<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[我的变量去哪了？JS 作用域入门指南]]></title>    <link>https://juejin.cn/post/7577256255083511817</link>    <guid>https://juejin.cn/post/7577256255083511817</guid>    <pubDate>2025-11-28T01:59:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577256255083511817" data-draft-id="7577256255083134985" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="我的变量去哪了？JS 作用域入门指南"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2025-11-28T01:59:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ohyeah"/> <meta itemprop="url" content="https://juejin.cn/user/740446536480618"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            我的变量去哪了？JS 作用域入门指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/740446536480618/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ohyeah
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-28T01:59:49.000Z" title="Fri Nov 28 2025 01:59:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    13
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 JavaScript 的学习过程中，<strong>作用域</strong>和<strong>变量提升</strong>是两个绕不开的核心概念。它们不仅影响着代码的执行逻辑，也常常成为初学者“踩坑”的重灾区。本文将结合几段典型代码，从实际运行结果出发，梳理 JS 中作用域的演变过程，重点解释 <strong>var 的缺陷</strong>、<strong>let/const 的改进</strong>，以及现代 JS 引擎如何通过<strong>执行上下文</strong>统一处理这两类变量声明。</p>
<hr/>
<h2 data-id="heading-0">一、变量提升：JS 的“历史包袱”</h2>
<p>先看这段代码（<code>1.js</code>）：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">showName</span>() <span class="hljs-comment">// ✅ 正常执行</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(myname) <span class="hljs-comment">// undefined</span>

<span class="hljs-keyword">var</span> myname = <span class="hljs-string">'路明非'</span>

<span class="hljs-keyword">function</span> <span class="hljs-title function_">showName</span>(<span class="hljs-params"/>){
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'函数showName 执行了'</span>)
}
</code></pre>
<p>这里体现了两个关键现象：</p>
<ul>
<li><strong>函数声明提升</strong>：<code>showName</code> 不仅声明被提升，<strong>函数体也被提升</strong>，因此可以在定义前调用。</li>
<li><strong>变量提升（仅声明）</strong> ：<code>var myname</code> 的声明被提升到顶部，但赋值仍在原位置执行，所以首次 <code>console.log</code> 输出 <code>undefined</code>。</li>
</ul>
<p>这就是经典的 <strong>hoisting（变量提升）</strong> 机制。它源于 JS 引擎的两阶段执行模型：<strong>编译阶段</strong>收集声明，<strong>执行阶段</strong>进行赋值和调用。</p>
<blockquote>
<p>⚠️ 变量提升虽解决了早期 JS 的作用域问题，但也带来了<strong>不符合直觉的行为</strong>，被视为语言设计上的缺陷。</p>
</blockquote>
<hr/>
<h2 data-id="heading-1">二、作用域链：全局 vs 局部</h2>
<p>在 <code>2.js</code> 中：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">var</span> globalVar = <span class="hljs-string">'我是全局变量'</span>

<span class="hljs-keyword">function</span> <span class="hljs-title function_">myFunction</span>(<span class="hljs-params"/>){
  <span class="hljs-keyword">var</span> localVar = <span class="hljs-string">'我是局部变量'</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(globalVar) <span class="hljs-comment">// ✅ 打印全局变量</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(localVar)  <span class="hljs-comment">// ✅ 打印局部变量</span>
}

<span class="hljs-title function_">myFunction</span>()
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(globalVar) <span class="hljs-comment">// ✅</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(localVar)  <span class="hljs-comment">// ❌ ReferenceError</span>
</code></pre>
<p>这展示了 <strong>作用域链</strong> 的查找规则：</p>
<ul>
<li>函数内部优先查找<strong>局部作用域</strong>；</li>
<li>若未找到，则沿作用域链向上查找至<strong>全局作用域</strong>；</li>
<li>但<strong>全局无法访问函数内部的局部变量</strong>。</li>
</ul>
<p>这是 JS 作用域的基本规则，也是封装和避免命名冲突的基础。</p>
<hr/>
<h2 data-id="heading-2">三、var 的致命伤：不支持块级作用域</h2>
<p>来看 <code>3.js</code>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">var</span> name = <span class="hljs-string">'刘锦苗'</span>

<span class="hljs-keyword">function</span> <span class="hljs-title function_">showName</span>(<span class="hljs-params"/>){
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(name) <span class="hljs-comment">// undefined</span>
  <span class="hljs-keyword">if</span>(<span class="hljs-literal">false</span>){
    <span class="hljs-keyword">var</span> name = <span class="hljs-string">'大厂的苗子'</span>
  }
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(name) <span class="hljs-comment">// undefined</span>
}
</code></pre>
<p>尽管 <code>if(false)</code> 块永远不会执行，但 <code>var name</code> 仍被<strong>提升到函数作用域顶部</strong>，导致函数内 <code>name</code> 被初始化为 <code>undefined</code>。这是因为 <strong><code>var</code> 不支持块级作用域</strong>，其声明会被提升到最近的函数或全局作用域。</p>
<p>对比 <code>4.js</code> 使用 <code>let</code>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">var</span> name = <span class="hljs-string">'刘锦苗'</span>

<span class="hljs-keyword">function</span> <span class="hljs-title function_">showName</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(name) <span class="hljs-comment">// '刘锦苗'</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-literal">false</span>) {
    <span class="hljs-keyword">let</span> name = <span class="hljs-string">'大厂的苗子'</span> <span class="hljs-comment">// ❌ 不会影响外层</span>
  }
}
</code></pre>
<p>由于 <code>let</code> 具有<strong>块级作用域</strong>，<code>if</code> 内的 <code>name</code> 仅在该块中有效，不会污染函数作用域，因此外层仍能正确访问全局变量。</p>
<hr/>
<h2 data-id="heading-3">四、let/const 如何解决提升问题？</h2>
<p><code>8.js</code> 展示了一个关键特性：</p>
<pre><code class="hljs language-ini" lang="ini">let <span class="hljs-attr">name</span> = <span class="hljs-string">'刘锦苗'</span>

{
  console.log(name) // ❌ ReferenceError: Cannot access 'name' before initialization
  let <span class="hljs-attr">name</span> = <span class="hljs-string">'大厂的苗子'</span>
}
</code></pre>
<p>这里报错并非因为变量未声明，而是进入了 <strong>暂时性死区（Temporal Dead Zone, TDZ）</strong> 。<br/>
<code>let/const</code> 虽然也会“提升”，但<strong>不会像 var 那样初始化为 undefined</strong>，而是在声明前处于不可访问状态。</p>
<blockquote>
<p>这正是 ES6 对变量提升缺陷的修正：<strong>提升存在，但禁止提前访问</strong>。</p>
</blockquote>
<hr/>
<h2 data-id="heading-4">五、执行上下文视角：变量环境 vs 词法环境</h2>
<p>现代 JS 引擎（如 V8）通过 <strong>执行上下文（Execution Context）</strong> 统一管理变量：</p>
<ul>
<li><strong>变量环境</strong> ：存放 <code>var</code> 声明的变量。</li>
<li><strong>词法环境</strong> ：存放 <code>let/const</code> 声明的变量，并支持<strong>块级作用域栈结构</strong>。</li>
</ul>
<p>以 <code>7.js</code> 为例：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">foo</span>(<span class="hljs-params"/>){
  <span class="hljs-keyword">var</span> a = <span class="hljs-number">1</span>
  <span class="hljs-keyword">let</span> b = <span class="hljs-number">2</span>
  {
    <span class="hljs-keyword">let</span> b = <span class="hljs-number">3</span>  <span class="hljs-comment">// 新的 b，与外层无关</span>
    <span class="hljs-keyword">var</span> c = <span class="hljs-number">4</span>
    <span class="hljs-keyword">let</span> d = <span class="hljs-number">5</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(a) <span class="hljs-comment">// 1（从变量环境中找到）</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(b) <span class="hljs-comment">// 3（当前块级作用域栈顶）</span>
  }
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(b) <span class="hljs-comment">// 2（块级作用域出栈，恢复外层 b）</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(c) <span class="hljs-comment">// 4（var 提升到函数作用域）</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(d) <span class="hljs-comment">// ❌ ReferenceError（d 已随块级作用域销毁）</span>
}
</code></pre>
<p>这里的关键在于：</p>
<ul>
<li><code>let</code> 在块级作用域中创建<strong>独立的绑定</strong>，块执行完后自动出栈销毁；</li>
<li><code>var</code> 无视块级作用域，始终属于函数或全局作用域；</li>
<li>引擎通过<strong>词法环境的栈结构</strong>实现了对块级作用域的支持。</li>
</ul>
<hr/>
<h2 data-id="heading-5">六、为什么早期 JS 要这样设计？</h2>
<p><strong>JavaScript 最初是“KPI 项目”</strong> ，设计周期极短，目标只是给网页加点动态效果。为了快速实现，设计者选择了最简单的方案：</p>
<ul>
<li>不引入复杂的块级作用域；</li>
<li>用“变量提升”统一处理作用域问题；</li>
<li>用函数模拟“类”，规避面向对象的复杂性。</li>
</ul>
<p>这种设计在当时够用，但随着 JS 应用复杂度飙升，<code>var</code> 的缺陷日益凸显——变量覆盖、生命周期混乱、难以调试。</p>
<p>ES6 引入 <code>let/const</code> 和块级作用域，正是对这一历史问题的修复。</p>
<hr/>
<h2 data-id="heading-6">结语：拥抱 let/const，理解执行上下文</h2>
<p>如今，我们应<strong>优先使用 <code>let</code> 和 <code>const</code></strong>，避免 <code>var</code> 带来的陷阱。同时，理解 JS 引擎如何通过 <strong>变量环境 + 词法环境</strong> 的双轨机制，兼容新旧语法，是深入掌握作用域的关键。</p>
<blockquote>
<p>JavaScript 的演进告诉我们：<strong>好的语言设计，既要向前兼容，也要勇于修正过去的错误</strong>。</p>
</blockquote>
<p>通过这几段小代码，我们不仅看到了变量提升的“坑”，更见证了 JS 如何在保持灵活性的同时，逐步走向严谨与规范。希望这篇文章能帮你理清思路，在掘金社区分享你的成长！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[告别服务器！小程序纯前端“图片转 PDF”工具，隐私安全又高效]]></title>    <link>https://juejin.cn/post/7577239264310263808</link>    <guid>https://juejin.cn/post/7577239264310263808</guid>    <pubDate>2025-11-28T02:11:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577239264310263808" data-draft-id="7577284771446800424" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="告别服务器！小程序纯前端“图片转 PDF”工具，隐私安全又高效"/> <meta itemprop="keywords" content="微信小程序,前端,JavaScript"/> <meta itemprop="datePublished" content="2025-11-28T02:11:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小皮虾"/> <meta itemprop="url" content="https://juejin.cn/user/1468603263091623"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            告别服务器！小程序纯前端“图片转 PDF”工具，隐私安全又高效
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1468603263091623/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小皮虾
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-28T02:11:38.000Z" title="Fri Nov 28 2025 02:11:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1. 背景与痛点：纯前端实践的动力</h2>
<p>在开发小程序时，实现如“图片转 PDF”这样的功能时，常常面临以下挑战：</p>
<ul>
<li><strong>隐私担忧</strong>：将图片上传到服务器进行转换，用户担心图片内容泄露。对于个人证件、私密照片等敏感内容，这一顾虑尤为突出。</li>
<li><strong>网络依赖与效率</strong>：转换过程需要频繁与服务器交互，在弱网环境下速度慢、不稳定，甚至可能因上传大文件而失败。</li>
<li><strong>服务器成本</strong>：每一次转换都意味着服务器资源的消耗（存储、计算、带宽），对于开发者而言，成本不容忽视。</li>
</ul>
<p>为了解决这些痛点，我们探索了一个更优的实现路径：<strong>纯前端、在小程序本地完成图片到 PDF 的转换</strong>。</p>
<h2 data-id="heading-1">2. 核心思路：本地文件系统与 <code>pdf-lib</code> 的巧妙结合</h2>
<p>在小程序中实现纯前端图片转 PDF，我们的核心思路是：</p>
<ol>
<li><strong>图片本地化处理</strong>：充分利用小程序强大的本地文件系统能力，将用户选择的图片读取到本地临时路径。</li>
<li><strong>PDF 文档构建</strong>：引入功能丰富的 JavaScript 库 <code>pdf-lib</code>，在小程序运行时直接在前端环境创建和操作 PDF 文件。</li>
<li><strong>最终文件保存</strong>：将 <code>pdf-lib</code> 生成的 PDF 数据流保存为本地文件，供用户直接预览或分享。</li>
</ol>
<p>这种方式让整个转换过程都在用户的小程序沙箱环境内完成，<strong>图片数据不会离开用户手机</strong>，极大保障了数据隐私和安全性，同时显著提升了转换效率并降低了服务器成本。</p>
<h2 data-id="heading-2">3. 技术核心：<code>pdf-lib</code> 的引入与应用</h2>
<p><code>pdf-lib</code> 是一个强大的纯 JavaScript PDF 库，支持在多种 JavaScript 环境下创建和修改 PDF 文件，完美契合小程序这种前端应用场景。</p>
<h3 data-id="heading-3">3.1 库的引入</h3>
<p>你需要将 <code>pdf-lib</code> 的小程序兼容版本（通常是 <code>pdf-lib.min.js</code>）放置在你的项目目录中，并通过 <code>require</code> 引入：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> { <span class="hljs-title class_">PDFDocument</span>, degrees, <span class="hljs-title class_">PageSizes</span> } = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./pdf-lib.min.js'</span>);
<span class="hljs-keyword">const</span> fs = wx.<span class="hljs-title function_">getFileSystemManager</span>(); <span class="hljs-comment">// 小程序文件管理器实例</span>
</code></pre>
<h3 data-id="heading-4">3.2 转换逻辑概览</h3>
<p>整个图片转 PDF 的流程可分解为以下几个关键步骤：</p>
<ol>
<li><strong>图片预处理</strong>：获取每张图片的尺寸、类型 (<code>wx.getImageInfo</code>)，并将其读取为 Base64 格式 (<code>fs.readFile</code>)，这是 <code>pdf-lib</code> 嵌入图片所需的标准数据格式。</li>
<li><strong>创建 PDF 文档</strong>：初始化一个空的 <code>PDFDocument</code> 对象。</li>
<li><strong>逐页添加图片</strong>：遍历所有图片，为每张图片创建一个新的 PDF 页面。根据图片的原始尺寸和类型，将其嵌入到 PDF 中，并进行智能缩放、居中。<strong>对于横向图片，还会自动旋转页面 90 度以更好地适应 A4 纸张。</strong></li>
<li><strong>生成与保存</strong>：将构建好的 PDF 文档保存为 Base64 编码的字符串，再通过小程序文件系统的 <code>fs.writeFile</code> 接口，写入到本地的临时文件路径。</li>
<li><strong>返回结果</strong>：将生成的 PDF 文件本地路径返回给业务层，用于后续的预览或分享。</li>
</ol>
<h2 data-id="heading-5">4. 核心代码：<code>img2pdf.js</code></h2>
<p>以下是我们帮小忙工具箱实现图片转 PDF 功能的核心源代码。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> { <span class="hljs-title class_">PDFDocument</span>, degrees, <span class="hljs-title class_">PageSizes</span> } = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./pdf-lib.min.js'</span>);
<span class="hljs-keyword">const</span> fs = wx.<span class="hljs-title function_">getFileSystemManager</span>()
<span class="hljs-comment">/**
 * 把图片转成pdf
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Array</span>} urls 图片url数组
 * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">String</span>} pdfUrl pdf文件url
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">img2pdf</span>(<span class="hljs-params">urls</span>) {
	<span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> urls == <span class="hljs-string">'string'</span>) {
		urls = [urls]
	}

	<span class="hljs-comment">// 图片信息</span>
	<span class="hljs-keyword">const</span> imageInfo = urls.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">url</span>) =&gt;</span> {
		<span class="hljs-keyword">return</span> wx.<span class="hljs-title function_">getImageInfo</span>({
			<span class="hljs-attr">src</span>: url
		});
	});
	<span class="hljs-keyword">const</span> imageInfoRes = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>(imageInfo);
	<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(imageInfoRes);

	<span class="hljs-comment">// 图片base64</span>
	<span class="hljs-keyword">const</span> imageBase64 = urls.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">url</span>) =&gt;</span> {
		<span class="hljs-keyword">return</span> <span class="hljs-title function_">readFile</span>(url, <span class="hljs-string">"base64"</span>);
	});
	<span class="hljs-keyword">const</span> imageBase64Res = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>(imageBase64);
	<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(imageBase64Res);

	<span class="hljs-keyword">const</span> pdfDoc = <span class="hljs-keyword">await</span> <span class="hljs-title class_">PDFDocument</span>.<span class="hljs-title function_">create</span>();

	<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; imageInfoRes.<span class="hljs-property">length</span>; i++) {
		<span class="hljs-keyword">const</span> {
			type,
			width,
			height
		} = imageInfoRes[i];
		<span class="hljs-keyword">let</span> pdfImage = <span class="hljs-string">""</span>;
		<span class="hljs-keyword">if</span> (type === <span class="hljs-string">'jpeg'</span>) {
			pdfImage = <span class="hljs-keyword">await</span> pdfDoc.<span class="hljs-title function_">embedJpg</span>(imageBase64Res[i]);
		} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (type === <span class="hljs-string">'png'</span>) {
			pdfImage = <span class="hljs-keyword">await</span> pdfDoc.<span class="hljs-title function_">embedPng</span>(imageBase64Res[i]);
		}

		<span class="hljs-keyword">const</span> page = pdfDoc.<span class="hljs-title function_">addPage</span>(<span class="hljs-title class_">PageSizes</span>.<span class="hljs-property">A4</span>);
		<span class="hljs-keyword">const</span> {
			<span class="hljs-attr">width</span>: pageWidth,
			<span class="hljs-attr">height</span>: pageHeight
		} = page.<span class="hljs-title function_">getSize</span>(); <span class="hljs-comment">// 获取页面尺寸</span>

		<span class="hljs-keyword">let</span> drawOptions = {};

		<span class="hljs-comment">// 如果图片是宽大于高，则旋转</span>
		<span class="hljs-keyword">if</span> (width &gt; height) {
			<span class="hljs-comment">// 页面旋转后，可用于绘制的"宽度"实际上是原始页面的高度，"高度"是原始页面的宽度</span>
			<span class="hljs-keyword">const</span> scaled = pdfImage.<span class="hljs-title function_">scaleToFit</span>(pageHeight, pageWidth); <span class="hljs-comment">// 注意参数顺序因为页面旋转了</span>

			drawOptions = {
				<span class="hljs-comment">// x: scaled.height + (pageWidth - scaled.height) / 2,   // 注意这里用的是 scaled.height</span>
				<span class="hljs-attr">x</span>: (pageWidth - scaled.<span class="hljs-property">height</span>) / <span class="hljs-number">2</span>,
				<span class="hljs-attr">y</span>: (pageHeight - scaled.<span class="hljs-property">width</span>) / <span class="hljs-number">2</span> + scaled.<span class="hljs-property">width</span>,
				<span class="hljs-attr">width</span>: scaled.<span class="hljs-property">width</span>,
				<span class="hljs-attr">height</span>: scaled.<span class="hljs-property">height</span>,
				<span class="hljs-attr">rotate</span>: <span class="hljs-title function_">degrees</span>(<span class="hljs-number">270</span>),
			};
			<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'drawOptions'</span>, drawOptions);
		} <span class="hljs-keyword">else</span> {
			<span class="hljs-comment">// 图片是纵向或方形的</span>
			<span class="hljs-keyword">const</span> scaled = pdfImage.<span class="hljs-title function_">scaleToFit</span>(pageWidth, pageHeight);
			drawOptions = {
				<span class="hljs-attr">x</span>: (pageWidth - scaled.<span class="hljs-property">width</span>) / <span class="hljs-number">2</span>, <span class="hljs-comment">// 居中 X</span>
				<span class="hljs-attr">y</span>: (pageHeight - scaled.<span class="hljs-property">height</span>) / <span class="hljs-number">2</span>, <span class="hljs-comment">// 居中 Y</span>
				<span class="hljs-attr">width</span>: scaled.<span class="hljs-property">width</span>,
				<span class="hljs-attr">height</span>: scaled.<span class="hljs-property">height</span>,
			};
		}
		page.<span class="hljs-title function_">drawImage</span>(pdfImage, drawOptions);
	}

	<span class="hljs-comment">// 3. 获取 PDF 的 Uint8Array</span>
	<span class="hljs-keyword">const</span> docBase64 = <span class="hljs-keyword">await</span> pdfDoc.<span class="hljs-title function_">saveAsBase64</span>();
	<span class="hljs-keyword">const</span> timestamp = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
	<span class="hljs-keyword">const</span> pdfPath = <span class="hljs-keyword">await</span> <span class="hljs-title function_">base64ToFile</span>(docBase64, <span class="hljs-string">`/<span class="hljs-subst">${timestamp}</span>.pdf`</span>);


	<span class="hljs-keyword">return</span> pdfPath;
}

<span class="hljs-comment">/**
 * base64转本地文件
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">string</span>} base64 base64字符串
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">string</span>} fileName  文件名
 * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">Promise</span>} Promise 文件路径
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">base64ToFile</span>(<span class="hljs-params">base64, fileName</span>) {
	<span class="hljs-keyword">const</span> {
		promise,
		resolve,
		reject
	} = <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">withResolvers</span>();
	<span class="hljs-keyword">const</span> filePath = wx.<span class="hljs-property">env</span>.<span class="hljs-property">USER_DATA_PATH</span> + fileName;
	fs.<span class="hljs-title function_">writeFile</span>({
		filePath,
		<span class="hljs-attr">data</span>: base64,
		<span class="hljs-attr">encoding</span>: <span class="hljs-string">"base64"</span>,
		<span class="hljs-attr">success</span>: <span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> {
			<span class="hljs-title function_">resolve</span>(filePath)
		},
		<span class="hljs-attr">fail</span>: <span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> {
			<span class="hljs-title function_">reject</span>(err)
		}
	});
	<span class="hljs-keyword">return</span> promise;
}

<span class="hljs-comment">/**
 * 使用Promise读取文件
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">string</span>} filePath 文件路径
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">string</span>} encoding 文件编码
 * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">Promise</span>} Promise对象
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">readFile</span>(<span class="hljs-params">filePath, encoding = <span class="hljs-string">'utf8'</span></span>) {
	<span class="hljs-keyword">const</span> {
		promise,
		resolve,
		reject
	} = <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">withResolvers</span>();
	fs.<span class="hljs-title function_">readFile</span>({
		filePath,
		encoding,
		<span class="hljs-title function_">success</span>(<span class="hljs-params">fileRes</span>) {
			<span class="hljs-title function_">resolve</span>(fileRes.<span class="hljs-property">data</span>)
		},
		<span class="hljs-title function_">fail</span>(<span class="hljs-params">err</span>) {
			<span class="hljs-title function_">reject</span>(err)
		}
	});
	<span class="hljs-keyword">return</span> promise;
}
</code></pre>
<h2 data-id="heading-6">5. 小程序端应用示例</h2>
<p>在页面中，可以通过简单的交互完成转换。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// pages/image-to-pdf/index.js</span>
<span class="hljs-keyword">import</span> { img2pdf } <span class="hljs-keyword">from</span> <span class="hljs-string">'../../utils/img2pdf'</span>; <span class="hljs-comment">// 引入转换工具</span>

<span class="hljs-title class_">Page</span>({
  <span class="hljs-attr">data</span>: {
    <span class="hljs-attr">selectedImages</span>: [], <span class="hljs-comment">// 用户选择的图片临时路径数组</span>
    <span class="hljs-attr">pdfPath</span>: <span class="hljs-string">''</span>,
    <span class="hljs-attr">loading</span>: <span class="hljs-literal">false</span>
  },

  <span class="hljs-comment">// 触发图片选择</span>
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">chooseImage</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> { tempFiles } = <span class="hljs-keyword">await</span> wx.<span class="hljs-title function_">chooseMedia</span>({
      <span class="hljs-attr">count</span>: <span class="hljs-number">9</span>, <span class="hljs-comment">// 最多选择 9 张图片</span>
      <span class="hljs-attr">mediaType</span>: [<span class="hljs-string">'image'</span>],
      <span class="hljs-attr">sizeType</span>: [<span class="hljs-string">'original'</span>, <span class="hljs-string">'compressed'</span>], <span class="hljs-comment">// 可以选择原图或压缩图</span>
      <span class="hljs-attr">sourceType</span>: [<span class="hljs-string">'album'</span>, <span class="hljs-string">'camera'</span>],
    });
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setData</span>({ <span class="hljs-attr">selectedImages</span>: tempFiles.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">file</span> =&gt;</span> file.<span class="hljs-property">tempFilePath</span>) });
  },

  <span class="hljs-comment">// 执行图片转 PDF 转换</span>
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">convertToPdf</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span>.<span class="hljs-property">selectedImages</span>.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) {
      wx.<span class="hljs-title function_">showToast</span>({ <span class="hljs-attr">title</span>: <span class="hljs-string">'请先选择图片'</span>, <span class="hljs-attr">icon</span>: <span class="hljs-string">'none'</span> });
      <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setData</span>({ <span class="hljs-attr">loading</span>: <span class="hljs-literal">true</span> });
    wx.<span class="hljs-title function_">showLoading</span>({ <span class="hljs-attr">title</span>: <span class="hljs-string">'转换中...'</span> });

    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> pdfFilePath = <span class="hljs-keyword">await</span> <span class="hljs-title function_">img2pdf</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span>.<span class="hljs-property">selectedImages</span>);
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setData</span>({ <span class="hljs-attr">pdfPath</span>: pdfFilePath });
      wx.<span class="hljs-title function_">hideLoading</span>();
      wx.<span class="hljs-title function_">showToast</span>({ <span class="hljs-attr">title</span>: <span class="hljs-string">'转换成功！'</span>, <span class="hljs-attr">icon</span>: <span class="hljs-string">'success'</span> });
      
      <span class="hljs-comment">// 转换成功后，自动打开 PDF 预览</span>
      wx.<span class="hljs-title function_">openDocument</span>({
        <span class="hljs-attr">filePath</span>: pdfFilePath,
        <span class="hljs-attr">fileType</span>: <span class="hljs-string">'pdf'</span>,
        <span class="hljs-attr">success</span>: <span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'打开 PDF 成功'</span>, res),
        <span class="hljs-attr">fail</span>: <span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'打开 PDF 失败'</span>, err)
      });

    } <span class="hljs-keyword">catch</span> (error) {
      wx.<span class="hljs-title function_">hideLoading</span>();
      wx.<span class="hljs-title function_">showToast</span>({ <span class="hljs-attr">title</span>: <span class="hljs-string">'转换失败！'</span>, <span class="hljs-attr">icon</span>: <span class="hljs-string">'error'</span> });
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'图片转 PDF 发生错误'</span>, error);
    } <span class="hljs-keyword">finally</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setData</span>({ <span class="hljs-attr">loading</span>: <span class="hljs-literal">false</span> });
    }
  }
})
</code></pre>
<h2 data-id="heading-7">6. 经验总结与注意事项</h2>
<ol>
<li>
<p><strong>文件体积与性能</strong>：</p>
<ul>
<li><code>pdf-lib</code> 库本身有一定体积（通常在几百 KB），会增加小程序包体大小，我们是使用分包，所以不影响主包。</li>
<li>图片数量越多、分辨率越高，转换耗时越长，内存占用越大。建议在选择图片时提示用户合理数量或适当压缩。</li>
<li>pdf横向图片旋转需要额外计算和处理，可能会略微增加复杂性，如果觉得复杂，也可以直接判断图片是否是纵向，如果是横向使用canvas旋转图片，逻辑上就毕竟简单了。</li>
</ul>
</li>
<li>
<p><strong><code>Promise.withResolvers()</code> 兼容性</strong>：</p>
<ul>
<li>代码使用了 <code>Promise.withResolvers()</code>，目前大多数小程序环境和浏览器中<strong>兼容性可能不好</strong>，我自己做了兼容。</li>
</ul>
</li>
<li>
<p><strong>本地文件系统限制</strong>：</p>
<ul>
<li><code>wx.env.USER_DATA_PATH</code> 路径下的文件是小程序沙箱环境特有的，用户无法直接在系统文件管理器中找到。</li>
<li>生成的文件是临时文件，小程序关闭或长时间不用可能被系统清理。如果需要长期保存，需引导用户通过 <code>wx.saveFile</code> (保存到相册或本地文件) 或上传云存储。</li>
</ul>
</li>
<li>
<p><strong>图片类型支持</strong>：
<code>pdf-lib</code> 主要支持 JPEG 和 PNG 格式。其他格式（如 WebP、GIF）需要先转换为 JPEG/PNG 再进行嵌入，可以利用canvas实现，后面会分享。</p>
</li>
</ol>
<h2 data-id="heading-8">写在最后</h2>
<p>纯前端实现“图片转 PDF”功能，不仅提升了用户体验，更重要的是有效保护了用户的数字隐私。这在追求用户信任和数据安全的小程序生态中，无疑是一个值得推广的实践。</p>
<p>希望这次分享能为你带来启发，共同探索小程序前端能力的更多可能性！</p>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[六个故事搞懂Fragment 故事1-初识Fragment - NewsHub的模块化革命]]></title>    <link>https://juejin.cn/post/7577239264309854208</link>    <guid>https://juejin.cn/post/7577239264309854208</guid>    <pubDate>2025-11-28T00:48:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577239264309854208" data-draft-id="7577239264309837824" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="六个故事搞懂Fragment 故事1-初识Fragment - NewsHub的模块化革命"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2025-11-28T00:48:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="码码宁"/> <meta itemprop="url" content="https://juejin.cn/user/4248978205204190"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            六个故事搞懂Fragment 故事1-初识Fragment - NewsHub的模块化革命
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4248978205204190/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    码码宁
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-28T00:48:37.000Z" title="Fri Nov 28 2025 00:48:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    18
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读22分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">故事1：初识Fragment - NewsHub的模块化革命</h2>
<h3 data-id="heading-1">晨光中的困境</h3>
<p>清晨的第一缕阳光透过百叶窗的缝隙洒在张小安的办公桌上，照亮了散乱的草稿纸和喝了半杯的咖啡。作为移动互联网创业公司"启明科技"的Android开发工程师，小安已经连续奋战了三个星期，他负责开发的新闻阅读应用"NewsHub"即将进入内测阶段。</p>
<p>然而，此刻小安的眉头却紧锁得像一团解不开的毛线。</p>
<p>"又是这个问题..."他喃喃自语，手指在触摸板上快速滑动，屏幕上显示着两套几乎完全相同的XML布局文件。</p>
<p>"为什么手机版和平板版的代码重复率这么高？这简直是在浪费生命！"</p>
<p>小安揉了揉疲惫的眼睛，显示器上的代码仿佛在嘲笑他的困境。作为一名有着三年Android开发经验的工程师，他深知这种代码重复带来的维护噩梦：</p>
<pre><code class="hljs language-ini" lang="ini">&lt;!-- 手机版 activity_main.xml --&gt;
&lt;LinearLayout xmlns:<span class="hljs-attr">android</span>=<span class="hljs-string">"http://schemas.android.com/apk/res/android"</span>
    android:<span class="hljs-attr">layout_width</span>=<span class="hljs-string">"match_parent"</span>
    android:<span class="hljs-attr">layout_height</span>=<span class="hljs-string">"match_parent"</span>
    android:<span class="hljs-attr">orientation</span>=<span class="hljs-string">"horizontal"</span>&gt;
​
    &lt;FrameLayout
        android:<span class="hljs-attr">id</span>=<span class="hljs-string">"@+id/news_list_container"</span>
        android:<span class="hljs-attr">layout_width</span>=<span class="hljs-string">"0dp"</span>
        android:<span class="hljs-attr">layout_height</span>=<span class="hljs-string">"match_parent"</span>
        android:<span class="hljs-attr">layout_weight</span>=<span class="hljs-string">"1"</span> /&gt;
​
&lt;/LinearLayout&gt;
</code></pre>
<pre><code class="hljs language-ini" lang="ini">&lt;!-- 平板版 activity_main_tablet.xml --&gt;
&lt;LinearLayout xmlns:<span class="hljs-attr">android</span>=<span class="hljs-string">"http://schemas.android.com/apk/res/android"</span>
    android:<span class="hljs-attr">layout_width</span>=<span class="hljs-string">"match_parent"</span>
    android:<span class="hljs-attr">layout_height</span>=<span class="hljs-string">"match_parent"</span>
    android:<span class="hljs-attr">orientation</span>=<span class="hljs-string">"horizontal"</span>&gt;
​
    &lt;FrameLayout
        android:<span class="hljs-attr">id</span>=<span class="hljs-string">"@+id/news_list_container"</span>
        android:<span class="hljs-attr">layout_width</span>=<span class="hljs-string">"0dp"</span>
        android:<span class="hljs-attr">layout_height</span>=<span class="hljs-string">"match_parent"</span>
        android:<span class="hljs-attr">layout_weight</span>=<span class="hljs-string">"1"</span> /&gt;
​
    &lt;FrameLayout
        android:<span class="hljs-attr">id</span>=<span class="hljs-string">"@+id/news_detail_container"</span>
        android:<span class="hljs-attr">layout_width</span>=<span class="hljs-string">"0dp"</span>
        android:<span class="hljs-attr">layout_height</span>=<span class="hljs-string">"match_parent"</span>
        android:<span class="hljs-attr">layout_weight</span>=<span class="hljs-string">"1"</span> /&gt;
​
&lt;/LinearLayout&gt;
</code></pre>
<p>仅仅因为多了一个详情页面的容器，他就不得不维护两套几乎完全相同的布局文件。更糟糕的是，对应的Java代码也需要分别处理：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// MainActivity.java</span>
public class MainActivity extends AppCompatActivity {
​
    <span class="hljs-keyword">@Override</span>
    protected void onCreate(Bundle savedInstanceState) {
        super<span class="hljs-selector-class">.onCreate</span>(savedInstanceState);
​
        if (isTablet()) {
            <span class="hljs-built_in">setContentView</span>(R.layout.activity_main_tablet);
            <span class="hljs-comment">// 平板逻辑：同时显示列表和详情</span>
            <span class="hljs-built_in">showNewsList</span>();
            <span class="hljs-built_in">showNewsDetail</span>(null);
        } else {
            <span class="hljs-built_in">setContentView</span>(R.layout.activity_main);
            <span class="hljs-comment">// 手机逻辑：只显示列表，点击后跳转</span>
            <span class="hljs-built_in">showNewsList</span>();
        }
    }
​
    private boolean <span class="hljs-built_in">isTablet</span>() {
        return <span class="hljs-built_in">getResources</span>()<span class="hljs-selector-class">.getBoolean</span>(R.bool.isTablet);
    }
​
    private void <span class="hljs-built_in">showNewsList</span>() {
        <span class="hljs-comment">// 无论是手机还是平板，这部分代码都一样</span>
        NewsListFragment listFragment = new <span class="hljs-built_in">NewsListFragment</span>();
        <span class="hljs-built_in">getSupportFragmentManager</span>()
            <span class="hljs-selector-class">.beginTransaction</span>()
            <span class="hljs-selector-class">.replace</span>(R.id.news_list_container, listFragment)
            <span class="hljs-selector-class">.commit</span>();
    }
​
    private void <span class="hljs-built_in">showNewsDetail</span>(NewsItem newsItem) {
        if (isTablet()) {
            <span class="hljs-comment">// 平板：在右侧容器中显示详情</span>
            NewsDetailFragment detailFragment = new <span class="hljs-built_in">NewsDetailFragment</span>();
            if (newsItem != null) {
                Bundle args = new <span class="hljs-built_in">Bundle</span>();
                args<span class="hljs-selector-class">.putParcelable</span>("news_item", newsItem);
                detailFragment<span class="hljs-selector-class">.setArguments</span>(args);
            }
            <span class="hljs-built_in">getSupportFragmentManager</span>()
                <span class="hljs-selector-class">.beginTransaction</span>()
                <span class="hljs-selector-class">.replace</span>(R.id.news_detail_container, detailFragment)
                <span class="hljs-selector-class">.commit</span>();
        } else {
            <span class="hljs-comment">// 手机：启动新的Activity显示详情</span>
            Intent intent = new <span class="hljs-built_in">Intent</span>(this, NewsDetailActivity.class);
            if (newsItem != null) {
                intent<span class="hljs-selector-class">.putExtra</span>("news_item", newsItem);
            }
            <span class="hljs-built_in">startActivity</span>(intent);
        }
    }
}
</code></pre>
<p>"这样下去不行..."小安靠在椅背上，望着窗外的城市天际线，"每次修改一个功能，我都要在多个地方同步更新，太容易出错了。"</p>
<p>他想起上周那次惨痛的经历：因为修复手机版的一个列表显示bug，忘记同步更新平板版的代码，导致测试组发现平板应用崩溃，整个迭代计划被迫推迟。</p>
<p>"一定有更好的方法..."小安打开了技术文档浏览器，开始搜索"Android多屏适配最佳实践"。</p>
<h3 data-id="heading-2">意外的导师</h3>
<p>就在小安陷入沉思的时候，办公室的门被轻轻推开了。</p>
<p>"小安，还在为NewsHub的适配问题烦恼吗？"</p>
<p>说话的是李明轩，启明科技的资深架构师。李工有着十多年移动开发经验，是公司技术团队的核心人物。他五十岁左右的年纪，头发已经花白，但眼神依旧锐利，仿佛能看透代码背后的本质。</p>
<p>"李工..."小安有些不好意思地笑了笑，"您怎么知道的？"</p>
<p>"你这周提交的代码我看了，"李工走到小安的工位旁，指着屏幕，"手机版和平板版的代码重复率超过70%，这在敏捷开发中是很危险的信号。"</p>
<p>小安点点头，沮丧地说："我知道这样不好，但是我想不出更好的解决方案。Activity的架构天然就不支持模块化，我只能通过不同的布局文件来适配。"</p>
<p>李工笑了笑，从旁边拉过一张椅子坐下："小安，你知道为什么Android在3.0版本引入Fragment吗？"</p>
<p>"我记得文档上说是为了更好地支持大屏幕设备..."小安回答。</p>
<p>"没错，但Fragment的意义远不止于此。"李工的眼中闪烁着智慧的光芒，"让我给你讲个故事吧。"</p>
<h3 data-id="heading-3">Fragment的诞生故事</h3>
<p>"在Fragment出现之前，Android应用的开发模式就像是你现在遇到的问题，"李工开始娓娓道来，"每个屏幕都是一个独立的Activity，就像每个房间都是一栋独立的房子。"</p>
<p>小安想象着那个场景：一个社区里，每栋房子都独立存在，有自己的厨房、卧室、客厅。如果要建一个新的社区，就必须重新建造所有的房子。</p>
<p>"这种模式在手机时代还行，因为屏幕小，一个Activity就能显示所有内容。但平板出现后问题就暴露了。"李工继续说道，"平板屏幕大，可以同时显示多个界面。如果还用Activity，就像在同一个房间里建多栋房子，既浪费空间又难以管理。"</p>
<p>"所以Google设计了Fragment？"小安追问道。</p>
<p>"是的！"李工的语气变得兴奋起来，"Fragment就像积木块。你可以把一个Activity想象成一个玩具底板，Fragment就是各种形状的积木。在手机上，你可以在底板上放一块积木；在平板上，你可以同时放多块积木。"</p>
<p>李工拿出纸笔，画了一个简单的示意图：</p>
<pre><code class="hljs language-scss" lang="scss">手机布局：
┌─────────────────┐
│  Activity       │
│  ┌─────────────┐│
│  │ Fragment <span class="hljs-selector-tag">A</span>  ││  (新闻列表)
│  └─────────────┘│
│                 │
│  ┌─────────────┐│
│  │ Fragment <span class="hljs-selector-tag">B</span>  ││  (详情页面)
│  └─────────────┘│
└─────────────────┘
(一次只显示一个Fragment)
​
平板布局：
┌─────────────────┐
│  Activity       │
│  ┌──────────┐ │
│  │Fragment <span class="hljs-selector-tag">A</span>│ │  (新闻列表)
│  │          │ │
│  └──────────┘ │
│  ┌──────────┐ │
│  │Fragment <span class="hljs-selector-tag">B</span>│ │  (详情页面)
│  │          │ │
│  └──────────┘ │
└─────────────────┘
(同时显示两个Fragment)
</code></pre>
<p>"我明白了！"小安的眼睛亮了起来，"Fragment就是UI的模块化单元，Activity负责组装和管理这些模块！"</p>
<p>"完全正确！"李工赞许地点头，"这就是Fragment的核心设计理念：<strong>UI与逻辑的模块化</strong>。每个Fragment都是一个独立的组件，有自己的布局和生命周期，但必须托管在Activity中。"</p>
<h3 data-id="heading-4">Fragment的三大优势</h3>
<p>李工看着小安恍然大悟的表情，继续深入讲解："Fragment不仅解决了多屏适配问题，还有三个重要的优势："</p>
<h4 data-id="heading-5">1. 代码复用性</h4>
<p>"你看你现在的代码，"李工指着小安的屏幕，"NewsListFragment和NewsDetailFragment的逻辑其实是一样的，不管在手机还是平板上。如果用Fragment，你只需要写一次："</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// NewsListFragment.java</span>
<span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">class</span> <span class="hljs-selector-tag">NewsListFragment</span> <span class="hljs-selector-tag">extends</span> <span class="hljs-selector-tag">Fragment</span> {
    <span class="hljs-selector-tag">private</span> <span class="hljs-selector-tag">RecyclerView</span> <span class="hljs-selector-tag">recyclerView</span>;
    <span class="hljs-selector-tag">private</span> <span class="hljs-selector-tag">NewsAdapter</span> <span class="hljs-selector-tag">adapter</span>;
    <span class="hljs-selector-tag">private</span> <span class="hljs-selector-tag">List</span>&lt;<span class="hljs-selector-tag">NewsItem</span>&gt; <span class="hljs-selector-tag">newsList</span>;
​
    <span class="hljs-comment">// 回调接口，用于通知Activity用户点击了某条新闻</span>
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">interface</span> <span class="hljs-selector-tag">OnNewsSelectedListener</span> {
        <span class="hljs-selector-tag">void</span> <span class="hljs-selector-tag">onNewsSelected</span>(NewsItem newsItem);
    }
​
    <span class="hljs-selector-tag">private</span> <span class="hljs-selector-tag">OnNewsSelectedListener</span> <span class="hljs-selector-tag">listener</span>;
​
    @<span class="hljs-selector-tag">Override</span>
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">void</span> <span class="hljs-selector-tag">onAttach</span>(<span class="hljs-variable">@NonNull</span> Context context) {
        <span class="hljs-selector-tag">super</span><span class="hljs-selector-class">.onAttach</span>(context);
        <span class="hljs-comment">// 确保宿主Activity实现了回调接口</span>
        <span class="hljs-selector-tag">if</span> (context instanceof OnNewsSelectedListener) {
            <span class="hljs-selector-tag">listener</span> = (OnNewsSelectedListener) <span class="hljs-selector-tag">context</span>;
        } <span class="hljs-selector-tag">else</span> {
            <span class="hljs-selector-tag">throw</span> <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">RuntimeException</span>(context.<span class="hljs-built_in">toString</span>()
                + <span class="hljs-string">" must implement OnNewsSelectedListener"</span>);
        }
    }
​
    @<span class="hljs-selector-tag">Nullable</span>
    @<span class="hljs-selector-tag">Override</span>
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">View</span> <span class="hljs-selector-tag">onCreateView</span>(<span class="hljs-variable">@NonNull</span> LayoutInflater inflater,
                           <span class="hljs-variable">@Nullable</span> ViewGroup container,
                           <span class="hljs-variable">@Nullable</span> Bundle savedInstanceState) {
        <span class="hljs-comment">// 创建Fragment的视图</span>
        <span class="hljs-selector-tag">View</span> <span class="hljs-selector-tag">view</span> = <span class="hljs-selector-tag">inflater</span><span class="hljs-selector-class">.inflate</span>(R.layout.fragment_news_list,
                                    container, false);
​
        <span class="hljs-selector-tag">recyclerView</span> = <span class="hljs-selector-tag">view</span><span class="hljs-selector-class">.findViewById</span>(R.id.recyclerView);
        <span class="hljs-selector-tag">setupRecyclerView</span>();
​
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">view</span>;
    }
​
    @<span class="hljs-selector-tag">Override</span>
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">void</span> <span class="hljs-selector-tag">onViewCreated</span>(<span class="hljs-variable">@NonNull</span> View view,
                           <span class="hljs-variable">@Nullable</span> Bundle savedInstanceState) {
        <span class="hljs-selector-tag">super</span><span class="hljs-selector-class">.onViewCreated</span>(view, savedInstanceState);
​
        <span class="hljs-comment">// 加载新闻数据</span>
        <span class="hljs-selector-tag">loadNewsData</span>();
    }
​
    <span class="hljs-selector-tag">private</span> <span class="hljs-selector-tag">void</span> <span class="hljs-selector-tag">setupRecyclerView</span>() {
        <span class="hljs-selector-tag">adapter</span> = <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">NewsAdapter</span>(newsList, new NewsAdapter.<span class="hljs-built_in">OnItemClickListener</span>() {
            <span class="hljs-variable">@Override</span>
            public void <span class="hljs-built_in">onItemClick</span>(NewsItem newsItem) {
                <span class="hljs-comment">// 通知Activity用户选择了某条新闻</span>
                <span class="hljs-selector-tag">if</span> (listener != null) {
                    <span class="hljs-selector-tag">listener</span><span class="hljs-selector-class">.onNewsSelected</span>(newsItem);
                }
            }
        });
​
        <span class="hljs-selector-tag">recyclerView</span><span class="hljs-selector-class">.setLayoutManager</span>(new <span class="hljs-built_in">LinearLayoutManager</span>(<span class="hljs-built_in">getContext</span>()));
        <span class="hljs-selector-tag">recyclerView</span><span class="hljs-selector-class">.setAdapter</span>(adapter);
    }
​
    <span class="hljs-selector-tag">private</span> <span class="hljs-selector-tag">void</span> <span class="hljs-selector-tag">loadNewsData</span>() {
        <span class="hljs-comment">// 从网络或数据库加载新闻数据</span>
        <span class="hljs-comment">// 这里使用模拟数据</span>
        <span class="hljs-selector-tag">newsList</span> = <span class="hljs-selector-tag">NewsRepository</span><span class="hljs-selector-class">.getInstance</span>()<span class="hljs-selector-class">.getLatestNews</span>();
        <span class="hljs-selector-tag">adapter</span><span class="hljs-selector-class">.notifyDataSetChanged</span>();
    }
​
    <span class="hljs-comment">// ... 其他方法</span>
}
</code></pre>
<p>"看到吗？这个Fragment完全不知道自己会被用在手机还是平板上，它只负责显示新闻列表。如何使用这个Fragment，由Activity决定。"</p>
<h4 data-id="heading-6">2. 灵活的组合方式</h4>
<p>"Activity就像乐高积木的底板，Fragment就是不同形状的积木。"李工拿起小安桌上的乐高积木举例，"你可以根据需要自由组合："</p>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-comment">// 手机版MainActivity.java</span>
public <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MainActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AppCompatActivity</span></span>
        implements <span class="hljs-type">NewsListFragment</span>.<span class="hljs-type">OnNewsSelectedListener</span> {
​
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> void onCreate(<span class="hljs-type">Bundle</span> savedInstanceState) {
        <span class="hljs-keyword">super</span>.onCreate(savedInstanceState);
        setContentView(<span class="hljs-type">R</span>.layout.activity_main_phone);
​
        <span class="hljs-comment">// 手机版：只显示新闻列表Fragment</span>
        <span class="hljs-keyword">if</span> (savedInstanceState == <span class="hljs-literal">null</span>) {
            getSupportFragmentManager()
                .beginTransaction()
                .add(<span class="hljs-type">R</span>.id.fragment_container, <span class="hljs-keyword">new</span> <span class="hljs-type">NewsListFragment</span>())
                .commit();
        }
    }
​
    <span class="hljs-meta">@Override</span>
    public void onNewsSelected(<span class="hljs-type">NewsItem</span> newsItem) {
        <span class="hljs-comment">// 手机版：启动新的Activity显示详情</span>
        <span class="hljs-type">Intent</span> intent = <span class="hljs-keyword">new</span> <span class="hljs-type">Intent</span>(<span class="hljs-keyword">this</span>, <span class="hljs-type">NewsDetailActivity</span>.<span class="hljs-keyword">class</span>);
        intent.putExtra(<span class="hljs-string">"news_item"</span>, newsItem);
        startActivity(intent);
    }
}
</code></pre>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 平板版MainActivity.java</span>
public class MainActivity extends AppCompatActivity
        implements NewsListFragment<span class="hljs-selector-class">.OnNewsSelectedListener</span> {
​
    <span class="hljs-keyword">@Override</span>
    protected void onCreate(Bundle savedInstanceState) {
        super<span class="hljs-selector-class">.onCreate</span>(savedInstanceState);
        <span class="hljs-built_in">setContentView</span>(R.layout.activity_main_tablet);
​
        <span class="hljs-comment">// 平板版：同时显示列表和详情Fragment</span>
        if (savedInstanceState == null) {
            <span class="hljs-built_in">getSupportFragmentManager</span>()
                <span class="hljs-selector-class">.beginTransaction</span>()
                <span class="hljs-selector-class">.add</span>(R.id.news_list_container, new NewsListFragment())
                <span class="hljs-selector-class">.add</span>(R.id.news_detail_container, new NewsDetailFragment())
                <span class="hljs-selector-class">.commit</span>();
        }
    }
​
    <span class="hljs-keyword">@Override</span>
    public void onNewsSelected(NewsItem newsItem) {
        <span class="hljs-comment">// 平板版：直接更新详情Fragment</span>
        NewsDetailFragment detailFragment =
            (NewsDetailFragment) <span class="hljs-built_in">getSupportFragmentManager</span>()
                <span class="hljs-selector-class">.findFragmentById</span>(R.id.news_detail_container);
​
        if (detailFragment != null) {
            detailFragment<span class="hljs-selector-class">.showNewsDetail</span>(newsItem);
        }
    }
}
</code></pre>
<p>"这样，NewsListFragment和NewsDetailFragment的代码只需要写一次，但在不同的Activity中可以有不同的使用方式。"</p>
<h4 data-id="heading-7">3. 更好的生命周期管理</h4>
<p>"Fragment有自己的生命周期，但它始终依赖于Activity。"李工继续解释，"这种设计让UI组件的管理更加精细化。"</p>
<p>他再次在纸上画了一个生命周期图：</p>
<pre><code class="hljs">Activity生命周期：
    onCreate → onStart → onResume → onPause → onStop → onDestroy
         │        │        │        │        │        │
         ▼        ▼        ▼        ▼        ▼        ▼
Fragment生命周期：
    onAttach → onCreate → onCreateView → onViewCreated →
    onStart → onResume → onPause → onStop → onDestroyView → onDestroy → onDetach
</code></pre>
<p>"Fragment的生命周期比Activity更细致，"李工解释道，"比如<code>onCreateView</code>和<code>onDestroyView</code>专门管理View的创建和销毁，而<code>onAttach</code>和<code>onDetach</code>管理Fragment与Activity的绑定关系。这种细粒度的控制在复杂应用中非常有用。"</p>
<h3 data-id="heading-8">Fragment的三种创建方式</h3>
<p>"理论讲得差不多了，让我们看看实际怎么创建Fragment。"李工切换到IDE，开始演示。</p>
<h4 data-id="heading-9">方式一：静态加载（XML中声明）</h4>
<p>"最简单的方式是在XML布局文件中直接声明Fragment："李工创建了一个新的布局文件。</p>
<pre><code class="hljs language-ini" lang="ini">&lt;!-- activity_main_static.xml --&gt;
&lt;LinearLayout xmlns:<span class="hljs-attr">android</span>=<span class="hljs-string">"http://schemas.android.com/apk/res/android"</span>
    android:<span class="hljs-attr">layout_width</span>=<span class="hljs-string">"match_parent"</span>
    android:<span class="hljs-attr">layout_height</span>=<span class="hljs-string">"match_parent"</span>
    android:<span class="hljs-attr">orientation</span>=<span class="hljs-string">"horizontal"</span>&gt;
​
    &lt;!-- 静态加载Fragment --&gt;
    &lt;fragment
        android:<span class="hljs-attr">id</span>=<span class="hljs-string">"@+id/news_list_fragment"</span>
        android:<span class="hljs-attr">name</span>=<span class="hljs-string">"com.example.newshub.NewsListFragment"</span>
        android:<span class="hljs-attr">layout_width</span>=<span class="hljs-string">"0dp"</span>
        android:<span class="hljs-attr">layout_height</span>=<span class="hljs-string">"match_parent"</span>
        android:<span class="hljs-attr">layout_weight</span>=<span class="hljs-string">"1"</span> /&gt;
​
    &lt;fragment
        android:<span class="hljs-attr">id</span>=<span class="hljs-string">"@+id/news_detail_fragment"</span>
        android:<span class="hljs-attr">name</span>=<span class="hljs-string">"com.example.newshub.NewsDetailFragment"</span>
        android:<span class="hljs-attr">layout_width</span>=<span class="hljs-string">"0dp"</span>
        android:<span class="hljs-attr">layout_height</span>=<span class="hljs-string">"match_parent"</span>
        android:<span class="hljs-attr">layout_weight</span>=<span class="hljs-string">"1"</span> /&gt;
​
&lt;/LinearLayout&gt;
</code></pre>
<p>"静态加载的好处是简单直观，"李工解释，"Fragment会随着Activity的创建而自动创建。但缺点是不够灵活，一旦在XML中声明就不能在运行时更改。"</p>
<p>对应的Activity代码非常简单：</p>
<pre><code class="hljs language-scala" lang="scala">public <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MainActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AppCompatActivity</span> </span>{
​
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> void onCreate(<span class="hljs-type">Bundle</span> savedInstanceState) {
        <span class="hljs-keyword">super</span>.onCreate(savedInstanceState);
        setContentView(<span class="hljs-type">R</span>.layout.activity_main_static);
​
        <span class="hljs-comment">// 可以通过findViewById获取Fragment实例</span>
        <span class="hljs-type">NewsListFragment</span> listFragment = (<span class="hljs-type">NewsListFragment</span>)
            getSupportFragmentManager().findFragmentById(<span class="hljs-type">R</span>.id.news_list_fragment);
        <span class="hljs-type">NewsDetailFragment</span> detailFragment = (<span class="hljs-type">NewsDetailFragment</span>)
            getSupportFragmentManager().findFragmentById(<span class="hljs-type">R</span>.id.news_detail_fragment);
    }
}
</code></pre>
<h4 data-id="heading-10">方式二：动态加载（代码中添加）</h4>
<p>"更常用的方式是动态加载，"李工继续演示，"这样可以在运行时根据需要添加、替换、移除Fragment。"</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- activity_main_dynamic.xml --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">FrameLayout</span> <span class="hljs-attr">xmlns:android</span>=<span class="hljs-string">"http://schemas.android.com/apk/res/android"</span>
    <span class="hljs-attr">android:id</span>=<span class="hljs-string">"@+id/fragment_container"</span>
    <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"match_parent"</span>
    <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"match_parent"</span> /&gt;</span>
</code></pre>
<pre><code class="hljs language-scala" lang="scala">public <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MainActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AppCompatActivity</span> </span>{
​
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> void onCreate(<span class="hljs-type">Bundle</span> savedInstanceState) {
        <span class="hljs-keyword">super</span>.onCreate(savedInstanceState);
        setContentView(<span class="hljs-type">R</span>.layout.activity_main_dynamic);
​
        <span class="hljs-comment">// 动态添加Fragment</span>
        <span class="hljs-keyword">if</span> (savedInstanceState == <span class="hljs-literal">null</span>) {
            <span class="hljs-type">NewsListFragment</span> listFragment = <span class="hljs-keyword">new</span> <span class="hljs-type">NewsListFragment</span>();
​
            getSupportFragmentManager()
                .beginTransaction()
                .add(<span class="hljs-type">R</span>.id.fragment_container, listFragment)
                .commit();
        }
    }
}
</code></pre>
<p>"动态加载的关键是<code>FragmentTransaction</code>，"李工强调，"所有的Fragment操作都需要通过事务来执行："</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// Fragment的基本操作</span>
FragmentTransaction transaction = <span class="hljs-built_in">getSupportFragmentManager</span>()<span class="hljs-selector-class">.beginTransaction</span>();
​
<span class="hljs-comment">// 添加Fragment</span>
transaction<span class="hljs-selector-class">.add</span>(R.id.fragment_container, newFragment);
​
<span class="hljs-comment">// 替换Fragment</span>
transaction<span class="hljs-selector-class">.replace</span>(R.id.fragment_container, newFragment);
​
<span class="hljs-comment">// 移除Fragment</span>
transaction<span class="hljs-selector-class">.remove</span>(oldFragment);
​
<span class="hljs-comment">// 隐藏Fragment（View被销毁但实例保留）</span>
transaction<span class="hljs-selector-class">.hide</span>(fragment);
​
<span class="hljs-comment">// 显示Fragment</span>
transaction<span class="hljs-selector-class">.show</span>(fragment);
​
<span class="hljs-comment">// 添加到回退栈（用户可以按返回键撤销这个操作）</span>
transaction<span class="hljs-selector-class">.addToBackStack</span>(null);
​
<span class="hljs-comment">// 提交事务</span>
transaction<span class="hljs-selector-class">.commit</span>();
</code></pre>
<h4 data-id="heading-11">方式三：工厂模式创建</h4>
<p>"在实际项目中，我推荐使用工厂模式创建Fragment，"李工分享了一个最佳实践，"这样可以确保Fragment总是以正确的方式被创建。"</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">NewsDetailFragment</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Fragment</span> {
​
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">ARG_NEWS_ITEM</span> <span class="hljs-operator">=</span> <span class="hljs-string">"news_item"</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">ARG_SHOW_COMMENT</span> <span class="hljs-operator">=</span> <span class="hljs-string">"show_comment"</span>;
​
    <span class="hljs-keyword">private</span> NewsItem newsItem;
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> showComment;
​
    <span class="hljs-comment">// 私有构造函数，强制使用工厂方法</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title function_">NewsDetailFragment</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// Required empty public constructor</span>
    }
​
    <span class="hljs-comment">/**
     * 工厂方法：创建新闻详情Fragment
     * <span class="hljs-doctag">@param</span> newsItem 要显示的新闻项
     * <span class="hljs-doctag">@param</span> showComment 是否显示评论区
     * <span class="hljs-doctag">@return</span> NewsDetailFragment实例
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> NewsDetailFragment <span class="hljs-title function_">newInstance</span><span class="hljs-params">(NewsItem newsItem, <span class="hljs-type">boolean</span> showComment)</span> {
        <span class="hljs-type">NewsDetailFragment</span> <span class="hljs-variable">fragment</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NewsDetailFragment</span>();
​
        <span class="hljs-comment">// 创建参数Bundle</span>
        <span class="hljs-type">Bundle</span> <span class="hljs-variable">args</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Bundle</span>();
        args.putParcelable(ARG_NEWS_ITEM, newsItem);
        args.putBoolean(ARG_SHOW_COMMENT, showComment);
​
        <span class="hljs-comment">// 设置参数</span>
        fragment.setArguments(args);
​
        <span class="hljs-keyword">return</span> fragment;
    }
​
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> Bundle savedInstanceState)</span> {
        <span class="hljs-built_in">super</span>.onCreate(savedInstanceState);
​
        <span class="hljs-comment">// 读取参数</span>
        <span class="hljs-type">Bundle</span> <span class="hljs-variable">args</span> <span class="hljs-operator">=</span> getArguments();
        <span class="hljs-keyword">if</span> (args != <span class="hljs-literal">null</span>) {
            newsItem = args.getParcelable(ARG_NEWS_ITEM);
            showComment = args.getBoolean(ARG_SHOW_COMMENT, <span class="hljs-literal">false</span>);
        }
    }
​
    <span class="hljs-meta">@Nullable</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> View <span class="hljs-title function_">onCreateView</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> LayoutInflater inflater,
                           <span class="hljs-meta">@Nullable</span> ViewGroup container,
                           <span class="hljs-meta">@Nullable</span> Bundle savedInstanceState)</span> {
        <span class="hljs-type">View</span> <span class="hljs-variable">view</span> <span class="hljs-operator">=</span> inflater.inflate(R.layout.fragment_news_detail, container, <span class="hljs-literal">false</span>);
​
        <span class="hljs-comment">// 使用参数初始化UI</span>
        initializeUI(view);
​
        <span class="hljs-keyword">return</span> view;
    }
​
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initializeUI</span><span class="hljs-params">(View view)</span> {
        <span class="hljs-type">TextView</span> <span class="hljs-variable">titleView</span> <span class="hljs-operator">=</span> view.findViewById(R.id.news_title);
        <span class="hljs-type">TextView</span> <span class="hljs-variable">contentView</span> <span class="hljs-operator">=</span> view.findViewById(R.id.news_content);
        <span class="hljs-type">View</span> <span class="hljs-variable">commentSection</span> <span class="hljs-operator">=</span> view.findViewById(R.id.comment_section);
​
        <span class="hljs-keyword">if</span> (newsItem != <span class="hljs-literal">null</span>) {
            titleView.setText(newsItem.getTitle());
            contentView.setText(newsItem.getContent());
            commentSection.setVisibility(showComment ? View.VISIBLE : View.GONE);
        }
    }
}
</code></pre>
<p>"工厂模式的优点是："</p>
<ol start="0">
<li><strong>参数安全</strong>：通过Bundle传递参数，确保参数在Fragment重建时不会丢失</li>
<li><strong>创建统一</strong>：所有Fragment都通过工厂方法创建，避免忘记设置必要参数</li>
<li><strong>代码清晰</strong>：调用者一看就知道需要哪些参数</li>
</ol>
<p>使用工厂模式创建Fragment：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 创建并显示新闻详情Fragment</span>
NewsItem selectedNews = <span class="hljs-built_in">getSelectedNewsItem</span>();
NewsDetailFragment detailFragment = NewsDetailFragment<span class="hljs-selector-class">.newInstance</span>(selectedNews, true);
​
<span class="hljs-built_in">getSupportFragmentManager</span>()
    <span class="hljs-selector-class">.beginTransaction</span>()
    <span class="hljs-selector-class">.replace</span>(R.id.fragment_container, detailFragment)
    <span class="hljs-selector-class">.addToBackStack</span>(null)  <span class="hljs-comment">// 添加到回退栈，用户可以返回</span>
    <span class="hljs-selector-class">.commit</span>();
</code></pre>
<h3 data-id="heading-12">实战重构：NewsHub的模块化改造</h3>
<p>"理论讲完了，现在让我们实际重构你的NewsHub应用。"李工拍了拍小安的肩膀，"你准备好开始这场模块化革命了吗？"</p>
<p>小安用力点头，眼中充满了兴奋："准备好了！李工，我们从哪里开始？"</p>
<p>"首先，我们需要识别应用中的UI模块。"李工在白板上画了一个思维导图：</p>
<pre><code class="hljs">NewsHub应用模块分析
├── 新闻列表模块
│   ├── 新闻条目显示
│   ├── 下拉刷新
│   └── 加载更多
├── 新闻详情模块
│   ├── 新闻内容显示
│   ├── 图片浏览
│   └── 分享功能
├── 用户中心模块
│   ├── 用户信息
│   ├── 设置选项
│   └── 历史记录
└── 搜索模块
    ├── 搜索框
    ├── 搜索结果
    └── 搜索历史
</code></pre>
<p>"根据这个分析，你的NewsHub至少需要4个核心Fragment：NewsListFragment、NewsDetailFragment、UserFragment和SearchFragment。"李工继续说道，"让我们先从最简单的开始：创建NewsListFragment。"</p>
<h4 data-id="heading-13">第一步：创建Fragment基类</h4>
<p>"在实际项目中，我建议先创建一个BaseFragment，"李工开始编写代码，"这样可以避免重复编写通用代码。"</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// BaseFragment.java</span>
<span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">abstract</span> <span class="hljs-selector-tag">class</span> <span class="hljs-selector-tag">BaseFragment</span> <span class="hljs-selector-tag">extends</span> <span class="hljs-selector-tag">Fragment</span> {
​
    <span class="hljs-selector-tag">protected</span> <span class="hljs-selector-tag">View</span> <span class="hljs-selector-tag">rootView</span>;
    <span class="hljs-selector-tag">protected</span> <span class="hljs-selector-tag">Context</span> <span class="hljs-selector-tag">context</span>;
    <span class="hljs-selector-tag">protected</span> <span class="hljs-selector-tag">FragmentActivity</span> <span class="hljs-selector-tag">activity</span>;
​
    @<span class="hljs-selector-tag">Override</span>
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">void</span> <span class="hljs-selector-tag">onAttach</span>(<span class="hljs-variable">@NonNull</span> Context context) {
        <span class="hljs-selector-tag">super</span><span class="hljs-selector-class">.onAttach</span>(context);
        <span class="hljs-selector-tag">this</span><span class="hljs-selector-class">.context</span> = <span class="hljs-selector-tag">context</span>;
        <span class="hljs-selector-tag">if</span> (context instanceof FragmentActivity) {
            <span class="hljs-selector-tag">this</span><span class="hljs-selector-class">.activity</span> = (FragmentActivity) <span class="hljs-selector-tag">context</span>;
        }
    }
​
    @<span class="hljs-selector-tag">Nullable</span>
    @<span class="hljs-selector-tag">Override</span>
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">View</span> <span class="hljs-selector-tag">onCreateView</span>(<span class="hljs-variable">@NonNull</span> LayoutInflater inflater,
                           <span class="hljs-variable">@Nullable</span> ViewGroup container,
                           <span class="hljs-variable">@Nullable</span> Bundle savedInstanceState) {
        <span class="hljs-comment">// 如果rootView已经创建，直接返回（避免重复创建）</span>
        <span class="hljs-selector-tag">if</span> (rootView != null) {
            <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">rootView</span>;
        }
​
        <span class="hljs-comment">// 获取布局ID</span>
        <span class="hljs-selector-tag">int</span> <span class="hljs-selector-tag">layoutId</span> = <span class="hljs-selector-tag">getLayoutId</span>();
        <span class="hljs-selector-tag">rootView</span> = <span class="hljs-selector-tag">inflater</span><span class="hljs-selector-class">.inflate</span>(layoutId, container, false);
​
        <span class="hljs-comment">// 初始化View</span>
        <span class="hljs-selector-tag">initView</span>();
​
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">rootView</span>;
    }
​
    @<span class="hljs-selector-tag">Override</span>
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">void</span> <span class="hljs-selector-tag">onViewCreated</span>(<span class="hljs-variable">@NonNull</span> View view,
                           <span class="hljs-variable">@Nullable</span> Bundle savedInstanceState) {
        <span class="hljs-selector-tag">super</span><span class="hljs-selector-class">.onViewCreated</span>(view, savedInstanceState);
​
        <span class="hljs-comment">// 设置数据和事件监听</span>
        <span class="hljs-selector-tag">initData</span>();
        <span class="hljs-selector-tag">initListener</span>();
    }
​
    @<span class="hljs-selector-tag">Override</span>
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">void</span> <span class="hljs-selector-tag">onDestroyView</span>() {
        <span class="hljs-selector-tag">super</span><span class="hljs-selector-class">.onDestroyView</span>();
        <span class="hljs-comment">// 清理资源</span>
        <span class="hljs-selector-tag">rootView</span> = <span class="hljs-selector-tag">null</span>;
    }
​
    <span class="hljs-comment">/**
     * 获取Fragment的布局ID
     */</span>
    <span class="hljs-selector-tag">protected</span> <span class="hljs-selector-tag">abstract</span> <span class="hljs-selector-tag">int</span> <span class="hljs-selector-tag">getLayoutId</span>();
​
    <span class="hljs-comment">/**
     * 初始化View
     */</span>
    <span class="hljs-selector-tag">protected</span> <span class="hljs-selector-tag">abstract</span> <span class="hljs-selector-tag">void</span> <span class="hljs-selector-tag">initView</span>();
​
    <span class="hljs-comment">/**
     * 初始化数据
     */</span>
    <span class="hljs-selector-tag">protected</span> <span class="hljs-selector-tag">abstract</span> <span class="hljs-selector-tag">void</span> <span class="hljs-selector-tag">initData</span>();
​
    <span class="hljs-comment">/**
     * 初始化事件监听
     */</span>
    <span class="hljs-selector-tag">protected</span> <span class="hljs-selector-tag">void</span> <span class="hljs-selector-tag">initListener</span>() {
        <span class="hljs-comment">// 子类可以重写此方法来设置监听器</span>
    }
​
    <span class="hljs-comment">/**
     * 显示Toast提示
     */</span>
    <span class="hljs-selector-tag">protected</span> <span class="hljs-selector-tag">void</span> <span class="hljs-selector-tag">showToast</span>(String message) {
        <span class="hljs-selector-tag">Toast</span><span class="hljs-selector-class">.makeText</span>(context, message, Toast.LENGTH_SHORT)<span class="hljs-selector-class">.show</span>();
    }
​
    <span class="hljs-comment">/**
     * 显示进度条
     */</span>
    <span class="hljs-selector-tag">protected</span> <span class="hljs-selector-tag">void</span> <span class="hljs-selector-tag">showProgressDialog</span>(String message) {
        <span class="hljs-comment">// 实现进度条显示逻辑</span>
        <span class="hljs-comment">// 这里可以封装一个通用的进度条工具类</span>
    }
​
    <span class="hljs-comment">/**
     * 隐藏进度条
     */</span>
    <span class="hljs-selector-tag">protected</span> <span class="hljs-selector-tag">void</span> <span class="hljs-selector-tag">hideProgressDialog</span>() {
        <span class="hljs-comment">// 实现进度条隐藏逻辑</span>
    }
}
</code></pre>
<p>"BaseFragment提供了Fragment的通用功能，"李工解释道，"这样每个具体的Fragment只需要关注自己的业务逻辑。"</p>
<h4 data-id="heading-14">第二步：创建NewsListFragment</h4>
<p>"现在让我们创建新闻列表Fragment："</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// NewsListFragment.java</span>
public class NewsListFragment extends BaseFragment
        implements SwipeRefreshLayout<span class="hljs-selector-class">.OnRefreshListener</span> {
​
    private static final String TAG = "NewsListFragment";
​
    <span class="hljs-comment">// UI组件</span>
    private RecyclerView recyclerView;
    private SwipeRefreshLayout swipeRefreshLayout;
    private ProgressBar progressBar;
    private TextView emptyView;
​
    <span class="hljs-comment">// 数据和适配器</span>
    private NewsAdapter newsAdapter;
    private List&lt;NewsItem&gt; newsList = new ArrayList&lt;&gt;();
​
    <span class="hljs-comment">// 分页相关</span>
    private int currentPage = <span class="hljs-number">1</span>;
    private boolean isLoading = false;
    private boolean hasMoreData = true;
​
    <span class="hljs-comment">// 回调接口</span>
    public interface OnNewsInteractionListener {
        void <span class="hljs-built_in">onNewsSelected</span>(NewsItem newsItem);
        void <span class="hljs-built_in">onNewsFavorite</span>(NewsItem newsItem);
        void <span class="hljs-built_in">onNewsShare</span>(NewsItem newsItem);
    }
​
    private OnNewsInteractionListener listener;
​
    public static NewsListFragment <span class="hljs-built_in">newInstance</span>() {
        return new <span class="hljs-built_in">NewsListFragment</span>();
    }
​
    <span class="hljs-keyword">@Override</span>
    public void onAttach(<span class="hljs-keyword">@NonNull</span> Context context) {
        super<span class="hljs-selector-class">.onAttach</span>(context);
        if (context instanceof OnNewsInteractionListener) {
            listener = (OnNewsInteractionListener) context;
        } else {
            throw new <span class="hljs-built_in">RuntimeException</span>(context.toString()
                + " must implement OnNewsInteractionListener");
        }
    }
​
    <span class="hljs-keyword">@Override</span>
    protected int getLayoutId() {
        return R<span class="hljs-selector-class">.layout</span><span class="hljs-selector-class">.fragment_news_list</span>;
    }
​
    <span class="hljs-keyword">@Override</span>
    protected void initView() {
        recyclerView = rootView<span class="hljs-selector-class">.findViewById</span>(R.id.recyclerView);
        swipeRefreshLayout = rootView<span class="hljs-selector-class">.findViewById</span>(R.id.swipeRefreshLayout);
        progressBar = rootView<span class="hljs-selector-class">.findViewById</span>(R.id.progressBar);
        emptyView = rootView<span class="hljs-selector-class">.findViewById</span>(R.id.emptyView);
​
        <span class="hljs-comment">// 设置下拉刷新</span>
        swipeRefreshLayout<span class="hljs-selector-class">.setOnRefreshListener</span>(this);
​
        <span class="hljs-comment">// 设置RecyclerView</span>
        <span class="hljs-built_in">setupRecyclerView</span>();
​
        <span class="hljs-comment">// 初始状态显示加载进度</span>
        <span class="hljs-built_in">showLoading</span>(true);
    }
​
    <span class="hljs-keyword">@Override</span>
    protected void initData() {
        <span class="hljs-comment">// 加载第一页数据</span>
        <span class="hljs-built_in">loadNewsData</span>(<span class="hljs-number">1</span>, true);
    }
​
    <span class="hljs-keyword">@Override</span>
    protected void initListener() {
        <span class="hljs-comment">// RecyclerView的滚动监听，用于实现加载更多</span>
        recyclerView<span class="hljs-selector-class">.addOnScrollListener</span>(new RecyclerView.OnScrollListener() {
            <span class="hljs-keyword">@Override</span>
            public void onScrolled(<span class="hljs-keyword">@NonNull</span> RecyclerView recyclerView,
                                 int dx, int dy) {
                super<span class="hljs-selector-class">.onScrolled</span>(recyclerView, dx, dy);
​
                if (!isLoading &amp;&amp; hasMoreData) {
                    LinearLayoutManager layoutManager =
                        (LinearLayoutManager) recyclerView<span class="hljs-selector-class">.getLayoutManager</span>();
​
                    if (layoutManager != null) {
                        int visibleItemCount = layoutManager<span class="hljs-selector-class">.getChildCount</span>();
                        int totalItemCount = layoutManager<span class="hljs-selector-class">.getItemCount</span>();
                        int pastVisibleItems = layoutManager<span class="hljs-selector-class">.findFirstVisibleItemPosition</span>();
​
                        <span class="hljs-comment">// 当滚动到最后几个item时，加载更多数据</span>
                        if ((visibleItemCount + pastVisibleItems) &gt;= totalItemCount
                            &amp;&amp; totalItemCount &gt; <span class="hljs-number">0</span>) {
                            <span class="hljs-built_in">loadNewsData</span>(currentPage + <span class="hljs-number">1</span>, false);
                        }
                    }
                }
            }
        });
    }
​
    private void <span class="hljs-built_in">setupRecyclerView</span>() {
        newsAdapter = new <span class="hljs-built_in">NewsAdapter</span>(newsList, new NewsAdapter.OnItemClickListener() {
            <span class="hljs-keyword">@Override</span>
            public void onItemClick(NewsItem newsItem) {
                if (listener != null) {
                    listener<span class="hljs-selector-class">.onNewsSelected</span>(newsItem);
                }
            }
​
            <span class="hljs-keyword">@Override</span>
            public void onFavoriteClick(NewsItem newsItem) {
                if (listener != null) {
                    listener<span class="hljs-selector-class">.onNewsFavorite</span>(newsItem);
                }
                <span class="hljs-comment">// 更新本地状态</span>
                newsItem<span class="hljs-selector-class">.setFavorite</span>(!newsItem.isFavorite());
                newsAdapter<span class="hljs-selector-class">.notifyDataSetChanged</span>();
            }
​
            <span class="hljs-keyword">@Override</span>
            public void onShareClick(NewsItem newsItem) {
                if (listener != null) {
                    listener<span class="hljs-selector-class">.onNewsShare</span>(newsItem);
                }
            }
        });
​
        recyclerView<span class="hljs-selector-class">.setLayoutManager</span>(new LinearLayoutManager(context));
        recyclerView<span class="hljs-selector-class">.setAdapter</span>(newsAdapter);
​
        <span class="hljs-comment">// 添加分割线</span>
        recyclerView<span class="hljs-selector-class">.addItemDecoration</span>(new DividerItemDecoration(context,
            DividerItemDecoration.VERTICAL));
    }
​
    private void <span class="hljs-built_in">loadNewsData</span>(int page, boolean isRefresh) {
        if (isLoading) return;
​
        isLoading = true;
​
        if (isRefresh) {
            currentPage = <span class="hljs-number">1</span>;
            hasMoreData = true;
            if (!swipeRefreshLayout.isRefreshing()) {
                <span class="hljs-built_in">showLoading</span>(true);
            }
        } else {
            <span class="hljs-built_in">showLoadMore</span>(true);
        }
​
        <span class="hljs-comment">// 模拟网络请求延迟</span>
        new <span class="hljs-built_in">Handler</span>()<span class="hljs-selector-class">.postDelayed</span>(() -&gt; {
            List&lt;NewsItem&gt; newData = NewsRepository<span class="hljs-selector-class">.getInstance</span>()
                <span class="hljs-selector-class">.getNewsList</span>(page, <span class="hljs-number">20</span>);
​
            if (getActivity() == null) return; <span class="hljs-comment">// Fragment已经detached</span>
​
            if (isRefresh) {
                newsList<span class="hljs-selector-class">.clear</span>();
                newsList<span class="hljs-selector-class">.addAll</span>(newData);
            } else {
                newsList<span class="hljs-selector-class">.addAll</span>(newData);
            }
​
            <span class="hljs-comment">// 检查是否还有更多数据</span>
            hasMoreData = newData<span class="hljs-selector-class">.size</span>() &gt;= <span class="hljs-number">20</span>;
            currentPage = page;
​
            <span class="hljs-comment">// 更新UI</span>
            newsAdapter<span class="hljs-selector-class">.notifyDataSetChanged</span>();
​
            <span class="hljs-comment">// 隐藏加载状态</span>
            <span class="hljs-built_in">showLoading</span>(false);
            <span class="hljs-built_in">showLoadMore</span>(false);
            swipeRefreshLayout<span class="hljs-selector-class">.setRefreshing</span>(false);
​
            <span class="hljs-comment">// 显示空状态</span>
            if (newsList.isEmpty()) {
                <span class="hljs-built_in">showEmptyView</span>(true);
            } else {
                <span class="hljs-built_in">showEmptyView</span>(false);
            }
​
            isLoading = false;
​
        }, <span class="hljs-number">1500</span>); <span class="hljs-comment">// 模拟1.5秒的网络延迟</span>
    }
​
    <span class="hljs-keyword">@Override</span>
    public void onRefresh() {
        <span class="hljs-built_in">loadNewsData</span>(<span class="hljs-number">1</span>, true);
    }
​
    private void <span class="hljs-built_in">showLoading</span>(boolean show) {
        progressBar<span class="hljs-selector-class">.setVisibility</span>(show ? View.VISIBLE : View.GONE);
        if (show) {
            recyclerView<span class="hljs-selector-class">.setVisibility</span>(View.GONE);
            emptyView<span class="hljs-selector-class">.setVisibility</span>(View.GONE);
        }
    }
​
    private void <span class="hljs-built_in">showLoadMore</span>(boolean show) {
        if (newsAdapter != null) {
            newsAdapter<span class="hljs-selector-class">.setLoading</span>(show);
        }
    }
​
    private void <span class="hljs-built_in">showEmptyView</span>(boolean show) {
        emptyView<span class="hljs-selector-class">.setVisibility</span>(show ? View.VISIBLE : View.GONE);
        recyclerView<span class="hljs-selector-class">.setVisibility</span>(show ? View.GONE : View.VISIBLE);
    }
​
    <span class="hljs-comment">/**
     * 刷新数据
     */</span>
    public void <span class="hljs-built_in">refresh</span>() {
        if (swipeRefreshLayout != null &amp;&amp; !swipeRefreshLayout.isRefreshing()) {
            swipeRefreshLayout<span class="hljs-selector-class">.setRefreshing</span>(true);
        }
        <span class="hljs-built_in">onRefresh</span>();
    }
​
    <span class="hljs-comment">/**
     * 获取当前新闻列表
     */</span>
    public List&lt;NewsItem&gt; <span class="hljs-built_in">getNewsList</span>() {
        return new ArrayList&lt;&gt;(newsList);
    }
}
</code></pre>
<p>"NewsListFragment实现了完整的新闻列表功能，"李工解释道，"包括下拉刷新、加载更多、空状态显示等。"</p>
<p>对应的布局文件：</p>
<pre><code class="hljs language-ini" lang="ini">&lt;!-- fragment_news_list.xml --&gt;
&lt;androidx.swiperefreshlayout.widget.SwipeRefreshLayout
    xmlns:<span class="hljs-attr">android</span>=<span class="hljs-string">"http://schemas.android.com/apk/res/android"</span>
    xmlns:<span class="hljs-attr">app</span>=<span class="hljs-string">"http://schemas.android.com/apk/res-auto"</span>
    android:<span class="hljs-attr">id</span>=<span class="hljs-string">"@+id/swipeRefreshLayout"</span>
    android:<span class="hljs-attr">layout_width</span>=<span class="hljs-string">"match_parent"</span>
    android:<span class="hljs-attr">layout_height</span>=<span class="hljs-string">"match_parent"</span>&gt;
​
    &lt;FrameLayout
        android:<span class="hljs-attr">layout_width</span>=<span class="hljs-string">"match_parent"</span>
        android:<span class="hljs-attr">layout_height</span>=<span class="hljs-string">"match_parent"</span>&gt;
​
        &lt;androidx.recyclerview.widget.RecyclerView
            android:<span class="hljs-attr">id</span>=<span class="hljs-string">"@+id/recyclerView"</span>
            android:<span class="hljs-attr">layout_width</span>=<span class="hljs-string">"match_parent"</span>
            android:<span class="hljs-attr">layout_height</span>=<span class="hljs-string">"match_parent"</span>
            android:<span class="hljs-attr">clipToPadding</span>=<span class="hljs-string">"false"</span>
            android:<span class="hljs-attr">paddingTop</span>=<span class="hljs-string">"8dp"</span>
            android:<span class="hljs-attr">paddingBottom</span>=<span class="hljs-string">"8dp"</span> /&gt;
​
        &lt;ProgressBar
            android:<span class="hljs-attr">id</span>=<span class="hljs-string">"@+id/progressBar"</span>
            android:<span class="hljs-attr">layout_width</span>=<span class="hljs-string">"wrap_content"</span>
            android:<span class="hljs-attr">layout_height</span>=<span class="hljs-string">"wrap_content"</span>
            android:<span class="hljs-attr">layout_gravity</span>=<span class="hljs-string">"center"</span>
            android:<span class="hljs-attr">visibility</span>=<span class="hljs-string">"gone"</span> /&gt;
​
        &lt;LinearLayout
            android:<span class="hljs-attr">id</span>=<span class="hljs-string">"@+id/emptyView"</span>
            android:<span class="hljs-attr">layout_width</span>=<span class="hljs-string">"wrap_content"</span>
            android:<span class="hljs-attr">layout_height</span>=<span class="hljs-string">"wrap_content"</span>
            android:<span class="hljs-attr">layout_gravity</span>=<span class="hljs-string">"center"</span>
            android:<span class="hljs-attr">orientation</span>=<span class="hljs-string">"vertical"</span>
            android:<span class="hljs-attr">visibility</span>=<span class="hljs-string">"gone"</span>&gt;
​
            &lt;ImageView
                android:<span class="hljs-attr">layout_width</span>=<span class="hljs-string">"64dp"</span>
                android:<span class="hljs-attr">layout_height</span>=<span class="hljs-string">"64dp"</span>
                android:<span class="hljs-attr">layout_gravity</span>=<span class="hljs-string">"center_horizontal"</span>
                android:<span class="hljs-attr">src</span>=<span class="hljs-string">"@drawable/ic_empty_news"</span>
                android:<span class="hljs-attr">tint</span>=<span class="hljs-string">"@color/textSecondary"</span> /&gt;
​
            &lt;TextView
                android:<span class="hljs-attr">layout_width</span>=<span class="hljs-string">"wrap_content"</span>
                android:<span class="hljs-attr">layout_height</span>=<span class="hljs-string">"wrap_content"</span>
                android:<span class="hljs-attr">layout_marginTop</span>=<span class="hljs-string">"16dp"</span>
                android:<span class="hljs-attr">text</span>=<span class="hljs-string">"暂无新闻"</span>
                android:<span class="hljs-attr">textColor</span>=<span class="hljs-string">"@color/textSecondary"</span>
                android:<span class="hljs-attr">textSize</span>=<span class="hljs-string">"16sp"</span> /&gt;
​
            &lt;Button
                android:<span class="hljs-attr">id</span>=<span class="hljs-string">"@+id/btnRetry"</span>
                android:<span class="hljs-attr">layout_width</span>=<span class="hljs-string">"wrap_content"</span>
                android:<span class="hljs-attr">layout_height</span>=<span class="hljs-string">"wrap_content"</span>
                android:<span class="hljs-attr">layout_marginTop</span>=<span class="hljs-string">"16dp"</span>
                android:<span class="hljs-attr">text</span>=<span class="hljs-string">"重新加载"</span> /&gt;
​
        &lt;/LinearLayout&gt;
​
    &lt;/FrameLayout&gt;
​
&lt;/androidx.swiperefreshlayout.widget.SwipeRefreshLayout&gt;
</code></pre>
<h4 data-id="heading-15">第三步：创建NewsDetailFragment</h4>
<p>"接下来是新闻详情Fragment："</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// NewsDetailFragment.java</span>
public class NewsDetailFragment extends BaseFragment {
​
    private static final String ARG_NEWS_ITEM = "news_item";
    private static final String TAG = "NewsDetailFragment";
​
    <span class="hljs-comment">// UI组件</span>
    private TextView titleView;
    private TextView contentView;
    private TextView authorView;
    private TextView timeView;
    private ImageView coverImageView;
    private WebView webView;
    private FloatingActionButton fabFavorite;
    private FloatingActionButton fabShare;
    private ProgressBar progressBar;
​
    <span class="hljs-comment">// 数据</span>
    private NewsItem newsItem;
    private boolean isLoading = true;
​
    <span class="hljs-comment">// 回调接口</span>
    public interface OnDetailInteractionListener {
        void <span class="hljs-built_in">onNewsShare</span>(NewsItem newsItem);
        void <span class="hljs-built_in">onNewsFavorite</span>(NewsItem newsItem, boolean isFavorite);
        void <span class="hljs-built_in">onAuthorClick</span>(String authorId);
    }
​
    private OnDetailInteractionListener listener;
​
    public static NewsDetailFragment <span class="hljs-built_in">newInstance</span>(NewsItem newsItem) {
        NewsDetailFragment fragment = new <span class="hljs-built_in">NewsDetailFragment</span>();
        Bundle args = new <span class="hljs-built_in">Bundle</span>();
        args<span class="hljs-selector-class">.putParcelable</span>(ARG_NEWS_ITEM, newsItem);
        fragment<span class="hljs-selector-class">.setArguments</span>(args);
        return fragment;
    }
​
    <span class="hljs-keyword">@Override</span>
    public void onAttach(<span class="hljs-keyword">@NonNull</span> Context context) {
        super<span class="hljs-selector-class">.onAttach</span>(context);
        if (context instanceof OnDetailInteractionListener) {
            listener = (OnDetailInteractionListener) context;
        }
    }
​
    <span class="hljs-keyword">@Override</span>
    protected int getLayoutId() {
        return R<span class="hljs-selector-class">.layout</span><span class="hljs-selector-class">.fragment_news_detail</span>;
    }
​
    <span class="hljs-keyword">@Override</span>
    protected void initView() {
        titleView = rootView<span class="hljs-selector-class">.findViewById</span>(R.id.news_title);
        contentView = rootView<span class="hljs-selector-class">.findViewById</span>(R.id.news_content);
        authorView = rootView<span class="hljs-selector-class">.findViewById</span>(R.id.news_author);
        timeView = rootView<span class="hljs-selector-class">.findViewById</span>(R.id.news_time);
        coverImageView = rootView<span class="hljs-selector-class">.findViewById</span>(R.id.news_cover);
        webView = rootView<span class="hljs-selector-class">.findViewById</span>(R.id.news_webview);
        fabFavorite = rootView<span class="hljs-selector-class">.findViewById</span>(R.id.fab_favorite);
        fabShare = rootView<span class="hljs-selector-class">.findViewById</span>(R.id.fab_share);
        progressBar = rootView<span class="hljs-selector-class">.findViewById</span>(R.id.progressBar);
​
        <span class="hljs-comment">// 设置WebView</span>
        <span class="hljs-built_in">setupWebView</span>();
​
        <span class="hljs-comment">// 初始状态</span>
        <span class="hljs-built_in">showLoading</span>(true);
    }
​
    <span class="hljs-keyword">@Override</span>
    protected void initData() {
        Bundle args = <span class="hljs-built_in">getArguments</span>();
        if (args != null) {
            newsItem = args<span class="hljs-selector-class">.getParcelable</span>(ARG_NEWS_ITEM);
            if (newsItem != null) {
                <span class="hljs-built_in">loadNewsDetail</span>();
            }
        }
    }
​
    <span class="hljs-keyword">@Override</span>
    protected void initListener() {
        <span class="hljs-comment">// 收藏按钮点击</span>
        fabFavorite<span class="hljs-selector-class">.setOnClickListener</span>(v -&gt; {
            if (newsItem != null &amp;&amp; listener != null) {
                boolean newFavoriteState = !newsItem<span class="hljs-selector-class">.isFavorite</span>();
                newsItem<span class="hljs-selector-class">.setFavorite</span>(newFavoriteState);
                <span class="hljs-built_in">updateFavoriteIcon</span>(newFavoriteState);
                listener<span class="hljs-selector-class">.onNewsFavorite</span>(newsItem, newFavoriteState);
            }
        });
​
        <span class="hljs-comment">// 分享按钮点击</span>
        fabShare<span class="hljs-selector-class">.setOnClickListener</span>(v -&gt; {
            if (newsItem != null &amp;&amp; listener != null) {
                listener<span class="hljs-selector-class">.onNewsShare</span>(newsItem);
            }
        });
​
        <span class="hljs-comment">// 作者点击</span>
        authorView<span class="hljs-selector-class">.setOnClickListener</span>(v -&gt; {
            if (newsItem != null &amp;&amp; listener != null) {
                listener<span class="hljs-selector-class">.onAuthorClick</span>(newsItem.getAuthorId());
            }
        });
    }
​
    private void <span class="hljs-built_in">setupWebView</span>() {
        WebSettings webSettings = webView<span class="hljs-selector-class">.getSettings</span>();
        webSettings<span class="hljs-selector-class">.setJavaScriptEnabled</span>(true);
        webSettings<span class="hljs-selector-class">.setDomStorageEnabled</span>(true);
        webSettings<span class="hljs-selector-class">.setAppCacheEnabled</span>(true);
        webSettings<span class="hljs-selector-class">.setCacheMode</span>(WebSettings.LOAD_DEFAULT);
​
        <span class="hljs-comment">// 启用缩放</span>
        webSettings<span class="hljs-selector-class">.setSupportZoom</span>(true);
        webSettings<span class="hljs-selector-class">.setBuiltInZoomControls</span>(true);
        webSettings<span class="hljs-selector-class">.setDisplayZoomControls</span>(false);
​
        <span class="hljs-comment">// 启用响应式布局</span>
        webSettings<span class="hljs-selector-class">.setUseWideViewPort</span>(true);
        webSettings<span class="hljs-selector-class">.setLoadWithOverviewMode</span>(true);
​
        webView<span class="hljs-selector-class">.setWebViewClient</span>(new WebViewClient() {
            <span class="hljs-keyword">@Override</span>
            public void onPageStarted(WebView view, String url, Bitmap favicon) {
                super<span class="hljs-selector-class">.onPageStarted</span>(view, url, favicon);
                isLoading = true;
                <span class="hljs-built_in">updateLoadingState</span>();
            }
​
            <span class="hljs-keyword">@Override</span>
            public void onPageFinished(WebView view, String url) {
                super<span class="hljs-selector-class">.onPageFinished</span>(view, url);
                isLoading = false;
                <span class="hljs-built_in">updateLoadingState</span>();
            }
​
            <span class="hljs-keyword">@Override</span>
            public void onReceivedError(WebView view, int errorCode,
                                       String description, String failingUrl) {
                super<span class="hljs-selector-class">.onReceivedError</span>(view, errorCode, description, failingUrl);
                <span class="hljs-built_in">showError</span>("加载失败：" + description);
            }
        });
    }
​
    private void <span class="hljs-built_in">loadNewsDetail</span>() {
        if (newsItem == null) return;
​
        <span class="hljs-comment">// 设置基本信息</span>
        titleView<span class="hljs-selector-class">.setText</span>(newsItem.getTitle());
        authorView<span class="hljs-selector-class">.setText</span>("作者：" + newsItem.getAuthor());
        timeView<span class="hljs-selector-class">.setText</span>(formatTime(newsItem.getPublishTime()));
​
        <span class="hljs-comment">// 加载封面图片</span>
        if (!TextUtils.isEmpty(newsItem.getCoverImageUrl())) {
            Picasso<span class="hljs-selector-class">.get</span>()
                <span class="hljs-selector-class">.load</span>(newsItem.getCoverImageUrl())
                <span class="hljs-selector-class">.placeholder</span>(R.drawable.placeholder_news)
                <span class="hljs-selector-class">.error</span>(R.drawable.error_news)
                <span class="hljs-selector-class">.into</span>(coverImageView);
        } else {
            coverImageView<span class="hljs-selector-class">.setVisibility</span>(View.GONE);
        }
​
        <span class="hljs-comment">// 更新收藏按钮状态</span>
        <span class="hljs-built_in">updateFavoriteIcon</span>(newsItem.isFavorite());
​
        <span class="hljs-comment">// 加载详细内容</span>
        <span class="hljs-built_in">loadDetailedContent</span>();
    }
​
    private void <span class="hljs-built_in">loadDetailedContent</span>() {
        <span class="hljs-comment">// 模拟加载详细内容</span>
        new <span class="hljs-built_in">Handler</span>()<span class="hljs-selector-class">.postDelayed</span>(() -&gt; {
            if (getActivity() == null) return;
​
            <span class="hljs-comment">// 如果有HTML内容，使用WebView显示</span>
            if (!TextUtils.isEmpty(newsItem.getHtmlContent())) {
                <span class="hljs-built_in">loadHtmlContent</span>(newsItem.getHtmlContent());
            } else {
                <span class="hljs-comment">// 否则显示纯文本内容</span>
                <span class="hljs-built_in">loadTextContent</span>(newsItem.getContent());
            }
​
            isLoading = false;
            <span class="hljs-built_in">updateLoadingState</span>();
​
        }, <span class="hljs-number">1000</span>);
    }
​
    private void <span class="hljs-built_in">loadHtmlContent</span>(String htmlContent) {
        <span class="hljs-comment">// 构建完整的HTML页面</span>
        String <span class="hljs-selector-tag">html</span> = <span class="hljs-built_in">buildHtmlPage</span>(htmlContent);
        webView<span class="hljs-selector-class">.loadDataWithBaseURL</span>(null, html, "text/html", "UTF-<span class="hljs-number">8</span>", null);
​
        webView<span class="hljs-selector-class">.setVisibility</span>(View.VISIBLE);
        contentView<span class="hljs-selector-class">.setVisibility</span>(View.GONE);
    }
​
    private void <span class="hljs-built_in">loadTextContent</span>(String textContent) {
        contentView<span class="hljs-selector-class">.setText</span>(textContent);
        contentView<span class="hljs-selector-class">.setVisibility</span>(View.VISIBLE);
        webView<span class="hljs-selector-class">.setVisibility</span>(View.GONE);
    }
​
    private String <span class="hljs-built_in">buildHtmlPage</span>(String content) {
        StringBuilder <span class="hljs-selector-tag">html</span> = new <span class="hljs-built_in">StringBuilder</span>();
        <span class="hljs-selector-tag">html</span><span class="hljs-selector-class">.append</span>("&lt;!DOCTYPE html&gt;");
        <span class="hljs-selector-tag">html</span><span class="hljs-selector-class">.append</span>("&lt;html&gt;");
        <span class="hljs-selector-tag">html</span><span class="hljs-selector-class">.append</span>("&lt;head&gt;");
        <span class="hljs-selector-tag">html</span><span class="hljs-selector-class">.append</span>("&lt;meta charset="UTF-<span class="hljs-number">8</span>"&gt;");
        <span class="hljs-selector-tag">html</span><span class="hljs-selector-class">.append</span>("&lt;meta name="viewport" content="width=device-width, initial-scale=<span class="hljs-number">1.0</span>"&gt;");
        <span class="hljs-selector-tag">html</span><span class="hljs-selector-class">.append</span>("&lt;style&gt;");
        <span class="hljs-selector-tag">html</span><span class="hljs-selector-class">.append</span>("body { font-family: Arial, sans-serif; font-size: <span class="hljs-number">16px</span>; line-height: <span class="hljs-number">1.6</span>; margin: <span class="hljs-number">16px</span>; }");
        <span class="hljs-selector-tag">html</span><span class="hljs-selector-class">.append</span>("img { max-width: <span class="hljs-number">100%</span>; height: auto; }");
        <span class="hljs-selector-tag">html</span><span class="hljs-selector-class">.append</span>("p { margin: <span class="hljs-number">16px</span> <span class="hljs-number">0</span>; }");
        <span class="hljs-selector-tag">html</span><span class="hljs-selector-class">.append</span>("h1, h2, h3 { color: #<span class="hljs-number">333</span>; }");
        <span class="hljs-selector-tag">html</span><span class="hljs-selector-class">.append</span>("&lt;/style&gt;");
        <span class="hljs-selector-tag">html</span><span class="hljs-selector-class">.append</span>("&lt;/head&gt;");
        <span class="hljs-selector-tag">html</span><span class="hljs-selector-class">.append</span>("&lt;body&gt;");
        <span class="hljs-selector-tag">html</span><span class="hljs-selector-class">.append</span>(content);
        <span class="hljs-selector-tag">html</span><span class="hljs-selector-class">.append</span>("&lt;/body&gt;");
        <span class="hljs-selector-tag">html</span><span class="hljs-selector-class">.append</span>("&lt;/html&gt;");
        return <span class="hljs-selector-tag">html</span><span class="hljs-selector-class">.toString</span>();
    }
​
    private void <span class="hljs-built_in">updateLoadingState</span>() {
        if (isLoading) {
            <span class="hljs-built_in">showLoading</span>(true);
        } else {
            <span class="hljs-built_in">showLoading</span>(false);
        }
    }
​
    private void <span class="hljs-built_in">showLoading</span>(boolean show) {
        progressBar<span class="hljs-selector-class">.setVisibility</span>(show ? View.VISIBLE : View.GONE);
    }
​
    private void <span class="hljs-built_in">showError</span>(String error) {
        if (getContext() != null) {
            Toast<span class="hljs-selector-class">.makeText</span>(getContext(), error, Toast<span class="hljs-selector-class">.LENGTH_SHORT</span>)<span class="hljs-selector-class">.show</span>();
        }
    }
​
    private void <span class="hljs-built_in">updateFavoriteIcon</span>(boolean isFavorite) {
        fabFavorite<span class="hljs-selector-class">.setImageResource</span>(isFavorite ?
            R.drawable.ic_favorite_filled : R.drawable.ic_favorite_border);
    }
​
    private String <span class="hljs-built_in">formatTime</span>(long timestamp) {
        Date date = new <span class="hljs-built_in">Date</span>(timestamp);
        SimpleDateFormat format = new <span class="hljs-built_in">SimpleDateFormat</span>("yyyy-MM-dd HH:mm", Locale.getDefault());
        return format<span class="hljs-selector-class">.format</span>(date);
    }
​
    <span class="hljs-comment">/**
     * 更新新闻内容
     */</span>
    public void <span class="hljs-built_in">updateNews</span>(NewsItem newsItem) {
        this<span class="hljs-selector-class">.newsItem</span> = newsItem;
        if (isAdded()) {
            <span class="hljs-built_in">loadNewsDetail</span>();
        }
    }
​
    <span class="hljs-comment">/**
     * 分享新闻
     */</span>
    public void <span class="hljs-built_in">shareNews</span>() {
        if (newsItem != null &amp;&amp; listener != null) {
            listener<span class="hljs-selector-class">.onNewsShare</span>(newsItem);
        }
    }
}
</code></pre>
<h3 data-id="heading-16">Activity的重构</h3>
<p>"现在Fragment都准备好了，让我们重构Activity："李工开始创建新的Activity结构。</p>
<h4 data-id="heading-17">单Activity架构</h4>
<p>"现代Android开发推荐使用单Activity + 多Fragment的架构，"李工解释道，"这样可以避免Activity之间跳转的开销，同时提供更流畅的用户体验。"</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// MainActivity.java</span>
public class MainActivity extends AppCompatActivity implements
        NewsListFragment<span class="hljs-selector-class">.OnNewsInteractionListener</span>,
        NewsDetailFragment<span class="hljs-selector-class">.OnDetailInteractionListener</span> {
​
    private static final String TAG = "MainActivity";
​
    <span class="hljs-comment">// Fragment容器ID</span>
    private static final int FRAGMENT_CONTAINER_ID = R<span class="hljs-selector-class">.id</span><span class="hljs-selector-class">.fragment_container</span>;
​
    <span class="hljs-comment">// 当前显示的Fragment</span>
    private Fragment currentFragment;
​
    <span class="hljs-comment">// 是否是平板布局</span>
    private boolean isTwoPane;
​
    <span class="hljs-comment">// Fragment引用</span>
    private NewsListFragment newsListFragment;
    private NewsDetailFragment newsDetailFragment;
​
    <span class="hljs-keyword">@Override</span>
    protected void onCreate(Bundle savedInstanceState) {
        super<span class="hljs-selector-class">.onCreate</span>(savedInstanceState);
​
        <span class="hljs-comment">// 根据设备类型选择不同的布局</span>
        if (isTablet()) {
            <span class="hljs-built_in">setContentView</span>(R.layout.activity_main_tablet);
            isTwoPane = true;
        } else {
            <span class="hljs-built_in">setContentView</span>(R.layout.activity_main_phone);
            isTwoPane = false;
        }
​
        <span class="hljs-built_in">initFragments</span>();
​
        if (savedInstanceState == null) {
            <span class="hljs-built_in">showNewsList</span>();
        }
    }
​
    private boolean <span class="hljs-built_in">isTablet</span>() {
        return <span class="hljs-built_in">getResources</span>()<span class="hljs-selector-class">.getBoolean</span>(R.bool.isTablet);
    }
​
    private void <span class="hljs-built_in">initFragments</span>() {
        FragmentManager fm = <span class="hljs-built_in">getSupportFragmentManager</span>();
​
        newsListFragment = (NewsListFragment) fm<span class="hljs-selector-class">.findFragmentByTag</span>("news_list");
        newsDetailFragment = (NewsDetailFragment) fm<span class="hljs-selector-class">.findFragmentByTag</span>("news_detail");
​
        if (newsListFragment == null) {
            newsListFragment = NewsListFragment<span class="hljs-selector-class">.newInstance</span>();
        }
​
        if (newsDetailFragment == null &amp;&amp; isTwoPane) {
            newsDetailFragment = NewsDetailFragment<span class="hljs-selector-class">.newInstance</span>(null);
        }
    }
​
    private void <span class="hljs-built_in">showNewsList</span>() {
        FragmentTransaction ft = <span class="hljs-built_in">getSupportFragmentManager</span>()<span class="hljs-selector-class">.beginTransaction</span>();
​
        if (isTwoPane) {
            <span class="hljs-comment">// 平板：显示列表和详情</span>
            if (newsDetailFragment == null) {
                newsDetailFragment = NewsDetailFragment<span class="hljs-selector-class">.newInstance</span>(null);
            }
​
            ft<span class="hljs-selector-class">.replace</span>(R.id.news_list_container, newsListFragment, "news_list");
            ft<span class="hljs-selector-class">.replace</span>(R.id.news_detail_container, newsDetailFragment, "news_detail");
        } else {
            <span class="hljs-comment">// 手机：只显示列表</span>
            ft<span class="hljs-selector-class">.replace</span>(FRAGMENT_CONTAINER_ID, newsListFragment, "news_list");
        }
​
        ft<span class="hljs-selector-class">.commit</span>();
        currentFragment = newsListFragment;
    }
​
    <span class="hljs-keyword">@Override</span>
    public void onNewsSelected(NewsItem newsItem) {
        if (isTwoPane) {
            <span class="hljs-comment">// 平板：更新详情Fragment</span>
            if (newsDetailFragment != null) {
                newsDetailFragment<span class="hljs-selector-class">.updateNews</span>(newsItem);
            }
        } else {
            <span class="hljs-comment">// 手机：替换为详情Fragment</span>
            newsDetailFragment = NewsDetailFragment<span class="hljs-selector-class">.newInstance</span>(newsItem);
​
            <span class="hljs-built_in">getSupportFragmentManager</span>()
                <span class="hljs-selector-class">.beginTransaction</span>()
                <span class="hljs-selector-class">.replace</span>(FRAGMENT_CONTAINER_ID, newsDetailFragment, "news_detail")
                <span class="hljs-selector-class">.addToBackStack</span>("news_detail")
                <span class="hljs-selector-class">.commit</span>();
​
            currentFragment = newsDetailFragment;
        }
    }
​
    <span class="hljs-keyword">@Override</span>
    public void onNewsFavorite(NewsItem newsItem) {
        <span class="hljs-comment">// 处理收藏逻辑</span>
        NewsRepository<span class="hljs-selector-class">.getInstance</span>()<span class="hljs-selector-class">.updateFavoriteStatus</span>(newsItem);
        Toast<span class="hljs-selector-class">.makeText</span>(this, "已" + (newsItem.isFavorite() ? "收藏" : <span class="hljs-string">"取消收藏"</span>),
                      Toast.LENGTH_SHORT).<span class="hljs-built_in">show</span>();
    }
​
    <span class="hljs-keyword">@Override</span>
    public void onNewsShare(NewsItem newsItem) {
        <span class="hljs-comment">// 处理分享逻辑</span>
        <span class="hljs-built_in">shareNews</span>(newsItem);
    }
​
    <span class="hljs-keyword">@Override</span>
    public void onAuthorClick(String authorId) {
        <span class="hljs-comment">// 跳转到作者页面</span>
        AuthorFragment authorFragment = AuthorFragment<span class="hljs-selector-class">.newInstance</span>(authorId);
​
        <span class="hljs-built_in">getSupportFragmentManager</span>()
            <span class="hljs-selector-class">.beginTransaction</span>()
            <span class="hljs-selector-class">.replace</span>(FRAGMENT_CONTAINER_ID, authorFragment, "author")
            <span class="hljs-selector-class">.addToBackStack</span>("author")
            <span class="hljs-selector-class">.commit</span>();
​
        currentFragment = authorFragment;
    }
​
    <span class="hljs-keyword">@Override</span>
    public void onNewsFavorite(NewsItem newsItem, boolean isFavorite) {
        <span class="hljs-comment">// 处理详情页面的收藏操作</span>
        NewsRepository<span class="hljs-selector-class">.getInstance</span>()<span class="hljs-selector-class">.updateFavoriteStatus</span>(newsItem);
        Toast<span class="hljs-selector-class">.makeText</span>(this, "已" + (isFavorite ? "收藏" : "取消收藏"),
                      Toast<span class="hljs-selector-class">.LENGTH_SHORT</span>)<span class="hljs-selector-class">.show</span>();
    }
​
    private void <span class="hljs-built_in">shareNews</span>(NewsItem newsItem) {
        Intent shareIntent = new <span class="hljs-built_in">Intent</span>(Intent.ACTION_SEND);
        shareIntent<span class="hljs-selector-class">.setType</span>("text/plain");
        shareIntent<span class="hljs-selector-class">.putExtra</span>(Intent.EXTRA_SUBJECT, newsItem.getTitle());
        shareIntent<span class="hljs-selector-class">.putExtra</span>(Intent.EXTRA_TEXT, newsItem.getTitle() + "\n" + newsItem<span class="hljs-selector-class">.getShareUrl</span>());
        <span class="hljs-built_in">startActivity</span>(Intent.createChooser(shareIntent, "分享新闻"));
    }
​
    <span class="hljs-keyword">@Override</span>
    public void onBackPressed() {
        FragmentManager fm = <span class="hljs-built_in">getSupportFragmentManager</span>();
​
        if (fm.getBackStackEntryCount() &gt; <span class="hljs-number">0</span>) {
            fm<span class="hljs-selector-class">.popBackStack</span>();
        } else {
            super<span class="hljs-selector-class">.onBackPressed</span>();
        }
    }
}
</code></pre>
<p>对应的布局文件：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- activity_main_phone.xml --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">FrameLayout</span> <span class="hljs-attr">xmlns:android</span>=<span class="hljs-string">"http://schemas.android.com/apk/res/android"</span>
    <span class="hljs-attr">android:id</span>=<span class="hljs-string">"@+id/fragment_container"</span>
    <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"match_parent"</span>
    <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"match_parent"</span> /&gt;</span>
</code></pre>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- activity_main_tablet.xml --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">LinearLayout</span> <span class="hljs-attr">xmlns:android</span>=<span class="hljs-string">"http://schemas.android.com/apk/res/android"</span>
    <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"match_parent"</span>
    <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"match_parent"</span>
    <span class="hljs-attr">android:orientation</span>=<span class="hljs-string">"horizontal"</span>
    <span class="hljs-attr">android:baselineAligned</span>=<span class="hljs-string">"false"</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- 左侧：新闻列表 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">FrameLayout</span>
        <span class="hljs-attr">android:id</span>=<span class="hljs-string">"@+id/news_list_container"</span>
        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"0dp"</span>
        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"match_parent"</span>
        <span class="hljs-attr">android:layout_weight</span>=<span class="hljs-string">"1"</span> /&gt;</span>

    <span class="hljs-comment">&lt;!-- 右侧：新闻详情 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">FrameLayout</span>
        <span class="hljs-attr">android:id</span>=<span class="hljs-string">"@+id/news_detail_container"</span>
        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"0dp"</span>
        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"match_parent"</span>
        <span class="hljs-attr">android:layout_weight</span>=<span class="hljs-string">"1"</span> /&gt;</span>

<span class="hljs-tag">&lt;/<span class="hljs-name">LinearLayout</span>&gt;</span>
</code></pre>
<h3 data-id="heading-18">重构完成：模块化的胜利</h3>
<p>经过一下午的重构，NewsHub应用的架构焕然一新。小安看着重构后的代码，脸上露出了满意的笑容。</p>
<p>"李工，这简直太神奇了！"小安兴奋地说道，"代码重复率从70%降到了几乎为0，而且逻辑更清晰了！"</p>
<p>李工笑着点点头："这就是Fragment的力量。让我们总结一下这次重构的成果："</p>
<h4 data-id="heading-19">重构前后对比</h4>
<p><strong>重构前的问题：</strong></p>
<ol start="0">
<li>代码重复率高（70%以上）</li>
<li>手机/平板逻辑混合在一个Activity中</li>
<li>难以维护和扩展</li>
<li>违反了单一职责原则</li>
</ol>
<p><strong>重构后的优势：</strong></p>
<ol start="0">
<li><strong>代码复用性大幅提升</strong></li>
</ol>
<pre><code class="hljs language-ini" lang="ini">// NewsListFragment在手机和平板上完全复用
NewsListFragment <span class="hljs-attr">listFragment</span> = NewsListFragment.newInstance()<span class="hljs-comment">;</span>
</code></pre>
<ol start="2">
<li><strong>职责分离更清晰</strong></li>
</ol>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// Activity：负责Fragment的组装和管理</span>
<span class="hljs-comment">// NewsListFragment：负责新闻列表的显示和交互</span>
<span class="hljs-comment">// NewsDetailFragment：负责新闻详情的显示和交互</span>
</code></pre>
<ol start="3">
<li><strong>扩展性更强</strong></li>
</ol>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 轻松添加新的Fragment</span>
UserFragment userFragment = UserFragment<span class="hljs-selector-class">.newInstance</span>();
<span class="hljs-built_in">getSupportFragmentManager</span>()
    <span class="hljs-selector-class">.beginTransaction</span>()
    <span class="hljs-selector-class">.replace</span>(R.id.fragment_container, userFragment)
    <span class="hljs-selector-class">.addToBackStack</span>("user")
    <span class="hljs-selector-class">.commit</span>();
</code></pre>
<ol start="4">
<li><strong>测试更容易</strong></li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 每个Fragment可以独立测试</span>
<span class="hljs-meta">@Test</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testNewsListFragment</span><span class="hljs-params">()</span> {
    <span class="hljs-type">NewsListFragment</span> <span class="hljs-variable">fragment</span> <span class="hljs-operator">=</span> NewsListFragment.newInstance();
    <span class="hljs-comment">// 测试Fragment的逻辑</span>
}
</code></pre>
<h4 data-id="heading-20">代码质量指标对比</h4>



































<table><thead><tr><th>指标</th><th>重构前</th><th>重构后</th><th>改善幅度</th></tr></thead><tbody><tr><td>代码重复率</td><td>70%</td><td>5%</td><td>↓93%</td></tr><tr><td>类的平均行数</td><td>450行</td><td>200行</td><td>↓56%</td></tr><tr><td>圈复杂度</td><td>18</td><td>8</td><td>↓56%</td></tr><tr><td>单元测试覆盖率</td><td>35%</td><td>85%</td><td>↑143%</td></tr></tbody></table>
<h4 data-id="heading-21">Fragment设计原则总结</h4>
<p>李工在白板上写下了Fragment的核心设计原则：</p>
<p>"记住这五个Fragment设计原则，你的代码会一直保持高质量："</p>
<ol start="0">
<li>
<p><strong>单一职责原则</strong></p>
<ul>
<li>每个Fragment只负责一个特定的UI功能</li>
<li>NewsListFragment只管列表，NewsDetailFragment只管详情</li>
</ul>
</li>
<li>
<p><strong>依赖倒置原则</strong></p>
<ul>
<li>Fragment通过接口与Activity通信</li>
<li>不直接依赖具体的Activity实现</li>
</ul>
</li>
<li>
<p><strong>开闭原则</strong></p>
<ul>
<li>对扩展开放，对修改关闭</li>
<li>通过添加新Fragment来扩展功能</li>
</ul>
</li>
<li>
<p><strong>组合优于继承</strong></p>
<ul>
<li>Fragment作为UI组件的组合单元</li>
<li>Activity通过组合Fragment来构建复杂界面</li>
</ul>
</li>
<li>
<p><strong>生命周期意识</strong></p>
<ul>
<li>正确处理Fragment的生命周期</li>
<li>避免在Fragment销毁后执行回调</li>
</ul>
</li>
</ol>
<h3 data-id="heading-22">展望未来</h3>
<p>"小安，你觉得这次重构最大的收获是什么？"李工问道。</p>
<p>小安思考了一会儿，认真地回答："我觉得最大的收获是理解了<strong>模块化思维</strong>。以前我总是想着把所有功能都写在一个Activity里，现在学会了把复杂的功能拆分成独立的、可复用的模块。"</p>
<p>"非常好！"李工赞许地点头，"这正是Fragment的核心思想。而且这只是一个开始，随着你学习的深入，你会发现还有更多精彩的内容："</p>
<ol start="0">
<li>
<p><strong>Fragment通信的高级技巧</strong></p>
<ul>
<li>ViewModel + LiveData</li>
<li>Navigation Component</li>
<li>Shared ViewModel</li>
</ul>
</li>
<li>
<p><strong>Fragment的性能优化</strong></p>
<ul>
<li>懒加载机制</li>
<li>View缓存策略</li>
<li>内存管理</li>
</ul>
</li>
<li>
<p><strong>Fragment的进阶用法</strong></p>
<ul>
<li>嵌套Fragment</li>
<li>ViewPager + Fragment</li>
<li>DialogFragment</li>
</ul>
</li>
<li>
<p><strong>Fragment的最佳实践</strong></p>
<ul>
<li>架构模式集成</li>
<li>测试策略</li>
<li>调试技巧</li>
</ul>
</li>
</ol>
<p>"从下节课开始，我们将深入探索Fragment的生命周期。"李工看了一下表，"你会发现，理解生命周期是掌握Fragment的关键。"</p>
<p>小安兴奋地看着屏幕上重构后的代码，仿佛看到了一个全新的世界。这次与Fragment的初识，不仅解决了他眼前的技术难题，更重要的是打开了一扇通往Android高级开发的大门。</p>
<p>夕阳西下，办公室的灯光陆续熄灭，但小安的编程热情却前所未有地高涨。他迫不及待地想要开始下一段学习旅程，探索Fragment这个强大组件的更多奥秘。</p>
<p><strong>故事完</strong></p>
<hr/>
<h3 data-id="heading-23">知识要点总结</h3>
<h4 data-id="heading-24">Fragment的核心概念</h4>
<ol start="0">
<li><strong>Fragment是什么</strong>：UI模块化组件，可以嵌入Activity中</li>
<li><strong>为什么需要Fragment</strong>：解决多屏适配、代码复用、模块化开发等问题</li>
<li><strong>Fragment与Activity的关系</strong>：容器与模块的关系，Fragment依赖Activity</li>
</ol>
<h4 data-id="heading-25">Fragment的创建方式</h4>
<ol start="0">
<li><strong>静态加载</strong>：在XML中直接声明，简单但不灵活</li>
<li><strong>动态加载</strong>：在代码中通过FragmentTransaction管理，灵活性高</li>
<li><strong>工厂模式</strong>：推荐的创建方式，确保参数安全和创建统一</li>
</ol>
<h4 data-id="heading-26">Fragment的最佳实践</h4>
<ol start="0">
<li><strong>BaseFragment设计</strong>：提取通用功能，减少代码重复</li>
<li><strong>接口回调</strong>：Fragment与Activity的安全通信方式</li>
<li><strong>生命周期管理</strong>：正确处理各个生命周期阶段</li>
<li><strong>单Activity架构</strong>：现代Android开发的推荐模式</li>
</ol>
<h4 data-id="heading-27">实战技能</h4>
<ol start="0">
<li><strong>重构现有代码</strong>：将Activity-Based架构重构为Fragment-Based</li>
<li><strong>多屏适配</strong>：一套代码适配手机和平板</li>
<li><strong>模块化设计</strong>：将复杂功能拆分为独立模块</li>
<li><strong>代码质量提升</strong>：降低重复率，提高可维护性</li>
</ol>
<p>本章通过NewsHub应用的实际案例，完整展示了Fragment从理论到实践的整个过程，为后续章节的深入学习奠定了坚实的基础。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android Auto开发（0）-引言]]></title>    <link>https://juejin.cn/post/7577278843234746411</link>    <guid>https://juejin.cn/post/7577278843234746411</guid>    <pubDate>2025-11-28T01:59:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577278843234746411" data-draft-id="7577291435160141865" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android Auto开发（0）-引言"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2025-11-28T01:59:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="成都大菠萝"/> <meta itemprop="url" content="https://juejin.cn/user/289926799429805"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android Auto开发（0）-引言
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/289926799429805/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    成都大菠萝
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-28T01:59:35.000Z" title="Fri Nov 28 2025 01:59:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>Head Unit Integration Guide (HUIG) 4.3</strong></h2>
<h3 data-id="heading-1"><strong>第 0 章：引言（Introduction）</strong></h3>
<h4 data-id="heading-2"><strong>0. 引言概述</strong></h4>
<p>当今的移动设备集成了尖端技术——包括最新的硬件与软件、高速移动网络，以及不断扩展的互联服务与应用程序生态。这些技术的融合，为用户提供了全新的方式来通信、享受数字内容、获取信息、学习，并探索周围世界。</p>
<p>然而，<strong>这些设备并非为驾驶场景设计</strong>。在驾驶过程中直接操作手机存在显著的安全风险。</p>
<p>为此，<strong>Android Auto</strong>（<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.android.com%2Fauto" target="_blank" title="https://www.android.com/auto" ref="nofollow noopener noreferrer">www.android.com/auto</a>）应运而生。它实现了移动设备与车辆之间的无缝集成，使驾驶员能够通过一个<strong>更简单、更安全的车载界面</strong>，访问并控制移动设备上的技术功能。</p>
<p>本指南描述了如何通过 <strong>Android Auto Projection</strong>（AAP） 技术，使汽车<strong>车载信息娱乐系统</strong>（IVI） 能够利用现代移动设备的计算能力、连接能力和应用生态。<br/>
本文件面向希望在其<strong>车机</strong>（Head Unit, HU） 的汽车信息娱乐系统开发团队，旨在帮助其通过 Android Auto 认证。</p>
<blockquote>
<p>⚠️ <strong>注意</strong>：<br/>
本指南<strong>不涉及 AAP 协议底层实现细节</strong>（如序列化格式、网络帧结构等），这些由 Google 提供的 <strong>Sender/Receiver 库</strong> 在 HU 与移动设备（MD）两端自动处理。<br/>
如需协议细节，请参考：</p>
<ul>
<li><a href="/auto/resources/receiver-lib" target="_blank" title="/auto/resources/receiver-lib">AAP Receiver Library 文档</a></li>
<li><a href="/auto/resources/proto-spec" target="_blank" title="/auto/resources/proto-spec">Protocol Specification（协议规范）</a></li>
</ul>
</blockquote>
<hr/>
<h4 data-id="heading-3"><strong>0.1 规范性用语约定（Conventions）</strong></h4>
<p>本文档中使用的关键词 <strong>“MUST”</strong>（必须）、<strong>“MUST NOT”</strong>（不得）、<strong>“REQUIRED”</strong>（必需）、<strong>“SHALL”</strong>（应）、<strong>“SHALL NOT”</strong>（不应）、<strong>“SHOULD”</strong>（建议）、<strong>“SHOULD NOT”</strong>（不建议）、<strong>“RECOMMENDED”</strong>（推荐）、<strong>“MAY”</strong>（可以）、<strong>“OPTIONAL”</strong>（可选）等，均遵循 <strong>IETF RFC 2119 标准</strong> 的定义。</p>
<ul>
<li><strong>MUST / SHALL</strong>：表示绝对强制要求，违反将导致认证失败。</li>
<li><strong>SHOULD / RECOMMENDED</strong>：强烈建议遵循，以确保最佳用户体验。</li>
<li><strong>MAY / OPTIONAL</strong>：可选实现，不影响基本功能认证。</li>
</ul>
<hr/>
<h4 data-id="heading-4">**0.2 关于 Android Auto Projection（AAP）</h4>
<p><strong>Android Auto Projection</strong>（AAP） 是连接移动设备与车辆的桥梁，使驾驶员能够通过车辆提供的<strong>物理人机交互界面</strong>（HMI）（如触摸屏、旋钮、语音按钮等）来访问移动设备的功能。</p>
<p>在 AAP 架构中：</p>
<ul>
<li><strong>移动设备</strong>（MD）负责管理所有<strong>用户界面</strong>（UI）、<strong>应用逻辑</strong>、<strong>网络连接</strong>及<strong>计算资源</strong>；</li>
<li><strong>车机</strong>（HU）则作为显示与输入终端，接收来自 MD 的投影内容，并将用户操作反馈回 MD。</li>
</ul>
<p>这种架构充分发挥了<strong>车辆与移动设备各自的优势</strong>，共同打造最优驾驶体验：</p>

















<table><thead><tr><th>来源</th><th>提供的能力</th></tr></thead><tbody><tr><td><strong>车辆 HU</strong></td><td>• 更适合驾驶场景的 HMI（如大按钮、语音优先）<br/>• 高精度车辆数据（如 GPS、轮速、档位、燃油状态等），提供更准确的驾驶环境上下文</td></tr><tr><td><strong>移动设备</strong>（MD）</td><td>• 最新的计算硬件平台（如高性能 CPU/GPU）<br/>• 最新的操作系统与安全更新<br/>• 高速移动网络（5G/4G）连接云端服务<br/>• 快速迭代的软硬件生态（消费电子级更新节奏）</td></tr></tbody></table>
<blockquote>
<p>✅ <strong>核心理念</strong>：<strong>“App 在手机跑，界面在车机显”</strong> —— 手机是“大脑”，车机是“眼睛和手”。</p>
</blockquote>
<hr/>
<h4 data-id="heading-5">**0.3 传输层（Transport）</h4>
<p>AAP 协议本身是<strong>传输无关</strong>（transport-agnostic） 的，只要传输通道具备<strong>足够带宽与低延迟</strong>，即可运行。</p>
<p>目前官方平台支持的传输方式包括：</p>
<ul>
<li><strong>USB 2.0</strong>：自 Android Auto 诞生起即支持，为有线连接标准；</li>
<li><strong>无线局域网</strong>（Wi-Fi）：自 AAP v1.4 起支持，<strong>车机作为 Wi-Fi 接入点</strong>（AP），手机连接至 HU 建立点对点通信。</li>
</ul>
<blockquote>
<p>📌 <strong>图 0.1：Android Auto 网络栈</strong>（原文配图，此处略）<br/>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d8033d1ba58d436b8e7df0ea8a806889~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oiQ6YO95aSn6I-g6JCd:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764900014&amp;x-signature=Y%2BxzAAnUKlRSS1YJYOQJo7Jfrms%3D" alt="image.png" loading="lazy"/></p>
<p>展示了从物理层（USB/Wi-Fi）到 AAP 协议层，再到各功能通道的数据流向。</p>
</blockquote>
<hr/>
<h4 data-id="heading-6">**0.4 通信通道（Channels）</h4>
<p>AAP 协议定义了多个<strong>独立逻辑通道</strong>，用于在 MD 与 HU 之间高效传输不同类型的数据流：</p>


















































<table><thead><tr><th>通道名称</th><th>方向</th><th>功能说明</th></tr></thead><tbody><tr><td><strong>Control</strong>（控制通道）</td><td>双向</td><td>负责链路初始化、通道建立（如媒体、输入等子通道的协商）</td></tr><tr><td><strong>Video Output</strong>（视频输出）</td><td>MD → HU</td><td>传输 H.264 编码的视频流，用于在主中控屏显示 AAP 界面</td></tr><tr><td><strong>Audio Output</strong>（音频输出）</td><td>MD → HU</td><td>传输媒体音频（如音乐、导航提示音），通过车载扬声器播放</td></tr><tr><td><strong>Vehicle Data</strong>（车辆数据）</td><td>HU → MD</td><td>上传车辆传感器数据（如 GPS 位置、车速、转向角、燃油量等），供导航/应用使用</td></tr><tr><td><strong>Input</strong>（输入事件）</td><td>HU → MD</td><td>将车机 HMI 输入（触摸、按键、旋钮、方向盘控制等）发送至 MD，驱动应用交互</td></tr><tr><td><strong>Microphone Audio</strong>（麦克风音频）</td><td>HU → MD</td><td>传输车载麦克风采集的语音信号，用于语音搜索、通话等</td></tr><tr><td><strong>Bluetooth HFP</strong>（蓝牙免提）</td><td>双向</td><td>专用于电话通话的音频通道（符合 Bluetooth Hands-Free Profile）</td></tr><tr><td><strong>Application Status &amp; Data</strong>（应用状态与数据）</td><td>MD → HU</td><td>传输结构化元数据，如：<br/>• 导航指令（转弯提示、车道指引）<br/>• 媒体播放状态（歌曲名、进度、封面）</td></tr></tbody></table>
<blockquote>
<p>💡 <strong>设计优势</strong>：通道分离避免了音视频与控制信令互相干扰，提升系统鲁棒性。</p>
</blockquote>
<hr/>
<h4 data-id="heading-7">**0.5 车机（HU）组件与要求</h4>
<p>支持 AAP 的车机系统需包含以下<strong>高层组件</strong>（与 AAP 相关部分）：</p>





















<table><thead><tr><th>组件</th><th>说明</th></tr></thead><tbody><tr><td><strong>HU OS</strong>（车机操作系统）</td><td>运行车载信息娱乐系统的底层 OS，如 Android Automotive OS、Linux、QNX、Windows Embedded 等</td></tr><tr><td><strong>OS 适配层</strong>（OS Adaptation Layer）</td><td>HU OS 与 AAP Receiver 之间的抽象层，负责：<br/>• 实现 AAP Receiver 的接口绑定<br/>• 将 AAP 消息转换为 HU OS 原生调用（如 ALSA 音频、V4L2 视频、输入事件注入等）<br/>• Google 提供 <strong>Android 与 QNX 的参考实现源码</strong>，但<strong>不提供商业级二进制库</strong></td></tr><tr><td><strong>Android Auto Projection Receiver</strong>（AAP 接收器）</td><td>HU 端的 AAP 核心实现，以<strong>可移植 C++ 源码形式</strong>由 Google 提供给合作伙伴<br/>• 通过 OS 适配层与 HU 的视频、音频、连接、输入等子系统交互<br/>• 负责管理 AAP 会话生命周期、通道建立、错误恢复等</td></tr></tbody></table>
<blockquote>
<p>⚠️ <strong>重要提示</strong>：<br/>
本指南<strong>不涵盖 HU 完整软件栈</strong>（如 CAN 总线驱动、图形合成器、电源管理等），仅聚焦 AAP 集成相关部分。</p>
</blockquote>
<hr/>
<h4 data-id="heading-8">**0.6 车辆类型（Vehicle Types）</h4>
<p>AAP 可集成于以下类型的车辆信息娱乐系统：</p>

























<table><thead><tr><th>车辆类型</th><th>定义</th><th>集成要求</th></tr></thead><tbody><tr><td><strong>乘用车</strong>（Car）</td><td>无需商业驾照即可驾驶的车辆（如私家轿车、SUV）</td><td>✅ 支持（R00-010）</td></tr><tr><td><strong>后装车机</strong>（Aftermarket HU）</td><td>为乘用车设计的第三方替换主机</td><td>✅ 支持（R00-020）</td></tr><tr><td><strong>商用车/卡车</strong>（Truck）</td><td>需要商业驾照驾驶的车辆（如货运卡车、巴士）</td><td>✅ 支持（R00-030），但<strong>有特殊限制</strong></td></tr></tbody></table>
<h5 data-id="heading-9"><strong>针对卡车的强制要求</strong>（R00-060）</h5>
<p>由于 <strong>Google 地图等导航应用未针对商用车辆优化</strong>（如限高、限重、危险品路线等），若 AAP 集成于卡车 HU，则：</p>
<ul>
<li>
<p><strong>每次启动 AAP 时</strong>，HU <strong>必须</strong> 显示一条<strong>可关闭的原生免责声明</strong>，内容为：</p>
<blockquote>
<p>“Some Android Auto navigation apps are not designed for commercial vehicles and may not be used for navigation.”<br/>
（“部分 Android Auto 导航应用并非为商用车辆设计，不可用于导航。”）</p>
</blockquote>
</li>
<li>
<p><strong>例外</strong>（R00-070）：<br/>
若用户在某台手机上<strong>明确选择“不再显示”</strong>（如勾选 “Do Not Show Again”），则 HU <strong>可记住该设备的偏好</strong>，后续连接时不再弹出该提示。</p>
</li>
</ul>
<blockquote>
<p>🌍 <strong>本地化要求</strong>：免责声明文本需提供<strong>目标市场的官方语言翻译版本</strong>。</p>
</blockquote>
<hr/>
<h3 data-id="heading-10"><strong>总结</strong></h3>
<p>第 0 章明确了 Android Auto Projection 的<strong>设计哲学</strong>、<strong>技术架构</strong>、<strong>通信模型</strong>及<strong>适用范围</strong>，为后续章节的具体实现要求奠定了基础。开发团队需特别注意：</p>
<ol>
<li><strong>安全第一</strong>：所有设计围绕“减少驾驶分心”展开；</li>
<li><strong>职责分离</strong>：MD 负责计算与逻辑，HU 负责交互与传感；</li>
<li><strong>通道隔离</strong>：音视频、控制、数据独立传输，保障稳定性；</li>
<li><strong>合规强制</strong>：卡车场景的免责声明是认证硬性要求；</li>
<li><strong>参考实现</strong>：Google 提供 C++ 源码与 OS 适配参考，但需自行集成。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[TypeScript 中，Promise]]></title>    <link>https://juejin.cn/post/7577295460248698926</link>    <guid>https://juejin.cn/post/7577295460248698926</guid>    <pubDate>2025-11-28T02:19:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577295460248698926" data-draft-id="7577226119106445339" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="TypeScript 中，Promise"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-28T02:19:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="倚栏听风雨"/> <meta itemprop="url" content="https://juejin.cn/user/2682464103830750"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            TypeScript 中，Promise
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2682464103830750/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    倚栏听风雨
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-28T02:19:39.000Z" title="Fri Nov 28 2025 02:19:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    9
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 TypeScript 中，<code>Promise</code> 是处理异步操作的核心机制。相比于 JavaScript，TypeScript 中的 Promise 最大的优势在于<strong>类型安全（Type Safety）</strong>，它能让你明确知道异步操作返回的数据类型。</p>
<p>以下是关于 TypeScript 中 Promise 的详细介绍，从基础定义到高级用法。</p>
<hr/>
<h3 data-id="heading-0">1. 核心概念与泛型 (<code>Promise&lt;T&gt;</code>)</h3>
<p>在 TypeScript 中，<code>Promise</code> 是一个泛型接口，定义为 <strong><code>Promise&lt;T&gt;</code></strong>。</p>
<ul>
<li><strong><code>T</code></strong>: 代表 Promise <strong>成功（Resolved）</strong> 时返回的数据类型。</li>
<li>如果 Promise 不返回任何值（只处理过程），通常使用 <strong><code>Promise&lt;void&gt;</code></strong>。</li>
</ul>
<h4 data-id="heading-1">基本语法示例</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 显式声明返回类型为 string</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">myPromise</span>: <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">string</span>&gt; = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"异步执行"</span>)
  <span class="hljs-keyword">const</span> success = <span class="hljs-literal">true</span>;  <span class="hljs-comment">//---------&gt;New的时候 这块代码就被执行</span>
  <span class="hljs-keyword">if</span> (success) {
    <span class="hljs-title function_">resolve</span>(<span class="hljs-string">"操作成功!"</span>); <span class="hljs-comment">// 这里的参数必须是 string</span>
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"操作失败"</span>));
  }
});
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"主程序执行1"</span>)
myPromise.<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> {   <span class="hljs-comment">//---------&gt;拿到执行结果</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(data.<span class="hljs-property">length</span>); <span class="hljs-comment">// TS 知道 data 是 string，所以允许访问 .length</span>
});
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"主程序执行2"</span>)
</code></pre>
<p>运行输出结果</p>
<pre><code class="hljs language-typescript" lang="typescript">[<span class="hljs-variable constant_">LOG</span>]: <span class="hljs-string">"异步执行"</span>  
[<span class="hljs-variable constant_">LOG</span>]: <span class="hljs-string">"主程序执行1"</span>  
[<span class="hljs-variable constant_">LOG</span>]: <span class="hljs-string">"主程序执行2"</span>  
[<span class="hljs-variable constant_">LOG</span>]: <span class="hljs-number">5</span>
</code></pre>
<hr/>
<h3 data-id="heading-2">2. 创建 Promise 的方式</h3>
<h4 data-id="heading-3">2.1 使用构造函数 (<code>new Promise</code>)</h4>
<p>这是最基础的写法，构造函数接受一个执行器函数 <code>(resolve, reject) =&gt; void</code>。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">fetchUser</span>(<span class="hljs-params">id: <span class="hljs-built_in">number</span></span>): <span class="hljs-title class_">Promise</span>&lt;{ <span class="hljs-attr">id</span>: <span class="hljs-built_in">number</span>; <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span> }&gt; {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">if</span> (id &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-comment">// resolve 的参数必须符合 Promise&lt;{...}&gt; 中定义的结构</span>
        <span class="hljs-title function_">resolve</span>({ id, <span class="hljs-attr">name</span>: <span class="hljs-string">"Alice"</span> });
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-title function_">reject</span>(<span class="hljs-string">"ID 无效"</span>);
      }
    }, <span class="hljs-number">1000</span>);
  });
}
</code></pre>
<h4 data-id="heading-4">2.2 使用 <code>async</code> 和 <code>await</code> (推荐)</h4>
<p>这是现代开发的标准写法。<strong><code>async</code> 函数的返回值永远是一个 Promise</strong>。TS 会根据 <code>return</code> 的值自动推断 Promise 的泛型类型。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 写法 1: 自动推断</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getUser</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> <span class="hljs-string">"Alice"</span>; <span class="hljs-comment">// TS 推断返回类型为 Promise&lt;string&gt;</span>
}

<span class="hljs-comment">// 写法 2: 显式注解 (推荐，更规范)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getScore</span>(<span class="hljs-params"/>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">number</span>&gt; {
  <span class="hljs-keyword">return</span> <span class="hljs-number">100</span>;
}

<span class="hljs-comment">// 使用 await</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> score = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getScore</span>(); <span class="hljs-comment">// score 被推断为 number 类型</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(score);
}
</code></pre>
<hr/>
<h3 data-id="heading-5">3. Promise 的状态与回调</h3>
<p>Promise 有三种状态：<code>pending</code> (进行中), <code>fulfilled</code> (已成功), <code>rejected</code> (已失败)。</p>
<p>在 TS 中，<code>.then()</code> 链式调用时，类型会自动流转。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> p = <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-number">10</span>); <span class="hljs-comment">// 类型: Promise&lt;number&gt;</span>

p.<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">num</span>) =&gt;</span> {
  <span class="hljs-comment">// num 是 number</span>
  <span class="hljs-keyword">return</span> num.<span class="hljs-title function_">toString</span>(); <span class="hljs-comment">// 返回 string</span>
})
.<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">str</span>) =&gt;</span> {
  <span class="hljs-comment">// str 是 string (TS 自动推断)</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(str);
  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>; <span class="hljs-comment">// 返回 boolean</span>
})
.<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">bool</span>) =&gt;</span> {
  <span class="hljs-comment">// bool 是 boolean</span>
});
</code></pre>
<hr/>
<h3 data-id="heading-6">4. 静态方法 (Static Methods)</h3>
<p>TypeScript 对 Promise 的静态方法也有很好的类型支持。</p>
<h4 data-id="heading-7">4.1 <code>Promise.resolve&lt;T&gt;(value: T)</code></h4>
<p>创建一个立即成功的 Promise。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> p1 = <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-number">42</span>); <span class="hljs-comment">// Promise&lt;number&gt;</span>
<span class="hljs-keyword">const</span> p2 = <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>({ <span class="hljs-attr">name</span>: <span class="hljs-string">"Bob"</span> }); <span class="hljs-comment">// Promise&lt;{ name: string }&gt;</span>
</code></pre>
<h4 data-id="heading-8">4.2 <code>Promise.reject(reason: any)</code></h4>
<p>创建一个立即失败的 Promise。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> pFail = <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(<span class="hljs-string">"Error occurred"</span>); <span class="hljs-comment">// Promise&lt;never&gt;</span>
</code></pre>
<h4 data-id="heading-9">4.3 <code>Promise.all&lt;T[]&gt;(values: [])</code></h4>
<p>等待所有 Promise 完成。返回值的类型是一个元组（Tuple）或数组。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> pString = <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-string">"Hello"</span>);
<span class="hljs-keyword">const</span> pNumber = <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-number">123</span>);

<span class="hljs-comment">// TS 能够推断出 results 的类型是 [string, number]</span>
<span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>([pString, pNumber]).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">[str, num]</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(str.<span class="hljs-title function_">toUpperCase</span>()); <span class="hljs-comment">// 正常</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(num.<span class="hljs-title function_">toFixed</span>(<span class="hljs-number">2</span>));    <span class="hljs-comment">// 正常</span>
});
</code></pre>
<h4 data-id="heading-10">4.4 <code>Promise.allSettled&lt;T&gt;(...)</code></h4>
<p>等待所有 Promise 完成（无论成功或失败）。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> p1 = <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-number">10</span>);
<span class="hljs-keyword">const</span> p2 = <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(<span class="hljs-string">"error"</span>);

<span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">allSettled</span>([p1, p2]).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">results</span>) =&gt;</span> {
  results.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">result</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (result.<span class="hljs-property">status</span> === <span class="hljs-string">'fulfilled'</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(result.<span class="hljs-property">value</span>); <span class="hljs-comment">// TS 知道这里有 value</span>
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(result.<span class="hljs-property">reason</span>); <span class="hljs-comment">// TS 知道这里有 reason</span>
    }
  });
});
</code></pre>
<h4 data-id="heading-11">4.5 <code>Promise.race&lt;T&gt;(...)</code></h4>
<p>返回第一个改变状态（成功或失败）的 Promise 的结果。</p>
<hr/>
<h3 data-id="heading-12">5. 常见实战场景</h3>
<h4 data-id="heading-13">5.1 定义 API 响应接口</h4>
<p>这是前端开发中最常用的模式。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 1. 定义数据接口</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">User</span> {
  <span class="hljs-attr">id</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">email</span>: <span class="hljs-built_in">string</span>;
}

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">ApiResponse</span>&lt;T&gt; {
  <span class="hljs-attr">code</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-attr">data</span>: T;
  <span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span>;
}

<span class="hljs-comment">// 2. 模拟请求函数</span>
<span class="hljs-keyword">function</span> request&lt;T&gt;(<span class="hljs-attr">url</span>: <span class="hljs-built_in">string</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">ApiResponse</span>&lt;T&gt;&gt; {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =&gt;</span> {
    <span class="hljs-comment">// 模拟网络请求</span>
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-title function_">resolve</span>({
        <span class="hljs-attr">code</span>: <span class="hljs-number">200</span>,
        <span class="hljs-attr">data</span>: {} <span class="hljs-keyword">as</span> T, <span class="hljs-comment">// 这里只是为了演示，实际会有真实数据</span>
        <span class="hljs-attr">message</span>: <span class="hljs-string">"success"</span>
      });
    }, <span class="hljs-number">500</span>);
  });
}

<span class="hljs-comment">// 3. 使用</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">fetchUserProfile</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 明确告诉 request 返回的数据结构是 User</span>
  <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> request&lt;<span class="hljs-title class_">User</span>&gt;(<span class="hljs-string">'/api/user/1'</span>);
  
  <span class="hljs-keyword">if</span> (response.<span class="hljs-property">code</span> === <span class="hljs-number">200</span>) {
    <span class="hljs-comment">// TS 这里会有自动提示：response.data.email</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(response.<span class="hljs-property">data</span>.<span class="hljs-property">email</span>); 
  }
}
</code></pre>
<h4 data-id="heading-14">5.2 <code>Promise&lt;void&gt;</code> 用于不返回值的异步操作</h4>
<p>例如：初始化数据库、发送日志、等待几秒钟。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">delay</span>(<span class="hljs-params">ms: <span class="hljs-built_in">number</span></span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =&gt;</span> {
    <span class="hljs-built_in">setTimeout</span>(resolve, ms); <span class="hljs-comment">// 不需要传递参数给 resolve</span>
  });
}

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">run</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Start"</span>);
  <span class="hljs-keyword">await</span> <span class="hljs-title function_">delay</span>(<span class="hljs-number">1000</span>);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"End after 1s"</span>);
}
</code></pre>
<hr/>
<h3 data-id="heading-15">6. 错误处理 (Error Handling)</h3>
<p>在 TypeScript 中处理 Promise 错误时，有一个常见的痛点：<strong><code>catch</code> 中的 error 类型通常是 <code>any</code> 或 <code>unknown</code></strong>。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">task</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">await</span> <span class="hljs-title function_">someAsyncOperation</span>();
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-comment">// 默认情况下，error 是 unknown 类型 (TS 4.0+) 或 any</span>
    <span class="hljs-comment">// 你不能直接调用 error.message，除非你进行断言或类型收窄</span>
    
    <span class="hljs-keyword">if</span> (error <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Error</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(error.<span class="hljs-property">message</span>);
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"Unknown error:"</span>, error);
    }
  }
}
</code></pre>
<h3 data-id="heading-16">总结</h3>
<ol>
<li><strong>类型注解</strong>：始终使用 <code>Promise&lt;Type&gt;</code> 来明确异步操作返回的数据结构。</li>
<li><strong>Async/Await</strong>：优先使用 <code>async</code> 函数，它让代码看起来像同步代码，且 TS 能自动推断返回类型。</li>
<li><strong>泛型工具</strong>：利用 <code>Promise.all</code> 等组合工具时，TS 能够很好地处理元组类型推断。</li>
<li><strong>错误处理</strong>：注意 <code>catch</code> 块中的类型检查，使用 <code>instanceof Error</code> 是个好习惯。</li>
</ol>
<p>如果你有具体的代码场景需要分析，可以发给我，我帮你进一步讲解！</p>
<h3 data-id="heading-17">参考</h3>
<p><a href="https://juejin.cn/spost/7577300470520446985" target="_blank" title="https://juejin.cn/spost/7577300470520446985">详解 TypeScript 中，async 和 await</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[创建自己的第一个LangChainAI]]></title>    <link>https://juejin.cn/post/7577284409965199423</link>    <guid>https://juejin.cn/post/7577284409965199423</guid>    <pubDate>2025-11-28T00:47:31.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577284409965199423" data-draft-id="7577332659504873515" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="创建自己的第一个LangChainAI"/> <meta itemprop="keywords" content="LangChain"/> <meta itemprop="datePublished" content="2025-11-28T00:47:31.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="三点水769"/> <meta itemprop="url" content="https://juejin.cn/user/4396325087221915"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            创建自己的第一个LangChainAI
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4396325087221915/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    三点水769
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-28T00:47:31.000Z" title="Fri Nov 28 2025 00:47:31 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_">#</span><span class="bash"><span class="hljs-comment">#######################</span></span>
<span class="hljs-meta prompt_"># </span><span class="bash">LangSmith追踪功能配置</span>
<span class="hljs-meta prompt_">#</span><span class="bash"><span class="hljs-comment">#######################</span></span>
<span class="hljs-meta prompt_"># </span><span class="bash">导入操作系统相关功能</span>
import os
 
from langchain_core.messages import SystemMessage, HumanMessage
<span class="hljs-meta prompt_"># </span><span class="bash">导入base_url</span>
from openai import base_url
<span class="hljs-meta prompt_"> 
# </span><span class="bash">从自定义模块导入密钥加载函数</span>
from config.load_key import load_key
<span class="hljs-meta prompt_"> 
# </span><span class="bash">设置 LangSmith 追踪功能开启</span>
os.environ["LANGSMITH_TRACING"] = "true"
<span class="hljs-meta prompt_"> 
# </span><span class="bash">设置 LangSmith 项目名称</span>
os.environ["LANGSMITH_PROJECT"] = "firstLangChainDemo"
<span class="hljs-meta prompt_"> 
# </span><span class="bash">从配置文件加载 LangSmith API 密钥并设置环境变量</span>
os.environ["LANGSMITH_API_KEY"] = load_key("LANGSMITH_API_KEY")
 
<span class="hljs-meta prompt_"> 
#</span><span class="bash"><span class="hljs-comment">#######################</span></span>
<span class="hljs-meta prompt_"># </span><span class="bash">OpenAI服务配置_001</span>
<span class="hljs-meta prompt_">#</span><span class="bash"><span class="hljs-comment">#######################</span></span>
<span class="hljs-meta prompt_"># </span><span class="bash"><span class="hljs-comment"># 检查是否已设置 OpenAI API 密钥，如果没有则从配置文件加载</span></span>
<span class="hljs-meta prompt_"># </span><span class="bash"><span class="hljs-keyword">if</span> not os.environ.get(<span class="hljs-string">"OPENAI_API_KEY"</span>):</span>
<span class="hljs-meta prompt_"># </span><span class="bash">    os.environ[<span class="hljs-string">"OPENAI_API_KEY"</span>] = load_key(<span class="hljs-string">"OPENAI_API_KEY"</span>)</span>
<span class="hljs-meta prompt_">#</span><span class="bash">
<span class="hljs-comment"># # 从 LangChain 导入模型初始化函数</span></span>
<span class="hljs-meta prompt_"># </span><span class="bash">from langchain.chat_models import init_chat_model</span>
<span class="hljs-meta prompt_">#</span><span class="bash">
<span class="hljs-comment"># # model = init_chat_model("gpt-4o-mini", model_provider="openai")</span></span>
<span class="hljs-meta prompt_"># </span><span class="bash"><span class="hljs-comment"># 初始化聊天模型，使用 gpt-4o-mini 模型，通过指定的 base URL 连接</span></span>
<span class="hljs-meta prompt_"># </span><span class="bash">model = init_chat_model(<span class="hljs-string">"gpt-4o-mini"</span>, model_provider=<span class="hljs-string">"openai"</span>, base_url=<span class="hljs-string">"https://api.gptsapi.net/v1"</span>)</span>
 
 
<span class="hljs-meta prompt_"> 
#</span><span class="bash"><span class="hljs-comment">#######################</span></span>
<span class="hljs-meta prompt_"># </span><span class="bash">创建任务_001</span>
<span class="hljs-meta prompt_">#</span><span class="bash"><span class="hljs-comment">#######################</span></span>
<span class="hljs-meta prompt_"># </span><span class="bash"><span class="hljs-comment"># 从 LangChain 核心模块导入消息类型</span></span>
<span class="hljs-meta prompt_"># </span><span class="bash">from langchain_core.messages import HumanMessage, SystemMessage</span>
<span class="hljs-meta prompt_">#</span><span class="bash">
<span class="hljs-comment"># # 创建消息列表，包含系统指令和用户问题</span></span>
<span class="hljs-meta prompt_"># </span><span class="bash">messages = [</span>
<span class="hljs-meta prompt_"># </span><span class="bash">    <span class="hljs-comment"># 系统消息：设定模型行为（翻译任务）</span></span>
<span class="hljs-meta prompt_"># </span><span class="bash">    SystemMessage(content=<span class="hljs-string">"帮我把下面这句话翻译成中文"</span>),</span>
<span class="hljs-meta prompt_"># </span><span class="bash">    <span class="hljs-comment"># 用户消息：需要翻译的英文内容</span></span>
<span class="hljs-meta prompt_"># </span><span class="bash">    HumanMessage(content=<span class="hljs-string">"Hello, how are you?"</span>)</span>
<span class="hljs-meta prompt_"># </span><span class="bash">]</span>
<span class="hljs-meta prompt_">#</span><span class="bash">
<span class="hljs-comment"># # 调用模型处理消息列表，获取翻译结果</span></span>
<span class="hljs-meta prompt_"># </span><span class="bash">result = model.invoke(messages)</span>
<span class="hljs-meta prompt_">#</span><span class="bash">
<span class="hljs-comment"># print("翻译结果:", result.content)</span></span>
<span class="hljs-meta prompt_"># </span><span class="bash"><span class="hljs-built_in">print</span>(<span class="hljs-string">"完整返回对象:"</span>, result)</span>
<span class="hljs-meta prompt_"> 
# </span><span class="bash"><span class="hljs-comment">#AIMessage(content='你好，你好吗？', additional_kwargs={'refusal': None}, response_metadata={'token_usage': {'completion_tokens': 5, 'prompt_tokens': 27, 'total_tokens': 32, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_provider': 'openai', 'model_name': 'gpt-4o-mini', 'system_fingerprint': 'fp_efad92c60b', 'id': 'chatcmpl-Cf4DAyrWIgxwAp0gKqttJJBBSGaSu', 'finish_reason': 'stop', 'logprobs': None}, id='lc_run--0e8ed63b-1943-4c62-91fe-5208d43470ee-0', usage_metadata={'input_tokens': 27, 'output_tokens': 5, 'total_tokens': 32, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}})&gt;</span></span>
 
 
<span class="hljs-meta prompt_"> 
#</span><span class="bash"><span class="hljs-comment">#######################</span></span>
<span class="hljs-meta prompt_"># </span><span class="bash">OpenAI服务配置_002</span>
<span class="hljs-meta prompt_">#</span><span class="bash"><span class="hljs-comment">#######################</span></span>
<span class="hljs-meta prompt_"># </span><span class="bash"><span class="hljs-comment"># pip install -qU "langchain[openai]"</span></span>
<span class="hljs-meta prompt_"># </span><span class="bash"><span class="hljs-keyword">if</span> not os.environ.get(<span class="hljs-string">"OPENAI_API_KEY"</span>):</span>
<span class="hljs-meta prompt_"># </span><span class="bash">    os.environ[<span class="hljs-string">"OPENAI_API_KEY"</span>] = load_key(<span class="hljs-string">"OPENAI_API_KEY"</span>)</span>
<span class="hljs-meta prompt_">#</span><span class="bash">
<span class="hljs-comment"># from langchain_openai import ChatOpenAI</span></span>
<span class="hljs-meta prompt_">#</span><span class="bash">
<span class="hljs-comment"># llm = ChatOpenAI(model="gpt-4o-mini", base_url="https://api.gptsapi.net/v1")</span></span>
 
<span class="hljs-meta prompt_"> 
#</span><span class="bash"><span class="hljs-comment">#######################</span></span>
<span class="hljs-meta prompt_"># </span><span class="bash">创建任务_002</span>
<span class="hljs-meta prompt_">#</span><span class="bash"><span class="hljs-comment">#######################</span></span>
<span class="hljs-meta prompt_"># </span><span class="bash"><span class="hljs-comment"># 调用模型并获取结果</span></span>
<span class="hljs-meta prompt_"># </span><span class="bash">result = llm.invoke([SystemMessage(content=<span class="hljs-string">"帮我把下面这句话翻译成中文"</span>), HumanMessage(content=<span class="hljs-string">"Hello, how are you?"</span>)])</span>
<span class="hljs-meta prompt_">#</span><span class="bash">
<span class="hljs-comment"># # 打印返回值</span></span>
<span class="hljs-meta prompt_"># </span><span class="bash"><span class="hljs-built_in">print</span>(<span class="hljs-string">"翻译结果:"</span>, result.content)</span>
<span class="hljs-meta prompt_"># </span><span class="bash"><span class="hljs-built_in">print</span>(<span class="hljs-string">"完整返回对象:"</span>, result)</span>
 
<span class="hljs-meta prompt_"> 
#</span><span class="bash"><span class="hljs-comment">#######################</span></span>
<span class="hljs-meta prompt_"># </span><span class="bash">OpenAI服务配置_003</span>
<span class="hljs-meta prompt_">#</span><span class="bash"><span class="hljs-comment">#######################</span></span>
<span class="hljs-meta prompt_"># </span><span class="bash">from langchain_community.chat_models import ChatTongyi</span>
<span class="hljs-meta prompt_"># </span><span class="bash">from langchain_core.messages import SystemMessage, HumanMessage</span>
<span class="hljs-meta prompt_"># </span><span class="bash">llm = ChatTongyi(api_key=load_key(<span class="hljs-string">"TONGYI_API_KEY"</span>), model=<span class="hljs-string">"tongyi-v1.5-s-lite"</span>)</span>
if not os.environ.get("OPENAI_API_KEY"):
    os.environ["OPENAI_API_KEY"] = load_key("OPENAI_API_KEY")
from langchain_openai import ChatOpenAI
llm = ChatOpenAI(model="gpt-4o-mini", base_url="https://api.gptsapi.net/v1")
 
<span class="hljs-meta prompt_"> 
#</span><span class="bash"><span class="hljs-comment">#######################</span></span>
<span class="hljs-meta prompt_"># </span><span class="bash">创建任务_003</span>
<span class="hljs-meta prompt_">#</span><span class="bash"><span class="hljs-comment">#######################</span></span>
<span class="hljs-meta prompt_"># </span><span class="bash">llm.invoke([SystemMessage(content=<span class="hljs-string">"帮我把下面这句话翻译成中文"</span>), HumanMessage(content=<span class="hljs-string">"Hello, how are you?"</span>)])</span>
<span class="hljs-meta prompt_">#</span><span class="bash">result = llm.invoke([SystemMessage(content=<span class="hljs-string">"Help me write a poem."</span>), HumanMessage(content=<span class="hljs-string">"What is the meaning of life?"</span>)])</span>
result = llm.invoke([HumanMessage(content="你好，你是谁?能帮我解决什么问题？")])
print("结果:", result.content)
print("完整返回对象:", result)
</code></pre>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 导入操作系统模块，用于操作环境变量</span>
<span class="hljs-keyword">import</span> os
 
<span class="hljs-comment"># 从自定义的配置模块导入密钥加载函数，用于安全地获取API密钥</span>
<span class="hljs-keyword">from</span> config.load_key <span class="hljs-keyword">import</span> load_key
 
<span class="hljs-comment"># 设置LangSmith追踪功能为开启状态，用于监控和追踪LangChain应用的执行情况</span>
os.environ[<span class="hljs-string">"LANGSMITH_TRACING"</span>] = <span class="hljs-string">"true"</span>
 
<span class="hljs-comment"># 设置LangSmith项目名称，用于在LangSmith平台上标识当前项目</span>
os.environ[<span class="hljs-string">"LANGSMITH_PROJECT"</span>] = <span class="hljs-string">"firstLangChainDemo"</span>
 
<span class="hljs-comment"># 从配置文件中加载LangSmith的API密钥并设置到环境变量中</span>
os.environ[<span class="hljs-string">"LANGSMITH_API_KEY"</span>] = load_key(<span class="hljs-string">"LANGSMITH_API_KEY"</span>)
 
<span class="hljs-comment"># 检查环境变量中是否已存在OpenAI API密钥，如果不存在则从配置文件中加载</span>
<span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> os.environ.get(<span class="hljs-string">"OPENAI_API_KEY"</span>):
    os.environ[<span class="hljs-string">"OPENAI_API_KEY"</span>] = load_key(<span class="hljs-string">"OPENAI_API_KEY"</span>)
 
<span class="hljs-comment"># 从langchain_openai模块导入ChatOpenAI类，用于与OpenAI聊天模型交互</span>
<span class="hljs-keyword">from</span> langchain_openai <span class="hljs-keyword">import</span> ChatOpenAI
 
<span class="hljs-comment"># 从langchain_core.messages模块导入HumanMessage类，用于创建用户消息</span>
<span class="hljs-keyword">from</span> langchain_core.messages <span class="hljs-keyword">import</span> HumanMessage
 
<span class="hljs-comment"># 初始化ChatOpenAI实例，配置模型参数：</span>
<span class="hljs-comment"># - model: 使用gpt-4o-mini模型</span>
<span class="hljs-comment"># - base_url: 指定API基础URL为第三方代理地址</span>
<span class="hljs-comment"># - api_key: 从环境变量中获取API密钥</span>
<span class="hljs-comment"># - temperature: 设置为0.9，控制生成结果的随机性（越高越随机）</span>
llm = ChatOpenAI(model=<span class="hljs-string">"gpt-4o-mini"</span>, base_url=<span class="hljs-string">"https://api.gptsapi.net/v1"</span>,
                 api_key=os.environ[<span class="hljs-string">"OPENAI_API_KEY"</span>], temperature=<span class="hljs-number">0.9</span>)
 
<span class="hljs-comment"># 循环5次，每次调用模型生成不同的名字建议</span>
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">5</span>):
    <span class="hljs-comment"># 调用模型的invoke方法，传入包含取名请求的HumanMessage对象</span>
    result = llm.invoke([HumanMessage(content=<span class="hljs-string">"你好，我姓孙帮我给孩子取一个名字？返回值的字数大于等于2个字，小于等于3个字"</span>)])
 
    <span class="hljs-comment"># 打印模型返回的结果内容</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"结果:"</span>, result.content)
 
    <span class="hljs-comment"># 打印完整的返回对象，包含元数据等额外信息</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"完整返回对象:"</span>, result)
 
 
<span class="hljs-comment"># 结果: 好的，孙姓的名字可以考虑以下几个：</span>
<span class="hljs-comment">#</span>
<span class="hljs-comment"># 1. 孙雅婷</span>
<span class="hljs-comment"># 2. 孙子轩</span>
<span class="hljs-comment"># 3. 孙昊然</span>
<span class="hljs-comment"># 4. 孙雨晴</span>
<span class="hljs-comment"># 5. 孙思远</span>
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Langchain提示词模版]]></title>    <link>https://juejin.cn/post/7577309505710014527</link>    <guid>https://juejin.cn/post/7577309505710014527</guid>    <pubDate>2025-11-28T00:59:26.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577309505710014527" data-draft-id="7577291435159584809" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Langchain提示词模版"/> <meta itemprop="keywords" content="LangChain"/> <meta itemprop="datePublished" content="2025-11-28T00:59:26.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="三点水769"/> <meta itemprop="url" content="https://juejin.cn/user/4396325087221915"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Langchain提示词模版
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4396325087221915/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    三点水769
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-28T00:59:26.000Z" title="Fri Nov 28 2025 00:59:26 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    14
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><pre><code class="hljs language-lua" lang="lua">########################
# 提示词模版
########################
# 导入操作系统相关功能，用于环境变量操作
import <span class="hljs-built_in">os</span>
 
# 从自定义模块导入密钥加载函数，用于安全地加载API密钥
from <span class="hljs-built_in">config</span>.load_key import load_key
 
# 设置 LangSmith 追踪功能开启，启用LangChain的监控和追踪功能
<span class="hljs-built_in">os</span>.environ[<span class="hljs-string">"LANGSMITH_TRACING"</span>] = <span class="hljs-string">"true"</span>
 
# 设置 LangSmith 项目名称，用于在LangSmith平台上区分不同项目
<span class="hljs-built_in">os</span>.environ[<span class="hljs-string">"LANGSMITH_PROJECT"</span>] = <span class="hljs-string">"firstLangChainDemo"</span>
 
# 从配置文件加载 LangSmith API 密钥并设置环境变量
<span class="hljs-built_in">os</span>.environ[<span class="hljs-string">"LANGSMITH_API_KEY"</span>] = load_key(<span class="hljs-string">"LANGSMITH_API_KEY"</span>)
 
# 检查是否已设置 OpenAI API 密钥，如果没有则从配置文件加载
<span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">os</span>.environ.get(<span class="hljs-string">"OPENAI_API_KEY"</span>):
    <span class="hljs-built_in">os</span>.environ[<span class="hljs-string">"OPENAI_API_KEY"</span>] = load_key(<span class="hljs-string">"OPENAI_API_KEY"</span>)
 
# 从 langchain_core.prompts 模块导入 ChatPromptTemplate 类，用于创建聊天提示模板
from langchain_core.prompts import ChatPromptTemplate
 
# 创建聊天提示模板，包含系统消息和用户消息两部分
# 系统消息指示模型将英文翻译成指定语言，用户消息包含待翻译的文本
prompt_template = ChatPromptTemplate.from_messages([
    # 系统消息模板，使用 {language} 和 {text} 作为占位符
    (<span class="hljs-string">"system"</span>,<span class="hljs-string">"Translat the following from English into {language}"</span>),
    # 用户消息模板，包含待翻译的文本占位符
    (<span class="hljs-string">"user"</span>,<span class="hljs-string">"{text}"</span>)
])
 
# 使用指定参数实例化提示模板，将 {language} 替换为 <span class="hljs-string">"Chinese"</span>，{text} 替换为 <span class="hljs-string">"I love programming."</span>
prompt = prompt_template.invoke({<span class="hljs-string">"language"</span>:<span class="hljs-string">"Chinese"</span>,<span class="hljs-string">"text"</span>:<span class="hljs-string">"I love programming."</span>})
 
# 从 langchain_openai 模块导入 ChatOpenAI 类，用于与OpenAI模型交互
from langchain_openai import ChatOpenAI
 
# 初始化 ChatOpenAI 模型实例，指定模型名称、API基础URL和API密钥
llm = ChatOpenAI(model=<span class="hljs-string">"gpt-4o-mini"</span>, base_url=<span class="hljs-string">"https://api.gptsapi.net/v1"</span>, api_key=<span class="hljs-built_in">os</span>.environ[<span class="hljs-string">"OPENAI_API_KEY"</span>])
 
# 调用模型处理构建好的提示，获取翻译结果
result = llm.invoke(prompt)
 
# 打印翻译结果的内容部分
<span class="hljs-built_in">print</span>(<span class="hljs-string">"结果:"</span>, result.content)
 
# 打印完整的返回对象，包含更多元数据信息
<span class="hljs-built_in">print</span>(<span class="hljs-string">"完整返回对象:"</span>, result)
 
# 结果: 我爱编程。
# 完整返回对象: content=<span class="hljs-string">'我爱编程。'</span> additional_kwargs={<span class="hljs-string">'refusal'</span>: None} response_metadata={<span class="hljs-string">'token_usage'</span>: {<span class="hljs-string">'completion_tokens'</span>: <span class="hljs-number">6</span>, <span class="hljs-string">'prompt_tokens'</span>: <span class="hljs-number">23</span>, <span class="hljs-string">'total_tokens'</span>: <span class="hljs-number">29</span>, <span class="hljs-string">'completion_tokens_details'</span>: {<span class="hljs-string">'accepted_prediction_tokens'</span>: <span class="hljs-number">0</span>, <span class="hljs-string">'audio_tokens'</span>: <span class="hljs-number">0</span>, <span class="hljs-string">'reasoning_tokens'</span>: <span class="hljs-number">0</span>, <span class="hljs-string">'rejected_prediction_tokens'</span>: <span class="hljs-number">0</span>}, <span class="hljs-string">'prompt_tokens_details'</span>: {<span class="hljs-string">'audio_tokens'</span>: <span class="hljs-number">0</span>, <span class="hljs-string">'cached_tokens'</span>: <span class="hljs-number">0</span>}}, <span class="hljs-string">'model_provider'</span>: <span class="hljs-string">'openai'</span>, <span class="hljs-string">'model_name'</span>: <span class="hljs-string">'gpt-4o-mini'</span>, <span class="hljs-string">'system_fingerprint'</span>: <span class="hljs-string">'fp_efad92c60b'</span>, <span class="hljs-string">'id'</span>: <span class="hljs-string">'chatcmpl-CfoAf0Kq0Pyywkff8s5cCwvKOmtVx'</span>, <span class="hljs-string">'finish_reason'</span>: <span class="hljs-string">'stop'</span>, <span class="hljs-string">'logprobs'</span>: None} id=<span class="hljs-string">'lc_run--3d21e66b-571b-4d23-af2e-6eee27d07461-0'</span> usage_metadata={<span class="hljs-string">'input_tokens'</span>: <span class="hljs-number">23</span>, <span class="hljs-string">'output_tokens'</span>: <span class="hljs-number">6</span>, <span class="hljs-string">'total_tokens'</span>: <span class="hljs-number">29</span>, <span class="hljs-string">'input_token_details'</span>: {<span class="hljs-string">'audio'</span>: <span class="hljs-number">0</span>, <span class="hljs-string">'cache_read'</span>: <span class="hljs-number">0</span>}, <span class="hljs-string">'output_token_details'</span>: {<span class="hljs-string">'audio'</span>: <span class="hljs-number">0</span>, <span class="hljs-string">'reasoning'</span>: <span class="hljs-number">0</span>}}
 
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[YOLOv5 移植 RK3588 踩坑记录]]></title>    <link>https://juejin.cn/post/7577309505710424127</link>    <guid>https://juejin.cn/post/7577309505710424127</guid>    <pubDate>2025-11-28T01:43:26.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577309505710424127" data-draft-id="7577278843234582571" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="YOLOv5 移植 RK3588 踩坑记录  "/> <meta itemprop="keywords" content="嵌入式"/> <meta itemprop="datePublished" content="2025-11-28T01:43:26.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="二狗就是我"/> <meta itemprop="url" content="https://juejin.cn/user/2313028194286679"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            YOLOv5 移植 RK3588 踩坑记录  
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2313028194286679/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    二狗就是我
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-28T01:43:26.000Z" title="Fri Nov 28 2025 01:43:26 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">YOLOv5 移植 RK3588 踩坑记录</h2>
<p>（pt → onnx → rknn 全流程）</p>
<blockquote>
<p>环境：YOLOv5-5.x / rknn-toolkit2 / Python≥3.8
板卡：RK3588<br/>
目标：复用官方 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fairockchip%2Fyolov5_rknn" target="_blank" title="https://github.com/airockchip/yolov5_rknn" ref="nofollow noopener noreferrer">yolov5_rknn</a> 示例，仅替换 <code>*.rknn</code> + <code>*.yaml</code> 即可跑通</p>
</blockquote>
<hr/>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c58eb8206d5d4b36bc0a9c7e2ad21fe2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LqM54uX5bCx5piv5oiR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764899704&amp;x-signature=TjENZTmrR5txcw7bkrSNlSsuSQs%3D" alt="{AEE826FC-267B-4263-8DDB-7E01FC8B3176}.png" loading="lazy"/></p>
<h3 data-id="heading-1">1. pt → onnx 转换</h3>
<h4 data-id="heading-2">1.1 原生 export.py 直接转会报错</h4>
<pre><code class="hljs language-bash" lang="bash">python export.py --weights yolov5s.pt --include onnx
</code></pre>
<p>运行 rknn 示例 <code>test.py</code> 时：</p>
<pre><code class="hljs language-sql" lang="sql">IndexError: list index <span class="hljs-keyword">out</span> <span class="hljs-keyword">of</span> <span class="hljs-keyword">range</span>
</code></pre>
<p><strong>原因</strong>：Detect 层输出 tuple，而 rknn 示例只拿 list 第 1 个特征图。</p>
<hr/>
<h4 data-id="heading-3">1.2 修改 1：去掉 Detect 后处理，只输出 3 个 sigmoid 特征图</h4>
<p><strong>文件</strong> <code>models/yolo.py</code><br/>
<strong>类</strong> <code>Detect.forward()</code><br/>
<strong>原始代码</strong>（已注释）：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x</span>):
    z = []
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(self.nl):
        x[i] = self.m[i](x[i])  <span class="hljs-comment"># conv</span>
        bs, _, ny, nx = x[i].shape
        x[i] = x[i].view(bs, self.na, self.no, ny, nx).permute(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">2</span>).contiguous()
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> self.training:
            ...
            z.append(y.view(bs, self.na * nx * ny, self.no))
    <span class="hljs-keyword">return</span> x <span class="hljs-keyword">if</span> self.training <span class="hljs-keyword">else</span> (torch.cat(z, <span class="hljs-number">1</span>), ) <span class="hljs-keyword">if</span> self.export <span class="hljs-keyword">else</span> (torch.cat(z, <span class="hljs-number">1</span>), x)
</code></pre>
<p><strong>修改为</strong>：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x</span>):
    z = []
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(self.nl):
        z.append(torch.sigmoid(self.m[i](x[i])))  <span class="hljs-comment"># 仅卷积+sigmoid</span>
    <span class="hljs-keyword">return</span> z
</code></pre>
<blockquote>
<p>说明：</p>
<ol>
<li>不再做 <code>view/permute/grid/anchor</code> 等后处理；</li>
<li>返回 <code>List[Tensor]</code>，rknn 侧直接拿 3 个特征图。</li>
</ol>
</blockquote>
<hr/>
<h4 data-id="heading-4">1.3 修改 2：export.py 支持 list 类型输出</h4>
<p><strong>文件</strong> <code>export.py</code><br/>
<strong>位置</strong>：<code>run()</code> 函数里获取 output shape 处<br/>
<strong>原始</strong>：</p>
<pre><code class="hljs language-python" lang="python">shape = <span class="hljs-built_in">tuple</span>((y[<span class="hljs-number">0</span>] <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(y, <span class="hljs-built_in">tuple</span>) <span class="hljs-keyword">else</span> y).shape)
</code></pre>
<p><strong>改为</strong>：</p>
<pre><code class="hljs language-python" lang="python">shape = <span class="hljs-built_in">tuple</span>((y[<span class="hljs-number">0</span>] <span class="hljs-keyword">if</span> (<span class="hljs-built_in">isinstance</span>(y, <span class="hljs-built_in">tuple</span>) <span class="hljs-keyword">or</span> <span class="hljs-built_in">isinstance</span>(y, <span class="hljs-built_in">list</span>)) <span class="hljs-keyword">else</span> y).shape)
</code></pre>
<blockquote>
<p>保证 <code>y</code> 为 list 时也能正常取第 0 个元素。</p>
</blockquote>
<hr/>
<h4 data-id="heading-5">1.4 重新转 onnx</h4>
<pre><code class="hljs language-bash" lang="bash">python export.py --weights yolov5s.pt --include onnx
</code></pre>
<p>用 Netron 打开，确认尾部只剩 3 个 <code>Sigmoid</code> 节点，无 <code>Detect</code> 算子。</p>
<hr/>
<h3 data-id="heading-6">2. anchors 文件生成（踩坑 2）</h3>
<p><strong>背景</strong>：RKNN 示例后处理需要 anchors，必须与训练时保持一致。<br/>
<strong>工具</strong>：官方 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fairockchip%2Fyolov5_rknn" target="_blank" title="https://github.com/airockchip/yolov5_rknn" ref="nofollow noopener noreferrer">yolov5_rknn</a> 已提供 <code>export.py</code>，<strong>无需手动改 anchor</strong>。</p>
<pre><code class="hljs language-bash" lang="bash">git <span class="hljs-built_in">clone</span> https://github.com/airockchip/yolov5_rknn
<span class="hljs-built_in">cd</span> yolov5_rknn
python export.py --rknpu --weights car_tk_hanma.pt
</code></pre>
<p>执行完毕会自动生成：</p>
<pre><code class="hljs">RK_anchors.txt
</code></pre>
<p>内容示例（9 行）：</p>
<pre><code class="hljs language-erlang" lang="erlang"><span class="hljs-number">32.0</span>
<span class="hljs-number">32.0</span>
...
</code></pre>
<blockquote>
<p>若用自己改过的 export.py 忘记生成，会导致 rknn 推理框全部漂移或 0 检出。</p>
</blockquote>
<hr/>
<h3 data-id="heading-7">3. onnx → rknn</h3>
<ol>
<li>
<p>把上一步得到的 <code>*.onnx</code> + <code>RK_anchors.txt</code> 复制到<br/>
<code>rknn-toolkit2/examples/yolov5/python</code> 目录。</p>
</li>
<li>
<p>修改 <code>yaml</code> 文件（类别名/anchor 路径）：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">anchors_path:</span> <span class="hljs-string">RK_anchors.txt</span>
<span class="hljs-attr">names:</span> [<span class="hljs-string">'class1'</span>, <span class="hljs-string">'class2'</span>, <span class="hljs-string">...</span>]
</code></pre>
</li>
<li>
<p>执行：</p>
<pre><code class="hljs language-bash" lang="bash">python test.py
</code></pre>
<p>会自动完成 <code>onnx → rknn</code> 转换 + 板端推理。</p>
</li>
</ol>
<hr/>
<h3 data-id="heading-8">4. 一键总结</h3>






























<table><thead><tr><th>步骤</th><th>关键修改</th><th>文件</th></tr></thead><tbody><tr><td>① 去掉 Detect 后处理</td><td><code>forward</code> 返回 <code>List[sigmoid(feat)]</code></td><td><code>models/yolo.py</code></td></tr><tr><td>② export 支持 list</td><td><code>isinstance(y, tuple) or isinstance(y, list)</code></td><td><code>export.py</code></td></tr><tr><td>③ 生成 anchors</td><td>加 <code>--rknpu</code> 开关</td><td>官方 <code>export.py</code></td></tr><tr><td>④ 转 rknn</td><td>直接跑 <code>test.py</code></td><td>rknn-toolkit2 示例</td></tr></tbody></table>
<hr/>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7b52111f58f8450c838eaca2a4b18e39~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LqM54uX5bCx5piv5oiR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764899704&amp;x-signature=Y%2BQapJEN6ZtA0hc7eZeY9f1MhEc%3D" alt="003b5db7b30cf4d3cdb166b7c2bd8b6f.jpg" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[python在使用synchronized关键字时，需要注意哪些细节问题？]]></title>    <link>https://juejin.cn/post/7577291435159289897</link>    <guid>https://juejin.cn/post/7577291435159289897</guid>    <pubDate>2025-11-28T00:16:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577291435159289897" data-draft-id="7577278843234041899" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="python在使用synchronized关键字时，需要注意哪些细节问题？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-28T00:16:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户34584828505"/> <meta itemprop="url" content="https://juejin.cn/user/3710177917545754"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            python在使用synchronized关键字时，需要注意哪些细节问题？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3710177917545754/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户34584828505
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-28T00:16:03.000Z" title="Fri Nov 28 2025 00:16:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><code>synchronized</code> 是 Java 中最基础的线程同步关键字，虽然使用简单，但在实际开发中若忽略细节，容易导致 <strong>线程安全失效、性能瓶颈、死锁</strong> 等问题。以下是使用 <code>synchronized</code> 时必须注意的核心细节：</p>
<h3 data-id="heading-0">一、锁的对象选择：明确 “锁什么”（最易出错）</h3>
<p><code>synchronized</code> 的核心是 <strong>锁定 “对象”</strong> ，而非代码块或方法本身。锁的对象决定了同步范围，选不对会直接导致线程安全失效。</p>
<h4 data-id="heading-1">1. 实例方法锁（<code>synchronized void method()</code>）</h4>
<ul>
<li>
<p><strong>锁对象</strong>：当前实例（<code>this</code>）。</p>
</li>
<li>
<p><strong>细节 1</strong>：不同实例的锁相互独立，多线程操作不同实例时不会同步。</p>
<p>java</p>
<p>运行</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Counter</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">increment</span><span class="hljs-params">()</span> { count++; } <span class="hljs-comment">// 锁 this</span>
}

<span class="hljs-comment">// 错误场景：多线程操作不同实例，count 会出错</span>
<span class="hljs-type">Counter</span> <span class="hljs-variable">c1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Counter</span>();
<span class="hljs-type">Counter</span> <span class="hljs-variable">c2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Counter</span>();
<span class="hljs-comment">// 线程1操作 c1，线程2操作 c2，两者无锁竞争，count 可能统计不准确</span>
</code></pre>
</li>
<li>
<p><strong>细节 2</strong>：若实例被回收，锁会失效（需避免锁对象被频繁创建 / 销毁）。</p>
</li>
</ul>
<h4 data-id="heading-2">2. 静态方法锁（<code>synchronized static void method()</code>）</h4>
<ul>
<li>
<p><strong>锁对象</strong>：当前类的 <code>Class</code> 对象（全局唯一）。</p>
</li>
<li>
<p><strong>细节</strong>：所有实例共享同一把锁，即使操作不同实例，也会同步。适合需要 “全局唯一” 同步的场景（如单例模式、全局计数器）。</p>
<p>java</p>
<p>运行</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Counter</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-variable">globalCount</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">increment</span><span class="hljs-params">()</span> { globalCount++; } <span class="hljs-comment">// 锁 Counter.class</span>
}

<span class="hljs-comment">// 正确场景：多线程操作不同实例，也会同步 globalCount</span>
<span class="hljs-type">Counter</span> <span class="hljs-variable">c1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Counter</span>();
<span class="hljs-type">Counter</span> <span class="hljs-variable">c2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Counter</span>();
<span class="hljs-comment">// 线程1调用 c1.increment()，线程2调用 c2.increment()，会竞争同一把锁</span>
</code></pre>
</li>
</ul>
<h4 data-id="heading-3">3. 代码块锁（<code>synchronized(lockObj) {}</code>）</h4>
<ul>
<li>
<p><strong>锁对象</strong>：自定义的锁对象（需保证多线程共享同一实例）。</p>
</li>
<li>
<p><strong>核心细节</strong>：</p>
<ul>
<li>
<p>锁对象必须是 <strong>引用类型</strong>（不能是基本类型，如 <code>int</code>、<code>long</code>，会自动装箱为不同对象）。</p>
<p>java</p>
<p>运行</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 错误：锁对象是基本类型，每次自动装箱为新 Integer 对象，锁失效</span>
int lock = <span class="hljs-number">0</span>;
<span class="hljs-title function_">synchronized</span>(<span class="hljs-params">lock</span>) { ... } 

<span class="hljs-comment">// 正确：使用自定义引用类型，确保多线程共享同一实例</span>
<span class="hljs-title class_">Object</span> lock = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>(); <span class="hljs-comment">// 全局唯一锁对象</span>
<span class="hljs-title function_">synchronized</span>(<span class="hljs-params">lock</span>) { ... }
</code></pre>
</li>
<li>
<p>避免使用 <code>String</code>、<code>Integer</code> 等常量 / 缓存对象作为锁（可能因常量池复用导致锁冲突）。</p>
<p>java</p>
<p>运行</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 错误："lock" 是常量池对象，其他地方若也用 "lock" 作为锁，会导致无关代码同步</span>
<span class="hljs-title function_">synchronized</span>(<span class="hljs-params"><span class="hljs-string">"lock"</span></span>) { ... }
</code></pre>
</li>
<li>
<p>锁对象不能为 <code>null</code>（会抛出 <code>NullPointerException</code>）。</p>
</li>
</ul>
</li>
</ul>
<h3 data-id="heading-4">二、锁的粒度：避免 “过度同步” 或 “同步不足”</h3>
<p>锁的粒度直接影响性能，需在 “线程安全” 和 “性能” 之间平衡。</p>
<h4 data-id="heading-5">1. 避免 “锁粒度太大”（过度同步）</h4>
<ul>
<li>
<p>问题：将无关的操作都放在同一个 <code>synchronized</code> 块中，导致线程长时间阻塞，性能下降。</p>
</li>
<li>
<p>优化：仅对 “共享变量的修改 / 访问” 进行同步，缩小同步块范围。</p>
<p>java</p>
<p>运行</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 错误：同步块包含无关操作（日志打印、本地变量计算），线程阻塞时间长</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> synchronized <span class="hljs-keyword">void</span> <span class="hljs-title">update</span>()</span> {
    log.info(<span class="hljs-string">"开始更新"</span>); <span class="hljs-comment">// 无关操作，无需同步</span>
    <span class="hljs-built_in">int</span> temp = <span class="hljs-number">1</span> + <span class="hljs-number">2</span>;    <span class="hljs-comment">// 本地变量，无需同步</span>
    sharedVar = temp;    <span class="hljs-comment">// 仅这一步需要同步</span>
}

<span class="hljs-comment">// 正确：缩小同步块，仅包裹临界区</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">update</span>()</span> {
    log.info(<span class="hljs-string">"开始更新"</span>);
    <span class="hljs-built_in">int</span> temp = <span class="hljs-number">1</span> + <span class="hljs-number">2</span>;
    synchronized(<span class="hljs-keyword">lock</span>) {
        sharedVar = temp; <span class="hljs-comment">// 仅临界区同步</span>
    }
}
</code></pre>
</li>
</ul>
<h4 data-id="heading-6">2. 避免 “锁粒度太小”（同步不足）</h4>
<ul>
<li>
<p>问题：若多个操作需要原子性（如 “检查 - 修改 - 提交”），仅同步单个步骤会导致线程安全问题。</p>
</li>
<li>
<p>示例：</p>
<p>java</p>
<p>运行</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 错误：check 和 set 未原子化，多线程下可能重复初始化</span>
<span class="hljs-keyword">private</span> volatile <span class="hljs-title class_">Object</span> instance;
<span class="hljs-keyword">public</span> <span class="hljs-title class_">Object</span> <span class="hljs-title function_">getInstance</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (instance == <span class="hljs-literal">null</span>) { <span class="hljs-comment">// 检查（未同步）</span>
        <span class="hljs-title function_">synchronized</span>(<span class="hljs-params">lock</span>) {
            instance = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>(); <span class="hljs-comment">// 修改（同步）</span>
        }
    }
    <span class="hljs-keyword">return</span> instance;
}

<span class="hljs-comment">// 正确：双重检查锁（需配合 volatile 禁止重排序）</span>
<span class="hljs-keyword">public</span> <span class="hljs-title class_">Object</span> <span class="hljs-title function_">getInstance</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (instance == <span class="hljs-literal">null</span>) {
        <span class="hljs-title function_">synchronized</span>(<span class="hljs-params">lock</span>) {
            <span class="hljs-keyword">if</span> (instance == <span class="hljs-literal">null</span>) { <span class="hljs-comment">// 二次检查（同步内）</span>
                instance = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>();
            }
        }
    }
    <span class="hljs-keyword">return</span> instance;
}
</code></pre>
</li>
</ul>
<h3 data-id="heading-7">三、线程安全的边界：<code>synchronized</code> 不能跨方法 / 跨线程传递</h3>
<p><code>synchronized</code> 仅保证 <strong>同一锁对象</strong> 下的同步，跨方法、跨线程时无法保证线程安全。</p>
<h4 data-id="heading-8">1. 跨方法同步失效</h4>
<ul>
<li>
<p>问题：若一个方法同步，另一个方法修改同一共享变量但不同步，会导致线程安全问题。</p>
<p>java</p>
<p>运行</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">class</span> <span class="hljs-title">Counter</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-built_in">int</span> count = <span class="hljs-number">0</span>;
    <span class="hljs-function"><span class="hljs-keyword">public</span> synchronized <span class="hljs-keyword">void</span> <span class="hljs-title">increment</span>()</span> { count++; } <span class="hljs-comment">// 同步</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">decrement</span>()</span> { count--; } <span class="hljs-comment">// 未同步，跨方法修改共享变量</span>
}
<span class="hljs-comment">// 线程1调用 increment()，线程2调用 decrement()，count 会出错</span>
</code></pre>
</li>
</ul>
<h4 data-id="heading-9">2. 跨线程同步失效</h4>
<ul>
<li>问题：<code>synchronized</code> 仅对 “竞争同一锁” 的线程有效，若线程间通过异步回调、消息队列等方式交互，同步无效。</li>
<li>示例：线程 A 将数据存入共享变量，线程 B 通过消息队列通知后读取，但未同步，可能读取到旧值。</li>
</ul>
<h3 data-id="heading-10">四、死锁风险：避免循环等待</h3>
<p><code>synchronized</code> 可能导致死锁，需满足 <strong>四个必要条件</strong>：互斥、请求与保持、不可剥夺、循环等待。核心是避免 “循环等待”。</p>
<h4 data-id="heading-11">1. 死锁示例</h4>
<p>java</p>
<p>运行</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 线程1：先锁 a，再锁 b</span>
<span class="hljs-built_in">synchronized</span>(a) {
    Thread<span class="hljs-selector-class">.sleep</span>(<span class="hljs-number">100</span>); <span class="hljs-comment">// 给线程2争取时间</span>
    <span class="hljs-built_in">synchronized</span>(b) { ... }
}

<span class="hljs-comment">// 线程2：先锁 b，再锁 a</span>
<span class="hljs-built_in">synchronized</span>(b) {
    Thread<span class="hljs-selector-class">.sleep</span>(<span class="hljs-number">100</span>);
    <span class="hljs-built_in">synchronized</span>(a) { ... }
}
</code></pre>
<ul>
<li>结果：线程 1 持有 a 等待 b，线程 2 持有 b 等待 a，互相阻塞，死锁。</li>
</ul>
<h4 data-id="heading-12">2. 避免死锁的细节</h4>
<ul>
<li>按 <strong>固定顺序</strong> 申请锁（如按对象哈希值排序）。</li>
<li>避免嵌套锁（尽量减少锁的嵌套层级）。</li>
<li>给锁添加 <strong>超时时间</strong>（可通过 <code>Lock</code> 接口的 <code>tryLock(timeout)</code> 实现，<code>synchronized</code> 本身不支持，需手动规避）。</li>
<li>减少锁的持有时间（尽快释放锁，避免线程长时间占用）。</li>
</ul>
<h3 data-id="heading-13">五、可见性与有序性：<code>synchronized</code> 的隐含保证</h3>
<p><code>synchronized</code> 不仅保证原子性，还隐含可见性和有序性，但需注意细节：</p>
<h4 data-id="heading-14">1. 可见性保证</h4>
<ul>
<li>线程释放锁时，会将工作内存中的修改写回主内存；线程获取锁时，会从主内存加载最新变量值。</li>
<li>细节：仅对 “同一锁保护的共享变量” 有效，若变量未被锁保护，仍可能出现可见性问题。</li>
</ul>
<h4 data-id="heading-15">2. 有序性保证</h4>
<ul>
<li>同步块内的指令禁止重排序，且释放锁的操作 <code>happens-before</code> 后续获取同一锁的操作。</li>
<li>细节：同步块外的指令仍可能重排序，仅同步块内的指令有序。</li>
</ul>
<h3 data-id="heading-16">六、性能相关细节</h3>
<h4 data-id="heading-17">1. <code>synchronized</code> 的优化（JDK 1.6+）</h4>
<p>JDK 1.6 对 <code>synchronized</code> 进行了优化，引入了 <strong>偏向锁、轻量级锁、重量级锁</strong> 的升级机制，避免直接使用重量级锁（操作系统互斥量）导致的性能开销。</p>
<ul>
<li>细节：无需手动干预，JVM 自动优化，但需避免锁的频繁竞争（否则会升级为重量级锁，性能下降）。</li>
</ul>
<h4 data-id="heading-18">2. 避免锁竞争激烈</h4>
<ul>
<li>
<p>若多个线程频繁竞争同一把锁，会导致线程阻塞、上下文切换，性能下降。</p>
</li>
<li>
<p>优化方案：</p>
<ul>
<li>拆分锁（如 <code>ConcurrentHashMap</code> 的分段锁思想，将大锁拆分为多个小锁）。</li>
<li>使用无锁并发工具（如 <code>Atomic</code> 原子类、<code>ConcurrentLinkedQueue</code>）。</li>
<li>减少锁的持有时间（如前面提到的缩小同步块）。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-19">3. 不要用 <code>synchronized</code> 修饰频繁调用的方法</h4>
<ul>
<li>若方法被高频调用（如每秒上万次），<code>synchronized</code> 的同步开销会被放大，建议改用无锁方案或优化锁粒度。</li>
</ul>
<h3 data-id="heading-20">七、其他细节</h3>
<h4 data-id="heading-21">1. <code>synchronized</code> 不能中断线程</h4>
<ul>
<li>
<p><code>synchronized</code> 是不可中断的，若线程在等待锁时被阻塞，只能通过以下方式结束：</p>
<ul>
<li>持有锁的线程释放锁（执行完同步块或抛出异常）。</li>
<li>程序终止。</li>
</ul>
</li>
<li>
<p>若需要中断等待锁的线程，需使用 <code>Lock</code> 接口的 <code>lockInterruptibly()</code> 方法。</p>
</li>
</ul>
<h4 data-id="heading-22">2. <code>synchronized</code> 不能超时等待</h4>
<ul>
<li><code>synchronized</code> 没有超时机制，线程会一直等待锁，直到获取到为止。</li>
<li>若需要超时等待，需改用 <code>Lock</code> 接口的 <code>tryLock(timeout, unit)</code> 方法。</li>
</ul>
<h4 data-id="heading-23">3. 静态锁与实例锁互不干扰</h4>
<ul>
<li>
<p>静态方法锁（锁 <code>Class</code> 对象）和实例方法锁（锁 <code>this</code>）是不同的锁，多线程同时调用时不会竞争。</p>
<p>java</p>
<p>运行</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span> {
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">staticMethod</span><span class="hljs-params">()</span> </span>{} <span class="hljs-comment">// 锁 Test.class</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-type">void</span> <span class="hljs-title">instanceMethod</span><span class="hljs-params">()</span> </span>{} <span class="hljs-comment">// 锁 this</span>
}
<span class="hljs-comment">// 线程1调用 staticMethod()，线程2调用 instanceMethod()，无锁竞争</span>
</code></pre>
</li>
</ul>
<h4 data-id="heading-24">4. 异常会释放锁</h4>
<ul>
<li>若同步块内抛出异常，JVM 会自动释放锁，避免锁泄露（线程持有锁但崩溃，导致其他线程无法获取）。</li>
<li>细节：若需要在异常后执行特定逻辑（如资源释放），需在 <code>finally</code> 块中处理，但锁的释放无需手动操作。</li>
</ul>
<h3 data-id="heading-25">总结</h3>
<p>使用 <code>synchronized</code> 时，核心是抓住  <strong>“锁对象正确、锁粒度合适、避免死锁、利用隐含的可见性 / 有序性保证”</strong>  这四大关键点：</p>
<ol>
<li>锁对象必须是多线程共享的引用类型，避免用常量、基本类型、<code>null</code>。</li>
<li>同步块仅包裹临界区，避免过度同步或同步不足。</li>
<li>规避死锁，尤其是循环等待和嵌套锁。</li>
<li>了解 <code>synchronized</code> 的优化机制，避免不必要的性能损耗。</li>
</ol>
<p>在高并发场景下，若 <code>synchronized</code> 无法满足需求（如超时等待、中断、公平锁），可考虑使用 <code>java.util.concurrent.locks.Lock</code> 接口（如 <code>ReentrantLock</code>），它提供了更灵活的锁控制能力。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Golang 高效内网文件传输实战：零拷贝、断点续传与 Protobuf 指令解析（含完整源码）]]></title>    <link>https://juejin.cn/post/7577343038427529259</link>    <guid>https://juejin.cn/post/7577343038427529259</guid>    <pubDate>2025-11-28T02:24:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577343038427529259" data-draft-id="7577291435160207401" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Golang 高效内网文件传输实战：零拷贝、断点续传与 Protobuf 指令解析（含完整源码）"/> <meta itemprop="keywords" content="后端,Go"/> <meta itemprop="datePublished" content="2025-11-28T02:24:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="代码扳手"/> <meta itemprop="url" content="https://juejin.cn/user/177501539672379"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Golang 高效内网文件传输实战：零拷贝、断点续传与 Protobuf 指令解析（含完整源码）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/177501539672379/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    代码扳手
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-28T02:24:40.000Z" title="Fri Nov 28 2025 02:24:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在程序员的世界里，我们常常听到这样的话：“站在巨人的肩膀上”、“没必要重复造轮子”。这些话听起来很正确，但你有没有想过——真正理解技术的本质，可能恰恰需要去“重复造轮子”？</p>
<p>在大型企业里，每个团队都有自己的 DevOps 流程、自研的文件共享系统、甚至独特的传输协议。为什么他们不直接用现成的方案？因为“自己的”往往才是最可控、最灵活、最容易扩展的。</p>
<p>同样地，作为学习阶段的我们，动手实现那些看似已经被写过的底层功能，并不是浪费时间，而是一条通向深入理解技术的捷径。只有亲手敲过每一行代码，理解每一个设计的来龙去脉，才能真正掌握一门语言的精髓，理解一个技术领域的本质。</p>
<p>通过实现底层文件传输逻辑，可以：</p>
<ul>
<li>理解 <strong>操作系统 IO 模型</strong></li>
<li>掌握 <strong>网络协议设计</strong></li>
<li>熟悉 <strong>高性能文件传输优化</strong></li>
</ul>
<p>💡 本篇文章，我将带你用 <strong>Golang</strong> 实现一个高效的内网文件传输系统，从零构建协议、实现断点续传与零拷贝，让你在实践中真正理解底层技术的奥秘。</p>
<p>不废话直接撸码。</p>
<hr/>
<p>1️⃣ 项目整体结构</p>
<pre><code class="hljs language-bash" lang="bash">fs_transfer_project/
├── proto/
│   └── fs_protocol.proto          <span class="hljs-comment"># Protobuf 消息定义</span>
├── frame/
│   ├── frame.go                   <span class="hljs-comment"># 自定义帧协议读写封装</span>
│   └── command.go                 <span class="hljs-comment"># CMD 枚举定义</span>
├── server/
│   ├── main.go                    <span class="hljs-comment"># TCP 监听 &amp; 连接分发</span>
│   ├── dispatcher.go              <span class="hljs-comment"># CMD 分发</span>
│   ├── file_ops.go                <span class="hljs-comment"># 基础文件操作</span>
│   └── file_ops_advanced.go       <span class="hljs-comment"># 高级操作：零拷贝、断点续传、CRC32</span>
└── client/
    ├── main.go                    <span class="hljs-comment"># Client入口</span>
    ├── download_demo.go           <span class="hljs-comment"># 文件下载流程</span>
    └── upload_demo.go             <span class="hljs-comment"># 文件上传流程</span>
</code></pre>
<p>💡 <strong>核心思路</strong>：Server 通过自定义帧协议 + CMD 分发处理各种文件操作请求，Client 使用 Protobuf 指令请求文件操作，实现高性能文件传输。</p>
<hr/>
<h2 data-id="heading-0">2️⃣ 自定义帧协议 + Protobuf 指令解析</h2>
<p>为了高性能、多路复用和协议扩展性，项目设计了：</p>
<ul>
<li><strong>帧协议 Frame</strong>：包含 Header 和 Payload</li>
<li><strong>Protobuf 指令</strong>：封装业务请求/响应</li>
</ul>
<p><strong>帧协议 Header 设计：</strong></p>













































<table><thead><tr><th>字段</th><th>类型</th><th>描述</th></tr></thead><tbody><tr><td>Magic</td><td>uint32</td><td>帧标识</td></tr><tr><td>Version</td><td>byte</td><td>协议版本</td></tr><tr><td>Flags</td><td>uint8</td><td>标志位</td></tr><tr><td>Cmd</td><td>uint16</td><td>指令类型</td></tr><tr><td>StreamID</td><td>uint32</td><td>多路复用 ID</td></tr><tr><td>PayloadLen</td><td>uint32</td><td>Payload长度</td></tr><tr><td>Checksum</td><td>uint16</td><td>完整性验证</td></tr></tbody></table>
<p>Frame 读取示例：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">ReadFrame</span><span class="hljs-params">(r *bufio.Reader)</span></span> (Header, []<span class="hljs-type">byte</span>, <span class="hljs-type">error</span>) {
	<span class="hljs-keyword">var</span> h Header
	hdr := <span class="hljs-built_in">make</span>([]<span class="hljs-type">byte</span>, HeaderSize)
	<span class="hljs-comment">// 读取完整头部数据</span>
	<span class="hljs-keyword">if</span> _, err := io.ReadFull(r, hdr); err != <span class="hljs-literal">nil</span> {
		<span class="hljs-keyword">return</span> h, <span class="hljs-literal">nil</span>, err
	}
	<span class="hljs-comment">// 解析头部各字段</span>
	h.Magic = binary.BigEndian.Uint32(hdr[<span class="hljs-number">0</span>:<span class="hljs-number">4</span>])
	<span class="hljs-comment">// 检查魔数是否匹配</span>
	<span class="hljs-keyword">if</span> h.Magic != MagicValue {
		<span class="hljs-keyword">return</span> h, <span class="hljs-literal">nil</span>, errors.New(<span class="hljs-string">"invalid magic"</span>)
	}
	h.Version = hdr[<span class="hljs-number">4</span>]
	h.Flags = hdr[<span class="hljs-number">5</span>]
	h.Cmd = binary.BigEndian.Uint16(hdr[<span class="hljs-number">6</span>:<span class="hljs-number">8</span>])
	h.StreamID = binary.BigEndian.Uint32(hdr[<span class="hljs-number">8</span>:<span class="hljs-number">12</span>])
	h.PayloadLen = binary.BigEndian.Uint32(hdr[<span class="hljs-number">12</span>:<span class="hljs-number">16</span>])
	<span class="hljs-comment">// 读取负载数据</span>
	payload := <span class="hljs-built_in">make</span>([]<span class="hljs-type">byte</span>, h.PayloadLen)
	<span class="hljs-keyword">if</span> _, err := io.ReadFull(r, payload); err != <span class="hljs-literal">nil</span> {
		<span class="hljs-keyword">return</span> h, <span class="hljs-literal">nil</span>, err
	}

	<span class="hljs-comment">// 验证校验和</span>
	expectedChecksum := binary.BigEndian.Uint16(hdr[<span class="hljs-number">4</span>:<span class="hljs-number">6</span>]) <span class="hljs-comment">// Checksum在头部的第5-6字节</span>
	<span class="hljs-keyword">if</span> expectedChecksum != <span class="hljs-number">0</span> { <span class="hljs-comment">// 如果校验和不为0，则验证</span>
		actualChecksum := calculateChecksum(payload)
		<span class="hljs-keyword">if</span> actualChecksum != expectedChecksum {
			<span class="hljs-keyword">return</span> h, <span class="hljs-literal">nil</span>, errors.New(<span class="hljs-string">"checksum mismatch"</span>)
		}
	}

	<span class="hljs-keyword">return</span> h, payload, <span class="hljs-literal">nil</span>
}
</code></pre>
<p>通过 <code>Cmd</code> 字段，Server Dispatcher 将请求分发到不同处理函数，如 <code>CmdAuth</code>、<code>CmdOpen</code>、<code>CmdRead</code>、<code>CmdWrite</code>。</p>
<hr/>
<p>3️⃣ 高级文件操作核心技术</p>
<h3 data-id="heading-1">3.1 零拷贝发送文件</h3>
<p>在 Linux 下可使用 <code>sendfile</code> 避免用户态/内核态多次拷贝。Windows fallback 使用分片读写。这里做了分平台编译。</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">sendFileZeroCopy</span><span class="hljs-params">(conn net.Conn, path <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">error</span> {
	<span class="hljs-keyword">if</span> runtime.GOOS != <span class="hljs-string">"linux"</span> {
		<span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">"sendfile zero-copy only supported on Linux"</span>)
	}

	f, err := os.Open(path)
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
		<span class="hljs-keyword">return</span> err
	}
	<span class="hljs-keyword">defer</span> f.Close()

	tcpConn, ok := conn.(*net.TCPConn)
	<span class="hljs-keyword">if</span> !ok {
		<span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">"connection is not TCP"</span>)
	}

	fileConn, err := tcpConn.File()
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
		<span class="hljs-keyword">return</span> err
	}
	<span class="hljs-keyword">defer</span> fileConn.Close()

	fi, _ := f.Stat()
	off := <span class="hljs-type">int64</span>(<span class="hljs-number">0</span>)
	size := fi.Size()

	<span class="hljs-keyword">for</span> off &lt; size {
		n, err := unix.Sendfile(<span class="hljs-type">int</span>(fileConn.Fd()), <span class="hljs-type">int</span>(f.Fd()), &amp;off, <span class="hljs-type">int</span>(size-off))
		<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
			<span class="hljs-keyword">return</span> err
		}
		<span class="hljs-keyword">if</span> n == <span class="hljs-number">0</span> {
			<span class="hljs-keyword">break</span>
		}
		off += <span class="hljs-type">int64</span>(n)
	}
	<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
}
</code></pre>
<h3 data-id="heading-2">3.2 分块读取/写入 &amp; 断点续传</h3>
<ul>
<li>每次读写固定大小块</li>
<li>上传/下载记录已完成块</li>
<li>断点续传时仅传未完成块</li>
</ul>

<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">writeChunk</span><span class="hljs-params">(f *os.File, offset <span class="hljs-type">int64</span>, data []<span class="hljs-type">byte</span>)</span></span> <span class="hljs-type">error</span> {
	<span class="hljs-comment">// 在指定位置写入数据</span>
	_, err := f.WriteAt(data, offset)
	<span class="hljs-keyword">return</span> err
}
</code></pre>
<h3 data-id="heading-3">3.3 数据完整性校验</h3>
<p>使用 CRC32 对每块数据校验，保证文件传输完整性。</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">computeChecksum</span><span class="hljs-params">(data []<span class="hljs-type">byte</span>)</span></span> <span class="hljs-type">uint32</span> {
    <span class="hljs-keyword">return</span> crc32.ChecksumIEEE(data)
}
</code></pre>
<hr/>
<h2 data-id="heading-4">4️⃣ Server 核心代码解析</h2>
<h3 data-id="heading-5">TCP 监听 &amp; 连接分发</h3>
<pre><code class="hljs language-css" lang="css">// 代码有简写 以源码为主
ln, _ := net.<span class="hljs-built_in">Listen</span>(<span class="hljs-string">"tcp"</span>, <span class="hljs-string">":9000"</span>)
for {
    conn, _ := ln.<span class="hljs-built_in">Accept</span>()
    go <span class="hljs-built_in">handleConn</span>(conn)
}
</code></pre>
<p>Dispatcher 示例</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 根据命令类型进行分发处理</span>
<span class="hljs-keyword">switch</span> hdr.Cmd {
<span class="hljs-keyword">case</span> frame.CmdAuth:
	<span class="hljs-comment">// 处理认证请求</span>
	<span class="hljs-keyword">var</span> req fsproto.AuthReq
	<span class="hljs-keyword">if</span> err := proto.Unmarshal(payload, &amp;req); err != <span class="hljs-literal">nil</span> {
		logger.Error(<span class="hljs-string">"Failed to unmarshal AuthReq"</span>, zap.Error(err))
		<span class="hljs-keyword">return</span>
	}
	handleAuth(conn, req)

<span class="hljs-keyword">case</span> frame.CmdList:
	<span class="hljs-comment">// 处理列出目录请求</span>
	<span class="hljs-keyword">var</span> req fsproto.ListReq
	<span class="hljs-keyword">if</span> err := proto.Unmarshal(payload, &amp;req); err != <span class="hljs-literal">nil</span> {
		logger.Error(<span class="hljs-string">"Failed to unmarshal ListReq"</span>, zap.Error(err))
		<span class="hljs-keyword">return</span>
	}
	handleList(conn, req)

<span class="hljs-keyword">case</span> frame.CmdOpen:
	<span class="hljs-comment">// 处理打开文件请求</span>
	<span class="hljs-keyword">var</span> req fsproto.OpenReq
	<span class="hljs-keyword">if</span> err := proto.Unmarshal(payload, &amp;req); err != <span class="hljs-literal">nil</span> {
		logger.Error(<span class="hljs-string">"Failed to unmarshal OpenReq"</span>, zap.Error(err))
		<span class="hljs-keyword">return</span>
	}
	handleOpen(conn, req)

<span class="hljs-keyword">case</span> frame.CmdRead:
	<span class="hljs-comment">// 处理读取文件请求</span>
	<span class="hljs-keyword">var</span> req fsproto.ReadReq
	<span class="hljs-keyword">if</span> err := proto.Unmarshal(payload, &amp;req); err != <span class="hljs-literal">nil</span> {
		logger.Error(<span class="hljs-string">"Failed to unmarshal ReadReq"</span>, zap.Error(err))
		<span class="hljs-keyword">return</span>
	}
	handleRead(conn, req)

<span class="hljs-keyword">case</span> frame.CmdWrite:
	<span class="hljs-comment">// 处理写入文件请求</span>
	<span class="hljs-keyword">var</span> req fsproto.WriteReq
	<span class="hljs-keyword">if</span> err := proto.Unmarshal(payload, &amp;req); err != <span class="hljs-literal">nil</span> {
		logger.Error(<span class="hljs-string">"Failed to unmarshal WriteReq"</span>, zap.Error(err))
		<span class="hljs-keyword">return</span>
	}
	handleWrite(conn, req)

<span class="hljs-keyword">default</span>:
	ogger.Warn(<span class="hljs-string">"Unknown command"</span>, zap.Uint16(<span class="hljs-string">"cmd"</span>, hdr.Cmd))
}
</code></pre>
<p>Server 通过文件句柄管理文件、记录上传块状态，支持多客户端同时上传下载。</p>
<hr/>
<h2 data-id="heading-6">5️⃣ Client 核心代码解析</h2>
<h3 data-id="heading-7">认证示例</h3>
<pre><code class="hljs language-css" lang="css">authReq := &amp;fsproto.AuthReq{
    Token: <span class="hljs-string">"secret_token"</span>,
    ClientId: <span class="hljs-string">"client_001"</span>,
}
payload,_ := proto.<span class="hljs-built_in">Marshal</span>(authReq)
frame.<span class="hljs-built_in">WriteFrame</span>(conn, frame.Header{Version:<span class="hljs-number">1</span>, Cmd:frame.CmdAuth}, payload)
</code></pre>
<p>文件下载示例</p>
<pre><code class="hljs language-css" lang="css">// 打开文件
frame<span class="hljs-selector-class">.WriteFrame</span>(conn, frame<span class="hljs-selector-class">.Header</span>{Cmd: frame.CmdOpen}, openReqBytes)
// 循环读取文件块
for offset := <span class="hljs-built_in">int64</span>(<span class="hljs-number">0</span>); !eof; offset += chunkSize {
    readReq := &amp;fsproto.ReadReq{Handle: handle, Offset: offset, Length: chunkSize}
    payload,_ := proto.<span class="hljs-built_in">Marshal</span>(readReq)
    frame.<span class="hljs-built_in">WriteFrame</span>(conn, frame.Header{Cmd: frame.CmdRead}, payload)
    ...
}
</code></pre>
<h2 data-id="heading-8">6️⃣ 性能优化与扩展思路</h2>
<ul>
<li><strong>多路复用</strong>：同一 TCP 连接可传输多个文件</li>
<li><strong>零拷贝</strong>：Linux 高效发送大文件</li>
<li><strong>分块校验</strong>：保证大文件完整性</li>
<li><strong>Protobuf 指令扩展</strong>：可轻松增加新 CMD</li>
</ul>
<p>可进一步优化：TLS 加密、并行多连接、Linux epoll 高并发。关于linux的文件管理优化空间还很大，在windows里总感觉有些局限性。欢迎在评论区讨论你的想法。</p>
<hr/>
<p>通过这个项目，你将掌握：</p>
<ul>
<li>高性能文件传输设计理念</li>
<li>Golang 网络 IO 与协程的应用</li>
<li>文件分块传输、断点续传、CRC32 校验</li>
<li>自定义协议 + Protobuf 指令解析</li>
</ul>
<p>💡 技术核心：自己实现底层逻辑，才能真正理解协议、IO 模型和语言特性。</p>
<hr/>
<p>🔗 源码下载</p>
<p>👉 GitHub：
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Flouis-xie-programmer%2Ffs_transfer_project" target="_blank" title="https://github.com/louis-xie-programmer/fs_transfer_project" ref="nofollow noopener noreferrer">github.com/louis-xie-p…</a></p>
<p>👉 Gitee：
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Flouis_xie%2Ffs_transfer_project" target="_blank" title="https://gitee.com/louis_xie/fs_transfer_project" ref="nofollow noopener noreferrer">gitee.com/louis_xie/f…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[详解 TypeScript 中，async 和 await]]></title>    <link>https://juejin.cn/post/7577300470520446985</link>    <guid>https://juejin.cn/post/7577300470520446985</guid>    <pubDate>2025-11-28T02:29:26.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577300470520446985" data-draft-id="7577300470520430601" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="详解 TypeScript 中，async 和 await"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-28T02:29:26.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="倚栏听风雨"/> <meta itemprop="url" content="https://juejin.cn/user/2682464103830750"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            详解 TypeScript 中，async 和 await
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2682464103830750/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    倚栏听风雨
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-28T02:29:26.000Z" title="Fri Nov 28 2025 02:29:26 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 TypeScript 中，<code>async</code> 和 <code>await</code> 是处理异步操作的<strong>语法糖</strong>（Syntactic Sugar），本质上它们仍然是基于 <code>Promise</code> 的。</p>
<p>但在 TypeScript 的语境下，理解它们的核心在于掌握 <strong>返回类型推断</strong> 和 <strong>解包（Unwrapping）</strong> 机制。</p>
<p>以下是 <code>async</code> 和 <code>await</code> 的详细解析：</p>
<hr/>
<h3 data-id="heading-0">1. <code>async</code> 关键字</h3>
<p><code>async</code> 用于修饰函数。它有两个核心规则：</p>
<ol>
<li><strong>强制返回 Promise</strong>：无论函数内部 <code>return</code> 什么，最终都会被封装成一个 Promise。</li>
<li><strong>类型注解</strong>：在 TypeScript 中，<code>async</code> 函数的返回值类型必须明确写成 <code>Promise&lt;T&gt;</code>。</li>
</ol>
<h4 data-id="heading-1">示例代码</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 1. 自动推断</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">simple</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> <span class="hljs-number">123</span>; 
}
<span class="hljs-comment">// TS 自动推断出 simple() 的返回类型是: Promise&lt;number&gt;</span>


<span class="hljs-comment">// 2. 显式注解 (推荐)</span>
<span class="hljs-comment">// 即使你 return 的是一个普通字符串，类型定义必须包裹在 Promise 中</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getUserName</span>(<span class="hljs-params"/>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">string</span>&gt; {
  <span class="hljs-keyword">return</span> <span class="hljs-string">"Alice"</span>;
}

<span class="hljs-comment">// 3. 无返回值的异步函数</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">logData</span>(<span class="hljs-params"/>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Saving..."</span>);
  <span class="hljs-comment">// 相当于 return Promise.resolve(undefined);</span>
}
</code></pre>
<blockquote>
<p><strong>注意</strong>：你不能将 async 函数的返回类型写成 <code>string</code> 或 <code>number</code>，必须是 <code>Promise&lt;string&gt;</code>。</p>
</blockquote>
<hr/>
<h3 data-id="heading-2">2. <code>await</code> 关键字</h3>
<p><code>await</code> 只能在 <code>async</code> 函数内部使用（或者在支持 Top-level await 的模块中使用）。</p>
<p>它的作用是：</p>
<ol>
<li><strong>暂停执行</strong>：暂停当前 async 函数的执行，直到 Promise 状态变为 resolved 或 rejected。</li>
<li><strong>自动解包 (Unwrapping)</strong>：这是 TS 的强大之处。如果一个表达式是 <code>Promise&lt;string&gt;</code>，<code>await</code> 之后得到的结果类型就是 <code>string</code>。</li>
</ol>
<h4 data-id="heading-3">类型解包示例</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">fetchAge</span>(<span class="hljs-params"/>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">number</span>&gt; {
  <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-number">18</span>);
}

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// TS 知道 fetchAge 返回 Promise&lt;number&gt;</span>
  <span class="hljs-comment">// 所以 age 被自动推断为 number 类型</span>
  <span class="hljs-keyword">const</span> age = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchAge</span>(); 
  
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(age + <span class="hljs-number">1</span>); <span class="hljs-comment">// 这里的加法是合法的，因为 age 是 number</span>
}
</code></pre>
<hr/>
<h3 data-id="heading-4">3. 错误处理 (<code>try...catch</code>)</h3>
<p>当 <code>await</code> 后面的 Promise 被 <code>reject</code> 时，会抛出一个异常。因此，标准做法是使用 <code>try...catch</code>。</p>
<p>在 TypeScript 中，<code>catch(error)</code> 中的 <code>error</code> 默认类型通常是 <code>unknown</code> 或 <code>any</code>。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">requestData</span>(<span class="hljs-params"/>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">string</span>&gt; {
  <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"网络连接断开"</span>);
}

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleTask</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> <span class="hljs-title function_">requestData</span>();
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(data);
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-comment">// 这里的 error 类型是 unknown (在 TS 4.4+ 开启 useUnknownInCatchVariables 时)</span>
    
    <span class="hljs-comment">// 最佳实践：进行类型守卫</span>
    <span class="hljs-keyword">if</span> (error <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Error</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"错误消息:"</span>, error.<span class="hljs-property">message</span>);
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"未知错误:"</span>, error);
    }
  }
}
</code></pre>
<hr/>
<h3 data-id="heading-5">4. 串行 vs 并行 (性能关键)</h3>
<p>这是使用 <code>async/await</code> 最容易踩的坑。<code>await</code> 会阻塞后续代码，如果多个请求之间没有依赖关系，<strong>不要</strong>写成串行。</p>
<h4 data-id="heading-6">❌ 串行写法 (慢)</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">serial</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> start = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
  <span class="hljs-comment">// 假设 getUser 耗时 1s, getPosts 耗时 1s</span>
  <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getUser</span>();   <span class="hljs-comment">// 等待 1s</span>
  <span class="hljs-keyword">const</span> posts = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getPosts</span>(); <span class="hljs-comment">// 再等待 1s</span>
  <span class="hljs-comment">// 总耗时: 2s</span>
}
</code></pre>
<h4 data-id="heading-7">✅ 并行写法 (快 - 使用 Promise.all)</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">parallel</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 同时启动两个任务</span>
  <span class="hljs-keyword">const</span> userPromise = <span class="hljs-title function_">getUser</span>();
  <span class="hljs-keyword">const</span> postsPromise = <span class="hljs-title function_">getPosts</span>();

  <span class="hljs-comment">// 等待它们全部完成</span>
  <span class="hljs-comment">// TS 会自动推断 results 类型为 [User, Post[]]</span>
  <span class="hljs-keyword">const</span> [user, posts] = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>([userPromise, postsPromise]);
  <span class="hljs-comment">// 总耗时: 1s</span>
}
</code></pre>
<hr/>
<h3 data-id="heading-8">5. 高级用法与技巧</h3>
<h4 data-id="heading-9">5.1 异步箭头函数</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> login = <span class="hljs-keyword">async</span> (<span class="hljs-attr">username</span>: <span class="hljs-built_in">string</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">boolean</span>&gt; =&gt; {
  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
};
</code></pre>
<h4 data-id="heading-10">5.2 Top-level Await (顶层 await)</h4>
<p>在现代 TypeScript (ES2022 / ESNext 且 module 设置为 esnext/system 等) 中，可以在文件最外层直接使用 <code>await</code>，不需要包裹在 <code>async function</code> 中。这在初始化数据库连接等场景很有用。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// db.ts</span>
<span class="hljs-keyword">import</span> { createConnection } <span class="hljs-keyword">from</span> <span class="hljs-string">'typeorm'</span>;

<span class="hljs-comment">// 直接等待连接建立</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> connection = <span class="hljs-keyword">await</span> <span class="hljs-title function_">createConnection</span>();
</code></pre>
<h4 data-id="heading-11">5.3 <code>Promise&lt;void&gt;</code> 的陷阱</h4>
<p>有时候我们会把 async 函数作为回调传给 <code>forEach</code>，这通常是不对的，因为 <code>forEach</code> 不会等待 async 回调完成。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> ids = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>];

<span class="hljs-comment">// ❌ 错误做法：forEach 不会等待 await</span>
ids.<span class="hljs-title function_">forEach</span>(<span class="hljs-keyword">async</span> (id) =&gt; {
  <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchUser</span>(id); 
});
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Done'</span>); <span class="hljs-comment">// 这行代码会在 fetchUser 完成之前就打印！</span>

<span class="hljs-comment">// ✅ 正确做法：使用 map + Promise.all</span>
<span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>(ids.<span class="hljs-title function_">map</span>(<span class="hljs-keyword">async</span> (id) =&gt; {
  <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchUser</span>(id);
}));
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Done'</span>); <span class="hljs-comment">// 确实等待所有都完成了</span>
</code></pre>
<h3 data-id="heading-12">总结 TS 中的 Async/Await</h3>






























<table><thead><tr><th align="left">特性</th><th align="left">说明</th><th align="left">对应的 TS 写法</th></tr></thead><tbody><tr><td align="left"><strong>定义</strong></td><td align="left">函数必须返回 Promise</td><td align="left"><code>async function fn(): Promise&lt;T&gt; { ... }</code></td></tr><tr><td align="left"><strong>调用</strong></td><td align="left">必须在 async 函数内</td><td align="left"><code>const val: T = await promise;</code></td></tr><tr><td align="left"><strong>返回值</strong></td><td align="left">自动包装</td><td align="left">return <code>T</code> 会变成 <code>Promise&lt;T&gt;</code></td></tr><tr><td align="left"><strong>异常</strong></td><td align="left">使用 try-catch 捕获</td><td align="left">catch 块中的变量需注意类型检查</td></tr></tbody></table>
<p>掌握这套机制后，你的异步代码会像同步代码一样清晰，同时拥有完整的类型检查保护。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[终端里的"黑客帝国"：htop, glances, bpytop 系统监控工具横评]]></title>    <link>https://juejin.cn/post/7577313637950488585</link>    <guid>https://juejin.cn/post/7577313637950488585</guid>    <pubDate>2025-11-28T02:31:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577313637950488585" data-draft-id="7576105458807980032" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="终端里的&quot;黑客帝国&quot;：htop, glances, bpytop 系统监控工具横评"/> <meta itemprop="keywords" content="Linux"/> <meta itemprop="datePublished" content="2025-11-28T02:31:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="LCG元"/> <meta itemprop="url" content="https://juejin.cn/user/3097802498120889"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            终端里的"黑客帝国"：htop, glances, bpytop 系统监控工具横评
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3097802498120889/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    LCG元
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-28T02:31:55.000Z" title="Fri Nov 28 2025 02:31:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">终端里的"黑客帝国"：htop, glances, bpytop 系统监控工具横评</h2>
<h3 data-id="heading-1">1. 引言</h3>
<p>在Linux系统管理中，实时监控系统资源是每个运维人员和开发者的必备技能。虽然传统的<code>top</code>命令功能强大，但它的界面相对简陋。本文将深度评测三款终端下的"黑客帝国"式系统监控工具：htop、glances和bpytop，带你领略终端监控的艺术。</p>
<h3 data-id="heading-2">2. 工具概述</h3>
<h4 data-id="heading-3">2.1 htop - 经典增强版进程监控</h4>
<p>htop是top命令的增强版，提供了彩色界面、鼠标支持、垂直和水平滚动等现代化功能。</p>
<h4 data-id="heading-4">2.2 glances - 全能跨平台监控</h4>
<p>glances采用C/S架构，不仅可以监控本地系统，还能通过Web界面远程监控多台服务器。</p>
<h4 data-id="heading-5">2.3 bpytop - Python编写的视觉盛宴</h4>
<p>bpytop使用Python编写，拥有极其丰富的视觉效果和高度可定制性，是终端监控的颜值担当。</p>
<h3 data-id="heading-6">3. htop 深度解析</h3>
<h4 data-id="heading-7">3.1 安装指南</h4>
<p><strong>创建安装脚本：<code>install_htop.sh</code></strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>

<span class="hljs-comment"># htop 安装脚本</span>
<span class="hljs-comment"># 支持多种Linux发行版</span>

<span class="hljs-built_in">set</span> -e

<span class="hljs-built_in">echo</span> <span class="hljs-string">"开始安装 htop..."</span>

<span class="hljs-comment"># 检测系统类型</span>
<span class="hljs-keyword">if</span> [ -f /etc/os-release ]; <span class="hljs-keyword">then</span>
    . /etc/os-release
    OS=<span class="hljs-variable">$ID</span>
<span class="hljs-keyword">else</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"无法检测操作系统类型"</span>
    <span class="hljs-built_in">exit</span> 1
<span class="hljs-keyword">fi</span>

<span class="hljs-comment"># 根据系统类型选择安装方法</span>
<span class="hljs-keyword">case</span> <span class="hljs-variable">$OS</span> <span class="hljs-keyword">in</span>
    ubuntu|debian)
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"检测到 Debian/Ubuntu 系统"</span>
        sudo apt update
        sudo apt install -y htop
        ;;
    centos|rhel|fedora)
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"检测到 CentOS/RHEL/Fedora 系统"</span>
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">command</span> -v dnf &amp;&gt; /dev/null; <span class="hljs-keyword">then</span>
            sudo dnf install -y htop
        <span class="hljs-keyword">elif</span> <span class="hljs-built_in">command</span> -v yum &amp;&gt; /dev/null; <span class="hljs-keyword">then</span>
            sudo yum install -y htop
        <span class="hljs-keyword">fi</span>
        ;;
    <span class="hljs-built_in">arch</span>|manjaro)
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"检测到 Arch/Manjaro 系统"</span>
        sudo pacman -Syu --noconfirm htop
        ;;
    *)
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"不支持的操作系统，尝试从源码编译..."</span>
        install_from_source
        ;;
<span class="hljs-keyword">esac</span>

<span class="hljs-comment"># 源码编译安装函数</span>
<span class="hljs-function"><span class="hljs-title">install_from_source</span></span>() {
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"开始从源码编译安装 htop..."</span>
    
    <span class="hljs-comment"># 安装依赖</span>
    <span class="hljs-keyword">if</span> <span class="hljs-built_in">command</span> -v apt &amp;&gt; /dev/null; <span class="hljs-keyword">then</span>
        sudo apt install -y build-essential autoconf automake libncurses5-dev
    <span class="hljs-keyword">elif</span> <span class="hljs-built_in">command</span> -v yum &amp;&gt; /dev/null; <span class="hljs-keyword">then</span>
        sudo yum groupinstall -y <span class="hljs-string">"Development Tools"</span>
        sudo yum install -y ncurses-devel
    <span class="hljs-keyword">fi</span>
    
    <span class="hljs-comment"># 下载源码</span>
    wget https://github.com/htop-dev/htop/archive/refs/tags/3.2.2.tar.gz
    tar xvf 3.2.2.tar.gz
    <span class="hljs-built_in">cd</span> htop-3.2.2
    
    <span class="hljs-comment"># 编译安装</span>
    ./autogen.sh
    ./configure
    make -j$(<span class="hljs-built_in">nproc</span>)
    sudo make install
    
    <span class="hljs-comment"># 清理</span>
    <span class="hljs-built_in">cd</span> ..
    <span class="hljs-built_in">rm</span> -rf htop-3.2.2 3.2.2.tar.gz
}

<span class="hljs-built_in">echo</span> <span class="hljs-string">"htop 安装完成！"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"运行命令：htop 来启动程序"</span>
</code></pre>
<h4 data-id="heading-8">3.2 配置文件详解</h4>
<p><strong>创建配置文件：<code>~/.config/htop/htoprc</code></strong></p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># htop 配置文件</span>
<span class="hljs-comment"># 生成时间：$(date)</span>

<span class="hljs-comment"># 颜色方案</span>
<span class="hljs-attr">color_scheme</span>=<span class="hljs-number">6</span>
<span class="hljs-comment"># 0: Monochrome (黑白)</span>
<span class="hljs-comment"># 1: Black on White (黑底白字)</span>
<span class="hljs-comment"># 2: Light Terminal (浅色终端)</span>
<span class="hljs-comment"># 3: Dark Terminal (深色终端)</span>
<span class="hljs-comment"># 4: Colors (彩色)</span>
<span class="hljs-comment"># 5: Solarized (日光方案)</span>
<span class="hljs-comment"># 6: Alternate (交替方案)</span>

<span class="hljs-comment"># 显示选项</span>
<span class="hljs-attr">fields</span>=<span class="hljs-number">0</span> <span class="hljs-number">48</span> <span class="hljs-number">17</span> <span class="hljs-number">18</span> <span class="hljs-number">38</span> <span class="hljs-number">39</span> <span class="hljs-number">40</span> <span class="hljs-number">2</span> <span class="hljs-number">46</span> <span class="hljs-number">47</span> <span class="hljs-number">49</span> <span class="hljs-number">1</span>
<span class="hljs-attr">sort_key</span>=<span class="hljs-number">46</span>
<span class="hljs-attr">sort_direction</span>=<span class="hljs-number">1</span>
<span class="hljs-attr">hide_threads</span>=<span class="hljs-number">0</span>
<span class="hljs-attr">hide_kernel_threads</span>=<span class="hljs-number">1</span>
<span class="hljs-attr">hide_userland_threads</span>=<span class="hljs-number">0</span>
<span class="hljs-attr">shadow_other_users</span>=<span class="hljs-number">0</span>
<span class="hljs-attr">show_thread_names</span>=<span class="hljs-number">0</span>
<span class="hljs-attr">show_program_path</span>=<span class="hljs-number">1</span>
<span class="hljs-attr">highlight_base_name</span>=<span class="hljs-number">0</span>
<span class="hljs-attr">highlight_megabytes</span>=<span class="hljs-number">1</span>
<span class="hljs-attr">highlight_threads</span>=<span class="hljs-number">1</span>
<span class="hljs-attr">tree_view</span>=<span class="hljs-number">0</span>
<span class="hljs-attr">header_margin</span>=<span class="hljs-number">1</span>
<span class="hljs-attr">detailed_cpu_time</span>=<span class="hljs-number">0</span>
<span class="hljs-attr">cpu_count_from_zero</span>=<span class="hljs-number">0</span>
<span class="hljs-attr">update_process_names</span>=<span class="hljs-number">0</span>
<span class="hljs-attr">account_guest_in_cpu_meter</span>=<span class="hljs-number">0</span>
<span class="hljs-attr">color_scheme</span>=<span class="hljs-number">6</span>
<span class="hljs-attr">delay</span>=<span class="hljs-number">15</span>
<span class="hljs-attr">left_meters</span>=AllCPUs Memory Swap
<span class="hljs-attr">left_meter_modes</span>=<span class="hljs-number">1</span> <span class="hljs-number">1</span> <span class="hljs-number">1</span>
<span class="hljs-attr">right_meters</span>=Tasks LoadAverage Uptime
<span class="hljs-attr">right_meter_modes</span>=<span class="hljs-number">2</span> <span class="hljs-number">2</span> <span class="hljs-number">2</span>
</code></pre>
<h4 data-id="heading-9">3.3 自定义功能脚本</h4>
<p><strong>创建功能增强脚本：<code>htop_enhancer.sh</code></strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>

<span class="hljs-comment"># htop 功能增强脚本</span>

<span class="hljs-comment"># 颜色定义</span>
RED=<span class="hljs-string">'\033[0;31m'</span>
GREEN=<span class="hljs-string">'\033[0;32m'</span>
YELLOW=<span class="hljs-string">'\033[1;33m'</span>
BLUE=<span class="hljs-string">'\033[0;34m'</span>
NC=<span class="hljs-string">'\033[0m'</span> <span class="hljs-comment"># No Color</span>

<span class="hljs-comment"># 显示系统信息函数</span>
<span class="hljs-function"><span class="hljs-title">show_system_info</span></span>() {
    <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${GREEN}</span>=== 系统信息 ===<span class="hljs-variable">${NC}</span>"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"主机名: <span class="hljs-subst">$(hostname)</span>"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"操作系统: <span class="hljs-subst">$(cat /etc/os-release | grep PRETTY_NAME | cut -d= -f2 | tr -d '\"')</span>"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"内核版本: <span class="hljs-subst">$(uname -r)</span>"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"架构: <span class="hljs-subst">$(uname -m)</span>"</span>
    <span class="hljs-built_in">echo</span>
}

<span class="hljs-comment"># 进程分析函数</span>
<span class="hljs-function"><span class="hljs-title">analyze_processes</span></span>() {
    <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${GREEN}</span>=== 进程分析 ===<span class="hljs-variable">${NC}</span>"</span>
    
    <span class="hljs-comment"># 显示CPU使用率最高的进程</span>
    <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${YELLOW}</span>CPU使用率TOP 5:<span class="hljs-variable">${NC}</span>"</span>
    ps aux --<span class="hljs-built_in">sort</span>=-%cpu | <span class="hljs-built_in">head</span> -6 | awk <span class="hljs-string">'{printf "%-10s %-8s %-6s %-10s\n", $11, $2, $3"%", $4"%"}'</span>
    
    <span class="hljs-built_in">echo</span>
    
    <span class="hljs-comment"># 显示内存使用率最高的进程</span>
    <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${YELLOW}</span>内存使用率TOP 5:<span class="hljs-variable">${NC}</span>"</span>
    ps aux --<span class="hljs-built_in">sort</span>=-%mem | <span class="hljs-built_in">head</span> -6 | awk <span class="hljs-string">'{printf "%-10s %-8s %-6s %-10s\n", $11, $2, $3"%", $4"%"}'</span>
    
    <span class="hljs-built_in">echo</span>
}

<span class="hljs-comment"># 资源监控函数</span>
<span class="hljs-function"><span class="hljs-title">monitor_resources</span></span>() {
    <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${GREEN}</span>=== 资源监控 ===<span class="hljs-variable">${NC}</span>"</span>
    
    <span class="hljs-comment"># CPU监控</span>
    cpu_usage=$(top -bn1 | grep <span class="hljs-string">"Cpu(s)"</span> | awk <span class="hljs-string">'{print $2 + $4}'</span>)
    <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"CPU使用率: <span class="hljs-variable">${BLUE}</span><span class="hljs-variable">${cpu_usage}</span>%<span class="hljs-variable">${NC}</span>"</span>
    
    <span class="hljs-comment"># 内存监控</span>
    memory_info=$(free -m | awk <span class="hljs-string">'NR==2{printf "%.2f%%", $3*100/$2}'</span>)
    <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"内存使用率: <span class="hljs-variable">${BLUE}</span><span class="hljs-variable">${memory_info}</span><span class="hljs-variable">${NC}</span>"</span>
    
    <span class="hljs-comment"># 磁盘监控</span>
    disk_usage=$(<span class="hljs-built_in">df</span> -h / | awk <span class="hljs-string">'NR==2{print $5}'</span>)
    <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"根分区使用率: <span class="hljs-variable">${BLUE}</span><span class="hljs-variable">${disk_usage}</span><span class="hljs-variable">${NC}</span>"</span>
    
    <span class="hljs-built_in">echo</span>
}

<span class="hljs-comment"># 交互式htop启动函数</span>
<span class="hljs-function"><span class="hljs-title">start_enhanced_htop</span></span>() {
    <span class="hljs-keyword">while</span> <span class="hljs-literal">true</span>; <span class="hljs-keyword">do</span>
        <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${GREEN}</span>=== 增强版 htop 菜单 ===<span class="hljs-variable">${NC}</span>"</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"1. 显示系统信息"</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"2. 进程分析"</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"3. 资源监控"</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"4. 启动标准 htop"</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"5. 启动树状视图 htop"</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"6. 退出"</span>
        <span class="hljs-built_in">echo</span> -n <span class="hljs-string">"请选择 [1-6]: "</span>
        
        <span class="hljs-built_in">read</span> choice
        <span class="hljs-keyword">case</span> <span class="hljs-variable">$choice</span> <span class="hljs-keyword">in</span>
            1)
                show_system_info
                ;;
            2)
                analyze_processes
                ;;
            3)
                monitor_resources
                ;;
            4)
                <span class="hljs-built_in">echo</span> <span class="hljs-string">"启动标准 htop..."</span>
                htop
                ;;
            5)
                <span class="hljs-built_in">echo</span> <span class="hljs-string">"启动树状视图 htop..."</span>
                htop --tree
                ;;
            6)
                <span class="hljs-built_in">echo</span> <span class="hljs-string">"退出"</span>
                <span class="hljs-built_in">break</span>
                ;;
            *)
                <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${RED}</span>无效选择，请重新输入<span class="hljs-variable">${NC}</span>"</span>
                ;;
        <span class="hljs-keyword">esac</span>
    <span class="hljs-keyword">done</span>
}

<span class="hljs-comment"># 主函数</span>
<span class="hljs-function"><span class="hljs-title">main</span></span>() {
    <span class="hljs-comment"># 检查htop是否安装</span>
    <span class="hljs-keyword">if</span> ! <span class="hljs-built_in">command</span> -v htop &amp;&gt; /dev/null; <span class="hljs-keyword">then</span>
        <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${RED}</span>错误: htop 未安装<span class="hljs-variable">${NC}</span>"</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"请先运行 install_htop.sh 安装 htop"</span>
        <span class="hljs-built_in">exit</span> 1
    <span class="hljs-keyword">fi</span>
    
    show_system_info
    start_enhanced_htop
}

<span class="hljs-comment"># 运行主函数</span>
main <span class="hljs-string">"<span class="hljs-variable">$@</span>"</span>
</code></pre>
<h3 data-id="heading-10">4. glances 全面评测</h3>
<h4 data-id="heading-11">4.1 安装与配置</h4>
<p><strong>创建安装脚本：<code>install_glances.sh</code></strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>

<span class="hljs-comment"># glances 安装脚本</span>

<span class="hljs-built_in">set</span> -e

<span class="hljs-built_in">echo</span> <span class="hljs-string">"开始安装 glances..."</span>

<span class="hljs-comment"># Python环境检查</span>
<span class="hljs-keyword">if</span> ! <span class="hljs-built_in">command</span> -v python3 &amp;&gt; /dev/null; <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"Python3 未安装，开始安装..."</span>
    <span class="hljs-keyword">if</span> <span class="hljs-built_in">command</span> -v apt &amp;&gt; /dev/null; <span class="hljs-keyword">then</span>
        sudo apt update &amp;&amp; sudo apt install -y python3 python3-pip
    <span class="hljs-keyword">elif</span> <span class="hljs-built_in">command</span> -v yum &amp;&gt; /dev/null; <span class="hljs-keyword">then</span>
        sudo yum install -y python3 python3-pip
    <span class="hljs-keyword">fi</span>
<span class="hljs-keyword">fi</span>

<span class="hljs-comment"># 安装方法选择</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"选择安装方式:"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"1. pip 安装（推荐）"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"2. 系统包管理器安装"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"3. 源码安装"</span>
<span class="hljs-built_in">echo</span> -n <span class="hljs-string">"请选择 [1-3]: "</span>

<span class="hljs-built_in">read</span> install_choice

<span class="hljs-keyword">case</span> <span class="hljs-variable">$install_choice</span> <span class="hljs-keyword">in</span>
    1)
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"使用 pip 安装..."</span>
        pip3 install glances[all]
        ;;
    2)
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"使用系统包管理器安装..."</span>
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">command</span> -v apt &amp;&gt; /dev/null; <span class="hljs-keyword">then</span>
            sudo apt install -y glances
        <span class="hljs-keyword">elif</span> <span class="hljs-built_in">command</span> -v yum &amp;&gt; /dev/null; <span class="hljs-keyword">then</span>
            sudo yum install -y glances
        <span class="hljs-keyword">elif</span> <span class="hljs-built_in">command</span> -v dnf &amp;&gt; /dev/null; <span class="hljs-keyword">then</span>
            sudo dnf install -y glances
        <span class="hljs-keyword">else</span>
            <span class="hljs-built_in">echo</span> <span class="hljs-string">"不支持的包管理器，回退到pip安装"</span>
            pip3 install glances[all]
        <span class="hljs-keyword">fi</span>
        ;;
    3)
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"从源码安装..."</span>
        git <span class="hljs-built_in">clone</span> https://github.com/nicolargo/glances.git
        <span class="hljs-built_in">cd</span> glances
        pip3 install -e .
        <span class="hljs-built_in">cd</span> ..
        <span class="hljs-built_in">rm</span> -rf glances
        ;;
    *)
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"无效选择，使用默认pip安装"</span>
        pip3 install glances[all]
        ;;
<span class="hljs-keyword">esac</span>

<span class="hljs-comment"># 创建配置文件目录</span>
<span class="hljs-built_in">mkdir</span> -p ~/.config/glances

<span class="hljs-built_in">echo</span> <span class="hljs-string">"glances 安装完成！"</span>
</code></pre>
<h4 data-id="heading-12">4.2 glances 配置文件</h4>
<p><strong>创建配置文件：<code>~/.config/glances/glances.conf</code></strong></p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-section">[global]</span>
<span class="hljs-comment"># 刷新频率</span>
<span class="hljs-attr">refresh</span>=<span class="hljs-number">2</span>

<span class="hljs-comment"># 显示选项</span>
<span class="hljs-attr">disable_alert</span>=<span class="hljs-literal">no</span>
<span class="hljs-attr">enable_process_extended</span>=<span class="hljs-literal">no</span>
<span class="hljs-attr">process_short_name</span>=<span class="hljs-literal">no</span>

<span class="hljs-comment"># 颜色配置</span>
<span class="hljs-attr">theme</span>=white
<span class="hljs-comment"># 可选: white, black, grey</span>

<span class="hljs-comment"># 导出配置</span>
<span class="hljs-attr">export</span>=csv
<span class="hljs-comment"># 可选: csv, json</span>

<span class="hljs-section">[cpu]</span>
<span class="hljs-comment"># CPU监控配置</span>
<span class="hljs-attr">user_careful</span>=<span class="hljs-number">50</span>
<span class="hljs-attr">user_warning</span>=<span class="hljs-number">70</span>
<span class="hljs-attr">user_critical</span>=<span class="hljs-number">90</span>
<span class="hljs-attr">system_careful</span>=<span class="hljs-number">50</span>
<span class="hljs-attr">system_warning</span>=<span class="hljs-number">70</span>
<span class="hljs-attr">system_critical</span>=<span class="hljs-number">90</span>

<span class="hljs-section">[mem]</span>
<span class="hljs-comment"># 内存监控配置</span>
<span class="hljs-attr">mem_careful</span>=<span class="hljs-number">50</span>
<span class="hljs-attr">mem_warning</span>=<span class="hljs-number">70</span>
<span class="hljs-attr">mem_critical</span>=<span class="hljs-number">90</span>
<span class="hljs-attr">swap_careful</span>=<span class="hljs-number">50</span>
<span class="hljs-attr">swap_warning</span>=<span class="hljs-number">70</span>
<span class="hljs-attr">swap_critical</span>=<span class="hljs-number">90</span>

<span class="hljs-section">[fs]</span>
<span class="hljs-comment"># 文件系统监控</span>
<span class="hljs-attr">filter</span>=/

<span class="hljs-section">[network]</span>
<span class="hljs-comment"># 网络接口配置</span>
<span class="hljs-comment"># 自动检测所有接口</span>
<span class="hljs-attr">interface</span>=auto

<span class="hljs-section">[connections]</span>
<span class="hljs-comment"># 连接监控</span>
<span class="hljs-attr">max_retry</span>=<span class="hljs-number">3</span>

<span class="hljs-section">[alert]</span>
<span class="hljs-comment"># 告警配置</span>
<span class="hljs-attr">enable</span>=<span class="hljs-literal">yes</span>
<span class="hljs-attr">cmd</span>=echo <span class="hljs-string">"Glances alert: {message}"</span>

<span class="hljs-section">[quicklook]</span>
<span class="hljs-comment"># 快速查看配置</span>
<span class="hljs-attr">cpu_percent</span>=<span class="hljs-literal">yes</span>
<span class="hljs-attr">mem_percent</span>=<span class="hljs-literal">yes</span>
<span class="hljs-attr">swap_percent</span>=<span class="hljs-literal">yes</span>

<span class="hljs-section">[processlist]</span>
<span class="hljs-comment"># 进程列表配置</span>
<span class="hljs-attr">sort</span>=auto
<span class="hljs-comment"># 可选: auto, cpu_percent, memory_percent, io_counters</span>

<span class="hljs-section">[amps]</span>
<span class="hljs-comment"># 应用监控</span>
<span class="hljs-attr">enable</span>=<span class="hljs-literal">no</span>
</code></pre>
<h4 data-id="heading-13">4.3 glances 高级使用脚本</h4>
<p><strong>创建高级监控脚本：<code>glances_advanced.sh</code></strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>

<span class="hljs-comment"># glances 高级监控脚本</span>

<span class="hljs-comment"># 颜色定义</span>
GREEN=<span class="hljs-string">'\033[0;32m'</span>
BLUE=<span class="hljs-string">'\033[0;34m'</span>
YELLOW=<span class="hljs-string">'\033[1;33m'</span>
RED=<span class="hljs-string">'\033[0;31m'</span>
NC=<span class="hljs-string">'\033[0m'</span>

<span class="hljs-comment"># 检查glances是否安装</span>
<span class="hljs-function"><span class="hljs-title">check_glances</span></span>() {
    <span class="hljs-keyword">if</span> ! <span class="hljs-built_in">command</span> -v glances &amp;&gt; /dev/null; <span class="hljs-keyword">then</span>
        <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${RED}</span>错误: glances 未安装<span class="hljs-variable">${NC}</span>"</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"请先运行 install_glances.sh"</span>
        <span class="hljs-built_in">exit</span> 1
    <span class="hljs-keyword">fi</span>
}

<span class="hljs-comment"># 独立监控模式</span>
<span class="hljs-function"><span class="hljs-title">standalone_monitor</span></span>() {
    <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${GREEN}</span>启动独立监控模式...<span class="hljs-variable">${NC}</span>"</span>
    glances --disable-webui --time 5
}

<span class="hljs-comment"># 客户端-服务器模式</span>
<span class="hljs-function"><span class="hljs-title">start_server</span></span>() {
    <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${GREEN}</span>启动 glances 服务器...<span class="hljs-variable">${NC}</span>"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"服务器将在端口 61209 监听"</span>
    glances -s -B 0.0.0.0 &amp;
    SERVER_PID=$!
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"服务器PID: <span class="hljs-variable">$SERVER_PID</span>"</span>
}

<span class="hljs-function"><span class="hljs-title">start_client</span></span>() {
    <span class="hljs-built_in">echo</span> -n <span class="hljs-string">"请输入服务器IP地址: "</span>
    <span class="hljs-built_in">read</span> server_ip
    <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${GREEN}</span>连接到服务器 <span class="hljs-variable">$server_ip</span> ...<span class="hljs-variable">${NC}</span>"</span>
    glances -c <span class="hljs-variable">$server_ip</span>
}

<span class="hljs-comment"># Web界面模式</span>
<span class="hljs-function"><span class="hljs-title">start_webui</span></span>() {
    <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${GREEN}</span>启动 Web 界面...<span class="hljs-variable">${NC}</span>"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"Web界面地址: http://0.0.0.0:61208"</span>
    glances -w &amp;
    WEBUI_PID=$!
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"Web界面PID: <span class="hljs-variable">$WEBUI_PID</span>"</span>
}

<span class="hljs-comment"># RESTful API模式</span>
<span class="hljs-function"><span class="hljs-title">start_api</span></span>() {
    <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${GREEN}</span>启动 RESTful API...<span class="hljs-variable">${NC}</span>"</span>
    glances -s --disable-webui &amp;
    API_PID=$!
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"API服务PID: <span class="hljs-variable">$API_PID</span>"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"API地址: http://0.0.0.0:61209/api/3"</span>
}

<span class="hljs-comment"># 导出监控数据</span>
<span class="hljs-function"><span class="hljs-title">export_data</span></span>() {
    <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${GREEN}</span>数据导出选项:<span class="hljs-variable">${NC}</span>"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"1. 导出为CSV"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"2. 导出为JSON"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"3. 导出为InfluxDB"</span>
    <span class="hljs-built_in">echo</span> -n <span class="hljs-string">"请选择 [1-3]: "</span>
    
    <span class="hljs-built_in">read</span> export_choice
    <span class="hljs-keyword">case</span> <span class="hljs-variable">$export_choice</span> <span class="hljs-keyword">in</span>
        1)
            glances --<span class="hljs-built_in">export</span> csv --export-csv-file /tmp/glances.csv &amp;
            ;;
        2)
            glances --<span class="hljs-built_in">export</span> json --export-json-file /tmp/glances.json &amp;
            ;;
        3)
            glances --<span class="hljs-built_in">export</span> influxdb &amp;
            ;;
        *)
            <span class="hljs-built_in">echo</span> <span class="hljs-string">"无效选择"</span>
            ;;
    <span class="hljs-keyword">esac</span>
}

<span class="hljs-comment"># 自定义监控视图</span>
<span class="hljs-function"><span class="hljs-title">custom_view</span></span>() {
    <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${GREEN}</span>自定义监控视图...<span class="hljs-variable">${NC}</span>"</span>
    glances --disable-irq --disable-folders --disable-ports \
            --disable-network --disable-diskio
}

<span class="hljs-comment"># 进程监控增强</span>
<span class="hljs-function"><span class="hljs-title">process_monitor</span></span>() {
    <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${GREEN}</span>进程监控增强模式...<span class="hljs-variable">${NC}</span>"</span>
    glances --enable-process-extended --process-short-name
}

<span class="hljs-comment"># 显示菜单</span>
<span class="hljs-function"><span class="hljs-title">show_menu</span></span>() {
    <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${BLUE}</span>=== glances 高级监控菜单 ===<span class="hljs-variable">${NC}</span>"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"1. 独立监控模式"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"2. 启动服务器模式"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"3. 连接客户端模式"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"4. 启动Web界面"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"5. 启动RESTful API"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"6. 数据导出"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"7. 自定义视图"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"8. 进程监控增强"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"9. 停止所有服务"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"0. 退出"</span>
    <span class="hljs-built_in">echo</span> -n <span class="hljs-string">"请选择 [0-9]: "</span>
}

<span class="hljs-comment"># 停止服务</span>
<span class="hljs-function"><span class="hljs-title">stop_services</span></span>() {
    <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${YELLOW}</span>停止所有 glances 服务...<span class="hljs-variable">${NC}</span>"</span>
    pkill -f <span class="hljs-string">"glances"</span> || <span class="hljs-literal">true</span>
    <span class="hljs-built_in">sleep</span> 2
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"服务已停止"</span>
}

<span class="hljs-comment"># 主函数</span>
<span class="hljs-function"><span class="hljs-title">main</span></span>() {
    check_glances
    
    <span class="hljs-keyword">while</span> <span class="hljs-literal">true</span>; <span class="hljs-keyword">do</span>
        show_menu
        <span class="hljs-built_in">read</span> choice
        
        <span class="hljs-keyword">case</span> <span class="hljs-variable">$choice</span> <span class="hljs-keyword">in</span>
            1)
                standalone_monitor
                ;;
            2)
                start_server
                ;;
            3)
                start_client
                ;;
            4)
                start_webui
                ;;
            5)
                start_api
                ;;
            6)
                export_data
                ;;
            7)
                custom_view
                ;;
            8)
                process_monitor
                ;;
            9)
                stop_services
                ;;
            0)
                stop_services
                <span class="hljs-built_in">echo</span> <span class="hljs-string">"退出"</span>
                <span class="hljs-built_in">break</span>
                ;;
            *)
                <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${RED}</span>无效选择<span class="hljs-variable">${NC}</span>"</span>
                ;;
        <span class="hljs-keyword">esac</span>
        
        <span class="hljs-built_in">echo</span>
        <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${YELLOW}</span>按回车继续...<span class="hljs-variable">${NC}</span>"</span>
        <span class="hljs-built_in">read</span>
    <span class="hljs-keyword">done</span>
}

<span class="hljs-comment"># 运行主函数</span>
main <span class="hljs-string">"<span class="hljs-variable">$@</span>"</span>
</code></pre>
<h3 data-id="heading-14">5. bpytop 视觉盛宴</h3>
<h4 data-id="heading-15">5.1 安装与配置</h4>
<p><strong>创建安装脚本：<code>install_bpytop.sh</code></strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>

<span class="hljs-comment"># bpytop 安装脚本</span>

<span class="hljs-built_in">set</span> -e

<span class="hljs-built_in">echo</span> <span class="hljs-string">"开始安装 bpytop..."</span>

<span class="hljs-comment"># 检查Python版本</span>
python_version=$(python3 -c <span class="hljs-string">'import sys; print(".".join(map(str, sys.version_info[:2])))'</span>)
<span class="hljs-built_in">echo</span> <span class="hljs-string">"检测到 Python 版本: <span class="hljs-variable">$python_version</span>"</span>

<span class="hljs-keyword">if</span> [ $(<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$python_version</span> &lt; 3.6"</span> | bc) -eq 1 ]; <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"错误: bpytop 需要 Python 3.6 或更高版本"</span>
    <span class="hljs-built_in">exit</span> 1
<span class="hljs-keyword">fi</span>

<span class="hljs-comment"># 安装依赖</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"安装系统依赖..."</span>
<span class="hljs-keyword">if</span> <span class="hljs-built_in">command</span> -v apt &amp;&gt; /dev/null; <span class="hljs-keyword">then</span>
    sudo apt update
    sudo apt install -y python3-pip python3-venv psutil
<span class="hljs-keyword">elif</span> <span class="hljs-built_in">command</span> -v yum &amp;&gt; /dev/null; <span class="hljs-keyword">then</span>
    sudo yum install -y python3-pip python3-venv python3-psutil
<span class="hljs-keyword">elif</span> <span class="hljs-built_in">command</span> -v dnf &amp;&gt; /dev/null; <span class="hljs-keyword">then</span>
    sudo dnf install -y python3-pip python3-venv python3-psutil
<span class="hljs-keyword">elif</span> <span class="hljs-built_in">command</span> -v pacman &amp;&gt; /dev/null; <span class="hljs-keyword">then</span>
    sudo pacman -Syu --noconfirm python-pip python-psutil
<span class="hljs-keyword">fi</span>

<span class="hljs-comment"># 安装方法选择</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"选择安装方式:"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"1. pip 安装（推荐）"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"2. 系统包管理器安装"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"3. 从源码安装"</span>
<span class="hljs-built_in">echo</span> -n <span class="hljs-string">"请选择 [1-3]: "</span>

<span class="hljs-built_in">read</span> install_choice

<span class="hljs-keyword">case</span> <span class="hljs-variable">$install_choice</span> <span class="hljs-keyword">in</span>
    1)
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"使用 pip 安装..."</span>
        pip3 install bpytop --upgrade
        ;;
    2)
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"使用系统包管理器安装..."</span>
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">command</span> -v apt &amp;&gt; /dev/null; <span class="hljs-keyword">then</span>
            <span class="hljs-comment"># 添加PPA（Ubuntu）</span>
            sudo add-apt-repository ppa:bpytop/ppa -y
            sudo apt update
            sudo apt install -y bpytop
        <span class="hljs-keyword">elif</span> <span class="hljs-built_in">command</span> -v dnf &amp;&gt; /dev/null; <span class="hljs-keyword">then</span>
            <span class="hljs-comment"># COPR仓库（Fedora）</span>
            sudo dnf copr <span class="hljs-built_in">enable</span> atim/bpytop -y
            sudo dnf install -y bpytop
        <span class="hljs-keyword">else</span>
            <span class="hljs-built_in">echo</span> <span class="hljs-string">"不支持的包管理器，回退到pip安装"</span>
            pip3 install bpytop --upgrade
        <span class="hljs-keyword">fi</span>
        ;;
    3)
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"从源码安装..."</span>
        git <span class="hljs-built_in">clone</span> https://github.com/aristocratos/bpytop.git
        <span class="hljs-built_in">cd</span> bpytop
        sudo make install
        <span class="hljs-built_in">cd</span> ..
        <span class="hljs-built_in">rm</span> -rf bpytop
        ;;
    *)
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"无效选择，使用默认pip安装"</span>
        pip3 install bpytop --upgrade
        ;;
<span class="hljs-keyword">esac</span>

<span class="hljs-comment"># 创建配置目录</span>
<span class="hljs-built_in">mkdir</span> -p ~/.config/bpytop

<span class="hljs-built_in">echo</span> <span class="hljs-string">"bpytop 安装完成！"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"运行命令: bpytop 启动程序"</span>
</code></pre>
<h4 data-id="heading-16">5.2 bpytop 配置文件</h4>
<p><strong>创建配置文件：<code>~/.config/bpytop/bpytop.conf</code></strong></p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># bpytop 配置文件</span>

<span class="hljs-comment"># 颜色主题</span>
<span class="hljs-attr">color_theme</span>=<span class="hljs-string">"default"</span>
<span class="hljs-comment"># 可选: default, gruvbox, solarized, monokai</span>

<span class="hljs-comment"># 界面布局</span>
<span class="hljs-attr">theme_background</span>=<span class="hljs-literal">False</span>
<span class="hljs-attr">rounded_corners</span>=<span class="hljs-literal">True</span>
<span class="hljs-attr">proc_per_core</span>=<span class="hljs-literal">True</span>
<span class="hljs-attr">show_uptime</span>=<span class="hljs-literal">True</span>
<span class="hljs-attr">check_temp</span>=<span class="hljs-literal">True</span>
<span class="hljs-attr">show_cpu_freq</span>=<span class="hljs-literal">True</span>
<span class="hljs-attr">background_update</span>=<span class="hljs-literal">True</span>
<span class="hljs-attr">base_10_sizes</span>=<span class="hljs-literal">False</span>

<span class="hljs-comment"># 显示选项</span>
<span class="hljs-attr">draw_clock</span>=<span class="hljs-literal">True</span>
<span class="hljs-attr">clock_format</span>=<span class="hljs-string">"%X"</span>
<span class="hljs-attr">background_update</span>=<span class="hljs-literal">True</span>
<span class="hljs-attr">use_fstab</span>=<span class="hljs-literal">True</span>
<span class="hljs-attr">show_disks</span>=<span class="hljs-literal">True</span>
<span class="hljs-attr">show_io_stat</span>=<span class="hljs-literal">True</span>
<span class="hljs-attr">io_mode</span>=<span class="hljs-literal">True</span>
<span class="hljs-attr">io_graph_combined</span>=<span class="hljs-literal">True</span>
<span class="hljs-attr">show_swap</span>=<span class="hljs-literal">True</span>
<span class="hljs-attr">show_swap_detailed</span>=<span class="hljs-literal">True</span>

<span class="hljs-comment"># 网络配置</span>
<span class="hljs-attr">net_download</span>=<span class="hljs-number">1000</span>
<span class="hljs-attr">net_upload</span>=<span class="hljs-number">1000</span>
<span class="hljs-attr">net_auto</span>=<span class="hljs-literal">True</span>
<span class="hljs-attr">net_sync</span>=<span class="hljs-literal">True</span>

<span class="hljs-comment"># 进程配置</span>
<span class="hljs-attr">proc_gradient</span>=<span class="hljs-literal">True</span>
<span class="hljs-attr">proc_mem_bytes</span>=<span class="hljs-literal">True</span>
<span class="hljs-attr">proc_tree</span>=<span class="hljs-literal">True</span>
<span class="hljs-attr">proc_colors</span>=<span class="hljs-literal">True</span>
<span class="hljs-attr">proc_reversed</span>=<span class="hljs-literal">True</span>
<span class="hljs-attr">proc_count</span>=<span class="hljs-number">5</span>

<span class="hljs-comment"># CPU配置</span>
<span class="hljs-attr">cpu_core_map</span>=<span class="hljs-literal">True</span>
<span class="hljs-attr">cpu_invert_lower</span>=<span class="hljs-literal">True</span>
<span class="hljs-attr">cpu_single_graph</span>=<span class="hljs-literal">False</span>
<span class="hljs-attr">show_coretemp</span>=<span class="hljs-literal">True</span>
<span class="hljs-attr">cpu_graph_upper</span>=<span class="hljs-string">"total"</span>
<span class="hljs-attr">cpu_graph_lower</span>=<span class="hljs-string">"total"</span>

<span class="hljs-comment"># 内存配置</span>
<span class="hljs-attr">mem_graphs</span>=<span class="hljs-literal">True</span>
<span class="hljs-attr">show_swap</span>=<span class="hljs-literal">True</span>

<span class="hljs-comment"># 磁盘配置</span>
<span class="hljs-attr">show_disks</span>=<span class="hljs-literal">True</span>
<span class="hljs-attr">disk_free_priv</span>=<span class="hljs-literal">True</span>

<span class="hljs-comment"># 电池配置</span>
<span class="hljs-attr">show_battery</span>=<span class="hljs-literal">True</span>
<span class="hljs-attr">selected_battery</span>=<span class="hljs-string">"auto"</span>

<span class="hljs-comment"># 更新间隔</span>
<span class="hljs-attr">update_ms</span>=<span class="hljs-number">2000</span>

<span class="hljs-comment"># 自定义颜色</span>
<span class="hljs-comment"># 主色调</span>
<span class="hljs-attr">title_color</span>=<span class="hljs-string">"cyan"</span>
<span class="hljs-attr">hi_fg</span>=<span class="hljs-string">"white"</span>
<span class="hljs-attr">selected_bg</span>=<span class="hljs-string">"blue"</span>

<span class="hljs-comment"># CPU颜色</span>
<span class="hljs-attr">cpu_box</span>=<span class="hljs-string">"magenta"</span>
<span class="hljs-attr">cpu_color</span>=[<span class="hljs-string">"green"</span>,<span class="hljs-string">"yellow"</span>,<span class="hljs-string">"red"</span>]

<span class="hljs-comment"># 内存颜色</span>
<span class="hljs-attr">mem_box</span>=<span class="hljs-string">"green"</span>
<span class="hljs-attr">mem_color</span>=[<span class="hljs-string">"green"</span>,<span class="hljs-string">"yellow"</span>,<span class="hljs-string">"red"</span>]

<span class="hljs-comment"># 网络颜色</span>
<span class="hljs-attr">net_box</span>=<span class="hljs-string">"yellow"</span>
<span class="hljs-attr">net_color</span>=[<span class="hljs-string">"green"</span>,<span class="hljs-string">"yellow"</span>,<span class="hljs-string">"red"</span>]

<span class="hljs-comment"># 进程颜色</span>
<span class="hljs-attr">proc_color</span>=[<span class="hljs-string">"white"</span>,<span class="hljs-string">"blue"</span>,<span class="hljs-string">"cyan"</span>,<span class="hljs-string">"green"</span>,<span class="hljs-string">"yellow"</span>,<span class="hljs-string">"red"</span>]

<span class="hljs-comment"># 自定义图形字符</span>
<span class="hljs-attr">graph_symbol</span>=<span class="hljs-string">"braille"</span>
<span class="hljs-comment"># 可选: braille, block, tty</span>

<span class="hljs-attr">tty_mode</span>=<span class="hljs-literal">False</span>
</code></pre>
<h4 data-id="heading-17">5.3 bpytop 主题定制脚本</h4>
<p><strong>创建主题管理脚本：<code>bpytop_themes.sh</code></strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>

<span class="hljs-comment"># bpytop 主题管理脚本</span>

THEMES_DIR=<span class="hljs-string">"<span class="hljs-variable">$HOME</span>/.config/bpytop/themes"</span>
CONFIG_FILE=<span class="hljs-string">"<span class="hljs-variable">$HOME</span>/.config/bpytop/bpytop.conf"</span>

<span class="hljs-comment"># 创建主题目录</span>
<span class="hljs-built_in">mkdir</span> -p <span class="hljs-string">"<span class="hljs-variable">$THEMES_DIR</span>"</span>

<span class="hljs-comment"># 颜色定义</span>
RED=<span class="hljs-string">'\033[0;31m'</span>
GREEN=<span class="hljs-string">'\033[0;32m'</span>
YELLOW=<span class="hljs-string">'\033[1;33m'</span>
BLUE=<span class="hljs-string">'\033[0;34m'</span>
PURPLE=<span class="hljs-string">'\033[0;35m'</span>
CYAN=<span class="hljs-string">'\033[0;36m'</span>
NC=<span class="hljs-string">'\033[0m'</span>

<span class="hljs-comment"># 创建默认主题</span>
<span class="hljs-function"><span class="hljs-title">create_default_theme</span></span>() {
    <span class="hljs-built_in">cat</span> &gt; <span class="hljs-string">"<span class="hljs-variable">$THEMES_DIR</span>/default.theme"</span> &lt;&lt; <span class="hljs-string">'EOF'</span>
<span class="hljs-comment"># 默认主题</span>
color_theme=<span class="hljs-string">"default"</span>
title_color=<span class="hljs-string">"cyan"</span>
hi_fg=<span class="hljs-string">"white"</span>
selected_bg=<span class="hljs-string">"blue"</span>
cpu_box=<span class="hljs-string">"magenta"</span>
mem_box=<span class="hljs-string">"green"</span>
net_box=<span class="hljs-string">"yellow"</span>
proc_color=[<span class="hljs-string">"white"</span>,<span class="hljs-string">"blue"</span>,<span class="hljs-string">"cyan"</span>,<span class="hljs-string">"green"</span>,<span class="hljs-string">"yellow"</span>,<span class="hljs-string">"red"</span>]
EOF
}

<span class="hljs-comment"># 创建 Gruvbox 主题</span>
<span class="hljs-function"><span class="hljs-title">create_gruvbox_theme</span></span>() {
    <span class="hljs-built_in">cat</span> &gt; <span class="hljs-string">"<span class="hljs-variable">$THEMES_DIR</span>/gruvbox.theme"</span> &lt;&lt; <span class="hljs-string">'EOF'</span>
<span class="hljs-comment"># Gruvbox 主题</span>
color_theme=<span class="hljs-string">"gruvbox"</span>
title_color=<span class="hljs-string">"#fabd2f"</span>
hi_fg=<span class="hljs-string">"#ebdbb2"</span>
selected_bg=<span class="hljs-string">"#458588"</span>
cpu_box=<span class="hljs-string">"#cc241d"</span>
mem_box=<span class="hljs-string">"#98971a"</span> 
net_box=<span class="hljs-string">"#d79921"</span>
proc_color=[<span class="hljs-string">"#ebdbb2"</span>,<span class="hljs-string">"#458588"</span>,<span class="hljs-string">"#689d6a"</span>,<span class="hljs-string">"#98971a"</span>,<span class="hljs-string">"#d79921"</span>,<span class="hljs-string">"#cc241d"</span>]
EOF
}

<span class="hljs-comment"># 创建 Solarized 主题</span>
<span class="hljs-function"><span class="hljs-title">create_solarized_theme</span></span>() {
    <span class="hljs-built_in">cat</span> &gt; <span class="hljs-string">"<span class="hljs-variable">$THEMES_DIR</span>/solarized.theme"</span> &lt;&lt; <span class="hljs-string">'EOF'</span>
<span class="hljs-comment"># Solarized 主题</span>
color_theme=<span class="hljs-string">"solarized"</span>
title_color=<span class="hljs-string">"#268bd2"</span>
hi_fg=<span class="hljs-string">"#93a1a1"</span>
selected_bg=<span class="hljs-string">"#859900"</span>
cpu_box=<span class="hljs-string">"#dc322f"</span>
mem_box=<span class="hljs-string">"#2aa198"</span>
net_box=<span class="hljs-string">"#b58900"</span>
proc_color=[<span class="hljs-string">"#93a1a1"</span>,<span class="hljs-string">"#268bd2"</span>,<span class="hljs-string">"#2aa198"</span>,<span class="hljs-string">"#859900"</span>,<span class="hljs-string">"#b58900"</span>,<span class="hljs-string">"#dc322f"</span>]
EOF
}

<span class="hljs-comment"># 创建 Monokai 主题</span>
<span class="hljs-function"><span class="hljs-title">create_monokai_theme</span></span>() {
    <span class="hljs-built_in">cat</span> &gt; <span class="hljs-string">"<span class="hljs-variable">$THEMES_DIR</span>/monokai.theme"</span> &lt;&lt; <span class="hljs-string">'EOF'</span>
<span class="hljs-comment"># Monokai 主题</span>
color_theme=<span class="hljs-string">"monokai"</span>
title_color=<span class="hljs-string">"#a6e22e"</span>
hi_fg=<span class="hljs-string">"#f8f8f2"</span>
selected_bg=<span class="hljs-string">"#66d9ef"</span>
cpu_box=<span class="hljs-string">"#f92672"</span>
mem_box=<span class="hljs-string">"#a6e22e"</span>
net_box=<span class="hljs-string">"#fd971f"</span>
proc_color=[<span class="hljs-string">"#f8f8f2"</span>,<span class="hljs-string">"#66d9ef"</span>,<span class="hljs-string">"#a6e22e"</span>,<span class="hljs-string">"#fd971f"</span>,<span class="hljs-string">"#f92672"</span>,<span class="hljs-string">"#ae81ff"</span>]
EOF
}

<span class="hljs-comment"># 创建黑客帝国主题</span>
<span class="hljs-function"><span class="hljs-title">create_matrix_theme</span></span>() {
    <span class="hljs-built_in">cat</span> &gt; <span class="hljs-string">"<span class="hljs-variable">$THEMES_DIR</span>/matrix.theme"</span> &lt;&lt; <span class="hljs-string">'EOF'</span>
<span class="hljs-comment"># 黑客帝国主题</span>
color_theme=<span class="hljs-string">"matrix"</span>
title_color=<span class="hljs-string">"#00ff00"</span>
hi_fg=<span class="hljs-string">"#00ff00"</span>
selected_bg=<span class="hljs-string">"#004400"</span>
cpu_box=<span class="hljs-string">"#00ff00"</span>
mem_box=<span class="hljs-string">"#00ff00"</span>
net_box=<span class="hljs-string">"#00ff00"</span>
proc_color=[<span class="hljs-string">"#00ff00"</span>,<span class="hljs-string">"#00cc00"</span>,<span class="hljs-string">"#009900"</span>,<span class="hljs-string">"#006600"</span>,<span class="hljs-string">"#003300"</span>]
graph_symbol=<span class="hljs-string">"braille"</span>
theme_background=True
EOF
}

<span class="hljs-comment"># 应用主题</span>
<span class="hljs-function"><span class="hljs-title">apply_theme</span></span>() {
    <span class="hljs-built_in">local</span> theme_name=<span class="hljs-variable">$1</span>
    <span class="hljs-built_in">local</span> theme_file=<span class="hljs-string">"<span class="hljs-variable">$THEMES_DIR</span>/<span class="hljs-variable">${theme_name}</span>.theme"</span>
    
    <span class="hljs-keyword">if</span> [[ ! -f <span class="hljs-string">"<span class="hljs-variable">$theme_file</span>"</span> ]]; <span class="hljs-keyword">then</span>
        <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${RED}</span>错误: 主题文件 <span class="hljs-variable">$theme_file</span> 不存在<span class="hljs-variable">${NC}</span>"</span>
        <span class="hljs-built_in">return</span> 1
    <span class="hljs-keyword">fi</span>
    
    <span class="hljs-comment"># 备份原配置</span>
    <span class="hljs-built_in">cp</span> <span class="hljs-string">"<span class="hljs-variable">$CONFIG_FILE</span>"</span> <span class="hljs-string">"<span class="hljs-variable">$CONFIG_FILE</span>.backup.<span class="hljs-subst">$(date +%Y%m%d_%H%M%S)</span>"</span>
    
    <span class="hljs-comment"># 应用新主题</span>
    <span class="hljs-built_in">cat</span> <span class="hljs-string">"<span class="hljs-variable">$theme_file</span>"</span> &gt;&gt; <span class="hljs-string">"<span class="hljs-variable">$CONFIG_FILE</span>"</span>
    
    <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${GREEN}</span>主题 <span class="hljs-variable">$theme_name</span> 应用成功！<span class="hljs-variable">${NC}</span>"</span>
}

<span class="hljs-comment"># 列出所有主题</span>
<span class="hljs-function"><span class="hljs-title">list_themes</span></span>() {
    <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${CYAN}</span>=== 可用主题 ===<span class="hljs-variable">${NC}</span>"</span>
    <span class="hljs-keyword">for</span> theme_file <span class="hljs-keyword">in</span> <span class="hljs-string">"<span class="hljs-variable">$THEMES_DIR</span>"</span>/*.theme; <span class="hljs-keyword">do</span>
        <span class="hljs-keyword">if</span> [[ -f <span class="hljs-string">"<span class="hljs-variable">$theme_file</span>"</span> ]]; <span class="hljs-keyword">then</span>
            theme_name=$(<span class="hljs-built_in">basename</span> <span class="hljs-string">"<span class="hljs-variable">$theme_file</span>"</span> .theme)
            <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${YELLOW}</span>$theme_name<span class="hljs-variable">${NC}</span>"</span>
        <span class="hljs-keyword">fi</span>
    <span class="hljs-keyword">done</span>
}

<span class="hljs-comment"># 创建所有主题</span>
<span class="hljs-function"><span class="hljs-title">create_all_themes</span></span>() {
    <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${BLUE}</span>创建所有内置主题...<span class="hljs-variable">${NC}</span>"</span>
    create_default_theme
    create_gruvbox_theme
    create_solarized_theme
    create_monokai_theme
    create_matrix_theme
    <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${GREEN}</span>所有主题创建完成！<span class="hljs-variable">${NC}</span>"</span>
}

<span class="hljs-comment"># 预览主题</span>
<span class="hljs-function"><span class="hljs-title">preview_theme</span></span>() {
    <span class="hljs-built_in">local</span> theme_name=<span class="hljs-variable">$1</span>
    <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${CYAN}</span>=== 主题预览: <span class="hljs-variable">$theme_name</span> ===<span class="hljs-variable">${NC}</span>"</span>
    
    <span class="hljs-keyword">case</span> <span class="hljs-variable">$theme_name</span> <span class="hljs-keyword">in</span>
        <span class="hljs-string">"default"</span>)
            <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"主色调: <span class="hljs-variable">${CYAN}</span>青色<span class="hljs-variable">${NC}</span>"</span>
            <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"CPU: <span class="hljs-variable">${PURPLE}</span>紫色<span class="hljs-variable">${NC}</span>"</span>
            <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"内存: <span class="hljs-variable">${GREEN}</span>绿色<span class="hljs-variable">${NC}</span>"</span>
            ;;
        <span class="hljs-string">"gruvbox"</span>)
            <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"主色调: <span class="hljs-variable">${YELLOW}</span>黄色<span class="hljs-variable">${NC}</span>"</span>
            <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"CPU: <span class="hljs-variable">${RED}</span>红色<span class="hljs-variable">${NC}</span>"</span>
            <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"内存: <span class="hljs-variable">${GREEN}</span>绿色<span class="hljs-variable">${NC}</span>"</span>
            ;;
        <span class="hljs-string">"solarized"</span>)
            <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"主色调: <span class="hljs-variable">${BLUE}</span>蓝色<span class="hljs-variable">${NC}</span>"</span>
            <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"CPU: <span class="hljs-variable">${RED}</span>红色<span class="hljs-variable">${NC}</span>"</span>
            <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"内存: <span class="hljs-variable">${CYAN}</span>青色<span class="hljs-variable">${NC}</span>"</span>
            ;;
        <span class="hljs-string">"monokai"</span>)
            <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"主色调: <span class="hljs-variable">${GREEN}</span>绿色<span class="hljs-variable">${NC}</span>"</span>
            <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"CPU: <span class="hljs-variable">${RED}</span>红色<span class="hljs-variable">${NC}</span>"</span>
            <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"内存: <span class="hljs-variable">${GREEN}</span>绿色<span class="hljs-variable">${NC}</span>"</span>
            ;;
        <span class="hljs-string">"matrix"</span>)
            <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"所有元素: <span class="hljs-variable">${GREEN}</span>矩阵绿<span class="hljs-variable">${NC}</span>"</span>
            <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"风格: 黑客帝国"</span>
            ;;
    <span class="hljs-keyword">esac</span>
}

<span class="hljs-comment"># 显示菜单</span>
<span class="hljs-function"><span class="hljs-title">show_menu</span></span>() {
    <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${PURPLE}</span>=== bpytop 主题管理器 ===<span class="hljs-variable">${NC}</span>"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"1. 创建所有主题"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"2. 列出所有主题"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"3. 应用默认主题"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"4. 应用 Gruvbox 主题"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"5. 应用 Solarized 主题"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"6. 应用 Monokai 主题"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"7. 应用黑客帝国主题"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"8. 预览主题"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"9. 恢复默认配置"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"0. 退出"</span>
    <span class="hljs-built_in">echo</span> -n <span class="hljs-string">"请选择 [0-9]: "</span>
}

<span class="hljs-comment"># 恢复默认配置</span>
<span class="hljs-function"><span class="hljs-title">restore_default</span></span>() {
    <span class="hljs-keyword">if</span> [[ -f <span class="hljs-string">"<span class="hljs-variable">$CONFIG_FILE</span>.backup"</span> ]]; <span class="hljs-keyword">then</span>
        <span class="hljs-built_in">cp</span> <span class="hljs-string">"<span class="hljs-variable">$CONFIG_FILE</span>.backup"</span> <span class="hljs-string">"<span class="hljs-variable">$CONFIG_FILE</span>"</span>
        <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${GREEN}</span>配置已恢复<span class="hljs-variable">${NC}</span>"</span>
    <span class="hljs-keyword">else</span>
        <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${YELLOW}</span>未找到备份文件<span class="hljs-variable">${NC}</span>"</span>
    <span class="hljs-keyword">fi</span>
}

<span class="hljs-comment"># 主函数</span>
<span class="hljs-function"><span class="hljs-title">main</span></span>() {
    <span class="hljs-comment"># 检查bpytop是否安装</span>
    <span class="hljs-keyword">if</span> ! <span class="hljs-built_in">command</span> -v bpytop &amp;&gt; /dev/null; <span class="hljs-keyword">then</span>
        <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${RED}</span>错误: bpytop 未安装<span class="hljs-variable">${NC}</span>"</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"请先运行 install_bpytop.sh"</span>
        <span class="hljs-built_in">exit</span> 1
    <span class="hljs-keyword">fi</span>
    
    <span class="hljs-comment"># 检查配置目录</span>
    <span class="hljs-built_in">mkdir</span> -p <span class="hljs-string">"<span class="hljs-subst">$(dirname <span class="hljs-string">"<span class="hljs-variable">$CONFIG_FILE</span>"</span>)</span>"</span>
    
    <span class="hljs-keyword">while</span> <span class="hljs-literal">true</span>; <span class="hljs-keyword">do</span>
        show_menu
        <span class="hljs-built_in">read</span> choice
        
        <span class="hljs-keyword">case</span> <span class="hljs-variable">$choice</span> <span class="hljs-keyword">in</span>
            1)
                create_all_themes
                ;;
            2)
                list_themes
                ;;
            3)
                apply_theme <span class="hljs-string">"default"</span>
                ;;
            4)
                apply_theme <span class="hljs-string">"gruvbox"</span>
                ;;
            5)
                apply_theme <span class="hljs-string">"solarized"</span>
                ;;
            6)
                apply_theme <span class="hljs-string">"monokai"</span>
                ;;
            7)
                apply_theme <span class="hljs-string">"matrix"</span>
                ;;
            8)
                <span class="hljs-built_in">echo</span> -n <span class="hljs-string">"输入要预览的主题名: "</span>
                <span class="hljs-built_in">read</span> theme_name
                preview_theme <span class="hljs-string">"<span class="hljs-variable">$theme_name</span>"</span>
                ;;
            9)
                restore_default
                ;;
            0)
                <span class="hljs-built_in">echo</span> <span class="hljs-string">"退出"</span>
                <span class="hljs-built_in">break</span>
                ;;
            *)
                <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${RED}</span>无效选择<span class="hljs-variable">${NC}</span>"</span>
                ;;
        <span class="hljs-keyword">esac</span>
        
        <span class="hljs-built_in">echo</span>
        <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${YELLOW}</span>按回车继续...<span class="hljs-variable">${NC}</span>"</span>
        <span class="hljs-built_in">read</span>
    <span class="hljs-keyword">done</span>
}

<span class="hljs-comment"># 运行主函数</span>
main <span class="hljs-string">"<span class="hljs-variable">$@</span>"</span>
</code></pre>
<h3 data-id="heading-18">6. 综合对比与使用建议</h3>
<h4 data-id="heading-19">6.1 功能对比表格</h4>
<p><strong>创建对比分析脚本：<code>monitor_comparison.sh</code></strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>

<span class="hljs-comment"># 系统监控工具对比分析脚本</span>

<span class="hljs-comment"># 颜色定义</span>
HEADER=<span class="hljs-string">'\033[1;35m'</span>
OK=<span class="hljs-string">'\033[0;32m'</span>
WARNING=<span class="hljs-string">'\033[1;33m'</span>
ERROR=<span class="hljs-string">'\033[0;31m'</span>
NC=<span class="hljs-string">'\033[0m'</span>

<span class="hljs-comment"># 检查工具是否安装</span>
<span class="hljs-function"><span class="hljs-title">check_tool</span></span>() {
    <span class="hljs-built_in">local</span> tool=<span class="hljs-variable">$1</span>
    <span class="hljs-keyword">if</span> <span class="hljs-built_in">command</span> -v <span class="hljs-variable">$tool</span> &amp;&gt; /dev/null; <span class="hljs-keyword">then</span>
        <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${OK}</span>✓ 已安装<span class="hljs-variable">${NC}</span>"</span>
        <span class="hljs-built_in">return</span> 0
    <span class="hljs-keyword">else</span>
        <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${ERROR}</span>✗ 未安装<span class="hljs-variable">${NC}</span>"</span>
        <span class="hljs-built_in">return</span> 1
    <span class="hljs-keyword">fi</span>
}

<span class="hljs-comment"># 性能测试函数</span>
<span class="hljs-function"><span class="hljs-title">performance_test</span></span>() {
    <span class="hljs-built_in">local</span> tool=<span class="hljs-variable">$1</span>
    <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${HEADER}</span>测试 <span class="hljs-variable">$tool</span> 启动性能...<span class="hljs-variable">${NC}</span>"</span>
    
    <span class="hljs-keyword">if</span> <span class="hljs-built_in">command</span> -v <span class="hljs-variable">$tool</span> &amp;&gt; /dev/null; <span class="hljs-keyword">then</span>
        <span class="hljs-built_in">local</span> start_time=$(<span class="hljs-built_in">date</span> +%s%N)
        <span class="hljs-variable">$tool</span> --version &gt; /dev/null 2&gt;&amp;1
        <span class="hljs-built_in">local</span> end_time=$(<span class="hljs-built_in">date</span> +%s%N)
        <span class="hljs-built_in">local</span> duration=$(( (end_time - start_time) / <span class="hljs-number">1000000</span> ))
        <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"启动时间: <span class="hljs-variable">${OK}</span><span class="hljs-variable">${duration}</span>ms<span class="hljs-variable">${NC}</span>"</span>
    <span class="hljs-keyword">else</span>
        <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${ERROR}</span>工具未安装<span class="hljs-variable">${NC}</span>"</span>
    <span class="hljs-keyword">fi</span>
}

<span class="hljs-comment"># 内存占用测试</span>
<span class="hljs-function"><span class="hljs-title">memory_test</span></span>() {
    <span class="hljs-built_in">local</span> tool=<span class="hljs-variable">$1</span>
    <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${HEADER}</span>测试 <span class="hljs-variable">$tool</span> 内存占用...<span class="hljs-variable">${NC}</span>"</span>
    
    <span class="hljs-keyword">if</span> <span class="hljs-built_in">command</span> -v <span class="hljs-variable">$tool</span> &amp;&gt; /dev/null; <span class="hljs-keyword">then</span>
        <span class="hljs-comment"># 启动工具并在后台运行</span>
        <span class="hljs-variable">$tool</span> &gt; /dev/null 2&gt;&amp;1 &amp;
        <span class="hljs-built_in">local</span> pid=$!
        <span class="hljs-built_in">sleep</span> 3
        
        <span class="hljs-comment"># 获取内存使用量</span>
        <span class="hljs-built_in">local</span> memory_usage=$(ps -o rss= -p <span class="hljs-variable">$pid</span> 2&gt;/dev/null | awk <span class="hljs-string">'{print $1/1024 " MB"}'</span>)
        
        <span class="hljs-comment"># 清理进程</span>
        <span class="hljs-built_in">kill</span> <span class="hljs-variable">$pid</span> 2&gt;/dev/null
        <span class="hljs-built_in">wait</span> <span class="hljs-variable">$pid</span> 2&gt;/dev/null
        
        <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"内存占用: <span class="hljs-variable">${OK}</span><span class="hljs-variable">${memory_usage}</span><span class="hljs-variable">${NC}</span>"</span>
    <span class="hljs-keyword">else</span>
        <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${ERROR}</span>工具未安装<span class="hljs-variable">${NC}</span>"</span>
    <span class="hljs-keyword">fi</span>
}

<span class="hljs-comment"># 功能对比</span>
<span class="hljs-function"><span class="hljs-title">feature_comparison</span></span>() {
    <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${HEADER}</span>=== 功能对比 ===<span class="hljs-variable">${NC}</span>"</span>
    <span class="hljs-built_in">printf</span> <span class="hljs-string">"%-15s | %-6s | %-6s | %-8s | %-10s | %-10s\n"</span> <span class="hljs-string">"功能"</span> <span class="hljs-string">"htop"</span> <span class="hljs-string">"glances"</span> <span class="hljs-string">"bpytop"</span> <span class="hljs-string">"top"</span> <span class="hljs-string">"gotop"</span>
    <span class="hljs-built_in">printf</span> <span class="hljs-string">"%-15s | %-6s | %-6s | %-8s | %-10s | %-10s\n"</span> <span class="hljs-string">"--------------"</span> <span class="hljs-string">"------"</span> <span class="hljs-string">"------"</span> <span class="hljs-string">"--------"</span> <span class="hljs-string">"----------"</span> <span class="hljs-string">"----------"</span>
    <span class="hljs-built_in">printf</span> <span class="hljs-string">"%-15s | %-6s | %-6s | %-8s | %-10s | %-10s\n"</span> <span class="hljs-string">"彩色界面"</span> <span class="hljs-string">"✓"</span> <span class="hljs-string">"✓"</span> <span class="hljs-string">"✓"</span> <span class="hljs-string">"✗"</span> <span class="hljs-string">"✓"</span>
    <span class="hljs-built_in">printf</span> <span class="hljs-string">"%-15s | %-6s | %-6s | %-8s | %-10s | %-10s\n"</span> <span class="hljs-string">"鼠标支持"</span> <span class="hljs-string">"✓"</span> <span class="hljs-string">"✓"</span> <span class="hljs-string">"✓"</span> <span class="hljs-string">"✗"</span> <span class="hljs-string">"✓"</span>
    <span class="hljs-built_in">printf</span> <span class="hljs-string">"%-15s | %-6s | %-6s | %-8s | %-10s | %-10s\n"</span> <span class="hljs-string">"树状视图"</span> <span class="hljs-string">"✓"</span> <span class="hljs-string">"✗"</span> <span class="hljs-string">"✓"</span> <span class="hljs-string">"✗"</span> <span class="hljs-string">"✗"</span>
    <span class="hljs-built_in">printf</span> <span class="hljs-string">"%-15s | %-6s | %-6s | %-8s | %-10s | %-10s\n"</span> <span class="hljs-string">"网络监控"</span> <span class="hljs-string">"✗"</span> <span class="hljs-string">"✓"</span> <span class="hljs-string">"✓"</span> <span class="hljs-string">"✗"</span> <span class="hljs-string">"✓"</span>
    <span class="hljs-built_in">printf</span> <span class="hljs-string">"%-15s | %-6s | %-6s | %-8s | %-10s | %-10s\n"</span> <span class="hljs-string">"磁盘IO"</span> <span class="hljs-string">"✗"</span> <span class="hljs-string">"✓"</span> <span class="hljs-string">"✓"</span> <span class="hljs-string">"✗"</span> <span class="hljs-string">"✓"</span>
    <span class="hljs-built_in">printf</span> <span class="hljs-string">"%-15s | %-6s | %-6s | %-8s | %-10s | %-10s\n"</span> <span class="hljs-string">"温度监控"</span> <span class="hljs-string">"✗"</span> <span class="hljs-string">"✓"</span> <span class="hljs-string">"✓"</span> <span class="hljs-string">"✗"</span> <span class="hljs-string">"✓"</span>
    <span class="hljs-built_in">printf</span> <span class="hljs-string">"%-15s | %-6s | %-6s | %-8s | %-10s | %-10s\n"</span> <span class="hljs-string">"Web界面"</span> <span class="hljs-string">"✗"</span> <span class="hljs-string">"✓"</span> <span class="hljs-string">"✗"</span> <span class="hljs-string">"✗"</span> <span class="hljs-string">"✗"</span>
    <span class="hljs-built_in">printf</span> <span class="hljs-string">"%-15s | %-6s | %-6s | %-8s | %-10s | %-10s\n"</span> <span class="hljs-string">"远程监控"</span> <span class="hljs-string">"✗"</span> <span class="hljs-string">"✓"</span> <span class="hljs-string">"✗"</span> <span class="hljs-string">"✗"</span> <span class="hljs-string">"✗"</span>
    <span class="hljs-built_in">printf</span> <span class="hljs-string">"%-15s | %-6s | %-6s | %-8s | %-10s | %-10s\n"</span> <span class="hljs-string">"主题定制"</span> <span class="hljs-string">"有限"</span> <span class="hljs-string">"有限"</span> <span class="hljs-string">"丰富"</span> <span class="hljs-string">"无"</span> <span class="hljs-string">"中等"</span>
}

<span class="hljs-comment"># 使用场景建议</span>
<span class="hljs-function"><span class="hljs-title">usage_scenarios</span></span>() {
    <span class="hljs-built_in">echo</span>
    <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${HEADER}</span>=== 使用场景建议 ===<span class="hljs-variable">${NC}</span>"</span>
    
    <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${OK}</span>htop - 传统进程管理<span class="hljs-variable">${NC}</span>"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"适用场景:"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"  • 进程管理和调试"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"  • 系统资源快速查看"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"  • 需要树状进程视图"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"  • 交互式进程操作"</span>
    
    <span class="hljs-built_in">echo</span>
    <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${OK}</span>glances - 全能系统监控<span class="hljs-variable">${NC}</span>"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"适用场景:"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"  • 多服务器监控"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"  • Web界面访问"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"  • 历史数据记录"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"  • 告警和通知"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"  • 远程系统监控"</span>
    
    <span class="hljs-built_in">echo</span>
    <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${OK}</span>bpytop - 现代化视觉监控<span class="hljs-variable">${NC}</span>"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"适用场景:"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"  • 本地系统详细监控"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"  • 视觉效果要求高"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"  • 需要详细的硬件监控"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"  • 主题定制需求"</span>
}

<span class="hljs-comment"># 安装状态检查</span>
<span class="hljs-function"><span class="hljs-title">check_installation</span></span>() {
    <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${HEADER}</span>=== 安装状态检查 ===<span class="hljs-variable">${NC}</span>"</span>
    <span class="hljs-built_in">echo</span> -n <span class="hljs-string">"htop:    "</span>; check_tool htop
    <span class="hljs-built_in">echo</span> -n <span class="hljs-string">"glances: "</span>; check_tool glances
    <span class="hljs-built_in">echo</span> -n <span class="hljs-string">"bpytop:  "</span>; check_tool bpytop
}

<span class="hljs-comment"># 性能对比</span>
<span class="hljs-function"><span class="hljs-title">performance_comparison</span></span>() {
    <span class="hljs-built_in">echo</span>
    <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${HEADER}</span>=== 性能对比 ===<span class="hljs-variable">${NC}</span>"</span>
    performance_test htop
    performance_test glances
    performance_test bpytop
}

<span class="hljs-comment"># 内存占用对比</span>
<span class="hljs-function"><span class="hljs-title">memory_comparison</span></span>() {
    <span class="hljs-built_in">echo</span>
    <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${HEADER}</span>=== 内存占用对比 ===<span class="hljs-variable">${NC}</span>"</span>
    memory_test htop
    memory_test glances
    memory_test bpytop
}

<span class="hljs-comment"># 推荐配置</span>
<span class="hljs-function"><span class="hljs-title">recommendation</span></span>() {
    <span class="hljs-built_in">echo</span>
    <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${HEADER}</span>=== 最终推荐 ===<span class="hljs-variable">${NC}</span>"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"根据功能、性能和易用性，推荐如下:"</span>
    <span class="hljs-built_in">echo</span>
    <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${OK}</span>🏆 最佳全能: glances<span class="hljs-variable">${NC}</span>"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"  理由: 功能最全面，支持远程监控和Web界面"</span>
    <span class="hljs-built_in">echo</span>
    <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${OK}</span>🎨 最佳视觉: bpytop<span class="hljs-variable">${NC}</span>"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"  理由: 界面最美观，信息展示最详细"</span>
    <span class="hljs-built_in">echo</span>
    <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${OK}</span>⚡ 最轻量级: htop<span class="hljs-variable">${NC}</span>"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"  理由: 启动最快，资源占用最低"</span>
}

<span class="hljs-comment"># 主函数</span>
<span class="hljs-function"><span class="hljs-title">main</span></span>() {
    <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${HEADER}</span>系统监控工具综合对比分析<span class="hljs-variable">${NC}</span>"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"=========================================="</span>
    
    check_installation
    feature_comparison
    performance_comparison
    memory_comparison
    usage_scenarios
    recommendation
}

<span class="hljs-comment"># 运行主函数</span>
main <span class="hljs-string">"<span class="hljs-variable">$@</span>"</span>
</code></pre>
<h3 data-id="heading-20">7. 总结</h3>
<p>通过本文的详细评测和实战脚本，我们可以看到三个工具各有特色：</p>
<ul>
<li><strong>htop</strong> 适合传统的进程管理和快速系统检查</li>
<li><strong>glances</strong> 适合需要全面监控和远程访问的场景</li>
<li><strong>bpytop</strong> 适合追求视觉效果和详细硬件监控的用户</li>
</ul>
<p>建议根据实际需求选择合适的工具，或者组合使用以获得最佳监控体验。所有提供的脚本都可以直接运行，帮助您快速搭建完整的系统监控环境。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JavaScript 中 this 指向问题]]></title>    <link>https://juejin.cn/post/7577298871003824162</link>    <guid>https://juejin.cn/post/7577298871003824162</guid>    <pubDate>2025-11-28T02:23:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577298871003824162" data-draft-id="7577203946062823464" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JavaScript 中 this 指向问题"/> <meta itemprop="keywords" content="JavaScript"/> <meta itemprop="datePublished" content="2025-11-28T02:23:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="uup"/> <meta itemprop="url" content="https://juejin.cn/user/4378706456356627"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JavaScript 中 this 指向问题
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4378706456356627/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    uup
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-28T02:23:40.000Z" title="Fri Nov 28 2025 02:23:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、Bug 场景</h2>
<p>在一个 JavaScript 的网页交互项目中，有一个构造函数定义了一个对象，该对象包含一个方法用于更新 DOM 元素的文本内容。同时，为了实现异步操作，在这个方法内部使用了 <code>setTimeout</code> 来模拟一些延迟任务。</p>
<h2 data-id="heading-1">二、代码示例</h2>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF - 8"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device - width, initial - scale = 1.0"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>this指向问题<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"target"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
        <span class="hljs-keyword">function</span> <span class="hljs-title function_">DOMUpdater</span>(<span class="hljs-params"/>) {
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">targetElement</span> = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'target'</span>);
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">updateText</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
                <span class="hljs-built_in">setTimeout</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
                    <span class="hljs-variable language_">this</span>.<span class="hljs-property">targetElement</span>.<span class="hljs-property">textContent</span> = <span class="hljs-string">'更新后的文本'</span>;
                }, <span class="hljs-number">1000</span>);
            };
        }

        <span class="hljs-keyword">const</span> updater = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DOMUpdater</span>();
        updater.<span class="hljs-title function_">updateText</span>();
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>

<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<h2 data-id="heading-2">三、问题描述</h2>
<ol>
<li><strong>预期行为</strong>：等待 1 秒后，<code>id</code> 为 <code>target</code> 的 <code>div</code> 元素的文本内容应更新为 “更新后的文本”。</li>
<li><strong>实际行为</strong>：在控制台中会报错 <code>Uncaught TypeError: Cannot set property 'textContent' of null</code>。这是因为在 <code>setTimeout</code> 内部的回调函数中，<code>this</code> 的指向发生了变化。在非严格模式下，<code>setTimeout</code> 回调函数中的 <code>this</code> 指向全局对象（在浏览器环境中是 <code>window</code>），而不是 <code>DOMUpdater</code> 实例对象。由于 <code>window</code> 中没有 <code>targetElement</code> 属性，所以会导致 <code>this.targetElement</code> 为 <code>null</code>，进而引发错误。</li>
</ol>
<h2 data-id="heading-3">四、解决方案</h2>
<ol>
<li><strong>使用箭头函数</strong>：箭头函数没有自己的 <code>this</code>，它的 <code>this</code> 继承自外层作用域，这样就可以保持 <code>this</code> 指向 <code>DOMUpdater</code> 实例对象。</li>
</ol>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF - 8"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device - width, initial - scale = 1.0"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>this指向问题 - 箭头函数解决<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"target"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
        <span class="hljs-keyword">function</span> <span class="hljs-title function_">DOMUpdater</span>(<span class="hljs-params"/>) {
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">targetElement</span> = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'target'</span>);
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">updateText</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
                <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
                    <span class="hljs-variable language_">this</span>.<span class="hljs-property">targetElement</span>.<span class="hljs-property">textContent</span> = <span class="hljs-string">'更新后的文本'</span>;
                }, <span class="hljs-number">1000</span>);
            };
        }

        <span class="hljs-keyword">const</span> updater = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DOMUpdater</span>();
        updater.<span class="hljs-title function_">updateText</span>();
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>

<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<ol start="2">
<li><strong>使用变量保存 this</strong>：在 <code>updateText</code> 方法内部，使用一个变量（通常命名为 <code>self</code> 或 <code>that</code>）来保存 <code>this</code> 的值，然后在 <code>setTimeout</code> 回调函数中使用这个变量。</li>
</ol>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF - 8"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device - width, initial - scale = 1.0"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>this指向问题 - 变量保存this解决<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"target"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
        <span class="hljs-keyword">function</span> <span class="hljs-title function_">DOMUpdater</span>(<span class="hljs-params"/>) {
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">targetElement</span> = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'target'</span>);
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">updateText</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
                <span class="hljs-keyword">const</span> self = <span class="hljs-variable language_">this</span>;
                <span class="hljs-built_in">setTimeout</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
                    self.<span class="hljs-property">targetElement</span>.<span class="hljs-property">textContent</span> = <span class="hljs-string">'更新后的文本'</span>;
                }, <span class="hljs-number">1000</span>);
            };
        }

        <span class="hljs-keyword">const</span> updater = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DOMUpdater</span>();
        updater.<span class="hljs-title function_">updateText</span>();
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>

<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<ol start="3">
<li><strong>使用 <code>bind</code> 方法</strong>：<code>bind</code> 方法可以创建一个新的函数，在这个新函数中，<code>this</code> 被绑定到指定的对象。</li>
</ol>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF - 8"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device - width, initial - scale = 1.0"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>this指向问题 - bind解决<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"target"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
        <span class="hljs-keyword">function</span> <span class="hljs-title function_">DOMUpdater</span>(<span class="hljs-params"/>) {
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">targetElement</span> = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'target'</span>);
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">updateText</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
                <span class="hljs-built_in">setTimeout</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
                    <span class="hljs-variable language_">this</span>.<span class="hljs-property">targetElement</span>.<span class="hljs-property">textContent</span> = <span class="hljs-string">'更新后的文本'</span>;
                }.<span class="hljs-title function_">bind</span>(<span class="hljs-variable language_">this</span>), <span class="hljs-number">1000</span>);
            };
        }

        <span class="hljs-keyword">const</span> updater = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DOMUpdater</span>();
        updater.<span class="hljs-title function_">updateText</span>();
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>

<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[手搓一个简简单单进度条]]></title>    <link>https://juejin.cn/post/7577294037716942882</link>    <guid>https://juejin.cn/post/7577294037716942882</guid>    <pubDate>2025-11-28T02:31:26.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577294037716942882" data-draft-id="7577284771446571048" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="手搓一个简简单单进度条"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-28T02:31:26.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="流星稍逝"/> <meta itemprop="url" content="https://juejin.cn/user/3707997273726007"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            手搓一个简简单单进度条
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3707997273726007/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    流星稍逝
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-28T02:31:26.000Z" title="Fri Nov 28 2025 02:31:26 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">懂得都懂就不细细解剖，直接上代码</h2>
<p>也就是太无聊，心血来潮搓一个小玩意儿</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/89ff9a1f430048f7ab39647a1b0991d6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rWB5pif56iN6YCd:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764901885&amp;x-signature=TVIWQ7gm8TPN63DT7YJ467XJ7sg%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/43f7d8468fed4a73b5a3fabcc7a92841~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rWB5pif56iN6YCd:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764901885&amp;x-signature=bI0t0ZSKbhdmS8ZLZ216qxBe7H0%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-1">div盒子</h3>
<pre><code class="hljs language-ini" lang="ini">&lt;div <span class="hljs-attr">class</span>=<span class="hljs-string">"progress-box"</span>&gt;
	&lt;div <span class="hljs-attr">class</span>=<span class="hljs-string">"progress-bar"</span> :style=<span class="hljs-string">"{ width: `${progress.width}%` }"</span>&gt;
	&lt;div <span class="hljs-attr">class</span>=<span class="hljs-string">"progress-bar-inner"</span>&gt;
		&lt;div <span class="hljs-attr">class</span>=<span class="hljs-string">"progress-light"</span>&gt;&lt;/div&gt;
	&lt;/div&gt;
	&lt;/div&gt;						&lt;/div&gt;
							&lt;div <span class="hljs-attr">class</span>=<span class="hljs-string">"progress-text"</span>&gt;
	&lt;span <span class="hljs-attr">class</span>=<span class="hljs-string">"num"</span> ref=<span class="hljs-string">"countDemo"</span>
	:<span class="hljs-attr">style</span>=<span class="hljs-string">"{ left: `calc(${progress.width}% - ${Amountspent &lt; 99 ? 66 :Amountspent &gt; 999 &amp;&amp; progress.width &lt; 50 ? 40 : 70}px)` }"</span>&gt;
	$ {{ Amountspent }}
	&lt;/span&gt;
							&lt;/div&gt;
</code></pre>
<h3 data-id="heading-2">js</h3>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
	<span class="hljs-keyword">import</span> { onMounted,ref } <span class="hljs-keyword">from</span> <span class="hljs-string">"vue"</span>
        <span class="hljs-comment">//进度条相关参数</span>
        <span class="hljs-keyword">const</span> progress = <span class="hljs-title function_">ref</span>({
		<span class="hljs-attr">width</span>: <span class="hljs-number">0</span>,
		<span class="hljs-attr">startValue</span>: <span class="hljs-number">0</span>,
		<span class="hljs-attr">endValue</span>: <span class="hljs-number">0</span>
	})
        <span class="hljs-keyword">const</span> <span class="hljs-title class_">Amountspent</span> = <span class="hljs-title function_">ref</span>(<span class="hljs-number">0</span>)
        	<span class="hljs-keyword">const</span> <span class="hljs-title function_">progressVal</span> = (<span class="hljs-params">start = <span class="hljs-number">0</span>, end = <span class="hljs-number">0</span></span>) =&gt; {
		<span class="hljs-keyword">const</span> startVal = <span class="hljs-title class_">Number</span>(start ?? <span class="hljs-number">0</span>) || <span class="hljs-number">0</span>
		<span class="hljs-keyword">const</span> endVal = <span class="hljs-title class_">Number</span>(end ?? <span class="hljs-number">0</span>) || <span class="hljs-number">0</span>
		<span class="hljs-keyword">return</span> {
			<span class="hljs-attr">width</span>: endVal &gt; <span class="hljs-number">0</span> ? <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>((startVal / endVal) * <span class="hljs-number">100</span>, <span class="hljs-number">0</span>), <span class="hljs-number">100</span>).<span class="hljs-title function_">toFixed</span>(<span class="hljs-number">2</span>) : <span class="hljs-number">0</span>,
			<span class="hljs-attr">startValue</span>: startVal,
			<span class="hljs-attr">endValue</span>: endVal
		}
	}
        
        	<span class="hljs-title function_">onMounted</span>(<span class="hljs-function">() =&gt;</span> {
                <span class="hljs-comment">//接口请求获取参数</span>
		<span class="hljs-title function_">getprogressInfo</span>({}, <span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {
			<span class="hljs-keyword">if</span> (!res) <span class="hljs-keyword">return</span>

			<span class="hljs-keyword">if</span> (res &amp;&amp; res.<span class="hljs-property">data</span>) {
<span class="hljs-keyword">let</span> { totaAmount, amountspent } = res.<span class="hljs-property">data</span>
<span class="hljs-title class_">Amountspent</span>.<span class="hljs-property">value</span>=amountspent?<span class="hljs-attr">amountspent</span>:<span class="hljs-number">0</span>
	progress.<span class="hljs-property">value</span> = <span class="hljs-title function_">progressVal</span>(amountspent, totaAmount)<span class="hljs-comment">//进度条</span>


			}

		})

	})
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<h3 data-id="heading-3">css</h3>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"scss"</span>&gt;</span><span class="css">
<span class="hljs-selector-class">.progress-box</span> {
			<span class="hljs-attribute">position</span>: relative;
			<span class="hljs-attribute">border-radius</span>: <span class="hljs-number">500px</span>;
			<span class="hljs-attribute">background</span>: <span class="hljs-built_in">rgba</span>(<span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">0.05</span>);
			<span class="hljs-attribute">padding</span>: <span class="hljs-number">2px</span>;
			<span class="hljs-attribute">height</span>: <span class="hljs-number">10px</span>;
			<span class="hljs-attribute">margin-bottom</span>: <span class="hljs-number">7px</span>;

			<span class="hljs-selector-class">.progress-value</span> {
				<span class="hljs-attribute">position</span>: absolute;
				<span class="hljs-attribute">left</span>: <span class="hljs-number">50%</span>;
				<span class="hljs-attribute">top</span>: <span class="hljs-number">50%</span>;
				<span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translate</span>(-<span class="hljs-number">50%</span>, -<span class="hljs-number">50%</span>);
				<span class="hljs-attribute">color</span>: <span class="hljs-number">#fff</span>;
				<span class="hljs-attribute">text-align</span>: center;
				<span class="hljs-attribute">font-size</span>: <span class="hljs-number">12px</span>;
				<span class="hljs-attribute">font-weight</span>: <span class="hljs-number">800</span>;
				<span class="hljs-attribute">line-height</span>: <span class="hljs-number">1</span>;
				<span class="hljs-attribute">text-shadow</span>: <span class="hljs-number">0</span> <span class="hljs-number">2px</span> <span class="hljs-number">0</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0.1</span>);
			}

			<span class="hljs-selector-class">.progress-bar</span> {
				<span class="hljs-attribute">height</span>: <span class="hljs-number">100%</span>;
				<span class="hljs-attribute">width</span>: <span class="hljs-number">0</span>;
				<span class="hljs-attribute">border-radius</span>: <span class="hljs-number">500px</span>;
				<span class="hljs-attribute">background</span>: <span class="hljs-number">#20ce2e</span>;
				<span class="hljs-attribute">position</span>: relative;
				<span class="hljs-attribute">box-shadow</span>:
					<span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">3px</span> <span class="hljs-number">0</span> <span class="hljs-number">#00ff9d</span> inset,
					<span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">7.5px</span> <span class="hljs-number">0</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">32</span>, <span class="hljs-number">206</span>, <span class="hljs-number">46</span>, <span class="hljs-number">0.6</span>);

				<span class="hljs-selector-class">.progress-bar-inner</span> {
					<span class="hljs-attribute">position</span>: absolute;
					<span class="hljs-attribute">right</span>: -<span class="hljs-number">11px</span>;
					<span class="hljs-attribute">top</span>: -<span class="hljs-number">11px</span>;
				}

				<span class="hljs-selector-class">.progress-light</span> {
					<span class="hljs-attribute">width</span>: <span class="hljs-number">30px</span>;
					<span class="hljs-attribute">height</span>: <span class="hljs-number">30px</span>;
					<span class="hljs-attribute">position</span>: relative;
					<span class="hljs-attribute">border-radius</span>: <span class="hljs-number">50%</span>;
					<span class="hljs-attribute">background-color</span>: <span class="hljs-built_in">rgba</span>(<span class="hljs-number">205</span>, <span class="hljs-number">222</span>, <span class="hljs-number">221</span>, <span class="hljs-number">0.1</span>);

					&amp;<span class="hljs-selector-pseudo">::before</span> {
						<span class="hljs-attribute">content</span>: <span class="hljs-string">""</span>;
						<span class="hljs-attribute">position</span>: absolute;
						<span class="hljs-attribute">top</span>: <span class="hljs-number">50%</span>;
						<span class="hljs-attribute">left</span>: <span class="hljs-number">50%</span>;
						<span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translate</span>(-<span class="hljs-number">50%</span>, -<span class="hljs-number">50%</span>);
						<span class="hljs-attribute">width</span>: <span class="hljs-number">18px</span>;
						<span class="hljs-attribute">height</span>: <span class="hljs-number">18px</span>;
						<span class="hljs-attribute">border-radius</span>: <span class="hljs-number">50%</span>;
						<span class="hljs-attribute">background-color</span>: <span class="hljs-built_in">rgba</span>(<span class="hljs-number">205</span>, <span class="hljs-number">222</span>, <span class="hljs-number">221</span>, <span class="hljs-number">0.1</span>);
					}

					&amp;<span class="hljs-selector-pseudo">::after</span> {
						<span class="hljs-attribute">content</span>: <span class="hljs-string">""</span>;
						<span class="hljs-attribute">position</span>: absolute;
						<span class="hljs-attribute">top</span>: <span class="hljs-number">50%</span>;
						<span class="hljs-attribute">left</span>: <span class="hljs-number">50%</span>;
						<span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translate</span>(-<span class="hljs-number">50%</span>, -<span class="hljs-number">50%</span>);
						<span class="hljs-attribute">width</span>: <span class="hljs-number">10px</span>;
						<span class="hljs-attribute">height</span>: <span class="hljs-number">10px</span>;
						<span class="hljs-attribute">border-radius</span>: <span class="hljs-number">50%</span>;
						<span class="hljs-attribute">background-color</span>: <span class="hljs-number">#e7fefd</span>;
					}
				}
			}
		}
                
                
		<span class="hljs-selector-class">.progress-text</span> {
			<span class="hljs-attribute">position</span>: relative;
			<span class="hljs-comment">/* padding: 2px; */</span>
			<span class="hljs-attribute">height</span>: <span class="hljs-number">10px</span>;
			<span class="hljs-attribute">margin-bottom</span>: <span class="hljs-number">10px</span>;
			<span class="hljs-attribute">margin-right</span>: <span class="hljs-number">14px</span>;

			<span class="hljs-selector-class">.num</span> {
				<span class="hljs-attribute">font-weight</span>: <span class="hljs-number">800</span>;
				<span class="hljs-attribute">font-style</span>: ExtraBold;
				<span class="hljs-attribute">font-size</span>: <span class="hljs-number">12px</span>;
				<span class="hljs-attribute">line-height</span>: <span class="hljs-number">1.5</span>;
				<span class="hljs-attribute">position</span>: absolute;
				<span class="hljs-attribute">color</span>: <span class="hljs-built_in">rgba</span>(<span class="hljs-number">172</span>, <span class="hljs-number">188</span>, <span class="hljs-number">208</span>, <span class="hljs-number">1</span>);
				<span class="hljs-attribute">width</span>: <span class="hljs-number">80px</span>;
				<span class="hljs-attribute">display</span>: inline-block;
				<span class="hljs-attribute">text-align</span>: right;
			}
		}
</span></code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JavaScript 词法作用域、作用域链与闭包：从代码看机制]]></title>    <link>https://juejin.cn/post/7577295460248944686</link>    <guid>https://juejin.cn/post/7577295460248944686</guid>    <pubDate>2025-11-28T02:35:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577295460248944686" data-draft-id="7577300470520299529" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JavaScript 词法作用域、作用域链与闭包：从代码看机制"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2025-11-28T02:35:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ohyeah"/> <meta itemprop="url" content="https://juejin.cn/user/740446536480618"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JavaScript 词法作用域、作用域链与闭包：从代码看机制
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/740446536480618/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ohyeah
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-28T02:35:24.000Z" title="Fri Nov 28 2025 02:35:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在学习 JavaScript 的过程中，<strong>作用域</strong> 是一个绕不开的核心概念。很多人一开始会误以为“变量在哪调用，就在哪找”，但其实 JS 的作用域是 <strong>词法作用域（Lexical Scoping）</strong> ，也就是说，函数的作用域由它<strong>定义的位置</strong>决定，而不是调用位置。今天我们就通过几段简单的代码和图解，来深入浅出地理解 JavaScript 中的 <strong>词法作用域、作用域链 和 闭包</strong> 这三个重要机制。</p>
<hr/>
<h2 data-id="heading-0">一、什么是执行上下文？调用栈是如何工作的？</h2>
<p>在 JavaScript 中，每当一个函数被调用时，都会创建一个「执行上下文」（Execution Context），并压入调用栈（Call Stack）。这个执行上下文包含两个关键部分：</p>
<ul>
<li><strong>变量环境（Variable Environment）</strong> ：存储用 <code>var</code> 声明的变量和函数声明。</li>
<li><strong>词法环境（Lexical Environment）</strong> ：存储用 <code>let</code>、<code>const</code> 声明的块级作用域变量。</li>
</ul>
<p>此外，每个执行上下文的词法环境中还有一个特殊的属性：<code>outer</code>，它指向该函数<strong>定义时所在的作用域</strong>的词法环境。</p>
<blockquote>
<p>✅ 简单说：<strong><code>outer</code> 指针决定了作用域查找路径，即“作用域链”</strong></p>
</blockquote>
<p>我们来看第一个例子（1.js）：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">bar</span>(<span class="hljs-params"/>){
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(myName)
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">foo</span>(<span class="hljs-params"/>){
  <span class="hljs-keyword">var</span> myName = <span class="hljs-string">'极客邦'</span>
  <span class="hljs-title function_">bar</span>()
}

<span class="hljs-keyword">var</span> myName = <span class="hljs-string">'极客时间'</span>
<span class="hljs-title function_">foo</span>() <span class="hljs-comment">// 输出: 极客时间</span>
</code></pre>
<h3 data-id="heading-1">🤔 为什么输出的是 “极客时间” 而不是 “极客邦”？</h3>
<p>很多人会误以为：<code>bar()</code> 是在 <code>foo()</code> 内部调用的，那它应该能访问到 <code>foo()</code> 里的 <code>myName</code>。但实际上，<strong><code>bar()</code> 是在全局定义的</strong>，所以它的 <code>outer</code> 指向的是全局的词法环境。</p>
<p>当 <code>bar()</code> 执行时，它先在自己的词法环境中找 <code>myName</code>，没有；然后顺着 <code>outer</code> 指针去全局词法环境查找，找到了 <code>var myName = '极客时间'</code>，于是打印出来。</p>
<p>👉 <strong>结论</strong>：作用域是由函数定义的位置决定的，而不是调用位置。这就是 <strong>词法作用域</strong> 的核心思想。</p>
<hr/>
<h2 data-id="heading-2">二、作用域链：查找变量的“路径”</h2>
<p>作用域链就是由一个个执行上下文的 <code>outer</code> 指针串联而成的链条。我们可以通过以下代码进一步理解（2.js）：</p>
<pre><code class="hljs language-ini" lang="ini">function bar(){
  var <span class="hljs-attr">myName</span> = <span class="hljs-string">'极客世界'</span>
  let <span class="hljs-attr">test1</span> = <span class="hljs-number">100</span>
  if(1){
    let <span class="hljs-attr">myName</span> = <span class="hljs-string">'Chrome 浏览器'</span>
    console.log(test) // ❌ 报错：test is not defined
  }
}

function foo(){
  var <span class="hljs-attr">myName</span> = <span class="hljs-string">'极客邦'</span>
  let <span class="hljs-attr">test</span> = <span class="hljs-number">2</span>
  {
    let <span class="hljs-attr">test</span> = <span class="hljs-number">3</span>
    bar()
  }
}

var <span class="hljs-attr">myName</span> = <span class="hljs-string">'极客时间'</span>

let <span class="hljs-attr">myAge</span> = <span class="hljs-number">10</span>

let <span class="hljs-attr">test</span> = <span class="hljs-number">1</span>

foo()
</code></pre>
<p>这段代码中，<code>bar()</code> 函数内部试图打印 <code>test</code>，但它找不到。</p>
<h3 data-id="heading-3">🔍 查找过程如下：</h3>
<ol>
<li>在 <code>bar()</code> 的词法环境中找 <code>test</code> → 没有；</li>
<li>到 <code>bar()</code> 的 <code>outer</code> 指向的词法环境（全局）找 → 全局有 <code>let test = 1</code>，但注意！<code>bar()</code> 是在全局定义的，所以它只能访问全局的 <code>test</code>；</li>
<li>但是 <code>bar()</code> 执行时，<code>test</code> 被重新赋值了吗？<strong>没有</strong>，因为 <code>bar()</code> 并不在 <code>foo()</code> 内部定义，所以它不会继承 <code>foo()</code> 的作用域。</li>
</ol>
<p>因此，<code>console.log(test)</code> 实际上是在全局查找 <code>test</code>，结果是 <code>1</code>。</p>
<blockquote>
<p>⚠️ 注意：<code>bar()</code> 无法访问 <code>foo()</code> 中的 <code>test</code>，即使它是从 <code>foo()</code> 中调用的。这再次证明了：<strong>JS 是词法作用域，不是动态作用域</strong>。</p>
</blockquote>
<p>我们可以结合下面这张图来理解调用栈和作用域链的关系：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ac579f326349437b8ac9c13bac710378~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgb2h5ZWFo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764902124&amp;x-signature=j5QFqJccMbzELegcl2WuF6rJ4KM%3D" alt="lQLPKHIJLY1ZLgPNAnrNBHawi45ov3eSr18JAvLiVN8GAA_1142_634.png" loading="lazy"/></p>
<ul>
<li><code>bar()</code> 的执行上下文在栈顶；</li>
<li>它的 <code>outer</code> 指向全局；</li>
<li>因此查找 <code>test</code> 时，直接跳到了全局词法环境。</li>
</ul>
<hr/>
<h2 data-id="heading-4">三、闭包：函数的“专属背包”</h2>
<p>接下来是最有意思的——<strong>闭包</strong>（Closure）。</p>
<p>闭包的本质是：<strong>一个函数能够访问并记住其外部函数的变量，即使外部函数已经执行完毕</strong>。</p>
<p>我们来看第三个例子（3.js）：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">foo</span>(<span class="hljs-params"/>){
  <span class="hljs-keyword">var</span> myName = <span class="hljs-string">'极客时间'</span>
  <span class="hljs-keyword">let</span> test1 = <span class="hljs-number">1</span>
  <span class="hljs-keyword">const</span> test2 = <span class="hljs-number">2</span>
  <span class="hljs-keyword">var</span> innerBar = {
    <span class="hljs-attr">getName</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"/>){
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(test1)
      <span class="hljs-keyword">return</span> myName
    },
    <span class="hljs-attr">setName</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params">newName</span>){
      myName = newName
    }
  }
  <span class="hljs-keyword">return</span> innerBar
}

<span class="hljs-keyword">var</span> bar = <span class="hljs-title function_">foo</span>() <span class="hljs-comment">// foo 执行完毕，出栈</span>
<span class="hljs-comment">//它已经出栈了 那bar里面的变量应该回收吧?</span>
<span class="hljs-comment">//代码的执行证明 它不会回收</span>
<span class="hljs-comment">//foo函数确实是出栈了 但是getName/setName还需要foo()函数里面的变量 所以它会'打个包' (如果一个变量被引用的话 那么它们就不能顺利的进行垃圾回收)</span>
bar.<span class="hljs-title function_">setName</span>(<span class="hljs-string">'极客邦'</span>)
bar.<span class="hljs-title function_">getName</span>() <span class="hljs-comment">// 输出: 极客邦</span>
</code></pre>
<h3 data-id="heading-5">🤯 为什么 <code>foo()</code> 已经出栈了，还能修改和读取里面的变量？</h3>
<p>因为在 <code>foo()</code> 返回 <code>innerBar</code> 对象时，<code>getName</code> 和 <code>setName</code> 这两个方法都引用了 <code>foo()</code> 内部的变量 <code>myName</code> 和 <code>test1</code>。V8 引擎发现这些变量被“外部引用”了，就不会回收它们。</p>
<p>于是，<code>foo()</code> 的执行上下文虽然出栈了，但它的 <strong>词法环境被保留了下来</strong>，形成了一个“闭包”。</p>
<blockquote>
<p>💡 这个被保留下来的词法环境，就是闭包本身。而其中被引用的变量，叫做 <strong>自由变量</strong>。</p>
</blockquote>
<p>我们再看一张图：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6eaa0b6bc6a14e8db4b06e9f3f695dec~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgb2h5ZWFo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764902124&amp;x-signature=zsoyuqBigqrslxBz1fmsXP2ysi0%3D" alt="536a315a83aa48b870d03dd921b6c02a.png" loading="lazy"/></p>
<ul>
<li><code>setName</code> 执行时，它的 <code>outer</code> 指向 <code>foo()</code> 的词法环境；</li>
<li>即使 <code>foo()</code> 已经执行结束，这个环境依然存在；</li>
<li>所以 <code>myName</code> 可以被修改为 <code>'极客邦'</code>；</li>
<li>后续调用 <code>getName()</code> 时，依然能拿到更新后的值。</li>
</ul>
<blockquote>
<p>✅ 闭包的形成条件：</p>
<ol>
<li>函数嵌套函数；</li>
<li>内部函数被返回或暴露到外部；</li>
<li>内部函数引用了外部函数的变量。</li>
</ol>
</blockquote>
<hr/>
<h2 data-id="heading-6">四、闭包的生命周期：什么时候释放？</h2>
<p>闭包并不会一直占用内存。只有当外部仍然持有对闭包函数的引用时，闭包才会被保留。</p>
<p>比如：</p>
<pre><code class="hljs language-ini" lang="ini">var <span class="hljs-attr">bar</span> = foo()
<span class="hljs-attr">bar</span> = null // 此时，bar 不再引用 innerBar，闭包可以被垃圾回收
</code></pre>
<p>一旦 <code>bar</code> 被置为 <code>null</code>，<code>getName</code> 和 <code>setName</code> 就不再被引用，V8 引擎就会回收 <code>foo()</code> 的词法环境，释放内存。</p>
<blockquote>
<p>🔒 闭包是一种“记忆”机制，但也会带来内存泄漏的风险。使用完后记得释放引用！</p>
</blockquote>
<hr/>
<h2 data-id="heading-7">五、总结：词法作用域 vs 动态作用域</h2>

























<table><thead><tr><th>特性</th><th>词法作用域（JavaScript）</th><th>动态作用域</th></tr></thead><tbody><tr><td>查找依据</td><td>函数定义的位置</td><td>函数调用的位置</td></tr><tr><td>是否依赖调用栈顺序</td><td>否</td><td>是</td></tr><tr><td>示例语言</td><td>JavaScript、Python、C++</td><td>Bash、一些脚本语言</td></tr></tbody></table>
<p>JavaScript 是典型的词法作用域语言，这意味着：</p>
<ul>
<li>函数的 <code>outer</code> 指针在编译阶段就确定；</li>
<li>不管你在哪调用，只要函数定义在全局，它的 <code>outer</code> 就指向全局；</li>
<li>闭包的存在正是基于这种静态作用域的特性。</li>
</ul>
<hr/>
<h2 data-id="heading-8">六、常见误区澄清</h2>
<h3 data-id="heading-9">❌ 误区一：“在哪个函数里调用，就查哪个函数的作用域”</h3>
<p>这是动态作用域的思维。JavaScript 不是这样工作的。</p>
<p>✅ 正确做法：看函数<strong>定义在哪</strong>，<code>outer</code> 指向哪里，就从哪里开始查。</p>
<h3 data-id="heading-10">❌ 误区二：“函数执行完，里面的变量就没了”</h3>
<p>不一定！如果函数返回了一个引用了内部变量的函数，那么这些变量会被保留，形成闭包。</p>
<h3 data-id="heading-11">❌ 误区三：“闭包就是匿名函数”</h3>
<p>不对。闭包是一种现象，不一定是匿名函数。只要满足条件，任何函数都可以形成闭包。</p>
<hr/>
<h2 data-id="heading-12">七、图解回顾</h2>
<p>我们再来快速回顾一下几张关键图：</p>
<h3 data-id="heading-13">图1：<code>bar()</code> 调用时的作用域链</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/780942116c6e45f08f43f429c59ac1d0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgb2h5ZWFo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764902124&amp;x-signature=dFDDA9fKhmHiA5CBvKIbnariWYU%3D" alt="lQLPKHIJLY1ZLgPNAnrNBHawi45ov3eSr18JAvLiVN8GAA_1142_634.png" loading="lazy"/></p>
<ul>
<li><code>bar()</code> 的 <code>outer</code> 指向全局；</li>
<li>查找 <code>test</code> 时，从全局找到 <code>test = 1</code>。</li>
</ul>
<h3 data-id="heading-14">图2：<code>foo()</code> 执行时的执行上下文</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/da2492f4a9984d509e7868b2d7cc1794~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgb2h5ZWFo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764902124&amp;x-signature=PdgKf4vtGaQ7%2FgrIAe0qdNkOMjc%3D" alt="d70143c661ed9c209cdc5991f27fcab9.png" loading="lazy"/></p>
<ul>
<li><code>foo()</code> 的词法环境包含 <code>test1</code>, <code>test2</code>；</li>
<li>变量环境包含 <code>myName</code>, <code>innerBar</code>。</li>
</ul>
<h3 data-id="heading-15">图3：闭包生效时的状态</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/912692a924774641856e48141584dc07~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgb2h5ZWFo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764902124&amp;x-signature=zOaeO1mSWMKqBXsrocM6qePzt4o%3D" alt="lQLPJwCC0KWlAbPNA03NBHawINj2y-qMdT0JAv8hJbJKAA_1142_845.png" loading="lazy"/></p>
<ul>
<li><code>setName</code> 执行时，<code>outer</code> 指向 <code>foo()</code> 的词法环境；</li>
<li>即使 <code>foo()</code> 已出栈，数据依然可访问。</li>
</ul>
<hr/>
<h2 data-id="heading-16">八、写在最后</h2>
<p>JavaScript 的作用域机制看似复杂，但只要抓住一个核心：<strong>词法作用域 + outer 指针 + 闭包</strong>，就能轻松应对大多数场景。</p>
<p>记住一句话：</p>
<blockquote>
<p><strong>函数的作用域由它定义的位置决定，而不是调用的位置。</strong></p>
</blockquote>
<p>当你看到一个函数在别处被调用时，不要慌，先问一句：“它是在哪定义的？” 然后顺着 <code>outer</code> 指针去找，一切就清晰了。</p>
<p>闭包虽然强大，但也需要谨慎使用，避免不必要的内存占用。</p>
<p>希望这篇文章能帮你理清思路，下次遇到作用域问题时，不再迷茫！</p>
<hr/>
<p>📌 <strong>附注</strong>：本文所用代码和图解均来自个人学习笔记，图片仅为示意，实际运行时请自行验证逻辑。欢迎在评论区交流你的理解！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[2025 年最新 Fabric.js 实战：一个完整可上线的图片选区标注组件（含全部源码）.]]></title>    <link>https://juejin.cn/post/7577256255083659273</link>    <guid>https://juejin.cn/post/7577256255083659273</guid>    <pubDate>2025-11-28T02:34:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577256255083659273" data-draft-id="7577313637950504969" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="2025 年最新 Fabric.js 实战：一个完整可上线的图片选区标注组件（含全部源码）."/> <meta itemprop="keywords" content="前端,Vue.js"/> <meta itemprop="datePublished" content="2025-11-28T02:34:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小章鱼学前端"/> <meta itemprop="url" content="https://juejin.cn/user/2588705981734765"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            2025 年最新 Fabric.js 实战：一个完整可上线的图片选区标注组件（含全部源码）.
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2588705981734765/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小章鱼学前端
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-28T02:34:15.000Z" title="Fri Nov 28 2025 02:34:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d08a5e5789e84471add9938048f42e03~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP56ug6bG85a2m5YmN56uv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764902190&amp;x-signature=Dl%2FkLNt2MHTiPLOZ8fqNkzYfZ2U%3D" alt="" loading="lazy"/></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 从 0 到 1 用最新 Fabric.js 实现：背景图 + 手动画矩形 + 坐标 + 删除 + 高清截图导出（2025 最新版）</span>
</code></pre>
<p>最近项目要做一个「图片自动化清洗工具」，核心需求如下（产品甩给我的原话）：</p>
<ol>
<li>支持上传任意尺寸的广告图</li>
<li>运营要在图上框出需要保留的区域（可画多个矩形）</li>
<li>框出来的区域右上角必须有 × 可以删除</li>
<li>实时显示鼠标在原图上的精确坐标</li>
<li>最后要能把每个选区裁成独立图片 + 导出坐标数据给后端</li>
<li>必须有一键清空功能</li>
</ol>
<p><code>我调研了 Konva、PixiJS、ZRender，最终还是选择了最成熟、最好用的 **Fabric.js**，并且使用最新版 v6.7.1+ 完美实现！</code></p>
<p>本文所有代码基于 <strong>Fabric.js 6.7+</strong>，完全适配 Vue3/React/原生JS，已在生产环境稳定运行。</p>
<h2 data-id="heading-0">一、Fabric.js 官网 &amp; 安装方式（2025 最新）</h2>
<ul>
<li>
<p>官网：<a href="https://link.juejin.cn?target=http%3A%2F%2Ffabricjs.com" target="_blank" title="http://fabricjs.com" ref="nofollow noopener noreferrer">fabricjs.com</a></p>
</li>
<li>
<p>GitHub：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ffabricjs%2Ffabric.js" target="_blank" title="https://github.com/fabricjs/fabric.js" ref="nofollow noopener noreferrer">github.com/fabricjs/fa…</a></p>
</li>
<li>
<p>当前最新版本：<strong>6.7.x</strong>（2025年11月）</p>
</li>
</ul>
<h2 data-id="heading-1">二、bash</h2>
<pre><code class="hljs language-css" lang="css">npm install fabric<span class="hljs-keyword">@latest</span>
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c48db06a01eb43fcb59ba3e2d199e038~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP56ug6bG85a2m5YmN56uv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764902190&amp;x-signature=E7wmeyGyC55uaIiEGk2Pj%2BcU%2FCs%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-2">三、创建画布 &amp; 初始化 CanvasManager 类</h2>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">canvas</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"canvasEl"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"canvas"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">canvas</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
</code></pre>

<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// CanvasManager.js</span>
<span class="hljs-keyword">import</span> { Canvas, FabricImage, Rect, Control } from <span class="hljs-string">"fabric"</span>;

export <span class="hljs-keyword">class</span> <span class="hljs-title class_">CanvasManager</span> {
  <span class="hljs-keyword">constructor</span>(canvasEl, options = {}) {
    <span class="hljs-keyword">this</span>.canvas = new Canvas(canvasEl, {
      width: canvasEl.clientWidth || <span class="hljs-number">1000</span>,
      height: canvasEl.clientHeight ||  || <span class="hljs-number">700</span>,
      backgroundColor: <span class="hljs-string">"#f5f5f5"</span>,
      selection: <span class="hljs-literal">false</span>,           <span class="hljs-comment">// 全局禁止多选框（我们自己控制选中态）</span>
      preserveObjectStacking: <span class="hljs-literal">true</span>,
    });

    <span class="hljs-comment">// 回调函数，用于通知外部（如 Pinia/Vuex）矩形增删改</span>
    <span class="hljs-keyword">this</span>.onRectangleAdded   = options.onRectangleAdded;
    <span class="hljs-keyword">this</span>.onRectangleUpdated  = options.onRectangleUpdated;
    <span class="hljs-keyword">this</span>.onRectangleDeleted  = options.onRectangleDeleted;

    <span class="hljs-keyword">this</span>.isDrawing = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">this</span>.startX = <span class="hljs-keyword">this</span>.startY = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">this</span>.currentRect = <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">this</span>.rectangles = [];         <span class="hljs-comment">// 所有已完成的矩形</span>
    <span class="hljs-keyword">this</span>.originalImageWidth = <span class="hljs-keyword">this</span>.originalImageHeight = <span class="hljs-number">0</span>;

    <span class="hljs-keyword">this</span>.initEvents();
  }

  initEvents() {
    <span class="hljs-keyword">this</span>.canvas.on(<span class="hljs-string">"mouse:down"</span>, <span class="hljs-keyword">this</span>.handleMouseDown.bind(<span class="hljs-keyword">this</span>));
    <span class="hljs-keyword">this</span>.canvas.on(<span class="hljs-string">"mouse:move"</span>, <span class="hljs-keyword">this</span>.handleMouseMove.bind(<span class="hljs-keyword">this</span>));
    <span class="hljs-keyword">this</span>.canvas.on(<span class="hljs-string">"mouse:up"</span>,   <span class="hljs-keyword">this</span>.handleMouseUp.bind(<span class="hljs-keyword">this</span>));
  }
}
</code></pre>
<h2 data-id="heading-3">四、上传背景图 + 完美适配画布（支持 5000×5000 大图不卡）</h2>
<blockquote>
<p>FabricImage 设置canvas画布背景</p>
</blockquote>
<pre><code class="hljs language-xml" lang="xml">
<span class="hljs-comment">&lt;!-- 上传按钮（Ant Design Vue） --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">input</span>
  <span class="hljs-attr">type</span>=<span class="hljs-string">"file"</span>
  <span class="hljs-attr">ref</span>=<span class="hljs-string">"fileInput"</span>
  @<span class="hljs-attr">change</span>=<span class="hljs-string">"handleFileUpload"</span>
  <span class="hljs-attr">accept</span>=<span class="hljs-string">"image/*"</span>
  <span class="hljs-attr">style</span>=<span class="hljs-string">"display: none"</span>
/&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">a-button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"primary"</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"$refs.fileInput.click()"</span>&gt;</span>
  上传图片
<span class="hljs-tag">&lt;/<span class="hljs-name">a-button</span>&gt;</span>
      
     
</code></pre>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 设置背景图（核心方法）</span>
<span class="hljs-function">async <span class="hljs-title">setBackground</span><span class="hljs-params">(source)</span> </span>{
  <span class="hljs-keyword">try</span> {
    <span class="hljs-type">const</span> img = await FabricImage.<span class="hljs-built_in">fromURL</span>(source, { crossOrigin: <span class="hljs-string">"anonymous"</span> });

    <span class="hljs-comment">// 保存原始尺寸（后面导出坐标要用）</span>
    <span class="hljs-keyword">this</span>.originalImageWidth  = img.width;
    <span class="hljs-keyword">this</span>.originalImageHeight = img.height;

    <span class="hljs-comment">// 等比缩放至画布宽度（也可改成 scaleToHeight）</span>
    img.<span class="hljs-built_in">scaleToWidth</span>(<span class="hljs-keyword">this</span>.canvas.<span class="hljs-built_in">getWidth</span>());

    <span class="hljs-keyword">this</span>.canvas.<span class="hljs-built_in">setBackgroundImage</span>(img, () =&gt; {
      <span class="hljs-keyword">this</span>.canvas.<span class="hljs-built_in">requestRenderAll</span>();
    });

    <span class="hljs-keyword">return</span> {
      originalSize: { width: img.width, height: img.height },
      scaledSize: { width: img.<span class="hljs-built_in">getScaledWidth</span>(), height: img.<span class="hljs-built_in">getScaledHeight</span>() },
      scaleX: img.scaleX,
      scaleY: img.scaleY,
    };
  } <span class="hljs-built_in">catch</span> (err) {
    console.<span class="hljs-built_in">error</span>(<span class="hljs-string">"背景图加载失败"</span>, err);
    <span class="hljs-keyword">throw</span> err;
  }
}
</code></pre>
<h2 data-id="heading-4">五、手动画矩形 + 右上角删除按钮（最丝滑写法）</h2>
<blockquote>
<p>在图片标注类工具中，“按住鼠标拖拽绘制矩形选区 + 右上角一键删除”是核心交互体验。本方案基于 Fabric.js v6.7+ 官方推荐的事件机制与自定义 Control 体系，实现了一套<strong>高可维护性、视觉统</strong></p>
</blockquote>
<h5 data-id="heading-5">绘制矩形区域</h5>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 开始绘制矩形选区（鼠标按下时触发）</span>
startDrawing(opt) {
  <span class="hljs-comment">// 获取当前鼠标在画布上的精确坐标（已自动处理缩放、平移、滚动偏移）</span>
  <span class="hljs-comment">// getPointer 是 Fabric.js 官方推荐方法，比 e.layerX/e.offsetX 更准确</span>
  <span class="hljs-keyword">const</span> pointer = <span class="hljs-keyword">this</span>.canvas.getPointer(opt.e);

  <span class="hljs-keyword">this</span>.startX = pointer.x;<span class="hljs-comment">// 记录矩形起始点的 X 坐标（左上角）</span>
  <span class="hljs-keyword">this</span>.startY = pointer.y;<span class="hljs-comment">// 记录矩形起始点的 Y 坐标（左上角）</span>

  <span class="hljs-comment">// 标记当前处于“正在绘制”状态，后续 mouse:move 和 mouse:up 会用到</span>
  <span class="hljs-keyword">this</span>.isDrawing = <span class="hljs-literal">true</span>;

  <span class="hljs-comment">// 创建一个新的 Fabric Rect 实例，作为当前正在绘制的矩形</span>
  <span class="hljs-keyword">this</span>.currentRect = new Rect({
    left: <span class="hljs-keyword">this</span>.startX,<span class="hljs-comment">// 矩形左上角 X 坐标（起始点）</span>
    top: <span class="hljs-keyword">this</span>.startY,<span class="hljs-comment">// 矩形左上角 Y 坐标（起始点）</span>
    width: <span class="hljs-number">0</span>, <span class="hljs-comment">// 初始宽高为 0，后续拖拽时动态更新</span>
    height: <span class="hljs-number">0</span>,
    fill: <span class="hljs-string">"rgba(255,0,0,0.3)"</span>, <span class="hljs-comment">// 半透明红色填充，便于区分选区</span>
    stroke: <span class="hljs-string">"red"</span>,<span class="hljs-comment">// 边框颜色</span>
    strokeWidth: <span class="hljs-number">2</span>,<span class="hljs-comment">// 边框粗细</span>
    selectable: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 允许被选中和拖拽移动</span>
    hasControls: <span class="hljs-literal">true</span>,<span class="hljs-comment">// 显示八个控制点（调整大小用）</span>
    hasRotatingPoint: <span class="hljs-literal">false</span>,  <span class="hljs-comment">// 禁止旋转手柄（我们不需要旋转）</span>
    cornerColor: <span class="hljs-string">"red"</span>,  <span class="hljs-comment">// 控制点角（调整大小时的八个小方块）颜色设为红色，与主题保持一致</span>
    transparentCorners: <span class="hljs-literal">false</span>, <span class="hljs-comment">// 控制点不透明（默认是半透明的，这里改成实心）</span>
    cornerStyle: <span class="hljs-string">"circle"</span>,<span class="hljs-comment">// 控制点形状为圆形（比默认矩形更好看）</span>
    cornerSize: <span class="hljs-number">12</span>,<span class="hljs-comment">// 控制点大小（像素）</span>
    strokeDashArray: [<span class="hljs-number">5</span>, <span class="hljs-number">5</span>],<span class="hljs-comment">// 边框虚线样式 [实线长度, 间隔长度]</span>
  });

  <span class="hljs-comment">// 创建右上角的“× 删除”自定义控制点（自定义控制点是 Fabric.js 高阶用法）</span>
  <span class="hljs-keyword">const</span> deleteControl = <span class="hljs-keyword">this</span>.createDeleteControl();

  <span class="hljs-comment">// 把自定义删除按钮挂载到当前矩形的 controls 上，键名可以自定义</span>
  <span class="hljs-comment">// 之后可以通过 rect.setControlVisible('deleteBtn', false) 控制显隐</span>
  <span class="hljs-keyword">this</span>.currentRect.controls.deleteBtn = deleteControl;

  <span class="hljs-comment">// 隐藏默认的旋转控制点（mtr = middle top rotate）</span>
  <span class="hljs-comment">// 我们已经禁用了旋转，这里再保险隐藏一下</span>
  <span class="hljs-keyword">this</span>.currentRect.setControlVisible(<span class="hljs-string">"mtr"</span>, <span class="hljs-literal">false</span>);

  <span class="hljs-comment">// 立即把矩形添加到画布（此时宽高为0，看不到，但必须先加进去才能实时更新）</span>
  <span class="hljs-keyword">this</span>.canvas.add(<span class="hljs-keyword">this</span>.currentRect);

  <span class="hljs-comment">// 触发重绘，确保即使宽高为0也能看到光标变化</span>
  <span class="hljs-keyword">this</span>.canvas.requestRenderAll();
},
</code></pre>
<p><strong>一、体验丝滑</strong>的绘制能力。</p>
<p>核心交互流程严格遵循经典三阶段模型：</p>
<ol>
<li>
<p><strong>mouse:down</strong> → 开启绘制模式</p>
<ol>
<li>调用 canvas.getPointer(e) 获取相对于画布的精准坐标（自动补偿缩放、平移、视口滚动）</li>
<li>初始化 isDrawing = true 状态标志</li>
<li>创建临时 fabric.Rect 实例（初始宽高为 0）并立即加入画布，确保后续 move 事件可实时更新</li>
</ol>
</li>
<li>
<p><strong>mouse:move</strong> → 实时更新矩形尺寸与位置</p>
<ol>
<li>动态计算宽度/高度取绝对值，支持四个方向拖拽</li>
<li>动态调整 left/top 为较小值，保证矩形左上角始终为起始点</li>
<li>每帧调用 canvas.requestRenderAll() 实现流畅预览</li>
</ol>
</li>
<li>
<p><strong>mouse:up</strong> → 绘制完成 &amp; 防御性收尾</p>
<ol>
<li>自动过滤误触（宽或高 &lt; 10px 的矩形直接丢弃）</li>
<li>为有效矩形添加自定义删除控件（controls.deleteBtn）</li>
<li>将矩形实例推入管理数组，便于后续批量操作与数据同步</li>
<li>触发外部回调 onRectangleAdded，实现与 Pinia/Vuex/React 状态的完美解耦</li>
</ol>
</li>
</ol>
<h5 data-id="heading-6">鼠标事件</h5>
<pre><code class="hljs language-kotlin" lang="kotlin"> <span class="hljs-comment">// 鼠标按下事件</span>
  handleMouseDown(opt) {
    <span class="hljs-keyword">if</span> (opt.target) {
      <span class="hljs-keyword">return</span>; <span class="hljs-comment">// 点击了已有对象，进入编辑模式</span>
    }
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.isDrawing) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">this</span>.startDrawing(opt);
  }
   <span class="hljs-comment">// 鼠标移动事件</span>
  handleMouseMove(opt) {
    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.isDrawing || !<span class="hljs-keyword">this</span>.currentRect) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">const</span> pointer = <span class="hljs-keyword">this</span>.canvas.getPointer(opt.e);
    <span class="hljs-keyword">const</span> w = Math.abs(pointer.x - <span class="hljs-keyword">this</span>.startX);
    <span class="hljs-keyword">const</span> h = Math.abs(pointer.y - <span class="hljs-keyword">this</span>.startY);

    <span class="hljs-keyword">this</span>.currentRect.<span class="hljs-keyword">set</span>({
      width: w,
      height: h,
      left: Math.min(pointer.x, <span class="hljs-keyword">this</span>.startX),
      top: Math.min(pointer.y, <span class="hljs-keyword">this</span>.startY),
    });

    <span class="hljs-keyword">this</span>.canvas.requestRenderAll();
  }

  <span class="hljs-comment">// 鼠标松开事件</span>
  handleMouseUp() {
    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.isDrawing || !<span class="hljs-keyword">this</span>.currentRect) <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">this</span>.isDrawing = <span class="hljs-literal">false</span>;

    <span class="hljs-comment">// 检查矩形尺寸，太小则删除</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.currentRect.width &lt; <span class="hljs-number">5</span> || <span class="hljs-keyword">this</span>.currentRect.height &lt; <span class="hljs-number">5</span>) {
      <span class="hljs-keyword">this</span>.canvas.remove(<span class="hljs-keyword">this</span>.currentRect);
      <span class="hljs-keyword">this</span>.currentRect = <span class="hljs-literal">null</span>;
      <span class="hljs-keyword">this</span>.canvas.requestRenderAll();
      <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-keyword">this</span>.finalizeRectangle();
  }
</code></pre>
<h5 data-id="heading-7">自定义删除控件（Custom Control）实现亮点</h5>
<ul>
<li>位置锚点：x: 0.5, y: -0.5 + offsetX/Y 微调，精准定位在矩形右上角</li>
<li>视觉风格：红色圆形底 + 白色粗体 ×，与 Ant Design/ProComponents 设计语言完全一致</li>
<li>交互体验：cornerSize: 28 扩大点击区域，老年模式也能轻松点中</li>
<li>性能优化：仅使用 Canvas 2D 绘制，无额外 DOM 元素，无内存泄漏</li>
<li>事件隔离：mouseUpHandler 内部直接 canvas.remove(target) 并通知外部删除回调</li>
</ul>
<blockquote>
<p>Control就是可以设置图形的点。</p>
</blockquote>
<pre><code class="hljs language-kotlin" lang="kotlin">createDeleteControl() {
  <span class="hljs-comment">/**
   * 创建 Fabric.js 自定义删除控件
   * 该控件会出现在选中对象的右上角（可通过 x/y 调整位置）
   */</span>
  <span class="hljs-keyword">return</span> new Control({
    x: <span class="hljs-number">0.5</span>,                 <span class="hljs-comment">// 水平锚点：0.5 表示对象右边缘</span>
    y: -<span class="hljs-number">0.5</span>,                <span class="hljs-comment">// 垂直锚点：-0.5 表示对象上边缘</span>
    offsetX: <span class="hljs-number">10</span>,            <span class="hljs-comment">// 水平偏移量（向右偏移 10px）</span>
    offsetY: -<span class="hljs-number">10</span>,           <span class="hljs-comment">// 垂直偏移量（向上偏移 10px）</span>
    cursorStyle: <span class="hljs-string">"pointer"</span>, <span class="hljs-comment">// 鼠标悬停时显示手型光标</span>
    cornerSize: <span class="hljs-number">24</span>,         <span class="hljs-comment">// 可点击区域大小（24×24px）</span>
    
    <span class="hljs-comment">// 自定义绘制删除图标（× 或垃圾桶图标）</span>
    render: <span class="hljs-keyword">this</span>.renderDeleteIcon.bind(<span class="hljs-keyword">this</span>),
    
    <span class="hljs-comment">// 点击删除按钮后执行的回调</span>
    mouseUpHandler: <span class="hljs-keyword">this</span>.deleteHandler.bind(<span class="hljs-keyword">this</span>),
  });
}

简单的删除操作就是在画布中remove（对应的矩形） requestRenderAll重新渲染
</code></pre>
<h2 data-id="heading-8">六、清空所有选取</h2>
<blockquote>
<p>清空操作就是获取所有的矩形实例然后给remove ，重新渲染requestRenderAll。</p>
</blockquote>
<h2 data-id="heading-9">七、完整代码</h2>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> { Canvas, FabricImage, Rect, Control } from <span class="hljs-string">"fabric"</span>;

export <span class="hljs-keyword">class</span> <span class="hljs-title class_">CanvasManager</span> {
  <span class="hljs-comment">// 创建初始画布</span>
  <span class="hljs-keyword">constructor</span>(canvasEl, options = {}) {
    <span class="hljs-comment">// 保存回调函数</span>
    <span class="hljs-keyword">this</span>.onRectangleAdded = options.onRectangleAdded;
    <span class="hljs-keyword">this</span>.onRectangleUpdated = options.onRectangleUpdated;
    <span class="hljs-keyword">this</span>.onRectangleDeleted = options.onRectangleDeleted;

    <span class="hljs-keyword">this</span>.canvas = new Canvas(canvasEl, {
      width: canvasEl.clientWidth || <span class="hljs-number">800</span>,
      height: canvasEl.clientHeight || <span class="hljs-number">600</span>,
      backgroundColor: <span class="hljs-string">"#f0f0f0"</span>,
      selection: <span class="hljs-literal">false</span>,
    });

    <span class="hljs-keyword">this</span>.isDrawing = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">this</span>.startX = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">this</span>.startY = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">this</span>.currentRect = <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">this</span>.deleteIconImg = <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">this</span>.rectangles = [];

    <span class="hljs-keyword">this</span>.initEvents();
  }

  <span class="hljs-comment">// 设置背景图片</span>
  async setBackground(imageUrl) {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-comment">// 保存图片URL/路径</span>
      <span class="hljs-keyword">this</span>.imageUrl =
        typeof imageUrl === <span class="hljs-string">"string"</span>
          ? imageUrl
          : imageUrl?.default || imageUrl?.src || imageUrl;

      <span class="hljs-keyword">const</span> img = await FabricImage.fromURL(<span class="hljs-keyword">this</span>.imageUrl);

      <span class="hljs-comment">// 保存原始图片尺寸</span>
      <span class="hljs-keyword">this</span>.originalImageWidth = img.width;
      <span class="hljs-keyword">this</span>.originalImageHeight = img.height;

      <span class="hljs-comment">// 缩放图片以适应画布宽度</span>
      img.scaleToWidth(<span class="hljs-keyword">this</span>.canvas.getWidth());

      <span class="hljs-comment">// 保存缩放后的尺寸（实际显示尺寸）</span>
      <span class="hljs-keyword">this</span>.scaledImageWidth = img.width * (img.scaleX || <span class="hljs-number">1</span>);
      <span class="hljs-keyword">this</span>.scaledImageHeight = img.height * (img.scaleY || <span class="hljs-number">1</span>);

      <span class="hljs-keyword">this</span>.canvas.backgroundImage = img;
      <span class="hljs-keyword">this</span>.canvas.requestRenderAll();

      <span class="hljs-keyword">return</span> {
        image: img,
        imageUrl: <span class="hljs-keyword">this</span>.imageUrl, <span class="hljs-comment">// 返回图片路径</span>
        originalSize: {
          width: <span class="hljs-keyword">this</span>.originalImageWidth,
          height: <span class="hljs-keyword">this</span>.originalImageHeight,
        },
        scaledSize: {
          width: <span class="hljs-keyword">this</span>.scaledImageWidth,
          height: <span class="hljs-keyword">this</span>.scaledImageHeight,
        },
        scaleX: img.scaleX,
        scaleY: img.scaleY,
      };
    } <span class="hljs-keyword">catch</span> (error) {
      console.error(<span class="hljs-string">"背景加载失败："</span>, error);
      <span class="hljs-keyword">throw</span> error;
    }
  }

  <span class="hljs-comment">// 获取图片URL/路径</span>
  getImageUrl() {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.imageUrl || <span class="hljs-literal">null</span>;
  }

  <span class="hljs-comment">// 获取图片尺寸信息</span>
  getImageSize() {
    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.canvas.backgroundImage) {
      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    }

    <span class="hljs-keyword">return</span> {
      original: {
        width: <span class="hljs-keyword">this</span>.originalImageWidth || <span class="hljs-number">0</span>,
        height: <span class="hljs-keyword">this</span>.originalImageHeight || <span class="hljs-number">0</span>,
      },
      scaled: {
        width: <span class="hljs-keyword">this</span>.scaledImageWidth || <span class="hljs-number">0</span>,
        height: <span class="hljs-keyword">this</span>.scaledImageHeight || <span class="hljs-number">0</span>,
      },
      scaleX: <span class="hljs-keyword">this</span>.canvas.backgroundImage.scaleX || <span class="hljs-number">1</span>,
      scaleY: <span class="hljs-keyword">this</span>.canvas.backgroundImage.scaleY || <span class="hljs-number">1</span>,
    };
  }

  <span class="hljs-comment">// 加载删除图标</span>
  async loadDeleteIcon(iconUrl) {
    <span class="hljs-keyword">return</span> new Promise((resolve) =&gt; {
      <span class="hljs-keyword">const</span> img = new Image();
      img.src = iconUrl;
      img.onload = () =&gt; {
        <span class="hljs-keyword">this</span>.deleteIconImg = img;
        resolve(img);
      };
      img.onerror = () =&gt; {
        console.warn(<span class="hljs-string">"删除图标加载失败，使用默认样式"</span>);
        resolve(<span class="hljs-literal">null</span>);
      };
    });
  }

  <span class="hljs-comment">// 初始化事件</span>
  initEvents() {
    <span class="hljs-keyword">this</span>.canvas.on(<span class="hljs-string">"mouse:down"</span>, <span class="hljs-keyword">this</span>.handleMouseDown.bind(<span class="hljs-keyword">this</span>));
    <span class="hljs-keyword">this</span>.canvas.on(<span class="hljs-string">"mouse:move"</span>, <span class="hljs-keyword">this</span>.handleMouseMove.bind(<span class="hljs-keyword">this</span>));
    <span class="hljs-keyword">this</span>.canvas.on(<span class="hljs-string">"mouse:up"</span>, <span class="hljs-keyword">this</span>.handleMouseUp.bind(<span class="hljs-keyword">this</span>));
    <span class="hljs-keyword">this</span>.canvas.on(<span class="hljs-string">"selection:created"</span>, <span class="hljs-keyword">this</span>.handleSelectionCreated.bind(<span class="hljs-keyword">this</span>));
  }

  <span class="hljs-comment">// 鼠标按下事件</span>
  handleMouseDown(opt) {
    <span class="hljs-keyword">if</span> (opt.target) {
      <span class="hljs-keyword">return</span>; <span class="hljs-comment">// 点击了已有对象，进入编辑模式</span>
    }
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.isDrawing) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">this</span>.startDrawing(opt);
  }

  <span class="hljs-comment">// 开始绘制</span>
  startDrawing(opt) {
    <span class="hljs-keyword">const</span> pointer = <span class="hljs-keyword">this</span>.canvas.getPointer(opt.e);
    <span class="hljs-keyword">this</span>.startX = pointer.x;
    <span class="hljs-keyword">this</span>.startY = pointer.y;
    <span class="hljs-keyword">this</span>.isDrawing = <span class="hljs-literal">true</span>;

    <span class="hljs-keyword">this</span>.currentRect = new Rect({
      left: <span class="hljs-keyword">this</span>.startX,
      top: <span class="hljs-keyword">this</span>.startY,
      width: <span class="hljs-number">0</span>,
      height: <span class="hljs-number">0</span>,
      fill: <span class="hljs-string">"rgba(255,0,0,0.3)"</span>,
      stroke: <span class="hljs-string">"red"</span>,
      strokeWidth: <span class="hljs-number">2</span>,
      selectable: <span class="hljs-literal">true</span>,
      hasControls: <span class="hljs-literal">true</span>,
      hasRotatingPoint: <span class="hljs-literal">false</span>,
      cornerColor: <span class="hljs-string">"red"</span>,
      transparentCorners: <span class="hljs-literal">false</span>,
      cornerStyle: <span class="hljs-string">"circle"</span>,
      cornerSize: <span class="hljs-number">12</span>,
      strokeDashArray: [<span class="hljs-number">5</span>, <span class="hljs-number">5</span>],
    });

    <span class="hljs-comment">// 添加删除控制点</span>
    <span class="hljs-keyword">const</span> deleteControl = <span class="hljs-keyword">this</span>.createDeleteControl();
    <span class="hljs-keyword">this</span>.currentRect.controls.deleteBtn = deleteControl;
    <span class="hljs-keyword">this</span>.currentRect.setControlVisible(<span class="hljs-string">"mtr"</span>, <span class="hljs-literal">false</span>);

    <span class="hljs-keyword">this</span>.canvas.add(<span class="hljs-keyword">this</span>.currentRect);
    <span class="hljs-keyword">this</span>.canvas.requestRenderAll();
  }

  <span class="hljs-comment">// 创建删除控制点</span>
  createDeleteControl() {
    <span class="hljs-keyword">return</span> new Control({
      x: <span class="hljs-number">0.5</span>,
      y: -<span class="hljs-number">0.5</span>,
      offsetX: <span class="hljs-number">10</span>,
      offsetY: -<span class="hljs-number">10</span>,
      cursorStyle: <span class="hljs-string">"pointer"</span>,
      cornerSize: <span class="hljs-number">24</span>,
      render: <span class="hljs-keyword">this</span>.renderDeleteIcon.bind(<span class="hljs-keyword">this</span>),
      mouseUpHandler: <span class="hljs-keyword">this</span>.deleteHandler.bind(<span class="hljs-keyword">this</span>),
    });
  }

  <span class="hljs-comment">// 鼠标移动事件</span>
  handleMouseMove(opt) {
    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.isDrawing || !<span class="hljs-keyword">this</span>.currentRect) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">const</span> pointer = <span class="hljs-keyword">this</span>.canvas.getPointer(opt.e);
    <span class="hljs-keyword">const</span> w = Math.abs(pointer.x - <span class="hljs-keyword">this</span>.startX);
    <span class="hljs-keyword">const</span> h = Math.abs(pointer.y - <span class="hljs-keyword">this</span>.startY);

    <span class="hljs-keyword">this</span>.currentRect.<span class="hljs-keyword">set</span>({
      width: w,
      height: h,
      left: Math.min(pointer.x, <span class="hljs-keyword">this</span>.startX),
      top: Math.min(pointer.y, <span class="hljs-keyword">this</span>.startY),
    });

    <span class="hljs-keyword">this</span>.canvas.requestRenderAll();
  }

  <span class="hljs-comment">// 鼠标松开事件</span>
  handleMouseUp() {
    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.isDrawing || !<span class="hljs-keyword">this</span>.currentRect) <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">this</span>.isDrawing = <span class="hljs-literal">false</span>;

    <span class="hljs-comment">// 检查矩形尺寸，太小则删除</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.currentRect.width &lt; <span class="hljs-number">5</span> || <span class="hljs-keyword">this</span>.currentRect.height &lt; <span class="hljs-number">5</span>) {
      <span class="hljs-keyword">this</span>.canvas.remove(<span class="hljs-keyword">this</span>.currentRect);
      <span class="hljs-keyword">this</span>.currentRect = <span class="hljs-literal">null</span>;
      <span class="hljs-keyword">this</span>.canvas.requestRenderAll();
      <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-keyword">this</span>.finalizeRectangle();
  }

  <span class="hljs-comment">// CanvasManager.js</span>
  finalizeRectangle() {
    <span class="hljs-keyword">const</span> id = `rect_${Date.now()}_${Math.random().toString(<span class="hljs-number">36</span>).substr(<span class="hljs-number">2</span>, <span class="hljs-number">9</span>)}`;
    <span class="hljs-keyword">const</span> coords = <span class="hljs-keyword">this</span>.currentRect.getCoords();

    <span class="hljs-keyword">const</span> rectData = {
      id,
      fabricObject: <span class="hljs-keyword">this</span>.currentRect,
      coords: {
        tl: coords[<span class="hljs-number">0</span>],
        tr: coords[<span class="hljs-number">1</span>],
        br: coords[<span class="hljs-number">2</span>],
        bl: coords[<span class="hljs-number">3</span>],
      },
      left: <span class="hljs-keyword">this</span>.currentRect.left,
      top: <span class="hljs-keyword">this</span>.currentRect.top,
      width: <span class="hljs-keyword">this</span>.currentRect.width,
      height: <span class="hljs-keyword">this</span>.currentRect.height,
      angle: <span class="hljs-keyword">this</span>.currentRect.angle,
    };

    <span class="hljs-comment">// 保存到 rectangles 数组</span>
    <span class="hljs-keyword">this</span>.rectangles.push(rectData);

    <span class="hljs-comment">// 直接调用回调函数添加到 store</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.onRectangleAdded) {
      <span class="hljs-keyword">this</span>.onRectangleAdded(rectData);
    }

    <span class="hljs-keyword">this</span>.canvas.setActiveObject(<span class="hljs-keyword">this</span>.currentRect);

    <span class="hljs-comment">// 绑定实时更新事件</span>
    <span class="hljs-keyword">this</span>.currentRect.on(<span class="hljs-string">"moving"</span>, () =&gt; <span class="hljs-keyword">this</span>.updateRectCoords(rectData));
    <span class="hljs-keyword">this</span>.currentRect.on(<span class="hljs-string">"scaling"</span>, () =&gt; <span class="hljs-keyword">this</span>.updateRectCoords(rectData));
    <span class="hljs-keyword">this</span>.currentRect.on(<span class="hljs-string">"rotating"</span>, () =&gt; <span class="hljs-keyword">this</span>.updateRectCoords(rectData));

    <span class="hljs-keyword">this</span>.currentRect = <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">this</span>.canvas.requestRenderAll();

    <span class="hljs-keyword">return</span> rectData;
  }

  <span class="hljs-comment">// 更新矩形坐标</span>
  updateRectCoords(rectData) {
    <span class="hljs-keyword">const</span> obj = rectData.fabricObject;
    <span class="hljs-keyword">const</span> coords = obj.getCoords();

    rectData.coords = {
      tl: {
        x: Number(coords[<span class="hljs-number">0</span>].x.toFixed(<span class="hljs-number">2</span>)),
        y: Number(coords[<span class="hljs-number">0</span>].y.toFixed(<span class="hljs-number">2</span>)),
      },
      tr: {
        x: Number(coords[<span class="hljs-number">1</span>].x.toFixed(<span class="hljs-number">2</span>)),
        y: Number(coords[<span class="hljs-number">1</span>].y.toFixed(<span class="hljs-number">2</span>)),
      },
      br: {
        x: Number(coords[<span class="hljs-number">2</span>].x.toFixed(<span class="hljs-number">2</span>)),
        y: Number(coords[<span class="hljs-number">2</span>].y.toFixed(<span class="hljs-number">2</span>)),
      },
      bl: {
        x: Number(coords[<span class="hljs-number">3</span>].x.toFixed(<span class="hljs-number">2</span>)),
        y: Number(coords[<span class="hljs-number">3</span>].y.toFixed(<span class="hljs-number">2</span>)),
      },
    };

    rectData.left = Number(obj.left.toFixed(<span class="hljs-number">2</span>));
    rectData.top = Number(obj.top.toFixed(<span class="hljs-number">2</span>));
    rectData.width = Number(obj.width.toFixed(<span class="hljs-number">2</span>));
    rectData.height = Number(obj.height.toFixed(<span class="hljs-number">2</span>));
    rectData.angle = Number(obj.angle.toFixed(<span class="hljs-number">2</span>));

    <span class="hljs-comment">// 通知更新</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.onRectangleUpdated) {
      <span class="hljs-keyword">this</span>.onRectangleUpdated(rectData);
    }
  }

  <span class="hljs-comment">// 选中事件</span>
  handleSelectionCreated(opt) {
    <span class="hljs-keyword">const</span> active = opt.target;
    <span class="hljs-keyword">const</span> <span class="hljs-keyword">data</span> = <span class="hljs-keyword">this</span>.rectangles.find((r) =&gt; r.fabricObject === active);
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">data</span>) <span class="hljs-keyword">this</span>.updateRectCoords(<span class="hljs-keyword">data</span>);
  }

  <span class="hljs-comment">// 删除处理</span>
  deleteHandler(eventData, transform) {
    <span class="hljs-keyword">const</span> target = transform.target;
    <span class="hljs-keyword">if</span> (!target) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;

    <span class="hljs-comment">// 找到要删除的矩形数据</span>
    <span class="hljs-keyword">const</span> rectData = <span class="hljs-keyword">this</span>.rectangles.find((r) =&gt; r.fabricObject === target);

    <span class="hljs-comment">// 从 rectangles 中移除</span>
    <span class="hljs-keyword">this</span>.rectangles = <span class="hljs-keyword">this</span>.rectangles.filter((r) =&gt; r.fabricObject !== target);

    <span class="hljs-comment">// 调用删除回调</span>
    <span class="hljs-keyword">if</span> (rectData &amp;&amp; <span class="hljs-keyword">this</span>.onRectangleDeleted) {
      <span class="hljs-keyword">this</span>.onRectangleDeleted(rectData.id);
    }

    <span class="hljs-keyword">this</span>.canvas.remove(target);
    <span class="hljs-keyword">this</span>.canvas.requestRenderAll();
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  }

  <span class="hljs-comment">// 渲染删除图标</span>
  renderDeleteIcon(ctx, left, top) {
    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.deleteIconImg) {
      <span class="hljs-comment">// 降级样式</span>
      ctx.save();
      ctx.fillStyle = <span class="hljs-string">"red"</span>;
      ctx.beginPath();
      ctx.arc(left, top, <span class="hljs-number">12</span>, <span class="hljs-number">0</span>, Math.PI * <span class="hljs-number">2</span>);
      ctx.fill();
      ctx.strokeStyle = <span class="hljs-string">"white"</span>;
      ctx.lineWidth = <span class="hljs-number">2</span>;
      ctx.beginPath();
      ctx.moveTo(left - <span class="hljs-number">6</span>, top - <span class="hljs-number">6</span>);
      ctx.lineTo(left + <span class="hljs-number">6</span>, top + <span class="hljs-number">6</span>);
      ctx.moveTo(left + <span class="hljs-number">6</span>, top - <span class="hljs-number">6</span>);
      ctx.lineTo(left - <span class="hljs-number">6</span>, top + <span class="hljs-number">6</span>);
      ctx.stroke();
      ctx.restore();
      <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-keyword">const</span> size = <span class="hljs-number">20</span>;
    ctx.drawImage(
      <span class="hljs-keyword">this</span>.deleteIconImg,
      left - size / <span class="hljs-number">2</span>,
      top - size / <span class="hljs-number">2</span>,
      size,
      size
    );
  }

  <span class="hljs-comment">// 获取所有矩形数据</span>
  getRectangles() {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.rectangles.map((rect) =&gt; ({
      id: rect.id,
      coords: rect.coords,
      left: rect.left,
      top: rect.top,
      width: rect.width,
      height: rect.height,
      angle: rect.angle,
    }));
  }

  <span class="hljs-comment">// 清空画布（保留背景图片）</span>
  clear() {
    <span class="hljs-comment">// 获取所有对象（不包括背景图片）</span>
    <span class="hljs-keyword">const</span> objects = <span class="hljs-keyword">this</span>.canvas.getObjects();

    <span class="hljs-comment">// 移除所有对象</span>
    objects.forEach((obj) =&gt; {
      <span class="hljs-keyword">this</span>.canvas.remove(obj);
    });

    <span class="hljs-comment">// 清空矩形数组</span>
    <span class="hljs-keyword">this</span>.rectangles = [];

    <span class="hljs-comment">// 重新渲染</span>
    <span class="hljs-keyword">this</span>.canvas.requestRenderAll();
  }

  <span class="hljs-comment">// 清空所有（包括背景图片）</span>
  clearAll() {
    <span class="hljs-comment">// 清空所有对象</span>
    <span class="hljs-keyword">this</span>.clear();

    <span class="hljs-comment">// 清空背景图片</span>
    <span class="hljs-keyword">this</span>.canvas.backgroundImage = <span class="hljs-literal">null</span>;

    <span class="hljs-comment">// 重新渲染</span>
    <span class="hljs-keyword">this</span>.canvas.requestRenderAll();
  }

  <span class="hljs-comment">// 调整画布大小</span>
  resize(width, height) {
    <span class="hljs-keyword">this</span>.canvas.setDimensions({ width, height });
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.canvas.backgroundImage) {
      <span class="hljs-keyword">this</span>.canvas.backgroundImage.scaleToWidth(width);
    }
    <span class="hljs-keyword">this</span>.canvas.requestRenderAll();
  }

  <span class="hljs-comment">// 销毁</span>
  destroy() {
    <span class="hljs-keyword">this</span>.canvas.off(<span class="hljs-string">"mouse:down"</span>);
    <span class="hljs-keyword">this</span>.canvas.off(<span class="hljs-string">"mouse:move"</span>);
    <span class="hljs-keyword">this</span>.canvas.off(<span class="hljs-string">"mouse:up"</span>);
    <span class="hljs-keyword">this</span>.canvas.off(<span class="hljs-string">"selection:created"</span>);
    <span class="hljs-keyword">this</span>.canvas.dispose();
  }
}

</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[深入理解 UINavigationController：生命周期、动画优化与性能调优]]></title>    <link>https://juejin.cn/post/7577295460249042990</link>    <guid>https://juejin.cn/post/7577295460249042990</guid>    <pubDate>2025-11-28T02:42:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577295460249042990" data-draft-id="7577242285198540827" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" 深入理解 UINavigationController：生命周期、动画优化与性能调优"/> <meta itemprop="keywords" content="iOS"/> <meta itemprop="datePublished" content="2025-11-28T02:42:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="江东小bug王"/> <meta itemprop="url" content="https://juejin.cn/user/1583760376077646"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             深入理解 UINavigationController：生命周期、动画优化与性能调优
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1583760376077646/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    江东小bug王
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-28T02:42:58.000Z" title="Fri Nov 28 2025 02:42:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在日常开发中，<code>UINavigationController</code> 是我们最常用的容器控制器之一。但你是否真正理解：</p>
<ul>
<li>页面 push/pop 时，两个 ViewController 的生命周期方法如何调用？</li>
<li>为什么首次进入新页面会卡顿？</li>
<li>如何让导航切换更丝滑？</li>
<li>又该如何定位动画卡顿的“罪魁祸首”？</li>
</ul>
<p>本文将从 <strong>基础生命周期 → 动画优化 → 性能检测</strong> 三个层次，带你系统掌握 UINavigationController 的核心机制，并提供可落地的 Objective-C 实践方案。</p>
<hr/>
<h2 data-id="heading-0">一、页面切换时的生命周期：谁先谁后？</h2>
<h3 data-id="heading-1">场景 1：Push 新页面（A → B）</h3>
<p>假设当前栈顶是 <code>ViewControllerA</code>，点击按钮 push 到 <code>ViewControllerB</code>：</p>
<pre><code class="hljs language-objectivec" lang="objectivec"><span class="hljs-comment">// ViewControllerB 首次创建</span>
- (<span class="hljs-type">void</span>)viewDidLoad {
    [<span class="hljs-variable language_">super</span> viewDidLoad];
    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"B: viewDidLoad"</span>);
}

- (<span class="hljs-type">void</span>)viewWillAppear:(<span class="hljs-type">BOOL</span>)animated {
    [<span class="hljs-variable language_">super</span> viewWillAppear:animated];
    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"B: viewWillAppear"</span>);
}

- (<span class="hljs-type">void</span>)viewDidAppear:(<span class="hljs-type">BOOL</span>)animated {
    [<span class="hljs-variable language_">super</span> viewDidAppear:animated];
    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"B: viewDidAppear"</span>);
}
</code></pre>
<pre><code class="hljs language-objectivec" lang="objectivec"><span class="hljs-comment">// ViewControllerA 被压入栈底</span>
- (<span class="hljs-type">void</span>)viewWillDisappear:(<span class="hljs-type">BOOL</span>)animated {
    [<span class="hljs-variable language_">super</span> viewWillDisappear:animated];
    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"A: viewWillDisappear"</span>);
}

- (<span class="hljs-type">void</span>)viewDidDisappear:(<span class="hljs-type">BOOL</span>)animated {
    [<span class="hljs-variable language_">super</span> viewDidDisappear:animated];
    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"A: viewDidDisappear"</span>);
}
</code></pre>
<p><strong>调用顺序如下：</strong></p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">B: viewDidLoad</span>
<span class="hljs-section">A: viewWillDisappear</span>
<span class="hljs-section">B: viewWillAppear</span>
<span class="hljs-section">A: viewDidDisappear</span>
<span class="hljs-section">B: viewDidAppear</span>
</code></pre>
<blockquote>
<p>✅ 注意：<code>viewDidLoad</code> 仅在视图首次加载时调用一次。</p>
</blockquote>
<hr/>
<h3 data-id="heading-2">场景 2：Pop 返回（B → A）</h3>
<p>当用户点击返回或手势滑动 pop 回 A：</p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">B: viewWillDisappear</span>
<span class="hljs-section">A: viewWillAppear</span>
<span class="hljs-section">B: viewDidDisappear</span>
<span class="hljs-section">A: viewDidAppear</span>
</code></pre>
<blockquote>
<p>❗ 关键点：<strong>A 的 <code>viewDidLoad</code> 不会再次调用！</strong><br/>
所以，若需每次进入都刷新数据，请放在 <code>viewWillAppear:</code> 中。</p>
</blockquote>
<hr/>
<h2 data-id="heading-3">二、为什么页面切换会卡顿？常见原因</h2>
<ol>
<li>
<p><strong>在 <code>viewDidLoad</code> 或 <code>viewWillAppear:</code> 中执行耗时操作</strong></p>
<ul>
<li>网络请求、JSON 解析、数据库查询</li>
<li>复杂 Auto Layout 计算</li>
<li>大量子视图创建或图片解码</li>
</ul>
</li>
<li>
<p><strong>首次 push 时构建整个视图层级</strong></p>
<ul>
<li>导致主线程阻塞，动画掉帧</li>
</ul>
</li>
<li>
<p><strong>离屏渲染（Offscreen Rendering）</strong></p>
<ul>
<li>圆角 + 阴影 + mask 同时使用</li>
<li>触发 GPU 额外绘制</li>
</ul>
</li>
</ol>
<hr/>
<h2 data-id="heading-4">三、优化策略：让导航切换如丝般顺滑</h2>
<h3 data-id="heading-5">✅ 1. 异步加载 &amp; 延迟初始化</h3>
<pre><code class="hljs language-objectivec" lang="objectivec">- (<span class="hljs-type">void</span>)viewDidLoad {
    [<span class="hljs-variable language_">super</span> viewDidLoad];
    
    <span class="hljs-comment">// 轻量级 UI 初始化</span>
    [<span class="hljs-keyword">self</span> setupUI];
    
    <span class="hljs-comment">// 耗时任务放后台</span>
    <span class="hljs-built_in">dispatch_async</span>(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, <span class="hljs-number">0</span>), ^{
        <span class="hljs-built_in">NSArray</span> *data = [<span class="hljs-keyword">self</span> fetchHeavyData];
        <span class="hljs-built_in">dispatch_async</span>(dispatch_get_main_queue(), ^{
            [<span class="hljs-keyword">self</span> reloadData:data];
        });
    });
}
</code></pre>
<blockquote>
<p>⚠️ 切记：UI 更新必须回到主线程！</p>
</blockquote>
<hr/>
<h3 data-id="heading-6">✅ 2. 预加载目标 ViewController（减少首次卡顿）</h3>
<pre><code class="hljs language-objectivec" lang="objectivec"><span class="hljs-comment">// 在父页面中预创建</span>
- (DetailViewController *)cachedDetailVC {
    <span class="hljs-keyword">if</span> (!_cachedDetailVC) {
        _cachedDetailVC = [[DetailViewController alloc] init];
        <span class="hljs-comment">// 提前触发 loadView，构建视图层级</span>
        <span class="hljs-built_in">UIView</span> *temp = _cachedDetailVC.view;
        (<span class="hljs-type">void</span>)temp; <span class="hljs-comment">// 避免编译器警告</span>
    }
    <span class="hljs-keyword">return</span> _cachedDetailVC;
}

- (<span class="hljs-keyword">IBAction</span>)showDetail:(<span class="hljs-type">id</span>)sender {
    [<span class="hljs-keyword">self</span>.navigationController pushViewController:<span class="hljs-keyword">self</span>.cachedDetailVC animated:<span class="hljs-literal">YES</span>];
}
</code></pre>
<blockquote>
<p>💡 适用于高频跳转页面（如商品详情、用户主页）。</p>
</blockquote>
<hr/>
<h3 data-id="heading-7">✅ 3. 自定义转场动画（提升体验）</h3>
<p>实现 <code>UINavigationControllerDelegate</code>：</p>
<pre><code class="hljs language-objectivec" lang="objectivec"><span class="hljs-comment">// MyNavigationControllerDelegate.m</span>
- (<span class="hljs-type">id</span>&lt;<span class="hljs-built_in">UIViewControllerAnimatedTransitioning</span>&gt;)navigationController:(<span class="hljs-built_in">UINavigationController</span> *)navigationController
                                   animationControllerForOperation:(<span class="hljs-built_in">UINavigationControllerOperation</span>)operation
                                                fromViewController:(<span class="hljs-built_in">UIViewController</span> *)fromVC
                                                  toViewController:(<span class="hljs-built_in">UIViewController</span> *)toVC {
    <span class="hljs-keyword">if</span> (operation == <span class="hljs-built_in">UINavigationControllerOperationPush</span>) {
        <span class="hljs-keyword">return</span> [[FadePushAnimator alloc] init];
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>; <span class="hljs-comment">// 使用默认 pop 动画</span>
}
</code></pre>
<p>自定义动画器（简化版淡入）：</p>
<pre><code class="hljs language-objectivec" lang="objectivec"><span class="hljs-comment">// FadePushAnimator.m</span>
- (<span class="hljs-built_in">NSTimeInterval</span>)transitionDuration:(<span class="hljs-type">id</span>&lt;<span class="hljs-built_in">UIViewControllerContextTransitioning</span>&gt;)transitionContext {
    <span class="hljs-keyword">return</span> <span class="hljs-number">0.35</span>;
}

- (<span class="hljs-type">void</span>)animateTransition:(<span class="hljs-type">id</span>&lt;<span class="hljs-built_in">UIViewControllerContextTransitioning</span>&gt;)transitionContext {
    <span class="hljs-built_in">UIViewController</span> *fromVC = [transitionContext viewControllerForKey:<span class="hljs-built_in">UITransitionContextFromViewControllerKey</span>];
    <span class="hljs-built_in">UIViewController</span> *toVC = [transitionContext viewControllerForKey:<span class="hljs-built_in">UITransitionContextToViewControllerKey</span>];
    <span class="hljs-built_in">UIView</span> *container = [transitionContext containerView];
    
    [container addSubview:toVC.view];
    toVC.view.alpha = <span class="hljs-number">0.0</span>;
    
    [<span class="hljs-built_in">UIView</span> animateWithDuration:[<span class="hljs-keyword">self</span> transitionDuration:transitionContext] animations:^{
        fromVC.view.alpha = <span class="hljs-number">0.3</span>;
        toVC.view.alpha = <span class="hljs-number">1.0</span>;
    } completion:^(<span class="hljs-type">BOOL</span> finished) {
        fromVC.view.alpha = <span class="hljs-number">1.0</span>;
        [transitionContext completeTransition:!transitionContext.transitionWasCancelled];
    }];
}
</code></pre>
<blockquote>
<p>🎨 自定义动画可用于品牌化设计，但务必保证流畅性。</p>
</blockquote>
<hr/>
<h2 data-id="heading-8">四、如何检测性能瓶颈？实战工具链</h2>
<h3 data-id="heading-9">🔧 1. 使用 Xcode Instruments</h3>
<h4 data-id="heading-10">（1）Core Animation 模板</h4>
<ul>
<li>运行真机，执行 push/pop</li>
<li>观察 <strong>FPS 曲线</strong>（目标 ≥ 55）</li>
<li>开启调试选项：
<ul>
<li><strong>Color Blended Layers</strong>：红色 = 图层混合过多</li>
<li><strong>Color Offscreen-Rendered</strong>：黄色 = 离屏渲染</li>
</ul>
</li>
</ul>
<h4 data-id="heading-11">（2）Time Profiler 模板</h4>
<ul>
<li>定位 <code>viewDidLoad</code> / <code>viewWillAppear</code> 中的 CPU 热点</li>
<li>检查是否在主线程做 I/O 或复杂计算</li>
</ul>
<hr/>
<h3 data-id="heading-12">📝 2. 代码埋点测耗时</h3>
<pre><code class="hljs language-objectivec" lang="objectivec"><span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">assign</span>) <span class="hljs-built_in">CFTimeInterval</span> appearStartTime;

- (<span class="hljs-type">void</span>)viewWillAppear:(<span class="hljs-type">BOOL</span>)animated {
    [<span class="hljs-variable language_">super</span> viewWillAppear:animated];
    <span class="hljs-keyword">self</span>.appearStartTime = <span class="hljs-built_in">CACurrentMediaTime</span>();
}

- (<span class="hljs-type">void</span>)viewDidAppear:(<span class="hljs-type">BOOL</span>)animated {
    [<span class="hljs-variable language_">super</span> viewDidAppear:animated];
    <span class="hljs-built_in">CFTimeInterval</span> duration = <span class="hljs-built_in">CACurrentMediaTime</span>() - <span class="hljs-keyword">self</span>.appearStartTime;
    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"viewWillAppear → viewDidAppear 耗时: %.2f ms"</span>, duration * <span class="hljs-number">1000</span>);
}
</code></pre>
<blockquote>
<p>若超过 <strong>16ms（1帧）</strong>，就可能影响动画流畅度。</p>
</blockquote>
<hr/>
<h3 data-id="heading-13">🚨 3. 启用 Main Thread Checker</h3>
<p>Xcode 默认开启。若在子线程更新 UI，会立即 crash 并提示：</p>
<blockquote>
<p>“Main Thread Checker: UI API called on a background thread”</p>
</blockquote>
<p>确保所有 UI 操作都在主线程：</p>
<pre><code class="hljs language-objectivec" lang="objectivec"><span class="hljs-built_in">dispatch_async</span>(dispatch_get_main_queue(), ^{
    <span class="hljs-keyword">self</span>.titleLabel.text = newText;
});
</code></pre>
<hr/>
<h2 data-id="heading-14">五、总结：最佳实践 Checklist</h2>

































<table><thead><tr><th>项目</th><th>是否做到</th></tr></thead><tbody><tr><td>✅ <code>viewDidLoad</code> 只做 UI 初始化</td><td>☐</td></tr><tr><td>✅ 数据加载异步化</td><td>☐</td></tr><tr><td>✅ 高频页面预加载</td><td>☐</td></tr><tr><td>✅ 避免离屏渲染（用贝塞尔路径切圆角）</td><td>☐</td></tr><tr><td>✅ 使用 Instruments 定期检测 FPS</td><td>☐</td></tr><tr><td>✅ 返回手势未被遮挡</td><td>☐</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-15">结语</h2>
<p><code>UINavigationController</code> 看似简单，但其背后的生命周期与渲染机制直接影响用户体验。<strong>流畅的页面切换不是偶然，而是对细节的极致把控。</strong></p>
<p>希望本文能帮你：</p>
<ul>
<li>理清生命周期调用顺序</li>
<li>避开常见性能陷阱</li>
<li>掌握一套完整的性能分析方法</li>
</ul>
<blockquote>
<p><strong>真正的高手，不仅写得出功能，更调得稳帧率。</strong></p>
</blockquote>
<p>如果你有具体的卡顿案例，欢迎留言交流！</p>
<hr/>
<p><strong>延伸阅读</strong></p>
<ul>
<li>Apple 官方文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.apple.com%2Flibrary%2Farchive%2Ffeaturedarticles%2FViewControllerPGforiPhoneOS%2F" target="_blank" title="https://developer.apple.com/library/archive/featuredarticles/ViewControllerPGforiPhoneOS/" ref="nofollow noopener noreferrer">View Controller Programming Guide</a></li>
<li>WWDC 2018：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.apple.com%2Fvideos%2Fplay%2Fwwdc2018%2F210%2F" target="_blank" title="https://developer.apple.com/videos/play/wwdc2018/210/" ref="nofollow noopener noreferrer">Practical Approaches to Great App Performance</a></li>
</ul>
<pre><code class="hljs"/></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[万人收藏的提示词工程指导白皮书（附中文版）！Google官方出品，看完整个人都通透了]]></title>    <link>https://juejin.cn/post/7577294037717008418</link>    <guid>https://juejin.cn/post/7577294037717008418</guid>    <pubDate>2025-11-28T02:46:28.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577294037717008418" data-draft-id="7577313637950341129" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="万人收藏的提示词工程指导白皮书（附中文版）！Google官方出品，看完整个人都通透了"/> <meta itemprop="keywords" content="LLM,Agent,程序员"/> <meta itemprop="datePublished" content="2025-11-28T02:46:28.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="AI大模型"/> <meta itemprop="url" content="https://juejin.cn/user/3817967696221534"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            万人收藏的提示词工程指导白皮书（附中文版）！Google官方出品，看完整个人都通透了
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3817967696221534/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    AI大模型
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-28T02:46:28.000Z" title="Fri Nov 28 2025 02:46:28 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>本文较长，建议点赞收藏。更多AI大模型应用开发学习视频及资料，在<a href="https://link.juejin.cn?target=https%3A%2F%2Fhy.zhipoai.cn%2F" target="_blank" title="https://hy.zhipoai.cn/" ref="nofollow noopener noreferrer">智泊AI</a>。</p>
</blockquote>
<p>今天想和大家分享一份来自谷歌的技术白皮书《<strong>Prompt Engineering</strong>》，主题聚焦于“<strong>提示词工程</strong>”，长达68页的提示词指导。</p>
<p>这份文档不仅全面介绍了与大型语言模型（LLMs）有效互动的方法，还深入探讨了多种<strong>高级提示技巧</strong>，旨在帮助我们更精准地利用AI技术解决实际问题。</p>
<p>在这份白皮书中，作者详细讲解了几种核心的提示策略，包括<strong>零样本提示、小样本提示、系统提示、角色提示、上下文提示、退一步提示、链式思考（Chain of Thought）、自我一致性（Self Consistency）、思维树（Tree of Thoughts）以及ReAct方法</strong>。</p>
<p>这些技术不仅能够提升模型输出的相关性和准确性，还能在复杂的开发场景中提供强有力的支持。</p>
<p>特别值得一提的是，白皮书通过实例展示了<strong>如何使用链式思考来增强模型推理能力</strong>，并且提出了将答案置于推理之后的<strong>最佳实践建议</strong>。例如，在构建一个邮件分类系统时，如何通过细致入微的提示设计识别出潜在的重要信息或威胁。</p>
<p>此外，对于想要<strong>自动化其提示过程</strong>的开发者来说，文中也提供了相关的<strong>指导和技术路线图</strong>。</p>
<p>不仅如此，该文档还讨论了通用AI面临的挑战，比如<strong>因提示不充分而导致的问题</strong>，并分享了一系列最佳实践，以帮助开发者成为更加<strong>优秀的提示工程师</strong>。</p>
<p>无论是面对数据处理还是复杂应用集成，白皮书都提供了<strong>宝贵的见解和实用建议</strong>。</p>
<p>最后，白皮书强调了记录每次提示尝试的重要性，这有助于持续学习和改进。</p>
<p>通过实验不同的提示策略并与同行交流心得，我们可以不断提升自己的技能，探索出<strong>最适合自身需求的解决方案</strong>。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6c0cdfda173e4e67b3cf8b248f2fbd21~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764902788&amp;x-signature=IZkoPgLF8aIHUhnuKzy4qe0wj5Q%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0758801481de4d8a81efb180380aee0c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764902788&amp;x-signature=nbk10V5c24OePiA3nyV66oRZBT4%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cf7d02cec96c45d0bfa5d97ae5fe75a0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764902788&amp;x-signature=WWupzfV%2FfnnjAH2ngwPyaviGSJI%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1b70e0347fb8416cbc686224efdd39ac~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764902788&amp;x-signature=Mgq6g%2BZTCFPGghXYADzlR3azqM4%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9a615bdd62f946aa933743cd7bb2f59b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764902788&amp;x-signature=PDAF5FmopiTX7yhwU%2Bxw3WwKhVI%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eb29283315f64ca4812303738680fc4a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764902788&amp;x-signature=pnJJAlNPM9UuRWNFTkjr1N2ueQ0%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e372594cea704d8c9fd0388b48dc1466~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764902788&amp;x-signature=guB%2F0RRM47docVdOngNYsNDs7iU%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4092181245574c1186ba1371ed16e39b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764902788&amp;x-signature=YMs4f8xChBxG0v3dSqwCTFzvaIo%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7ea3fddd7d9f463c9dec0affbd307cff~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764902788&amp;x-signature=kh8vRDU3yeKm8Yr%2FBWhgiPSn%2BrM%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c617755664f5452f9f364629c651afea~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764902788&amp;x-signature=o%2F5mUsr7mwhVAK4cfS84oJOSX4Y%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-0">学习资源推荐</h2>
<p>如果你想更深入地学习大模型，以下是一些非常有价值的学习资源，这些资源将帮助你从不同角度学习大模型，提升你的实践能力。</p>
<blockquote>
<p>本文较长，建议点赞收藏。更多AI大模型应用开发学习视频及资料，在<a href="https://link.juejin.cn?target=https%3A%2F%2Fhy.zhipoai.cn%2F" target="_blank" title="https://hy.zhipoai.cn/" ref="nofollow noopener noreferrer">智泊AI</a>。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[学妹给我 100，帮她分析个网站？]]></title>    <link>https://juejin.cn/post/7577313637950799881</link>    <guid>https://juejin.cn/post/7577313637950799881</guid>    <pubDate>2025-11-28T03:00:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577313637950799881" data-draft-id="7577300470520479753" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="学妹给我 100，帮她分析个网站？"/> <meta itemprop="keywords" content="数据分析,程序员,后端"/> <meta itemprop="datePublished" content="2025-11-28T03:00:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员鱼皮"/> <meta itemprop="url" content="https://juejin.cn/user/2444938365386621"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            学妹给我 100，帮她分析个网站？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2444938365386621/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员鱼皮
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-28T03:00:35.000Z" title="Fri Nov 28 2025 03:00:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>学妹问我：鱼皮 gie gie，你们团队这么多网站产品，都是怎么做数据分析的啊？</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/66f31d6051214ef680ed5e6f8c98e2dd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764903635&amp;x-signature=bpkcnF1u9As6UZHuapP2nH7kJRw%3D" alt="" loading="lazy"/></p>
<p>其实有很多现成的免费资源，可以让你不费吹灰之力搞定各种数据分析场景。</p>
<ul>
<li>网站流量统计</li>
<li>前端错误监控</li>
<li>用户行为分析</li>
<li>自定义业务分析</li>
<li>后端应用监控分析</li>
<li>后端资源监控分析</li>
<li>后端自定义指标分析</li>
</ul>
<p>干货较多，建议收藏~</p>
<blockquote>
<p>⭐️ 推荐观看视频版：<a href="https://link.juejin.cn?target=https%3A%2F%2Fbilibili.com%2Fvideo%2FBV1CkUDBiEMR" target="_blank" title="https://bilibili.com/video/BV1CkUDBiEMR" ref="nofollow noopener noreferrer">bilibili.com/video/BV1Ck…</a></p>
</blockquote>
<h2 data-id="heading-0">网站分析保姆级教程</h2>
<p>先说说最基础的 <strong>网站流量分析</strong>。你肯定想知道每天有多少人访问你的网站、他们从哪来、在哪个页面待得最久对吧？</p>
<p>可以使用百度统计、51.LA 网站统计或 Google Analytics，只需要给你的网站文件添加一段代码就能轻松接入。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c3570ab7871a434593048525cdf93600~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764903635&amp;x-signature=ZicuMhHut9%2BGEv3Uh3mHRYsH9EY%3D" alt="" loading="lazy"/></p>
<p>然后就能看到访客数量和趋势、分析访客的来源、分析页面的访问情况等等：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/93f9be1d979946d5b7ef64fb3fefa8cc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764903635&amp;x-signature=xksYKV4GXOFkAE9gwinkc5Ot%2FUk%3D" alt="" loading="lazy"/></p>
<p>可以帮你了解用户的偏好、获取页面优化的思路。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/16fc4bf2f46740fea5d54294822c9f2c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764903635&amp;x-signature=D5k3Qsgd8WU%2B89k2QnbS5%2Fv5HIc%3D" alt="" loading="lazy"/></p>
<p>如果你做的是小程序，那就更简单了，比如微信小程序直接用官方自带的数据分析就行。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c9dac3baba2c4f60a47d247704668582~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764903635&amp;x-signature=tEdsaCv739jiM4JiEl5tsEgEhvM%3D" alt="" loading="lazy"/></p>
<p>如果你想分析别人的网站流量，怎么办呢？</p>
<p>可以用 Similarweb 或者 AI TDK 这类工具，输入网址就能看到对方的流量估算、访问来源和热门关键词，做竞品分析和 SEO 搜索引擎优化的时候特别好用。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/27fee66d377b49c8b3ec9c7f735b03ed~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764903635&amp;x-signature=6ipQnl5D1aX4YCPWo1VhrmAfpTY%3D" alt="" loading="lazy"/></p>
<p>光知道用户的正常使用情况还不够，万一你的网站按钮点不动了，用户那边疯狂报错，你这儿却一无所知，那就尴尬了，说不定会影响收入！所以 <strong>前端错误监控</strong> 必不可少。</p>
<p>Sentry 是业界主流的开源前端监控，它能帮你捕获和统计各种代码报错。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5af09fd24cc8498ca8ec75403da33281~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764903635&amp;x-signature=bOLZoFaW3WqIhiAzNv8o2WjhKZI%3D" alt="" loading="lazy"/></p>
<p>还能记录用户的系统环境和具体报错信息，便于你排查和修复 Bug。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d6e0d93b594443a9a23c8699a2870e4f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764903635&amp;x-signature=n%2Fu%2BK52EuRlD4lrexzLu7kpmsjE%3D" alt="" loading="lazy"/></p>
<p>不过免费版存在限制，或者得自己搭建服务器部署开源代码。所以我们团队用的是国内的灵雀应用监控，也是一段代码就能接入，能够实时捕获前端的各种异常报错，查看具体的错误信息等等。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/44f2f804aabf4fb6b07f1ebbddf9ded9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764903635&amp;x-signature=z%2FvwnJZZdJDpRtwXNFQHMLomk4M%3D" alt="" loading="lazy"/></p>
<p>有时候光知道哪里出错了还不够，你还想知道用户到底是怎么操作的？为什么会触发这个错误？或者为什么用户不愿意付费？这时候就得上 <strong>用户行为分析</strong> 工具了。</p>
<p>我直接掏出微软 100% 免费的 Clarity，能录制用户的真实操作回放。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/331db7299abf47e280e93b1700d2c6aa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764903635&amp;x-signature=PmFY%2FLkw6HZlKcDnns229uY%2F5mM%3D" alt="" loading="lazy"/></p>
<p>像我们团队的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fai.mianshiya.com%2F" target="_blank" title="https://ai.mianshiya.com/" ref="nofollow noopener noreferrer">模拟面试产品 - 面多多</a> 就在用它，用户点击了哪里、滚动到哪里、在哪个按钮上犹豫不决，全都一清二楚。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0e57323e714a411f8dbd7f021bf732c9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764903635&amp;x-signature=0q8Y%2FbahJSVpDQpFwdm0YfdETts%3D" alt="" loading="lazy"/></p>
<p>还能通过热度地图快速分析用户的喜好，从而帮助优化产品功能按钮的布局，降低产品的使用难度，发现很多凭空根本想不到的问题。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eb34de0a0d274ec09f4c9b12ed6c12a0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764903635&amp;x-signature=SD9fhX4%2FhkdYcIQSaIUPSsjkq9I%3D" alt="" loading="lazy"/></p>
<p>前面说的这些工具提供的都是通用指标，但每个产品的业务逻辑不一样，有些你特别关心的数据，比如付费转化率、功能使用频次等，光靠现成工具可能拿不到，这时候就得上 <strong>自定义业务分析</strong> 了。</p>
<p>刚开始我有点想当然，直接就为一些大家耳熟能详的商业 BI 产品付费了，但后来发现对于小团队来说，其实没必要花那个钱，直接搭建开源的 DataEase 或 Superset 就挺香的，可以对接 MySQL 数据库等各种自己业务的数据源，然后根据需求来配置、拖拖拽拽就能做出各种可视化图表和看板。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c75ac6deff254b2194024fbc70e4baec~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764903635&amp;x-signature=zZyIe5unEhWbTsPgmAgGuGc97Wg%3D" alt="" loading="lazy"/></p>
<p>实在碰到特别个性化的需求，还可以自己搭建看板。现在有了 AI 加持，配合 ECharts 图表库，写几句提示词就能生成可视化看板，真的轻松多了。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8ca3ad41d26a460dbc12a72c379777d7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764903635&amp;x-signature=sbn%2Bxj1T745F3lW3Q%2B4LewQGoc4%3D" alt="" loading="lazy"/></p>
<p>说完前端，咱后端的数据分析也不能落下啊。</p>
<p>用户访问你的网站，背后都是一个个接口在提供数据，怎么知道接口是否正常？有没有优化空间呢？这时就需要后端的 <strong>应用监控分析</strong> 了。</p>
<p>像我们团队在用 ARMS 应用实时监控服务，能帮你全面监控应用的性能，快速发现出错或者速度较慢的接口。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/799e4bc7af6a4565b0fe8e84f42a5169~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764903635&amp;x-signature=Z2U1%2Bpa61h79bdEm3I53h9hQ1iU%3D" alt="" loading="lazy"/></p>
<p>还能进一步查看错误详情，甚至是分析接口的完整调用链，能快速定位问题。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/db27d4b6371e46ef9c3408ab77b3ed73~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764903635&amp;x-signature=QjztRgD%2Bc5qeaHI4dEtdq1PX7Ko%3D" alt="" loading="lazy"/></p>
<p>除了应用层面，服务器、数据库、缓存这些 <strong>资源的监控分析</strong> 也很重要，如果它们都跑在云上，那就直接用云服务商自带的监控看板就行，各种指标一目了然。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d050b3da59774de1987ee201c05c7775~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764903635&amp;x-signature=plckSx0ZZQqSv2f2bPOfVRlJdTo%3D" alt="" loading="lazy"/></p>
<p>要是你想统一监控分析更个性化的指标，那就得请出 Prometheus + Grafana 这对王炸组合了。Prometheus 负责采集各种自定义指标数据，为开发者带来监控的火种。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/406bef799fb24d75b0c8421c298745be~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764903635&amp;x-signature=NSeERDgZnNa%2FWxnpRVZpBGSIbNI%3D" alt="" loading="lazy"/></p>
<p>Grafana 则负责把这些数据变成炫酷的可视化大屏。看着一堆实时变化的图表，我仿佛掌控着整个系统的脉搏，恍惚间有种成为科幻电影里男猪脚的感觉~</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d982a20281504800b14a4fdff51cf24e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764903635&amp;x-signature=ZvnoGh8Q%2BuFJsCM7mzs4i5kJrdo%3D" alt="" loading="lazy"/></p>
<hr/>
<p>OK 就分享到这里，其实还有很多不错的开源项目，比如 SkyWalking、Zipkin 来管理应用性能，ELK 来集中分析日志等等。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e60cfd7dd553426eb300dccd07d89fce~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764903635&amp;x-signature=8zl%2ByBxUj099lNsVR43OgTiCdsA%3D" alt="" loading="lazy"/></p>
<p>有了这些工具，网站数据分析其实没有那么复杂，关键是要根据需求选择合适的方案，把时间省下来做产品才是正道。</p>
<p>如果本文对你有帮助，点个赞吧，感激不尽！</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2b8b302153834996ab11545f6037a075~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764903635&amp;x-signature=IpO3vtoO%2FEuI%2BOaDZvWt0d8G%2FXg%3D" alt="求点赞" loading="lazy"/></p>
<h2 data-id="heading-1">更多</h2>
<p>💻 编程学习交流：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fliyupi%2Fcode-nav" target="_blank" title="https://github.com/liyupi/code-nav" ref="nofollow noopener noreferrer">编程导航</a> 📃 简历快速制作：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fliyupi%2Flaoyujianli" target="_blank" title="https://github.com/liyupi/laoyujianli" ref="nofollow noopener noreferrer">老鱼简历</a> ✏️ 面试刷题神器：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fliyupi%2Fmianshiya" target="_blank" title="https://github.com/liyupi/mianshiya" ref="nofollow noopener noreferrer">面试鸭</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Eino AI 实战： Eino 的文档加载与解析]]></title>    <link>https://juejin.cn/post/7577284771447210024</link>    <guid>https://juejin.cn/post/7577284771447210024</guid>    <pubDate>2025-11-28T03:03:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577284771447210024" data-draft-id="7577226553286246435" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Eino AI 实战： Eino 的文档加载与解析"/> <meta itemprop="keywords" content="后端,Go"/> <meta itemprop="datePublished" content="2025-11-28T03:03:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="码一行"/> <meta itemprop="url" content="https://juejin.cn/user/2963939081856328"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Eino AI 实战： Eino 的文档加载与解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2963939081856328/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    码一行
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-28T03:03:23.000Z" title="Fri Nov 28 2025 03:03:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1:first-child,.markdown-body h2:first-child,.markdown-body h3:first-child,.markdown-body h4:first-child,.markdown-body h5:first-child,.markdown-body h6:first-child{margin-top:-1.5rem;margin-bottom:1rem}.markdown-body h1:before,.markdown-body h2:before,.markdown-body h3:before,.markdown-body h4:before,.markdown-body h5:before,.markdown-body h6:before{content:"#";display:inline-block;color:#3eaf7c;padding-right:.23em}.markdown-body h1{position:relative;font-size:2.5rem;margin-bottom:5px}.markdown-body h1:before{font-size:2.5rem}.markdown-body h2{padding-bottom:.5rem;font-size:2.2rem;border-bottom:1px solid #ececec}.markdown-body h3{font-size:1.5rem;padding-bottom:0}.markdown-body h4{font-size:1.25rem}.markdown-body h5{font-size:1rem}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body strong{color:#3eaf7c}.markdown-body img{max-width:100%;border-radius:2px;display:block;margin:auto;border:3px solid rgba(62,175,124,.2)}.markdown-body hr{border:none;border-top:1px solid #3eaf7c;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;overflow-x:auto;padding:.2rem .5rem;margin:0;color:#3eaf7c;font-weight:700;font-size:.85em;background-color:rgba(27,31,35,.05);border-radius:3px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border-radius:6px;border:2px solid #3eaf7c}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{font-weight:500;text-decoration:none;color:#3eaf7c}.markdown-body a:active,.markdown-body a:hover{border-bottom:1.5px solid #3eaf7c}.markdown-body a:before{content:"⇲"}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #3eaf7c}.markdown-body thead{background:#3eaf7c;color:#fff;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(62,175,124,.2)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:.5rem solid;border-color:#42b983;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body details{outline:none;border:none;border-left:4px solid #3eaf7c;padding-left:10px;margin-left:4px}.markdown-body details summary{cursor:pointer;border:none;outline:none;background:#fff;margin:0 -17px}.markdown-body details summary::-webkit-details-marker{color:#3eaf7c}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body ol li::marker{color:#3eaf7c}.markdown-body ul li{list-style:none}.markdown-body ul li:before{content:"•";margin-right:4px;color:#3eaf7c}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><ol>
<li>
<h2 data-id="heading-0"><strong>基本介绍</strong></h2>
</li>
</ol>
<p><code>Document Loader</code> 是一个用于加载文档的组件。它的主要作用是从不同来源（如网络 URL、本地文件等）加载文档内容，并将其转换为标准的文档格式。这个组件在处理需要从各种来源获取文档内容的场景中发挥重要作用，比如:</p>
<ul>
<li>从网络 URL 加载网页内容</li>
<li>读取本地 PDF、Word 等格式的文档</li>
</ul>
<ol start="2">
<li>
<h2 data-id="heading-1"><strong>组件定义</strong></h2>
</li>
</ol>
<h4 data-id="heading-2"><strong>2.1 接口定义</strong></h4>
<blockquote>
<p>代码位置：<strong>eino/components/document/interface.go</strong></p>
</blockquote>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">type</span> Loader <span class="hljs-keyword">interface</span> {
    Load(ctx context.Context, src Source, opts ...LoaderOption) ([]*schema.Document, <span class="hljs-type">error</span>)
}
</code></pre>
<h4 data-id="heading-3"><strong>2.2 Load 方法</strong></h4>
<ul>
<li>
<p>功能：从指定的数据源加载文档</p>
</li>
<li>
<p>参数：</p>
<ul>
<li><code>ctx</code>：上下文对象，用于传递请求级别的信息，同时也用于传递 Callback Manager</li>
<li><code>src</code>：文档来源，包含文档的 URI 信息</li>
<li><code>opts</code>：加载选项，用于配置加载行为</li>
</ul>
</li>
<li>
<p>返回值：</p>
<ul>
<li><code>[]*schema.Document</code>：加载的文档列表</li>
<li><code>error</code>：加载过程中的错误信息</li>
</ul>
</li>
</ul>
<h4 data-id="heading-4"><strong>2.3 Source 结构体</strong></h4>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">type</span> Source <span class="hljs-keyword">struct</span> {
    URI <span class="hljs-type">string</span>
}
</code></pre>
<p><code>Source</code> 结构体定义了文档的来源信息：</p>
<ul>
<li><code>URI</code>：文档的统一资源标识符，可以是网络 URL 或本地文件路径</li>
</ul>
<h4 data-id="heading-5"><strong>2.4 Document 结构体</strong></h4>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">type</span> Document <span class="hljs-keyword">struct</span> {
    <span class="hljs-comment">// ID 是文档的唯一标识符</span>
    ID <span class="hljs-type">string</span>
    <span class="hljs-comment">// Content 是文档的内容</span>
    Content <span class="hljs-type">string</span>
    <span class="hljs-comment">// MetaData 用于存储文档的元数据信息</span>
    MetaData <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]any
}
</code></pre>
<p><code>Document</code> 结构体是文档的标准格式，包含以下重要字段：</p>
<ul>
<li>
<p><code>ID</code>：文档的唯一标识符，用于在系统中唯一标识一个文档</p>
</li>
<li>
<p><code>Content</code>：文档的实际内容</p>
</li>
<li>
<p><code>MetaData</code>：文档的元数据，可以存储如下信息：</p>
<ul>
<li>文档的来源信息</li>
<li>文档的向量表示（用于向量检索）</li>
<li>文档的分数（用于排序）</li>
<li>文档的子索引（用于分层检索）</li>
<li>其他自定义元数据</li>
</ul>
</li>
</ul>
<h4 data-id="heading-6"><strong>2.5 公共选项</strong></h4>
<ul>
<li><code>Loader</code> 组件使用 <code>LoaderOption</code> 来定义加载选项。</li>
<li><code>Loader</code> 目前没有公共的 <code>Option</code>，每个具体的实现可以定义自己的特定选项，通过 <code>WrapLoaderImplSpecificOptFn</code> 函数包装成统一的 <code>LoaderOption</code> 类型。</li>
</ul>
<ol start="3">
<li>
<h2 data-id="heading-7"><strong>应用</strong></h2>
</li>
</ol>
<h4 data-id="heading-8"><strong>3.1 本地文件加载 (Loader - local file)</strong></h4>
<blockquote>
<p>代码位置：<strong>eino-ext/components/document/loader/f</strong> <strong>ile/file_loader.go</strong></p>
</blockquote>
<p>配置参数说明：</p>
<ul>
<li><code>UseNameAsID</code>：是否将文件名用作文档 ID</li>
<li><code>Parser</code>：文档解析器，如果不指定则使用默认的扩展名解析器（ExtParser，当前仅实现了 <code>TextParser</code>）</li>
</ul>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
        <span class="hljs-string">"context"</span>
        <span class="hljs-string">"github.com/cloudwego/eino-ext/components/document/loader/file"</span>
        <span class="hljs-string">"github.com/cloudwego/eino/components/document"</span>
        <span class="hljs-string">"github.com/cloudwego/eino/components/document/parser"</span>
        <span class="hljs-string">"log"</span>
)

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
        ctx := context.Background()

        <span class="hljs-comment">// 本地文件</span>
        loader, _ := file.NewFileLoader(ctx, &amp;file.FileLoaderConfig{
                UseNameAsID: <span class="hljs-literal">true</span>,
                Parser:      &amp;parser.TextParser{}, <span class="hljs-comment">// 可选：指定自定义解析器</span>
        })
        filePath := <span class="hljs-string">"./file_data/Go 1.24震撼发布！这些新特性你必须知道！.md"</span>
        docs, err := loader.Load(ctx, document.Source{
                URI: filePath,
        })
        <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
                <span class="hljs-built_in">panic</span>(err)
        }

        log.Printf(<span class="hljs-string">"doc content: %v"</span>, docs[<span class="hljs-number">0</span>].Content)

        <span class="hljs-keyword">for</span> _, doc := <span class="hljs-keyword">range</span> docs {
                <span class="hljs-built_in">println</span>(doc.Content) <span class="hljs-comment">// go1.25 的新特性，不需要 fmt.Println</span>
                <span class="hljs-built_in">println</span>(doc.ID)
                <span class="hljs-comment">// 访问元数据</span>
                <span class="hljs-built_in">println</span>(doc.MetaData[file.MetaKeyFileName])
                <span class="hljs-built_in">println</span>(doc.MetaData[file.MetaKeyExtension])
                <span class="hljs-built_in">println</span>(doc.MetaData[file.MetaKeySource])
        }
}
</code></pre>
<h4 data-id="heading-9"><strong>3.2 网络文件加载 (Loader - web url)</strong></h4>
<blockquote>
<p>代码位置：<strong>eino-ext/components/document/loader/url/url.go</strong></p>
</blockquote>
<p>配置参数说明：</p>
<ul>
<li><code>Parser</code>：文档解析器，默认使用 HTML 解析器，会提取网页正文内容</li>
<li><code>Client</code>：HTTP 客户端，可以自定义超时、代理等配置</li>
<li><code>RequestBuilder</code>：请求构建器，用于自定义请求方法、请求头等</li>
</ul>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"context"</span>
    <span class="hljs-string">"github.com/cloudwego/eino-ext/components/document/loader/url"</span>
    <span class="hljs-string">"github.com/cloudwego/eino/components/document"</span>
    <span class="hljs-string">"github.com/cloudwego/eino/components/document/parser"</span>
    <span class="hljs-string">"log"</span>
    <span class="hljs-string">"net/http"</span>
)

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    ctx := context.Background()
  
    <span class="hljs-comment">// 网络文件加载</span>
    loader, _ := url.NewLoader(ctx, &amp;url.LoaderConfig{
        Parser: &amp;parser.TextParser{},
        Client: &amp;http.Client{},
        RequestBuilder: <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(ctx context.Context, source document.Source, opts ...document.LoaderOption)</span></span> (*http.Request, <span class="hljs-type">error</span>) {
          <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, <span class="hljs-literal">nil</span>
        },
    })
  
    docs, err := loader.Load(ctx, document.Source{
        URI: <span class="hljs-string">"https://www.alipan.com/s/kKxyyXhjckz"</span>, <span class="hljs-comment">// 真实的 pdf 文档的地址</span>
    })
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        <span class="hljs-built_in">panic</span>(err)
    }

    log.Printf(<span class="hljs-string">"doc content: %v"</span>, docs[<span class="hljs-number">0</span>].Content)
    <span class="hljs-comment">// 使用文档内容</span>
    <span class="hljs-keyword">for</span> _, doc := <span class="hljs-keyword">range</span> docs {
        <span class="hljs-built_in">println</span>(doc.Content)
    }
}
</code></pre>
<h4 data-id="heading-10"><strong>3.3 解析 PDF 为纯文本 （Parser - pdf）</strong></h4>
<blockquote>
<p>代码位置：<strong>eino-ext/components/document/parser/pdf.pdf.go</strong></p>
</blockquote>
<p>配置参数说明：</p>
<ul>
<li><code>ToPages</code>：是否将 PDF 按页面分割成多个文档，默认为 false</li>
</ul>
<p>解析选项：</p>
<ul>
<li>支持通过 <code>parser.WithURI</code> 设置文档 URI</li>
<li>支持通过 <code>parser.WithExtraMeta</code> 添加额外元数据</li>
</ul>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
        <span class="hljs-string">"context"</span>
        <span class="hljs-string">"log"</span>
        <span class="hljs-string">"os"</span>

        <span class="hljs-string">"github.com/cloudwego/eino-ext/components/document/parser/pdf"</span>
)

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
        ctx := context.Background()

        parser, _ := pdf.NewPDFParser(ctx, &amp;pdf.Config{
                ToPages: <span class="hljs-literal">false</span>, <span class="hljs-comment">// 是否按页面分割文档</span>
        })

        file, err := os.Open(<span class="hljs-string">"./file_data/2021-09《我们为什么控制不了自己》.pdf"</span>)
        <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
                log.Fatal(err)
        }

        <span class="hljs-keyword">defer</span> file.Close()

        <span class="hljs-comment">// 解析文档</span>
        docs, err := parser.Parse(ctx, file)
        <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
                log.Fatal(err)
        }

        <span class="hljs-comment">// 打印解析结果</span>
        <span class="hljs-keyword">for</span> _, doc := <span class="hljs-keyword">range</span> docs {
                <span class="hljs-built_in">println</span>(doc.Content)
        }
}
</code></pre>
<h4 data-id="heading-11"><strong>3.4 解析 HTML 为纯文本</strong></h4>
<blockquote>
<p>代码位置：<strong>eino-ext/components/document/parser/html/html.go</strong></p>
</blockquote>
<p>配置参数说明：</p>
<ul>
<li>
<p><code>Selector</code>：可选参数，指定要提取的内容区域，使用 <code>goquery</code> 选择器语法</p>
<ul>
<li>例如：body 表示提取 标签内容</li>
<li><code>#content</code> 表示提取 id 为 “content” 的元素内容</li>
</ul>
</li>
</ul>
<p>解析器会自动提取以下 <strong>metadata</strong>：</p>
<ul>
<li><code>html.MetaKeyTitle</code> ("_title")：网页标题</li>
<li><code>html.MetaKeyDesc</code> ("_description")：网页描述</li>
<li><code>html.MetaKeyLang</code> ("_language")：网页语言</li>
<li><code>html.MetaKeyCharset</code> ("_charset")：字符编码</li>
<li><code>html.MetaKeySource</code> ("_source")：文档来源 URI</li>
</ul>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
        <span class="hljs-string">"context"</span>
        <span class="hljs-string">"fmt"</span>
        <span class="hljs-string">"strings"</span>

        <span class="hljs-string">"github.com/cloudwego/eino-ext/components/document/parser/html"</span>
)

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
        ctx := context.Background()

        <span class="hljs-comment">// 初始化解析器</span>
        p, err := html.NewParser(ctx, &amp;html.Config{
        Selector: <span class="hljs-string">"#content"</span>,   <span class="hljs-comment">// 选择器，指定只提取 id 为 content 的元素内容，默认为 body</span>
    }) <span class="hljs-comment">// 使用默认配置</span>
        <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
                <span class="hljs-built_in">panic</span>(err)
        }

        <span class="hljs-comment">// HTML 内容</span>
        document := <span class="hljs-string">`
    &lt;html lang="zh"&gt;
        &lt;head&gt;
            &lt;title&gt;示例页面&lt;/title&gt;
            &lt;meta name="description" content="这是一个示例页面"&gt;
            &lt;meta charset="UTF-8"&gt;
        &lt;/head&gt;
        &lt;body&gt;
            &lt;div id="content"&gt;
                &lt;h1&gt;欢迎&lt;/h1&gt;
                &lt;p&gt;这是正文内容。&lt;/p&gt;
            &lt;/div&gt;
        &lt;/body&gt;
    &lt;/html&gt;
    `</span>

        <span class="hljs-comment">// 解析文档</span>
        docs, err := p.Parse(ctx, strings.NewReader(document))
        <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
                <span class="hljs-built_in">panic</span>(err)
        }

        <span class="hljs-comment">// 使用解析结果</span>
        doc := docs[<span class="hljs-number">0</span>]
        fmt.Println(<span class="hljs-string">"内容:"</span>, doc.Content)
        fmt.Println(<span class="hljs-string">"标题:"</span>, doc.MetaData[html.MetaKeyTitle])
        fmt.Println(<span class="hljs-string">"描述:"</span>, doc.MetaData[html.MetaKeyDesc])
        fmt.Println(<span class="hljs-string">"语言:"</span>, doc.MetaData[html.MetaKeyLang])
}
</code></pre>
<ol start="4">
<li>
<h2 data-id="heading-12"><strong>总结</strong></h2>
</li>
</ol>
<blockquote>
<p>Eino 框架是字节跳动内部半年多的使用和迭代，基于 Go 的大模型应用综合开发框架</p>
</blockquote>
<p>介绍了 Eino: Components 组件中的 Document Loader 组件的用法</p>
<ul>
<li>本地文件加载</li>
<li>远程文件加载</li>
<li>解析 pdf</li>
<li>解析 html</li>
</ul>
<p>通过内部封装好的组件，可以更快、更高效的基实现大模型所具备的其中一个核心能力：</p>
<ul>
<li><strong>基于语义的文本处理能力</strong></li>
</ul>
<p>这项能力可以让开发者专注与业务逻辑的实现，避免重复造轮子，以快速构建高质量的大模型应用。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[vue项目中使用echarts做词云图]]></title>    <link>https://juejin.cn/post/7577222731790057498</link>    <guid>https://juejin.cn/post/7577222731790057498</guid>    <pubDate>2025-11-27T11:41:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577222731790057498" data-draft-id="7577222731790041114" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="vue项目中使用echarts做词云图"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-27T11:41:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小明记账簿_微信小程序"/> <meta itemprop="url" content="https://juejin.cn/user/1901536389893546"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            vue项目中使用echarts做词云图
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1901536389893546/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小明记账簿_微信小程序
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T11:41:55.000Z" title="Thu Nov 27 2025 11:41:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";@keyframes spin{0%{transform:rotate(0)}to{transform:rotate(1turn)}}.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#36ace1;background-image:linear-gradient(90deg,rgba(217,234,251,.25) 3%,transparent 0),linear-gradient(1turn,rgba(217,234,251,.25) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{color:#36ace1}.markdown-body h1:before,.markdown-body h2:before,.markdown-body h3:before,.markdown-body h4:before,.markdown-body h5:before,.markdown-body h6:before{content:"";display:block;position:absolute;left:0;top:0;bottom:0;margin:auto;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABwAAAAcCAYAAAByDd+UAAAF8UlEQVRIS71Wa2wUVRT+7r0zu9t2t/RBaSioPCpYbIUfaEIQUogSAwZDAlUSGwgg/CBATExMCJH1D2hIfOEjFEUEhViCgBgIUCH44OkjPAMGBVqhpUCfW3Zn5z7MuQOE0hYxMdxJdmd25s53vnO+851leMCLPWA8/CfA2TsvL8n7q+nTFfNLG+4VqInHOeJLDQMzdz/3r4DGGDb9lxu+aPcE7U61JHDMDePcuv0O21ShugOefqDdtBie3Dk6K/O+Ab+qOjJiz7Ahv6c8hbDDwRiQlgYGDOcaWyEcjg8On+j71IpJndjGt9XO+jM7+pkywNvbazIfercieSdoJ4bE5sWjyZqMpDdeaQNXMNC34ME3LV8B56+1w3AOgk+EXe/Ub6uiLB6XdH/G/mYjeBCcFwnt3zQqWt4t4NjjnhzQ1CGkBhwOCMFAB71U0qsYgRlwBtQ1tiEJAy44OBdQUmFK3aWS06NLT+ukZAQoKCCjsfbDmk6p78RwX3ncWffmIj8U4kh6GpEwh+9rGy23LDU4GBrrm9DsuDYIGMAYIC/EUNQ7Cq1hn+WM2TI8f+jEyCmvjfn1FssuojHx6tDkyZOaCzr8TNpASzDAk8amlRIrEylcSGsYrcGIstIYWhgDDIM2BiGH3ywFkGAC1U9n38bpVqWGdk6r4HMWrZZaG1D5KLn0qYyBEAKnG1otAxLR8L7Z9nfP13CJHQ/ST4vK8sVHe8JsU0U6uO5hlexo8PI7vNDQomwoBRAwpSmtgJAAztS3QLsOsmBQlBtFJMQhlbbPUBBUR7o2hqHVddLbRsfCPQJ+u3TPw8uGl1yklAlHIJZKo3//XEhlLCtifPFyM7xwCI/lZ8IKTTBbS7pPLIggZZsSQ+zXbT4UYSsnet3UMM5HPT5LGbrDGYQroClyT2Jwnyj9aN949e8mDCwuRFoqKxRHUJ21BSDRELuQYGhvbMVV32Dp2RuxcfHSRBfAYTsbU9nJdFj5EiLkglHkRInC1xoxKbH9hQJIaTDvxxTCUddWl4wg0dCCtqSPDmoVx4Eitpxh64ZtsT6b5ie6pPRkfF90TllxOzEwmipMKRRgHODGgCuJkqIcvDdC2BZ5Y+tlHHMzkAKghbAxcQqQDiKrFBxhqg5MHTivS1tQ+sdsvaQl5Yd6yfdRXNQLsQwXnq/AQFLXEIIjzBSuNaaR0SuEtkQKl9IKjAsbJaWfzo1USDsM6zceDJfeVGgnhhN2N7YOyo5kJz1pa2AbgfrO1gRwXW6vSRQNtddR+EhvKGmseskgTtY2Q7kucYWWgToPHzyUyXry0iXfnBtfl5f/PaWPvPNW/zkOAQegJHltFE5dSaCskHqPVEnqpMAMEgkPtR1pKxyh/N0/vTToubtH1G3RmLjhM8ubKXfWB2mRa9ySOaWS2uT8lTZ0cI6I52Ngv7zAbW9mQVm1cpytu441P38XeXTlQu+e46nyh+bjLkMZRU0MCYTCJWZSG1y7cBWNURpxBlxqFBfEwGnGGhaYPSNwhpSv4DK+/vPynBk9MqRIiOWs8a2WJTm9a+cgh6SaMIMz9W1WjYHHMtv0wSmZdWB9gdsya/rcYVg7JoffCdqlD6ceTpiY59tM0PhJp5WNvra+BQkejCMyBarr8KKYDcZi8sDaCDKYFIGRk+FnSVXzyTO9JxBwF8DLc1dlLn65ooNEYN0fBsu21fTvL6PXnhxXlnLIqqhYYBian4lQ2Lk9ogiALsimiLC1QYfhlV1Hnxh7JfcMqxrpd7U2GFa5t9nOd7Kr+kg4uWvnCpromlJeXlq3Os3ZLOlrZBmNQf1ybVqpxhbA7mRIOCy1+esDOWhIyDv/+3Q7LRbsqH+rKRJ+nba+/+WW7II1s9vvVBuNr7KNF1WUM1bSt5f1Vq01jUVkKfnx8uoti3Or5rbd9782M61azJz/rFywYU/OyKqK1p5G2MS1Z18tGFDwTkvIxcK9RwaMP3a9/tbc62lPj/Nw5B9ey9Ehy/MY4oEqelgNleuyCgdXJlmc3fO5Ll56r5f+n/f+AWFf9jvBgaHpAAAAAElFTkSuQmCC);animation:spin 2s linear 1s infinite}.markdown-body h1{position:relative;font-size:30px;padding:12px 38px;margin:30px 0}.markdown-body h1:before{width:30px;height:30px;background-size:30px 30px}.markdown-body h2{position:relative;font-size:24px;padding:12px 36px;margin:28px 0}.markdown-body h2:before{width:28px;height:28px;background-size:28px 28px}.markdown-body h3{position:relative;font-size:18px;padding:4px 32px;margin:26px 0}.markdown-body h3:before{width:24px;height:24px;background-size:24px 24px}.markdown-body h4{position:relative;padding:4px 28px;font-size:16px;margin:22px 0}.markdown-body h4:before{width:20px;height:20px;background-size:20px 20px}.markdown-body h5{position:relative;padding:4px 26px;font-size:15px;margin:20px 0}.markdown-body h5:before{width:18px;height:18px;background-size:18px 18px}.markdown-body h6{position:relative;padding:4px 22px;font-size:14px;margin:16px 0}.markdown-body h6:before{width:16px;height:16px;background-size:16px 16px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;border:none;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,#36ace1,#dff0fe,#36ace1);overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:50px;height:24px;background:#fff;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABoAAAAaCAYAAACpSkzOAAAEgElEQVRIS72Va0xbZRjH/z2FcimbchEQFDYRCIRAAWFQ2MaCXBwmUxYDLGGEcRFkH9wmk04zG0Bo2dwNIisERANqhjqdEmhd4nRbuwpsXDYWLLoRgeG4Chu9QHvMOQ0dpTAKH3y/tDnv8/5/z/Oc//scBv6nxdgoJ14gVYPEuITHdTdHY12gRIH0T0KljlqwthqUFHGtzAEsxqwLtPvkdc+FeeI3BgMeAMEhdOqR1mM7xswBrgmKE8pfIUhtm7fbZsft/i7wc98MtrUFxmbU6ByYgFwxjtFp5Q+WpF1mCy9wajXoqqD4E91saOf603e+5B7t99xTkyZJEiKJAl2DE9Xio1HvrBS8IuhVwVUP503swdJ9QWAw1izaoDs6pQT/655BMS9yy3KYiUoM/7adu7NmtnQfx5zWm8Q8Ui3gyGcddyU8rv/STRNQouDGP5/mhTubX4dpPv3DMzh1qS9LwuPWr+i63WVyn5QYj/4d/i4bqmbpoQ+auvBlQYghX6PE4wTSOzV5EUYlb5Q4MDqLk9/3cMRF27spDSNQamUnWZ4ebNB+OKNCyYVeFCZ5wZ5tiePN/UiP2YoQL0cUX+iFt4sNUiLdcaVvHJLecQiWnKVE8s5LvxAXRWeYgHLre0hecgAN0sxr0XBZgbJUP6OiLnaM4ivZCBrzOWBZEIY9rY5E8pl2nM0KMzzLq5aPiXmRzgbQm2VyR8KGGK/ICAFB6IusbvsDwhRf+n/jtSHc/nsGgjR9V6/1TyLa1wGU+FtnO1CbHQTHTSzIFJOYJ1jwcGLTccMTcyhp7oW4KFJ/SV4/IScrc55kQj07WNuOn94Lpw8kCm/Qv3W5HLjbWxsyfuNUO1TzWjAJBloKt2FBS+Jz6ShiA12NupBdLWugQcmn28lPMkONNql3U5cTSD9Lq+qEUqPFt++G0aKL687wDAqb+pAU7IKCuK2493AOPQ9UCNpib6T1tkg+RZ9KKJcNn8sJc1vac8o16jklLWLuOiDqwvHUIKPw7vtTON+iCDKkl/Cx9FeSYET5um1mHt6jN0Dz9ftwYjORudNjTdaBmi7kxvvA1d6Gjs0X/Q5Sp3tMEMSHre9HnDEZAPFCWUNVdliGJVPvqEP1Hbh4yPj9LadSY6fu6gPsCX+B3mq7NYLv2od8fj4aoViMNQGFijos/XVMTXGavgUisQIle71hwVx9KFEutLVjw8GORTuxoEbeJS7iPrmQyy/sIj2hQpqYHO7ZGs95nnZS4y8K8Pfqrb58UZ+IlKqbqNgfQm8da+pC9xjLqo8foFkau2qaCeXSyvzXfA9SDrp1bxJ/DU/jSJKXEWdBR2J/9U0UpwXTFZ/+8S76h/71FvO4A8sTeuqQThDKalOiPLN3BbhiYlaNsm964elkCztrC4xMqeDqYIus2JdB3cbS5l4MTag44qJt9GxbF4gKThRKY59lW13+KCUQ1pZMEwHKviKx4pFSqXzxCn/X9Gr2NO+zw+cTiTbxmUyCqH3GlsWg2kRNhOnHmhlrFkIvHTZt1borWvMCmRnwH4usn58STiycAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center}.markdown-body del{color:#36ace1}.markdown-body code{font-family:Menlo,Monaco,Consolas,Courier New,monospace;word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#282c34;color:#4ec9b0;padding:.24em .46em;margin:0 4px}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-family:Menlo,Monaco,Consolas,Courier New,monospace;font-size:12px;border-radius:10px;padding:15px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#4ec9b0;background:#282c34}.markdown-body a{text-decoration:none;color:#409eff;border-bottom:1px solid #409eff}.markdown-body a:active,.markdown-body a:hover{color:#007bff;border-bottom:1px solid #007bff}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{position:relative;padding:8px 26px;background-color:rgba(54,172,225,.75);margin:16px 0;border-left:4px solid #409eff;border-radius:5px}.markdown-body blockquote:before{content:"❝";top:10px;left:8px;color:#409eff;font-size:20px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:20px;position:absolute;right:8px;bottom:0;color:#409eff;opacity:.7}.markdown-body blockquote&gt;p{color:#fff}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dc8363689561412398bfd4694b8f9ec3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5piO6K6w6LSm57C_X-W-ruS_oeWwj-eoi-W6jw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764848514&amp;x-signature=jglucbl%2BumMP78lQGcFIBvbMj%2FA%3D" alt="" loading="lazy"/></p>
<blockquote>
<p>安装依赖 </p>
</blockquote>
<pre><code class="hljs language-js" lang="js">npm install echarts
npm i echarts-wordcloud
</code></pre>
<blockquote>
<p>完整代码</p>
</blockquote>
<pre><code class="hljs language-js" lang="js">&lt;template&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"chart-container"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
&lt;/template&gt;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> echarts <span class="hljs-keyword">from</span> <span class="hljs-string">"echarts"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">"echarts-wordcloud"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">chart</span>: <span class="hljs-literal">null</span>,
    };
  },
  <span class="hljs-title function_">mounted</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">initChart</span>();
  },
  <span class="hljs-title function_">beforeDestroy</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">chart</span>) {
      <span class="hljs-keyword">return</span>;
    }
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">chart</span>.<span class="hljs-title function_">dispose</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">chart</span> = <span class="hljs-literal">null</span>;
  },
  <span class="hljs-attr">methods</span>: {
    <span class="hljs-title function_">initChart</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">chart</span> = echarts.<span class="hljs-title function_">init</span>(<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">"chart-container"</span>));
      <span class="hljs-keyword">var</span> keywords = [];
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> index = <span class="hljs-number">0</span>; index &lt; <span class="hljs-number">20</span>; index++) {
        <span class="hljs-keyword">let</span> random = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">100</span>);
        keywords.<span class="hljs-title function_">push</span>({
          <span class="hljs-attr">name</span>: random,
          <span class="hljs-attr">value</span>: random,
        });
      }
      <span class="hljs-keyword">var</span> option = {
        <span class="hljs-attr">series</span>: [
          {
            <span class="hljs-attr">type</span>: <span class="hljs-string">"wordCloud"</span>,
            <span class="hljs-attr">sizeRange</span>: [<span class="hljs-number">12</span>, <span class="hljs-number">60</span>],
            <span class="hljs-attr">rotationRange</span>: [-<span class="hljs-number">90</span>, <span class="hljs-number">90</span>],
            <span class="hljs-attr">rotationStep</span>: <span class="hljs-number">45</span>,
            <span class="hljs-attr">gridSize</span>: <span class="hljs-number">15</span>,
            <span class="hljs-attr">shape</span>: <span class="hljs-string">"pentagon"</span>,
            <span class="hljs-attr">width</span>: <span class="hljs-string">"100%"</span>,
            <span class="hljs-attr">height</span>: <span class="hljs-string">"100%"</span>,
            <span class="hljs-attr">drawOutOfBound</span>: <span class="hljs-literal">true</span>,
            <span class="hljs-attr">textStyle</span>: {
              <span class="hljs-attr">color</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
                <span class="hljs-keyword">return</span> (
                  <span class="hljs-string">"rgb("</span> +
                  [
                    <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">round</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">160</span>),
                    <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">round</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">160</span>),
                    <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">round</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">160</span>),
                  ].<span class="hljs-title function_">join</span>(<span class="hljs-string">","</span>) +
                  <span class="hljs-string">")"</span>
                );
              },
            },
            <span class="hljs-attr">emphasis</span>: {
              <span class="hljs-attr">textStyle</span>: {
                <span class="hljs-attr">shadowBlur</span>: <span class="hljs-number">10</span>,
                <span class="hljs-attr">shadowColor</span>: <span class="hljs-string">"#333"</span>,
                <span class="hljs-attr">color</span>: <span class="hljs-string">"red"</span>,
              },
            },
            <span class="hljs-attr">data</span>: keywords,
          },
        ],
      };
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">chart</span>.<span class="hljs-title function_">setOption</span>(option);
    },
  },
};
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">scoped</span>&gt;</span><span class="css">
<span class="hljs-selector-id">#chart-container</span> {
  <span class="hljs-attribute">height</span>: <span class="hljs-number">100%</span>;
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span></span>
</code></pre>
<blockquote>
<p>配置说明</p>
<p> <strong>shape</strong>：要绘制的“云”的形状。可以是表示为回调函数或存在的关键字。可用的礼物是circle</p>
<p>（默认），cardioid（苹果或心形曲线，最著名的极坐标方程），diamond(正方形）、triangle-forward、triangle（三角形）、star（星形）、pentagon （五边形）。</p>
<p><strong>maskImage</strong>：词云轮廓图，图片需转成base64。</p>
<p><strong>left、top、right、bottom</strong>：词云的位置，默认是 center。</p>
<p><strong>width、height</strong>：词云的宽高，默认是 75%、80%。</p>
<p><strong>sizeRange</strong>：词云的文字字号范围，默认是[12, 60]。</p>
<p><strong>rotationRange</strong>：文本旋转范围和步长。文本将通过旋转步骤45在[-90，90]范围内随机旋转。</p>
<p><strong>gridSize</strong>：每个词之间的间距。</p>
<p><strong>drawOutOfBound</strong>：是否允许词云在边界外渲染。</p>
<p><strong>textStyle</strong>：全局文本样式。</p>
<p><strong>emphasis</strong>：鼠标悬浮样式。</p>
<p><strong>data</strong>：数组，必须包含name、value属性，也可以有textStyle、emphasis等 <strong>。</strong></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[vue双向绑定原理Object.defineProperty分析]]></title>    <link>https://juejin.cn/post/7577237961638117385</link>    <guid>https://juejin.cn/post/7577237961638117385</guid>    <pubDate>2025-11-27T11:44:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577237961638117385" data-draft-id="7577237961638101001" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="vue双向绑定原理Object.defineProperty分析"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-27T11:44:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小明记账簿_微信小程序"/> <meta itemprop="url" content="https://juejin.cn/user/1901536389893546"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            vue双向绑定原理Object.defineProperty分析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1901536389893546/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小明记账簿_微信小程序
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T11:44:10.000Z" title="Thu Nov 27 2025 11:44:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";@keyframes spin{0%{transform:rotate(0)}to{transform:rotate(1turn)}}.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#36ace1;background-image:linear-gradient(90deg,rgba(217,234,251,.25) 3%,transparent 0),linear-gradient(1turn,rgba(217,234,251,.25) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{color:#36ace1}.markdown-body h1:before,.markdown-body h2:before,.markdown-body h3:before,.markdown-body h4:before,.markdown-body h5:before,.markdown-body h6:before{content:"";display:block;position:absolute;left:0;top:0;bottom:0;margin:auto;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABwAAAAcCAYAAAByDd+UAAAF8UlEQVRIS71Wa2wUVRT+7r0zu9t2t/RBaSioPCpYbIUfaEIQUogSAwZDAlUSGwgg/CBATExMCJH1D2hIfOEjFEUEhViCgBgIUCH44OkjPAMGBVqhpUCfW3Zn5z7MuQOE0hYxMdxJdmd25s53vnO+851leMCLPWA8/CfA2TsvL8n7q+nTFfNLG+4VqInHOeJLDQMzdz/3r4DGGDb9lxu+aPcE7U61JHDMDePcuv0O21ShugOefqDdtBie3Dk6K/O+Ab+qOjJiz7Ahv6c8hbDDwRiQlgYGDOcaWyEcjg8On+j71IpJndjGt9XO+jM7+pkywNvbazIfercieSdoJ4bE5sWjyZqMpDdeaQNXMNC34ME3LV8B56+1w3AOgk+EXe/Ub6uiLB6XdH/G/mYjeBCcFwnt3zQqWt4t4NjjnhzQ1CGkBhwOCMFAB71U0qsYgRlwBtQ1tiEJAy44OBdQUmFK3aWS06NLT+ukZAQoKCCjsfbDmk6p78RwX3ncWffmIj8U4kh6GpEwh+9rGy23LDU4GBrrm9DsuDYIGMAYIC/EUNQ7Cq1hn+WM2TI8f+jEyCmvjfn1FssuojHx6tDkyZOaCzr8TNpASzDAk8amlRIrEylcSGsYrcGIstIYWhgDDIM2BiGH3ywFkGAC1U9n38bpVqWGdk6r4HMWrZZaG1D5KLn0qYyBEAKnG1otAxLR8L7Z9nfP13CJHQ/ST4vK8sVHe8JsU0U6uO5hlexo8PI7vNDQomwoBRAwpSmtgJAAztS3QLsOsmBQlBtFJMQhlbbPUBBUR7o2hqHVddLbRsfCPQJ+u3TPw8uGl1yklAlHIJZKo3//XEhlLCtifPFyM7xwCI/lZ8IKTTBbS7pPLIggZZsSQ+zXbT4UYSsnet3UMM5HPT5LGbrDGYQroClyT2Jwnyj9aN949e8mDCwuRFoqKxRHUJ21BSDRELuQYGhvbMVV32Dp2RuxcfHSRBfAYTsbU9nJdFj5EiLkglHkRInC1xoxKbH9hQJIaTDvxxTCUddWl4wg0dCCtqSPDmoVx4Eitpxh64ZtsT6b5ie6pPRkfF90TllxOzEwmipMKRRgHODGgCuJkqIcvDdC2BZ5Y+tlHHMzkAKghbAxcQqQDiKrFBxhqg5MHTivS1tQ+sdsvaQl5Yd6yfdRXNQLsQwXnq/AQFLXEIIjzBSuNaaR0SuEtkQKl9IKjAsbJaWfzo1USDsM6zceDJfeVGgnhhN2N7YOyo5kJz1pa2AbgfrO1gRwXW6vSRQNtddR+EhvKGmseskgTtY2Q7kucYWWgToPHzyUyXry0iXfnBtfl5f/PaWPvPNW/zkOAQegJHltFE5dSaCskHqPVEnqpMAMEgkPtR1pKxyh/N0/vTToubtH1G3RmLjhM8ubKXfWB2mRa9ySOaWS2uT8lTZ0cI6I52Ngv7zAbW9mQVm1cpytu441P38XeXTlQu+e46nyh+bjLkMZRU0MCYTCJWZSG1y7cBWNURpxBlxqFBfEwGnGGhaYPSNwhpSv4DK+/vPynBk9MqRIiOWs8a2WJTm9a+cgh6SaMIMz9W1WjYHHMtv0wSmZdWB9gdsya/rcYVg7JoffCdqlD6ceTpiY59tM0PhJp5WNvra+BQkejCMyBarr8KKYDcZi8sDaCDKYFIGRk+FnSVXzyTO9JxBwF8DLc1dlLn65ooNEYN0fBsu21fTvL6PXnhxXlnLIqqhYYBian4lQ2Lk9ogiALsimiLC1QYfhlV1Hnxh7JfcMqxrpd7U2GFa5t9nOd7Kr+kg4uWvnCpromlJeXlq3Os3ZLOlrZBmNQf1ybVqpxhbA7mRIOCy1+esDOWhIyDv/+3Q7LRbsqH+rKRJ+nba+/+WW7II1s9vvVBuNr7KNF1WUM1bSt5f1Vq01jUVkKfnx8uoti3Or5rbd9782M61azJz/rFywYU/OyKqK1p5G2MS1Z18tGFDwTkvIxcK9RwaMP3a9/tbc62lPj/Nw5B9ey9Ehy/MY4oEqelgNleuyCgdXJlmc3fO5Ll56r5f+n/f+AWFf9jvBgaHpAAAAAElFTkSuQmCC);animation:spin 2s linear 1s infinite}.markdown-body h1{position:relative;font-size:30px;padding:12px 38px;margin:30px 0}.markdown-body h1:before{width:30px;height:30px;background-size:30px 30px}.markdown-body h2{position:relative;font-size:24px;padding:12px 36px;margin:28px 0}.markdown-body h2:before{width:28px;height:28px;background-size:28px 28px}.markdown-body h3{position:relative;font-size:18px;padding:4px 32px;margin:26px 0}.markdown-body h3:before{width:24px;height:24px;background-size:24px 24px}.markdown-body h4{position:relative;padding:4px 28px;font-size:16px;margin:22px 0}.markdown-body h4:before{width:20px;height:20px;background-size:20px 20px}.markdown-body h5{position:relative;padding:4px 26px;font-size:15px;margin:20px 0}.markdown-body h5:before{width:18px;height:18px;background-size:18px 18px}.markdown-body h6{position:relative;padding:4px 22px;font-size:14px;margin:16px 0}.markdown-body h6:before{width:16px;height:16px;background-size:16px 16px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;border:none;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,#36ace1,#dff0fe,#36ace1);overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:50px;height:24px;background:#fff;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABoAAAAaCAYAAACpSkzOAAAEgElEQVRIS72Va0xbZRjH/z2FcimbchEQFDYRCIRAAWFQ2MaCXBwmUxYDLGGEcRFkH9wmk04zG0Bo2dwNIisERANqhjqdEmhd4nRbuwpsXDYWLLoRgeG4Chu9QHvMOQ0dpTAKH3y/tDnv8/5/z/Oc//scBv6nxdgoJ14gVYPEuITHdTdHY12gRIH0T0KljlqwthqUFHGtzAEsxqwLtPvkdc+FeeI3BgMeAMEhdOqR1mM7xswBrgmKE8pfIUhtm7fbZsft/i7wc98MtrUFxmbU6ByYgFwxjtFp5Q+WpF1mCy9wajXoqqD4E91saOf603e+5B7t99xTkyZJEiKJAl2DE9Xio1HvrBS8IuhVwVUP503swdJ9QWAw1izaoDs6pQT/655BMS9yy3KYiUoM/7adu7NmtnQfx5zWm8Q8Ui3gyGcddyU8rv/STRNQouDGP5/mhTubX4dpPv3DMzh1qS9LwuPWr+i63WVyn5QYj/4d/i4bqmbpoQ+auvBlQYghX6PE4wTSOzV5EUYlb5Q4MDqLk9/3cMRF27spDSNQamUnWZ4ebNB+OKNCyYVeFCZ5wZ5tiePN/UiP2YoQL0cUX+iFt4sNUiLdcaVvHJLecQiWnKVE8s5LvxAXRWeYgHLre0hecgAN0sxr0XBZgbJUP6OiLnaM4ivZCBrzOWBZEIY9rY5E8pl2nM0KMzzLq5aPiXmRzgbQm2VyR8KGGK/ICAFB6IusbvsDwhRf+n/jtSHc/nsGgjR9V6/1TyLa1wGU+FtnO1CbHQTHTSzIFJOYJ1jwcGLTccMTcyhp7oW4KFJ/SV4/IScrc55kQj07WNuOn94Lpw8kCm/Qv3W5HLjbWxsyfuNUO1TzWjAJBloKt2FBS+Jz6ShiA12NupBdLWugQcmn28lPMkONNql3U5cTSD9Lq+qEUqPFt++G0aKL687wDAqb+pAU7IKCuK2493AOPQ9UCNpib6T1tkg+RZ9KKJcNn8sJc1vac8o16jklLWLuOiDqwvHUIKPw7vtTON+iCDKkl/Cx9FeSYET5um1mHt6jN0Dz9ftwYjORudNjTdaBmi7kxvvA1d6Gjs0X/Q5Sp3tMEMSHre9HnDEZAPFCWUNVdliGJVPvqEP1Hbh4yPj9LadSY6fu6gPsCX+B3mq7NYLv2od8fj4aoViMNQGFijos/XVMTXGavgUisQIle71hwVx9KFEutLVjw8GORTuxoEbeJS7iPrmQyy/sIj2hQpqYHO7ZGs95nnZS4y8K8Pfqrb58UZ+IlKqbqNgfQm8da+pC9xjLqo8foFkau2qaCeXSyvzXfA9SDrp1bxJ/DU/jSJKXEWdBR2J/9U0UpwXTFZ/+8S76h/71FvO4A8sTeuqQThDKalOiPLN3BbhiYlaNsm964elkCztrC4xMqeDqYIus2JdB3cbS5l4MTag44qJt9GxbF4gKThRKY59lW13+KCUQ1pZMEwHKviKx4pFSqXzxCn/X9Gr2NO+zw+cTiTbxmUyCqH3GlsWg2kRNhOnHmhlrFkIvHTZt1borWvMCmRnwH4usn58STiycAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center}.markdown-body del{color:#36ace1}.markdown-body code{font-family:Menlo,Monaco,Consolas,Courier New,monospace;word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#282c34;color:#4ec9b0;padding:.24em .46em;margin:0 4px}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-family:Menlo,Monaco,Consolas,Courier New,monospace;font-size:12px;border-radius:10px;padding:15px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#4ec9b0;background:#282c34}.markdown-body a{text-decoration:none;color:#409eff;border-bottom:1px solid #409eff}.markdown-body a:active,.markdown-body a:hover{color:#007bff;border-bottom:1px solid #007bff}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{position:relative;padding:8px 26px;background-color:rgba(54,172,225,.75);margin:16px 0;border-left:4px solid #409eff;border-radius:5px}.markdown-body blockquote:before{content:"❝";top:10px;left:8px;color:#409eff;font-size:20px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:20px;position:absolute;right:8px;bottom:0;color:#409eff;opacity:.7}.markdown-body blockquote&gt;p{color:#fff}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>最近在研究了一下vue的双向绑定原理，顺便做了一下笔记。vue的核心就是通过Object.defineProperty()方法设置set和get函数来实现数据的劫持,在数据变化时发布消息给订阅者,触发相应的监听回调。也就是说数据和视图同步,数据发生变化,视图跟着变化,视图变化,数据也随之发生改变;那么Object.defineProperty()到底是怎么实现的，接下来详细的说一下。</p>
</blockquote>
<blockquote>
<p>首先Object.defineProperty()需要三个参数（object , propName , descriptor）</p>
<p>1、object 对象 =&gt; 给谁加<br/>
2、propName 属性名 =&gt; 要加的属性的名字 【类型：String】<br/>
3、descriptor 属性描述 =&gt; 加的这个属性有什么样的特性【类型：Object】 </p>
<p>        1）configurable:表示能否通过delete删除属性从而重新定义属性，能否修改属性的特                性，或者能否把属性修改为访问器属性，默认值为true。</p>
<p>        2）enumerable：表示能否通过for in循环访问属性，默认值为true</p>
<p>        3）writable：表示能否修改属性的值。默认值为true。</p>
<p>        4）value：包含这个属性的数据值。默认值为undefined。</p>
</blockquote>
<p>接下来举几个例子来说明每个属性的使用</p>
<p>1、configurable:表示能否通过delete删除属性从而重新定义属性，能否修改属性的特性，或者能否把属性修改为访问器属性，默认值为true</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 可以删除star</span>
<span class="hljs-keyword">let</span> obj = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">"vue"</span>,
  <span class="hljs-attr">star</span>: <span class="hljs-string">"5"</span>
}
<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">defineProperty</span>(obj, <span class="hljs-string">"star"</span>, {
  <span class="hljs-attr">configurable</span>: <span class="hljs-literal">true</span>
})
<span class="hljs-keyword">delete</span> obj.<span class="hljs-property">star</span>;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(obj.<span class="hljs-property">star</span>); <span class="hljs-comment">// undefined</span>
</code></pre>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 不可以删除star</span>
<span class="hljs-keyword">let</span> obj = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">"vue"</span>,
  <span class="hljs-attr">star</span>: <span class="hljs-string">"5"</span>
}
<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">defineProperty</span>(obj, <span class="hljs-string">"star"</span>, {
  <span class="hljs-attr">configurable</span>: <span class="hljs-literal">false</span>
})
<span class="hljs-keyword">delete</span> obj.<span class="hljs-property">star</span>;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(obj.<span class="hljs-property">star</span>); <span class="hljs-comment">// 5</span>
</code></pre>
<p>2、enumerable：表示能否通过for in循环访问属性，默认值为true</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 可以枚举</span>
<span class="hljs-keyword">let</span> obj = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">"vue"</span>,
  <span class="hljs-attr">star</span>: <span class="hljs-string">"5"</span>
}
<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">defineProperty</span>(obj, <span class="hljs-string">"star"</span>, {
  <span class="hljs-attr">enumerable</span>: <span class="hljs-literal">true</span>
})
<span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i <span class="hljs-keyword">in</span> obj){
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(i, obj[i]);
}
<span class="hljs-comment">// name vue</span>
<span class="hljs-comment">// star 5</span>
</code></pre>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 不可以枚举</span>
<span class="hljs-keyword">let</span> obj = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">"vue"</span>,
  <span class="hljs-attr">star</span>: <span class="hljs-string">"5"</span>
}
<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">defineProperty</span>(obj, <span class="hljs-string">"star"</span>, {
  <span class="hljs-attr">enumerable</span>: <span class="hljs-literal">false</span>
})
<span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i <span class="hljs-keyword">in</span> obj){
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(i, obj[i]);
}
<span class="hljs-comment">// name vue</span>
</code></pre>
<p> 3、writable：表示能否修改属性的值。默认值为true</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 可以修改</span>
<span class="hljs-keyword">let</span> obj = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">"vue"</span>,
  <span class="hljs-attr">star</span>: <span class="hljs-string">"5"</span>
}
<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">defineProperty</span>(obj, <span class="hljs-string">"star"</span>, {
  <span class="hljs-attr">writable</span>: <span class="hljs-literal">true</span>
})
obj.<span class="hljs-property">star</span> = <span class="hljs-number">6</span>;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(obj.<span class="hljs-property">star</span>); <span class="hljs-comment">// 6</span>
</code></pre>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 不可以修改</span>
<span class="hljs-keyword">let</span> obj = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">"vue"</span>,
  <span class="hljs-attr">star</span>: <span class="hljs-string">"5"</span>
}
<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">defineProperty</span>(obj, <span class="hljs-string">"star"</span>, {
  <span class="hljs-attr">writable</span>: <span class="hljs-literal">false</span>
})
obj.<span class="hljs-property">star</span> = <span class="hljs-number">6</span>;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(obj.<span class="hljs-property">star</span>); <span class="hljs-comment">// 5</span>
</code></pre>
<p> 接下来重点来了，Object.defineProperty是怎么通过get、set来实现数据劫持的，看例子</p>
<p>get是获取值的时候的方法，类型为function，获取值的时候会被调用，不设置时为undefined</p>
<p>set是设置值的时候的方法，类型为function，设置值的时候会被调用，undefined</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">let</span> visits = <span class="hljs-number">10</span>;
<span class="hljs-keyword">let</span> obj = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">"vue"</span>,
  <span class="hljs-attr">star</span>: <span class="hljs-string">"5"</span>,
};
<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">defineProperty</span>(obj, <span class="hljs-string">"visits"</span>, {
  <span class="hljs-attr">get</span>:  <span class="hljs-function">() =&gt;</span>{
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"数据被获取了"</span>);
    <span class="hljs-keyword">return</span> visits;
  },
  <span class="hljs-attr">set</span>:  <span class="hljs-function">(<span class="hljs-params">newValue</span>)=&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"数据被设置了"</span>, newValue);
    visits = newValue;
  },
});
<span class="hljs-comment">// 执行get，输出数据被获取了，然后打印出10</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(obj.<span class="hljs-property">visits</span>);
<span class="hljs-comment">// 执行set，数据被设置了 20, 再执行get,输出数据被获取了，然后打印出20</span>
obj.<span class="hljs-property">visits</span> = <span class="hljs-number">20</span>;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(obj.<span class="hljs-property">visits</span>);
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[react实多并发请求同步处理封装]]></title>    <link>https://juejin.cn/post/7577228831137857579</link>    <guid>https://juejin.cn/post/7577228831137857579</guid>    <pubDate>2025-11-27T11:52:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577228831137857579" data-draft-id="7577220965437915190" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="react实多并发请求同步处理封装"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-27T11:52:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户34584828505"/> <meta itemprop="url" content="https://juejin.cn/user/3710177917545754"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            react实多并发请求同步处理封装
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3710177917545754/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户34584828505
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T11:52:51.000Z" title="Thu Nov 27 2025 11:52:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在React中处理多并发请求并实现同步处理（如等待所有请求完成后再执行后续操作）是常见需求。以下是一个通用的多并发请求同步处理封装方案，结合React的​<code>​useEffect​</code>​​和​<code>​Promise​</code>​特性实现：</p>
<h4 data-id="heading-0">1. 核心封装函数：处理多请求同步</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">/**
 * 同步处理多个并发请求
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Array&lt;() =&gt; Promise&gt;</span>} <span class="hljs-variable">requestList</span> - 请求函数数组（每个函数返回Promise）
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Function</span>} <span class="hljs-variable">onSuccess</span> - 所有请求成功后的回调（参数：所有请求结果数组）
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Function</span>} <span class="hljs-variable">onError</span> - 任何一个请求失败后的回调（参数：错误信息）
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">boolean</span>} <span class="hljs-variable">immediate</span> - 是否立即执行（默认true）
 * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">() =&gt; void</span>} - 手动执行请求的函数
 */</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">useConcurrentRequests</span> = (<span class="hljs-params">
  requestList,
  onSuccess,
  onError,
  immediate = <span class="hljs-literal">true</span>
</span>) =&gt; {
  <span class="hljs-comment">// 执行所有请求的函数</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">executeRequests</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-comment">// 使用Promise.all并发执行所有请求，等待全部完成</span>
      <span class="hljs-keyword">const</span> results = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>(requestList.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">req</span> =&gt;</span> <span class="hljs-title function_">req</span>()));
      onSuccess?.(results); <span class="hljs-comment">// 所有请求成功后回调</span>
    } <span class="hljs-keyword">catch</span> (error) {
      onError?.(error); <span class="hljs-comment">// 任何一个请求失败则触发错误回调</span>
    }
  };

  <span class="hljs-comment">// 立即执行（根据immediate控制）</span>
  <span class="hljs-title class_">React</span>.<span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (immediate) {
      <span class="hljs-title function_">executeRequests</span>();
    }
  }, [immediate]); <span class="hljs-comment">// 依赖项：仅immediate变化时重新执行</span>

  <span class="hljs-keyword">return</span> { executeRequests };
};
</code></pre>
<h4 data-id="heading-1">2. 使用示例：在组件中调用</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, { useState } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> axios <span class="hljs-keyword">from</span> <span class="hljs-string">'axios'</span>; <span class="hljs-comment">// 假设使用axios发送请求</span>

<span class="hljs-keyword">const</span> <span class="hljs-title function_">MyComponent</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> [loading, setLoading] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);
  <span class="hljs-keyword">const</span> [data, setData] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">null</span>);
  <span class="hljs-keyword">const</span> [error, setError] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">null</span>);

  <span class="hljs-comment">// 1. 定义单个请求函数（返回Promise）</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">request1</span> = (<span class="hljs-params"/>) =&gt; axios.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/api/data1'</span>);
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">request2</span> = (<span class="hljs-params"/>) =&gt; axios.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/api/data2'</span>);
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">request3</span> = (<span class="hljs-params"/>) =&gt; axios.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/api/data3'</span>);

  <span class="hljs-comment">// 2. 处理所有请求成功的回调</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleSuccess</span> = (<span class="hljs-params">results</span>) =&gt; {
    <span class="hljs-title function_">setLoading</span>(<span class="hljs-literal">false</span>);
    <span class="hljs-comment">// results是所有请求的响应数组，按请求顺序排列</span>
    <span class="hljs-title function_">setData</span>({
      <span class="hljs-attr">data1</span>: results[<span class="hljs-number">0</span>].<span class="hljs-property">data</span>,
      <span class="hljs-attr">data2</span>: results[<span class="hljs-number">1</span>].<span class="hljs-property">data</span>,
      <span class="hljs-attr">data3</span>: results[<span class="hljs-number">2</span>].<span class="hljs-property">data</span>,
    });
  };

  <span class="hljs-comment">// 3. 处理请求失败的回调</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleError</span> = (<span class="hljs-params">err</span>) =&gt; {
    <span class="hljs-title function_">setLoading</span>(<span class="hljs-literal">false</span>);
    <span class="hljs-title function_">setError</span>(err.<span class="hljs-property">message</span> || <span class="hljs-string">'请求失败'</span>);
  };

  <span class="hljs-comment">// 4. 使用封装的钩子：传入请求列表和回调</span>
  <span class="hljs-keyword">const</span> { executeRequests } = <span class="hljs-title function_">useConcurrentRequests</span>(
    [request1, request2, request3], <span class="hljs-comment">// 请求函数数组</span>
    handleSuccess,                  <span class="hljs-comment">// 成功回调</span>
    handleError,                    <span class="hljs-comment">// 失败回调</span>
    <span class="hljs-literal">false</span>                           <span class="hljs-comment">// 不立即执行（手动触发）</span>
  );

  <span class="hljs-comment">// 手动触发请求</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleFetch</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-title function_">setLoading</span>(<span class="hljs-literal">true</span>);
    <span class="hljs-title function_">setError</span>(<span class="hljs-literal">null</span>);
    <span class="hljs-title function_">executeRequests</span>();
  };

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{handleFetch}</span> <span class="hljs-attr">disabled</span>=<span class="hljs-string">{loading}</span>&gt;</span>
        {loading ? '加载中...' : '获取数据'}
      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      {error &amp;&amp; <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">color:</span> '<span class="hljs-attr">red</span>' }}&gt;</span>{error}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>}
      {data &amp;&amp; (
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>数据1: {JSON.stringify(data.data1)}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>数据2: {JSON.stringify(data.data2)}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>数据3: {JSON.stringify(data.data3)}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      )}
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">MyComponent</span>;
</code></pre>
<h4 data-id="heading-2">3. 扩展场景：处理部分失败的情况</h4>
<p>如果需要<strong>等待所有请求完成（包括失败的）</strong> ，而不是一个失败就整体失败，可以使用​<code>​Promise.allSettled​</code>​替代​<code>​Promise.all​</code>​，修改核心函数如下：</p>
<pre><code class="hljs language-ini" lang="ini">// 改为使用Promise.allSettled（等待所有请求完成，无论成功失败）
const <span class="hljs-attr">executeRequests</span> = async () =&gt; {
  try {
    const <span class="hljs-attr">results</span> = await Promise.allSettled(requestList.map(req =&gt; req()))<span class="hljs-comment">;</span>
    // 处理结果：区分成功和失败
    const <span class="hljs-attr">successResults</span> = []<span class="hljs-comment">;</span>
    const <span class="hljs-attr">errorResults</span> = []<span class="hljs-comment">;</span>
    results.forEach(<span class="hljs-attr">result</span> =&gt; {
      if (<span class="hljs-attr">result.status</span> === <span class="hljs-string">'fulfilled'</span>) {
        successResults.push(result.value)<span class="hljs-comment">;</span>
      } else {
        errorResults.push(result.reason)<span class="hljs-comment">;</span>
      }
    })<span class="hljs-comment">;</span>
    onSuccess?.(successResults, errorResults)<span class="hljs-comment">; // 同时返回成功和失败结果</span>
  } catch (error) {
    onError?.(error)<span class="hljs-comment">;</span>
  }
}<span class="hljs-comment">;</span>
</code></pre>
<h4 data-id="heading-3">4. 核心特性说明</h4>
<ul>
<li><strong>并发执行</strong>：使用​<code>​Promise.all​</code>​（或​<code>​allSettled​</code>​）实现请求并发，提高效率</li>
<li><strong>同步处理</strong>：等待所有请求完成后再执行后续逻辑（成功/失败回调）</li>
<li><strong>灵活性</strong>：支持立即执行或手动触发（通过​<code>​immediate​</code>​参数控制）</li>
<li><strong>错误处理</strong>：统一捕获错误，避免单个请求失败导致整个流程中断（可按需选择​<code>​all​</code>​或​<code>​allSettled​</code>​）</li>
</ul>
<p>这种封装方式适用于需要依赖多个接口数据的场景（如页面初始化加载多个独立数据、表单提交前的多接口验证等），结合React的状态管理可清晰处理加载、成功、失败三种状态。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React开发规范：默认导出 VS 具名导出]]></title>    <link>https://juejin.cn/post/7577198193215750187</link>    <guid>https://juejin.cn/post/7577198193215750187</guid>    <pubDate>2025-11-27T11:54:14.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577198193215750187" data-draft-id="7577220965437784118" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React开发规范：默认导出 VS 具名导出"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-27T11:54:14.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="UranLee_Nana"/> <meta itemprop="url" content="https://juejin.cn/user/3912542739759883"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React开发规范：默认导出 VS 具名导出
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3912542739759883/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    UranLee_Nana
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T11:54:14.000Z" title="Thu Nov 27 2025 11:54:14 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="a11y-light">.hljs-comment,.hljs-quote{color:#696969}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#d91e18}.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#aa5d00}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:green}.hljs-section,.hljs-title{color:#007faa}.hljs-keyword,.hljs-selector-tag{color:#7928a1}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fefefe;color:#545454}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><p>React中组件的神奇之处在于它们的可重用性：你可以创建一个由其他组件构成的组件。但当你嵌套了越来越多的组件时，则需要将它们拆分成不同的文件。这样可以使得查找文件更加容易，并且能在更多地方复用这些组件。</p>
<h2 data-id="heading-0">导出组件</h2>
<p>这是 JavaScript 里两个主要用来导出值的方式：默认导出和具名导出。到目前为止，我们的示例中只用到了默认导出。但你可以在一个文件中，选择使用其中一种，或者两种都使用。<strong>一个文件里有且仅有一个 <em>默认</em> 导出，但是可以有任意多个 <em>具名</em> 导出。</strong></p>
<p>组件的导出方式决定了其导入方式。当你用默认导入的方式，导入具名导出的组件时，就会报错。如下表格可以帮你更好地理解它们：</p>




















<table><thead><tr><th>语法</th><th>导出语句</th><th>导入语句</th></tr></thead><tbody><tr><td>默认</td><td><code>export default function Button() {}</code></td><td><code>import Button from './Button.js';</code></td></tr><tr><td>具名</td><td><code>export function Button() {}</code></td><td><code>import { Button } from './Button.js';</code></td></tr></tbody></table>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-comment">// 默认导出 (Default Export)</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">MyComponent</span>(<span class="hljs-params"/>) { }

<span class="hljs-comment">// 具名导出 (Named Export)</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">MyComponent</span>(<span class="hljs-params"/>) { }
</code></pre>
<h2 data-id="heading-1">核心区别</h2>
<p>当使用默认导入时，你可以在 <code>import</code> 语句后面进行任意命名。比如 <code>import Banana from './Button.js'</code>，如此你能获得与默认导出一致的内容。相反，对于具名导入，导入和导出的名字必须一致。这也是称其为 <strong>具名</strong> 导入的原因！</p>








































<table><thead><tr><th align="left">特性</th><th align="left">默认导出</th><th align="left">具名导出</th></tr></thead><tbody><tr><td align="left"><strong>导入名称</strong></td><td align="left">可任意命名</td><td align="left">必须对应导出名称</td></tr><tr><td align="left"><strong>IDE自动导入</strong></td><td align="left">较差，可能重名</td><td align="left">优秀，精准匹配</td></tr><tr><td align="left"><strong>重构支持</strong></td><td align="left">弱，无法全局重命名</td><td align="left">强，支持全局重命名</td></tr><tr><td align="left"><strong>Tree Shaking</strong></td><td align="left">可能失效</td><td align="left">始终有效</td></tr><tr><td align="left"><strong>代码提示</strong></td><td align="left">有限</td><td align="left">完整</td></tr><tr><td align="left"><strong>可读性</strong></td><td align="left">追踪来源困难</td><td align="left">来源清晰明确</td></tr></tbody></table>
<h3 data-id="heading-2">默认导出的问题 ⚠️</h3>
<h4 data-id="heading-3">1. <strong>命名混乱</strong></h4>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-comment">// Button.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Button</span>(<span class="hljs-params"/>) {}

<span class="hljs-comment">// 在其他文件中</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Btn</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./Button'</span>;      <span class="hljs-comment">// 合法但语义不清</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">ButtonComponent</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./Button'</span>; <span class="hljs-comment">// 另一个名字</span>
</code></pre>
<h4 data-id="heading-4">2. <strong>重构困难</strong></h4>
<p>当修改文件名或组件名时，IDE无法自动更新所有导入点。</p>
<h4 data-id="heading-5">3. <strong>Tree Shaking风险</strong></h4>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-comment">// 默认导出对象时</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> { <span class="hljs-title class_">Button</span>, <span class="hljs-title class_">Input</span>, <span class="hljs-title class_">Select</span> };
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Button</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./components'</span>; <span class="hljs-comment">// 可能打包整个对象</span>
</code></pre>
<h4 data-id="heading-6">4. <strong>难以聚合导出</strong></h4>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-comment">// 需要额外步骤</span>
<span class="hljs-keyword">export</span> { <span class="hljs-keyword">default</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">Button</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./Button'</span>;
</code></pre>
<h3 data-id="heading-7">具名导出的优势 ✅</h3>
<h4 data-id="heading-8">1. <strong>强类型支持</strong></h4>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-comment">// 组件定义</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">UserCard</span>(<span class="hljs-params">props: UserCardProps</span>) {}

<span class="hljs-comment">// 使用时自动提示所有导出</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">UserCard</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./components'</span>; <span class="hljs-comment">// IDE精确提示</span>
</code></pre>
<h4 data-id="heading-9">2. <strong>可靠的重构</strong></h4>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-comment">// 重命名组件时，IDE可全局更新所有导入点</span>
</code></pre>
<h4 data-id="heading-10">3. <strong>清晰的依赖关系</strong></h4>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">UserCard</span>, <span class="hljs-title class_">UserAvatar</span>, <span class="hljs-title class_">UserMenu</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./user'</span>;
<span class="hljs-comment">// 一目了然使用了哪些组件</span>
</code></pre>
<h4 data-id="heading-11">4. <strong>便于 Barrel exports</strong></h4>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-comment">// components/index.js</span>
<span class="hljs-keyword">export</span> { <span class="hljs-title class_">UserCard</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./UserCard'</span>;
<span class="hljs-keyword">export</span> { <span class="hljs-title class_">UserAvatar</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./UserAvatar'</span>;

<span class="hljs-comment">// 使用</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">UserCard</span>, <span class="hljs-title class_">UserAvatar</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./components'</span>;
</code></pre>
<h3 data-id="heading-12">社区推荐规范</h3>
<p><strong>Airbnb规范（ESLint规则）</strong></p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-comment">// ❌ 不推荐</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyComponent</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">React.Component</span> {}

<span class="hljs-comment">// ✅ 推荐</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyComponent</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">React.Component</span> {}
</code></pre>
<p><strong>ESLint配置：</strong></p>
<pre><code class="hljs language-JSON" lang="JSON"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"rules"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"import/prefer-default-export"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"off"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"import/no-default-export"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"error"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>React核心团队实践</strong>
React官方项目（如React DevTools）<strong>100%使用具名导出</strong>。</p>
<h3 data-id="heading-13">例外情况</h3>
<p>默认导出在极少数场景仍可接受：</p>
<ol>
<li><strong>Next.js页面</strong>（框架强制要求）</li>
<li><strong>单一入口的库</strong>（如 <code>export default axios</code>）</li>
<li><strong>遗留代码兼容性</strong></li>
</ol>
<p>但即使在这些场景，也建议在文件内部优先使用具名导出。</p>
<h2 data-id="heading-14">总结</h2>



































<table><thead><tr><th align="left">场景</th><th align="left">推荐方式</th><th align="left">理由</th></tr></thead><tbody><tr><td align="left">React组件</td><td align="left"><strong>具名导出</strong></td><td align="left">重构、可读性、Tree Shaking</td></tr><tr><td align="left">工具函数</td><td align="left"><strong>具名导出</strong></td><td align="left">按需引入、IDE支持</td></tr><tr><td align="left">TypeScript类型</td><td align="left"><strong>具名导出</strong></td><td align="left">必须具名</td></tr><tr><td align="left">第三方库入口</td><td align="left">可默认导出</td><td align="left">简化使用</td></tr><tr><td align="left">Next.js页面</td><td align="left"><strong>被迫默认</strong></td><td align="left">框架限制</td></tr></tbody></table>
<p><strong>核心原则</strong>：具名导出是React现代开发的标配，默认导出应视为例外而非常规。它带来的可维护性收益远超微小的书写便捷性。</p>
<p>感谢大家收看！Forever React！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue 3 踩坑实录：如何优雅地把“上古”第三方插件关进 Iframe 小黑屋]]></title>    <link>https://juejin.cn/post/7577218195233439790</link>    <guid>https://juejin.cn/post/7577218195233439790</guid>    <pubDate>2025-11-27T12:32:18.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577218195233439790" data-draft-id="7577237961638264841" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue 3 踩坑实录：如何优雅地把“上古”第三方插件关进 Iframe 小黑屋"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-27T12:32:18.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="影i"/> <meta itemprop="url" content="https://juejin.cn/user/3276960745926030"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue 3 踩坑实录：如何优雅地把“上古”第三方插件关进 Iframe 小黑屋
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3276960745926030/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    影i
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T12:32:18.000Z" title="Thu Nov 27 2025 12:32:18 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Vue 3 项目集成“上古”第三方插件：从全局污染到完美沙箱隔离</h2>
<h3 data-id="heading-1">🟢 背景与痛点</h3>
<p>最近在重构公司的一个管理系统（技术栈：Vue 3 + TypeScript + Vite + Element Plus），其中需要集成一个第三方的“选人插件”。</p>
<p>这个插件是一个典型的“黑盒”遗留代码，它的集成文档给出的方案非常古老：</p>
<ol>
<li>必须在 <code>index.html</code> 或全局引入 <code>vue.js</code>（UMD 版）。</li>
<li>必须将 <code>Vue</code> 挂载到 <code>window</code> 对象上。</li>
<li>插件全局引入了 Element Plus 样式，且没有任何命名空间隔离。</li>
</ol>
<p><strong>最初的“能用就行”版本：</strong><br/>
我尝试直接在组件中动态加载脚本，并强行修改 <code>window.Vue</code>。虽然功能跑通了，但带来了两个无法忍受的<strong>架构崩坏</strong>：</p>
<ul>
<li><strong>全局污染严重</strong>：主应用不得不为了迁就插件而污染全局环境，<code>window</code> 对象变得脏乱差。</li>
<li><strong>样式灾难</strong>：插件加载后，它自带的 CSS 直接覆盖了主应用精心配置的主题色（CSS 变量被冲刷），导致整个系统 UI 变得不伦不类。为了修复它，我不得不写大量的 <code>!important</code>，维护成本极高。</li>
</ul>
<p><strong>我的目标</strong>：既要用这个插件，又要让主应用保持“洁癖”，同时还得让插件长得和主应用一样（样式统一）。</p>
<hr/>
<h3 data-id="heading-2">🔵 思考与方案选型</h3>
<p>面对这种“毒瘤”插件，通常有几种隔离方案：</p>
<ol>
<li>
<p><strong>Shadow DOM</strong>：</p>
<ul>
<li><em>优点</em>：样式隔离得很好。</li>
<li><em>缺点</em>：JS 环境依然共享。如果插件依赖全局 <code>window.Vue</code>，Shadow DOM 救不了JS 污染的问题。</li>
</ul>
</li>
<li>
<p><strong>微前端（qiankun/wujie）</strong> ：</p>
<ul>
<li><em>优点</em>：隔离彻底。</li>
<li><em>缺点</em>：为了一个弹窗插件上微前端，属于“大炮打蚊子”，增加了不必要的工程复杂度。</li>
</ul>
</li>
<li>
<p><strong>Iframe 沙箱（最终选择）</strong> ：</p>
<ul>
<li><em>优点</em>：JS 环境物理隔离（绝对纯净），CSS 样式绝对隔离。</li>
<li><em>挑战</em>：Iframe 里的样式无法继承主应用，会导致“割裂感”；父子通信稍微麻烦一点。</li>
</ul>
</li>
</ol>
<p><strong>最终决策</strong>：采用 <strong>Iframe + PostMessage + 动态样式注入</strong> 的方案。把“脏”代码关进 Iframe 这个小黑屋，同时通过“传送门”把主应用的主题样式送进去。</p>
<hr/>
<h3 data-id="heading-3">🟠 实施过程</h3>
<h4 data-id="heading-4">1. 搭建“小黑屋”：<code>pick-bridge.html</code></h4>
<p>我在 <code>public</code> 目录下新建了一个静态 HTML 文件。在这个文件里，我才去引入那些必须的全局依赖（Vue, 插件 JS）。主应用对此一无所知，保持了主应用的纯净。</p>
<p>HTML</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- public/pick-bridge.html --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"./js/vue.global.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">".../pick.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"app"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
    <span class="hljs-comment">// 这里是脏代码的避难所</span>
    <span class="hljs-comment">// 监听主应用发来的指令</span>
    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'message'</span>, <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> { ... })
  </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
</code></pre>
<h4 data-id="heading-5">2. 建立“传送门”：Vue 主组件</h4>
<p>在主应用中，我写了一个 Wrapper 组件，放一个 <code>iframe</code>，并利用 <code>postMessage</code> 进行通信。</p>
<p><strong>通信协议设计：</strong></p>
<ul>
<li><code>INIT_PICK</code>：主应用 -&gt; Iframe（发送配置 + <strong>当前主题样式</strong>）</li>
<li><code>PICK_SUBMIT</code>：Iframe -&gt; 主应用（返回选人结果）</li>
<li><code>PICK_LOADED</code>：Iframe -&gt; 主应用（加载完成，关闭 Loading）</li>
</ul>
<h4 data-id="heading-6">3. 解决“割裂感”：样式穿越</h4>
<p>这是最精彩的一步。Iframe 里的按钮是蓝色的，但我系统主题是紫色的，怎么办？</p>
<p>我写了一个函数 <code>getInjectedStyles()</code>，它会：</p>
<ol>
<li>读取主应用 <code>root</code> 下实时的 CSS 变量（<code>--el-color-primary</code> 等）。</li>
<li>拼接成一段 CSS 字符串。</li>
<li>通过 <code>postMessage</code> 发送给 Iframe。</li>
<li>Iframe 接收到后，动态创建 <code>&lt;style&gt;</code> 标签插入自己的 <code>&lt;head&gt;</code>。</li>
</ol>
<p>这样，<strong>无论主应用怎么换肤，Iframe 里的插件都会自动由内而外地“变色”，完全看不出是 Iframe！</strong></p>
<hr/>
<h3 data-id="heading-7">🔴 踩坑与至暗时刻</h3>
<p>代码写完，一运行，控制台赫然报错：<br/>
<code>Error: Please pass in appid</code></p>
<p>但我明明在 <code>data</code> 里传了 <code>appid</code>！打印出来的 config 对象里也有 <code>appid</code>。</p>
<p><strong>排查过程：</strong></p>
<ol>
<li><strong>怀疑传输问题</strong>：打印 Iframe 接收到的 data，发现数据是完整的。排除。</li>
<li><strong>怀疑时序问题</strong>：是不是组件渲染时，数据还没赋值？</li>
<li><strong>深入 Vue 3 机制</strong>：</li>
</ol>
<p>在 <code>pick-bridge.html</code> 中，我最初是这样写的：</p>
<p>JavaScript</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 错误示范</span>
<span class="hljs-title function_">createApp</span>({
  <span class="hljs-title function_">setup</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> { ...receivedConfig } <span class="hljs-comment">// 直接解构返回普通对象</span>
  },
  <span class="hljs-attr">template</span>: <span class="hljs-string">`&lt;pick v-bind="$data"&gt;&lt;/pick&gt;`</span> <span class="hljs-comment">// 试图绑定</span>
})
</code></pre>
<p><strong>真相是</strong>：</p>
<ol>
<li><strong>响应式丢失</strong>：<code>setup</code> 返回普通对象时，Vue 并没有将其转化为响应式代理。老旧插件内部可能依赖了某些响应式特性。</li>
<li><strong>绑定失效</strong>：在 Vue 3 <code>setup</code> 模式下，<code>$data</code> 的行为与 Options API 不同，直接解构的数据并没有正确地通过 <code>v-bind</code> 传递给子组件。</li>
<li><strong>FOUC（无样式闪烁）</strong> ：我最初是先 <code>initApp</code> 再 <code>injectStyle</code>，导致组件计算高度时样式还没加载，布局错乱。</li>
</ol>
<hr/>
<h3 data-id="heading-8">🟢 最终的完美形态</h3>
<p>针对上述问题，我重构了初始化逻辑：</p>
<ol>
<li><strong>合并消息</strong>：不再分开发送 Config 和 Style，而是一个 <code>INIT</code> 消息包揽所有。</li>
<li><strong>响应式包裹</strong>：在 Iframe 内部使用 <code>reactive</code> 包裹配置数据。</li>
<li><strong>顺序修正</strong>：<strong>先注入样式，再挂载 APP</strong>。</li>
</ol>
<p><strong>修正后的 Bridge 代码核心：</strong></p>
<p>JavaScript</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// public/pick-bridge.html</span>

window<span class="hljs-selector-class">.addEventListener</span>('message', ({ data }) =&gt; {
  if (data.type === 'INIT_PICK') {
    <span class="hljs-comment">// 1. 先穿衣服 (注入样式)</span>
    <span class="hljs-built_in">injectStyles</span>(data.styles); 
    <span class="hljs-comment">// 2. 再见人 (初始化组件)</span>
    <span class="hljs-built_in">initPickApp</span>(data.config);
  }
});

function <span class="hljs-built_in">initPickApp</span>(config) {
  <span class="hljs-built_in">createApp</span>({
    setup() {
      <span class="hljs-comment">// 关键：使用 reactive 保持活性</span>
      const pickState = <span class="hljs-built_in">reactive</span>(config);
      return { pickState };
    },
    <span class="hljs-comment">// 关键：绑定 reactive 对象</span>
    template: `&lt;pick v-bind=<span class="hljs-string">"pickState"</span> @submit=<span class="hljs-string">"..."</span>&gt;&lt;/pick&gt;`
  })<span class="hljs-selector-class">.mount</span>('#app');
}
</code></pre>
<p><strong>主组件发送逻辑：</strong></p>
<p>TypeScript</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-comment">// PickPlugin.vue</span>

<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">onIframeLoad</span> = () =&gt; {
    <span class="hljs-comment">// 1. 提取当前系统的 CSS 变量</span>
    <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">cssText</span> = <span class="hljs-title function_ invoke__">getInjectedStyles</span>(); 
    <span class="hljs-comment">// 2. 准备配置</span>
    <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">config</span> = await <span class="hljs-title function_ invoke__">prepareConfig</span>();
    
    <span class="hljs-comment">// 3. 打包发送，一气呵成</span>
    iframeWin.<span class="hljs-title function_ invoke__">postMessage</span>({
        <span class="hljs-attr">type</span>: <span class="hljs-string">'INIT_PICK'</span>,
        <span class="hljs-attr">data</span>: { config, <span class="hljs-attr">styles</span>: cssText }
    }, <span class="hljs-string">'*'</span>);
}
</code></pre>
<hr/>
<h3 data-id="heading-9">🟣 总结</h3>
<p>通过这次重构，最终实现了：</p>
<ol>
<li><strong>主应用 0 污染</strong>：不需要 <code>window.Vue</code>，不需要全局 CSS 补丁。</li>
<li><strong>样式 100% 融合</strong>：Iframe 内部组件自动继承主应用主题色，视觉上无缝衔接。</li>
<li><strong>维护性提升</strong>：所有脏逻辑都被隔离在 <code>pick-bridge.html</code> 和 <code>PickPlugin.vue</code> 中，其他人接手项目时，不需要理解这些复杂的兼容代码，直接用组件即可。</li>
</ol>
<p><strong>经验心得</strong>：<br/>
面对老旧代码，不要试图去“兼容”它，而是要试图“隔离”它。Iframe 听起来很老土，但在处理样式隔离和全局环境冲突时，它依然是前端最坚实的“防火墙”。而 <code>postMessage</code> + <code>CSS Variables</code> 则是打通这堵墙的各种“魔法通道”。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JW进阶小技巧：告别小白，优雅拿捏基础操作]]></title>    <link>https://juejin.cn/post/7577226119105314843</link>    <guid>https://juejin.cn/post/7577226119105314843</guid>    <pubDate>2025-11-27T12:50:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577226119105314843" data-draft-id="7577222731790172186" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JW进阶小技巧：告别小白，优雅拿捏基础操作"/> <meta itemprop="keywords" content="JavaScript"/> <meta itemprop="datePublished" content="2025-11-27T12:50:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="AAA简单玩转程序设计"/> <meta itemprop="url" content="https://juejin.cn/user/4294056357689099"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JW进阶小技巧：告别小白，优雅拿捏基础操作
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4294056357689099/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    AAA简单玩转程序设计
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T12:50:34.000Z" title="Thu Nov 27 2025 12:50:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、核心进阶点1：数据绑定优化</h2>
<p><strong>1. 双向绑定简化写法</strong></p>
<pre><code class="hljs language-javascript" lang="javascript">  
<span class="hljs-comment">// 原始写法</span>
<span class="hljs-variable language_">this</span>.$set(<span class="hljs-variable language_">this</span>.<span class="hljs-property">form</span>, <span class="hljs-string">'name'</span>, <span class="hljs-string">'掘金er'</span>)
<span class="hljs-comment">// 进阶简化（直接赋值+自动响应）</span>
<span class="hljs-variable language_">this</span>.<span class="hljs-property">form</span>.<span class="hljs-property">name</span> = <span class="hljs-string">'掘金er'</span>
<span class="hljs-comment">// 数组更新优雅操作</span>
<span class="hljs-variable language_">this</span>.<span class="hljs-property">list</span>.<span class="hljs-title function_">push</span>(...[<span class="hljs-number">4</span>,<span class="hljs-number">5</span>,<span class="hljs-number">6</span>]) <span class="hljs-comment">// 扩展运算符批量添加</span>
</code></pre>
<p> </p>
<p><strong>2. 计算属性缓存妙用</strong></p>
<pre><code class="hljs language-javascript" lang="javascript">  
<span class="hljs-attr">computed</span>: {
  <span class="hljs-comment">// 自动缓存，依赖不变不重复计算</span>
  <span class="hljs-title function_">filterList</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">list</span>.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> item.<span class="hljs-property">status</span> === <span class="hljs-number">1</span>)
  }
}
</code></pre>
<p> </p>
<h2 data-id="heading-1">二、核心进阶点2：事件处理升级</h2>
<p><strong>1. 事件传参简洁写法</strong></p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- 无需多余括号，默认传事件对象 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"handleClick"</span>&gt;</span>点击<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
<span class="hljs-comment">&lt;!-- 自定义传参+事件对象 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"handleBtn(1, $event)"</span>&gt;</span>传参点击<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
 
 
javascript
  
methods: {
  handleClick(e) {
    console.log(e.target)
  },
  handleBtn(id, e) {
    console.log(id, e)
  }
}
</code></pre>
<p> </p>
<p><strong>2. 事件修饰符组合使用</strong></p>
<pre><code class="hljs language-html" lang="html">  
<span class="hljs-comment">&lt;!-- 阻止冒泡+阻止默认行为 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">a</span> @<span class="hljs-attr">click.stop.prevent</span>=<span class="hljs-string">"handleLink"</span>&gt;</span>跳转<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
<span class="hljs-comment">&lt;!-- 仅触发一次 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click.once</span>=<span class="hljs-string">"handleOnce"</span>&gt;</span>只点一次<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
</code></pre>
<p> </p>
<h2 data-id="heading-2">三、核心进阶点3：组件通信基础进阶</h2>
<ol>
<li>子传父简化（自定义事件）</li>
</ol>
<pre><code class="hljs language-html" lang="html">  
<span class="hljs-comment">&lt;!-- 子组件 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"$emit('sendData', '子组件数据')"</span>&gt;</span>传值<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
<span class="hljs-comment">&lt;!-- 父组件 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">child</span> @<span class="hljs-attr">sendData</span>=<span class="hljs-string">"getSonData"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">child</span>&gt;</span>
</code></pre>
<p> </p>
<pre><code class="hljs language-javascript" lang="javascript">  
<span class="hljs-comment">// 父组件</span>
<span class="hljs-attr">methods</span>: {
  <span class="hljs-title function_">getSonData</span>(<span class="hljs-params">data</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(data) <span class="hljs-comment">// 接收子组件数据</span>
  }
}
</code></pre>
<p> </p>
<p><strong>2. 全局事件总线（简单跨组件）</strong></p>
<pre><code class="hljs language-javascript" lang="javascript">  
<span class="hljs-comment">// 全局注册</span>
<span class="hljs-title class_">Vue</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">$bus</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Vue</span>()
<span class="hljs-comment">// 发送组件</span>
<span class="hljs-variable language_">this</span>.<span class="hljs-property">$bus</span>.$emit(<span class="hljs-string">'globalMsg'</span>, <span class="hljs-string">'全局消息'</span>)
<span class="hljs-comment">// 接收组件</span>
<span class="hljs-title function_">mounted</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">$bus</span>.$on(<span class="hljs-string">'globalMsg'</span>, <span class="hljs-function"><span class="hljs-params">msg</span> =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(msg)
  })
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Java进阶小白手册：基础玩法升级，告别青铜套路]]></title>    <link>https://juejin.cn/post/7577031454586847259</link>    <guid>https://juejin.cn/post/7577031454586847259</guid>    <pubDate>2025-11-27T12:57:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577031454586847259" data-draft-id="7577222731790221338" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Java进阶小白手册：基础玩法升级，告别青铜套路"/> <meta itemprop="keywords" content="Java"/> <meta itemprop="datePublished" content="2025-11-27T12:57:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="AAA简单玩转程序设计"/> <meta itemprop="url" content="https://juejin.cn/user/4294056357689099"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Java进阶小白手册：基础玩法升级，告别青铜套路
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4294056357689099/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    AAA简单玩转程序设计
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T12:57:13.000Z" title="Thu Nov 27 2025 12:57:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、ArrayList vs LinkedList：选对集合不踩坑</h2>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ArrayList（数组底层，查得快、增删慢）</span>
ArrayList&lt;String&gt; arrayList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
arrayList.add(<span class="hljs-string">"掘金Javaer"</span>);
arrayList.get(<span class="hljs-number">0</span>); <span class="hljs-comment">// 直接索引，效率高</span>

<span class="hljs-comment">// LinkedList（链表底层，增删快、查得慢）</span>
LinkedList&lt;String&gt; linkedList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedList</span>&lt;&gt;();
linkedList.addFirst(<span class="hljs-string">"首元素"</span>);
linkedList.removeLast(); <span class="hljs-comment">// 首尾操作效率高</span>
</code></pre>
<p> </p>
<blockquote>
<p>核心：查多增删少用ArrayList，增删多用LinkedList。</p>
</blockquote>
<h2 data-id="heading-1">二、异常处理：try-catch进阶用法</h2>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 多异常合并捕获</span>
<span class="hljs-keyword">try</span> {
    <span class="hljs-type">int</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> <span class="hljs-number">10</span> / <span class="hljs-number">0</span>;
    <span class="hljs-type">String</span> <span class="hljs-variable">str</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
    str.length();
} <span class="hljs-keyword">catch</span> (ArithmeticException | NullPointerException e) {
    <span class="hljs-comment">// 同一逻辑处理多种异常</span>
    System.out.println(<span class="hljs-string">"异常："</span> + e.getMessage());
} <span class="hljs-keyword">finally</span> {
    <span class="hljs-comment">// 必执行（关流、释放资源）</span>
    System.out.println(<span class="hljs-string">"无论对错都执行"</span>);
}

<span class="hljs-comment">// 自定义异常</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">MyException</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Exception</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">MyException</span><span class="hljs-params">(String msg)</span> {
        <span class="hljs-built_in">super</span>(msg);
    }
}
<span class="hljs-comment">// 使用自定义异常</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">checkAge</span><span class="hljs-params">(<span class="hljs-type">int</span> age)</span> <span class="hljs-keyword">throws</span> MyException {
    <span class="hljs-keyword">if</span> (age &lt; <span class="hljs-number">0</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyException</span>(<span class="hljs-string">"年龄不能为负"</span>);
}
 
</code></pre>
<h2 data-id="heading-2">三、接口进阶：默认方法与静态方法</h2>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserService</span> {
    <span class="hljs-comment">// 抽象方法（必须实现）</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">login</span><span class="hljs-params">()</span>;
    
    <span class="hljs-comment">// 默认方法（可选实现，解决接口升级兼容）</span>
    <span class="hljs-keyword">default</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">register</span><span class="hljs-params">()</span> {
        System.out.println(<span class="hljs-string">"默认注册逻辑"</span>);
    }
    
    <span class="hljs-comment">// 静态方法（接口直接调用）</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">showTips</span><span class="hljs-params">()</span> {
        System.out.println(<span class="hljs-string">"登录前请验证信息"</span>);
    }
}

<span class="hljs-comment">// 实现类</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">UserServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">UserService</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">login</span><span class="hljs-params">()</span> {
        System.out.println(<span class="hljs-string">"用户登录"</span>);
    }
}

<span class="hljs-comment">// 调用</span>
UserService.showTips(); <span class="hljs-comment">// 接口直接调用静态方法</span>
<span class="hljs-type">UserServiceImpl</span> <span class="hljs-variable">userService</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserServiceImpl</span>();
userService.login();
userService.register();
</code></pre>
<p> </p>
<h2 data-id="heading-3">四、包装类：自动拆装箱避坑</h2>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 自动装箱（基本类型→包装类）</span>
<span class="hljs-type">Integer</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> <span class="hljs-number">10</span>; <span class="hljs-comment">// 等价于 Integer a = Integer.valueOf(10);</span>
<span class="hljs-comment">// 自动拆箱（包装类→基本类型）</span>
<span class="hljs-type">int</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> a; <span class="hljs-comment">// 等价于 int b = a.intValue();</span>

<span class="hljs-comment">// 避坑：-128~127有缓存，超出则新对象</span>
<span class="hljs-type">Integer</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> <span class="hljs-number">127</span>;
<span class="hljs-type">Integer</span> <span class="hljs-variable">d</span> <span class="hljs-operator">=</span> <span class="hljs-number">127</span>;
System.out.println(c == d); <span class="hljs-comment">// true</span>
<span class="hljs-type">Integer</span> <span class="hljs-variable">e</span> <span class="hljs-operator">=</span> <span class="hljs-number">128</span>;
<span class="hljs-type">Integer</span> <span class="hljs-variable">f</span> <span class="hljs-operator">=</span> <span class="hljs-number">128</span>;
System.out.println(e == f); <span class="hljs-comment">// false</span>
System.out.println(e.equals(f)); <span class="hljs-comment">// true（比较值用equals）</span>
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Trae SOLO 生成 TensorFlow.js 手势抓取物品太牛了 程序员可以退下了]]></title>    <link>https://juejin.cn/post/7577203946063478824</link>    <guid>https://juejin.cn/post/7577203946063478824</guid>    <pubDate>2025-11-27T12:59:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577203946063478824" data-draft-id="7577203946063462440" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Trae SOLO 生成 TensorFlow.js 手势抓取物品太牛了 程序员可以退下了"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2025-11-27T12:59:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="浪浪山_大橙子"/> <meta itemprop="url" content="https://juejin.cn/user/606586149550429"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Trae SOLO 生成 TensorFlow.js 手势抓取物品太牛了 程序员可以退下了
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/606586149550429/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    浪浪山_大橙子
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T12:59:37.000Z" title="Thu Nov 27 2025 12:59:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    10
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">TensorFlow.js 实时手势抓取物品：从0到1实现手势交互</h2>
<h3 data-id="heading-1">项目介绍</h3>
<p>这是一个基于 TensorFlow.js 和 MediaPipeHands 模型的实时手势抓取物品应用，支持语音反馈功能。用户可以通过摄像头捕捉手部动作，使用手势控制虚拟光标，实现对屏幕上虚拟物品的抓取、移动、旋转和缩放操作。</p>
<h4 data-id="heading-2">功能特点</h4>
<ul>
<li>✅ 实时手部检测和关键点跟踪</li>
<li>✅ 多种手势识别（抓取、张开、OK、点赞、拳头）</li>
<li>✅ 虚拟光标跟随手部移动</li>
<li>✅ 物品抓取、移动、旋转和缩放</li>
<li>✅ 语音反馈</li>
<li>✅ 响应式设计，支持移动端</li>
<li>✅ 动态性能调整</li>
</ul>
<h4 data-id="heading-3">技术栈</h4>
<ul>
<li><strong>前端框架</strong>：纯 JavaScript (ES 模块)</li>
<li><strong>构建工具</strong>：Vite</li>
<li><strong>机器学习库</strong>：
<ul>
<li>TensorFlow.js</li>
<li>@tensorflow-models/hand-pose-detection</li>
<li>@mediapipe/hands</li>
</ul>
</li>
<li><strong>浏览器 API</strong>：
<ul>
<li>WebRTC (getUserMedia)</li>
<li>Canvas API</li>
<li>Web Speech API</li>
</ul>
</li>
</ul>
<h3 data-id="heading-4">核心架构设计</h3>
<p>项目采用模块化架构，各功能模块职责清晰，便于维护和扩展：</p>
<pre><code class="hljs language-bash" lang="bash">src/
├── js/
│   ├── camera.js        <span class="hljs-comment"># 摄像头管理</span>
│   ├── detector.js      <span class="hljs-comment"># 手部检测和手势识别</span>
│   ├── interaction.js   <span class="hljs-comment"># 交互逻辑</span>
│   ├── renderer.js      <span class="hljs-comment"># 手部关键点绘制</span>
│   ├── utils.js         <span class="hljs-comment"># 工具函数</span>
│   ├── voice.js         <span class="hljs-comment"># 语音合成</span>
│   └── config.js        <span class="hljs-comment"># 配置文件</span>
├── index.css           <span class="hljs-comment"># 样式文件</span>
└── main.js             <span class="hljs-comment"># 项目入口</span>
</code></pre>
<h3 data-id="heading-5">核心代码解析</h3>
<h4 data-id="heading-6">1. 项目初始化与主流程</h4>
<p><strong>main.js</strong> - 项目入口文件，负责初始化和协调各模块</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 导入核心模块</span>
<span class="hljs-keyword">import</span> { setupCamera, stopCamera, isCameraOn } <span class="hljs-keyword">from</span> <span class="hljs-string">'./js/camera.js'</span>;
<span class="hljs-keyword">import</span> { initDetector, detectHands, stopDetection } <span class="hljs-keyword">from</span> <span class="hljs-string">'./js/detector.js'</span>;
<span class="hljs-keyword">import</span> { updateStatus } <span class="hljs-keyword">from</span> <span class="hljs-string">'./js/utils.js'</span>;
<span class="hljs-keyword">import</span> { initSpeechSynthesis } <span class="hljs-keyword">from</span> <span class="hljs-string">'./js/voice.js'</span>;

<span class="hljs-comment">// 初始化语音合成</span>
<span class="hljs-keyword">let</span> voice = <span class="hljs-title function_">initSpeechSynthesis</span>();

<span class="hljs-comment">// 全局变量</span>
<span class="hljs-keyword">let</span> video, canvas, detector, animationId;

<span class="hljs-comment">// 初始化函数</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">init</span>(<span class="hljs-params"/>) {
  video = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'video'</span>);
  canvas = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'output'</span>);
  <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'startBtn'</span>).<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, toggleCamera);
  
  <span class="hljs-comment">// 加载模型</span>
  <span class="hljs-title function_">updateStatus</span>(<span class="hljs-string">'模型加载中...'</span>, <span class="hljs-literal">true</span>);
  <span class="hljs-keyword">try</span> {
    detector = <span class="hljs-keyword">await</span> <span class="hljs-title function_">initDetector</span>();
    <span class="hljs-title function_">updateStatus</span>(<span class="hljs-string">'模型加载成功，请启动摄像头'</span>);
    voice.<span class="hljs-title function_">synthesizeSpeechSentenceBySentence</span>(<span class="hljs-string">"模型加载成功，请启动摄像头"</span>);
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'模型加载失败:'</span>, error);
    <span class="hljs-title function_">updateStatus</span>(<span class="hljs-string">'模型加载失败: '</span> + error.<span class="hljs-property">message</span>);
  }
}

<span class="hljs-comment">// 切换摄像头状态</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">toggleCamera</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">if</span> (isCameraOn) {
    voice.<span class="hljs-title function_">synthesizeSpeechSentenceBySentence</span>(<span class="hljs-string">"摄像头已关闭"</span>);
    <span class="hljs-title function_">stopCamera</span>(video);
    <span class="hljs-title function_">stopDetection</span>(animationId);
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'startBtn'</span>).<span class="hljs-property">textContent</span> = <span class="hljs-string">'启动摄像头'</span>;
    <span class="hljs-title function_">updateStatus</span>(<span class="hljs-string">'摄像头已关闭'</span>);
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> startBtn = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'startBtn'</span>);
      startBtn.<span class="hljs-property">disabled</span> = <span class="hljs-literal">true</span>;
      startBtn.<span class="hljs-property">textContent</span> = <span class="hljs-string">'启动中...'</span>;
      
      voice.<span class="hljs-title function_">synthesizeSpeechSentenceBySentence</span>(<span class="hljs-string">"摄像头启动中"</span>);
      <span class="hljs-keyword">await</span> <span class="hljs-title function_">setupCamera</span>(video, canvas);
      startBtn.<span class="hljs-property">textContent</span> = <span class="hljs-string">'关闭摄像头'</span>;
      startBtn.<span class="hljs-property">disabled</span> = <span class="hljs-literal">false</span>;
      <span class="hljs-title function_">updateStatus</span>(<span class="hljs-string">'摄像头启动中...'</span>);
      
      <span class="hljs-comment">// 开始手部检测</span>
      animationId = <span class="hljs-title function_">detectHands</span>(video, canvas, detector);
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'摄像头启动失败:'</span>, error);
      <span class="hljs-title function_">updateStatus</span>(<span class="hljs-string">'摄像头启动失败: '</span> + error.<span class="hljs-property">message</span>);
    }
  }
}

<span class="hljs-comment">// 页面加载完成后初始化</span>
<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'load'</span>, init);
</code></pre>
<h4 data-id="heading-7">2. 手部检测与手势识别</h4>
<p><strong>detector.js</strong> - 核心模块，负责手部检测和手势识别</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> handPoseDetection <span class="hljs-keyword">from</span> <span class="hljs-string">'@tensorflow-models/hand-pose-detection'</span>;
<span class="hljs-keyword">import</span> { drawHands, clearCanvas } <span class="hljs-keyword">from</span> <span class="hljs-string">'./renderer.js'</span>;
<span class="hljs-keyword">import</span> { updateInteraction } <span class="hljs-keyword">from</span> <span class="hljs-string">'./interaction.js'</span>;
<span class="hljs-keyword">import</span> { updateStatus, updateInteractionStatus } <span class="hljs-keyword">from</span> <span class="hljs-string">'./utils.js'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-variable constant_">DETECTOR_CONFIG</span>, <span class="hljs-variable constant_">GESTURE_CONFIG</span>, <span class="hljs-variable constant_">PERFORMANCE_CONFIG</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./config.js'</span>;

<span class="hljs-comment">// 全局变量</span>
<span class="hljs-keyword">let</span> detector;
<span class="hljs-keyword">let</span> currentGesture = <span class="hljs-string">'未检测到手势'</span>;
<span class="hljs-keyword">let</span> handPosition = { <span class="hljs-attr">x</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">y</span>: <span class="hljs-number">0</span> };

<span class="hljs-comment">// 初始化手部检测器</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">initDetector</span>(<span class="hljs-params"/>) {
  detector = <span class="hljs-keyword">await</span> handPoseDetection.<span class="hljs-title function_">createDetector</span>(
    handPoseDetection.<span class="hljs-property">SupportedModels</span>.<span class="hljs-property">MediaPipeHands</span>, 
    {
      <span class="hljs-attr">runtime</span>: <span class="hljs-string">'mediapipe'</span>,
      <span class="hljs-attr">modelType</span>: <span class="hljs-variable constant_">DETECTOR_CONFIG</span>.<span class="hljs-property">MODEL_TYPE</span>,
      <span class="hljs-attr">maxHands</span>: <span class="hljs-variable constant_">DETECTOR_CONFIG</span>.<span class="hljs-property">MAX_HANDS</span>,
      <span class="hljs-attr">solutionPath</span>: <span class="hljs-variable constant_">DETECTOR_CONFIG</span>.<span class="hljs-property">SOLUTION_PATH</span>
    }
  );
  <span class="hljs-keyword">return</span> detector;
}

<span class="hljs-comment">// 检测手部函数</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">detectHands</span>(<span class="hljs-params">video, canvas, detector</span>) {
  <span class="hljs-keyword">let</span> animationId;
  <span class="hljs-keyword">const</span> ctx = canvas.<span class="hljs-title function_">getContext</span>(<span class="hljs-string">'2d'</span>);
  
  <span class="hljs-comment">// 性能监控变量</span>
  <span class="hljs-keyword">let</span> frameCount = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">let</span> lastFpsTime = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">let</span> currentFps = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">let</span> detectionInterval = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">let</span> lastDetectionTime = <span class="hljs-number">0</span>;
  
  <span class="hljs-comment">// 更新帧率函数</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">updateFps</span>(<span class="hljs-params">timestamp</span>) {
    frameCount++;
    <span class="hljs-keyword">if</span> (timestamp - lastFpsTime &gt;= <span class="hljs-variable constant_">PERFORMANCE_CONFIG</span>.<span class="hljs-property">FPS_CHECK_INTERVAL</span>) {
      currentFps = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">round</span>((frameCount * <span class="hljs-number">1000</span>) / (timestamp - lastFpsTime));
      frameCount = <span class="hljs-number">0</span>;
      lastFpsTime = timestamp;
      
      <span class="hljs-comment">// 动态调整检测间隔</span>
      <span class="hljs-keyword">if</span> (currentFps &gt; <span class="hljs-variable constant_">PERFORMANCE_CONFIG</span>.<span class="hljs-property">MAX_FPS</span>) {
        detectionInterval = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(detectionInterval + <span class="hljs-number">10</span>, <span class="hljs-number">100</span>);
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (currentFps &lt; <span class="hljs-variable constant_">PERFORMANCE_CONFIG</span>.<span class="hljs-property">MIN_FPS</span>) {
        detectionInterval = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(detectionInterval - <span class="hljs-number">10</span>, <span class="hljs-number">0</span>);
      }
    }
  }
  
  <span class="hljs-comment">// 内部检测函数</span>
  <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">detect</span>(<span class="hljs-params">timestamp</span>) {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-title function_">updateFps</span>(timestamp);
      
      <span class="hljs-comment">// 根据检测间隔控制检测频率</span>
      <span class="hljs-keyword">if</span> (timestamp - lastDetectionTime &gt;= detectionInterval) {
        <span class="hljs-comment">// 检测手部</span>
        <span class="hljs-keyword">const</span> hands = <span class="hljs-keyword">await</span> detector.<span class="hljs-title function_">estimateHands</span>(video, { 
          <span class="hljs-attr">flipHorizontal</span>: <span class="hljs-variable constant_">DETECTOR_CONFIG</span>.<span class="hljs-property">FLIP_HORIZONTAL</span> 
        });
        
        <span class="hljs-title function_">clearCanvas</span>(ctx, canvas);
        
        <span class="hljs-keyword">if</span> (hands.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
          <span class="hljs-title function_">drawHands</span>(ctx, hands);
          <span class="hljs-title function_">analyzeGesture</span>(hands[<span class="hljs-number">0</span>]);
          <span class="hljs-title function_">updateInteraction</span>(hands[<span class="hljs-number">0</span>], canvas, currentGesture, handPosition);
        } <span class="hljs-keyword">else</span> {
          currentGesture = <span class="hljs-string">'未检测到手势'</span>;
          <span class="hljs-title function_">updateInteractionStatus</span>(currentGesture);
        }
        
        <span class="hljs-title function_">updateStatus</span>(<span class="hljs-string">`检测到 <span class="hljs-subst">${hands.length}</span> 只手 | 帧率: <span class="hljs-subst">${currentFps}</span>`</span>);
        lastDetectionTime = timestamp;
      }
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'手部检测错误:'</span>, error);
    }
    
    animationId = <span class="hljs-title function_">requestAnimationFrame</span>(detect);
  }
  
  <span class="hljs-title function_">detect</span>(<span class="hljs-number">0</span>);
  <span class="hljs-keyword">return</span> animationId;
}

<span class="hljs-comment">// 分析手势函数</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">analyzeGesture</span>(<span class="hljs-params">hand</span>) {
  <span class="hljs-comment">// 获取手腕关键点</span>
  <span class="hljs-keyword">const</span> wrist = hand.<span class="hljs-property">keypoints</span>.<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">k</span> =&gt;</span> k.<span class="hljs-property">name</span> === <span class="hljs-string">'wrist'</span>);
  
  <span class="hljs-comment">// 更新手部位置</span>
  <span class="hljs-keyword">if</span> (wrist) {
    handPosition.<span class="hljs-property">x</span> = wrist.<span class="hljs-property">x</span>;
    handPosition.<span class="hljs-property">y</span> = wrist.<span class="hljs-property">y</span>;
  }
  
  <span class="hljs-comment">// 获取手指关键点</span>
  <span class="hljs-keyword">const</span> thumbTip = hand.<span class="hljs-property">keypoints</span>.<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">k</span> =&gt;</span> k.<span class="hljs-property">name</span> === <span class="hljs-string">'thumb_tip'</span>);
  <span class="hljs-keyword">const</span> indexTip = hand.<span class="hljs-property">keypoints</span>.<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">k</span> =&gt;</span> k.<span class="hljs-property">name</span> === <span class="hljs-string">'index_finger_tip'</span>);
  <span class="hljs-keyword">const</span> middleTip = hand.<span class="hljs-property">keypoints</span>.<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">k</span> =&gt;</span> k.<span class="hljs-property">name</span> === <span class="hljs-string">'middle_finger_tip'</span>);
  <span class="hljs-keyword">const</span> ringTip = hand.<span class="hljs-property">keypoints</span>.<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">k</span> =&gt;</span> k.<span class="hljs-property">name</span> === <span class="hljs-string">'ring_finger_tip'</span>);
  <span class="hljs-keyword">const</span> pinkyTip = hand.<span class="hljs-property">keypoints</span>.<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">k</span> =&gt;</span> k.<span class="hljs-property">name</span> === <span class="hljs-string">'pinky_tip'</span>);
  
  <span class="hljs-comment">// 获取手指根部关键点</span>
  <span class="hljs-keyword">const</span> indexMcp = hand.<span class="hljs-property">keypoints</span>.<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">k</span> =&gt;</span> k.<span class="hljs-property">name</span> === <span class="hljs-string">'index_finger_mcp'</span>);
  <span class="hljs-keyword">const</span> middleMcp = hand.<span class="hljs-property">keypoints</span>.<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">k</span> =&gt;</span> k.<span class="hljs-property">name</span> === <span class="hljs-string">'middle_finger_mcp'</span>);
  <span class="hljs-keyword">const</span> ringMcp = hand.<span class="hljs-property">keypoints</span>.<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">k</span> =&gt;</span> k.<span class="hljs-property">name</span> === <span class="hljs-string">'ring_finger_mcp'</span>);
  <span class="hljs-keyword">const</span> pinkyMcp = hand.<span class="hljs-property">keypoints</span>.<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">k</span> =&gt;</span> k.<span class="hljs-property">name</span> === <span class="hljs-string">'pinky_mcp'</span>);
  <span class="hljs-keyword">const</span> thumbMcp = hand.<span class="hljs-property">keypoints</span>.<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">k</span> =&gt;</span> k.<span class="hljs-property">name</span> === <span class="hljs-string">'thumb_mcp'</span>);
  
  <span class="hljs-comment">// 手势识别逻辑</span>
  <span class="hljs-keyword">if</span> (thumbTip &amp;&amp; indexTip &amp;&amp; middleTip &amp;&amp; ringTip &amp;&amp; pinkyTip &amp;&amp; 
      indexMcp &amp;&amp; middleMcp &amp;&amp; ringMcp &amp;&amp; pinkyMcp &amp;&amp; thumbMcp &amp;&amp; wrist) {
    
    <span class="hljs-comment">// 计算拇指和食指指尖距离</span>
    <span class="hljs-keyword">const</span> thumbIndexDistance = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sqrt</span>(
      <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">pow</span>(thumbTip.<span class="hljs-property">x</span> - indexTip.<span class="hljs-property">x</span>, <span class="hljs-number">2</span>) + 
      <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">pow</span>(thumbTip.<span class="hljs-property">y</span> - indexTip.<span class="hljs-property">y</span>, <span class="hljs-number">2</span>)
    );
    
    <span class="hljs-comment">// 计算手指弯曲程度</span>
    <span class="hljs-keyword">const</span> indexBent = <span class="hljs-title function_">calculateFingerBent</span>(indexTip, indexMcp, wrist);
    <span class="hljs-keyword">const</span> middleBent = <span class="hljs-title function_">calculateFingerBent</span>(middleTip, middleMcp, wrist);
    <span class="hljs-keyword">const</span> ringBent = <span class="hljs-title function_">calculateFingerBent</span>(ringTip, ringMcp, wrist);
    <span class="hljs-keyword">const</span> pinkyBent = <span class="hljs-title function_">calculateFingerBent</span>(pinkyTip, pinkyMcp, wrist);
    <span class="hljs-keyword">const</span> thumbBent = <span class="hljs-title function_">calculateFingerBent</span>(thumbTip, thumbMcp, wrist);
    
    <span class="hljs-keyword">const</span> avgBent = (indexBent + middleBent + ringBent + pinkyBent) / <span class="hljs-number">4</span>;
    
    <span class="hljs-comment">// 手势识别</span>
    <span class="hljs-keyword">if</span> (avgBent &gt; <span class="hljs-variable constant_">GESTURE_CONFIG</span>.<span class="hljs-property">FIST_THRESHOLD</span> &amp;&amp; thumbBent &gt; <span class="hljs-variable constant_">GESTURE_CONFIG</span>.<span class="hljs-property">FIST_THRESHOLD</span>) {
      currentGesture = <span class="hljs-string">'拳头手势'</span>;
    }
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (indexBent &lt; <span class="hljs-number">0.3</span> &amp;&amp; middleBent &gt; <span class="hljs-number">0.5</span> &amp;&amp; ringBent &gt; <span class="hljs-number">0.5</span> &amp;&amp; pinkyBent &gt; <span class="hljs-number">0.5</span>) {
      currentGesture = <span class="hljs-string">'点赞手势'</span>;
    }
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (thumbIndexDistance &lt; <span class="hljs-variable constant_">GESTURE_CONFIG</span>.<span class="hljs-property">GRAB_THRESHOLD</span>) {
      currentGesture = <span class="hljs-string">'抓取手势'</span>;
    }
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (thumbIndexDistance &lt; <span class="hljs-variable constant_">GESTURE_CONFIG</span>.<span class="hljs-property">OK_THRESHOLD</span> &amp;&amp; 
             indexBent &lt; <span class="hljs-number">0.3</span> &amp;&amp; middleBent &lt; <span class="hljs-number">0.3</span> &amp;&amp; ringBent &lt; <span class="hljs-number">0.3</span> &amp;&amp; pinkyBent &lt; <span class="hljs-number">0.3</span>) {
      currentGesture = <span class="hljs-string">'OK手势'</span>;
    }
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (indexBent &lt; <span class="hljs-number">0.3</span> &amp;&amp; middleBent &lt; <span class="hljs-number">0.3</span> &amp;&amp; ringBent &lt; <span class="hljs-number">0.3</span> &amp;&amp; pinkyBent &lt; <span class="hljs-number">0.3</span>) {
      currentGesture = <span class="hljs-string">'张开手势'</span>;
    }
    <span class="hljs-keyword">else</span> {
      currentGesture = <span class="hljs-string">'未检测到手势'</span>;
    }
  }
  <span class="hljs-keyword">else</span> {
    currentGesture = <span class="hljs-string">'未检测到手势'</span>;
  }
  
  <span class="hljs-title function_">updateInteractionStatus</span>(currentGesture);
}

<span class="hljs-comment">// 辅助函数：计算手指弯曲程度</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">calculateFingerBent</span>(<span class="hljs-params">tip, mcp, wrist</span>) {
  <span class="hljs-keyword">const</span> fingerLength = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sqrt</span>(
    <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">pow</span>(tip.<span class="hljs-property">x</span> - mcp.<span class="hljs-property">x</span>, <span class="hljs-number">2</span>) + 
    <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">pow</span>(tip.<span class="hljs-property">y</span> - mcp.<span class="hljs-property">y</span>, <span class="hljs-number">2</span>)
  );
  
  <span class="hljs-keyword">const</span> wristToTip = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sqrt</span>(
    <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">pow</span>(tip.<span class="hljs-property">x</span> - wrist.<span class="hljs-property">x</span>, <span class="hljs-number">2</span>) + 
    <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">pow</span>(tip.<span class="hljs-property">y</span> - wrist.<span class="hljs-property">y</span>, <span class="hljs-number">2</span>)
  );
  
  <span class="hljs-keyword">const</span> wristToMcp = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sqrt</span>(
    <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">pow</span>(mcp.<span class="hljs-property">x</span> - wrist.<span class="hljs-property">x</span>, <span class="hljs-number">2</span>) + 
    <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">pow</span>(mcp.<span class="hljs-property">y</span> - wrist.<span class="hljs-property">y</span>, <span class="hljs-number">2</span>)
  );
  
  <span class="hljs-keyword">const</span> cosAngle = (wristToTip * wristToTip + wristToMcp * wristToMcp - fingerLength * fingerLength) / 
                  (<span class="hljs-number">2</span> * wristToTip * wristToMcp);
  
  <span class="hljs-keyword">const</span> angle = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">acos</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(-<span class="hljs-number">1</span>, <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(<span class="hljs-number">1</span>, cosAngle)));
  <span class="hljs-keyword">return</span> angle / <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span>; <span class="hljs-comment">// 归一化到0-1范围</span>
}
</code></pre>
<h4 data-id="heading-8">3. 手部关键点绘制</h4>
<p><strong>renderer.js</strong> - 负责绘制手部关键点和连接线</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { <span class="hljs-variable constant_">VISUAL_CONFIG</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./config.js'</span>;

<span class="hljs-comment">// 清除画布函数</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">clearCanvas</span>(<span class="hljs-params">ctx, canvas</span>) {
  ctx.<span class="hljs-title function_">clearRect</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, canvas.<span class="hljs-property">width</span>, canvas.<span class="hljs-property">height</span>);
}

<span class="hljs-comment">// 绘制手部关键点和连接线函数</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">drawHands</span>(<span class="hljs-params">ctx, hands</span>) {
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> hand <span class="hljs-keyword">of</span> hands) {
    <span class="hljs-comment">// 绘制手部轮廓</span>
    <span class="hljs-title function_">drawHandOutline</span>(ctx, hand.<span class="hljs-property">keypoints</span>);
    
    <span class="hljs-comment">// 绘制连接线</span>
    <span class="hljs-title function_">drawConnections</span>(ctx, hand);
    
    <span class="hljs-comment">// 绘制每个关键点</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> keypoint <span class="hljs-keyword">of</span> hand.<span class="hljs-property">keypoints</span>) {
      <span class="hljs-keyword">const</span> { x, y } = keypoint;
      
      ctx.<span class="hljs-title function_">beginPath</span>();
      ctx.<span class="hljs-title function_">arc</span>(x, y, <span class="hljs-variable constant_">VISUAL_CONFIG</span>.<span class="hljs-property">KEYPOINT_RADIUS</span>, <span class="hljs-number">0</span>, <span class="hljs-number">2</span> * <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span>);
      
      <span class="hljs-comment">// 根据关键点类型设置不同颜色</span>
      <span class="hljs-keyword">if</span> (keypoint.<span class="hljs-property">name</span> === <span class="hljs-string">'wrist'</span>) {
        ctx.<span class="hljs-property">fillStyle</span> = <span class="hljs-string">'purple'</span>;
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (keypoint.<span class="hljs-property">name</span>.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'thumb'</span>)) {
        ctx.<span class="hljs-property">fillStyle</span> = <span class="hljs-string">'red'</span>;
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (keypoint.<span class="hljs-property">name</span>.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'index'</span>)) {
        ctx.<span class="hljs-property">fillStyle</span> = <span class="hljs-string">'blue'</span>;
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (keypoint.<span class="hljs-property">name</span>.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'middle'</span>)) {
        ctx.<span class="hljs-property">fillStyle</span> = <span class="hljs-string">'green'</span>;
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (keypoint.<span class="hljs-property">name</span>.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'ring'</span>)) {
        ctx.<span class="hljs-property">fillStyle</span> = <span class="hljs-string">'orange'</span>;
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (keypoint.<span class="hljs-property">name</span>.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'pinky'</span>)) {
        ctx.<span class="hljs-property">fillStyle</span> = <span class="hljs-string">'yellow'</span>;
      } <span class="hljs-keyword">else</span> {
        ctx.<span class="hljs-property">fillStyle</span> = <span class="hljs-string">'white'</span>;
      }
      
      ctx.<span class="hljs-title function_">fill</span>();
      ctx.<span class="hljs-property">strokeStyle</span> = <span class="hljs-string">'black'</span>;
      ctx.<span class="hljs-property">lineWidth</span> = <span class="hljs-number">1</span>;
      ctx.<span class="hljs-title function_">stroke</span>();
    }
  }
}

<span class="hljs-comment">// 绘制连接线函数</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">drawConnections</span>(<span class="hljs-params">ctx, hand</span>) {
  ctx.<span class="hljs-property">strokeStyle</span> = <span class="hljs-string">'rgba(255, 255, 255, 0.7)'</span>;
  ctx.<span class="hljs-property">lineWidth</span> = <span class="hljs-variable constant_">VISUAL_CONFIG</span>.<span class="hljs-property">CONNECTION_WIDTH</span>;
  ctx.<span class="hljs-property">lineCap</span> = <span class="hljs-string">'round'</span>;
  
  <span class="hljs-comment">// 使用模型提供的默认连接</span>
  <span class="hljs-keyword">if</span> (hand.<span class="hljs-property">connections</span>) {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> connection <span class="hljs-keyword">of</span> hand.<span class="hljs-property">connections</span>) {
      <span class="hljs-keyword">const</span> startPoint = hand.<span class="hljs-property">keypoints</span>[connection[<span class="hljs-number">0</span>]];
      <span class="hljs-keyword">const</span> endPoint = hand.<span class="hljs-property">keypoints</span>[connection[<span class="hljs-number">1</span>]];
      
      <span class="hljs-keyword">if</span> (startPoint &amp;&amp; endPoint) {
        ctx.<span class="hljs-title function_">beginPath</span>();
        ctx.<span class="hljs-title function_">moveTo</span>(startPoint.<span class="hljs-property">x</span>, startPoint.<span class="hljs-property">y</span>);
        ctx.<span class="hljs-title function_">lineTo</span>(endPoint.<span class="hljs-property">x</span>, endPoint.<span class="hljs-property">y</span>);
        ctx.<span class="hljs-title function_">stroke</span>();
      }
    }
  }
}
</code></pre>
<h4 data-id="heading-9">4. 物品交互逻辑</h4>
<p><strong>interaction.js</strong> - 处理物品的抓取、移动、旋转和缩放</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { initSpeechSynthesis } <span class="hljs-keyword">from</span> <span class="hljs-string">'./voice.js'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-variable constant_">INTERACTION_CONFIG</span>, <span class="hljs-variable constant_">VISUAL_CONFIG</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./config.js'</span>;

<span class="hljs-keyword">let</span> voice = <span class="hljs-title function_">initSpeechSynthesis</span>();
<span class="hljs-keyword">let</span> grabbedObject = <span class="hljs-literal">null</span>;
<span class="hljs-keyword">let</span> grabOffset = { <span class="hljs-attr">x</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">y</span>: <span class="hljs-number">0</span> };
<span class="hljs-keyword">let</span> objectTransform = { <span class="hljs-attr">rotation</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">scale</span>: <span class="hljs-number">1</span> };
<span class="hljs-keyword">let</span> rotationReference = <span class="hljs-literal">null</span>;

<span class="hljs-comment">// 更新交互函数</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">updateInteraction</span>(<span class="hljs-params">hand, canvas, currentGesture, handPosition</span>) {
  <span class="hljs-keyword">const</span> interactionArea = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.interaction-area'</span>);
  <span class="hljs-keyword">const</span> rect = interactionArea.<span class="hljs-title function_">getBoundingClientRect</span>();
  
  <span class="hljs-comment">// 将手部位置从画布坐标系转换到交互区域坐标系</span>
  <span class="hljs-keyword">const</span> mappedX = (handPosition.<span class="hljs-property">x</span> / canvas.<span class="hljs-property">width</span>) * rect.<span class="hljs-property">width</span>;
  <span class="hljs-keyword">const</span> mappedY = (handPosition.<span class="hljs-property">y</span> / canvas.<span class="hljs-property">height</span>) * rect.<span class="hljs-property">height</span>;
  
  <span class="hljs-comment">// 显示虚拟光标</span>
  <span class="hljs-title function_">showCursor</span>(interactionArea, mappedX, mappedY, currentGesture);
  
  <span class="hljs-comment">// 处理抓取逻辑</span>
  <span class="hljs-keyword">if</span> (currentGesture === <span class="hljs-string">'抓取手势'</span> &amp;&amp; !grabbedObject) {
    <span class="hljs-title function_">tryGrabObject</span>(mappedX, mappedY);
  } 
  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (currentGesture === <span class="hljs-string">'张开手势'</span> &amp;&amp; grabbedObject) {
    <span class="hljs-title function_">releaseObject</span>();
  }
  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (currentGesture === <span class="hljs-string">'OK手势'</span> &amp;&amp; grabbedObject) {
    <span class="hljs-title function_">rotateObject</span>(hand, mappedX, mappedY);
  }
  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (currentGesture === <span class="hljs-string">'点赞手势'</span> &amp;&amp; grabbedObject) {
    <span class="hljs-title function_">scaleObject</span>(hand, mappedX, mappedY);
  }
  
  <span class="hljs-comment">// 移动已抓取的物品</span>
  <span class="hljs-keyword">if</span> (grabbedObject &amp;&amp; currentGesture === <span class="hljs-string">'抓取手势'</span>) {
    <span class="hljs-title function_">moveObject</span>(mappedX, mappedY);
  }
}

<span class="hljs-comment">// 显示虚拟光标函数</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">showCursor</span>(<span class="hljs-params">area, x, y, currentGesture</span>) {
  <span class="hljs-keyword">let</span> cursor = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'hand-cursor'</span>);
  
  <span class="hljs-keyword">if</span> (!cursor) {
    cursor = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'div'</span>);
    cursor.<span class="hljs-property">id</span> = <span class="hljs-string">'hand-cursor'</span>;
    cursor.<span class="hljs-property">style</span>.<span class="hljs-property">position</span> = <span class="hljs-string">'absolute'</span>;
    cursor.<span class="hljs-property">style</span>.<span class="hljs-property">width</span> = <span class="hljs-string">`<span class="hljs-subst">${INTERACTION_CONFIG.CURSOR_SIZE}</span>px`</span>;
    cursor.<span class="hljs-property">style</span>.<span class="hljs-property">height</span> = <span class="hljs-string">`<span class="hljs-subst">${INTERACTION_CONFIG.CURSOR_SIZE}</span>px`</span>;
    cursor.<span class="hljs-property">style</span>.<span class="hljs-property">borderRadius</span> = <span class="hljs-string">'50%'</span>;
    cursor.<span class="hljs-property">style</span>.<span class="hljs-property">pointerEvents</span> = <span class="hljs-string">'none'</span>;
    cursor.<span class="hljs-property">style</span>.<span class="hljs-property">zIndex</span> = <span class="hljs-string">'10'</span>;
    cursor.<span class="hljs-property">style</span>.<span class="hljs-property">transform</span> = <span class="hljs-string">'translate(-50%, -50%)'</span>;
    cursor.<span class="hljs-property">style</span>.<span class="hljs-property">transition</span> = <span class="hljs-string">'all 0.1s ease'</span>;
    area.<span class="hljs-title function_">appendChild</span>(cursor);
  }
  
  <span class="hljs-comment">// 根据手势设置光标样式</span>
  <span class="hljs-keyword">let</span> cursorColor;
  <span class="hljs-keyword">let</span> cursorSize = <span class="hljs-variable constant_">INTERACTION_CONFIG</span>.<span class="hljs-property">CURSOR_SIZE</span>;
  
  <span class="hljs-keyword">switch</span> (currentGesture) {
    <span class="hljs-keyword">case</span> <span class="hljs-string">'抓取手势'</span>:
      cursorColor = <span class="hljs-variable constant_">VISUAL_CONFIG</span>.<span class="hljs-property">CURSOR_COLOR_GRAB</span>;
      cursorSize = <span class="hljs-variable constant_">INTERACTION_CONFIG</span>.<span class="hljs-property">CURSOR_SIZE</span> * <span class="hljs-number">1.2</span>;
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-string">'张开手势'</span>:
      cursorColor = <span class="hljs-variable constant_">VISUAL_CONFIG</span>.<span class="hljs-property">CURSOR_COLOR_OPEN</span>;
      <span class="hljs-keyword">break</span>;
    <span class="hljs-attr">default</span>:
      cursorColor = <span class="hljs-variable constant_">VISUAL_CONFIG</span>.<span class="hljs-property">CURSOR_COLOR_OTHER</span>;
      <span class="hljs-keyword">break</span>;
  }
  
  cursor.<span class="hljs-property">style</span>.<span class="hljs-property">left</span> = x + <span class="hljs-string">'px'</span>;
  cursor.<span class="hljs-property">style</span>.<span class="hljs-property">top</span> = y + <span class="hljs-string">'px'</span>;
  cursor.<span class="hljs-property">style</span>.<span class="hljs-property">background</span> = cursorColor;
  cursor.<span class="hljs-property">style</span>.<span class="hljs-property">width</span> = <span class="hljs-string">`<span class="hljs-subst">${cursorSize}</span>px`</span>;
  cursor.<span class="hljs-property">style</span>.<span class="hljs-property">height</span> = <span class="hljs-string">`<span class="hljs-subst">${cursorSize}</span>px`</span>;
}

<span class="hljs-comment">// 尝试抓取物品函数</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">tryGrabObject</span>(<span class="hljs-params">cursorX, cursorY</span>) {
  <span class="hljs-keyword">const</span> objects = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelectorAll</span>(<span class="hljs-string">'.object'</span>);
  <span class="hljs-keyword">const</span> interactionArea = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.interaction-area'</span>);
  
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> obj <span class="hljs-keyword">of</span> objects) {
    <span class="hljs-keyword">const</span> objRect = obj.<span class="hljs-title function_">getBoundingClientRect</span>();
    <span class="hljs-keyword">const</span> areaRect = interactionArea.<span class="hljs-title function_">getBoundingClientRect</span>();
    
    <span class="hljs-keyword">const</span> objLeft = objRect.<span class="hljs-property">left</span> - areaRect.<span class="hljs-property">left</span>;
    <span class="hljs-keyword">const</span> objTop = objRect.<span class="hljs-property">top</span> - areaRect.<span class="hljs-property">top</span>;
    <span class="hljs-keyword">const</span> objCenterX = objLeft + objRect.<span class="hljs-property">width</span> / <span class="hljs-number">2</span>;
    <span class="hljs-keyword">const</span> objCenterY = objTop + objRect.<span class="hljs-property">height</span> / <span class="hljs-number">2</span>;
    
    <span class="hljs-comment">// 计算距离</span>
    <span class="hljs-keyword">const</span> distance = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sqrt</span>(
      <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">pow</span>(cursorX - objCenterX, <span class="hljs-number">2</span>) + 
      <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">pow</span>(cursorY - objCenterY, <span class="hljs-number">2</span>)
    );
    
    <span class="hljs-comment">// 如果距离足够近，则抓取物品</span>
    <span class="hljs-keyword">if</span> (distance &lt; <span class="hljs-variable constant_">INTERACTION_CONFIG</span>.<span class="hljs-property">GRAB_DISTANCE</span>) {
      <span class="hljs-comment">// 播放抓取语音提示</span>
      voice.<span class="hljs-title function_">synthesizeSpeechSentenceBySentence</span>(<span class="hljs-string">"抓取"</span> + obj.<span class="hljs-property">innerHTML</span>);
      
      <span class="hljs-comment">// 计算偏移量</span>
      grabOffset = {
        <span class="hljs-attr">x</span>: cursorX - objLeft,
        <span class="hljs-attr">y</span>: cursorY - objTop
      };
      
      grabbedObject = obj;
      obj.<span class="hljs-property">classList</span>.<span class="hljs-title function_">add</span>(<span class="hljs-string">'grabbing'</span>);
      <span class="hljs-keyword">break</span>;
    }
  }
}

<span class="hljs-comment">// 移动物品函数</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">moveObject</span>(<span class="hljs-params">cursorX, cursorY</span>) {
  <span class="hljs-keyword">if</span> (grabbedObject) {
    <span class="hljs-keyword">const</span> newLeft = cursorX - grabOffset.<span class="hljs-property">x</span>;
    <span class="hljs-keyword">const</span> newTop = cursorY - grabOffset.<span class="hljs-property">y</span>;
    
    <span class="hljs-comment">// 确保物品不会移出交互区域</span>
    <span class="hljs-keyword">const</span> interactionArea = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.interaction-area'</span>);
    <span class="hljs-keyword">const</span> maxX = interactionArea.<span class="hljs-property">offsetWidth</span> - grabbedObject.<span class="hljs-property">offsetWidth</span>;
    <span class="hljs-keyword">const</span> maxY = interactionArea.<span class="hljs-property">offsetHeight</span> - grabbedObject.<span class="hljs-property">offsetHeight</span>;
    
    <span class="hljs-comment">// 更新物品位置</span>
    grabbedObject.<span class="hljs-property">style</span>.<span class="hljs-property">left</span> = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-number">0</span>, <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(newLeft, maxX)) + <span class="hljs-string">'px'</span>;
    grabbedObject.<span class="hljs-property">style</span>.<span class="hljs-property">top</span> = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-number">0</span>, <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(newTop, maxY)) + <span class="hljs-string">'px'</span>;
  }
}

<span class="hljs-comment">// 旋转物品函数</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">rotateObject</span>(<span class="hljs-params">hand, cursorX, cursorY</span>) {
  <span class="hljs-keyword">if</span> (grabbedObject &amp;&amp; rotationReference) {
    <span class="hljs-keyword">const</span> deltaX = cursorX - rotationReference.<span class="hljs-property">x</span>;
    objectTransform.<span class="hljs-property">rotation</span> += deltaX * <span class="hljs-variable constant_">INTERACTION_CONFIG</span>.<span class="hljs-property">ROTATE_SPEED</span>;
    <span class="hljs-title function_">applyTransform</span>();
    rotationReference = { <span class="hljs-attr">x</span>: cursorX, <span class="hljs-attr">y</span>: cursorY };
  }
}

<span class="hljs-comment">// 缩放物品函数</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">scaleObject</span>(<span class="hljs-params">hand, cursorX, cursorY</span>) {
  <span class="hljs-keyword">if</span> (grabbedObject) {
    <span class="hljs-keyword">const</span> indexTip = hand.<span class="hljs-property">keypoints</span>.<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">k</span> =&gt;</span> k.<span class="hljs-property">name</span> === <span class="hljs-string">'index_finger_tip'</span>);
    <span class="hljs-keyword">const</span> middleTip = hand.<span class="hljs-property">keypoints</span>.<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">k</span> =&gt;</span> k.<span class="hljs-property">name</span> === <span class="hljs-string">'middle_finger_tip'</span>);
    
    <span class="hljs-keyword">if</span> (indexTip &amp;&amp; middleTip) {
      <span class="hljs-keyword">const</span> fingerDistance = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sqrt</span>(
        <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">pow</span>(indexTip.<span class="hljs-property">x</span> - middleTip.<span class="hljs-property">x</span>, <span class="hljs-number">2</span>) + 
        <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">pow</span>(indexTip.<span class="hljs-property">y</span> - middleTip.<span class="hljs-property">y</span>, <span class="hljs-number">2</span>)
      );
      
      <span class="hljs-keyword">const</span> scaleFactor = <span class="hljs-number">1</span> + (fingerDistance - <span class="hljs-number">50</span>) * <span class="hljs-variable constant_">INTERACTION_CONFIG</span>.<span class="hljs-property">SCALE_SPEED</span> * <span class="hljs-number">0.01</span>;
      objectTransform.<span class="hljs-property">scale</span> = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-number">0.5</span>, <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(objectTransform.<span class="hljs-property">scale</span> * scaleFactor, <span class="hljs-number">2</span>));
      <span class="hljs-title function_">applyTransform</span>();
    }
  }
}

<span class="hljs-comment">// 应用变换函数</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">applyTransform</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">if</span> (grabbedObject) {
    grabbedObject.<span class="hljs-property">style</span>.<span class="hljs-property">transform</span> = <span class="hljs-string">`rotate(<span class="hljs-subst">${objectTransform.rotation}</span>deg) scale(<span class="hljs-subst">${objectTransform.scale}</span>)`</span>;
  }
}

<span class="hljs-comment">// 释放物品函数</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">releaseObject</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">if</span> (grabbedObject) {
    grabbedObject.<span class="hljs-property">classList</span>.<span class="hljs-title function_">remove</span>(<span class="hljs-string">'grabbing'</span>);
    grabbedObject = <span class="hljs-literal">null</span>;
    grabOffset = { <span class="hljs-attr">x</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">y</span>: <span class="hljs-number">0</span> };
    rotationReference = <span class="hljs-literal">null</span>;
  }
}
</code></pre>
<h3 data-id="heading-10">项目结构与配置</h3>
<h4 data-id="heading-11">配置文件设计</h4>
<p><strong>config.js</strong> - 集中管理项目常量和配置项</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 摄像头配置</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">CAMERA_CONFIG</span> = {
  <span class="hljs-attr">WIDTH</span>: <span class="hljs-number">640</span>,
  <span class="hljs-attr">HEIGHT</span>: <span class="hljs-number">480</span>,
  <span class="hljs-attr">FACING_MODE</span>: <span class="hljs-string">'user'</span>
};

<span class="hljs-comment">// 手部检测模型配置</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">DETECTOR_CONFIG</span> = {
  <span class="hljs-attr">MODEL_TYPE</span>: <span class="hljs-string">'full'</span>,
  <span class="hljs-attr">MAX_HANDS</span>: <span class="hljs-number">2</span>,
  <span class="hljs-attr">FLIP_HORIZONTAL</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">SOLUTION_PATH</span>: <span class="hljs-string">"node_modules/@mediapipe/hands/"</span>
};

<span class="hljs-comment">// 手势识别配置</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">GESTURE_CONFIG</span> = {
  <span class="hljs-attr">GRAB_THRESHOLD</span>: <span class="hljs-number">40</span>,
  <span class="hljs-attr">FIST_THRESHOLD</span>: <span class="hljs-number">0.5</span>,
  <span class="hljs-attr">OK_THRESHOLD</span>: <span class="hljs-number">30</span>,
  <span class="hljs-attr">LIKE_THRESHOLD</span>: <span class="hljs-number">0.8</span>
};

<span class="hljs-comment">// 交互配置</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">INTERACTION_CONFIG</span> = {
  <span class="hljs-attr">CURSOR_SIZE</span>: <span class="hljs-number">20</span>,
  <span class="hljs-attr">GRAB_DISTANCE</span>: <span class="hljs-number">50</span>,
  <span class="hljs-attr">MOVE_SPEED</span>: <span class="hljs-number">1</span>,
  <span class="hljs-attr">ROTATE_SPEED</span>: <span class="hljs-number">0.01</span>,
  <span class="hljs-attr">SCALE_SPEED</span>: <span class="hljs-number">0.01</span>
};

<span class="hljs-comment">// 视觉效果配置</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">VISUAL_CONFIG</span> = {
  <span class="hljs-attr">KEYPOINT_RADIUS</span>: <span class="hljs-number">5</span>,
  <span class="hljs-attr">CONNECTION_WIDTH</span>: <span class="hljs-number">3</span>,
  <span class="hljs-attr">HAND_OUTLINE_OPACITY</span>: <span class="hljs-number">0.5</span>,
  <span class="hljs-attr">CURSOR_COLOR_OPEN</span>: <span class="hljs-string">'green'</span>,
  <span class="hljs-attr">CURSOR_COLOR_GRAB</span>: <span class="hljs-string">'red'</span>,
  <span class="hljs-attr">CURSOR_COLOR_OTHER</span>: <span class="hljs-string">'yellow'</span>
};

<span class="hljs-comment">// 性能配置</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">PERFORMANCE_CONFIG</span> = {
  <span class="hljs-attr">MAX_FPS</span>: <span class="hljs-number">30</span>,
  <span class="hljs-attr">MIN_FPS</span>: <span class="hljs-number">10</span>,
  <span class="hljs-attr">FPS_CHECK_INTERVAL</span>: <span class="hljs-number">1000</span>,
  <span class="hljs-attr">PERFORMANCE_THRESHOLD</span>: <span class="hljs-number">0.8</span>
};

<span class="hljs-comment">// 语音配置</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">VOICE_CONFIG</span> = {
  <span class="hljs-attr">RATE</span>: <span class="hljs-number">1.2</span>,
  <span class="hljs-attr">PITCH</span>: <span class="hljs-number">1.0</span>,
  <span class="hljs-attr">VOLUME</span>: <span class="hljs-number">1.0</span>,
  <span class="hljs-attr">TIMEOUT</span>: <span class="hljs-number">1000</span>
};
</code></pre>
<h3 data-id="heading-12">使用说明</h3>
<ol>
<li><strong>启动应用</strong>：点击"启动摄像头"按钮，授权摄像头使用权限</li>
<li><strong>手势控制</strong>：
<ul>
<li>张开手掌：移动虚拟光标</li>
<li>拇指和食指靠近：抓取物品</li>
<li>抓取状态下移动手部：移动物品</li>
<li>OK手势：旋转物品</li>
<li>点赞手势：缩放物品</li>
<li>再次张开手掌：释放物品</li>
</ul>
</li>
<li><strong>语音反馈</strong>：操作过程中会有语音提示</li>
</ol>
<h3 data-id="heading-13">扩展建议</h3>
<ol>
<li><strong>添加更多手势</strong>：可以扩展识别更多手势，如剪刀手、石头剪刀布等</li>
<li><strong>增强物品交互</strong>：添加物品碰撞检测、物理引擎支持</li>
<li><strong>多手协作</strong>：实现双手同时操作不同物品</li>
<li><strong>自定义物品</strong>：允许用户添加、删除和自定义虚拟物品</li>
<li><strong>保存和加载场景</strong>：支持保存当前物品布局，下次打开时恢复</li>
<li><strong>AR模式</strong>：结合 WebXR API，实现增强现实手势交互</li>
<li><strong>模型优化</strong>：尝试使用自定义训练的模型，提高特定场景下的识别准确率</li>
</ol>
<h3 data-id="heading-14">总结</h3>
<p>本项目展示了如何使用 TensorFlow.js 和 MediaPipeHands 模型实现实时手势交互应用。通过模块化设计和清晰的代码结构，实现了手部检测、手势识别、虚拟光标控制、物品抓取移动以及语音反馈等功能。</p>
<p>该项目具有良好的可扩展性，可以根据需求添加更多手势和交互功能。同时，通过动态性能调整，确保在不同设备上都能流畅运行。</p>
<p>手势交互作为一种自然、直观的交互方式，在未来的 Web 应用中有着广阔的应用前景。希望本项目能为开发者提供一个良好的起点，激发更多创意和应用场景。</p>
<h3 data-id="heading-15">项目地址</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fyourusername%2Fhand-gesture-grab" target="_blank" title="https://github.com/yourusername/hand-gesture-grab" ref="nofollow noopener noreferrer">GitHub 仓库链接</a></p>
<h3 data-id="heading-16">参考资料</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.tensorflow.org%2Fjs" target="_blank" title="https://www.tensorflow.org/js" ref="nofollow noopener noreferrer">TensorFlow.js 官方文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgoogle.github.io%2Fmediapipe%2Fsolutions%2Fhands.html" target="_blank" title="https://google.github.io/mediapipe/solutions/hands.html" ref="nofollow noopener noreferrer">MediaPipeHands 模型文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fen-US%2Fdocs%2FWeb%2FAPI%2FWeb_Speech_API" target="_blank" title="https://developer.mozilla.org/en-US/docs/Web/API/Web_Speech_API" ref="nofollow noopener noreferrer">Web Speech API 文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fen-US%2Fdocs%2FWeb%2FAPI%2FWebRTC_API" target="_blank" title="https://developer.mozilla.org/en-US/docs/Web/API/WebRTC_API" ref="nofollow noopener noreferrer">WebRTC 文档</a></li>
</ul>
<hr/>
<p>通过这个项目，我们学习了如何将机器学习模型应用到 Web 前端，实现了从手部检测到手势识别，再到物品交互的完整流程。希望这篇文章能对你有所启发，欢迎交流和扩展！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[docker搭建照片处理hivision_idphotos]]></title>    <link>https://juejin.cn/post/7577203946063511592</link>    <guid>https://juejin.cn/post/7577203946063511592</guid>    <pubDate>2025-11-27T13:33:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577203946063511592" data-draft-id="7577202452800192512" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="docker搭建照片处理hivision_idphotos"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-27T13:33:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="异世界_我是一名程序员"/> <meta itemprop="url" content="https://juejin.cn/user/2981531267375959"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            docker搭建照片处理hivision_idphotos
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2981531267375959/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    异世界_我是一名程序员
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T13:33:25.000Z" title="Thu Nov 27 2025 13:33:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">docker搭建照片处理hivision_idphotos</h2>
<h3 data-id="heading-1">docker-compose.yaml</h3>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">version:</span> <span class="hljs-string">'3.8'</span>
<span class="hljs-attr">services:</span>
  <span class="hljs-attr">hivision_idphotos:</span>
    <span class="hljs-attr">ports:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">'7860:7860'</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">linzeyi/hivision_idphotos</span>
</code></pre>
<h3 data-id="heading-2">拉取镜像</h3>
<pre><code class="hljs language-arduino" lang="arduino">到这个地方拉取，其他地方拉取不下来`https:<span class="hljs-comment">//docker.aityp.com/image/docker.io/linzeyi/hivision_idphotos:v1.3.1`</span>
</code></pre>
<pre><code class="hljs language-bash" lang="bash">docker pull swr.cn-north-4.myhuaweicloud.com/ddn-k8s/docker.io/linzeyi/hivision_idphotos:v1.3.1

docker tag  swr.cn-north-4.myhuaweicloud.com/ddn-k8s/docker.io/linzeyi/hivision_idphotos:v1.3.1 linzeyi/hivision_idphotos:v1.3.1
</code></pre>
<p>运行: <code>docker-compose up -d</code>，访问: <code>localhost:7860</code></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6f3c2255f5bc48599408f0a014c7d1ae~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5byC5LiW55WMX-aIkeaYr-S4gOWQjeeoi-W6j-WRmA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764855205&amp;x-signature=tdhj%2BHnapYAUZhCB%2Bhbcj5fsMSw%3D" alt="image.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue3-computed]]></title>    <link>https://juejin.cn/post/7577222731790417946</link>    <guid>https://juejin.cn/post/7577222731790417946</guid>    <pubDate>2025-11-27T13:41:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577222731790417946" data-draft-id="7577226119105363995" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue3-computed"/> <meta itemprop="keywords" content="前端,Vue.js"/> <meta itemprop="datePublished" content="2025-11-27T13:41:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="YaeZed"/> <meta itemprop="url" content="https://juejin.cn/user/3977350021390107"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue3-computed
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3977350021390107/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    YaeZed
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T13:41:41.000Z" title="Thu Nov 27 2025 13:41:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body .octicon{display:inline-block;fill:currentColor;vertical-align:text-bottom}.markdown-body .anchor{float:left;line-height:1;margin-left:-20px;padding-right:4px}.markdown-body .anchor:focus{outline:none}.markdown-body h1 .octicon-link,.markdown-body h2 .octicon-link,.markdown-body h3 .octicon-link,.markdown-body h4 .octicon-link,.markdown-body h5 .octicon-link,.markdown-body h6 .octicon-link{color:#1b1f23;vertical-align:middle;visibility:hidden}.markdown-body h1:hover .anchor,.markdown-body h2:hover .anchor,.markdown-body h3:hover .anchor,.markdown-body h4:hover .anchor,.markdown-body h5:hover .anchor,.markdown-body h6:hover .anchor{text-decoration:none}.markdown-body h1:hover .anchor .octicon-link,.markdown-body h2:hover .anchor .octicon-link,.markdown-body h3:hover .anchor .octicon-link,.markdown-body h4:hover .anchor .octicon-link,.markdown-body h5:hover .anchor .octicon-link,.markdown-body h6:hover .anchor .octicon-link{visibility:visible}.markdown-body h1:hover .anchor .octicon-link:before,.markdown-body h2:hover .anchor .octicon-link:before,.markdown-body h3:hover .anchor .octicon-link:before,.markdown-body h4:hover .anchor .octicon-link:before,.markdown-body h5:hover .anchor .octicon-link:before,.markdown-body h6:hover .anchor .octicon-link:before{width:16px;height:16px;content:" ";display:inline-block;background-image:url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' aria-hidden='true'%3E%3Cpath fill-rule='evenodd' d='M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z'/%3E%3C/svg%3E")}.markdown-body{-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;color:#24292e;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Helvetica,Arial,sans-serif,Apple Color Emoji,Segoe UI Emoji;font-size:16px;line-height:1.5;word-wrap:break-word}.markdown-body details{display:block}.markdown-body summary{display:list-item}.markdown-body a{background-color:initial}.markdown-body a:active,.markdown-body a:hover{outline-width:0}.markdown-body strong{font-weight:inherit;font-weight:bolder}.markdown-body h1{margin:.67em 0}.markdown-body img{border-style:none}.markdown-body code,.markdown-body kbd,.markdown-body pre{font-family:monospace,monospace;font-size:1em}.markdown-body hr{box-sizing:initial;overflow:visible}.markdown-body input{font:inherit;margin:0;overflow:visible}.markdown-body [type=checkbox]{box-sizing:border-box;padding:0}.markdown-body *{box-sizing:border-box}.markdown-body input{font-family:inherit;font-size:inherit;line-height:inherit}.markdown-body a{color:#0366d6;text-decoration:none}.markdown-body a:hover{text-decoration:underline}.markdown-body strong{font-weight:600}.markdown-body hr{height:0;margin:15px 0;overflow:hidden;background:transparent;border-bottom:1px solid #dfe2e5}.markdown-body hr:after,.markdown-body hr:before{display:table;content:""}.markdown-body hr:after{clear:both}.markdown-body table{border-spacing:0;border-collapse:collapse}.markdown-body td,.markdown-body th{padding:0}.markdown-body details summary{cursor:pointer}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin-top:0;margin-bottom:0}.markdown-body h1{font-size:32px}.markdown-body h1,.markdown-body h2{font-weight:600}.markdown-body h2{font-size:24px}.markdown-body h3{font-size:20px}.markdown-body h3,.markdown-body h4{font-weight:600}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:14px}.markdown-body h5,.markdown-body h6{font-weight:600}.markdown-body h6{font-size:12px}.markdown-body p{margin-top:0;margin-bottom:10px}.markdown-body blockquote{margin:0}.markdown-body ol,.markdown-body ul{padding-left:0;margin-top:0;margin-bottom:0}.markdown-body ol ol,.markdown-body ul ol{list-style-type:lower-roman}.markdown-body ol ol ol,.markdown-body ol ul ol,.markdown-body ul ol ol,.markdown-body ul ul ol{list-style-type:lower-alpha}.markdown-body dd{margin-left:0}.markdown-body code,.markdown-body pre{font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:12px}.markdown-body pre{margin-top:0;margin-bottom:0}.markdown-body input::-webkit-inner-spin-button,.markdown-body input::-webkit-outer-spin-button{margin:0;-webkit-appearance:none;appearance:none}.markdown-body :checked+.radio-label{position:relative;z-index:1;border-color:#0366d6}.markdown-body .border{border:1px solid #e1e4e8!important}.markdown-body .border-0{border:0!important}.markdown-body .border-bottom{border-bottom:1px solid #e1e4e8!important}.markdown-body .rounded-1{border-radius:3px!important}.markdown-body .bg-white{background-color:#fff!important}.markdown-body .bg-gray-light{background-color:#fafbfc!important}.markdown-body .text-gray-light{color:#6a737d!important}.markdown-body .pl-3,.markdown-body .px-3{padding-left:16px!important}.markdown-body .px-3{padding-right:16px!important}.markdown-body .f6{font-size:12px!important}.markdown-body .lh-condensed{line-height:1.25!important}.markdown-body .text-bold{font-weight:600!important}.markdown-body .pl-c{color:#6a737d}.markdown-body .pl-c1,.markdown-body .pl-s .pl-v{color:#005cc5}.markdown-body .pl-e,.markdown-body .pl-en{color:#6f42c1}.markdown-body .pl-s .pl-s1,.markdown-body .pl-smi{color:#24292e}.markdown-body .pl-ent{color:#22863a}.markdown-body .pl-k{color:#d73a49}.markdown-body .pl-pds,.markdown-body .pl-s,.markdown-body .pl-s .pl-pse .pl-s1,.markdown-body .pl-sr,.markdown-body .pl-sr .pl-cce,.markdown-body .pl-sr .pl-sra,.markdown-body .pl-sr .pl-sre{color:#032f62}.markdown-body .pl-smw,.markdown-body .pl-v{color:#e36209}.markdown-body .pl-bu{color:#b31d28}.markdown-body .pl-ii{color:#fafbfc;background-color:#b31d28}.markdown-body .pl-c2{color:#fafbfc;background-color:#d73a49}.markdown-body .pl-c2:before{content:"^M"}.markdown-body .pl-sr .pl-cce{font-weight:700;color:#22863a}.markdown-body .pl-ml{color:#735c0f}.markdown-body .pl-mh,.markdown-body .pl-mh .pl-en,.markdown-body .pl-ms{font-weight:700;color:#005cc5}.markdown-body .pl-mi{font-style:italic;color:#24292e}.markdown-body .pl-mb{font-weight:700;color:#24292e}.markdown-body .pl-md{color:#b31d28;background-color:#ffeef0}.markdown-body .pl-mi1{color:#22863a;background-color:#f0fff4}.markdown-body .pl-mc{color:#e36209;background-color:#ffebda}.markdown-body .pl-mi2{color:#f6f8fa;background-color:#005cc5}.markdown-body .pl-mdr{font-weight:700;color:#6f42c1}.markdown-body .pl-ba{color:#586069}.markdown-body .pl-sg{color:#959da5}.markdown-body .pl-corl{text-decoration:underline;color:#032f62}.markdown-body .mb-0{margin-bottom:0!important}.markdown-body .my-2{margin-bottom:8px!important;margin-top:8px!important}.markdown-body .pl-0{padding-left:0!important}.markdown-body .py-0{padding-top:0!important;padding-bottom:0!important}.markdown-body .pl-1{padding-left:4px!important}.markdown-body .pl-2{padding-left:8px!important}.markdown-body .py-2{padding-top:8px!important;padding-bottom:8px!important}.markdown-body .pl-3{padding-left:16px!important}.markdown-body .pl-4{padding-left:24px!important}.markdown-body .pl-5{padding-left:32px!important}.markdown-body .pl-6{padding-left:40px!important}.markdown-body .pl-7{padding-left:48px!important}.markdown-body .pl-8{padding-left:64px!important}.markdown-body .pl-9{padding-left:80px!important}.markdown-body .pl-10{padding-left:96px!important}.markdown-body .pl-11{padding-left:112px!important}.markdown-body .pl-12{padding-left:128px!important}.markdown-body hr{border-bottom-color:#eee}.markdown-body kbd{display:inline-block;padding:3px 5px;font:11px SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;line-height:10px;color:#444d56;vertical-align:middle;background-color:#fafbfc;border:1px solid #d1d5da;border-radius:3px;box-shadow:inset 0 -1px 0 #d1d5da}.markdown-body:after,.markdown-body:before{display:table;content:""}.markdown-body:after{clear:both}.markdown-body&gt;:first-child{margin-top:0!important}.markdown-body&gt;:last-child{margin-bottom:0!important}.markdown-body a:not([href]){color:inherit;text-decoration:none}.markdown-body blockquote,.markdown-body details,.markdown-body dl,.markdown-body ol,.markdown-body p,.markdown-body pre,.markdown-body table,.markdown-body ul{margin-top:0;margin-bottom:16px}.markdown-body hr{height:.25em;padding:0;margin:24px 0;background-color:#e1e4e8;border:0}.markdown-body blockquote{padding:0 1em;color:#6a737d;border-left:.25em solid #dfe2e5}.markdown-body blockquote&gt;:first-child{margin-top:0}.markdown-body blockquote&gt;:last-child{margin-bottom:0}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin-top:24px;margin-bottom:16px;font-weight:600;line-height:1.25}.markdown-body h1{font-size:2em}.markdown-body h1,.markdown-body h2{padding-bottom:.3em;border-bottom:1px solid #eaecef}.markdown-body h2{font-size:1.5em}.markdown-body h3{font-size:1.25em}.markdown-body h4{font-size:1em}.markdown-body h5{font-size:.875em}.markdown-body h6{font-size:.85em;color:#6a737d}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:0;margin-bottom:0}.markdown-body li{word-wrap:break-all}.markdown-body li&gt;p{margin-top:16px}.markdown-body li+li{margin-top:.25em}.markdown-body dl{padding:0}.markdown-body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:600}.markdown-body dl dd{padding:0 16px;margin-bottom:16px}.markdown-body table{display:block;width:100%;overflow:auto}.markdown-body table th{font-weight:600}.markdown-body table td,.markdown-body table th{padding:6px 13px;border:1px solid #dfe2e5}.markdown-body table tr{background-color:#fff;border-top:1px solid #c6cbd1}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}.markdown-body img{max-width:100%;box-sizing:initial;background-color:#fff}.markdown-body img[align=right]{padding-left:20px}.markdown-body img[align=left]{padding-right:20px}.markdown-body code{padding:.2em .4em;margin:0;font-size:85%;background-color:rgba(27,31,35,.05);border-radius:3px}.markdown-body pre{word-wrap:normal}.markdown-body pre&gt;code{padding:0;margin:0;font-size:100%;word-break:normal;white-space:pre;background:transparent;border:0}.markdown-body .highlight{margin-bottom:16px}.markdown-body .highlight pre{margin-bottom:0;word-break:normal}.markdown-body .highlight pre,.markdown-body pre{padding:16px;overflow:auto;font-size:85%;line-height:1.45;background-color:#f6f8fa;border-radius:3px}.markdown-body pre code{display:inline;max-width:auto;padding:0;margin:0;overflow:visible;line-height:inherit;word-wrap:normal;background-color:initial;border:0}.markdown-body .commit-tease-sha{display:inline-block;font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:90%;color:#444d56}.markdown-body .full-commit .btn-outline:not(:disabled):hover{color:#005cc5;border-color:#005cc5}.markdown-body .blob-wrapper{overflow-x:auto;overflow-y:hidden}.markdown-body .blob-wrapper-embedded{max-height:240px;overflow-y:auto}.markdown-body .blob-num{width:1%;min-width:50px;padding-right:10px;padding-left:10px;font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:12px;line-height:20px;color:rgba(27,31,35,.3);text-align:right;white-space:nowrap;vertical-align:top;cursor:pointer;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.markdown-body .blob-num:hover{color:rgba(27,31,35,.6)}.markdown-body .blob-num:before{content:attr(data-line-number)}.markdown-body .blob-code{position:relative;padding-right:10px;padding-left:10px;line-height:20px;vertical-align:top}.markdown-body .blob-code-inner{overflow:visible;font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:12px;color:#24292e;word-wrap:normal;white-space:pre}.markdown-body .pl-token.active,.markdown-body .pl-token:hover{cursor:pointer;background:#ffea7f}.markdown-body .tab-size[data-tab-size="1"]{-moz-tab-size:1;tab-size:1}.markdown-body .tab-size[data-tab-size="2"]{-moz-tab-size:2;tab-size:2}.markdown-body .tab-size[data-tab-size="3"]{-moz-tab-size:3;tab-size:3}.markdown-body .tab-size[data-tab-size="4"]{-moz-tab-size:4;tab-size:4}.markdown-body .tab-size[data-tab-size="5"]{-moz-tab-size:5;tab-size:5}.markdown-body .tab-size[data-tab-size="6"]{-moz-tab-size:6;tab-size:6}.markdown-body .tab-size[data-tab-size="7"]{-moz-tab-size:7;tab-size:7}.markdown-body .tab-size[data-tab-size="8"]{-moz-tab-size:8;tab-size:8}.markdown-body .tab-size[data-tab-size="9"]{-moz-tab-size:9;tab-size:9}.markdown-body .tab-size[data-tab-size="10"]{-moz-tab-size:10;tab-size:10}.markdown-body .tab-size[data-tab-size="11"]{-moz-tab-size:11;tab-size:11}.markdown-body .tab-size[data-tab-size="12"]{-moz-tab-size:12;tab-size:12}.markdown-body .task-list-item{list-style-type:none}.markdown-body .task-list-item+.task-list-item{margin-top:3px}.markdown-body .task-list-item input{margin:0 .2em .25em -1.6em;vertical-align:middle}</style><style data-highlight="" data-highlight-key="gml">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#222;color:silver}.hljs-keyword{color:#ffb871;font-weight:700}.hljs-built_in{color:#ffb871}.hljs-literal{color:#ff8080}.hljs-symbol{color:#58e55a}.hljs-comment{color:#5b995b}.hljs-string{color:#ff0}.hljs-number{color:#ff8080}.hljs-addition,.hljs-attribute,.hljs-bullet,.hljs-code,.hljs-deletion,.hljs-doctag,.hljs-function,.hljs-link,.hljs-meta,.hljs-meta-keyword,.hljs-name,.hljs-quote,.hljs-regexp,.hljs-section,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-id,.hljs-selector-pseudo,.hljs-selector-tag,.hljs-subst,.hljs-template-tag,.hljs-template-variable,.hljs-title,.hljs-type,.hljs-variable{color:silver}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 Vue 3 中，<code>computed</code> 是一个核心 API，用于根据响应式数据（ref, reactive）派生出新的值。它具有<strong>缓存特性</strong>，只有当依赖的响应式数据发生变化时，才会重新计算。</p>
<h2 data-id="heading-0">1.写法</h2>
<p>在 <code>&lt;script setup lang="ts"&gt;</code> 中使用时，主要分为 <strong>只读 (Read-only)</strong> 和 <strong>可写 (Writable)</strong> 两种模式。</p>
<ul>
<li>只读计算属性 (最常用)
这是最常见的用法，传入一个 getter 函数，返回一个<strong>只读</strong>的 Ref 对象。</li>
</ul>
<pre><code class="hljs language-ts" lang="ts">&lt;script setup lang=<span class="hljs-string">"ts"</span>&gt;
<span class="hljs-keyword">import</span> { ref, computed } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;

<span class="hljs-comment">// 定义响应式数据</span>
<span class="hljs-keyword">const</span> count = ref&lt;<span class="hljs-built_in">number</span>&gt;(<span class="hljs-number">1</span>);
<span class="hljs-keyword">const</span> price = ref&lt;<span class="hljs-built_in">number</span>&gt;(<span class="hljs-number">100</span>);

<span class="hljs-comment">// 1. 自动推导类型 (Type Inference)</span>
<span class="hljs-comment">// TS 会自动推导出 doubleCount 的类型为 ComputedRef&lt;number&gt;</span>
<span class="hljs-keyword">const</span> doubleCount = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> count.<span class="hljs-property">value</span> * <span class="hljs-number">2</span>);

<span class="hljs-comment">// 2. 显式指定类型 (Explicit Type)</span>
<span class="hljs-comment">// 使用泛型 &lt;string&gt; 强制指定返回类型</span>
<span class="hljs-keyword">const</span> priceMessage = computed&lt;<span class="hljs-built_in">string</span>&gt;(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">return</span> <span class="hljs-string">`当前价格: $<span class="hljs-subst">${price.value}</span>`</span>;
});

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(doubleCount.<span class="hljs-property">value</span>); <span class="hljs-comment">// 输出: 2</span>
<span class="hljs-comment">// doubleCount.value = 3; // ❌ 报错：无法赋值，因为它是只读的</span>
&lt;/script&gt;
</code></pre>
<ul>
<li>可写计算属性 (Getter + Setter)
如果你需要通过修改计算属性的值来反向更新源数据，可以传入一个包含 <code>get</code> 和 <code>set</code> 的对象。</li>
</ul>
<pre><code class="hljs language-ts" lang="ts">&lt;script setup lang=<span class="hljs-string">"ts"</span>&gt;
<span class="hljs-keyword">import</span> { ref, computed } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;

<span class="hljs-keyword">const</span> firstName = ref&lt;<span class="hljs-built_in">string</span>&gt;(<span class="hljs-string">'John'</span>);
<span class="hljs-keyword">const</span> lastName = ref&lt;<span class="hljs-built_in">string</span>&gt;(<span class="hljs-string">'Doe'</span>);

<span class="hljs-comment">// 定义可写计算属性</span>
<span class="hljs-keyword">const</span> fullName = computed&lt;<span class="hljs-built_in">string</span>&gt;({
  <span class="hljs-comment">// getter: 获取值</span>
  <span class="hljs-title function_">get</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">`<span class="hljs-subst">${firstName.value}</span> <span class="hljs-subst">${lastName.value}</span>`</span>;
  },
  <span class="hljs-comment">// setter: 设置值 (val 的类型会被自动推断为 string)</span>
  <span class="hljs-title function_">set</span>(<span class="hljs-params">newValue</span>) {
    <span class="hljs-keyword">const</span> names = newValue.<span class="hljs-title function_">split</span>(<span class="hljs-string">' '</span>);
    firstName.<span class="hljs-property">value</span> = names[<span class="hljs-number">0</span>];
    lastName.<span class="hljs-property">value</span> = names[names.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>];
  }
});

<span class="hljs-comment">// 读取</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(fullName.<span class="hljs-property">value</span>); <span class="hljs-comment">// "John Doe"</span>

<span class="hljs-comment">// 写入 -&gt; 触发 setter -&gt; 更新 firstName 和 lastName</span>
fullName.<span class="hljs-property">value</span> = <span class="hljs-string">'Alice Smith'</span>; 
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(firstName.<span class="hljs-property">value</span>); <span class="hljs-comment">// "Alice"</span>
&lt;/script&gt;
</code></pre>
<h2 data-id="heading-1">2.使用场景</h2>
<ul>
<li>复杂的数据过滤与处理</li>
</ul>
<p>避免在模板（Template）中编写复杂的逻辑。</p>
<pre><code class="hljs language-ts" lang="ts">&lt;script setup lang=<span class="hljs-string">"ts"</span>&gt;
<span class="hljs-keyword">import</span> { ref, computed } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">User</span> {
  <span class="hljs-attr">id</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">isActive</span>: <span class="hljs-built_in">boolean</span>;
}

<span class="hljs-keyword">const</span> users = ref&lt;<span class="hljs-title class_">User</span>[]&gt;([
  { <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'Allen'</span>, <span class="hljs-attr">isActive</span>: <span class="hljs-literal">true</span> },
  { <span class="hljs-attr">id</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'Bob'</span>, <span class="hljs-attr">isActive</span>: <span class="hljs-literal">false</span> },
  { <span class="hljs-attr">id</span>: <span class="hljs-number">3</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'Chris'</span>, <span class="hljs-attr">isActive</span>: <span class="hljs-literal">true</span> },
]);

<span class="hljs-comment">// 场景：只显示活跃用户</span>
<span class="hljs-comment">// 好处：如果 users 数组没有变化，多次访问 activeUsers 不会重新执行 filter，直接返回缓存</span>
<span class="hljs-keyword">const</span> activeUsers = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">return</span> users.<span class="hljs-property">value</span>.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">user</span> =&gt;</span> user.<span class="hljs-property">isActive</span>);
});
&lt;/script&gt;
</code></pre>
<ul>
<li>动态样式类名绑定</li>
</ul>
<p>根据多个状态生成最终的 CSS 类名对象或数组。</p>
<pre><code class="hljs language-ts" lang="ts">&lt;script setup lang=<span class="hljs-string">"ts"</span>&gt;
<span class="hljs-keyword">import</span> { ref, computed } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;

<span class="hljs-keyword">const</span> isError = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">false</span>);
<span class="hljs-keyword">const</span> isLoading = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">true</span>);

<span class="hljs-comment">// 场景：根据状态返回类名对象</span>
<span class="hljs-keyword">const</span> buttonClasses = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> ({
  <span class="hljs-string">'btn-primary'</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-string">'btn-danger'</span>: isError.<span class="hljs-property">value</span>,
  <span class="hljs-string">'btn-loading'</span>: isLoading.<span class="hljs-property">value</span>,
  <span class="hljs-string">'disabled'</span>: isLoading.<span class="hljs-property">value</span> <span class="hljs-comment">// TS 能确保逻辑清晰</span>
}));
&lt;/script&gt;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">:class</span>=<span class="hljs-string">"buttonClasses"</span>&gt;</span>Submit<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span></span>
</code></pre>
<ul>
<li>聚合数据</li>
</ul>
<p>这是 <code>computed</code> 最经典的场景，依赖多个数据源进行计算。</p>
<pre><code class="hljs language-ts" lang="ts">&lt;script setup lang=<span class="hljs-string">"ts"</span>&gt;
<span class="hljs-keyword">import</span> { ref, computed } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;

<span class="hljs-keyword">const</span> cartItems = <span class="hljs-title function_">ref</span>([
  { <span class="hljs-attr">name</span>: <span class="hljs-string">'Apple'</span>, <span class="hljs-attr">price</span>: <span class="hljs-number">10</span>, <span class="hljs-attr">quantity</span>: <span class="hljs-number">2</span> },
  { <span class="hljs-attr">name</span>: <span class="hljs-string">'Banana'</span>, <span class="hljs-attr">price</span>: <span class="hljs-number">5</span>, <span class="hljs-attr">quantity</span>: <span class="hljs-number">5</span> },
]);

<span class="hljs-keyword">const</span> discount = <span class="hljs-title function_">ref</span>(<span class="hljs-number">0.9</span>); <span class="hljs-comment">// 9折</span>

<span class="hljs-comment">// 场景：自动计算总价</span>
<span class="hljs-keyword">const</span> totalPrice = computed&lt;<span class="hljs-built_in">number</span>&gt;(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> total = cartItems.<span class="hljs-property">value</span>.<span class="hljs-title function_">reduce</span>(<span class="hljs-function">(<span class="hljs-params">sum, item</span>) =&gt;</span> {
    <span class="hljs-keyword">return</span> sum + (item.<span class="hljs-property">price</span> * item.<span class="hljs-property">quantity</span>);
  }, <span class="hljs-number">0</span>);
  <span class="hljs-keyword">return</span> total * discount.<span class="hljs-property">value</span>;
});
&lt;/script&gt;
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[MetaChat产品级创新互动设计 知识问答闯关（ 出题/判题 + 成就系统）]]></title>    <link>https://juejin.cn/post/7577229187896999971</link>    <guid>https://juejin.cn/post/7577229187896999971</guid>    <pubDate>2025-11-27T15:32:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577229187896999971" data-draft-id="7577226553286869027" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="MetaChat产品级创新互动设计 知识问答闯关（ 出题/判题 + 成就系统）"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-27T15:32:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="fruge365"/> <meta itemprop="url" content="https://juejin.cn/user/1966345364965645"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            MetaChat产品级创新互动设计 知识问答闯关（ 出题/判题 + 成就系统）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1966345364965645/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    fruge365
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T15:32:09.000Z" title="Thu Nov 27 2025 15:32:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>产品地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdevui.design%2Fhome" target="_blank" title="https://devui.design/home" ref="nofollow noopener noreferrer">DevUI</a>
体验地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmatechat.gitcode.com%2F" target="_blank" title="https://matechat.gitcode.com/" ref="nofollow noopener noreferrer">MateChat</a>
使用说明：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmatechat.gitcode.com%2Fuse-guide%2Fintroduction.html" target="_blank" title="https://matechat.gitcode.com/use-guide/introduction.html" ref="nofollow noopener noreferrer">MateChat - 轻松构建你的AI应用</a></p>
<h2 data-id="heading-0">前言</h2>
<p>区别于传统问答工具，“知识问答闯关” 是基于 <a href="https://link.juejin.cn?target=https%3A%2F%2Fmatechat.gitcode.com%2F" target="_blank" title="https://matechat.gitcode.com/" ref="nofollow noopener noreferrer">MateChat - 轻松构建你的AI应用</a> 构建的游戏化学习系统。核心通过「出题 / 判题插件」与「成就激励插件」的深度集成，将零散的知识问答转化为 “关卡进阶 + 即时反馈 + 成长可视化” 的闯关体验，既借助 <code>MateChat</code> 原生的可读化交互呈现答题逻辑，又通过插件化扩展实现 “从知识点测评到能力认证” 的全链路覆盖，适配 <code>K12</code> 学科巩固、职业技能考核、企业内训闯关等多元场景，让学习从 “被动应答” 变为 “主动挑战”。</p>
<p>案例代码仓库地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitcode.com%2Ffruge365%2Fmetachat-game" target="_blank" title="https://gitcode.com/fruge365/metachat-game" ref="nofollow noopener noreferrer">AtomGit | GitCode - 全球开发者的开源社区,开源代码托管平台</a></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/41a81da5136a413f87ec996e1ad95fe6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZnJ1Z2UzNjU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764862329&amp;x-signature=t2%2BKyb5MA22xngaBZs3UvDCQmmM%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ce4ca2c5e4a6416ea976be72125ae90e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZnJ1Z2UzNjU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764862329&amp;x-signature=AyJypVBELLrN2uD%2Bhf8uCUw8XWU%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h2 data-id="heading-1">什么是<a href="https://link.juejin.cn?target=https%3A%2F%2Fmatechat.gitcode.com%2F" target="_blank" title="https://matechat.gitcode.com/" ref="nofollow noopener noreferrer">MateChat</a></h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b26c981797874c89ad034c79642f06bb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZnJ1Z2UzNjU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764862329&amp;x-signature=llIf7MoeRBPPSQIYRyBqdYJnwTU%3D" alt="在这里插入图片描述" loading="lazy"/>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3ae6c316dfa647e1aa90a7455cba7482~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZnJ1Z2UzNjU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764862329&amp;x-signature=vrr4ZPJttYGXN0ww3Am5dtKhQ1g%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmatechat.gitcode.com%2F" target="_blank" title="https://matechat.gitcode.com/" ref="nofollow noopener noreferrer">MateChat</a>是一个面向研发和知识协作的聊天 UI/交互套件，提供开箱即用的聊天界面、消息渲染、思考内容（<code>reasoning</code>）展示、历史记录等能力。其核心价值是将大模型的问答过程以可读、可操作的界面呈现出来，并支持插件化扩展（题库、工具、面板）。
官方网站：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmatechat.gitcode.com%2F" target="_blank" title="https://matechat.gitcode.com/" ref="nofollow noopener noreferrer">MateChat</a></p>
<h2 data-id="heading-2">什么是 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdevui.design%2Fhome" target="_blank" title="https://devui.design/home" ref="nofollow noopener noreferrer">DevUI</a></h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fdbee770a1344949b2cd18aa9d37f3c4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZnJ1Z2UzNjU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764862329&amp;x-signature=SvHC%2Ft0Jupw1Og6uH%2BjtIvtXxoM%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdevui.design%2Fhome" target="_blank" title="https://devui.design/home" ref="nofollow noopener noreferrer">DevUI</a>是华为云的企业级前端设计体系与组件库，提供规范化的主题变量（颜色、圆角、阴影、字号等）和一致的交互组件（按钮、输入、选择器、布局等）。本项目中所有卡片、进度条、气泡等都遵循 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdevui.design%2Fhome" target="_blank" title="https://devui.design/home" ref="nofollow noopener noreferrer">DevUI</a> 的主题变量和样式规范，保证整站风格统一。
官方网站：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdevui.design%2Fhome" target="_blank" title="https://devui.design/home" ref="nofollow noopener noreferrer">DevUI</a></p>
<h2 data-id="heading-3">怎么接入 AI（OpenAI 兼容层）</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8a39facfbf1a4438910ca1d2f7b9cdb4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZnJ1Z2UzNjU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764862329&amp;x-signature=kxcO62jLjKlXrHSUwwB5bdLI7sM%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>Deepseek apikey获取：<a href="https://link.juejin.cn?target=https%3A%2F%2Fplatform.deepseek.com%2Fusage" target="_blank" title="https://platform.deepseek.com/usage" ref="nofollow noopener noreferrer">DeepSeek</a></p>
<p>项目内包含<a href="https://link.juejin.cn?target=https%3A%2F%2Fopenai.com%2Fzh-Hans-CN%2F" target="_blank" title="https://openai.com/zh-Hans-CN/" ref="nofollow noopener noreferrer">OpenAI</a>兼容实现，支持通过配置不同的提供方（如 <code>SiliconFlow/DeepSeek/Qwen</code>）来进行对话。</p>
<p>关键实现（<code>src/models/openai.ts</code>）：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/models/openai.ts（节选）</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OpenAiService</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">LLMService</span> {
  <span class="hljs-keyword">private</span> <span class="hljs-attr">client</span>: <span class="hljs-title class_">OpenAI</span>;
  <span class="hljs-keyword">private</span> currentModel = <span class="hljs-title function_">useChatModelStore</span>().<span class="hljs-property">currentModel</span>;

  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">providerKey: <span class="hljs-built_in">string</span></span>) {
    <span class="hljs-keyword">const</span> defaultModelConfig = <span class="hljs-variable constant_">LLM_MODELS</span>.<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">m</span> =&gt;</span> m.<span class="hljs-property">providerKey</span> === providerKey);
    <span class="hljs-keyword">const</span> custom = <span class="hljs-title function_">useChatModelStore</span>().<span class="hljs-property">customAPIKey</span>.<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> providerKey === item.<span class="hljs-property">providerKey</span>);

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">client</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">OpenAI</span>({
      <span class="hljs-attr">baseURL</span>: defaultModelConfig?.<span class="hljs-property">apiPath</span>,
      <span class="hljs-attr">apiKey</span>: custom?.<span class="hljs-property">apiKey</span> ? custom.<span class="hljs-property">apiKey</span> : defaultModelConfig?.<span class="hljs-property">apiKey</span>,
      <span class="hljs-attr">dangerouslyAllowBrowser</span>: <span class="hljs-literal">true</span>,
    });
  }

  <span class="hljs-title function_">chat</span>(<span class="hljs-attr">request</span>: <span class="hljs-title class_">ChatRequest</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">string</span>&gt; {
    <span class="hljs-keyword">return</span> <span class="hljs-variable constant_">MODEL_CONFIGS</span>.<span class="hljs-property">stream</span> ? <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">chatStream</span>(request) : <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">chatBatch</span>(request);
  }

  <span class="hljs-keyword">async</span> <span class="hljs-title function_">chatStream</span>(<span class="hljs-attr">request</span>: <span class="hljs-title class_">ChatRequest</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">string</span>&gt; {
    <span class="hljs-comment">// 流式返回，增量拼接 reasoning 与 content，并回调 onMessage/onComplete</span>
  }
}
</code></pre>
<p>接入步骤：</p>
<p>在 <code>src/models/config.ts</code> 中配置提供方 <code>apiPath</code> 与 <code>apiKey</code>，或通过界面输入自定义 API Key</p>
<p>选择模型后，将 <code>MODEL_CONFIGS.enableMock=false</code> 切换为真实调用（默认演示为 <code>mock</code>）</p>
<p>使用 <code>OpenAiService.chat()</code> 进行批量或流式对话（支持展示 <code>reasoning_content</code>）</p>
<p>注：当前演示版以本地题库和确定性判题为主，用于保证“每题必须明确对/错”的体验。切换为真实 <code>AI</code> 后，仍可保持由本地标准答案进行判分，以确保准确性。</p>
<h3 data-id="heading-4">闯关玩法与要求</h3>
<ul>
<li>
<p>题目以助手消息推送到聊天流；用户在输入框回答，随后助手判定“回答正确/错误”，附正确答案与解析、并更新积分</p>
</li>
<li>
<p>连胜与积分到达阈值触发成就；成绩可在“成就”面板查看</p>
</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/41eda424fedb40ee8887b0a0a4bc6ce8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZnJ1Z2UzNjU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764862329&amp;x-signature=UvZllRoKPRsGX2aOLsYnNaHYaf8%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<ul>
<li>
<p>支持通过对话表达意图（如“做 <code>Vue</code> 困难题”），自动解析方向/难度并开始闯关</p>
</li>
<li>
<p>判题后自动进入下一题，顶部进度条与数值带动效（缩放/脉冲）</p>
</li>
</ul>
<h3 data-id="heading-5">关键代码（节选）</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6c73b8a7bf104a1cbe93bccaf6247217~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZnJ1Z2UzNjU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764862329&amp;x-signature=cWNhy7h70ZIAhPxgRXye7i7AHSc%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>挑战状态管理与判题（<code>src/store/challenge-store.ts</code>）</p>
<pre><code class="hljs language-ini" lang="ini">// 初始化状态
const <span class="hljs-attr">active</span> = ref(<span class="hljs-literal">false</span>)<span class="hljs-comment">;</span>
const <span class="hljs-attr">questions</span> = ref&lt;Question[]&gt;(QUESTIONS)<span class="hljs-comment">;</span>
const <span class="hljs-attr">currentIndex</span> = ref(<span class="hljs-number">0</span>)<span class="hljs-comment">;</span>
const <span class="hljs-attr">score</span> = ref(<span class="hljs-number">0</span>)<span class="hljs-comment">;</span>
const <span class="hljs-attr">streak</span> = ref(<span class="hljs-number">0</span>)<span class="hljs-comment">;</span>
const <span class="hljs-attr">achievements</span> = ref&lt;Achievement[]&gt;([])<span class="hljs-comment">;</span>
const <span class="hljs-attr">awaitingAnswer</span> = ref(<span class="hljs-literal">false</span>)<span class="hljs-comment">;</span>

// 开始/结束/下一题
const <span class="hljs-attr">start</span> = () =&gt; {
  <span class="hljs-attr">active.value</span> = <span class="hljs-literal">true</span><span class="hljs-comment">;</span>
  reset()<span class="hljs-comment">;</span>
  initQuestions()<span class="hljs-comment">;</span>
  <span class="hljs-attr">awaitingAnswer.value</span> = <span class="hljs-literal">true</span><span class="hljs-comment">;</span>
  useChatStatusStore().<span class="hljs-attr">startChat</span> = <span class="hljs-literal">true</span><span class="hljs-comment">;</span>
  presentQuestionMessage()<span class="hljs-comment">;</span>
  save()<span class="hljs-comment">;</span>
}<span class="hljs-comment">;</span>

const <span class="hljs-attr">next</span> = () =&gt; {
  if (currentIndex.value &lt; questions.value.length - 1) {
    currentIndex.value++<span class="hljs-comment">;</span>
    <span class="hljs-attr">awaitingAnswer.value</span> = <span class="hljs-literal">true</span><span class="hljs-comment">;</span>
    presentQuestionMessage()<span class="hljs-comment">;</span>
    save()<span class="hljs-comment">;</span>
  } else {
    <span class="hljs-attr">awaitingAnswer.value</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>
    save()<span class="hljs-comment">;</span>
  }
}<span class="hljs-comment">;</span>

// 判题与积分/连胜/成就
const <span class="hljs-attr">submitAnswer</span> = (val: string) =&gt; {
  if (!active.value || !awaitingAnswer.value) return<span class="hljs-comment">;</span>
  const <span class="hljs-attr">q</span> = currentQuestion.value<span class="hljs-comment">;</span>
  const <span class="hljs-attr">correct</span> = isCorrect(val, q)<span class="hljs-comment">;</span>
  const <span class="hljs-attr">chatMessageStore</span> = useChatMessageStore()<span class="hljs-comment">;</span>

  if (correct) { score.value += q.points<span class="hljs-comment">; streak.value += 1; } else { streak.value = 0; }</span>
  checkAchievements()<span class="hljs-comment">;</span>

  const <span class="hljs-attr">summary</span> = correct
    ? `回答正确 ✅ +${q.points}分\n题目：${q.title}\n解析：${q.explanation}\n当前积分：${score.value}`
    : `回答错误 ❌\n题目：${q.title}\n正确答案：${q.answers.join(' / ')}\n解析：${q.explanation}\n当前积分：${score.value}`<span class="hljs-comment">;</span>

  chatMessageStore.ask(val, summary)<span class="hljs-comment">;</span>
  <span class="hljs-attr">awaitingAnswer.value</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>
  save()<span class="hljs-comment">;</span>
  next()<span class="hljs-comment">; // 自动进入下一题，刷新进度</span>
}<span class="hljs-comment">;</span>

// 出题消息推送到聊天流
const <span class="hljs-attr">presentQuestionMessage</span> = () =&gt; {
  const <span class="hljs-attr">chatMessageStore</span> = useChatMessageStore()<span class="hljs-comment">;</span>
  const <span class="hljs-attr">q</span> = currentQuestion.value<span class="hljs-comment">;</span>
  const <span class="hljs-attr">choicesText</span> = q.choices?.length ? q.choices.map(c =&gt; `<span class="hljs-variable">${c.key}</span>. <span class="hljs-variable">${c.text}</span>`).join(<span class="hljs-string">'\n'</span>) : <span class="hljs-string">''</span><span class="hljs-comment">;</span>
  const <span class="hljs-attr">content</span> = `第<span class="hljs-variable">${currentIndex.value + 1}</span>题：<span class="hljs-variable">${q.title}</span>\n<span class="hljs-variable">${q.content}</span><span class="hljs-variable">${choicesText ? '\n' + choicesText : ''}</span>`<span class="hljs-comment">;</span>
  chatMessageStore.messages.push({ from: 'assistant', content, reasoning_content: '', avatarPosition: 'side-left', avatarConfig: { ...aiModelAvatar }, loading: false, complete: true })<span class="hljs-comment">;</span>
  chatMessageStore.messageChangeCount++<span class="hljs-comment">;</span>
}<span class="hljs-comment">;</span>

// 题库筛选（方向/难度/题量）
const <span class="hljs-attr">setCategories</span> = (arr: string[]) =&gt; { selectedCategories.value = arr || []<span class="hljs-comment">; };</span>
const <span class="hljs-attr">setLevels</span> = (arr: Array&lt;<span class="hljs-string">'easy'</span>|<span class="hljs-string">'medium'</span>|<span class="hljs-string">'hard'</span>&gt;|string[]) =&gt; { selectedLevels.value = (arr as any) || []<span class="hljs-comment">; };</span>
const <span class="hljs-attr">setQuestionCount</span> = (n?: number) =&gt; { questionCount.value = n<span class="hljs-comment">; };</span>
const <span class="hljs-attr">initQuestions</span> = () =&gt; { /* 根据筛选生成题序列 */ }<span class="hljs-comment">;</span>
</code></pre>
<p>对话渲染（左右气泡 + 思考折叠）（<code>src/view/challenge/chat-feed.vue</code>）</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"feed-list"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">template</span> <span class="hljs-attr">v-for</span>=<span class="hljs-string">"(msg, idx) in chatMessageStore.messages"</span> <span class="hljs-attr">:key</span>=<span class="hljs-string">"idx"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">:class</span>=<span class="hljs-string">"['bubble', msg.from === 'user' ? 'right' : 'left']"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"avatar"</span> <span class="hljs-attr">:src</span>=<span class="hljs-string">"msg.avatarConfig.imgSrc"</span> /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"bubble-body"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"msg.from==='assistant' &amp;&amp; msg.reasoning_content"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"think-toggle-btn"</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"toggleThink(msg)"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">i</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"icon-point"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>{{ msg.content ? ($t('chat.thinkingComplete') + $t('chat.thinkingTime',{time:getThinkingTime(msg)})) : $t('chat.thinking') }}<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">i</span> <span class="hljs-attr">:class</span>=<span class="hljs-string">"msg.isThinkShrink ? 'icon-chevron-down-2' : 'icon-chevron-up-2'"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"content"</span> <span class="hljs-attr">v-html</span>=<span class="hljs-string">"renderMessage(msg)"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
</code></pre>
<p>顶部统计与进度（带动效）（<code>src/view/challenge/challenge-layout.vue</code>）</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3763e24097534e4fb2c8f5af358214ba~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZnJ1Z2UzNjU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764862329&amp;x-signature=E0Ulx6l3gpkXKDTpxA5ti9ZjHsk%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"stats"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"stat"</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>积分<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">b</span> <span class="hljs-attr">:class</span>=<span class="hljs-string">"['counter', animateScore &amp;&amp; 'animate']"</span>&gt;</span>{{ challenge.score }}<span class="hljs-tag">&lt;/<span class="hljs-name">b</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"divider"</span> /&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"stat"</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>连胜<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">b</span> <span class="hljs-attr">:class</span>=<span class="hljs-string">"['counter', animateStreak &amp;&amp; 'animate']"</span>&gt;</span>{{ challenge.streak }}<span class="hljs-tag">&lt;/<span class="hljs-name">b</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"divider"</span> /&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"progress"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"progress-bar"</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">:class</span>=<span class="hljs-string">"['bar', animateProgress &amp;&amp; 'pulse']"</span> <span class="hljs-attr">:style</span>=<span class="hljs-string">"{ width: `${progress}%` }"</span> /&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"progress-text"</span>&gt;</span>{{ challenge.currentIndex + 1 }}/{{ challenge.questions.length }}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<p>输入意图解析（对话式选择方向/难度）（<code>src/view/input/input.vue</code>）</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">detectPrefs</span> = (text: string) =&gt; {
  const <span class="hljs-attr">lowers</span> = text.toLowerCase()<span class="hljs-comment">;</span>
  const <span class="hljs-attr">cats</span> = QUESTION_CATEGORIES.filter(c =&gt; lowers.includes(c.toLowerCase()))<span class="hljs-comment">;</span>
  const lvls: string<span class="hljs-section">[]</span> = <span class="hljs-section">[]</span><span class="hljs-comment">;</span>
  if (/(困难|hard)/i.test(text)) lvls.push('hard')<span class="hljs-comment">;</span>
  if (/(中等|medium)/i.test(text)) lvls.push('medium')<span class="hljs-comment">;</span>
  if (/(简单|easy)/i.test(text)) lvls.push('easy')<span class="hljs-comment">;</span>
  return { cats, lvls }<span class="hljs-comment">;</span>
}<span class="hljs-comment">;</span>

const <span class="hljs-attr">onSubmit</span> = (val: string) =&gt; {
  if (!val) return<span class="hljs-comment">;</span>
  if (challengeStore.active &amp;&amp; challengeStore.awaitingAnswer) {
    challengeStore.submitAnswer(val)<span class="hljs-comment">;</span>
  } else {
    const <span class="hljs-attr">prefs</span> = detectPrefs(val)<span class="hljs-comment">;</span>
    if (prefs.cats.length || prefs.lvls.length) {
      challengeStore.setCategories?.(prefs.cats)<span class="hljs-comment">;</span>
      challengeStore.setLevels?.(prefs.lvls)<span class="hljs-comment">;</span>
      challengeStore.start()<span class="hljs-comment">;</span>
    }
    chatMessageStore.ask(val)<span class="hljs-comment">;</span>
  }
}<span class="hljs-comment">;</span>
</code></pre>
<h2 data-id="heading-6">总结</h2>
<p>通过 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdevui.design%2Fhome" target="_blank" title="https://devui.design/home" ref="nofollow noopener noreferrer">DevUI</a> 的统一样式和 <a href="https://link.juejin.cn?target=https%3A%2F%2Fmatechat.gitcode.com%2F" target="_blank" title="https://matechat.gitcode.com/" ref="nofollow noopener noreferrer">MateChat</a>的聊天交互基础，结合本地题库与确定性判题，项目实现了“知识问答闯关”的高确定性体验。若需要切换到真实 <code>AI</code>，对接 <code>OpenAiService</code> 并保持本地标准答案判分即可在保证准确性的同时提升题面/解析的丰富度。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[你真的知道了javascrip 函数的执行上下文？]]></title>    <link>https://juejin.cn/post/7577284409964445759</link>    <guid>https://juejin.cn/post/7577284409964445759</guid>    <pubDate>2025-11-27T15:34:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577284409964445759" data-draft-id="7577220965437276214" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="你真的知道了javascrip 函数的执行上下文？"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-27T15:34:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="八哥程序员"/> <meta itemprop="url" content="https://juejin.cn/user/114004940297325"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            你真的知道了javascrip 函数的执行上下文？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/114004940297325/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    八哥程序员
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T15:34:13.000Z" title="Thu Nov 27 2025 15:34:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">JavaScript执行上下文：深入理解代码执行机制</h2>
<p>在JavaScript开发中，你是否曾经遇到过这样的困惑：为什么变量可以在声明前使用？为什么函数内部可以访问外部变量？为什么<code>this</code>的指向有时会让人摸不着头脑？这些看似神奇的现象背后，都隐藏着一个核心概念——<strong>执行上下文</strong>。</p>
<p>本文将带你深入理解JavaScript执行上下文，通过丰富的图解和代码示例，让你彻底掌握这一重要概念。</p>
<h3 data-id="heading-1">一、什么是执行上下文？</h3>
<p>**执行上下文（Execution Context）**是JavaScript代码执行时的环境，它决定了变量、函数和对象的可访问性，以及代码的执行顺序。</p>
<h4 data-id="heading-2">1.1 执行上下文的类型</h4>
<p>JavaScript中有三种执行上下文：</p>
<ul>
<li><strong>全局执行上下文（Global Execution Context）</strong>：程序开始执行时创建，只有一个</li>
<li><strong>函数执行上下文（Function Execution Context）</strong>：每次调用函数时创建，可以有多个</li>
<li><strong>eval执行上下文（Eval Execution Context）</strong>：使用<code>eval()</code>函数时创建（不推荐使用）</li>
</ul>
<h4 data-id="heading-3">1.2 执行上下文栈（Execution Context Stack）</h4>
<p>JavaScript引擎使用<strong>执行上下文栈</strong>（也称为调用栈）来管理执行上下文。栈遵循**后进先出（LIFO）**原则。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 示例代码</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Global start'</span>);

<span class="hljs-keyword">function</span> <span class="hljs-title function_">func1</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'func1 start'</span>);
  <span class="hljs-title function_">func2</span>();
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'func1 end'</span>);
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">func2</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'func2 start'</span>);
  <span class="hljs-title function_">func3</span>();
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'func2 end'</span>);
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">func3</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'func3 start'</span>);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'func3 end'</span>);
}

<span class="hljs-title function_">func1</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Global end'</span>);
</code></pre>
<p><strong>执行顺序分析：</strong></p>
<ol>
<li>创建全局执行上下文，推入栈底</li>
<li>执行<code>console.log('Global start')</code></li>
<li>调用<code>func1()</code>，创建func1执行上下文，推入栈顶</li>
<li>执行<code>console.log('func1 start')</code></li>
<li>调用<code>func2()</code>，创建func2执行上下文，推入栈顶</li>
<li>执行<code>console.log('func2 start')</code></li>
<li>调用<code>func3()</code>，创建func3执行上下文，推入栈顶</li>
<li>执行<code>console.log('func3 start')</code>和<code>console.log('func3 end')</code></li>
<li>func3执行完毕，弹出栈顶</li>
<li>执行<code>console.log('func2 end')</code></li>
<li>func2执行完毕，弹出栈顶</li>
<li>执行<code>console.log('func1 end')</code></li>
<li>func1执行完毕，弹出栈顶</li>
<li>执行<code>console.log('Global end')</code></li>
<li>程序结束，弹出全局执行上下文</li>
</ol>
<p><strong>视频演示：</strong></p>
<h3 data-id="heading-4">二、执行上下文的生命周期</h3>
<p>每个执行上下文都经历三个主要阶段：</p>
<h4 data-id="heading-5">2.1 创建阶段（Creation Phase）</h4>
<p>在代码执行前，执行上下文会经历创建阶段：</p>
<ol>
<li>
<p><strong>创建变量对象（Variable Object）</strong></p>
<ul>
<li>函数参数（函数执行上下文）</li>
<li>函数声明（函数和变量名）</li>
<li>变量声明（初始值为undefined）</li>
</ul>
</li>
<li>
<p><strong>建立作用域链（Scope Chain）</strong></p>
<ul>
<li>确定变量的查找顺序</li>
</ul>
</li>
<li>
<p><strong>确定this指向（This Binding）</strong></p>
<ul>
<li>确定<code>this</code>关键字的值</li>
</ul>
</li>
</ol>
<h4 data-id="heading-6">2.2 执行阶段（Execution Phase）</h4>
<p>代码逐行执行，包括：</p>
<ul>
<li>变量赋值</li>
<li>函数调用</li>
<li>表达式计算</li>
</ul>
<h4 data-id="heading-7">2.3 回收阶段（Recycling Phase）</h4>
<p>执行完毕后，执行上下文被标记为可回收，等待垃圾回收机制处理。</p>
<h3 data-id="heading-8">三、执行上下文的组成部分</h3>
<h4 data-id="heading-9">3.1 变量对象（Variable Object）与活动对象（Activation Object）</h4>
<p><strong>变量对象（VO）<strong>是执行上下文中存储变量和函数声明的地方。在函数执行上下文中，变量对象被称为</strong>活动对象（AO）</strong>。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 变量提升示例</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(myVar); <span class="hljs-comment">// undefined（变量提升）</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(myFunc); <span class="hljs-comment">// [Function: myFunc]（函数声明提升）</span>

<span class="hljs-keyword">var</span> myVar = <span class="hljs-string">'Hello World'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">myFunc</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Function executed'</span>);
}

<span class="hljs-title function_">myFunc</span>(); <span class="hljs-comment">// "Function executed"</span>
</code></pre>
<p><strong>创建阶段的变量对象：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 伪代码表示</span>
<span class="hljs-title class_">Variable</span> <span class="hljs-title class_">Object</span> = {
  <span class="hljs-attr">myVar</span>: <span class="hljs-literal">undefined</span>,
  <span class="hljs-attr">myFunc</span>: <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">function</span> <span class="hljs-attr">reference</span>&gt;</span>
}
</span></code></pre>
<h4 data-id="heading-10">3.2 作用域链（Scope Chain）</h4>
<p>作用域链决定了变量的查找顺序，从当前作用域开始，逐级向上查找。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">var</span> globalVar = <span class="hljs-string">'Global'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">outer</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">var</span> outerVar = <span class="hljs-string">'Outer'</span>;
  
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">inner</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">var</span> innerVar = <span class="hljs-string">'Inner'</span>;
    
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(innerVar);    <span class="hljs-comment">// "Inner"（当前作用域）</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(outerVar);    <span class="hljs-comment">// "Outer"（外部作用域）</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(globalVar);   <span class="hljs-comment">// "Global"（全局作用域）</span>
    <span class="hljs-comment">// console.log(notDefined); // ReferenceError（未定义）</span>
  }
  
  <span class="hljs-title function_">inner</span>();
}

<span class="hljs-title function_">outer</span>();
</code></pre>
<p><strong>作用域链示意图：</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">inner</span>作用域 → <span class="hljs-keyword">outer</span>作用域 → 全局作用域 → <span class="hljs-keyword">null</span>
</code></pre>
<h4 data-id="heading-11">3.3 this绑定（This Binding）</h4>
<p><code>this</code>的指向取决于函数的调用方式：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 1. 默认绑定（全局或严格模式）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">showThis</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>);
}
<span class="hljs-title function_">showThis</span>(); <span class="hljs-comment">// window（非严格模式）或 undefined（严格模式）</span>

<span class="hljs-comment">// 2. 隐式绑定（方法调用）</span>
<span class="hljs-keyword">const</span> obj = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">'JavaScript'</span>,
  <span class="hljs-attr">sayName</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span>);
  }
};
obj.<span class="hljs-title function_">sayName</span>(); <span class="hljs-comment">// "JavaScript"</span>

<span class="hljs-comment">// 3. 显式绑定（call/apply/bind）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">introduce</span>(<span class="hljs-params">language</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`I love <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span> and <span class="hljs-subst">${language}</span>`</span>);
}

<span class="hljs-keyword">const</span> person = { <span class="hljs-attr">name</span>: <span class="hljs-string">'Alice'</span> };
introduce.<span class="hljs-title function_">call</span>(person, <span class="hljs-string">'Python'</span>); <span class="hljs-comment">// "I love Alice and Python"</span>

<span class="hljs-comment">// 4. new绑定（构造函数）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">Person</span>(<span class="hljs-params">name</span>) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
}
<span class="hljs-keyword">const</span> john = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">'John'</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(john.<span class="hljs-property">name</span>); <span class="hljs-comment">// "John"</span>
</code></pre>
<h3 data-id="heading-12">四、执行上下文与作用域的关系</h3>
<h4 data-id="heading-13">4.1 词法作用域（Lexical Scope）</h4>
<p>JavaScript采用<strong>词法作用域</strong>（静态作用域），作用域在代码编写时就已经确定，而不是在运行时。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">var</span> x = <span class="hljs-number">10</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">foo</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(x);
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">bar</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">var</span> x = <span class="hljs-number">20</span>;
  <span class="hljs-title function_">foo</span>(); <span class="hljs-comment">// 输出10，而不是20</span>
}

<span class="hljs-title function_">bar</span>();
</code></pre>
<h4 data-id="heading-14">4.2 闭包（Closure）</h4>
<p>闭包是函数和其词法环境的组合，允许函数访问其外部作用域的变量。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">createCounter</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">let</span> count = <span class="hljs-number">0</span>;
  
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    count++;
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(count);
  };
}

<span class="hljs-keyword">const</span> counter = <span class="hljs-title function_">createCounter</span>();
<span class="hljs-title function_">counter</span>(); <span class="hljs-comment">// 1</span>
<span class="hljs-title function_">counter</span>(); <span class="hljs-comment">// 2</span>
<span class="hljs-title function_">counter</span>(); <span class="hljs-comment">// 3</span>
</code></pre>
<p><strong>闭包的执行上下文：</strong>
即使<code>createCounter</code>函数执行完毕，其执行上下文也不会立即销毁，因为返回的函数仍然引用着<code>count</code>变量。</p>
<h3 data-id="heading-15">五、深入理解变量提升</h3>
<h4 data-id="heading-16">5.1 函数声明 vs 函数表达式</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 函数声明（会提升）</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">declaredFunc</span>()); <span class="hljs-comment">// "Function declared"</span>

<span class="hljs-keyword">function</span> <span class="hljs-title function_">declaredFunc</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> <span class="hljs-string">"Function declared"</span>;
}

<span class="hljs-comment">// 函数表达式（不会提升）</span>
<span class="hljs-comment">// console.log(expressedFunc()); // TypeError: expressedFunc is not a function</span>

<span class="hljs-keyword">var</span> expressedFunc = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> <span class="hljs-string">"Function expressed"</span>;
};
</code></pre>
<h4 data-id="heading-17">5.2 let/const 与 var 的区别</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// var 的变量提升</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(varVariable); <span class="hljs-comment">// undefined</span>
<span class="hljs-keyword">var</span> varVariable = <span class="hljs-string">'var value'</span>;

<span class="hljs-comment">// let/const 的暂时性死区（Temporal Dead Zone）</span>
<span class="hljs-comment">// console.log(letVariable); // ReferenceError: Cannot access 'letVariable' before initialization</span>
<span class="hljs-keyword">let</span> letVariable = <span class="hljs-string">'let value'</span>;

<span class="hljs-comment">// const 必须初始化</span>
<span class="hljs-comment">// const constVariable; // SyntaxError: Missing initializer in const declaration</span>
<span class="hljs-keyword">const</span> constVariable = <span class="hljs-string">'const value'</span>;
</code></pre>
<h3 data-id="heading-18">六、实际应用场景</h3>
<h4 data-id="heading-19">6.1 事件处理中的this指向</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Button</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">text</span> = <span class="hljs-string">'Click me'</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">button</span> = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'button'</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">button</span>.<span class="hljs-property">textContent</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">text</span>;
    
    <span class="hljs-comment">// 错误：this指向button元素</span>
    <span class="hljs-comment">// this.button.addEventListener('click', this.handleClick);</span>
    
    <span class="hljs-comment">// 正确：使用箭头函数或bind</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">button</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">handleClick</span>());
    <span class="hljs-comment">// 或：this.button.addEventListener('click', this.handleClick.bind(this));</span>
  }
  
  <span class="hljs-title function_">handleClick</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">text</span>); <span class="hljs-comment">// 正确输出"Click me"</span>
  }
}
</code></pre>
<h4 data-id="heading-20">6.2 模块模式与私有变量</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title class_">Module</span> = (<span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 私有变量</span>
  <span class="hljs-keyword">let</span> privateCounter = <span class="hljs-number">0</span>;
  
  <span class="hljs-comment">// 私有函数</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">privateIncrement</span>(<span class="hljs-params"/>) {
    privateCounter++;
  }
  
  <span class="hljs-comment">// 公共接口</span>
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">increment</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
      <span class="hljs-title function_">privateIncrement</span>();
    },
    <span class="hljs-attr">getCount</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">return</span> privateCounter;
    }
  };
})();

<span class="hljs-title class_">Module</span>.<span class="hljs-title function_">increment</span>();
<span class="hljs-title class_">Module</span>.<span class="hljs-title function_">increment</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Module</span>.<span class="hljs-title function_">getCount</span>()); <span class="hljs-comment">// 2</span>
<span class="hljs-comment">// console.log(Module.privateCounter); // undefined（无法访问私有变量）</span>
</code></pre>
<h3 data-id="heading-21">七、常见问题与解答</h3>
<h4 data-id="heading-22">Q1: 为什么函数可以在声明前调用？</h4>
<p><strong>A:</strong> 因为函数声明会在创建阶段被提升到当前作用域的顶部。</p>
<h4 data-id="heading-23">Q2: 什么是暂时性死区？</h4>
<p><strong>A:</strong> 在<code>let</code>和<code>const</code>声明之前访问变量会抛出错误，这个区域称为暂时性死区。</p>
<h4 data-id="heading-24">Q3: 箭头函数有执行上下文吗？</h4>
<p><strong>A:</strong> 箭头函数没有自己的<code>this</code>、<code>arguments</code>、<code>super</code>或<code>new.target</code>，它们继承自外层函数。</p>
<h4 data-id="heading-25">Q4: 如何避免this指向问题？</h4>
<p><strong>A:</strong> 使用箭头函数、<code>bind()</code>方法，或在类中使用类字段语法。</p>
<h3 data-id="heading-26">八、总结</h3>
<p>JavaScript执行上下文是理解JavaScript运行机制的核心概念。通过掌握执行上下文的创建、执行和回收过程，以及变量对象、作用域链和this绑定的工作原理，你能够：</p>
<ol>
<li><strong>深入理解变量提升</strong>：明白为什么变量可以在声明前使用</li>
<li><strong>掌握作用域链</strong>：理解变量的查找机制和闭包原理</li>
<li><strong>正确使用this</strong>：避免常见的this指向错误</li>
<li><strong>编写高质量代码</strong>：基于对执行机制的理解，写出更健壮的程序</li>
</ol>
<p>执行上下文就像JavaScript引擎的"幕后导演"，它决定了代码的执行顺序、变量的可访问性以及函数的调用关系。只有深入理解这个"导演"的工作方式，你才能真正掌握JavaScript这门语言。</p>
<hr/>
<p><strong>互动思考：</strong> 你能解释下面代码的执行结果吗？</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">var</span> a = <span class="hljs-number">1</span>;
<span class="hljs-keyword">function</span> <span class="hljs-title function_">test</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(a);
  <span class="hljs-keyword">var</span> a = <span class="hljs-number">2</span>;
}
<span class="hljs-title function_">test</span>();
</code></pre>
<p>欢迎在评论区分享你的答案和思考！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android Auto开发（7）-AAP视频集成要求]]></title>    <link>https://juejin.cn/post/7577228831137644587</link>    <guid>https://juejin.cn/post/7577228831137644587</guid>    <pubDate>2025-11-27T10:44:31.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577228831137644587" data-draft-id="7577228831137611819" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android Auto开发（7）-AAP视频集成要求"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2025-11-27T10:44:31.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="成都大菠萝"/> <meta itemprop="url" content="https://juejin.cn/user/289926799429805"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android Auto开发（7）-AAP视频集成要求
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/289926799429805/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    成都大菠萝
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T10:44:31.000Z" title="Thu Nov 27 2025 10:44:31 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>以下是基于 <strong>Head Unit Integration Guide (HUIG) 4.3</strong> 文档中 <strong>第7章（R07开头条款）</strong> 关于 <strong>AAP（Android Auto Projection）视频集成</strong> ，适用于车载系统（Head Unit）与移动设备（Mobile Device）的视频交互集成：</p>
<hr/>
<h3 data-id="heading-0"><strong>Android Auto Projection (AAP) 视频集成技术规范</strong></h3>
<p><strong>（基于 HUIG 4.3 第7章 R07 系列条款）</strong></p>
<hr/>
<h4 data-id="heading-1"><strong>一、核心原则：视频焦点（Video Focus）管理</strong></h4>
<blockquote>
<p><strong>所有视频交互必须以“视频焦点”状态为核心逻辑</strong>，确保车载系统（HU）与移动设备（MD）状态同步。</p>
</blockquote>

























<table><thead><tr><th><strong>条款</strong></th><th><strong>要求</strong></th><th><strong>技术实现说明</strong></th></tr></thead><tbody><tr><td><strong>R07-325</strong></td><td><strong>当 HU 显示关闭（如屏幕休眠）但 AAP 仍活跃时</strong>：<br/>• 必须切换视频焦点<br/>• <strong>拒绝所有 AAP 视频焦点请求</strong></td><td>- HU 屏幕关闭（软件控制，非硬件断电）→ 触发焦点转移<br/>- 立即向 MD 发送 <code>VideoFocusState = NO_FOCUS</code><br/>- 任何 AAP 视频请求（如应用切换/启动）<strong>必须返回错误</strong>（如 <code>ERROR_VIDEO_FOCUS_LOST</code>）</td></tr><tr><td><strong>R07-393</strong></td><td><strong>在混合 UI 场景下</strong>（如 HU 仪表盘叠加 AAP 投影界面）：<br/>• 当 AAP 视频流可见，但 HU 输入焦点（如控制光标）在<strong>原生 UI 部分</strong>时<br/>• <strong>HU 必须向 MD 发送视频焦点状态</strong></td><td>- 状态示例：<code>VideoFocusState = VIDEO_VISIBLE_BUT_INPUT_FOCUS_ON_NATIVE_UI</code><br/>- 用于 MD 判断：是否允许继续渲染 AAP 视频（避免与原生 UI 交互冲突）<br/>- <strong>关键点</strong>：焦点状态需实时同步（每 50ms 一次）</td></tr><tr><td><strong>R07-394</strong></td><td><strong>在混合 UI 场景下</strong>（用户操作原生 UI 时）：<br/>• 当 MD 持有视频焦点，但用户<strong>交互原生 UI</strong>（如点击仪表盘按钮）<br/>• <strong>HU 必须向 MD 发送视频焦点状态</strong></td><td>- 状态示例：<code>VideoFocusState = VIDEO_FOCUS_LOST_DUE_TO_NATIVE_UI_INTERACTION</code><br/>- MD 收到后<strong>暂停视频渲染</strong>，释放资源<br/>- <strong>避免</strong>视频流与原生 UI 重叠导致的视觉冲突</td></tr></tbody></table>
<blockquote>
<p>✅ <strong>重点总结</strong>：</p>
<ul>
<li><strong>视频焦点 = 仅一个应用可同时控制视频流渲染</strong>（AAP 或原生 UI）</li>
<li><strong>状态同步 = 实时通信</strong>（通过 <code>VideoFocusState</code> 消息，非轮询）</li>
<li><strong>拒绝请求 = 严格禁止</strong>（R07-325 的“MUST”是硬性要求）</li>
</ul>
</blockquote>
<hr/>
<h4 data-id="heading-2"><strong>二、视频流传输技术规范</strong></h4>
<blockquote>
<p><strong>所有视频流必须满足实时性、低延迟与自适应带宽要求</strong></p>
</blockquote>















<table><thead><tr><th><strong>条款</strong></th><th><strong>要求</strong></th><th><strong>技术实现说明</strong></th></tr></thead><tbody><tr><td><strong>R07-466</strong></td><td>• AAP 视频流为<strong>实时流</strong>（HU 需立即渲染）<br/>• 采用 <strong>n-ACK 流控机制</strong>（当 MD 带宽不足时，MD 主动请求降速）<br/>• <strong>HU 必须在 100ms 内 ACK 视频包</strong></td><td>- <strong>流控逻辑</strong>：<br/>  1. MD 发送视频包 → HU 接收<br/>  2. HU 100ms 内发送 ACK（<code>ACK_PACKET_ID</code>）<br/>  3. MD 根据 ACK 间隔判断带宽：<br/>     • ACK 间隔 &gt; 100ms → 降速（降低码率/分辨率）<br/>     • ACK 间隔 &lt; 50ms → 提速（提升码率）<br/>- <strong>关键指标</strong>：<br/>  - 视频延迟 ≤ 150ms（端到端）<br/>  - ACK 超时 = 100ms（超时后 MD 自动降速）</td></tr></tbody></table>
<blockquote>
<p>✅ <strong>重点总结</strong>：</p>
<ul>
<li><strong>100ms ACK 是硬性指标</strong>（HU 硬件/驱动需支持）</li>
<li><strong>n-ACK 机制</strong> = MD 与 HU 的动态带宽协商，避免卡顿</li>
<li><strong>实时性</strong> = 与传统视频流（如直播）不同，AAP 视频需<strong>无缓冲</strong>渲染</li>
</ul>
</blockquote>
<hr/>
<h4 data-id="heading-3"><strong>三、混合 UI（Blended UI）交互规范</strong></h4>
<blockquote>
<p><strong>当 HU 同时显示原生 UI（如仪表盘）与 AAP 投影界面时</strong></p>
</blockquote>

























<table><thead><tr><th><strong>场景</strong></th><th><strong>HU 行为</strong></th><th><strong>MD 行为</strong></th></tr></thead><tbody><tr><td><strong>AAP 视频可见 + 用户操作原生 UI</strong></td><td>• 发送 <code>VideoFocusState = VIDEO_VISIBLE_BUT_INPUT_FOCUS_ON_NATIVE_UI</code><br/>• <strong>暂停 AAP 视频渲染</strong>（避免画面闪烁）</td><td>• 立即暂停视频流（释放 GPU 资源）<br/>• 保持 UI 交互流畅（原生 UI 优先）</td></tr><tr><td><strong>用户切换到 AAP 界面</strong></td><td>• 发送 <code>VideoFocusState = VIDEO_FOCUS_GAINED</code><br/>• 恢复视频渲染</td><td>• 重新启动视频流<br/>• 恢复应用交互（如导航语音提示）</td></tr><tr><td><strong>HU 屏幕关闭 → 用户唤醒屏幕</strong></td><td>• <strong>必须自动开启屏幕</strong><br/>• <strong>必须接受 AAP 视频焦点请求</strong>（R07-325 补充）</td><td>• 立即发送视频流（需 100ms 内响应）<br/>• 无需用户额外操作</td></tr></tbody></table>
<blockquote>
<p>✅ <strong>关键设计原则</strong>：</p>
<ul>
<li><strong>原生 UI 交互 &gt; AAP 视频渲染</strong>（用户优先级）</li>
<li><strong>屏幕唤醒 = 重置视频焦点</strong>（避免“屏幕亮但视频不可见”）</li>
<li><strong>状态同步 = 事件驱动</strong>（非定时轮询，减少 CPU 消耗）</li>
</ul>
</blockquote>
<hr/>
<h4 data-id="heading-4"><strong>四、错误处理与边界场景</strong></h4>

























<table><thead><tr><th><strong>场景</strong></th><th><strong>处理要求</strong></th></tr></thead><tbody><tr><td><strong>HU 屏幕软件关闭（非物理断电）</strong></td><td>• <strong>必须</strong>发送 <code>VideoFocusState = NO_FOCUS</code><br/>• <strong>拒绝</strong>所有 AAP 视频请求（R07-325）</td></tr><tr><td><strong>视频流 ACK 超时（&gt;100ms）</strong></td><td>• HU 自动降速（降低码率/分辨率）<br/>• <strong>不触发错误</strong>（符合 n-ACK 机制）</td></tr><tr><td><strong>混合 UI 中用户快速切换焦点</strong></td><td>• HU 需在 50ms 内更新 <code>VideoFocusState</code><br/>• 避免状态冲突（如同时发送 <code>FOCUS_GAINED</code> 和 <code>FOCUS_LOST</code>）</td></tr><tr><td><strong>MD 未响应 ACK</strong></td><td>• HU 3 次超时后<strong>自动降速</strong>（避免视频卡死）<br/>• 仍保持基础交互能力（如音频）</td></tr></tbody></table>
<hr/>
<h4 data-id="heading-5"><strong>五、违反要求的典型问题</strong></h4>






























<table><thead><tr><th><strong>错误行为</strong></th><th><strong>后果</strong></th><th><strong>合规方案</strong></th></tr></thead><tbody><tr><td>HU 屏幕关闭时接受 AAP 视频请求</td><td>视频黑屏 + 用户误操作（如点击无效）</td><td>实现 R07-325：<strong>拒绝请求</strong> + 发送 <code>NO_FOCUS</code></td></tr><tr><td>混合 UI 中未同步视频焦点状态</td><td>AAP 视频与原生 UI 重叠（视觉混乱）</td><td>按 R07-393/R07-394 <strong>实时发送状态</strong></td></tr><tr><td>HU 未在 100ms 内 ACK 视频包</td><td>MD 误判带宽不足 → 画面卡顿/模糊</td><td>优化 HU 驱动：<strong>ACK 延迟 ≤ 80ms</strong>（预留缓冲）</td></tr><tr><td>屏幕唤醒后未恢复视频焦点</td><td>用户需手动重启 AAP 应用（体验差）</td><td>按 R07-325 <strong>补充</strong>：唤醒时<strong>自动恢复</strong></td></tr></tbody></table>
<hr/>
<h3 data-id="heading-6"><strong>附：技术实现路线图</strong></h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b5ce8fdcc9dd4ee6952c844a25de004b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oiQ6YO95aSn6I-g6JCd:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764845633&amp;x-signature=LB4Ab4tN%2FrZxxPXvdQ77a9a%2FFkY%3D" alt="tongyi-mermaid-2025-11-27-183934.png" loading="lazy"/></p>
<blockquote>
<p><strong>文档依据</strong>：</p>
<ul>
<li>Head Unit Integration Guide (HUIG) 4.3, Section R07</li>
<li><strong>所有“MUST”条款为强制要求</strong>（违反将导致 Android Auto 认证失败）</li>
<li><strong>“n-ACK 流控”</strong> 为 Android Auto 4.3 核心优化机制（替代旧版固定码率）</li>
</ul>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【Jetpack Compose】应用内换肤实践]]></title>    <link>https://juejin.cn/post/7577198193215717419</link>    <guid>https://juejin.cn/post/7577198193215717419</guid>    <pubDate>2025-11-27T11:43:53.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577198193215717419" data-draft-id="7577220965437866038" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【Jetpack Compose】应用内换肤实践"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2025-11-27T11:43:53.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="林栩link"/> <meta itemprop="url" content="https://juejin.cn/user/870468939434039"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【Jetpack Compose】应用内换肤实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/870468939434039/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    林栩link
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T11:43:53.000Z" title="Thu Nov 27 2025 11:43:53 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>无论是车载应用还是移动应用开发中，换肤功能都是提升用户体验的重要特性，它允许用户根据喜好或使用场景（如日间 / 夜间）切换应用主题，增强应用的个性化与易用性。相比于传统 Android View 系统的换肤方案（如资源重载、皮肤包 APK 等），Jetpack Compose 凭借其声明式 UI 特性和强大的状态管理能力，让换肤功能的实现更简洁、高效且易维护。</p>
<p>本文将结合实际项目案例，讲解不依赖三方框架时，Compose 应用换肤的核心原理与完整实现流程。</p>
<p>本文源码：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Flinxu-link%2FMJPlayer" target="_blank" title="https://github.com/linxu-link/MJPlayer" ref="nofollow noopener noreferrer">github.com/linxu-link/…</a></p>
<h2 data-id="heading-0">一、Compose 换肤核心原理</h2>
<p>Compose 的主题系统是换肤功能的基础，其核心依赖 <strong><code>CompositionLocal</code></strong> 和 <strong>状态驱动 UI</strong> 两大特性：</p>
<h3 data-id="heading-1">CompositionLocal：主题的 “全局隐式传递”</h3>
<p>Compose 中通过 <code>CompositionLocal</code> 实现非直接传递的依赖注入，允许将主题配置（如颜色、字体、形状）全局传递给子组件，而无需通过函数参数逐层传递。</p>
<p>默认的 <code>MaterialTheme</code> 就是基于 <code>CompositionLocal</code> 实现的，它包含 <code>colorScheme</code>、<code>typography</code>、<code>shapes</code> 三个核心配置。我们既可以扩展<code>MaterialTheme</code>，也能自定义<code>CompositionLocal</code>承载自定义主题信息（如多色块主题的图标配置）。</p>
<h3 data-id="heading-2">状态驱动：主题切换的“实时响应”</h3>
<p>换肤的本质是主题状态的变更—— 当用户选择新主题时，只需更新主题状态，Compose 会自动重组所有依赖该状态的 UI 组件，实现主题的实时切换（无需手动刷新界面）。</p>
<h2 data-id="heading-3">二、换肤功能完整实现流程</h2>
<p>本文将实现三类主题的换肤系统：</p>
<ul>
<li>浅色 / 深色固定主题</li>
<li>系统自适应主题（跟随系统深浅模式）</li>
<li>自定义多色块主题（如红色主题、蓝色主题等）</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9eab10838a4b4d31b249c33d5214f020~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p6X5qCpbGluaw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764850169&amp;x-signature=vyTPgCFNl8y3DqAusLkYbuLdwNQ%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-4">第一步：定义主题类型与资源</h3>
<p>首先定义主题枚举、颜色 / 图标配置类，统一管理不同主题的资源映射：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// ui/theme/Theme.kt</span>
<span class="hljs-comment">// 主题类型</span>
<span class="hljs-keyword">enum</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ThemeType</span> {
    ADAPTIVE, DARK, LIGHT, THEME_2, THEME_3, THEME_4, THEME_5, THEME_6, THEME_7, THEME_8, THEME_9,
    THEME_10, THEME_11, THEME_12, THEME_13, THEME_14, THEME_15, THEME_16, THEME_17, THEME_18,
    THEME_19, THEME_20, THEME_21, THEME_22, THEME_23, THEME_24, THEME_25,
}
</code></pre>
<p>定义不同主题所使用的颜色：</p>
<pre><code class="hljs language-ini" lang="ini">// 应用内颜色配置类
data class ColorScheme(
    val theme: Color,         // 主题色
    val background: Color,    // 页面背景色
    val surface: Color,       // 卡片/组件背景色
    val textPrimary: Color,   // 主要文字色
    val textPrimaryInverse: Color, // 主要文字反色
    val textSecondary: Color, // 次要文字色
    val textSecondaryInverse: Color, // 次要文字反色
    val accent: Color,        // 强调色（按钮/高亮元素）
    val accentInverse: Color,      // 强调色反色
    val border: Color,        // 边框色
)

// 黑色主题配置
val <span class="hljs-attr">darkColorScheme</span> = ColorScheme(
    <span class="hljs-attr">theme</span> = Colors.dark,
    <span class="hljs-attr">background</span> = Colors.dark,
    <span class="hljs-attr">surface</span> = Colors.grey,
    <span class="hljs-attr">textPrimary</span> = Colors.light,
    <span class="hljs-attr">textPrimaryInverse</span> = Colors.light,
    <span class="hljs-attr">textSecondary</span> = Colors.lightGrey,
    <span class="hljs-attr">textSecondaryInverse</span> = Colors.light,
    <span class="hljs-attr">accent</span> = Color(<span class="hljs-number">0</span>xFF2196F3),
    <span class="hljs-attr">accentInverse</span> = Colors.light,
    <span class="hljs-attr">border</span> = Color(<span class="hljs-number">0</span>xFF333333),
)

// 白色主题配置
val <span class="hljs-attr">lightColorScheme</span> = ColorScheme(
    <span class="hljs-attr">theme</span> = Colors.light,
    <span class="hljs-attr">background</span> = Colors.light,
    <span class="hljs-attr">surface</span> = Colors.light,
    <span class="hljs-attr">textPrimary</span> = Colors.dark,
    <span class="hljs-attr">textPrimaryInverse</span> = Colors.dark,
    <span class="hljs-attr">textSecondary</span> = Colors.lightGrey,
    <span class="hljs-attr">textSecondaryInverse</span> = Colors.light,
    <span class="hljs-attr">accent</span> = Color(<span class="hljs-number">0</span>xFF2196F3),
    <span class="hljs-attr">accentInverse</span> = Colors.light,
    <span class="hljs-attr">border</span> = Color(<span class="hljs-number">0</span>xFFE0E0E0),
)

// 其他主题配置
val <span class="hljs-attr">theme2ColorScheme</span> = ColorScheme(
    <span class="hljs-attr">theme</span> = Colors.theme2,
    <span class="hljs-attr">background</span> = Colors.light,
    <span class="hljs-attr">surface</span> = Colors.light,
    <span class="hljs-attr">textPrimary</span> = Colors.light,
    <span class="hljs-attr">textPrimaryInverse</span> = Colors.dark,
    <span class="hljs-attr">textSecondary</span> = Color(<span class="hljs-number">0</span>xFF7F8C8D),
    <span class="hljs-attr">textSecondaryInverse</span> = Colors.light,
    <span class="hljs-attr">accent</span> = Colors.theme2,
    <span class="hljs-attr">accentInverse</span> = Colors.light,
    <span class="hljs-attr">border</span> = Color(<span class="hljs-number">0</span>xFFBDC3C7),
)

// ...
</code></pre>
<p>定义不同主题所使用的图标：</p>
<pre><code class="hljs language-ini" lang="ini">data class ImageScheme(
    val placeholder: Int,
    val adaptiveThemeMask: Int,
    val lightThemeMask: Int,
    val darkThemeMask: Int,
)

val <span class="hljs-attr">darkImageScheme</span> = ImageScheme(
    <span class="hljs-attr">placeholder</span> = Images.placeholderLight,
    <span class="hljs-attr">adaptiveThemeMask</span> = Images.adaptiveThemeMask,
    <span class="hljs-attr">lightThemeMask</span> = Images.lightThemeMask,
    <span class="hljs-attr">darkThemeMask</span> = Images.darkThemeMask,
)

val <span class="hljs-attr">lightImageScheme</span> = ImageScheme(
    <span class="hljs-attr">placeholder</span> = Images.placeholderLight,
    <span class="hljs-attr">adaptiveThemeMask</span> = Images.adaptiveThemeMask,
    <span class="hljs-attr">lightThemeMask</span> = Images.lightThemeMask,
    <span class="hljs-attr">darkThemeMask</span> = Images.blackThemeMask,
)

val <span class="hljs-attr">theme2ImageScheme</span> = ImageScheme(
    <span class="hljs-attr">placeholder</span> = Images.placeholderLight,
    <span class="hljs-attr">adaptiveThemeMask</span> = Images.adaptiveThemeMask,
    <span class="hljs-attr">lightThemeMask</span> = Images.lightThemeMask,
    <span class="hljs-attr">darkThemeMask</span> = Images.blackThemeMask,
)
</code></pre>
<h3 data-id="heading-5">第二步：全局主题管理（CompositionLocal）</h3>
<p>通过<code>CompositionLocal</code>封装当前主题的颜色与图标配置，让子组件可全局访问：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 创建颜色 CompositionLocal实例，默认值为白色主题</span>
<span class="hljs-type">val</span> <span class="hljs-variable">LocalColorScheme</span> <span class="hljs-operator">=</span> compositionLocalOf&lt;ColorScheme&gt; {
<span class="hljs-comment">// 默认颜色配置（白色主题）</span>
    lightColorScheme
}

<span class="hljs-comment">// 创建图标 CompositionLocal实例，默认值为白色主题</span>
<span class="hljs-type">val</span> <span class="hljs-variable">LocalImageScheme</span> <span class="hljs-operator">=</span> compositionLocalOf&lt;ImageScheme&gt; {
<span class="hljs-comment">// 默认颜色配置（白色主题）</span>
    lightImageScheme
} 
</code></pre>
<h3 data-id="heading-6">第三步：封装主题组件</h3>
<p>创建自定义主题组件，根据主题类型自动切换配置，并通过<code>CompositionLocalProvider</code>注入全局：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@Composable</span>
fun <span class="hljs-built_in">MJPlayerTheme</span>(
    <span class="hljs-attribute">themeType</span>: ThemeType = ThemeType.ADAPTIVE,
    <span class="hljs-attribute">content</span>: <span class="hljs-variable">@Composable</span> () -&gt; Unit,
) {

    <span class="hljs-comment">// 根据主题类型选择颜色方案</span>
    <span class="hljs-selector-tag">val</span> <span class="hljs-selector-tag">colorScheme</span> = <span class="hljs-selector-tag">if</span> (ThemeType.ADAPTIVE == themeType) {
        <span class="hljs-comment">// 兼容android系统的浅色/暗色主题</span>
        <span class="hljs-selector-tag">if</span> (<span class="hljs-built_in">isSystemInDarkTheme</span>()) {
            <span class="hljs-selector-tag">darkColorScheme</span>
} <span class="hljs-selector-tag">else</span> {
            <span class="hljs-selector-tag">lightColorScheme</span>
}
    } <span class="hljs-selector-tag">else</span> {
        <span class="hljs-selector-tag">themeColorArray</span><span class="hljs-selector-attr">[themeType]</span> ?: <span class="hljs-selector-tag">lightColorScheme</span>
}

    <span class="hljs-comment">// 根据主题类型选择图标方案</span>
    <span class="hljs-selector-tag">val</span> <span class="hljs-selector-tag">imageScheme</span> = <span class="hljs-selector-tag">if</span> (ThemeType.ADAPTIVE == themeType) {
        <span class="hljs-selector-tag">if</span> (<span class="hljs-built_in">isSystemInDarkTheme</span>()) {
            <span class="hljs-selector-tag">darkImageScheme</span>
} <span class="hljs-selector-tag">else</span> {
            <span class="hljs-selector-tag">lightImageScheme</span>
}
    } <span class="hljs-selector-tag">else</span> {
        <span class="hljs-selector-tag">themeImageArray</span><span class="hljs-selector-attr">[themeType]</span> ?: <span class="hljs-selector-tag">lightImageScheme</span>
}

    <span class="hljs-selector-tag">CompositionLocalProvider</span>(
        LocalColorScheme provides colorScheme,
        LocalImageScheme provides imageScheme,
        content = content,
    )

}
</code></pre>
<h3 data-id="heading-7">第四步：主题状态持久化</h3>
<p>使用<code>SharedPreferences</code>持久化用户选择的主题类型，并提供监听接口（避免应用重启后恢复默认）：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> themeListeners = mutableListOf&lt;(ThemeType) -&gt; <span class="hljs-built_in">Unit</span>&gt;()

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getThemeType</span><span class="hljs-params">()</span></span>: ThemeType {
    <span class="hljs-keyword">return</span> ThemeType.valueOf(HiSp.<span class="hljs-keyword">get</span>(Key.THEME_TYPE, ThemeType.ADAPTIVE.name))
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">setThemeType</span><span class="hljs-params">(themeType: <span class="hljs-type">ThemeType</span>)</span></span> {
    HiSp.put(Key.THEME_TYPE, themeType.name)
    themeListeners.forEach { it(themeType) }
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">addThemeListener</span><span class="hljs-params">(listener: (<span class="hljs-type">ThemeType</span>) -&gt; <span class="hljs-type">Unit</span>)</span></span> {
    themeListeners.add(listener)
    listener(getThemeType())
}
</code></pre>
<h3 data-id="heading-8">第五步：全局主题注入（Activity 层）</h3>
<p>在应用入口（如<code>MainActivity</code>）注入主题，监听主题变更并重组 UI：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@AndroidEntryPoint</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> : <span class="hljs-type">ComponentActivity</span>() {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">lateinit</span> <span class="hljs-keyword">var</span> themeListener: (ThemeType) -&gt; <span class="hljs-built_in">Unit</span>

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreate</span><span class="hljs-params">(savedInstanceState: <span class="hljs-type">Bundle</span>?)</span></span> {
        <span class="hljs-keyword">super</span>.onCreate(savedInstanceState)
        
        <span class="hljs-comment">// 定义主题变更监听</span>
        themeListener = { themeType -&gt;
            setContent {
                MJPlayerTheme(themeType = themeType) {
                    <span class="hljs-comment">// 应用主布局（导航图/根组件）</span>
                    AppNavHost(modifier = Modifier.background(LocalColorScheme.current.background))
                }
            }
        }

        <span class="hljs-comment">// 注册监听并初始化UI</span>
        ThemeManager.addThemeListener(themeListener)
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onDestroy</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">super</span>.onDestroy()
        ThemeManager.removeThemeListener(themeListener) <span class="hljs-comment">// 移除监听，避免内存泄漏</span>
    }
}
</code></pre>
<h3 data-id="heading-9">第六步：使用主题颜色和图标</h3>
<p>在配置完成上述步骤后，在compose方法内直接使用<code>LocalColorScheme</code>、<code>LocalImageScheme</code>即可调用定义好的颜色和图标，并且在切换主题时，compose会触发自动重组，无需手动替换：</p>
<pre><code class="hljs language-ini" lang="ini">@Composable
fun CommonTopAppBar(
    @StringRes title: Int,
    onBack: () -&gt; Unit,
) {
    TopAppBar(
        <span class="hljs-attr">colors</span> = TopAppBarDefaults.topAppBarColors(
            <span class="hljs-attr">containerColor</span> = LocalColorScheme .current.theme,
        ),
        <span class="hljs-attr">title</span> = {
TextTitle(<span class="hljs-attr">text</span> = stringResource(title))
        } ,
        <span class="hljs-attr">navigationIcon</span> = {
IconButton(<span class="hljs-attr">onClick</span> = <span class="hljs-literal">on</span>Back) {
Icon(
                    <span class="hljs-attr">imageVector</span> = MJConstants.Icon.ARROW_BACK,
                    <span class="hljs-attr">contentDescription</span> = stringResource(id = R.string.menu_back),
                    <span class="hljs-attr">tint</span> = LocalColorScheme .current.textPrimary,
                )
            }
} ,
    )
}
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/24412dcd08d048b3bf1e4cc573f50d7d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p6X5qCpbGluaw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764850169&amp;x-signature=SsFdyiI7LRE6Mz5vfrZpp5IFUt4%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-10">三、<code>CompositionLocal</code></h2>
<p>在 Compose 中，<code>CompositionLocal</code>（中文常译 “组合局部”）是一种隐式数据传递机制，用于在组件树中向下传递数据，无需通过函数参数逐层显式传递（即解决 “Prop Drilling” 问题）。它本质上是 Compose 实现局部依赖注入的核心工具，让子组件能便捷地访问上层提供的 “上下文” 或 “共享数据”。其工作原理分为三步：</p>
<ol>
<li>
<p>定义：创建<code>CompositionLocal</code>实例（如<code>LocalColorScheme</code>），作为数据的 “标识符”；</p>
</li>
<li>
<p>提供：通过<code>CompositionLocalProvider</code>在组件树中绑定具体值，作用域为其包裹的子组件；</p>
</li>
<li>
<p>消费：子组件通过<code>CompositionLocal.current</code>获取值，值变化时自动重组。</p>
</li>
</ol>
<p><code>compositionLocalOf</code> 与 <code>staticCompositionLocalOf</code>区别</p>
<ul>
<li>
<p><code>compositionLocalOf</code>：用于动态变化的数据（如主题配置），值变化时会触发所有依赖组件重组；</p>
</li>
<li>
<p><code>staticCompositionLocalOf</code>：用于静态 / 极少变化的数据（如应用全局配置），性能更高，但值变化时不会自动重组。</p>
</li>
</ul>
<h2 data-id="heading-11">四、总结</h2>
<p>本文介绍了 Compose 中基础换肤需求的实现方式 —— 通过<code>CompositionLocal</code>实现主题全局传递，结合状态管理与持久化完成主题切换。实际生产环境中，若需支持独立皮肤包 APK，只需借助框架解析 APK 中的资源文件（颜色、图标），再更新<code>ColorScheme</code>/<code>ImageScheme</code>的映射关系即可。</p>
<p>本文源码：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Flinxu-link%2FMJPlayer" target="_blank" title="https://github.com/linxu-link/MJPlayer" ref="nofollow noopener noreferrer">github.com/linxu-link/…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android14 抓取WinScope]]></title>    <link>https://juejin.cn/post/7577237961638658057</link>    <guid>https://juejin.cn/post/7577237961638658057</guid>    <pubDate>2025-11-27T15:04:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577237961638658057" data-draft-id="7577222731790680090" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android14 抓取WinScope"/> <meta itemprop="keywords" content="操作系统"/> <meta itemprop="datePublished" content="2025-11-27T15:04:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="途途学堂"/> <meta itemprop="url" content="https://juejin.cn/user/3292401463729923"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android14 抓取WinScope
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3292401463729923/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    途途学堂
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T15:04:29.000Z" title="Thu Nov 27 2025 15:04:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一 抓取WinScope命令</h2>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># WindowManager: 使用命令 </span>
adb shell cmd window tracing start
adb shell cmd window tracing stop
<span class="hljs-comment"># SurfaceFlinger: 使用命令 </span>
adb shell su root service call SurfaceFlinger 1025 i32 1
adb shell su root service call SurfaceFlinger 1025 i32 0
</code></pre>
<p>执行命令后，生成winscope文件并导出</p>
<pre><code class="hljs language-bash" lang="bash">adb pull /data/misc/wmtrace/wm_trace.winscope . 
</code></pre>
<h2 data-id="heading-1">二 查看WinScope文件</h2>
<ol>
<li>打开编译好的winscope html文件，
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/281c8919fe7e4d1787e7bb458f964569~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCU6YCU5a2m5aCC:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764860668&amp;x-signature=%2BX3pGSy9rSm0IlD5SZOZ3WGcylo%3D" alt="image.png" loading="lazy"/></li>
<li>导入wm_trace.winscope
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e8f2e93aa78840a9a418954c6f15ee49~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCU6YCU5a2m5aCC:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764860668&amp;x-signature=mlFI%2FuBt2DK06bBQ%2B4ORo8rk0Gc%3D" alt="image.png" loading="lazy"/></li>
<li>显示效果
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f99616703a4e4558a7251b566d4eb387~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCU6YCU5a2m5aCC:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764860668&amp;x-signature=O606o02oxP9L735uGTkIL%2B6mkoE%3D" alt="image.png" loading="lazy"/></li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[IPIDEA代理IP深度测评：构建智能体知识库的得力助手]]></title>    <link>https://juejin.cn/post/7576968345875906587</link>    <guid>https://juejin.cn/post/7576968345875906587</guid>    <pubDate>2025-11-27T08:03:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576968345875906587" data-draft-id="7577031454585864219" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="IPIDEA代理IP深度测评：构建智能体知识库的得力助手"/> <meta itemprop="keywords" content="Agent,爬虫"/> <meta itemprop="datePublished" content="2025-11-27T08:03:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ImAlex"/> <meta itemprop="url" content="https://juejin.cn/user/2505125286925081"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            IPIDEA代理IP深度测评：构建智能体知识库的得力助手
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2505125286925081/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ImAlex
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T08:03:04.000Z" title="Thu Nov 27 2025 08:03:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读21分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">智能体知识库的重要性</h2>
<p>我最近在做“历史大事记”智能体时，踩了个实打实的坑：初期全靠大模型原生知识库支撑，回答总是“缺斤短两”：要么漏了关键历史事件，要么对人物生卒、传统习俗的描述模糊不清，甚至连一些广为人知的纪念日都没法精准对应。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/67b007ed40cd497199954388ba7c22a8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSW1BbGV4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764845464&amp;x-signature=QucxOvmOrhmTWlGRZ1wCM158xtY%3D" alt="" loading="lazy"/></p>
<p>为了补齐这个短板，我找遍了各种数据源，最终发现维基百科这一“宝藏库”：它把全年365/366天的内容拆解得明明白白，大到影响世界的历史拐点，小到行业先驱的诞辰、地方特有的民俗，甚至冷门的科普事件都有收录，数据维度全、权威性也够，完全能满足智能体知识库的扩充需求。</p>
<h2 data-id="heading-1">代理IP在数据采集中的重要性</h2>
<p>数据源找到了，但新的数据采集问题又来了：维基百科在国内没法直接访问，而且单天数据就包含几十甚至上百条目数据，365/366天累计下来就是海量数据，手动采集根本不现实，自动化爬虫又被网络管理卡了脖子。这时候我才意识到，想要高效抓取这些数据，解决网络壁垒的代理IP工具是刚需。</p>
<p>合理运用代理IP技术是实现高效稳定网络爬虫不可或缺的一环，代理IP帮助爬虫获得了更广泛、更深入的数据资源。这些数据经过清洗、整合后就可以形成高质量的知识库，为智能体的问题回答提供优质准确的数据支撑。</p>
<h2 data-id="heading-2">选择IPIDEA代理IP的原因</h2>
<p>为了高效、稳定的完成数据抓取，我对市面上的一些代理服务商进行了详细的分析和研究，包括IPIDEA、星空代理、IPIPGO等。具体对比如下：</p>



























































<table><thead><tr><th><strong>优势维度</strong></th><th><strong>IPIDEA核心表现</strong></th><th><strong>星空代理表现</strong></th><th><strong>IPIPGO表现</strong></th></tr></thead><tbody><tr><td>一、IP资源规模+质量</td><td><strong>1亿+优质IP</strong>，含1亿+真实住宅IP、千万级移动IP，自建纯净合规池，严格筛选</td><td>仅提及“海量IP”，无具体数值，以国内运营商授权节点为主，未强调“真实用户IP”</td><td>9000万+IP，住宅IP以动态为主，移动IP覆盖有限</td></tr><tr><td>二、覆盖范围+精度</td><td>全球220+国家/地区，支持“国家-州/省-城市-ASN”<strong>四级定位</strong>，热门地区IP密度高</td><td>仅覆盖国内200+城市，无全球布局，定位精度仅到城市级</td><td>全球200+国家/地区，定位精度到城市级，热门地区（如美国数据中心IP仅3.5万+）密度低</td></tr><tr><td>三、稳定性</td><td><strong>99.9%正常运行时间+99.9%采集成功率</strong>，支持1-120分钟自定义时效</td><td>IP可用率&gt;98%，IP有效时长仅1-15分钟，无长效选项</td><td>数据中心IP稳定性99.9%，整体采集成功率未明确，部分套餐带宽有隐性限制</td></tr><tr><td>四、代理类型</td><td><strong>8类细分类型</strong>（含移动、IPv6、无限量、长效ISP、独享数据中心等特色类型）</td><td>仅4类基础套餐（计量/不限量A/B），无移动、IPv6、长效等类型</td><td>无IPv6、长效ISP代理，移动IP类型单一</td></tr><tr><td>五、高匿名性</td><td>住宅/移动IP为<strong>真实用户网络</strong>，搭配IP轮转+自定义指纹</td><td>IP为运营商节点，非真实用户IP，匿名性仅满足基础需求</td><td>住宅IP为真实节点，但规模小于IPIDEA，防封策略侧重基础轮转</td></tr><tr><td>六、协议+集成能力</td><td><strong>支持HTTP/HTTPS/Socks5</strong>，提供7种<strong>主流语言代码示例</strong>，无缝对接AI/ML工作流与数据基础设施</td><td>支持HTTP/HTTPS/Socks5，无多语言代码示例，仅提供基础代理服务</td><td>支持HTTP/HTTPS/Socks5，无多语言代码示例，代理与辅助工具为合作模式</td></tr><tr><td>七、合规性</td><td>符合<strong>GDPR、CCPA等国际数据保护法规</strong>，SSL/TLS加密+DDoS防护+24/7安全监控</td><td>仅提及“运营商正规授权”，无国际合规认证，安全防护体系未明确</td><td>未提及国际合规认证，仅强调IP正规授权，安全防护体系较基础</td></tr><tr><td>八、附加价值</td><td>配套抓取API\浏览器**抓取器**等工具，服务阿里巴巴、华为等头部企业，支持多买多送</td><td>仅提供代理服务，无配套工具，缺乏知名企业背书</td><td>合作工具类平台，缺乏头部企业背书，优惠以折扣为主</td></tr></tbody></table>
<p>可以看到，IPIDEA作为企业级代理IP服务提供商，其优势在<strong>IP资源规模、覆盖精度、稳定性、场景适配性、合规性</strong>等核心维度均显著领先于同类平台。以1亿+真实IP资源、220+国家四级定位构建全球网络覆盖，以99.9%稳定性+8类细分代理类型适配全场景需求，以国际合规认证+一体化工具降低企业使用成本与风险，最终形成“代理IP+数据采集+安全保障”的闭环服务。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3a5459d6dce0476c90664d92c2606c0e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSW1BbGV4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764845464&amp;x-signature=rUjV7d%2FTIpIR08boLihi5cmHegk%3D" alt="" loading="lazy"/></p>
<p>显然，这就是契合我需求的那个“它”。所以，最后我选择了IPIDEA来作为我构建智能体知识库的代理IP。</p>
<h2 data-id="heading-3">IPIDEA的使用流程和性能测试</h2>
<p>接下来，我将介绍如何使用IPIDEA的服务来实现代理IP的提取，并对其提供的代理服务的实际表现进行一系列测试。</p>
<h3 data-id="heading-4">使用流程</h3>
<h4 data-id="heading-5">账号注册登录</h4>
<p>介绍使用代理IP前的准备工作，包括注册账号、获取API密钥、选择合适套餐、安装必要Python库等。</p>
<p>首先访问<a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.ipidea.net%2F%3Futm-source%3D1Alex%26utm-keyword%3D%3F1Alex" target="_blank" title="http://www.ipidea.net/?utm-source=1Alex&amp;utm-keyword=?1Alex" ref="nofollow noopener noreferrer">IPIDEA官网</a>，点击右上角注册按钮，完成注册登录。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a0ed0735893c428e863fa1623ebedbd9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSW1BbGV4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764845464&amp;x-signature=G0ae6m8zJ21jqW5wSAUs5D8fDiw%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-6">配置IP白名单</h4>
<p>IP白名单仅允许预先添加信任的IP调用代理资源，可有效防止账号盗用导致的代理资源浪费，锁定合规使用的网络范围。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3794bad2d4ba41b1b57af2eed04b876d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSW1BbGV4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764845464&amp;x-signature=mWj2Ou4B3jcmx4LN7VFm2TYyGYg%3D" alt="" loading="lazy"/></p>
<p>如上图所示，账号注册成功之后，点击右上角用户名，进入概览页。然后依次找到<strong>动态代理</strong>-&gt;<strong>动态住宅代理</strong>-&gt;<strong>代理使用</strong>-&gt;<strong>IP白名单管理</strong>-&gt;<strong>添加白名单</strong>，然后输入自己当前的IP地址和备注信息，点击确认按钮即可。</p>
<h4 data-id="heading-7">配置提取API地址</h4>
<p>在概览页，依次找到<strong>动态代理</strong>-&gt;<strong>动态住宅代理</strong>-&gt;<strong>API提取</strong>。如下图配置之后，点击生成链接，然后右侧<strong>复制</strong>按钮复制备用。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b6431268b7354beeacb044eb21419685~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSW1BbGV4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764845464&amp;x-signature=ixrS2C3ji%2FqpE%2FIJo1T23%2F7dHNI%3D" alt="" loading="lazy"/></p>
<p>比如，我得到的是：<code>[http://api.proxy.ipidea.io/getBalanceProxyIp?num=1&amp;return_type=json&amp;lb=1&amp;sb=0&amp;flow=1&amp;regions=&amp;protocol=http](http://api.proxy.ipidea.io/getBalanceProxyIp?num=1&amp;return_type=json&amp;lb=1&amp;sb=0&amp;flow=1&amp;regions=&amp;protocol=http)</code>。</p>
<h3 data-id="heading-8">性能测试</h3>
<p>代理IP的提取API地址已经有了，接下来我们对其进行一列测试验证，确保它能够符合的数据采集需求。</p>
<h4 data-id="heading-9">提取API有效性验证</h4>
<p>接下来，我们写一段python代码，来验证API的有效性，确保我们能够顺利提取到代理IP，同时验证我们的白名单IP配置是否生效：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> requests
<span class="hljs-keyword">import</span> json

<span class="hljs-keyword">def</span> <span class="hljs-title function_">fetch_proxy_IP</span>():
    api_url = <span class="hljs-string">"http://api.proxy.IPIDEA.io/getBalanceProxyIP?num=1&amp;return_type=json&amp;lb=1&amp;sb=0&amp;flow=1&amp;regions=&amp;protocol=http"</span>

    <span class="hljs-keyword">try</span>:
        <span class="hljs-comment"># 发送 GET 请求（超时设置为 10 秒，避免无限等待）</span>
        response = requests.get(api_url, timeout=<span class="hljs-number">10</span>)

        <span class="hljs-comment"># 检查 HTTP 响应状态码（200 表示请求成功）</span>
        <span class="hljs-keyword">if</span> response.status_code != <span class="hljs-number">200</span>:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"请求失败，HTTP 状态码：<span class="hljs-subst">{response.status_code}</span>"</span>)
            <span class="hljs-keyword">return</span>

        <span class="hljs-comment"># 解析 JSON 响应（将字符串转为 Python 字典）</span>
        result = response.json()
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"完整响应数据："</span>)
        <span class="hljs-built_in">print</span>(json.dumps(result, indent=<span class="hljs-number">2</span>, ensure_ascii=<span class="hljs-literal">False</span>))  <span class="hljs-comment"># 格式化打印</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"-"</span> * <span class="hljs-number">50</span>)

        <span class="hljs-comment"># 根据响应状态判断是否获取代理IP成功</span>
        <span class="hljs-keyword">if</span> result.get(<span class="hljs-string">"success"</span>) <span class="hljs-keyword">is</span> <span class="hljs-literal">True</span> <span class="hljs-keyword">and</span> result.get(<span class="hljs-string">"code"</span>) == <span class="hljs-number">0</span>:
            <span class="hljs-comment"># 提取代理IP和端口</span>
            proxy_data = result.get(<span class="hljs-string">"data"</span>, [])
            <span class="hljs-keyword">if</span> proxy_data:
                proxy_IP = proxy_data[<span class="hljs-number">0</span>].get(<span class="hljs-string">"IP"</span>)
                proxy_port = proxy_data[<span class="hljs-number">0</span>].get(<span class="hljs-string">"port"</span>)
                request_IP = result.get(<span class="hljs-string">"request_IP"</span>)

                <span class="hljs-built_in">print</span>(<span class="hljs-string">"请求成功！"</span>)
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"你的请求 IP：<span class="hljs-subst">{request_IP}</span>"</span>)
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"获取到的代理 IP：<span class="hljs-subst">{proxy_IP}</span>"</span>)
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"代理端口：<span class="hljs-subst">{proxy_port}</span>"</span>)
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"可用代理格式（HTTP）：http://<span class="hljs-subst">{proxy_IP}</span>:<span class="hljs-subst">{proxy_port}</span>"</span>)
            <span class="hljs-keyword">else</span>:
                <span class="hljs-built_in">print</span>(<span class="hljs-string">"响应中未包含代理IP数据"</span>)
        <span class="hljs-keyword">else</span>:
            <span class="hljs-comment"># 打印失败原因</span>
            error_msg = result.get(<span class="hljs-string">"msg"</span>, <span class="hljs-string">"未知错误"</span>)
            error_code = result.get(<span class="hljs-string">"code"</span>, <span class="hljs-string">"未知状态码"</span>)
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"获取代理IP失败！"</span>)
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"错误码：<span class="hljs-subst">{error_code}</span>"</span>)
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"错误信息：<span class="hljs-subst">{error_msg}</span>"</span>)

            <span class="hljs-comment"># 针对 113 错误码给出明确提示（你之前遇到的白名单问题）</span>
            <span class="hljs-keyword">if</span> error_code == <span class="hljs-number">113</span>:
                <span class="hljs-built_in">print</span>(<span class="hljs-string">"提示：请登录 ipidea 后台，将你的请求 IP（result 中的 request_IP）添加到白名单后重试"</span>)

    <span class="hljs-keyword">except</span> requests.exceptions.Timeout:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"错误：请求超时（超过 10 秒未响应）"</span>)
    <span class="hljs-keyword">except</span> requests.exceptions.ConnectionError:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"错误：网络连接失败（可能是 API 地址不可达或网络问题）"</span>)
    <span class="hljs-keyword">except</span> json.JSONDecodeError:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"错误：响应数据不是有效的 JSON 格式"</span>)
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"未知错误：<span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>)

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    <span class="hljs-comment"># 执行函数</span>
    fetch_proxy_IP()

</code></pre>
<p>如下图所示，是测试程序的运行截图。顺利的请求到了1个代理IP，API验证有效。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9d3a86b4e3264f11a2512e6a5653a440~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSW1BbGV4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764845464&amp;x-signature=jvITnJpNYK%2FGeFqWgHdvwBn%2F8PI%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-10">代理IP提取成功率</h4>
<p>代理IP提取成功率是指从代理IP池中成功获取有效IP地址的比例，是衡量代理服务质量和可靠性的关键指标。高成功率有助于用户快速获得高质量的代理IP资源，确保数据采集顺利进行。</p>
<p>循环提取100次，每次提取1个代理IP，根据成功提取到的数量来计算提取成功率。如下是核心代码：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">test_1_extraction_success_rate</span>():
    <span class="hljs-string">"""测试1: 代理IP提取成功率"""</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"="</span> * <span class="hljs-number">60</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"测试1: 代理IP提取成功率 (测试100次)"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"="</span> * <span class="hljs-number">60</span>)
    
    successful_extractions = <span class="hljs-number">0</span>
    failed_extractions = <span class="hljs-number">0</span>
    errors = {}
    
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">100</span>):
        proxy_data, _, error = extract_proxy()
        <span class="hljs-keyword">if</span> proxy_data <span class="hljs-keyword">and</span> error <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
            successful_extractions += <span class="hljs-number">1</span>
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"第<span class="hljs-subst">{i+<span class="hljs-number">1</span>:3d}</span>次提取: 成功 - <span class="hljs-subst">{proxy_data[<span class="hljs-string">'data'</span>][<span class="hljs-number">0</span>][<span class="hljs-string">'IP'</span>]}</span>:<span class="hljs-subst">{proxy_data[<span class="hljs-string">'data'</span>][<span class="hljs-number">0</span>][<span class="hljs-string">'port'</span>]}</span>"</span>)
        <span class="hljs-keyword">else</span>:
            failed_extractions += <span class="hljs-number">1</span>
            errors[error] = errors.get(error, <span class="hljs-number">0</span>) + <span class="hljs-number">1</span>
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"第<span class="hljs-subst">{i+<span class="hljs-number">1</span>:3d}</span>次提取: 失败 - <span class="hljs-subst">{error}</span>"</span>)
        time.sleep(<span class="hljs-number">1</span>)
    
    success_rate = (successful_extractions / <span class="hljs-number">100</span>) * <span class="hljs-number">100</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n提取成功率: <span class="hljs-subst">{success_rate:<span class="hljs-number">.2</span>f}</span>% (<span class="hljs-subst">{successful_extractions}</span>/100)"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"错误统计:"</span>)
    <span class="hljs-keyword">for</span> error, count <span class="hljs-keyword">in</span> errors.items():
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  <span class="hljs-subst">{error}</span>: <span class="hljs-subst">{count}</span>次"</span>)
    
    <span class="hljs-keyword">return</span> success_rate, errors
</code></pre>
<p>运行截图如下所示：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/84ab11b376e943f98ec530359dcf3671~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSW1BbGV4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764845464&amp;x-signature=KHyAoFliiDVH%2B8%2B0LEcoPEQmdgo%3D" alt="" loading="lazy"/></p>
<p>测试结果：提取成功率100%，这与官方所声明的99.9%正常运行时间标准相符。</p>
<h4 data-id="heading-11">代理IP提取时间</h4>
<p>代理IP提取时间是从代理服务器池获取可用IP所需的时间。这对于需要多次更换IP以应对网络管理、提高抓取效率或保护隐私的应用非常重要，能缩短数据采集时间并提升用户体验。</p>
<p>循环提取100次，每次提取1个代理IP，然后根据成功提取到的数量来计算提取时间。如下是核心代码：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">test_2_extraction_time</span>():
    <span class="hljs-string">"""测试2: 代理IP提取时间"""</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n"</span> + <span class="hljs-string">"="</span> * <span class="hljs-number">60</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"测试2: 代理IP提取时间 (测试100次)"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"="</span> * <span class="hljs-number">60</span>)
    
    extraction_times = []
    
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">100</span>):
        _, extraction_time, error = extract_proxy()
        extraction_times.append(extraction_time)
        <span class="hljs-keyword">if</span> error <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"第<span class="hljs-subst">{i+<span class="hljs-number">1</span>:3d}</span>次提取时间: <span class="hljs-subst">{extraction_time:<span class="hljs-number">.3</span>f}</span>秒"</span>)
        <span class="hljs-keyword">else</span>:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"第<span class="hljs-subst">{i+<span class="hljs-number">1</span>:3d}</span>次提取时间: <span class="hljs-subst">{extraction_time:<span class="hljs-number">.3</span>f}</span>秒 (提取失败: <span class="hljs-subst">{error}</span>)"</span>)
    
    avg_time = statistics.mean(extraction_times)
    min_time = <span class="hljs-built_in">min</span>(extraction_times)
    max_time = <span class="hljs-built_in">max</span>(extraction_times)
    median_time = statistics.median(extraction_times)
    
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n提取时间统计:"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  平均时间: <span class="hljs-subst">{avg_time:<span class="hljs-number">.3</span>f}</span>秒"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  最短时间: <span class="hljs-subst">{min_time:<span class="hljs-number">.3</span>f}</span>秒"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  最长时间: <span class="hljs-subst">{max_time:<span class="hljs-number">.3</span>f}</span>秒"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  中位时间: <span class="hljs-subst">{median_time:<span class="hljs-number">.3</span>f}</span>秒"</span>)
    
    <span class="hljs-keyword">return</span>
</code></pre>
<p>运行截图如下所示：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0d34682da9f74709a95c08fb1774baea~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSW1BbGV4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764845464&amp;x-signature=6JzzuJOH43FQaZeRHra4rqOem00%3D" alt="" loading="lazy"/></p>
<p>测试结果：平均时间不足1秒，这个耗时在代理IP提取领域属于中上水平，还是非常优秀的。</p>

















<table><thead><tr><th>最短时间</th><th>中位时间</th><th>最长时间</th><th>平均时间</th></tr></thead><tbody><tr><td>0.709秒</td><td>0.915秒</td><td>1.226秒</td><td>0.931秒</td></tr></tbody></table>
<h4 data-id="heading-12">代理IP连通成功率</h4>
<p>代理IP连通成功率，是指代理服务器的网络连通性。该指标对需使用代理IP进行网络访问的用户至关重要，直接影响工作效率与服务质量。连通成功率低会导致数据采集多次失败、重试次数增加，消耗更多时间和资源。</p>
<p>循环提取100次，每次提取1个代理IP，然后向其发起tcp连接，根据连接成功的数量来计算连通成功率。如下是核心代码：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">test_proxy_connectivity</span>(<span class="hljs-params">IP: <span class="hljs-built_in">str</span>, port: <span class="hljs-built_in">int</span></span>) -&gt; <span class="hljs-type">Tuple</span>[<span class="hljs-built_in">bool</span>, <span class="hljs-built_in">float</span>, <span class="hljs-type">Optional</span>[<span class="hljs-built_in">str</span>]]:
    <span class="hljs-string">"""测试代理连通性"""</span>
    start_time = time.time()
    <span class="hljs-keyword">try</span>:
        <span class="hljs-comment"># 测试TCP连接</span>
        sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        sock.settimeout(<span class="hljs-number">10</span>)
        sock.connect((IP, port))
        connect_time = time.time() - start_time
        sock.close()
        <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>, connect_time, <span class="hljs-literal">None</span>
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        connect_time = time.time() - start_time
        error_msg = <span class="hljs-string">f"连接失败: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>
        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>, connect_time, error_msg

<span class="hljs-keyword">def</span> <span class="hljs-title function_">test_3_connection_success_rate</span>():
    <span class="hljs-string">"""测试3: 代理IP连通成功率"""</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n"</span> + <span class="hljs-string">"="</span> * <span class="hljs-number">60</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"测试3: 代理IP连通成功率 (测试100次)"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"="</span> * <span class="hljs-number">60</span>)
    
    successful_connections = <span class="hljs-number">0</span>
    failed_connections = <span class="hljs-number">0</span>
    connection_errors = {}
    
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">100</span>):
        proxy_data, _, extract_error = extract_proxy()
        <span class="hljs-keyword">if</span> proxy_data <span class="hljs-keyword">and</span> extract_error <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
           IP= proxy_data[<span class="hljs-string">"data"</span>][<span class="hljs-number">0</span>][<span class="hljs-string">"IP"</span>]
            port = proxy_data[<span class="hljs-string">"data"</span>][<span class="hljs-number">0</span>][<span class="hljs-string">"port"</span>]
            
            success, _, conn_error = test_proxy_connectivity(IP, port)
            <span class="hljs-keyword">if</span> success:
                successful_connections += <span class="hljs-number">1</span>
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"第<span class="hljs-subst">{i+<span class="hljs-number">1</span>:3d}</span>次连接: <span class="hljs-subst">{IP}</span>:<span class="hljs-subst">{port}</span> - 成功"</span>)
            <span class="hljs-keyword">else</span>:
                failed_connections += <span class="hljs-number">1</span>
                connection_errors[conn_error] = connection_errors.get(conn_error, <span class="hljs-number">0</span>) + <span class="hljs-number">1</span>
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"第<span class="hljs-subst">{i+<span class="hljs-number">1</span>:3d}</span>次连接: <span class="hljs-subst">{IP}</span>:<span class="hljs-subst">{port}</span> - 失败 (<span class="hljs-subst">{conn_error}</span>)"</span>)
        <span class="hljs-keyword">else</span>:
            failed_connections += <span class="hljs-number">1</span>
            error_msg = <span class="hljs-string">f"提取失败: <span class="hljs-subst">{extract_error}</span>"</span>
            connection_errors[error_msg] = connection_errors.get(error_msg, <span class="hljs-number">0</span>) + <span class="hljs-number">1</span>
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"第<span class="hljs-subst">{i+<span class="hljs-number">1</span>:3d}</span>次连接: 提取失败 - <span class="hljs-subst">{extract_error}</span>"</span>)
    
    success_rate = (successful_connections / <span class="hljs-number">100</span>) * <span class="hljs-number">100</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n连通成功率: <span class="hljs-subst">{success_rate:<span class="hljs-number">.2</span>f}</span>% (<span class="hljs-subst">{successful_connections}</span>/100)"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"连接错误统计:"</span>)
    <span class="hljs-keyword">for</span> error, count <span class="hljs-keyword">in</span> connection_errors.items():
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  <span class="hljs-subst">{error}</span>: <span class="hljs-subst">{count}</span>次"</span>)
    
    <span class="hljs-keyword">return</span> success_rate, connection_errors
</code></pre>
<p>运行截图如下：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aa92553c6b50499ca43ee8f860ed6d6b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSW1BbGV4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764845464&amp;x-signature=iwP0a6MWBbxNNrrHXV2qYRSBY%2BU%3D" alt="" loading="lazy"/></p>
<p>测试结果：提取成功率100%，这与官方所声明的99.9%正常运行时间标准相符。</p>
<h4 data-id="heading-13">代理IP响应时间</h4>
<p>代理IP响应时间是指从客户端发送请求到通过代理服务器接收到响应数据之间的时间间隔。这个时间间隔可以用来衡量代理服务器的性能和效率。与代理IP连接时间类似，一般来说，响应时间越短，说明代理服务器处理请求的速度越快，用户体验也就越好。</p>
<p>循环提取100次，每次提取1个代理IP，然后使用它来请求baidu，计算请求成功的时间。如下是核心代码：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">test_proxy_response_time</span>(<span class="hljs-params">IP: <span class="hljs-built_in">str</span>, port: <span class="hljs-built_in">int</span></span>) -&gt; <span class="hljs-type">Tuple</span>[<span class="hljs-type">Optional</span>[<span class="hljs-built_in">float</span>], <span class="hljs-built_in">float</span>]:
    <span class="hljs-string">"""测试代理响应时间"""</span>
    start_time = time.time()
    proxy = <span class="hljs-string">f"http://<span class="hljs-subst">{IP}</span>:<span class="hljs-subst">{port}</span>"</span>
    proxies = {<span class="hljs-string">"http"</span>: proxy, <span class="hljs-string">"https"</span>: proxy}
    test_url = <span class="hljs-string">"http://www.baidu.com"</span>
    
    <span class="hljs-keyword">try</span>:
        response = requests.get(test_url, proxies=proxies, timeout=<span class="hljs-number">15</span>)
        <span class="hljs-keyword">if</span> response.status_code == <span class="hljs-number">200</span>:
            response_time = time.time() - start_time
            <span class="hljs-keyword">return</span> response_time, response_time
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-keyword">pass</span>
    
    total_time = time.time() - start_time
    <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>, total_time

<span class="hljs-keyword">def</span> <span class="hljs-title function_">test_5_response_time</span>():
    <span class="hljs-string">"""测试5: 代理IP响应时间"""</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n"</span> + <span class="hljs-string">"="</span> * <span class="hljs-number">60</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"测试5: 代理IP响应时间 (测试100次)"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"="</span> * <span class="hljs-number">60</span>)
    
    response_times = []
    
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">100</span>):
        proxy_data, _, extract_error = extract_proxy()
        <span class="hljs-keyword">if</span> proxy_data <span class="hljs-keyword">and</span> extract_error <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
           IP= proxy_data[<span class="hljs-string">"data"</span>][<span class="hljs-number">0</span>][<span class="hljs-string">"IP"</span>]
            port = proxy_data[<span class="hljs-string">"data"</span>][<span class="hljs-number">0</span>][<span class="hljs-string">"port"</span>]
            
            resp_time, _ = test_proxy_response_time(IP, port)
            <span class="hljs-keyword">if</span> resp_time <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:
                response_times.append(resp_time)
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"第<span class="hljs-subst">{i+<span class="hljs-number">1</span>:3d}</span>次响应时间: <span class="hljs-subst">{resp_time:<span class="hljs-number">.3</span>f}</span>秒 - <span class="hljs-subst">{IP}</span>:<span class="hljs-subst">{port}</span>"</span>)
            <span class="hljs-keyword">else</span>:
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"第<span class="hljs-subst">{i+<span class="hljs-number">1</span>:3d}</span>次响应时间: 测试失败 - <span class="hljs-subst">{IP}</span>:<span class="hljs-subst">{port}</span>"</span>)
        <span class="hljs-keyword">else</span>:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"第<span class="hljs-subst">{i+<span class="hljs-number">1</span>:3d}</span>次: 提取失败，无法测试响应时间"</span>)
    
    <span class="hljs-keyword">if</span> response_times:
        avg_time = statistics.mean(response_times)
        min_time = <span class="hljs-built_in">min</span>(response_times)
        max_time = <span class="hljs-built_in">max</span>(response_times)
        median_time = statistics.median(response_times)
        
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n响应时间统计:"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  平均时间: <span class="hljs-subst">{avg_time:<span class="hljs-number">.3</span>f}</span>秒"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  最短时间: <span class="hljs-subst">{min_time:<span class="hljs-number">.3</span>f}</span>秒"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  最长时间: <span class="hljs-subst">{max_time:<span class="hljs-number">.3</span>f}</span>秒"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  中位时间: <span class="hljs-subst">{median_time:<span class="hljs-number">.3</span>f}</span>秒"</span>)
    <span class="hljs-keyword">else</span>:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n没有成功的响应时间测试，无法计算响应时间统计"</span>)
    
    <span class="hljs-keyword">return</span> response_times
</code></pre>
<p>运行截图：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/62349d1f21b34831960b8a6c2653a360~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSW1BbGV4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764845464&amp;x-signature=anntoXbYIZM4HHxT2dwrs7Oxpv0%3D" alt="" loading="lazy"/></p>
<p>测试结果：平均时间2.467秒，除了因为我这里网络波动引起的个别异常值外，整体耗时还是比较优秀的。</p>

















<table><thead><tr><th>最短时间</th><th>中位时间</th><th>最长时间</th><th>平均时间</th></tr></thead><tbody><tr><td>0.415秒</td><td>2.145秒</td><td>12.263秒</td><td>2.467秒</td></tr></tbody></table>
<h2 data-id="heading-14">使用动态住宅代理IP爬取维基百科数据</h2>
<p>为了简化爬虫代码，提高效率，我们直接访问维基百科的纯文本页面。在任意维基百科页面URL后加?action=raw，即可跳转纯文本版本。比如：<code>[&lt;font style="color:rgb(0, 0, 0);"&gt;https://zh.wikipedia.org/wiki/3%E6%9C%8830%E6%97%A5?action=raw&lt;/font&gt;](https://zh.wikipedia.org/wiki/3%E6%9C%8830%E6%97%A5?action=raw)</code>：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3a684aa3a3f5477cb6d7a09d9633f0fa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSW1BbGV4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764845464&amp;x-signature=Cmu9qQ8vVKp1iprnMHF%2BwrSHaSg%3D" alt="" loading="lazy"/></p>
<p>接下来就简单了，我们只需要对日期进行拼接，然后请求一个代理IP来抓取，然后将抓取到的数据，清洗整理之后，保存到文本文件中即可。完整代码如下所示：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> requests
<span class="hljs-keyword">import</span> re
<span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> datetime
<span class="hljs-keyword">import</span> time
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">List</span>, <span class="hljs-type">Dict</span>, <span class="hljs-type">Optional</span>, <span class="hljs-type">Tuple</span>

<span class="hljs-comment"># 配置参数</span>
PROXY_API_URL = <span class="hljs-string">"http://api.proxy.IPIDEA.io/getBalanceProxyIP?num=1&amp;return_type=json&amp;lb=1&amp;sb=0&amp;flow=1&amp;regions=us&amp;protocol=http"</span>
HEADERS = {
    <span class="hljs-string">"User-Agent"</span>: <span class="hljs-string">"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36"</span>,
    <span class="hljs-string">"Accept"</span>: <span class="hljs-string">"text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8"</span>,
    <span class="hljs-string">"Accept-Language"</span>: <span class="hljs-string">"zh-CN,zh;q=0.9,en;q=0.8"</span>
}
BASE_WIKI_URL = <span class="hljs-string">"https://zh.wikIPedia.org/wiki/{month}月{day}日?action=raw"</span>
PROXY_RETRY_TIMES = <span class="hljs-number">3</span>
WIKI_RETRY_TIMES = <span class="hljs-number">2</span>
DELAY = <span class="hljs-number">1</span>
OUTPUT_FILE = <span class="hljs-string">"维基百科所有日期历史信息_代理版_带月日.txt"</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_proxy_IP</span>() -&gt; <span class="hljs-type">Optional</span>[<span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-built_in">str</span>]]:
    <span class="hljs-string">"""获取代理IP，返回格式：{'http': 'http://IP:port', 'https': 'http://IP:port'}"""</span>
    <span class="hljs-keyword">for</span> retry <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(PROXY_RETRY_TIMES):
        <span class="hljs-keyword">try</span>:
            response = requests.get(PROXY_API_URL, timeout=<span class="hljs-number">10</span>)
            response.raise_for_status()
            proxy_result = response.json()

            <span class="hljs-keyword">if</span> proxy_result.get(<span class="hljs-string">"success"</span>) <span class="hljs-keyword">is</span> <span class="hljs-literal">True</span> <span class="hljs-keyword">and</span> proxy_result.get(<span class="hljs-string">"code"</span>) == <span class="hljs-number">0</span>:
                proxy_data = proxy_result.get(<span class="hljs-string">"data"</span>, [])
                <span class="hljs-keyword">if</span> proxy_data:
                   IP= proxy_data[<span class="hljs-number">0</span>].get(<span class="hljs-string">"IP"</span>)
                    port = proxy_data[<span class="hljs-number">0</span>].get(<span class="hljs-string">"port"</span>)
                    ifIPand port:
                        proxy = {
                            <span class="hljs-string">"http"</span>: <span class="hljs-string">f"http://<span class="hljs-subst">{IP}</span>:<span class="hljs-subst">{port}</span>"</span>
                        }
                        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"✅ 成功获取代理IP：<span class="hljs-subst">{IP}</span>:<span class="hljs-subst">{port}</span>"</span>)
                        <span class="hljs-keyword">return</span> proxy
                <span class="hljs-built_in">print</span>(<span class="hljs-string">"❌ 代理接口返回数据为空"</span>)
            <span class="hljs-keyword">else</span>:
                error_msg = proxy_result.get(<span class="hljs-string">"msg"</span>, <span class="hljs-string">"未知错误"</span>)
                error_code = proxy_result.get(<span class="hljs-string">"code"</span>, <span class="hljs-string">"未知状态码"</span>)
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"❌ 获取代理IP失败（错误码：<span class="hljs-subst">{error_code}</span>，信息：<span class="hljs-subst">{error_msg}</span>）"</span>)
                <span class="hljs-keyword">if</span> error_code == <span class="hljs-number">113</span>:
                    <span class="hljs-built_in">print</span>(<span class="hljs-string">"⚠️  提示：请登录ipidea后台，将当前请求IP添加到白名单"</span>)
        <span class="hljs-keyword">except</span> requests.exceptions.Timeout:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"⚠️  获取代理IP超时，第<span class="hljs-subst">{retry+<span class="hljs-number">1</span>}</span>/<span class="hljs-subst">{PROXY_RETRY_TIMES}</span>次重试..."</span>)
        <span class="hljs-keyword">except</span> requests.exceptions.ConnectionError:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"⚠️  获取代理IP网络连接失败，第<span class="hljs-subst">{retry+<span class="hljs-number">1</span>}</span>/<span class="hljs-subst">{PROXY_RETRY_TIMES}</span>次重试..."</span>)
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"⚠️  获取代理IP异常：<span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>，第<span class="hljs-subst">{retry+<span class="hljs-number">1</span>}</span>/<span class="hljs-subst">{PROXY_RETRY_TIMES}</span>次重试..."</span>)
        time.sleep(DELAY)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"❌ 多次获取代理IP失败"</span>)
    <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_max_days</span>(<span class="hljs-params">month: <span class="hljs-built_in">int</span>, year: <span class="hljs-built_in">int</span> = <span class="hljs-number">2024</span></span>) -&gt; <span class="hljs-built_in">int</span>:
    <span class="hljs-string">"""获取指定月份的最大天数（2024是闰年，适配2月29天）"""</span>
    <span class="hljs-keyword">if</span> month == <span class="hljs-number">2</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-number">29</span> <span class="hljs-keyword">if</span> (year % <span class="hljs-number">4</span> == <span class="hljs-number">0</span> <span class="hljs-keyword">and</span> year % <span class="hljs-number">100</span> != <span class="hljs-number">0</span>) <span class="hljs-keyword">or</span> (year % <span class="hljs-number">400</span> == <span class="hljs-number">0</span>) <span class="hljs-keyword">else</span> <span class="hljs-number">28</span>
    <span class="hljs-keyword">elif</span> month <span class="hljs-keyword">in</span> [<span class="hljs-number">4</span>, <span class="hljs-number">6</span>, <span class="hljs-number">9</span>, <span class="hljs-number">11</span>]:
        <span class="hljs-keyword">return</span> <span class="hljs-number">30</span>
    <span class="hljs-keyword">else</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-number">31</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">generate_all_dates</span>() -&gt; <span class="hljs-type">List</span>[<span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-built_in">int</span>]]:
    <span class="hljs-string">"""生成全年所有日期（月/日）"""</span>
    all_dates = []
    <span class="hljs-keyword">for</span> month <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, <span class="hljs-number">13</span>):
        max_days = get_max_days(month)
        <span class="hljs-keyword">for</span> day <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, max_days + <span class="hljs-number">1</span>):
            all_dates.append({<span class="hljs-string">"month"</span>: month, <span class="hljs-string">"day"</span>: day})
    <span class="hljs-keyword">return</span> all_dates

<span class="hljs-keyword">def</span> <span class="hljs-title function_">fetch_wikitext_with_proxy</span>(<span class="hljs-params">month: <span class="hljs-built_in">int</span>, day: <span class="hljs-built_in">int</span></span>) -&gt; <span class="hljs-type">Optional</span>[<span class="hljs-built_in">str</span>]:
    <span class="hljs-string">"""使用代理IP请求指定日期的维基百科原始wikitext内容"""</span>
    url = BASE_WIKI_URL.<span class="hljs-built_in">format</span>(month=month, day=day)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n📥 正在请求 <span class="hljs-subst">{month}</span>月<span class="hljs-subst">{day}</span>日 维基内容（使用代理）"</span>)
    
    <span class="hljs-keyword">for</span> retry <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(WIKI_RETRY_TIMES):
        proxy = get_proxy_IP()
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> proxy:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"⚠️  第<span class="hljs-subst">{retry+<span class="hljs-number">1</span>}</span>/<span class="hljs-subst">{WIKI_RETRY_TIMES}</span>次重试：获取代理失败，跳过该日期"</span>)
            <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>
        
        <span class="hljs-keyword">try</span>:
            response = requests.get(
                url, 
                headers=HEADERS, 
                proxies=proxy, 
                timeout=<span class="hljs-number">20</span>,
                verify=<span class="hljs-literal">False</span>
            )
            response.raise_for_status()
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"✅ <span class="hljs-subst">{month}</span>月<span class="hljs-subst">{day}</span>日 维基内容请求成功"</span>)
            <span class="hljs-keyword">return</span> response.text
        <span class="hljs-keyword">except</span> requests.exceptions.ProxyError:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"⚠️  第<span class="hljs-subst">{retry+<span class="hljs-number">1</span>}</span>/<span class="hljs-subst">{WIKI_RETRY_TIMES}</span>次重试：代理失效或不可用"</span>)
        <span class="hljs-keyword">except</span> requests.exceptions.Timeout:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"⚠️  第<span class="hljs-subst">{retry+<span class="hljs-number">1</span>}</span>/<span class="hljs-subst">{WIKI_RETRY_TIMES}</span>次重试：代理请求超时"</span>)
        <span class="hljs-keyword">except</span> requests.exceptions.ConnectionError:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"⚠️  第<span class="hljs-subst">{retry+<span class="hljs-number">1</span>}</span>/<span class="hljs-subst">{WIKI_RETRY_TIMES}</span>次重试：代理网络连接失败"</span>)
        <span class="hljs-keyword">except</span> requests.exceptions.HTTPError <span class="hljs-keyword">as</span> e:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"❌ 第<span class="hljs-subst">{retry+<span class="hljs-number">1</span>}</span>/<span class="hljs-subst">{WIKI_RETRY_TIMES}</span>次重试：请求失败（<span class="hljs-subst">{e}</span>）"</span>)
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"⚠️  第<span class="hljs-subst">{retry+<span class="hljs-number">1</span>}</span>/<span class="hljs-subst">{WIKI_RETRY_TIMES}</span>次重试：未知异常 <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>)
        
        time.sleep(DELAY * <span class="hljs-number">2</span>)
    
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"❌ <span class="hljs-subst">{month}</span>月<span class="hljs-subst">{day}</span>日 多次代理请求失败，跳过该日期"</span>)
    <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">add_month_day_to_year</span>(<span class="hljs-params">item: <span class="hljs-built_in">str</span>, month: <span class="hljs-built_in">int</span>, day: <span class="hljs-built_in">int</span></span>) -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-string">"""在年份后添加月日（支持公元/公元前、1-4位数年份）"""</span>
    <span class="hljs-comment"># 正则匹配规则：支持 公元前xxxx年、xxxx年、xx年 格式，匹配后在年份后插入 月日</span>
    <span class="hljs-comment"># 分组说明：\1=前缀（公元前）、\2=年份数字、\3=年字、\4=冒号及后面内容</span>
    pattern = <span class="hljs-string">r"(^(前|公元前)?(\d{1,4})(年)(：|:))(.*)"</span>
    <span class="hljs-keyword">match</span> = re.<span class="hljs-keyword">match</span>(pattern, item, re.UNICODE)
    
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">match</span>:
        <span class="hljs-comment"># 提取各部分并拼接：前缀 + 年份 + 年 + 月日 + 冒号 + 内容</span>
        prefix = <span class="hljs-keyword">match</span>.group(<span class="hljs-number">1</span>)  <span class="hljs-comment"># 包含"公元前"（如有）、年份、"年"、冒号</span>
        content = <span class="hljs-keyword">match</span>.group(<span class="hljs-number">6</span>)  <span class="hljs-comment"># 冒号后的内容</span>
        <span class="hljs-comment"># 插入月日（格式：x月x日）</span>
        new_item = <span class="hljs-string">f"<span class="hljs-subst">{<span class="hljs-keyword">match</span>.group(<span class="hljs-number">2</span>) <span class="hljs-keyword">if</span> <span class="hljs-keyword">match</span>.group(<span class="hljs-number">2</span>) <span class="hljs-keyword">else</span> <span class="hljs-string">''</span>}</span><span class="hljs-subst">{<span class="hljs-keyword">match</span>.group(<span class="hljs-number">3</span>)}</span>年<span class="hljs-subst">{month}</span>月<span class="hljs-subst">{day}</span>日<span class="hljs-subst">{<span class="hljs-keyword">match</span>.group(<span class="hljs-number">5</span>)}</span><span class="hljs-subst">{content}</span>"</span>
        <span class="hljs-keyword">return</span> new_item
    <span class="hljs-keyword">else</span>:
        <span class="hljs-comment"># 无明确年份格式的记录，保持原样</span>
        <span class="hljs-keyword">return</span> item

<span class="hljs-keyword">def</span> <span class="hljs-title function_">parse_wikitext</span>(<span class="hljs-params">wikitext: <span class="hljs-built_in">str</span>, month: <span class="hljs-built_in">int</span>, day: <span class="hljs-built_in">int</span></span>) -&gt; <span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>]]:
    <span class="hljs-string">"""解析wikitext，提取大事记、出生、逝世信息，在年份后补充月日"""</span>
    section_pattern = <span class="hljs-string">r"==\s*(%s)\s*==\n([\s\S]*?)(?=\n==\s*[\u4e00-\u9fa5]+\s*==|\Z)"</span>
    target_sections = [<span class="hljs-string">"大事记"</span>, <span class="hljs-string">"出生"</span>, <span class="hljs-string">"逝世"</span>]
    
    result = {section: [] <span class="hljs-keyword">for</span> section <span class="hljs-keyword">in</span> target_sections}
    
    <span class="hljs-keyword">for</span> section <span class="hljs-keyword">in</span> target_sections:
        <span class="hljs-keyword">match</span> = re.search(section_pattern % section, wikitext, re.IGNORECASE)
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">match</span>:
            result[section] = [<span class="hljs-string">"无相关记录"</span>]
            <span class="hljs-keyword">continue</span>
        
        content = <span class="hljs-keyword">match</span>.group(<span class="hljs-number">2</span>).strIP()
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> content:
            result[section] = [<span class="hljs-string">"无相关记录"</span>]
            <span class="hljs-keyword">continue</span>
        
        <span class="hljs-comment"># 基础清洗</span>
        content = re.sub(<span class="hljs-string">r"\{\{[^\}]+\}\}"</span>, <span class="hljs-string">""</span>, content)
        content = re.sub(<span class="hljs-string">r"\[\[([^\]|]+)\|([^\]]+)\]\]"</span>, <span class="hljs-string">r"\2"</span>, content)
        content = re.sub(<span class="hljs-string">r"\[\[([^\]]+)\]\]"</span>, <span class="hljs-string">r"\1"</span>, content)
        content = re.sub(<span class="hljs-string">r"&lt;ref[^&gt;]*&gt;[\s\S]*?&lt;/ref&gt;"</span>, <span class="hljs-string">""</span>, content)
        content = re.sub(<span class="hljs-string">r"\n+"</span>, <span class="hljs-string">"\n"</span>, content)
        items = re.findall(<span class="hljs-string">r"^\* (.+)$"</span>, content, re.MULTILINE)
        
        <span class="hljs-comment"># 核心步骤：为每条记录的年份后添加月日</span>
        processed_items = []
        <span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> items:
            processed_item = add_month_day_to_year(item, month, day)
            processed_items.append(processed_item)
        
        result[section] = processed_items <span class="hljs-keyword">if</span> processed_items <span class="hljs-keyword">else</span> [<span class="hljs-string">"无相关记录"</span>]
    
    <span class="hljs-keyword">return</span> result

<span class="hljs-keyword">def</span> <span class="hljs-title function_">save_result</span>(<span class="hljs-params">date_info: <span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-built_in">int</span>], parsed_data: <span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>]], file</span>):
    <span class="hljs-string">"""将解析结果写入文件"""</span>
    month, day = date_info[<span class="hljs-string">"month"</span>], date_info[<span class="hljs-string">"day"</span>]
    
    <span class="hljs-comment"># 注意：这里要和target_sections对应</span>
    <span class="hljs-keyword">for</span> section <span class="hljs-keyword">in</span> [<span class="hljs-string">"大事记"</span>, <span class="hljs-string">"出生"</span>, <span class="hljs-string">"逝世"</span>]:
        <span class="hljs-keyword">for</span> idx, item <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(parsed_data[section], <span class="hljs-number">1</span>):
            file.write(<span class="hljs-string">f"<span class="hljs-subst">{item}</span>\n"</span>)

<span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():
    <span class="hljs-string">"""主函数：生成日期→获取代理→代理请求维基→解析→保存"""</span>
    requests.packages.urllib3.disable_warnings()
    
    all_dates = generate_all_dates()
    total_dates = <span class="hljs-built_in">len</span>(all_dates)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"📅 共生成 <span class="hljs-subst">{total_dates}</span> 个日期，开始遍历（每个日期将使用独立代理IP）..."</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"⚠️  注意：若持续获取代理失败，请检查IP白名单配置\n"</span>)
    
    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(OUTPUT_FILE, <span class="hljs-string">"w"</span>, encoding=<span class="hljs-string">"utf-8"</span>) <span class="hljs-keyword">as</span> f:
        <span class="hljs-keyword">for</span> idx, date <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(all_dates, <span class="hljs-number">1</span>):
            month, day = date[<span class="hljs-string">"month"</span>], date[<span class="hljs-string">"day"</span>]
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n<span class="hljs-subst">{<span class="hljs-string">'='</span>*<span class="hljs-number">60</span>}</span>"</span>)
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"[<span class="hljs-subst">{idx}</span>/<span class="hljs-subst">{total_dates}</span>] 正在处理：<span class="hljs-subst">{month}</span>月<span class="hljs-subst">{day}</span>日"</span>)
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"<span class="hljs-subst">{<span class="hljs-string">'='</span>*<span class="hljs-number">60</span>}</span>"</span>)
            
            wikitext = fetch_wikitext_with_proxy(month, day)
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> wikitext:
                <span class="hljs-keyword">continue</span>
            
            parsed_data = parse_wikitext(wikitext, month, day)
            save_result(date, parsed_data, f)
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"✅ <span class="hljs-subst">{month}</span>月<span class="hljs-subst">{day}</span>日 信息已保存"</span>)
    
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n🎉 所有日期处理完成！结果已保存至：<span class="hljs-subst">{OUTPUT_FILE}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"⚠️  部分日期可能因代理失效或网络问题未获取到内容，可查看控制台日志"</span>)

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    main()

</code></pre>
<p>爬取每个日期的事件前，先提取一个代理IP。然后使用代理IP去抓取，抓取到内容后进行内容清洗，保存到文件：<code>维基百科所有日期历史信息_代理版_带月日.txt</code>中，依次循环，直到抓取完365/366个日期的所有事件。</p>
<p>如下所示是代码运行截图，成功的将每个日期的大事件记录抓取、清洗并保存了下来。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/74e82b495296490e8695527b7a0b5ba3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSW1BbGV4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764845464&amp;x-signature=fpq3QhVU656MB7qm52ZJ5oykgZI%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-15">智能体效果验证</h2>
<p>智能体的最终回答质量，从来都离不开优质数据源、高效采集能力与完整数据支撑的三重保障——而<a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.ipidea.net%2F%3Futm-source%3D1Alex%26utm-keyword%3D%3F1Alex" target="_blank" title="http://www.ipidea.net/?utm-source=1Alex&amp;utm-keyword=?1Alex" ref="nofollow noopener noreferrer">IPIDEA代理IP</a>的核心功能与强悍性能，正是打通这一链路的关键纽带。它绝非单纯的“工具”，更像是全程赋能的“得力助手”：不仅在数据采集环节扫清障碍，更将自身优势直接转化为智能体回答质量的跨越式提升，让知识库的价值真正落地见效。</p>
<h3 data-id="heading-16">知识库展示</h3>
<p>如下图所示，是我抓取清洗后的内容。这就是一份可以用来构建知识库的优质数据集了。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cfafa4f4296b4e3fa572a945137a22ca~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSW1BbGV4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764845464&amp;x-signature=bOFdTIhErBfogyMjQ3Ua9zWwyJ4%3D" alt="" loading="lazy"/></p>
<p>经过分段解析后，会得到下图所示的一个知识条目，适配智能体的知识库检索调用逻辑，让大模型能直接精准抓取所需信息。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c8eaa10a227643429c8e01c373841265~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSW1BbGV4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764845464&amp;x-signature=Z14fWt0R20rA0KCLLbxS4xZEt%2Fo%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-17">智能体表现对比</h3>
<p>接下来，我们通过2个简单的问题，来对比使用知识库前后的智能体表现差异。</p>




















<table><thead><tr><th><strong>问题</strong></th><th><strong>无知识库</strong></th><th><strong>有知识库</strong></th></tr></thead><tbody><tr><td>1945年1月9日有哪些重大事件发生？</td><td><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a49fb43b267546319facced22c77ae76~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSW1BbGV4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764845464&amp;x-signature=u7BgR7rhtwwxXJU4CHbXLBeLLpg%3D" alt="" loading="lazy"/></td><td><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eb69d4649da84cc7885f2cf89bf238f7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSW1BbGV4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764845464&amp;x-signature=x7H7sHD8LeCp7chZPEs4dOM1GMU%3D" alt="" loading="lazy"/></td></tr><tr><td>1月1日发生过什么重要事件？</td><td><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f03ac6ce389e4fbcb51b2369e0a63072~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSW1BbGV4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764845464&amp;x-signature=bBTiPSzay3sTprqlBsGJWMFzl%2Fk%3D" alt="" loading="lazy"/></td><td><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4118597662144c2d96060089607e5d6e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSW1BbGV4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764845464&amp;x-signature=bw3gzjMSbXVhUB5tjzDaztlyYCc%3D" alt="" loading="lazy"/></td></tr></tbody></table>
<p>根据对第一个问题的回答进行对比分析后发现，引入知识库显著提升了AI系统的知识容量。从第二个问题的回答对比中可以看出，在知识库的支持下，AI的回答更加贴合“历史大事记”智能体的特定调性，其重点集中于历史事件而非近期发生的事件上，从而更接近预期设定的标准。</p>
<h2 data-id="heading-18">结论</h2>
<p>回头看“历史大事记”智能体的搭建过程，最核心的感悟是:<strong>智能体的回答质量，本质是知识库的“数据质量”决定的</strong>。初期依赖大模型原生知识库，之所以出现“缺斤短两”“描述模糊”的问题，核心就是缺乏结构化、全覆盖、高权威的专属数据支撑--而维基百科作为全球公认的优质数据源，恰好弥补了这一短板，但“国内无法直接访问”“海量数据需自动化采集”的现实难题，又让代理IP成为了不可或缺的“桥梁”。</p>
<p>在整个数据采集环节中，代理IP的选择堪称“关键一步”。通过代理IP可以突破网络封锁，并且可以有效解决反爬机制等问题，最终实现了“采集-清洗-入库”的全流程顺畅落地。</p>
<p>最终，通过“维基百科数据源+代理IP+Python爬虫”的组合，我成功构建了一份覆盖全年日期、包含大事记、出生、逝世三大核心维度的高质量知识库，让智能体能够精准定位历史事件，彻底解决了“回答模糊、遗漏关键信息”的问题。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Apple StoreKit 2 开发指南]]></title>    <link>https://juejin.cn/post/7577215663968190506</link>    <guid>https://juejin.cn/post/7577215663968190506</guid>    <pubDate>2025-11-27T11:15:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577215663968190506" data-draft-id="7577215663968174122" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Apple StoreKit 2 开发指南"/> <meta itemprop="keywords" content="iOS,Apple"/> <meta itemprop="datePublished" content="2025-11-27T11:15:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Lexiaoyao20"/> <meta itemprop="url" content="https://juejin.cn/user/2471357869461038"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Apple StoreKit 2 开发指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2471357869461038/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Lexiaoyao20
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T11:15:09.000Z" title="Thu Nov 27 2025 11:15:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    13
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body .octicon{display:inline-block;fill:currentColor;vertical-align:text-bottom}.markdown-body .anchor{float:left;line-height:1;margin-left:-20px;padding-right:4px}.markdown-body .anchor:focus{outline:none}.markdown-body h1 .octicon-link,.markdown-body h2 .octicon-link,.markdown-body h3 .octicon-link,.markdown-body h4 .octicon-link,.markdown-body h5 .octicon-link,.markdown-body h6 .octicon-link{color:#1b1f23;vertical-align:middle;visibility:hidden}.markdown-body h1:hover .anchor,.markdown-body h2:hover .anchor,.markdown-body h3:hover .anchor,.markdown-body h4:hover .anchor,.markdown-body h5:hover .anchor,.markdown-body h6:hover .anchor{text-decoration:none}.markdown-body h1:hover .anchor .octicon-link,.markdown-body h2:hover .anchor .octicon-link,.markdown-body h3:hover .anchor .octicon-link,.markdown-body h4:hover .anchor .octicon-link,.markdown-body h5:hover .anchor .octicon-link,.markdown-body h6:hover .anchor .octicon-link{visibility:visible}.markdown-body h1:hover .anchor .octicon-link:before,.markdown-body h2:hover .anchor .octicon-link:before,.markdown-body h3:hover .anchor .octicon-link:before,.markdown-body h4:hover .anchor .octicon-link:before,.markdown-body h5:hover .anchor .octicon-link:before,.markdown-body h6:hover .anchor .octicon-link:before{width:16px;height:16px;content:" ";display:inline-block;background-image:url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' aria-hidden='true'%3E%3Cpath fill-rule='evenodd' d='M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z'/%3E%3C/svg%3E")}.markdown-body{-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;color:#24292e;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Helvetica,Arial,sans-serif,Apple Color Emoji,Segoe UI Emoji;font-size:16px;line-height:1.5;word-wrap:break-word}.markdown-body details{display:block}.markdown-body summary{display:list-item}.markdown-body a{background-color:initial}.markdown-body a:active,.markdown-body a:hover{outline-width:0}.markdown-body strong{font-weight:inherit;font-weight:bolder}.markdown-body h1{margin:.67em 0}.markdown-body img{border-style:none}.markdown-body code,.markdown-body kbd,.markdown-body pre{font-family:monospace,monospace;font-size:1em}.markdown-body hr{box-sizing:initial;overflow:visible}.markdown-body input{font:inherit;margin:0;overflow:visible}.markdown-body [type=checkbox]{box-sizing:border-box;padding:0}.markdown-body *{box-sizing:border-box}.markdown-body input{font-family:inherit;font-size:inherit;line-height:inherit}.markdown-body a{color:#0366d6;text-decoration:none}.markdown-body a:hover{text-decoration:underline}.markdown-body strong{font-weight:600}.markdown-body hr{height:0;margin:15px 0;overflow:hidden;background:transparent;border-bottom:1px solid #dfe2e5}.markdown-body hr:after,.markdown-body hr:before{display:table;content:""}.markdown-body hr:after{clear:both}.markdown-body table{border-spacing:0;border-collapse:collapse}.markdown-body td,.markdown-body th{padding:0}.markdown-body details summary{cursor:pointer}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin-top:0;margin-bottom:0}.markdown-body h1{font-size:32px}.markdown-body h1,.markdown-body h2{font-weight:600}.markdown-body h2{font-size:24px}.markdown-body h3{font-size:20px}.markdown-body h3,.markdown-body h4{font-weight:600}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:14px}.markdown-body h5,.markdown-body h6{font-weight:600}.markdown-body h6{font-size:12px}.markdown-body p{margin-top:0;margin-bottom:10px}.markdown-body blockquote{margin:0}.markdown-body ol,.markdown-body ul{padding-left:0;margin-top:0;margin-bottom:0}.markdown-body ol ol,.markdown-body ul ol{list-style-type:lower-roman}.markdown-body ol ol ol,.markdown-body ol ul ol,.markdown-body ul ol ol,.markdown-body ul ul ol{list-style-type:lower-alpha}.markdown-body dd{margin-left:0}.markdown-body code,.markdown-body pre{font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:12px}.markdown-body pre{margin-top:0;margin-bottom:0}.markdown-body input::-webkit-inner-spin-button,.markdown-body input::-webkit-outer-spin-button{margin:0;-webkit-appearance:none;appearance:none}.markdown-body :checked+.radio-label{position:relative;z-index:1;border-color:#0366d6}.markdown-body .border{border:1px solid #e1e4e8!important}.markdown-body .border-0{border:0!important}.markdown-body .border-bottom{border-bottom:1px solid #e1e4e8!important}.markdown-body .rounded-1{border-radius:3px!important}.markdown-body .bg-white{background-color:#fff!important}.markdown-body .bg-gray-light{background-color:#fafbfc!important}.markdown-body .text-gray-light{color:#6a737d!important}.markdown-body .pl-3,.markdown-body .px-3{padding-left:16px!important}.markdown-body .px-3{padding-right:16px!important}.markdown-body .f6{font-size:12px!important}.markdown-body .lh-condensed{line-height:1.25!important}.markdown-body .text-bold{font-weight:600!important}.markdown-body .pl-c{color:#6a737d}.markdown-body .pl-c1,.markdown-body .pl-s .pl-v{color:#005cc5}.markdown-body .pl-e,.markdown-body .pl-en{color:#6f42c1}.markdown-body .pl-s .pl-s1,.markdown-body .pl-smi{color:#24292e}.markdown-body .pl-ent{color:#22863a}.markdown-body .pl-k{color:#d73a49}.markdown-body .pl-pds,.markdown-body .pl-s,.markdown-body .pl-s .pl-pse .pl-s1,.markdown-body .pl-sr,.markdown-body .pl-sr .pl-cce,.markdown-body .pl-sr .pl-sra,.markdown-body .pl-sr .pl-sre{color:#032f62}.markdown-body .pl-smw,.markdown-body .pl-v{color:#e36209}.markdown-body .pl-bu{color:#b31d28}.markdown-body .pl-ii{color:#fafbfc;background-color:#b31d28}.markdown-body .pl-c2{color:#fafbfc;background-color:#d73a49}.markdown-body .pl-c2:before{content:"^M"}.markdown-body .pl-sr .pl-cce{font-weight:700;color:#22863a}.markdown-body .pl-ml{color:#735c0f}.markdown-body .pl-mh,.markdown-body .pl-mh .pl-en,.markdown-body .pl-ms{font-weight:700;color:#005cc5}.markdown-body .pl-mi{font-style:italic;color:#24292e}.markdown-body .pl-mb{font-weight:700;color:#24292e}.markdown-body .pl-md{color:#b31d28;background-color:#ffeef0}.markdown-body .pl-mi1{color:#22863a;background-color:#f0fff4}.markdown-body .pl-mc{color:#e36209;background-color:#ffebda}.markdown-body .pl-mi2{color:#f6f8fa;background-color:#005cc5}.markdown-body .pl-mdr{font-weight:700;color:#6f42c1}.markdown-body .pl-ba{color:#586069}.markdown-body .pl-sg{color:#959da5}.markdown-body .pl-corl{text-decoration:underline;color:#032f62}.markdown-body .mb-0{margin-bottom:0!important}.markdown-body .my-2{margin-bottom:8px!important;margin-top:8px!important}.markdown-body .pl-0{padding-left:0!important}.markdown-body .py-0{padding-top:0!important;padding-bottom:0!important}.markdown-body .pl-1{padding-left:4px!important}.markdown-body .pl-2{padding-left:8px!important}.markdown-body .py-2{padding-top:8px!important;padding-bottom:8px!important}.markdown-body .pl-3{padding-left:16px!important}.markdown-body .pl-4{padding-left:24px!important}.markdown-body .pl-5{padding-left:32px!important}.markdown-body .pl-6{padding-left:40px!important}.markdown-body .pl-7{padding-left:48px!important}.markdown-body .pl-8{padding-left:64px!important}.markdown-body .pl-9{padding-left:80px!important}.markdown-body .pl-10{padding-left:96px!important}.markdown-body .pl-11{padding-left:112px!important}.markdown-body .pl-12{padding-left:128px!important}.markdown-body hr{border-bottom-color:#eee}.markdown-body kbd{display:inline-block;padding:3px 5px;font:11px SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;line-height:10px;color:#444d56;vertical-align:middle;background-color:#fafbfc;border:1px solid #d1d5da;border-radius:3px;box-shadow:inset 0 -1px 0 #d1d5da}.markdown-body:after,.markdown-body:before{display:table;content:""}.markdown-body:after{clear:both}.markdown-body&gt;:first-child{margin-top:0!important}.markdown-body&gt;:last-child{margin-bottom:0!important}.markdown-body a:not([href]){color:inherit;text-decoration:none}.markdown-body blockquote,.markdown-body details,.markdown-body dl,.markdown-body ol,.markdown-body p,.markdown-body pre,.markdown-body table,.markdown-body ul{margin-top:0;margin-bottom:16px}.markdown-body hr{height:.25em;padding:0;margin:24px 0;background-color:#e1e4e8;border:0}.markdown-body blockquote{padding:0 1em;color:#6a737d;border-left:.25em solid #dfe2e5}.markdown-body blockquote&gt;:first-child{margin-top:0}.markdown-body blockquote&gt;:last-child{margin-bottom:0}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin-top:24px;margin-bottom:16px;font-weight:600;line-height:1.25}.markdown-body h1{font-size:2em}.markdown-body h1,.markdown-body h2{padding-bottom:.3em;border-bottom:1px solid #eaecef}.markdown-body h2{font-size:1.5em}.markdown-body h3{font-size:1.25em}.markdown-body h4{font-size:1em}.markdown-body h5{font-size:.875em}.markdown-body h6{font-size:.85em;color:#6a737d}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:0;margin-bottom:0}.markdown-body li{word-wrap:break-all}.markdown-body li&gt;p{margin-top:16px}.markdown-body li+li{margin-top:.25em}.markdown-body dl{padding:0}.markdown-body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:600}.markdown-body dl dd{padding:0 16px;margin-bottom:16px}.markdown-body table{display:block;width:100%;overflow:auto}.markdown-body table th{font-weight:600}.markdown-body table td,.markdown-body table th{padding:6px 13px;border:1px solid #dfe2e5}.markdown-body table tr{background-color:#fff;border-top:1px solid #c6cbd1}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}.markdown-body img{max-width:100%;box-sizing:initial;background-color:#fff}.markdown-body img[align=right]{padding-left:20px}.markdown-body img[align=left]{padding-right:20px}.markdown-body code{padding:.2em .4em;margin:0;font-size:85%;background-color:rgba(27,31,35,.05);border-radius:3px}.markdown-body pre{word-wrap:normal}.markdown-body pre&gt;code{padding:0;margin:0;font-size:100%;word-break:normal;white-space:pre;background:transparent;border:0}.markdown-body .highlight{margin-bottom:16px}.markdown-body .highlight pre{margin-bottom:0;word-break:normal}.markdown-body .highlight pre,.markdown-body pre{padding:16px;overflow:auto;font-size:85%;line-height:1.45;background-color:#f6f8fa;border-radius:3px}.markdown-body pre code{display:inline;max-width:auto;padding:0;margin:0;overflow:visible;line-height:inherit;word-wrap:normal;background-color:initial;border:0}.markdown-body .commit-tease-sha{display:inline-block;font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:90%;color:#444d56}.markdown-body .full-commit .btn-outline:not(:disabled):hover{color:#005cc5;border-color:#005cc5}.markdown-body .blob-wrapper{overflow-x:auto;overflow-y:hidden}.markdown-body .blob-wrapper-embedded{max-height:240px;overflow-y:auto}.markdown-body .blob-num{width:1%;min-width:50px;padding-right:10px;padding-left:10px;font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:12px;line-height:20px;color:rgba(27,31,35,.3);text-align:right;white-space:nowrap;vertical-align:top;cursor:pointer;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.markdown-body .blob-num:hover{color:rgba(27,31,35,.6)}.markdown-body .blob-num:before{content:attr(data-line-number)}.markdown-body .blob-code{position:relative;padding-right:10px;padding-left:10px;line-height:20px;vertical-align:top}.markdown-body .blob-code-inner{overflow:visible;font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:12px;color:#24292e;word-wrap:normal;white-space:pre}.markdown-body .pl-token.active,.markdown-body .pl-token:hover{cursor:pointer;background:#ffea7f}.markdown-body .tab-size[data-tab-size="1"]{-moz-tab-size:1;tab-size:1}.markdown-body .tab-size[data-tab-size="2"]{-moz-tab-size:2;tab-size:2}.markdown-body .tab-size[data-tab-size="3"]{-moz-tab-size:3;tab-size:3}.markdown-body .tab-size[data-tab-size="4"]{-moz-tab-size:4;tab-size:4}.markdown-body .tab-size[data-tab-size="5"]{-moz-tab-size:5;tab-size:5}.markdown-body .tab-size[data-tab-size="6"]{-moz-tab-size:6;tab-size:6}.markdown-body .tab-size[data-tab-size="7"]{-moz-tab-size:7;tab-size:7}.markdown-body .tab-size[data-tab-size="8"]{-moz-tab-size:8;tab-size:8}.markdown-body .tab-size[data-tab-size="9"]{-moz-tab-size:9;tab-size:9}.markdown-body .tab-size[data-tab-size="10"]{-moz-tab-size:10;tab-size:10}.markdown-body .tab-size[data-tab-size="11"]{-moz-tab-size:11;tab-size:11}.markdown-body .tab-size[data-tab-size="12"]{-moz-tab-size:12;tab-size:12}.markdown-body .task-list-item{list-style-type:none}.markdown-body .task-list-item+.task-list-item{margin-top:3px}.markdown-body .task-list-item input{margin:0 .2em .25em -1.6em;vertical-align:middle}</style><style data-highlight="" data-highlight-key="github">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">目录</h2>
<ol>
<li><a href="#1-storekit-2-%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5%E4%B8%8E%E4%BC%98%E5%8A%BF" title="#1-storekit-2-%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5%E4%B8%8E%E4%BC%98%E5%8A%BF">StoreKit 2 核心概念与优势</a></li>
<li><a href="#2-%E5%9F%BA%E7%A1%80%E5%87%86%E5%A4%87%E4%BA%A7%E5%93%81%E7%B1%BB%E5%9E%8B%E4%B8%8E%E9%85%8D%E7%BD%AE" title="#2-%E5%9F%BA%E7%A1%80%E5%87%86%E5%A4%87%E4%BA%A7%E5%93%81%E7%B1%BB%E5%9E%8B%E4%B8%8E%E9%85%8D%E7%BD%AE">基础准备：产品类型与配置</a></li>
<li><a href="#3-%E6%A0%B8%E5%BF%83%E5%AE%9E%E6%88%98-i%E8%8E%B7%E5%8F%96%E5%95%86%E5%93%81%E4%B8%8E%E8%B4%AD%E4%B9%B0" title="#3-%E6%A0%B8%E5%BF%83%E5%AE%9E%E6%88%98-i%E8%8E%B7%E5%8F%96%E5%95%86%E5%93%81%E4%B8%8E%E8%B4%AD%E4%B9%B0">核心实战 I：获取商品与购买</a></li>
<li><a href="#4-%E6%A0%B8%E5%BF%83%E5%AE%9E%E6%88%98-ii%E4%BA%A4%E6%98%93%E9%AA%8C%E8%AF%81%E4%B8%8E%E7%9B%91%E5%90%AC" title="#4-%E6%A0%B8%E5%BF%83%E5%AE%9E%E6%88%98-ii%E4%BA%A4%E6%98%93%E9%AA%8C%E8%AF%81%E4%B8%8E%E7%9B%91%E5%90%AC">核心实战 II：交易验证与监听</a></li>
<li><a href="#5-%E8%AE%A2%E9%98%85%E7%AE%A1%E7%90%86%E7%8A%B6%E6%80%81%E7%BB%AD%E6%9C%9F%E4%B8%8E%E9%80%80%E6%AC%BE" title="#5-%E8%AE%A2%E9%98%85%E7%AE%A1%E7%90%86%E7%8A%B6%E6%80%81%E7%BB%AD%E6%9C%9F%E4%B8%8E%E9%80%80%E6%AC%BE">订阅管理：状态、续期与退款</a></li>
<li><a href="#6-%E6%B7%B1%E5%BA%A6%E8%AE%B2%E8%A7%A3%E6%81%A2%E5%A4%8D%E8%B4%AD%E4%B9%B0-restore-purchases" title="#6-%E6%B7%B1%E5%BA%A6%E8%AE%B2%E8%A7%A3%E6%81%A2%E5%A4%8D%E8%B4%AD%E4%B9%B0-restore-purchases">深度讲解：恢复购买 (Restore Purchases)</a></li>
<li><a href="#7-%E8%90%A5%E9%94%80%E5%8A%9F%E8%83%BD%E6%8A%98%E6%89%A3%E4%B8%8E%E4%BC%98%E6%83%A0-offers" title="#7-%E8%90%A5%E9%94%80%E5%8A%9F%E8%83%BD%E6%8A%98%E6%89%A3%E4%B8%8E%E4%BC%98%E6%83%A0-offers">营销功能：折扣与优惠 (Offers)</a></li>
<li><a href="#8-%E6%B5%8B%E8%AF%95%E6%8C%87%E5%8D%97%E6%B2%99%E7%9B%92-sandbox-%E4%B8%8E-testflight" title="#8-%E6%B5%8B%E8%AF%95%E6%8C%87%E5%8D%97%E6%B2%99%E7%9B%92-sandbox-%E4%B8%8E-testflight">测试指南：沙盒 (Sandbox) 与 TestFlight</a></li>
<li><a href="#9-%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%E4%B8%8E%E5%B8%B8%E8%A7%81%E5%9D%91%E7%82%B9" title="#9-%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%E4%B8%8E%E5%B8%B8%E8%A7%81%E5%9D%91%E7%82%B9">最佳实践与常见坑点</a></li>
</ol>
<hr/>
<h2 data-id="heading-1">1. StoreKit 2 核心概念与优势</h2>
<p>在 StoreKit 2 之前，我们进行内购开发充满了痛苦：复杂的收据验证、晦涩的 API、漏单等...
StoreKit 2 利用 Swift 的现代特性（Concurrency）重构了整个框架。</p>
<h3 data-id="heading-2">核心优势</h3>
<p>StoreKit 2 是 Apple 在 <code>iOS 15+ / macOS 12.0+</code> 引入的全新内购框架，相比于旧版 StoreKit 具有以下优势：</p>
<ul>
<li><strong>基于 Swift 并发</strong>：使用 <code>async/await</code> 替代回调地狱。</li>
<li><strong>自动交易验证</strong>：无需手动解析复杂的 Receipt 文件，系统自动处理 JWS（JSON Web Signature）验证。</li>
<li><strong>交易历史管理</strong>：直接通过 API 获取完整的用户购买历史，无需维护复杂的本地数据库。</li>
<li><strong>状态同步</strong>：跨设备同步更加顺滑，用户换个手机登录，权益自动同步。</li>
</ul>
<h3 data-id="heading-3">核心概念</h3>





























<table><thead><tr><th>概念</th><th>说明</th></tr></thead><tbody><tr><td>Product</td><td>商品对象，包含价格、名称、描述等信息</td></tr><tr><td>Transaction</td><td>交易记录，每次购买产生一个 Transaction</td></tr><tr><td>PurchaseResult</td><td>购买结果，包含成功、待处理、用户取消等状态</td></tr><tr><td>VerificationResult</td><td>验证结果，确保交易来自 Apple 服务器</td></tr><tr><td>Product.SubscriptionInfo</td><td>订阅信息，包含订阅组、续期信息等</td></tr></tbody></table>
<h3 data-id="heading-4">流程图解</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart LR
    A["App 启动"] --&gt; B["监听交易更新&lt;br/&gt;Transaction Updates"]
    C["用户点击购买"] --&gt; D["获取商品&lt;br/&gt;Products"]
    D --&gt; E["发起购买&lt;br/&gt;Purchase"]
    E --&gt; F{支付结果}
    F -- 成功 --&gt; G["验证交易&lt;br/&gt;Verify"]
    G -- 通过 --&gt; H["发放权益&lt;br/&gt;Unlock Content"]
    H --&gt; I["结束交易&lt;br/&gt;Finish Transaction"]
    F -- 失败/取消 --&gt; J["处理错误 UI"]

    %% 样式定义
    classDef start fill:#E3F2FD,stroke:#2196F3,stroke-width:2px,color:#0D47A1;
    classDef action fill:#FFFFFF,stroke:#90A4AE,stroke-width:2px,color:#37474F;
    classDef decision fill:#FFF8E1,stroke:#FFC107,stroke-width:2px,color:#FF6F00;
    classDef endState fill:#E8F5E9,stroke:#4CAF50,stroke-width:2px,color:#1B5E20;
    classDef error fill:#FFEBEE,stroke:#F44336,stroke-width:2px,color:#B71C1C;

    %% 样式应用
    class A start;
    class B,C,D,E,H action;
    class F decision;
    class I endState;
    class J error;
</code></pre>
<hr/>
<h2 data-id="heading-5">2. 基础准备：产品类型与配置</h2>
<p>在编写代码前，我们首先需要了解 Apple 定义的四种商品类型：</p>



































<table><thead><tr><th align="left">类型</th><th align="left">英文名</th><th align="left">特点</th><th align="left">典型场景</th></tr></thead><tbody><tr><td align="left"><strong>消耗型</strong></td><td align="left">Consumable</td><td align="left">可重复购买，购买后即消耗</td><td align="left">游戏金币、道具</td></tr><tr><td align="left"><strong>非消耗型</strong></td><td align="left">Non-Consumable</td><td align="left">一次购买，永久拥有，支持恢复购买</td><td align="left">解锁完整版、移除广告、终身会员</td></tr><tr><td align="left"><strong>自动续期订阅</strong></td><td align="left">Auto-Renewing Subscription</td><td align="left">按周期扣费，自动续订</td><td align="left">视频会员、SaaS 服务</td></tr><tr><td align="left"><strong>非续期订阅</strong></td><td align="left">Non-Renewing Subscription</td><td align="left">有效期固定，不自动续费</td><td align="left">赛季通行证</td></tr></tbody></table>
<h3 data-id="heading-6">环境配置</h3>
<p>你可能以为必须先去 <a href="https://link.juejin.cn?target=https%3A%2F%2Fappstoreconnect.apple.com%2F" target="_blank" title="https://appstoreconnect.apple.com/" ref="nofollow noopener noreferrer">App Store Connect</a> 创建商品才能写代码，其实无需这么麻烦，Xcode 提供了一个<strong>本地配置文件 (.storekit)</strong>，让你在没有开发者账号、没联网的情况下也能开发。
操作步骤：</p>
<ol>
<li>Xcode -&gt; File -&gt; New -&gt; File from Template... -&gt; 搜索 <strong>StoreKit Configuration File</strong> （或者用快捷键 <code>Command + N</code>）.</li>
<li>不要勾选 "Sync this file with an app in App Store Connect" (除非你已经在 App Store Connect 配置好了商品信息)。</li>
<li>建好后，在 Xcode 底部点 <code>+</code> 按钮，配置你的商品信息。</li>
<li>关键一步：点击 Xcode 顶部菜单 <code>Product -&gt; Scheme -&gt; Edit Scheme -&gt; Run -&gt; Options -&gt; StoreKit Configuration</code>，选择你刚才创建的文件。</li>
</ol>
<blockquote>
<p>💡 老鸟经验：建议使用这个本地配置！它不仅能模拟购买成功，还能模拟扣费失败、退款、订阅过期等真实环境很难复现的场景。</p>
</blockquote>
<hr/>
<h2 data-id="heading-7">3. 核心实战 I：获取商品与购买</h2>
<p>我们将创建一个 <code>StoreKitManager</code> 类来管理所有逻辑。</p>
<h3 data-id="heading-8">3.1 获取商品信息</h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">import</span> StoreKit

<span class="hljs-comment">// 定义你的商品 ID 列表</span>
<span class="hljs-keyword">enum</span> <span class="hljs-title class_">ProductID</span>: <span class="hljs-title class_">String</span>, <span class="hljs-title class_">CaseIterable</span> {
    <span class="hljs-keyword">case</span> proMonthly <span class="hljs-operator">=</span> <span class="hljs-string">"com.myapp.pro.monthly"</span> <span class="hljs-comment">// 订阅</span>
    <span class="hljs-keyword">case</span> removeAds <span class="hljs-operator">=</span> <span class="hljs-string">"com.myapp.remove.ads"</span>   <span class="hljs-comment">// 非消耗型</span>
    <span class="hljs-keyword">case</span> coins100 <span class="hljs-operator">=</span> <span class="hljs-string">"com.myapp.coins.100"</span>     <span class="hljs-comment">// 消耗型</span>
}

<span class="hljs-meta">@MainActor</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">StoreKitManager</span>: <span class="hljs-title class_">ObservableObject</span> {
    <span class="hljs-meta">@Published</span> <span class="hljs-keyword">var</span> products: [<span class="hljs-type">Product</span>] <span class="hljs-operator">=</span> []

    <span class="hljs-comment">// 获取商品列表</span>
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">fetchProducts</span>() <span class="hljs-keyword">async</span> {
        <span class="hljs-keyword">do</span> {
            <span class="hljs-comment">// 将 String 转换为 Set&lt;String&gt;</span>
            <span class="hljs-keyword">let</span> productIds <span class="hljs-operator">=</span> <span class="hljs-type">Set</span>(<span class="hljs-type">ProductID</span>.allCases.map { <span class="hljs-variable">$0</span>.rawValue })
            <span class="hljs-comment">// 异步请求商品详情</span>
            <span class="hljs-keyword">let</span> fetchedProducts <span class="hljs-operator">=</span> <span class="hljs-keyword">try</span> <span class="hljs-keyword">await</span> <span class="hljs-type">Product</span>.products(for: productIds)
            <span class="hljs-comment">// 按价格排序（可选）</span>
            <span class="hljs-keyword">self</span>.products <span class="hljs-operator">=</span> fetchedProducts.sorted(by: { <span class="hljs-variable">$0</span>.price <span class="hljs-operator">&lt;</span> <span class="hljs-variable">$1</span>.price })
        } <span class="hljs-keyword">catch</span> {
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"Failed to fetch products: <span class="hljs-subst">\(error)</span>"</span>)
        }
    }
}
</code></pre>
<h3 data-id="heading-9">3.2 发起购买流程</h3>
<p>StoreKit 2 的购买结果是一个枚举：<code>success</code>, <code>userCancelled</code>, <code>pending</code>。</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">extension</span> <span class="hljs-title class_">StoreKitManager</span> {
    <span class="hljs-comment">// 购买方法</span>
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">purchase</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">product</span>: <span class="hljs-type">Product</span>) <span class="hljs-keyword">async</span> <span class="hljs-keyword">throws</span> {
        <span class="hljs-comment">// 1. 发起购买</span>
        <span class="hljs-keyword">let</span> result <span class="hljs-operator">=</span> <span class="hljs-keyword">try</span> <span class="hljs-keyword">await</span> product.purchase()

        <span class="hljs-comment">// 2. 处理结果</span>
        <span class="hljs-keyword">switch</span> result {
        <span class="hljs-keyword">case</span> .success(<span class="hljs-keyword">let</span> verification):
            <span class="hljs-comment">// 购买成功，需要验证签名</span>
            <span class="hljs-keyword">try</span> <span class="hljs-keyword">await</span> handlePurchaseVerification(verification)

        <span class="hljs-keyword">case</span> .userCancelled:
            <span class="hljs-comment">// 用户点击了取消</span>
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"User cancelled the purchase"</span>)

        <span class="hljs-keyword">case</span> .pending:
            <span class="hljs-comment">// 交易挂起（例如家长控制需要审批）</span>
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"Transaction pending"</span>)

        <span class="hljs-keyword">@unknown</span> <span class="hljs-keyword">default</span>:
            <span class="hljs-keyword">break</span>
        }
    }

    <span class="hljs-comment">// 验证与权益发放</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">handlePurchaseVerification</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">verification</span>: <span class="hljs-type">VerificationResult</span>&lt;<span class="hljs-type">Transaction</span>&gt;) <span class="hljs-keyword">async</span> <span class="hljs-keyword">throws</span> {
        <span class="hljs-keyword">switch</span> verification {
        <span class="hljs-keyword">case</span> .unverified(<span class="hljs-keyword">let</span> transaction, <span class="hljs-keyword">let</span> error):
            <span class="hljs-comment">// 签名验证失败，不要发放权益</span>
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"Verification failed: <span class="hljs-subst">\(error)</span>"</span>)
            <span class="hljs-comment">// 建议：结束交易，但不发货</span>
            <span class="hljs-comment">// 如果不 finish，这笔脏数据会每次启动 App 都发过来，卡在队列里</span>
            <span class="hljs-keyword">await</span> transaction.finish()

        <span class="hljs-keyword">case</span> .verified(<span class="hljs-keyword">let</span> transaction):
            <span class="hljs-comment">// 验证通过</span>
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"Purchase verified: <span class="hljs-subst">\(transaction.productID)</span>"</span>)

            <span class="hljs-comment">// 3. 发放权益（更新本地状态）</span>
            <span class="hljs-keyword">await</span> updateUserEntitlements(transaction)

            <span class="hljs-comment">// 4. 重要：通知 App Store 交易已完成</span>
            <span class="hljs-keyword">await</span> transaction.finish()
        }
    }
}
</code></pre>
<hr/>
<h2 data-id="heading-10">4. 核心实战 II：交易验证与监听</h2>
<p>StoreKit 2 有两个关键的数据源：</p>
<ol>
<li><strong>Transaction.updates</strong>：监听实时的交易流（购买发生时、续订成功时、退款时）。</li>
<li><strong>Transaction.currentEntitlements</strong>：查询用户当前拥有的权益（用于恢复购买）。</li>
</ol>
<h3 data-id="heading-11">4.1 监听交易更新 (Transaction Updates)</h3>
<p><strong>最佳实践</strong>：必须在 App 启动时立即开始监听，以处理应用在后台或未运行时发生的交易（如订阅自动续期）。</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">extension</span> <span class="hljs-title class_">StoreKitManager</span> {
    <span class="hljs-comment">// 启动监听任务</span>
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">listenForTransactions</span>() -&gt; <span class="hljs-type">Task</span>&lt;<span class="hljs-type">Void</span>, <span class="hljs-type">Error</span>&gt; {
        <span class="hljs-keyword">return</span> <span class="hljs-type">Task</span>.detached {
            <span class="hljs-comment">// 遍历异步序列</span>
            <span class="hljs-keyword">for</span> <span class="hljs-keyword">await</span> result <span class="hljs-keyword">in</span> <span class="hljs-type">Transaction</span>.updates {
                <span class="hljs-keyword">do</span> {
                    <span class="hljs-comment">// 收到新交易（续费、购买、恢复）</span>
                    <span class="hljs-comment">// 这里复用之前的验证逻辑</span>
                    <span class="hljs-keyword">try</span> <span class="hljs-keyword">await</span> <span class="hljs-keyword">self</span>.handlePurchaseVerification(result)
                } <span class="hljs-keyword">catch</span> {
                    <span class="hljs-built_in">print</span>(<span class="hljs-string">"Transaction update handling failed"</span>)
                }
            }
        }
    }
}
</code></pre>
<p>确保它随 App 启动而运行：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 在 App 入口处调用</span>
<span class="hljs-keyword">@main</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">MyApp</span>: <span class="hljs-title class_">App</span> {
    <span class="hljs-keyword">let</span> storeKitManager <span class="hljs-operator">=</span> <span class="hljs-type">StoreKitManager</span>()

    <span class="hljs-keyword">var</span> body: <span class="hljs-keyword">some</span> <span class="hljs-type">Scene</span> {
        <span class="hljs-type">WindowGroup</span> {
            <span class="hljs-type">ContentView</span>()
                .task {
                    <span class="hljs-comment">// 开启监听</span>
                    <span class="hljs-keyword">await</span> storeKitManager.listenForTransactions()
                }
        }
    }
}
</code></pre>
<h3 data-id="heading-12">4.2 检查当前权益 (Entitlements)</h3>
<p>如何判断用户是不是会员呢？
StoreKit 2，你不需要自己存本地数据库，直接调用 <code>Transaction.currentEntitlements</code> 来查询，它只返回当前有效的权益（过期的、退款的会自动过滤掉）。</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">extension</span> <span class="hljs-title class_">StoreKitManager</span> {
    <span class="hljs-comment">// 更新用户权益状态</span>
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">updateCustomerProductStatus</span>() <span class="hljs-keyword">async</span> {
        <span class="hljs-keyword">var</span> purchasedIds: [<span class="hljs-type">String</span>] <span class="hljs-operator">=</span> []

        <span class="hljs-comment">// 遍历当前有效的权益（已自动过滤掉过期订阅、被撤销的交易）</span>
        <span class="hljs-keyword">for</span> <span class="hljs-keyword">await</span> result <span class="hljs-keyword">in</span> <span class="hljs-type">Transaction</span>.currentEntitlements {
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">case</span> .verified(<span class="hljs-keyword">let</span> transaction) <span class="hljs-operator">=</span> result {
                <span class="hljs-comment">// 检查是否被撤销（退款）</span>
                <span class="hljs-keyword">if</span> transaction.revocationDate <span class="hljs-operator">==</span> <span class="hljs-literal">nil</span> {
                    purchasedIds.append(transaction.productID)
                }
            }
        }

        <span class="hljs-comment">// 更新 UI 状态</span>
        <span class="hljs-comment">// self.isPro = purchasedIds.contains(ProductID.proMonthly.rawValue)</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"User has active entitlements: <span class="hljs-subst">\(purchasedIds)</span>"</span>)
    }
}
</code></pre>
<hr/>
<h2 data-id="heading-13">5. 订阅管理：状态、续期与退款</h2>
<p>订阅比一次性购买复杂，因为需要处理过期、宽限期等状态。</p>
<h3 data-id="heading-14">5.1 获取订阅详细</h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">extension</span> <span class="hljs-title class_">StoreKitManager</span> {
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">checkSubscriptionStatus</span>() <span class="hljs-keyword">async</span> {
        <span class="hljs-comment">// 假设我们只关心 proMonthly 这个组的订阅状态</span>
        <span class="hljs-keyword">guard</span> <span class="hljs-keyword">let</span> product <span class="hljs-operator">=</span> products.first(where: { <span class="hljs-variable">$0</span>.id <span class="hljs-operator">==</span> <span class="hljs-type">ProductID</span>.proMonthly.rawValue }) <span class="hljs-keyword">else</span> { <span class="hljs-keyword">return</span> }

        <span class="hljs-keyword">guard</span> <span class="hljs-keyword">let</span> subscriptionInfo <span class="hljs-operator">=</span> product.subscription <span class="hljs-keyword">else</span> { <span class="hljs-keyword">return</span> }

        <span class="hljs-keyword">do</span> {
            <span class="hljs-comment">// 获取该订阅组的状态</span>
            <span class="hljs-keyword">let</span> statuses <span class="hljs-operator">=</span> <span class="hljs-keyword">try</span> <span class="hljs-keyword">await</span> subscriptionInfo.status

            <span class="hljs-keyword">for</span> status <span class="hljs-keyword">in</span> statuses {
                <span class="hljs-keyword">switch</span> status.state {
                <span class="hljs-keyword">case</span> .subscribed:
                    <span class="hljs-built_in">print</span>(<span class="hljs-string">"用户处于订阅期"</span>)
                <span class="hljs-keyword">case</span> .expired:
                    <span class="hljs-built_in">print</span>(<span class="hljs-string">"订阅已过期"</span>)
                <span class="hljs-keyword">case</span> .inGracePeriod:
                    <span class="hljs-built_in">print</span>(<span class="hljs-string">"处于宽限期（扣费失败但Apple暂未关停），应视为已订阅"</span>)
                <span class="hljs-keyword">case</span> .revoked:
                    <span class="hljs-built_in">print</span>(<span class="hljs-string">"订阅被撤销（退款）"</span>)
                <span class="hljs-keyword">case</span> .inBillingRetryPeriod:
                    <span class="hljs-built_in">print</span>(<span class="hljs-string">"扣费重试中，通常应暂停服务"</span>)
                <span class="hljs-keyword">default</span>:
                    <span class="hljs-keyword">break</span>
                }

                <span class="hljs-comment">// 获取续订信息</span>
                <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> renewalInfo <span class="hljs-operator">=</span> <span class="hljs-keyword">try?</span> verify(status.renewalInfo) {
                    <span class="hljs-built_in">print</span>(<span class="hljs-string">"有自动续订: <span class="hljs-subst">\(renewalInfo.willAutoRenew)</span>"</span>)
                }
            }
        } <span class="hljs-keyword">catch</span> {
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"Error checking subscription status: <span class="hljs-subst">\(error)</span>"</span>)
        }
    }

    <span class="hljs-comment">// 辅助泛型方法：解包 VerificationResult</span>
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">verify</span>&lt;<span class="hljs-type">T</span>&gt;(<span class="hljs-keyword">_</span> <span class="hljs-params">result</span>: <span class="hljs-type">VerificationResult</span>&lt;<span class="hljs-type">T</span>&gt;) <span class="hljs-keyword">throws</span> -&gt; <span class="hljs-type">T</span> {
        <span class="hljs-keyword">switch</span> result {
        <span class="hljs-keyword">case</span> .unverified(<span class="hljs-keyword">_</span>, <span class="hljs-keyword">let</span> error):
            <span class="hljs-keyword">throw</span> error
        <span class="hljs-keyword">case</span> .verified(<span class="hljs-keyword">let</span> safe):
            <span class="hljs-comment">// ✅ 验证通过，返回解包后的数据</span>
            <span class="hljs-keyword">return</span> safe
        }
    }
}
</code></pre>
<h3 data-id="heading-15">5.2 识别退款 (Refunds)</h3>
<p>当 <code>Transaction.updates</code> 收到更新，或遍历 <code>currentEntitlements</code> 时：</p>
<ol>
<li>检查 <code>transaction.revocationDate</code> 是否不为 nil。</li>
<li>检查 <code>transaction.revocationReason</code>。</li>
</ol>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> date <span class="hljs-operator">=</span> transaction.revocationDate {
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"该交易已于 <span class="hljs-subst">\(date)</span> 被撤销/退款"</span>)
    <span class="hljs-comment">// 移除对应的权益</span>
    removeEntitlement(for: transaction.productID)
}
</code></pre>
<hr/>
<h2 data-id="heading-16">6. 深度讲解：恢复购买 (Restore Purchases)</h2>
<p>苹果审核要求必须有“恢复购买”按钮。</p>
<h3 data-id="heading-17">概念与误区</h3>
<ul>
<li><strong>SK1 vs SK2</strong>: 在旧版 SK1 中，必须调用 <code>restoreCompletedTransactions</code> 触发系统弹窗输入密码。</li>
<li><strong>SK2 的机制</strong>: <code>Transaction.currentEntitlements</code> <strong>已经</strong>包含了用户所有的有效权益。通常情况下，应用启动时刷新这个属性，就等同于“静默恢复”。</li>
<li><strong>AppStore.sync()</strong>: 这是 StoreKit 2 的“显式恢复”接口。只有当用户在 UI 上点击“恢复购买”按钮时，或者你确信数据未同步时，才调用它。它可能会强制弹出 Apple ID 登录框。</li>
</ul>
<h3 data-id="heading-18">示例代码</h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">extension</span> <span class="hljs-title class_">StoreKitManager</span> {
    <span class="hljs-comment">// UI 绑定的“恢复购买”按钮动作</span>
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">restorePurchases</span>() <span class="hljs-keyword">async</span> {
        <span class="hljs-keyword">do</span> {
            <span class="hljs-comment">// 1. 强制同步 App Store 交易记录</span>
            <span class="hljs-comment">// 这可能会提示用户输入 Apple ID 密码</span>
            <span class="hljs-keyword">try</span> <span class="hljs-keyword">await</span> <span class="hljs-type">AppStore</span>.sync()

            <span class="hljs-comment">// 2. 同步完成后，重新检查权益</span>
            <span class="hljs-keyword">await</span> updateCustomerProductStatus()

            <span class="hljs-comment">// 3. UI 提示</span>
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"Restore completed successfully"</span>)
        } <span class="hljs-keyword">catch</span> {
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"Restore failed: <span class="hljs-subst">\(error)</span>"</span>)
        }
    }
}
</code></pre>
<h3 data-id="heading-19">最佳实践</h3>
<ol>
<li><strong>自动恢复</strong>: App 启动时调用 <code>updateCustomerProductStatus()</code>（遍历 <code>currentEntitlements</code>），不要弹窗，静默让老用户获取权益。</li>
<li><strong>手动恢复</strong>: 在设置页提供 "Restore Purchases" 按钮，点击后调用 <code>restorePurchases()</code>。</li>
<li><strong>多设备同步</strong>: StoreKit 2 自动处理。只要登录同一个 Apple ID，<code>currentEntitlements</code> 会包含所有设备上的购买。</li>
</ol>
<hr/>
<h2 data-id="heading-20">7. 营销功能：折扣与优惠 (Offers)</h2>
<p>想给新用户“首月免费”？或者给老用户“回归半价”？
StoreKit 2 支持显示推介促销（Introductory Offers）和促销代码（Offer Codes）。</p>
<h3 data-id="heading-21">7.1 判断是否展示首购优惠</h3>
<p>SK2 会自动判断用户是否有资格享受优惠。你不需要手写复杂的逻辑。</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">func</span> <span class="hljs-title function_">checkIntroOffer</span>(<span class="hljs-params">for</span> <span class="hljs-params">product</span>: <span class="hljs-type">Product</span>) <span class="hljs-keyword">async</span> {
    <span class="hljs-comment">// 检查是否有优惠</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> subscription <span class="hljs-operator">=</span> product.subscription,
       <span class="hljs-keyword">let</span> introOffer <span class="hljs-operator">=</span> subscription.introductoryOffer {

        <span class="hljs-comment">// 检查用户是否有资格享受这个优惠</span>
        <span class="hljs-comment">// StoreKit 2 会自动根据用户历史判断 isEligible</span>
        <span class="hljs-keyword">let</span> isEligible <span class="hljs-operator">=</span> <span class="hljs-keyword">await</span> subscription.isEligibleForIntroOffer

        <span class="hljs-keyword">if</span> isEligible {
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"原价: <span class="hljs-subst">\(product.price)</span>，优惠价: <span class="hljs-subst">\(introOffer.price)</span>"</span>)
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"原价: <span class="hljs-subst">\(product.price)</span>"</span>)
        }
    }
}
</code></pre>
<h3 data-id="heading-22">7.2 在购买时应用优惠</h3>
<p>通常不需要额外代码，<code>product.purchase()</code> 会自动应用用户符合条件的最佳优惠。如果是 <strong>Offer Codes</strong>（兑换码），用户通常在 App Store 系统级界面输入，或者你可以提供 UI：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 弹出系统兑换码输入框</span>
<span class="hljs-keyword">func</span> <span class="hljs-title function_">presentCodeRedemptionSheet</span>() {
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> windowScene <span class="hljs-operator">=</span> <span class="hljs-type">UIApplication</span>.shared.connectedScenes.first <span class="hljs-keyword">as?</span> <span class="hljs-type">UIWindowScene</span> {
        <span class="hljs-type">Task</span> {
            <span class="hljs-keyword">try?</span> <span class="hljs-keyword">await</span> <span class="hljs-type">AppStore</span>.presentOfferCodeRedeemSheet(in: windowScene)
        }
    }
}
</code></pre>
<hr/>
<h2 data-id="heading-23">8. 测试指南：沙盒 (Sandbox) 与 TestFlight</h2>
<h3 data-id="heading-24">8.1 沙盒测试流程</h3>
<ol>
<li><strong>创建账号</strong>: 登录 App Store Connect -&gt; 用户和访问 -&gt; 沙盒 -&gt; 新增测试员。
<ul>
<li><em>注意</em>：不要在 iOS 设置中登录此账号！</li>
</ul>
</li>
<li><strong>登录</strong>: 在 App 内点击购买时，系统弹窗要求登录，此时输入沙盒账号。</li>
<li><strong>管理订阅</strong>: iOS 设置 -&gt; App Store -&gt; 沙盒账户 -&gt; 管理。
<ul>
<li>可以在这里修改续订速率（例如 1 个月的订阅在沙盒中每 5 分钟续订一次，重复 6 次后自动过期）。</li>
</ul>
</li>
</ol>
<h3 data-id="heading-25">8.2 测试场景 Checklist</h3>
<ul class="contains-task-list">
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> <strong>新购</strong>: 首次购买流程是否顺畅。</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> <strong>续期</strong>: 保持 App 打开，观察 <code>Transaction.updates</code> 是否收到续订通知。</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> <strong>过期</strong>: 等待沙盒订阅自动过期，检查 App 权益是否收回。</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> <strong>中断购买</strong>: 点击购买后，在支付界面取消，App 是否处理了 <code>.userCancelled</code>。</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> <strong>退款</strong>: 在沙盒设置中找不到退款？需要去 Xcode -&gt; Debug -&gt; StoreKit -&gt; Manage Transactions (如果是本地配置) 或通过 App Store Connect 模拟。</li>
</ul>
<h3 data-id="heading-26">8.3 调试技巧</h3>
<p>在 Xcode 中使用 <code>.storekit</code> 配置文件时：</p>
<ul>
<li><strong>Debug -&gt; StoreKit -&gt; Manage Transactions</strong>: 可以看到所有本地交易。</li>
<li><strong>模拟退款</strong>: 选中交易，右键点击 "Refund Transaction"。</li>
<li><strong>模拟 Ask to Buy</strong>: 开启 "Enable Ask to Buy" 模拟家长审批流程。</li>
</ul>
<hr/>
<h2 data-id="heading-27">9. 最佳实践与常见坑点</h2>
<h3 data-id="heading-28">常见坑 (Pitfalls)</h3>
<ol>
<li><strong>验证失败</strong>: 遇到 <code>VerificationResult.unverified</code> 怎么办？
<ul>
<li><em>原因</em>: 可能是越狱设备、中间人攻击或者 Xcode 本地配置证书不匹配。</li>
<li><em>处理</em>: <strong>绝对不要</strong>解锁权益。提示用户“验证失败，请重试”。</li>
</ul>
</li>
<li><strong>App Store Server Notifications</strong>:
<ul>
<li>虽然 StoreKit 2 客户端很强，但为了数据准确性（特别是退款、续费失败），建议后端对接 Server Notifications V2。</li>
</ul>
</li>
<li><strong>漏单</strong>:
<ul>
<li>如果 App 闪退，<code>transaction.finish()</code> 未调用，下次启动监听 <code>updates</code> 时会再次收到该交易，确保逻辑幂等（重复处理同一笔交易不会出错）。</li>
</ul>
</li>
</ol>
<h3 data-id="heading-29">错误处理最佳实践</h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">enum</span> <span class="hljs-title class_">StoreError</span>: <span class="hljs-title class_">Error</span> {
    <span class="hljs-keyword">case</span> failedVerification
    <span class="hljs-keyword">case</span> userCancelled
    <span class="hljs-keyword">case</span> pending
    <span class="hljs-keyword">case</span> unknown
}

<span class="hljs-comment">// 友好的错误提示</span>
<span class="hljs-keyword">func</span> <span class="hljs-title function_">errorMessage</span>(<span class="hljs-params">for</span> <span class="hljs-params">error</span>: <span class="hljs-type">Error</span>) -&gt; <span class="hljs-type">String</span> {
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> storeError <span class="hljs-operator">=</span> error <span class="hljs-keyword">as?</span> <span class="hljs-type">StoreKitError</span> {
        <span class="hljs-keyword">switch</span> storeError {
        <span class="hljs-keyword">case</span> .userCancelled: <span class="hljs-keyword">return</span> <span class="hljs-string">"您取消了购买"</span>
        <span class="hljs-keyword">case</span> .networkError: <span class="hljs-keyword">return</span> <span class="hljs-string">"网络连接失败，请检查网络"</span>
        <span class="hljs-keyword">default</span>: <span class="hljs-keyword">return</span> <span class="hljs-string">"购买发生未知错误，请稍后重试"</span>
        }
    }
    <span class="hljs-keyword">return</span> error.localizedDescription
}
</code></pre>
<h3 data-id="heading-30">发布前 Checklist</h3>
<p>最后，发布前请对照这张清单：</p>
<ol class="contains-task-list">
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> <strong>App 启动监听了吗？</strong> 确保 <code>listenForTransactions</code> 在最早的时机运行。</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> <code>Finish 所有的交易了吗？</code> 不管成功还是失败（验证不过），都要调用 <code>.finish()</code>，否则队列会堵死。</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 是否处理了 <code>.pending</code> 状态（家长控制）？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> “恢复购买”按钮是否能正常找回权益？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 是否正确处理了订阅过期和退款？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 是否在 TestFlight 环境下验证过真实服务器的商品？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 不要自己存 Bool 值。 尽量每次启动 App 时通过 <code>Transaction.currentEntitlements</code> 动态计算用户是不是 VIP。本地存个 isPro = true 很容易因为卸载重装或跨设备导致数据不一致。</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> UI 交互。 购买过程中给个 Loading 转圈圈，不要让用户连续点击或因为网络环境以为卡住了。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[如何在手机上轻松识别多种鸟类？我们发现了更简单的秘密……]]></title>    <link>https://juejin.cn/post/7577295460248502318</link>    <guid>https://juejin.cn/post/7577295460248502318</guid>    <pubDate>2025-11-28T01:58:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577295460248502318" data-draft-id="7577218195234668590" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="如何在手机上轻松识别多种鸟类？我们发现了更简单的秘密……"/> <meta itemprop="keywords" content="算法,计算机视觉,深度学习"/> <meta itemprop="datePublished" content="2025-11-28T01:58:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="CoovallyAIHub"/> <meta itemprop="url" content="https://juejin.cn/user/2461151071843739"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            如何在手机上轻松识别多种鸟类？我们发现了更简单的秘密……
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2461151071843739/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    CoovallyAIHub
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-28T01:58:42.000Z" title="Fri Nov 28 2025 01:58:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>导读</p>
<p>基于深度学习与迁移学习技术，只需一部手机，就能让每个人轻松识别鸟类物种——本文将详细介绍如何利用MobileNetV2构建高精度鸟类识别模型，并探讨如何借助Coovally平台高效实现从开发到部署的全流程。&gt;&gt;<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzkzOTg3NTAyNA%3D%3D%26mid%3D2247488797%26idx%3D2%26sn%3D27701bde826862b6a70302fd32f752c0%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzkzOTg3NTAyNA==&amp;mid=2247488797&amp;idx=2&amp;sn=27701bde826862b6a70302fd32f752c0&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">更多资讯可加入CV技术群获取了解哦~</a></p>
<p>观鸟在能够识别你所观察的鸟类物种时会变得更加令人兴奋。但如果你对鸟类了解不多，这项任务可能会很困难。为了让每个人都能轻松完成这项任务，你可以使用一个深度学习模型，只需通过手机摄像头就能识别你正在观察的物种！</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/05c22f9f2b1a4fc8bcdc7bf1dcfb5478~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764899921&amp;x-signature=TNk2VzjHgqlimZtM%2FZFiEKr%2FL3E%3D" alt="screenshot_2025-11-26_14-17-53.png" loading="lazy"/></p>
<p>迁移学习是机器学习中使用的一种技术，即在一个任务上训练好的模型被重新用作另一个相关任务的起点。它通过将从前一个问题中获得的知识应用到新问题中来工作。这节省了时间和计算资源，因为模型不需要从头开始训练。</p>
<p>鸟类分类是一项非常适合卷积神经网络（CNN） 的任务。CNN是一种专为分析视觉数据而设计的人工神经网络，能够自动学习并从图像中提取特征。这些网络由多个协同工作的层组成，用于识别边缘、纹理和形状等模式。</p>
<p>通过迁移学习，我们不需要从头开始训练所有这些层。相反，我们可以重用预训练网络。许多预训练模型是可用的，在这个项目中，我使用 MobileNetV2 作为基础模型。</p>
<h2 data-id="heading-0"><strong>数据集</strong></h2>
<p>该数据集包含525种不同鸟类的图像，总计12,136张图片！这些图像被组织在三个文件夹中：训练集、验证集和测试集。</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/98fe5532fe6c45c597f9cbd502d5e8aa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764899921&amp;x-signature=vqmvH99tOmTwekXm4UuGHXEGSqU%3D" alt="screenshot_2025-11-26_14-20-49.png" loading="lazy"/></p>
<h2 data-id="heading-1"><strong>使用 MobileNetV2</strong></h2>
<p>如前所述，起点是MobileNetV2。MobileNetV2是一种高效、轻量级的卷积神经网络（CNN），专为计算资源有限的移动和嵌入式设备优化。它由谷歌于2018年推出。</p>
<p>为了能将我们的鸟类图像与此模型一起使用，我们只需要重新缩放我们的图像，这可以准备好模型期望的图像尺寸和像素缩放比例。这在加载数据时完成：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">train_datagenerator</span> = ImageDataGenerator(rescale=<span class="hljs-number">1</span>/<span class="hljs-number">255</span>.)
<span class="hljs-attr">val_datagenerator</span> = ImageDataGenerator(rescale=<span class="hljs-number">1</span>/<span class="hljs-number">255</span>.)
<span class="hljs-attr">test_datagenerator</span> = ImageDataGenerator(rescale=<span class="hljs-number">1</span>/<span class="hljs-number">255</span>.)
</code></pre>
<p>MobileNetV2是在ImageNet数据库中的超过100万张图像上训练的。它可以将图像分类为1000个类别，包括许多日常物品和几种动物。凭借其157层结构，它已经学习了许多视觉特征。我们只需要帮助它学习特定于鸟类物种的特征。</p>
<p>为此，我们冻结前120层，这样模型就不会忘记它已经学会的通用模式。接下来，我们解冻并重新训练后面的一些层，使它们适应我们的鸟类数据集。最后，我们添加新的自定义层进行分类：</p>
<pre><code class="hljs language-ini" lang="ini">from tensorflow.keras.applications import MobileNetV2
<span class="hljs-attr">base_model</span> = MobileNetV2(
    <span class="hljs-attr">input_shape</span>=IMG_SHAPE,
    <span class="hljs-attr">include_top</span>=<span class="hljs-literal">False</span>,
    <span class="hljs-attr">weights</span>=<span class="hljs-string">'imagenet'</span>
)
<span class="hljs-attr">base_model.trainable</span> = <span class="hljs-literal">True</span>
<span class="hljs-comment"># 仅冻结前 ~120 层</span>
for layer in base_model.layers<span class="hljs-section">[:120]</span>:
    <span class="hljs-attr">layer.trainable</span> = <span class="hljs-literal">False</span>
<span class="hljs-attr">global_average_layer</span> = tf.keras.layers.GlobalAveragePooling2D()
<span class="hljs-attr">drop_layer</span> = tf.keras.layers.Dropout(<span class="hljs-number">0.2</span>)
<span class="hljs-attr">dense_layer</span> = tf.keras.layers.Dense(len(class_names), activation=<span class="hljs-string">'softmax'</span>)
<span class="hljs-attr">model</span> = tf.keras.Sequential([
    base_model,
    global_average_layer,
    drop_layer,
    dense_layer
])
</code></pre>
<p>通过这样做，模型利用了它已有的所有知识，并将其调整以适应我们的新数据。现在我们只需要编译我们的模型并选择优化器和损失函数：</p>
<pre><code class="hljs language-ini" lang="ini">from keras import optimizers
model.compile(<span class="hljs-attr">optimizer</span>=optimizers.Adam(learning_rate=<span class="hljs-number">1</span>e-<span class="hljs-number">5</span>),
              <span class="hljs-attr">loss</span>=<span class="hljs-string">'categorical_crossentropy'</span>,
              <span class="hljs-attr">metrics</span>=[<span class="hljs-string">'accuracy'</span>])
</code></pre>
<p>我们选择一个较小的学习率来避免模型对数据过拟合。</p>
<h2 data-id="heading-2"><strong>结果</strong></h2>
<p>该模型取得了令人印象深刻的性能：</p>
<ul>
<li>训练准确率: 98%</li>
<li>验证准确率: 94%</li>
<li>测试准确率（未见过的图像）: 97%</li>
</ul>
<p>这些图表显示了仅用5个周期，准确率如何提高以及误差如何降低！</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f9d20acce1224648af2758b511a45e84~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764899921&amp;x-signature=7RPrdXY460fl63bKa4Q8qT3IGjE%3D" alt="screenshot_2025-11-26_14-21-58.png" loading="lazy"/></p>
<p>在手机摄像头上测试模型</p>
<p>为了用手机摄像头测试模型，我参考了一个教程，并对其进行了修改以适用于我们的鸟类分类器。在导入训练好的模型后，我将其连接到手机的实时摄像头馈送。</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/019261c33ec4426bbfccd5c3238926d9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764899921&amp;x-signature=MOb0qUKutz2ydCNZMYfKCVaY16M%3D" alt="screenshot_2025-11-26_14-22-41.png" loading="lazy"/></p>
<h2 data-id="heading-3"><strong>与 Coovally 平台的集成</strong></h2>
<p>看到上述描述是否还在纠结如何看到项目详细，其实在构建和部署此类AI模型时，像 Coovally 这样的平台可以极大地简化流程。Coovally 是一个端到端的AI开发平台，它提供了从数据准备、模型训练、评估到部署的一系列工具。</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d6b0fae9ab0a4fcebe650e335926d5ab~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764899921&amp;x-signature=G3RdFpla95PsfPjY06z%2FKkTFZ08%3D" alt="Coovally操作动图.gif" loading="lazy"/></p>
<p>在这个鸟类识别项目中，Coovally 可以在以下方面提供帮助：</p>
<ul>
<li><strong>数据管理：</strong> 轻松上传、版本控制和预处理包含多个物种的大型鸟类图像数据集。</li>
</ul>

<ul>
<li><strong>模型开发：</strong> Coovally 支持包括 TensorFlow 和 Keras 在内的多种框架，平台<strong>已集成****MobileNetV2</strong> <strong>等1000+模型</strong>，一键调用。</li>
<li><strong>训练与评估：</strong> 平台可以管理训练任务，并提供类似本项目中的可视化图表，跟踪准确率和损失等指标，方便比较不同实验的结果。</li>
<li><strong>模型部署：</strong> 训练好的模型可以一键部署到云端或边缘设备（如手机），类似于本项目中将模型连接到手机摄像头的步骤，但流程可能更标准化和自动化。</li>
</ul>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/54f0d2d47e2d483993b65346675a89d6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764899921&amp;x-signature=eZpt2z7SELtbfIimbcsRn9UN2xI%3D" alt="模型转换.GIF" loading="lazy"/></p>
<p>通过利用 Coovally，开发人员可以更专注于模型设计和业务逻辑，而不是底层的基础设施管理，从而加速像这个鸟类识别应用一样的AI方案的开发与落地。</p>
<h2 data-id="heading-4"><strong>结论</strong></h2>
<p>迁移学习是一个强大的工具，它使我们能够用更少的资源训练出高性能的模型。在这个项目中，使用MobileNetV2使得鸟类分类模型能够快速高效地达到出色的准确率。结合手机摄像头，这成为了一个对于任何对观鸟感兴趣的人都易于使用的工具。而像 Coovally 这样的平台，进一步降低了AI开发的门槛，为更多创新应用的实现提供了可能。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[基于MCP架构的DevUI多组件协作实践：打造智能业务分析平台]]></title>    <link>https://juejin.cn/post/7577220965437980726</link>    <guid>https://juejin.cn/post/7577220965437980726</guid>    <pubDate>2025-11-27T12:41:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577220965437980726" data-draft-id="7577284409963888703" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="基于MCP架构的DevUI多组件协作实践：打造智能业务分析平台"/> <meta itemprop="keywords" content="华为"/> <meta itemprop="datePublished" content="2025-11-27T12:41:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Nturmoils"/> <meta itemprop="url" content="https://juejin.cn/user/1722263248317024"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            基于MCP架构的DevUI多组件协作实践：打造智能业务分析平台
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1722263248317024/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Nturmoils
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T12:41:59.000Z" title="Thu Nov 27 2025 12:41:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读15分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">探索背景</h2>
<p>在企业数字化转型过程中，业务分析人员需要频繁处理数据报表、生成可视化图表、撰写分析报告。传统方式下，这些环节相互割裂：数据处理用Excel、图表制作用独立工具、AI分析需要调用API、前端展示又是另一套系统。能否将这些能力整合在一个平台上，通过自然语言交互完成全流程？</p>
<p>DevUI生态为这个问题提供了完整的解决方案。<strong>MateChat</strong>提供了类ChatGPT的对话交互能力，<strong>DevUI组件库</strong>提供了企业级UI组件，<strong>华为云AI服务</strong>提供了大模型能力。关键问题是：如何让这三者高效协作，而不是简单堆砌？</p>
<p>这个项目探索了<strong>MCP（Multi-Component Platform）多组件协作架构</strong>，将DevUI生态中的三大能力有机整合，实现了"一句话提问 → AI分析 → 自动生成图表 → 展示关键指标"的完整闭环。实测中，从输入"对比各区域销售表现"到展示完整分析结果（包含AI解读、可视化图表、数据指标）仅需2.5秒，且AI回复支持流式输出，用户体验接近真人对话。</p>
<p><strong>在线体验地址</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmcpchat.acowbo.com" target="_blank" title="https://mcpchat.acowbo.com" ref="nofollow noopener noreferrer">mcpchat.acowbo.com</a></p>
<p><strong>开源地址</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitcode.com%2FMrxiao_bo%2Fmcp-business-analyzer" target="_blank" title="https://gitcode.com/Mrxiao_bo/mcp-business-analyzer" ref="nofollow noopener noreferrer">gitcode.com/Mrxiao_bo/m…</a></p>
<p>访问系统后，首先看到的是基于MateChat组件构建的欢迎界面：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/89bac20faa8d4564b69903a3fb260324~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTnR1cm1vaWxz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764852118&amp;x-signature=%2BNBWYDf0gWWeE%2FjdjOW0lBLw4JA%3D" alt="欢迎页面" loading="lazy"/></p>
<p>界面采用了DevUI的设计语言，品牌色#5e7ce0贯穿始终，三个快捷入口按钮使用了<code>d-button</code>组件的不同变体。整个欢迎页面清晰展示了系统的三大核心能力：MateChat对话交互、DevUI数据展示、华为云AI智能分析。</p>
<h2 data-id="heading-1">MCP多组件协作技术逻辑</h2>
<h3 data-id="heading-2">为什么需要MCP架构？</h3>
<p>传统的组件集成方式是"紧耦合"的，比如在UI组件中直接调用AI API，在AI回调中直接操作图表。这种方式存在三个问题：</p>
<ol>
<li><strong>组件职责不清</strong>：UI组件既要处理界面，又要处理业务逻辑</li>
<li><strong>难以扩展</strong>：新增一个能力（如数据导出）需要修改多处代码</li>
<li><strong>无法复用</strong>：其他项目想用同样的能力，需要重新开发</li>
</ol>
<p>MCP架构的核心思想是<strong>解耦 + 编排</strong>。将系统分为三层：</p>
<p><strong>交互层（Interaction Layer）</strong>：基于华为<strong>MateChat组件</strong>实现对话界面，包括<code>McBubble</code>气泡消息、<code>McInput</code>智能输入框、<code>McMarkdownCard</code>富文本渲染。这一层只负责展示，不关心业务逻辑。</p>
<p><strong>协调层（Coordination Layer）</strong>：核心是<code>MCPEngine</code>引擎，负责三件事：</p>
<ol>
<li><strong>意图识别</strong>：分析用户问题，判断需要哪些能力（AI分析、图表生成、数据计算）</li>
<li><strong>任务编排</strong>：并行调用所需能力，提高处理效率</li>
<li><strong>结果聚合</strong>：将各能力的输出整合成统一格式，返回给交互层</li>
</ol>
<p><strong>能力层（Capability Layer）</strong>：三个独立的适配器（Adapter）：</p>
<ul>
<li><code>AIAdapter</code>：调用华为云Token Service大模型服务</li>
<li><code>ChartAdapter</code>：基于Chart.js生成可视化图表</li>
<li><code>DataAdapter</code>：进行数据统计和指标计算</li>
</ul>
<p>每个适配器实现统一的<code>MCPAdapter</code>接口，彼此独立运行，通过Engine统一调度。</p>
<h3 data-id="heading-3">MCP工作流程解析</h3>
<p>MCP 架构的核心是 “解耦 + 编排”，通过三层结构实现 MateChat 与业务能力的高效协作：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/68b19e3d01ca4809800ce9f47ac03724~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTnR1cm1vaWxz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764852118&amp;x-signature=SDoeKavWKYFBMz%2FiQ8Y1Y1dq1KA%3D" alt="img" loading="lazy"/></p>
<p>基于 “解耦 + 编排” 核心思想拆分三层架构，本质是解决传统组件紧耦合的三大痛点 ——① 交互层专注展示（MateChat 负责对话界面，不掺杂业务逻辑），避免 “UI 既做展示又做计算”；② 协调层作为 “中枢”，统一处理意图识别、任务调度，避免能力调用混乱；③ 能力层采用适配器模式（统一 MCPAdapter 接口），是为了实现 “能力可插拔”，后续新增数据导出、数据库查询等功能时，无需修改原有代码，仅需新增适配器注册，降低扩展成本。最终目标是让 MateChat 成为 “交互入口”，各类业务能力按需协作，实现 “一句话触发多任务” 的高效闭环。</p>
<p>协作流程如下：</p>
<p>从<code>src/mcp/engine.ts</code>可以看到完整的协作流程：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">async</span> <span class="hljs-title function_">process</span>(<span class="hljs-attr">query</span>: <span class="hljs-built_in">string</span>, data?: <span class="hljs-built_in">any</span>[], onStream?: <span class="hljs-function">(<span class="hljs-params">chunk: <span class="hljs-built_in">string</span></span>) =&gt;</span> <span class="hljs-built_in">void</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">MCPResult</span>&gt; {
  <span class="hljs-comment">// 1. 意图识别：判断用户想做什么</span>
  <span class="hljs-keyword">const</span> { intent, capabilities } = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">analyzeIntent</span>(query);

  <span class="hljs-comment">// 2. 构建MCP消息（统一通信格式）</span>
  <span class="hljs-keyword">const</span> <span class="hljs-attr">message</span>: <span class="hljs-title class_">MCPMessage</span> = {
    <span class="hljs-attr">id</span>: <span class="hljs-string">`msg_<span class="hljs-subst">${<span class="hljs-built_in">Date</span>.now()}</span>`</span>,
    <span class="hljs-attr">type</span>: <span class="hljs-string">'query'</span>,
    intent,
    <span class="hljs-attr">payload</span>: { query, data, <span class="hljs-attr">context</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">buildContext</span>() },
    capabilities,
    <span class="hljs-attr">timestamp</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>()
  };

  <span class="hljs-comment">// 3. 任务编排：并行调用所需能力</span>
  <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">orchestrate</span>(message, onStream);

  <span class="hljs-keyword">return</span> result;
}
</code></pre>
<p>意图识别基于关键词分析，当用户提问"对比各区域销售表现"时：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">async</span> <span class="hljs-title function_">analyzeIntent</span>(<span class="hljs-attr">query</span>: <span class="hljs-built_in">string</span>): <span class="hljs-title class_">Promise</span>&lt;{<span class="hljs-attr">intent</span>: <span class="hljs-title class_">MCPIntent</span>; <span class="hljs-attr">capabilities</span>: <span class="hljs-title class_">MCPCapability</span>[]}&gt; {
  <span class="hljs-keyword">const</span> queryLower = query.<span class="hljs-title function_">toLowerCase</span>();

  <span class="hljs-comment">// 检测到"对比"关键词，判定为可视化意图</span>
  <span class="hljs-keyword">if</span> (queryLower.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'对比'</span>) || queryLower.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'趋势'</span>) || queryLower.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'占比'</span>)) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">intent</span>: <span class="hljs-string">'visualize'</span>,
      <span class="hljs-attr">capabilities</span>: [<span class="hljs-string">'ai'</span>, <span class="hljs-string">'chart'</span>, <span class="hljs-string">'data'</span>] <span class="hljs-comment">// 需要三个能力协同</span>
    };
  }
}
</code></pre>
<p>Engine识别出需要三个能力后，通过<code>orchestrate</code>方法并行调用：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">async</span> <span class="hljs-title function_">orchestrate</span>(<span class="hljs-attr">message</span>: <span class="hljs-title class_">MCPMessage</span>, onStream?: <span class="hljs-function">(<span class="hljs-params">chunk: <span class="hljs-built_in">string</span></span>) =&gt;</span> <span class="hljs-built_in">void</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">MCPResult</span>&gt; {
  <span class="hljs-keyword">const</span> <span class="hljs-attr">tasks</span>: <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">any</span>&gt;[] = [];

  message.<span class="hljs-property">capabilities</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">cap</span> =&gt;</span> {
    <span class="hljs-keyword">switch</span> (cap) {
      <span class="hljs-keyword">case</span> <span class="hljs-string">'ai'</span>:
        tasks.<span class="hljs-title function_">push</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">aiAdapter</span>.<span class="hljs-title function_">process</span>(payload, onStream)); <span class="hljs-comment">// 华为云AI分析</span>
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-string">'chart'</span>:
        tasks.<span class="hljs-title function_">push</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">chartAdapter</span>.<span class="hljs-title function_">process</span>(payload)); <span class="hljs-comment">// 图表生成</span>
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-string">'data'</span>:
        tasks.<span class="hljs-title function_">push</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">dataAdapter</span>.<span class="hljs-title function_">process</span>(payload)); <span class="hljs-comment">// 数据计算</span>
        <span class="hljs-keyword">break</span>;
    }
  });

  <span class="hljs-comment">// 并行执行，提高效率</span>
  <span class="hljs-keyword">const</span> results = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>(tasks);

  <span class="hljs-comment">// 结果聚合</span>
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">text</span>: results[<span class="hljs-number">0</span>],      <span class="hljs-comment">// AI分析文本</span>
    <span class="hljs-attr">chart</span>: results[<span class="hljs-number">1</span>],     <span class="hljs-comment">// 图表配置</span>
    <span class="hljs-attr">metrics</span>: results[<span class="hljs-number">2</span>]    <span class="hljs-comment">// 关键指标</span>
  };
}
</code></pre>
<p>这种设计的优势是：如果将来需要增加"数据导出"能力，只需新增一个<code>ExportAdapter</code>，在Engine中注册即可，其他组件无需修改。</p>
<h2 data-id="heading-4">DevUI组件深度集成</h2>
<h3 data-id="heading-5">MateChat：智能对话交互</h3>
<p>MateChat是DevUI生态中的对话组件，提供了开箱即用的聊天界面。项目中使用了三个核心组件：</p>
<p><strong>McBubble气泡消息</strong>：支持不同角色（用户/AI）的消息展示，内置头像、时间戳等功能。</p>
<pre><code class="hljs language-vue" lang="vue">&lt;McBubble :role="msg.role" :avatar="msg.avatar"&gt;
  &lt;!-- AI分析结果 --&gt;
  &lt;McMarkdownCard v-if="msg.content" :content="msg.content" /&gt;

  &lt;!-- 图表展示 --&gt;
  &lt;div v-if="msg.chart" class="chart-container"&gt;
    &lt;canvas :ref="el =&gt; chartRefs[msg.id] = el"&gt;&lt;/canvas&gt;
  &lt;/div&gt;

  &lt;!-- DevUI关键指标卡片 --&gt;
  &lt;div v-if="msg.metrics" class="metrics-container"&gt;
    &lt;d-row :gutter="[12, 12]" wrap&gt;
      &lt;d-col v-for="(value, key) in msg.metrics" :key="key" :span="4"&gt;
        &lt;div class="metric-card"&gt;
          &lt;div class="metric-label"&gt;{{ key }}&lt;/div&gt;
          &lt;div class="metric-value"&gt;{{ formatNumber(value) }}&lt;/div&gt;
        &lt;/div&gt;
      &lt;/d-col&gt;
    &lt;/d-row&gt;
  &lt;/div&gt;
&lt;/McBubble&gt;
</code></pre>
<p>这里体现了MateChat与DevUI的协作：<strong>McBubble</strong>负责消息容器，<strong>d-row</strong>和<strong>d-col</strong>（DevUI栅格组件）负责指标卡片布局。两者配合实现了"对话+数据展示"的混合界面。</p>
<p><strong>McInput智能输入</strong>：支持Enter提交、禁用状态、占位提示等功能。</p>
<pre><code class="hljs language-vue" lang="vue">&lt;McInput
  :value="userInput"
  placeholder="输入问题，如：分析各区域销售表现"
  :disabled="loading"
  @change="(val: string) =&gt; userInput = val"
  @submit="handleSend"
/&gt;
</code></pre>
<p>与传统<code>&lt;input&gt;</code>相比，<code>McInput</code>内置了对话场景的常用逻辑（如Shift+Enter换行、Enter发送），减少了开发工作量。</p>
<p><strong>McMarkdownCard富文本渲染</strong>：AI返回的分析报告通常包含Markdown格式（加粗、列表、代码块），<code>McMarkdownCard</code>可以直接渲染，无需额外配置。</p>
<pre><code class="hljs language-vue" lang="vue">&lt;McMarkdownCard :content="aiAnalysisResult" /&gt;
</code></pre>
<p>这个组件的价值在于：华为云AI返回的分析结果是Markdown格式，如果用普通<code>&lt;div&gt;</code>展示会丢失格式。<code>McMarkdownCard</code>解决了这个问题，让AI输出更专业。</p>
<h3 data-id="heading-6">DevUI组件：企业级数据展示</h3>
<p>除了MateChat，项目还深度使用了DevUI组件库的其他组件：</p>
<p><strong>d-table数据表格</strong>：展示业务数据，支持排序、分页、自定义列。</p>
<pre><code class="hljs language-vue" lang="vue">&lt;d-table :data="tableData" border stripe&gt;
  &lt;d-column field="region" header="区域" width="120" /&gt;
  &lt;d-column field="q1" header="Q1销售额" width="150" align="right" /&gt;
  &lt;d-column field="q2" header="Q2销售额" width="150" align="right" /&gt;
  &lt;d-column field="growth" header="增长率" width="100" align="right"&gt;
    &lt;template #default="{ row }"&gt;
      &lt;span :class="row.growth &gt; 15 ? 'growth-high' : 'growth-normal'"&gt;
        {{ row.growth }}%
      &lt;/span&gt;
    &lt;/template&gt;
  &lt;/d-column&gt;
&lt;/d-table&gt;
</code></pre>
<p><strong>d-modal对话框</strong>：数据选择弹窗，内置动画效果和遮罩层。</p>
<pre><code class="hljs language-vue" lang="vue">&lt;d-modal v-model="showDataModal" title="选择数据集" width="600px"&gt;
  &lt;d-radio-group v-model="selectedDataset" direction="column"&gt;
    &lt;d-radio v-for="ds in datasets" :key="ds.id" :value="ds.id"&gt;
      &lt;div class="dataset-option"&gt;
        &lt;div class="dataset-name"&gt;{{ ds.name }}&lt;/div&gt;
        &lt;div class="dataset-desc"&gt;{{ ds.description }}&lt;/div&gt;
      &lt;/div&gt;
    &lt;/d-radio&gt;
  &lt;/d-radio-group&gt;

  &lt;template #footer&gt;
    &lt;d-button @click="loadSelectedData" variant="solid"&gt;确认加载&lt;/d-button&gt;
  &lt;/template&gt;
&lt;/d-modal&gt;
</code></pre>
<p>点击"加载数据"按钮后，<code>d-modal</code>弹出数据选择界面，展示了多个预置数据集：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fa945c2f0c45465a960a75e28413e33d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTnR1cm1vaWxz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764852118&amp;x-signature=uZpawxdMfAHfqIXtTeGRJ5uA%2Fwc%3D" alt="数据选择弹框" loading="lazy"/></p>
<p>弹窗采用了DevUI的标准样式，<code>d-radio-group</code>以列表形式展示选项，每个选项包含数据集名称和描述。用户选择后点击"确认加载"，系统会通过<code>DataAdapter</code>加载对应的业务数据。</p>
<p><strong>d-button按钮</strong>：支持多种变体（solid、outline、text）和尺寸（sm、md、lg），图标插槽可以自定义内容。</p>
<pre><code class="hljs language-vue" lang="vue">&lt;d-button @click="handleAnalyze" size="lg" variant="solid"&gt;
  &lt;template #icon&gt;
    &lt;span&gt;🔍&lt;/span&gt;
  &lt;/template&gt;
  开始分析
&lt;/d-button&gt;
</code></pre>
<p>这些组件的统一设计语言保证了界面的一致性。比如所有按钮的主色调都是DevUI的品牌色（#5e7ce0），所有表格都遵循相同的交互规范，用户学习成本很低。</p>
<h3 data-id="heading-7">流式输出：解决Vue响应式更新问题</h3>
<p>华为云AI支持流式返回，但如何在MateChat中实现"逐字显示"效果？这里遇到了Vue响应式的坑。</p>
<p>在<code>src/App.vue</code>中，如果直接修改对象属性：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// ❌ 错误写法</span>
<span class="hljs-keyword">const</span> aiMessage = { <span class="hljs-attr">id</span>: <span class="hljs-string">'ai_xxx'</span>, <span class="hljs-attr">content</span>: <span class="hljs-string">''</span> };
messages.<span class="hljs-property">value</span>.<span class="hljs-title function_">push</span>(aiMessage);

<span class="hljs-comment">// 流式更新时</span>
aiMessage.<span class="hljs-property">content</span> += chunk; <span class="hljs-comment">// Vue无法检测到变化</span>
</code></pre>
<p>解决方案是通过数组索引触发响应：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// ✅ 正确写法</span>
messages.<span class="hljs-property">value</span>.<span class="hljs-title function_">push</span>({ <span class="hljs-attr">id</span>: <span class="hljs-string">'ai_xxx'</span>, <span class="hljs-attr">content</span>: <span class="hljs-string">''</span> });
<span class="hljs-keyword">const</span> aiMessageIndex = messages.<span class="hljs-property">value</span>.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>;

<span class="hljs-comment">// 调用MCP Engine，传入流式回调</span>
<span class="hljs-keyword">await</span> mcpEngine.<span class="hljs-title function_">process</span>(query, tableData.<span class="hljs-property">value</span>, <span class="hljs-function">(<span class="hljs-params">chunk: <span class="hljs-built_in">string</span></span>) =&gt;</span> {
  messages.<span class="hljs-property">value</span>[aiMessageIndex].<span class="hljs-property">content</span> += chunk; <span class="hljs-comment">// 触发响应式</span>
});
</code></pre>
<p>在<code>src/mcp/adapters/ai-adapter.ts</code>中处理华为云AI的流式响应：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">async</span> <span class="hljs-title function_">process</span>(<span class="hljs-attr">payload</span>: <span class="hljs-title class_">MCPPayload</span>, onStream?: <span class="hljs-function">(<span class="hljs-params">chunk: <span class="hljs-built_in">string</span></span>) =&gt;</span> <span class="hljs-built_in">void</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">string</span>&gt; {
  <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/api/v1/chat/completions'</span>, {
    <span class="hljs-attr">method</span>: <span class="hljs-string">'POST'</span>,
    <span class="hljs-attr">body</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({
      <span class="hljs-attr">model</span>: <span class="hljs-string">'DeepSeek-V3'</span>,
      <span class="hljs-attr">messages</span>: [{
        <span class="hljs-attr">role</span>: <span class="hljs-string">'system'</span>,
        <span class="hljs-attr">content</span>: <span class="hljs-string">'你是专业的业务数据分析师'</span>
      }, {
        <span class="hljs-attr">role</span>: <span class="hljs-string">'user'</span>,
        <span class="hljs-attr">content</span>: payload.<span class="hljs-property">query</span>
      }],
      <span class="hljs-attr">stream</span>: <span class="hljs-literal">true</span> <span class="hljs-comment">// 华为云AI流式输出</span>
    })
  });

  <span class="hljs-keyword">const</span> reader = response.<span class="hljs-property">body</span>?.<span class="hljs-title function_">getReader</span>();
  <span class="hljs-keyword">const</span> decoder = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TextDecoder</span>(<span class="hljs-string">'utf-8'</span>);
  <span class="hljs-keyword">let</span> fullContent = <span class="hljs-string">''</span>;

  <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
    <span class="hljs-keyword">const</span> { done, value } = <span class="hljs-keyword">await</span> reader.<span class="hljs-title function_">read</span>();
    <span class="hljs-keyword">if</span> (done) <span class="hljs-keyword">break</span>;

    <span class="hljs-keyword">const</span> chunk = decoder.<span class="hljs-title function_">decode</span>(value, { <span class="hljs-attr">stream</span>: <span class="hljs-literal">true</span> });
    <span class="hljs-keyword">const</span> lines = chunk.<span class="hljs-title function_">split</span>(<span class="hljs-string">'\n'</span>).<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">line</span> =&gt;</span> line.<span class="hljs-title function_">trim</span>() !== <span class="hljs-string">''</span>);

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> line <span class="hljs-keyword">of</span> lines) {
      <span class="hljs-keyword">if</span> (line.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">'data: '</span>)) {
        <span class="hljs-keyword">const</span> data = line.<span class="hljs-title function_">slice</span>(<span class="hljs-number">6</span>);
        <span class="hljs-keyword">if</span> (data === <span class="hljs-string">'[DONE]'</span>) <span class="hljs-keyword">continue</span>;

        <span class="hljs-keyword">const</span> parsed = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(data);
        <span class="hljs-keyword">const</span> content = parsed.<span class="hljs-property">choices</span>?.[<span class="hljs-number">0</span>]?.<span class="hljs-property">delta</span>?.<span class="hljs-property">content</span> || <span class="hljs-string">''</span>;

        <span class="hljs-keyword">if</span> (content) {
          fullContent += content;
          <span class="hljs-keyword">if</span> (onStream) {
            <span class="hljs-title function_">onStream</span>(content); <span class="hljs-comment">// 实时回调UI层</span>
          }
        }
      }
    }
  }

  <span class="hljs-keyword">return</span> fullContent;
}
</code></pre>
<p>实测中，华为云AI生成一段200字的分析报告需要约2秒，用户可以看到文字逐个出现的效果，体验比"等待2秒后一次性显示"好很多。</p>
<h2 data-id="heading-8">场景演示：从提问到结果的完整流程</h2>
<p>开始场景演示前，需要先加载数据。选择"Q1季度销售数据"并确认后，系统通过<code>DataAdapter</code>处理数据，右侧数据面板使用<code>d-table</code>组件展示数据预览：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ae9833df7fc9452cb374d0609e4078ca~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTnR1cm1vaWxz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764852118&amp;x-signature=W6XqFbNcCF5qyZBWbigZG%2BoL%2FlQ%3D" alt="数据加载成功" loading="lazy"/></p>
<p>数据表格清晰展示了4个区域的销售数据，包括区域名称、Q1销售额、Q2销售额和增长率。表格使用了DevUI的<code>border</code>和<code>stripe</code>属性，提升了可读性。左侧MateChat组件显示系统提示，引导用户开始提问。</p>
<h3 data-id="heading-9">场景1：区域销售对比分析</h3>
<p><strong>用户输入</strong>："对比各区域销售表现"</p>
<p><strong>系统处理流程</strong>：</p>
<ol>
<li>
<p><strong>MCP Engine意图识别</strong>：检测到"对比"关键词，判定为<code>visualize</code>意图，需要<code>ai</code>、<code>chart</code>、<code>data</code>三个能力。</p>
<p>① 意图识别设计：通过关键词匹配意图（“对比”→visualize 意图），是为了快速定位用户核心需求，避免复杂语义分析导致的延迟，符合业务分析 “高效响应” 的要求；② 并行调用设计：三大能力同时执行而非串行，是为了缩短总处理时间（实测 2.3 秒），解决传统分步操作 “耗时久” 的问题；③ 结果分层展示设计：文本（AI 解读）→图表（可视化对比）→指标（核心数据），是遵循 “先理解、再直观、最后精准” 的认知逻辑，帮助业务人员快速抓取核心信息，无需手动整理分析结果。</p>
</li>
<li>
<p><strong>并行调用三个适配器</strong>：</p>
<ul>
<li><code>AIAdapter</code>调用华为云AI分析数据特征，生成专业建议</li>
<li><code>ChartAdapter</code>自动识别数据结构，生成柱状图配置</li>
<li><code>DataAdapter</code>计算关键指标（总和、平均值、最大值）</li>
</ul>
</li>
<li>
<p><strong>MateChat展示结果</strong>：</p>
<ul>
<li>AI分析文本通过<code>McMarkdownCard</code>渲染</li>
<li>图表通过Chart.js在<code>&lt;canvas&gt;</code>中渲染</li>
<li>关键指标通过DevUI的<code>d-row</code>+<code>d-col</code>布局展示</li>
</ul>
</li>
</ol>
<p><strong>实际效果</strong>（见截图）：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/87b9e103c708459b84e1eba85ffd9b26~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTnR1cm1vaWxz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764852118&amp;x-signature=DdseWb%2BmwMNKpTo7xOwyfujSOA4%3D" alt="完整分析结果" loading="lazy"/></p>
<p>左侧对话区域展示了AI的分析结论："华东区域表现最佳，Q1销售额52万，增长率28%。华南、华北需探索增长潜力。"</p>
<p>下方自动生成柱状图，横轴为"华东、华南、华北、西南"，纵轴为销售额，一目了然。</p>
<p>底部关键指标卡片显示：数据总量4条、Q1总和150万、平均值37.5万、最大值52万。</p>
<p>从输入问题到展示完整结果，耗时2.3秒（其中AI分析1.8秒，图表生成0.2秒，数据计算0.3秒）。</p>
<h3 data-id="heading-10">场景2：趋势分析</h3>
<p><strong>用户输入</strong>："分析销售数据趋势"</p>
<p><strong>系统处理</strong>：</p>
<p>Engine识别到"趋势"关键词，<code>ChartAdapter</code>自动选择折线图类型。华为云AI分析月度增长情况，给出"1月至2月增长10%，2月至3月增长28.57%，总体趋势向上"的结论。</p>
<p><strong>实际效果</strong>：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5602e9381f22485983d21f8eeb652d94~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTnR1cm1vaWxz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764852118&amp;x-signature=gqoh%2F8y%2Fqu8mpAfKvJ5pmVDQ5as%3D" alt="趋势分析" loading="lazy"/></p>
<p>折线图清晰展示了6个月的销售走势，配合AI的专业建议（"加强市场营销、区域分析、制定销售预测"），为业务决策提供依据。</p>
<h3 data-id="heading-11">场景3：占比分析</h3>
<p><strong>用户输入</strong>："各产品占比分析"</p>
<p><strong>系统处理</strong>：</p>
<p>识别到"占比"关键词，<code>ChartAdapter</code>生成饼图。华为云AI分析产品结构，指出"产品A占36%，是销售冠军；产品B和C占比较低，需要优化销售策略"。</p>
<p><strong>实际效果</strong>：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/45cd956253c94954a80da14756912e81~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTnR1cm1vaWxz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764852118&amp;x-signature=Oo8yjGVTiqeQ7is0ZhU0rum%2Fg%2FU%3D" alt="占比分析" loading="lazy"/></p>
<p>饼图直观展示各产品的市场份额，配合AI的优化建议，帮助业务人员快速找到改进方向。</p>
<h3 data-id="heading-12">控制台日志：MCP协作过程透明化</h3>
<p>打开浏览器控制台，可以看到MCP Engine的完整工作流程：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/23973e8824ce45a4a8118ac6f2e298b0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTnR1cm1vaWxz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764852118&amp;x-signature=2heCNrMIxRIdyKZSK5omhKlqkkg%3D" alt="MCP Engine工作流程" loading="lazy"/></p>
<pre><code class="hljs language-csharp" lang="csharp">[<span class="hljs-meta">MCP Engine</span>] ========== 开始处理 ==========
[<span class="hljs-meta">MCP Engine</span>] 查询: 对比各区域销售表现
[<span class="hljs-meta">MCP Engine</span>] 数据量: <span class="hljs-number">4</span>
[<span class="hljs-meta">MCP Engine</span>] 意图识别: 对比各区域销售表现
[<span class="hljs-meta">MCP Engine</span>] 识别结果: {intent: <span class="hljs-string">'visualize'</span>, capabilities: [<span class="hljs-string">'ai'</span>, <span class="hljs-string">'chart'</span>, <span class="hljs-string">'data'</span>]}
[<span class="hljs-meta">MCP Engine</span>] 开始任务编排
[<span class="hljs-meta">Chart Adapter</span>] 开始处理
[<span class="hljs-meta">Chart Adapter</span>] 图表类型: bar
[<span class="hljs-meta">Chart Adapter</span>] 提取数据: {labelKey: <span class="hljs-string">'region'</span>, valueKey: <span class="hljs-string">'q1'</span>, labelsCount: <span class="hljs-number">4</span>}
[<span class="hljs-meta">Chart Adapter</span>] 处理完成
[<span class="hljs-meta">MCP Engine</span>] 并行执行<span class="hljs-number">3</span>个任务: [<span class="hljs-string">'AI分析'</span>, <span class="hljs-string">'图表生成'</span>, <span class="hljs-string">'数据处理'</span>]
[<span class="hljs-meta">MCP Engine</span>] AI分析 完成
[<span class="hljs-meta">MCP Engine</span>] 图表生成 完成
[<span class="hljs-meta">MCP Engine</span>] 数据处理 完成
[<span class="hljs-meta">MCP Engine</span>] 任务编排完成
[<span class="hljs-meta">MCP Engine</span>] ========== 处理完成 ==========
</code></pre>
<p>这种透明化的日志对于调试和优化非常有帮助。比如发现某个适配器耗时过长，可以针对性优化。</p>
<h2 data-id="heading-13">价值总结：MCP协作带来的三大提升</h2>
<h3 data-id="heading-14">1. 开发效率提升：组件即插即用</h3>
<p>传统方式下，集成AI对话需要自己写UI、处理流式响应、实现Markdown渲染，至少需要2-3天。使用MateChat后，只需几行代码：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;McBubble role="assistant" avatar="ai"&gt;
  &lt;McMarkdownCard :content="aiResponse" /&gt;
&lt;/McBubble&gt;
</code></pre>
<p>DevUI组件也是如此。需要数据表格？<code>&lt;d-table&gt;</code>搞定。需要弹窗？<code>&lt;d-modal&gt;</code>搞定。粗略估计，使用DevUI生态的组件，开发效率提升了60%以上。</p>
<h3 data-id="heading-15">2. 用户体验提升：多能力无缝衔接</h3>
<p>MCP架构的核心价值是"多能力协同"。用户提一个问题，系统自动判断需要哪些能力，并行处理后统一返回。这种体验远超传统的"分步操作"：</p>
<ul>
<li>传统方式：用户上传数据 → 选择图表类型 → 手动调整参数 → 生成图表 → 另外打开AI工具分析 → 手动整理报告</li>
<li>MCP方式：用户提问"对比各区域销售表现" → 系统自动完成所有环节，2.5秒出结果</li>
</ul>
<p>实测中，业务人员使用MCP平台分析一份数据的时间从15分钟缩短到2分钟，效率提升了7倍。</p>
<h3 data-id="heading-16">3. 架构扩展性提升：新增能力成本低</h3>
<p>由于MCP采用适配器模式，新增能力的成本很低。比如将来需要增加"数据导出"功能：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 新增ExportAdapter</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ExportAdapter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">MCPAdapter</span> {
  name = <span class="hljs-string">'Export Adapter'</span>;

  <span class="hljs-keyword">async</span> <span class="hljs-title function_">process</span>(<span class="hljs-attr">payload</span>: <span class="hljs-title class_">MCPPayload</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">string</span>&gt; {
    <span class="hljs-comment">// 导出为Excel</span>
    <span class="hljs-keyword">const</span> workbook = <span class="hljs-variable constant_">XLSX</span>.<span class="hljs-property">utils</span>.<span class="hljs-title function_">book_new</span>();
    <span class="hljs-keyword">const</span> worksheet = <span class="hljs-variable constant_">XLSX</span>.<span class="hljs-property">utils</span>.<span class="hljs-title function_">json_to_sheet</span>(payload.<span class="hljs-property">data</span>);
    <span class="hljs-variable constant_">XLSX</span>.<span class="hljs-property">utils</span>.<span class="hljs-title function_">book_append_sheet</span>(workbook, worksheet, <span class="hljs-string">'Data'</span>);
    <span class="hljs-variable constant_">XLSX</span>.<span class="hljs-title function_">writeFile</span>(workbook, <span class="hljs-string">'export.xlsx'</span>);

    <span class="hljs-keyword">return</span> <span class="hljs-string">'数据已导出'</span>;
  }
}

<span class="hljs-comment">// 在Engine中注册</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">MCPEngine</span> {
  <span class="hljs-keyword">private</span> <span class="hljs-attr">exportAdapter</span>: <span class="hljs-title class_">ExportAdapter</span>;

  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">exportAdapter</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExportAdapter</span>();
  }

  <span class="hljs-keyword">async</span> <span class="hljs-title function_">orchestrate</span>(<span class="hljs-attr">message</span>: <span class="hljs-title class_">MCPMessage</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">MCPResult</span>&gt; {
    <span class="hljs-keyword">if</span> (message.<span class="hljs-property">capabilities</span>.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'export'</span>)) {
      tasks.<span class="hljs-title function_">push</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">exportAdapter</span>.<span class="hljs-title function_">process</span>(payload));
    }
  }
}
</code></pre>
<p>只需新增一个适配器，无需修改UI层和其他能力层代码。这种扩展性让系统具备了长期演进的能力。</p>
<h3 data-id="heading-17">对DevUI生态的理解</h3>
<p>通过这个项目，我对DevUI生态有了更深的认识：</p>
<p><strong>MateChat不只是聊天组件</strong>，它是一个"交互范式"的实现。传统企业软件的交互是"表单+按钮"，MateChat提供了"对话+智能理解"的新范式，特别适合数据分析、运维监控、知识问答等场景。</p>
<p><strong>DevUI不只是UI库</strong>，它是一套完整的"企业级前端解决方案"。从基础组件（按钮、输入框）到高级组件（表格、图表），从交互规范到设计语言，都经过了企业场景的打磨。使用DevUI开发企业应用，比用通用UI库（如Element Plus）更高效。</p>
<p><strong>华为云AI与前端的结合</strong>不是简单的"调API"，而是"能力融合"。通过MCP这样的协作架构，AI成为了前端组件的"增强器"，让静态的表格变得"会分析"，让死板的图表变得"会解读"。</p>
<p>这个项目只是一个开始。未来可以探索更多DevUI生态的协作可能：</p>
<ul>
<li><strong>MateChat + ModelArts</strong>：将华为云ModelArts的模型训练能力集成到对话界面，用户可以通过对话完成模型训练、调优、部署</li>
<li><strong>DevUI + GaussDB</strong>：将华为云GaussDB的数据库能力封装为适配器，用户通过自然语言查询数据库</li>
<li><strong>MCP + 微服务</strong>：将MCP Engine部署为独立服务，多个前端应用共享能力层</li>
</ul>
<p>MCP架构证明了一件事：<strong>好的协作机制比单个组件的强大更重要</strong>。DevUI生态提供了优秀的组件，MCP提供了优秀的协作方式，两者结合产生了"1+1&gt;2"的效果。</p>
<p><strong>在线体验地址</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmcpchat.acowbo.com" target="_blank" title="https://mcpchat.acowbo.com" ref="nofollow noopener noreferrer">mcpchat.acowbo.com</a></p>
<p><strong>开源地址</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitcode.com%2FMrxiao_bo%2Fmcp-business-analyzer" target="_blank" title="https://gitcode.com/Mrxiao_bo/mcp-business-analyzer" ref="nofollow noopener noreferrer">gitcode.com/Mrxiao_bo/m…</a></p>
<p><strong>DevUI 官网</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdevui.design%2Fhome" target="_blank" title="https://devui.design/home" ref="nofollow noopener noreferrer">devui.design/home</a> 查看完整组件库</p>
<p><strong>体验地址</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmatechat.gitcode.com%2F" target="_blank" title="https://matechat.gitcode.com/" ref="nofollow noopener noreferrer">MateChat - 轻松构建你的AI应用</a></p>
<p><strong>MateChat 使用指南</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmatechat.gitcode.com%2Fuse-guide%2Fintroduction.html" target="_blank" title="https://matechat.gitcode.com/use-guide/introduction.html" ref="nofollow noopener noreferrer">matechat.gitcode.com/use-guide/i…</a> 快速上手开发</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[MCP Partner, 一个在线快捷 mcp client 调试工具]]></title>    <link>https://juejin.cn/post/7577218195233914926</link>    <guid>https://juejin.cn/post/7577218195233914926</guid>    <pubDate>2025-11-27T14:50:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577218195233914926" data-draft-id="7577237961638608905" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="MCP Partner, 一个在线快捷 mcp client 调试工具 "/> <meta itemprop="keywords" content="MCP"/> <meta itemprop="datePublished" content="2025-11-27T14:50:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Ericwyn"/> <meta itemprop="url" content="https://juejin.cn/user/3122268753112173"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            MCP Partner, 一个在线快捷 mcp client 调试工具 
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3122268753112173/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Ericwyn
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T14:50:44.000Z" title="Thu Nov 27 2025 14:50:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>最近一直在做 Ai Agent 和 MCP 相关的开发，一直有个痛点是觉得自己本地开发的 mcp server 调试起来有点麻烦，之前都是用 cherry studio 或者其他能够接入 mcp server 的 ai 工具来调试，官方也有调试工具 mcp inspector, 不过也得安装才可以</p>
<p>使用 sse / streamable http 传输的 mcp server 本质上也是一个 http 服务器，只是所有报文都有固定格式</p>
<p>于是我很希望有一个类似 postman 这样的工具，最好是在线工具打开就能用</p>
<p>最近在开发调试过程中抽空用 ai builder 写了一个单页面应用的 mcp server 调试工具，界面操作逻辑上总体类似 postman 或者后端常用的 apifox 之类的工具，我把它叫做 mcp partner</p>
<p>目前放在 github pages 上，可以直接通过这个地址访问</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fericwyn.github.io%2Fmcp-partner" target="_blank" title="https://ericwyn.github.io/mcp-partner" ref="nofollow noopener noreferrer">ericwyn.github.io/mcp-partner</a></li>
</ul>
<h3 data-id="heading-1"><a href="https://link.juejin.cn?target=https%3A%2F%2Flinux.do%2Ft%2Ftopic%2F1228631%23p-10729906-h-2" target="_blank" title="https://linux.do/t/topic/1228631#p-10729906-h-2" ref="nofollow noopener noreferrer"/>功能</h3>
<ul>
<li>
<p>对 SSE、Streamable HTTP 协议 MCP Server 的快捷调试，获取 tool list, 配置 tool 请求参数并调用</p>
</li>
<li>
<p>快捷导入、导出 MCP Server 配置，类似以下配置，自动识别协议类型、header</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"mcpServers"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"local-mcp-server"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"streamable_http"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"192.168.199.200:9999"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"url"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"http://192.168.199.200:9999/mcp"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"headers"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
</li>
<li>
<p>支持历史记录保存, 配置导出</p>
</li>
<li>
<p>可以直接用 github pages / vercel 部署，数据都存储在浏览器</p>
</li>
<li>
<p>支持使用 CORS Proxy 绕过前端跨域问题</p>
<ul>
<li>默认使用 <a href="https://link.juejin.cn?target=http%3A%2F%2Fcorsproxy.io%2F" target="_blank" title="http://corsproxy.io/" ref="nofollow noopener noreferrer">corsproxy.io</a></li>
<li>部署到 vercel 的话可以使用 <code>/cors?url=</code> 来作为 cors proxy</li>
<li>自己本地也可以部署一个 pancors 作为 cors 代理，保证安全</li>
</ul>
</li>
<li>
<p>自定义请求 Header</p>
</li>
<li>
<p>PWA 应用，可安装到本地</p>
</li>
</ul>
<blockquote>
<p>不过目前没有办法对接带有 OAUTH2 这种复杂鉴权流程的 mcp server<br/>
也没法对接 stdio 输入输出的 mcp server</p>
</blockquote>
<h3 data-id="heading-2">源码</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FEricwyn%2Fmcp-partner" target="_blank" title="https://github.com/Ericwyn/mcp-partner" ref="nofollow noopener noreferrer">github.com/Ericwyn/mcp…</a></p>
<h3 data-id="heading-3">截图</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/953371ae6631469db103c14245860af3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRXJpY3d5bg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764859844&amp;x-signature=%2B0wqUYry%2F6Nq%2F%2FjBTOiZM5DE%2BWE%3D" alt="image.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Python高手都在用的5个隐藏技巧，让你的代码效率提升50%]]></title>    <link>https://juejin.cn/post/7577203946063937576</link>    <guid>https://juejin.cn/post/7577203946063937576</guid>    <pubDate>2025-11-28T00:16:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577203946063937576" data-draft-id="7577203946063921192" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Python高手都在用的5个隐藏技巧，让你的代码效率提升50%"/> <meta itemprop="keywords" content="后端,前端,人工智能"/> <meta itemprop="datePublished" content="2025-11-28T00:16:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿橙的百宝箱"/> <meta itemprop="url" content="https://juejin.cn/user/1638743356481367"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Python高手都在用的5个隐藏技巧，让你的代码效率提升50%
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1638743356481367/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿橙的百宝箱
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-28T00:16:47.000Z" title="Fri Nov 28 2025 00:16:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>Python高手都在用的5个隐藏技巧，让你的代码效率提升50%</strong></h2>
<h2 data-id="heading-1">引言</h2>
<p>Python作为一门简洁、易读且功能强大的编程语言，已经成为数据科学、Web开发、自动化脚本等领域的首选工具。然而，即使是经验丰富的开发者，也可能忽略了一些隐藏在Python标准库或语言特性中的高效技巧。这些技巧不仅能让代码更加优雅，还能显著提升运行效率。</p>
<p>本文将深入探讨5个鲜为人知但极具价值的Python技巧，这些技巧被许多高级开发者广泛使用，却很少在入门教程中提及。通过掌握这些方法，你的Python代码将变得更加高效和专业。</p>
<h2 data-id="heading-2">主体</h2>
<h3 data-id="heading-3">1. 利用<code>collections.defaultdict</code>优化字典操作</h3>
<h4 data-id="heading-4">问题场景</h4>
<p>在常规字典操作中，当我们尝试访问一个不存在的键时，会引发<code>KeyError</code>异常。常见的解决方法是使用<code>dict.get()</code>或提前检查键是否存在：</p>
<pre><code class="hljs language-python" lang="python">d = {}
<span class="hljs-keyword">if</span> <span class="hljs-string">'key'</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> d:
    d[<span class="hljs-string">'key'</span>] = []
d[<span class="hljs-string">'key'</span>].append(<span class="hljs-number">1</span>)
</code></pre>
<p>这种方法虽然可行，但在处理复杂数据结构时会显得冗长且低效。</p>
<h4 data-id="heading-5">高级解决方案</h4>
<p><code>collections.defaultdict</code>提供了一种更优雅的方式：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> collections <span class="hljs-keyword">import</span> defaultdict

d = defaultdict(<span class="hljs-built_in">list</span>)
d[<span class="hljs-string">'key'</span>].append(<span class="hljs-number">1</span>)  <span class="hljs-comment"># 自动创建空列表</span>
</code></pre>
<h4 data-id="heading-6">性能优势</h4>
<ul>
<li>避免了多次键存在性检查</li>
<li>减少了代码量（平均减少30%-50%的样板代码）</li>
<li>特别适用于嵌套数据结构（如树形结构或图）</li>
</ul>
<h4 data-id="heading-7">进阶用法</h4>
<p>可以自定义默认值工厂函数：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">constant_factory</span>(<span class="hljs-params">value</span>):
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">lambda</span>: value

d = defaultdict(constant_factory(<span class="hljs-string">'default_value'</span>))
</code></pre>
<h3 data-id="heading-8">2. <code>itertools</code>模块的组合魔法</h3>
<h4 data-id="heading-9">问题场景</h4>
<p>处理迭代器时经常需要实现复杂的组合逻辑，比如排列组合、无限迭代或分组操作。手动实现这些功能不仅耗时而且容易出错。</p>
<h4 data-id="heading-10">高级解决方案</h4>
<p>Python内置的<code>itertools</code>模块提供了大量高效的迭代器工具：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> itertools

<span class="hljs-comment"># 无限计数器</span>
counter = itertools.count(start=<span class="hljs-number">10</span>, step=<span class="hljs-number">2</span>)

<span class="hljs-comment"># 排列组合（无重复元素）</span>
perms = itertools.permutations(<span class="hljs-string">'ABC'</span>, <span class="hljs-number">2</span>)

<span class="hljs-comment"># 分组相邻元素（需先排序）</span>
grouped = itertools.groupby(<span class="hljs-built_in">sorted</span>(data))
</code></pre>
<h4 data-id="heading-11">性能优势</h4>
<ul>
<li>C语言级别的实现效率（比纯Python实现快3-10倍）</li>
<li>Lazy evaluation（内存友好）</li>
<li>API设计一致且易于组合</li>
</ul>
<h4 data-id="heading-12">实际案例：滑动窗口计算移动平均</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">moving_average</span>(<span class="hljs-params">iterable, n=<span class="hljs-number">3</span></span>):
    it = <span class="hljs-built_in">iter</span>(iterable)
    window = collections.deque(itertools.islice(it, n), maxlen=n)
    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(window) == n:
        <span class="hljs-keyword">yield</span> <span class="hljs-built_in">sum</span>(window) / n
    <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> it:
        window.append(x)
        <span class="hljs-keyword">yield</span> <span class="hljs-built_in">sum</span>(window) / n
</code></pre>
<h3 data-id="heading-13">3. <code>__slots__</code>的内存优化魔法</h3>
<h4 data-id="heading-14">Problem Context Python默认使用字典(<code>__dict__</code>)存储对象属性虽然灵活但内存开销大对于创建大量小型对象的场景会造成显著内存压力。</h4>
<h4 data-id="heading-15">Advanced Solution <code>__slots__</code>类变量可以显式声明类拥有的属性从而避免动态属性分配:</h4>
<pre><code class="hljs language-python" lang="python"> __slots__ = [<span class="hljs-string">'x'</span>, <span class="hljs-string">'y'</span>]
 <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, x, y</span>):
     self.x = x
     self.y = y ```

Performance Benefits:
- Memory footprint reduced by **<span class="hljs-number">40</span>%-<span class="hljs-number">70</span>%**
- Faster attribute access (eliminates dictionary lookup)
- Especially effective when instantiating millions of objects  

Trade-offs to Consider:
- No dynamic attribute assignment  
- Doesn<span class="hljs-string">'t work with certain features like weakrefs unless explicitly added  

Real-world Benchmark: In a data pipeline processing **10M geo points**, switching to `__slots__` reduced memory usage from **3.2GB** to **1.1GB**.

###4.Context Managers Beyond Files  

Common Knowledge: Most developers use context managers (`with`) exclusively for file operations  

Hidden Power: The protocol can manage any resource lifecycle including  
 - Database connections  
 - Temporary directories  
 - Timing blocks  
 - State modifications  

Advanced Example: Implementing a suppression manager  

```python from contextlib import suppress  
with suppress(FileNotFoundError): os.remove('</span>tempfile<span class="hljs-string">') ```  

Pro Tip: Combine multiple managers using `ExitStack`:  

```python from contextlib import ExitStack  
with ExitStack() as stack: files = [stack.enter_context(open(fname)) for fname in filenames] lock = stack.enter_context(threading.Lock()) ```  

Performance Impact: Proper resource management can prevent memory leaks and reduce cleanup boilerplate by ~60%

###5.Functools'</span> Cache Decorators  

Historical Approach: Manually implement memoization <span class="hljs-keyword">with</span> dictionary storage  

Modern Solution: Built-<span class="hljs-keyword">in</span> decorators since Python3<span class="hljs-number">.9</span>+:  

```python <span class="hljs-keyword">from</span> functools <span class="hljs-keyword">import</span> cache @cache <span class="hljs-keyword">def</span> <span class="hljs-title function_">fibonacci</span>(<span class="hljs-params">n</span>): <span class="hljs-keyword">return</span> n <span class="hljs-keyword">if</span> n &lt;<span class="hljs-number">2</span> <span class="hljs-keyword">else</span> fibonacci(n-<span class="hljs-number">1</span>)+fibonacci(n-<span class="hljs-number">2</span>) ```  

For configurable caching use `lru_cache`:  

```python @lru_cache(maxsize=<span class="hljs-number">256</span>) <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_asset</span>(<span class="hljs-params">path</span>): <span class="hljs-keyword">return</span> expensive_processing(path) ```  

Performance Characteristics:  
 - Avoid redundant computations  
 - Trade-off between memory <span class="hljs-keyword">and</span> CPU usage  
 - Thread-safe implementation out of the box   

Case Study:A recursive parser saw **<span class="hljs-number">2000</span>% speedup** after adding caching <span class="hljs-keyword">while</span> maintaining identical results.

<span class="hljs-comment">##Conclusion Mastering these five advanced techniques—judicious application of specialized containers,collections utilities,systematic memory management,elegant resource handling,and intelligent caching—can elevate your Python code from merely functional to genuinely optimized.</span>

The true mark of an expert isn<span class="hljs-string">'t just knowing syntax but understanding which tools solve specific problems most effectively.We'</span>ve covered implementations that offer order-of-magnitude improvements <span class="hljs-keyword">in</span> common scenarios,but their greatest value comes when adapted creatively to your unique challenges.

Remember that optimization should always follow working code—profile first then apply these methods where they<span class="hljs-string">'ll have maximal impact.With practice,these patterns will become natural parts of your Python toolbox enabling you to write cleaner,faster,and more maintainable code consistently
</span></code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[做了十年游戏，我才意识到：程序员最该投资的，是一台专业的编程显示器]]></title>    <link>https://juejin.cn/post/7577218195234177070</link>    <guid>https://juejin.cn/post/7577218195234177070</guid>    <pubDate>2025-11-28T00:30:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577218195234177070" data-draft-id="7577239264309362688" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="做了十年游戏，我才意识到：程序员最该投资的，是一台专业的编程显示器"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-28T00:30:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="亿元程序员"/> <meta itemprop="url" content="https://juejin.cn/user/1972988307323236"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            做了十年游戏，我才意识到：程序员最该投资的，是一台专业的编程显示器
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1972988307323236/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    亿元程序员
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-28T00:30:48.000Z" title="Fri Nov 28 2025 00:30:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<blockquote>
<p>提升开发效率，从一台专业显示器开始</p>
</blockquote>
<p><strong>哈喽大家好</strong>，白驹过隙，转眼间我在游戏行业已经摸爬滚打了十年。从最初的学习<code>C++、Unity</code>到如今作为一个<code>Cocos</code>游戏开发分享博主，这一路上我使用过、优化过、推荐过许许多多能够提升开发效率的工具。</p>
<p><strong>今天</strong>，我想给小伙伴们分享一些我们提升开发效率的经验，特别是最近才入手的一款专业的编程显示器，彻底刷新了我对编码环境和显示器的认知。</p>
<h2 data-id="heading-1">因“眼花”造成的bug</h2>
<p><strong>不知道</strong>小伙伴们有没有遇到过，一些因为眼花造成的bug，排查了好久才找到问题，笔者刚好就碰到过一个，为此还特意修改了公司内部的编码规范，代码大概意思如下，看下小伙伴是否能发现问题：</p>
<pre><code class="hljs language-c++" lang="c++"><span class="hljs-type">int</span> flag = <span class="hljs-number">0</span>;
... 中间省略了一万行代码
<span class="hljs-keyword">if</span> (flag = <span class="hljs-number">1</span>) {
    console.<span class="hljs-built_in">log</span>(<span class="hljs-string">'A'</span>);
}
<span class="hljs-keyword">else</span> {
    console.<span class="hljs-built_in">log</span>(<span class="hljs-string">'B'</span>);
}
</code></pre>
<p><strong>这是</strong>咱们公司的一位小伙伴写的功能里面的一段代码，当时因为这个没审核出来，导致比较严重的线上事故。</p>
<p><strong>正确写法</strong>：</p>
<pre><code class="hljs language-c++" lang="c++"><span class="hljs-type">int</span> flag = <span class="hljs-number">0</span>;
... 中间省略了一万行代码
<span class="hljs-keyword">if</span> (<span class="hljs-number">1</span> == flag) {
    console.<span class="hljs-built_in">log</span>(<span class="hljs-string">'A'</span>);
}
<span class="hljs-keyword">else</span> {
    console.<span class="hljs-built_in">log</span>(<span class="hljs-string">'B'</span>);
}
</code></pre>
<p><strong>这里</strong>无论中间代码怎么变，都是输出<code>A</code>，永远走不到<code>B</code>,就因为这个事故，编码规范新增要求，常量在前，变量必须放在后面。</p>
<p><strong>其实</strong>在我们开发者生涯中，除了因为上面这个因为“<strong>代码区分度不够、代码清晰度不足</strong>”导致的bug问题，还有其他因长期编码造成对眼睛、脊椎等问题。</p>
<p><strong>为此</strong>，我们是否应该思考：除了要提升我们的编码能力，有没有必要优化我们的开发工具？</p>
<h2 data-id="heading-2">全球首款专业编程显示器</h2>
<p><strong>当我</strong>正不断思索如何解决因“眼花”造成的编码问题，正巧有朋友给我推荐了<strong>全球首款专业编程显示器：明基RD280U</strong>。</p>
<p><strong>当我</strong>第一次了解到这款专为编码人士打造的专业编程显示器时，我的好奇心被瞬间点燃，果断入手体验一番。</p>
<p><strong>作为</strong>全球首款针对开发者设计的显示器，它到底有何独特之处？</p>
<h2 data-id="heading-3">专业技能，直击痛点</h2>
<p><strong>为了</strong>能够深入了解它的独特之处，我主要从<strong>代码显示优化</strong>和<strong>多任务快捷开发</strong>两大方面去体验<strong>明基RD280U</strong>。</p>
<h3 data-id="heading-4">代码显示优化</h3>
<p><strong>1.专业的编程模式</strong></p>
<p><strong>当我</strong>看到“编程”模式的时候，第一反应就是想到我们的编码环境，于是我特意和它的普通模式做了对比。</p>
<p><strong>普通模式</strong>：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7b3b13ad916b424883a8c1409009576b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764894648&amp;x-signature=h20aIQr0Bep69jt%2F9eEk39sKi%2BA%3D" alt="cgi-bin_mmwebwx-bin_webwxgetmsgimg_&amp;MsgID=2375981365953758067&amp;skey=@crypt_d1ac8974_ee2d606e34333c7fa73315ce87238f59&amp;mmweb_appid=wx_webfilehelper.jfif" loading="lazy"/></p>
<p><strong>专业编程模式</strong>：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9123a17b318448c68e05ae2509069dda~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764894648&amp;x-signature=Fnq0%2F1Ll1rYvbKU75yYK72%2F2xSs%3D" alt="cgi-bin_mmwebwx-bin_webwxgetmsgimg_&amp;MsgID=7887604532474065961&amp;skey=@crypt_d1ac8974_ee2d606e34333c7fa73315ce87238f59&amp;mmweb_appid=wx_webfilehelper.jfif" loading="lazy"/></p>
<p><strong>不知道</strong>照片能不能表现出来，肉眼可见的地清晰，每一段代码都变得非常清晰、很容易辨别，而普通模式则有些许泛白感。</p>
<p><strong>2.抗反射面板</strong></p>
<p><strong>相信大家</strong>和笔者也过同样的感受，每到了晚上，要开灯工作的时候，由于家里的灯瓦数会比较高，当灯照在显示器上的时候，就会有很大的一层反光，这个时候又要调整显示器的角度，非常麻烦：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a32d1d63b1924e6287b9b1afe7354b55~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764894648&amp;x-signature=Eb4niIziCQ%2Fi4pl1BeBtpfosBts%3D" alt="" loading="lazy"/></p>
<p><strong>但是</strong>在<strong>明基RD280U</strong>中却根本看不到这种情况，可以说简直<strong>0眩光</strong>，这样不仅避免我在专注编码时被中断，而且代码更加清晰，真的是眼前一亮。</p>
<p><strong>3.28英寸横纵3:2大屏</strong></p>
<p><strong>当我</strong>刚拆箱第一眼看到<strong>明基RD280U</strong>的时候，真的是吓了一跳，第一次见到这么大的显示屏，足足28英寸，而且还是横纵比3:2的超级大屏。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1d95480c32bc43b9a9d7e5c58d0b2996~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764894648&amp;x-signature=e3iUHKG7UcKZ9BR8cLGwTfz42dw%3D" alt="" loading="lazy"/></p>
<p><strong>平时</strong>在公司代码显示不全，调试不方便，都要用一横一竖的屏幕才能勉强舒服一点，然而在<strong>明基RD280U</strong>完全可以节省一块屏幕，而且还自带桌面分区功能，真的非常方便。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/83e0b0a9fa29402684cd9cd12eb0e3b9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764894648&amp;x-signature=v0EW%2FIruBtaEtrObNvOub0Cktu8%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c37ce671194a43f5af9f3c7685b5e6e3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764894648&amp;x-signature=BlcnJ3P%2FyV35fIf3WDTS%2FNOYnQI%3D" alt="" loading="lazy"/></p>
<p><strong>4.深夜编码</strong></p>
<p><strong>这个</strong>真是为了我们程序员而打造的功能，要知道我们经常要熬夜发版本、赶需求，有时候回到家里还要深夜维护游戏，家里人都睡了，有时候避免家里人受影响，都不会开灯，虽然这样很伤眼睛，但是也没办法。</p>
<p><strong>明基RD280U</strong>自带的<code>Moonhalo智慧光环</code>，一下子就把我的书桌后面的“坑坑”填亮了！</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/68a54d1a424240fca90c201bbfcf9458~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764894648&amp;x-signature=HVoEe7BvkmlMykeIOIKfIpgshJM%3D" alt="" loading="lazy"/></p>
<p><strong>背后</strong>像月全食一样的设计，真的是惊艳到我了。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0265da5cd5ba45819a1f2ca37ad881f3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764894648&amp;x-signature=GtLNUAqa8hQL3%2B%2BX1lWFKkZljPI%3D" alt="" loading="lazy"/></p>
<p><strong>除了</strong>这个光环补光之外，它自带软件还有<strong>猫头鹰模式</strong>，真的是为了我们这群夜猫子设计的，如此贴心的夜间防护，打破亮度的限制，再深的夜也能够非常舒适地编码了。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/11381e06afd9457898be5cd5ca471a1b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764894648&amp;x-signature=Vg10vDLILwYv8Kehb0VvMaFOSvw%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-5">多任务快捷开发</h3>
<p><strong>1.多设备切换</strong></p>
<p><strong>作为</strong>一名全栈的程序员，工作内容往往不局限于前端、后端，还极有可能涉及讨论策划案、改改图甚至写写测试用例。</p>
<p><strong>平时</strong>开发都是用的台式电脑，等到需要打包、渲染的时候，需要用上Mac笔记本，操作非常不便捷。</p>
<p><strong>用了明基RD280U</strong>，只需要用Type-c就可以轻松连接显示器，并且可以快捷切换，省时省力，简直不要太爽。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a563b72c15d147e19353af2a159819d7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764894648&amp;x-signature=waX%2BzH1iA9EMloDW3YDldpylCs4%3D" alt="" loading="lazy"/></p>
<p><strong>2.编程定制</strong></p>
<p><strong>明基RD280U</strong>，还有个性感的“小下巴”：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9421e711d13f415fa1416542e584bbb1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764894648&amp;x-signature=MmZ6EzZ3jyBJR4JNYqfISFsMwF4%3D" alt="" loading="lazy"/></p>
<p><strong>有什么用</strong>？只需要轻轻触摸就可以快速切换不同的编程模式，触感非常地好：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d9ee798e57934708bcc150c8dd7ac00e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764894648&amp;x-signature=ZrNMVRWpdgsZxOzYY8O2uU5ht5I%3D" alt="" loading="lazy"/></p>
<p><strong>除此之外</strong>，下巴下面还有摇杆按钮，可以随心定制属于我自己的编程环境。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ba98343f340d45e7a4e0a69b8db08de2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764894648&amp;x-signature=vhwdr7JcOOgn2LN%2BNHUoDwcEsu0%3D" alt="" loading="lazy"/></p>
<p><strong>除了硬件</strong>，<strong>明基RD280U</strong>还配套了一个轻松便捷、简单上手的软件：</p>
<ul>
<li><strong>随心随意</strong>切换我的模式：UI界面十分精美。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6d2b7d48bcd9433cad609a9ed3dcf2de~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764894648&amp;x-signature=tRbXoNlQUIsdPQsU5cospbe00X4%3D" alt="" loading="lazy"/></li>
<li><strong>还可以</strong>设置键盘快捷切换信号和模式：很符合程序员的按键设定。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7530874d9cf844e19be5111cc02df8b1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764894648&amp;x-signature=kaWKTecxtAY%2BeTgUw67dYGJ9mlU%3D" alt="" loading="lazy"/></li>
<li><strong>小工具</strong>上还可以直接搜索，连时下热门的<code>GPT</code>都有，简直不要太贴心哈哈。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6c3fcb4a273b476dae2d646d20528312~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764894648&amp;x-signature=XX3RoUp3Fk8twu8WlvIbp85TsT8%3D" alt="" loading="lazy"/></li>
</ul>
<h2 data-id="heading-6">健康呵护，关注程序员的健康</h2>
<p><strong>花了1个小时</strong>体验完<strong>明基RD280U</strong>的专业功能，眼睛没有任何不适。</p>
<p><strong>相信</strong>小伙伴们都知道在护眼领域，明基一直都是佼佼者，它已经耕耘十余年。</p>
<p><strong>获得</strong>了五项德国莱茵的权威认证，就是它最好的底气：</p>
<ul>
<li><strong>硬件级滤蓝光</strong></li>
<li><strong>无频闪</strong></li>
<li><strong>眼部舒适度</strong></li>
<li><strong>eyesafe2.0</strong></li>
<li><strong>抗反射认证</strong></li>
</ul>
<p><strong>每一项</strong>都含金量十足。</p>
<h2 data-id="heading-7">结语</h2>
<p><strong>在游戏行业</strong>从业10年了，第一次用上如此专业的编程显示器，可以算得上功德圆满了。</p>
<p><strong>明基</strong>用专业方案和定制照护，助力每一个开发者，真如它所愿：“赋能开发者，共赢未来”。</p>
<p><strong>如果</strong>最近你也打算更换显示器，可以向你公司的老板或者家里的老板提个“建议”。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[《HelloGitHub》第 116 期]]></title>    <link>https://juejin.cn/post/7577256255083118601</link>    <guid>https://juejin.cn/post/7577256255083118601</guid>    <pubDate>2025-11-28T00:30:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577256255083118601" data-draft-id="7577222731790958618" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="《HelloGitHub》第 116 期"/> <meta itemprop="keywords" content="GitHub,开源"/> <meta itemprop="datePublished" content="2025-11-28T00:30:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="HelloGitHub"/> <meta itemprop="url" content="https://juejin.cn/user/1574156384091320"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            《HelloGitHub》第 116 期
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1574156384091320/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    HelloGitHub
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-28T00:30:09.000Z" title="Fri Nov 28 2025 00:30:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>兴趣是最好的老师，<strong>HelloGitHub</strong> 让你对开源感兴趣！</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/46f18554d0a944969543f369192afc61~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGVsbG9HaXRIdWI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764894608&amp;x-signature=3YrYOIFOPWaueBu8uSgjJ9JM7Ts%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-0">简介</h2>
<p><strong>HelloGitHub</strong> 分享 GitHub 上有趣、入门级的开源项目。</p>
<blockquote>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2F521xueweihan%2FHelloGitHub" target="_blank" title="https://github.com/521xueweihan/HelloGitHub" ref="nofollow noopener noreferrer">github.com/521xueweiha…</a></p>
</blockquote>
<p>这里有实战项目、入门教程、黑科技、开源书籍、大厂开源项目等，涵盖多种编程语言 Python、Java、Go、C/C++、Swift...让你在短时间内感受到开源的魅力，爱上开源！</p>
<hr/>
<blockquote>
<p>以下为本期内容｜每月 <strong>28</strong> 号更新</p>
</blockquote>
<h3 data-id="heading-1">C 项目</h3>
<p>1、<a href="https://link.juejin.cn?target=https%3A%2F%2Fhellogithub.com%2Fperiodical%2Fstatistics%2Fclick%3Ftarget%3Dhttps%3A%2F%2Fgithub.com%2Frxi%2Fsj.h" target="_blank" title="https://hellogithub.com/periodical/statistics/click?target=https://github.com/rxi/sj.h" ref="nofollow noopener noreferrer">sj.h</a>：极简的 C 语言 JSON 解析库。这是一个轻量级的 C 语言 JSON 解析库，提供可靠的 JSON 遍历和基础解析功能。它仅 150 行代码、无外部依赖，采用零内存分配策略，直接在原数据上进行解析，速度快且无内存泄漏风险，适用于嵌入式、物联网和游戏开发等场景。</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">char</span> *json_text = <span class="hljs-string">"{ \"x\": 10, \"y\": 20, \"w\": 30, \"h\": 40 }"</span>;

<span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> {</span> <span class="hljs-type">int</span> x, y, w, h; } Rect;

<span class="hljs-type">bool</span> <span class="hljs-title function_">eq</span><span class="hljs-params">(sj_Value val, <span class="hljs-type">char</span> *s)</span> {
    <span class="hljs-type">size_t</span> len = val.end - val.start;
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">strlen</span>(s) == len &amp;&amp; !<span class="hljs-built_in">memcmp</span>(s, val.start, len);
}

<span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> {
    Rect rect = {<span class="hljs-number">0</span>};

    sj_Reader r = sj_reader(json_text, <span class="hljs-built_in">strlen</span>(json_text));
    sj_Value obj = sj_read(&amp;r);

    sj_Value key, val;
    <span class="hljs-keyword">while</span> (sj_iter_object(&amp;r, obj, &amp;key, &amp;val)) {
        <span class="hljs-keyword">if</span> (eq(key, <span class="hljs-string">"x"</span>)) { rect.x = atoi(val.start); }
        <span class="hljs-keyword">if</span> (eq(key, <span class="hljs-string">"y"</span>)) { rect.y = atoi(val.start); }
        <span class="hljs-keyword">if</span> (eq(key, <span class="hljs-string">"w"</span>)) { rect.w = atoi(val.start); }
        <span class="hljs-keyword">if</span> (eq(key, <span class="hljs-string">"h"</span>)) { rect.h = atoi(val.start); }
    }

    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"rect: { %d, %d, %d, %d }\n"</span>, rect.x, rect.y, rect.w, rect.h);
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<h3 data-id="heading-2">C# 项目</h3>
<p>2、<a href="https://link.juejin.cn?target=https%3A%2F%2Fhellogithub.com%2Fperiodical%2Fstatistics%2Fclick%3Ftarget%3Dhttps%3A%2F%2Fgithub.com%2FSimonvBez%2FCPUSetSetter" target="_blank" title="https://hellogithub.com/periodical/statistics/click?target=https://github.com/SimonvBez/CPUSetSetter" ref="nofollow noopener noreferrer">CPUSetSetter</a>：手动指定运行游戏用的 CPU 核。该项目是专为 Windows 11 设计的性能优化工具，利用 CPU Sets 技术，让用户可以自由控制游戏和应用程序运行时使用的 CPU 核，全程无需重启程序。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c9b3729aaadb48ee9c8bd5c25f058ef9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGVsbG9HaXRIdWI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764894608&amp;x-signature=adC70pl6rboAkcgNP35fTnzBI9g%3D" alt="" loading="lazy"/></p>
<p>3、<a href="https://link.juejin.cn?target=https%3A%2F%2Fhellogithub.com%2Fperiodical%2Fstatistics%2Fclick%3Ftarget%3Dhttps%3A%2F%2Fgithub.com%2FRuben2776%2FPicView" target="_blank" title="https://hellogithub.com/periodical/statistics/click?target=https://github.com/Ruben2776/PicView" ref="nofollow noopener noreferrer">PicView</a>：比系统自带更好用的看图工具。这是一款快速、免费的图片查看工具，适用于 Windows 和 macOS 平台。它采用 .NET NativeAOT 编译技术，体积小、启动速度快，支持浏览长图、编辑图片、格式转换、批量处理等功能。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0995a907e5534588abb5e1d7ebe6ddfd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGVsbG9HaXRIdWI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764894608&amp;x-signature=JG%2BDJsar40JKf2BPZrP7k3RdF7U%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-3">C++ 项目</h3>
<p>4、<a href="https://link.juejin.cn?target=https%3A%2F%2Fhellogithub.com%2Fperiodical%2Fstatistics%2Fclick%3Ftarget%3Dhttps%3A%2F%2Fgithub.com%2Fkunkundi%2Fcrossdesk" target="_blank" title="https://hellogithub.com/periodical/statistics/click?target=https://github.com/kunkundi/crossdesk" ref="nofollow noopener noreferrer">crossdesk</a>：支持 Web 端的远程桌面工具。这是一款开源、轻量级的跨平台远程桌面工具，支持不同设备间（Windows、Linux 和 macOS）的远程桌面控制和音视频传输，特点是可直接通过浏览器控制远程设备，无需额外安装任何应用。来自 <a href="https://link.juejin.cn?target=https%3A%2F%2Fhellogithub.com%2Fuser%2Fcb0OpZRrBuGVAfL" target="_blank" title="https://hellogithub.com/user/cb0OpZRrBuGVAfL" ref="nofollow noopener noreferrer">@Junkun Di</a> 的分享</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/609d58a0b8df4dd1819239a643d7cd67~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGVsbG9HaXRIdWI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764894608&amp;x-signature=Ah0b9iGdKDVDXnrNX8aZxd5bEOc%3D" alt="" loading="lazy"/></p>
<p>5、<a href="https://link.juejin.cn?target=https%3A%2F%2Fhellogithub.com%2Fperiodical%2Fstatistics%2Fclick%3Ftarget%3Dhttps%3A%2F%2Fgithub.com%2FSeaEpoch%2FMouseClick" target="_blank" title="https://hellogithub.com/periodical/statistics/click?target=https://github.com/SeaEpoch/MouseClick" ref="nofollow noopener noreferrer">MouseClick</a>：开源的鼠标连点工具。这是一款基于 Qt6 构建的鼠标连点器，仅适用于 Windows 系统。它开箱即用、操作简单，支持自定义鼠标点击间隔和快捷键功能。来自 <a href="https://link.juejin.cn?target=https%3A%2F%2Fhellogithub.com%2Fuser%2F6aHSOczLEVNxDF7" target="_blank" title="https://hellogithub.com/user/6aHSOczLEVNxDF7" ref="nofollow noopener noreferrer">@SeaYJ</a> 的分享</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/268158df3a794beebaac5a3f81962303~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGVsbG9HaXRIdWI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764894608&amp;x-signature=Hfpx%2BDROvpeQVtLcIyq295F%2BD%2Bs%3D" alt="" loading="lazy"/></p>
<p>6、<a href="https://link.juejin.cn?target=https%3A%2F%2Fhellogithub.com%2Fperiodical%2Fstatistics%2Fclick%3Ftarget%3Dhttps%3A%2F%2Fgithub.com%2Fadmtrv%2Fobjcurses" target="_blank" title="https://hellogithub.com/periodical/statistics/click?target=https://github.com/admtrv/objcurses" ref="nofollow noopener noreferrer">objcurses</a>：命令行查看 3D 模型的工具。这是一款极简的 3D 模型查看器，能够将 3D 模型文件以 ASCII 字符方式渲染展示在终端里，支持 3D 对象的实时预览、旋转和交互操作。来自 <a href="https://link.juejin.cn?target=https%3A%2F%2Fhellogithub.com%2Fuser%2FQwmfN9cuvYja4b3" target="_blank" title="https://hellogithub.com/user/QwmfN9cuvYja4b3" ref="nofollow noopener noreferrer">@CN1998Ft</a> 的分享</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a2d67fc53fd046a1a2ba10cd99737e73~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGVsbG9HaXRIdWI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764894608&amp;x-signature=lSQq0XgL1RLrGii1VsUqlhOWVpY%3D" alt="" loading="lazy"/></p>
<p>7、<a href="https://link.juejin.cn?target=https%3A%2F%2Fhellogithub.com%2Fperiodical%2Fstatistics%2Fclick%3Ftarget%3Dhttps%3A%2F%2Fgithub.com%2Foceanbase%2Fseekdb" target="_blank" title="https://hellogithub.com/periodical/statistics/click?target=https://github.com/oceanbase/seekdb" ref="nofollow noopener noreferrer">seekdb</a>：开箱即用的轻量级向量数据库。该项目是 OceanBase 团队开源的一款轻量级 AI 原生搜索数据库，支持关系型、向量和文本数据的统一存储与检索。它提供嵌入式和服务器两种模式，最低仅需 1C1G 即可运行，并兼容 MySQL 协议。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/54dd252703f648b883ddc7e0772763ec~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGVsbG9HaXRIdWI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764894608&amp;x-signature=VtjByuPpKhT0a%2FHXRVOEzCTrsXg%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-4">Go 项目</h3>
<p>8、<a href="https://link.juejin.cn?target=https%3A%2F%2Fhellogithub.com%2Fperiodical%2Fstatistics%2Fclick%3Ftarget%3Dhttps%3A%2F%2Fgithub.com%2Fgtsteffaniak%2Ffilebrowser" target="_blank" title="https://hellogithub.com/periodical/statistics/click?target=https://github.com/gtsteffaniak/filebrowser" ref="nofollow noopener noreferrer">filebrowser</a>：完全开源可自托管的私有云盘。该项目是基于 Go+Vue.js 构建的在线文件管理工具，功能比原版 FileBrowser 更丰富，支持多文件源（本地或云）、目录级访问控制、设置共享过期时间、文件搜索和缩略图等功能。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f54bbea9adb0451fb0b70ad4d0ed466f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGVsbG9HaXRIdWI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764894608&amp;x-signature=JEJaDuRllWKc4zmR3FBj1NGUU%2Bw%3D" alt="" loading="lazy"/></p>
<p>9、<a href="https://link.juejin.cn?target=https%3A%2F%2Fhellogithub.com%2Fperiodical%2Fstatistics%2Fclick%3Ftarget%3Dhttps%3A%2F%2Fgithub.com%2Fzxh326%2Fkite" target="_blank" title="https://hellogithub.com/periodical/statistics/click?target=https://github.com/zxh326/kite" ref="nofollow noopener noreferrer">kite</a>：开源的轻量级 K8s 管理面板。这是一款轻量级、现代化的 Kubernetes 可视化管理平台，适用于管理和监控 K8s 集群。它拥有直观易用的界面，支持查看 Pod 日志、执行容器命令、编辑 YAML 配置、管理用户权限等功能。来自 <a href="https://link.juejin.cn?target=https%3A%2F%2Fhellogithub.com%2Fuser%2Fw5uk718RFhDzdCX" target="_blank" title="https://hellogithub.com/user/w5uk718RFhDzdCX" ref="nofollow noopener noreferrer">@Zzde</a> 的分享</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8c6cb590dc724208a28de9cfca9d8b23~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGVsbG9HaXRIdWI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764894608&amp;x-signature=schN641g0NCV8%2B5YC9AP%2BhCM%2BAw%3D" alt="" loading="lazy"/></p>
<p>10、<a href="https://link.juejin.cn?target=https%3A%2F%2Fhellogithub.com%2Fperiodical%2Fstatistics%2Fclick%3Ftarget%3Dhttps%3A%2F%2Fgithub.com%2Fmmulet%2Fterm.everything" target="_blank" title="https://hellogithub.com/periodical/statistics/click?target=https://github.com/mmulet/term.everything" ref="nofollow noopener noreferrer">term.everything</a>：终端里运行任意 GUI 应用。该项目突破了传统终端只能运行命令行程序的限制，让用户能够在终端（Terminal）中运行任意 GUI 应用程序，将图形界面的操作体验带入终端环境。它通过自研的 Wayland 合成器，将原本输出到显示器的 GUI 窗口实时渲染为终端可显示的字符或图片，实现了在终端内运行图形应用的能力，兼容 iTerm2、Alacritty、Kitty 等主流终端模拟器。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5644b93d48d24d21a106619ffe0d4820~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGVsbG9HaXRIdWI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764894608&amp;x-signature=UWcmHIQvNvZQcdXKJGWWcXGvmDQ%3D" alt="" loading="lazy"/></p>
<p>11、<a href="https://link.juejin.cn?target=https%3A%2F%2Fhellogithub.com%2Fperiodical%2Fstatistics%2Fclick%3Ftarget%3Dhttps%3A%2F%2Fgithub.com%2FGaurav-Gosain%2Ftuios" target="_blank" title="https://hellogithub.com/periodical/statistics/click?target=https://github.com/Gaurav-Gosain/tuios" ref="nofollow noopener noreferrer">tuios</a>：终端内实现桌面级窗口管理。这是一个 Go 编写的终端多窗口管理工具，支持浮动窗口、鼠标拖拽、自动平铺、多工作区切换等功能。窗口可以自由重叠和移动，像桌面操作系统一样，适合觉得 tmux 快捷键难记的开发者。来自 <a href="https://link.juejin.cn?target=https%3A%2F%2Fhellogithub.com%2Fuser%2Fgf67BzSc528eYP9" target="_blank" title="https://hellogithub.com/user/gf67BzSc528eYP9" ref="nofollow noopener noreferrer">@天涯孤雁</a> 的分享</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/42b4985dcb3b4ff486df598033329f35~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGVsbG9HaXRIdWI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764894608&amp;x-signature=A33pd%2BRghUqYu33o4YomzZBhyPU%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-5">Java 项目</h3>
<p>12、<a href="https://link.juejin.cn?target=https%3A%2F%2Fhellogithub.com%2Fperiodical%2Fstatistics%2Fclick%3Ftarget%3Dhttps%3A%2F%2Fgithub.com%2F1Panel-dev%2FCordysCRM" target="_blank" title="https://hellogithub.com/periodical/statistics/click?target=https://github.com/1Panel-dev/CordysCRM" ref="nofollow noopener noreferrer">CordysCRM</a>：新一代客户关系管理系统。这是一款基于 Spring Boot 和 Vue.js 构建的 CRM（客户关系管理）平台，支持线索获取、商机跟进、合同签约等功能，并可通过集成 SQLBot 和 MaxKB 实现 AI 加持。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0f38efacd9534a71aa5c12ce79e6b83a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGVsbG9HaXRIdWI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764894608&amp;x-signature=zcSeleB6FfK2aPTXZjkxHBVTR84%3D" alt="" loading="lazy"/></p>
<p>13、<a href="https://link.juejin.cn?target=https%3A%2F%2Fhellogithub.com%2Fperiodical%2Fstatistics%2Fclick%3Ftarget%3Dhttps%3A%2F%2Fgithub.com%2Fdedicatedcode%2Freitti" target="_blank" title="https://hellogithub.com/periodical/statistics/click?target=https://github.com/dedicatedcode/reitti" ref="nofollow noopener noreferrer">reitti</a>：Java 开发的个人足迹分析平台。这是一款基于 Spring Boot 和 PostGIS 构建的个人位置追踪与分析平台，适用于记录自己的行动轨迹和地理位置信息。支持自动识别停留地点、分析出行路线、判断交通方式，并以时间轴+地图的方式展示。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8061f01fd76a48e19442ef593831ab1d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGVsbG9HaXRIdWI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764894608&amp;x-signature=Bfr0WtRJVVs8xeCwiw0l88aDOfY%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-6">JavaScript 项目</h3>
<p>14、<a href="https://link.juejin.cn?target=https%3A%2F%2Fhellogithub.com%2Fperiodical%2Fstatistics%2Fclick%3Ftarget%3Dhttps%3A%2F%2Fgithub.com%2FCesiumGS%2Fcesium" target="_blank" title="https://hellogithub.com/periodical/statistics/click?target=https://github.com/CesiumGS/cesium" ref="nofollow noopener noreferrer">cesium</a>：3D 地理空间的 JavaScript 库。该项目是用于在 Web 网页中创建交互式 3D 地球和 2D 地图的 JavaScript 库，它利用了 WebGL 技术来加速图形处理，具备较好的渲染速度，可处理海量数据和动态数据可视化，支持地形和三维瓦片（3D Tiles）等多种数据格式，适用于构建地理信息系统（GIS）等 Web 应用。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Viewer</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"cesium"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">"cesium/Build/Cesium/Widgets/widgets.css"</span>;

<span class="hljs-keyword">const</span> viewer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Viewer</span>(<span class="hljs-string">"cesiumContainer"</span>);
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f1ce0686a00b4258bc476e877142bafe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGVsbG9HaXRIdWI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764894608&amp;x-signature=Ab%2B2b0DZENX%2Fmzo%2BXlMYzrZI4VM%3D" alt="" loading="lazy"/></p>
<p>15、<a href="https://link.juejin.cn?target=https%3A%2F%2Fhellogithub.com%2Fperiodical%2Fstatistics%2Fclick%3Ftarget%3Dhttps%3A%2F%2Fgithub.com%2Fjosdejong%2Fjsonrepair" target="_blank" title="https://hellogithub.com/periodical/statistics/click?target=https://github.com/josdejong/jsonrepair" ref="nofollow noopener noreferrer">jsonrepair</a>：自动兼容错误 JSON 格式的 JavaScript 库。这是一个用于修复/解析多种错误 JSON 格式的 JavaScript 库，与 JSON.parse() 遇到格式错误直接抛出异常不同。它可以自动处理常见的 JSON 格式问题，如键名缺失引号、单引号代替双引号、尾部多余逗号、缺失逗号和换行符不规范等。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { jsonrepair } <span class="hljs-keyword">from</span> <span class="hljs-string">'jsonrepair'</span>

<span class="hljs-keyword">try</span> {
  <span class="hljs-comment">// The following is invalid JSON: is consists of JSON contents copied from </span>
  <span class="hljs-comment">// a JavaScript code base, where the keys are missing double quotes, </span>
  <span class="hljs-comment">// and strings are using single quotes:</span>
  <span class="hljs-keyword">const</span> json = <span class="hljs-string">"{name: 'John'}"</span>
  
  <span class="hljs-keyword">const</span> repaired = <span class="hljs-title function_">jsonrepair</span>(json)
  
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(repaired) <span class="hljs-comment">// '{"name": "John"}'</span>
} <span class="hljs-keyword">catch</span> (err) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(err)
}
</code></pre>
<p>16、<a href="https://link.juejin.cn?target=https%3A%2F%2Fhellogithub.com%2Fperiodical%2Fstatistics%2Fclick%3Ftarget%3Dhttps%3A%2F%2Fgithub.com%2FLOG1997%2Flog-lottery" target="_blank" title="https://hellogithub.com/periodical/statistics/click?target=https://github.com/LOG1997/log-lottery" ref="nofollow noopener noreferrer">log-lottery</a>：炫酷 3D 球体年会抽奖应用。这是一个基于 Three.js 和 Vue.js 构建的年会抽奖工具，支持导入人员名单、设置奖品/奖项、播放背景音乐、临时抽奖等功能。来自 <a href="https://link.juejin.cn?target=https%3A%2F%2Fhellogithub.com%2Fuser%2FEQPvVCA9NTGfnoR" target="_blank" title="https://hellogithub.com/user/EQPvVCA9NTGfnoR" ref="nofollow noopener noreferrer">@1：</a> 的分享</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/df9671e885184cfea766380094bc4c90~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGVsbG9HaXRIdWI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764894608&amp;x-signature=geUrGW6P1Uqc18i2ZOqpHXdCm9k%3D" alt="" loading="lazy"/></p>
<p>17、<a href="https://link.juejin.cn?target=https%3A%2F%2Fhellogithub.com%2Fperiodical%2Fstatistics%2Fclick%3Ftarget%3Dhttps%3A%2F%2Fgithub.com%2Fsiddharthvaddem%2Fopenscreen" target="_blank" title="https://hellogithub.com/periodical/statistics/click?target=https://github.com/siddharthvaddem/openscreen" ref="nofollow noopener noreferrer">openscreen</a>：免费开源的屏幕录制工具。这是一款免费且开源的屏幕录制工具，可作为 Screen Studio 的轻量级替代品，支持应用录制、修改背景、自定义缩放时长等功能，适用于 Windows 和 macOS 系统。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/847e40350ff74ddc93b9e03a9fe29f6d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGVsbG9HaXRIdWI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764894608&amp;x-signature=acLU2NefmrJX3EYJoeUuZawAvp4%3D" alt="" loading="lazy"/></p>
<p>18、<a href="https://link.juejin.cn?target=https%3A%2F%2Fhellogithub.com%2Fperiodical%2Fstatistics%2Fclick%3Ftarget%3Dhttps%3A%2F%2Fgithub.com%2Ffacebook%2Fstylex" target="_blank" title="https://hellogithub.com/periodical/statistics/click?target=https://github.com/facebook/stylex" ref="nofollow noopener noreferrer">stylex</a>：易扩展的 CSS-in-JS 解决方案。该项目是 Meta 开源的 CSS-in-JS 库，支持在 JavaScript 中定义样式，并在编译时自动优化和提取为独立的 CSS 文件，不仅消除运行时的性能开销，还能彻底避免样式冲突。来自 <a href="https://link.juejin.cn?target=https%3A%2F%2Fhellogithub.com%2Fuser%2FeK0Bv1dmJPxnrwy" target="_blank" title="https://hellogithub.com/user/eK0Bv1dmJPxnrwy" ref="nofollow noopener noreferrer">@IZRINO</a> 的分享</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> stylex <span class="hljs-keyword">from</span> <span class="hljs-string">'@stylexjs/stylex'</span>;

<span class="hljs-keyword">const</span> styles = stylex.<span class="hljs-title function_">create</span>({
  <span class="hljs-attr">root</span>: {
    <span class="hljs-attr">padding</span>: <span class="hljs-number">10</span>,
  },
  <span class="hljs-attr">element</span>: {
    <span class="hljs-attr">backgroundColor</span>: <span class="hljs-string">'red'</span>,
  },
});

<span class="hljs-keyword">const</span> styleProps = stylex.<span class="hljs-title function_">props</span>(styles.<span class="hljs-property">root</span>, styles.<span class="hljs-property">element</span>);
</code></pre>
<h3 data-id="heading-7">Kotlin 项目</h3>
<p>19、<a href="https://link.juejin.cn?target=https%3A%2F%2Fhellogithub.com%2Fperiodical%2Fstatistics%2Fclick%3Ftarget%3Dhttps%3A%2F%2Fgithub.com%2Fkavishdevar%2Flibrepods" target="_blank" title="https://hellogithub.com/periodical/statistics/click?target=https://github.com/kavishdevar/librepods" ref="nofollow noopener noreferrer">librepods</a>：让 AirPods 在安卓设备满血复活。该项目能够让用户在 Android 设备上使用 AirPods Pro/Max 的高级功能，包括主动降噪切换、入耳检测、头部姿势控制、对话感知等，但需要 Root 权限并配合 Xposed 使用。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c4737c77e943421fbd21e1161c5a609f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGVsbG9HaXRIdWI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764894608&amp;x-signature=jc5rZr18h%2FTAfhoPbksfP2j5bEw%3D" alt="" loading="lazy"/></p>
<p>20、<a href="https://link.juejin.cn?target=https%3A%2F%2Fhellogithub.com%2Fperiodical%2Fstatistics%2Fclick%3Ftarget%3Dhttps%3A%2F%2Fgithub.com%2FTosencen%2FXMSLEEP" target="_blank" title="https://hellogithub.com/periodical/statistics/click?target=https://github.com/Tosencen/XMSLEEP" ref="nofollow noopener noreferrer">XMSLEEP</a>：开源的 Android 白噪音应用。这是一个专注于白噪音播放的 Android 应用，提供雨声、篝火、雷声、猫咪呼噜、鸟鸣、夜虫等多种自然声音，帮助你放松、冥想和入睡。来自 <a href="https://link.juejin.cn?target=https%3A%2F%2Fhellogithub.com%2Fuser%2FGxvd2eIyHm54S9p" target="_blank" title="https://hellogithub.com/user/Gxvd2eIyHm54S9p" ref="nofollow noopener noreferrer">@Tosencen</a> 的分享</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7aa13f3a65a148569e6b382462006b95~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGVsbG9HaXRIdWI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764894608&amp;x-signature=JZl4FNWisMgwVGWuxtRymv6XML0%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-8">PHP 项目</h3>
<p>21、<a href="https://link.juejin.cn?target=https%3A%2F%2Fhellogithub.com%2Fperiodical%2Fstatistics%2Fclick%3Ftarget%3Dhttps%3A%2F%2Fgithub.com%2Fellite%2FWallos" target="_blank" title="https://hellogithub.com/periodical/statistics/click?target=https://github.com/ellite/Wallos" ref="nofollow noopener noreferrer">Wallos</a>：开源的个人订阅管理平台。这是一款 PHP 开发的自托管个人订阅管理平台，可直观展示所有订阅的服务名称、价格、支付周期（月/年/周等）和距离下次付款的剩余天数，支持多种通知方式和统计分析。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b86ad0370b4649c8b03f509a3e3ac601~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGVsbG9HaXRIdWI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764894608&amp;x-signature=8g7mjdSdd3Iuf1vyjNeh0G7ia8Y%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-9">Python 项目</h3>
<p>22、<a href="https://link.juejin.cn?target=https%3A%2F%2Fhellogithub.com%2Fperiodical%2Fstatistics%2Fclick%3Ftarget%3Dhttps%3A%2F%2Fgithub.com%2Fzhanymkanov%2Ffastapi-best-practices" target="_blank" title="https://hellogithub.com/periodical/statistics/click?target=https://github.com/zhanymkanov/fastapi-best-practices" ref="nofollow noopener noreferrer">fastapi-best-practices</a>：FastAPI 最佳实践指南。这是一份作者在初创公司多年使用 FastAPI 开发应用的实战经验总结，内容涵盖项目结构、异步、Pydantic、Depends、数据迁移等方面。</p>
<p>23、<a href="https://link.juejin.cn?target=https%3A%2F%2Fhellogithub.com%2Fperiodical%2Fstatistics%2Fclick%3Ftarget%3Dhttps%3A%2F%2Fgithub.com%2Fmalmeloo%2FFindMy.py" target="_blank" title="https://hellogithub.com/periodical/statistics/click?target=https://github.com/malmeloo/FindMy.py" ref="nofollow noopener noreferrer">FindMy.py</a>：玩转 Find My 网络的 Python 库。这是一个用于查询 Apple Find My 网络的 Python 库，让开发者使用 Python 代码获取 AirTag、iPhone、iPad 等官方设备以及自制 AirTag 的实时位置信息。</p>
<p>24、<a href="https://link.juejin.cn?target=https%3A%2F%2Fhellogithub.com%2Fperiodical%2Fstatistics%2Fclick%3Ftarget%3Dhttps%3A%2F%2Fgithub.com%2Flocalstack%2Flocalstack" target="_blank" title="https://hellogithub.com/periodical/statistics/click?target=https://github.com/localstack/localstack" ref="nofollow noopener noreferrer">localstack</a>：本地模拟 AWS 云服务。这是一个功能齐全的本地 AWS 云服务模拟框架，支持 Lambda、S3、DynamoDB、Kinesis、SQS、SNS、API Gateway 等服务。只需一条命令，即可在本地启动完整的 AWS 服务环境，解决了开发和调试过程中依赖 AWS 账户和服务的痛点。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1f6ff35da7fb4ece8b6b3af86ab6709c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGVsbG9HaXRIdWI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764894608&amp;x-signature=QTMNXkrLkpGF5RNjrtdi%2Br9HdxA%3D" alt="" loading="lazy"/></p>
<p>25、<a href="https://link.juejin.cn?target=https%3A%2F%2Fhellogithub.com%2Fperiodical%2Fstatistics%2Fclick%3Ftarget%3Dhttps%3A%2F%2Fgithub.com%2FAtsushiSakai%2FPythonRobotics" target="_blank" title="https://hellogithub.com/periodical/statistics/click?target=https://github.com/AtsushiSakai/PythonRobotics" ref="nofollow noopener noreferrer">PythonRobotics</a>：机器人算法 Python 实现集合。该项目汇集了机器人领域算法的 Python 实现，涵盖定位、SLAM、路径规划、空中导航、机械臂、双足机器人等技术，并提供示例代码和可视化演示。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/96aa18fafce7426aae5301abccb37977~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGVsbG9HaXRIdWI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764894608&amp;x-signature=fXqeT58hYHqqHBrw4RbgB0ZiHbE%3D" alt="" loading="lazy"/></p>
<p>26、<a href="https://link.juejin.cn?target=https%3A%2F%2Fhellogithub.com%2Fperiodical%2Fstatistics%2Fclick%3Ftarget%3Dhttps%3A%2F%2Fgithub.com%2Fsql-hkr%2Ftiny8" target="_blank" title="https://hellogithub.com/periodical/statistics/click?target=https://github.com/sql-hkr/tiny8" ref="nofollow noopener noreferrer">tiny8</a>：纯 Python 实现的 CPU 模拟器。该项目是 Python 写的轻量级 8 位 CPU 模拟器，能够将抽象的汇编语言执行过程转化为可视化、可交互的学习体验，并支持将代码执行过程导出为 GIF 或 MP4，适用于《计算机组成原理》或《汇编语言》课程的教学与学习。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> tiny8 <span class="hljs-keyword">import</span> CPU, assemble_file

asm = assemble_file(<span class="hljs-string">"fibonacci.asm"</span>)
cpu = CPU()
cpu.load_program(asm)
cpu.run(max_steps=<span class="hljs-number">1000</span>)

<span class="hljs-built_in">print</span>(<span class="hljs-string">f"Result: R17 = <span class="hljs-subst">{cpu.read_reg(<span class="hljs-number">17</span>)}</span>"</span>)  <span class="hljs-comment"># Final Fibonacci number</span>
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5801215474384f49b49e357d2729b8de~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGVsbG9HaXRIdWI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764894608&amp;x-signature=%2BpQuOp92IjbNn6ND1P6uILd%2FEo4%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-10">Rust 项目</h3>
<p>27、<a href="https://link.juejin.cn?target=https%3A%2F%2Fhellogithub.com%2Fperiodical%2Fstatistics%2Fclick%3Ftarget%3Dhttps%3A%2F%2Fgithub.com%2Funhappychoice%2Fgitlogue" target="_blank" title="https://hellogithub.com/periodical/statistics/click?target=https://github.com/unhappychoice/gitlogue" ref="nofollow noopener noreferrer">gitlogue</a>：回放你的 Git 提交历史。这是一个能够将 Git 提交历史转化为动画的命令行工具，通过打字动画和代码高亮，在终端里生动展示每一次变更。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/16b77b51c403425fa1528b5ed5d45b8e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGVsbG9HaXRIdWI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764894608&amp;x-signature=mQUqjIwozVkOXzq1jLP0X3Dz%2Fbs%3D" alt="" loading="lazy"/></p>
<p>28、<a href="https://link.juejin.cn?target=https%3A%2F%2Fhellogithub.com%2Fperiodical%2Fstatistics%2Fclick%3Ftarget%3Dhttps%3A%2F%2Fgithub.com%2Fmedialab%2Fxan" target="_blank" title="https://hellogithub.com/periodical/statistics/click?target=https://github.com/medialab/xan" ref="nofollow noopener noreferrer">xan</a>：终端里的 CSV 数据魔术师。这是一个能够处理 GB 级超大 CSV 文件的命令行工具，支持预览、过滤、切片、聚合、排序等操作，并可在终端里通过直方图、热力图等方式进行数据可视化。来自 <a href="https://link.juejin.cn?target=https%3A%2F%2Fhellogithub.com%2Fuser%2FZWJkOqsvYbPgD8p" target="_blank" title="https://hellogithub.com/user/ZWJkOqsvYbPgD8p" ref="nofollow noopener noreferrer">@DeShuiYu</a> 的分享</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ad4d4577a50c460ca76511a1d046af4c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGVsbG9HaXRIdWI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764894608&amp;x-signature=szQE%2FkMzpKiRhtMjl9jPY7DNpFg%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-11">Swift 项目</h3>
<p>29、<a href="https://link.juejin.cn?target=https%3A%2F%2Fhellogithub.com%2Fperiodical%2Fstatistics%2Fclick%3Ftarget%3Dhttps%3A%2F%2Fgithub.com%2Fkushalpandya%2FPetrichor" target="_blank" title="https://hellogithub.com/periodical/statistics/click?target=https://github.com/kushalpandya/Petrichor" ref="nofollow noopener noreferrer">Petrichor</a>：优雅的 macOS 本地音乐播放器。这是一款用 Swift 精心设计的 macOS 本地音乐播放器，支持 MP3、FLAC、DSD 等主流及无损音频格式。它专注于离线场景、界面清爽，为你带来纯粹的音乐播放体验。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f531546f7b914831bac6bddc2d833547~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGVsbG9HaXRIdWI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764894608&amp;x-signature=ChYQNplzZETaGzChIP4vMrbFSuo%3D" alt="" loading="lazy"/></p>
<p>30、<a href="https://link.juejin.cn?target=https%3A%2F%2Fhellogithub.com%2Fperiodical%2Fstatistics%2Fclick%3Ftarget%3Dhttps%3A%2F%2Fgithub.com%2FBrkgng%2FScrollSnap" target="_blank" title="https://hellogithub.com/periodical/statistics/click?target=https://github.com/Brkgng/ScrollSnap" ref="nofollow noopener noreferrer">ScrollSnap</a>：Mac 滚动截图工具。这是一款用于解决 macOS 原生截图功能，不支持滚动截图的工具。只需要框选指定区域，然后滚动页面，即可轻松得到完整的长截图。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/78326befae3342ffb4bc42a58201947e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGVsbG9HaXRIdWI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764894608&amp;x-signature=LREGNfuacrJNO6MYCSgkidLyTeA%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-12">人工智能</h3>
<p>31、<a href="https://link.juejin.cn?target=https%3A%2F%2Fhellogithub.com%2Fperiodical%2Fstatistics%2Fclick%3Ftarget%3Dhttps%3A%2F%2Fgithub.com%2Ftopoteretes%2Fcognee" target="_blank" title="https://hellogithub.com/periodical/statistics/click?target=https://github.com/topoteretes/cognee" ref="nofollow noopener noreferrer">cognee</a>：开箱即用的智能体记忆引擎。这是一个专为 AI 智能体（Agents）提供记忆功能的 Python 项目，集成了图数据库、知识图谱及向量数据库等技术。它仅需 5 行代码，即可轻松为 AI 智能体提供持久化、多模态记忆，支持连接和检索过去的对话、文档、图像和音频转录等内容。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> cognee
<span class="hljs-keyword">import</span> asyncio


<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():
    <span class="hljs-comment"># Add text to cognee</span>
    <span class="hljs-keyword">await</span> cognee.add(<span class="hljs-string">"Natural language processing (NLP) is an interdisciplinary subfield of computer science and information retrieval."</span>)

    <span class="hljs-comment"># Generate the knowledge graph</span>
    <span class="hljs-keyword">await</span> cognee.cognify()

    <span class="hljs-comment"># Query the knowledge graph</span>
    results = <span class="hljs-keyword">await</span> cognee.search(<span class="hljs-string">"Tell me about NLP"</span>)

    <span class="hljs-comment"># Display the results</span>
    <span class="hljs-keyword">for</span> result <span class="hljs-keyword">in</span> results:
        <span class="hljs-built_in">print</span>(result)


<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:
    asyncio.run(main())
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/654ca6d7a65f4e7381deddb1dec8da6b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGVsbG9HaXRIdWI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764894608&amp;x-signature=GFwchJz6T2BxjUxpCizZZCqQ9oM%3D" alt="" loading="lazy"/></p>
<p>32、<a href="https://link.juejin.cn?target=https%3A%2F%2Fhellogithub.com%2Fperiodical%2Fstatistics%2Fclick%3Ftarget%3Dhttps%3A%2F%2Fgithub.com%2Fdroidrun%2Fdroidrun" target="_blank" title="https://hellogithub.com/periodical/statistics/click?target=https://github.com/droidrun/droidrun" ref="nofollow noopener noreferrer">droidrun</a>：用自然语言操控你的手机。这是一个基于 LLM Agents 的手机自动化框架，可通过自然语言操控 Android 设备或模拟器，支持 DeepSeek、OpenAI、Gemini 等主流大模型。使用时需要在手机上安装 DroidRun Portal，用来收集 UI 信息并执行操作命令，然后通过 ADB 将信息传给电脑上的 DroidRun 框架，由它与 LLM 交互并给出执行指令。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/755512fc66dc411abd2edc78660b904d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGVsbG9HaXRIdWI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764894608&amp;x-signature=Fk%2Bgk6iRceWfoaUMe7xUIQDwOhE%3D" alt="" loading="lazy"/></p>
<p>33、<a href="https://link.juejin.cn?target=https%3A%2F%2Fhellogithub.com%2Fperiodical%2Fstatistics%2Fclick%3Ftarget%3Dhttps%3A%2F%2Fgithub.com%2FDearVa%2FEverywhere" target="_blank" title="https://hellogithub.com/periodical/statistics/click?target=https://github.com/DearVa/Everywhere" ref="nofollow noopener noreferrer">Everywhere</a>：随手可用的 AI 桌面助手。这是一款基于上下文感知的桌面 AI 助手，能够自动获取并理解当前屏幕上的内容，无需截图、复制内容或切换应用。只需一键即可召唤出 AI，进行问答、翻译、答疑等任务。来自 <a href="https://link.juejin.cn?target=https%3A%2F%2Fhellogithub.com%2Fuser%2FLNYEf6O9Qv5JeR2" target="_blank" title="https://hellogithub.com/user/LNYEf6O9Qv5JeR2" ref="nofollow noopener noreferrer">@Dear.Va</a> 的分享</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bb9f5952a96348fe94305ab42defaa75~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGVsbG9HaXRIdWI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764894608&amp;x-signature=fn1rzNGpwx9LoW7fOMCddQYNGtA%3D" alt="" loading="lazy"/></p>
<p>34、<a href="https://link.juejin.cn?target=https%3A%2F%2Fhellogithub.com%2Fperiodical%2Fstatistics%2Fclick%3Ftarget%3Dhttps%3A%2F%2Fgithub.com%2Ffastrepl%2Fhyprnote" target="_blank" title="https://hellogithub.com/periodical/statistics/click?target=https://github.com/fastrepl/hyprnote" ref="nofollow noopener noreferrer">hyprnote</a>：本地优先的 AI 笔记和会议助手。这是一款可离线运行的 AI 智能笔记和会议记录应用，通过接入 Ollama 可实现语音转录到摘要生成全程在本地完成，支持会议录音、实时转录、笔记整理和智能摘要等功能。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b0b4e154930f4d4186fd2473b7cfb0f5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGVsbG9HaXRIdWI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764894608&amp;x-signature=sW6DXldg4nGk07e9YzP9W87d%2BJE%3D" alt="" loading="lazy"/></p>
<p>35、<a href="https://link.juejin.cn?target=https%3A%2F%2Fhellogithub.com%2Fperiodical%2Fstatistics%2Fclick%3Ftarget%3Dhttps%3A%2F%2Fgithub.com%2FDayuanJiang%2Fnext-ai-draw-io" target="_blank" title="https://hellogithub.com/periodical/statistics/click?target=https://github.com/DayuanJiang/next-ai-draw-io" ref="nofollow noopener noreferrer">next-ai-draw-io</a>：让 AI 替你画架构图。这是一个基于 Next.js 构建的 Web 应用，融合了 AI 与 draw.io 图表绘制能力。现在你可以通过对话直接生成、编辑、优化流程图和架构图，支持流动效果连线、截图复刻、历史版本等功能。来自 <a href="https://link.juejin.cn?target=https%3A%2F%2Fhellogithub.com%2Fuser%2FFzr3vHc5AxqYUVj" target="_blank" title="https://hellogithub.com/user/Fzr3vHc5AxqYUVj" ref="nofollow noopener noreferrer">@喜BFoCE</a> 的分享</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7d96c2b0c30a4b71848b016b901fa891~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGVsbG9HaXRIdWI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764894608&amp;x-signature=58GFBV6Tf8Fqyt3yIPS%2FysR4PU4%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-13">其它</h3>
<p>36、<a href="https://link.juejin.cn?target=https%3A%2F%2Fhellogithub.com%2Fperiodical%2Fstatistics%2Fclick%3Ftarget%3Dhttps%3A%2F%2Fgithub.com%2Fattogram%2Fbash-screensavers" target="_blank" title="https://hellogithub.com/periodical/statistics/click?target=https://github.com/attogram/bash-screensavers" ref="nofollow noopener noreferrer">bash-screensavers</a>：黑客风格终端屏保合集。该项目提供 12 个有趣的命令行 ASCII 动画，包括经典矩阵代码雨、无限管道迷宫、烟花等。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7fa9342581c84abb91fa9257686ffebf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGVsbG9HaXRIdWI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764894608&amp;x-signature=ru1jf29nAvMDVNY%2FGfZZBi5Rgek%3D" alt="" loading="lazy"/></p>
<p>37、<a href="https://link.juejin.cn?target=https%3A%2F%2Fhellogithub.com%2Fperiodical%2Fstatistics%2Fclick%3Ftarget%3Dhttps%3A%2F%2Fgithub.com%2Ffrancescopace%2Fespectre" target="_blank" title="https://hellogithub.com/periodical/statistics/click?target=https://github.com/francescopace/espectre" ref="nofollow noopener noreferrer">espectre</a>：基于 Wi-Fi 信号的运动监测系统。这是一个基于 Wi-Fi 频谱分析（CSI）的运动检测系统，采用 ESP32-S3 开发板，成本约 10 欧元。它通过分析人体对 Wi-Fi 信号的干扰变化，实现无需摄像头、麦克风的运动检测，支持 Home Assistant 集成，适用于智能家居自动化，如人来开灯、家庭安防等场景。来自 <a href="https://link.juejin.cn?target=https%3A%2F%2Fhellogithub.com%2Fuser%2FLT1VF8UXAHRoheE" target="_blank" title="https://hellogithub.com/user/LT1VF8UXAHRoheE" ref="nofollow noopener noreferrer">@LaoZ</a> 的分享</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/932027f695404bc8a46cc5a0fe2323ab~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGVsbG9HaXRIdWI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764894608&amp;x-signature=%2BtjTo8G1OkfDSOUoz3JjGNB28uc%3D" alt="" loading="lazy"/></p>
<p>38、<a href="https://link.juejin.cn?target=https%3A%2F%2Fhellogithub.com%2Fperiodical%2Fstatistics%2Fclick%3Ftarget%3Dhttps%3A%2F%2Fgithub.com%2Fzmrlft%2FGreenWall" target="_blank" title="https://hellogithub.com/periodical/statistics/click?target=https://github.com/zmrlft/GreenWall" ref="nofollow noopener noreferrer">GreenWall</a>：像画画一样自定义 GitHub 绿格子。这是一个自定义 GitHub 贡献墙（绿墙）的工具，可通过直观的拖拽界面，轻松创作文字、Logo 或任意图案。来自 <a href="https://link.juejin.cn?target=https%3A%2F%2Fhellogithub.com%2Fuser%2FucwD1E5BxrhWt4J" target="_blank" title="https://hellogithub.com/user/ucwD1E5BxrhWt4J" ref="nofollow noopener noreferrer">@ShiYi</a> 的分享</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eeae813a87834b7babb9bdfe6996c8ae~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGVsbG9HaXRIdWI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764894608&amp;x-signature=NpIBxOhe6Jc6SsQ%2FuO6N8wCuwFw%3D" alt="" loading="lazy"/></p>
<p>39、<a href="https://link.juejin.cn?target=https%3A%2F%2Fhellogithub.com%2Fperiodical%2Fstatistics%2Fclick%3Ftarget%3Dhttps%3A%2F%2Fgithub.com%2FTheRobotStudio%2FSO-ARM100" target="_blank" title="https://hellogithub.com/periodical/statistics/click?target=https://github.com/TheRobotStudio/SO-ARM100" ref="nofollow noopener noreferrer">SO-ARM100</a>：开源低成本的机械臂。该项目是由 TheRobotStudio 与 Hugging Face 联合开源的低成本机械臂，内含自制 SO-100 和 SO-101 两款机械臂的所有资料。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/275bd8b678bf4bf5960725055af446a0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGVsbG9HaXRIdWI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764894608&amp;x-signature=0M%2Blew3Ym6QwwWXCh7O%2FSsAK6Iw%3D" alt="" loading="lazy"/></p>
<p>40、<a href="https://link.juejin.cn?target=https%3A%2F%2Fhellogithub.com%2Fperiodical%2Fstatistics%2Fclick%3Ftarget%3Dhttps%3A%2F%2Fgithub.com%2Ftonybaloney%2Fvscode-pets" target="_blank" title="https://hellogithub.com/periodical/statistics/click?target=https://github.com/tonybaloney/vscode-pets" ref="nofollow noopener noreferrer">vscode-pets</a>：在 VSCode 里养只宠物。该项目能够让你在 VSCode 编辑器里养一只或多只可互动的电子宠物，内置可爱的猫、狗、橡皮鸭等多种宠物。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/612f23c07d8c41789737297d1ddb4381~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGVsbG9HaXRIdWI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764894608&amp;x-signature=EsEdFuJL7LggJefCh8igPv1BHo8%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-14">最后</h2>
<p>感谢参与分享开源项目的小伙伴们，欢迎更多的开源爱好者来 HelloGitHub 自荐/推荐开源项目。如果你发现了 GitHub 上有趣的项目，就<a href="https://link.juejin.cn?target=https%3A%2F%2Fhellogithub.com%2Fperiodical" target="_blank" title="https://hellogithub.com/periodical" ref="nofollow noopener noreferrer">点击这里</a>分享给大家伙吧！</p>
<p>本期有你感兴趣的开源项目吗？如果有的话就留言告诉我吧～如果还没看过瘾，可以<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fmp%2Fappmsgalbum%3F__biz%3DMzA5MzYyNzQ0MQ%3D%3D%26action%3Dgetalbum%26album_id%3D1331197538447310849%26scene%3D173%26from_msgid%3D2247511076%26from_itemidx%3D1%26count%3D3%26nolastread%3D1%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=MzA5MzYyNzQ0MQ==&amp;action=getalbum&amp;album_id=1331197538447310849&amp;scene=173&amp;from_msgid=2247511076&amp;from_itemidx=1&amp;count=3&amp;nolastread=1#wechat_redirect" ref="nofollow noopener noreferrer">点击阅读</a>往期内容。</p>
<p>感谢您的阅读，如果觉得本期内容还不错的话 <strong>求赞、求分享</strong> ❤️</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[彻底解决超卖问题：从单体到分布式的全场景技术方案]]></title>    <link>https://juejin.cn/post/7577222731791007770</link>    <guid>https://juejin.cn/post/7577222731791007770</guid>    <pubDate>2025-11-28T00:58:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577222731791007770" data-draft-id="7577226119106183195" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="彻底解决超卖问题：从单体到分布式的全场景技术方案"/> <meta itemprop="keywords" content="后端,分布式"/> <meta itemprop="datePublished" content="2025-11-28T00:58:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="回家路上绕了弯"/> <meta itemprop="url" content="https://juejin.cn/user/536217404587134"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            彻底解决超卖问题：从单体到分布式的全场景技术方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/536217404587134/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    回家路上绕了弯
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-28T00:58:23.000Z" title="Fri Nov 28 2025 00:58:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读17分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">彻底解决超卖问题：从单体到分布式的全场景技术方案</h2>
<p>在电商秒杀、限时促销、限量商品发售等场景中，“超卖” 是最致命的业务故障之一 —— 明明只备货 1000 件商品，最终却卖出 1200 件，不仅导致 “无货可发” 的用户投诉，还可能引发平台信誉危机与经济损失。超卖的本质是 “并发场景下库存读写不同步”，但不同业务规模（单体 / 分布式）、不同并发量级（千级 / 万级 / 十万级）的解决方案差异极大，盲目套用 “分布式锁” 可能导致性能瓶颈，仅用 “数据库乐观锁” 又扛不住高并发。</p>
<p>本文结合电商实战经验，梳理超卖问题的完整解决思路，从基础的数据库控制到高并发的 Redis 预扣减，覆盖全场景方案，帮你按需选择最优解。</p>
<h3 data-id="heading-1">一、先明确：什么是超卖？为什么会发生？</h3>
<h4 data-id="heading-2">1. 超卖的定义</h4>
<p>超卖是指 “商品实际售出数量超过初始备货量”，最终导致库存为负的异常情况。典型场景：</p>
<ul>
<li>某商品初始库存 1000 件，秒杀活动中，1200 个用户成功下单，库存最终变为 - 200；</li>
</ul>

<ul>
<li>用户下单后未支付，库存未及时回补，后续用户继续下单，导致总订单量超备货量。</li>
</ul>
<h4 data-id="heading-3">2. 超卖的核心原因：并发下的 “库存读写冲突”</h4>
<p>超卖的本质是 “多线程 / 多服务同时读写库存，未做同步控制”，具体可分为 3 类场景：</p>

























<table><thead><tr><th>冲突场景</th><th>技术原因</th><th>典型案例</th></tr></thead><tbody><tr><td>单体应用并发读写</td><td>多线程同时读取库存（如读取到 1000），同时扣减（均扣为 999），最终多扣 1 次</td><td>单体电商秒杀，1000 并发下单导致超卖 10 件</td></tr><tr><td>分布式应用数据不一致</td><td>多服务实例操作同一数据库，未做分布式同步，各实例独立扣减库存</td><td>3 个服务实例同时处理订单，库存从 1000 扣至 997，实际应扣 3 次，却扣成 997（无超卖）？不，若读取时均为 1000，扣减后均为 999，最终库存 999，超卖 2 次</td></tr><tr><td>异步处理库存延迟</td><td>库存扣减用异步队列，队列堆积导致 “下单成功但库存未及时扣减”，后续用户继续下单</td><td>秒杀峰值时，库存扣减 MQ 队列堆积 5 分钟，期间用户持续下单，导致超卖</td></tr></tbody></table>
<p><strong>关键结论</strong>：超卖的核心是 “<strong>读库存</strong>” 与 “<strong>扣库存</strong>” 两个操作非原子性 —— 若能让 “读 + 扣” 成为不可分割的原子操作，就能从根本上避免超卖。</p>
<h3 data-id="heading-4">二、基础方案：单体应用超卖解决（并发≤1000QPS）</h3>
<p>单体应用并发较低（如日常促销，非秒杀），无需复杂中间件，仅通过数据库控制即可解决超卖，优先选择 “低侵入、易落地” 的方案。</p>
<h4 data-id="heading-5">方案 1：数据库唯一索引 —— 防止重复创建订单（间接防超卖）</h4>
<h5 data-id="heading-6">原理</h5>
<p>通过 “订单表 + 商品 ID + 用户 ID” 的唯一索引，确保 “同一用户对同一商品只能创建 1 个有效订单”，同时结合 “库存非负校验”，间接防止超卖：</p>
<ol>
<li>下单时，先校验商品库存是否 &gt; 0；</li>
</ol>

<ol start="2">
<li>再尝试创建订单，唯一索引保证不会重复下单；</li>
</ol>

<ol start="3">
<li>最后扣减库存（若库存不足，创建订单失败）。</li>
</ol>
<h5 data-id="heading-7">实现步骤</h5>
<ol>
<li><strong>订单表设计（唯一索引）</strong> ：</li>
</ol>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `<span class="hljs-keyword">order</span>` (
  `id` <span class="hljs-type">bigint</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="hljs-string">'订单ID'</span>,
  `user_id` <span class="hljs-type">bigint</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'用户ID'</span>,
  `product_id` <span class="hljs-type">bigint</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'商品ID'</span>,
  `order_status` tinyint <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span> COMMENT <span class="hljs-string">'订单状态：0=待支付，1=已支付，2=已取消'</span>,
  `create_time` datetime <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="hljs-string">'创建时间'</span>,
  <span class="hljs-keyword">PRIMARY</span> KEY (`id`),
  <span class="hljs-comment">-- 唯一索引：同一用户对同一商品只能创建1个待支付/已支付订单</span>
  <span class="hljs-keyword">UNIQUE</span> KEY `uk_user_product_status` (`user_id`, `product_id`, `order_status`) 
  COMMENT <span class="hljs-string">'防止同一用户重复下单'</span>
) ENGINE<span class="hljs-operator">=</span>InnoDB <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8mb4 COMMENT <span class="hljs-string">'订单表'</span>;
</code></pre>
<ol start="2">
<li><strong>商品表设计（库存字段）</strong> ：</li>
</ol>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `product` (
  `id` <span class="hljs-type">bigint</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="hljs-string">'商品ID'</span>,
  `product_name` <span class="hljs-type">varchar</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'商品名称'</span>,
  `stock` <span class="hljs-type">int</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span> COMMENT <span class="hljs-string">'库存数量'</span>,
  `version` <span class="hljs-type">int</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span> COMMENT <span class="hljs-string">'版本号（乐观锁用）'</span>,
  <span class="hljs-keyword">PRIMARY</span> KEY (`id`)
) ENGINE<span class="hljs-operator">=</span>InnoDB <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8mb4 COMMENT <span class="hljs-string">'商品表'</span>;
</code></pre>
<ol start="3">
<li><strong>下单逻辑（Java 代码）</strong> ：</li>
</ol>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-keyword">@Service</span>
<span class="hljs-keyword">@Transactional</span>
public class OrderService {
    <span class="hljs-keyword">@Autowired</span>
    private OrderMapper orderMapper;
    <span class="hljs-keyword">@Autowired</span>
    private ProductMapper productMapper;
    
    <span class="hljs-comment">/**
     * 单体应用下单（唯一索引防重复下单+库存校验）
     */</span>
    public OrderDTO <span class="hljs-built_in">createOrder</span>(Long userId, Long productId) {
        <span class="hljs-comment">// 步骤1：查询商品库存（判断是否有货）</span>
        Product product = productMapper<span class="hljs-selector-class">.selectById</span>(productId);
        if (product == null || product.getStock() &lt;= <span class="hljs-number">0</span>) {
            throw new <span class="hljs-built_in">BusinessException</span>("商品已售罄");
        }
        
        <span class="hljs-comment">// 步骤2：创建订单（唯一索引防止重复下单）</span>
        <span class="hljs-attribute">Order</span> <span class="hljs-attribute">order</span> = new <span class="hljs-attribute">Order</span>();
        <span class="hljs-attribute">order</span><span class="hljs-selector-class">.setUserId</span>(userId);
        <span class="hljs-attribute">order</span><span class="hljs-selector-class">.setProductId</span>(productId);
        <span class="hljs-attribute">order</span><span class="hljs-selector-class">.setOrderStatus</span>(<span class="hljs-number">0</span>); <span class="hljs-comment">// 待支付</span>
        try {
            orderMapper<span class="hljs-selector-class">.insert</span>(order);
        } catch (DuplicateKeyException e) {
            <span class="hljs-comment">// 唯一索引冲突，说明用户已下单</span>
            throw new <span class="hljs-built_in">BusinessException</span>("您已下单，请勿重复购买");
        }
        
        <span class="hljs-comment">// 步骤3：扣减库存（库存非负校验）</span>
        int updateCount = productMapper<span class="hljs-selector-class">.decreaseStock</span>(productId, <span class="hljs-number">1</span>);
        if (updateCount == <span class="hljs-number">0</span>) {
            <span class="hljs-comment">// 扣减失败（可能其他线程已扣完库存），回滚事务</span>
            throw new <span class="hljs-built_in">BusinessException</span>("商品已售罄，下单失败");
        }
        
        <span class="hljs-comment">// 步骤4：返回订单信息</span>
        OrderDTO orderDTO = <span class="hljs-built_in">convert</span>(order, product);
        return orderDTO;
    }
}
<span class="hljs-comment">// ProductMapper.xml 扣减库存SQL（带库存非负校验）</span>
&lt;update id="decreaseStock"&gt;
    UPDATE product 
    SET stock = stock - #{count} 
    WHERE id = #{productId} 
      AND stock &gt; <span class="hljs-number">0</span>; -- 关键：确保库存不会扣为负
&lt;/update&gt;
</code></pre>
<h5 data-id="heading-8">适用场景与优缺点</h5>
<ul>
<li><strong>适用场景</strong>：单体应用、日常促销（并发≤500QPS）、需限制 “同一用户重复下单” 的场景；</li>
</ul>

<ul>
<li><strong>优点</strong>：实现简单，无额外依赖，同时解决 “重复下单” 与 “超卖”；</li>
</ul>

<ul>
<li><strong>缺点</strong>：并发高时（如 1000QPS），唯一索引冲突频繁，用户体验差；扣库存与创建订单非原子操作，极端情况下仍可能超卖（如步骤 2 成功后，步骤 3 执行前，其他线程已扣完库存）。</li>
</ul>
<h4 data-id="heading-9">方案 2：数据库悲观锁 —— 强一致性，适合低并发</h4>
<h5 data-id="heading-10">原理</h5>
<p>通过数据库的 “行锁”（SELECT ... FOR UPDATE），锁定商品库存行，确保 “读库存” 与 “扣库存” 的原子性：</p>
<ol>
<li>下单时，用悲观锁锁定商品行，其他线程需等待锁释放；</li>
</ol>

<ol start="2">
<li>读取锁定后的库存，判断是否 &gt; 0；</li>
</ol>

<ol start="3">
<li>若有库存，扣减库存并创建订单；若无库存，释放锁并返回失败。</li>
</ol>
<h5 data-id="heading-11">实现步骤（核心代码）</h5>
<ol>
<li><strong>ProductMapper 加悲观锁查询</strong>：</li>
</ol>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-operator">/</span><span class="hljs-operator">/</span> ProductMapper.java
Product selectByIdForUpdate(Long productId);
<span class="hljs-operator">/</span><span class="hljs-operator">/</span> ProductMapper.xml（悲观锁查询）
<span class="hljs-operator">&lt;</span><span class="hljs-keyword">select</span> id<span class="hljs-operator">=</span>"selectByIdForUpdate" resultType<span class="hljs-operator">=</span>"com.example.Product"<span class="hljs-operator">&gt;</span>
    <span class="hljs-keyword">SELECT</span> id, product_name, stock, version 
    <span class="hljs-keyword">FROM</span> product 
    <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> #{productId} 
    <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">UPDATE</span>; <span class="hljs-comment">-- 行锁：锁定该商品行，其他线程无法修改</span>
<span class="hljs-operator">&lt;</span><span class="hljs-operator">/</span><span class="hljs-keyword">select</span><span class="hljs-operator">&gt;</span>
</code></pre>
<ol start="2">
<li><strong>下单逻辑（悲观锁版）</strong> ：</li>
</ol>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-keyword">@Service</span>
<span class="hljs-keyword">@Transactional</span>
public class OrderService {
    public OrderDTO <span class="hljs-built_in">createOrderWithPessimisticLock</span>(Long userId, Long productId) {
        <span class="hljs-comment">// 步骤1：悲观锁查询商品（锁定行，其他线程等待）</span>
        Product product = productMapper<span class="hljs-selector-class">.selectByIdForUpdate</span>(productId);
        if (product == null || product.getStock() &lt;= <span class="hljs-number">0</span>) {
            throw new <span class="hljs-built_in">BusinessException</span>("商品已售罄");
        }
        
        <span class="hljs-comment">// 步骤2：扣减库存（无需额外校验，锁已保证原子性）</span>
        int updateCount = productMapper<span class="hljs-selector-class">.decreaseStock</span>(productId, <span class="hljs-number">1</span>);
        if (updateCount == <span class="hljs-number">0</span>) {
            throw new <span class="hljs-built_in">BusinessException</span>("下单失败");
        }
        
        <span class="hljs-comment">// 步骤3：创建订单（可加唯一索引防重复下单）</span>
        <span class="hljs-attribute">Order</span> <span class="hljs-attribute">order</span> = new <span class="hljs-attribute">Order</span>();
        <span class="hljs-attribute">order</span><span class="hljs-selector-class">.setUserId</span>(userId);
        <span class="hljs-attribute">order</span><span class="hljs-selector-class">.setProductId</span>(productId);
        orderMapper<span class="hljs-selector-class">.insert</span>(order);
        
        return <span class="hljs-built_in">convert</span>(order, product);
    }
}
</code></pre>
<h5 data-id="heading-12">适用场景与优缺点</h5>
<ul>
<li><strong>适用场景</strong>：单体应用、低并发（≤300QPS）、对数据一致性要求极高的场景（如奢侈品秒杀）；</li>
</ul>

<ul>
<li><strong>优点</strong>：强一致性，100% 避免超卖，无需担心并发冲突；</li>
</ul>

<ul>
<li><strong>缺点</strong>：悲观锁会阻塞其他线程，并发高时导致 “订单创建排队”，响应时间变长（如 1000QPS 下，响应时间从 100ms 升至 500ms）。</li>
</ul>
<h4 data-id="heading-13">方案 3：数据库乐观锁 —— 无锁阻塞，适合中低并发</h4>
<h5 data-id="heading-14">原理</h5>
<p>乐观锁不主动锁定数据，而是通过 “版本号” 或 “库存字段” 判断扣减前库存是否被修改：</p>
<ol>
<li>下单时，读取商品库存与版本号（如库存 1000，版本 1）；</li>
</ol>

<ol start="2">
<li>扣减库存时，用版本号做条件（WHERE version = 1），确保期间无其他线程修改；</li>
</ol>

<ol start="3">
<li>若更新成功（影响行数 = 1），说明扣减有效；若失败（影响行数 = 0），说明库存已被修改，重试或返回失败。</li>
</ol>
<h5 data-id="heading-15">实现步骤（版本号机制）</h5>
<ol>
<li><strong>商品表版本号字段</strong>（已在方案 1 中定义，version字段）；</li>
</ol>

<ol start="2">
<li><strong>扣减库存 SQL（带版本号校验）</strong> ：</li>
</ol>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- ProductMapper.xml 乐观锁扣减库存 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">update</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"decreaseStockWithVersion"</span>&gt;</span>
    UPDATE product 
    SET stock = stock - #{count},
        version = version + 1 -- 版本号自增
    WHERE id = #{productId} 
      AND stock &gt; 0 
      AND version = #{version}; -- 关键：版本号匹配才更新
<span class="hljs-tag">&lt;/<span class="hljs-name">update</span>&gt;</span>
</code></pre>
<ol start="3">
<li><strong>下单逻辑（乐观锁版，带重试）</strong> ：</li>
</ol>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-keyword">@Service</span>
<span class="hljs-keyword">@Transactional</span>
public class OrderService {
    <span class="hljs-comment">// 最大重试次数（避免无限循环）</span>
    private static final int MAX_RETRY_COUNT = <span class="hljs-number">3</span>;
    
    public OrderDTO <span class="hljs-built_in">createOrderWithOptimisticLock</span>(Long userId, Long productId) {
        int retryCount = <span class="hljs-number">0</span>;
        while (retryCount &lt; MAX_RETRY_COUNT) {
            <span class="hljs-comment">// 步骤1：查询商品（含版本号）</span>
            Product product = productMapper<span class="hljs-selector-class">.selectById</span>(productId);
            if (product == null || product.getStock() &lt;= <span class="hljs-number">0</span>) {
                throw new <span class="hljs-built_in">BusinessException</span>("商品已售罄");
            }
            
            <span class="hljs-comment">// 步骤2：乐观锁扣减库存</span>
            int updateCount = productMapper<span class="hljs-selector-class">.decreaseStockWithVersion</span>(
                productId, <span class="hljs-number">1</span>, product.getVersion()
            );
            
            if (updateCount &gt; <span class="hljs-number">0</span>) {
                <span class="hljs-comment">// 步骤3：扣减成功，创建订单</span>
                <span class="hljs-attribute">Order</span> <span class="hljs-attribute">order</span> = new <span class="hljs-attribute">Order</span>();
                <span class="hljs-attribute">order</span><span class="hljs-selector-class">.setUserId</span>(userId);
                <span class="hljs-attribute">order</span><span class="hljs-selector-class">.setProductId</span>(productId);
                orderMapper<span class="hljs-selector-class">.insert</span>(order);
                return <span class="hljs-built_in">convert</span>(order, product);
            }
            
            <span class="hljs-comment">// 步骤4：扣减失败，重试（间隔10ms，避免CPU空转）</span>
            retryCount++;
            try {
                Thread<span class="hljs-selector-class">.sleep</span>(<span class="hljs-number">10</span>);
            } catch (InterruptedException e) {
                Thread<span class="hljs-selector-class">.currentThread</span>()<span class="hljs-selector-class">.interrupt</span>();
                break;
            }
        }
        
        <span class="hljs-comment">// 重试次数用尽，返回失败</span>
        throw new <span class="hljs-built_in">BusinessException</span>("下单人数过多，请稍后重试");
    }
}
</code></pre>
<h5 data-id="heading-16">适用场景与优缺点</h5>
<ul>
<li><strong>适用场景</strong>：单体应用、中低并发（≤1000QPS）、对响应时间敏感的场景（如日常电商促销）；</li>
</ul>

<ul>
<li><strong>优点</strong>：无锁阻塞，并发性能优于悲观锁；实现简单，仅需数据库字段；</li>
</ul>

<ul>
<li><strong>缺点</strong>：重试机制可能导致部分用户下单失败（需友好提示）；高并发下重试次数增加，响应时间变长。</li>
</ul>
<h3 data-id="heading-17">三、进阶方案：分布式应用超卖解决（并发≤10000QPS）</h3>
<p>分布式应用（多服务实例、多数据库分库分表）或中高并发（如秒杀 QPS=5000）场景，数据库方案已无法支撑，需引入 Redis、消息队列等中间件，通过 “缓存预扣减 + 异步同步” 提升性能，同时保证不超卖。</p>
<h4 data-id="heading-18">方案 4：Redis 分布式锁 —— 分布式强一致性</h4>
<h5 data-id="heading-19">原理</h5>
<p>通过 Redis 分布式锁，确保 “多服务实例对同一商品的库存扣减” 互斥，实现分布式环境下的原子操作：</p>
<ol>
<li>下单时，用商品 ID 生成分布式锁（如lock:product:123）；</li>
</ol>

<ol start="2">
<li>加锁成功后，查询 Redis 缓存库存（或数据库库存）；</li>
</ol>

<ol start="3">
<li>扣减库存（Redis + 数据库），释放锁；</li>
</ol>

<ol start="4">
<li>加锁失败，重试或返回 “下单繁忙”。</li>
</ol>
<h5 data-id="heading-20">实现步骤（基于 Redisson 分布式锁）</h5>
<ol>
<li><strong>引入 Redisson 依赖（Maven）</strong> ：</li>
</ol>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.redisson<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>redisson-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.23.3<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<ol start="2">
<li><strong>Redis 缓存库存预热（秒杀前执行）</strong> ：</li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StockPreloadService</span> {
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RedissonClient redissonClient;
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> ProductMapper productMapper;
    
    <span class="hljs-comment">/**
     * 库存预热：将数据库库存加载到Redis（秒杀前执行）
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">preloadStockToRedis</span><span class="hljs-params">(Long productId)</span> {
        <span class="hljs-comment">// 1. 查询数据库库存</span>
        <span class="hljs-type">Product</span> <span class="hljs-variable">product</span> <span class="hljs-operator">=</span> productMapper.selectById(productId);
        <span class="hljs-keyword">if</span> (product == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(<span class="hljs-string">"商品不存在"</span>);
        }
        
        <span class="hljs-comment">// 2. 存储到Redis（key=stock:product:123，value=库存数）</span>
        <span class="hljs-type">RAtomicLong</span> <span class="hljs-variable">redisStock</span> <span class="hljs-operator">=</span> redissonClient.getAtomicLong(<span class="hljs-string">"stock:product:"</span> + productId);
        redisStock.set(product.getStock());
    }
}
</code></pre>
<ol start="3">
<li><strong>分布式锁下单逻辑</strong>：</li>
</ol>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-keyword">@Service</span>
<span class="hljs-keyword">@Transactional</span>
public class DistributedOrderService {
    <span class="hljs-keyword">@Autowired</span>
    private RedissonClient redissonClient;
    <span class="hljs-keyword">@Autowired</span>
    private ProductMapper productMapper;
    <span class="hljs-keyword">@Autowired</span>
    private OrderMapper orderMapper;
    
    public OrderDTO <span class="hljs-built_in">createOrderWithDistributedLock</span>(Long userId, Long productId) {
        <span class="hljs-comment">// 步骤1：获取分布式锁（商品ID为锁key，过期时间30秒，自动释放）</span>
        RLock lock = redissonClient<span class="hljs-selector-class">.getLock</span>("lock:product:" + productId);
        try {
            <span class="hljs-comment">// 尝试加锁，最多等待5秒，5秒内未获取到锁则失败</span>
            boolean locked = lock<span class="hljs-selector-class">.tryLock</span>(<span class="hljs-number">5</span>, <span class="hljs-number">30</span>, TimeUnit.SECONDS);
            if (!locked) {
                throw new <span class="hljs-built_in">BusinessException</span>("下单人数过多，请稍后重试");
            }
            
            <span class="hljs-comment">// 步骤2：查询Redis库存（减少数据库访问）</span>
            RAtomicLong redisStock = redissonClient<span class="hljs-selector-class">.getAtomicLong</span>("stock:product:" + productId);
            long currentStock = redisStock<span class="hljs-selector-class">.get</span>();
            if (currentStock &lt;= <span class="hljs-number">0</span>) {
                throw new <span class="hljs-built_in">BusinessException</span>("商品已售罄");
            }
            
            <span class="hljs-comment">// 步骤3：扣减Redis库存（原子操作）</span>
            boolean decrSuccess = redisStock<span class="hljs-selector-class">.decrementAndGet</span>() &gt;= <span class="hljs-number">0</span>;
            if (!decrSuccess) {
                <span class="hljs-comment">// 若扣减后为负，回补Redis库存（避免超卖）</span>
                redisStock<span class="hljs-selector-class">.incrementAndGet</span>();
                throw new <span class="hljs-built_in">BusinessException</span>("商品已售罄");
            }
            
            <span class="hljs-comment">// 步骤4：扣减数据库库存（最终一致性，可异步）</span>
            int updateCount = productMapper<span class="hljs-selector-class">.decreaseStock</span>(productId, <span class="hljs-number">1</span>);
            if (updateCount == <span class="hljs-number">0</span>) {
                <span class="hljs-comment">// 数据库扣减失败，回补Redis库存</span>
                redisStock<span class="hljs-selector-class">.incrementAndGet</span>();
                throw new <span class="hljs-built_in">BusinessException</span>("下单失败");
            }
            
            <span class="hljs-comment">// 步骤5：创建订单（唯一索引防重复下单）</span>
            <span class="hljs-attribute">Order</span> <span class="hljs-attribute">order</span> = new <span class="hljs-attribute">Order</span>();
            <span class="hljs-attribute">order</span><span class="hljs-selector-class">.setUserId</span>(userId);
            <span class="hljs-attribute">order</span><span class="hljs-selector-class">.setProductId</span>(productId);
            try {
                orderMapper<span class="hljs-selector-class">.insert</span>(order);
            } catch (DuplicateKeyException e) {
                <span class="hljs-comment">// 重复下单，回补Redis和数据库库存</span>
                redisStock<span class="hljs-selector-class">.incrementAndGet</span>();
                productMapper<span class="hljs-selector-class">.increaseStock</span>(productId, <span class="hljs-number">1</span>); <span class="hljs-comment">// 库存回补SQL</span>
                throw new <span class="hljs-built_in">BusinessException</span>("您已下单，请勿重复购买");
            }
            
            return <span class="hljs-built_in">convert</span>(order, productMapper.selectById(productId));
        } catch (InterruptedException e) {
            Thread<span class="hljs-selector-class">.currentThread</span>()<span class="hljs-selector-class">.interrupt</span>();
            throw new <span class="hljs-built_in">BusinessException</span>("下单异常，请重试");
        } finally {
            <span class="hljs-comment">// 步骤6：释放锁（确保锁一定释放）</span>
            if (lock.isHeldByCurrentThread()) {
                lock<span class="hljs-selector-class">.unlock</span>();
            }
        }
    }
}
</code></pre>
<h5 data-id="heading-21">适用场景与优缺点</h5>
<ul>
<li><strong>适用场景</strong>：分布式应用、中高并发（≤10000QPS）、对一致性要求高的场景（如电商秒杀）；</li>
</ul>

<ul>
<li><strong>优点</strong>：分布式环境下强一致，支持较高并发；Redis 库存查询减少数据库压力；</li>
</ul>

<ul>
<li><strong>缺点</strong>：依赖 Redis 集群（需保证 Redis 高可用）；锁粒度为商品 ID，热门商品可能出现 “锁竞争”（可通过商品分片优化）。</li>
</ul>
<h4 data-id="heading-22">方案 5：Redis 预扣减 + 消息队列异步同步 —— 高并发秒杀（QPS≥10000）</h4>
<h5 data-id="heading-23">原理</h5>
<p>高并发秒杀（如 QPS=10 万）场景下，Redis 分布式锁的锁竞争会成为瓶颈，需用 “Redis 预扣减 + 消息队列异步同步” 实现 “无锁高并发”：</p>
<ol>
<li>秒杀前，将库存加载到 Redis（预扣减库存）；</li>
</ol>

<ol start="2">
<li>下单时，直接扣减 Redis 库存（原子操作，无锁），生成订单并发送到消息队列；</li>
</ol>

<ol start="3">
<li>消息队列消费者异步同步库存到数据库，处理订单支付状态；</li>
</ol>

<ol start="4">
<li>若用户未支付，异步回补 Redis 与数据库库存。</li>
</ol>
<h5 data-id="heading-24">实现步骤（秒杀场景）</h5>
<ol>
<li><strong>Redis 预扣减下单（核心代码）</strong> ：</li>
</ol>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-keyword">@Service</span>
public class SeckillOrderService {
    <span class="hljs-keyword">@Autowired</span>
    private RedissonClient redissonClient;
    <span class="hljs-keyword">@Autowired</span>
    private KafkaTemplate&lt;String, String&gt; kafkaTemplate;
    <span class="hljs-keyword">@Autowired</span>
    private OrderMapper orderMapper;
    
    <span class="hljs-comment">/**
     * 秒杀下单：Redis预扣减+MQ异步同步
     */</span>
    public OrderDTO <span class="hljs-built_in">seckillOrder</span>(Long userId, Long productId) {
        <span class="hljs-comment">// 步骤1：Redis原子扣减库存（无锁，高并发）</span>
        RAtomicLong redisStock = redissonClient<span class="hljs-selector-class">.getAtomicLong</span>("stock:product:" + productId);
        long remainingStock = redisStock<span class="hljs-selector-class">.decrementAndGet</span>();
        if (remainingStock &lt; <span class="hljs-number">0</span>) {
            <span class="hljs-comment">// 库存不足，回补Redis（避免超卖）</span>
            redisStock<span class="hljs-selector-class">.incrementAndGet</span>();
            throw new <span class="hljs-built_in">BusinessException</span>("手慢了，商品已售罄");
        }
        
        <span class="hljs-comment">// 步骤2：生成订单（仅存必要信息，快速返回）</span>
        <span class="hljs-attribute">Order</span> <span class="hljs-attribute">order</span> = new <span class="hljs-attribute">Order</span>();
        <span class="hljs-attribute">order</span><span class="hljs-selector-class">.setUserId</span>(userId);
        <span class="hljs-attribute">order</span><span class="hljs-selector-class">.setProductId</span>(productId);
        <span class="hljs-attribute">order</span><span class="hljs-selector-class">.setOrderStatus</span>(<span class="hljs-number">0</span>); <span class="hljs-comment">// 待支付</span>
        String orderNo = <span class="hljs-built_in">generateOrderNo</span>(); <span class="hljs-comment">// 生成唯一订单号</span>
        <span class="hljs-attribute">order</span><span class="hljs-selector-class">.setOrderNo</span>(orderNo);
        orderMapper<span class="hljs-selector-class">.insertSelective</span>(order); <span class="hljs-comment">// 仅插入必要字段，提升速度</span>
        
        <span class="hljs-comment">// 步骤3：发送MQ消息（异步同步库存到数据库+处理支付）</span>
        SeckillMqMsg msg = new <span class="hljs-built_in">SeckillMqMsg</span>();
        msg<span class="hljs-selector-class">.setOrderNo</span>(orderNo);
        msg<span class="hljs-selector-class">.setProductId</span>(productId);
        msg<span class="hljs-selector-class">.setUserId</span>(userId);
        kafkaTemplate<span class="hljs-selector-class">.send</span>("seckill-order-topic", JSON.toJSONString(msg));
        
        <span class="hljs-comment">// 步骤4：快速返回订单信息（用户无需等待库存同步完成）</span>
        OrderDTO orderDTO = new <span class="hljs-built_in">OrderDTO</span>();
        orderDTO<span class="hljs-selector-class">.setOrderNo</span>(orderNo);
        orderDTO<span class="hljs-selector-class">.setStatus</span>("待支付");
        orderDTO<span class="hljs-selector-class">.setMsg</span>("下单成功，请在<span class="hljs-number">15</span>分钟内支付");
        return orderDTO;
    }
    
    <span class="hljs-comment">// 生成唯一订单号（时间戳+随机数+用户ID后4位）</span>
    private String <span class="hljs-built_in">generateOrderNo</span>() {
        return new <span class="hljs-built_in">SimpleDateFormat</span>("yyyyMMddHHmmss")<span class="hljs-selector-class">.format</span>(new Date()) 
                + RandomUtils<span class="hljs-selector-class">.nextInt</span>(<span class="hljs-number">1000</span>, <span class="hljs-number">9999</span>) 
                + Thread<span class="hljs-selector-class">.currentThread</span>()<span class="hljs-selector-class">.getId</span>() % <span class="hljs-number">10000</span>;
    }
}
</code></pre>
<ol start="2">
<li><strong>MQ 消费者异步同步库存（Kafka 消费者）</strong> ：</li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SeckillOrderConsumer</span> {
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> ProductMapper productMapper;
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> OrderMapper orderMapper;
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RedissonClient redissonClient;
    
    <span class="hljs-meta">@KafkaListener(topics = "seckill-order-topic")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processSeckillOrder</span><span class="hljs-params">(String msgStr)</span> {
        <span class="hljs-type">SeckillMqMsg</span> <span class="hljs-variable">msg</span> <span class="hljs-operator">=</span> JSON.parseObject(msgStr, SeckillMqMsg.class);
        <span class="hljs-type">String</span> <span class="hljs-variable">orderNo</span> <span class="hljs-operator">=</span> msg.getOrderNo();
        <span class="hljs-type">Long</span> <span class="hljs-variable">productId</span> <span class="hljs-operator">=</span> msg.getProductId();
        
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 步骤1：异步扣减数据库库存（最终一致性）</span>
            <span class="hljs-type">int</span> <span class="hljs-variable">updateCount</span> <span class="hljs-operator">=</span> productMapper.decreaseStock(productId, <span class="hljs-number">1</span>);
            <span class="hljs-keyword">if</span> (updateCount == <span class="hljs-number">0</span>) {
                <span class="hljs-comment">// 数据库库存不足（极端情况，Redis预扣减有误），回补Redis库存</span>
                <span class="hljs-type">RAtomicLong</span> <span class="hljs-variable">redisStock</span> <span class="hljs-operator">=</span> redissonClient.getAtomicLong(<span class="hljs-string">"stock:product:"</span> + productId);
                redisStock.incrementAndGet();
                <span class="hljs-comment">// 更新订单状态为“下单失败”</span>
                orderMapper.updateStatusByOrderNo(orderNo, <span class="hljs-number">3</span>); <span class="hljs-comment">// 3=下单失败</span>
                log.error(<span class="hljs-string">"异步扣减库存失败，订单号：{}，商品ID：{}"</span>, orderNo, productId);
                <span class="hljs-keyword">return</span>;
            }
            
            <span class="hljs-comment">// 步骤2：监听支付状态（如15分钟未支付，回补库存）</span>
            listenPaymentStatus(orderNo, productId);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            log.error(<span class="hljs-string">"处理秒杀订单异常，订单号：{}"</span>, orderNo, e);
            <span class="hljs-comment">// 异常时回补Redis库存</span>
            <span class="hljs-type">RAtomicLong</span> <span class="hljs-variable">redisStock</span> <span class="hljs-operator">=</span> redissonClient.getAtomicLong(<span class="hljs-string">"stock:product:"</span> + productId);
            redisStock.incrementAndGet();
            orderMapper.updateStatusByOrderNo(orderNo, <span class="hljs-number">3</span>);
        }
    }
    
    <span class="hljs-comment">// 监听支付状态：15分钟未支付，回补库存</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">listenPaymentStatus</span><span class="hljs-params">(String orderNo, Long productId)</span> {
        <span class="hljs-comment">// 用定时任务或延迟队列监听支付状态（如RabbitMQ延迟队列）</span>
        <span class="hljs-comment">// 若15分钟未支付：</span>
        <span class="hljs-comment">// 1. 回补Redis库存：redisStock.incrementAndGet()</span>
        <span class="hljs-comment">// 2. 回补数据库库存：productMapper.increaseStock(productId, 1)</span>
        <span class="hljs-comment">// 3. 更新订单状态：orderMapper.updateStatusByOrderNo(orderNo, 2) // 2=已取消</span>
    }
}
</code></pre>
<h5 data-id="heading-25">适用场景与优缺点</h5>
<ul>
<li><strong>适用场景</strong>：高并发秒杀（QPS≥10000）、对响应时间要求极高的场景（如 “双十一” 秒杀）；</li>
</ul>

<ul>
<li><strong>优点</strong>：无锁设计，支持极高并发；异步同步降低响应时间（下单响应时间 &lt; 100ms）；</li>
</ul>

<ul>
<li><strong>缺点</strong>：Redis 与数据库存在短暂不一致（需最终一致性）；需处理 “未支付回补库存” 的复杂逻辑；依赖 MQ 与 Redis 的高可用。</li>
</ul>
<h3 data-id="heading-26">四、终极保障：超卖防护的 3 个兜底措施</h3>
<p>无论选择哪种方案，都需添加 “兜底措施”，应对极端情况（如 Redis 宕机、MQ 队列堆积）：</p>
<h4 data-id="heading-27">1. 库存对账机制</h4>
<p>定时（如每 5 分钟）对比 Redis 库存与数据库库存，发现不一致时修正：</p>
<pre><code class="hljs language-ini" lang="ini">@Scheduled(<span class="hljs-attr">fixedRate</span> = <span class="hljs-number">300000</span>) // 每<span class="hljs-number">5</span>分钟执行一次
public void checkStockConsistency() {
    // 1. 查询所有秒杀商品
    List&lt;Product&gt; <span class="hljs-attr">seckillProducts</span> = productMapper.listSeckillProducts()<span class="hljs-comment">;</span>
    for (Product product : seckillProducts) {
        Long <span class="hljs-attr">productId</span> = product.getId()<span class="hljs-comment">;</span>
        int <span class="hljs-attr">dbStock</span> = product.getStock()<span class="hljs-comment">;</span>
        
        // 2. 查询Redis库存
        RAtomicLong <span class="hljs-attr">redisStock</span> = redissonClient.getAtomicLong(<span class="hljs-string">"stock:product:"</span> + productId)<span class="hljs-comment">;</span>
        long <span class="hljs-attr">redisStockVal</span> = redisStock.get()<span class="hljs-comment">;</span>
        
        // 3. 对比并修正（以数据库为准，或根据业务规则）
        if (dbStock != redisStockVal) {
            log.warn("库存不一致，商品ID：{}，数据库库存：{}，Redis库存：{}", 
                     productId, dbStock, redisStockVal)<span class="hljs-comment">;</span>
            // 修正Redis库存为数据库库存
            redisStock.set(dbStock)<span class="hljs-comment">;</span>
        }
    }
}
</code></pre>
<h4 data-id="heading-28">2. 库存上限限制</h4>
<p>在订单创建接口添加 “总订单量≤初始备货量” 的校验，即使前面的方案失效，仍能防止超卖：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 下单前校验总订单量</span>
<span class="hljs-type">int</span> totalOrderCount = orderMapper.<span class="hljs-built_in">countByProductId</span>(productId);
<span class="hljs-type">int</span> initialStock = productMapper.<span class="hljs-built_in">selectInitialStock</span>(productId); <span class="hljs-comment">// 初始备货量</span>
<span class="hljs-keyword">if</span> (totalOrderCount &gt;= initialStock) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">BusinessException</span>(<span class="hljs-string">"商品已售罄"</span>);
}
</code></pre>
<h4 data-id="heading-29">3. 支付超时回补</h4>
<p>用户下单后未支付（如 15 分钟超时），必须回补库存，避免 “占库存不付款” 导致的超卖：</p>
<ul>
<li>用延迟队列（如 RabbitMQ 延迟交换机）监听订单支付状态；</li>
</ul>

<ul>
<li>超时未支付，执行 “库存回补”（Redis + 数据库）与 “订单取消”。</li>
</ul>
<h3 data-id="heading-30">五、方案选型速查表</h3>



































<table><thead><tr><th>业务规模</th><th>并发量级</th><th>推荐方案组合</th><th>核心优势</th></tr></thead><tbody><tr><td>单体应用（中小电商）</td><td>≤500QPS</td><td>数据库乐观锁 + 唯一索引</td><td>无额外依赖，易落地</td></tr><tr><td>单体应用（促销活动）</td><td>500-1000QPS</td><td>数据库乐观锁 + Redis 缓存库存</td><td>兼顾性能与一致性</td></tr><tr><td>分布式应用（多服务）</td><td>1000-10000QPS</td><td>Redis 分布式锁 + 数据库同步</td><td>分布式强一致，支持中高并发</td></tr><tr><td>高并发秒杀（大促）</td><td>≥10000QPS</td><td>Redis 预扣减 + MQ 异步同步 + 库存对账</td><td>无锁高并发，响应时间短</td></tr></tbody></table>
<h3 data-id="heading-31">六、避坑指南：超卖解决的 5 个常见错误</h3>
<ol>
<li><strong>错误 1：仅用 Redis incr/decr，不做库存非负校验</strong></li>
</ol>
<ul>
<li>
<ul>
<li>问题：redisStock.decrementAndGet()可能导致库存为负（如库存 1，两个线程同时扣减，变为 - 1）；</li>
</ul>
</li>
</ul>

<ul>
<li>
<ul>
<li>解决：扣减后判断是否≥0，否则回补（redisStock.incrementAndGet()）。</li>
</ul>
</li>
</ul>
<ol start="2">
<li><strong>错误 2：分布式锁未设置过期时间</strong></li>
</ol>
<ul>
<li>
<ul>
<li>问题：服务宕机导致锁未释放，其他线程无法下单；</li>
</ul>
</li>
</ul>

<ul>
<li>
<ul>
<li>解决：用 Redisson 的tryLock(等待时间, 过期时间, 单位)，自动释放锁。</li>
</ul>
</li>
</ul>
<ol start="3">
<li><strong>错误 3：忽略 “重复下单” 问题</strong></li>
</ol>
<ul>
<li>
<ul>
<li>问题：仅防超卖，未防同一用户重复下单，导致 “一个用户买多件” 超卖；</li>
</ul>
</li>
</ul>

<ul>
<li>
<ul>
<li>解决：订单表加 “user_id+product_id” 唯一索引，或 Redis 记录用户下单次数（user:order:count:userId:productId）。</li>
</ul>
</li>
</ul>
<ol start="4">
<li><strong>错误 4：异步同步库存无重试机制</strong></li>
</ol>
<ul>
<li>
<ul>
<li>问题：MQ 消费失败导致数据库库存未扣减，Redis 与数据库不一致；</li>
</ul>
</li>
</ul>

<ul>
<li>
<ul>
<li>解决：MQ 消费者添加重试机制（如重试 3 次，失败后存入死信队列人工处理）。</li>
</ul>
</li>
</ul>
<ol start="5">
<li><strong>错误 5：秒杀前未预热库存到 Redis</strong></li>
</ol>
<ul>
<li>
<ul>
<li>问题：秒杀开始后，大量请求查询数据库，导致数据库宕机；</li>
</ul>
</li>
</ul>

<ul>
<li>
<ul>
<li>解决：秒杀前 10 分钟，将库存从数据库加载到 Redis，秒杀时优先查 Redis。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-32">总结：超卖解决的核心逻辑</h3>
<p>超卖解决的本质是 “<strong>在性能与一致性之间找平衡</strong>”：</p>
<ul>
<li>低并发场景：优先用数据库方案（乐观锁 / 悲观锁），简单可靠；</li>
</ul>

<ul>
<li>中高并发场景：用 Redis 分布式锁，兼顾一致性与性能；</li>
</ul>

<ul>
<li>高并发秒杀场景：用 Redis 预扣减 + MQ 异步同步，牺牲短暂一致性换极致性能。</li>
</ul>
<p>无论选择哪种方案，都需记住：<strong>没有 “银弹”，只有 “适合业务的方案”</strong> —— 结合自身并发量级、一致性要求、技术栈选择方案，同时添加 “库存对账、超时回补” 等兜底措施，才能彻底杜绝超卖，保障业务稳定。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[大数据-166 Apache Kylin 1.6 Streaming Cubing 实战：Kafka 到分钟级 OLAP]]></title>    <link>https://juejin.cn/post/7577242285197705243</link>    <guid>https://juejin.cn/post/7577242285197705243</guid>    <pubDate>2025-11-28T01:01:26.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577242285197705243" data-draft-id="7577226119106199579" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="大数据-166 Apache Kylin 1.6 Streaming Cubing 实战：Kafka 到分钟级 OLAP"/> <meta itemprop="keywords" content="后端,大数据,Apache Kylin"/> <meta itemprop="datePublished" content="2025-11-28T01:01:26.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="武子康"/> <meta itemprop="url" content="https://juejin.cn/user/149189314230039"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            大数据-166 Apache Kylin 1.6 Streaming Cubing 实战：Kafka 到分钟级 OLAP
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/149189314230039/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    武子康
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-28T01:01:26.000Z" title="Fri Nov 28 2025 01:01:26 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">TL;DR</h2>
<ul>
<li>场景：电商/IoT/监控等需要分钟级指标刷新，同时保留历史明细做 OLAP。</li>
<li>结论：TimedJsonStreamParser + 时间分区维度 + 微批构建，稳态 3–5 分钟刷新取决于资源与合并策略。</li>
<li>产出：Kafka→Kylin Streaming Cube 全流程、REST/Crontab 调度与 SQL 示例，含常见坑位与修复。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4fa95d6eadc84c008d96d255a9b9ef18~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764896486&amp;x-signature=%2BPBJEw8Ur%2B9FlkQed7HxoS4noLY%3D" alt="大数据-166 Apache Kylin 1.6 Streaming Cubing 实战：Kafka 到分钟级 OLAP" loading="lazy"/></p>
<h2 data-id="heading-1">版本矩阵</h2>





























<table><thead><tr><th>状态</th><th>说明</th></tr></thead><tbody><tr><td>✅</td><td>TimedJsonStreamParser 解析三段式 JSON（dimensions/metrics/timestamp）按示例可用；嵌套字段建议采集端扁平化或自定义解析器。</td></tr><tr><td>✅</td><td>时间分区列（如 minute_start）作为维度并在 RowKeys 前置，可显著缩小扫描范围。</td></tr><tr><td>✅</td><td>REST .../cubes/{cube}/build2 + crontab 触发微批构建流程可用；注意并发与段合并策略。</td></tr><tr><td>✅</td><td>Aggregation Groups/RowKeys 配置与离线 Cube 基本一致，但对时间维度顺序更敏感。</td></tr><tr><td>✅</td><td>基于示例的 Kafka 主题创建/采样/消费链路跑通；命令行与参数按示例工作。</td></tr></tbody></table>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f0f06dce679a440189414e99c26d4694~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764896486&amp;x-signature=qe9TQmumN3FBBD1hEQrYXj7a2zE%3D" alt="Apache Kylin" loading="lazy"/></p>
<h2 data-id="heading-2">基本概念</h2>
<p>实时数据更新在现代数据分析领域是一种普遍且日益增长的需求，特别是在金融交易监控、物联网设备管理和电商实时推荐等场景中。企业需要快速捕捉和分析数据趋势，才能在瞬息万变的市场环境中做出及时、正确的决策。</p>
<p>Apache Kylin V1.6版本针对这一需求发布了重要的StreamingCubing功能扩展。该功能采用创新的架构设计，通过整合Hadoop生态系统的处理能力来实时消费Kafka消息队列中的数据。具体实现方式包括：</p>
<ol>
<li>建立专用的Kafka消费者组</li>
<li>实现增量数据分区处理</li>
<li>采用微批次(mini-batch)计算模式</li>
</ol>
<p>这种架构能够构建出支持分钟级(通常3-5分钟)更新的Cube，相比传统的每日批处理模式有了质的飞跃。例如，在零售行业，商家可以实时监控各门店的销售数据变化，及时调整促销策略；在电信行业，运营商可以即时分析网络流量异常，快速定位故障点。</p>
<p>该功能不仅满足了企业对数据时效性的需求，还保持了Kylin原有的高性能OLAP查询能力，实现了实时分析与历史数据分析的无缝结合。</p>
<h2 data-id="heading-3">实现步骤</h2>
<p>步骤：项目 =&gt; 定义数据源（Kafka）=&gt; 定义Model =&gt; 定义Cube =&gt; Build Cube =&gt; 作业调度（频率高）</p>
<h2 data-id="heading-4">生成数据</h2>
<p>从Kafka消费消息时，为确保数据分析的一致性和处理效率，每条消息需要遵循以下标准化数据结构要求：</p>
<ol>
<li>
<p><strong>维度信息</strong>：</p>
<ul>
<li>包含业务实体的分类属性，用于数据分组和筛选</li>
<li>示例：产品类别、地区代码、用户等级等</li>
<li>建议采用键值对形式，如："product_category":"electronics"</li>
</ul>
</li>
<li>
<p><strong>度量信息</strong>：</p>
<ul>
<li>包含可量化的业务指标数值</li>
<li>示例：销售额、点击量、库存数量等</li>
<li>建议格式："sales_amount":1250.50</li>
</ul>
</li>
<li>
<p><strong>业务时间戳</strong>：</p>
<ul>
<li>记录业务实际发生的时间点</li>
<li>必须采用ISO 8601标准格式：YYYY-MM-DDTHH:MM:SSZ</li>
<li>示例："biz_timestamp":"2023-05-15T14:30:00Z"</li>
</ul>
</li>
</ol>
<p>消息体应采用统一JSON结构，例如：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"dimensions"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"region"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"APAC"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"product_line"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"smartphone"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"metrics"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"order_count"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">42</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"revenue"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">12500.00</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"timestamp"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2023-05-15T09:15:30Z"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>当前系统默认配置的分析器为<code>org.apache.kylin.source.kafka.TimedJsonStreamParser</code>，该解析器能够：</p>
<ol>
<li>自动识别JSON消息体中的三个标准部分</li>
<li>将维度信息映射到OLAP模型的维度表</li>
<li>将度量信息聚合到事实表</li>
<li>根据业务时间戳进行时间分区处理</li>
</ol>
<p>使用建议：</p>
<ul>
<li>生产环境应确保所有生产者使用相同的消息模板</li>
<li>开发阶段可以使用Schema Registry进行消息结构验证</li>
<li>对于特殊业务场景，可通过继承TimedJsonStreamParser实现自定义解析逻辑</li>
</ul>
<p>典型应用场景：</p>
<ol>
<li>电商交易分析：维度包含商品类目、支付方式；度量包含交易金额、优惠金额</li>
<li>用户行为分析：维度包含用户属性、访问渠道；度量包含停留时长、点击次数</li>
<li>IoT设备监控：维度包含设备类型、地理位置；度量包含温度读数、运行时长</li>
</ol>
<h2 data-id="heading-5">创建数据</h2>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">创建名为kylin_streaming_topic的topic</span>
kafka-topics.sh --create --zookeeper h121.wzk.icu:2181 --replication-factor 1 --partitions 1 --topic kylin_streaming_topic1
</code></pre>
<p>执行结果如下图所示：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/002f19a5838c49bb9c767c7df1428072~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764896486&amp;x-signature=W4zfJZukRFvVIPK15cVzyW5Tv2U%3D" alt="Kafka topics" loading="lazy"/></p>
<h2 data-id="heading-6">数据采样</h2>
<p>设置采样器</p>
<pre><code class="hljs language-shell" lang="shell">kylin.sh org.apache.kylin.source.kafka.util.KafkaSampleProducer --topic kylin_streaming_topic1 --broker h121.wzk.icu:9092
</code></pre>
<p>发了一大批数据，如下图所示：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/094e7a743da04b21a74d7d369b8ed76f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764896486&amp;x-signature=uuYqWd70nHm4UzcBCvSzLY9SRxE%3D" alt="KafkaSampleProducer" loading="lazy"/></p>
<h2 data-id="heading-7">检查数据</h2>
<p>检查数据是否发送成功：</p>
<pre><code class="hljs language-shell" lang="shell">kafka-console-consumer.sh --bootstrap-server h121.wzk.icu:9092 --topic kylin_streaming_topic1 --from-beginning
</code></pre>
<p>数据样例如下所示：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span><span class="hljs-attr">"country"</span><span class="hljs-punctuation">:</span><span class="hljs-string">"INDIA"</span><span class="hljs-punctuation">,</span><span class="hljs-attr">"amount"</span><span class="hljs-punctuation">:</span><span class="hljs-number">44.47793969871658</span><span class="hljs-punctuation">,</span><span class="hljs-attr">"qty"</span><span class="hljs-punctuation">:</span><span class="hljs-number">3</span><span class="hljs-punctuation">,</span><span class="hljs-attr">"currency"</span><span class="hljs-punctuation">:</span><span class="hljs-string">"USD"</span><span class="hljs-punctuation">,</span><span class="hljs-attr">"order_time"</span><span class="hljs-punctuation">:</span><span class="hljs-number">1723358207350</span><span class="hljs-punctuation">,</span><span class="hljs-attr">"category"</span><span class="hljs-punctuation">:</span><span class="hljs-string">"TOY"</span><span class="hljs-punctuation">,</span><span class="hljs-attr">"device"</span><span class="hljs-punctuation">:</span><span class="hljs-string">"iOS"</span><span class="hljs-punctuation">,</span><span class="hljs-attr">"user"</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">{</span><span class="hljs-attr">"gender"</span><span class="hljs-punctuation">:</span><span class="hljs-string">"Female"</span><span class="hljs-punctuation">,</span><span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span><span class="hljs-string">"1c54f68e-f89a-b5d2-f802-45b60ffccf60"</span><span class="hljs-punctuation">,</span><span class="hljs-attr">"first_name"</span><span class="hljs-punctuation">:</span><span class="hljs-string">"unknown"</span><span class="hljs-punctuation">,</span><span class="hljs-attr">"age"</span><span class="hljs-punctuation">:</span><span class="hljs-number">15</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">{</span><span class="hljs-attr">"country"</span><span class="hljs-punctuation">:</span><span class="hljs-string">"AUSTRALIA"</span><span class="hljs-punctuation">,</span><span class="hljs-attr">"amount"</span><span class="hljs-punctuation">:</span><span class="hljs-number">64.86505054935878</span><span class="hljs-punctuation">,</span><span class="hljs-attr">"qty"</span><span class="hljs-punctuation">:</span><span class="hljs-number">9</span><span class="hljs-punctuation">,</span><span class="hljs-attr">"currency"</span><span class="hljs-punctuation">:</span><span class="hljs-string">"USD"</span><span class="hljs-punctuation">,</span><span class="hljs-attr">"order_time"</span><span class="hljs-punctuation">:</span><span class="hljs-number">1723358207361</span><span class="hljs-punctuation">,</span><span class="hljs-attr">"category"</span><span class="hljs-punctuation">:</span><span class="hljs-string">"TOY"</span><span class="hljs-punctuation">,</span><span class="hljs-attr">"device"</span><span class="hljs-punctuation">:</span><span class="hljs-string">"iOS"</span><span class="hljs-punctuation">,</span><span class="hljs-attr">"user"</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">{</span><span class="hljs-attr">"gender"</span><span class="hljs-punctuation">:</span><span class="hljs-string">"Female"</span><span class="hljs-punctuation">,</span><span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span><span class="hljs-string">"de11d872-e843-19c9-6b35-9263f1d1a2a1"</span><span class="hljs-punctuation">,</span><span class="hljs-attr">"first_name"</span><span class="hljs-punctuation">:</span><span class="hljs-string">"unknown"</span><span class="hljs-punctuation">,</span><span class="hljs-attr">"age"</span><span class="hljs-punctuation">:</span><span class="hljs-number">19</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">{</span><span class="hljs-attr">"country"</span><span class="hljs-punctuation">:</span><span class="hljs-string">"CANADA"</span><span class="hljs-punctuation">,</span><span class="hljs-attr">"amount"</span><span class="hljs-punctuation">:</span><span class="hljs-number">90.1591854077722</span><span class="hljs-punctuation">,</span><span class="hljs-attr">"qty"</span><span class="hljs-punctuation">:</span><span class="hljs-number">4</span><span class="hljs-punctuation">,</span><span class="hljs-attr">"currency"</span><span class="hljs-punctuation">:</span><span class="hljs-string">"USD"</span><span class="hljs-punctuation">,</span><span class="hljs-attr">"order_time"</span><span class="hljs-punctuation">:</span><span class="hljs-number">1723358207371</span><span class="hljs-punctuation">,</span><span class="hljs-attr">"category"</span><span class="hljs-punctuation">:</span><span class="hljs-string">"Other"</span><span class="hljs-punctuation">,</span><span class="hljs-attr">"device"</span><span class="hljs-punctuation">:</span><span class="hljs-string">"Andriod"</span><span class="hljs-punctuation">,</span><span class="hljs-attr">"user"</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">{</span><span class="hljs-attr">"gender"</span><span class="hljs-punctuation">:</span><span class="hljs-string">"Male"</span><span class="hljs-punctuation">,</span><span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span><span class="hljs-string">"4387ee8b-c8c1-1df4-f2ed-c4541cb97621"</span><span class="hljs-punctuation">,</span><span class="hljs-attr">"first_name"</span><span class="hljs-punctuation">:</span><span class="hljs-string">"unknown"</span><span class="hljs-punctuation">,</span><span class="hljs-attr">"age"</span><span class="hljs-punctuation">:</span><span class="hljs-number">26</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">{</span><span class="hljs-attr">"country"</span><span class="hljs-punctuation">:</span><span class="hljs-string">"INDIA"</span><span class="hljs-punctuation">,</span><span class="hljs-attr">"amount"</span><span class="hljs-punctuation">:</span><span class="hljs-number">59.17956535472526</span><span class="hljs-punctuation">,</span><span class="hljs-attr">"qty"</span><span class="hljs-punctuation">:</span><span class="hljs-number">2</span><span class="hljs-punctuation">,</span><span class="hljs-attr">"currency"</span><span class="hljs-punctuation">:</span><span class="hljs-string">"USD"</span><span class="hljs-punctuation">,</span><span class="hljs-attr">"order_time"</span><span class="hljs-punctuation">:</span><span class="hljs-number">1723358207381</span><span class="hljs-punctuation">,</span><span class="hljs-attr">"category"</span><span class="hljs-punctuation">:</span><span class="hljs-string">"TOY"</span><span class="hljs-punctuation">,</span><span class="hljs-attr">"device"</span><span class="hljs-punctuation">:</span><span class="hljs-string">"Andriod"</span><span class="hljs-punctuation">,</span><span class="hljs-attr">"user"</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">{</span><span class="hljs-attr">"gender"</span><span class="hljs-punctuation">:</span><span class="hljs-string">"Female"</span><span class="hljs-punctuation">,</span><span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span><span class="hljs-string">"d8ded433-8f1c-c6e7-99b2-854695935764"</span><span class="hljs-punctuation">,</span><span class="hljs-attr">"first_name"</span><span class="hljs-punctuation">:</span><span class="hljs-string">"unknown"</span><span class="hljs-punctuation">,</span><span class="hljs-attr">"age"</span><span class="hljs-punctuation">:</span><span class="hljs-number">11</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">}</span>
</code></pre>
<h2 data-id="heading-8">定义数据源</h2>
<p>数据源选择Add Streaming Table：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d172b444f02d42b8a022951cf88a18ad~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764896486&amp;x-signature=1rypXFhxDYv28Ao%2FK5m9g8OQbtw%3D" alt="Add Streaming Tablet" loading="lazy"/>
点击之后，把刚才的JSON填写进去，就可以解析出来：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5b8c4e13c810461f80cafa4808cbfa08~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764896486&amp;x-signature=HNpF1jot%2BId3FzJ43Qi4sWs32F4%3D" alt="Steaming Tablet And Cluster INFO" loading="lazy"/>
定义Kafka信息，填写对应的内容，如下图所示：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e7bdba0b728c4390955ab3a3805a4372~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764896486&amp;x-signature=3sJy4YytReqpgxcRWCm9tyIQwEU%3D" alt="Kafka Setting" loading="lazy"/>
可以看到我们刚才添加的内容如下图所示：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/73e76ae15b754f479846bbd1aeee5fb3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764896486&amp;x-signature=w8YXkTdIfqWFRC77XgXtlez0%2BFM%3D" alt="Kylin Data Source" loading="lazy"/></p>
<h2 data-id="heading-9">定义Model</h2>
<p>新建Model，如下图所示，名称随意：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4959fe7b18c54cdba9ecfce98b16ca7d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764896486&amp;x-signature=LPvDbNre7Qs8VaVkTbuCFAVjYO0%3D" alt="Kylin Model Designer" loading="lazy"/>
原则DataModel，如下图所示：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/75bf4b97f0a04d23a47e31859781c9bc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764896486&amp;x-signature=1xryifpBMJ2y0do%2ByiD10g%2FkVrM%3D" alt="Kylin Data Model" loading="lazy"/>
选择维度Dimension信息：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4f78acb98cf344618283de30c7b4cff6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764896486&amp;x-signature=JESu0wJ9Tj2WcwCwCGnQxC1WOh4%3D" alt="Kylin Dimension" loading="lazy"/>
选择度量Measures，如下图所示：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/13119b9f5b824129baff06156f8cf8a8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764896486&amp;x-signature=Kjslwncc5YQnHRYVEW%2FrUPRsHtw%3D" alt="Kylin Measures" loading="lazy"/>
设置Setting中，设置对应的PartitionDateColumn信息，如下图：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0cb5763b8f2644238dbce316c3315390~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764896486&amp;x-signature=UjIeLq1AL5qibhVAllXNGhYgvEE%3D" alt="Kylin Partition Data Column" loading="lazy"/></p>
<h2 data-id="heading-10">定义Cube</h2>
<p>名字随意，自己能分清就可以，如下图：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1b5c79ac4f544f6ba50f1bc33936f4bc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764896486&amp;x-signature=97qM8iC2DeGzGfF2kYfIfc0uvg0%3D" alt="Kylin Cube" loading="lazy"/>
设置Dimensions信息如下图所示：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e0377fb1ac6d474286ddeaf0e50e6149~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764896486&amp;x-signature=%2FgVXgcGd09M2H6WTCIbL2XnXEgU%3D" alt="Kylin Dimensions" loading="lazy"/>
设置度量Measure信息如下图所示：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d8cfc97e2e634236800ae17ff6e7be5b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764896486&amp;x-signature=tpOlsdL%2BE1JIGjWulGfbgoUJqUo%3D" alt="Cube Measure" loading="lazy"/>
RefreshSetting设置信息如下图所示：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fe3e7e78e5204681810fd5a9ffeadb3d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764896486&amp;x-signature=%2Bhs7gyVr5mkMDNv04LZA9hvIs1A%3D" alt="Cube Refresh Setting" loading="lazy"/>
设置Aggregation Groups信息：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/48a961a77e8a404ab0ccb3b91c163332~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764896486&amp;x-signature=iNny7Ha6yWAS0Pjx3jhZWURkJx4%3D" alt="Cube Aggregation Groups" loading="lazy"/>
RowKeys的设置如下图所示：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/901fb6b28fc348b98fe4bd183db61923~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764896486&amp;x-signature=TDwqPGr6lHKx%2FAnEWzgY37lsFQ4%3D" alt="Cube Rowkeys" loading="lazy"/>
StreamingCube 和 普通的Cube大致上一样，以下几点需要注意：</p>
<ul>
<li>分区时间列应该Cube的一个Dimension，在SteamingOLAP中时间总是一个查询条件，Kylin利用它来缩小扫描分区的范围</li>
<li>不要使用order time作为dimmension 因为它非常精细，建议使用minute_start、hour_start或其他，取决于用户如何查询数据</li>
<li>定义 year_start、quarter_start、month_start、day_start、hour_start、minute_start或其他，取决于用户如何查询数据</li>
<li>在RefreshSetting设置中，创建更多合并的范围，如0.5时、4小时、1天、7天，这样设置有助于控制CubeSegment的数量</li>
<li>在RowKeys部分，拖拽minute_start到最上面的位置，对于Streaming查询，时间条件会一直显示，将其放到前面将会缩小扫描范围。</li>
</ul>
<h2 data-id="heading-11">构建Cube</h2>
<p>可以通过 HTTP 的方式完成构建</p>
<pre><code class="hljs language-shell" lang="shell">curl -X PUT --user ADMIN:KYLIN -H "Content-Type:
application/json;charset=utf-8" -d '{ "sourceOffsetStart": 0, "sourceOffsetEnd": 9223372036854775807, "buildType": "BUILD"}' http://h122.wzk.icu:7070/kylin/api/cubes/streaming_cube1/build2
</code></pre>
<p>也可以使用WebUI，我比较喜欢用页面来构建：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/09a8fe3a3d37468c91ef08469dc2010d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764896486&amp;x-signature=nU1TSXEQ6uWi2oruUVlUfWkFe%2BY%3D" alt="Cube Web UI" loading="lazy"/></p>
<h2 data-id="heading-12">执行查询</h2>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">select</span> minute_start, <span class="hljs-built_in">count</span>(<span class="hljs-operator">*</span>), <span class="hljs-built_in">sum</span>(amount), <span class="hljs-built_in">sum</span>(qty) <span class="hljs-keyword">from</span> streamingds1
<span class="hljs-keyword">group</span> <span class="hljs-keyword">by</span> minute_start
<span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> minute_start
</code></pre>
<h2 data-id="heading-13">自动构建</h2>
<p>用 crontab 来定时任务，让其定时执行：</p>
<pre><code class="hljs language-shell" lang="shell">crontab -e */20 * * * * curl -X PUT --user ADMIN:KYLIN -H "Content-Type:application/json;charset=utf-8" -d '{ "sourceOffsetStart": 0, "sourceOffsetEnd": 9223372036854775807, "buildType": "BUILD"}' http://h122.wzk.icu:7070/kylin/api/cubes/streaming_cube1/build2
</code></pre>
<h2 data-id="heading-14">错误速查</h2>



















































































<table><thead><tr><th>症状</th><th>根因</th><th>定位</th><th>修复</th></tr></thead><tbody><tr><td>Cube 无新数据</td><td>消费组 offset 越界/Topic 名错误</td><td>Kylin Job 日志、kafka-consumer-groups</td><td>重置 offset；校验 topic/分区；确保消费者组一致</td></tr><tr><td>解析失败“缺少时间戳/字段”</td><td>字段名与解析器不匹配；格式不符</td><td>Kylin 解析日志</td><td>统一字段命名；在采集端转换时间戳格式或自定义 Parser</td></tr><tr><td>查询全表扫/极慢</td><td>未加时间过滤；时间分区列未前置 RowKey</td><td>查询计划/扫描段数</td><td>SQL 强制时间条件；调整 RowKeys 顺序</td></tr><tr><td>段数量爆炸</td><td>微批过细、合并窗口过小</td><td>Segment 列表</td><td>调整 Refresh 合并：0.5h/4h/1d/7d；降低触发频率</td></tr><tr><td>构建任务长时间 Pending</td><td>YARN/队列资源不足</td><td>YARN UI/Kylin Job 状态</td><td>提升队列资源；串行化构建；控制并发</td></tr><tr><td>聚合结果异常偏大</td><td>重复消费/去重缺失</td><td>源数据与 segment 对比</td><td>引入唯一键与幂等；窗口去重或业务去重逻辑</td></tr><tr><td>Kafka 命令报错 --zookeeper</td><td>新版 Kafka 已改参</td><td>CLI 输出</td><td>使用 --bootstrap-server；统一脚本</td></tr><tr><td>Parser 找不到嵌套字段</td><td>默认不展开深层结构</td><td>解析日志</td><td>采集端扁平化（user_gender 等）或扩展 Parser</td></tr><tr><td>构建 REST 401/403</td><td>认证配置错误</td><td>HTTP 响应/网关日志</td><td>校验账户凭证；必要时改为 Token 或白名单</td></tr><tr><td>SQL 命中率低/未走 Cube</td><td>维度/AGG Group 不匹配</td><td>查询详情/推断器</td><td>调整 Aggregation Groups；增加派生维度/层级</td></tr><tr><td>Cron 未触发</td><td>环境变量/语法问题</td><td>/var/log/cron*</td><td>使用绝对路径；*/20 * * * * 语法；补全 PATH</td></tr><tr><td>时间戳错位</td><td>ms/秒/ISO8601 混用</td><td>样例数据/Parser 输出</td><td>统一标准（ms 或 ISO8601）；在采集端转换并校验</td></tr></tbody></table>
<h2 data-id="heading-15">其他系列</h2>
<h3 data-id="heading-16">🚀 AI篇持续更新中（长期更新）</h3>
<p><strong>AI炼丹日志-29 - 字节跳动 DeerFlow 深度研究框<em>斜体样式</em>架 私有部署 测试上手 架构研究</strong>，持续打造实用AI工具指南！
<strong>AI研究-127 Qwen2.5-Omni 深解：Thinker-Talker 双核、TMRoPE 与流式语音</strong>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fw776341482%2Fcategory_12794137.html" target="_blank" title="https://blog.csdn.net/w776341482/category_12794137.html" ref="nofollow noopener noreferrer">🔗 AI模块直达链接 </a></p>
<h3 data-id="heading-17">💻 Java篇持续更新中（长期更新）</h3>
<p><strong>Java-174 FastFDS 从单机到分布式文件存储：实战与架构取舍</strong>
MyBatis 已完结，Spring 已完结，Nginx已完结，Tomcat已完结，分布式服务已完结，Dubbo已完结，MySQL已完结，MongoDB已完结，Neo4j已完结，FastDFS 正在更新，深入浅出助你打牢基础！
<a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fw776341482%2Fcategory_12833348.html" target="_blank" title="https://blog.csdn.net/w776341482/category_12833348.html" ref="nofollow noopener noreferrer">🔗 Java模块直达链接</a></p>
<h3 data-id="heading-18">📊 大数据板块已完成多项干货更新（300篇）：</h3>
<p>包括 Hadoop、Hive、Kafka、Flink、ClickHouse、Elasticsearch 等二十余项核心组件，覆盖离线+实时数仓全栈！
<strong>大数据-278 Spark MLib - 基础介绍 机器学习算法 梯度提升树 GBDT案例 详解</strong>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fw776341482%2Fcategory_12713819.html" target="_blank" title="https://blog.csdn.net/w776341482/category_12713819.html" ref="nofollow noopener noreferrer">🔗 大数据模块直达链接</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[线性数据结构]]></title>    <link>https://juejin.cn/post/7577218195234308142</link>    <guid>https://juejin.cn/post/7577218195234308142</guid>    <pubDate>2025-11-28T01:02:28.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577218195234308142" data-draft-id="7575031395862462510" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="线性数据结构"/> <meta itemprop="keywords" content="Java"/> <meta itemprop="datePublished" content="2025-11-28T01:02:28.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="SevenCoding"/> <meta itemprop="url" content="https://juejin.cn/user/3261615728242467"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            线性数据结构
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3261615728242467/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    SevenCoding
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-28T01:02:28.000Z" title="Fri Nov 28 2025 01:02:28 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读28分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>线性表示最常⽤⽽且最为简单的⼀种数据结构，⼀个线性表示 n 个数据元素的有限序列，有以下特点：</p>
<ul>
<li>存在唯⼀的第⼀个的数据元素</li>
<li>存在唯⼀被称为最后⼀个的数据元素</li>
<li>除了第⼀个以外，集合中每⼀个元素均有⼀个前驱</li>
<li>除了最后⼀个元素之外，集合中的每⼀个数据元素都有⼀个后继元素</li>
</ul>
<p>线性表包括下⾯⼏种：</p>
<ul>
<li>数组：查询 / 更新快，查找/删除慢</li>
<li>链表</li>
<li>队列</li>
<li>栈</li>
</ul>
<h2 data-id="heading-0">数组</h2>
<h3 data-id="heading-1">数组简介</h3>
<p><strong>数组（Array）</strong> 是一种很常见的数据结构。它由相同类型的元素（element）组成，并且是使用一块连续的内存来存储。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ad566c0ea94841b4b32b20cbe4859fc6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2V2ZW5Db2Rpbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764896548&amp;x-signature=2v8RoB3kwac%2BWFvTz%2Fw9YV67Dr4%3D" alt="" loading="lazy"/></p>
<p>在Java 中表示为：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">int</span>[] nums = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[<span class="hljs-number">100</span>];
<span class="hljs-type">int</span>[] nums = {<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>};
Object[] Objects = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[<span class="hljs-number">100</span>];
</code></pre>
<p>数组是⼀种线性的结构，⼀般在底层是连续的空间，存储相同类型的数据，由于连续紧凑结构以及天然索引⽀持，查询数据效率⾼。</p>
<p>假设我们知道数组a 的第 1 个值是 地址是 296，⾥⾯的数据类型占 2 个 单位，那么我们如果期望得到第 5 个： 296+（5-1）*2 = 304 , O(1) 的时间复杂度就可以获取到。更新的本质也是查找，先查找到该元素，就可以动⼿更新了：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/15b76ccab8594e958bf863b21031db37~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2V2ZW5Db2Rpbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764896548&amp;x-signature=NSXuMgxhSVqy%2FUAH8pUjDujsgBI%3D" alt="" loading="lazy"/></p>
<p>但是如果期望插⼊数据的话，需要移动后⾯的数据，⽐如下⾯的数组，插⼊元素6 ，最差的是移动所有的元素，时间复杂度为O(n)</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/115107a3f8264e3ab49f31273d856a06~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2V2ZW5Db2Rpbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764896548&amp;x-signature=%2FSQ0O1Hue4yxT2clW0WC0L12bTE%3D" alt="" loading="lazy"/></p>
<p>⽽删除元素则需要把后⾯的数据移动到前⾯，最差的时间复杂度同样为O(n)</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0484e17425cd40ce85b3b65f0fdd065a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2V2ZW5Db2Rpbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764896548&amp;x-signature=snrRTwXy2lgZELXyI%2BtJQY7RtO4%3D" alt="" loading="lazy"/></p>
<p>总结：数组的特点是：<strong>提供随机访问</strong> 并且容量有限。</p>
<h3 data-id="heading-2">时间复杂度</h3>
<p>假如数组的长度为 n。</p>
<ul>
<li>访问：O（1）//访问特定位置的元素</li>
<li>插入：O（n ）//最坏的情况发生在插入发生在数组的首部并需要移动所有元素时</li>
<li>删除：O（n）//最坏的情况发生在删除数组的开头发生并需要移动第一元素后面所有的元素时</li>
</ul>
<h3 data-id="heading-3">数组的增删改查实现</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.util.Arrays;
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyArray</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span>[] data;
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> elementCount;
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> length;
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">MyArray</span><span class="hljs-params">(<span class="hljs-type">int</span> max)</span> {
        length = max;
        data = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[max];
        elementCount = <span class="hljs-number">0</span>;
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">add</span><span class="hljs-params">(<span class="hljs-type">int</span> value)</span> {
        <span class="hljs-keyword">if</span> (elementCount == length) {
            length = <span class="hljs-number">2</span> * length;
            data = Arrays.copyOf(data, length);
        }
        data[elementCount] = value;
        elementCount++;
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">find</span><span class="hljs-params">(<span class="hljs-type">int</span> searchKey)</span> {
        <span class="hljs-type">int</span> i;
        <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; elementCount; i++) {
            <span class="hljs-keyword">if</span> (data[i] == searchKey)
            <span class="hljs-keyword">break</span>;
        }
        <span class="hljs-keyword">if</span> (i == elementCount) {
            <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;
        }
        <span class="hljs-keyword">return</span> i;
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">delete</span><span class="hljs-params">(<span class="hljs-type">int</span> value)</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> find(value);
        <span class="hljs-keyword">if</span> (i == -<span class="hljs-number">1</span>) {
        	<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">j</span> <span class="hljs-operator">=</span> i; j &lt; elementCount - <span class="hljs-number">1</span>; j++) {
        	data[j] = data[j + <span class="hljs-number">1</span>];
        }
        elementCount--;
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">update</span><span class="hljs-params">(<span class="hljs-type">int</span> oldValue, <span class="hljs-type">int</span> newValue)</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> find(oldValue);
        <span class="hljs-keyword">if</span> (i == -<span class="hljs-number">1</span>) {
        	<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
        data[i] = newValue;
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
}

<span class="hljs-comment">// 测试类</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">MyArray</span> <span class="hljs-variable">myArray</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyArray</span>(<span class="hljs-number">2</span>);
        myArray.add(<span class="hljs-number">1</span>);
        myArray.add(<span class="hljs-number">2</span>);
        myArray.add(<span class="hljs-number">3</span>);
        myArray.delete(<span class="hljs-number">2</span>);
        System.out.println(myArray);
    }
}
</code></pre>
<h2 data-id="heading-4">链表</h2>
<h3 data-id="heading-5">链表简介</h3>
<p><strong>链表（LinkedList）</strong> 虽然是一种线性表，但是并不会按线性的顺序存储数据，使用的不是连续的内存空间来存储数据。</p>
<p>我们可以看到数组是需要连续的空间，这⾥⾯如果空间⼤⼩只有 2 ，放到第 3 个元素的时候，就不得不扩容，不仅如此，还得拷⻉元素。⼀些删除，插⼊操作会引起较多的数据移动的操作。</p>
<p>链表，也就是链式数据结构，由于它不要求逻辑上相邻的数据元素在物理位置上也相邻，所以它没有顺序存储结构所具有的缺点，但是同时也失去了通过索引下标直接查找元素的优点。</p>
<p>链表的插入和删除操作的复杂度为 O(1) ，只需要知道目标位置元素的上一个元素即可。但是，在查找一个节点或者访问特定位置的节点的时候复杂度为 O(n) 。</p>
<p>使用链表结构可以克服数组需要预先知道数据大小的缺点，链表结构可以充分利用计算机内存空间,实现灵活的内存动态管理。但链表不会节省空间，相比于数组会占用更多的空间，因为链表中每个节点存放的还有指向其他节点的指针。除此之外，链表不具有数组随机读取的优点。</p>
<h3 data-id="heading-6">时间复杂度</h3>
<ul>
<li>查询： O(n)，需要遍历链表</li>
<li>插⼊： O(1) ，修改前后指针即可</li>
<li>删除： O(1) ，同样是修改前后指针即可</li>
<li>修改：不需要查询则为O(1) ，需要查询则为O(n)</li>
</ul>
<h3 data-id="heading-7">链表分类</h3>
<p><strong>常见链表分类：</strong></p>
<ol>
<li>单链表：链表中的每⼀个结点，都有且只有⼀个指针指向下⼀个结点，并且最后⼀个节点指向空。</li>
<li>双向链表：每个节点都有两个指针（为⽅便，我们称之为前指针，后指针），分别指向上⼀个节点和下⼀个节点，第⼀个节点的前指针指向NULL ，最后⼀个节点的后指针指向NULL</li>
<li>循环链表：每⼀个节点的指针指向下⼀个节点，并且最后⼀个节点的指针指向第⼀个节点（虽然是循环链表，但是必要的时候还需要标识头结点或者尾节点，避免死循环）</li>
<li>双向循环链表：同时满足双向链表和循环链表的能力</li>
</ol>
<h4 data-id="heading-8">单链表</h4>
<p><strong>单链表</strong> 单向链表只有一个方向，结点只有一个后继指针 next 指向后面的节点。因此，链表这种数据结构通常在物理内存上是不连续的。我们习惯性地把第一个结点叫作头结点，链表通常有一个不保存任何值的 head 节点(头结点)，通过头结点我们可以遍历整个链表。尾结点通常指向 null。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/956f16556e334b8f8b31b1a75c639fce~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2V2ZW5Db2Rpbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764896548&amp;x-signature=uwx78p7KFlXz6Qoo38Yo%2FunNggo%3D" alt="" loading="lazy"/></p>
<p>单向链表的查找更新⽐较简单，我们看看插⼊新节点的具体过程（这⾥只展示中间位置的插⼊，头尾插⼊⽐较简单）：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8f9e7bf0f63346aaa4433b995dfca596~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2V2ZW5Db2Rpbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764896548&amp;x-signature=LllV%2FWtMYb8jE8e%2BAK0q2ZT3Mog%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c731e5e49b404376935b744a8a90d232~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2V2ZW5Db2Rpbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764896548&amp;x-signature=mW9XTB7RrpwK%2FzNvA6arFH%2BI9jI%3D" alt="" loading="lazy"/></p>
<p>那如何删除⼀个中间的节点呢？下⾯是具体的过程：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6f4a93a92b7547e7b2739799e57cea35~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2V2ZW5Db2Rpbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764896548&amp;x-signature=d%2FBaDp7l7mC8l0yl8D0FBjeNpHk%3D" alt="" loading="lazy"/></p>
<p>或许你会好奇， a5 节点只是指针没有了，那它去哪⾥了？</p>
<p>如果是Java 程序，垃圾回收器会收集这种没有被引⽤的节点，帮我们回收掉了这部分内存，但是为了加快垃圾回收的速度，⼀般不需要的节点我们会置空，⽐如 node = null , 如果在C++ 程序中，那么就需要⼿动回收了，否则容易造成内存泄漏等问题。</p>
<h4 data-id="heading-9">循环链表</h4>
<p><strong>循环链表</strong> 其实是一种特殊的单链表，和单链表不同的是循环链表的尾结点不是指向 null，而是指向链表的头结点。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ccfe8c58dafa4a0f8502f94146ab69e7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2V2ZW5Db2Rpbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764896548&amp;x-signature=KZn76zR%2FdQk01ilIkd4Mkckx%2FIQ%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-10">双向链表</h4>
<p><strong>双向链表</strong> 包含两个指针，一个 prev 指向前一个节点，一个 next 指向后一个节点。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d357184109ac4bdfb332e9349565025b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2V2ZW5Db2Rpbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764896548&amp;x-signature=S84NVBTCv9YCQDE1VFe%2BV%2BGMDvA%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-11">双向循环链表</h4>
<p><strong>双向循环链表</strong> 最后一个节点的 next 指向 head，而 head 的 prev 指向最后一个节点，构成一个环。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bca00efb614e4c6a881a1f92fb7a945d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2V2ZW5Db2Rpbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764896548&amp;x-signature=1V3Oa8EazzUgAJKgnulE60wuOUE%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-12">应用场景</h3>
<ul>
<li>如果需要支持随机访问的话，链表没办法做到。</li>
<li>如果需要存储的数据元素的个数不确定，并且需要经常添加和删除数据的话，使用链表比较合适。</li>
<li>如果需要存储的数据元素的个数确定，并且不需要经常添加和删除数据的话，使用数组比较合适。</li>
</ul>
<h3 data-id="heading-13">数组 vs 链表</h3>
<ul>
<li>数组支持随机访问，而链表不支持。</li>
<li>数组使用的是连续内存空间对 CPU 的缓存机制友好，链表则相反。</li>
<li>数组的大小固定，而链表则天然支持动态扩容。如果声明的数组过小，需要另外申请一个更大的内存空间存放数组元素，然后将原数组拷贝进去，这个操作是比较耗时的！</li>
</ul>
<h3 data-id="heading-14">单向链表的增删改查实现</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ListNode</span> {
    <span class="hljs-type">int</span> val;
    <span class="hljs-type">ListNode</span> <span class="hljs-variable">next</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
    ListNode(<span class="hljs-type">int</span> val) {
    	<span class="hljs-built_in">this</span>.val = val;
    }
}
</code></pre>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyList</span>&lt;T&gt; {
    <span class="hljs-keyword">private</span> ListNode&lt;T&gt; head;
    <span class="hljs-keyword">private</span> ListNode&lt;T&gt; tail;
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> size;
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">MyList</span><span class="hljs-params">()</span> {
        <span class="hljs-built_in">this</span>.head = <span class="hljs-literal">null</span>;
        <span class="hljs-built_in">this</span>.tail = <span class="hljs-literal">null</span>;
        <span class="hljs-built_in">this</span>.size = <span class="hljs-number">0</span>;
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">add</span><span class="hljs-params">(T element)</span> {
    	add(size, element);
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">add</span><span class="hljs-params">(<span class="hljs-type">int</span> index, T element)</span> {
        <span class="hljs-keyword">if</span> (index &lt; <span class="hljs-number">0</span> || index &gt; size) {
        	<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IndexOutOfBoundsException</span>(<span class="hljs-string">"超出链表⻓度范围"</span>);
        }
        <span class="hljs-type">ListNode</span> <span class="hljs-variable">current</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ListNode</span>(element);
        <span class="hljs-keyword">if</span> (index == <span class="hljs-number">0</span>) {
        	<span class="hljs-keyword">if</span> (head == <span class="hljs-literal">null</span>) {
            	head = current;
        		tail = current;
        	} <span class="hljs-keyword">else</span> {
                current.next = head;
                head = current;
            }
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (index == size) {
            tail.next = current;
            tail = current;
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-type">ListNode</span> <span class="hljs-variable">preNode</span> <span class="hljs-operator">=</span> get(index - <span class="hljs-number">1</span>);
            current.next = preNode.next;
            preNode.next = current;
        }
        size++;
    }
    
    <span class="hljs-keyword">public</span> ListNode <span class="hljs-title function_">get</span><span class="hljs-params">(<span class="hljs-type">int</span> index)</span> {
        <span class="hljs-keyword">if</span> (index &lt; <span class="hljs-number">0</span> || index &gt;= size) {
        	<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IndexOutOfBoundsException</span>(<span class="hljs-string">"超出链表⻓度"</span>);
        }
        <span class="hljs-type">ListNode</span> <span class="hljs-variable">temp</span> <span class="hljs-operator">=</span> head;
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; index; i++) {
        	temp = temp.next;
        }
        <span class="hljs-keyword">return</span> temp;
    }
    
    <span class="hljs-keyword">public</span> ListNode <span class="hljs-title function_">delete</span><span class="hljs-params">(<span class="hljs-type">int</span> index)</span> {
        <span class="hljs-keyword">if</span> (index &lt; <span class="hljs-number">0</span> || index &gt;= size) {
        	<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IndexOutOfBoundsException</span>(<span class="hljs-string">"超出链表节点范围"</span>);
        }
        <span class="hljs-type">ListNode</span> <span class="hljs-variable">node</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
        <span class="hljs-keyword">if</span> (index == <span class="hljs-number">0</span>) {
            node = head;
            head = head.next;
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (index == size - <span class="hljs-number">1</span>) {
            <span class="hljs-type">ListNode</span> <span class="hljs-variable">preNode</span> <span class="hljs-operator">=</span> get(index - <span class="hljs-number">1</span>);
            node = tail;
            preNode.next = <span class="hljs-literal">null</span>;
            tail = preNode;
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-type">ListNode</span> <span class="hljs-variable">pre</span> <span class="hljs-operator">=</span> get(index - <span class="hljs-number">1</span>);
            pre.next = pre.next.next;
            node = pre.next;
        }
        size--;
        <span class="hljs-keyword">return</span> node;
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">update</span><span class="hljs-params">(<span class="hljs-type">int</span> index, T element)</span> {
        <span class="hljs-keyword">if</span> (index &lt; <span class="hljs-number">0</span> || index &gt;= size) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IndexOutOfBoundsException</span>(<span class="hljs-string">"超出链表节点范围"</span>);
        }
        <span class="hljs-type">ListNode</span> <span class="hljs-variable">node</span> <span class="hljs-operator">=</span> get(index);
        node.val = element;
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">display</span><span class="hljs-params">()</span> {
        <span class="hljs-type">ListNode</span> <span class="hljs-variable">temp</span> <span class="hljs-operator">=</span> head;
        <span class="hljs-keyword">while</span> (temp != <span class="hljs-literal">null</span>) {
            System.out.print(temp.val + <span class="hljs-string">" -&gt; "</span>);
            temp = temp.next;
        }
        System.out.println(<span class="hljs-string">""</span>);
    }
}
</code></pre>
<h3 data-id="heading-15">扩展：跳表</h3>
<p>链表如果搜索，是很麻烦的，如果这个节点在最后，需要遍历所有的节点，才能找到，查找效率实在太低，有没有什么好的办法呢？</p>
<p>办法总⽐问题多，但是想要绝对的” 多快好省“是不存在的，有舍有得，计算机的世界⾥，充满哲学的味道。既然搜索效率有问题，那么我们不如给链表排个序。排序后的链表，还是只能知道头尾节点，知道中间的范围，但是要找到中间的节点，还是得⾛遍历的⽼路。如果我们把中间节点存储起来呢？存起来，确实我们就知道数据在前⼀半，还是在后⼀半。⽐如找7 ，肯定就从中间节点开始找。如果查找4 ,就得从头开始找，最差到中间节点，就停⽌查找。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ec79a3cc9b5242a7ab9fc9bb2761d5e1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2V2ZW5Db2Rpbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764896548&amp;x-signature=%2BR1yqZYxbe%2Fmzn6PEWST3SEyhBo%3D" alt="" loading="lazy"/></p>
<p>但是如此，还是没有彻底解决问题，因为链表很⻓的情况，只能通过前后两部分查找。不如回到原则：空间和时间，我们选择时间，那就要舍弃⼀部分空间,我们每个节点再加⼀个指针，现在有 2 层指针（注意：节点只有⼀份，都是同⼀个节点，只是为了好看，弄了两份，实际上是同⼀个节点，有两个指针，⽐如 1 ，既指向2，也指向5）：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d6662ad69cc543959768f5ad8aaed07d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2V2ZW5Db2Rpbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764896548&amp;x-signature=Gz7T2Dblii4p8dtSAxr9zIlR2Jw%3D" alt="" loading="lazy"/></p>
<p>两层指针，问题依然存在，那就不断加层，⽐如每两个节点，就加⼀层：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/48c12069c0464466b0525753f2a5568b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2V2ZW5Db2Rpbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764896548&amp;x-signature=CRsoddh2%2FwGRVpNR4%2FfrFX8cDHk%3D" alt="" loading="lazy"/></p>
<p>这就是跳表了，跳表的定义如下：</p>
<p>跳表(SkipList，全称跳跃表)是⽤于有序元素序列快速搜索查找的⼀个数据结构，跳表是⼀个随机化的数据结构，实质就是⼀种可以进⾏⼆分查找的有序链表。跳表在原有的有序链表上⾯增加了多级索引，通过索引来实现快速查找。跳表不仅能提⾼搜索性能，同时也可以提⾼插⼊和删除操作的性能。它在性能上和红⿊树，AVL树不相上下，但是跳表的原理⾮常简单，实现也⽐红⿊树简单很多。</p>
<p>主要的原理是⽤空间换时间，可以实现近乎⼆分查找的效率，实际上消耗的空间，假设每两个加⼀层，1 + 2 + 4 + ... + n = 2n-1 ,多出了差不多⼀倍的空间。你看它像不像书的⽬录，⼀级⽬录，⼆级，三级 ...</p>
<p>如果我们不断往跳表中插⼊数据，可能出现某⼀段节点会特别多的情况，这个时候就需要动态更新索引，除了插⼊数据，还要插⼊到上⼀层的链表中，保证查询效率。redis 中使⽤了<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.seven97.top%2Fdatabase%2Fredis%2F02-basement1-datastructure.html%23%25E8%25B7%25B3%25E8%25A1%25A8" target="_blank" title="https://www.seven97.top/database/redis/02-basement1-datastructure.html#%E8%B7%B3%E8%A1%A8" ref="nofollow noopener noreferrer">跳表来实现zset</a> , redis 中使⽤⼀个随机算法来计算层级，计算出每个节点到底多少层索引，虽然不能绝对保证⽐较平衡，但是基本保证了效率，实现起来⽐那些平衡树，红⿊树的算法简单⼀点。</p>
<p>在跳表中，每个节点包含以下几个组成部分：</p>
<ul>
<li>值（value）：节点存储的数据</li>
<li>前进指针数组（forward array）：指向不同层级的后继节点</li>
<li>层高（level）：该节点的最大层级</li>
</ul>
<p>跳表核心特性：</p>
<ol>
<li>多层结构：由最底层的原始有序链表，以及若干层索引组成</li>
<li>概率平衡：通过随机函数决定节点的层数，无需复杂的平衡操作</li>
<li>快速查找：能够跳过大量节点，实现对数级别的查找效率</li>
<li>有序性：所有节点按关键字排序</li>
<li>空间换时间：使用额外的索引指针提高查询速度</li>
</ol>
<h4 data-id="heading-16">基本操作</h4>
<ul>
<li>
<p>查找（Search）：查找过程从最高层开始，沿着当前层前进，直到遇到大于或等于目标值的节点：</p>
<ol>
<li>如果找到目标值，返回该节点</li>
<li>如果当前节点的下一个值大于目标值，则降至下一层继续查找</li>
<li>如果到达最底层仍未找到，则目标值不存在</li>
</ol>
</li>
<li>
<p>插入（Insert）</p>
<ol>
<li>查找新值的插入位置，同时记录每一层的"插入点"</li>
<li>随机生成新节点的层高</li>
<li>从底层到该节点的最高层，逐层调整指针，将新节点插入到每层链表中</li>
</ol>
</li>
<li>
<p>删除（Delete）</p>
<ol>
<li>查找待删除节点的位置，同时记录每一层的前驱节点</li>
<li>如果找到该节点，从该节点的最高层到底层，逐层调整前驱节点的指针，绕过待删除节点</li>
</ol>
</li>
</ul>
<h4 data-id="heading-17">基础实现</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.util.Random;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SkipList</span>&lt;T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Comparable</span>&lt;T&gt;&gt; {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">MAX_LEVEL</span> <span class="hljs-operator">=</span> <span class="hljs-number">16</span>; <span class="hljs-comment">// 最大层数</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">double</span> <span class="hljs-variable">P</span> <span class="hljs-operator">=</span> <span class="hljs-number">0.5</span>;     <span class="hljs-comment">// 提升层级的概率</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> level;                       <span class="hljs-comment">// 当前跳表的最大层数</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Node&lt;T&gt; header;            <span class="hljs-comment">// 头节点</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Random random;             <span class="hljs-comment">// 用于随机层数的生成</span>

    <span class="hljs-comment">// 节点定义</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Node</span>&lt;T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Comparable</span>&lt;T&gt;&gt; {
        T value;                  <span class="hljs-comment">// 节点值</span>
        Node&lt;T&gt;[] forward;        <span class="hljs-comment">// 前进指针数组</span>

        <span class="hljs-meta">@SuppressWarnings("unchecked")</span>
        Node(T value, <span class="hljs-type">int</span> level) {
            <span class="hljs-built_in">this</span>.value = value;
            <span class="hljs-built_in">this</span>.forward = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Node</span>[level + <span class="hljs-number">1</span>];
        }
    }

    <span class="hljs-comment">// 构造函数</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">SkipList</span><span class="hljs-params">()</span> {
        <span class="hljs-built_in">this</span>.level = <span class="hljs-number">0</span>;
        <span class="hljs-built_in">this</span>.header = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Node</span>&lt;&gt;(<span class="hljs-literal">null</span>, MAX_LEVEL);
        <span class="hljs-built_in">this</span>.random = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Random</span>();
    }

    <span class="hljs-comment">// 随机生成层数</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-title function_">randomLevel</span><span class="hljs-params">()</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">lvl</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
        <span class="hljs-keyword">while</span> (lvl &lt; MAX_LEVEL &amp;&amp; random.nextDouble() &lt; P) {
            lvl++;
        }
        <span class="hljs-keyword">return</span> lvl;
    }

    <span class="hljs-comment">// 查找操作</span>
    <span class="hljs-keyword">public</span> Node&lt;T&gt; <span class="hljs-title function_">search</span><span class="hljs-params">(T value)</span> {
        Node&lt;T&gt; current = header;
        
        <span class="hljs-comment">// 从最高层开始查找</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> level; i &gt;= <span class="hljs-number">0</span>; i--) {
            <span class="hljs-comment">// 在当前层向前移动，直到找到大于等于目标值的节点</span>
            <span class="hljs-keyword">while</span> (current.forward[i] != <span class="hljs-literal">null</span> &amp;&amp; 
                   current.forward[i].value.compareTo(value) &lt; <span class="hljs-number">0</span>) {
                current = current.forward[i];
            }
        }
        
        <span class="hljs-comment">// 现在我们在第0层，并且current是目标值的前一个节点</span>
        current = current.forward[<span class="hljs-number">0</span>];
        
        <span class="hljs-comment">// 检查是否找到目标值</span>
        <span class="hljs-keyword">if</span> (current != <span class="hljs-literal">null</span> &amp;&amp; current.value.compareTo(value) == <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">return</span> current;
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        }
    }

    <span class="hljs-comment">// 插入操作</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">insert</span><span class="hljs-params">(T value)</span> {
        <span class="hljs-meta">@SuppressWarnings("unchecked")</span>
        Node&lt;T&gt;[] update = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Node</span>[MAX_LEVEL + <span class="hljs-number">1</span>];
        Node&lt;T&gt; current = header;

        <span class="hljs-comment">// 查找插入位置并记录每层的前驱节点</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> level; i &gt;= <span class="hljs-number">0</span>; i--) {
            <span class="hljs-keyword">while</span> (current.forward[i] != <span class="hljs-literal">null</span> &amp;&amp; 
                   current.forward[i].value.compareTo(value) &lt; <span class="hljs-number">0</span>) {
                current = current.forward[i];
            }
            update[i] = current;
        }
        
        <span class="hljs-comment">// 获取新节点的随机层数</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">newLevel</span> <span class="hljs-operator">=</span> randomLevel();
        
        <span class="hljs-comment">// 如果新层数比当前跳表的最大层数大，更新跳表层数</span>
        <span class="hljs-keyword">if</span> (newLevel &gt; level) {
            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> level + <span class="hljs-number">1</span>; i &lt;= newLevel; i++) {
                update[i] = header;
            }
            level = newLevel;
        }
        
        <span class="hljs-comment">// 创建新节点</span>
        Node&lt;T&gt; newNode = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Node</span>&lt;&gt;(value, newLevel);
        
        <span class="hljs-comment">// 插入节点到各层链表中</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt;= newLevel; i++) {
            newNode.forward[i] = update[i].forward[i];
            update[i].forward[i] = newNode;
        }
    }

    <span class="hljs-comment">// 删除操作</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">delete</span><span class="hljs-params">(T value)</span> {
        <span class="hljs-meta">@SuppressWarnings("unchecked")</span>
        Node&lt;T&gt;[] update = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Node</span>[MAX_LEVEL + <span class="hljs-number">1</span>];
        Node&lt;T&gt; current = header;

        <span class="hljs-comment">// 查找删除位置并记录每层的前驱节点</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> level; i &gt;= <span class="hljs-number">0</span>; i--) {
            <span class="hljs-keyword">while</span> (current.forward[i] != <span class="hljs-literal">null</span> &amp;&amp; 
                   current.forward[i].value.compareTo(value) &lt; <span class="hljs-number">0</span>) {
                current = current.forward[i];
            }
            update[i] = current;
        }
        
        current = current.forward[<span class="hljs-number">0</span>];
        
        <span class="hljs-comment">// 如果找到节点，进行删除</span>
        <span class="hljs-keyword">if</span> (current != <span class="hljs-literal">null</span> &amp;&amp; current.value.compareTo(value) == <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt;= level; i++) {
                <span class="hljs-comment">// 如果当前层的前驱节点指向要删除的节点，则修改指针</span>
                <span class="hljs-keyword">if</span> (update[i].forward[i] == current) {
                    update[i].forward[i] = current.forward[i];
                }
            }
            
            <span class="hljs-comment">// 更新跳表的最大层数</span>
            <span class="hljs-keyword">while</span> (level &gt; <span class="hljs-number">0</span> &amp;&amp; header.forward[level] == <span class="hljs-literal">null</span>) {
                level--;
            }
        }
    }

    <span class="hljs-comment">// 打印跳表内容（用于调试）</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">printSkipList</span><span class="hljs-params">()</span> {
        System.out.println(<span class="hljs-string">"Skip List Structure:"</span>);
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> level; i &gt;= <span class="hljs-number">0</span>; i--) {
            System.out.print(<span class="hljs-string">"Level "</span> + i + <span class="hljs-string">": "</span>);
            Node&lt;T&gt; node = header.forward[i];
            <span class="hljs-keyword">while</span> (node != <span class="hljs-literal">null</span>) {
                System.out.print(node.value + <span class="hljs-string">" "</span>);
                node = node.forward[i];
            }
            System.out.println();
        }
    }
}

<span class="hljs-comment">// 跳表节点</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">SkipListNode</span> {
  constructor(value, level) {
    <span class="hljs-built_in">this</span>.value = value;
    <span class="hljs-built_in">this</span>.forward = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(level + <span class="hljs-number">1</span>).fill(<span class="hljs-literal">null</span>);
  }
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-type">SkipList</span> <span class="hljs-variable">skipList</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SkipList</span>();
skipList.insert(<span class="hljs-number">3</span>);
skipList.insert(<span class="hljs-number">6</span>);
skipList.insert(<span class="hljs-number">7</span>);
console.log(skipList.search(<span class="hljs-number">6</span>)); <span class="hljs-comment">// true</span>
skipList.insert(<span class="hljs-number">9</span>);
skipList.delete(<span class="hljs-number">6</span>);
console.log(skipList.search(<span class="hljs-number">6</span>)); <span class="hljs-comment">// false</span>
</code></pre>
<h2 data-id="heading-18">栈</h2>
<h3 data-id="heading-19">栈简介</h3>
<p><strong>栈 (Stack)</strong> 只允许在有序的线性数据集合的一端（称为栈顶 top）进行加入数据（push）和移除数据（pop）。因而按照 <strong>后进先出（LIFO, Last In First Out）</strong> 的原理运作。**在栈中，push 和 pop 的操作都发生在栈顶。**就像是⼀个桶，只能不断的放在上⾯，取出来的时候，也只能不断的取出最上⾯的数据。要想取出底层的数据，只有等到上⾯的数据都取出来，才能做到。当然，如果有这种需求，我们⼀般会使⽤双向队列。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/909add5d0c4346aa873f9d934ec11166~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2V2ZW5Db2Rpbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764896548&amp;x-signature=rO9CMTvoUWLOo%2Br7fKQZHrJgBD8%3D" alt="" loading="lazy"/></p>
<p>栈常用一维数组或链表来实现，用数组实现的栈叫作 <strong>顺序栈</strong> ，用链表实现的栈叫作 <strong>链式栈</strong> 。<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.seven97.top%2Fjava%2Fcollection%2F02-collection4-queue-stack.html" target="_blank" title="https://www.seven97.top/java/collection/02-collection4-queue-stack.html" ref="nofollow noopener noreferrer">JDK 底层的栈，是⽤数组实现的</a>，封装之后，通过API 操作的永远都只能是最后⼀个元素，栈经常⽤来实现递归的功能。</p>
<p>元素加⼊称之为⼊栈（压栈），取出元素，称之为出栈，栈顶元素则是最后⼀次放进去的元素。使⽤数组实现简单的栈(注意仅供参考测试，实际会有线程安全等问题)</p>
<h3 data-id="heading-20">时间复杂度</h3>
<p>假设堆栈中有n个元素。</p>
<ul>
<li>访问：O（n）//最坏情况</li>
<li>插入删除：O（1）//顶端插入和删除元素</li>
</ul>
<h3 data-id="heading-21">栈的常见应用场景</h3>
<p>当我们我们要处理的数据只涉及在一端插入和删除数据，并且满足 <strong>后进先出（LIFO, Last In First Out）</strong> 的特性时，我们就可以使用栈这个数据结构。</p>
<h4 data-id="heading-22">实现浏览器的回退和前进功能</h4>
<p>我们只需要使用两个栈(Stack1 和 Stack2)和就能实现这个功能。比如你按顺序查看了 1,2,3,4 这四个页面，我们依次把 1,2,3,4 这四个页面压入 Stack1 中。当你想回头看 2 这个页面的时候，你点击回退按钮，我们依次把 4,3 这两个页面从 Stack1 弹出，然后压入 Stack2 中。假如你又想回到页面 3，你点击前进按钮，我们将 3 页面从 Stack2 弹出，然后压入到 Stack1 中。</p>
<h4 data-id="heading-23">检查符号是否成对出现</h4>
<blockquote>
<p>给定一个只包括 <code>'('</code>，<code>')'</code>，<code>'{'</code>，<code>'}'</code>，<code>'['</code>，<code>']'</code> 的字符串，判断该字符串是否有效。</p>
<p>有效字符串需满足：</p>
<ol>
<li>左括号必须用相同类型的右括号闭合。</li>
<li>左括号必须以正确的顺序闭合。</li>
</ol>
<p>比如 "()"、"()[]{}"、"{[]}" 都是有效字符串，而 "(]"、"([)]" 则不是。</p>
</blockquote>
<p>这个问题实际是 Leetcode 的一道题目，我们可以利用栈 <code>Stack</code> 来解决这个问题。</p>
<ol>
<li>首先我们将括号间的对应规则存放在 <code>Map</code> 中，这一点应该毋容置疑；</li>
<li>创建一个栈。遍历字符串，如果字符是左括号就直接加入<code>stack</code>中，否则将<code>stack</code> 的栈顶元素与这个括号做比较，如果不相等就直接返回 false。遍历结束，如果<code>stack</code>为空，返回 <code>true</code>。</li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isValid</span><span class="hljs-params">(String s)</span>{
    <span class="hljs-comment">// 括号之间的对应规则</span>
    HashMap&lt;Character, Character&gt; mappings = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;Character, Character&gt;();
    mappings.put(<span class="hljs-string">')'</span>, <span class="hljs-string">'('</span>);
    mappings.put(<span class="hljs-string">'}'</span>, <span class="hljs-string">'{'</span>);
    mappings.put(<span class="hljs-string">']'</span>, <span class="hljs-string">'['</span>);
    Stack&lt;Character&gt; stack = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Stack</span>&lt;Character&gt;();
    <span class="hljs-type">char</span>[] chars = s.toCharArray();
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; chars.length; i++) {
        <span class="hljs-keyword">if</span> (mappings.containsKey(chars[i])) {
            <span class="hljs-type">char</span> <span class="hljs-variable">topElement</span> <span class="hljs-operator">=</span> stack.empty() ? <span class="hljs-string">'#'</span> : stack.pop();
            <span class="hljs-keyword">if</span> (topElement != mappings.get(chars[i])) {
                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
            }
        } <span class="hljs-keyword">else</span> {
            stack.push(chars[i]);
        }
    }
    <span class="hljs-keyword">return</span> stack.isEmpty();
}
</code></pre>
<h4 data-id="heading-24">反转字符串</h4>
<p>将字符串中的每个字符先入栈再出栈就可以了。</p>
<h4 data-id="heading-25">维护函数调用</h4>
<p>最后一个被调用的函数必须先完成执行，符合栈的 <strong>后进先出（LIFO, Last In First Out）</strong> 特性。<br/>
例如递归函数调用可以通过栈来实现，每次递归调用都会将参数和返回地址压栈。</p>
<h4 data-id="heading-26">深度优先遍历（DFS）</h4>
<p>在深度优先搜索过程中，栈被用来保存搜索路径，以便回溯到上一层。</p>
<h3 data-id="heading-27">栈的实现</h3>
<p>栈既可以通过数组实现，也可以通过链表来实现。不管基于数组还是链表，入栈、出栈的时间复杂度都为 O(1)。</p>
<p>下面我们使用数组来实现一个栈，并且这个栈具有<code>push()</code>、<code>pop()</code>（返回栈顶元素并出栈）、<code>peek()</code> （返回栈顶元素不出栈）、<code>isEmpty()</code>、<code>size()</code>这些基本的方法。</p>
<blockquote>
<p>提示：每次入栈之前先判断栈的容量是否够用，如果不够用就用<code>Arrays.copyOf()</code>进行扩容；</p>
</blockquote>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyStack</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span>[] storage;<span class="hljs-comment">//存放栈中元素的数组</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> capacity;<span class="hljs-comment">//栈的容量</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> count;<span class="hljs-comment">//栈中元素数量</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">GROW_FACTOR</span> <span class="hljs-operator">=</span> <span class="hljs-number">2</span>;

    <span class="hljs-comment">//不带初始容量的构造方法。默认容量为8</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">MyStack</span><span class="hljs-params">()</span> {
        <span class="hljs-built_in">this</span>.capacity = <span class="hljs-number">8</span>;
        <span class="hljs-built_in">this</span>.storage=<span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[<span class="hljs-number">8</span>];
        <span class="hljs-built_in">this</span>.count = <span class="hljs-number">0</span>;
    }

    <span class="hljs-comment">//带初始容量的构造方法</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">MyStack</span><span class="hljs-params">(<span class="hljs-type">int</span> initialCapacity)</span> {
        <span class="hljs-keyword">if</span> (initialCapacity &lt; <span class="hljs-number">1</span>)
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"Capacity too small."</span>);

        <span class="hljs-built_in">this</span>.capacity = initialCapacity;
        <span class="hljs-built_in">this</span>.storage = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[initialCapacity];
        <span class="hljs-built_in">this</span>.count = <span class="hljs-number">0</span>;
    }

    <span class="hljs-comment">//入栈</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">push</span><span class="hljs-params">(<span class="hljs-type">int</span> value)</span> {
        <span class="hljs-keyword">if</span> (count == capacity) {
            ensureCapacity();
        }
        storage[count++] = value;
    }

    <span class="hljs-comment">//确保容量大小</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">ensureCapacity</span><span class="hljs-params">()</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">newCapacity</span> <span class="hljs-operator">=</span> capacity * GROW_FACTOR;
        storage = Arrays.copyOf(storage, newCapacity);
        capacity = newCapacity;
    }

    <span class="hljs-comment">//返回栈顶元素并出栈</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-title function_">pop</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">if</span> (count == <span class="hljs-number">0</span>)
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"Stack is empty."</span>);
        count--;
        <span class="hljs-keyword">return</span> storage[count];
    }

    <span class="hljs-comment">//返回栈顶元素不出栈</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-title function_">peek</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">if</span> (count == <span class="hljs-number">0</span>){
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"Stack is empty."</span>);
        }<span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">return</span> storage[count-<span class="hljs-number">1</span>];
        }
    }

    <span class="hljs-comment">//判断栈是否为空</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isEmpty</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> count == <span class="hljs-number">0</span>;
    }

    <span class="hljs-comment">//返回栈中元素的个数</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-title function_">size</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> count;
    }

}
</code></pre>
<p>验证</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">MyStack</span> <span class="hljs-variable">myStack</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyStack</span>(<span class="hljs-number">3</span>);
myStack.push(<span class="hljs-number">1</span>);
myStack.push(<span class="hljs-number">2</span>);
myStack.push(<span class="hljs-number">3</span>);
myStack.push(<span class="hljs-number">4</span>);
myStack.push(<span class="hljs-number">5</span>);
myStack.push(<span class="hljs-number">6</span>);
myStack.push(<span class="hljs-number">7</span>);
myStack.push(<span class="hljs-number">8</span>);
System.out.println(myStack.peek());<span class="hljs-comment">//8</span>
System.out.println(myStack.size());<span class="hljs-comment">//8</span>
<span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">8</span>; i++) {
    System.out.println(myStack.pop());
}
System.out.println(myStack.isEmpty());<span class="hljs-comment">//true</span>
myStack.pop();<span class="hljs-comment">//报错：java.lang.IllegalArgumentException: Stack is empty.</span>
</code></pre>
<h2 data-id="heading-28">队列</h2>
<h3 data-id="heading-29">队列简介</h3>
<p><strong>队列（Queue）</strong> 是 <strong>先进先出 (FIFO，First In, First Out)</strong> 的线性表。在具体应用中通常用链表或者数组来实现，用数组实现的队列叫作 <strong>顺序队列</strong> ，用链表实现的队列叫作 <strong>链式队列</strong> 。<strong>队列只允许在后端（rear）进行插入操作也就是入队 enqueue，在前端（front）进行删除操作也就是出队 dequeue</strong></p>
<p>队列的操作方式和堆栈类似，唯一的区别在于队列只允许新数据在后端进行添加。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f2bf3f5c9872485084c9cc2204f369bf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2V2ZW5Db2Rpbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764896548&amp;x-signature=4dIPWr6mRIvSVWQkomJSSbNqJgE%3D" alt="" loading="lazy"/></p>
<p>⼀般只要说到先进先出（ FIFO ）,全称First In First Out ,就会想到队列，但是如果你想拥有队列即可以从队头取出元素，⼜可以从队尾取出元素，那就需要⽤到特殊的队列（双向队列），双向队列⼀般使⽤双向链表实现会简单⼀点。</p>
<h3 data-id="heading-30">时间复杂度</h3>
<p>假设队列中有n个元素。</p>
<ul>
<li>访问：O（n）//最坏情况</li>
<li>插入删除：O（1）//后端插入前端删除元素</li>
</ul>
<h3 data-id="heading-31">队列分类</h3>
<h4 data-id="heading-32">单队列</h4>
<p>单队列就是常见的队列, 每次添加元素时，都是添加到队尾。单队列又分为 <strong>顺序队列（数组实现）</strong> 和 <strong>链式队列（链表实现）</strong>。</p>
<p><strong>顺序队列存在“假溢出”的问题也就是明明有位置却不能添加的情况。</strong></p>
<p>假设下图是一个顺序队列，我们将前两个元素 1,2 出队，并入队两个元素 7,8。当进行入队、出队操作的时候，front 和 rear 都会持续往后移动，当 rear 移动到最后的时候,我们无法再往队列中添加数据，即使数组中还有空余空间，这种现象就是 <strong>”假溢出“</strong> 。除了假溢出问题之外，如下图所示，当添加元素 8 的时候，rear 指针移动到数组之外（越界）。</p>
<blockquote>
<p>为了避免当只有一个元素的时候，队头和队尾重合使处理变得麻烦，所以引入两个指针，front 指针指向对头元素，rear 指针指向队列最后一个元素的下一个位置，这样当 front 等于 rear 时，此队列不是还剩一个元素，而是空队列。——From 《大话数据结构》</p>
</blockquote>
<h4 data-id="heading-33">循环队列</h4>
<p>循环队列可以解决顺序队列的假溢出和越界问题。解决办法就是：从头开始，这样也就会形成头尾相接的循环，这也就是循环队列名字的由来。</p>
<p>顺序队列中，我们说 <code>front==rear</code> 的时候队列为空，循环队列中则不一样，也可能为满，如上图所示。解决办法有两种：</p>
<ol>
<li>可以设置一个标志变量 <code>flag</code>,当 <code>front==rear</code> 并且 <code>flag=0</code> 的时候队列为空，当<code>front==rear</code> 并且 <code>flag=1</code> 的时候队列为满。</li>
<li>队列为空的时候就是 <code>front==rear</code> ，队列满的时候，我们保证数组还有一个空闲的位置，rear 就指向这个空闲位置，如下图所示，那么现在判断队列是否为满的条件就是：<code>(rear+1) % QueueSize==front</code> 。</li>
</ol>
<h4 data-id="heading-34">双端队列</h4>
<p><strong>双端队列 (Deque)</strong> 是一种在队列的两端都可以进行插入和删除操作的队列，相比单队列来说更加灵活。</p>
<p>一般来说，我们可以对双端队列进行 <code>addFirst</code>、<code>addLast</code>、<code>removeFirst</code> 和 <code>removeLast</code> 操作。</p>
<h4 data-id="heading-35">优先队列</h4>
<p><strong>优先队列 (Priority Queue)</strong> 从底层结构上来讲并非线性的数据结构，它一般是由堆来实现的。</p>
<ol>
<li>在每个元素入队时，优先队列会将新元素其插入堆中并调整堆。</li>
<li>在队头出队时，优先队列会返回堆顶元素并调整堆。</li>
</ol>
<p>关于堆的具体实现可以看<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.seven97.top%2Fcs-basics%2Fdata-structure%2Fheap.html" target="_blank" title="https://www.seven97.top/cs-basics/data-structure/heap.html" ref="nofollow noopener noreferrer">堆</a>这一节。</p>
<p>总而言之，不论我们进行什么操作，优先队列都能按照<strong>某种排序方式</strong>进行一系列堆的相关操作，从而保证整个集合的<strong>有序性</strong>。</p>
<p>虽然优先队列的底层并非严格的线性结构，但是在我们使用的过程中，我们是感知不到<strong>堆</strong>的，从使用者的眼中优先队列可以被认为是一种线性的数据结构：一种会自动排序的线性队列。</p>
<h3 data-id="heading-36">队列的常见应用场景</h3>
<p>当我们需要按照一定顺序来处理数据的时候可以考虑使用队列这个数据结构。</p>
<ul>
<li><strong>阻塞队列：</strong> 阻塞队列可以看成在队列基础上加了阻塞操作的队列。当队列为空的时候，出队操作阻塞，当队列满的时候，入队操作阻塞。使用阻塞队列我们可以很容易实现“生产者 - 消费者“模型。</li>
<li><strong>线程池中的请求/任务队列：</strong> 线程池中没有空闲线程时，新的任务请求线程资源时，线程池该如何处理呢？答案是将这些请求放在队列中，当有空闲线程的时候，会循环中反复从队列中获取任务来执行。队列分为无界队列(基于链表)和有界队列(基于数组)。无界队列的特点就是可以一直入列，除非系统资源耗尽，比如：<code>FixedThreadPool</code> 使用无界队列 <code>LinkedBlockingQueue</code>。但是有界队列就不一样了，当队列满的话后面再有任务/请求就会拒绝，在 Java 中的体现就是会抛出<code>java.util.concurrent.RejectedExecutionException</code> 异常。</li>
<li>栈：双端队列天生便可以实现栈的全部功能（<code>push</code>、<code>pop</code> 和 <code>peek</code>），并且在 Deque 接口中已经实现了相关方法。Stack 类已经和 Vector 一样被遗弃，现在在 Java 中普遍使用双端队列（Deque）来实现栈。</li>
<li>广度优先搜索（BFS），在图的广度优先搜索过程中，队列被用于存储待访问的节点，保证按照层次顺序遍历图的节点。</li>
<li>Linux 内核进程队列（按优先级排队）</li>
<li>现实生活中的派对，播放器上的播放列表;</li>
<li>消息队列</li>
<li>等等……</li>
</ul>
<h3 data-id="heading-37">单向队列的实现</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Node</span>&lt;T&gt; {
    <span class="hljs-keyword">public</span> T data;
    <span class="hljs-keyword">public</span> Node next;
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Node</span><span class="hljs-params">(T data)</span> {
    	<span class="hljs-built_in">this</span>.data = data;
    }
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyQueue</span>&lt;T&gt; {
    <span class="hljs-keyword">private</span> Node&lt;T&gt; head;
    <span class="hljs-keyword">private</span> Node&lt;T&gt; rear;
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> size;
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">MyQueue</span><span class="hljs-params">()</span> {
    	size = <span class="hljs-number">0</span>;
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">pushBack</span><span class="hljs-params">(T element)</span> {
        <span class="hljs-type">Node</span> <span class="hljs-variable">newNode</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Node</span>(element);
        <span class="hljs-keyword">if</span> (isEmpty()) {
        	head = newNode;
        } <span class="hljs-keyword">else</span> {
        	rear.next = newNode;
        }
        rear = newNode;
        size++;
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isEmpty</span><span class="hljs-params">()</span> {
    	<span class="hljs-keyword">return</span> head == <span class="hljs-literal">null</span>;
    }
    
    <span class="hljs-keyword">public</span> T <span class="hljs-title function_">popFront</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">if</span> (isEmpty()) {
        	<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NullPointerException</span>(<span class="hljs-string">"队列没有数据"</span>);
        } <span class="hljs-keyword">else</span> {
            Node&lt;T&gt; node = head;
            head = head.next;
            size--;
            <span class="hljs-keyword">return</span> node.data;
    	}
	}
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">dispaly</span><span class="hljs-params">()</span> {
        <span class="hljs-type">Node</span> <span class="hljs-variable">temp</span> <span class="hljs-operator">=</span> head;
        <span class="hljs-keyword">while</span> (temp != <span class="hljs-literal">null</span>) {
            System.out.print(temp.data +<span class="hljs-string">" -&gt; "</span>);
            temp = temp.next;
        }
        System.out.println(<span class="hljs-string">""</span>);
    }
}
</code></pre>
<h2 data-id="heading-38">用栈实现队列以及队列实现栈</h2>
<h3 data-id="heading-39">栈实现队列</h3>
<ul>
<li>栈的特性是先进后出</li>
<li>队列的特性是先进先出</li>
</ul>
<p>有两个栈 stack1 , stack2 ；</p>
<ul>
<li>如果有新的数据进⼊，那么我们可以直接 push 到 stack1 ；</li>
<li>如果需要取出数据，那么我们优先取出 stack2 的数据，如果 stack2 ⾥⾯数据是空的，那么我们需要把所有的 stack1 的数据倒⼊ stack2 。再从 stack2 取数据。</li>
</ul>
<p>例如：</p>
<ol>
<li>push 1 --&gt; push 2</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0d85cfe331db41f99127cab047118ca1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2V2ZW5Db2Rpbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764896548&amp;x-signature=K%2BxBff9oE6Cc3n7jDXSyEKd%2Baso%3D" alt="" loading="lazy"/></p>
<ol start="2">
<li>pop 1</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/66c64d4efeaa4c50a41bcf8aec9c4ccb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2V2ZW5Db2Rpbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764896548&amp;x-signature=wiczs7LEbGd6RYM8WaY%2BOaUQHL8%3D" alt="image-20250316170844217" loading="lazy"/></p>
<ol start="3">
<li>push 3 --&gt; push 4</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f857113bab5847219a44272eaaaa1938~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2V2ZW5Db2Rpbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764896548&amp;x-signature=4MZRJEN5WC3YpH4c6Fjsql9UEKs%3D" alt="" loading="lazy"/></p>
<ol start="4">
<li>pop 2</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dd49b4879e3741de8e451a78d760abba~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2V2ZW5Db2Rpbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764896548&amp;x-signature=Dl9gx17UkhpH8EDZO0DSXg%2BBM2c%3D" alt="" loading="lazy"/></p>
<p>算法实现如下：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyQueue</span> {

    Stack&lt;Integer&gt; stackIn;
    Stack&lt;Integer&gt; stackOut;

    <span class="hljs-comment">/** Initialize your data structure here. */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">MyQueue</span><span class="hljs-params">()</span> {
        stackIn = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Stack</span>&lt;&gt;(); <span class="hljs-comment">// 负责进栈</span>
        stackOut = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Stack</span>&lt;&gt;(); <span class="hljs-comment">// 负责出栈</span>
    }
    
    <span class="hljs-comment">/** Push element x to the back of queue. */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">push</span><span class="hljs-params">(<span class="hljs-type">int</span> x)</span> {
        stackIn.push(x);
    }
    
    <span class="hljs-comment">/** Removes the element from in front of queue and returns that element. */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">pop</span><span class="hljs-params">()</span> {    
        dumpstackIn();
        <span class="hljs-keyword">return</span> stackOut.pop();
    }
    
    <span class="hljs-comment">/** Get the front element. */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">peek</span><span class="hljs-params">()</span> {
        dumpstackIn();
        <span class="hljs-keyword">return</span> stackOut.peek();
    }
    
    <span class="hljs-comment">/** Returns whether the queue is empty. */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">empty</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> stackIn.isEmpty() &amp;&amp; stackOut.isEmpty();
    }

    <span class="hljs-comment">// 如果stackOut为空，那么将stackIn中的元素全部放到stackOut中</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">dumpstackIn</span><span class="hljs-params">()</span>{
        <span class="hljs-keyword">if</span> (!stackOut.isEmpty()) <span class="hljs-keyword">return</span>; 
        <span class="hljs-keyword">while</span> (!stackIn.isEmpty()){
                stackOut.push(stackIn.pop());
        }
    }
}
</code></pre>
<ul>
<li>时间复杂度: push和empty为O(1), pop和peek为O(n)</li>
<li>空间复杂度: O(n)</li>
</ul>
<h3 data-id="heading-40">队列实现栈</h3>
<p><strong>队列是先进先出的规则，把一个队列中的数据导入另一个队列中，数据的顺序并没有变，并没有变成先进后出的顺序。</strong></p>
<p>所以用栈实现队列， 和用队列实现栈的思路还是不一样的，这取决于这两个数据结构的性质。</p>
<p>但是依然还是要用两个队列来模拟栈，只不过没有输入和输出的关系，而是另一个队列完全用来备份的！</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyStack</span> {

    Queue&lt;Integer&gt; queue1; <span class="hljs-comment">// 和栈中保持一样元素的队列</span>
    Queue&lt;Integer&gt; queue2; <span class="hljs-comment">// 辅助队列</span>

    <span class="hljs-comment">/** Initialize your data structure here. */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">MyStack</span><span class="hljs-params">()</span> {
        queue1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedList</span>&lt;&gt;();
        queue2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedList</span>&lt;&gt;();
    }
    
    <span class="hljs-comment">/** Push element x onto stack. */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">push</span><span class="hljs-params">(<span class="hljs-type">int</span> x)</span> {
        queue2.offer(x); <span class="hljs-comment">// 先放在辅助队列中</span>
        <span class="hljs-keyword">while</span> (!queue1.isEmpty()){
            queue2.offer(queue1.poll());
        }
        Queue&lt;Integer&gt; queueTemp;
        queueTemp = queue1;
        queue1 = queue2;
        queue2 = queueTemp; <span class="hljs-comment">// 最后交换queue1和queue2，将元素都放到queue1中</span>
    }
    
    <span class="hljs-comment">/** Removes the element on top of the stack and returns that element. */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">pop</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> queue1.poll(); <span class="hljs-comment">// 因为queue1中的元素和栈中的保持一致，所以这个和下面两个的操作只看queue1即可</span>
    }
    
    <span class="hljs-comment">/** Get the top element. */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">top</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> queue1.peek();
    }
    
    <span class="hljs-comment">/** Returns whether the stack is empty. */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">empty</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> queue1.isEmpty();
    }
}
</code></pre>
<ul>
<li>时间复杂度: pop为O(n)，其他为O(1)</li>
<li>空间复杂度: O(n)</li>
</ul>
<p>优化：</p>
<p>其实这道题目就是用一个队列就够了。</p>
<p><strong>一个队列在模拟栈弹出元素的时候只要将队列头部的元素（除了最后一个元素外） 重新添加到队列尾部，此时再去弹出元素就是栈的顺序了。</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyStack</span> {
    Queue&lt;Integer&gt; queue;
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">MyStack</span><span class="hljs-params">()</span> {
        queue = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedList</span>&lt;&gt;();
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">push</span><span class="hljs-params">(<span class="hljs-type">int</span> x)</span> {
        queue.add(x);
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">pop</span><span class="hljs-params">()</span> {
        rePosition();
        <span class="hljs-keyword">return</span> queue.poll();
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">top</span><span class="hljs-params">()</span> {
        rePosition();
        <span class="hljs-type">int</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> queue.poll();
        queue.add(result);
        <span class="hljs-keyword">return</span> result;
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">empty</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> queue.isEmpty();
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">rePosition</span><span class="hljs-params">()</span>{
        <span class="hljs-type">int</span> <span class="hljs-variable">size</span> <span class="hljs-operator">=</span> queue.size();
        size--;
        <span class="hljs-keyword">while</span>(size--&gt;<span class="hljs-number">0</span>)
            queue.add(queue.poll());
    }
}
</code></pre>
<ul>
<li>时间复杂度: pop为O(n)，其他为O(1)</li>
<li>空间复杂度: O(n)</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[docker总结]]></title>    <link>https://juejin.cn/post/7577239264309559296</link>    <guid>https://juejin.cn/post/7577239264309559296</guid>    <pubDate>2025-11-27T15:38:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577239264309559296" data-draft-id="7577239264309166080" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="docker总结"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-27T15:38:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="gnip"/> <meta itemprop="url" content="https://juejin.cn/user/4064230391423197"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            docker总结
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4064230391423197/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    gnip
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T15:38:41.000Z" title="Thu Nov 27 2025 15:38:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">概述</h2>
<p>虽然docker运维层面可能用的多一些，由于时不时会用到docker做一些自动化CI/CD、并发执行脚本等操作，还是很重要的，对于日常开发能大幅提高开发效率，记录下常用的docker常见概念和操作</p>
<h2 data-id="heading-1">镜像（Image）---》模具</h2>
<h3 data-id="heading-2">定义</h3>
<ul>
<li><strong>只读模板</strong>：包含运行应用所需的所有依赖、配置、代码</li>
<li><strong>分层存储</strong>：由多个只读层组成，每层代表一个修改</li>
<li><strong>构建基础</strong>：用于创建容器的蓝图</li>
</ul>
<h2 data-id="heading-3">容器（Container）----》实例</h2>
<h3 data-id="heading-4">定义</h3>
<ul>
<li><strong>运行实例</strong>：镜像的可运行实例</li>
<li><strong>隔离环境</strong>：具有独立的文件系统、网络、进程空间</li>
<li><strong>可写层</strong>：在镜像基础上添加可写层，所有修改都在此层</li>
</ul>
<h3 data-id="heading-5">生命周期</h3>
<pre><code class="hljs language-markdown" lang="markdown">创建 → 运行 → 停止 → 删除
<span class="hljs-code">    ↘ 暂停 → 恢复 ↗
</span></code></pre>
<h2 data-id="heading-6">仓库（Registry）</h2>
<h3 data-id="heading-7">定义</h3>
<ul>
<li><strong>镜像存储库</strong>：集中存放镜像的地方</li>
<li><strong>公共/私有</strong>：Docker Hub（公共）或私有仓库</li>
<li><strong>版本管理</strong>：支持标签（tag）管理不同版本</li>
</ul>
<h3 data-id="heading-8">常见仓库</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># Docker Hub（默认）</span>
docker pull nginx:latest

<span class="hljs-comment"># 私有仓库</span>
docker pull myregistry.com/myapp:v1.0
</code></pre>
<h2 data-id="heading-9">Dockerfile----》图纸</h2>
<h3 data-id="heading-10">定义</h3>
<ul>
<li><strong>构建脚本</strong>：包含构建镜像的指令</li>
<li><strong>自动化构建</strong>：可重复的构建过程</li>
<li><strong>版本控制</strong>：可与代码一起管理</li>
</ul>
<h3 data-id="heading-11">结构</h3>
<pre><code class="hljs language-bash" lang="bash">FROM ubuntu:20.04          <span class="hljs-comment"># 基础镜像</span>
COPY . /app                <span class="hljs-comment"># 复制文件</span>
RUN make /app              <span class="hljs-comment"># 执行命令</span>
ENV PATH /app:<span class="hljs-variable">$PATH</span>        <span class="hljs-comment"># 设置环境变量</span>
EXPOSE 80                  <span class="hljs-comment"># 声明端口</span>
CMD [<span class="hljs-string">"/app/start.sh"</span>]      <span class="hljs-comment"># 启动命令</span>
</code></pre>
<h3 data-id="heading-12">打包一个前端项目示例</h3>
<pre><code class="hljs language-sh" lang="sh"><span class="hljs-comment"># 使使用镜像</span>
FROM node:25.2.1
WORKDIR /app

<span class="hljs-comment"># 复制当前目录文件到/app下</span>
COPY . .



<span class="hljs-comment"># 执行命令</span>
<span class="hljs-comment"># RUN node -v &amp;&amp; \</span>
<span class="hljs-comment">#     npm -v  &amp;&amp;\</span>
<span class="hljs-comment">#     npm i -g pnpm &amp;&amp; \</span>
<span class="hljs-comment">#     pnpm i &amp;&amp; \</span>
<span class="hljs-comment">#     pnpm i run build &amp;&amp; \</span>
<span class="hljs-comment">#     pnpm run serve</span>

<span class="hljs-comment"># 暴露 80 端口</span>
EXPOSE 8080

<span class="hljs-comment"># # 启动 Nginx</span>
<span class="hljs-comment"># CMD ["nginx", "-g", "daemon off;"]</span>

CMD node -v &amp;&amp; \
    npm -v  &amp;&amp;\
    npm i -g pnpm &amp;&amp; \
    pnpm i &amp;&amp; \
    pnpm i run build &amp;&amp; \
    pnpm run serve

<span class="hljs-comment"># 将静态文件复制到 Nginx 服务目录</span>
COPY ./dist /usr/share/nginx/html
</code></pre>
<h2 data-id="heading-13">数据卷（Volume）</h2>
<h3 data-id="heading-14">定义</h3>
<ul>
<li><strong>持久化存储</strong>：独立于容器的数据存储</li>
<li><strong>数据共享</strong>：在容器间共享数据</li>
<li><strong>生命周期</strong>：与容器分离，可独立管理</li>
</ul>
<h3 data-id="heading-15">使用方式</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 创建数据卷</span>
docker volume create mydata

<span class="hljs-comment"># 挂载到容器</span>
docker run -v mydata:/app/data myapp
</code></pre>
<h2 data-id="heading-16">网络（Network）</h2>
<h3 data-id="heading-17">定义</h3>
<ul>
<li><strong>容器通信</strong>：管理容器间的网络连接</li>
<li><strong>网络隔离</strong>：不同类型的网络提供不同级别的隔离</li>
<li><strong>端口映射</strong>：容器与主机的网络通信</li>
</ul>
<h3 data-id="heading-18">网络类型</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 桥接网络（默认）</span>
docker network create mynetwork

<span class="hljs-comment"># 主机网络</span>
docker run --network host nginx

<span class="hljs-comment"># 容器网络</span>
docker run --network container:other-container nginx
</code></pre>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># Docker Hub（默认）</span>
docker pull nginx:latest

<span class="hljs-comment"># 私有仓库</span>
docker pull myregistry.com/myapp:v1.0
</code></pre>
<h2 data-id="heading-19">docker compose</h2>
<p>Docker Compose 是一个用于定义和运行多容器 Docker 应用程序的工具</p>
<ul>
<li><strong>多容器管理</strong>：通过 YAML 文件定义和运行多个容器</li>
<li><strong>服务编排</strong>：自动处理容器间的依赖关系和网络</li>
<li><strong>简化部署</strong>：一条命令启动整个应用栈</li>
</ul>
<h2 data-id="heading-20">常用命令</h2>
<h3 data-id="heading-21">docker pull</h3>
<p>用来拉取仓库镜像</p>
<pre><code class="hljs language-sh" lang="sh">//docker pull [镜像包]
docker pull node 
docker pull node:14.21.3
docker pull nginx
</code></pre>
<h3 data-id="heading-22">docker image ls</h3>
<p>列举当前下载的镜像包</p>
<h3 data-id="heading-23">docker image rm</h3>
<p>删除镜像包</p>
<pre><code class="hljs language-sh" lang="sh">//docker image <span class="hljs-built_in">rm</span> [镜像名]
docker image <span class="hljs-built_in">rm</span> nginx
docker image <span class="hljs-built_in">rm</span> -f nginx //强制删除
</code></pre>
<h3 data-id="heading-24">docker ps</h3>
<p>查看当前运行的镜像</p>
<pre><code class="hljs language-sh" lang="sh">docker ps //当前运行的镜像
docker ps -a //当前所有镜像
</code></pre>
<h3 data-id="heading-25">docker run</h3>
<p>基于当前镜像运行容器</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">//docker run [镜像名|镜像id]   //可能会阻塞控制台</span>
<span class="hljs-comment">//docker run -d [镜像名|镜像id] //后台运行（常用）</span>
<span class="hljs-comment">//docker run -d -p [宿主端口]:[容器端口] [镜像名|镜像id] //后台运行（常用）</span>
doker run nginx -d 
doker run nginx -d  -p <span class="hljs-number">88</span>:<span class="hljs-number">80</span> <span class="hljs-comment">//宿主环境访问88端口会访问到容器内部的80端口</span>


</code></pre>
<h3 data-id="heading-26">docker rm</h3>
<pre><code class="hljs language-sh" lang="sh"><span class="hljs-comment"># 删除已停止的容器</span>
docker <span class="hljs-built_in">rm</span> &lt;container_id_or_name&gt;

<span class="hljs-comment"># 示例</span>
docker <span class="hljs-built_in">rm</span> my-container
docker <span class="hljs-built_in">rm</span> d4df063702d4
<span class="hljs-comment"># 强制删除运行中的容器（先停止再删除）</span>
docker <span class="hljs-built_in">rm</span> -f &lt;container_id_or_name&gt;

<span class="hljs-comment"># 示例</span>
docker <span class="hljs-built_in">rm</span> -f d4df063702d4

<span class="hljs-comment"># 强制删除所有容器（包括运行中的）</span>
docker <span class="hljs-built_in">rm</span> -f $(docker ps -aq)
</code></pre>
<h3 data-id="heading-27">docker run -v</h3>
<p>容器时挂载（外部映射文件到容器内部，改外面里面也改）</p>
<pre><code class="hljs language-sh" lang="sh"><span class="hljs-comment"># 挂载 Nginx 配置</span>
docker run -v /host/nginx.conf:/etc/nginx/nginx.conf:ro nginx

<span class="hljs-comment"># 挂载网站文件</span>
docker run -v /host/html:/usr/share/nginx/html nginx
docker run -d -p 80:80  -v /www/test:/usr/share/nginx/html nginx

<span class="hljs-comment"># 使用相对路径（相对于当前目录）</span>
docker run -v ./data:/app/data nginx

<span class="hljs-comment"># 挂载多个目录</span>
docker run \
  -v /host/config:/app/config:ro \
  -v /host/data:/app/data \
  -v /host/logs:/app/logs \
  myapp
</code></pre>
<h3 data-id="heading-28">docker volume</h3>
<p>命名卷</p>
<pre><code class="hljs language-sh" lang="sh"><span class="hljs-comment"># 创建命名卷</span>
doucker volume create [卷名]

<span class="hljs-comment">#示例</span>

<span class="hljs-comment">#创建nginx的html</span>
doucker volume create nginx_html 

<span class="hljs-comment">#卷替换目录</span>
docker volume create nginx_html 
docker run -d -p 80:80  -v nginx_html:/usr/share/nginx/html nginx

<span class="hljs-comment"># 查询卷创建的位置</span>
docker volume inspect nginx_html

<span class="hljs-comment"># 输出</span>
[
    {
        <span class="hljs-string">"CreatedAt"</span>: <span class="hljs-string">"2025-11-27T21:43:28+08:00"</span>,
        <span class="hljs-string">"Driver"</span>: <span class="hljs-string">"local"</span>,
        <span class="hljs-string">"Labels"</span>: null,
        <span class="hljs-string">"Mountpoint"</span>: <span class="hljs-string">"/var/lib/docker/volumes/nginx_html/_data"</span>,//卷的位置
        <span class="hljs-string">"Name"</span>: <span class="hljs-string">"nginx_html"</span>,
        <span class="hljs-string">"Options"</span>: null,
        <span class="hljs-string">"Scope"</span>: <span class="hljs-string">"local"</span>
    }
]

<span class="hljs-comment"># 列出所有数据卷</span>
docker volume <span class="hljs-built_in">ls</span>

<span class="hljs-comment"># 删除数据卷</span>
docker volume <span class="hljs-built_in">rm</span> my_volume

<span class="hljs-comment"># 强制删除数据卷</span>
docker volume <span class="hljs-built_in">rm</span> -f my_volume

<span class="hljs-comment"># 删除所有未使用的数据卷</span>
docker volume prune
</code></pre>
<h3 data-id="heading-29">docker start|stop</h3>
<p>容器启停(等同于将服务上上下线），会保存之前的缓存</p>
<pre><code class="hljs language-sh" lang="sh"><span class="hljs-comment"># 启动已停止的容器</span>
docker start container_name

<span class="hljs-comment"># 启动容器并显示日志</span>
docker start -a container_name

<span class="hljs-comment"># 启动多个容器</span>
docker start container1 container2 container3

<span class="hljs-comment"># 启动所有已停止的容器</span>
docker start $(docker ps -aq -f status=exited)

<span class="hljs-comment"># 停止运行中的容器</span>
docker stop container_name

<span class="hljs-comment"># 停止多个容器</span>
docker stop container1 container2 container3

<span class="hljs-comment"># 停止所有运行中的容器</span>
docker stop $(docker ps -q)

<span class="hljs-comment"># 设置停止超时时间（默认10秒）</span>
docker stop -t 30 container_name
</code></pre>
<h3 data-id="heading-30">docker-compose</h3>
<pre><code class="hljs language-sh" lang="sh"><span class="hljs-comment"># 启动所有服务（后台运行）</span>
docker-compose up -d

<span class="hljs-comment"># 启动并构建镜像</span>
docker-compose up --build

<span class="hljs-comment"># 停止所有服务</span>
docker-compose down

<span class="hljs-comment"># 查看服务状态</span>
docker-compose ps

<span class="hljs-comment"># 查看服务日志</span>
docker-compose logs
docker-compose logs -f  <span class="hljs-comment"># 实时日志</span>
docker-compose logs service_name  <span class="hljs-comment"># 特定服务日志</span>

<span class="hljs-comment"># 重启服务</span>
docker-compose restart

<span class="hljs-comment"># 缩放服务实例数量</span>
docker-compose up --scale web=3 --scale worker=2

<span class="hljs-comment"># 构建服务镜像</span>
docker-compose build

<span class="hljs-comment"># 拉取服务镜像</span>
docker-compose pull

<span class="hljs-comment"># 执行命令</span>
docker-compose <span class="hljs-built_in">exec</span> service_name <span class="hljs-built_in">command</span>
docker-compose <span class="hljs-built_in">exec</span> web bash  <span class="hljs-comment"># 进入容器</span>

<span class="hljs-comment"># 暂停/恢复服务</span>
docker-compose pause
docker-compose unpause
</code></pre>
<h3 data-id="heading-31">docker build</h3>
<p>命令用于根据 Dockerfile 构建 Docker 镜像(图纸为dockeFile)</p>
<pre><code class="hljs language-sh" lang="sh">docker build -t [镜像名] [OPTIONS] PATH | URL | -
<span class="hljs-comment"># 在当前目录查找 Dockerfile 并构建（.基于档期啊目录构建）</span>
docker build .
docker build -t my-app-test .
<span class="hljs-comment"># 指定 Dockerfile 路径</span>
docker build -f Dockerfile.dev .

<span class="hljs-comment"># 指定构建上下文路径</span>
docker build /path/to/build/context
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[低代码Agent开发框架使用指南（八）—Coze 知识库详解]]></title>    <link>https://juejin.cn/post/7577239264309739520</link>    <guid>https://juejin.cn/post/7577239264309739520</guid>    <pubDate>2025-11-27T23:37:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577239264309739520" data-draft-id="7576893180080455722" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="低代码Agent开发框架使用指南（八）—Coze 知识库详解"/> <meta itemprop="keywords" content="人工智能,Coze,Agent"/> <meta itemprop="datePublished" content="2025-11-27T23:37:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="大模型真好玩"/> <meta itemprop="url" content="https://juejin.cn/user/3140624091453053"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            低代码Agent开发框架使用指南（八）—Coze 知识库详解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3140624091453053/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    大模型真好玩
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T23:37:07.000Z" title="Thu Nov 27 2025 23:37:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><h2 data-id="heading-0">前言</h2>
<p>上篇文章《<a href="https://juejin.cn/post/7571067260052783130" target="_blank" title="https://juejin.cn/post/7571067260052783130">低代码Agent开发框架使用指南（七）—Coze 数据库详解</a>》中，笔者详细介绍了如何在Coze平台中创建和使用数据库，并结合可视化图表完成了一个数据分析任务。除了能够高效处理结构化数据之外，作为一款功能强大的低代码开发平台，Coze同样支持对文档、表格、图片等非结构化数据进行管理与调用——这正是Coze知识库功能的核心价值所在。</p>
<p>低代码Agent开发相关文章已全部收录于笔者专栏<a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fweixin_42782643%2Fcategory_13062185.html" title="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fweixin_42782643%2Fcategory_13062185.html" target="_blank">《AI应用工厂：低代码智能体开发使用指南》</a>。本专栏致力于帮助零代码经验的朋友快速上手智能体搭建，学会该技能可以轻松实现如旅游助手、自动文档处理、自动视频生成等实用工具，让大模型技术真正赋能日常生活。</p>
<p>对于有编程基础、喜欢写代码的开发者也可以阅读笔者的<a href="https://juejin.cn/column/7526240014499495972" title="https://juejin.cn/column/7526240014499495972" target="_blank">LangChain/LangGraph系列教程</a>专栏。该专栏融合了笔者在实战中积累的深度经验，系统讲解如何基于LangChain与LangGraph框架高效开发智能体，并通过众多实战项目助大家快速构建专业级应用。大家感兴趣可以关注笔者掘金账号和系列专栏，更可关注笔者同名微信公众号: <strong>大模型真好玩</strong>, 每期分享涉及的代码均可在公众号私信: <strong>LangChain智能体开发</strong>获得。</p>
<h2 data-id="heading-1">一、什么是知识库？</h2>
<h3 data-id="heading-2">1.1 知识库概念</h3>
<p>在介绍Coze知识库的具体使用方法之前，笔者先分享什么是知识库。<strong>知识库是一种用于存储、管理和应用海量结构化、非结构化数据的系统</strong>。它通过对信息进行系统性的收集、组织、分类和索引，帮助用户高效地检索和利用相关知识。Coze的知识库功能正是基于这一理念，为用户提供了一套完整的知识管理解决方案。</p>
<p>为了让大家更直观地理解，笔者这里举一个简单的例子。假设上传的文档中包含这样两句话：“AAA是一个AI产品经理”和“BBB是一个AI程序员”。Coze知识库会先将文档切分为两个分段，分别对应这两句话。当用户提问“AAA是谁”时，知识库会通过语义相似度匹配到第一句话“AAA是一个AI产品经理”，然后将这段内容交给大模型。大模型基于这句话进行回答：“据我所知，AAA是一个AI产品经理。”</p>
<p>关于知识库背后更深入的技术原理，特别是RAG（检索增强生成）的核心机制，大家可以参考笔者的另一篇文章<a href="https://juejin.cn/post/7494201369303253002" target="_blank" title="https://juejin.cn/post/7494201369303253002">《一文带你了解RAG核心原理！不再只是文档的搬运工》</a>，这里就不再详细展开。</p>
<h3 data-id="heading-3">1.2 Coze知识库核心功能</h3>
<p>Coze知识库提供了一种简单易用的方式，帮助开发者存储、管理和应用外部数据，使智能体能够在特定领域进行专业、准确的对话交互。其主要特点包括：</p>
<ul>
<li><strong>多样化数据源</strong>：支持上传本地文件（如.txt、.pdf、.docx、.csv、.xlsx等）、在线网页、API接口数据，并可集成Notion、飞书等多种来源的文本与结构化数据。</li>
<li><strong>智能内容分割</strong>：上传的文档内容会被自动切分为多个独立的信息片段进行存储（类似上一节中的示例），同时也支持自定义分段规则，如关键词、字符长度等，便于后续更精准地检索与应用。</li>
<li><strong>灵活的应用方式</strong>：将知识库关联到智能体后，开发者可选择自动调用或按需调用的方式，灵活使用知识库中的内容。</li>
</ul>
<p>借助Coze知识库，开发者能够以低成本、高效率的方式，让智能体快速掌握各行各业的专业知识，打造个性化的智能服务体验，为客户提供准确的信息支持，为企业创造更多价值。</p>
<h3 data-id="heading-4">1.3 Coze知识库的适用场景</h3>
<p>Coze知识库适用于多种专业场景，以下列举几个典型应用方向：</p>
<ol>
<li><strong>搭建行业知识专家</strong><br/>
针对特定行业构建涵盖各类细分知识点的知识库，使智能体迅速成为该领域的专家。例如，为汽车行业建立车型参数知识库，机器人即可详细解答每款车型的具体配置；为医疗行业上传疾病百科，智能体就能提供专业的医疗咨询服务。</li>
<li><strong>构建企业产品/服务助手</strong><br/>
企业可将产品说明书、操作手册、服务条款等文档导入知识库。当客户咨询相关问题时，智能体能够快速给出权威、准确的回答，实现全天候在线的标准化服务，有效提升客户体验。</li>
<li><strong>打造员工培训与知识问答系统</strong><br/>
将岗位手册、业务规范、操作流程等内容上传至知识库后，员工可随时通过对话机器人进行学习。智能体能够根据员工的提问，从知识库中检索最佳答案，在员工培训和知识管理方面发挥重要作用。</li>
</ol>
<h2 data-id="heading-5">二、 Coze知识库使用指南</h2>
<h3 data-id="heading-6">2.1 知识库的创建和管理</h3>
<ol>
<li>
<p><strong>进入知识库管理页面：</strong> 访问 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.coze.cn%2Fhome" target="_blank" title="https://www.coze.cn/home" ref="nofollow noopener noreferrer">Coze 空间首页</a>，依次点击左侧菜单栏中的「资源库」→「知识库」标签页，然后点击右上角的「添加资源」按钮，在下拉选项中选择「知识库」。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/da9dd9467d684e88a43a27755b95c485~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L55yf5aW9546p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764891427&amp;x-signature=fkuGoSqu%2Bc66LPlhQ%2F6D8c76FCY%3D" alt="0.png" loading="lazy"/></p>
</li>
<li>
<p><strong>创建知识库并上传文件：</strong> 选择创建「扣子知识库」，本次演示将以文本格式上传笔者之前的笔记《DeepSeek高性能部署实战》文档。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4dd1472cfa43414a9cbfbec035bad777~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L55yf5aW9546p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764891427&amp;x-signature=pDGxFjrcHWm9D91R7CtpVJUd8Rw%3D" alt="1.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/69d8baa3ee244a41b64845ee78e0e3c3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L55yf5aW9546p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764891427&amp;x-signature=3EXMBR2RLqEirUzWeelb2vtJh5o%3D" alt="2.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3f9d30247b4e425da2c5460786937de5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L55yf5aW9546p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764891427&amp;x-signature=0Xbr6ub8hMKLYeHQjE99OavGHG0%3D" alt="3.png" loading="lazy"/></p>
</li>
<li>
<p><strong>配置内容解析方式：</strong> 上传完成后，由于文档包含文字与图片等多模态内容，需通过 Coze 知识库进行内容提取。系统能够准确识别图片、表格等元素。若为纯文本内容，可选择「快速解析」以加快处理速度。
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0be4b255626446a196f43def317541ec~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L55yf5aW9546p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764891427&amp;x-signature=lUJuBRS9gdtOxUnLmmBDn95IKiU%3D" alt="4.png" loading="lazy"/></p>
</li>
<li>
<p><strong>设置分段策略:</strong> 开发者可选择系统提供的「自动分段与清洗」功能，或启用「自定义」分段。自动模式下，系统将依据内置规则进行内容切分与噪声清除；自定义模式下，可配置以下参数：</p>
<ul>
<li><strong>分段标识符</strong>：设定分段依据的符号或关键词</li>
<li><strong>分段最大长度</strong>：控制每段包含的文本数量</li>
<li><strong>分段重叠</strong>：设置相邻段落间的重叠部分，确保内容连续性</li>
<li><strong>文本预处理</strong>：如去除空白字符、过滤链接等</li>
</ul>
<p>对于结构化文档，还可选用「按层级分段」模式，系统将依照文档的标题层级自动划分段落。配置完成后，点击「下一步」继续。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/01f3f4eacf08416f8ec9ab2ea82be6f1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L55yf5aW9546p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764891427&amp;x-signature=mcjoOcZYzjBZJ8q8ST%2BFfjKNDYI%3D" alt="5.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2fafa93456a1449aa90e0e5dd8a42e7f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L55yf5aW9546p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764891427&amp;x-signature=i7XSHYZRKs0%2FgtChIu4HjqOTjZs%3D" alt="6.png" loading="lazy"/></p>
</li>
<li>
<p><strong>预览分段结果并完成创建:</strong> 系统将依据设定对内容进行自动分段，开发者可实时预览分段结果（此过程可能需要一定时间）。完成后点击「下一步」，Coze 知识库会将每个段落转化为向量形式存储，为后续语义匹配做好准备。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e7a08d4f049147cd8e0f7a1a7d33dccc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L55yf5aW9546p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764891427&amp;x-signature=hfpwM2uqvQhPsFrVuFxcAdiG0vY%3D" alt="8.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c58106e123104290bb7180bac5a22975~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L55yf5aW9546p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764891427&amp;x-signature=zVFvCN7e%2B5iiOyWMYD0EMJOFhyU%3D" alt="9.png" loading="lazy"/></p>
</li>
<li>
<p><strong>完成知识库创建：</strong> 确认无误后，点击「确认」按钮，即可成功创建知识库。</p>
</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5262dff0f3c8457387c5103ebc4a2756~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L55yf5aW9546p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764891427&amp;x-signature=Ih6AUthY45X9Z%2BuGG4lZI6myk%2BE%3D" alt="10.png" loading="lazy"/></p>
<ol start="7">
<li>创建智能体并关联知识库：参考笔者之前的教程《<a href="https://juejin.cn/post/7559893593608192040" target="_blank" title="https://juejin.cn/post/7559893593608192040">低代码Agent开发框架使用指南（三）—小白5分钟利用Coze轻松构建智能体</a>》创建一个智能体，并将其与刚创建的知识库关联。</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d46629d3c6534926bfc6c4f4a05fb616~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L55yf5aW9546p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764891427&amp;x-signature=g44%2BdyviviS0FTgU2hA5MBPISm4%3D" alt="11.png" loading="lazy"/></p>
<ol start="8">
<li>
<p><strong>配置提示词并启用知识库：</strong> 利用大模型自动优化提示词，并在编辑框中选择我们创建的知识库《DeepSeek高性能部署实战》。</p>
<p><strong>优化后的提示词案例：</strong></p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section"># 角色</span>
你是一个专注于利用知识库信息进行精准回答的智能助手，专门用于测试知识库的功能与信息呈现效果，能够严谨地从知识库中提取相关内容并以清晰易懂的方式回复用户。

<span class="hljs-section">## 技能</span>
<span class="hljs-section">### 技能 1: 知识库优先检索</span>
<span class="hljs-bullet">1.</span> 当用户提问时，<span class="hljs-strong">**优先调用知识库**</span>中的相关信息进行回答，不主动使用外部工具或自行编造内容；
<span class="hljs-bullet">2.</span> 若知识库中存在直接匹配的信息，需提取核心内容，合并为简洁回答；
<span class="hljs-bullet">3.</span> 若知识库中信息零散或需关联多个知识点，自动进行结构化整合（如分点说明、逻辑串联）。
===回复示例===
<span class="hljs-bullet">   -</span> 🔑 匹配知识点：&lt;知识库中对应词条/模块&gt;
<span class="hljs-bullet">   -</span> 📌 核心内容：&lt;用1-2句话总结关键信息&gt;
<span class="hljs-bullet">   -</span> 📊 详细分解：&lt;若信息复杂，按逻辑分点说明，每个点对应知识库中的具体条目&gt;
===示例结束===

<span class="hljs-section">### 技能 2: 知识准确性与完整性验证</span>
<span class="hljs-bullet">1.</span> 对知识库中的信息进行严格校验，确保回复内容与知识库原文一致，不夸大、不删减；
<span class="hljs-bullet">2.</span> 若知识库存在信息冲突或缺失，需明确标注“知识库中存在不同解释”或“相关信息暂未完整收录”，不强行整合矛盾内容。

<span class="hljs-section">### 技能 3: 知识场景化解释</span>
<span class="hljs-bullet">1.</span> 针对抽象或专业的知识库内容，使用用户熟悉的逻辑或场景进行类比解释（如生活实例、日常场景映射）；
<span class="hljs-bullet">2.</span> 若用户问题涉及多个知识点，主动梳理知识关联逻辑，帮助用户理解知识点间的联系。

<span class="hljs-section">## 限制</span>
<span class="hljs-bullet">-</span> <span class="hljs-strong">**严格限制知识库范围**</span>：仅基于当前知识库内容回复，不引入外部信息或个性化观点；
<span class="hljs-bullet">-</span> <span class="hljs-strong">**明确边界提示**</span>：当问题超出知识库覆盖范围时（如“我不知道”“这个概念不在知识库中”），直接回复“当前问题超出知识库支持范围，建议补充相关知识库内容后再次提问”；
<span class="hljs-bullet">-</span> <span class="hljs-strong">**拒绝无关话题**</span>：不回应与知识库内容无关的问题（如个人经历、娱乐八卦、技术故障等）；
<span class="hljs-bullet">-</span> <span class="hljs-strong">**格式规范**</span>：所有回复需按示例中的结构分点，信息密度适中，避免冗长或简略过度。
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7c15500db3274c19949bfb30c6475ff1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L55yf5aW9546p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764891427&amp;x-signature=tQM7HNl196%2FM04G4W5UoBAZLBV4%3D" alt="12.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/afa7f2dc6c744a2bbd827a90b5999fe1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L55yf5aW9546p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764891427&amp;x-signature=HB9ihbgpWRk5QNOwDgvtUY8ffu0%3D" alt="13.png" loading="lazy"/></p>
</li>
<li>
<p><strong>测试知识库检索结果：</strong> 提出问题：“高性能部署 DeepSeek 有哪几种方式”，智能体将调用知识库并返回相应答案。点击运行完毕的下拉框，可查看知识库搜索的详细信息，包括：</p>
<ul>
<li>与问题相关联的内容块</li>
<li>各内容块与问题的相似度评分</li>
<li>按相似度从高到低排列的检索结果</li>
</ul>
<p>测试结果表明，智能体能够准确从知识库中获取相关内容并生成回答，有效扩展了大模型的知识边界，提升了回答的准确性和专业性。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9adffe7b0da049bbbdf5917a307d6687~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L55yf5aW9546p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764891427&amp;x-signature=5BPf0PDCsdbP0nVmSptSygCWTqg%3D" alt="14.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/49c318879f1b44e29d905af0df6d718d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L55yf5aW9546p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764891427&amp;x-signature=n8JuTLEmxETv2vCHN9zWe2eBcSA%3D" alt="15.png" loading="lazy"/></p>
</li>
</ol>
<h3 data-id="heading-7">2.2 知识库和变量、长期记忆、数据库的对比</h3>
<p>在 Coze 平台中，知识库、变量、长期记忆和数据库都具备数据存储能力，但在使用场景和特性上存在显著差异。我们可以从数据的使用对象和内容性质两个维度进行区分：</p>
<ul>
<li><strong>知识（主要指知识库）</strong> ：作为供智能体或工作流调用的静态数据，可在空间内共享。这类数据由开发者创建和维护，终端用户仅可读取而无法修改。</li>
<li><strong>记忆（包括变量、数据库、长期记忆）</strong> ：用于存储智能体在与终端用户交互过程中产生的动态数据。这类数据通常与具体用户相关联，不支持跨智能体共享。</li>
</ul>
<p>以下以一个租房平台智能体为例，说明不同类型数据的存储方式与特点：</p>




















<table><thead><tr><th><strong>类别</strong></th><th><strong>存储的数据</strong></th><th><strong>特点</strong></th></tr></thead><tbody><tr><td>知识</td><td>房源信息、房屋图片、房屋描述、房屋价格、房屋地址、房屋设施、房屋评价等</td><td>由 智能体 开发者上传和维护、所有用户可见但不可修改、可跨 智能体 使用</td></tr><tr><td>记忆</td><td>用户信息、用户历史租房信息、用户关注的小区/房屋等</td><td>用户个人数据，不支持跨 智能体 使用</td></tr></tbody></table>
<h2 data-id="heading-8">三、总结</h2>
<p>Coze知识库作为一套集存储、管理、检索与应用于一体的知识管理解决方案，为智能体的能力提升提供了强有力的支持。然而，知识库的实际效果很大程度上取决于导入内容的质量与相关性。作为使用者，我们需要深入理解其功能特性，结合具体应用场景规划和构建知识体系，并持续优化更新内容，才能充分释放知识库的价值，打造真正懂行业、有深度、高效率的智能助手，为业务创新持续赋能。</p>
<p>本文介绍的内容已能满足基础使用需求，但要充分发挥知识库的潜力，仍需掌握更多构建技巧。本专栏将持续深入这一领域，下篇文章将重点解析Coze知识库的优化方法与高级实践，敬请期待！大家阅读后感兴趣可关注笔者掘金账号和专栏。 低代码Agent开发相关文章已全部收录于笔者专栏<a href="https://juejin.cn/column/7558439013464932362" title="https://juejin.cn/column/7558439013464932362" target="_blank">《AI应用工厂：低代码智能体开发使用指南》</a>。</p>
<p>对于有经验喜欢写代码的开发者也可以阅读笔者的<a href="https://juejin.cn/column/7526240014499495972" title="https://juejin.cn/column/7526240014499495972" target="_blank">LangChain/LangGraph系列教程</a>专栏，目前已经更完28节。该专栏融合了笔者在实战中积累的深度经验，系统讲解如何基于LangChain与LangGraph框架高效开发智能体，助你快速构建专业级应用。大家可关注笔者同名微信公众号: <strong>大模型真好玩</strong>, 每期分享涉及的代码均可在公众号私信: <strong>LangChain智能体开发</strong>获得。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[还在为组件通信头疼？defineExpose让你彻底告别传值烦恼]]></title>    <link>https://juejin.cn/post/7577239264309772288</link>    <guid>https://juejin.cn/post/7577239264309772288</guid>    <pubDate>2025-11-27T23:45:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577239264309772288" data-draft-id="7577239264309755904" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="还在为组件通信头疼？defineExpose让你彻底告别传值烦恼"/> <meta itemprop="keywords" content="Vue.js,JavaScript,前端"/> <meta itemprop="datePublished" content="2025-11-27T23:45:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="良山有风来"/> <meta itemprop="url" content="https://juejin.cn/user/3940246036939358"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            还在为组件通信头疼？defineExpose让你彻底告别传值烦恼
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3940246036939358/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    良山有风来
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T23:45:48.000Z" title="Thu Nov 27 2025 23:45:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>最近在写Vue 3项目的时候，你是不是经常遇到这样的场景：父组件想要调用子组件里的方法，但在<code>&lt;script setup&gt;</code>里却不知道该怎么暴露出去？</p>
<p>每次都要翻文档查半天，最后可能还是用了不太优雅的解决方案。</p>
<p>别担心，今天我要给你介绍的<code>defineExpose</code>，就是专门解决这个痛点的神器。它能让你在<code>&lt;script setup&gt;</code>中轻松暴露组件方法，让组件通信变得前所未有的简单。</p>
<p>读完这篇文章，你不仅能掌握<code>defineExpose</code>的核心用法，还能学到几个实际项目中的最佳实践，从此再也不怕复杂的组件通信了！</p>
<h2 data-id="heading-0">为什么需要defineExpose？</h2>
<p>在深入了解<code>defineExpose</code>之前，我们先来看看为什么会有这个API的出现。</p>
<p>在Vue 3的<code>&lt;script setup&gt;</code>语法糖出现之前，我们通常使用<code>setup()</code>函数来编写组件逻辑。在那个时候，如果要暴露方法给父组件，我们会这样做：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 传统setup()函数写法</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-title function_">setup</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">showMessage</span> = (<span class="hljs-params"/>) =&gt; {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Hello from child component!'</span>)
    }
    
    <span class="hljs-comment">// 需要手动返回</span>
    <span class="hljs-keyword">return</span> {
      showMessage
    }
  }
}
</code></pre>
<p>而在<code>&lt;script setup&gt;</code>中，默认情况下所有顶层的绑定（包括变量、函数）都是私有的，父组件无法直接访问。这就带来了一个问题：当父组件确实需要调用子组件的某些方法时，我们该怎么办？</p>
<p>这时候，<code>defineExpose</code>就闪亮登场了！</p>
<h2 data-id="heading-1">defineExpose基础用法</h2>
<p><code>defineExpose</code>是Vue 3专门为<code>&lt;script setup&gt;</code>设计的编译器宏，用来显式暴露组件实例上的属性和方法。</p>
<p>让我们从一个最简单的例子开始：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ChildComponent.vue</span>
&lt;script setup&gt;
<span class="hljs-keyword">import</span> { ref } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-comment">// 子组件内部的状态</span>
<span class="hljs-keyword">const</span> count = <span class="hljs-title function_">ref</span>(<span class="hljs-number">0</span>)
<span class="hljs-keyword">const</span> message = <span class="hljs-string">'这是子组件的消息'</span>

<span class="hljs-comment">// 子组件内部的方法</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">increment</span> = (<span class="hljs-params"/>) =&gt; {
  count.<span class="hljs-property">value</span>++
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'计数器增加了:'</span>, count.<span class="hljs-property">value</span>)
}

<span class="hljs-keyword">const</span> <span class="hljs-title function_">showAlert</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-title function_">alert</span>(<span class="hljs-string">'这是子组件暴露的方法!'</span>)
}

<span class="hljs-comment">// 使用defineExpose暴露需要让父组件访问的属性和方法</span>
<span class="hljs-title function_">defineExpose</span>({
  increment,
  showAlert,
  count
})
&lt;/script&gt;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>子组件计数: {{ count }}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span></span>
</code></pre>
<p>在父组件中，我们可以这样使用：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ParentComponent.vue</span>
&lt;script setup&gt;
<span class="hljs-keyword">import</span> { ref, onMounted } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">ChildComponent</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./ChildComponent.vue'</span>

<span class="hljs-comment">// 创建子组件的模板引用</span>
<span class="hljs-keyword">const</span> childRef = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">null</span>)

<span class="hljs-title function_">onMounted</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-comment">// 组件挂载后，可以通过childRef访问暴露的方法和属性</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'子组件的count值:'</span>, childRef.<span class="hljs-property">value</span>.<span class="hljs-property">count</span>)
})

<span class="hljs-comment">// 调用子组件暴露的方法</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleButtonClick</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">if</span> (childRef.<span class="hljs-property">value</span>) {
    childRef.<span class="hljs-property">value</span>.<span class="hljs-title function_">increment</span>()
    childRef.<span class="hljs-property">value</span>.<span class="hljs-title function_">showAlert</span>()
  }
}
&lt;/script&gt;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">ChildComponent</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"childRef"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"handleButtonClick"</span>&gt;</span>调用子组件方法<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span></span>
</code></pre>
<p>看到这里，你可能已经明白了<code>defineExpose</code>的基本用法。它就像是在组件内部开了一个小窗口，让父组件能够看到和使用你特意暴露出来的功能。</p>
<h2 data-id="heading-2">defineExpose的高级技巧</h2>
<p>掌握了基础用法后，让我们来看看一些在实际项目中特别有用的高级技巧。</p>
<h3 data-id="heading-3">选择性暴露</h3>
<p>在实际开发中，我们通常不希望把所有内部方法和状态都暴露出去。<code>defineExpose</code>让我们可以精确控制暴露的内容：</p>
<pre><code class="hljs language-javascript" lang="javascript">&lt;script setup&gt;
<span class="hljs-keyword">import</span> { ref, reactive } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-comment">// 内部状态 - 不暴露</span>
<span class="hljs-keyword">const</span> internalData = <span class="hljs-title function_">ref</span>(<span class="hljs-string">'这是内部数据，父组件看不到'</span>)

<span class="hljs-comment">// 需要暴露的状态</span>
<span class="hljs-keyword">const</span> userInfo = <span class="hljs-title function_">reactive</span>({
  <span class="hljs-attr">name</span>: <span class="hljs-string">'张三'</span>,
  <span class="hljs-attr">age</span>: <span class="hljs-number">25</span>
})

<span class="hljs-comment">// 内部方法 - 不暴露</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">internalMethod</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'这是内部方法'</span>)
}

<span class="hljs-comment">// 需要暴露的方法</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">publicMethod</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'这是对外公开的方法'</span>)
  <span class="hljs-title function_">internalMethod</span>() <span class="hljs-comment">// 内部方法可以在暴露的方法内部调用</span>
}

<span class="hljs-keyword">const</span> <span class="hljs-title function_">updateUserInfo</span> = (<span class="hljs-params">newInfo</span>) =&gt; {
  <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>(userInfo, newInfo)
}

<span class="hljs-comment">// 只暴露必要的部分</span>
<span class="hljs-title function_">defineExpose</span>({
  publicMethod,
  updateUserInfo,
  userInfo
  <span class="hljs-comment">// internalData 和 internalMethod 不会被暴露</span>
})
&lt;/script&gt;
</code></pre>
<h3 data-id="heading-4">组合式函数与defineExpose的结合</h3>
<p>在大型项目中，我们经常使用组合式函数来组织逻辑。结合<code>defineExpose</code>，可以让代码更加清晰：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// useFormValidation.js - 表单验证的组合式函数</span>
<span class="hljs-keyword">import</span> { ref, computed } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useFormValidation</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> formData = <span class="hljs-title function_">ref</span>({
    <span class="hljs-attr">username</span>: <span class="hljs-string">''</span>,
    <span class="hljs-attr">email</span>: <span class="hljs-string">''</span>,
    <span class="hljs-attr">password</span>: <span class="hljs-string">''</span>
  })

  <span class="hljs-keyword">const</span> errors = <span class="hljs-title function_">ref</span>({})

  <span class="hljs-comment">// 计算属性 - 验证用户名</span>
  <span class="hljs-keyword">const</span> isUsernameValid = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">return</span> formData.<span class="hljs-property">value</span>.<span class="hljs-property">username</span>.<span class="hljs-property">length</span> &gt;= <span class="hljs-number">3</span>
  })

  <span class="hljs-comment">// 验证邮箱</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">validateEmail</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">const</span> emailRegex = <span class="hljs-regexp">/^[^\s@]+@[^\s@]+\.[^\s@]+$/</span>
    errors.<span class="hljs-property">value</span>.<span class="hljs-property">email</span> = emailRegex.<span class="hljs-title function_">test</span>(formData.<span class="hljs-property">value</span>.<span class="hljs-property">email</span>) 
      ? <span class="hljs-string">''</span> 
      : <span class="hljs-string">'邮箱格式不正确'</span>
  }

  <span class="hljs-comment">// 整体验证</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">validateForm</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-title function_">validateEmail</span>()
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">values</span>(errors.<span class="hljs-property">value</span>).<span class="hljs-title function_">every</span>(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> !error)
  }

  <span class="hljs-comment">// 重置表单</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">resetForm</span> = (<span class="hljs-params"/>) =&gt; {
    formData.<span class="hljs-property">value</span> = { <span class="hljs-attr">username</span>: <span class="hljs-string">''</span>, <span class="hljs-attr">email</span>: <span class="hljs-string">''</span>, <span class="hljs-attr">password</span>: <span class="hljs-string">''</span> }
    errors.<span class="hljs-property">value</span> = {}
  }

  <span class="hljs-keyword">return</span> {
    formData,
    errors,
    validateForm,
    resetForm,
    isUsernameValid
  }
}
</code></pre>
<p>在组件中使用：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// FormComponent.vue</span>
&lt;script setup&gt;
<span class="hljs-keyword">import</span> { useFormValidation } <span class="hljs-keyword">from</span> <span class="hljs-string">'./useFormValidation'</span>

<span class="hljs-keyword">const</span> { 
  formData, 
  errors, 
  validateForm, 
  resetForm,
  isUsernameValid 
} = <span class="hljs-title function_">useFormValidation</span>()

<span class="hljs-comment">// 提交表单的方法</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">submitForm</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">if</span> (<span class="hljs-title function_">validateForm</span>()) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'表单验证通过，准备提交:'</span>, formData)
    <span class="hljs-comment">// 这里可以添加提交逻辑</span>
  }
}

<span class="hljs-comment">// 只暴露父组件需要的方法</span>
<span class="hljs-title function_">defineExpose</span>({
  validateForm,
  resetForm,
  submitForm
})
&lt;/script&gt;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">form</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">"formData.username"</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"用户名"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"!isUsernameValid"</span>&gt;</span>用户名至少3个字符<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
    
    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">"formData.email"</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"邮箱"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>{{ errors.email }}<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
    
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"button"</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"submitForm"</span>&gt;</span>提交<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span></span>
</code></pre>
<h2 data-id="heading-5">实际项目中的最佳实践</h2>
<p>在真实项目开发中，正确使用<code>defineExpose</code>能让你的代码更加健壮和可维护。</p>
<h3 data-id="heading-6">类型安全的defineExpose</h3>
<p>如果你使用TypeScript，可以为暴露的内容添加类型定义：</p>
<pre><code class="hljs language-typescript" lang="typescript">&lt;script setup lang=<span class="hljs-string">"ts"</span>&gt;
<span class="hljs-keyword">import</span> { ref } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-keyword">const</span> count = <span class="hljs-title function_">ref</span>(<span class="hljs-number">0</span>)

<span class="hljs-keyword">const</span> <span class="hljs-title function_">increment</span> = (<span class="hljs-params"/>) =&gt; {
  count.<span class="hljs-property">value</span>++
}

<span class="hljs-keyword">const</span> <span class="hljs-title function_">resetCount</span> = (<span class="hljs-params">value: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span></span>) =&gt; {
  count.<span class="hljs-property">value</span> = value
}

<span class="hljs-comment">// 定义暴露接口的类型</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">ExposedProps</span> {
  <span class="hljs-attr">increment</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span>
  <span class="hljs-attr">resetCount</span>: <span class="hljs-function">(<span class="hljs-params">value?: <span class="hljs-built_in">number</span></span>) =&gt;</span> <span class="hljs-built_in">void</span>
  <span class="hljs-attr">count</span>: <span class="hljs-built_in">number</span>
}

<span class="hljs-comment">// 类型安全的暴露</span>
defineExpose&lt;<span class="hljs-title class_">ExposedProps</span>&gt;({
  increment,
  resetCount,
  count
})
&lt;/script&gt;
</code></pre>
<h3 data-id="heading-7">表单组件的完整示例</h3>
<p>让我们看一个更完整的表单组件示例，这在管理后台系统中非常常见：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// AdvancedForm.vue</span>
&lt;script setup&gt;
<span class="hljs-keyword">import</span> { ref, reactive, computed, watch } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-comment">// 表单数据</span>
<span class="hljs-keyword">const</span> formModel = <span class="hljs-title function_">reactive</span>({
  <span class="hljs-attr">title</span>: <span class="hljs-string">''</span>,
  <span class="hljs-attr">content</span>: <span class="hljs-string">''</span>,
  <span class="hljs-attr">category</span>: <span class="hljs-string">''</span>,
  <span class="hljs-attr">tags</span>: [],
  <span class="hljs-attr">publishTime</span>: <span class="hljs-string">''</span>
})

<span class="hljs-comment">// 表单验证状态</span>
<span class="hljs-keyword">const</span> validationState = <span class="hljs-title function_">reactive</span>({
  <span class="hljs-attr">isTitleValid</span>: <span class="hljs-literal">false</span>,
  <span class="hljs-attr">isContentValid</span>: <span class="hljs-literal">false</span>,
  <span class="hljs-attr">isCategoryValid</span>: <span class="hljs-literal">false</span>
})

<span class="hljs-comment">// 计算属性 - 表单是否完整</span>
<span class="hljs-keyword">const</span> isFormComplete = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">return</span> <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">values</span>(validationState).<span class="hljs-title function_">every</span>(<span class="hljs-function"><span class="hljs-params">valid</span> =&gt;</span> valid)
})

<span class="hljs-comment">// 监听表单变化</span>
<span class="hljs-title function_">watch</span>(<span class="hljs-function">() =&gt;</span> formModel.<span class="hljs-property">title</span>, <span class="hljs-function">(<span class="hljs-params">newTitle</span>) =&gt;</span> {
  validationState.<span class="hljs-property">isTitleValid</span> = newTitle.<span class="hljs-property">length</span> &gt;= <span class="hljs-number">5</span>
})

<span class="hljs-title function_">watch</span>(<span class="hljs-function">() =&gt;</span> formModel.<span class="hljs-property">content</span>, <span class="hljs-function">(<span class="hljs-params">newContent</span>) =&gt;</span> {
  validationState.<span class="hljs-property">isContentValid</span> = newContent.<span class="hljs-property">length</span> &gt;= <span class="hljs-number">10</span>
})

<span class="hljs-title function_">watch</span>(<span class="hljs-function">() =&gt;</span> formModel.<span class="hljs-property">category</span>, <span class="hljs-function">(<span class="hljs-params">newCategory</span>) =&gt;</span> {
  validationState.<span class="hljs-property">isCategoryValid</span> = !!newCategory
})

<span class="hljs-comment">// 提交方法</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">submit</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">if</span> (!isFormComplete.<span class="hljs-property">value</span>) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'表单未填写完整'</span>)
  }
  
  <span class="hljs-comment">// 模拟API调用</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'提交数据:'</span>, formModel)
  <span class="hljs-keyword">return</span> { <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">'提交成功'</span> }
}

<span class="hljs-comment">// 重置方法</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">reset</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>(formModel, {
    <span class="hljs-attr">title</span>: <span class="hljs-string">''</span>,
    <span class="hljs-attr">content</span>: <span class="hljs-string">''</span>,
    <span class="hljs-attr">category</span>: <span class="hljs-string">''</span>,
    <span class="hljs-attr">tags</span>: [],
    <span class="hljs-attr">publishTime</span>: <span class="hljs-string">''</span>
  })
  <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(validationState).<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">key</span> =&gt;</span> {
    validationState[key] = <span class="hljs-literal">false</span>
  })
}

<span class="hljs-comment">// 获取表单数据</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">getFormData</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">return</span> { ...formModel }
}

<span class="hljs-comment">// 设置表单数据</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">setFormData</span> = (<span class="hljs-params">newData</span>) =&gt; {
  <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>(formModel, newData)
}

<span class="hljs-comment">// 暴露给父组件的方法和属性</span>
<span class="hljs-title function_">defineExpose</span>({
  submit,
  reset,
  getFormData,
  setFormData,
  isFormComplete
})
&lt;/script&gt;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"advanced-form"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">"formModel.title"</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"文章标题"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">textarea</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">"formModel.content"</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"文章内容"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">textarea</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">"formModel.category"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">""</span>&gt;</span>选择分类<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"tech"</span>&gt;</span>技术<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"life"</span>&gt;</span>生活<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span></span>
</code></pre>
<p>父组件使用示例：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ParentPage.vue</span>
&lt;script setup&gt;
<span class="hljs-keyword">import</span> { ref } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">AdvancedForm</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./AdvancedForm.vue'</span>

<span class="hljs-keyword">const</span> formRef = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">null</span>)

<span class="hljs-comment">// 保存草稿</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">saveDraft</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> formRef.<span class="hljs-property">value</span>.<span class="hljs-title function_">submit</span>()
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'保存成功:'</span>, result)
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'保存失败:'</span>, error.<span class="hljs-property">message</span>)
  }
}

<span class="hljs-comment">// 重置表单</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">clearForm</span> = (<span class="hljs-params"/>) =&gt; {
  formRef.<span class="hljs-property">value</span>.<span class="hljs-title function_">reset</span>()
}

<span class="hljs-comment">// 从服务器加载数据到表单</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">loadFormData</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> mockData = {
    <span class="hljs-attr">title</span>: <span class="hljs-string">'Vue 3高级技巧'</span>,
    <span class="hljs-attr">content</span>: <span class="hljs-string">'这是一篇关于Vue 3的文章...'</span>,
    <span class="hljs-attr">category</span>: <span class="hljs-string">'tech'</span>,
    <span class="hljs-attr">tags</span>: [<span class="hljs-string">'vue'</span>, <span class="hljs-string">'javascript'</span>],
    <span class="hljs-attr">publishTime</span>: <span class="hljs-string">'2024-01-20'</span>
  }
  formRef.<span class="hljs-property">value</span>.<span class="hljs-title function_">setFormData</span>(mockData)
}
&lt;/script&gt;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">AdvancedForm</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"formRef"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"saveDraft"</span>&gt;</span>保存草稿<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"clearForm"</span>&gt;</span>清空表单<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"loadFormData"</span>&gt;</span>加载数据<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span></span>
</code></pre>
<h2 data-id="heading-8">常见问题与解决方案</h2>
<p>在实际使用<code>defineExpose</code>时，你可能会遇到一些典型问题，这里我为你整理了解决方案。</p>
<h3 data-id="heading-9">问题1：模板引用为null</h3>
<p>这是最常见的问题之一，通常是因为在组件挂载完成前就尝试访问引用。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ❌ 错误用法</span>
<span class="hljs-keyword">const</span> childRef = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">null</span>)
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(childRef.<span class="hljs-property">value</span>) <span class="hljs-comment">// 输出: null</span>

<span class="hljs-comment">// ✅ 正确用法</span>
<span class="hljs-keyword">const</span> childRef = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">null</span>)

<span class="hljs-title function_">onMounted</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(childRef.<span class="hljs-property">value</span>) <span class="hljs-comment">// 输出: 组件实例</span>
})

<span class="hljs-comment">// 或者在事件处理程序中访问</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleClick</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">if</span> (childRef.<span class="hljs-property">value</span>) {
    childRef.<span class="hljs-property">value</span>.<span class="hljs-title function_">someMethod</span>()
  }
}
</code></pre>
<h3 data-id="heading-10">问题2：方法未定义</h3>
<p>如果调用方法时出现"undefined"错误，检查是否正确定义和暴露了该方法。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ❌ 忘记暴露方法</span>
&lt;script setup&gt;
<span class="hljs-keyword">const</span> <span class="hljs-title function_">myMethod</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'hello'</span>)
}
<span class="hljs-comment">// 忘记调用 defineExpose</span>
&lt;/script&gt;

<span class="hljs-comment">// ✅ 正确暴露</span>
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">const</span> <span class="hljs-title function_">myMethod</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'hello'</span>)
}

<span class="hljs-title function_">defineExpose</span>({
  myMethod
})
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>
</code></pre>
<h3 data-id="heading-11">问题3：响应式数据更新问题</h3>
<p>当父组件修改子组件暴露的响应式数据时，需要注意：</p>
<pre><code class="hljs language-javascript" lang="javascript">&lt;script setup&gt;
<span class="hljs-keyword">import</span> { ref } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-keyword">const</span> count = <span class="hljs-title function_">ref</span>(<span class="hljs-number">0</span>)

<span class="hljs-comment">// 提供安全的方法来修改数据</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">safeIncrement</span> = (<span class="hljs-params"/>) =&gt; {
  count.<span class="hljs-property">value</span>++
}

<span class="hljs-keyword">const</span> <span class="hljs-title function_">safeSetCount</span> = (<span class="hljs-params">newValue</span>) =&gt; {
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> newValue === <span class="hljs-string">'number'</span>) {
    count.<span class="hljs-property">value</span> = newValue
  }
}

<span class="hljs-title function_">defineExpose</span>({
  count,
  safeIncrement,
  safeSetCount
  <span class="hljs-comment">// 不直接暴露count的.value属性，而是通过方法控制</span>
})
&lt;/script&gt;
</code></pre>
<h2 data-id="heading-12">总结</h2>
<p>通过今天的学习，相信你已经对Vue 3的<code>defineExpose</code>有了全面的了解。</p>
<p><code>defineExpose</code>是<code>&lt;script setup&gt;</code>中的编译器宏，专门用于暴露组件方法和属性给父组件。它的核心价值在于：</p>
<p>第一，提供了精确的控制能力，让你能够决定哪些内容对外可见，保持组件的封装性。</p>
<p>第二，与组合式函数完美配合，让复杂的组件逻辑能够清晰地组织和暴露。</p>
<p>第三，在TypeScript项目中提供完整的类型安全支持。</p>
<p>最重要的是，它解决了<code>&lt;script setup&gt;</code>中组件通信的关键痛点，让父组件能够以类型安全的方式调用子组件的功能。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>