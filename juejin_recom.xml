<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[动态监听DOM元素高度变化]]></title>    <link>https://juejin.cn/post/7570201730991783962</link>    <guid>https://juejin.cn/post/7570201730991783962</guid>    <pubDate>2025-11-09T15:15:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7570201730991783962" data-draft-id="7569945160870264878" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="动态监听DOM元素高度变化"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2025-11-09T15:15:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员大卫"/> <meta itemprop="url" content="https://juejin.cn/user/1961184474695213"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            动态监听DOM元素高度变化
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1961184474695213/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员大卫
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-09T15:15:48.000Z" title="Sun Nov 09 2025 15:15:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是<strong>前端架构师</strong>，关注微信公众号【<strong>程序员大卫</strong>】，免费领取精品前端资料。</p>
<h2 data-id="heading-0">背景</h2>
<p>在前端开发中，监听DOM元素的高度变化有时候是一个常见需求，尤其是在做响应式设计或需要根据内容变化调整布局时。常见的解决方案有两种，一种是使用现代浏览器支持的 <code>ResizeObserver</code>，另一种是通过兼容性更强的 iframe 技术来实现，适用于老款手机和IE浏览器。</p>
<h2 data-id="heading-1">1. ResizeObserver</h2>
<p><code>ResizeObserver</code> 是现代浏览器提供的一种监听元素尺寸变化的 API。它可以监听任意元素的大小变化，并在变化时触发回调函数，适合处理 DOM 元素高度变化的情况。</p>
<h3 data-id="heading-2">示例代码：</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 选择你想要监听的 DOM 元素</span>
<span class="hljs-keyword">const</span> targetElement = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.target'</span>);

<span class="hljs-comment">// 创建 ResizeObserver 实例，并传入回调函数</span>
<span class="hljs-keyword">const</span> resizeObserver = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ResizeObserver</span>(<span class="hljs-function"><span class="hljs-params">entries</span> =&gt;</span> {
    <span class="hljs-comment">// entries 是一个包含被监听元素的数组</span>
    entries.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">entry</span> =&gt;</span> {
        <span class="hljs-comment">// 获取目标元素的当前高度</span>
        <span class="hljs-keyword">const</span> height = entry.<span class="hljs-property">contentRect</span>.<span class="hljs-property">height</span>;
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'元素的当前高度:'</span>, height);
    });
});

<span class="hljs-comment">// 开始监听目标元素的尺寸变化</span>
resizeObserver.<span class="hljs-title function_">observe</span>(targetElement);
</code></pre>
<h3 data-id="heading-3">使用说明：</h3>
<ul>
<li><code>ResizeObserver</code> 会监听目标元素的大小变化，并返回一个 <code>entries</code> 数组，其中每一项代表一个被观察的元素。</li>
<li><code>entry.contentRect</code> 是一个包含元素尺寸信息的矩形对象，<code>height</code> 属性即为元素的高度。</li>
<li>这个方法对于现代浏览器（Chrome、Firefox、Safari 等）都有效，支持程度较高。</li>
</ul>
<h2 data-id="heading-4">2. Iframe</h2>
<p>对于一些老款浏览器（如 IE 浏览器）或者需要兼容更多设备的情况，我们可以采用 iframe 技术来实现动态监听容器的高度变化。通过嵌入一个隐藏的 iframe 元素，可以监听 iframe 元素的 <code>resize</code> 事件来间接判断容器的高度。</p>
<h3 data-id="heading-5">示例代码（纯 HTML 实现）：</h3>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"zh"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>动态监听DOM元素高度变化 - iframe 示例<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
        <span class="hljs-selector-class">.container</span> {
            <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
            <span class="hljs-attribute">height</span>: <span class="hljs-number">200px</span>; <span class="hljs-comment">/* 初始高度 */</span>
            <span class="hljs-attribute">position</span>: relative;
            <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#ccc</span>;
        }
        <span class="hljs-selector-class">.resize-iframe</span> {
            <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
            <span class="hljs-attribute">height</span>: <span class="hljs-number">100%</span>;
            <span class="hljs-attribute">border</span>: none;
            <span class="hljs-attribute">position</span>: absolute;
            <span class="hljs-attribute">top</span>: <span class="hljs-number">0</span>;
            <span class="hljs-attribute">left</span>: <span class="hljs-number">0</span>;
        }
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"container"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">iframe</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"resize-iframe"</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"about:blank"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">iframe</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
        <span class="hljs-keyword">const</span> container = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.container'</span>);
        <span class="hljs-keyword">const</span> iframe = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.resize-iframe'</span>);

        <span class="hljs-comment">// 监听 iframe 的 resize 事件</span>
        iframe.<span class="hljs-property">contentWindow</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'resize'</span>, <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
            <span class="hljs-comment">// 获取容器的当前高度</span>
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'容器的当前高度:'</span>, container.<span class="hljs-property">offsetHeight</span>);
        });

        <span class="hljs-comment">// 为了演示，在容器的高度变化时触发 resize 事件</span>
        <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
            container.<span class="hljs-property">style</span>.<span class="hljs-property">height</span> = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">500</span> + <span class="hljs-string">'px'</span>;  <span class="hljs-comment">// 随机调整容器高度</span>
        }, <span class="hljs-number">2000</span>);  <span class="hljs-comment">// 每2秒调整一次高度</span>
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<h3 data-id="heading-6">使用说明：</h3>
<ul>
<li>这个方法通过将一个隐藏的 iframe 嵌套到目标容器内，利用 iframe 的 <code>resize</code> 事件来检测容器的高度变化。</li>
<li>由于 <code>iframe</code> 的 <code>resize</code> 事件会在容器的尺寸发生变化时触发，因此我们可以在事件回调中获取容器的最新高度。</li>
<li>此方法的兼容性更广，可以支持老旧浏览器，如 IE 浏览器。</li>
</ul>
<h2 data-id="heading-7">总结</h2>
<p>通过这两种方法，我们可以动态监听 DOM 元素的高度变化，选择适合的方案可以保证跨浏览器和设备的兼容性。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[智能体颠覆教育行业调研报告：英语、编程、语文、数学学科应用分析]]></title>    <link>https://juejin.cn/post/7570197010885361710</link>    <guid>https://juejin.cn/post/7570197010885361710</guid>    <pubDate>2025-11-09T15:02:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7570197010885361710" data-draft-id="7570243451724775451" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="智能体颠覆教育行业调研报告：英语、编程、语文、数学学科应用分析"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-09T15:02:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="oioihoii"/> <meta itemprop="url" content="https://juejin.cn/user/1972974802965230"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            智能体颠覆教育行业调研报告：英语、编程、语文、数学学科应用分析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1972974802965230/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    oioihoii
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-09T15:02:07.000Z" title="Sun Nov 09 2025 15:02:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读35分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>教育行业正经历着自印刷术发明以来最深刻的结构性变革，其核心驱动力来自人工智能技术的突破性进展。传统教育模式长期面临的个性化不足、资源分配不均等痛点，在智能体技术的冲击下迎来系统性重构的契机。数据显示，我国初一新生数学能力标准差高达 23.7 分，这种显著的个体差异与"一刀切"的教学模式形成尖锐矛盾，导致 30% 的学生出现"消化不良"，25% 的学生产生"知识饥渴"[<a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.gdedu123.com%2Fgd%2F686482.html" target="_blank" title="http://www.gdedu123.com/gd/686482.html" ref="nofollow noopener noreferrer">1</a>]。与之形成鲜明对比的是，智慧中心教育平台通过自适应诊断系统，能在 72 小时内完成新生数学能力的全方位评估，使用该平台个性化学习方案的学生，在有理数运算模块的掌握速度比传统教学快 40%，错误率下降 57%[<a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.gdedu123.com%2Fgd%2F686482.html" target="_blank" title="http://www.gdedu123.com/gd/686482.html" ref="nofollow noopener noreferrer">1</a>]。这种实证数据的强烈反差，直观揭示了智能体技术对教育效率提升的革命性意义。</p>
<p><strong>核心写作原则</strong>：本报告严格遵循"真实可靠"的实证研究标准，所有数据引用均标注可验证来源，关键政策文件链接指向教育部官网公开资源，学科应用案例均来自可追溯的平台实践报告，确保研究结论建立在坚实的事实基础之上。</p>
<p>从政策维度看，智能教育已成为国家战略布局的核心领域。教育部出台《中小学人工智能通识教育指南（2025 年版）》和《中小学生成式人工智能使用指南（2025 年版）》，从顶层设计层面规范 AI 教育应用的发展方向[<a href="https://link.juejin.cn?target=http%3A%2F%2Fm.toutiao.com%2Fgroup%2F7545373719712940570%2F%3Fupstream_biz%3Ddoubao" target="_blank" title="http://m.toutiao.com/group/7545373719712940570/?upstream_biz=doubao" ref="nofollow noopener noreferrer">2</a>]。习近平总书记明确指出："教育数字化是我国开辟教育发展新赛道和塑造教育发展新优势的重要突破口。"《教育强国建设规划纲要（2024—2035 年）》进一步提出实施国家教育数字化战略，促进人工智能助力教育变革[<a href="https://link.juejin.cn?target=https%3A%2F%2Fhudong.moe.gov.cn%2Fjyb_xwfb%2Fs5147%2F202504%2Ft20250417_1187747.html" target="_blank" title="https://hudong.moe.gov.cn/jyb_xwfb/s5147/202504/t20250417_1187747.html" ref="nofollow noopener noreferrer">3</a>]。这种政策支持体系为智能体技术在教育领域的深度应用提供了制度保障，推动其从实验性阶段转向嵌入核心学习基础设施[<a href="https://link.juejin.cn?target=http%3A%2F%2Fm.toutiao.com%2Fgroup%2F7545373719712940570%2F%3Fupstream_biz%3Ddoubao" target="_blank" title="http://m.toutiao.com/group/7545373719712940570/?upstream_biz=doubao" ref="nofollow noopener noreferrer">2</a>]。</p>
<p>产业层面呈现爆发式增长态势，中国智慧教育市场规模 2023 年已达 7200 亿元，预计 2025 年将突破 1.2 万亿元，年复合增长率达 14.5%[<a href="https://link.juejin.cn?target=https%3A%2F%2Fm.book118.com%2Fhtml%2F2025%2F0817%2F5222214322012312.shtm" target="_blank" title="https://m.book118.com/html/2025/0817/5222214322012312.shtm" ref="nofollow noopener noreferrer">4</a>]。市场繁荣的背后是技术能力的实质性突破，2025 年 GPT-5 等高级 AI 模型的出现标志着教育领域的关键转折点，AI 驱动的学习平台已从实验性附加工具演变为能够提供个性化、情境感知辅导的复杂智能体[<a href="https://link.juejin.cn?target=https%3A%2F%2Fai2.work%2Feconomics%2Fai-market-ai-driven-learning-boosts-scores-2025%2F" target="_blank" title="https://ai2.work/economics/ai-market-ai-driven-learning-boosts-scores-2025/" ref="nofollow noopener noreferrer">5</a>]。这种技术跃迁使得"因材施教"的教育理想具备了规模化实现的可能，如睿诺思教育集团自主研发的"启慧"智慧教育平台，整合顶尖 AI 算法工程师与教育专家资源，历时两年耗资数十亿，旨在弥合地域鸿沟、消解资源壁垒[<a href="https://link.juejin.cn?target=https%3A%2F%2Fweixin.rnsvip.com%2Findex.php%3Fa%3Dshow%26id%3D3006%26m%3DArticle" target="_blank" title="https://weixin.rnsvip.com/index.php?a=show&amp;id=3006&amp;m=Article" ref="nofollow noopener noreferrer">6</a>]。</p>
<p>本报告将通过"技术-学科-挑战-趋势"的四维分析框架，系统解构智能体技术重塑教育行业的内在逻辑与实现路径。在技术维度，重点剖析生成式 AI、多模态交互等核心技术对教育场景的适应性改造；在学科应用层面，将分别对英语、编程、语文、数学四门核心学科的智能体解决方案进行实证分析，包括英语智能教学平台提升互动性的具体机制、数学 3D 动态模型对抽象概念理解的促进效应等[<a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.gdedu123.com%2Fgd%2F686482.html" target="_blank" title="http://www.gdedu123.com/gd/686482.html" ref="nofollow noopener noreferrer">1</a>][<a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fyuntongliangda%2Farticle%2Fdetails%2F147495222" target="_blank" title="https://blog.csdn.net/yuntongliangda/article/details/147495222" ref="nofollow noopener noreferrer">7</a>]；在挑战部分，深入探讨数据隐私、算法偏见等伦理风险；最后基于联合国教科文组织《教育 2030 行动框架》等国际视野，前瞻智能教育的未来发展方向[<a href="https://link.juejin.cn?target=https%3A%2F%2Fm.book118.com%2Fhtml%2F2025%2F0912%2F6124010042011230.shtm" target="_blank" title="https://m.book118.com/html/2025/0912/6124010042011230.shtm" ref="nofollow noopener noreferrer">8</a>]。通过这种多维度、实证化的研究路径，本报告力图全面呈现智能体技术如何重新定义教与学的本质，为教育工作者、政策制定者和技术开发者提供兼具战略高度与实践价值的决策参考。</p>
<p>全球范围内，人工智能已成为推动教育变革的核心驱动力。联合国教科文组织强调利用 AI 技术促进教育公平与质量提升，美国将"AI 与教育"列为国家重点领域，欧盟则聚焦伦理规范与风险防控[<a href="https://link.juejin.cn?target=https%3A%2F%2Fm.book118.com%2Fhtml%2F2025%2F0912%2F6124010042011230.shtm" target="_blank" title="https://m.book118.com/html/2025/0912/6124010042011230.shtm" ref="nofollow noopener noreferrer">8</a>]。在这一全球浪潮下，我国教育体系正经历从数字化到智能化的深刻转型，国家智慧教育公共服务平台注册用户数已突破 1.63 亿，浏览量达 608 亿，成为教育数字化转型的集大成者[<a href="https://link.juejin.cn?target=https%3A%2F%2Fhudong.moe.gov.cn%2Fjyb_xwfb%2Fs5147%2F202504%2Ft20250417_1187747.html" target="_blank" title="https://hudong.moe.gov.cn/jyb_xwfb/s5147/202504/t20250417_1187747.html" ref="nofollow noopener noreferrer">3</a>]。当技术变革与政策引导形成合力，教育行业正站在历史性转折点上，智能体不仅是教学工具的革新，更将重构教育的底层逻辑与价值形态，最终实现从"教育 1.0"到"教育 4.0"的范式革命。</p>
<h2 data-id="heading-0">全球及中国智能教育市场发展现状</h2>
<p>全球智能教育市场正经历爆发式增长，形成以技术迭代与需求扩张双轮驱动的发展格局。根据 "AI in Education Global Market Report 2024" 数据，全球 AI 教育市场规模预计将从 2023 年的 39.9 亿美元增长至 2024 年的 55.7 亿美元，复合年增长率（CAGR）高达 39.7%，到 2028 年将进一步达到 211.3 亿美元[<a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.shurl.cc%2F90301cca26d0b6452aa62384ca72a5b0" target="_blank" title="http://www.shurl.cc/90301cca26d0b6452aa62384ca72a5b0" ref="nofollow noopener noreferrer">9</a>]。另据 Precedence Research 预测，2025 年市场规模将达到 70 - 75.7 亿美元区间，2034 年更将攀升至 1123 亿美元，长期复合年增长率维持在 36% 以上[<a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fweixin_53105865%2Farticle%2Fdetails%2F149060705" target="_blank" title="https://blog.csdn.net/weixin_53105865/article/details/149060705" ref="nofollow noopener noreferrer">10</a>]。这一增长态势主要得益于智能手机用户规模的持续扩张，2022 年全球智能手机订阅量已达 64.2 亿，预计 2028 年将增长至 77.4 亿，为移动教育应用提供了广阔的用户基础[<a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.shurl.cc%2F90301cca26d0b6452aa62384ca72a5b0" target="_blank" title="http://www.shurl.cc/90301cca26d0b6452aa62384ca72a5b0" ref="nofollow noopener noreferrer">9</a>]。
从市场结构看，企业培训领域占比超过 45%，成为全球 AI 教育市场最大的细分板块；技术部署方面，云平台凭借 59 - 72% 的市场份额主导行业技术架构[<a href="https://link.juejin.cn?target=https%3A%2F%2Fagentiveaiq.com%2Fblog%2Fhow-big-is-the-edtech-ai-market-in-2025" target="_blank" title="https://agentiveaiq.com/blog/how-big-is-the-edtech-ai-market-in-2025" ref="nofollow noopener noreferrer">11</a>]。应用渗透层面，教育行业已成为生成式 AI 应用率最高的领域，86% 的教育机构已启用相关技术，美国学生 AI 使用率较去年提升 26 个百分点，教育工作者应用率增长 21 个百分点[<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.microsoft.com%2Fen-us%2Feducation%2Fblog%2F2025%2F08%2Fai-in-education-report-insights-to-support-teaching-and-learning%2F" target="_blank" title="https://www.microsoft.com/en-us/education/blog/2025/08/ai-in-education-report-insights-to-support-teaching-and-learning/" ref="nofollow noopener noreferrer">12</a>]。
中国市场在全球格局中表现尤为突出，呈现政策引导与市场驱动协同发展的特征。规模方面，中国智慧教育市场从 2017 年的 4542 亿元增长至 2022 年的 10157 亿元，预计 2025 年将突破 9000 亿元，2030 年有望达到 1.8 万亿元，长期增速保持在 12% 左右[<a href="https://link.juejin.cn?target=https%3A%2F%2Fm.book118.com%2Fhtml%2F2025%2F0817%2F5222214322012312.shtm" target="_blank" title="https://m.book118.com/html/2025/0817/5222214322012312.shtm" ref="nofollow noopener noreferrer">4</a>][<a href="https://link.juejin.cn?target=https%3A%2F%2Fmguba.eastmoney.com%2Fmguba%2Farticle%2F0%2F1530642118" target="_blank" title="https://mguba.eastmoney.com/mguba/article/0/1530642118" ref="nofollow noopener noreferrer">13</a>]。政策层面，九部门《关于加快推进教育数字化的意见》提出 "集成化、智能化、国际化" 的 "3I" 发展理念，强调人工智能教育大模型与教学深度融合，国家智慧教育平台 2.0 智能版已上线 "AI 学习" 专栏，整合智能交互、知识图谱等技术优化教学测评与资源搜索功能[<a href="https://link.juejin.cn?target=https%3A%2F%2Fhudong.moe.gov.cn%2Fjyb_xwfb%2Fs5147%2F202504%2Ft20250417_1187747.html" target="_blank" title="https://hudong.moe.gov.cn/jyb_xwfb/s5147/202504/t20250417_1187747.html" ref="nofollow noopener noreferrer">3</a>][<a href="https://link.juejin.cn?target=https%3A%2F%2Fedu.people.com.cn%2Fn1%2F2025%2F0417%2Fc1006-40461775.html" target="_blank" title="https://edu.people.com.cn/n1/2025/0417/c1006-40461775.html" ref="nofollow noopener noreferrer">14</a>]。</p>
<p><strong>中国智能教育市场增长轨迹（2017 - 2030）</strong>
2017 年：4542 亿元 → 2022 年：10157 亿元 → 2025 年（预测）：9000 亿元 → 2030 年（预测）：1.8 万亿元，长期复合增长率约 12%[<a href="https://link.juejin.cn?target=https%3A%2F%2Fm.book118.com%2Fhtml%2F2025%2F0817%2F5222214322012312.shtm" target="_blank" title="https://m.book118.com/html/2025/0817/5222214322012312.shtm" ref="nofollow noopener noreferrer">4</a>][<a href="https://link.juejin.cn?target=https%3A%2F%2Fmguba.eastmoney.com%2Fmguba%2Farticle%2F0%2F1530642118" target="_blank" title="https://mguba.eastmoney.com/mguba/article/0/1530642118" ref="nofollow noopener noreferrer">13</a>]。</p>
<p>产业支撑体系已形成多元主体协同布局的生态格局。科大讯飞(行情002230,诊股)、鸥玛软件(行情301185,诊股)等上市公司通过技术研发构建核心竞争力，互联网巨头如阿里云课堂、腾讯教育进行全生态链布局，猿辅导、作业帮等垂直领域独角兽则聚焦差异化场景[<a href="https://link.juejin.cn?target=https%3A%2F%2Fm.book118.com%2Fhtml%2F2025%2F0817%2F5222214322012312.shtm" target="_blank" title="https://m.book118.com/html/2025/0817/5222214322012312.shtm" ref="nofollow noopener noreferrer">4</a>]。基础设施建设方面，全国 17 个省份已建成省级教育数据中心，其中山东教育数据中心部署国家统建系统及省级业务平台 10 个，包含子系统 90 余个，为智能教育应用提供底层支撑[<a href="https://link.juejin.cn?target=https%3A%2F%2Fhudong.moe.gov.cn%2Fjyb_xwfb%2Fs5147%2F202504%2Ft20250417_1187747.html" target="_blank" title="https://hudong.moe.gov.cn/jyb_xwfb/s5147/202504/t20250417_1187747.html" ref="nofollow noopener noreferrer">3</a>]。典型案例显示，希沃课堂智能反馈系统已覆盖全国超 1000 所学校，累计生成超 75000 份课堂分析报告，印证了技术落地的规模化效应[<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.seewo.com%2Farticle%2Fdetail%2F2669" target="_blank" title="https://www.seewo.com/article/detail/2669" ref="nofollow noopener noreferrer">15</a>]。</p>
<p>区域实践层面，宁夏回族自治区将省级平台与国家平台工具整合为 "大工具箱"，开发推广智慧学伴、智能助教等数字工具，成为政策落地的区域典范[<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.moe.gov.cn%2Fjyb_xwfb%2Fs6192%2Fs222%2Fmoe_1762%2F202503%2Ft20250331_1185653.html" target="_blank" title="https://www.moe.gov.cn/jyb_xwfb/s6192/s222/moe_1762/202503/t20250331_1185653.html" ref="nofollow noopener noreferrer">16</a>]。这种 "政策-技术-产业" 的三维驱动模式，正推动中国智能教育市场从工具应用向生态重构演进，为全球教育智能化转型提供实践样本。</p>
<h2 data-id="heading-1">智能体在学科教育中的应用分析</h2>
<h3 data-id="heading-2">英语学科：从标准化教学到个性化语言能力培养</h3>
<p>智能体技术正通过资源整合、数据驱动和互动形式三大维度重构英语教学范式。智能教学平台已实现文本、音频、视频等多元资源的系统化整合，如国家开放大学与科大讯飞合作开发的《学位英语》课程，通过知识图谱拆解200个知识点，配套141个AI虚拟人课件和844分钟虚拟资源，构建起动态更新的立体化学习资源库[<a href="https://link.juejin.cn?target=http%3A%2F%2Fm2.people.cn%2Fnews%2Fdefault.html%3Fs%3DM18zXzIxMDYzMDY0XzQwNDJfMTcxNTA1MjQyOQ%3D%3D%26from%3Dsohu" target="_blank" title="http://m2.people.cn/news/default.html?s=M18zXzIxMDYzMDY0XzQwNDJfMTcxNTA1MjQyOQ==&amp;from=sohu" ref="nofollow noopener noreferrer">17</a>]。这种资源整合能力在基础教学场景中显现显著价值，例如通过AR语音朗读评分系统对《登鹳雀楼》等诗词的英文朗诵进行实时发音矫正，将语言学习与文化理解深度融合[<a href="https://link.juejin.cn?target=http%3A%2F%2Fxueshu.qikan.com.cn%2Fpreview%2F1%2F71%2F4669255" target="_blank" title="http://xueshu.qikan.com.cn/preview/1/71/4669255" ref="nofollow noopener noreferrer">18</a>]。</p>
<p>数据驱动的个性化学习构成智能教学的核心引擎。AI系统通过分析学习行为数据实现精准分层教学，如JBoltAI系统可根据自然拼读掌握情况动态调整练习难度，针对"th"清浊音混淆等高频错误生成专项强化训练[<a href="https://link.juejin.cn?target=https%3A%2F%2Ftt.jxnews.com.cn%2Fnews%2F2811888%3Fapp%3Dsry" target="_blank" title="https://tt.jxnews.com.cn/news/2811888?app=sry" ref="nofollow noopener noreferrer">19</a>]；"爱种子"平台则通过语音测评快速定位发音问题，为不同水平学生推荐适配的听说任务[<a href="https://link.juejin.cn?target=https%3A%2F%2Ftt.jxnews.com.cn%2Fnews%2F2811888%3Fapp%3Dsry" target="_blank" title="https://tt.jxnews.com.cn/news/2811888?app=sry" ref="nofollow noopener noreferrer">19</a>]。上海交通大学开发的AI数字人智能对话系统更进一步，通过微信小程序为四千余名学生提供一对一发音辅导，其自适应难度模式能匹配不同水平学习者，系统涵盖情景对话、自由交谈、朗读测评等模块，学生跟读文本后可获得即时反馈与AI打分，教师后台则能实时追踪学习进度与对话记录[<a href="https://link.juejin.cn?target=https%3A%2F%2Fnews.sjtu.edu.cn%2Fztzl_aijyzl%2F20250611%2F211580.html" target="_blank" title="https://news.sjtu.edu.cn/ztzl_aijyzl/20250611/211580.html" ref="nofollow noopener noreferrer">20</a>]。</p>
<p>互动教学形式的革新显著提升学习沉浸感与参与度。AI聊天机器人可模拟购物、节日问候等真实场景进行实时对话，通过ASR技术纠正发音偏差；在读写教学中，能围绕"Jobs and Hobbies"等主题生成分级阅读材料和思维导图式写作支架[<a href="https://link.juejin.cn?target=https%3A%2F%2Ftt.jxnews.com.cn%2Fnews%2F2811888%3Fapp%3Dsry" target="_blank" title="https://tt.jxnews.com.cn/news/2811888?app=sry" ref="nofollow noopener noreferrer">19</a>]。跨文化交流能力培养成为新突破点，部分平台已实现国际学习者语言合作任务功能，通过跨文化讨论模块和文化背景视频资源，帮助学生理解语言使用的语境性，其讨论模块使用频次与语言得体性评分呈正相关[<a href="https://link.juejin.cn?target=http%3A%2F%2Fxueshu.qikan.com.cn%2Fpreview%2F1%2F71%2F4669255" target="_blank" title="http://xueshu.qikan.com.cn/preview/1/71/4669255" ref="nofollow noopener noreferrer">18</a>]。生成式AI工具还能激发学习者的理想二语自我想象与国际姿态，研究表明这些因素对非正式数字英语学习活动具有显著促进作用[<a href="https://link.juejin.cn?target=https%3A%2F%2Feric.ed.gov%2F%3Fq%3Dsource%253a%2522Journal%2Bof%2BEducational%2BTechnology%2522%26ff1%3DsouJournal%2Bof%2BEducational%2BTechnology%2BSystems" target="_blank" title="https://eric.ed.gov/?q=source%3a%22Journal+of+Educational+Technology%22&amp;ff1=souJournal+of+Educational+Technology+Systems" ref="nofollow noopener noreferrer">21</a>]。</p>
<p>教学实践数据印证了智能体技术的应用成效。流程优化方面，AI工具使词汇拼写、语法填空等客观题批改效率提升60%，教师备课时间缩短40%[<a href="https://link.juejin.cn?target=https%3A%2F%2Ftt.jxnews.com.cn%2Fnews%2F2811888%3Fapp%3Dsry" target="_blank" title="https://tt.jxnews.com.cn/news/2811888?app=sry" ref="nofollow noopener noreferrer">19</a>]。实证研究显示，经过3个月AI辅助教学，实验班学生口语proficiency和交际意愿(WTC)显著高于传统班级；一学期实验后，综合成绩平均分高出8.3分，其中口语和写作模块分别提升10.5分和9.2分[<a href="https://link.juejin.cn?target=https%3A%2F%2Ftt.jxnews.com.cn%2Fnews%2F2811888%3Fapp%3Dsry" target="_blank" title="https://tt.jxnews.com.cn/news/2811888?app=sry" ref="nofollow noopener noreferrer">19</a>]。这种"技术功能-教学场景-效果验证"的闭环体系，正在推动英语教育从标准化知识传授向个性化语言能力培养的范式转型。</p>
<p><strong>核心技术路径</strong></p>
<ul>
<li>精准分层：通过自然语言处理技术定位发音、语法薄弱点，生成个性化强化方案- 语境创设：利用虚拟场景构建真实交际环境，ASR技术实现实时语音纠错- 流程优化：AI自动批改客观题并生成错题分析，教师干预聚焦高阶能力培养</li>
</ul>
<p>智能体技术在英语教学中的深度应用，不仅体现在工具层面的效率提升，更重构了"以学习者为中心"的教育生态。从国家开放大学的知识图谱课程到上海交大的AI数字人口语教练，技术赋能正使个性化语言教育从精英特权转变为普惠资源，为培养具备跨文化沟通能力的国际化人才提供全新可能。</p>
<h3 data-id="heading-3">数学学科：从抽象概念到可视化思维培养</h3>
<h4 data-id="heading-4">传统数学教育的结构性矛盾</h4>
<p>传统数学教育"一刀切"模式面临显著的结构性矛盾，某市教育质量监测数据显示，初一新生数学能力标准差达23.7分，30%学生存在"消化不良"问题，25%学生处于"知识饥渴"状态[<a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.gdedu123.com%2Fgd%2F686482.html" target="_blank" title="http://www.gdedu123.com/gd/686482.html" ref="nofollow noopener noreferrer">1</a>]。这种矛盾在抽象概念教学中尤为突出，如函数图像动态变化规律、立体几何空间关系等内容，长期依赖静态板书和二维图示，导致63%的学生反馈"难以将抽象概念与现实情境建立联系"[<a href="https://link.juejin.cn?target=http%3A%2F%2Fm.toutiao.com%2Fgroup%2F7538723061894218283%2F%3Fupstream_biz%3Ddoubao" target="_blank" title="http://m.toutiao.com/group/7538723061894218283/?upstream_biz=doubao" ref="nofollow noopener noreferrer">22</a>]。</p>
<h4 data-id="heading-5">智能体的可视化解决方案</h4>
<p>智慧中心平台构建了"实时预警-动态建模-精准干预"的闭环教学流程。以"一元一次方程"教学为例，系统通过3D模型将抽象等量关系转化为可操作的动态平衡场景，学生可拖拽虚拟砝码观察等式两边的变化关系[<a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.gdedu123.com%2Fgd%2F686482.html" target="_blank" title="http://www.gdedu123.com/gd/686482.html" ref="nofollow noopener noreferrer">1</a>]。在立体几何教学中，AR技术让学生能"握在手中"旋转观察几何体，空间想象力培养效率提升80%；VR虚拟实验室则支持实时切割正方体操作，直观呈现三角形、六边形等不同截面的形成过程[<a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.gdedu123.com%2Fgd%2F686482.html" target="_blank" title="http://www.gdedu123.com/gd/686482.html" ref="nofollow noopener noreferrer">1</a>][<a href="https://link.juejin.cn?target=http%3A%2F%2Fm.toutiao.com%2Fgroup%2F7560220927951143467%2F%3Fupstream_biz%3Ddoubao" target="_blank" title="http://m.toutiao.com/group/7560220927951143467/?upstream_biz=doubao" ref="nofollow noopener noreferrer">23</a>]。</p>
<p>针对函数教学的痛点，智能系统设计了参数调节交互界面，学生通过滑动条改变函数参数时，图像会同步动态更新，配合切线斜率实时计算演示，使导数的几何意义从抽象定义转化为可观察的动态过程[<a href="https://link.juejin.cn?target=http%3A%2F%2Fm.toutiao.com%2Fgroup%2F7538723061894218283%2F%3Fupstream_biz%3Ddoubao" target="_blank" title="http://m.toutiao.com/group/7538723061894218283/?upstream_biz=doubao" ref="nofollow noopener noreferrer">22</a>]。球体体积公式推导中，3D动画模拟"球体分割为无数小圆锥体"的积累过程，让"4/3πr³"的数学表达获得具象解释[<a href="https://link.juejin.cn?target=http%3A%2F%2Fm.toutiao.com%2Fgroup%2F7538723061894218283%2F%3Fupstream_biz%3Ddoubao" target="_blank" title="http://m.toutiao.com/group/7538723061894218283/?upstream_biz=doubao" ref="nofollow noopener noreferrer">22</a>]。</p>
<h4 data-id="heading-6">实证效果与数据支撑</h4>
<p>基于palmyra-mini模型的对照实验显示，AI辅助教学组在8周内实现代数运算错误减少41%，几何证明错误减少37%，成绩提升幅度（13.8分）是传统教学组（5.7分）的2.4倍[<a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fgitblog_00429%2Farticle%2Fdetails%2F152018725" target="_blank" title="https://blog.csdn.net/gitblog_00429/article/details/152018725" ref="nofollow noopener noreferrer">24</a>]。更广泛的教学实践表明，智能导学系统使学生数学抽象能力测评得分提升23.7%，"正比例和反比例"单元测试优秀率从45%增至70%[<a href="https://link.juejin.cn?target=http%3A%2F%2Fm.toutiao.com%2Fgroup%2F7560220927951143467%2F%3Fupstream_biz%3Ddoubao" target="_blank" title="http://m.toutiao.com/group/7560220927951143467/?upstream_biz=doubao" ref="nofollow noopener noreferrer">23</a>]。</p>
<p><strong>核心成效数据对比</strong></p>
<ul>
<li>解题效率：相同难度试卷完成时间缩短22% [<a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fgitblog_00429%2Farticle%2Fdetails%2F152018725" target="_blank" title="https://blog.csdn.net/gitblog_00429/article/details/152018725" ref="nofollow noopener noreferrer">24</a>]- 课堂参与：主动提问频次提升67%，参与度从58%增至89% [<a href="https://link.juejin.cn?target=http%3A%2F%2Fm.toutiao.com%2Fgroup%2F7560220927951143467%2F%3Fupstream_biz%3Ddoubao" target="_blank" title="http://m.toutiao.com/group/7560220927951143467/?upstream_biz=doubao" ref="nofollow noopener noreferrer">23</a>]- 概念理解：63%学生反馈"AI动态实验让抽象概念变得可触摸" [<a href="https://link.juejin.cn?target=http%3A%2F%2Fm.toutiao.com%2Fgroup%2F7560220927951143467%2F%3Fupstream_biz%3Ddoubao" target="_blank" title="http://m.toutiao.com/group/7560220927951143467/?upstream_biz=doubao" ref="nofollow noopener noreferrer">23</a>]- 长期提分：2025年高中数学智能辅导平均提分35-40分，函数模块提升率达42% [<a href="https://link.juejin.cn?target=https%3A%2F%2Fm.renrendoc.com%2Fpaper%2F481467283.html" target="_blank" title="https://m.renrendoc.com/paper/481467283.html" ref="nofollow noopener noreferrer">25</a>]</li>
</ul>
<p>北京朝阳区中学的实践案例显示，智能系统通过多模态交互捕捉学生思维轨迹，对逻辑漏洞提供即时引导。其分层教学策略使基础层学生通过几何画板理解定理形成过程，应用层学生开展探究式学习，拓展层学生解决跨学科测量问题，实现个性化能力提升[<a href="https://link.juejin.cn?target=http%3A%2F%2Fm.toutiao.com%2Fgroup%2F7560220927951143467%2F%3Fupstream_biz%3Ddoubao" target="_blank" title="http://m.toutiao.com/group/7560220927951143467/?upstream_biz=doubao" ref="nofollow noopener noreferrer">23</a>]。这种"可视化+精准化"的教学范式，正在重塑数学教育从知识传授到思维培养的核心路径。</p>
<h3 data-id="heading-7">语文学科：从知识灌输到核心素养培育</h3>
<p>智能体在语文学科的应用正推动教学范式从知识灌输向核心素养培育转型，其价值集中体现在"教-学-评"全流程的智能化重构。在教学端，智能备课系统通过知识图谱技术实现教学内容的结构化呈现，如针对《植物妈妈有办法》开发的生字关联网络，能自动梳理"旅、洼、啪"等汉字的偏旁部首关联，并结合往届学生错题数据标注"洼"与"娃"的混淆点，使教师讲解时间压缩50%，释放更多精力开展探究式教学[<a href="https://link.juejin.cn?target=https%3A%2F%2Fggrb.ggnews.com.cn%2Fhtml%2F2025-06%2F04%2Fcontent_27338_18582335.htm" target="_blank" title="https://ggrb.ggnews.com.cn/html/2025-06/04/content_27338_18582335.htm" ref="nofollow noopener noreferrer">26</a>]。沉浸式课堂则通过多模态交互深化学习体验，在《曹冲称象》教学中，3D建模还原的称象场景允许学生拖拽虚拟石块模拟"等量替换"过程，配合AI表情识别系统（当15%以上学生分心时自动触发互动），使知识点吸收率显著提升[<a href="https://link.juejin.cn?target=https%3A%2F%2Fggrb.ggnews.com.cn%2Fhtml%2F2025-06%2F04%2Fcontent_27338_18582335.htm" target="_blank" title="https://ggrb.ggnews.com.cn/html/2025-06/04/content_27338_18582335.htm" ref="nofollow noopener noreferrer">26</a>]。</p>
<p>学习环节的智能化体现在分层教学的精准实施。基于学生错题数据构建的个性化学习图谱，能为识字薄弱学生推送"偏旁拆解游戏"，为阅读理解困难者提供"句子排序训练"[<a href="https://link.juejin.cn?target=https%3A%2F%2Fggrb.ggnews.com.cn%2Fhtml%2F2025-06%2F04%2Fcontent_27338_18582335.htm" target="_blank" title="https://ggrb.ggnews.com.cn/html/2025-06/04/content_27338_18582335.htm" ref="nofollow noopener noreferrer">26</a>]。北京师范大学开发的古诗文学习平台通过AI意境画生成技术，将《山居秋暝》诗句转化为"明月松间照，清泉石上流"的动态画面，使85%的学生反馈"更愿意主动学习古诗文"，古诗理解测试平均分提高15.7分[<a href="https://link.juejin.cn?target=http%3A%2F%2Fm.toutiao.com%2Fgroup%2F7527659819625382450%2F%3Fupstream_biz%3Ddoubao" target="_blank" title="http://m.toutiao.com/group/7527659819625382450/?upstream_biz=doubao" ref="nofollow noopener noreferrer">27</a>]。而讯飞语阅系统通过分析阅读速度、停顿位置等微观行为生成能力图谱，经一学期训练使学生阅读理解正确率从68%提升至82%，远超对照组5%的进步幅度[<a href="https://link.juejin.cn?target=http%3A%2F%2Fm.toutiao.com%2Fgroup%2F7527659819625382450%2F%3Fupstream_biz%3Ddoubao" target="_blank" title="http://m.toutiao.com/group/7527659819625382450/?upstream_biz=doubao" ref="nofollow noopener noreferrer">27</a>]。</p>
<p>评价体系的革新尤为显著。海淀区第二实验小学引入的智能作文批改系统，通过92%的错误检出率实现精准标注，如提示"此处比喻不够贴切"等具体修改建议，使学生作文修改次数平均增加2.3次，语言错误率下降42%[<a href="https://link.juejin.cn?target=http%3A%2F%2Fm.toutiao.com%2Fgroup%2F7527659819625382450%2F%3Fupstream_biz%3Ddoubao" target="_blank" title="http://m.toutiao.com/group/7527659819625382450/?upstream_biz=doubao" ref="nofollow noopener noreferrer">27</a>]。贵港地区试点数据显示，使用AI作文批改的班级在"看图写话"项目中优秀率达47%，较对照班高出28个百分点，一名原本仅能写出5句话的学生，通过系统的句式推荐和词汇拓展，三个月内可完成200字结构完整的短文[<a href="https://link.juejin.cn?target=https%3A%2F%2Fggrb.ggnews.com.cn%2Fhtml%2F2025-06%2F04%2Fcontent_27338_18582335.htm" target="_blank" title="https://ggrb.ggnews.com.cn/html/2025-06/04/content_27338_18582335.htm" ref="nofollow noopener noreferrer">26</a>]。教师角色也随之转变，AI将批改时间缩短75%后，教师得以聚焦高阶思维指导，如北京某中学"小冰诗人"系统中，学生与"AI李白"探讨"天生我材必有用"的创作心境，教师则引导学生对比虚拟对话与历史文献的差异[<a href="https://link.juejin.cn?target=http%3A%2F%2Fm.toutiao.com%2Fgroup%2F7527659819625382450%2F%3Fupstream_biz%3Ddoubao" target="_blank" title="http://m.toutiao.com/group/7527659819625382450/?upstream_biz=doubao" ref="nofollow noopener noreferrer">27</a>]。</p>
<p><strong>技术-人文平衡的实践路径</strong>：在《登鹳雀楼》等古诗文教学中，需建立"AI初评+教师复评"双轨机制。AI可检测朗读的语音标准度与情感基调，教师则深入解读"欲穷千里目"蕴含的人生哲思，避免算法对审美感知和创造性思维的误判。北京师范大学吴娟教授指出，这种模式既保留了AI的效率优势，又确保了人文教育的温度[<a href="https://link.juejin.cn?target=http%3A%2F%2Fm.toutiao.com%2Fgroup%2F7527659819625382450%2F%3Fupstream_biz%3Ddoubao" target="_blank" title="http://m.toutiao.com/group/7527659819625382450/?upstream_biz=doubao" ref="nofollow noopener noreferrer">27</a>][<a href="https://link.juejin.cn?target=https%3A%2F%2Fqzrb.gxqzxw.com%2Fpad%2Fcontent%2F202507%2F02%2Fcontent_53308.html" target="_blank" title="https://qzrb.gxqzxw.com/pad/content/202507/02/content_53308.html" ref="nofollow noopener noreferrer">28</a>]。</p>
<p>数据驱动的教学改进需要警惕"唯数据论"倾向。某区"AI+语文"教师培训使85%的教师能独立设计分层教学任务，但同时也需认识到AI在情感体验解读上的局限性——如诗歌鉴赏中的复杂意境和作文中的独特创意，仍依赖教师的专业判断[<a href="https://link.juejin.cn?target=https%3A%2F%2Fggrb.ggnews.com.cn%2Fhtml%2F2025-06%2F04%2Fcontent_27338_18582335.htm" target="_blank" title="https://ggrb.ggnews.com.cn/html/2025-06/04/content_27338_18582335.htm" ref="nofollow noopener noreferrer">26</a>][<a href="https://link.juejin.cn?target=https%3A%2F%2Fqzrb.gxqzxw.com%2Fpad%2Fcontent%2F202507%2F02%2Fcontent_53308.html" target="_blank" title="https://qzrb.gxqzxw.com/pad/content/202507/02/content_53308.html" ref="nofollow noopener noreferrer">28</a>]。未来语文教育的智能化发展，将是技术赋能与人文关怀的深度融合，最终实现从"教会知识"到"培育素养"的质变。</p>
<h3 data-id="heading-8">编程学科：从工具操作到计算思维培养</h3>
<p>编程教育正经历从技术工具操作向计算思维培养的范式转变，智能体通过“跨学科工具-思维培养-教学效率”三维框架重构教学实践。以豆包AI编程为代表的低代码平台，已在语文《望岳》互动页面生成、数学PhET风格模拟实验开发等场景中展现出跨学科融合能力，其可视化编程界面使教师无需深入掌握代码语法即可快速开发教学工具，显著降低技术门槛[<a href="https://link.juejin.cn?target=https%3A%2F%2Fm.zxxk.com%2Farticle%2F1047385.html" target="_blank" title="https://m.zxxk.com/article/1047385.html" ref="nofollow noopener noreferrer">29</a>]。例如，语文教师可借助该平台将杜甫《望岳》诗句拆解为逻辑模块，通过拖拽组件实现“会当凌绝顶”诗句的动态呈现效果，学生在调整页面背景参数（如泰山云海的透明度变化）过程中，潜移默化地理解条件判断与循环逻辑的应用。</p>
<p><strong>计算思维迁移典型案例</strong>：数学PhET模拟实验中，学生通过调整抛物线参数（a/b/c值）观察函数图像变化，这种“输入-处理-输出”的逻辑训练，可迁移至物理运动轨迹分析、化学反应速率模拟等多学科场景[<a href="https://link.juejin.cn?target=https%3A%2F%2Fm.zxxk.com%2Farticle%2F1047385.html" target="_blank" title="https://m.zxxk.com/article/1047385.html" ref="nofollow noopener noreferrer">29</a>]。教师反馈显示，尽管背景图片修改等细节仍需手动调整CSS代码，但互动功能开发效率提升达60%以上，实现“技术为思维培养服务”的核心目标。</p>
<p>智能体驱动的教学模式创新呈现多元路径。北京邮电大学“码上”平台采用32B规模的Qwen2.5-Coder模型，通过分析学生代码与流程图数据构建知识图谱，实现编程问题的精准诊断——当学生调试排序算法时，系统不直接提供标准答案，而是通过提示“尝试将冒泡法的比较条件从&gt;改为&gt;=”引导自主探索[<a href="https://link.juejin.cn?target=http%3A%2F%2Fm2.people.cn%2Fnews%2Fdefault.html%3Fs%3DM18zXzIxMDYzMDY0XzQwNDJfMTcxNTA1MjQyOQ%3D%3D%26from%3Dsohu" target="_blank" title="http://m2.people.cn/news/default.html?s=M18zXzIxMDYzMDY0XzQwNDJfMTcxNTA1MjQyOQ==&amp;from=sohu" ref="nofollow noopener noreferrer">17</a>][<a href="https://link.juejin.cn?target=https%3A%2F%2Fnews.uestc.edu.cn%2F%3FId%3D95777%26n%3DUestcNews.Front.DocumentV2.ArticlePage" target="_blank" title="https://news.uestc.edu.cn/?Id=95777&amp;n=UestcNews.Front.DocumentV2.ArticlePage" ref="nofollow noopener noreferrer">30</a>]。无锡市春城实验小学则开创“反向学习编程”模式，学生用自然语言描述“机械狗迷宫寻路”任务，Cursor软件自动生成Python代码，教师再引导学生从代码反推“if-else条件判断”等抽象概念，这种“实践-抽象-再实践”的闭环使四年级学生独立完成率提升至78%[<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.jse.edu.cn%2Fstudio%2Findex.php%3Fr%3Dstudio%2Fpost%2Fview%26sid%3D204%26id%3D85705" target="_blank" title="https://www.jse.edu.cn/studio/index.php?r=studio/post/view&amp;sid=204&amp;id=85705" ref="nofollow noopener noreferrer">31</a>]。</p>
<p>产业实践与AI工具的结合正在突破课堂边界。宁夏乡村小学通过“机器人指令执行”游戏渗透算法思想，学生在模拟快递蜂巢系统编程中理解队列与栈的应用；DeepSeek-V2等国产大模型凭借优异的中文理解能力，支持校本化课程开发，如编程猫平台引入AI后，学生平均项目完成时间缩短42%[<a href="https://link.juejin.cn?target=https%3A%2F%2Fhudong.moe.gov.cn%2Fjyb_xwfb%2Fs5147%2F202504%2Ft20250417_1187747.html" target="_blank" title="https://hudong.moe.gov.cn/jyb_xwfb/s5147/202504/t20250417_1187747.html" ref="nofollow noopener noreferrer">3</a>][<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.jse.edu.cn%2Fstudio%2Findex.php%3Fr%3Dstudio%2Fpost%2Fview%26sid%3D204%26id%3D85705" target="_blank" title="https://www.jse.edu.cn/studio/index.php?r=studio/post/view&amp;sid=204&amp;id=85705" ref="nofollow noopener noreferrer">31</a>]。但需警惕技术依赖风险——潘晔教授团队构建的“教师-学生-AI协同飞轮”模式强调，AI助教应作为思维引导者而非代码生成器，通过上传专业书籍构建领域知识库，在学生提问时以“变量命名是否符合单一职责原则”等提示促进深度思考[<a href="https://link.juejin.cn?target=https%3A%2F%2Fnews.uestc.edu.cn%2F%3FId%3D95777%26n%3DUestcNews.Front.DocumentV2.ArticlePage" target="_blank" title="https://news.uestc.edu.cn/?Id=95777&amp;n=UestcNews.Front.DocumentV2.ArticlePage" ref="nofollow noopener noreferrer">30</a>]。</p>
<p>当前阶段的核心挑战在于平衡技术赋能与思维培养的关系。一方面，低代码平台需优化背景修改等高频需求的自动化程度，减少教师技术负担；另一方面，需建立“AI使用梯度”评价体系，从初期的代码生成辅助，逐步过渡到算法优化建议，最终实现计算思维的独立迁移。正如“赤壁之战”互动剧情页开发所揭示的，技术落地的价值不在于完美无缺的工具，而在于教师能否借助智能体将历史事件的因果关系转化为可交互的逻辑流程图，让学生在调整“风向参数”的决策中培养系统性思维[<a href="https://link.juejin.cn?target=https%3A%2F%2Fm.zxxk.com%2Farticle%2F1047385.html" target="_blank" title="https://m.zxxk.com/article/1047385.html" ref="nofollow noopener noreferrer">29</a>]。这种“工具服务于思维”的教育哲学，正是智能体重塑编程教育的核心要义。</p>
<h2 data-id="heading-9">智能体教育应用的技术驱动与核心能力</h2>
<p>智能体教育应用的技术架构遵循"基础技术-平台支撑-应用落地"三层逻辑体系，形成完整的技术驱动链条。在上游技术供给层，多模型协同与智能管线成为核心架构模式，整合了Whisper语音识别、GPT/BERT语义分析、EmotionNet情感识别、TextGCN篇章结构分析等AI模型，构建起覆盖教材解析、知识点抽取、多模态内容生成的全流程自动化处理能力[<a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fyuntongliangda%2Farticle%2Fdetails%2F147495222" target="_blank" title="https://blog.csdn.net/yuntongliangda/article/details/147495222" ref="nofollow noopener noreferrer">7</a>]。大语言模型展现出突出性能，如GPT-5融合高级推理与自适应对话记忆，Qwen2.5-Coder通过本地部署优化运行效率，讯飞星火大模型在中文语言理解与数学能力方面超越GPT-4，而基于palmyra-mini等模型开发的智能教学助手，能够依据课堂反馈与错题类型自动推送梯度匹配的学习资源[<a href="https://link.juejin.cn?target=https%3A%2F%2Fai2.work%2Feconomics%2Fai-market-ai-driven-learning-boosts-scores-2025%2F" target="_blank" title="https://ai2.work/economics/ai-market-ai-driven-learning-boosts-scores-2025/" ref="nofollow noopener noreferrer">5</a>][<a href="https://link.juejin.cn?target=http%3A%2F%2Fm2.people.cn%2Fnews%2Fdefault.html%3Fs%3DM18zXzIxMDYzMDY0XzQwNDJfMTcxNTA1MjQyOQ%3D%3D%26from%3Dsohu" target="_blank" title="http://m2.people.cn/news/default.html?s=M18zXzIxMDYzMDY0XzQwNDJfMTcxNTA1MjQyOQ==&amp;from=sohu" ref="nofollow noopener noreferrer">2</a>][<a href="https://link.juejin.cn?target=http%3A%2F%2Fm.toutiao.com%2Fgroup%2F7560220927951143467%2F%3Fupstream_biz%3Ddoubao" target="_blank" title="http://m.toutiao.com/group/7560220927951143467/?upstream_biz=doubao" ref="nofollow noopener noreferrer">3</a>][<a href="https://link.juejin.cn?target=https%3A%2F%2Fnews.uestc.edu.cn%2F%3FId%3D95777%26n%3DUestcNews.Front.DocumentV2.ArticlePage" target="_blank" title="https://news.uestc.edu.cn/?Id=95777&amp;n=UestcNews.Front.DocumentV2.ArticlePage" ref="nofollow noopener noreferrer">4</a>]。轻量化模型部署技术（TinyBERT、MobileNetV3）与离线语音包的应用，有效解决了低端设备与弱网环境下的使用痛点[<a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fyuntongliangda%2Farticle%2Fdetails%2F147495222" target="_blank" title="https://blog.csdn.net/yuntongliangda/article/details/147495222" ref="nofollow noopener noreferrer">7</a>]。</p>
<p>平台支撑层通过知识图谱与自适应算法实现精准教学干预。智慧中心教育平台整合2000万条学习行为数据，构建数学能力雷达图等可视化工具，结合交替自回归知识追踪（AAKT）技术，利用学生先前练习数据预测学习表现，精确识别思维断点[<a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.gdedu123.com%2Fgd%2F686482.html" target="_blank" title="http://www.gdedu123.com/gd/686482.html" ref="nofollow noopener noreferrer">1</a>][<a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Faudyxiao001%2Farticle%2Fdetails%2F147516954" target="_blank" title="https://blog.csdn.net/audyxiao001/article/details/147516954" ref="nofollow noopener noreferrer">32</a>]。"启慧"平台的AI学习伴侣"小慧"基于多模态预训练模型，融合教育知识图谱与持续学习机制，动态生成个性化学习路径图谱[<a href="https://link.juejin.cn?target=https%3A%2F%2Fweixin.rnsvip.com%2Findex.php%3Fa%3Dshow%26id%3D3006%26m%3DArticle" target="_blank" title="https://weixin.rnsvip.com/index.php?a=show&amp;id=3006&amp;m=Article" ref="nofollow noopener noreferrer">6</a>]。CZI知识图谱将课程标准与学习科学研究映射为机器可读格式，为教学法落地提供结构化支撑，而六维智能匹配系统（基础知识掌握度、解题速度等维度）使师资匹配准确率达82%[<a href="https://link.juejin.cn?target=https%3A%2F%2Fm.renrendoc.com%2Fpaper%2F481467283.html" target="_blank" title="https://m.renrendoc.com/paper/481467283.html" ref="nofollow noopener noreferrer">25</a>][<a href="https://link.juejin.cn?target=https%3A%2F%2Fchanzuckerberg.com%2Fblog%2Fasu-gsv-2025-ai-edtech%2F" target="_blank" title="https://chanzuckerberg.com/blog/asu-gsv-2025-ai-edtech/" ref="nofollow noopener noreferrer">33</a>]。</p>
<p>应用落地层呈现多模态交互与数据驱动决策的深度融合。沉浸式教学场景通过3D建模与VR技术显著降低认知负荷，如苏州大学360智慧教室中，医学院学生借助VR眼镜观摩手术直播并进行三维动态学习[<a href="https://link.juejin.cn?target=https%3A%2F%2Fhudong.moe.gov.cn%2Fjyb_xwfb%2Fs5147%2F202504%2Ft20250417_1187747.html" target="_blank" title="https://hudong.moe.gov.cn/jyb_xwfb/s5147/202504/t20250417_1187747.html" ref="nofollow noopener noreferrer">3</a>]。教育机器人模拟器RoblockLLy提升STEM兴趣，培养计算思维技能，而多模态生成管线实现从知识点抽取到个性化资源适配的全流程自动化[<a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fyuntongliangda%2Farticle%2Fdetails%2F147495222" target="_blank" title="https://blog.csdn.net/yuntongliangda/article/details/147495222" ref="nofollow noopener noreferrer">7</a>][<a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Faudyxiao001%2Farticle%2Fdetails%2F147516954" target="_blank" title="https://blog.csdn.net/audyxiao001/article/details/147516954" ref="nofollow noopener noreferrer">32</a>]。数据治理方面，宁夏教育大数据中心集约化建设2700万条有效数据，"观澜"全景数据驾驶舱整合全维度学习数据，支持资源调配与课程设置决策，国家开放大学则利用知识图谱绘制学习者诊断画像，构建虚拟教师教学场景[<a href="https://link.juejin.cn?target=https%3A%2F%2Fweixin.rnsvip.com%2Findex.php%3Fa%3Dshow%26id%3D3006%26m%3DArticle" target="_blank" title="https://weixin.rnsvip.com/index.php?a=show&amp;id=3006&amp;m=Article" ref="nofollow noopener noreferrer">6</a>][<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.moe.gov.cn%2Fjyb_xwfb%2Fs6192%2Fs222%2Fmoe_1762%2F202503%2Ft20250331_1185653.html" target="_blank" title="https://www.moe.gov.cn/jyb_xwfb/s6192/s222/moe_1762/202503/t20250331_1185653.html" ref="nofollow noopener noreferrer">2</a>][<a href="https://link.juejin.cn?target=http%3A%2F%2Fm2.people.cn%2Fnews%2Fdefault.html%3Fs%3DM18zXzIxMDYzMDY0XzQwNDJfMTcxNTA1MjQyOQ%3D%3D%26from%3Dsohu" target="_blank" title="http://m2.people.cn/news/default.html?s=M18zXzIxMDYzMDY0XzQwNDJfMTcxNTA1MjQyOQ==&amp;from=sohu" ref="nofollow noopener noreferrer">3</a>]。</p>
<p>教育智能体的核心突破在于技术原理与教学场景的深度耦合。超长上下文窗口支持多步骤数学题解析，语音识别与情感识别技术实现拟人化鼓励式交互，课堂数据实时采集分析系统（如希沃教学大模型）通过学情热力图辅助教师反思[<a href="https://link.juejin.cn?target=https%3A%2F%2Fweixin.rnsvip.com%2Findex.php%3Fa%3Dshow%26id%3D3006%26m%3DArticle" target="_blank" title="https://weixin.rnsvip.com/index.php?a=show&amp;id=3006&amp;m=Article" ref="nofollow noopener noreferrer">6</a>][<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.seewo.com%2Farticle%2Fdetail%2F2669" target="_blank" title="https://www.seewo.com/article/detail/2669" ref="nofollow noopener noreferrer">2</a>][<a href="https://link.juejin.cn?target=http%3A%2F%2Fm.toutiao.com%2Fgroup%2F7560220927951143467%2F%3Fupstream_biz%3Ddoubao" target="_blank" title="http://m.toutiao.com/group/7560220927951143467/?upstream_biz=doubao" ref="nofollow noopener noreferrer">3</a>]。这种技术赋能不仅体现在工具层面，更推动教育范式从标准化向个性化转变，如AI-Human互动自我调节学习模型所示，AI通过个性化路径规划与实时反馈提升学生自主学习能力，印证了技术与教育背景、教学法结合的必要性[<a href="https://link.juejin.cn?target=https%3A%2F%2Fchanzuckerberg.com%2Fblog%2Fasu-gsv-2025-ai-edtech%2F" target="_blank" title="https://chanzuckerberg.com/blog/asu-gsv-2025-ai-edtech/" ref="nofollow noopener noreferrer">33</a>][<a href="https://link.juejin.cn?target=https%3A%2F%2Fieta.zjnu.edu.cn%2F2025%2F0617%2Fc10681a522279%2Fpage.htm" target="_blank" title="https://ieta.zjnu.edu.cn/2025/0617/c10681a522279/page.htm" ref="nofollow noopener noreferrer">34</a>]。当前产业链已形成上游技术供给（AI算法、硬件设备）、中游平台服务（SaaS系统、内容开发）、下游应用场景（K12、高等教育等）的完整生态，为智能体教育应用的规模化落地奠定基础[<a href="https://link.juejin.cn?target=https%3A%2F%2Fm.renrendoc.com%2Fpaper%2F481267468.html" target="_blank" title="https://m.renrendoc.com/paper/481267468.html" ref="nofollow noopener noreferrer">35</a>]。</p>
<p><strong>技术架构核心特征</strong>：多模型协同（Whisper+GPT/BERT+EmotionNet）、轻量化部署（TinyBERT/MobileNetV3）、知识图谱驱动（CZI标准映射/六维能力模型）、多模态交互（VR手术模拟/情感识别），形成从数据采集到个性化干预的闭环体系，支持弱网环境与隐私保护要求下的规模化应用。</p>
<h2 data-id="heading-10">智能体教育应用的挑战与伦理风险</h2>
<p>智能体教育应用在快速发展的同时，面临着技术、伦理与系统层面的多重挑战。构建"技术-人文-系统"三维分析框架，可系统解构这些复合型风险，并为制定应对策略提供理论基础。</p>
<h3 data-id="heading-11">技术层面：实施成本与能力鸿沟的双重制约</h3>
<p>技术落地面临基础设施与人力资源的双重瓶颈。智能教学平台对网络条件要求苛刻，部分农村及偏远地区学校因带宽不足难以支撑常态化应用[<a href="https://link.juejin.cn?target=https%3A%2F%2Fm.book118.com%2Fhtml%2F2025%2F0817%2F5222214322012312.shtm" target="_blank" title="https://m.book118.com/html/2025/0817/5222214322012312.shtm" ref="nofollow noopener noreferrer">4</a>]。硬件投入外，持续维护成本构成长期负担，导致部分学校陷入"重采购、轻运维"的困境[<a href="https://link.juejin.cn?target=http%3A%2F%2Fm.toutiao.com%2Fgroup%2F7545373719712940570%2F%3Fupstream_biz%3Ddoubao" target="_blank" title="http://m.toutiao.com/group/7545373719712940570/?upstream_biz=doubao" ref="nofollow noopener noreferrer">2</a>]。教师数字素养缺口尤为突出，中小学教师普遍存在技术应用能力不足与教学整合障碍，尽管相关研究已构建包含情境创设、动态可视化、个性化辅导、互动增强四个模块的培训框架，但全国范围内教师AI工具伦理评估知识仍显匮乏[<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.gaejournal.org%2F" target="_blank" title="https://www.gaejournal.org/" ref="nofollow noopener noreferrer">36</a>][<a href="https://link.juejin.cn?target=https%3A%2F%2Feric.ed.gov%2F%3Fq%3DAi%2Bin%2Beducation%26ff1%3DsouEducation%2Band%2BInformation%2BTechnologies%26pg%3D5" target="_blank" title="https://eric.ed.gov/?q=Ai+in+education&amp;ff1=souEducation+and+Information+Technologies&amp;pg=5" ref="nofollow noopener noreferrer">37</a>]。</p>
<h3 data-id="heading-12">伦理层面：认知外包与价值离散的风险叠加</h3>
<p>生成式AI的滥用正在重塑教育生态的脆弱平衡。实证研究显示，过度依赖AI完成作业的学生独立解题能力下降17%，GPT Base等直接输出答案的模型加剧了"认知外包"现象，而GPT Tutor通过启发式引导设计可显著降低此类风险[<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.sohu.com%2Fa%2F858783318_120975090" target="_blank" title="https://www.sohu.com/a/858783318_120975090" ref="nofollow noopener noreferrer">38</a>]。语文等学科面临特殊挑战，AI难以准确评判情感体验与创造性思维等主观性内容，需建立"AI初评+教师复评"双轨机制保障教学质量[<a href="https://link.juejin.cn?target=https%3A%2F%2Fqzrb.gxqzxw.com%2Fpad%2Fcontent%2F202507%2F02%2Fcontent_53308.html" target="_blank" title="https://qzrb.gxqzxw.com/pad/content/202507/02/content_53308.html" ref="nofollow noopener noreferrer">28</a>]。更深层的风险在于教育主体权威消解，历史教学中AI文本生成机制可能与主流价值导向产生冲突，算法偏见或隐私泄露事件亦时有发生[<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.gaejournal.org%2F" target="_blank" title="https://www.gaejournal.org/" ref="nofollow noopener noreferrer">36</a>][<a href="https://link.juejin.cn?target=https%3A%2F%2Fsimfero.eu%2Fknowledge-base%2Fmonthly-research-roundup-ai-in-education-june-2025%2F" target="_blank" title="https://simfero.eu/knowledge-base/monthly-research-roundup-ai-in-education-june-2025/" ref="nofollow noopener noreferrer">39</a>]。</p>
<h3 data-id="heading-13">系统层面：数字鸿沟与治理滞后的结构性矛盾</h3>
<p>教育公平在智能时代呈现新形态。城乡生均教育经费差距达1.5倍，硬件接入"硬鸿沟"加速弥合的同时，数字素养、信息筛选能力等"软鸿沟"差异持续扩大[<a href="https://link.juejin.cn?target=https%3A%2F%2Fm.book118.com%2Fhtml%2F2025%2F0817%2F5222214322012312.shtm" target="_blank" title="https://m.book118.com/html/2025/0817/5222214322012312.shtm" ref="nofollow noopener noreferrer">4</a>][<a href="https://link.juejin.cn?target=https%3A%2F%2Fweixin.rnsvip.com%2Findex.php%3Fa%3Dshow%26id%3D3006%26m%3DArticle" target="_blank" title="https://weixin.rnsvip.com/index.php?a=show&amp;id=3006&amp;m=Article" ref="nofollow noopener noreferrer">6</a>]。宁夏通过《关于进一步提升乡村中小学数字化发展水平的指导意见》从"建、用、管"全流程缩小城乡差距，为全国提供了政策范本[<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.moe.gov.cn%2Fjyb_xwfb%2Fs6192%2Fs222%2Fmoe_1762%2F202503%2Ft20250331_1185653.html" target="_blank" title="https://www.moe.gov.cn/jyb_xwfb/s6192/s222/moe_1762/202503/t20250331_1185653.html" ref="nofollow noopener noreferrer">16</a>]。行业协同机制尚未成熟，上游技术商与下游教育机构需求错配，数据孤岛现象导致个性化服务能力不足，亟需建立跨主体的资源共享平台[<a href="https://link.juejin.cn?target=https%3A%2F%2Fm.renrendoc.com%2Fpaper%2F481267468.html" target="_blank" title="https://m.renrendoc.com/paper/481267468.html" ref="nofollow noopener noreferrer">35</a>]。</p>
<p><strong>风险警示</strong>：当前教育类App隐私合规检测通过率仅68%，人脸识别、情绪监控等技术在课堂管理中的滥用已引发隐私争议。建议建立独立数据伦理委员会，对智能教育产品实施全生命周期伦理评估[<a href="https://link.juejin.cn?target=http%3A%2F%2Fm.toutiao.com%2Fgroup%2F7545373719712940570%2F%3Fupstream_biz%3Ddoubao" target="_blank" title="http://m.toutiao.com/group/7545373719712940570/?upstream_biz=doubao" ref="nofollow noopener noreferrer">2</a>][<a href="https://link.juejin.cn?target=https%3A%2F%2Fm.book118.com%2Fhtml%2F2025%2F0817%2F5222214322012312.shtm" target="_blank" title="https://m.book118.com/html/2025/0817/5222214322012312.shtm" ref="nofollow noopener noreferrer">2</a>][<a href="https://link.juejin.cn?target=https%3A%2F%2Fweixin.rnsvip.com%2Findex.php%3Fa%3Dshow%26id%3D3006%26m%3DArticle" target="_blank" title="https://weixin.rnsvip.com/index.php?a=show&amp;id=3006&amp;m=Article" ref="nofollow noopener noreferrer">3</a>]。</p>
<p>平衡技术工具性与教育本质性成为核心命题。智能体应用必须坚持"辅助"定位，通过社交情感学习内容设计强化师生互动，在提升教学效率的同时守护教育的人文内核[<a href="https://link.juejin.cn?target=https%3A%2F%2Fweixin.rnsvip.com%2Findex.php%3Fa%3Dshow%26id%3D3006%26m%3DArticle" target="_blank" title="https://weixin.rnsvip.com/index.php?a=show&amp;id=3006&amp;m=Article" ref="nofollow noopener noreferrer">6</a>]。这要求教育工作者从知识传授者转型为AI协作导师，在掌握技术工具的同时保持对教育本质的深刻认知。</p>
<h3 data-id="heading-14">应对策略的三维协同路径</h3>
<p>技术层面需创新"最后一公里"解决方案，针对薄弱学校开发低带宽适配版本；伦理层面应建立算法偏见审查制度，优先采购GPT Tutor类引导式模型；系统层面可借鉴睿诺思"数字公民素养普及计划"，构建覆盖城乡的数字能力培养体系[<a href="https://link.juejin.cn?target=https%3A%2F%2Fweixin.rnsvip.com%2Findex.php%3Fa%3Dshow%26id%3D3006%26m%3DArticle" target="_blank" title="https://weixin.rnsvip.com/index.php?a=show&amp;id=3006&amp;m=Article" ref="nofollow noopener noreferrer">6</a>]。唯有技术创新、伦理规范与制度保障三管齐下，方能推动智能体教育应用健康可持续发展。</p>
<h2 data-id="heading-15">未来趋势与政策建议</h2>
<p>以“政策导向-技术演进-教育生态”为逻辑主线，结合教育部等九部门《关于加快推进教育数字化的意见》中“人工智能教育大模型与教学深度融合”的核心要求，智能体在教育领域的应用将呈现三大趋势演进。情感计算技术的突破将显著提升AI对学生认知状态的识别精度，例如在语文阅读教学中实现情感反馈的动态调整，通过多模态数据融合捕捉学习者的困惑点与情感波动[<a href="https://link.juejin.cn?target=http%3A%2F%2Fm.toutiao.com%2Fgroup%2F7527659819625382450%2F%3Fupstream_biz%3Ddoubao" target="_blank" title="http://m.toutiao.com/group/7527659819625382450/?upstream_biz=doubao" ref="nofollow noopener noreferrer">27</a>]。增强现实（AR）与虚拟现实（VR）技术将重构学科场景体验，如将《山居秋暝》等古诗文意境转化为沉浸式三维空间，使抽象的文学意象与数学几何概念可视化呈现[<a href="https://link.juejin.cn?target=https%3A%2F%2Fm.book118.com%2Fhtml%2F2025%2F0817%2F5222214322012312.shtm" target="_blank" title="https://m.book118.com/html/2025/0817/5222214322012312.shtm" ref="nofollow noopener noreferrer">4</a>][<a href="https://link.juejin.cn?target=http%3A%2F%2Fm.toutiao.com%2Fgroup%2F7527659819625382450%2F%3Fupstream_biz%3Ddoubao" target="_blank" title="http://m.toutiao.com/group/7527659819625382450/?upstream_biz=doubao" ref="nofollow noopener noreferrer">27</a>]。区块链技术的应用则为学习成果认证提供了可信基础设施，可构建不可篡改的编程能力成长轨迹等个性化档案，实现跨学段学习数据的安全追溯[<a href="https://link.juejin.cn?target=https%3A%2F%2Fm.book118.com%2Fhtml%2F2025%2F0817%2F5222214322012312.shtm" target="_blank" title="https://m.book118.com/html/2025/0817/5222214322012312.shtm" ref="nofollow noopener noreferrer">4</a>][<a href="https://link.juejin.cn?target=http%3A%2F%2Fm.toutiao.com%2Fgroup%2F7527659819625382450%2F%3Fupstream_biz%3Ddoubao" target="_blank" title="http://m.toutiao.com/group/7527659819625382450/?upstream_biz=doubao" ref="nofollow noopener noreferrer">27</a>]。
技术演进的深层驱动源于教育需求的变革。未来三到五年，“代理式AI”（Agentic AI）将推动超个性化学习落地，通过动态知识图谱构建（预计2026年实现千万级知识点关联）和无代码化平台（如Agentive AIQ）降低技术门槛，实现教育服务的规模化与精准化[<a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fweixin_53105865%2Farticle%2Fdetails%2F149060705" target="_blank" title="https://blog.csdn.net/weixin_53105865/article/details/149060705" ref="nofollow noopener noreferrer">10</a>][<a href="https://link.juejin.cn?target=https%3A%2F%2Fagentiveaiq.com%2Fblog%2Fhow-big-is-the-edtech-ai-market-in-2025" target="_blank" title="https://agentiveaiq.com/blog/how-big-is-the-edtech-ai-market-in-2025" ref="nofollow noopener noreferrer">11</a>]。教育元宇宙的加速建设将进一步拓展学习边界，计划2028年前建成300个国家级虚拟教研室，结合具备情绪识别能力的教育机器人（2027年渗透率或达65%），构建虚实融合的新型教育生态[<a href="https://link.juejin.cn?target=https%3A%2F%2Fm.book118.com%2Fhtml%2F2025%2F0817%2F5222214322012312.shtm" target="_blank" title="https://m.book118.com/html/2025/0817/5222214322012312.shtm" ref="nofollow noopener noreferrer">4</a>]。</p>
<p>政策建议需聚焦“技术-人才-生态”三维协同，构建与智能教育发展相适应的支撑体系。在技术层面，加快教育大模型国产化进程，推广“智海—三乐”模型等国产解决方案，推动高校-企业联合开发学科专用模型，如编程教育领域的本土化AI助教与MechDog机器人硬件结合方案[<a href="https://link.juejin.cn?target=https%3A%2F%2Fhudong.moe.gov.cn%2Fjyb_xwfb%2Fs5147%2F202504%2Ft20250417_1187747.html" target="_blank" title="https://hudong.moe.gov.cn/jyb_xwfb/s5147/202504/t20250417_1187747.html" ref="nofollow noopener noreferrer">3</a>][<a href="https://link.juejin.cn?target=https%3A%2F%2Fm.book118.com%2Fhtml%2F2025%2F0817%2F5222214322012312.shtm" target="_blank" title="https://m.book118.com/html/2025/0817/5222214322012312.shtm" ref="nofollow noopener noreferrer">2</a>][<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.jse.edu.cn%2Fstudio%2Findex.php%3Fr%3Dstudio%2Fpost%2Fview%26sid%3D204%26id%3D85705" target="_blank" title="https://www.jse.edu.cn/studio/index.php?r=studio/post/view&amp;sid=204&amp;id=85705" ref="nofollow noopener noreferrer">3</a>]。人才培养方面，需建立教师AI素养“测-评-训”三位一体培育机制，借鉴宁夏“三年一周期”计划经验，开展“智能备课系统实操工作坊”等场景化培训，将教育者角色转变为“AI协调者”[<a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fweixin_53105865%2Farticle%2Fdetails%2F149060705" target="_blank" title="https://blog.csdn.net/weixin_53105865/article/details/149060705" ref="nofollow noopener noreferrer">10</a>][<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.moe.gov.cn%2Fjyb_xwfb%2Fs6192%2Fs222%2Fmoe_1762%2F202503%2Ft20250331_1185653.html" target="_blank" title="https://www.moe.gov.cn/jyb_xwfb/s6192/s222/moe_1762/202503/t20250331_1185653.html" ref="nofollow noopener noreferrer">16</a>]。生态构建上，应完善“教育+元宇宙”虚拟实验室建设标准，落实《中小学人工智能通识教育指南（2025年版）》的分层设计要求，对经济薄弱地区提供专项经费支持，形成政府引导、学校主导、企业参与的协同治理格局[<a href="https://link.juejin.cn?target=http%3A%2F%2Fm.toutiao.com%2Fgroup%2F7545373719712940570%2F%3Fupstream_biz%3Ddoubao" target="_blank" title="http://m.toutiao.com/group/7545373719712940570/?upstream_biz=doubao" ref="nofollow noopener noreferrer">2</a>][<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.gov.cn%2Flianbo%2Fbumen%2F202505%2Fcontent_7023810.htm" target="_blank" title="https://www.gov.cn/lianbo/bumen/202505/content_7023810.htm" ref="nofollow noopener noreferrer">40</a>]。
<strong>政策落地关键路径</strong></p>
<ul>
<li>技术协同：推动AI算法与教育场景深度融合，突破数据安全与隐私保护技术[<a href="https://link.juejin.cn?target=https%3A%2F%2Fm.renrendoc.com%2Fpaper%2F481267468.html" target="_blank" title="https://m.renrendoc.com/paper/481267468.html" ref="nofollow noopener noreferrer">35</a>]- 数据协同：构建省市县校四级贯通的智慧教研体系，实现教学质量动态分析[<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.moe.gov.cn%2Fjyb_xwfb%2Fs6192%2Fs222%2Fmoe_1762%2F202503%2Ft20250331_1185653.html" target="_blank" title="https://www.moe.gov.cn/jyb_xwfb/s6192/s222/moe_1762/202503/t20250331_1185653.html" ref="nofollow noopener noreferrer">16</a>]- 主体协同：建立科学的AI教学审核机制，企业需摒弃过度营销，回归教育本质[<a href="https://link.juejin.cn?target=http%3A%2F%2Fm.toutiao.com%2Fgroup%2F7545373719712940570%2F%3Fupstream_biz%3Ddoubao" target="_blank" title="http://m.toutiao.com/group/7545373719712940570/?upstream_biz=doubao" ref="nofollow noopener noreferrer">2</a>]</li>
</ul>
<p>需特别注意的是，智能教育发展必须坚守教育公平底线。政策实施中应细化配套措施，禁止小学阶段学生独自使用开放式AI生成功能，初中阶段限定逻辑分析场景，高中阶段侧重探究性学习引导，通过分层管控确保技术应用的安全性与适切性[<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.gov.cn%2Flianbo%2Fbumen%2F202505%2Fcontent_7023810.htm" target="_blank" title="https://www.gov.cn/lianbo/bumen/202505/content_7023810.htm" ref="nofollow noopener noreferrer">40</a>][<a href="https://link.juejin.cn?target=https%3A%2F%2Fm.baike.com%2Fwiki%2F%25E4%25B8%25AD%25E5%25B0%258F%25E5%25AD%25A6%25E7%2594%259F%25E6%2588%2590%25E5%25BC%258F%25E4%25BA%25BA%25E5%25B7%25A5%25E6%2599%25BA%25E8%2583%25BD%25E4%25BD%25BF%25E7%2594%25A8%25E6%258C%2587%25E5%258D%2597%25EF%25BC%25882025%25E5%25B9%25B4%25E7%2589%2588%25EF%25BC%2589%2F7503740708949246003" target="_blank" title="https://m.baike.com/wiki/%E4%B8%AD%E5%B0%8F%E5%AD%A6%E7%94%9F%E6%88%90%E5%BC%8F%E4%BA%BA%E5%B7%A5%E6%99%BA%E8%83%BD%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97%EF%BC%882025%E5%B9%B4%E7%89%88%EF%BC%89/7503740708949246003" ref="nofollow noopener noreferrer">41</a>]。教育部将打造国家智慧教育平台2.0智能版，接入国产通用大模型，完善“AI试验场”建设，为趋势落地提供国家级基础设施支撑[<a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.moe.gov.cn%2Ffbh%2Flive%2F2025%2F56808%2Fmtbd%2F202504%2Ft20250417_1187722.html" target="_blank" title="http://www.moe.gov.cn/fbh/live/2025/56808/mtbd/202504/t20250417_1187722.html" ref="nofollow noopener noreferrer">42</a>]。</p>
<p>（政策依据：教育部等九部门《关于加快推进教育数字化的意见》<a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.moe.gov.cn%2Fsrcsite%2FA16%2Fs3342%2F202501%2Ft20250115_1081232.html%25EF%25BC%2589" target="_blank" title="http://www.moe.gov.cn/srcsite/A16/s3342/202501/t20250115_1081232.html%EF%BC%89" ref="nofollow noopener noreferrer">www.moe.gov.cn/srcsite/A16…</a></p>
<h2 data-id="heading-16">智能体颠覆教育的机遇与平衡之道</h2>
<p>智能体对教育的“颠覆”具有双重内涵：既是教学模式从“一刀切”到个性化的革新，如自适应AI tutors通过实时调整课程难度与节奏，使欧洲五国中学生课堂参与度提升67%；也是优质资源普惠化的推进，国家智慧教育平台通过慕课西部行计划已服务西部学生5.9亿人次，海南乡村学校“同步课堂”保障25万学生开齐课程。这种变革重塑了教育生态——云南山区小学通过“启慧”平台实现统考平均分提升30%，上海AI数字人系统获97%学生认可为课堂有效延伸，印证了技术作为“教学增强器”的价值。</p>
<p>但技术应用需坚守“工具服务于育人”底线。AI永远不能替代教师核心角色，正如语文教学中“AI初评+教师复评”机制对情感表达的把控，或数学教学中动态可视化技术需配合教师对抽象思维的引导。重庆博雅小学案例显示，智能反馈系统助力教师获市区竞赛一等奖，学生学业指标位列区域前列，证明技术赋能需以教师主导为前提。</p>
<p><strong>平衡路径三原则</strong></p>
<ul>
<li><strong>定位边界</strong>：AI承担机械性任务（如英语发音评分、数学题自动批改），教师聚焦育人本质（情感培养、价值观塑造）- <strong>协同机制</strong>：建立“政府规范+学校实践+企业研发”协同体系，如宁夏全域应用国家智慧教育平台的模式- <strong>人文锚点</strong>：通过“技术赋能+人文引领”融合，实现《中国教育现代化2035》中因材施教的规模化愿景</li>
</ul>
<p>未来教育形态将是人类智慧与AI优势的深度融合。当教师从知识传授者转型为“成长教练”，学生通过个性化路径获得学习掌控感，课堂形态向翻转式、项目式多样化发展，智能体才能真正推动教育公平与质量的双重提升，最终实现“以技术革新教育，以人文守护初心”的可持续发展。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[草梅 Auth 1.11.0 发布与 GitHub 依赖安全更新 | 2025 年第 45 周草梅周报]]></title>    <link>https://juejin.cn/post/7570243451724939291</link>    <guid>https://juejin.cn/post/7570243451724939291</guid>    <pubDate>2025-11-09T15:44:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7570243451724939291" data-draft-id="7570243451724922907" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="草梅 Auth 1.11.0 发布与 GitHub 依赖安全更新 | 2025 年第 45 周草梅周报"/> <meta itemprop="keywords" content="GitHub,开源,AI编程"/> <meta itemprop="datePublished" content="2025-11-09T15:44:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="草梅友仁"/> <meta itemprop="url" content="https://juejin.cn/user/3043088413495815"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            草梅 Auth 1.11.0 发布与 GitHub 依赖安全更新 | 2025 年第 45 周草梅周报
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3043088413495815/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    草梅友仁
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-09T15:44:58.000Z" title="Sun Nov 09 2025 15:44:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>本文在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmyr.ltd" target="_blank" title="https://blog.cmyr.ltd" ref="nofollow noopener noreferrer">草梅友仁的博客</a> 发布和更新，并在多个平台同步发布。如有更新，以博客上的版本为准。您也可以通过文末的 <code>原文链接</code> 查看最新版本。</p>
</blockquote>
<h2 data-id="heading-0">前言</h2>
<p>欢迎来到草梅周报！这是一个由草梅友仁基于 AI 整理的周报，旨在为您提供最新的博客更新、GitHub 动态、个人动态和其他周刊文章推荐等内容。</p>
<hr/>
<p>本周依旧在开发 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FCaoMeiYouRen%2Fcaomei-auth" target="_blank" title="https://github.com/CaoMeiYouRen/caomei-auth" ref="nofollow noopener noreferrer">草梅 Auth</a> 中。</p>
<blockquote>
<p>你也可以直接访问官网地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fauth.cmyr.dev%2F" target="_blank" title="https://auth.cmyr.dev/" ref="nofollow noopener noreferrer">auth.cmyr.dev/</a>
Demo 站：<a href="https://link.juejin.cn?target=https%3A%2F%2Fauth-demo.cmyr.dev%2F" target="_blank" title="https://auth-demo.cmyr.dev/" ref="nofollow noopener noreferrer">auth-demo.cmyr.dev/</a>
文档地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fauth-docs.cmyr.dev%2F" target="_blank" title="https://auth-docs.cmyr.dev/" ref="nofollow noopener noreferrer">auth-docs.cmyr.dev/</a></p>
</blockquote>
<p>本周 草梅 Auth 发布了 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FCaoMeiYouRen%2Fcaomei-auth%2Freleases%2Ftag%2Fv1.11.0" target="_blank" title="https://github.com/CaoMeiYouRen/caomei-auth/releases/tag/v1.11.0" ref="nofollow noopener noreferrer">1.11.0</a> 版本。</p>
<p><img src="https://oss.cmyr.dev/images/20251109225945031.png" alt="image-20251109225725739" loading="lazy"/></p>
<p>本周的主要改动是添加了 Facebook 登录支持，增加了暗色模式的切换按钮。</p>
<p>除此之外也添加了一部分测试用例，后续还会继续补充。</p>
<p>如果想了解如何部署和使用项目，可以参考文档的内容，也欢迎补充文档缺失的内容。</p>
<p>如果你对草梅 Auth 感兴趣，欢迎参与开发和测试。</p>
<hr/>
<p><img src="https://oss.cmyr.dev/images/20251109230723838.png" alt="image-20251109230723757" loading="lazy"/></p>
<p>本周处理了一些项目中存在的依赖安全漏洞，是由 Dependabot 提醒的。</p>
<p><img src="https://oss.cmyr.dev/images/20251109231011986.png" alt="image-20251109231011940" loading="lazy"/></p>
<p>虽然借助 Dependabot ，也能自动更新依赖，不过有一些间接依赖就没那么好处理，往往需要添加覆盖原有版本的依赖选项的配置，比如 pnpm 中的 <code>overrides</code>字段，就是用来指定覆盖版本的。</p>
<p>不过我也得吐槽下，GitHub 默认的这个 <code>Dependabot alerts</code> 面板实际上没那么好查看具体的漏洞信息，还得每条点开，于是我就干脆写了个 n8n 工作流，生成一份 markdown 文件，用于集中报告 Dependabot alerts 详情，为修复做指导。</p>
<p><img src="https://oss.cmyr.dev/images/20251109231323436.png" alt="image-20251109231216615" loading="lazy"/></p>
<p>当然，如果进一步优化的话，应该扔给 AI 来自动修复，这样会更节约时间一点。</p>
<h2 data-id="heading-1">GitHub Release</h2>
<h3 data-id="heading-2">rss-impact-server</h3>
<h4 data-id="heading-3"><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FCaoMeiYouRen%2Frss-impact-server%2Freleases%2Ftag%2Fv1.17.1" target="_blank" title="https://github.com/CaoMeiYouRen/rss-impact-server/releases/tag/v1.17.1" ref="nofollow noopener noreferrer">v1.17.1</a> - 2025-11-08 20:12:01</h4>
<p>摘要:</p>
<p>主要修复内容：</p>
<ul>
<li>通知功能：新增基于 isRemotePush 参数的远程推送字段条件验证，确保远程推送操作的正确性</li>
</ul>
<p>本次更新为小版本修复，主要针对通知功能中的远程推送验证逻辑进行了完善。通过添加 isRemotePush 字段的条件验证，提升了系统在远程推送场景下的稳定性和可靠性。</p>
<h3 data-id="heading-4">push-all-in-one</h3>
<h4 data-id="heading-5"><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FCaoMeiYouRen%2Fpush-all-in-one%2Freleases%2Ftag%2Fv4.5.0" target="_blank" title="https://github.com/CaoMeiYouRen/push-all-in-one/releases/tag/v4.5.0" ref="nofollow noopener noreferrer">v4.5.0</a> - 2025-11-06 23:42:39</h4>
<p>摘要:</p>
<p>新增功能：</p>
<ul>
<li>添加了 push-all-in-cloud 服务推送功能</li>
</ul>
<h3 data-id="heading-6">caomei-auth</h3>
<h4 data-id="heading-7"><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FCaoMeiYouRen%2Fcaomei-auth%2Freleases%2Ftag%2Fv1.11.0" target="_blank" title="https://github.com/CaoMeiYouRen/caomei-auth/releases/tag/v1.11.0" ref="nofollow noopener noreferrer">v1.11.0</a> - 2025-11-08 20:08:06</h4>
<p>摘要:
版本 1.11.0 更新摘要 (2025-11-08)</p>
<p>新功能：</p>
<ol>
<li>认证模块新增 Facebook 登录支持及相关配置</li>
<li>主题模块增加系统偏好设置的暗色模式同步功能</li>
<li>主题模块新增暗色模式支持及主题切换功能</li>
</ol>
<p>Bug 修复：</p>
<ol>
<li>样式模块优化暗色模式样式，统一媒体查询格式</li>
</ol>
<h3 data-id="heading-8">picgo-plugin-optimization</h3>
<h4 data-id="heading-9"><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FCaoMeiYouRen%2Fpicgo-plugin-optimization%2Freleases%2Ftag%2Fv1.0.1" target="_blank" title="https://github.com/CaoMeiYouRen/picgo-plugin-optimization/releases/tag/v1.0.1" ref="nofollow noopener noreferrer">v1.0.1</a> - 2025-11-07 20:23:09</h4>
<p>摘要:
版本 1.0.1 (2025-11-07) 摘要：</p>
<p>主要更新内容：</p>
<p>Bug 修复：</p>
<ul>
<li>优化了 PNG 图片压缩级别的计算逻辑，修复了相关 bug</li>
</ul>
<p>本次更新主要针对 PNG 图片处理进行了优化，改进了压缩级别的计算方式，提升了插件处理 PNG 图片的性能和效果。</p>
<h2 data-id="heading-10">最新 GitHub 加星仓库</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FDrewThomasson%2Febook2audiobook" target="_blank" title="https://github.com/DrewThomasson/ebook2audiobook" ref="nofollow noopener noreferrer">CaoMeiYouRen starred ebook2audiobook</a> - 2025-11-07 15:35:12
该文本介绍了一个基于 Python 的音频书籍生成工具，具有语音克隆功能并支持 1107 多种语言。项目在 GitHub 上获得了 15017 个星标，表明其受欢迎程度。核心功能包括将电子书转换为有声读物和高质量的语音克隆技术。</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2F666ghj%2FBettaFish" target="_blank" title="https://github.com/666ghj/BettaFish" ref="nofollow noopener noreferrer">CaoMeiYouRen starred BettaFish</a> - 2025-11-05 01:08:31
微舆是一款基于 Python 开发的多 Agent 舆情分析工具，旨在提供客观全面的舆情分析服务。该工具完全从零开发，不依赖任何现有框架，具备打破信息壁垒、还原真实舆情、预测发展趋势等功能。目前该项目已在 GitHub 上获得 23698 颗星标，显示出较高的社区关注度。</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FJStone2934%2FLiveGalGame" target="_blank" title="https://github.com/JStone2934/LiveGalGame" ref="nofollow noopener noreferrer">CaoMeiYouRen starred LiveGalGame</a> - 2025-11-03 18:04:26
一款基于 Kotlin 开发的创新应用，能够为与美少女的对话添加类似 GalGame 的交互体验。该应用提供选项选择和字幕显示功能，模拟视觉小说游戏中的对话系统。项目在 GitHub 上获得 1592 个星标，显示其受欢迎程度。开发者选择 Kotlin 作为主要编程语言，适合 Android 平台开发。应用旨在增强聊天互动性，为用户提供游戏化的交流体验。</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fzymk9%2Fyolov5_anime" target="_blank" title="https://github.com/zymk9/yolov5_anime" ref="nofollow noopener noreferrer">CaoMeiYouRen starred yolov5_anime</a> - 2025-11-03 14:17:34
基于 YOLOv5 的动漫人脸检测工具，使用 Python 开发，获得 105 星标。</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2F1adrianb%2Fface-alignment" target="_blank" title="https://github.com/1adrianb/face-alignment" ref="nofollow noopener noreferrer">CaoMeiYouRen starred face-alignment</a> - 2025-11-03 14:17:33
基于 PyTorch 开发的 2D 和 3D 面部对齐库，主要使用 Python 语言编写，已获得 7415 个星标。</li>
</ul>
<h2 data-id="heading-11">其他博客或周刊推荐</h2>
<h3 data-id="heading-12">阮一峰的网络日志</h3>
<ul>
<li><a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.ruanyifeng.com%2Fblog%2F2025%2F11%2Fweekly-issue-372.html" target="_blank" title="http://www.ruanyifeng.com/blog/2025/11/weekly-issue-372.html" ref="nofollow noopener noreferrer">科技爱好者周刊（第 372 期）：软件界面如何设计</a> - 2025-11-07 08:14:38</li>
<li><a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.ruanyifeng.com%2Fblog%2F2025%2F11%2Fminimax-m2.html" target="_blank" title="http://www.ruanyifeng.com/blog/2025/11/minimax-m2.html" ref="nofollow noopener noreferrer">大模型比拼：MiniMax M2 vs GLM 4.6 vs Claude Sonnet 4.5</a> - 2025-11-04 08:21:31</li>
</ul>
<h3 data-id="heading-13">潮流周刊</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fweekly.tw93.fun%2Fposts%2F244%2F" target="_blank" title="https://weekly.tw93.fun/posts/244/" ref="nofollow noopener noreferrer">第 244 期 - 飞机飞过</a> - 2025-11-10 08:00:00</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fweekly.tw93.fun%2Fposts%2F243%2F" target="_blank" title="https://weekly.tw93.fun/posts/243/" ref="nofollow noopener noreferrer">第 243 期 - 森泊不错</a> - 2025-11-03 08:00:00</li>
</ul>
<h3 data-id="heading-14">二丫讲梵的学习周刊</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwiki.eryajf.net%2Fpages%2Fff912f%2F" target="_blank" title="https://wiki.eryajf.net/pages/ff912f/" ref="nofollow noopener noreferrer">学习周刊-总第 236 期-2025 年第 45 周</a> - 2025-11-06 20:41:08</li>
</ul>
<h2 data-id="heading-15">总结</h2>
<p>本周的更新和动态如上所示。感谢您的阅读！
您可以通过以下方式订阅草梅周报的更新：</p>
<ul>
<li><strong>博客</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmyr.ltd" target="_blank" title="https://blog.cmyr.ltd" ref="nofollow noopener noreferrer">草梅友仁的博客</a></li>
<li><strong>RSS</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmyr.ltd%2Fweekly.xml" target="_blank" title="https://blog.cmyr.ltd/weekly.xml" ref="nofollow noopener noreferrer">草梅周报</a></li>
<li><strong>公众号</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Foss.cmyr.dev%2Fimages%2F20241025184516839-21n2ctv.png" target="_blank" title="https://oss.cmyr.dev/images/20241025184516839-21n2ctv.png" ref="nofollow noopener noreferrer">草梅友仁的后花园</a></li>
<li><strong>邮箱订阅</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Flistmonk.cmyr.dev%2Fsubscription%2Fform" target="_blank" title="https://listmonk.cmyr.dev/subscription/form" ref="nofollow noopener noreferrer">草梅友仁的博客订阅</a></li>
</ul>
<h2 data-id="heading-16">往期回顾</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmyr.ltd%2Farchives%2F2025-44-caomei-weekly-rss-impact-1-17-0-docker-migration.html" target="_blank" title="https://blog.cmyr.ltd/archives/2025-44-caomei-weekly-rss-impact-1-17-0-docker-migration.html" ref="nofollow noopener noreferrer">RSS Impact 1.17.0 发布与 Docker 服务器迁移经验 | 2025 年第 44 周草梅周报</a> - 2025-11-02 19:03:26</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmyr.ltd%2Farchives%2F2025-43-caomei-weekly-npm-security-update-and-thousand-stars-sandbox.html" target="_blank" title="https://blog.cmyr.ltd/archives/2025-43-caomei-weekly-npm-security-update-and-thousand-stars-sandbox.html" ref="nofollow noopener noreferrer">Npm 安全更新与千星沙箱 | 2025 年第 43 周草梅周报</a> - 2025-10-26 21:10:36</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmyr.ltd%2Farchives%2F2025-42-caomei-weekly-caomei-auth-1-10-1-browser-auto-tool.html" target="_blank" title="https://blog.cmyr.ltd/archives/2025-42-caomei-weekly-caomei-auth-1-10-1-browser-auto-tool.html" ref="nofollow noopener noreferrer">草梅 Auth 1.10.1 发布与浏览器自动化工具 | 2025 年第 42 周草梅周报</a> - 2025-10-19 22:13:55</li>
</ul>
<p>本文作者：草梅友仁<br/>本文地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmyr.ltd%2Farchives%2F2025-45-caomei-weekly-caomei-auth-1-11-0-github-dependabot.html" target="_blank" title="https://blog.cmyr.ltd/archives/2025-45-caomei-weekly-caomei-auth-1-11-0-github-dependabot.html" ref="nofollow noopener noreferrer">blog.cmyr.ltd/archives/20…</a><br/>版权声明：本文采用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fcreativecommons.org%2Flicenses%2Fby-nc-sa%2F4.0%2Fdeed.zh-hans" target="_blank" title="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh-hans" ref="nofollow noopener noreferrer">CC BY-NC-SA 4.0 协议</a> 进行分发，转载请注明出处！<br/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[删一个却少俩：Antd Tag 多节点同时消失的原因]]></title>    <link>https://juejin.cn/post/7570268773333073947</link>    <guid>https://juejin.cn/post/7570268773333073947</guid>    <pubDate>2025-11-09T15:48:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7570268773333073947" data-draft-id="7569976345931022387" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="删一个却少俩：Antd Tag 多节点同时消失的原因"/> <meta itemprop="keywords" content="前端,JavaScript,面试"/> <meta itemprop="datePublished" content="2025-11-09T15:48:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="顺凡"/> <meta itemprop="url" content="https://juejin.cn/user/2788017221153015"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            删一个却少俩：Antd Tag 多节点同时消失的原因
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2788017221153015/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    顺凡
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-09T15:48:05.000Z" title="Sun Nov 09 2025 15:48:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">删一个却少俩：Antd Tag 多节点同时消失的原因</h2>
<h3 data-id="heading-1">需求</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6998ad4d6b1f4301a10a1ef8c1705998~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aG65Yeh:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763308084&amp;x-signature=emQOPAkT5osXyRiW0qtMQWRDyb4%3D" alt="image.png" loading="lazy"/></p>
<p>一个表单的小需求，能填写多个福利，最多十个，福利名称允许重复，和<a href="https://link.juejin.cn?target=https%3A%2F%2Fant.design%2Fcomponents%2Ftag-cn%23tag-demo-control" target="_blank" title="https://ant.design/components/tag-cn#tag-demo-control" ref="nofollow noopener noreferrer">官方的动态添加和删除示例</a>交互一模一样，只是官方示例不支持 tag 内容重复，使用的 tag 内容作为 key</p>
<p>我复制丢给 AI，下掉去重，限制个数，好！满足需求了，key 值怎么办不能用重复的，拼个索引吧，最后主要代码如下，</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9833951839b84b30be341ee723feb636~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aG65Yeh:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763308084&amp;x-signature=5JigkuOQucTPcuKvuscwuW4hw2o%3D" alt="image.png" loading="lazy"/></p>
<p>反问一下：你觉得这会有什么问题，能达到删一个少俩的效果吗🤔？？？</p>
<h3 data-id="heading-2">问题</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/131fd1a6ec6f4b618a4e420ebbd753f9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aG65Yeh:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763308084&amp;x-signature=K%2B2UqHwHygeb9LyIxNDrtFRGwLQ%3D" alt="image.png" loading="lazy"/></p>
<p>大家应该都知道用 index 作为 key，会有一些问题，对于我这个需求的影响是，点击第一个福利删除操作，实际移除的是最后一个福利的节点，我觉得在这个需求是可以接受的，在没有动画前提下也体感不到，所以我并没有改这个代码。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6d60254120f4454b937cf40f4bb563d8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aG65Yeh:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763308084&amp;x-signature=hu8JXnKGRMZbVn%2BVeAYLIzFplAA%3D" alt="image.png" loading="lazy"/></p>
<p>但是实际测试的效果的是，<strong>最后一个福利的节点没了，第一个福利节点也没了</strong>，我！！！</p>
<p>这啥情况，这不对呀，根据 <a href="https://juejin.cn/post/7118580620195790855" target="_blank" title="https://juejin.cn/post/7118580620195790855">React Diff 算法的原理</a>吧啦吧啦...他不应该是这样然后...他咋能...</p>
<h3 data-id="heading-3">原因</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ffa835de756e41da95b1161fbdb2a7d6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aG65Yeh:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763308084&amp;x-signature=QVsyHNzG8zGC%2FnH5CGGPLbN9fiE%3D" alt="image.png" loading="lazy"/></p>
<p>开始 debug，打开控制台 command + shif + p，搜索并进入 react-dom.development.js 文件，搜索 reconcileChildrenArray 方法，打上断点</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0a22f03b2a294467a543c381fd6c6bae~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aG65Yeh:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763308084&amp;x-signature=fMLv1iBKFcusiY0JUq7AmwuquI4%3D" alt="image.png" loading="lazy"/></p>
<p>React Diff 的处理也没问题呀，被标记删除的是最后一个节点，第一个节点也被正确复用了，什么情况？难道后面的代码出了问题，我就讲断点就放到了 commitRoot 方法，先看了 root.finishedWork 发现也是正确的，后面继续执行了几下，想找出问题出在哪...就突然觉的这个福利节点是不是真没被删除，但是被隐藏掉了，我就切换到了元素控制台，还真是我去！！！这为啥多了个 ant-tag-hidden 的类</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3e0192406f8f4ae0afcf9ca4466e2afd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aG65Yeh:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763308084&amp;x-signature=ncezqd0OUq19R7LiiYPT6olVdRs%3D" alt="image.png" loading="lazy"/></p>
<p>看了下 Antd Tag 代码，还真有这个设计，给被移除项加 ant-tag-hidden，加上索引 key 复用导致出现“多节点同时消失”</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8242539c45204d48923b6dd973956038~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aG65Yeh:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763308084&amp;x-signature=4jXPc6NSdSIS%2BDAsDIcNZaGjyNI%3D" alt="image.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[云原生技术栈中的核心组件（如Kubernetes、Docker）具体是如何协同工作的？]]></title>    <link>https://juejin.cn/post/7570162686579785770</link>    <guid>https://juejin.cn/post/7570162686579785770</guid>    <pubDate>2025-11-09T14:08:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7570162686579785770" data-draft-id="7569910533509529619" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="云原生技术栈中的核心组件（如Kubernetes、Docker）具体是如何协同工作的？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-09T14:08:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="IT橘子皮"/> <meta itemprop="url" content="https://juejin.cn/user/3148645291002232"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            云原生技术栈中的核心组件（如Kubernetes、Docker）具体是如何协同工作的？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3148645291002232/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    IT橘子皮
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-09T14:08:20.000Z" title="Sun Nov 09 2025 14:08:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>云原生技术栈中的各个核心组件就像一个专业的团队，各司其职又紧密协同，共同支撑起庞大应用的稳定运行。要理解它们如何协同工作，关键在于把握两个核心层次：<strong>容器层（Docker）</strong> 和<strong>编排调度层（Kubernetes及其生态）</strong> 。</p>
<p>为了让你快速建立整体印象，下表清晰地展示了各核心组件在云原生体系中的角色与协同关系。</p>



































<table><thead><tr><th>组件类别</th><th>核心组件示例</th><th>核心职责</th><th>类比说明</th></tr></thead><tbody><tr><td><strong>容器运行时</strong></td><td><strong>Docker</strong></td><td>应用打包、隔离、运行，提供最小可执行单元</td><td><strong>集装箱</strong>：标准化封装应用及其所有依赖</td></tr><tr><td><strong>编排调度平台</strong></td><td><strong>Kubernetes</strong></td><td>集群管理、调度、服务发现、弹性伸缩、自愈</td><td><strong>超级调度中心</strong>：管理所有集装箱的运输、存放和维护</td></tr><tr><td><strong>网络治理层</strong></td><td><strong>Istio</strong>(服务网格)</td><td>服务间通信的精细化管理（流量路由、安全、可观测性）</td><td><strong>空中交通管制系统</strong>：精密指挥每架飞机的航线与通信</td></tr><tr><td><strong>运维支撑体系</strong></td><td><strong>Prometheus, Argo CD</strong></td><td>监控、持续交付（CI/CD）、自动化运维</td><td><strong>后勤保障系统</strong>：负责监控设备状态、自动化补给与调度</td></tr></tbody></table>
<h3 data-id="heading-0">🔄 核心协同工作流程</h3>
<p>了解了各自角色后，我们来看看它们是如何具体配合来完成一次应用部署与管理的。这个流程可以比作一个高度自动化的智能物流系统。</p>
<ol>
<li>
<p><strong>应用打包与注册（制造与登记集装箱）</strong></p>
<ul>
<li>你编写好应用代码后，使用 <strong>Dockerfile</strong>定义一个镜像的构建规则。这个过程就像是制作集装箱的图纸。</li>
<li>通过 <code>docker build</code>命令，Docker 引擎会根据 Dockerfile 将你的应用及其依赖打包成一个不可变的 <strong>Docker 镜像</strong>。这个镜像就是一个标准的“集装箱”。</li>
<li>接着，使用 <code>docker push</code>将镜像上传到镜像仓库（如 Docker Hub、Harbor）。这相当于将造好的集装箱登记到全球统一的货柜编码系统，方便后续调度中心随时取用。</li>
</ul>
</li>
<li>
<p><strong>定义期望状态与调度部署（下达运输指令与启动物流）</strong></p>
<ul>
<li>你不再需要手动到每台服务器上启动容器，而是通过编写 Kubernetes 的配置文件（如 <strong>Deployment、Service</strong>等 YAML 文件），向 Kubernetes 集群“声明”你期望的应用状态：例如，需要运行 3 个副本，并通过某个端口对外提供服务。</li>
<li>使用 <code>kubectl apply</code>命令将这份“声明”提交给 Kubernetes。Kubernetes 的 <strong>API Server</strong>接收到指令后，<strong>Scheduler</strong>组件会智能地选择集群中最合适的节点（Worker Node），并通知该节点上的 <strong>kubelet</strong>（节点代理）去执行。</li>
<li><strong>kubelet</strong>接到指令后，会从镜像仓库拉取指定的 Docker 镜像，并调用本地的 <strong>Docker 引擎</strong>或符合标准的其他容器运行时（如 containerd）来创建并启动容器。</li>
</ul>
</li>
<li>
<p><strong>运行时的持续管理与治理（物流系统的自动化运维）</strong></p>
<ul>
<li><strong>服务发现与负载均衡</strong>：Kubernetes 的 <strong>Service</strong>资源会为你的多个应用实例（Pod）提供一个稳定的访问入口，并自动将流量负载均衡到各个健康的容器实例上。</li>
<li><strong>弹性伸缩（HPA）</strong> ：当监控系统（如 Prometheus）发现应用容器的 CPU 使用率或自定义业务指标超过阈值时，Kubernetes 的 <strong>Horizontal Pod Autoscaler（HPA）</strong> 会自动增加 Pod 的副本数量，以应对流量高峰；在流量低谷时自动缩减，节约资源。</li>
<li><strong>高级流量治理（服务网格）</strong> ：对于更复杂的通信需求，例如金丝雀发布（逐步将用户流量切换到新版本）、熔断、重试等，<strong>服务网格（如 Istio）</strong> 会发挥作用。它会以 <strong>Sidecar</strong>模式在您的应用容器旁自动注入一个轻量级网络代理，接管所有进出容器的流量，实现精细化的控制，而无需修改应用代码。</li>
<li><strong>自愈与高可用</strong>：Kubernetes 持续监控集群状态。如果某个节点故障或容器异常退出，<strong>ReplicaSet</strong>控制器会立即检测到实际状态与期望状态不符，并自动在健康的节点上重新创建新的容器实例，确保应用始终可用。</li>
</ul>
</li>
</ol>
<h3 data-id="heading-1">💎 总结</h3>
<p>简单来说，<strong>Docker 提供了应用的标准化包装和运行时隔离，是云原生的基石</strong>；而 <strong>Kubernetes 则在此基础上，提供了大规模、自动化、智能化的集群管理能力，是云原生的大脑和中枢神经系统</strong>。其他组件如服务网格、CI/CD工具等，则是在这个坚实基础上，为特定场景（如网络治理、自动化交付）添加的专业能力模块。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[OpenStack在混合云架构中通常扮演什么角色？]]></title>    <link>https://juejin.cn/post/7569910533509578771</link>    <guid>https://juejin.cn/post/7569910533509578771</guid>    <pubDate>2025-11-09T14:10:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7569910533509578771" data-draft-id="7570162686579802154" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="OpenStack在混合云架构中通常扮演什么角色？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-09T14:10:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="IT橘子皮"/> <meta itemprop="url" content="https://juejin.cn/user/3148645291002232"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            OpenStack在混合云架构中通常扮演什么角色？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3148645291002232/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    IT橘子皮
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-09T14:10:11.000Z" title="Sun Nov 09 2025 14:10:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在混合云架构中，OpenStack最核心的角色是作为私有云部分的管理与控制中心。它像一个“总调度室”，帮助企业统一管理本地的计算、存储和网络资源，并凭借其开放的API与外部公有云（如阿里云、AWS）协同工作，共同构成一个灵活、高效且安全的混合环境。</p>
<p>下表清晰地概括了OpenStack在混合云中的核心角色及其带来的关键价值。</p>






























<table><thead><tr><th align="left">角色维度</th><th align="left">核心职责</th><th align="left">带来的关键价值</th></tr></thead><tbody><tr><td align="left">私有云的核心管理者</td><td align="left">通过计算（Nova）、存储（Cinder/Swift）、网络（Neutron）等模块，池化和调度本地数据中心的物理资源，提供与公有云体验一致的IaaS（基础设施即服务）服务。</td><td align="left">安全可控：保障企业对敏感数据和关键应用的控制力，满足合规性要求。</td></tr><tr><td align="left">混合环境的统一连接点</td><td align="left">提供标准化的API接口，与公有云（如阿里云、AWS）对接，实现跨云资源的协同管理和编排。</td><td align="left">避免供应商锁定：开放的API使企业能灵活选择不同的公有云服务商，保持议价能力和架构灵活性。</td></tr><tr><td align="left">工作负载的智能调度器</td><td align="left">根据预设策略（如成本、性能），自动将应用在私有云和公有云之间进行分发或扩展（云爆发）。</td><td align="left">成本优化与弹性：利用公有云应对流量高峰，避免私有云资源过度投资，实现按需付费。</td></tr><tr><td align="left">跨云服务的集成底座</td><td align="left">提供统一的身份认证（Keystone）、监控和运维界面，简化混合云环境的管理复杂度。</td><td align="left">运维一致性：通过统一的控制平面管理异构资源，提升运营效率，降低学习成本。</td></tr></tbody></table>
<h3 data-id="heading-0">🔄 关键实现技术</h3>
<p>要实现上述角色，OpenStack依赖几项关键技术来确保混合云的无缝集成：</p>
<p>•   跨云网络互联：通过SDN（软件定义网络）技术，如使用VPN隧道或SD-WAN专线，将私有云网络与公有云VPC（虚拟私有云）安全地连通，并优化跨云数据传输的延迟和带宽。</p>
<p>•   统一身份认证：OpenStack的Keystone模块可以与企业现有的身份系统（如LDAP/AD）集成，实现跨云环境的单点登录和统一的访问控制策略，这是安全管理的基石。</p>
<p>•   数据同步与容灾：存储组件（如Cinder）支持跨云的数据复制策略，帮助企业实现数据的异地备份和灾难恢复，以满足严格的业务连续性指标（RTO/RPO）。</p>
<h3 data-id="heading-1">🛠️ 典型应用场景</h3>
<p>OpenStack混合云的价值在以下场景中尤为突出：
•   应对突发流量：电商平台在“双11”等大促期间，将核心交易系统置于私有云，而将商品浏览、图片服务等非核心业务扩展到公有云，以保障核心业务的稳定并控制成本。</p>
<p>•   实现跨云容灾：金融机构可以在两个地域的数据中心部署OpenStack私有云，或者利用公有云作为灾备中心，当一方故障时，关键业务能快速切换，保障业务连续性。</p>
<p>•   支撑AI/科研计算：将训练数据和安全要求高的模型开发放在私有云，在需要大规模并行计算进行模型训练或推理时，弹性使用公有云的GPU资源，实现高效计算。</p>
<h3 data-id="heading-2">💎 核心价值总结</h3>
<p>总而言之，OpenStack赋予企业在混合云架构中的主导权和控制力。它让企业能够构建一个以自身业务需求为核心、灵活调配、安全且经济高效的IT基础架构，是数字化转型过程中的关键引擎。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[每日一个计算机小知识：ICMP]]></title>    <link>https://juejin.cn/post/7569959427879600138</link>    <guid>https://juejin.cn/post/7569959427879600138</guid>    <pubDate>2025-11-09T14:10:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7569959427879600138" data-draft-id="7569976345931251763" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="每日一个计算机小知识：ICMP"/> <meta itemprop="keywords" content="后端,网络协议"/> <meta itemprop="datePublished" content="2025-11-09T14:10:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="人人都是码农"/> <meta itemprop="url" content="https://juejin.cn/user/2365804754776718"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            每日一个计算机小知识：ICMP
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2365804754776718/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    人人都是码农
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-09T14:10:20.000Z" title="Sun Nov 09 2025 14:10:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>每日分享一个有趣的计算机小知识，今日话题：<strong>ICMP</strong></p>
<p>ICMP是Internet Control Message Protocol 的缩写，互联网控制消息协议 。它是TCP/IP协议族的一个子协议，用于在IP主机和路由器之间传递差错报告、网络拥塞控制和诊断信息。</p>
<p>1981年4月，美国人乔恩·波斯特尔Jon Postel（互联网发展初期的关键人物之一，编写了大量的RFC文档，在互联网协议的制定和标准化方面发挥了至关重要的作用），编写了ICMP的第一个标准草案RFC 777，初步提出了ICMP的基本概念和功能框架。同年9月，由Jon Postel编写的RFC 792正式发布，对ICMP协议的基本框架进行了定义，确立了其作为TCP/IP协议族中网络层控制协议的地位。</p>
<p>1983年，美国人迈克尔·穆伊斯Mike Muuss开发了基于ICMP协议的网络诊断工具Ping，用于测试网络连接和测量网络延迟。我们在开发中经常会用Ping命令来检查网络通不通（Linux和Windows中均支持），这个Ping的过程实际上就是ICMP协议的工作过程（除了Ping还有跟踪路由的Tracert命令也是基于ICMP协议的）。</p>
<p>Ping命令的核心原理就是利用ICMP协议的Echo Request（请求）和Echo Reply（应答）报文，通过“发送请求-接收应答”的简单交互，测试两台主机间的网络连通性、延迟和丢包率。其执行过程可分为如下6步：</p>
<p><strong>1. 输入ping命令</strong></p>
<p>用户在终端输入ping 目的设备的IP地址，操作系统接触发ICMP协议模块工作。</p>
<p><strong>2. 构造Echo Request报文</strong></p>
<p>ICMP模块生成Echo Request报文，报文中会包含两个关键字段：请求标识符和序列号。</p>
<p><strong>3. 封装成IP数据包</strong></p>
<p>ICMP请求报文本身无法直接传输，需被封装到IP数据包中。IP数据包的源IP设为当前用户的IP，目标IP设为目的设备的IP，且会将IP首部的协议字段设为1（表示该IP包承载的是ICMP协议数据）。</p>
<p><strong>4. 网络层转发</strong></p>
<p>发送Echo Request报文的数量可以设置，缺省时默认发送5个，封装好的IP数据包通过网关（如家用路由器）进入网络，路由器根据目标IP查询路由表，逐层转发数据包，最终送达目的设备。</p>
<p><strong>5. 回复Echo Reply报文</strong></p>
<p>目的设备的IP层收到数据包后，根据协议字段为1识别为ICMP协议，ICMP模块根据Echo Request请求生成对应的Echo Reply应答报文，再将应答报文封装成IP数据包，按原路径反向回复给用户。</p>
<p><strong>6. 用户端接收应答</strong></p>
<p>用户电脑收到Echo Reply数据包后交给ICMP模块，计算请求发送到应答接收的时间（即延迟），同时统计成功收到的应答数与发送的请求数，得出丢包率，然后终端会显示每一次请求的延迟、TTL（生存时间）等信息。如果网络不通（如路由故障、目的设备禁用ICMP等）用户电脑会超时未收到应答，终端就会显示Request timed out请求超时。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b5eeb482ae064769b810a769967618a4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq65Lq66YO95piv56CB5Yac:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763302219&amp;x-signature=7NVu1ot68R8oUNUkdChvtQKDV04%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>ICMP属于网络层协议，是同属网络层的IP协议的重要辅助协议，它有自己独立的协议规范和功能，只是借助IP协议的传输能力来实现自身功能（ICMP报文需要封装在IP数据报中传输），其协议逻辑和功能实现是独立的。它和传输层的UDP协议一样是无连接协议，无确认和重传机制，所以是不可靠的，不过ICMP并不用于传输数据。</p>
<p>IP协议的核心作用是在不同网络之间路由数据包，实现端到端的数据包传输，但是IP协议并不提供可靠传输，如果IP数据包因目标不可达、超时等原因丢失，IP协议并不能通知源主机是否丢包以及丢包的原因，也无法探测网络连通性、无法调节网络拥塞、无法引导路由优化…这些问题就需要ICMP协议来解决。</p>
<p>形象点比喻：IP是负责送货的快递员，只负责把包裹送出去，ICMP则是客服+导航，负责通知送货结果（丢件/送不到）、确认收货方是否在家，以及指引更优送货路线。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[每日一个计算机小知识：IGMP]]></title>    <link>https://juejin.cn/post/7570243451724660763</link>    <guid>https://juejin.cn/post/7570243451724660763</guid>    <pubDate>2025-11-09T14:16:57.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7570243451724660763" data-draft-id="7569959427879616522" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="每日一个计算机小知识：IGMP"/> <meta itemprop="keywords" content="后端,网络协议"/> <meta itemprop="datePublished" content="2025-11-09T14:16:57.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="人人都是码农"/> <meta itemprop="url" content="https://juejin.cn/user/2365804754776718"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            每日一个计算机小知识：IGMP
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2365804754776718/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    人人都是码农
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-09T14:16:57.000Z" title="Sun Nov 09 2025 14:16:57 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>每日分享一个有趣的计算机小知识，今日话题：IGMP</p>
<p>IGMP是Internet Group Management Protocol的缩写，互联网组管理协议，它是TCP/IP协议族中负责IP组播成员管理的一个子协议。和<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzIxNjg0MDA4NQ%3D%3D%26mid%3D2247484637%26idx%3D1%26sn%3D99077ef42514625cb994c68aaac14e2d%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzIxNjg0MDA4NQ==&amp;mid=2247484637&amp;idx=1&amp;sn=99077ef42514625cb994c68aaac14e2d&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">ICMP协议</a>一样都是基于IP的网络协议，且都运行在OSI模型的网络层，它有如下3个版本：</p>
<h4 data-id="heading-0">IGMPv1</h4>
<p>1989年，RFC 1112第一次详细定义了IGMP协议规范，提供了基本的查询和响应机制，主机能够通知路由器加入多播组，但缺乏对主机离开多播组的通知机制。</p>
<h4 data-id="heading-1">IGMPv2</h4>
<p>1997年，IGMP版本2规范发布RFC 2236，增加了主机离开组的通知机制，减少了不必要的成员报告消息，并改进了路由器的查询机制，使得多播管理更加灵活和高效。</p>
<h4 data-id="heading-2">IGMPv3</h4>
<p>2002年，IGMP版本3规范发布RFC 3376，支持源特定组播（SSM，Source-Specific Multicast），允许主机指定要接收或屏蔽的源IP，进一步提高了多播通信的灵活性和安全性。</p>
<p>ICMP主要用于局域网（LAN）中，主要功能就是让主机能够向本地路由器报告它们希望接收的多播流，从而实现数据的高效传输，优化带宽使用。</p>
<p>对于多播不理解的，我们可以先来看下常见的网络数据传输方式：</p>
<h4 data-id="heading-3">1. 单播 Unicast</h4>
<p>一对一传输，一个发送方只能将数据传递给一个指定的接收方。若有多个接收方，发送方需重复发送相同数据，接收方越多，发送端压力越大，适用于个人化、点对点的交互场景，比如浏览网页、微信聊天、下载文件、在线购物下单等。</p>
<h4 data-id="heading-4">2. 广播 Broadcast</h4>
<p>一对所有传输，发送方只需发送一份数据，数据会自动扩散到当前网段内的所有设备，所有设备强制接收。多用于局域网内的通用通知或查询，比如ARP协议地址解析、路由器DHCP自动分配IP地址等。</p>
<h4 data-id="heading-5">3. 组播/多播 Multicast</h4>
<p>一对多传输，仅支持特定网络内传输，发送方仅发送1份数据，数据会精准传输给所有“主动加入组播组”的接收方，未加入的设备则收不到。不管有多少个接收方，发送方始终只需发送1份数据，带宽利用率高。适用于多用户获取相同内容的场景，比如IPTV直播、企业视频会议、股市实时行情推送、在线课堂等。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b8089bf0200e41d8b8be95cdf6b75488~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq65Lq66YO95piv56CB5Yac:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763302617&amp;x-signature=xo2UQE%2Fq9W65DcnA9ReooBU2O74%3D" alt="图片" loading="lazy"/></p>
<p>IGMP协议需将报文封装在IP数据包中传输（IP协议版本号为2），主要分为查询报文和报告报文2类：</p>
<h4 data-id="heading-6">查询报文 Query</h4>
<p>由组播路由器发送，用于询问网段内是否有设备加入特定组播组，如：通用查询General Query（用于询问所有设备加入了哪些组）、特定组查询Group-Specific Query（指定某一组播组，询问还有没有设备在接收当前组的数据流）、特定源特定组查询报文Group-Source-Specific Query（针对某一个组播组+某几个特定源IP，向终端询问是否还需要从这些源接收这个组播组的数据，仅IGMPv3支持）。</p>
<h4 data-id="heading-7">报告报文 Report</h4>
<p>由终端主机发送，用于上报主机自己的组播成员身份，如：成员报告报文Membership Report（终端主动告知路由器加入或继续订阅某个组播组）、离开组报文Leave Group（仅IGMPv2/3支持，终端主动告知路由器不再需要某组播组的数据）。</p>
<p>在没有IGMP时，要1对多传输只能将多播流量发送到整个网络，浪费带宽资源。而通过IGMP协议，路由器只会向需要接收多播流量的主机转发数据，从而显著提升网络效率，减少不必要的带宽占用。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[如何统一前端项目的 Node 版本和包管理器？]]></title>    <link>https://juejin.cn/post/7570243451724693531</link>    <guid>https://juejin.cn/post/7570243451724693531</guid>    <pubDate>2025-11-09T14:20:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7570243451724693531" data-draft-id="7570201730991669274" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="如何统一前端项目的 Node 版本和包管理器？"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-09T14:20:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员大卫"/> <meta itemprop="url" content="https://juejin.cn/user/1961184474695213"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            如何统一前端项目的 Node 版本和包管理器？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1961184474695213/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员大卫
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-09T14:20:37.000Z" title="Sun Nov 09 2025 14:20:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是<strong>前端架构师</strong>，关注微信公众号【<strong>程序员大卫</strong>】：</p>
<ul>
<li>回复 <strong>[面试]</strong> ：免费领取“前端面试大全2025(Vue,React等)”</li>
<li>回复 <strong>[架构师]</strong> ：免费领取“前端精品架构师资料”</li>
<li>回复 <strong>[书]</strong> ：免费领取“前端精品电子书”</li>
<li>回复 <strong>[软件]</strong> ：免费领取“Window和Mac精品安装软件”</li>
</ul>
<p>在使用 <code>pnpm</code> 时，可以通过 <code>.npmrc</code> 或 <code>engines</code> 字段来锁定 Node.js 的版本。下面是几种常见的方法：</p>
<h3 data-id="heading-0">1. 使用 <code>.npmrc</code> 文件锁定 Node 版本</h3>
<p>你可以在项目根目录下的 <code>.npmrc</code> 文件中指定 Node.js 的版本：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">engine-strict</span>=<span class="hljs-literal">true</span>
</code></pre>
<p>这将强制在安装依赖时遵守 <code>package.json</code> 中的 <code>engines</code> 配置。</p>
<h3 data-id="heading-1">2. 使用 <code>engines</code> 字段</h3>
<p>在你的 <code>package.json</code> 中，可以通过 <code>engines</code> 字段来锁定 Node.js 的版本范围。例如：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"engines"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"node"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"&gt;=16.0.0 &lt;18.0.0"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>这样，<code>pnpm</code> 会检查当前 Node.js 版本是否符合这个范围。如果不符合，会报错提示。</p>
<h3 data-id="heading-2">3. 使用 <code>pnpm env use</code> 来指定 Node 版本</h3>
<p>如果你希望在项目中使用特定版本的 Node.js，可以通过 <code>pnpm env use</code> 命令指定 Node 版本。例如：</p>
<pre><code class="hljs language-bash" lang="bash">pnpm <span class="hljs-built_in">env</span> use --global 16
</code></pre>
<p>这样会全局使用 Node.js 16.x 版本。</p>
<p>你也可以使用 <code>pnpm env use &lt;version&gt;</code> 来安装并切换到你指定的 Node.js 版本。</p>
<h3 data-id="heading-3">4. 使用 <code>volta</code> 或 <code>nvm</code> 等工具（外部工具）</h3>
<p>虽然 <code>pnpm</code> 本身没有直接提供锁定 Node.js 版本的机制，但你可以通过工具如 <code>volta</code> 或 <code>nvm</code> 来管理 Node.js 版本，并确保每次切换到项目目录时，自动使用指定的 Node 版本。</p>
<h4 data-id="heading-4">使用 <code>volta</code>:</h4>
<p>安装并使用 <code>volta</code> 可以自动化这个过程，确保在项目中使用的 Node.js 版本与指定的版本一致。首先，你需要安装 Volta：</p>
<pre><code class="hljs language-bash" lang="bash">curl https://get.volta.sh | bash
</code></pre>
<p>然后，你可以使用 <code>volta pin</code> 来锁定 Node 版本：</p>
<pre><code class="hljs language-bash" lang="bash">volta pin node@16
</code></pre>
<p>这样，<code>volta</code> 会在项目中使用 Node.js 16.x 版本。</p>
<h3 data-id="heading-5">总结</h3>
<ul>
<li><code>.npmrc</code> 中设置 <code>engine-strict</code> 可确保安装时遵守 <code>engines</code> 设置。</li>
<li><code>package.json</code> 中的 <code>engines</code> 字段可以指定 Node.js 版本范围。</li>
<li><code>pnpm env use</code> 用于切换和锁定 Node.js 版本。</li>
<li>使用外部工具如 <code>volta</code> 或 <code>nvm</code> 管理 Node 版本也是常见的做法。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[进入职场第二课—融入]]></title>    <link>https://juejin.cn/post/7570213477950177332</link>    <guid>https://juejin.cn/post/7570213477950177332</guid>    <pubDate>2025-11-09T14:47:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7570213477950177332" data-draft-id="7570260758060744739" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="进入职场第二课—融入"/> <meta itemprop="keywords" content="程序员"/> <meta itemprop="datePublished" content="2025-11-09T14:47:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="老李说技术"/> <meta itemprop="url" content="https://juejin.cn/user/624178336632407"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            进入职场第二课—融入
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/624178336632407/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    老李说技术
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-09T14:47:13.000Z" title="Sun Nov 09 2025 14:47:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>经过观察后要做的第二件事一定是融入，大白话来说，就是经过观察，结论是想要留下来，接下来要顺利融入，适应这家公司、这个团队，安全度过新手期。融入和观察一样，都属于入职后的第一阶段，从完全陌生到逐渐熟悉。《易经》乾卦中的“潜龙勿用”，其实说的就是这两件事相加——观察是完全接收输入之后判断，而融入则是在观察的基础上，开始主动输出。</p>
<p>经过新手期的观察，你已经对业务，团队，成员，以及现状，有了充分的认识，那么融入，就是需要我们根据这些信息，走的更顺，更稳。</p>
<p>通过以下 4 个关键动作，快速完成从“局外人”到“团队一份子”的蜕变。</p>
<h3 data-id="heading-0">一、顺着领导的脾气干：先成为他“预期中”的靠谱下属</h3>
<p>你的直属领导，也就是你的老板，是你想要融入这个团队必须搞定的人。他不认可你，不看好你，可能连试用期都过不了，更别提融入这个团队了。</p>
<p>观察出来领导的脾气，顺着这个脾气干，就是你获得领导认可的关键。看看他喜欢的下属是怎么工作的，他们之间又是怎么配合的，很快你就会有答案，照着学，千万别犹豫。</p>
<p>我的前领导曾说：“我不要求你一开始多厉害，但得让我看到你在‘努力契合’——这种态度比能力更重要。” 比如他爱早会同步进度，就别总等周报才汇报；他重视数据支撑，汇报时就多带具体案例和结果；他习惯简洁沟通，就别用长篇大论消耗他的时间。</p>
<h3 data-id="heading-1">​二、和关键同事建立信任：他们是你的“隐形导师”​</h3>
<p>无论你是职场老鸟，还是应届新人，入职之后，你的老板都会给你制定试用期计划。这个计划涉及的工作内容，你可能有经验，也可能什么都不懂——除非你的上一家公司是现在这家公司的竞争对手，业务做的够大、够接近，否则你都得有一个学习上手的过程。</p>
<p>这个过程一般包含两件事：看代码、看资料、学业务，问老人。这个“老人”指的是懂业务的同时，也是对你来说的关键同事——是你不能得罪，必须要建立信任的人。因为他告诉你多一点，你就会少走很多弯路，避开很多雷区；他告诉你少一点，你就惨了，自己费很大的劲不说，还会踩很多值钱的坑。</p>
<p>请他吃个饭拜拜码头，时不时买杯咖啡——伸手不打笑脸人。不需要刻意讨好，真诚 + 分寸感就够了：一句“前辈，这个问题我实在搞不懂，能耽误您 10 分钟吗？”配上认真记笔记的态度，事后反馈“按您说的做，果然少走了弯路”，就能快速拉近距离。</p>
<h3 data-id="heading-2">三、完成本职工作：“好”永远比“快”重要</h3>
<p>所有老板都希望你做的又快又好，但这句话还有后半句：如果让老板在快和好里面只能选一个，所有老板都会选好，而不会选快。快一定是建立在好的基础上，如果做不好，达不到要求，交付之后频频出问题，天天被客户投诉，没有一个老板想要这样的结果。他们宁愿你慢慢做，做好了再交付。</p>
<p>对你来说，本职工作一定要做好，试用期计划里的内容也一定要实现。切记，是完成本职工作，而不是快速的完成。这个阶段快没有任何好处——职场想发展的好，走得稳，走得远，这一点必须学会。比谁做题做得快，比谁背课文背得快，比谁回答问题反应快，这都是还在上小学、初中的学生在比的东西，职场里没人关注这个。</p>
<h3 data-id="heading-3">四、适应公司的已有气场：先“入乡随俗”，再谈改变*</h3>
<p>每个公司都有自己的气场，作为新人，你只能收起自己的锋芒。原因很简单，你还没有做出任何成绩。平时加不加班，考勤严不严格，流程繁不繁琐，氛围活不活跃，搞清楚这些之后，加入他们，照着做，千万别特立独行。</p>
<p>公司开会多，你就跟着开，听听大家都是什么套路；说事情总是发邮件，不直接说，你也跟着发，措辞照着写的好的学；办公区随处可见口号横幅、价值观标语，其他员工什么态度，你也什么态度；如果公司组织学习价值观的话，你就好好认真听。</p>
<h2 data-id="heading-4">写在最后：潜龙勿用，是为了更好地“见龙在田”</h2>
<p>其实融入并不难，把上面这 4 个动作做个七七八八，大概率都不会有啥问题。融入之后，恭喜你，你也就顺利度过了新手期。</p>
<p>再提醒一下，“潜龙勿用”就是龙还潜在水下，还不到你施展才华的时候。别露头，攒着劲，别着急，找出新公司的规律，按这个规律办事，就是顺势而为。</p>
<p>记住：观察是“找出规律”，融入是“学会按规律办事”——二者叠加，就是《易经》里“潜龙勿用”的完整含义。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[纯CSS&JS实现：丝滑渐变过渡的动态导航栏]]></title>    <link>https://juejin.cn/post/7570243451724726299</link>    <guid>https://juejin.cn/post/7570243451724726299</guid>    <pubDate>2025-11-09T14:48:18.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7570243451724726299" data-draft-id="7570243451724627995" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="纯CSS&amp;JS实现：丝滑渐变过渡的动态导航栏"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-09T14:48:18.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="一诺滚雪球"/> <meta itemprop="url" content="https://juejin.cn/user/2824015112318094"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            纯CSS&amp;JS实现：丝滑渐变过渡的动态导航栏
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2824015112318094/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    一诺滚雪球
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-09T14:48:18.000Z" title="Sun Nov 09 2025 14:48:18 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">背景</h2>
<p>在前端开发中，通常实现的导航栏切换时没有添加交互效果，今天就从0到1实现一个美观且交互流畅的导航栏。</p>
<p>直接看效果：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5a14905729de471599df7f5cef3f90f4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA6K-65rua6Zuq55CD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763305123&amp;x-signature=aG9JfTgsywgDAG88p4Gn%2FZcVgB4%3D" alt="tab-ezgif.com-video-to-gif-converter.gif" loading="lazy"/></p>
<h2 data-id="heading-1">1.导航栏实现思路</h2>
<p>实现的导航栏需要具备<strong>丝滑过渡动画</strong>，切换选项时，指示器通过自定义贝塞尔曲线（cubic-bezier(0.68, -0.55, 0.265, 1.55)）实现灵动过渡效果。</p>
<h2 data-id="heading-2">2. 案例代码</h2>
<p>下面逐部分拆解代码，带你理解每个模块的作用。</p>
<h3 data-id="heading-3">2.1 模板结构</h3>
<p>代码如下：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"nav-container"</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 渐变指示器：核心动画元素 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"indicator"</span> <span class="hljs-attr">:style</span>=<span class="hljs-string">"indicatorStyle"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    
    <span class="hljs-comment">&lt;!-- 导航容器：包裹所有导航项 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"nav"</span>&gt;</span>
      <span class="hljs-comment">&lt;!-- 循环渲染导航项 --&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> 
        <span class="hljs-attr">v-for</span>=<span class="hljs-string">"(tab, index) in tabs"</span> 
        <span class="hljs-attr">:key</span>=<span class="hljs-string">"index"</span> 
        <span class="hljs-attr">class</span>=<span class="hljs-string">"nav-item"</span> 
        <span class="hljs-attr">:class</span>=<span class="hljs-string">"{ active: activeTab === index }"</span>
        @<span class="hljs-attr">click</span>=<span class="hljs-string">"changeTab(index)"</span>
      &gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>{{ tab.label }}<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
</code></pre>
<ul>
<li><strong>层级关系</strong>：nav-container 作为最外层容器，内部包含 indicator（指示器）和 nav（导航项容器），通过 z-index 控制层级（指示器 z=0，导航项 z=2）</li>
<li><strong>激活状态</strong>：通过 :class="{ active: activeTab === index }" 控制选中项的文字颜色（白色）</li>
</ul>
<h3 data-id="heading-4">2.2 逻辑处理</h3>
<p>主要控制交互与动画效果。</p>
<p>代码如下：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { ref, computed } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-comment">// 1. 导航数据：可根据需求扩展（如添加路由地址、图标等）</span>
<span class="hljs-keyword">const</span> tabs = [
    { <span class="hljs-attr">label</span>: <span class="hljs-string">'首页'</span>, <span class="hljs-attr">value</span>: <span class="hljs-number">0</span> },
    { <span class="hljs-attr">label</span>: <span class="hljs-string">'分类'</span>, <span class="hljs-attr">value</span>: <span class="hljs-number">1</span> },
    { <span class="hljs-attr">label</span>: <span class="hljs-string">'购物车'</span>, <span class="hljs-attr">value</span>: <span class="hljs-number">2</span> },
    { <span class="hljs-attr">label</span>: <span class="hljs-string">'我的'</span>, <span class="hljs-attr">value</span>: <span class="hljs-number">3</span> }
]
<span class="hljs-comment">// 2. 选中项状态：用 ref 定义响应式变量</span>
<span class="hljs-keyword">const</span> activeTab = <span class="hljs-title function_">ref</span>(<span class="hljs-number">0</span>)
<span class="hljs-comment">// 3. 指示器样式计算：用 computed 实时更新位置和宽度</span>
<span class="hljs-keyword">const</span> indicatorStyle = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> ({
  <span class="hljs-comment">// 左偏移量：选中项索引 * (100% / 导航项数量)</span>
  <span class="hljs-attr">left</span>: <span class="hljs-string">`<span class="hljs-subst">${activeTab.value * (<span class="hljs-number">100</span> / tabs.length)}</span>%`</span>,
  <span class="hljs-comment">// 宽度：均分导航栏（100% / 导航项数量）</span>
  <span class="hljs-attr">width</span>: <span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-number">100</span> / tabs.length}</span>%`</span>
}))
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<h3 data-id="heading-5">2.3 实现视觉与动画</h3>
<p>核心代码如下：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">scoped</span>&gt;</span><span class="css">
<span class="hljs-comment">/* 渐变指示器：核心视觉元素 */</span>
<span class="hljs-selector-class">.indicator</span> {
  <span class="hljs-attribute">position</span>: absolute;
  <span class="hljs-attribute">top</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">100%</span>;
  <span class="hljs-attribute">background</span>: <span class="hljs-built_in">linear-gradient</span>(<span class="hljs-number">45deg</span>, <span class="hljs-number">#4facfe</span> <span class="hljs-number">0%</span>, <span class="hljs-number">#00f2fe</span> <span class="hljs-number">100%</span>); <span class="hljs-comment">/* 蓝青渐变 */</span>
  <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">35px</span>; <span class="hljs-comment">/* 与容器圆角一致：避免棱角 */</span>
  <span class="hljs-comment">/* 自定义过渡曲线：让动画更灵动（非匀速） */</span>
  <span class="hljs-attribute">transition</span>: all <span class="hljs-number">0.5s</span> <span class="hljs-built_in">cubic-bezier</span>(<span class="hljs-number">0.68</span>, -<span class="hljs-number">0.55</span>, <span class="hljs-number">0.265</span>, <span class="hljs-number">1.55</span>);
  <span class="hljs-attribute">z-index</span>: <span class="hljs-number">0</span>; <span class="hljs-comment">/* 指示器在最下层 */</span>
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
</code></pre>
<h2 data-id="heading-6">3. 导航栏优化</h2>
<p>基础版本已实现核心功能，下面分享几个实用的优化方向，满足更多场景需求。</p>
<h3 data-id="heading-7">3.1 添加 hover 效果：增强交互反馈</h3>
<p>在 .nav-item 中添加 hover 样式，让未选中项也有交互反馈：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.nav-item</span><span class="hljs-selector-pseudo">:hover</span><span class="hljs-selector-pseudo">:not</span>(<span class="hljs-selector-class">.active</span>) {
  <span class="hljs-attribute">color</span>: <span class="hljs-number">#4facfe</span>; <span class="hljs-comment">/* hover 时文字变浅蓝 */</span>
  <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">scale</span>(<span class="hljs-number">1.05</span>); <span class="hljs-comment">/* 轻微放大：增强感知 */</span>
}
</code></pre>
<h3 data-id="heading-8">3.2 支持路由跳转：适配单页应用</h3>
<ol>
<li>先引入 Vue Router：</li>
</ol>

<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { useRouter } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue-router'</span>
<span class="hljs-keyword">const</span> router = <span class="hljs-title function_">useRouter</span>()
</code></pre>
<p>2.  在 tabs 数组中添加路由地址：</p>

<pre><code class="hljs language-lua" lang="lua">const tabs = [
  { label: <span class="hljs-string">'首页'</span>, value: <span class="hljs-number">1</span>, <span class="hljs-built_in">path</span>: <span class="hljs-string">'/'</span> },
  { label: <span class="hljs-string">'分类'</span>, value: <span class="hljs-number">2</span>, <span class="hljs-built_in">path</span>: <span class="hljs-string">'/category'</span> },
  { label: <span class="hljs-string">'购物车'</span>, value: <span class="hljs-number">3</span>, <span class="hljs-built_in">path</span>: <span class="hljs-string">'/cart'</span> },
  { label: <span class="hljs-string">'我的'</span>, value: <span class="hljs-number">4</span>, <span class="hljs-built_in">path</span>: <span class="hljs-string">'/mine'</span> }
]
</code></pre>
<p>3.  修改 changeTab 方法，实现路由跳转：</p>

<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">changeTab</span> = (index) =&gt; {
  <span class="hljs-attr">activeTab.value</span> = index
  router.push({ path: tabs<span class="hljs-section">[index]</span>.path })
}
</code></pre>
<h3 data-id="heading-9">3.3 自定义指示器样式</h3>
<p>代码中注释了 “下划线样式” 的指示器，若不需要渐变背景，可替换为：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.indicator</span> {
  <span class="hljs-attribute">position</span>: absolute;
  <span class="hljs-attribute">top</span>: auto;
  <span class="hljs-attribute">bottom</span>: <span class="hljs-number">0</span>; <span class="hljs-comment">/* 下划线靠底部 */</span>
  <span class="hljs-attribute">height</span>: auto;
  <span class="hljs-attribute">border-bottom</span>: <span class="hljs-number">2px</span> solid <span class="hljs-number">#4facfe</span>; <span class="hljs-comment">/* 下划线颜色 */</span>
  <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">0</span>; <span class="hljs-comment">/* 取消圆角 */</span>
  <span class="hljs-attribute">transition</span>: all <span class="hljs-number">0.3s</span> ease; <span class="hljs-comment">/* 简化过渡曲线 */</span>
}
</code></pre>
<h3 data-id="heading-10">3.4 支持触摸滑动</h3>
<p>若需要在移动端支持 “触摸滑动切换”，可结合 touchstart 和 touchend 事件，计算滑动距离来判断是否切换导航项，核心逻辑如下：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 记录触摸起始位置</span>
<span class="hljs-keyword">const</span> startX = <span class="hljs-title function_">ref</span>(<span class="hljs-number">0</span>)
<span class="hljs-comment">// 触摸开始</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleTouchStart</span> = (<span class="hljs-params">e</span>) =&gt; {
  startX.<span class="hljs-property">value</span> = e.<span class="hljs-property">touches</span>[<span class="hljs-number">0</span>].<span class="hljs-property">clientX</span>
}
<span class="hljs-comment">// 触摸结束</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleTouchEnd</span> = (<span class="hljs-params">e</span>) =&gt; {
  <span class="hljs-keyword">const</span> endX = e.<span class="hljs-property">changedTouches</span>[<span class="hljs-number">0</span>].<span class="hljs-property">clientX</span>
  <span class="hljs-keyword">const</span> diffX = endX - startX.<span class="hljs-property">value</span>
  
  <span class="hljs-comment">// 滑动距离超过 50px 才切换（避免误触）</span>
  <span class="hljs-keyword">if</span> (diffX &gt; <span class="hljs-number">50</span> &amp;&amp; activeTab.<span class="hljs-property">value</span> &gt; <span class="hljs-number">0</span>) {
    activeTab.<span class="hljs-property">value</span>--
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (diffX &lt; -<span class="hljs-number">50</span> &amp;&amp; activeTab.<span class="hljs-property">value</span> &lt; tabs.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>) {
    activeTab.<span class="hljs-property">value</span>++
  }
}
<span class="hljs-comment">// 在模板中添加触摸事件</span>
&lt;div <span class="hljs-keyword">class</span>=<span class="hljs-string">"nav"</span> <span class="hljs-meta">@touchstart</span>=<span class="hljs-string">"handleTouchStart"</span> <span class="hljs-meta">@touchend</span>=<span class="hljs-string">"handleTouchEnd"</span>&gt;
  &lt;!-- 导航项 --&gt;
&lt;/div&gt;
</code></pre>
<h2 data-id="heading-11">4. 完整代码</h2>
<p>完整代码如下（可直接复制使用）：</p>
<pre><code class="hljs language-xml" lang="xml">    <span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"nav-container"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"indicator"</span> <span class="hljs-attr">:style</span>=<span class="hljs-string">"indicatorStyle"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> 
          <span class="hljs-attr">class</span>=<span class="hljs-string">"nav"</span> 
          @<span class="hljs-attr">touchstart</span>=<span class="hljs-string">"handleTouchStart"</span> 
          @<span class="hljs-attr">touchend</span>=<span class="hljs-string">"handleTouchEnd"</span>
        &gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> 
            <span class="hljs-attr">v-for</span>=<span class="hljs-string">"(tab, index) in tabs"</span> 
            <span class="hljs-attr">:key</span>=<span class="hljs-string">"tab.value"</span>
            <span class="hljs-attr">class</span>=<span class="hljs-string">"nav-item"</span> 
            <span class="hljs-attr">:class</span>=<span class="hljs-string">"{ active: activeTab === index }"</span>
            @<span class="hljs-attr">click</span>=<span class="hljs-string">"changeTab(index)"</span>
          &gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>{{ tab.label }}<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
    <span class="hljs-keyword">import</span> { ref, computed } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
    <span class="hljs-keyword">import</span> { useRouter } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue-router'</span>
    <span class="hljs-keyword">const</span> router = <span class="hljs-title function_">useRouter</span>()
    <span class="hljs-comment">// 导航数据（支持路由）</span>
    <span class="hljs-keyword">const</span> tabs = [
      { <span class="hljs-attr">label</span>: <span class="hljs-string">'首页'</span>, <span class="hljs-attr">value</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">path</span>: <span class="hljs-string">'/'</span> },
      { <span class="hljs-attr">label</span>: <span class="hljs-string">'分类'</span>, <span class="hljs-attr">value</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">path</span>: <span class="hljs-string">'/category'</span> },
      { <span class="hljs-attr">label</span>: <span class="hljs-string">'购物车'</span>, <span class="hljs-attr">value</span>: <span class="hljs-number">3</span>, <span class="hljs-attr">path</span>: <span class="hljs-string">'/cart'</span> },
      { <span class="hljs-attr">label</span>: <span class="hljs-string">'我的'</span>, <span class="hljs-attr">value</span>: <span class="hljs-number">4</span>, <span class="hljs-attr">path</span>: <span class="hljs-string">'/mine'</span> }
    ]
    <span class="hljs-keyword">const</span> activeTab = <span class="hljs-title function_">ref</span>(<span class="hljs-number">0</span>)
    <span class="hljs-keyword">const</span> startX = <span class="hljs-title function_">ref</span>(<span class="hljs-number">0</span>)
    <span class="hljs-comment">// 指示器样式</span>
    <span class="hljs-keyword">const</span> indicatorStyle = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> ({
      <span class="hljs-attr">left</span>: <span class="hljs-string">`<span class="hljs-subst">${activeTab.value * (<span class="hljs-number">100</span> / tabs.length)}</span>%`</span>,
      <span class="hljs-attr">width</span>: <span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-number">100</span> / tabs.length}</span>%`</span>
    }))
    <span class="hljs-comment">// 切换导航（含路由跳转）</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">changeTab</span> = (<span class="hljs-params">index</span>) =&gt; {
      activeTab.<span class="hljs-property">value</span> = index
      router.<span class="hljs-title function_">push</span>({ <span class="hljs-attr">path</span>: tabs[index].<span class="hljs-property">path</span> })
    }
    <span class="hljs-comment">// 触摸滑动逻辑（移动端适配）</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleTouchStart</span> = (<span class="hljs-params">e</span>) =&gt; {
      startX.<span class="hljs-property">value</span> = e.<span class="hljs-property">touches</span>[<span class="hljs-number">0</span>].<span class="hljs-property">clientX</span>
    }
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleTouchEnd</span> = (<span class="hljs-params">e</span>) =&gt; {
      <span class="hljs-keyword">const</span> endX = e.<span class="hljs-property">changedTouches</span>[<span class="hljs-number">0</span>].<span class="hljs-property">clientX</span>
      <span class="hljs-keyword">const</span> diffX = endX - startX.<span class="hljs-property">value</span>
      <span class="hljs-keyword">if</span> (diffX &gt; <span class="hljs-number">50</span> &amp;&amp; activeTab.<span class="hljs-property">value</span> &gt; <span class="hljs-number">0</span>) {
        activeTab.<span class="hljs-property">value</span>--
        router.<span class="hljs-title function_">push</span>({ <span class="hljs-attr">path</span>: tabs[activeTab.<span class="hljs-property">value</span>].<span class="hljs-property">path</span> })
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (diffX &lt; -<span class="hljs-number">50</span> &amp;&amp; activeTab.<span class="hljs-property">value</span> &lt; tabs.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>) {
        activeTab.<span class="hljs-property">value</span>++
        router.<span class="hljs-title function_">push</span>({ <span class="hljs-attr">path</span>: tabs[activeTab.<span class="hljs-property">value</span>].<span class="hljs-property">path</span> })
      }
    }
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">scoped</span>&gt;</span><span class="css">
    <span class="hljs-selector-class">.nav-container</span> {
      <span class="hljs-attribute">position</span>: relative;
      <span class="hljs-attribute">width</span>: <span class="hljs-number">90%</span>; <span class="hljs-comment">/* 缩小宽度，避免贴边 */</span>
      <span class="hljs-attribute">margin</span>: <span class="hljs-number">20px</span> auto; <span class="hljs-comment">/* 居中显示 */</span>
      <span class="hljs-attribute">height</span>: <span class="hljs-number">44px</span>;
      <span class="hljs-attribute">background</span>: <span class="hljs-number">#fff</span>;
      <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">35px</span>;
      <span class="hljs-attribute">box-shadow</span>: <span class="hljs-number">0</span> <span class="hljs-number">5px</span> <span class="hljs-number">15px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0.08</span>);
      <span class="hljs-attribute">overflow</span>: hidden;
    }
    <span class="hljs-selector-class">.nav</span> {
      <span class="hljs-attribute">position</span>: relative;
      <span class="hljs-attribute">display</span>: flex;
      <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
      <span class="hljs-attribute">height</span>: <span class="hljs-number">100%</span>;
      <span class="hljs-attribute">z-index</span>: <span class="hljs-number">1</span>;
    }
    <span class="hljs-selector-class">.nav-item</span> {
      <span class="hljs-attribute">flex</span>: <span class="hljs-number">1</span>;
      <span class="hljs-attribute">display</span>: flex;
      <span class="hljs-attribute">justify-content</span>: center;
      <span class="hljs-attribute">align-items</span>: center;
      <span class="hljs-attribute">color</span>: <span class="hljs-number">#555</span>;
      <span class="hljs-attribute">font-size</span>: <span class="hljs-number">14px</span>;
      <span class="hljs-attribute">font-weight</span>: <span class="hljs-number">500</span>;
      <span class="hljs-attribute">cursor</span>: pointer;
      <span class="hljs-attribute">transition</span>: all <span class="hljs-number">0.3s</span> ease;
      <span class="hljs-attribute">z-index</span>: <span class="hljs-number">2</span>;
    }
    <span class="hljs-selector-class">.nav-item</span><span class="hljs-selector-class">.active</span> {
      <span class="hljs-attribute">color</span>: <span class="hljs-number">#fff</span>;
    }
    <span class="hljs-selector-class">.nav-item</span><span class="hljs-selector-pseudo">:hover</span><span class="hljs-selector-pseudo">:not</span>(<span class="hljs-selector-class">.active</span>) {
      <span class="hljs-attribute">color</span>: <span class="hljs-number">#4facfe</span>;
      <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">scale</span>(<span class="hljs-number">1.05</span>);
    }
    <span class="hljs-selector-class">.indicator</span> {
      <span class="hljs-attribute">position</span>: absolute;
      <span class="hljs-attribute">top</span>: <span class="hljs-number">0</span>;
      <span class="hljs-attribute">height</span>: <span class="hljs-number">100%</span>;
      <span class="hljs-attribute">background</span>: <span class="hljs-built_in">linear-gradient</span>(<span class="hljs-number">45deg</span>, <span class="hljs-number">#ff9a9e</span> <span class="hljs-number">0%</span>, <span class="hljs-number">#fecfef</span> <span class="hljs-number">100%</span>); 
      <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">35px</span>;
      <span class="hljs-attribute">transition</span>: all <span class="hljs-number">0.5s</span> <span class="hljs-built_in">cubic-bezier</span>(<span class="hljs-number">0.68</span>, -<span class="hljs-number">0.55</span>, <span class="hljs-number">0.265</span>, <span class="hljs-number">1.55</span>);
      <span class="hljs-attribute">z-index</span>: <span class="hljs-number">0</span>;
    }
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
</code></pre>
<h2 data-id="heading-12">5. 总结</h2>
<p>最后总结一下：导航栏实现的核心思路就是是通过动态计算指示器样式，配合<strong>transition</strong>实现动画效果。</p>
<p>如有错误，请指正O^O!</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[《C语言点滴》——笑着入门，扎实成长]]></title>    <link>https://juejin.cn/post/7570299986529746971</link>    <guid>https://juejin.cn/post/7570299986529746971</guid>    <pubDate>2025-11-09T15:00:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7570299986529746971" data-draft-id="7570201730991734810" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="《C语言点滴》——笑着入门，扎实成长"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-09T15:00:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="oioihoii"/> <meta itemprop="url" content="https://juejin.cn/user/1972974802965230"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            《C语言点滴》——笑着入门，扎实成长
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1972974802965230/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    oioihoii
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-09T15:00:11.000Z" title="Sun Nov 09 2025 15:00:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>作者：赵岩（哈尔滨工业大学计算机系教师）<br/>
出版社：人民邮电出版社<br/>
出版时间：2013 年 10 月<br/>
ISBN：978-7-115-32198-5</p>
<p>一、为什么推荐“零基础”读者先读它<br/>
C 语言语法简单，却“贴近机器”，初学者常被指针、数组越界、格式串错误等问题绊倒。作者把课堂里学生最容易“卡壳”的几十个知识点拆成 14 章，每章只讲一件事：<br/>
第 1 章用“程序员职场段子”当开胃菜，先让你笑出来；第 2～13 章把数据类型、运算符、控制流、函数、数组、指针、结构体、文件、调试等“硬骨头”挨个敲碎；第 14 章给出继续进阶的路线与书单，相当于“结业辅导员”。</p>
<p>二、写作风格：把“枯燥”写成“脱口秀”<br/>
书里随处可见的“赵氏吐槽”——<br/>
“如果你把 &amp; 写成 *，编译器不会生气，它只会静静地看着你跑飞。”<br/>
“指针就像快递小哥，地址写错，包裹就送到别人家。”<br/>
编辑读完调侃：“作者从小被笑话，于是决定写本书，边逗你边把钱挣了。”<br/>
这种轻松口吻把学习曲线拉平，让零基础读者也能“笑着读完”。</p>
<p>三、内容设计：正面拆解，少即是多<br/>
不同于《C 陷阱与缺陷》的“错误案例大合集”，本书习惯先给出正确范式，再用 1～2 段最精简的代码把原理跑通；遇到指针、数组等重难点，则不惜篇幅画内存示意图，一步一步跟踪变量值的变化。<br/>
每章末尾会“贴心”地引用 K&amp;R、C FAQ、C 标准库等经典资料，告诉你“学完了该往哪儿钻”。</p>
<p>四、读者反馈与适读人群<br/>
豆瓣、CSDN 上的读者用一句话总结：<br/>
“可以当小说看的 C 语言教材。”<br/>
适合：</p>
<ol>
<li>完全零基础、想先建立“能跑起来的”程序思维；</li>
<li>被国内高校教材“劝退”后，需要重新找回自信；</li>
<li>已经会写代码，却总感觉“根基不牢”，需要补细节。</li>
</ol>
<p>五、阅读路线图<br/>
阶段 1：把《C 语言点滴》通读一遍，跟着敲完书中 40 余个示例——你不再惧怕指针和 malloc。<br/>
阶段 2：回头刷《C 程序设计语言》（K&amp;R），这时你会发现曾经“高冷”的 K&amp;R 突然亲切起来。<br/>
阶段 3：根据第 14 章的指引，选择《C 和指针》《C 陷阱与缺陷》《Expert C Programming》继续深耕。</p>
<p>六、小结<br/>
如果你第一次学 C，却不想“从入门到放弃”，把《C 语言点滴》放在手边。它像一位幽默的学长：先递给你一杯奶茶，再把最难啃的概念掰开揉碎，最后拍拍肩膀告诉你——<br/>
“别怕，继续往前走，幸福就会跟在你尾巴上。”</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Webpack 老项目的优化实践]]></title>    <link>https://juejin.cn/post/7569976345931350067</link>    <guid>https://juejin.cn/post/7569976345931350067</guid>    <pubDate>2025-11-09T15:00:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7569976345931350067" data-draft-id="7570243451724759067" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Webpack 老项目的优化实践"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-09T15:00:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员大卫"/> <meta itemprop="url" content="https://juejin.cn/user/1961184474695213"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Webpack 老项目的优化实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1961184474695213/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员大卫
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-09T15:00:05.000Z" title="Sun Nov 09 2025 15:00:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是<strong>前端架构师</strong>，关注微信公众号【<strong>程序员大卫</strong>】,免费领取精品前端资料。</p>
<h2 data-id="heading-0">背景</h2>
<p>我将分享一些我在公司项目中实际操作的优化方法，最终使得项目的首屏加载速度显著提升。以下是优化前后的对比。</p>
<h3 data-id="heading-1">性能对比：</h3>




















<table><thead><tr><th><strong>指标</strong></th><th><strong>优化前</strong></th><th><strong>优化后</strong></th></tr></thead><tbody><tr><td>JS 文件大小</td><td>32MB</td><td>4MB</td></tr><tr><td>首屏加载时间</td><td>12秒</td><td>2秒</td></tr></tbody></table>
<p>从上面的对比可以看到，优化后项目加载速度有了质的飞跃，首屏加载时间从 11 秒降到了 1 秒，JS 文件的体积也减少了 80%以上。</p>
<h2 data-id="heading-2">优化步骤解析</h2>
<p>接下来，我会详细讲解我在项目中实施的优化措施。</p>
<h3 data-id="heading-3">1. 分析打包体积，找出性能瓶颈</h3>
<p>通过使用 <code>webpack-bundle-analyzer</code> 插件，我们可以直观地查看项目打包后各个文件的体积分布，并发现哪些模块占用了过多的空间。比如，<code>element-plus</code>、<code>echarts</code> 等文件的体积非常庞大，这些文件直接影响了加载速度和构建时间。</p>
<p>可以使用按需加载 <code>element-plus</code> 组件，<code>echarts</code> 不要全局引入，按模块需要引入。</p>
<p>安装 <code>webpack-bundle-analyzer</code> 插件：</p>
<pre><code class="hljs language-bash" lang="bash">npm install webpack-bundle-analyzer -D
</code></pre>
<p>配置 <code>webpack</code> 以启用分析：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> { <span class="hljs-title class_">BundleAnalyzerPlugin</span> } = <span class="hljs-built_in">require</span>(<span class="hljs-string">'webpack-bundle-analyzer'</span>);

<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-attr">configureWebpack</span>: {
    <span class="hljs-attr">plugins</span>: [
      <span class="hljs-keyword">new</span> <span class="hljs-title class_">BundleAnalyzerPlugin</span>()  <span class="hljs-comment">// 用于展示各个模块的大小和依赖关系</span>
    ]
  }
};
</code></pre>
<h3 data-id="heading-4">2. 使用cdn加载第三方js</h3>
<p>使用 CDN 加速是常见的优化方式，它能显著减少项目的打包体积、提高页面加载速度并减少服务器带宽压力。</p>
<h4 data-id="heading-5">1. 将 CDN 资源提取到配置文件中</h4>
<p>首先，你可以将 CDN 配置提取到一个独立的文件中（如 <code>cdn-config.js</code>），并在 <code>vue.config.js</code> 中动态加载。这种方式更灵活且易于维护，尤其是当项目有多个环境（开发、测试、生产）时。</p>
<p><strong><code>cdn-config.js</code> 示例：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-attr">vue</span>: <span class="hljs-string">'https://cdn.jsdelivr.net/npm/vue@2.6.12/dist/vue.min.js'</span>,
  <span class="hljs-string">'element-ui'</span>: <span class="hljs-string">'https://cdn.jsdelivr.net/npm/element-ui@2.15.0/lib/index.js'</span>,
  <span class="hljs-attr">echarts</span>: <span class="hljs-string">'https://cdn.jsdelivr.net/npm/echarts@5.1.2/dist/echarts.min.js'</span>,
  <span class="hljs-attr">css</span>: {
    <span class="hljs-string">'element-ui'</span>: <span class="hljs-string">'https://cdn.jsdelivr.net/npm/element-ui@2.15.0/lib/theme-chalk/index.min.css'</span>,
  },
};
</code></pre>
<h4 data-id="heading-6">2. 动态加载 CDN 链接</h4>
<p>然后，在 <code>vue.config.js</code> 中动态加载这些 CDN 配置，并通过 <code>chainWebpack</code> 插入到 HTML 中。这种方式可以减少硬编码，提高可维护性，并且更灵活地切换 CDN。</p>
<p><strong><code>vue.config.js</code> 示例：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> cdn = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./cdn-config.js'</span>);
<span class="hljs-keyword">const</span> isProduction = process.<span class="hljs-property">env</span>.<span class="hljs-property">NODE_ENV</span> === <span class="hljs-string">'production'</span>;

<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-attr">configureWebpack</span>: {
    <span class="hljs-attr">externals</span>: isProduction ? {
      <span class="hljs-attr">vue</span>: <span class="hljs-string">'Vue'</span>,
      <span class="hljs-string">'element-ui'</span>: <span class="hljs-string">'ELEMENT'</span>,
      <span class="hljs-attr">echarts</span>: <span class="hljs-string">'echarts'</span>
    } : {}
  },
  <span class="hljs-attr">chainWebpack</span>: <span class="hljs-function"><span class="hljs-params">config</span> =&gt;</span> {
    config.<span class="hljs-title function_">plugin</span>(<span class="hljs-string">'html'</span>).<span class="hljs-title function_">tap</span>(<span class="hljs-function"><span class="hljs-params">args</span> =&gt;</span> {
      args[<span class="hljs-number">0</span>].<span class="hljs-property">cdn</span> = {
        <span class="hljs-attr">js</span>: <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">values</span>(cdn).<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">url</span> =&gt;</span> url.<span class="hljs-title function_">endsWith</span>(<span class="hljs-string">'.js'</span>)),
        <span class="hljs-attr">css</span>: <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">values</span>(cdn.<span class="hljs-property">css</span> || {})
      };
      <span class="hljs-keyword">return</span> args;
    });
  }
};
</code></pre>
<h4 data-id="heading-7">3. 在 HTML 模板中插入 CDN 资源</h4>
<p>在 <code>index.html</code> 中，我们使用 <code>html-webpack-plugin</code> 插入 CDN 资源。通过 <code>htmlWebpackPlugin.options.cdn</code> 动态注入这些资源，使得 HTML 模板更加灵活，且无需硬编码每个 CDN 资源。</p>
<p><strong><code>index.html</code> 示例：</strong></p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"utf-8"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Webpack CDN Example<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>

  <span class="hljs-comment">&lt;!-- 动态插入 CSS --&gt;</span>
  &lt;% for (var css of htmlWebpackPlugin.options.cdn.css) { %&gt;
    <span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"stylesheet"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"&lt;%= css %&gt;"</span>&gt;</span>
  &lt;% } %&gt;
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"app"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

  <span class="hljs-comment">&lt;!-- 动态插入 JS --&gt;</span>
  &lt;% for (var js of htmlWebpackPlugin.options.cdn.js) { %&gt;
    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"&lt;%= js %&gt;"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
  &lt;% } %&gt;
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<h4 data-id="heading-8">4. 版本控制和 CDN 服务选择</h4>
<p>使用 <code>jsdelivr</code> 或 <code>unpkg</code> 这种公共 CDN 服务时，注意加上版本号，以确保兼容性。如果项目中有多个依赖项需要加载，最好选择那些稳定且提供长期支持的 CDN 服务，避免因为 CDN 服务问题导致的资源加载失败。</p>
<h4 data-id="heading-9">5. fallback 机制（备用方案）</h4>
<p>为了保证 CDN 加载失败时，页面能正常工作，你可以为 CDN 资源提供一个 fallback 机制。当 CDN 资源无法加载时，可以从本地文件或其他备份源加载。</p>
<p>例如，在 HTML 中加一个简单的 fallback：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
  <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">window</span>.<span class="hljs-property">Vue</span>) {
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">write</span>(<span class="hljs-string">'&lt;script src="/path/to/local/vue.min.js"&gt;&lt;\/script&gt;'</span>);
  }
  <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">window</span>.<span class="hljs-property">ELEMENT</span>) {
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">write</span>(<span class="hljs-string">'&lt;script src="/path/to/local/element-ui.js"&gt;&lt;\/script&gt;'</span>);
  }
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<h3 data-id="heading-10">3. 懒加载优化</h3>
<p>对于一些不常用的库或功能，我们可以通过懒加载来避免它们在首次加载时被下载。例如，<code>Table2Excel</code> 和 <code>exceljs</code> 只是某些功能的依赖，并不会在页面加载时立刻用到。我们采用了 <code>import()</code> 异步加载这些模块。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">download</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">import</span>(<span class="hljs-string">'table2excel.js'</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">Table2Excel</span>) =&gt;</span> {
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Table2Excel</span>.<span class="hljs-title function_">default</span>(<span class="hljs-string">'#table'</span>).<span class="hljs-title function_">export</span>(<span class="hljs-string">'filename'</span>);
  });
}
</code></pre>
<p>通过这种方式，只有在需要时才会加载 <code>Table2Excel</code> 和 <code>exceljs</code>，有效减轻了首次加载的压力。</p>
<h3 data-id="heading-11">4. 压缩并优化 Moment.js</h3>
<p><code>Moment.js</code> 是一个常用的时间处理库，但它的体积较大。我们通过忽略掉不必要的语言包，减少了它的体积。</p>
<p>在 <code>vue.config.js</code> 中配置：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-attr">chainWebpack</span>: <span class="hljs-function"><span class="hljs-params">config</span> =&gt;</span> {
    config.<span class="hljs-title function_">plugin</span>(<span class="hljs-string">'ignore'</span>)
      .<span class="hljs-title function_">use</span>(<span class="hljs-keyword">new</span> webpack.<span class="hljs-title class_">IgnorePlugin</span>(<span class="hljs-regexp">/^\.\/locale$/</span>, <span class="hljs-regexp">/moment$/</span>));  <span class="hljs-comment">// 忽略 moment 的其他语言包</span>
  }
};
</code></pre>
<p>然后在 <code>main.js</code> 中手动引入所需的语言包：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> moment <span class="hljs-keyword">from</span> <span class="hljs-string">'moment'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'moment/locale/zh-cn'</span>;  <span class="hljs-comment">// 只引入中文语言包</span>
moment.<span class="hljs-title function_">locale</span>(<span class="hljs-string">'zh-cn'</span>);
</code></pre>
<p>这种做法将 <code>Moment.js</code> 的体积从几百 KB 降低到了 174KB。</p>
<h3 data-id="heading-12">5. Gzip 压缩文件</h3>
<p>最后，为了进一步减小文件体积并提高加载速度，我们使用了 <code>compression-webpack-plugin</code> 插件对 JS 和 CSS 文件进行 Gzip 压缩。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title class_">CompressionPlugin</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">'compression-webpack-plugin'</span>);

<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-attr">chainWebpack</span>: <span class="hljs-function"><span class="hljs-params">config</span> =&gt;</span> {
    <span class="hljs-keyword">if</span> (isProduction) {
      config.<span class="hljs-title function_">plugin</span>(<span class="hljs-string">'compressionPlugin'</span>).<span class="hljs-title function_">use</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CompressionPlugin</span>({
        <span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.(js|css)$/</span>,  <span class="hljs-comment">// 只压缩 JS 和 CSS 文件</span>
        <span class="hljs-attr">threshold</span>: <span class="hljs-number">10240</span>,     <span class="hljs-comment">// 压缩大于 10KB 的文件</span>
        <span class="hljs-attr">minRatio</span>: <span class="hljs-number">0.8</span>,        <span class="hljs-comment">// 压缩比率</span>
        <span class="hljs-attr">deleteOriginalAssets</span>: <span class="hljs-literal">true</span> <span class="hljs-comment">// 删除原始文件</span>
      }));
    }
  }
};
</code></pre>
<p>经过这些优化，项目的打包文件大小从 3MB 减少到 860KB，加载速度得到了显著提升。</p>
<blockquote>
<p>服务器端也得配置 nginx 开启静态压缩</p>
</blockquote>
<h3 data-id="heading-13">总结</h3>
<p>这些看似简单的优化方法，在实际应用中却能带来显著的性能提升。虽然这些优化技术不是什么新鲜事，但要在实际项目中实施却需要一定的时间和精力。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[前端跨标签页通信方案（上）]]></title>    <link>https://juejin.cn/post/7569945160870068270</link>    <guid>https://juejin.cn/post/7569945160870068270</guid>    <pubDate>2025-11-09T13:08:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7569945160870068270" data-draft-id="7553119425118912512" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="前端跨标签页通信方案（上）"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2025-11-09T13:08:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="168169"/> <meta itemprop="url" content="https://juejin.cn/user/2541726614191528"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            前端跨标签页通信方案（上）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2541726614191528/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    168169
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-09T13:08:38.000Z" title="Sun Nov 09 2025 13:08:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>前情</strong></h2>
<p>平时开发很少有接触到有什么需求需要实现跨标签页通信，但最近因为一些变故，不得不重新开始找工作了，其中就有面试官问到一道题，跨标签页怎么实现数据通信，我当时只答出二种，面试完后特意重新查资料，因此有些文章</p>
<h2 data-id="heading-1"><strong>localStorage / sessionStorage</strong></h2>
<p>利用<code>localStorage</code>的存储事件实现通信，当一个标签页修改<code>localStorage</code>时，其他同源标签页会触发<code>storage</code>事件</p>
<p>关键代码如下：</p>
<p>标签页1</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>page0-localStorage<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"setCacheBtn"</span>&gt;</span>设置本地缓存<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'setCacheBtn'</span>).<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">setItem</span>(<span class="hljs-string">'message'</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({
        <span class="hljs-attr">type</span>: <span class="hljs-string">'greeting'</span>,
        <span class="hljs-comment">// 这里为了保证通信每次生效，每次都设置不同的值</span>
        <span class="hljs-attr">content</span>: <span class="hljs-string">'Hello from page0.html'</span> + <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>()
      }));
    });
  </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<p>标签页2</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>page1-localStorage<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'storage'</span>, <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (e.<span class="hljs-property">key</span> === <span class="hljs-string">'message'</span>) {
        <span class="hljs-keyword">const</span> data = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(e.<span class="hljs-property">newValue</span>);
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Received:page1.html'</span>, data);
      }
    });
  </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<p>动图演示：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0f40a77955cc443da437d47db7292022~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgMTY4MTY5:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763298518&amp;x-signature=n5EtUHa8XY08%2F7njNVwBOGq73pg%3D" alt="20250923_193504.gif" loading="lazy"/></p>
<p><strong>提醒：</strong></p>
<ul>
<li>同源标签才有效</li>
<li>设置不同的本地存储值才有效，如果设置的是同一个缓存值是不会生效的</li>
<li>兼容性非常nice，可以大胆使用了，国内一些浏览器从can i use查不到，但兼容性是没啥问题的</li>
<li>sessionStorage仅在同一标签页的不同 iframe 间有效，不适用于不同标签页</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fa4498c839d142969190eec9a402faeb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgMTY4MTY5:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763298518&amp;x-signature=zGgszvvHWwc9M%2BPxs58H7IJfIS8%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-2"><strong>BroadcastChannel</strong></h2>
<p>专门用于同源标签页通信的 API，创建一个频道后，所有加入该频道的页面都能收到消息</p>
<p>关键代码如下:</p>
<p>标签页1</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>BroadcastChannel0<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>BroadcastChannel0<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"communication"</span>&gt;</span>BroadcastChannel0.html 发送消息<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
    <span class="hljs-comment">// 所有页面都创建相同名称的频道</span>
    <span class="hljs-keyword">const</span> channel = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BroadcastChannel</span>(<span class="hljs-string">'my_channel'</span>);

    <span class="hljs-comment">// 发送消息</span>
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'communication'</span>).<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-function">() =&gt;</span> {
      channel.<span class="hljs-title function_">postMessage</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">'update'</span>, <span class="hljs-attr">data</span>: <span class="hljs-string">'new content from BroadcastChannel0.html'</span> });
    });
  </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<p>标签页2</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>BroadcastChannel1<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>BroadcastChannel1<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
    <span class="hljs-comment">// 所有页面都创建相同名称的频道</span>
    <span class="hljs-keyword">const</span> channel = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BroadcastChannel</span>(<span class="hljs-string">'my_channel'</span>);

    <span class="hljs-comment">// 接收消息</span>
    channel.<span class="hljs-property">onmessage</span> = <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Received:BroadcastChannel1.html'</span>, e.<span class="hljs-property">data</span>);
    };
  </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<p>演示动图如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/87f8ad2389db40ca9426ad93656ea931~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgMTY4MTY5:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763298518&amp;x-signature=O00Ye7U8pkMByUesjARN6xLGbHw%3D" alt="20250923_200047.gif" loading="lazy"/></p>
<p><strong>提醒：</strong></p>
<ul>
<li>要通信的标签记得都初始化BroadcastChannel，一定记得使用相同的名称</li>
<li>查询来看除IE外可以大但使用了</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0a152c1412da4bd180d00cd6d7cad081~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgMTY4MTY5:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763298518&amp;x-signature=tcEPQs9C%2FvT%2FgP%2FUb0F0PANFxyc%3D" alt="image 1.png" loading="lazy"/></p>
<h2 data-id="heading-3">小结</h2>
<p>这二种是我面试的时候答出来的，第二种我只是模糊记得跟面试官模棱二可的说了说，面试馆给了正面的回应，呵呵……，此文暂时写这么多，下篇继续探索其它方式……</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[读懂 Pin，一次搞清 Rust 最难的指针]]></title>    <link>https://juejin.cn/post/7569976345930956851</link>    <guid>https://juejin.cn/post/7569976345930956851</guid>    <pubDate>2025-11-09T12:34:12.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7569976345930956851" data-draft-id="7569976345930924083" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="读懂 Pin，一次搞清 Rust 最难的指针"/> <meta itemprop="keywords" content="Rust"/> <meta itemprop="datePublished" content="2025-11-09T12:34:12.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="大鱼七成饱"/> <meta itemprop="url" content="https://juejin.cn/user/3017475369480509"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            读懂 Pin，一次搞清 Rust 最难的指针
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3017475369480509/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    大鱼七成饱
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-09T12:34:12.000Z" title="Sun Nov 09 2025 12:34:12 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<p>这是Rust九九八十一难第13篇，介绍下pin指针。pin指针跟Future紧密相关，也算是多线程部分第三篇。关于这块，之前看了几篇文章，有评论这块难以理解，我也同感。忘记谁说的了，如果不能简单明了的描述某个东西，说明自己还没真正掌握。本篇尝试用简单方式整理Pin相关的知识，有问题请留言。</p>
<h2 data-id="heading-1">一、基本概念</h2>
<p>入门pin，先要知道四个概念：pin，Unpin和!Upin,以及rust的move。通过这些概念的对比，理解pin的边界，在哪些范围发生作用。</p>
<h3 data-id="heading-2">1、<code>Pin&lt;T&gt;</code> 到底是什么</h3>
<h3 data-id="heading-3">Pin是个智能指针包装器。比如:</h3>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">use</span> std::pin::Pin;

<span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">x</span> = <span class="hljs-number">10</span>;
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">pinned</span> = Pin::<span class="hljs-title function_ invoke__">new</span>(&amp;x);
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"Pinned: {:?}"</span>, pinned);<span class="hljs-comment">//Pinned: 10</span>
}
</code></pre>
<ul>
<li>它包裹了一个类型 <code>T</code>（通常是放在<strong>堆上</strong>的，如 <code>Box&lt;T&gt;</code>），对 <strong>!Unpin 类型</strong> ， 编译器会在语法层面阻止移动。</li>
<li>简单说就是可以拿到 <code>&amp;T</code> 或 <code>&amp;mut T</code>，但保证不会把整个 <code>T</code> 移到别的内存位置。</li>
</ul>
<h3 data-id="heading-4">2、Unpin是什么？</h3>
<p><code>Unpin</code> 是一个 <strong>标记 trait</strong>，表示该类型可以安全地被移动。</p>
<ul>
<li>
<p>大多数普通类型（如 <code>i32</code>, <code>String</code>, <code>Vec&lt;T&gt;</code>）<strong>默认实现</strong>了 <code>Unpin</code>；</p>
</li>
<li>
<p>但一些类型（如 <code>Future</code>、自引用结构）<strong>不会自动实现</strong>。</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">need_unpin</span>&lt;T: Unpin&gt;(x: T) {
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"可以安全移动"</span>);
}
</code></pre>
<p>如果某类型没有 <code>Unpin</code>，那么它就 <strong>必须被固定（pinned）</strong> 才能安全使用。</p>
</li>
</ul>
<h3 data-id="heading-5">3、!Unpin是什么</h3>
<p><strong><code>!Unpin</code></strong> 就是 <strong>没有实现 <code>Unpin</code> 的类型</strong>，表示类型 <strong>不能随意移动</strong>。<code>!Unpin</code> 并不是 Rust 的语法，而是“没有实现 Unpin 的类型”的意思。Rust 默认会自动为大部分类型实现 <code>Unpin</code>，只有少数类型（自引用、Future、PhantomPinned）才是 <code>!Unpin</code></p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">use</span> std::pin::Pin;
<span class="hljs-keyword">use</span> std::marker::PhantomPinned;

<span class="hljs-keyword">struct</span> <span class="hljs-title class_">SelfRef</span> {
    data: <span class="hljs-type">String</span>,
    ptr: *<span class="hljs-keyword">const</span> <span class="hljs-type">String</span>,
    _pin: PhantomPinned, <span class="hljs-comment">// 表示 !Unpin</span>
}

<span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() {
    <span class="hljs-comment">// 普通类型 Unpin</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">x</span> = <span class="hljs-type">Box</span>::<span class="hljs-title function_ invoke__">new</span>(<span class="hljs-number">42</span>);
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">px</span> = Pin::<span class="hljs-title function_ invoke__">new</span>(x);
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">moved_px</span> = px; <span class="hljs-comment">// ✅ 可以移动</span>

    <span class="hljs-comment">// 自引用类型 !Unpin</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">y</span> = <span class="hljs-type">Box</span>::<span class="hljs-title function_ invoke__">pin</span>(SelfRef {
        data: <span class="hljs-string">"hello"</span>.<span class="hljs-title function_ invoke__">to_string</span>(),
        ptr: std::ptr::<span class="hljs-title function_ invoke__">null</span>(),
        _pin: PhantomPinned,
    });
    <span class="hljs-comment">// let moved_y = y; // ❌ 编译报错，不可移动</span>
}
</code></pre>
<p>Unpin 类型 → 钉住也能搬，!Unpin 类型 → 钉住后无法搬。换句话**!Unpin 的作用是“固定对象的地址”，而不是搬动堆上的数据**，如下图：</p>
<pre><code class="hljs language-lua" lang="lua">Stack                     Heap
+<span class="hljs-comment">-------+                 +--------+</span>
| a     | <span class="hljs-comment">--------------&gt; | "hello"|</span>
| Box   |                 +<span class="hljs-comment">--------+</span>
+<span class="hljs-comment">-------+</span>
!Unpin 阻止 a 被 move
</code></pre>
<ul>
<li>
<p><code>a</code>（栈上的 Box）被 Pin ， 栈上的地址不能被移动，堆上的 <code>"hello"</code> 数据不受影响</p>
</li>
<li>
<p>Pin 作用在 <strong>栈上的对象地址</strong>，确保内部指针不会悬空</p>
</li>
</ul>
<h3 data-id="heading-6">4、Pin、Unpin和!Unpin三者对比</h3>

























<table><thead><tr><th>类型</th><th>Pin 是否生效</th><th>说明</th></tr></thead><tbody><tr><td>Unpin</td><td>❌ 不生效（透明）</td><td>移动仍然允许，安全无问题</td></tr><tr><td>!Unpin</td><td>✅ 生效</td><td>栈上值被固定，移动会编译报错，保护内部引用安全</td></tr><tr><td>Copy 类型</td><td>❌ 不生效</td><td>move 其实是复制，Pin 对它无意义</td></tr></tbody></table>
<p><strong><code>Pin</code> 是动作，“把对象钉住”，<code>Unpin</code> / <code>!Unpin</code> 决定钉住后能否移动。</strong></p>
<h3 data-id="heading-7">5、Pin与move的关系</h3>

































<table><thead><tr><th>类型</th><th>Copy？</th><th>Unpin？</th><th>Pin 后移动？</th><th>Pin 作用</th></tr></thead><tbody><tr><td>i32 / bool / f64</td><td>✅</td><td>✅</td><td>✅ 可以移动</td><td>不起作用（透明）</td></tr><tr><td>String / Vec / Box</td><td>❌</td><td>✅</td><td>✅ 可以移动</td><td>对 Unpin 类型不起作用</td></tr><tr><td>自引用 / Future</td><td>❌</td><td>❌</td><td>❌ 禁止移动</td><td>Pin 生效，保护内部引用</td></tr></tbody></table>
<p><strong>Pin 的实际意义只针对 !Unpin （Pin&lt;T: !Unpin&gt;）类型</strong>，Copy 或 Unpin 类型( String、Vec、Box) 标记了 Pin（Pin&lt;T: Unpin&gt;），本质上不起作用。</p>
<h2 data-id="heading-8">二、核心API使用入门</h2>
<p>上一章节确定了边界，这一章看下Pin的api怎么用。</p>
<h3 data-id="heading-9">示例1：Pin&lt;Box&gt;</h3>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">use</span> std::pin::Pin;

<span class="hljs-keyword">struct</span> <span class="hljs-title class_">Data</span> {
    value: <span class="hljs-type">String</span>,
}

<span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() {
  
  	<span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">boxed</span> = <span class="hljs-type">Box</span>::<span class="hljs-title function_ invoke__">new</span>(<span class="hljs-number">123</span>);
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">pinned</span> = Pin::<span class="hljs-title function_ invoke__">new</span>(boxed);

    <span class="hljs-comment">// i32 是 Unpin，所以可以安全取出</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">inner</span> = Pin::<span class="hljs-title function_ invoke__">into_inner</span>(pinned); 
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"{}"</span>, inner);
   
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">data</span> = Data {
        value: <span class="hljs-string">"hello"</span>.<span class="hljs-title function_ invoke__">to_string</span>(),
    };

    <span class="hljs-comment">// 普通 Box，可以自由移动</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">boxed</span> = <span class="hljs-type">Box</span>::<span class="hljs-title function_ invoke__">new</span>(data);

    <span class="hljs-comment">// Pin&lt;Box&lt;T&gt;&gt;：禁止移动内部 T</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">pinned</span>: Pin&lt;<span class="hljs-type">Box</span>&lt;Data&gt;&gt; = Pin::<span class="hljs-title function_ invoke__">new</span>(boxed);

    <span class="hljs-comment">// 安全访问字段</span>
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"Value = {}"</span>, pinned.value);

    <span class="hljs-comment">// 尝试移动 pinned（编译失败），内部值（Data）被移动出原来的内存地址，原先地址上的那块堆内存变成空的，违反了pin的约束</span>
    <span class="hljs-comment">// let moved = *pinned; // ❌</span>
}
</code></pre>
<p><strong>说明：</strong></p>
<ul>
<li><code>Pin&lt;Box&lt;T&gt;&gt;</code> 保证 <code>T</code> 在堆上的地址不会改变；仍然可以修改内容，但不能“移走”整个结构体。</li>
<li>Pin::new()：对 <code>!Unpin</code> 类型（例如自引用结构体），不能直接用这个函数。编译器会强制你使用 <code>unsafe { Pin::new_unchecked(...) }</code>。</li>
<li>如果想只有当类型是 <code>Unpin</code>（可安全移动）时才能用into_inner。</li>
</ul>
<h3 data-id="heading-10">示例2：自引用结构体（<code>Pin</code> 的典型场景）</h3>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">use</span> std::pin::Pin;
<span class="hljs-keyword">use</span> std::ptr::NonNull;

<span class="hljs-keyword">struct</span> <span class="hljs-title class_">SelfRef</span> {
    data: <span class="hljs-type">String</span>,
    ptr: <span class="hljs-type">Option</span>&lt;NonNull&lt;<span class="hljs-type">String</span>&gt;&gt;,
}

<span class="hljs-keyword">impl</span> <span class="hljs-title class_">SelfRef</span> {
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">new</span>(txt: &amp;<span class="hljs-type">str</span>) <span class="hljs-punctuation">-&gt;</span> SelfRef {
        SelfRef {
            data: txt.<span class="hljs-title function_ invoke__">to_string</span>(),
            ptr: <span class="hljs-literal">None</span>,
        }
    }

    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">init</span>(<span class="hljs-keyword">self</span>: Pin&lt;&amp;<span class="hljs-keyword">mut</span> SelfRef&gt;) {
        <span class="hljs-comment">// 安全地拿到内部可变引用</span>
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">this</span> = <span class="hljs-keyword">unsafe</span> { <span class="hljs-keyword">self</span>.<span class="hljs-title function_ invoke__">get_unchecked_mut</span>() };
        <span class="hljs-comment">// 设置指针指向自己字段</span>
        this.ptr = <span class="hljs-title function_ invoke__">Some</span>(NonNull::<span class="hljs-title function_ invoke__">from</span>(&amp;this.data));
    }

    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">print</span>(&amp;<span class="hljs-keyword">self</span>) {
        <span class="hljs-keyword">unsafe</span> {
            <span class="hljs-built_in">println!</span>(<span class="hljs-string">"self.data = {}"</span>, <span class="hljs-keyword">self</span>.data);
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">Some</span>(ptr) = <span class="hljs-keyword">self</span>.ptr {
                <span class="hljs-built_in">println!</span>(<span class="hljs-string">"ptr -&gt; {}"</span>, ptr.<span class="hljs-title function_ invoke__">as_ref</span>());
            }
        }
    }
}

<span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">s</span> = <span class="hljs-type">Box</span>::<span class="hljs-title function_ invoke__">pin</span>(SelfRef::<span class="hljs-title function_ invoke__">new</span>(<span class="hljs-string">"Rust Pin!"</span>));
    s.<span class="hljs-title function_ invoke__">as_mut</span>().<span class="hljs-title function_ invoke__">init</span>();  <span class="hljs-comment">// 初始化自引用</span>
    s.<span class="hljs-title function_ invoke__">print</span>();          <span class="hljs-comment">// ✅ OK：data 没被移动</span>
}
</code></pre>
<h3 data-id="heading-11">示例 3：在异步任务中（<code>Future</code> 的典型应用）</h3>
<p><code>async fn</code> 生成的状态机其实是 <strong>自引用结构体</strong>。 <code>Pin</code> 在运行时保护它不被移动。</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">use</span> std::pin::Pin;
<span class="hljs-keyword">use</span> std::future::Future;
<span class="hljs-keyword">use</span> std::task::{Context, Poll};

<span class="hljs-keyword">struct</span> <span class="hljs-title class_">MyFuture</span> {
    counter: <span class="hljs-type">u8</span>,
}

<span class="hljs-keyword">impl</span> <span class="hljs-title class_">Future</span> <span class="hljs-keyword">for</span> <span class="hljs-title class_">MyFuture</span> {
    <span class="hljs-keyword">type</span> <span class="hljs-title class_">Output</span> = <span class="hljs-type">u8</span>;

    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">poll</span>(<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>: Pin&lt;&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">Self</span>&gt;, _cx: &amp;<span class="hljs-keyword">mut</span> Context&lt;<span class="hljs-symbol">'_</span>&gt;) <span class="hljs-punctuation">-&gt;</span> Poll&lt;<span class="hljs-keyword">Self</span>::Output&gt; {
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">self</span>.counter &lt; <span class="hljs-number">3</span> {
            <span class="hljs-keyword">self</span>.counter += <span class="hljs-number">1</span>;
            <span class="hljs-built_in">println!</span>(<span class="hljs-string">"Counting: {}"</span>, <span class="hljs-keyword">self</span>.counter);
            Poll::Pending
        } <span class="hljs-keyword">else</span> {
            Poll::<span class="hljs-title function_ invoke__">Ready</span>(<span class="hljs-keyword">self</span>.counter)
        }
    }
}

<span class="hljs-meta">#[tokio::main]</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">result</span> = MyFuture { counter: <span class="hljs-number">0</span> }.<span class="hljs-keyword">await</span>;
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"Done: {}"</span>, result);
}
</code></pre>
<p><code>Pin</code> 确保 <code>MyFuture</code> 内部状态（如引用）不会在 <code>.await</code> 期间被移动。这就是为什么 <code>async</code> 语法能安全地处理复杂状态。</p>
<h3 data-id="heading-12">示例4：unsafe</h3>
<h4 data-id="heading-13">a) Pin::new_unchecked</h4>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">x</span> = SelfRef { ... }; <span class="hljs-comment">// !Unpin 类型</span>
<span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">px</span> = <span class="hljs-keyword">unsafe</span> { Pin::<span class="hljs-title function_ invoke__">new_unchecked</span>(&amp;<span class="hljs-keyword">mut</span> x) };
</code></pre>
<ul>
<li><strong>为什么 unsafe</strong>：
<ul>
<li>编译器不能保证后续不会移动 <code>x</code></li>
<li>需要开发者保证 <code>x</code> 在生命周期内不会移动</li>
</ul>
</li>
<li>Pin::new_unchecked：必须 <strong>100% 确保</strong> 这个值不会在 pinned 后被移动，一般只在底层框架（如 tokio、futures）或自引用实现中用，业务代码一般不用。</li>
</ul>
<h4 data-id="heading-14">b) Pin::get_unchecked_mut</h4>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">px</span>: Pin&lt;&amp;<span class="hljs-keyword">mut</span> SelfRef&gt; = Pin::<span class="hljs-title function_ invoke__">new</span>(&amp;<span class="hljs-keyword">mut</span> x);

<span class="hljs-keyword">unsafe</span> {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">mut_ref</span>: &amp;<span class="hljs-keyword">mut</span> SelfRef = Pin::<span class="hljs-title function_ invoke__">get_unchecked_mut</span>(px.<span class="hljs-title function_ invoke__">as_mut</span>());
    mut_ref.ptr = &amp;<span class="hljs-keyword">mut</span> mut_ref.data; <span class="hljs-comment">// 自引用赋值</span>
}
</code></pre>
<ul>
<li>get_unchecked_mut()：不安全适用任何类型，跳过移动安全检查，手动保证 pinned 值不会移动</li>
</ul>
<h4 data-id="heading-15">c)  into_inner 堆上对象拆回原类型（!Unpin 类型不可行）</h4>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">px</span>: Pin&lt;<span class="hljs-type">Box</span>&lt;SelfRef&gt;&gt; = <span class="hljs-type">Box</span>::<span class="hljs-title function_ invoke__">pin</span>(SelfRef { ... });
<span class="hljs-comment">// let b: Box&lt;SelfRef&gt; = Pin::into_inner(px); // ❌ 不安全，编译禁止</span>
</code></pre>
<ul>
<li>对 Unpin 类型安全，可以拆回 Box</li>
<li>对 !Unpin 类型，拆回 Box 需要 unsafe 并自己保证移动不会破坏安全（一般不推荐）</li>
</ul>
<h2 data-id="heading-16">三、为什么要自引用</h2>
<p>pin指针常用场景是自引用，这里聊聊自引用是啥，为什么有自引用。</p>
<h3 data-id="heading-17">1、对比方法访问和内部引用</h3>
<p>假设我们有一个字符串字段 <code>data</code>，想访问前两个字符：</p>
<h4 data-id="heading-18">a、方法访问（推荐做法）</h4>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">MyStruct</span> {
    data: <span class="hljs-type">String</span>,
}

<span class="hljs-keyword">impl</span> <span class="hljs-title class_">MyStruct</span> {
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">slice</span>(&amp;<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> &amp;<span class="hljs-type">str</span> {
        &amp;<span class="hljs-keyword">self</span>.data[<span class="hljs-number">0</span>..<span class="hljs-number">2</span>] <span class="hljs-comment">// 每次调用都生成切片</span>
    }
}

<span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">s</span> = MyStruct { data: <span class="hljs-string">"Hello"</span>.<span class="hljs-title function_ invoke__">into</span>() };
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"{}"</span>, s.<span class="hljs-title function_ invoke__">slice</span>()); <span class="hljs-comment">// "He"</span>
}
</code></pre>
<ul>
<li>
<p>优点：
Rust borrow checker 安全，没有悬空指针，简单、可维护</p>
</li>
<li>
<p>缺点：
每次调用都会生成一个切片（非常轻量级，但在<strong>高性能/大量数据</strong>场景下可能产生微小开销）</p>
</li>
</ul>
<h4 data-id="heading-19">b、内部引用（self_ref / slice 指向 data）</h4>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">SelfRef</span> {
    data: <span class="hljs-type">String</span>,
    slice: *<span class="hljs-keyword">const</span> <span class="hljs-type">str</span>, <span class="hljs-comment">// 内部指针</span>
}

<span class="hljs-keyword">impl</span> <span class="hljs-title class_">SelfRef</span> {
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">new</span>(txt: &amp;<span class="hljs-type">str</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span> {
        <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">s</span> = SelfRef {
            data: txt.<span class="hljs-title function_ invoke__">to_string</span>(),
            slice: std::ptr::<span class="hljs-title function_ invoke__">null</span>(),
        };
        s.slice = &amp;s.data[<span class="hljs-number">0</span>..<span class="hljs-number">2</span>] <span class="hljs-keyword">as</span> *<span class="hljs-keyword">const</span> <span class="hljs-type">str</span>; <span class="hljs-comment">// 指向 data</span>
        s
    }

    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">get_slice</span>(&amp;<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> &amp;<span class="hljs-type">str</span> {
        <span class="hljs-keyword">unsafe</span> { &amp;*<span class="hljs-keyword">self</span>.slice }
    }
}
</code></pre>
<ul>
<li>
<p>优点：</p>
<ul>
<li><strong>零拷贝</strong>：切片预先计算好，访问不需要每次切分</li>
<li>可用于<strong>异步/自引用结构</strong>，避免在 Future 状态机 poll 时重复生成切片</li>
</ul>
</li>
<li>
<p>缺点：</p>
<ul>
<li>必须使用 <strong>Pin</strong> 或堆分配保证 <code>data</code> 地址不变</li>
<li>使用裸指针，需要 <code>unsafe</code>，风险大</li>
<li>程序复杂度高，可维护性差</li>
</ul>
</li>
</ul>
<h3 data-id="heading-20">2、自引用场景</h3>
<h4 data-id="heading-21">a、零拷贝解析</h4>
<p>HTTP、JSON、CSV、文本流等大量数据处理，想存储对 buffer 的切片，而不是复制字符串。那内部引用可以直接保存 slice，避免每次 <code>data[0..n]</code> 生成新切片</p>
<h4 data-id="heading-22">b、异步状态机 / Future 自引用</h4>
<p>状态机字段之间可能互相引用Poll 时不希望重新计算 slice 或临时变量</p>
<h4 data-id="heading-23">c、高性能图结构 / AI / Tensor</h4>
<p>节点存指针指向数据的一部分，而不是每次生成新对象</p>
<h3 data-id="heading-24">3、不加pin的有什么问题</h3>
<p>假设2的场景没加pin，Rust 编译器在面对“直接自引用”，通常会：</p>
<ul>
<li>
<p>如果是安全引用（<code>&amp;str</code>），<strong>直接拒绝编译</strong>；</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">BadRef</span>&lt;<span class="hljs-symbol">'a</span>&gt; {
    data: <span class="hljs-type">String</span>,
    slice: &amp;<span class="hljs-symbol">'a</span> <span class="hljs-type">str</span>, <span class="hljs-comment">// 引用自身字段</span>
}

<span class="hljs-keyword">impl</span>&lt;<span class="hljs-symbol">'a</span>&gt; BadRef&lt;<span class="hljs-symbol">'a</span>&gt; {
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">new</span>(txt: &amp;<span class="hljs-type">str</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span> {
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">s</span> = txt.<span class="hljs-title function_ invoke__">to_string</span>();
        <span class="hljs-keyword">Self</span> {
            data: s,
            slice: &amp;s, <span class="hljs-comment">// ❌ 编译错误</span>
        }
    }
}
</code></pre>
<pre><code class="hljs language-swift" lang="swift">error[<span class="hljs-type">E0505</span>]: cannot move out of `s` because it <span class="hljs-keyword">is</span> borrowed
 <span class="hljs-operator">--&gt;</span> src<span class="hljs-operator">/</span>main.rs:<span class="hljs-number">9</span>:<span class="hljs-number">13</span>
  <span class="hljs-operator">|</span>
<span class="hljs-number">8</span> <span class="hljs-operator">|</span>         <span class="hljs-keyword">let</span> s <span class="hljs-operator">=</span> txt.to_string();
  <span class="hljs-operator">|</span>             <span class="hljs-operator">-</span> binding `s` declared here
<span class="hljs-number">9</span> <span class="hljs-operator">|</span>         <span class="hljs-keyword">Self</span> { data: s, slice: <span class="hljs-operator">&amp;</span>s }
  <span class="hljs-operator">|</span>                    <span class="hljs-operator">^</span> move out of `s` occurs here
  <span class="hljs-operator">|</span>                    <span class="hljs-operator">|</span>
  <span class="hljs-operator">|</span>                    borrow later used here
</code></pre>
<p>Rust 检测到 <code>&amp;s</code> 引用了局部变量 <code>s</code>，但又 move 了它（所有权转移），这违反了生命周期规则。</p>
</li>
<li>
<p>如果用裸指针（<code>*const T</code>），<strong>编译能过但属于未定义行为（UB）</strong>。</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">use</span> std::ptr;

<span class="hljs-keyword">struct</span> <span class="hljs-title class_">SelfRef</span> {
    data: <span class="hljs-type">String</span>,
    ptr: *<span class="hljs-keyword">const</span> <span class="hljs-type">String</span>,
}

<span class="hljs-keyword">impl</span> <span class="hljs-title class_">SelfRef</span> {
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">new</span>(s: &amp;<span class="hljs-type">str</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span> {
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">data</span> = <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">from</span>(s);
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">ptr</span> = &amp;data <span class="hljs-keyword">as</span> *<span class="hljs-keyword">const</span> <span class="hljs-type">String</span>;
        <span class="hljs-keyword">Self</span> { data, ptr }
    }

    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">print</span>(&amp;<span class="hljs-keyword">self</span>) {
        <span class="hljs-keyword">unsafe</span> {
            <span class="hljs-comment">// 访问 ptr 指向的旧地址</span>
            <span class="hljs-built_in">println!</span>(<span class="hljs-string">"ptr -&gt; {}"</span>, &amp;*<span class="hljs-keyword">self</span>.ptr);
        }
    }
}

<span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">x</span> = SelfRef::<span class="hljs-title function_ invoke__">new</span>(<span class="hljs-string">"hello"</span>);
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">y</span> = x; <span class="hljs-comment">// move 发生</span>
    <span class="hljs-comment">// 此时 y.ptr 仍指向 x.data 的旧地址（已被 drop）</span>

    y.<span class="hljs-title function_ invoke__">print</span>(); <span class="hljs-comment">// ❌ UB: 访问已释放内存</span>
}
</code></pre>
<p>interrupted by signal 11:SIGSEGV，或者出现乱码，因为 <code>b.slice</code> 指向了 <code>a.data</code> 的旧位置。有的rust版本可能不崩，有点随机，所以是未定义行为。</p>
</li>
</ul>
<h2 data-id="heading-25">四、Pin具体是怎么固定的</h2>
<p><code>Pin</code> 本身不保证对象真的“不会被移动”，它只是 <strong>在类型系统层面限制移动</strong>,依赖于“不能获取 <code>&amp;mut T</code> 原始引用：</p>
<ul>
<li>对于 <code>Pin&lt;Box&lt;T&gt;&gt;</code>，堆上分配 + 无法替换指针 = 地址稳定</li>
<li>对于 <code>Pin&lt;&amp;mut T&gt;</code>，编译器禁止 <code>T</code> 被 <code>mem::replace()</code> 或 <code>move</code></li>
</ul>
<h3 data-id="heading-26">1、PhantomPinned + !Unpin</h3>
<p>Rust 编译器通过 <strong>类型系统约束</strong>固定内部指针。<code>PhantomPinned</code> 用来标记一个类型 <strong>不可移动</strong>。默认情况下，所有类型都实现 <code>Unpin</code>：</p>
<ul>
<li>
<p><code>Unpin</code> 意味着可以安全移动。</p>
</li>
<li>
<p>自引用类型必须显式禁用 <code>Unpin</code>（通过 <code>PhantomPinned</code>）。</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">use</span> std::marker::PhantomPinned;
<span class="hljs-keyword">use</span> std::pin::Pin;

<span class="hljs-keyword">struct</span> <span class="hljs-title class_">SelfRef</span> {
    data: <span class="hljs-type">String</span>,
    ptr: *<span class="hljs-keyword">const</span> <span class="hljs-type">String</span>,
    _pin: PhantomPinned, <span class="hljs-comment">// 禁止移动</span>
}
</code></pre>
</li>
</ul>
<h3 data-id="heading-27">2、Pin 的 API 层约束</h3>
<p>Pin的核心api定义：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">impl</span>&lt;T: ?<span class="hljs-built_in">Sized</span>&gt; Pin&lt;&amp;<span class="hljs-keyword">mut</span> T&gt; {
    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">as_mut</span>(<span class="hljs-keyword">self</span>: Pin&lt;&amp;<span class="hljs-keyword">mut</span> T&gt;) <span class="hljs-punctuation">-&gt;</span> Pin&lt;&amp;<span class="hljs-keyword">mut</span> T&gt; { ... }
    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">unsafe</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">get_unchecked_mut</span>(<span class="hljs-keyword">self</span>: Pin&lt;&amp;<span class="hljs-keyword">mut</span> T&gt;) <span class="hljs-punctuation">-&gt;</span> &amp;<span class="hljs-keyword">mut</span> T { ... }
}
</code></pre>
<ul>
<li>
<p><code>as_mut</code>  安全获取可变引用，但仍然被 Pin 约束。</p>
</li>
<li>
<p><code>get_unchecked_mut</code> 是 <strong>unsafe</strong>的，允许手动移动内部字段，但风险自担。</p>
</li>
<li>
<p>编译器只允许安全 API 移动外部包裹指针，但内部 T 地址固定。</p>
</li>
</ul>
<h3 data-id="heading-28">3、阻止move的例子</h3>
<p>堆上移动禁止的例子，Pin在编译期就会阻止</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">use</span> std::pin::Pin;
<span class="hljs-keyword">use</span> std::marker::PhantomPinned;

<span class="hljs-keyword">struct</span> <span class="hljs-title class_">SelfRef</span> {
    data: <span class="hljs-type">String</span>,
    ptr: *<span class="hljs-keyword">const</span> <span class="hljs-type">String</span>,
    _pin: PhantomPinned, <span class="hljs-comment">// !Unpin，禁止移动</span>
}

<span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() {
    <span class="hljs-comment">// 堆上创建 SelfRef 并 Pin</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">boxed</span>: Pin&lt;<span class="hljs-type">Box</span>&lt;SelfRef&gt;&gt; = <span class="hljs-type">Box</span>::<span class="hljs-title function_ invoke__">pin</span>(SelfRef {
        data: <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">from</span>(<span class="hljs-string">"hello"</span>),
        ptr: std::ptr::<span class="hljs-title function_ invoke__">null</span>(),
        _pin: PhantomPinned,
    });

    <span class="hljs-comment">// 初始化内部自引用指针</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">ptr</span> = &amp;boxed.data <span class="hljs-keyword">as</span> *<span class="hljs-keyword">const</span> <span class="hljs-type">String</span>;
    <span class="hljs-keyword">unsafe</span> {
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">mut_ref</span> = Pin::<span class="hljs-title function_ invoke__">as_mut</span>(&amp;<span class="hljs-keyword">mut</span> boxed);
        Pin::<span class="hljs-title function_ invoke__">get_unchecked_mut</span>(mut_ref).ptr = ptr;
    }

    <span class="hljs-comment">// ❌ 尝试 move 内部 SelfRef 会报错</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">moved</span> = *boxed; <span class="hljs-comment">// error: cannot move out of `*boxed` because it is pinned</span>

    <span class="hljs-comment">// // 但是 Box 本身可以移动</span>
    <span class="hljs-comment">// let moved_boxed = boxed; // ✅ Box 可移动，但堆上地址固定</span>
    <span class="hljs-comment">//</span>
    <span class="hljs-comment">// println!("data via pinned: {}", unsafe { &amp;*moved_boxed.ptr });</span>
}


</code></pre>
<p>原理：</p>
<ul>
<li>Box 是智能指针，移动 Box 只移动指针，不移动堆数据，如下图，堆没变；</li>
<li>Pin API 保证 T 在堆上的内存地址不会改变。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7ec66390241147e7ae27470b0ba78730~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn6bG85LiD5oiQ6aWx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763296451&amp;x-signature=VtRzzPTncRIR7%2FnDbHQDNlteSt8%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-29">五、为什么 <code>Future</code> 要有 Pin 设计</h2>
<h3 data-id="heading-30">1、future自引用</h3>
<p>一个 <code>async fn</code> 编译后其实会生成一个<strong>状态机结构体</strong></p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">async</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">foo</span>() {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">s</span> = <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">from</span>(<span class="hljs-string">"hello"</span>);
    <span class="hljs-title function_ invoke__">bar</span>(&amp;s).<span class="hljs-keyword">await</span>;
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"{s}"</span>);
}
</code></pre>
<p>编译器大致会生成：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">enum</span> <span class="hljs-title class_">FooFuture</span> {
    State0,                        <span class="hljs-comment">// 初始状态</span>
    State1 { s: <span class="hljs-type">String</span>, bar_fut: BarFuture&lt;<span class="hljs-symbol">'_</span>&gt; },  <span class="hljs-comment">// await 之后</span>
    Done,
}
</code></pre>
<p>每次 <code>.poll()</code> 时，<code>Future</code> 会被推进到下一个状态。</p>
<p>在 <code>State1</code> 中，<code>bar_fut</code> 持有一个对 <code>s</code> 的引用：<code>BarFuture&lt;'_&gt; // 生命周期依赖 FooFuture::s</code></p>
<p>这意味着整个 <code>FooFuture</code> 结构体内部出现了**自引用（self-referential）**关系：</p>
<pre><code class="hljs language-rust" lang="rust">FooFuture
 ├─ s: <span class="hljs-type">String</span>
 └─ bar_fut: BarFuture&lt;<span class="hljs-symbol">'s</span>&gt;
              ↑
              └── 引用了 s
</code></pre>
<h3 data-id="heading-31">2、Future何时被移动</h3>
<p>当 Future 被运行（比如通过 <code>tokio::spawn</code>、<code>block_on</code>）时，执行器会做这样的事：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">fut</span> = <span class="hljs-title function_ invoke__">foo</span>();          <span class="hljs-comment">// 创建 Future</span>
executor.<span class="hljs-title function_ invoke__">spawn</span>(fut);      <span class="hljs-comment">// 把 Future 移进任务队列（Move #1）</span>
</code></pre>
<p>在任务系统中，执行器通常会：</p>
<ul>
<li>把 <code>fut</code> 移进某个堆上分配的任务结构体；</li>
<li>再从任务结构体中取出 <code>Pin&lt;&amp;mut fut&gt;</code> 去调用 <code>poll()</code>。</li>
</ul>
<p>这样，<strong>在被 poll 之前，它已经被 move 过一次了。</strong></p>
<p>更隐蔽的情况:</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">fut</span> = <span class="hljs-title function_ invoke__">foo</span>();
<span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">f1</span> = <span class="hljs-keyword">async</span> { fut.<span class="hljs-keyword">await</span> };
</code></pre>
<p><code>fut</code> 被嵌入另一个 Future <code>f1</code> 中。 <code>f1</code> 也会被 executor 再次移动。 也就是说 <code>fut</code> 可能经历：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-title function_ invoke__">foo</span>() <span class="hljs-punctuation">-&gt;</span> 创建 Future
   ↓ <span class="hljs-keyword">move</span>
<span class="hljs-keyword">async</span> { fut.<span class="hljs-keyword">await</span> } <span class="hljs-punctuation">-&gt;</span> 另一个 Future 包装
   ↓ <span class="hljs-keyword">move</span>
executor.<span class="hljs-title function_ invoke__">spawn</span>() <span class="hljs-punctuation">-&gt;</span> 放入任务
   ↓ <span class="hljs-keyword">move</span>
<span class="hljs-title function_ invoke__">poll</span>() <span class="hljs-punctuation">-&gt;</span> 固定到堆上
</code></pre>
<p>如果 <code>FooFuture</code> 在 poll 过程中被 <strong>移动 (move)</strong>，那么 <code>s</code> 在内存中的地址就变了。
但 <code>bar_fut</code> 仍然保存着旧地址的引用，则<strong>引用失效，属于UB（未定义行为）！</strong>。</p>
<p>所以Rust通过Pin来固定Future内存位置</p>
<h3 data-id="heading-32">3、流程如下</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/71d1b2e2fae34a98b71845636c8f6573~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn6bG85LiD5oiQ6aWx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763296451&amp;x-signature=TQ44aG1DJbNBgDEW8PsmfpLREyk%3D" alt="" loading="lazy"/></p>
<p>说明：</p>
<ul>
<li>当写一个 <code>async fn foo() { … }</code> 或 <code>async { … }</code>，Rust 编译器把它转成一个状态机 struct，其字段包括局部变量、状态标记、可能的 Waker 等。</li>
<li>如果这个状态机 <strong>在 await 点之后</strong> 还持有对自身结构体内部字段（例如 <code>&amp;mut self.field</code>、或 <code>&amp;self.field</code>）的引用，那么它就是一个 <strong>自引用 Future</strong>。也就是说，它存储了指向自身内容的引用。</li>
<li>若这种 Future 被移动（即地址变化），那么这些内部引用就变成悬垂引用，可能引起 UB。</li>
<li>因此，为了安全，Rust 要求：若一个 Future 有可能是自引用的（即生成器状态机可能这样），那么它必须 <strong>先固定住地址（pinned）</strong>，再被 <code>poll</code>。这就是为什么 <code>poll(self: Pin&lt;&amp;mut Self&gt;, …)</code> 而不是 <code>&amp;mut Self</code>。<a href="https://link.juejin.cn?target=https%3A%2F%2Fstackoverflow.com%2Fquestions%2F72769316%2Fwhy-do-futures-use-pins-in-rust%3Futm_source%3Dchatgpt.com" target="_blank" title="https://stackoverflow.com/questions/72769316/why-do-futures-use-pins-in-rust?utm_source=chatgpt.com" ref="nofollow noopener noreferrer">stackoverflow.com/questions/7…</a></li>
<li>在 <code>Pin&lt;&amp;mut Self&gt;</code> 的约束下，类型系统禁止你再偷偷将 Self 移动。只有当 Self 类型实现了 <code>Unpin</code> （表示“即便被 Pin 包装，也可安全移动”）时，才允许“解除固定”的操作。</li>
<li>总结来说，在 poll 期间，保证 Future 所表示的内存位置不会改变**，从而底层状态机字段中的“self-引用”依然有效。</li>
</ul>
<h2 data-id="heading-33">六、总结</h2>
<p>Pin主要保证 !Unpin 类型在内存中的地址固定，比如自引用类型、异步 Future 类型（async/await 内部状态机）、底层异步 I/O 驱动（如 Tokio 内部 task、io_uring buffer）。理解起来有点复杂，对普通类型或短生命周期变量没必要使用，除非是明确的需求。如果用的话，能用安全 API 就不用 unsafe；只能 unsafe 的地方，要保证对象绝对不动。</p>
<p>如果觉得有用，请点个关注吧。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[云原生，与云计算、云服务的区别与联系]]></title>    <link>https://juejin.cn/post/7569977160275771435</link>    <guid>https://juejin.cn/post/7569977160275771435</guid>    <pubDate>2025-11-09T13:12:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7569977160275771435" data-draft-id="7569910533509464083" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="云原生，与云计算、云服务的区别与联系"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-09T13:12:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="IT橘子皮"/> <meta itemprop="url" content="https://juejin.cn/user/3148645291002232"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            云原生，与云计算、云服务的区别与联系
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3148645291002232/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    IT橘子皮
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-09T13:12:47.000Z" title="Sun Nov 09 2025 13:12:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>为了帮助你快速理解云原生、云计算和云服务的关系与区别，我先用一个表格来汇总它们的核心特征。</p>



































<table><thead><tr><th>维度</th><th><strong>云计算</strong></th><th><strong>云服务</strong></th><th><strong>云原生</strong></th></tr></thead><tbody><tr><td><strong>核心定位</strong></td><td>一种<strong>基础范式与商业模式</strong>，提供按需使用的计算资源池</td><td>云计算的<strong>产品形态和交付方式</strong></td><td>一套<strong>构建和运行应用的方法论与技术集合</strong></td></tr><tr><td><strong>关键特征/模式</strong></td><td>资源池化、按需自助、快速弹性、网络访问</td><td><strong>IaaS, PaaS, SaaS</strong>等分层服务模式</td><td><strong>容器、微服务、DevOps、不可变基础设施、声明式API</strong></td></tr><tr><td><strong>核心价值</strong></td><td>像使用水电气一样<strong>按需使用IT资源</strong>，降低IT成本与运维复杂性</td><td>将IT能力作为<strong>即开即用的服务</strong>提供，简化获取过程</td><td>让应用<strong>天生具备弹性、韧性，易于频繁变更与管理</strong>，最大化释放云价值</td></tr><tr><td><strong>形象比喻</strong></td><td><strong>电厂</strong>（发电能力）</td><td><strong>供电服务</strong>（220V插座/专属电路）</td><td><strong>高效用电的整套方案</strong>（节能家电、智能配电）</td></tr></tbody></table>
<h3 data-id="heading-0">☁️ 理解云计算</h3>
<p>云计算是一种<strong>颠覆性的计算模式</strong>。它通过网络（主要是互联网）将庞大的计算资源（如服务器、存储、数据库、网络、软件等）整合成可配置的资源池，让你能够像使用水和电一样，按需使用、按量付费 。</p>
<p>它的核心价值在于：</p>
<ul>
<li><strong>降低门槛</strong>：你无需自建昂贵的数据中心，极大降低了初始投资和运维成本 。</li>
<li><strong>弹性伸缩</strong>：可根据业务高峰和低谷动态调整资源，避免资源闲置或不足 。</li>
<li><strong>高可靠性</strong>：云服务商通常在全球布局多个数据中心，保障服务的连续性和数据安全 。</li>
</ul>
<h3 data-id="heading-1">🔌 认识云服务</h3>
<p>云服务是云计算理念的<strong>具体产品和商业实现</strong>。它明确了云计算资源是如何以一种标准化的方式交付给用户的。通常分为三个层次 ：</p>
<ul>
<li><strong>IaaS</strong>：提供最基础的计算、网络、存储资源。这就像你租用了一间毛坯房，里面的装修和家具（操作系统、应用程序）需要自己负责。例如<strong>阿里云的ECS云服务器</strong>、亚马逊的AWS 。</li>
<li><strong>PaaS</strong>：除了基础设施，还提供了操作系统、数据库、开发工具等平台软件。这相当于租用了一间精装公寓，你可以直接布置家居（开发部署自己的应用）。例如<strong>百度云的应用引擎BAE</strong>。</li>
<li><strong>SaaS</strong>：直接提供可使用的应用软件。这就像直接入住酒店，所有设施服务一应俱全，开箱即用。例如<strong>钉钉、企业微信</strong>等 。</li>
</ul>
<h3 data-id="heading-2">🚀 掌握云原生</h3>
<p>云原生是一套<strong>最佳实践和方法论</strong>，指导我们如何<strong>充分利用云计算的优势来设计、开发和部署应用</strong>。它回答的是“如何更好地在云上构建和运行应用”这个问题 。</p>
<p>它的技术基石包括：</p>
<ul>
<li><strong>容器化</strong>：实现应用及其依赖的标准化打包和隔离，确保环境一致性 。</li>
<li><strong>微服务</strong>：将大型单体应用拆分为一组小型、松耦合的服务，每个服务可独立开发、部署和扩展 。</li>
<li><strong>DevOps</strong>：结合文化、实践与工具，促进开发与运维团队紧密协作，实现持续集成和持续交付 。</li>
<li><strong>声明式API与不可变基础设施</strong>：通过描述“期望的状态”来管理系统和基础设施，使系统更加健壮和易于维护 。</li>
</ul>
<h3 data-id="heading-3">🔗 三者关联</h3>
<p>简单来说，<strong>云计算是基础和理念，云服务是产品和交付，云原生则是方法和路径</strong>。</p>
<ul>
<li>企业通过<strong>云服务</strong>的形式来消费<strong>云计算</strong>的巨大能力。</li>
<li>而采用<strong>云原生</strong>的架构和方式来开发部署应用，才能最充分地释放<strong>云计算</strong>的潜力，用好<strong>云服务</strong>。</li>
</ul>
<p>可以理解为，云计算提供了“电厂”般的强大算力；云服务是为你接通电力的“标准插座”；而云原生则是一套“高效利用电能的现代家电和智能家居方案”，让你不仅能用上电，还能用得智能、高效、可靠。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从傅里叶变换到 RoPE：解构位置编码的数学灵魂]]></title>    <link>https://juejin.cn/post/7570247858869927988</link>    <guid>https://juejin.cn/post/7570247858869927988</guid>    <pubDate>2025-11-09T13:13:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7570247858869927988" data-draft-id="7570213477950013492" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从傅里叶变换到 RoPE：解构位置编码的数学灵魂"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-11-09T13:13:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="mwq30123"/> <meta itemprop="url" content="https://juejin.cn/user/3403743729030686"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从傅里叶变换到 RoPE：解构位置编码的数学灵魂
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3403743729030686/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    mwq30123
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-09T13:13:25.000Z" title="Sun Nov 09 2025 13:13:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">从傅里叶变换到 RoPE：解构位置编码的数学灵魂</h2>
<p>旋转位置编码 (RoPE) 的天才之处，并不仅仅在于它使用了 <code>sin</code> 和 <code>cos</code> 函数。它真正的革命性在于，它将<strong>傅里叶变换的“时移定理”</strong> （Time-Shift Theorem）从一个分析工具，转变成了 Transformer 注意力机制的<strong>内建架构</strong>。</p>
<p>与原始 Transformer 将位置信息“相加”不同，RoPE 通过“旋转”（即复数乘法）来注入位置。这种设计在数学上<strong>强行保证</strong>了注意力分数<strong>只</strong>依赖于词符间的<strong>相对位置 (m-n)</strong> ，从而从根本上解决了绝对位置编码的诸多弊端。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c5a77ae64499486fac68369f997f2153~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbXdxMzAxMjM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763298805&amp;x-signature=p9U%2B9c2jcqxtVfzOyFmwV79z5Lc%3D" alt="傅里叶变换.png" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-1">1. 问题的根源：注意力机制的“位置色盲”</h3>
<p>Transformer 的核心——自注意力机制（Self-Attention）——天生具有“置换不变性”。这意味着，对于模型来说，<code>["我", "打", "你"]</code> 和 <code>["你", "打", "我"]</code> 在计算注意力时是完全等价的，因为它只关心词符之间的“内容”互动，而不关心它们的“顺序”。</p>
<p>为了解决这个“位置色盲”，我们必须以某种方式将“位置 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>m</mi></mrow><annotation encoding="application/x-tex">m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">m</span></span></span></span></span>”和“位置 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">n</span></span></span></span></span>”的信息注入模型。</p>
<h4 data-id="heading-2">1.1 原始方案：加性的绝对编码 (APE)</h4>
<p>原始论文《Attention Is All You Need》提出了一种精妙的方案：</p>
<ol>
<li>为每个绝对位置 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi><mi>o</mi><mi>s</mi></mrow><annotation encoding="application/x-tex">pos</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord mathnormal">p</span><span class="mord mathnormal">os</span></span></span></span></span> 计算一个基于多频率 <code>sin/cos</code> 的向量 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><msub><mi>E</mi><mrow><mi>p</mi><mi>o</mi><mi>s</mi></mrow></msub></mrow><annotation encoding="application/x-tex">PE_{pos}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight">os</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span>。</li>
<li>将这个位置向量**“加”**到词嵌入向量上：<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>X</mi><mrow><mi>f</mi><mi>i</mi><mi>n</mi><mi>a</mi><mi>l</mi></mrow></msub><mo>=</mo><msub><mi>X</mi><mrow><mi>w</mi><mi>o</mi><mi>r</mi><mi>d</mi></mrow></msub><mo>+</mo><mi>P</mi><msub><mi>E</mi><mrow><mi>p</mi><mi>o</mi><mi>s</mi></mrow></msub></mrow><annotation encoding="application/x-tex">X_{final} = X_{word} + PE_{pos}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span><span class="mord mathnormal mtight">ina</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">or</span><span class="mord mathnormal mtight">d</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight">os</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span>。</li>
</ol>
<p>这个方案（我们称之为 APE）是有效的，但它把一个难题留给了模型：</p>
<ul>
<li>模型看到的是一个“混合”向量 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>X</mi><mrow><mi>f</mi><mi>i</mi><mi>n</mi><mi>a</mi><mi>l</mi></mrow></msub></mrow><annotation encoding="application/x-tex">X_{final}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span><span class="mord mathnormal mtight">ina</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span>。</li>
<li>它必须**自行“学习”**如何从 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>X</mi><mrow><mi>f</mi><mi>i</mi><mi>n</mi><mi>a</mi><mi>l</mi></mrow></msub></mrow><annotation encoding="application/x-tex">X_{final}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span><span class="mord mathnormal mtight">ina</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span> 中解耦出词义 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>X</mi><mrow><mi>w</mi><mi>o</mi><mi>r</mi><mi>d</mi></mrow></msub></mrow><annotation encoding="application/x-tex">X_{word}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">or</span><span class="mord mathnormal mtight">d</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 和位置 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><msub><mi>E</mi><mrow><mi>p</mi><mi>o</mi><mi>s</mi></mrow></msub></mrow><annotation encoding="application/x-tex">PE_{pos}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight">os</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span>。</li>
<li>更重要的是，它必须**“学习”<strong>出 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">⟨</mo><msub><mi>X</mi><mi>m</mi></msub><mo>+</mo><mi>P</mi><msub><mi>E</mi><mi>m</mi></msub><mo separator="true">,</mo><msub><mi>X</mi><mi>n</mi></msub><mo>+</mo><mi>P</mi><msub><mi>E</mi><mi>n</mi></msub><mo stretchy="false">⟩</mo></mrow><annotation encoding="application/x-tex">\langle X_m + PE_m, X_n + PE_n \rangle</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">⟨</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">⟩</span></span></span></span></span> 这个复杂的点积中蕴含的“相对位置 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>m</mi><mo>−</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(m-n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord mathnormal">m</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span></span>”信息。这是一种</strong>间接且低效**的方式。</li>
<li>它在训练中只见过 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><msub><mi>E</mi><mn>0</mn></msub></mrow><annotation encoding="application/x-tex">PE_0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 到 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><msub><mi>E</mi><mn>4095</mn></msub></mrow><annotation encoding="application/x-tex">PE_{4095}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">4095</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>，当 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><msub><mi>E</mi><mn>5000</mn></msub></mrow><annotation encoding="application/x-tex">PE_{5000}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">5000</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 出现时，模型会彻底“崩溃”，因为它从未见过这个位置的编码，导致<strong>外推性 (Extrapolation) 极差</strong>。</li>
</ul>
<hr/>
<h3 data-id="heading-3">2. 傅里叶变换的启示：时移即“相旋”</h3>
<p>为了找到更好的方案，我们必须回到信号处理的本源——傅里叶变换。</p>
<p>傅里叶变换的核心思想是：任何时域信号 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mo stretchy="false">(</mo><mi>t</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">f(t)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal">t</span><span class="mclose">)</span></span></span></span></span> 都可以分解为不同频率 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>ω</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(\omega)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">ω</span><span class="mclose">)</span></span></span></span></span> 的 <code>sin</code> 和 <code>cos</code> 波的叠加。</p>
<p>而在所有特性中， <strong>“时移定理” (Shift Theorem)</strong> 是我们的关键：</p>
<blockquote>
<p>时移定理（简易版）：</p>
<p>一个信号在时域的平移 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mo stretchy="false">(</mo><mi>t</mi><mo>+</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">f(t+n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal">t</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span></span>，对应到频域上是一个相位的旋转。</p>
</blockquote>
<p>让我们用最纯粹的数学形式（复数）来表达：</p>
<ol>
<li>
<p>一个单一频率 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>ω</mi></mrow><annotation encoding="application/x-tex">\omega</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">ω</span></span></span></span></span> 的波，在时间 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi></mrow><annotation encoding="application/x-tex">t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6151em;"/><span class="mord mathnormal">t</span></span></span></span></span> 的“编码”是 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mo stretchy="false">(</mo><mi>t</mi><mo stretchy="false">)</mo><mo>=</mo><msup><mi>e</mi><mrow><mi>i</mi><mi>ω</mi><mi>t</mi></mrow></msup></mrow><annotation encoding="application/x-tex">f(t) = e^{i\omega t}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal">t</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.8247em;"/><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8247em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">iω</span><span class="mord mathnormal mtight">t</span></span></span></span></span></span></span></span></span></span></span></span></span>。</p>
</li>
<li>
<p>那么，在时间 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi><mo>+</mo><mi>n</mi></mrow><annotation encoding="application/x-tex">t+n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6984em;vertical-align:-0.0833em;"/><span class="mord mathnormal">t</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">n</span></span></span></span></span>（即平移了 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">n</span></span></span></span></span>）的“编码”是什么？</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mo stretchy="false">(</mo><mi>t</mi><mo>+</mo><mi>n</mi><mo stretchy="false">)</mo><mo>=</mo><msup><mi>e</mi><mrow><mi>i</mi><mi>ω</mi><mo stretchy="false">(</mo><mi>t</mi><mo>+</mo><mi>n</mi><mo stretchy="false">)</mo></mrow></msup><mo>=</mo><msup><mi>e</mi><mrow><mi>i</mi><mi>ω</mi><mi>t</mi></mrow></msup><mo>⋅</mo><msup><mi>e</mi><mrow><mi>i</mi><mi>ω</mi><mi>n</mi></mrow></msup></mrow><annotation encoding="application/x-tex">f(t+n) = e^{i\omega(t+n)} = e^{i\omega t} \cdot e^{i\omega n}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal">t</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">n</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.888em;"/><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">iω</span><span class="mopen mtight">(</span><span class="mord mathnormal mtight">t</span><span class="mbin mtight">+</span><span class="mord mathnormal mtight">n</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.8247em;"/><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8247em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">iω</span><span class="mord mathnormal mtight">t</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.8247em;"/><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8247em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">iωn</span></span></span></span></span></span></span></span></span></span></span></span></span></p>
</li>
<li>
<p>我们得到了一个惊人的公式： <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mo stretchy="false">(</mo><mi>t</mi><mo>+</mo><mi>n</mi><mo stretchy="false">)</mo><mo>=</mo><mi>f</mi><mo stretchy="false">(</mo><mi>t</mi><mo stretchy="false">)</mo><mo>⋅</mo><mi>f</mi><mo stretchy="false">(</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">f(t+n) = f(t) \cdot f(n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal">t</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">n</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal">t</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span></span> （注：这里 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mo stretchy="false">(</mo><mi>n</mi><mo stretchy="false">)</mo><mo>=</mo><msup><mi>e</mi><mrow><mi>i</mi><mi>ω</mi><mi>n</mi></mrow></msup></mrow><annotation encoding="application/x-tex">f(n) = e^{i\omega n}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.8247em;"/><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8247em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">iωn</span></span></span></span></span></span></span></span></span></span></span></span></span>）</p>
</li>
</ol>
<p>这个公式告诉我们： <strong>“平移后”的编码 = “原始编码” 乘以 “平移量对应的旋转因子”</strong> 。</p>
<p>这种关系是<strong>乘性的 (Multiplicative)</strong> ，而不是加性的。</p>
<hr/>
<h3 data-id="heading-4">3. RoPE：将“时移定理”注入注意力</h3>
<p>RoPE 的设计者（苏剑林）敏锐地抓住了这个点。我们希望注意力 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi><mi>t</mi><mi>t</mi><mi>e</mi><mi>n</mi><mi>t</mi><mi>i</mi><mi>o</mi><mi>n</mi><mo stretchy="false">(</mo><mi>m</mi><mo separator="true">,</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">Attention(m, n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">A</span><span class="mord mathnormal">tt</span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span><span class="mord mathnormal">t</span><span class="mord mathnormal">i</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mopen">(</span><span class="mord mathnormal">m</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span></span> 只依赖于相对位置 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>m</mi><mo>−</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(m-n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord mathnormal">m</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span></span>。我们如何利用上述的“乘性”关系呢？</p>
<h4 data-id="heading-5">3.1 目标重设</h4>
<p>我们不再将 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><mi>E</mi></mrow><annotation encoding="application/x-tex">PE</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.05764em;">PE</span></span></span></span></span>“加”到 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>X</mi></mrow><annotation encoding="application/x-tex">X</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.07847em;">X</span></span></span></span></span> 上。我们定义一种新的 Query 和 Key，它们是位置的函数。</p>
<p>我们希望： <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">⟨</mo><msub><mi>q</mi><mi>m</mi></msub><mo separator="true">,</mo><msub><mi>k</mi><mi>n</mi></msub><mo stretchy="false">⟩</mo></mrow><annotation encoding="application/x-tex">\langle q_m, k_n \rangle</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">⟨</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0315em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">⟩</span></span></span></span></span> 能够只由 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>q</mi><mo separator="true">,</mo><mi>k</mi></mrow><annotation encoding="application/x-tex">q, k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span></span> 和 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>m</mi><mo>−</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(m-n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord mathnormal">m</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span></span> 决定。</p>
<h4 data-id="heading-6">3.2 傅里叶“旋转”的实现</h4>
<p>RoPE 正是傅里叶时移定理的直接应用。为了简化，我们暂时使用复数（RoPE 的实际实现就是 2D 旋转，与复数乘法等价）。</p>
<p>RoPE 将 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi></mrow><annotation encoding="application/x-tex">d</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal">d</span></span></span></span></span> 维向量 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>q</mi></mrow><annotation encoding="application/x-tex">q</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">q</span></span></span></span></span> 分解为 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi><mi mathvariant="normal">/</mi><mn>2</mn></mrow><annotation encoding="application/x-tex">d/2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">d</span><span class="mord">/2</span></span></span></span></span> 个复数 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>q</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">q_j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7167em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span>。对每一个复数（代表一个特定的频率 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>θ</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">\theta_j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9805em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span>）：</p>
<ol>
<li>
<p>定义 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>q</mi><mi>m</mi></msub></mrow><annotation encoding="application/x-tex">q_m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>（Query 在位置 m）： <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>q</mi><mi>m</mi></msub><mo>=</mo><msub><mi>q</mi><mi>j</mi></msub><mo>⋅</mo><msup><mi>e</mi><mrow><mi>i</mi><mi>m</mi><msub><mi>θ</mi><mi>j</mi></msub></mrow></msup></mrow><annotation encoding="application/x-tex">q_m = q_j \cdot e^{im\theta_j}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.7306em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.8491em;"/><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8491em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">im</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3281em;"><span style="top:-2.357em;margin-left:-0.0278em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2819em;"><span/></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> （这就是 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mo stretchy="false">(</mo><mi>t</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">f(t)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal">t</span><span class="mclose">)</span></span></span></span></span> 乘以 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mo stretchy="false">(</mo><mi>m</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">f(m)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal">m</span><span class="mclose">)</span></span></span></span></span>）</p>
</li>
<li>
<p>定义 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>k</mi><mi>n</mi></msub></mrow><annotation encoding="application/x-tex">k_n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0315em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>（Key 在位置 n）：<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>k</mi><mi>n</mi></msub><mo>=</mo><msub><mi>k</mi><mi>j</mi></msub><mo>⋅</mo><msup><mi>e</mi><mrow><mi>i</mi><mi>n</mi><msub><mi>θ</mi><mi>j</mi></msub></mrow></msup></mrow><annotation encoding="application/x-tex">k_n = k_j \cdot e^{in\theta_j}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0315em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.9805em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0315em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.8491em;"/><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8491em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">in</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3281em;"><span style="top:-2.357em;margin-left:-0.0278em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2819em;"><span/></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> （这就是 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mo stretchy="false">(</mo><mi>t</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">f(t)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal">t</span><span class="mclose">)</span></span></span></span></span> 乘以 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mo stretchy="false">(</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">f(n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span></span>）</p>
</li>
</ol>
<p>现在，让我们计算 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>q</mi><mi>m</mi></msub></mrow><annotation encoding="application/x-tex">q_m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 和 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>k</mi><mi>n</mi></msub></mrow><annotation encoding="application/x-tex">k_n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0315em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 之间的（复数）点积，这对应于注意力分数：</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.25em" columnalign="right left" columnspacing="0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mtext>Attention</mtext><mo stretchy="false">(</mo><mi>m</mi><mo separator="true">,</mo><mi>n</mi><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow/><mo>∝</mo><msub><mi>q</mi><mi>m</mi></msub><mo>⋅</mo><msubsup><mi>k</mi><mi>n</mi><mo>∗</mo></msubsup><mspace width="1em"/><mo stretchy="false">(</mo><mtext>* 表示共轭</mtext><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow/></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow/><mo>=</mo><mo stretchy="false">(</mo><msub><mi>q</mi><mi>j</mi></msub><mo>⋅</mo><msup><mi>e</mi><mrow><mi>i</mi><mi>m</mi><msub><mi>θ</mi><mi>j</mi></msub></mrow></msup><mo stretchy="false">)</mo><mo>⋅</mo><mo stretchy="false">(</mo><msub><mi>k</mi><mi>j</mi></msub><mo>⋅</mo><msup><mi>e</mi><mrow><mi>i</mi><mi>n</mi><msub><mi>θ</mi><mi>j</mi></msub></mrow></msup><msup><mo stretchy="false">)</mo><mo>∗</mo></msup></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow/></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow/><mo>=</mo><mo stretchy="false">(</mo><msub><mi>q</mi><mi>j</mi></msub><mo>⋅</mo><msup><mi>e</mi><mrow><mi>i</mi><mi>m</mi><msub><mi>θ</mi><mi>j</mi></msub></mrow></msup><mo stretchy="false">)</mo><mo>⋅</mo><mo stretchy="false">(</mo><msubsup><mi>k</mi><mi>j</mi><mo>∗</mo></msubsup><mo>⋅</mo><msup><mi>e</mi><mrow><mo>−</mo><mi>i</mi><mi>n</mi><msub><mi>θ</mi><mi>j</mi></msub></mrow></msup><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow/></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow/><mo>=</mo><mo stretchy="false">(</mo><msub><mi>q</mi><mi>j</mi></msub><mo>⋅</mo><msubsup><mi>k</mi><mi>j</mi><mo>∗</mo></msubsup><mo stretchy="false">)</mo><mo>⋅</mo><mo stretchy="false">(</mo><msup><mi>e</mi><mrow><mi>i</mi><mi>m</mi><msub><mi>θ</mi><mi>j</mi></msub></mrow></msup><mo>⋅</mo><msup><mi>e</mi><mrow><mo>−</mo><mi>i</mi><mi>n</mi><msub><mi>θ</mi><mi>j</mi></msub></mrow></msup><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow/></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow/><mo>=</mo><mo stretchy="false">(</mo><msub><mi>q</mi><mi>j</mi></msub><mo>⋅</mo><msubsup><mi>k</mi><mi>j</mi><mo>∗</mo></msubsup><mo stretchy="false">)</mo><mo>⋅</mo><msup><mi>e</mi><mrow><mi>i</mi><mo stretchy="false">(</mo><mi>m</mi><mo>−</mo><mi>n</mi><mo stretchy="false">)</mo><msub><mi>θ</mi><mi>j</mi></msub></mrow></msup></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{aligned}
\text{Attention}(m, n) &amp;\propto q_m \cdot k_n^* \quad (\text{* 表示共轭}) \\
&amp;= (q_j \cdot e^{i m \theta_j}) \cdot (k_j \cdot e^{i n \theta_j})^* \\
&amp;= (q_j \cdot e^{i m \theta_j}) \cdot (k_j^* \cdot e^{-i n \theta_j}) \\
&amp;= (q_j \cdot k_j^*) \cdot (e^{i m \theta_j} \cdot e^{-i n \theta_j}) \\
&amp;= (q_j \cdot k_j^*) \cdot e^{i (m - n) \theta_j}
\end{aligned}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:7.8446em;vertical-align:-3.6723em;"/><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:4.1723em;"><span style="top:-6.3323em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord text"><span class="mord">Attention</span></span><span class="mopen">(</span><span class="mord mathnormal">m</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span><span style="top:-4.7732em;"><span class="pstrut" style="height:3em;"/><span class="mord"/></span><span style="top:-3.2141em;"><span class="pstrut" style="height:3em;"/><span class="mord"/></span><span style="top:-1.6319em;"><span class="pstrut" style="height:3em;"/><span class="mord"/></span><span style="top:-0.0108em;"><span class="pstrut" style="height:3em;"/><span class="mord"/></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:3.6723em;"><span/></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:4.1723em;"><span style="top:-6.3323em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"/><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">∝</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7387em;"><span style="top:-2.453em;margin-left:-0.0315em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">∗</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:1em;"/><span class="mopen">(</span><span class="mord text"><span class="mord">* </span><span class="mord cjk_fallback">表示共轭</span></span><span class="mclose">)</span></span></span><span style="top:-4.7732em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"/><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8991em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">im</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3281em;"><span style="top:-2.357em;margin-left:-0.0278em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2819em;"><span/></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0315em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8991em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">in</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3281em;"><span style="top:-2.357em;margin-left:-0.0278em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2819em;"><span/></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7387em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">∗</span></span></span></span></span></span></span></span></span></span><span style="top:-3.2141em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"/><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8991em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">im</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3281em;"><span style="top:-2.357em;margin-left:-0.0278em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2819em;"><span/></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7387em;"><span style="top:-2.453em;margin-left:-0.0315em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">∗</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3831em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8991em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mathnormal mtight">in</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3281em;"><span style="top:-2.357em;margin-left:-0.0278em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2819em;"><span/></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span><span style="top:-1.6319em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"/><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7387em;"><span style="top:-2.453em;margin-left:-0.0315em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">∗</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3831em;"><span/></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8991em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">im</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3281em;"><span style="top:-2.357em;margin-left:-0.0278em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2819em;"><span/></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8991em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mathnormal mtight">in</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3281em;"><span style="top:-2.357em;margin-left:-0.0278em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2819em;"><span/></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span><span style="top:-0.0108em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"/><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7387em;"><span style="top:-2.453em;margin-left:-0.0315em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">∗</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3831em;"><span/></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.938em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mopen mtight">(</span><span class="mord mathnormal mtight">m</span><span class="mbin mtight">−</span><span class="mord mathnormal mtight">n</span><span class="mclose mtight">)</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3281em;"><span style="top:-2.357em;margin-left:-0.0278em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2819em;"><span/></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:3.6723em;"><span/></span></span></span></span></span></span></span></span></span></span></div>
<p><strong>这就是 RoPE 的魔法所在！</strong></p>
<ul>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><msub><mi>q</mi><mi>j</mi></msub><mo>⋅</mo><msubsup><mi>k</mi><mi>j</mi><mo>∗</mo></msubsup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(q_j \cdot k_j^*)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"/><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.1448em;vertical-align:-0.3948em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6887em;"><span style="top:-2.4413em;margin-left:-0.0315em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">∗</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3948em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span></span></span>：这部分只与<strong>内容 (content)</strong> 有关。</li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>e</mi><mrow><mi>i</mi><mo stretchy="false">(</mo><mi>m</mi><mo>−</mo><mi>n</mi><mo stretchy="false">)</mo><msub><mi>θ</mi><mi>j</mi></msub></mrow></msup></mrow><annotation encoding="application/x-tex">e^{i(m-n)\theta_j}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.888em;"/><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mopen mtight">(</span><span class="mord mathnormal mtight">m</span><span class="mbin mtight">−</span><span class="mord mathnormal mtight">n</span><span class="mclose mtight">)</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">θ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3281em;"><span style="top:-2.357em;margin-left:-0.0278em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2819em;"><span/></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>：这部分只与<strong>相对位置 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>m</mi><mo>−</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(m-n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord mathnormal">m</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span></span></strong> 有关。</li>
</ul>
<p>RoPE 通过<strong>乘性（旋转）<strong>操作，<strong>在数学上</strong>将内容和相对位置</strong>完美地解耦</strong>了。</p>
<h4 data-id="heading-7">3.3 频率的多尺度（类比“进制”）</h4>
<p>在 RoPE 中，<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>θ</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">\theta_j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9805em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span> 的值（即频率）也不是单一的，而是采用了和 APE 类似的多尺度设计：</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>θ</mi><mi>j</mi></msub><mo>=</mo><mn>1000</mn><msup><mn>0</mn><mrow><mo>−</mo><mn>2</mn><mi>j</mi><mi mathvariant="normal">/</mi><mi>d</mi></mrow></msup></mrow><annotation encoding="application/x-tex">\theta_j = 10000^{-2j/d}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9805em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.938em;"/><span class="mord">1000</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.938em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">2</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mord mtight">/</span><span class="mord mathnormal mtight">d</span></span></span></span></span></span></span></span></span></span></span></span></span></div>
<ul>
<li><strong>低 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>j</mi></mrow><annotation encoding="application/x-tex">j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.854em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.05724em;">j</span></span></span></span></span> 维度：</strong> <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>θ</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">\theta_j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9805em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span> 值大，频率<strong>高</strong>（旋转快，像时钟的“秒针”），捕捉精细的短程相对位置。</li>
<li><strong>高 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>j</mi></mrow><annotation encoding="application/x-tex">j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.854em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.05724em;">j</span></span></span></span></span> 维度：</strong> <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>θ</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">\theta_j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9805em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span> 值小，频率<strong>低</strong>（旋转慢，像时钟的“时针”），捕捉粗粒度的长程相对位置。</li>
</ul>
<p>用不同的“位”或“频率”来捕捉不同尺度的信息。</p>
<hr/>
<h3 data-id="heading-8">4. 结论：加法 vs 乘法</h3>








































<table><thead><tr><th><strong>特性</strong></th><th><strong>原始 APE (加法)</strong></th><th><strong>RoPE (乘法/旋转)</strong></th></tr></thead><tbody><tr><td><strong>集成方式</strong></td><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>X</mi><mo>+</mo><mi>P</mi><msub><mi>E</mi><mrow><mi>a</mi><mi>b</mi><mi>s</mi></mrow></msub></mrow><annotation encoding="application/x-tex">X + PE_{abs}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7667em;vertical-align:-0.0833em;"/><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">ab</span><span class="mord mathnormal mtight">s</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span></td><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>R</mi><mi>m</mi></msub><mo>⋅</mo><mi>q</mi></mrow><annotation encoding="application/x-tex">R_m \cdot q</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0077em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">q</span></span></span></span></span> 和 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>R</mi><mi>n</mi></msub><mo>⋅</mo><mi>k</mi></mrow><annotation encoding="application/x-tex">R_n \cdot k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0077em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span></span></td></tr><tr><td><strong>数学原理</strong></td><td>线性叠加</td><td>傅里叶时移定理（复数乘法）</td></tr><tr><td><strong>模型负担</strong></td><td>必须**“学习”**出相对位置</td><td>相对位置**“内建”**于数学结构</td></tr><tr><td><strong>编码对象</strong></td><td>绝对位置 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>m</mi></mrow><annotation encoding="application/x-tex">m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">m</span></span></span></span></span></td><td>绝对位置 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>m</mi></mrow><annotation encoding="application/x-tex">m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">m</span></span></span></span></span> 和 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">n</span></span></span></span></span></td></tr><tr><td><strong>解码结果</strong></td><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">⟨</mo><msub><mi>q</mi><mi>m</mi></msub><mo separator="true">,</mo><msub><mi>k</mi><mi>n</mi></msub><mo stretchy="false">⟩</mo></mrow><annotation encoding="application/x-tex">\langle q_m, k_n \rangle</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">⟨</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0315em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">⟩</span></span></span></span></span> 中<strong>混杂</strong>着绝对和相对信息</td><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">⟨</mo><msub><mi>q</mi><mi>m</mi></msub><mo separator="true">,</mo><msub><mi>k</mi><mi>n</mi></msub><mo stretchy="false">⟩</mo></mrow><annotation encoding="application/x-tex">\langle q_m, k_n \rangle</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">⟨</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0315em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">⟩</span></span></span></span></span> 中<strong>只包含</strong>相对位置 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>m</mi><mo>−</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(m-n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord mathnormal">m</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span></span></td></tr><tr><td><strong>外推性</strong></td><td>极差</td><td>较好（为位置内插 PI 提供了基础）</td></tr></tbody></table>
<p><strong>总结：</strong></p>
<p>RoPE 与傅里叶变换的联系，远不止于“都用了 <code>sin/cos</code>”。</p>
<p>RoPE 是一种架构上的飞跃：它不再满足于给模型提供“绝对位置”的线索（加法 APE），而是利用傅里ye变换最核心的“时移-相旋”特性，<strong>将相对位置 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>m</mi><mo>−</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(m-n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord mathnormal">m</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span></span> 的计算，变成了注意力机制的内生本能</strong>。这是一种远比加法更优雅、更符合数学原理的解决方案。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Elasticsearch 避坑指南：我在项目中总结的 14 条实用经验]]></title>    <link>https://juejin.cn/post/7569959427879567370</link>    <guid>https://juejin.cn/post/7569959427879567370</guid>    <pubDate>2025-11-09T13:45:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7569959427879567370" data-draft-id="7567249547006607387" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Elasticsearch 避坑指南：我在项目中总结的 14 条实用经验"/> <meta itemprop="keywords" content="Elasticsearch,后端,性能优化"/> <meta itemprop="datePublished" content="2025-11-09T13:45:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="红尘旅人"/> <meta itemprop="url" content="https://juejin.cn/user/3485898277388519"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Elasticsearch 避坑指南：我在项目中总结的 14 条实用经验
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3485898277388519/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    红尘旅人
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-09T13:45:03.000Z" title="Sun Nov 09 2025 13:45:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>刚开始接触 Elasticsearch 时，我觉得它就像个黑盒子——数据往里一扔，查询语句一写，结果就出来了。直到负责公司核心业务的搜索模块后，我才发现这个黑盒子里面藏着无数需要注意的细节。</p>
</blockquote>
<hr/>
<p>今天就把我在实际项目中积累的 ES 使用经验分享给大家，主要从<strong>索引设计</strong>、<strong>字段类型</strong>、<strong>查询优化</strong>、<strong>集群管理</strong>和<strong>架构设计</strong>这几个方面来展开。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ed326ed06d3f41ec9c1ee1010da01c42~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57qi5bCY5peF5Lq6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763300702&amp;x-signature=kA3%2FCjHgK3B0Ze8upiBaoF5nBzE%3D" alt="20251102-4.jpg" loading="lazy"/></p>
<h2 data-id="heading-0">索引设计：从基础到进阶</h2>
<h3 data-id="heading-1">1. 索引别名（alias）：为变更留条后路</h3>
<p>刚开始做项目时，我习惯直接用索引名。直到有一次需要修改字段类型，才发现 <strong>ES 不支持直接修改映射，也不支持修改主分片数</strong>，必须重建索引。（**新增字段是可以的）</p>
<p><strong>解决方案很简单</strong>：使用<strong>索引别名</strong>。业务代码中永远使用别名，重建索引时只需要切换别名的指向，整个过程用户无感知。</p>
<p>这就好比给索引起了个"外号"，里面怎么换内容都不影响外面的人称呼它。</p>
<h3 data-id="heading-2">2. Routing 路由：让查询更精准</h3>
<p>在做 <strong>SaaS 电商系统</strong>时，我发现查询某个商家的订单数据特别慢。原来，<strong>默认情况下ES根据文档ID的哈希值分配分片</strong>，导致同一个商家的数据分散在不同分片上。</p>
<p><strong>优化方案</strong>：使用商家 ID 作为 <strong>routing key</strong>，存储和查询数据时指定routing key。这样，同一个商家的所有数据都会存储在同一个分片上。</p>
<p><strong>效果对比</strong>：</p>
<ul>
<li>优化前：查询要扫描所有分片（比如3个分片都要查）</li>
<li>优化后：只需要查1个分片</li>
<li><strong>结果</strong>：查询速度直接翻倍，资源消耗还更少</li>
</ul>
<h3 data-id="heading-3">3. 分片拆分：应对数据增长</h3>
<p>当单个索引数据量持续增长时，单纯增加分片数并不是最佳方案。</p>
<p><strong>我的经验是</strong>：</p>
<ul>
<li><strong>业务索引</strong>：单个分片控制在 10-30GB</li>
<li><strong>搜索索引</strong>：10GB 以内更合适</li>
<li><strong>日志索引</strong>：可以放宽到 20-50GB</li>
</ul>
<p>对于 SaaS 系统，ES单索引数据较大，且存在“超级大商户”，导致数据倾斜严重时，可以按<strong>商家ID%64取模</strong>进行索引拆分，比如 <code>orders_001</code> 到 <code>orders_064</code>，每个索引包含部分商家的数据，然后再根据商户ID指定routing key。</p>
<blockquote>
<p>请根据<strong>业务数据量</strong>和<strong>业务要求</strong>，选择最适合的<strong>分片拆分规则</strong> 和<strong>routing key路由算法</strong>，同时不要因为拆分不合理，导致ES节点中存在大量分片。</p>
<p>ES默认<strong>单节点分片最大值为1000</strong>(7.0版本后)，可以参考ES官方建议，<strong>堆内存分片数量</strong>维持大约<strong>1:20</strong>的比例</p>
</blockquote>
<hr/>
<h2 data-id="heading-4">字段类型：选择比努力重要</h2>
<h3 data-id="heading-5">4. Text vs Keyword：理解它们的本质区别</h3>
<p>曾经有个坑：用户手机号用 <strong>text 类型</strong>存储，结果搜索完整的手机号却搜不到。原来 text 类型会被分词，<code>13800138000</code> 可能被拆成 <code>138</code>、<code>0013</code>、<code>8000</code> 等片段。</p>
<p><strong>正确做法</strong>：</p>
<ul>
<li>需要分词搜索的用 <strong>text</strong>（如商品描述）</li>
<li>需要精确匹配的用 <strong>keyword</strong>（如订单号、手机号），适合 <strong>term、terms</strong> 等精确查询</li>
<li><strong>效果</strong>：keyword 类型的 term 查询速度更快，存储空间更小</li>
</ul>
<h3 data-id="heading-6">5. 多字段映射（multi-fields）：按需使用不浪费</h3>
<p>ES 默认会为 text 字段创建 keyword 子字段，但这并不总是必要的。</p>
<p><strong>我的选择</strong>：</p>
<ul>
<li>确定字段需要<strong>精确匹配和聚合</strong>时：启用 <strong>multi-fields</strong></li>
<li>只用于全文搜索时：禁用 multi-fields</li>
<li><strong>好处</strong>：节省存储空间，提升写入速度</li>
</ul>
<h3 data-id="heading-7">6. 排序字段：选对类型提升性能</h3>
<p>用 keyword 字段做数值排序是个常见误区。比如价格排序，<code>100</code> 会排在 <code>99</code> 前面，因为它是按字符串顺序比较的。</p>
<p><strong>推荐做法</strong>：</p>
<ul>
<li>数值排序：用 <strong>long、integer</strong> 类型</li>
<li>时间排序：用 <strong>date</strong> 类型</li>
<li><strong>提升效果</strong>：排序速度提升明显，内存占用也更少</li>
</ul>
<hr/>
<h2 data-id="heading-8">查询优化：平衡速度与精度</h2>
<h3 data-id="heading-9">7. 模糊查询：了解正确的打开方式</h3>
<p>在 <strong>ES 7.9 之前</strong>，<strong>wildcard 查询</strong>是个性能陷阱。它基于正则表达式引擎，前导通配符会导致全量词项扫描。</p>
<p><strong>现在的方案</strong>：</p>
<ul>
<li><strong>ES7.9+</strong>：使用 <strong>wildcard 字段类型</strong></li>
<li><strong>优势</strong>：底层使用优化的 <strong>n-gram</strong> + <strong>二进制 doc value</strong> 机制，性能提升显著</li>
</ul>
<blockquote>
<p>提示：ES7.9前后版本wildcard的具体介绍，可以参考我的上一篇文章</p>
<p><a href="https://juejin.cn/post/7567581946144522291" target="_blank" title="https://juejin.cn/post/7567581946144522291">《与产品经理的“模糊”对决：Elasticsearch实现MySQL LIKE '%xxx%'》</a></p>
</blockquote>
<h3 data-id="heading-10">8. 分页查询：避免深度分页的坑</h3>
<p>产品经理曾要求实现"无限滚动"，我展示了深度分页的性能数据后，大家达成共识：<strong>业务层面避免深度分页才是根本解决方案</strong>。就像淘宝、Google 这样的大厂，也都对分页做了限制，这不仅是技术考量，更是用户体验的最优选择。</p>
<p><strong>技术方案</strong>（仅在确实无法避免时考虑）：</p>
<ul>
<li><strong>浅分页</strong>：使用 <code>from/size</code>，适合前几页的常规分页</li>
<li><strong>Scroll</strong>：适合大数据量导出，但需要维护 scroll_id 和历史快照，对服务器资源消耗较大</li>
<li><strong>search_after</strong>：基于上一页最后一条记录进行分页，但无法跳转任意页面，且频繁查询会增加服务器压力</li>
</ul>
<p>需要强调的是，这些技术方案都存在各自的局限性，<strong>业务设计上的规避始终是最佳选择</strong>。</p>
<hr/>
<h2 data-id="heading-11">集群管理：保障稳定运行</h2>
<h3 data-id="heading-12">9. 索引生命周期：自动化运维</h3>
<p>日志数据的特点是源源不断，如果不加管理，磁盘很快就会被撑满。</p>
<p><strong>我的做法</strong>：</p>
<ul>
<li>按天创建索引（如 log_20231201）</li>
<li>设置保留策略（保留7天或30天）</li>
<li>结合模板自动化管理</li>
</ul>
<h3 data-id="heading-13">10. 准实时性：理解刷新机制</h3>
<p>很多新手会困惑：为什么数据写入后不能立即搜索？</p>
<p><strong>原理</strong>：<strong>ES 默认 1 秒刷新一次索引</strong>，这是为了在实时性和写入性能之间取得平衡。</p>
<p><strong>调整建议</strong>：</p>
<ul>
<li>实时性要求高：保持 1s</li>
<li>写入量大：适当调大 refresh_interval</li>
</ul>
<blockquote>
<p><strong>补充说明</strong>：如果需要更新后立即能查询到，通常有两种方案：</p>
<ol>
<li>让前端直接展示刚提交的数据，等下一次调用接口时再查询 ES</li>
<li>更新完后，前端延迟 1.5 秒后再查询</li>
</ol>
<p><strong>关键点</strong>：业务需求不一定都要后端实现，可以结合前端一起考虑解决方案。</p>
</blockquote>
<h3 data-id="heading-14">11. 内存配置：32G 限制的真相</h3>
<p>为什么 ES 官方建议不要超过 32G 内存？</p>
<p><strong>技术原因</strong>：Java 的<strong>压缩指针技术</strong>在 32G 以内有效，超过这个限制会浪费大量内存。</p>
<p><strong>实践建议</strong>：单个节点配置约50%内存，留出部分给操作系统。</p>
<hr/>
<h2 data-id="heading-15">架构设计：合理的分工协作</h2>
<h3 data-id="heading-16">12. ES 与数据库：各司其职</h3>
<p>曾经试图在 ES 里存储完整的业务数据，结果遇到<strong>数据一致性</strong>问题。</p>
<p><strong>现在的方案</strong>：</p>
<ul>
<li><strong>ES</strong>：存储搜索条件和文档 ID</li>
<li><strong>数据库</strong>：存储完整业务数据</li>
<li><strong>查询</strong>：ES 找 ID，数据库取详情</li>
</ul>
<p><strong>好处</strong>：既享受 ES 的搜索能力，又保证数据的强一致性。</p>
<h3 data-id="heading-17">13. 嵌套对象：保持数据关联性</h3>
<p>处理商品规格这类数组数据时，用普通的 <strong>object 类型</strong>会导致数据扁平化，破坏对象间的关联。</p>
<p><strong>解决方案</strong>：使用 <strong>nested 类型</strong>，保持数组内对象的独立性，确保查询结果的准确性。</p>
<h3 data-id="heading-18">14. 副本配置：读写平衡的艺术</h3>
<p>副本可以提升查询能力，但也不是越多越好。</p>
<p><strong>经验值</strong>：</p>
<ul>
<li>大多数场景：<strong>1 个副本</strong>足够</li>
<li>高查询压力：可适当增加</li>
<li><strong>注意</strong>：副本越多，写入压力越大</li>
</ul>
<hr/>
<h2 data-id="heading-19">写在最后</h2>
<p>这些经验都是在解决实际问题中慢慢积累的。就像修路一样，开始可能只是简单铺平，随着车流量的增加，需要不断优化——设置红绿灯、划分车道、建立立交桥。使用 ES 也是同样的道理，随着业务的发展，需要不断调整和优化。</p>
<p>最大的体会是：<strong>理解原理比记住命令更重要</strong>。只有明白了为什么这样设计，才能在遇到新问题时找到合适的解决方案。</p>
<blockquote>
<p>如果有人问我："ES 怎么才能用得更好？"我的回答是："先理解业务场景，再选择技术方案。就像我们之前做的模糊搜索，不是简单地用 wildcard，而是根据 ES 版本选择最优解。"</p>
</blockquote>
<p><strong>技术的价值不在于多复杂，而在于能否优雅地解决实际问题。与大家共勉。</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[美团CatPaw：代码“撸”得飞起，AI帮你轻松实现！]]></title>    <link>https://juejin.cn/post/7570197010885247022</link>    <guid>https://juejin.cn/post/7570197010885247022</guid>    <pubDate>2025-11-09T13:53:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7570197010885247022" data-draft-id="7569976345931218995" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="美团CatPaw：代码“撸”得飞起，AI帮你轻松实现！"/> <meta itemprop="keywords" content="AIGC"/> <meta itemprop="datePublished" content="2025-11-09T13:53:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="墨风如雪"/> <meta itemprop="url" content="https://juejin.cn/user/4064249017803927"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            美团CatPaw：代码“撸”得飞起，AI帮你轻松实现！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4064249017803927/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    墨风如雪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-09T13:53:55.000Z" title="Sun Nov 09 2025 13:53:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是你们的老朋友，混迹AI编程圈多年的观察者。最近，美团在AI编程领域又搞出了大动作，推出了一款名为<strong>CatPaw</strong>的AI集成开发环境（IDE）。这可不是一般的代码辅助工具，它简直是冲着彻底改变开发者工作流去的！今天，我就带大家深入盘盘这个号称“智能伙伴”的CatPaw，看看它到底有何魔力。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2025%2F11%2FiShot_2025-11-09_21.45.02-1024x513.png" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2025/11/iShot_2025-11-09_21.45.02-1024x513.png" ref="nofollow noopener noreferrer"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2edaf0df414445b98409e428d3be0946~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763301235&amp;x-signature=9iHi8ehw5ENKRHfc2fBfKpEAKrQ%3D" alt="iShot_2025-11-09_21.45.02" loading="lazy"/></a></p>
<h3 data-id="heading-0">🐱 CatPaw：你的代码“智能伙伴”究竟是何方神圣？</h3>
<p>想象一下，你的IDE不再是冰冷的编辑器，而是一个能理解你意图、预测你需求、甚至能与你对话的智能助手。这就是CatPaw的核心愿景。它不仅是一个AI驱动的IDE，更被设计成每一位开发者的“智能伙伴”，旨在让大家从繁琐中解脱，专注于代码的灵魂——创新与实现。</p>
<p>为了让大家快速抓住重点，我整理了CatPaw的几大“杀手锏”：</p>
<h4 data-id="heading-1">一、四大绝招，提升效率不止一点点</h4>
<ol>
<li>
<p><strong>代码补全：神来之笔，无需等待</strong> 这可不是简单的字符联想，CatPaw的实时代码补全能力，是基于你当前的编码上下文进行深度理解，智能预测你可能需要的整行代码，甚至是一个完整的函数。当你按下 <code>Tab</code> 键的那一刻，就像有位资深前辈在你耳边低语，帮你瞬间完成“神来之笔”，效率直接拉满。</p>
</li>
<li>
<p><strong>问答生码：你的编程私教，随叫随到</strong> 还在为某个算法逻辑绞尽脑汁？或者对一个陌生的API感到困惑？CatPaw内置的AI助手，允许你直接用自然语言提问。无论是寻求代码片段、解释复杂概念，还是探讨解决方案，它都能即时给出回应，无需切换窗口，一个“AI编程私教”就这么随时待命。</p>
</li>
<li>
<p><strong>预览调试：前端开发者的福音，所见即所得</strong> 对于前端开发者来说， CatPaw简直是“梦中情IDE”。它内置了浏览器，支持前端代码的实时渲染和调试。这意味着你修改一行CSS，就能立刻看到效果，甚至能直接将页面元素“甩”给AI，让它帮你分析并优化，真正实现“所见即所得”的开发体验。</p>
</li>
<li>
<p><strong>项目级分析：从宏观到微观，洞察一切</strong> 这功能可就厉害了。CatPaw能够自动扫描并理解整个代码库，不仅仅是文件，而是整个项目的结构、模块依赖、潜在的重构点，甚至是潜藏的bug。特别是对于新加入项目的成员，它能像一位经验丰富的架构师，帮你快速掌握项目全貌，给出全局性的优化建议。</p>
</li>
</ol>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2025%2F11%2FiShot_2025-11-09_21.44.50-1024x659.png" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2025/11/iShot_2025-11-09_21.44.50-1024x659.png" ref="nofollow noopener noreferrer"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4fe7a4545f6b456687c6a0e661ff8e92~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763301235&amp;x-signature=UeeJ%2BM6%2B5Fgv6Y0WcZcWIE4vCIQ%3D" alt="iShot_2025-11-09_21.44.50" loading="lazy"/></a></p>
<h4 data-id="heading-2">二、深挖技术腹地：LongCat与ReAct的黑科技</h4>
<p>CatPaw之所以能有这些强大的功能，离不开美团在底层模型上的硬核实力。</p>
<p>它的核心驱动力来源于美团自研的<strong>LongCat大模型</strong>。这可不是一个泛泛而谈的模型，它是一个参数量高达5600亿的混合专家模型，支持128K tokens的超长上下文。想象一下，这意味着AI可以“读懂”你项目里更多的代码，拥有更强的“记忆力”去理解你的编码意图。LongCat还创新性地采用了“零计算专家”机制和“快捷连接MoE”架构，简单来说，就是它能智能地识别代码中的简单部分，避免不必要的计算，同时优化计算和通信的效率，从而在保证高性能的同时，大幅降低算力消耗，提升推理速度——据称单用户生成速度能超过100 tokens/s。</p>
<p>而在交互层面，CatPaw采用了<strong>ReAct框架</strong>，这让AI在多轮对话中能够保持上下文的连贯性，让你的“编程私教”越聊越懂你，对话体验自然流畅。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2025%2F11%2FiShot_2025-11-09_21.44.45-1024x597.png" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2025/11/iShot_2025-11-09_21.44.45-1024x597.png" ref="nofollow noopener noreferrer"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eb582c8465b64939a5f01cf8f60dbc85~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763301235&amp;x-signature=lAI1A1SYjGjaWqeQTwN2nkn3ao4%3D" alt="iShot_2025-11-09_21.44.45" loading="lazy"/></a></p>
<h4 data-id="heading-3">三、双生花？CatPaw与NoCode，美团的两盘大棋</h4>
<p>值得一提的是，CatPaw并非美团在AI编程领域的首次尝试。早在2025年6月，美团就推出了名为<strong>NoCode</strong>的AI编程智能体。但它们俩定位截然不同，可以说是美团在AI编程领域下的两盘精妙大棋：</p>
<ul>
<li><strong>CatPaw</strong>：定位是面向<strong>专业开发者</strong>的集成开发环境，它深入到编码的每一个细节，提供更深度的集成和智能辅助，让专业程序员如虎添翼。</li>
<li><strong>NoCode</strong>：则更偏向“<strong>氛围编程</strong>”，主要面向产品经理、运营人员等<strong>非专业程序员</strong>。通过简单的自然语言对话，他们就能快速生成应用，极大地降低了编程门槛。</li>
</ul>
<p>尽管目标用户不同，但它们都共享着美团自研的LongCat大模型这个强大基因。据美团研发负责人透露，在内部，这两款工具已经共同支持了美团超过90%的工程师使用AI编程，每周约有50%的新代码是靠AI生成的——这组数据，足以证明美团在AI编程领域的决心和成果。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2025%2F11%2FiShot_2025-11-09_21.44.21.png" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2025/11/iShot_2025-11-09_21.44.21.png" ref="nofollow noopener noreferrer"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/325c256df2fc46fb83111c7bf6fc2f1c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763301235&amp;x-signature=vT75kfpgT9RnH8lw7vV8xpDAZi8%3D" alt="iShot_2025-11-09_21.44.21" loading="lazy"/></a></p>
<h4 data-id="heading-4">四、如何“撸”到CatPaw？你的专属体验指南</h4>
<p>如果你已经心痒难耐，想立马体验这款黑科技，美团也提供了便捷的尝鲜路径：</p>
<ol>
<li><strong>下载安装</strong>：目前CatPaw已在macOS 10.15及以上平台上线，你可以访问官方网站（<a href="https://link.juejin.cn?target=https%3A%2F%2Fcatpaw.meituan.com%2F%25EF%25BC%2589%25E4%25B8%258B%25E8%25BD%25BD%25E5%25AE%2589%25E8%25A3%2585%25E5%258C%2585%25E3%2580%2582%25E5%25BD%2593%25E7%2584%25B6%25EF%25BC%258CWindows%25E7%2589%2588%25E6%259C%25AC%25E7%259A%2584%25E5%25BC%2580%25E5%258F%2591%25E8%2580%2585%25E4%25BB%25AC%25E4%25B9%259F%25E4%25B8%258D%25E8%25A6%2581%25E7%259D%2580%25E6%2580%25A5%25EF%25BC%258C%25E7%25BE%258E%25E5%259B%25A2%25E6%2589%25BF%25E8%25AF%25BAWindows%25E7%2589%2588%25E6%259C%25AC%25E5%258D%25B3%25E5%25B0%2586%25E6%258E%25A8%25E5%2587%25BA" target="_blank" title="https://catpaw.meituan.com/%EF%BC%89%E4%B8%8B%E8%BD%BD%E5%AE%89%E8%A3%85%E5%8C%85%E3%80%82%E5%BD%93%E7%84%B6%EF%BC%8CWindows%E7%89%88%E6%9C%AC%E7%9A%84%E5%BC%80%E5%8F%91%E8%80%85%E4%BB%AC%E4%B9%9F%E4%B8%8D%E8%A6%81%E7%9D%80%E6%80%A5%EF%BC%8C%E7%BE%8E%E5%9B%A2%E6%89%BF%E8%AF%BAWindows%E7%89%88%E6%9C%AC%E5%8D%B3%E5%B0%86%E6%8E%A8%E5%87%BA" ref="nofollow noopener noreferrer">catpaw.meituan.com/）下载安装包。当然，W…</a>。</li>
<li><strong>注册与额度</strong>：新用户通过手机号或邮箱注册后，即可获得<strong>500次免费对话额度</strong>。每次与AI的交互都会消耗一次额度，用完后，可在设置页提交续充申请。目前来看，它仍处于免费使用阶段。</li>
<li><strong>无缝迁移</strong>：首次启动，CatPaw支持导入VS Code或Cursor等主流IDE的现有配置，让你能够实现零成本的切换，几乎感受不到迁移的阵痛。</li>
</ol>
<h3 data-id="heading-5">写在最后：AI编程的浪潮，你准备好了吗？</h3>
<p>美团CatPaw的推出，不仅仅是一个工具的更新，更是美团“AI at Work”战略的一个缩影，它在实打实地重塑着开发流程。从内部数据来看，高达50%的AI代码生成占比和超过80%的周活跃率，都预示着AI辅助编程已经从“辅助”走向了“主导”地位。</p>
<p>所以，美团CatPaw，到底值不值得一试？我想，答案不言而喻。在这个AI编程的浪潮中，抓住先行者的机会，也许，你与代码效率的下一个飞跃，就从CatPaw开始。</p>
<p><strong>如果你也对最新的AI信息感兴趣或者有疑问 都可以加入我的大家庭 第一时间分享最新AI资讯、工具、教程、文档 欢迎你的加入！！！😉😉😉</strong></p>
<p>公众号：墨风如雪小站</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[孩子的名字有救了]]></title>    <link>https://juejin.cn/post/7569976345931235379</link>    <guid>https://juejin.cn/post/7569976345931235379</guid>    <pubDate>2025-11-09T13:57:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7569976345931235379" data-draft-id="7569909335909138441" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="孩子的名字有救了"/> <meta itemprop="keywords" content="TypeScript,AI编程,微信小程序"/> <meta itemprop="datePublished" content="2025-11-09T13:57:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="fthux"/> <meta itemprop="url" content="https://juejin.cn/user/3526889033182685"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            孩子的名字有救了
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3526889033182685/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    fthux
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-09T13:57:27.000Z" title="Sun Nov 09 2025 13:57:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">开发经历</h3>
<p>在孩子出生前很早起名字就排上了日程，当时起名字用到了各种AI，各种修改提示词，每天一有时间就点开AI，让AI吐N个名字出来，这种情况陆陆续续持续了好几个月，但始终还是没有满意的名字。后来还是回到了随机生成这条看天意的路上。看到 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fholynova%2Fgushi_namer" target="_blank" title="https://github.com/holynova/gushi_namer" ref="nofollow noopener noreferrer">gushi_namer</a> 项目后，为了便于查看，我就做了一个丑陋不堪的 <code>mvp</code> 微信小程序（名语屋的原型），基于这个原型，我最终选中了6个名字（3男3女），然后和家里的领导请示，经领导批示，最终敲定了1男1女两个名字。而其中的一个名字，正是我孩子的正式名字。</p>
<p>从我确认了孩子的正式名字后，就想把这个原型整成正式的小程序（也许也有想要靠随机来起名字的同学），但是因为各种事情的耽搁，几个月后小程序才正式上线——名语屋。作为一个没有审美的搬砖工人，<code>UI</code> 页面基本上全部由 <code>Gemini</code> 生成。具体的链接可查看<a href="#UI%E7%94%9F%E6%88%90" title="#UI%E7%94%9F%E6%88%90">UI生成部分</a>。</p>
<p>最后，希望每个兄弟姐妹叔叔阿姨都能给自己的孩子取到心怡的名字。</p>
<h2 data-id="heading-1">名语屋</h2>
<blockquote>
<p>起名小程序</p>
</blockquote>
<p>从诗经、楚辞、唐诗宋词、乐府诗集、古诗三百首、著名楚辞等古典文籍中起名字</p>
<p align="center">
  <img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1a0eb0426f8344a681aae77f13aa560f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZnRodXg=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763301528&amp;x-signature=1DAyvqKYNCIANcgf%2BOssC0a62zQ%3D" alt="小程序码" loading="lazy"/>
</p>
<h3 data-id="heading-2">特别感谢</h3>
<p>数据源来自 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fholynova%2Fgushi_namer" target="_blank" title="https://github.com/holynova/gushi_namer" ref="nofollow noopener noreferrer">gushi_namer</a>。</p>
<h3 data-id="heading-3">仓库地址</h3>
<blockquote>
<ul>
<li>github 仓库地址 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ffthux%2Fnomely" target="_blank" title="https://github.com/fthux/nomely" ref="nofollow noopener noreferrer">github.com/fthux/nomel…</a>。</li>
<li>gitee 仓库地址 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Ffthux%2Fnomely" target="_blank" title="https://gitee.com/fthux/nomely" ref="nofollow noopener noreferrer">gitee.com/fthux/nomel…</a>。</li>
</ul>
</blockquote>
<h3 data-id="heading-4">UI生成</h3>
<p><code>UI</code> 页面基本上全部由 <code>Gemini</code> 生成，小程序版本做了一些小的UI调整和适配，完整的 <code>Gemini APP</code> 实现可访问 <a href="https://link.juejin.cn?target=https%3A%2F%2Fai.studio%2Fapps%2Fdrive%2F1P7XoluwC5s7CL1xeVv8NeXWjTQ_OwvHf" target="_blank" title="https://ai.studio/apps/drive/1P7XoluwC5s7CL1xeVv8NeXWjTQ_OwvHf" ref="nofollow noopener noreferrer">Google AI Studio</a>。贴几张 <code>Gemini</code> 生成的 <code>UI</code> 和小程序实现的 <code>UI</code>：</p>
<h4 data-id="heading-5"><code>Gemini</code> 实现</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cbd6ae8212ad4192ad8c4f19410a82dd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZnRodXg=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763301528&amp;x-signature=UzyTTBTEbjCpJp1sHa9HNLUogo0%3D" alt="screenshot1.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8436234d6e2842fea295a8b4518ac0a5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZnRodXg=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763301528&amp;x-signature=91V8qewl3VSxtHhsFJpBf3MiRuc%3D" alt="screenshot2.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2aaed1f5c0c1421e816a12959bbba5ad~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZnRodXg=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763301528&amp;x-signature=8RO07k33DNbxa4vY44VCe09kNmc%3D" alt="screenshot3.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3808eeae52e6425aa232136c22641993~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZnRodXg=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763301528&amp;x-signature=kMbzFGCzHn77uAew%2FmvBdr%2FqfeI%3D" alt="screenshot4.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/82c49a290d284c31be3e7c4456e8f138~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZnRodXg=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763301528&amp;x-signature=slRvYN7F3f6oHYn0MWHeexuOiDw%3D" alt="screenshot5.png" loading="lazy"/></p>
<h4 data-id="heading-6">小程序实现</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8d333487041644c88efc0d6080ee1781~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZnRodXg=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763301528&amp;x-signature=Pcx1EuQWgsEwiCCNfxK6IQSOQfM%3D" alt="screenshot6.jpg" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/283778387a864c579a54907d2e09c3ad~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZnRodXg=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763301528&amp;x-signature=dPkT%2BC8CHPJOm6MR8%2FRgNUR2qTc%3D" alt="screenshot7.jpg" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ee374e5b98084fecb7a16c47539a83c0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZnRodXg=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763301528&amp;x-signature=7yCGUu3t7W5BxDug5jAinLVSTHg%3D" alt="screenshot8.jpg" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0e261ce7278b44508dfa17a4c6346a3d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZnRodXg=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763301528&amp;x-signature=EpKeNDhD%2BOS2dmzAHAyulFVHN3o%3D" alt="screenshot9.jpg" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b01cef5d4a8541af8e9ef4ceed1e3246~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZnRodXg=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763301528&amp;x-signature=%2F6ae%2FRarueMBcFxsDbRGfsbSC6g%3D" alt="screenshot10.jpg" loading="lazy"/></p>
<h3 data-id="heading-7">名字的意义</h3>
<blockquote>
<p>注：该部分文案由AI生成</p>
</blockquote>
<ul>
<li>一名之立，旬月踟蹰”。名字，是父母赠予孩子的第一份厚礼。我们深知其重，故潜心于诗、骚、词、赋的浩瀚文海，为您精心撷取文采斐然、寓意深远的灵感，愿每个名字都承载着经典与祝福。</li>
<li>为避常用名之普遍，并追求音律与字形之美，我们专选双字为名。与您的姓氏结合，构成和谐的三字姓名，既独特不易重复，又蕴含悠长的文化意境。</li>
</ul>
<h3 data-id="heading-8">Q&amp;A</h3>
<blockquote>
<p>注：该部分文案由AI生成</p>
</blockquote>
<ul>
<li>
<p>Question
为什么不直接用 AI 生成名字，而是让我自己挑选？</p>
</li>
<li>
<p>Answer
我们认为，AI 最强大的地方在于“博学”，而非“创造”。借助AI的能力，我们可以从浩如烟海的古典文籍中精准地检索和匹配相关的诗句，这大大提升了效率。然而，名字是情感与期望的载体，最终的选择应源自人心的触动。我们为您呈现这些蕴含美意的“璞玉”，由您亲自雕琢、赋予其独特的生命力。这既保证了名字的文化底蕴，又保留了起名过程中最宝贵的人文温度。</p>
</li>
<li>
<p>Question
为什么建议使用“姓+双字名”的组合？</p>
</li>
<li>
<p>Answer
在当代，单字名（如“李昂”）虽然简洁，但重名率相对较高。双字名（如“李思源”）不仅能有效降低重名的可能性，也为名字的音律和谐与寓意深度提供了更广阔的空间。三个字的组合在汉语发音中往往更具节奏感，读来朗朗上口，也更能承载父母对孩子的美好祝愿。</p>
</li>
<li>
<p>Question
随机“换一批”的方式会不会很麻烦？</p>
</li>
<li>
<p>Answer
我们理解您可能觉得这需要花费更多时间，但这正是我们设计的初衷。起名是一次充满喜悦的探索之旅，而非一项追求效率的任务。“换一批”的功能就像在书海中随手翻阅，每一次点击都可能带来一次与美好名字的“不期而遇”。我们相信，这个为孩子寻觅专属印记的过程本身就充满意义，而花费的时间，终将化为名字里沉甸甸的爱与祝福。</p>
</li>
<li>
<p>Question
未来会加入更多的古典文籍吗？</p>
</li>
<li>
<p>Answer
当然会！我们正持续不断地扩充我们的灵感文库，计划未来会囊括更多朝代、更多体裁的经典之作。我们的目标是打造一个最全面、最富诗意的古典文学起名宝库，陪伴每一个家庭完成这项神圣而美好的使命。敬请期待！</p>
</li>
<li>
<p>Question
可以指定生成男孩或女孩的名字吗？</p>
</li>
<li>
<p>Answer
我们特意未加入严格的性别筛选功能，原因在于中国古典文学中的许多优美词汇本身是中性的，其意境的“刚”与“柔”往往取决于搭配和个人的解读。例如，“清川”既可形容男子的俊朗，亦可描绘女子的澄澈。我们鼓励您超越固有的性别标签，用心感受每个名字背后的音韵与意象，为您未来的“他”或“她”选择一个最能触动您心弦的佳名。真正的专属，往往诞生于这份不设限的探索之中。</p>
</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Flutter 拖拉对比组件，换装图片前后对比必备]]></title>    <link>https://juejin.cn/post/7570197010885034030</link>    <guid>https://juejin.cn/post/7570197010885034030</guid>    <pubDate>2025-11-09T12:28:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7570197010885034030" data-draft-id="7568699551101075508" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Flutter 拖拉对比组件，换装图片前后对比必备"/> <meta itemprop="keywords" content="Flutter,前端,开源"/> <meta itemprop="datePublished" content="2025-11-09T12:28:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="LinXunFeng"/> <meta itemprop="url" content="https://juejin.cn/user/1820446984512392"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Flutter 拖拉对比组件，换装图片前后对比必备
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1820446984512392/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    LinXunFeng
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-09T12:28:38.000Z" title="Sun Nov 09 2025 12:28:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>欢迎关注微信公众号：<a href="https://link.juejin.cn?target=https%3A%2F%2Fp3-juejin.byteimg.com%2Ftos-cn-i-k3u1fbpfcp%2F31960a996f1f4b0da35d69ab7480f7d6~tplv-k3u1fbpfcp-zoom-1.image" target="_blank" title="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/31960a996f1f4b0da35d69ab7480f7d6~tplv-k3u1fbpfcp-zoom-1.image" ref="nofollow noopener noreferrer">FSA全栈行动</a> 👋</p>
</blockquote>
<h2 data-id="heading-0">一、前言</h2>
<p>最近一个需求，需要在 <code>photo_view</code> 中实现拖拉对比两张图片的功能，要求不影响左右翻页及缩放手势。</p>
<p>其中前后图片上需要显示一些额外的信息，所以更准确来说，要对比的是两个视图，而不单单只是图片。</p>
<p>市面上几个现有的组件库，要么只能传入 <code>Image</code>，要么只允许全屏拖拽，且无法满足我们高自定义的需要，所以我自己做了一个。</p>
<p>相应的 <code>Demo</code> 可科学上网后在线体验:
<a href="https://link.juejin.cn?target=https%3A%2F%2Flinxunfeng.github.io%2Fflutter_compare_slider%2F" target="_blank" title="https://linxunfeng.github.io/flutter_compare_slider/" ref="nofollow noopener noreferrer">linxunfeng.github.io/flutter_com…</a></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e582ebd2385247bdbfb966509bcdc5c6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTGluWHVuRmVuZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763296117&amp;x-signature=b6xhOjYJqMvCSsqTxQRu%2BLK7nRo%3D" alt="" loading="lazy"/></p>
<p>OK，接下来我们就来看看具体使用</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FLinXunFeng%2Fflutter_compare_slider" target="_blank" title="https://github.com/LinXunFeng/flutter_compare_slider" ref="nofollow noopener noreferrer">github.com/LinXunFeng/…</a></p>
<h2 data-id="heading-1">二、使用</h2>
<p>添加依赖</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">dependencies:</span>
  <span class="hljs-attr">compare_slider:</span> <span class="hljs-string">latest_version</span>
</code></pre>
<p>导入</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">import</span> <span class="hljs-string">'package:compare_slider/compare_slider.dart'</span>;
</code></pre>
<p>使用</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-built_in">double</span> value = <span class="hljs-number">0.5</span>;
<span class="hljs-built_in">double</span> thickness = <span class="hljs-number">1</span>;
<span class="hljs-built_in">bool</span> dragOnlyOnSlider = <span class="hljs-keyword">true</span>;

CompareSlider(
  <span class="hljs-comment">// 当前值 [0, 1]</span>
  value: value,
  <span class="hljs-comment">// 是否只允许在滑块区域拖拽</span>
  dragOnlyOnSlider: dragOnlyOnSlider,
  <span class="hljs-comment">// 原图视图（接收类型为 Widget，不局限于图片）</span>
  before: _buildImageView(isBefore: <span class="hljs-keyword">true</span>),
  <span class="hljs-comment">// 换装后的视图</span>
  after: _buildImageView(isBefore: <span class="hljs-keyword">false</span>),
  <span class="hljs-comment">// 分割线厚度</span>
  thickness: thickness,
  <span class="hljs-comment">// 拖拽的滑块和分割线</span>
  thumb: _buildThumb(),
  <span class="hljs-comment">// 滑块值改变时触发的回调</span>
  onValueChanged: (<span class="hljs-built_in">double</span> value) {
    <span class="hljs-keyword">this</span>.value = value;
    setState(() {});
  },
);
</code></pre>
<p>分割线与滑块</p>
<pre><code class="hljs language-dart" lang="dart">Widget _buildThumb() {
  <span class="hljs-keyword">return</span> Stack(
    clipBehavior: Clip.none,
    alignment: Alignment.center,
    children: [
      <span class="hljs-comment">// 分割线</span>
      _buildSliderLine(),
      <span class="hljs-comment">// 滑块</span>
      Positioned(
        left: -(thumbSize - thickness) / <span class="hljs-number">2</span>,
        child: _buildSliderThumb(),
      ),
    ],
  );
}

Widget _buildSliderLine() {
  <span class="hljs-keyword">return</span> Container(
    width: thickness,
    color: Colors.white.withValues(alpha: <span class="hljs-number">0.5</span>),
  );
}
</code></pre>
<p><code>thickness</code> 是分割线的宽度，传入用于提前计算其偏移量。</p>
<p><code>dragOnlyOnSlider</code> 默认为 <code>false</code>，即全区域拖动，如果设置为 <code>true</code>，则默认情况下，交互区域为 <code>_buildSliderLine()</code> 视图。</p>
<p>有时分割线的宽度较小，而你想扩大交互范围时，则可以通过 <code>extraHitTestArea</code> 来实现，结合 <code>debugHitTestAreaColor</code> 可清晰知道交互范围，如文章顶部动图中半透明红色。</p>
<p>为了不影响 <code>photo_view</code> 的缩放手势，可以在开始触摸滑块时（<code>onSliderThumbTouchBegin</code> 回调）禁用手势，在结束触摸滑块时（<code>onSliderThumbTouchEnd</code> 回调）恢复手势即可。</p>
<h2 data-id="heading-2">三、最后</h2>
<p>好了，开源不易，如果你也觉得这个库好用，请不吝给个 <code>Star</code>  👍 ，并多多支持！</p>
<p><strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FLinXunFeng%2Fflutter_compare_slider" target="_blank" title="https://github.com/LinXunFeng/flutter_compare_slider" ref="nofollow noopener noreferrer">github.com/LinXunFeng/…</a></strong></p>
<p>本篇到此结束，感谢大家的支持，我们下次再见！ 👋</p>
<blockquote>
<p>如果文章对您有所帮助, 请不吝点击关注一下我的微信公众号：<a href="https://link.juejin.cn/?target=https%3A%2F%2Fp3-juejin.byteimg.com%2Ftos-cn-i-k3u1fbpfcp%2F31960a996f1f4b0da35d69ab7480f7d6~tplv-k3u1fbpfcp-zoom-1.image" title="https://link.juejin.cn/?target=https%3A%2F%2Fp3-juejin.byteimg.com%2Ftos-cn-i-k3u1fbpfcp%2F31960a996f1f4b0da35d69ab7480f7d6~tplv-k3u1fbpfcp-zoom-1.image" target="_blank">FSA全栈行动</a>, 这将是对我最大的激励. 公众号不仅有 <code>iOS</code> 技术，还有 <code>Android</code>，<code>Flutter</code>，<code>Python</code> 等文章, 可能有你想要了解的技能知识点哦~</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[最小信息表达：从误解到深层理解的五个关键点]]></title>    <link>https://juejin.cn/post/7569959427879174154</link>    <guid>https://juejin.cn/post/7569959427879174154</guid>    <pubDate>2025-11-09T11:35:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7569959427879174154" data-draft-id="7570201730991308826" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="最小信息表达：从误解到深层理解的五个关键点"/> <meta itemprop="keywords" content="后端,架构"/> <meta itemprop="datePublished" content="2025-11-09T11:35:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="canonical_entropy"/> <meta itemprop="url" content="https://juejin.cn/user/4212984289694429"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            最小信息表达：从误解到深层理解的五个关键点
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4212984289694429/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    canonical_entropy
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-09T11:35:43.000Z" title="Sun Nov 09 2025 11:35:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>Kimi K2 Thinking的智商有了明显提高，虽然还是错误理解不断，但讲解关键点之后它表现出相当程度的总结能力。</p>
</blockquote>
<p>初次接触"最小信息表达"原则时，很容易觉得它不过是又一个"高内聚低耦合"式的抽象口号。但当我们真正尝试将其应用到日常设计中，会发现这个概念远比看起来复杂。在讨论和实践中，我注意到自己和同行们反复陷入几个典型的认知误区——急于下结论，却忽略了概念背后的深层含义。</p>
<p>这篇文章试图梳理五个最常见的误判。如果你对"最小信息表达"的原始论述感兴趣，可先阅读<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F1opDaIqojYVxRY3UEZBz1A" target="_blank" title="https://mp.weixin.qq.com/s/1opDaIqojYVxRY3UEZBz1A" ref="nofollow noopener noreferrer">《最小信息表达：软件框架设计的第一性原理》</a>，再回到这里看实践中的理解偏差如何产生。</p>
<hr/>
<h2 data-id="heading-0"><strong>误判一：把"信息方向"和"技术寿命"混为一谈</strong></h2>
<p><strong>最初想法</strong>：我觉得<code>@BizQuery</code>就算比<code>@GET</code>更贴近业务，可技术总在变，过几年它一样会变成过时包袱。</p>
<p><strong>问题所在</strong>：我错把<strong>时间维度</strong>（技术会不会过时）当成判断标准，却漏掉了更关键的<strong>空间维度</strong>（信息指向哪里）。</p>
<p><strong>底层逻辑</strong>：<code>@BizQuery</code>的价值不在于技术寿命，而在于它<strong>指向业务语义自身</strong>（内向），而非外部技术实现（外向）。即使通信方式颠覆，"查询"（无副作用、只读）这个本体论区分依然成立。它如同数学中的"质数"概念——不因为计算工具改变而改变。</p>
<p><strong>修正后的理解</strong>：判断是不是本质复杂性，别问"它会不会变"，要问"它指向哪"。指向问题域内部的，是跟业务共生的<strong>本质信息</strong>；指向解决方案外部的，是选型带来的<strong>偶发信息</strong>。这个方向性判据，是把设计从"技术驱动"拉回"业务驱动"的关键。</p>
<hr/>
<h2 data-id="heading-1"><strong>误判二：把"数学同构"当成"工程可逆"</strong></h2>
<p><strong>最初想法</strong>：我质疑"最小表达唯一性"，觉得同一业务能建构成过程或事件两种范式，且都能做到最小，转换成本很高，所以唯一性站不住脚。</p>
<p><strong>问题所在</strong>：我混淆了<strong>数学层面的同构</strong>（范畴论中函子的存在）和<strong>工程层面的便利性</strong>（转换成本能不能接受）。这是抽象洁癖的通病——在理论层面看到一致性，却选择性忽略实现层面的摩擦。</p>
<p><strong>底层逻辑</strong>：在<strong>给定范式P</strong>和<strong>判定准则C</strong>的前提下，最小表达唯一。范式选择本身是L+1层的<strong>战略决策</strong>，不是L层能推迟的细节。CDC和Flink-SQL的工业实践证明：<strong>当范式差异足够结构化时，抽象层G能把转换成本压到零</strong>，使范式选择从"架构锚点"降级为"生成器配置"。</p>
<p><strong>修正后的理解</strong>：唯一性不是静止不变的属性，而是<strong>生成器成熟度</strong>的函数。当CDC出现前，"数据库变更→事件流"是重写级工作；CDC出来后，它变成可逆的自动转换。判断一个差异是"本质"还是"偶发"，不应依赖思辨，而应看<strong>ROI</strong>：是否存在G，使<code>G(范式₁,模型) ↔ G(范式₂,模型)</code>的成本低于手动重写？存在，差异就 reversible；不存在，就是战略锚点。</p>
<hr/>
<h2 data-id="heading-2"><strong>误判三：以为"弱化上下文"等于扔掉IoC</strong></h2>
<p><strong>最初想法</strong>：我把"弱化上下文"理解成"所有依赖都得手写传递"，觉得这跟IoC的自动装配对着干。</p>
<p><strong>问题所在</strong>：我混了<strong>显式依赖</strong>和<strong>显式传递</strong>。IoC的<code>@Inject</code>本身就在显式声明依赖，只是<strong>装配过程</strong>由框架接管。我错把它跟"富上下文定位器"（比如<code>RequestContextHolder.getBean()</code>）当成一回事。</p>
<p><strong>底层逻辑</strong>：弱化上下文要求的是<strong>双重显式契约</strong>：</p>
<ul>
<li><strong>服务依赖</strong>：用IoC注入（<code>@Inject IAuthDao</code>），声明"我需要什么能力"</li>
<li><strong>环境依赖</strong>：用方法参数传递（<code>IExecutionContext</code>），声明"我在什么环境下执行"</li>
</ul>
<p>IoC和弱化上下文<strong>互相补位</strong>：前者管"能力装配"，后者管"元信息传递"。<code>IExecutionContext</code>之所以"弱化"，就因为它<strong>不含<code>getService()</code>这类方法</strong>，退化成纯数据容器。这是把依赖方向从"外向拉取框架服务"扭转为"内向接收调用者信息"的核心。</p>
<p><strong>修正后的理解</strong>：偶发复杂性的根源不在"是否自动装配"，而在"<strong>信息指向哪</strong>"。<code>@Inject IAuthDao</code>指向<strong>业务接口</strong>，是本质；<code>RequestContextHolder.getBean()</code>指向<strong>框架容器</strong>，是偶发。弱化上下文不是抛弃自动化，而是<strong>把自动化的触发器从"主动拉取"改成"被动接收"</strong>。</p>
<hr/>
<h2 data-id="heading-3"><strong>误判四：高估Δ的万能性，低估范式转换的刚性</strong></h2>
<p><strong>最初想法</strong>：我以为Δ能搞定一切演化，包括范式迁移。</p>
<p><strong>问题所在</strong>：我把可逆计算的"差量叠加"泛化成"任意变换"，忽略了Δ的<strong>代数结构限制</strong>——它擅长<strong>增删改</strong>，不擅长<strong>重写代数规则</strong>。这相当于觉得导数的线性组合能解所有微分方程。</p>
<p><strong>底层逻辑</strong>：Δ的边界很明确：<strong>处理偶发复杂性（定制、扩展、适配），不处理范式转换（重构核心代数）</strong>。从ACID到BASE，得重写补偿逻辑（Saga），这不是Δ能自动生成的——因为BASE的"最终一致性"是<strong>与ACID不兼容的语义契约</strong>，它改变了业务不变量的定义方式。</p>
<p><strong>修正后的理解</strong>：Δ和生成器G的<strong>分工不同</strong>：</p>
<ul>
<li><strong>G</strong>：处理<strong>结构化差异</strong>（过程↔事件溯源，因为状态转移图能映射成两种代码模式）</li>
<li><strong>Δ</strong>：处理<strong>非结构化噪音</strong>（客户A要字段X，客户B要字段Y）</li>
</ul>
<p>范式差异能<strong>完全形式化</strong>时，G能补上；差异涉及<strong>业务语义重定义</strong>时，得人工重构。这区分了"<strong>可逆的计算</strong>"和"<strong>可逆的演化</strong>"：前者自动，后者需要设计决策。</p>
<hr/>
<h2 data-id="heading-4"><strong>误判五：把语言工作台当成项目级成本包袱</strong></h2>
<p><strong>最初想法</strong>：看到Nop平台20万行代码，我第一反应是"这哪是轻量原则，分明是沉重负担"，怀疑它的经济性。</p>
<p><strong>问题所在</strong>：我陷在<strong>企业成本中心</strong>的短视里，把工作台当成"单个项目的脚手架"，完全没意识到这是<strong>行业级公共品</strong>。这是对新制度经济学里<strong>公共品溢出效应</strong>的无知。</p>
<p><strong>底层逻辑</strong>：语言工作台不是<strong>成本</strong>，而是<strong>战略基础设施投资</strong>，价值遵循<strong>网络效应</strong>而非线性折旧：</p>
<ol>
<li>
<p><strong>知识网络效应</strong>：每个组织贡献的DSL（比如"金融衍生品合约DSL"）变成可复用的领域词汇。Workbench一旦成为行业公地，DSL开发成本从<code>O(n)</code>线性增长降到<code>O(log n)</code>亚线性——新DSL能直接复用语法组件、调试器、IDE插件。这就像<strong>Maven Central</strong>，但粒度细化到<strong>语言构造本身</strong>。</p>
</li>
<li>
<p><strong>工具链网络效应</strong>：Workbench存在后，所有基于它的DSL<strong>自动获得完整工具链</strong>（调试、重构、版本管理）。这彻底解决了传统DSL"每做一个就得重做工具"的痛点。20万行代码的<strong>摊销对象是整个行业</strong>，不是某个项目。</p>
</li>
<li>
<p><strong>人才网络效应</strong>：Workbench成为标准后，开发者能力从"精通框架X"转向"精通构造DSL"。这种元能力<strong>跨项目、跨公司复用</strong>，带来抽象层级的永久跃迁。这正是从"汇编专家"到"高级语言程序员"的历史重演。</p>
</li>
</ol>
<p><strong>修正后的理解</strong>：语言工作台的经济学本质，是把<strong>企业内部的偶发复杂性</strong>，通过<strong>行业级基础设施</strong>，转化为<strong>可复用的本质复杂性</strong>。这不是负担，而是<strong>对全产业交易成本的结构性降低</strong>。就像<strong>云厂商投资虚拟化技术</strong>，单个企业扛不住，但社会总成本因共享而最优。</p>
<hr/>
<h2 data-id="heading-5"><strong>这些误判的根源：为什么我们总是想得太简单</strong></h2>
<p>回头一看，所有误判都源于一个共同习惯——<strong>总想在一个时间点上把事情看死</strong>。我们急于在静态层面划分"本质"和"偶发"，却忘了：</p>
<ul>
<li><strong>技术会变</strong>：今天的战略锚点，明天可能因Flink-SQL这类技术降格为配置项</li>
<li><strong>抽象会嵌套</strong>：范式选择在本层是本质，在上一层就是偶发</li>
<li><strong>熵是动态的</strong>：最小化不是一次设计，是持续的熵预算管控</li>
<li><strong>成本要分摊</strong>：算成本不该按项目，得按行业生态算总账</li>
</ul>
<p>作者提出的"<strong>分形分解+可逆计算+熵监控+公共品投资</strong>"这套组合拳，就是为了打破这种静态思维。软件设计不是雕冰雕，而是养生命体——DNA（DSL）要稳定，表现型（Δ）要能适应环境变化，进化靠<strong>生态基础设施</strong>持续供给养分。</p>
<hr/>
<h2 data-id="heading-6"><strong>理论的实际价值：一套可检验的框架</strong></h2>
<p>这套理论不是只能谈不能用的空泛哲学，它具备<strong>可证伪性</strong>：</p>
<ul>
<li><strong>核心判据</strong>：信息指向方向（业务内向 vs 技术外向）</li>
<li><strong>推导结论</strong>：SOLID统一解释、范式可延迟条件、Δ边界定理、基础设施网络效应</li>
<li><strong>实践验证</strong>：Nop平台作为可运行实例</li>
<li><strong>度量方式</strong>：熵监控提供可证伪性（拒绝重构导致系统崩溃，理论预测失败）</li>
</ul>
<p>它跟那些无法验证的"最佳实践清单"有本质区别，提供了一个<strong>从哲学到数学再到工程</strong>的闭环。我的误判暴露了翻译损耗——<strong>抽象概念需要具体判据支撑</strong>，否则就沦为各说各话。</p>
<hr/>
<h2 data-id="heading-7"><strong>对工程师的实际意义</strong></h2>
<ol>
<li><strong>检查信息方向</strong>：每写一行代码，先问"它指向业务还是技术？"</li>
<li><strong>投资生成器</strong>：重复三次以上的模式，想想值不值得建生成器G</li>
<li><strong>设置熵预算</strong>：给核心模块定个熵值上限，超标就触发重构审查</li>
<li><strong>接受范式锚点</strong>：对ACID/BASE、读写分离这类战略决策，别妄图万能抽象</li>
<li><strong>分离IoC与上下文</strong>：IoC管能力装配，上下文传纯数据</li>
<li><strong>共建Workbench</strong>：别每个团队都造DSL，<strong>像共建Linux内核那样共建行业级Workbench</strong></li>
</ol>
<hr/>
<h2 data-id="heading-8"><strong>写在最后：理论是地图，不是终点</strong></h2>
<p>这场对话让我明白：这套理论的价值不在给标准答案，而在<strong>提可检验的问题</strong>。它把软件设计从"凭感觉"变成"可计算"，让每个决策都能推演、度量、验证。</p>
<p>我的误判，恰似软件工程本身——<strong>抽象和具象之间、理想和现实之间、数学和代码之间，总有鸿沟</strong>。好理论就是帮我们在鸿沟上架桥的脚手架。桥稳不稳，不在于它永存，而在于它能否<strong>指引我们抵达更清晰的认知彼岸</strong>。</p>
<p>CDC和Flink已经证明：<strong>当范式差异足够大时，聪明人会在中间建抽象层，而非在应用层硬编码</strong>。这套理论最硬的预言，就是<strong>技术演化的这个方向</strong>：<strong>从框架臃肿走向语言精炼，从企业重复造轮走向行业共建公地</strong>。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Webpack：从构建流程到性能优化的深度探索]]></title>    <link>https://juejin.cn/post/7569960869960368174</link>    <guid>https://juejin.cn/post/7569960869960368174</guid>    <pubDate>2025-11-09T12:35:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7569960869960368174" data-draft-id="7570201730991505434" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" Webpack：从构建流程到性能优化的深度探索"/> <meta itemprop="keywords" content="Webpack,前端工程化,JavaScript"/> <meta itemprop="datePublished" content="2025-11-09T12:35:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="answerball"/> <meta itemprop="url" content="https://juejin.cn/user/209320781557531"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             Webpack：从构建流程到性能优化的深度探索
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/209320781557531/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    answerball
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-09T12:35:37.000Z" title="Sun Nov 09 2025 12:35:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{line-height:1.75;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;letter-spacing:2px;background-image:linear-gradient(90deg,rgba(50,0,0,.05) 3%,transparent 0),linear-gradient(1turn,rgba(50,0,0,.05) 3%,transparent 0);background-size:20px 20px;background-position:50%;word-break:break-word;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body h1{font-size:23px;margin-bottom:5px;font-weight:700;padding-left:10px;border-left:5px solid #773098}.markdown-body h2{font-size:19px;font-weight:700;padding-left:10px;border-left:5px solid #916dd5}.markdown-body h3{font-size:17px;font-weight:700;padding-left:10px;border-left:5px solid #d89cf6}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{font-size:14px;margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{display:block;max-width:100%;margin:1em 0;border-radius:6px;box-shadow:2px 4px 7px #999;user-select:none}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{padding:.2em .5em;font-weight:700;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;font-size:1em;color:#916dd5;word-break:break-word;overflow-x:auto;background-color:none;border-radius:2px}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;font-weight:400;font-size:.9em;padding:16px 12px;margin:0;color:#333;word-break:normal;overflow-x:auto;background:#f8f8f8;scroll-behavior:smooth}.markdown-body a{text-decoration:none;color:#916dd5;font-weight:700;border-bottom:1px solid #916dd5}.markdown-body a:active,.markdown-body a:hover{color:#773098}.markdown-body table{display:inline-block!important;font-size:14px;width:auto;max-width:100%;overflow:auto;border:1px solid #916dd5;border-collapse:collapse}.markdown-body thead{background-color:#916dd5;color:#fff;text-align:left}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px;border:1px solid #916dd5}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #d89cf6;background-color:#f4eeff}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0;line-height:26px}.markdown-body ol,.markdown-body ul{padding-left:28px;list-style-type:circle}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body b,.markdown-body strong{color:#916dd5;font-weight:700}.markdown-body b:before,.markdown-body strong:before{content:"「"}.markdown-body b:after,.markdown-body strong:after{content:"」"}.markdown-body em,.markdown-body i{color:#916dd5}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="github-gist">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fff;color:#333}.hljs-comment,.hljs-meta{color:#969896}.hljs-emphasis,.hljs-quote,.hljs-strong,.hljs-template-variable,.hljs-variable{color:#df5000}.hljs-keyword,.hljs-selector-tag,.hljs-type{color:#d73a49}.hljs-attribute,.hljs-bullet,.hljs-literal,.hljs-symbol{color:#0086b3}.hljs-name,.hljs-section{color:#63a35c}.hljs-tag{color:#333}.hljs-attr,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-id,.hljs-selector-pseudo,.hljs-title{color:#6f42c1}.hljs-addition{color:#55a532;background-color:#eaffea}.hljs-deletion{color:#bd2c00;background-color:#ffecec}.hljs-link{text-decoration:underline}.hljs-number{color:#005cc5}.hljs-string{color:#032f62}</style><p><strong>引言：为什么我们需要构建工具？</strong></p>
<p>想象一下，你正在开发一个复杂的前端应用，有几十个JavaScript文件、几十个CSS文件、各种图片和字体资源。如果手动管理这些文件的依赖关系、合并、压缩，那将是一场噩梦。这就是Webpack等构建工具诞生的原因——它们像一位细心的管家，帮我们打理前端项目中的各种资源，让开发变得高效而愉快。</p>
<p>作为前端开发领域最流行的构建工具之一，Webpack已经成为了现代Web开发不可或缺的一部分。本文将带你深入探索Webpack的构建机制，并分享一系列提升开发效率的实用技巧。</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3a3c1fcfc332450c8738452b7fcd9f3e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYW5zd2VyYmFsbA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763296537&amp;x-signature=fs9CxMtzbLXdGwebCmHIQ8%2BpNkg%3D" alt="image.png" width="50%" loading="lazy"/></p>
<h2 data-id="heading-0">一、Webpack构建流程：一场精心编排的演出</h2>
<p>Webpack的构建过程就像一场精心编排的演出，每个环节都有明确的职责和顺序。让我们揭开这场演出的幕后秘密。</p>
<h3 data-id="heading-1">1.1 初始化阶段：准备舞台</h3>
<p>一切始于参数初始化。Webpack会从配置文件（通常是webpack.config.js）和Shell命令中读取参数，然后合并这些参数，得出最终的配置。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// webpack.config.js 示例</span>
<span class="hljs-keyword">const</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">'path'</span>);

<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-attr">entry</span>: <span class="hljs-string">'./src/index.js'</span>,
  <span class="hljs-attr">output</span>: {
    <span class="hljs-attr">path</span>: path.<span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">'dist'</span>),
    <span class="hljs-attr">filename</span>: <span class="hljs-string">'bundle.js'</span>
  },
  <span class="hljs-attr">mode</span>: <span class="hljs-string">'development'</span>
};
</code></pre>
<p>在这个阶段，Webpack会初始化Compiler对象——这是整个构建过程的大脑，负责调度和执行各个构建任务。同时，所有配置的插件会被加载，并注册到对应的事件钩子上。</p>
<h3 data-id="heading-2">1.2 编译阶段：演员就位</h3>
<p>编译阶段是构建过程的核心，它又可以分为几个关键步骤：</p>
<p><strong>确定入口</strong></p>
<p>Webpack从配置的entry开始，像侦探一样追踪每一个依赖。假设我们的入口文件是这样的：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// src/index.js</span>
<span class="hljs-keyword">import</span> { utils } <span class="hljs-keyword">from</span> <span class="hljs-string">'./utils'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'./styles.css'</span>;

utils.<span class="hljs-title function_">sayHello</span>();
</code></pre>
<p>Webpack会先处理index.js，然后发现它依赖utils.js和styles.css，接着去处理这些文件，再发现这些文件的依赖...如此递归下去，最终形成一个完整的依赖图。</p>
<p><strong>编译模块</strong></p>
<p>对于每个模块，Webpack会根据配置的loader对其进行"翻译"。比如，对于CSS文件，css-loader会处理其中的@import和url()，style-loader则会将CSS注入到DOM中。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// webpack配置中的loader部分</span>
<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-attr">module</span>: {
    <span class="hljs-attr">rules</span>: [
      {
        <span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.css$/</span>,
        <span class="hljs-attr">use</span>: [<span class="hljs-string">'style-loader'</span>, <span class="hljs-string">'css-loader'</span>]
      },
      {
        <span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.js$/</span>,
        <span class="hljs-attr">use</span>: <span class="hljs-string">'babel-loader'</span>
      }
    ]
  }
};
</code></pre>
<p>这个过程就像把各种语言的书籍（不同类型的模块）翻译成统一的语言（JavaScript），让浏览器这个"读者"能够理解。</p>
<p><strong>完成模块编译</strong></p>
<p>经过loader的处理，每个模块都被转换成了浏览器能够理解的形式，同时Webpack也清晰地掌握了模块之间的依赖关系。</p>
<h3 data-id="heading-3">1.3 输出阶段：演出开始</h3>
<p><strong>输出资源</strong></p>
<p>Webpack会将相关的模块分组到不同的chunk中。比如，通过splitChunks优化，可以将第三方库单独打包：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-attr">optimization</span>: {
    <span class="hljs-attr">splitChunks</span>: {
      <span class="hljs-attr">cacheGroups</span>: {
        <span class="hljs-attr">vendor</span>: {
          <span class="hljs-attr">test</span>: <span class="hljs-regexp">/[\\/]node_modules[\\/]/</span>,
          <span class="hljs-attr">name</span>: <span class="hljs-string">'vendors'</span>,
          <span class="hljs-attr">chunks</span>: <span class="hljs-string">'all'</span>
        }
      }
    }
  }
};
</code></pre>
<p>每个chunk最终会被转换成单独的文件，加入到输出列表中。这时，插件还有最后一次机会修改输出内容。</p>
<p><strong>输出完成</strong></p>
<p>最后，Webpack根据配置的输出路径和文件名，将文件写入到文件系统中。至此，构建过程圆满完成。</p>
<h3 data-id="heading-4">1.4 插件系统：演出的特效团队</h3>
<p>Webpack的插件系统就像演出的特效团队，在特定时刻为演出增添亮点。插件通过监听Webpack在生命周期中广播的各种事件，在合适的时机执行自定义逻辑。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 一个简单的插件示例</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">MyPlugin</span> {
  <span class="hljs-title function_">apply</span>(<span class="hljs-params">compiler</span>) {
    compiler.<span class="hljs-property">hooks</span>.<span class="hljs-property">emit</span>.<span class="hljs-title function_">tap</span>(<span class="hljs-string">'MyPlugin'</span>, <span class="hljs-function">(<span class="hljs-params">compilation</span>) =&gt;</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'构建完成，准备输出资源！'</span>);
    });
  }
}

<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-title class_">MyPlugin</span>;
</code></pre>
<h2 data-id="heading-5">二、提升开发效率：Webpack的好帮手</h2>
<p>在了解了Webpack的构建流程后，让我们看看如何通过各种工具和技巧提升开发效率。</p>
<h3 data-id="heading-6">2.1 可视化工具：让构建过程一目了然</h3>
<p><strong>webpack-dashboard：构建仪表盘</strong></p>
<p>传统的命令行输出信息有限且不够直观。webpack-dashboard提供了一个全新的终端可视化界面，让你对构建状态、资源大小、错误信息等一目了然。</p>
<p>安装和使用非常简单：</p>
<pre><code class="hljs language-bash" lang="bash">npm install --save-dev webpack-dashboard
</code></pre>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// webpack.config.js</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">DashboardPlugin</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">'webpack-dashboard/plugin'</span>);

<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-comment">// ...其他配置</span>
  <span class="hljs-attr">plugins</span>: [
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">DashboardPlugin</span>()
  ]
};
</code></pre>
<p><strong>speed-measure-webpack-plugin：性能分析专家</strong></p>
<p>这个插件可以测量各个loader和插件的耗时，帮你找出构建过程中的性能瓶颈。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title class_">SpeedMeasurePlugin</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">"speed-measure-webpack-plugin"</span>);
<span class="hljs-keyword">const</span> smp = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SpeedMeasurePlugin</span>();

<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = smp.<span class="hljs-title function_">wrap</span>({
  <span class="hljs-comment">// 原来的webpack配置</span>
  <span class="hljs-attr">module</span>: {
    <span class="hljs-attr">rules</span>: [
      {
        <span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.css$/</span>,
        <span class="hljs-attr">use</span>: [<span class="hljs-string">'style-loader'</span>, <span class="hljs-string">'css-loader'</span>] <span class="hljs-comment">// 这里会显示每个loader的耗时</span>
      }
    ]
  }
});
</code></pre>
<h3 data-id="heading-7">2.2 配置管理：让配置更清晰</h3>
<p><strong>webpack-merge：配置合并利器</strong></p>
<p>在大型项目中，我们通常需要针对不同环境（开发、测试、生产）使用不同的配置。webpack-merge可以帮助我们提取公共配置，避免重复代码。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> { merge } = <span class="hljs-built_in">require</span>(<span class="hljs-string">'webpack-merge'</span>);

<span class="hljs-comment">// 公共配置</span>
<span class="hljs-keyword">const</span> commonConfig = {
  <span class="hljs-attr">entry</span>: <span class="hljs-string">'./src/index.js'</span>,
  <span class="hljs-attr">module</span>: {
    <span class="hljs-attr">rules</span>: [{
      <span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.js$/</span>,
      <span class="hljs-attr">use</span>: <span class="hljs-string">'babel-loader'</span>
    }]
  }
};

<span class="hljs-comment">// 开发环境配置</span>
<span class="hljs-keyword">const</span> devConfig = {
  <span class="hljs-attr">mode</span>: <span class="hljs-string">'development'</span>,
  <span class="hljs-attr">devtool</span>: <span class="hljs-string">'cheap-module-source-map'</span>
};

<span class="hljs-comment">// 生产环境配置  </span>
<span class="hljs-keyword">const</span> prodConfig = {
  <span class="hljs-attr">mode</span>: <span class="hljs-string">'production'</span>,
  <span class="hljs-attr">devtool</span>: <span class="hljs-string">'source-map'</span>
};

<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-function">(<span class="hljs-params">env</span>) =&gt;</span> {
  <span class="hljs-keyword">if</span> (env === <span class="hljs-string">'production'</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">merge</span>(commonConfig, prodConfig);
  }
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">merge</span>(commonConfig, devConfig);
};
</code></pre>
<h3 data-id="heading-8">2.3 热更新：开发者的福音</h3>
<p><strong>HotModuleReplacementPlugin</strong></p>
<p>热模块替换（HMR）是开发过程中极其有用的功能。它允许在运行时更新各种模块，而无需进行完全刷新，这意味着你可以在不丢失应用状态的情况下看到代码更改的效果。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> webpack = <span class="hljs-built_in">require</span>(<span class="hljs-string">'webpack'</span>);

<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-comment">// ...其他配置</span>
  <span class="hljs-attr">devServer</span>: {
    <span class="hljs-attr">hot</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 开启热更新</span>
    <span class="hljs-attr">contentBase</span>: <span class="hljs-string">'./dist'</span>
  },
  <span class="hljs-attr">plugins</span>: [
    <span class="hljs-keyword">new</span> webpack.<span class="hljs-title class_">HotModuleReplacementPlugin</span>()
  ]
};
</code></pre>
<p>对于CSS，HMR体验尤为出色 - 样式更改会立即反映在页面上。对于JavaScript，你可能需要手动处理模块更新：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">if</span> (<span class="hljs-variable language_">module</span>.<span class="hljs-property">hot</span>) {
  <span class="hljs-variable language_">module</span>.<span class="hljs-property">hot</span>.<span class="hljs-title function_">accept</span>(<span class="hljs-string">'./myModule'</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// 模块更新后的回调</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'myModule更新了！'</span>);
  });
}
</code></pre>
<h2 data-id="heading-9">三、文件指纹：精准控制缓存策略</h2>
<p>文件指纹是打包后输出文件名的后缀，用于控制浏览器缓存，是性能优化中的重要一环。</p>
<h3 data-id="heading-10">3.1 三种文件指纹策略</h3>
<p><strong>Hash：项目级别</strong></p>
<p>Hash与整个项目构建相关，只要项目文件有修改，整个项目构建的hash值就会改变。这种策略比较"粗放"，任何文件改动都会导致所有输出文件的hash变化。</p>
<p><strong>ChunkHash：代码块级别</strong></p>
<p>ChunkHash与webpack打包的chunk相关，不同的entry会生成不同的chunkhash。这种方式更为精准，只有属于同一chunk的文件发生变化时，该chunk的hash才会改变。</p>
<p><strong>ContentHash：内容级别</strong></p>
<p>ContentHash根据文件内容来定义hash，文件内容不变，contenthash就不变。这是最精确的缓存控制策略，特别适用于CSS等资源文件。</p>
<h3 data-id="heading-11">3.2 实战文件指纹配置</h3>
<p><strong>JavaScript的文件指纹</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-attr">entry</span>: {
    <span class="hljs-attr">app</span>: <span class="hljs-string">'./src/app.js'</span>,
    <span class="hljs-attr">search</span>: <span class="hljs-string">'./src/search.js'</span>
  },
  <span class="hljs-attr">output</span>: {
    <span class="hljs-attr">path</span>: path.<span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">'dist'</span>),
    <span class="hljs-attr">filename</span>: <span class="hljs-string">'[name]-[chunkhash:8].js'</span> <span class="hljs-comment">// 使用8位chunkhash</span>
  }
};
</code></pre>
<p>这样会生成类似app-a1b2c3d4.js和search-e5f6g7h8.js的文件。</p>
<p><strong>CSS的文件指纹</strong></p>
<p>CSS的文件指纹需要借助MiniCssExtractPlugin：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title class_">MiniCssExtractPlugin</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">'mini-css-extract-plugin'</span>);

<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-attr">entry</span>: {
    <span class="hljs-attr">app</span>: <span class="hljs-string">'./src/app.js'</span>,
    <span class="hljs-attr">search</span>: <span class="hljs-string">'./src/search.js'</span>
  },
  <span class="hljs-attr">output</span>: {
    <span class="hljs-attr">path</span>: path.<span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">'dist'</span>),
    <span class="hljs-attr">filename</span>: <span class="hljs-string">'[name]-[chunkhash:8].js'</span>
  },
  <span class="hljs-attr">module</span>: {
    <span class="hljs-attr">rules</span>: [
      {
        <span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.css$/</span>,
        <span class="hljs-attr">use</span>: [
          <span class="hljs-title class_">MiniCssExtractPlugin</span>.<span class="hljs-property">loader</span>, <span class="hljs-comment">// 使用MiniCssExtractPlugin的loader</span>
          <span class="hljs-string">'css-loader'</span>
        ]
      }
    ]
  },
  <span class="hljs-attr">plugins</span>: [
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">MiniCssExtractPlugin</span>({
      <span class="hljs-attr">filename</span>: <span class="hljs-string">'[name]-[contenthash:8].css'</span> <span class="hljs-comment">// 使用8位contenthash</span>
    })
  ]
};
</code></pre>
<p><strong>图片资源的文件指纹</strong></p>
<p>对于图片等静态资源，我们通常使用file-loader或url-loader来处理：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">'path'</span>);

<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-attr">entry</span>: <span class="hljs-string">'./src/index.js'</span>,
  <span class="hljs-attr">output</span>: {
    <span class="hljs-attr">filename</span>: <span class="hljs-string">'bundle.js'</span>,
    <span class="hljs-attr">path</span>: path.<span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">'dist'</span>)
  },
  <span class="hljs-attr">module</span>: {
    <span class="hljs-attr">rules</span>: [
      {
        <span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.(png|svg|jpg|gif)$/</span>,
        <span class="hljs-attr">use</span>: [
          {
            <span class="hljs-attr">loader</span>: <span class="hljs-string">'file-loader'</span>,
            <span class="hljs-attr">options</span>: {
              <span class="hljs-attr">name</span>: <span class="hljs-string">'images/[name]-[hash:8].[ext]'</span> <span class="hljs-comment">// 图片使用hash</span>
            }
          }
        ]
      }
    ]
  }
};
</code></pre>
<p>file-loader提供了丰富的占位符：</p>
<ul>
<li><code>[name]</code>：文件原名</li>
<li><code>[path]</code>：文件相对路径</li>
<li><code>[folder]</code>：文件所在文件夹</li>
<li><code>[hash]</code>：文件内容hash</li>
<li><code>[contenthash]</code>：内容hash（与hash通常相同）</li>
</ul>
<h2 data-id="heading-12">四、构建性能优化：让打包速度飞起来</h2>
<p>随着项目规模的增长，构建时间可能会成为开发效率的瓶颈。下面是一些实用的优化策略。</p>
<h3 data-id="heading-13">4.1 使用最新工具</h3>
<p>始终使用最新版本的Webpack和Node.js。每个新版本通常都会带来性能改进和新特性。Webpack 5相比Webpack 4在构建性能上有显著提升。</p>
<h3 data-id="heading-14">4.2 多进程构建</h3>
<p><strong>thread-loader</strong></p>
<p>将这个loader放在其他loader之前，其后的loader就会在单独的worker池中运行，充分利用多核CPU的优势。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-attr">module</span>: {
    <span class="hljs-attr">rules</span>: [
      {
        <span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.js$/</span>,
        <span class="hljs-attr">use</span>: [
          {
            <span class="hljs-attr">loader</span>: <span class="hljs-string">'thread-loader'</span>,
            <span class="hljs-attr">options</span>: {
              <span class="hljs-attr">workers</span>: <span class="hljs-number">2</span>, <span class="hljs-comment">// 开启2个worker</span>
            }
          },
          <span class="hljs-string">'babel-loader'</span>
        ]
      }
    ]
  }
};
</code></pre>
<p>注意：thread-loader有一定启动开销，在小型项目中可能不太划算。</p>
<h3 data-id="heading-15">4.3 优化压缩过程</h3>
<p><strong>并行压缩JavaScript</strong></p>
<p>使用TerserWebpackPlugin开启多进程并行压缩：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title class_">TerserPlugin</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">'terser-webpack-plugin'</span>);

<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-attr">optimization</span>: {
    <span class="hljs-attr">minimizer</span>: [
      <span class="hljs-keyword">new</span> <span class="hljs-title class_">TerserPlugin</span>({
        <span class="hljs-attr">parallel</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 开启多进程</span>
        <span class="hljs-attr">cache</span>: <span class="hljs-literal">true</span> <span class="hljs-comment">// 开启缓存</span>
      })
    ]
  }
};
</code></pre>
<p><strong>CSS压缩和提取</strong></p>
<p>使用MiniCssExtractPlugin配合优化器：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title class_">MiniCssExtractPlugin</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">'mini-css-extract-plugin'</span>);
<span class="hljs-keyword">const</span> <span class="hljs-title class_">CssMinimizerPlugin</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">'css-minimizer-webpack-plugin'</span>);

<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-attr">module</span>: {
    <span class="hljs-attr">rules</span>: [
      {
        <span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.css$/</span>,
        <span class="hljs-attr">use</span>: [<span class="hljs-title class_">MiniCssExtractPlugin</span>.<span class="hljs-property">loader</span>, <span class="hljs-string">'css-loader'</span>]
      }
    ]
  },
  <span class="hljs-attr">optimization</span>: {
    <span class="hljs-attr">minimizer</span>: [
      <span class="hljs-keyword">new</span> <span class="hljs-title class_">CssMinimizerPlugin</span>()
    ]
  },
  <span class="hljs-attr">plugins</span>: [<span class="hljs-keyword">new</span> <span class="hljs-title class_">MiniCssExtractPlugin</span>()]
};
</code></pre>
<h3 data-id="heading-16">4.4 图片优化</h3>
<p>使用image-webpack-loader自动压缩图片：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-attr">module</span>: {
    <span class="hljs-attr">rules</span>: [
      {
        <span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.(jpe?g|png|gif|svg)$/</span>,
        <span class="hljs-attr">use</span>: [
          {
            <span class="hljs-attr">loader</span>: <span class="hljs-string">'file-loader'</span>,
            <span class="hljs-attr">options</span>: {
              <span class="hljs-attr">name</span>: <span class="hljs-string">'images/[name]-[hash:8].[ext]'</span>
            }
          },
          {
            <span class="hljs-attr">loader</span>: <span class="hljs-string">'image-webpack-loader'</span>,
            <span class="hljs-attr">options</span>: {
              <span class="hljs-attr">mozjpeg</span>: {
                <span class="hljs-attr">progressive</span>: <span class="hljs-literal">true</span>,
                <span class="hljs-attr">quality</span>: <span class="hljs-number">65</span>
              },
              <span class="hljs-attr">optipng</span>: {
                <span class="hljs-attr">enabled</span>: <span class="hljs-literal">true</span>
              },
              <span class="hljs-attr">pngquant</span>: {
                <span class="hljs-attr">quality</span>: [<span class="hljs-number">0.65</span>, <span class="hljs-number">0.90</span>],
                <span class="hljs-attr">speed</span>: <span class="hljs-number">4</span>
              }
            }
          }
        ]
      }
    ]
  }
};
</code></pre>
<h3 data-id="heading-17">4.5 缩小打包作用域</h3>
<p>通过精确配置，减少Webpack的搜索范围，可以显著提升构建速度。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">'path'</span>);

<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-attr">resolve</span>: {
    <span class="hljs-comment">// 明确告诉webpack搜索哪些目录</span>
    <span class="hljs-attr">modules</span>: [path.<span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">'node_modules'</span>)],
    <span class="hljs-comment">// 使用别名减少查找过程</span>
    <span class="hljs-attr">alias</span>: {
      <span class="hljs-string">'@'</span>: path.<span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">'src'</span>)
    },
    <span class="hljs-comment">// 减少尝试的扩展名</span>
    <span class="hljs-attr">extensions</span>: [<span class="hljs-string">'.js'</span>, <span class="hljs-string">'.jsx'</span>, <span class="hljs-string">'.json'</span>]
  },
  <span class="hljs-attr">module</span>: {
    <span class="hljs-attr">rules</span>: [
      {
        <span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.js$/</span>,
        <span class="hljs-comment">// 只对src目录下的js文件使用babel-loader</span>
        <span class="hljs-attr">include</span>: path.<span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">'src'</span>),
        <span class="hljs-attr">use</span>: <span class="hljs-string">'babel-loader'</span>
      }
    ]
  }
};
</code></pre>
<h3 data-id="heading-18">4.6 提取公共资源</h3>
<p><strong>分离第三方库</strong></p>
<p>将不常变动的第三方库单独打包，可以利用浏览器缓存：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-attr">optimization</span>: {
    <span class="hljs-attr">splitChunks</span>: {
      <span class="hljs-attr">cacheGroups</span>: {
        <span class="hljs-attr">vendor</span>: {
          <span class="hljs-attr">test</span>: <span class="hljs-regexp">/[\\/]node_modules[\\/]/</span>,
          <span class="hljs-attr">name</span>: <span class="hljs-string">'vendors'</span>,
          <span class="hljs-attr">chunks</span>: <span class="hljs-string">'all'</span>
        }
      }
    }
  }
};
</code></pre>
<p><strong>使用CDN</strong></p>
<p>通过externals配置，将一些大型库排除在打包之外，通过CDN引入：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-attr">externals</span>: {
    <span class="hljs-attr">react</span>: <span class="hljs-string">'React'</span>,
    <span class="hljs-string">'react-dom'</span>: <span class="hljs-string">'ReactDOM'</span>
  }
};
</code></pre>
<p>然后在HTML中通过script标签引入CDN资源。</p>
<h3 data-id="heading-19">4.7 充分利用缓存</h3>
<p>缓存是提升二次构建速度的利器。</p>
<p><strong>babel-loader缓存</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-attr">module</span>: {
    <span class="hljs-attr">rules</span>: [
      {
        <span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.js$/</span>,
        <span class="hljs-attr">use</span>: {
          <span class="hljs-attr">loader</span>: <span class="hljs-string">'babel-loader'</span>,
          <span class="hljs-attr">options</span>: {
            <span class="hljs-attr">cacheDirectory</span>: <span class="hljs-literal">true</span> <span class="hljs-comment">// 开启babel缓存</span>
          }
        }
      }
    ]
  }
};
</code></pre>
<p><strong>持久化缓存</strong></p>
<p>Webpack 5提供了内置的持久化缓存：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-attr">cache</span>: {
    <span class="hljs-attr">type</span>: <span class="hljs-string">'filesystem'</span> <span class="hljs-comment">// 使用文件系统缓存</span>
  }
};
</code></pre>
<p>对于Webpack 4，可以使用hard-source-webpack-plugin：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title class_">HardSourceWebpackPlugin</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">'hard-source-webpack-plugin'</span>);

<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-attr">plugins</span>: [<span class="hljs-keyword">new</span> <span class="hljs-title class_">HardSourceWebpackPlugin</span>()]
};
</code></pre>
<h3 data-id="heading-20">4.8 Tree Shaking：消除无用代码</h3>
<p>Tree Shaking就像园丁修剪树木一样，去除代码中未被使用的部分，让最终打包体积更小。</p>
<p>ES6模块系统是Tree Shaking的基础，因为ES6模块是静态的，可以在编译时确定依赖关系。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// math.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">square</span>(<span class="hljs-params">x</span>) {
  <span class="hljs-keyword">return</span> x * x;
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">cube</span>(<span class="hljs-params">x</span>) {
  <span class="hljs-keyword">return</span> x * x * x;
}

<span class="hljs-comment">// index.js</span>
<span class="hljs-keyword">import</span> { cube } <span class="hljs-keyword">from</span> <span class="hljs-string">'./math.js'</span>; <span class="hljs-comment">// 只引入了cube</span>

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">cube</span>(<span class="hljs-number">5</span>));
</code></pre>
<p>在这个例子中，square函数不会被包含在最终的bundle中。</p>
<p>确保在package.json中设置sideEffects属性，帮助Webpack识别哪些文件有副作用：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"your-project"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"sideEffects"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-string">"*.css"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-string">"*.scss"</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h2 data-id="heading-21">五、自定义Loader和Plugin：扩展Webpack能力</h2>
<p>当Webpack内置功能无法满足需求时，我们可以通过编写自定义loader和plugin来扩展其能力。</p>
<h3 data-id="heading-22">5.1 编写Loader：模块转换器</h3>
<p>Loader就像一个翻译官，负责将各种类型的模块"翻译"成Webpack能够理解的JavaScript。</p>
<p><strong>Loader开发原则</strong></p>
<ul>
<li>单一职责：每个loader只做一件事</li>
<li>链式调用：loader支持链式调用，前一个loader的输出作为后一个loader的输入</li>
<li>模块化：确保loader输出的是JavaScript模块</li>
<li>无状态：在多次构建之间，loader不应该保留状态</li>
</ul>
<p><strong>一个简单的Loader示例</strong></p>
<p>假设我们要开发一个简单的markdown loader：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> marked = <span class="hljs-built_in">require</span>(<span class="hljs-string">'marked'</span>);

<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">source</span>) {
  <span class="hljs-comment">// 获取loader的配置选项</span>
  <span class="hljs-keyword">const</span> options = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getOptions</span>();
  
  <span class="hljs-comment">// 使用marked解析markdown</span>
  <span class="hljs-keyword">const</span> html = <span class="hljs-title function_">marked</span>(source, options);
  
  <span class="hljs-comment">// 返回JavaScript模块</span>
  <span class="hljs-keyword">return</span> <span class="hljs-string">`module.exports = <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(html)}</span>`</span>;
};
</code></pre>
<p>使用这个loader：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-attr">module</span>: {
    <span class="hljs-attr">rules</span>: [
      {
        <span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.md$/</span>,
        <span class="hljs-attr">use</span>: [
          {
            <span class="hljs-attr">loader</span>: path.<span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">'markdown-loader.js'</span>),
            <span class="hljs-attr">options</span>: {
              <span class="hljs-attr">pedantic</span>: <span class="hljs-literal">true</span>
            }
          }
        ]
      }
    ]
  }
};
</code></pre>
<p><strong>Loader工具库</strong></p>
<p>官方提供的loader-utils和schema-utils可以简化loader开发：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> { getOptions } = <span class="hljs-built_in">require</span>(<span class="hljs-string">'loader-utils'</span>);
<span class="hljs-keyword">const</span> { validate } = <span class="hljs-built_in">require</span>(<span class="hljs-string">'schema-utils'</span>);

<span class="hljs-keyword">const</span> schema = {
  <span class="hljs-attr">type</span>: <span class="hljs-string">'object'</span>,
  <span class="hljs-attr">properties</span>: {
    <span class="hljs-attr">test</span>: {
      <span class="hljs-attr">type</span>: <span class="hljs-string">'boolean'</span>
    }
  }
};

<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">source</span>) {
  <span class="hljs-keyword">const</span> options = <span class="hljs-title function_">getOptions</span>(<span class="hljs-variable language_">this</span>);
  
  <span class="hljs-comment">// 验证options是否符合schema</span>
  <span class="hljs-title function_">validate</span>(schema, options, <span class="hljs-string">'Example Loader'</span>);
  
  <span class="hljs-comment">// loader逻辑...</span>
  <span class="hljs-keyword">return</span> source;
};
</code></pre>
<h3 data-id="heading-23">5.2 编写Plugin：构建过程增强器</h3>
<p>如果说Loader处理的是单个模块，那么Plugin则是在整个构建过程中起作用，可以监听Webpack构建生命周期中的事件，在合适的时机执行自定义逻辑。</p>
<p><strong>Plugin基本结构</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyPlugin</span> {
  <span class="hljs-title function_">apply</span>(<span class="hljs-params">compiler</span>) {
    <span class="hljs-comment">// 注册钩子</span>
    compiler.<span class="hljs-property">hooks</span>.<span class="hljs-property">someHook</span>.<span class="hljs-title function_">tap</span>(<span class="hljs-string">'MyPlugin'</span>, <span class="hljs-function">(<span class="hljs-params">params</span>) =&gt;</span> {
      <span class="hljs-comment">// 插件逻辑</span>
    });
  }
}

<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-title class_">MyPlugin</span>;
</code></pre>
<p><strong>一个实用的Plugin示例</strong></p>
<p>让我们创建一个在构建完成后显示构建信息的插件：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">BuildInfoPlugin</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">options</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span> = options || {};
  }

  <span class="hljs-title function_">apply</span>(<span class="hljs-params">compiler</span>) {
    compiler.<span class="hljs-property">hooks</span>.<span class="hljs-property">done</span>.<span class="hljs-title function_">tap</span>(<span class="hljs-string">'BuildInfoPlugin'</span>, <span class="hljs-function">(<span class="hljs-params">stats</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> { compilation } = stats;
      <span class="hljs-keyword">const</span> { outputOptions } = compilation;
      
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'🎉 构建完成！'</span>);
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`📁 输出目录: <span class="hljs-subst">${outputOptions.path}</span>`</span>);
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`📦 文件数量: <span class="hljs-subst">${compilation.assets.length}</span>`</span>);
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`⏱ 构建时间: <span class="hljs-subst">${stats.endTime - stats.startTime}</span>ms`</span>);
      
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">showAssets</span>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'📄 生成文件:'</span>);
        <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(compilation.<span class="hljs-property">assets</span>).<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">assetName</span> =&gt;</span> {
          <span class="hljs-keyword">const</span> asset = compilation.<span class="hljs-property">assets</span>[assetName];
          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`   <span class="hljs-subst">${assetName}</span> (<span class="hljs-subst">${asset.size()}</span> bytes)`</span>);
        });
      }
    });
  }
}

<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-title class_">BuildInfoPlugin</span>;
</code></pre>
<p>使用这个插件：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title class_">BuildInfoPlugin</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./build-info-plugin'</span>);

<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-attr">plugins</span>: [
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">BuildInfoPlugin</span>({
      <span class="hljs-attr">showAssets</span>: <span class="hljs-literal">true</span>
    })
  ]
};
</code></pre>
<p><strong>理解Compiler和Compilation</strong></p>
<p>在Plugin开发中，有两个核心概念需要理解：</p>
<ul>
<li>compiler：代表了配置完备的Webpack环境，从启动到关闭的整个生命周期</li>
<li>compilation：代表了一次单一的构建，包含了当前的模块资源、编译生成资源、变化的文件等信息</li>
</ul>
<p><strong>常用的钩子时机</strong></p>
<ul>
<li>entryOption：处理entry配置</li>
<li>compile：开始编译</li>
<li>emit：生成资源到output目录之前</li>
<li>done：编译完成</li>
</ul>
<h2 data-id="heading-24">结语</h2>
<p>Webpack作为现代前端开发的基石，其重要性不言而喻。通过深入了解其构建流程、掌握性能优化技巧、甚至能够编写自定义的loader和plugin，我们不仅能够提升开发效率，还能更好地应对复杂项目的构建需求。</p>
<p>记住，Webpack配置没有绝对的"最佳实践"，最适合项目需求的配置就是最好的配置。希望本文能帮助你在Webpack的学习和使用道路上走得更远，让构建工具真正成为提升开发体验的利器，而不是令人头疼的负担。</p>
<p>构建愉快！</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/310f9fafebf248d2bcd0e307983f15d3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYW5zd2VyYmFsbA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763296537&amp;x-signature=hd5FmxDyvnYgqcpe4eXd1FJ9zhg%3D" alt="image.png" width="50%" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Python数据可视化：从零开始教你绘制精美雷达图]]></title>    <link>https://juejin.cn/post/7570162891142217743</link>    <guid>https://juejin.cn/post/7570162891142217743</guid>    <pubDate>2025-11-09T11:51:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7570162891142217743" data-draft-id="7569987064689410082" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Python数据可视化：从零开始教你绘制精美雷达图"/> <meta itemprop="keywords" content="前端,Python"/> <meta itemprop="datePublished" content="2025-11-09T11:51:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="烛阴"/> <meta itemprop="url" content="https://juejin.cn/user/950397795841032"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Python数据可视化：从零开始教你绘制精美雷达图
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/950397795841032/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    烛阴
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-09T11:51:35.000Z" title="Sun Nov 09 2025 11:51:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">安装必要的库</h2>
<p>我们需要安装两个核心的 Python 库：<code>matplotlib</code> 用于绘图，<code>numpy</code> 用于高效的数值计算：</p>
<pre><code class="hljs language-bash" lang="bash">pip install matplotlib numpy
</code></pre>
<h2 data-id="heading-1">绘制雷达图的核心逻辑</h2>
<p>创建雷达图的过程可以清晰地分解为以下几步，理解了这些步骤，你就能自如地应对各种定制化需求：</p>
<ol>
<li><strong>数据准备</strong>：确定雷达图需要展示的几个维度（标签），以及每个对象在这些维度上的具体数值。</li>
<li><strong>创建极坐标画布</strong>：雷达图并非画在常规的直角坐标系上，而是画在一个圆形布局的<strong>极坐标系 (Polar Coordinates)</strong> 上。</li>
<li><strong>计算角度</strong>：根据维度的数量，将 360 度的圆进行等分，确定每个维度轴线所在的角度。</li>
<li><strong>闭合图形</strong>：为了让雷达图形成一个封闭的多边形，我们需要在数据和角度列表的末尾，额外补充上第一个点的数据和角度。</li>
<li><strong>绘图与美化</strong>：在坐标系上绘制数据点连线、填充颜色、添加网格、标签、图例和标题，使图表变得完整且易于解读。</li>
</ol>
<h2 data-id="heading-2">示例代码</h2>
<p>现在，让我们用具体的代码来实现一个“篮球运动员能力对比”的雷达图。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np
<span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt

<span class="hljs-keyword">def</span> <span class="hljs-title function_">create_table_tennis_radar_chart</span>():
    <span class="hljs-string">"""
    创建一个专门用于展示乒乓球运动员六维能力数据的雷达图。
    """</span>
    <span class="hljs-comment"># 解决中文显示问题</span>
    plt.rcParams[<span class="hljs-string">'font.sans-serif'</span>] = [<span class="hljs-string">'SimHei'</span>]
    plt.rcParams[<span class="hljs-string">'axes.unicode_minus'</span>] = <span class="hljs-literal">False</span>

    <span class="hljs-comment"># 1. 定义六个维度的标签</span>
    labels = np.array([<span class="hljs-string">'力量'</span>, <span class="hljs-string">'速度'</span>, <span class="hljs-string">'技巧'</span>, <span class="hljs-string">'防守'</span>, <span class="hljs-string">'发球'</span>, <span class="hljs-string">'经验'</span>])
    n_labels = <span class="hljs-built_in">len</span>(labels)

    <span class="hljs-comment"># 2. 准备运动员的数据 (这里是假设的示例数据)</span>
    <span class="hljs-comment"># “六边形战士”的数据，各项能力非常均衡且顶尖</span>
    hex_warrior_stats = [<span class="hljs-number">98</span>, <span class="hljs-number">95</span>, <span class="hljs-number">99</span>, <span class="hljs-number">92</span>, <span class="hljs-number">96</span>, <span class="hljs-number">100</span>]
    <span class="hljs-comment"># “进攻型选手”的数据，力量和速度突出，防守相对是短板</span>
    attacker_stats = [<span class="hljs-number">100</span>, <span class="hljs-number">98</span>, <span class="hljs-number">85</span>, <span class="hljs-number">75</span>, <span class="hljs-number">90</span>, <span class="hljs-number">80</span>]

    <span class="hljs-comment"># 3. 计算角度 (360度/6)</span>
    angles = np.linspace(<span class="hljs-number">0</span>, <span class="hljs-number">2</span> * np.pi, n_labels, endpoint=<span class="hljs-literal">False</span>)

    <span class="hljs-comment"># 4. 闭合图形数据</span>
    hex_warrior_stats_closed = np.concatenate((hex_warrior_stats, [hex_warrior_stats[<span class="hljs-number">0</span>]]))
    attacker_stats_closed = np.concatenate((attacker_stats, [attacker_stats[<span class="hljs-number">0</span>]]))
    angles_closed = np.concatenate((angles, [angles[<span class="hljs-number">0</span>]]))

    <span class="hljs-comment"># 5. 绘图</span>
    fig, ax = plt.subplots(figsize=(<span class="hljs-number">8</span>, <span class="hljs-number">8</span>), subplot_kw=<span class="hljs-built_in">dict</span>(polar=<span class="hljs-literal">True</span>))

    <span class="hljs-comment"># 设置坐标轴范围</span>
    ax.set_ylim(<span class="hljs-number">0</span>, <span class="hljs-number">105</span>)

    <span class="hljs-comment"># 绘制“六边形战士”</span>
    ax.plot(angles_closed, hex_warrior_stats_closed, <span class="hljs-string">'o-'</span>, color=<span class="hljs-string">'gold'</span>, linewidth=<span class="hljs-number">2</span>, label=<span class="hljs-string">'“六边形战士”'</span>)
    ax.fill(angles_closed, hex_warrior_stats_closed, <span class="hljs-string">'gold'</span>, alpha=<span class="hljs-number">0.25</span>)

    <span class="hljs-comment"># 绘制“进攻型选手”</span>
    ax.plot(angles_closed, attacker_stats_closed, <span class="hljs-string">'o-'</span>, color=<span class="hljs-string">'red'</span>, linewidth=<span class="hljs-number">2</span>, label=<span class="hljs-string">'进攻型选手'</span>)
    ax.fill(angles_closed, attacker_stats_closed, <span class="hljs-string">'red'</span>, alpha=<span class="hljs-number">0.25</span>)

    <span class="hljs-comment"># 6. 美化图表</span>
    <span class="hljs-comment"># 设置维度标签</span>
    ax.set_thetagrids(angles * <span class="hljs-number">180</span> / np.pi, labels, fontsize=<span class="hljs-number">14</span>)

    <span class="hljs-comment"># 设置半径刻度标签</span>
    ax.set_rlabel_position(<span class="hljs-number">0</span>)
    ax.set_yticklabels([<span class="hljs-string">''</span>, <span class="hljs-string">'20'</span>, <span class="hljs-string">'40'</span>, <span class="hljs-string">'60'</span>, <span class="hljs-string">'80'</span>, <span class="hljs-string">'100'</span>], color=<span class="hljs-string">"grey"</span>, size=<span class="hljs-number">10</span>)

    <span class="hljs-comment"># 添加标题和图例</span>
    plt.title(<span class="hljs-string">'乒乓球运动员能力对比雷达图'</span>, size=<span class="hljs-number">22</span>, color=<span class="hljs-string">'black'</span>, y=<span class="hljs-number">1.1</span>)
    plt.legend(loc=<span class="hljs-string">'best'</span>, bbox_to_anchor=(<span class="hljs-number">1.1</span>, <span class="hljs-number">1.1</span>), fontsize=<span class="hljs-number">12</span>)

    <span class="hljs-comment"># 显示网格</span>
    ax.grid(<span class="hljs-literal">True</span>, linestyle=<span class="hljs-string">'--'</span>, linewidth=<span class="hljs-number">0.5</span>, color=<span class="hljs-string">'gray'</span>)
    
    <span class="hljs-comment"># 显示图表</span>
    plt.show()

<span class="hljs-comment"># --- 主程序入口 ---</span>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    create_table_tennis_radar_chart()

</code></pre>
<p><strong>解析：</strong></p>
<ol>
<li><strong><code>plt.rcParams</code> 设置</strong>：这两行是为了确保 Matplotlib 可以正确显示中文字符。如果你不设置，图表中的中文可能会显示为方框。你需要确保你的系统中有 <code>SimHei</code> (黑体) 或其他中文字体。</li>
<li><strong><code>np.linspace(0, 2 * np.pi, n_labels, endpoint=False)</code></strong>：这是创建角度数组的核心。它在 0 到 360 度（<code>2*np.pi</code>）之间，生成 <code>n_labels</code> 个等分的角度值。<code>endpoint=False</code>参数是关键，它避免了 360 度和 0 度重合。</li>
<li><strong><code>np.concatenate()</code></strong>：这个 NumPy 函数用于连接数组。我们用它将第一个数据点和第一个角度值拼接到数组的末尾，从而实现图形的闭合。</li>
<li><strong><code>subplot_kw=dict(polar=True)</code></strong>：在创建子图（<code>ax</code>）时，这个参数告诉 Matplotlib：“我想要的不是普通的直角坐标系，而是一个极坐标系”。</li>
<li><strong><code>ax.plot()</code> 和 <code>ax.fill()</code></strong>：<code>plot</code> 负责画出数据的轮廓线，而 <code>fill</code> 则为这个轮廓区域填充上带有一定透明度（<code>alpha</code>）的颜色，使得重叠区域也能清晰可见。</li>
<li><strong><code>ax.set_thetagrids()</code></strong>：这个函数专门用于在极坐标上设置角度网格线（也就是我们的维度轴）的位置和显示的标签。它需要将弧度制的 <code>angles</code> 转换为角度制 (<code>angles * 180 / np.pi</code>)。</li>
</ol>
<h2 data-id="heading-3">效果</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/10aaa8b00d294dc782105344ffe322da~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54Ob6Zi0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763293895&amp;x-signature=0J%2FQ36R5yUT%2B8KfxW2hMM40ubQk%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-4">结语</h2>
<p><strong>点个赞，关注我获取更多实用 Python 技术干货！如果觉得有用，记得收藏本文！</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[提升页面质感：CSS 重复格子背景的实用技巧]]></title>    <link>https://juejin.cn/post/7569904733717233683</link>    <guid>https://juejin.cn/post/7569904733717233683</guid>    <pubDate>2025-11-08T13:36:31.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7569904733717233683" data-draft-id="7569904733717200915" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="提升页面质感：CSS 重复格子背景的实用技巧"/> <meta itemprop="keywords" content="前端,CSS"/> <meta itemprop="datePublished" content="2025-11-08T13:36:31.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="elvinnn"/> <meta itemprop="url" content="https://juejin.cn/user/3685218705479655"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            提升页面质感：CSS 重复格子背景的实用技巧
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3685218705479655/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    elvinnn
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-08T13:36:31.000Z" title="Sat Nov 08 2025 13:36:31 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">重复格子背景</h2>
<p>最近发现不少开发类的网站都在首页使用上了重复格子的背景，例如下图中左侧以 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.relay.app%2F" target="_blank" title="https://www.relay.app/" ref="nofollow noopener noreferrer">relay.app</a> 为例子的截图。</p>
<p>这种背景主要是为了在现在大量留白的设计风格下，避免页面过于空旷，增加一些视觉上的丰富性，不然就会如下图中右侧的截图那样在去掉背景后略显单调。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fa77e2c23c3843f7a7fd06e986be9e5d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZWx2aW5ubg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763213791&amp;x-signature=Dmkn7YgpO41EqYPao8adgu1qN6c%3D" alt="背景有无效果对比" loading="lazy"/></p>
<p>接下来具体讲一讲如何用 CSS 实现这种重复格子背景，主要有两种方法：</p>
<ul>
<li>局部格子图片 + 背景重复</li>
<li>CSS 渐变 + 背景重复（推荐）</li>
</ul>
<h3 data-id="heading-1">方法一：局部格子图片 + 背景重复</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.relay.app%2F" target="_blank" title="https://www.relay.app/" ref="nofollow noopener noreferrer">relay.app</a> 使用的就是这种方法，这应该是最常见也是最容易想到的方法，就是先准备一张格子图片，例如：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5517052d65e24a4fb4647cb6799c099b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZWx2aW5ubg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763213791&amp;x-signature=6eoqNwhWqxTiSaP5S7FFYDremmA%3D" alt="格子图片" loading="lazy"/></p>
<p>然后通过 <code>background</code> 相关属性进行设置即可，关键在于：</p>
<ul>
<li><code>background-repeat</code> 需要设置为 <code>repeat</code>，保证图片的重复。</li>
<li><code>background-size</code> 可用于调整背景中格子的密度。</li>
</ul>
<pre><code class="hljs language-css" lang="css"><span class="hljs-attribute">background-image</span>: <span class="hljs-built_in">url</span>(<span class="hljs-string">https://framerusercontent.com/images/9c47fOR3CNoSsEtr6IEYJoKM.svg?width=126&amp;height=126</span>);
<span class="hljs-attribute">background-size</span>: <span class="hljs-number">63px</span> auto;
<span class="hljs-attribute">background-repeat</span>: repeat;
<span class="hljs-attribute">background-position</span>: left top;
</code></pre>
<p>下面是一个前端组件使用后的效果示例 (访问 <a href="https://link.juejin.cn?target=https%3A%2F%2Felvinn.wiki%2Fcss%2Fbox-background.html" target="_blank" title="https://elvinn.wiki/css/box-background.html" ref="nofollow noopener noreferrer">我的博客</a> 可以进行交互式体验）：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5d559a2ed3cf487f93280030b9bea588~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZWx2aW5ubg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763213791&amp;x-signature=xroPCRgIcllINNCHNHdZMfzM7cs%3D" alt="SVG 图片实现效果" loading="lazy"/></p>
<h3 data-id="heading-2">方法二：CSS 渐变 + 背景重复（推荐）</h3>
<p>我们还可以通过 CSS 渐变来替代方法一中依赖的外部图片资源，从而实现更快的加载和更灵活的控制，一个简单的例子如下：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-attribute">background-image</span>:
    <span class="hljs-built_in">linear-gradient</span>(to right, <span class="hljs-built_in">rgba</span>(<span class="hljs-number">59</span>, <span class="hljs-number">130</span>, <span class="hljs-number">246</span>, <span class="hljs-number">0.08</span>) <span class="hljs-number">1px</span>, transparent <span class="hljs-number">1px</span>),
    <span class="hljs-built_in">linear-gradient</span>(to bottom, <span class="hljs-built_in">rgba</span>(<span class="hljs-number">59</span>, <span class="hljs-number">130</span>, <span class="hljs-number">246</span>, <span class="hljs-number">0.08</span>) <span class="hljs-number">1px</span>, transparent <span class="hljs-number">1px</span>);
<span class="hljs-attribute">background-size</span>: <span class="hljs-number">40px</span> <span class="hljs-number">40px</span>;
<span class="hljs-attribute">transform</span>: <span class="hljs-built_in">rotate</span>(-<span class="hljs-number">3deg</span>) <span class="hljs-built_in">scale</span>(<span class="hljs-number">1.2</span>);
</code></pre>
<p>代码的关键在于：</p>
<ul>
<li>通过 <code>linear-gradient</code> 创建一个只有1px宽度的渐变条，颜色为 <code>rgba(59, 130, 246, 0.08)</code> 的部分占 1px，其余部分透明，<code>to right</code> 控制竖向的线条，<code>to bottom</code> 控制横向的线条。</li>
<li>通过 <code>background-size</code> 控制格子的大小。</li>
<li>通过 <code>transform</code> 可以制造倾斜的效果，更加有趣一些。</li>
</ul>
<p>下面是一个前端组件使用后的效果示例 (访问 <a href="https://link.juejin.cn?target=https%3A%2F%2Felvinn.wiki%2Fcss%2Fbox-background.html" target="_blank" title="https://elvinn.wiki/css/box-background.html" ref="nofollow noopener noreferrer">我的博客</a> 可以进行交互式体验）：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/14545005ee3c4020a5baf94de8bd7ae0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZWx2aW5ubg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763213791&amp;x-signature=87xjkKA1gYCDCwcqMmebEeVk0rQ%3D" alt="CSS 渐变实现效果" loading="lazy"/></p>
<p>我最近开发的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fjtool.dev%2F" target="_blank" title="https://jtool.dev/" ref="nofollow noopener noreferrer">JTool.dev</a> 首页就是通过方法二实现的效果，也欢迎大家体验：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/091a65b11138430fb49297b84e369aae~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZWx2aW5ubg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763213791&amp;x-signature=LzbTxNKu%2B1LTTrYDcPpBanSSsUU%3D" alt="JTool.dev 首页截图" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[使用 Hardhat V3 框架构建智能合约项目全指南]]></title>    <link>https://juejin.cn/post/7570239631847112738</link>    <guid>https://juejin.cn/post/7570239631847112738</guid>    <pubDate>2025-11-09T09:56:12.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7570239631847112738" data-draft-id="7570247858869272628" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="使用 Hardhat V3 框架构建智能合约项目全指南"/> <meta itemprop="keywords" content="web3,智能合约,Solidity"/> <meta itemprop="datePublished" content="2025-11-09T09:56:12.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="木西"/> <meta itemprop="url" content="https://juejin.cn/user/2436173496845549"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            使用 Hardhat V3 框架构建智能合约项目全指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2436173496845549/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    木西
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-09T09:56:12.000Z" title="Sun Nov 09 2025 09:56:12 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<blockquote>
<p>本文详细介绍如何使用 Hardhat V3 框架从零开始构建智能合约项目，涵盖合约的开发、测试、部署全流程，以及开发过程中常见问题的解决方法。</p>
</blockquote>
<h2 data-id="heading-1">项目构建</h2>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 创建项目文件夹</span>
  <span class="hljs-built_in">mkdir</span> hardhat-example
<span class="hljs-comment"># 进入项目文件夹</span>
  <span class="hljs-built_in">cd</span> hardhat-example
<span class="hljs-comment"># hardhat初始化</span>
  npx hardhat --init
<span class="hljs-comment"># 按照提示进行模板选择和项目构建</span>
<span class="hljs-comment"># 构建成功</span>
</code></pre>
<h2 data-id="heading-2">项目目录</h2>
<pre><code class="hljs language-arduino" lang="arduino">hardhat-example/
├── contracts/
│   └── Counter.sol            <span class="hljs-comment">// 示例智能合约</span>
├── test/
│   └── Counter.test.ts        <span class="hljs-comment">// 测试文件</span>
├── ignition/
│   └── modules/
│       └── Counter.ts         <span class="hljs-comment">// Ignition部署模块</span>
├── scripts/
│   └── interact.ts            <span class="hljs-comment">// 交互脚本</span>
├── hardhat.config.ts          <span class="hljs-comment">// Hardhat配置文件</span>
├── package.json               <span class="hljs-comment">// 项目依赖</span>
└── .env                       <span class="hljs-comment">// 环境变量（需gitignore）</span>
</code></pre>
<h2 data-id="heading-3">常用指令</h2>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 获取所有指令</span>
npx hardhat

<span class="hljs-comment"># 在 Hardhat Network 上启动 JSON-RPC 服务器</span>
npx hardhat node 

<span class="hljs-comment"># 编译合约（两种等价方式）</span>
npx hardhat build
npx hardhat compile

<span class="hljs-comment"># 清空缓存并删除所有编译产物</span>
npx hardhat clean

<span class="hljs-comment"># 测试合约 </span>
npx hardhat <span class="hljs-built_in">test</span> //测试所有的合约
npx hardhat <span class="hljs-built_in">test</span> ./test/xxx.ts//测试指定的合约

<span class="hljs-comment"># 编译项目后运行用户自定义脚本快速部署不止是部署（快速验证）</span>
npx hardhat run 
npx hardhat run  ./scripts/xxx.ts

<span class="hljs-comment"># 部署（Hardhat 2.0+ 的现代部署标准）</span>
npx hardhat ignition deploy ignition/modules/xxx.ts --network sepolia

<span class="hljs-comment"># 然后使用公共网络验证</span>
npx hardhat verify &lt;已部署地址&gt; --network sepolia//验证sepolia链

<span class="hljs-comment"># 扁平化并打印合约及其依赖项 =&gt;展平并保存到文件</span>
npx hardhat flatten contracts/YourContract.sol &gt; flattened.sol
</code></pre>
<h2 data-id="heading-4">常见问题解决</h2>
<h5 data-id="heading-5">问题描述：<code>项目构建后执行指令时卡在 "Downloading solc 0.8.28"，通常是由于网络问题导致 Solidity 编译器下载失败。</code></h5>
<h5 data-id="heading-6">解决方法：手动下载 solc 并指定路径</h5>
<ol>
<li>
<p><strong>手动下载安装solc</strong>：根据操作系统下载对应二进制文件<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fethereum%2Fsolidity%2Freleases%2Ftag%2Fv0.8.28" target="_blank" title="https://github.com/ethereum/solidity/releases/tag/v0.8.28" ref="nofollow noopener noreferrer">solc releases安装包</a>并安装</p>
</li>
<li>
<p><strong>找到安装路径</strong></p>
<p>通过命令提示符（CMD）</p>
<pre><code class="hljs language-sql" lang="sql">按 Win <span class="hljs-operator">+</span> R，输入 cmd，回车
输入指令：<span class="hljs-keyword">start</span> <span class="hljs-operator">%</span>LOCALAPPDATA<span class="hljs-operator">%</span>\hardhat<span class="hljs-operator">-</span>nodejs\Cache\compilers<span class="hljs-operator">-</span>v3\windows<span class="hljs-operator">-</span>amd64\
</code></pre>
</li>
<li>
<p><strong>配置 Hardhat 使用本地 solc</strong>：</p>
<ul>
<li>在<code>hardhat.config.js</code>中指定本地 solc 路径：</li>
</ul>
<pre><code class="hljs language-php" lang="php">export <span class="hljs-keyword">default</span> <span class="hljs-title function_ invoke__">defineConfig</span>({
  <span class="hljs-attr">plugins</span>: [hardhatToolboxViemPlugin],
  <span class="hljs-attr">solidity</span>: {
    <span class="hljs-attr">profiles</span>: {
      <span class="hljs-attr">default</span>: {
        <span class="hljs-attr">version</span>: <span class="hljs-string">"0.8.28"</span>,
      },
      <span class="hljs-attr">production</span>: {
        <span class="hljs-attr">version</span>: <span class="hljs-string">"0.8.28"</span>,
        <span class="hljs-attr">settings</span>: {
          <span class="hljs-attr">solc</span>:{
          //绝对路径
          <span class="hljs-attr">path</span>: <span class="hljs-string">"C:/Users/用户名/AppData/Local/hardhat-nodejs/Cache/compilers-v3/windows-amd64/tmp-solc-windows-amd64-v0.8.28+commit.7893614a.exe"</span>,
          },
          <span class="hljs-attr">optimizer</span>: {
            <span class="hljs-attr">enabled</span>: <span class="hljs-literal">true</span>,
            <span class="hljs-attr">runs</span>: <span class="hljs-number">200</span>,
          },
        },
      },
    },
  },

 其他配置
  }
</code></pre>
<h5 data-id="heading-7">特殊说明：<code>关于以上hardhat.config.js配置或导致执行npx hardhat ignition deploy --network localhost ignition/modules/Counter.ts 执行失败</code></h5>
<h5 data-id="heading-8">部署问题修复：</h5>
<pre><code class="hljs language-css" lang="css">// 注释掉solc路径配置
把以上配置 production: {
    version: <span class="hljs-string">"0.8.28"</span>,
    settings: {
      // solc:{
      // path: <span class="hljs-string">"xxx.exe"</span>,
      // },
      optimizer: {
        enabled: true,
        runs: <span class="hljs-number">200</span>,
      },
    },
  },
</code></pre>
</li>
</ol>
<h2 data-id="heading-9">实操案例</h2>
<h5 data-id="heading-10">合约开发：ERC20 代币合约</h5>
<p>基于 OpenZeppelin 实现一个带 mint 和 burn 功能的 ERC20 代币：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// SPDX-License-Identifier: MIT</span>
<span class="hljs-comment">// Compatible with OpenZeppelin Contracts ^5.5.0</span>
pragma solidity ^<span class="hljs-number">0.8</span><span class="hljs-number">.27</span>;

<span class="hljs-keyword">import</span> {<span class="hljs-title class_">ERC20</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">"@openzeppelin/contracts/token/ERC20/ERC20.sol"</span>;
<span class="hljs-keyword">import</span> {<span class="hljs-title class_">ERC20Burnable</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">"@openzeppelin/contracts/token/ERC20/extensions/ERC20Burnable.sol"</span>;
<span class="hljs-keyword">import</span> {<span class="hljs-title class_">ERC20Permit</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">"@openzeppelin/contracts/token/ERC20/extensions/ERC20Permit.sol"</span>;
<span class="hljs-keyword">import</span> {<span class="hljs-title class_">Ownable</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">"@openzeppelin/contracts/access/Ownable.sol"</span>;

contract <span class="hljs-title class_">BoykaYuriToken</span> is <span class="hljs-title class_">ERC20</span>, <span class="hljs-title class_">ERC20Burnable</span>, <span class="hljs-title class_">Ownable</span>, <span class="hljs-title class_">ERC20Permit</span> {
    <span class="hljs-title function_">constructor</span>(<span class="hljs-params">address recipient, address initialOwner</span>)
        <span class="hljs-title class_">ERC20</span>(<span class="hljs-string">"BoykaYuriToken"</span>, <span class="hljs-string">"BTK"</span>)
        <span class="hljs-title class_">Ownable</span>(initialOwner)
        <span class="hljs-title class_">ERC20Permit</span>(<span class="hljs-string">"BoykaYuriToken"</span>)
    {
        <span class="hljs-title function_">_mint</span>(recipient, <span class="hljs-number">1000000</span> * <span class="hljs-number">10</span> ** <span class="hljs-title function_">decimals</span>());
    }

    <span class="hljs-keyword">function</span> <span class="hljs-title function_">mint</span>(<span class="hljs-params">address to, uint256 amount</span>) public onlyOwner {
        <span class="hljs-title function_">_mint</span>(to, amount);
    }
}
# 编译指令
# npx hardhat compile
</code></pre>
<h5 data-id="heading-11">合约测试</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> assert <span class="hljs-keyword">from</span> <span class="hljs-string">"node:assert/strict"</span>;
<span class="hljs-keyword">import</span> { describe, it } <span class="hljs-keyword">from</span> <span class="hljs-string">"node:test"</span>;

<span class="hljs-keyword">import</span> { network } <span class="hljs-keyword">from</span> <span class="hljs-string">"hardhat"</span>;
<span class="hljs-title function_">describe</span>(<span class="hljs-string">"MyToken"</span>, <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) { 
    <span class="hljs-title function_">it</span>(<span class="hljs-string">"Should deploy the contract"</span>, <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
        <span class="hljs-keyword">const</span> { viem } = <span class="hljs-keyword">await</span> network.<span class="hljs-title function_">connect</span>();
        <span class="hljs-keyword">const</span> publicClient = <span class="hljs-keyword">await</span> viem.<span class="hljs-title function_">getPublicClient</span>();
        <span class="hljs-keyword">const</span> [owner] = <span class="hljs-keyword">await</span> viem.<span class="hljs-title function_">getWalletClients</span>();<span class="hljs-comment">//获取第一个钱包客户端</span>
        <span class="hljs-keyword">const</span> deployerAddress = owner.<span class="hljs-property">account</span>.<span class="hljs-property">address</span>;<span class="hljs-comment">//钱包地址</span>
        <span class="hljs-keyword">const</span> contract = <span class="hljs-keyword">await</span> viem.<span class="hljs-title function_">deployContract</span>(<span class="hljs-string">"BoykaYuriToken"</span>, [deployerAddress, deployerAddress]);<span class="hljs-comment">//部署合约</span>
        assert.<span class="hljs-title function_">ok</span>(contract.<span class="hljs-property">address</span>); <span class="hljs-comment">//断言合约地址存在</span>
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Contract deployed at:"</span>, contract.<span class="hljs-property">address</span>);
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"合约所有者:"</span>, deployerAddress);
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"代币名:"</span>, <span class="hljs-keyword">await</span> publicClient.<span class="hljs-title function_">readContract</span>({
            <span class="hljs-attr">address</span>: contract.<span class="hljs-property">address</span>,
            <span class="hljs-attr">abi</span>: contract.<span class="hljs-property">abi</span>,
            <span class="hljs-attr">functionName</span>: <span class="hljs-string">"name"</span>,
        }));
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"代币符号:"</span>, <span class="hljs-keyword">await</span> publicClient.<span class="hljs-title function_">readContract</span>({
            <span class="hljs-attr">address</span>: contract?.<span class="hljs-property">address</span>,
            <span class="hljs-attr">abi</span>: contract?.<span class="hljs-property">abi</span>,
            <span class="hljs-attr">functionName</span>: <span class="hljs-string">"symbol"</span>,
        }));
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"合约总供应量:"</span>, <span class="hljs-keyword">await</span> publicClient.<span class="hljs-title function_">readContract</span>({
            <span class="hljs-attr">address</span>: contract.<span class="hljs-property">address</span>,
            <span class="hljs-attr">abi</span>: contract.<span class="hljs-property">abi</span>,
            <span class="hljs-attr">functionName</span>: <span class="hljs-string">"totalSupply"</span>,
        }));
    })
})
# 测试指令
# npx gardhat test test/xx.<span class="hljs-property">ts</span>
</code></pre>
<h5 data-id="heading-12">合约部署</h5>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// scripts/deploy.js</span>
import { network, artifacts } <span class="hljs-keyword">from</span> <span class="hljs-string">"hardhat"</span>;

<span class="hljs-function"><span class="hljs-keyword">async</span> function <span class="hljs-title">main</span>()</span> {
  <span class="hljs-comment">// 连接网络</span>
  <span class="hljs-keyword">const</span> { viem } = <span class="hljs-keyword">await</span> network.connect({ network: network.name });
  
  <span class="hljs-comment">// 获取客户端</span>
  <span class="hljs-keyword">const</span> [deployer] = <span class="hljs-keyword">await</span> viem.getWalletClients();
  <span class="hljs-keyword">const</span> publicClient = <span class="hljs-keyword">await</span> viem.getPublicClient();

  <span class="hljs-comment">// 加载合约</span>
  <span class="hljs-keyword">const</span> artifact = <span class="hljs-keyword">await</span> artifacts.readArtifact(<span class="hljs-string">"BoykaYuriToken"</span>);

  <span class="hljs-comment">// 部署（构造函数参数：recipient, initialOwner）</span>
  <span class="hljs-keyword">const</span> hash = <span class="hljs-keyword">await</span> deployer.deployContract({
    abi: artifact.abi,
    bytecode: artifact.bytecode,
    args: [process.env.RECIPIENT, process.env.OWNER],<span class="hljs-comment">//参数1，参数2</span>
  });

  <span class="hljs-comment">// 等待确认并打印地址</span>
  <span class="hljs-keyword">const</span> receipt = <span class="hljs-keyword">await</span> publicClient.waitForTransactionReceipt({ hash });
  console.log(<span class="hljs-string">"TOKEN合约地址"</span>,receipt.contractAddress);
}

main().<span class="hljs-keyword">catch</span>(console.error);
<span class="hljs-meta"># 部署指令</span>
<span class="hljs-meta"># npx hardhat run scripts/xxx.ts</span>
</code></pre>
<h2 data-id="heading-13">总结</h2>
<p>本文完整介绍了使用 Hardhat V3 框架从项目初始化到合约开发、测试、部署的全流程，并提供了常见问题的解决方案。通过本文的指导，你可以快速搭建起一个可靠的智能合约开发环境并完成基础的合约开发工作。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[类比前端知识来学习Java的Spring Boot实现MySql的全栈CRUD功能——搭配Svelte+Vite]]></title>    <link>https://juejin.cn/post/7569976345930563635</link>    <guid>https://juejin.cn/post/7569976345930563635</guid>    <pubDate>2025-11-09T09:49:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7569976345930563635" data-draft-id="7568630130022613043" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="类比前端知识来学习Java的Spring Boot实现MySql的全栈CRUD功能——搭配Svelte+Vite"/> <meta itemprop="keywords" content="Spring Boot,Svelte"/> <meta itemprop="datePublished" content="2025-11-09T09:49:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="水冗水孚"/> <meta itemprop="url" content="https://juejin.cn/user/1406974769508679"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            类比前端知识来学习Java的Spring Boot实现MySql的全栈CRUD功能——搭配Svelte+Vite
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1406974769508679/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    水冗水孚
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-09T09:49:33.000Z" title="Sun Nov 09 2025 09:49:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><h2 data-id="heading-0">前言</h2>
<ul>
<li>本文梳理了后端的相关操作流程环节</li>
<li>使用Svelte+Vite（前端）搭配<a href="https://link.juejin.cn?target=https%3A%2F%2Fspringdoc.cn%2Fspring-boot%2F" target="_blank" title="https://springdoc.cn/spring-boot/" ref="nofollow noopener noreferrer">Spring Boot</a>（后端）</li>
<li>实现了一个增删改查全栈项目</li>
<li>有助于前端更好理解后端java的分层思想，数据流转控制</li>
<li>和<a href="https://link.juejin.cn?target=https%3A%2F%2Fsvelte.js.cn%2Fdocs%2Fsvelte%2Fgetting-started" target="_blank" title="https://svelte.js.cn/docs/svelte/getting-started" ref="nofollow noopener noreferrer">Svelte</a>尝鲜学习了解</li>
<li>完整前后端代码在github：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fshuirongshuifu%2Fsvelte-springBoot-crud" target="_blank" title="https://github.com/shuirongshuifu/svelte-springBoot-crud" ref="nofollow noopener noreferrer">github.com/shuirongshu…</a></li>
</ul>
<p>大道至简，一些知识点是相通的比如——python里面也有闭包这个概念</p>
<blockquote>
<p>所谓编程即：学习规则语法、理解规则语法、合理运用规则语法、从而自定义规则...</p>
</blockquote>
<h2 data-id="heading-1">Java、Spring、Spring Boot ≈ Node.js、Express/Koa、Egg.js/NestJS</h2>
<h3 data-id="heading-2">效果图</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/14c741708c0142dfa0330f693cdf68e3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rC05YaX5rC05a2a:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763286600&amp;x-signature=2r021nH0R5WHr5L%2Fg5jRrWaUmVg%3D" alt="1.gif" loading="lazy"/></p>
<h3 data-id="heading-3">仓库代码图</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8d7a7f3fd648435a8f3190136f247646~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rC05YaX5rC05a2a:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763286600&amp;x-signature=5bZqfOFvt7ZnfNd4QAEO%2F8kTkBQ%3D" alt="2.png" loading="lazy"/></p>
<h3 data-id="heading-4">对比理解后端宏观架构流程、数据流转</h3>
<p>当我们知道后端具体做了什么事情以后，就更好理解了，即宏观架构流程、数据流转要清晰</p>
<p><strong><code>Java之于Spring之于Spring Boot 相当于 Node.js之于Express/Koa之于Egg.js/NestJS</code></strong></p>
<ul>
<li>
<p>Java底层是JDK+JRE+JVM（JDK安装以后自带JRE和JVM，类似于Node安装后自带NPM）</p>
</li>
<li>
<p>基于Java原生开发了Spring框架，基于Spring框架有了Spring Boot（开箱即用）</p>
<ul>
<li>
<p>Spring MVC是Spring框架中的一部分，所谓的MVC指的是<strong>Model</strong>、<strong>View</strong>、<strong>Controller</strong></p>
</li>
<li>
<p>简约而言，后端主要做这几件事：</p>
<ol start="0">
<li>定义请求路由接口 <strong>(C路由)</strong></li>
<li>请求参数验证 <strong>(C参数验证)</strong></li>
<li>业务逻辑处理 <strong>(M业务逻辑)</strong></li>
<li>操作数据库 <strong>(M业务逻辑)</strong></li>
<li>返回响应数据JSON、下载返回流文件 <strong>（C路由返回 V视图概念消失弱化）</strong></li>
</ol>
</li>
<li>
<p>前后端不分离JSP时代，MVC基本后端做。即：</p>
<ol start="0">
<li>过去: 后端 = M + C + <strong>V (渲染HTML)</strong></li>
<li>现在: 后端 = M + C; 前端 = <strong>V (前端框架渲染)</strong> + 交互</li>
</ol>
</li>
</ul>
</li>
<li>
<p>类比，Node.js --&gt; Express.js / Koa.js --&gt; Egg.js/NestJS （开箱即用）</p>
</li>
<li>
<p>至于Java微服务<strong>Spring Cloud</strong>实际上就是一堆<strong>Spring Boot</strong>的集合</p>
</li>
</ul>
<h3 data-id="heading-5">技术栈类比</h3>























































<table><thead><tr><th>Spring Boot 生态</th><th>Node.js 对应技术</th><th>说明</th></tr></thead><tbody><tr><td><strong>JDK 8</strong></td><td>Node.js</td><td>⚙️ 运行环境，学Java装JDK，就像学JS装Node</td></tr><tr><td><strong>Spring &amp;&amp; Spring MVC</strong></td><td>Express/Koa/Fastify</td><td>🚀 后端基础框架，快速搭建应用服务</td></tr><tr><td><strong>Spring Boot 2.7.18</strong></td><td>Egg.js/Nest.js 或 Express/Koa/Fastify + 一堆插件</td><td>🚀 后端进阶完善的框架，可开箱即用</td></tr><tr><td><strong>MyBatis-Plus 3.5.3.1</strong></td><td>Sequelize/Prisma</td><td>🗄️ ORM框架，简化数据库操作，不用手搓sql了</td></tr><tr><td><strong>Swagger 3.0.0 + Knife4j 3.0.3</strong></td><td>swagger-ui-express</td><td>📖 API文档自动生成</td></tr><tr><td><strong>Hutool 5.8.22</strong></td><td>lodash/day.js</td><td>🛠️ 工具库，提供各种实用函数</td></tr><tr><td><strong>Apache POI 4.1.2</strong></td><td>node-xlsx / xlsx</td><td>📊 Excel文件处理，导入导出解析excel的数据</td></tr><tr><td><strong>数据库驱动（JDBC Driver）</strong></td><td>mysql或者mysql2</td><td>🔌 数据库连接</td></tr><tr><td><strong>HikariCP</strong></td><td>mysql或者mysql2内置的连接池</td><td>🔌 数据库连接池，管理数据库连接</td></tr></tbody></table>
<blockquote>
<ul>
<li>Maven 就像 npm，<code>pom.xml</code> 就是 <code>package.json</code>，依赖管理方式几乎一样！</li>
<li>Java 的包管理比 npm 更严格，但概念相同</li>
<li>Spring Boot 的注解就像 Vue的自定义指令</li>
</ul>
</blockquote>
<h2 data-id="heading-6">后端五件事（简约版）</h2>
<ul>
<li>
<ol start="0">
<li>定义请求路由接口</li>
</ol>
</li>
<li>
<ol start="2">
<li>请求参数验证</li>
</ol>
</li>
<li>
<ol start="3">
<li>业务逻辑处理</li>
</ol>
</li>
<li>
<ol start="4">
<li>操作数据库</li>
</ol>
</li>
<li>
<ol start="5">
<li>返回响应数据（JSON / 流）</li>
</ol>
</li>
</ul>
<h3 data-id="heading-7">整体流程</h3>









































<table><thead><tr><th>流程节点</th><th>核心操作</th></tr></thead><tbody><tr><td>前端 → Nginx → Controller</td><td>前端发请求（如 <code>GET /user/1</code>），Controller 用 <code>UserQueryDTO</code> 接收参数（如 <code>id=1</code>），校验参数合法性</td></tr><tr><td>Controller → Service</td><td>Controller 调用 Service 方法，传入 <code>UserQueryDTO</code> 或提取后的参数（如 <code>id=1</code>）</td></tr><tr><td>Service → Mapper</td><td>Service 处理业务逻辑（如权限判断），调用 Mapper 方法（如 <code>userMapper.selectById(1)</code>）</td></tr><tr><td>Mapper → 数据库</td><td>Mapper 执行 SQL，将查询条件（<code>id=1</code>）转为数据库语句，同时通过 Entity 映射表结构（如 <code>User</code> 类对应 <code>user</code> 表）</td></tr><tr><td>数据库 → Mapper</td><td>数据库返回结果集，Mapper 自动将结果集转为 <code>User</code> 实体对象</td></tr><tr><td>Mapper → Service</td><td>Mapper 将 <code>User</code> 实体返回给 Service</td></tr><tr><td>Service → Controller</td><td>Service 将 <code>User</code> 实体通过转换器（或手动）转为 <code>UserRespDTO</code>（屏蔽敏感字段，如密码）</td></tr><tr><td>Controller → Nginx → 前端</td><td>Controller 将 <code>UserRespDTO</code> 转为 JSON 响应，返回给前端</td></tr></tbody></table>
<p>下面以新增请求为例</p>
<blockquote>
<p>当然还有别的 这里不赘述</p>
</blockquote>
<h2 data-id="heading-8">1. 定义请求路由接口 （Controller层）</h2>
<h3 data-id="heading-9">定义新增接口 /people</h3>
<p>比如定义一个新增接口</p>
<ul>
<li>定义一个请求Url是 /people</li>
<li>Post 请求 Body传参</li>
<li>传参示例：<code>{ age: 20，home: "string"，name: "string"，remark: "string" }</code></li>
<li>curl命令调用如下</li>
</ul>

<pre><code class="hljs language-json" lang="json">curl -X POST http<span class="hljs-punctuation">:</span><span class="hljs-comment">//localhost:8080/people \</span>
  -H <span class="hljs-string">"Content-Type: application/json"</span> \
  -d '<span class="hljs-punctuation">{</span><span class="hljs-attr">"age"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">20</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"home"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"string"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"string"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"remark"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"string"</span><span class="hljs-punctuation">}</span>'
</code></pre>
<h3 data-id="heading-10">Controller控制层</h3>
<p><em>PeopleController.java</em></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> com.people_sys.people.service.PeopleService; <span class="hljs-comment">// 导入业务服务层 PeopleService</span>
<span class="hljs-comment">// @RestController = @Controller + @ResponseBody = 返回JSON格式的数据</span>
<span class="hljs-meta">@RestController</span> 
<span class="hljs-meta">@RestController</span> <span class="hljs-comment">// REST风格的接口</span>
<span class="hljs-meta">@RequestMapping("/people")</span> <span class="hljs-comment">// 接口请求url 统一请求前缀/people</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PeopleController</span> { <span class="hljs-comment">// PeopleController类</span>
    <span class="hljs-comment">// 定义变量存储peopleService</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> PeopleService peopleService;
    <span class="hljs-comment">// 构造器注入（初始化执行）</span>
    <span class="hljs-comment">// 也可以使用注解 @Resource 或 @Autowired  一步到位</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">PeopleController</span><span class="hljs-params">(PeopleService peopleService)</span> {
        <span class="hljs-built_in">this</span>.peopleService = peopleService; <span class="hljs-comment">// 存起来</span>
    }
    
    <span class="hljs-comment">// 新增人员 - POST /people</span>
    <span class="hljs-meta">@PostMapping</span>
    <span class="hljs-keyword">public</span> ApiResponse&lt;Boolean&gt; <span class="hljs-title function_">create</span><span class="hljs-params">(<span class="hljs-meta">@Valid</span> <span class="hljs-meta">@RequestBody</span> PeopleDTO people)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-comment">// 调用peopleService层的create方法新增用户人员</span>
        <span class="hljs-type">boolean</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> peopleService.create(people);
        <span class="hljs-keyword">return</span> ApiResponse.success(result);
    }
    <span class="hljs-comment">// 根据id查询 - GET /people/{id}</span>
    <span class="hljs-meta">@GetMapping("/{id}")</span>
    <span class="hljs-keyword">public</span> ApiResponse&lt;People&gt; <span class="hljs-title function_">getById</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Integer id)</span> {
        <span class="hljs-comment">// 调用peopleService层的getById方法，根据id查询对应人员的</span>
        <span class="hljs-type">People</span> <span class="hljs-variable">people</span> <span class="hljs-operator">=</span> peopleService.getById(id);
        <span class="hljs-keyword">return</span> ApiResponse.success(people);
    }
    
    ......
}
</code></pre>
<h3 data-id="heading-11">何为注解&amp;常见的注解举例</h3>
<p>简而言之：</p>
<ul>
<li>注解有点像前端Vue中的指令，比如只要写了v-if以后，Vue框架会自动根据相应逻辑处理显示隐藏</li>
<li>也像React中的Props，比如 @NotNull(message = "不能为空") 类比于 &lt;input required ... /&gt;</li>
</ul>
<p><strong>注解（实际上是封装了一层），就是用特定的语法，告诉框架（组件），如何正确处理对应逻辑</strong></p>
<p>常见的注解举例：</p>
<ul>
<li>
<p>@RestController 控制器注解，标明定义的接口——适合前后端分析的项目，返回JSON</p>
</li>
<li>
<p>@Controller 适合前后端不分离的，比如返回html，用的少了</p>
</li>
<li>
<p>@Service 服务层注解，撰写具体业务逻辑</p>
</li>
<li>
<p>@Data Lombok注解，自动生成getter/setter/toString等</p>
</li>
<li>
<p>@RequestMapping系列注解，请求映射注解</p>
<ul>
<li>@PostMapping // POST请求</li>
<li>@GetMapping("/{id}") // GET请求带路径参数</li>
<li>@PutMapping // PUT请求</li>
<li>@DeleteMapping // DELETE请求</li>
<li>@RequestMapping("/api") // 通用映射</li>
</ul>
</li>
<li>
<p>验证注解系列</p>
<ul>
<li>@NotNull // 不为 null</li>
<li>@NotBlank // 去空格非空</li>
<li>@NotEmpty // 集合或数组至少一个元素</li>
<li>@Size(min=1, max=10) // 长度限制</li>
<li>@Email // 邮箱格式</li>
<li>@Min(0) @Max(150) // 数值范围</li>
</ul>
</li>
<li>
<p>跨域注解</p>
</li>
</ul>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.CrossOrigin;
<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.GetMapping;
<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RestController;
<span class="hljs-meta">@RestController</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TestController</span> {
    <span class="hljs-comment">// 仅当前接口支持跨域，允许所有来源（*）</span>
    <span class="hljs-meta">@CrossOrigin</span>
    <span class="hljs-meta">@GetMapping("/api/test")</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">testCrossOrigin</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"跨域请求成功！"</span>;
    }
}
</code></pre>
<ul>
<li>
<p>拿到前端传参的注解</p>
<ul>
<li>
<p>@PathVariable注解</p>
<ul>
<li>能拿到/findById/100 这个100</li>
<li>类似express中的req.params + 路由 :变量名</li>
</ul>
</li>
<li>
<p>@RequestParam 注解</p>
<ul>
<li>能拿到query传参 ?name=xxx&amp;age=88</li>
<li>类似express中的req.query</li>
</ul>
</li>
<li>
<p>@RequestBody</p>
<ul>
<li>能拿到body传参</li>
<li>类似express中的req.body + 解析中间件app.use(express.json())</li>
</ul>
</li>
</ul>
</li>
<li>
<p>等很多注解...</p>
</li>
</ul>
<blockquote>
<p>注解还可以自定义，有点像函数</p>
</blockquote>
<h2 data-id="heading-12">5. 返回响应 JSON / 流</h2>
<h3 data-id="heading-13">统一返回JSON</h3>
<p>首先，前端请求接口时，后端统一返回格式，使用ApiResponse这个类统一控制</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.people_sys.people.config;
<span class="hljs-keyword">import</span> lombok.Data;
<span class="hljs-meta">@Data</span> <span class="hljs-comment">// 自动生成getter/setter</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ApiResponse</span>&lt;T&gt; {
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> code;       <span class="hljs-comment">// 状态码（如200成功，400参数错误，500系统错误）</span>
    <span class="hljs-keyword">private</span> String message; <span class="hljs-comment">// 响应消息（成功时为"success"，失败时为错误信息）</span>
    <span class="hljs-keyword">private</span> T data;         <span class="hljs-comment">// 业务数据（成功时返回）</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ApiResponse</span><span class="hljs-params">(<span class="hljs-type">int</span> code, String message, T data)</span> {
        <span class="hljs-built_in">this</span>.code = code;
        <span class="hljs-built_in">this</span>.message = message;
        <span class="hljs-built_in">this</span>.data = data;
    }
    <span class="hljs-comment">// 成功响应</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; ApiResponse&lt;T&gt; <span class="hljs-title function_">success</span><span class="hljs-params">(T data)</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ApiResponse</span>&lt;&gt;(<span class="hljs-number">200</span>, <span class="hljs-string">"success"</span>, data);
    }
    <span class="hljs-comment">// 错误响应</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; ApiResponse&lt;T&gt; <span class="hljs-title function_">error</span><span class="hljs-params">(<span class="hljs-type">int</span> code, String message)</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ApiResponse</span>&lt;&gt;(code, message, <span class="hljs-literal">null</span>);
    }
}
</code></pre>
<p>前端查询id为300的这条数据，<code>http://localhost:8080/people/300</code>返回</p>
<pre><code class="hljs language-js" lang="js">{
    <span class="hljs-string">"code"</span>: <span class="hljs-number">200</span>,
    <span class="hljs-string">"message"</span>: <span class="hljs-string">"success"</span>,
    <span class="hljs-string">"data"</span>: {
        <span class="hljs-string">"id"</span>: <span class="hljs-number">300</span>,
        <span class="hljs-string">"name"</span>: <span class="hljs-string">"张三"</span>,
        <span class="hljs-string">"age"</span>: <span class="hljs-number">3</span>,
        <span class="hljs-string">"home"</span>: <span class="hljs-string">"山东"</span>,
        <span class="hljs-string">"remark"</span>: <span class="hljs-string">"zhangsan"</span>,
        <span class="hljs-string">"delFlag"</span>: <span class="hljs-number">0</span>,
        <span class="hljs-string">"createTime"</span>: <span class="hljs-string">"2025-11-04T14:48:05"</span>,
        <span class="hljs-string">"updateTime"</span>: <span class="hljs-string">"2025-11-04T17:23:32"</span>
    }
}
</code></pre>
<blockquote>
<p>ApiResponse实际上就是一个公共函数，统一加工处理数据的</p>
</blockquote>
<h3 data-id="heading-14">返回流文件给前端下载</h3>
<p>动态生成Excel并下载（伪代码示例）</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@GetMapping("/downloadExcel")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">downloadExcel</span><span class="hljs-params">(HttpServletResponse response)</span> <span class="hljs-keyword">throws</span> IOException {
    <span class="hljs-comment">// 1. 动态生成Excel（使用POI等工具）</span>
    <span class="hljs-type">XSSFWorkbook</span> <span class="hljs-variable">workbook</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">XSSFWorkbook</span>(); <span class="hljs-comment">// POI的Excel对象</span>
    <span class="hljs-type">XSSFSheet</span> <span class="hljs-variable">sheet</span> <span class="hljs-operator">=</span> workbook.createSheet(<span class="hljs-string">"Sheet1"</span>);
    <span class="hljs-comment">// ... 向sheet中写入数据 ...</span>
​
    <span class="hljs-comment">// 2. 设置响应头（同上）</span>
    response.setContentType(<span class="hljs-string">"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"</span>);
    <span class="hljs-type">String</span> <span class="hljs-variable">fileName</span> <span class="hljs-operator">=</span> URLEncoder.encode(<span class="hljs-string">"动态生成的Excel.xlsx"</span>, <span class="hljs-string">"UTF-8"</span>);
    response.setHeader(<span class="hljs-string">"Content-Disposition"</span>, <span class="hljs-string">"attachment; filename*=UTF-8''"</span> + fileName);
​
    <span class="hljs-comment">// 3. 直接将工作簿写入响应流</span>
    workbook.write(response.getOutputStream());
    workbook.close(); <span class="hljs-comment">// 关闭资源</span>
}
</code></pre>
<blockquote>
<p>workbook.write(response.getOutputStream()) 意思就是：将内存中动态生成的文件（如 Excel）以二进制流的形式写入 HTTP 响应输出流，最终返回给前端，以便于前端使用a标签实现文件下载</p>
</blockquote>
<h2 data-id="heading-15">2. 请求参数验证 （Controller层）</h2>
<h3 data-id="heading-16">数据新增接口细节拆解</h3>
<p>接下来，看对应新增接口注释，新增接口前端Post的Body传参为</p>
<p><code>people: { name: 'tom', age: 2, home: 'New York', 'remark': 'xyz' }</code></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 1. 接口请求类型注解，等价于：@RequestMapping(method = RequestMethod.POST)</span>
<span class="hljs-meta">@PostMapping</span>
<span class="hljs-comment">// 2. public公开的create方法，允许其他类调用（若写成private，Spring无法扫描到这个接口，前端会访问失败）</span>
<span class="hljs-keyword">public</span> ApiResponse&lt;Boolean&gt; <span class="hljs-title function_">create</span><span class="hljs-params">( // 方法名叫做create
    // <span class="hljs-number">3.</span> 数据校验触发注解（想要使用PeopleDTO里面的校验，必须要使用<span class="hljs-meta">@Valid</span>标明开启校验）
    <span class="hljs-meta">@Valid</span>  
    // <span class="hljs-number">4.</span> 请求体接收注解，通过这个可以拿到前端请求体里面的参数，并将其赋值给people参数
    <span class="hljs-meta">@RequestBody</span>  
    // <span class="hljs-number">5.</span> 方法参数（DTO 实体 + 参数名）
    PeopleDTO people  // people为函数的形参存储的前端参数
)</span> <span class="hljs-keyword">throws</span> Exception {  <span class="hljs-comment">// 6. 异常则抛出声明</span>
    <span class="hljs-comment">// 7. 业务逻辑：把前端传递进来的people对象参数，调用 Service 层新增方法，得到布尔类型结果</span>
    <span class="hljs-type">boolean</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> peopleService.create(people);
    <span class="hljs-comment">// 8. 返回统一响应结果，新增成功返回 {"code":200,"message":"success","data":true}</span>
    <span class="hljs-keyword">return</span> ApiResponse.success(result); 
}
</code></pre>
<p>通过@RequestBody 可以拿到前端参数 存到people变量里面，然后交由peopleService.create方法去做业务逻辑处理进而写入数据库</p>
<p>但是，前端可能乱传参，所以，需要搭配PeopleDTO和 @Valid 进行校验一下</p>
<h3 data-id="heading-17">什么是DTO，能做什么</h3>
<p>简而言之：DTO就是规范接收前端传参、规范返回接口数据</p>
<p>新增的DTO</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.people_sys.people.dto;
<span class="hljs-keyword">import</span> lombok.Data;
<span class="hljs-keyword">import</span> javax.validation.constraints.NotBlank;
<span class="hljs-keyword">import</span> javax.validation.constraints.NotNull;
<span class="hljs-meta">@Data</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PeopleDTO</span> {
    <span class="hljs-meta">@NotBlank(message = "姓名不能为空")</span> <span class="hljs-comment">// 必传，字符串类型</span>
    <span class="hljs-keyword">private</span> String name;
    <span class="hljs-meta">@NotNull(message = "年龄不能为空")</span> <span class="hljs-comment">// 必传，数字类型</span>
    <span class="hljs-keyword">private</span> Integer age;
    <span class="hljs-keyword">private</span> String home; <span class="hljs-comment">// 非必传</span>
    <span class="hljs-keyword">private</span> String remark; <span class="hljs-comment">// 非必传</span>
}
</code></pre>
<p>编辑的DTO多了一个id，其他和新增一样（毕竟编辑要找到对应id再去编辑）</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Data</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PeopleUpdateDTO</span> {

    <span class="hljs-meta">@NotNull(message = "ID不能为空")</span>
    <span class="hljs-keyword">private</span> Integer id;

    <span class="hljs-meta">@NotBlank(message = "姓名不能为空")</span>
    <span class="hljs-keyword">private</span> String name;

    ...
}
</code></pre>
<p>我们可以把DTO看成一个工具函数，在接到前端传参的时候，做规范限制——过滤掉不需要的参数，校验是否符合传参要求</p>
<h3 data-id="heading-18">用JavaScript模拟DTO功能</h3>
<p>假设，我们要求前端传参规则是这样的：</p>
<p><code>name字段必传且为字符串类型、age字段非必传（若传了必须要是数字类型），若多传则忽略之</code></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">const</span> <span class="hljs-variable">Dto</span> <span class="hljs-operator">=</span> {
    name: {
        type: <span class="hljs-string">"string"</span>,
        required: <span class="hljs-literal">true</span>,
    },
    age: {
        type: <span class="hljs-string">"number"</span>,
        required: <span class="hljs-literal">false</span>,
    },
}
</code></pre>
<ul>
<li>假设用户传递<code>{ name: '孙悟空', age: 500, home: '花果山' }</code>那么经过DTO处理以后，能得到<code>{ name: '孙悟空', age: 500}</code>多传的home字段和其值，被忽略</li>
<li>假设用户传递<code>{ age: 500 }</code>那么经过DTO处理以后，要校验提示name是必传的</li>
<li>假设用户传递<code>{ name: true }</code>那么经过DTO处理以后，要校验提示name的数据类型不对</li>
</ul>
<p>于是，就可以有以下模拟代码</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/**
 * 模拟定义DTO
 *  姓名为字符串，必传
 *  年龄为数字类型，非必传
 * */</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">dtoDef</span> = (<span class="hljs-params">params</span>) =&gt; {
    <span class="hljs-comment">// 定义Dto字段规则</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title class_">Dto</span> = {
        <span class="hljs-attr">name</span>: {
            <span class="hljs-attr">type</span>: <span class="hljs-string">"string"</span>,
            <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>,
        },
        <span class="hljs-attr">age</span>: {
            <span class="hljs-attr">type</span>: <span class="hljs-string">"number"</span>,
            <span class="hljs-attr">required</span>: <span class="hljs-literal">false</span>,
        },
    }
    <span class="hljs-comment">/**
     * 1. 必传字段校验
     * */</span>
    <span class="hljs-keyword">const</span> mustHaveKeys = []
    <span class="hljs-comment">// 1.1 收集那些字段是必传的</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> key <span class="hljs-keyword">in</span> <span class="hljs-title class_">Dto</span>) {
        <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Dto</span>[key].<span class="hljs-property">required</span>) {
            mustHaveKeys.<span class="hljs-title function_">push</span>(key)
        }
    }
    <span class="hljs-comment">// 1.2 收集传递进来的key组成的数组</span>
    <span class="hljs-keyword">const</span> paramsKeys = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(params)
    <span class="hljs-comment">// 1.3 看看是否每一个必传字段，都在参数key数组里面</span>
    <span class="hljs-keyword">const</span> flag = mustHaveKeys.<span class="hljs-title function_">every</span>(<span class="hljs-function">(<span class="hljs-params">mk</span>) =&gt;</span> paramsKeys.<span class="hljs-title function_">includes</span>(mk))
    <span class="hljs-comment">// 1.4 必传参数校验</span>
    <span class="hljs-keyword">if</span> (!flag) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">`必传字段缺失，必传字段有这些：<span class="hljs-subst">${mustHaveKeys.join(<span class="hljs-string">","</span>)}</span>`</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
    }
    <span class="hljs-comment">/**
    * 2. 字段类型校验
    * */</span>
    <span class="hljs-keyword">const</span> resDto = {}
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> key <span class="hljs-keyword">in</span> params) {
        <span class="hljs-comment">// 在Dto里的做对应校验</span>
        <span class="hljs-keyword">if</span> (key <span class="hljs-keyword">in</span> <span class="hljs-title class_">Dto</span>) {
            <span class="hljs-comment">// 类型校验</span>
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> params[key] === <span class="hljs-title class_">Dto</span>[key].<span class="hljs-property">type</span>) {
                <span class="hljs-comment">// 校验通过则转存一份</span>
                resDto[key] = params[key]
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">`字段<span class="hljs-subst">${key}</span>类型错误，类型应为<span class="hljs-subst">${Dto[key].type}</span>`</span>)
                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
            }
        }
        <span class="hljs-comment">// 不在Dto里面的忽略，这样resDto里存的就是定义好的</span>
        <span class="hljs-keyword">else</span> { }
    }
    <span class="hljs-keyword">return</span> resDto
}

<span class="hljs-keyword">const</span> par = { <span class="hljs-attr">name</span>: <span class="hljs-string">'孙悟空'</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">500</span>, <span class="hljs-attr">home</span>: <span class="hljs-string">'花果山'</span> }

<span class="hljs-comment">// 经过dtoDef的校验、过滤就能得到符合要求的dto了</span>
<span class="hljs-keyword">const</span> result = <span class="hljs-title function_">dtoDef</span>(par)
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'result'</span>, result) <span class="hljs-comment">// {name: '孙悟空', age: 500}</span>
</code></pre>
<ul>
<li>
<p>在java中，dto定义好以后，可在接受前端参数的时候使用</p>
<ul>
<li>只拿自己需要的字段值</li>
<li>使用注解快速校验前端传参</li>
</ul>
</li>
<li>
<p>也可在从数据库捞出数据返回给前端的时候使用</p>
<ul>
<li>比如返回的时候，password和gender字段作为保密，不返回给前端</li>
<li>只返回能返回的数据</li>
</ul>
</li>
</ul>
<p>所以，再总结一下：DTO就是规范接收前端传参、规范返回接口数据的一个工具</p>
<blockquote>
<p>问：如果有一些额外的字段，要返回给前端，又不是前端要传递的字段，怎么定义呢？比如返数据时，需加一个字段isAdults来确认是否成年（规则是大于18岁成年为true，小于则为false）</p>
<p>答：这个时候，VO就闪亮登场了</p>
</blockquote>
<h3 data-id="heading-19">VO是最终返回给前端数据结构格式</h3>
<p>总结：VO是最终返回给前端数据结构格式——如果小项目，直接用dto也行（可以看成把dto当成vo用）</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Data</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PeopleVO</span> {
    <span class="hljs-keyword">private</span> Long id; <span class="hljs-comment">// 额外字段：数据库主键（前端不用传，要展示）</span>
    <span class="hljs-comment">// 复用 DTO 中的字段</span>
    <span class="hljs-keyword">private</span> String name; 
    <span class="hljs-keyword">private</span> Integer age;
    <span class="hljs-keyword">private</span> String home;
    <span class="hljs-keyword">private</span> String remark;
    <span class="hljs-keyword">private</span> Boolean isAdults; <span class="hljs-comment">// 额外字段：计算后信息，是否成年</span>
}
</code></pre>
<h2 data-id="heading-20">3. 业务逻辑处理 &amp; 4.操作数据库</h2>
<blockquote>
<p>先假设没有复杂业务逻辑处理，直接把前端传递的数据，存到数据库里，就需要编写sql语句</p>
</blockquote>
<h3 data-id="heading-21">古法手搓sql</h3>
<p>现在接口定义好了，且用DTO规范了前端传参，接下来应该把前端传递来的参数转成sql语句</p>
<p>比如，新增一条数据：<code>{ "name": "tom", "age": 18 }</code></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addPerson</span><span class="hljs-params">(String name, <span class="hljs-type">int</span> age)</span> { <span class="hljs-comment">// 拿到前端传进来的参数name和age</span>
     <span class="hljs-comment">// 拼接手搓sql</span>
    <span class="hljs-type">String</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> <span class="hljs-string">"INSERT INTO people (name, age) VALUES (?, ?)"</span>;
    <span class="hljs-comment">// 调用Spring的jdbcTemplate类的update方法新增数据</span>
    <span class="hljs-type">int</span> <span class="hljs-variable">rowsAffected</span> <span class="hljs-operator">=</span> jdbcTemplate.update(sql, name, age);
    <span class="hljs-comment">// 成功插入 1 条记录 → 返回 1</span>
    <span class="hljs-keyword">if</span> (rowsAffected &gt; <span class="hljs-number">0</span>) {
        System.out.println(<span class="hljs-string">"成功插入 "</span> + rowsAffected + <span class="hljs-string">" 条记录"</span>);
    }
}
</code></pre>
<p>但是这个手搓sql的方式，不优雅（可维护性、类型安全、重复劳动等），所以诞生了orm框架，通过orm框架去操作数据库</p>
<h3 data-id="heading-22">什么是ORM</h3>
<ul>
<li>ORM（Object-Relational Mapping，<strong>对象关系映射</strong>）是一种编程技术</li>
<li>核心是<strong>把数据库中的 “表、行、列” 映射成程序中的 “类、对象、属性”</strong> ，</li>
<li>让开发者能用<strong>面向对象（OOP）的方式操作数据库</strong>，而不用直接写复杂的 SQL 语句。</li>
</ul>
<p>换句话说，ORM是翻译官</p>
<ul>
<li>数据库世界：用表（Table）、行（Row）、字段（Column）存储数据（比如 MySQL 的 <code>user</code> 表，有 <code>id</code>/<code>name</code>/<code>age</code> 字段）；</li>
<li>程序世界：用类（Class）、对象（Object）、属性（Attribute）处理数据（比如 Java 的 <code>User</code> 类，有 <code>id</code>/<code>name</code>/<code>age</code> 属性）；</li>
<li>ORM 的作用：在两者之间做 “翻译”—— 假使我们操作程序里的对象（比如 <code>user.name = "张三"</code>），ORM 自动转换成对应的 SQL（<code>UPDATE user SET name = "张三"</code>），执行后再把数据库结果转回</li>
</ul>
<blockquote>
<p>ORM的核心价值就是不用写 或者少写 SQL，专注业务逻辑</p>
</blockquote>
<p>上述案例，如果使用mybatis-plus这个orm框架(半自动化orm框架)，则这样写即可</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addPerson</span><span class="hljs-params">(String name, <span class="hljs-type">int</span> age)</span> {
    <span class="hljs-comment">// 创建实体对象并设置参数</span>
    <span class="hljs-type">Person</span> <span class="hljs-variable">person</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>();
    person.setName(name);
    person.setAge(age);

    <span class="hljs-comment">// 调用 MyBatis-Plus 的 insert 方法插入数据</span>
    <span class="hljs-type">int</span> <span class="hljs-variable">rowsAffected</span> <span class="hljs-operator">=</span> personMapper.insert(person);

    <span class="hljs-keyword">if</span> (rowsAffected &gt; <span class="hljs-number">0</span>) {
        System.out.println(<span class="hljs-string">"成功插入 "</span> + rowsAffected + <span class="hljs-string">" 条记录"</span>);
    }
}
</code></pre>
<p>这里的personMapper继承自BaseMapper（自带一套通用的crud的方法）如</p>
<ul>
<li><code>insert(T entity)</code>：插入一条记录</li>
<li><code>deleteById(Serializable id)</code>：根据主键删除</li>
<li><code>updateById(T entity)</code>：根据主键更新</li>
<li><code>selectById(Serializable id)</code>：根据主键查询</li>
<li><code>selectList(Wrapper&lt;T&gt; queryWrapper)</code>：条件查询列表</li>
</ul>
<p>所以可以直接insert数据</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.core.mapper.BaseMapper;
<span class="hljs-comment">// 定义一个接口PersonMapper继承了BaseMapper上所用功能，比如crud的api</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">PersonMapper</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseMapper</span>&lt;Person&gt; {
    <span class="hljs-comment">// 无需编写任何方法，BaseMapper 已提供 CRUD 基础功能</span>
}
</code></pre>
<blockquote>
<p>注意，<code>BaseMapper&lt;Person&gt;</code> 中的泛型 <code>&lt;Person&gt;</code> 就是告诉 MyBatis-Plus：这个 Mapper 要操作的是与 <code>Person</code> 类绑定的那张表（即 <code>people</code> 表）</p>
</blockquote>
<p><strong>所以，一定要告诉 MyBatis-Plus要操作那张表，怎么告诉呢 就通过entity告诉</strong></p>
<p><strong>所以，这里的<code>&lt;Person&gt;</code>就是一个entity，如下</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Data</span>  <span class="hljs-comment">// 无需手动编写 getter、setter 等方法，@Data 会自动生成</span>
<span class="hljs-meta">@TableName("people")</span> <span class="hljs-comment">// 映射数据库表名——告诉mybatis，是那张表</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span> {
    <span class="hljs-meta">@TableId(type = IdType.AUTO)</span> <span class="hljs-comment">// 主键自增</span>
    <span class="hljs-keyword">private</span> Long id; 
    
    <span class="hljs-keyword">private</span> String name; 
    <span class="hljs-keyword">private</span> Integer age; 
}
</code></pre>
<p><strong>所以ORM 一定是要搭配着entity，才能一块干活！！！</strong></p>
<p><strong>通俗而言，ORM是翻译官，他要把火星文翻译成中文，所以，它需要一个火星文对应中文词典，而entity就是这本词典</strong></p>
<h3 data-id="heading-23">常见的 ORM 框架</h3>
<ul>
<li>Python：SQLAlchemy（通用）、Django ORM（Django 内置）；</li>
<li>Java：Hibernate（重量级）、MyBatis（半 ORM，更灵活）；</li>
<li>JavaScript/TypeScript：Sequelize（Node.js）、Prisma（现代主流）；</li>
<li>PHP：Eloquent ORM（Laravel 内置）。</li>
</ul>
<blockquote>
<p>无论哪种 ORM 框架，<strong>都必须通过某种形式的 “实体” 来定义 “代码对象” 与 “数据库表” 的映射关系</strong>（表名、字段名、类型、主键等）。这些 “实体” 可能叫 <code>Model（PHP Prisma Python）</code>、<code>Entity（Java、cSharp）</code> 或直接是一个类 / 配置，但本质都是 ORM 框架的 “翻译词典”—— 没有它们，ORM 就无法完成 “对象操作→SQL 语句” 的转换。</p>
</blockquote>
<h3 data-id="heading-24">ORM之Mybatis操作sql</h3>
<p>回顾一下，使用ORM操作sql，首先，orm要知道操作那张表的哪些字段，当然，dto是老早就定义好了，如下提前定义好了的dto</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// DTO（接收前端）</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PersonDTO</span> {
    <span class="hljs-keyword">private</span> String name;
    <span class="hljs-keyword">private</span> Integer age;
    <span class="hljs-comment">// getter/setter</span>
}
</code></pre>
<p>我们会发现，dto中的东西不够用，毕竟DTO只是用来定义传输的部分数据，完整数据还是在表里。但是orm必须要知道完整数据，才方便操作数据库</p>
<p>而我们又不能把所有信息都丢到dto里面</p>
<p>所以，需要一个新的东西，来告知orm，完整的表、字段、数据类型是啥。用对象（类）的形式告知，映射数据库，于是就有了Entity这个文件</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Entity（映射数据库）</span>
<span class="hljs-meta">@TableName("people")</span> <span class="hljs-comment">// 告知表名字</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">People</span> {
    <span class="hljs-meta">@TableId(type = IdType.AUTO)</span> <span class="hljs-comment">// 主键自增</span>
    <span class="hljs-keyword">private</span> Long id;
    <span class="hljs-keyword">private</span> String name;
    <span class="hljs-keyword">private</span> Integer age;
    <span class="hljs-comment">// getter/setter</span>
}
</code></pre>
<p>现在orm知道了操作的表名是people，和表里的对应字段信息，那么orm就方便操作数据库中的表了</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 3. Service 层</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addPerson</span><span class="hljs-params">(PersonDTO dto)</span> {
    <span class="hljs-type">People</span> <span class="hljs-variable">people</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">People</span>();
    people.setName(dto.getName());
    people.setAge(dto.getAge());
    
    <span class="hljs-comment">// 无需写 SQL！ORM 自动 INSERT</span>
    <span class="hljs-type">boolean</span> <span class="hljs-variable">saved</span> <span class="hljs-operator">=</span> peopleService.save(people);
    <span class="hljs-keyword">if</span> (!saved) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(<span class="hljs-string">"保存失败"</span>);
    }
}
</code></pre>
<h3 data-id="heading-25">ORM 框架的核心优势</h3>
<ol start="0">
<li><strong>简化开发</strong>：不用写 SQL，减少重复工作（比如拼接 SQL、解析结果），开发效率大幅提升；</li>
<li><strong>屏蔽数据库差异</strong>：同一套代码，通过 ORM 适配 MySQL、PostgreSQL、SQLite 等不同数据库（ORM 负责翻译不同数据库的 SQL 语法）；</li>
<li><strong>降低学习成本</strong>：不用精通各种数据库的 SQL 细节，专注于面向对象编程；</li>
<li><strong>安全性更高</strong>：自动防止 SQL 注入（比如拼接用户输入时，ORM 会自动转义）。</li>
</ol>
<h3 data-id="heading-26">ORM总结</h3>
<p>ORM 是连接 “面向对象编程” 和 “关系型数据库” 的桥梁，核心目标是<strong>让开发者用更熟悉的 OOP 方式操作数据库，减少 SQL 编写，提升开发效率和代码可维护性</strong>。</p>
<h3 data-id="heading-27">Entity与DTO和VO对比</h3>
<p><strong>Entity 是“存数据的”，DTO 是“传数据的”，VO 是“给用户看的”。</strong></p>
<ul>
<li>Entity（实体类）——一般不直接返回 Entity 给前端</li>
<li>DTO（Data Transfer Object，数据传输对象）</li>
<li>VO（View Object / Value Object，视图对象）</li>
</ul>
<p>如果项目简单、无敏感数据，可 DTO/VO 合并，但Entity 仍应隔离</p>















































<table><thead><tr><th>维度</th><th>Entity</th><th>DTO</th><th>VO（View Object）</th></tr></thead><tbody><tr><td><strong>用途</strong></td><td>数据库映射</td><td>层间/系统间数据传输</td><td>前端展示专用</td></tr><tr><td><strong>是否持久化</strong></td><td>是（对应 DB 表）</td><td>否</td><td>否</td></tr><tr><td><strong>是否含敏感字段</strong></td><td>可能有（如密码）</td><td>通常过滤掉</td><td>通常无</td></tr><tr><td><strong>字段结构</strong></td><td>与 DB 一致</td><td>灵活，可裁剪/组合</td><td>为 UI 定制，可能格式化/计算</td></tr><tr><td><strong>使用位置</strong></td><td>Repository / JPA 层</td><td>Service ↔ Controller / API 间</td><td>Controller → 前端</td></tr><tr><td><strong>是否含逻辑</strong></td><td>一般无（或简单 getter）</td><td>无</td><td>可能有简单格式化逻辑</td></tr></tbody></table>
<h3 data-id="heading-28">3. 业务逻辑之新增的人员不能重名</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Override</span>
<span class="hljs-comment">// 新增人员的校验：新增的人名字不能和数据库中已经有的人名字重复</span>
<span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">create</span><span class="hljs-params">(PeopleDTO dto)</span> <span class="hljs-keyword">throws</span> Exception {
    <span class="hljs-comment">// 校验名字是否重复</span>
    <span class="hljs-keyword">if</span> (lambdaQuery()
            .eq(People::getName, dto.getName())
            .eq(People::getDelFlag, <span class="hljs-number">0</span>)
            .count() &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(<span class="hljs-number">400</span>, <span class="hljs-string">"人员姓名已存在，请使用其他姓名"</span>);
    }

    <span class="hljs-type">People</span> <span class="hljs-variable">entity</span> <span class="hljs-operator">=</span> BeanUtil.copyProperties(dto, People.class);
    <span class="hljs-keyword">return</span> save(entity);
}
</code></pre>
<blockquote>
<p>这里的save也是mybatis-plus提供的，比直接insert更加智能</p>
</blockquote>
<p>由于我们的业务逻辑是——新增的人名字不能和数据库中已经有的人名字重复，所以，在写入数据库之前，还需要编写sql查询一下，数据库中有多少条数据，和当前人名一样。</p>
<p>Mybatis也提前准备好了lambdaQuery()以供我们进行链式调用，进行条件构造链式查询，语法简洁</p>
<p>若使用手写sql，则是如下写法</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Autowired</span>
<span class="hljs-keyword">private</span> JdbcTemplate jdbcTemplate; <span class="hljs-comment">// Spring 的 JDBC 工具类</span>

<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">checkDuplicateName</span><span class="hljs-params">(String name)</span> {
    <span class="hljs-comment">// 手写 SQL 字符串</span>
    <span class="hljs-type">String</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> <span class="hljs-string">"SELECT COUNT(*) FROM people WHERE name = ? AND del_flag = 0"</span>;
    <span class="hljs-comment">// 执行查询，获取记录数</span>
    <span class="hljs-type">Integer</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> jdbcTemplate.queryForObject(
        sql, 
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]{name},  <span class="hljs-comment">// 绑定参数（姓名）</span>
        Integer.class        <span class="hljs-comment">// 返回类型</span>
    );
    <span class="hljs-comment">// 判断并抛异常</span>
    <span class="hljs-keyword">if</span> (count != <span class="hljs-literal">null</span> &amp;&amp; count &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(<span class="hljs-number">400</span>, <span class="hljs-string">"人员姓名已存在，请使用其他姓名"</span>);
    }
}
</code></pre>
<p>由此可见，当真是使用ORM框架——Mybatis更优雅提效，便于我们处理业务路基，操作数据库</p>
<h2 data-id="heading-29">常用技术栈：</h2>
<ul>
<li>数据库：MySQL + HikariCP（连接池）</li>
<li>数据访问：MyBatis + MyBatis-Plus（ORM + 代码生成）</li>
<li>API 开发：Spring Web + SpringDoc-OpenAPI（接口 + 文档）</li>
<li>缓存：Redis + Spring Cache（提升性能）</li>
<li>消息队列：Kafka/RabbitMQ（削峰填谷）</li>
<li>日志：SLF4J + Logback（日志记录）</li>
<li>测试：JUnit 5 + Mockito（单元测试）</li>
<li>部署：Maven + Docker（打包部署）</li>
</ul>
<h3 data-id="heading-30">Maven打包构建</h3>
<ul>
<li>Maven之于Java如同Npm之于Node.js</li>
<li>pom.xml文件作依赖版本管理——package.json做依赖版本管理</li>
<li>mvn install安装项目依赖——相当于npm install</li>
<li>项目内安装单个依赖，需手动在 <code>pom.xml</code> 文件中添加依赖后执行 <code>mvn install</code>——相当于npm install xxx</li>
<li>卸载某个依赖，需手动删除 <code>pom.xml</code> 中依赖后执行 <code>mvn clean install</code>——相当于npm uninstall xxx</li>
<li>mvn package相当于npm run build</li>
<li>Maven构建打包功能，把一堆Java开发代码打包成一个.jar文件（压缩包）——Npm把一堆前端代码打包成一个dist文件夹</li>
</ul>
<blockquote>
<p>Java基础，面向对象、类、接口、抽象、封装、继承、多态、线程、IO流 本文暂不赘述...</p>
</blockquote>
<h2 data-id="heading-31">Svelte的增删改查尝鲜</h2>
<ul>
<li>Svelte也有生命周期，如<code>import { onMount } from "svelte";</code></li>
<li>也可以数据双向绑定，如<code>bind:value={variable}</code></li>
<li>也有计算属性，如<code>$: computed = expression</code></li>
<li>可直接响应式变量，如<code>let variable = value</code></li>
<li>事件绑定语法是<code>on:click={handler}</code></li>
<li>阻止冒泡<code>on:click|stopPropagation</code></li>
<li>也有条件渲染，如</li>
</ul>
<pre><code class="hljs language-js" lang="js">{#<span class="hljs-keyword">if</span> condition}
  &lt;!-- 内容 --&gt;
{:<span class="hljs-keyword">else</span>}
  &lt;!-- 其他内容 --&gt;
{/<span class="hljs-keyword">if</span>}
</code></pre>
<ul>
<li>也有循环v-for、map渲染</li>
</ul>
<pre><code class="hljs language-js" lang="js">{#each items <span class="hljs-keyword">as</span> item (item.<span class="hljs-property">id</span>)}
  &lt;!-- 循环内容 --&gt;
{/each}
</code></pre>
<ul>
<li>也可组件化开发项目（单文件直接和vue类似，直接 <code>&lt;script&gt;</code>、<code>&lt;style&gt;</code>、<code>HTML模板</code>）</li>
<li>也可以import和export</li>
<li>分页组件父组件传对象和做事件处理<code>&lt;Page {pageInfo} on:pageChange={handlePageChange} /&gt;</code></li>
<li>对应子组件接收是</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// Props - 接收整个分页信息对象</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">let</span> pageInfo = {
    <span class="hljs-attr">currentPage</span>: <span class="hljs-number">1</span>,
    <span class="hljs-attr">pageSize</span>: <span class="hljs-number">10</span>,
    <span class="hljs-attr">total</span>: <span class="hljs-number">0</span>,
};
</code></pre>
<ul>
<li>子组件触发父组件使用<code>createEventDispatcher</code>，如</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { createEventDispatcher } <span class="hljs-keyword">from</span> <span class="hljs-string">"svelte"</span>;

<span class="hljs-comment">// 创建事件分发器</span>
<span class="hljs-keyword">const</span> dispatch = <span class="hljs-title function_">createEventDispatcher</span>();

<span class="hljs-comment">// 按钮点击的回调</span>
<span class="hljs-title function_">dispatch</span>(<span class="hljs-string">"pageChange"</span>, newPage);
</code></pre>
<p>比如和React语法对比：</p>
<ol>
<li><strong>更简洁的语法</strong>: 无需 <code>useState</code>、<code>useEffect</code> 等Hook</li>
<li><strong>真正的响应式</strong>: 直接赋值触发更新，不需要 <code>setState()</code></li>
<li><strong>更少的样板代码</strong>: 无需频繁的解构和回调</li>
<li><strong>更小的包体积</strong>: 编译时优化，运行时更轻量</li>
<li><strong>内置动画支持</strong>: <code>transition</code>、<code>animate</code> 指令</li>
<li><strong>CSS作用域自动化</strong>: 无需CSS Modules或CSS-in-JS</li>
</ol>
<blockquote>
<p>更多完整代码和注释，参见github仓库的前后端代码，创作不易，感谢支持点赞鼓励😉😉😉</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Spring 容器的基本实现]]></title>    <link>https://juejin.cn/post/7569913182036754442</link>    <guid>https://juejin.cn/post/7569913182036754442</guid>    <pubDate>2025-11-09T09:32:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7569913182036754442" data-draft-id="7568757323256430642" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Spring 容器的基本实现"/> <meta itemprop="keywords" content="Spring"/> <meta itemprop="datePublished" content="2025-11-09T09:32:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ToPossessLight0902"/> <meta itemprop="url" content="https://juejin.cn/user/4408354903695419"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Spring 容器的基本实现
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4408354903695419/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ToPossessLight0902
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-09T09:32:35.000Z" title="Sun Nov 09 2025 09:32:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1、基本用法</h2>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MySpringBean</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> <span class="hljs-variable">beanName</span> <span class="hljs-operator">=</span> <span class="hljs-string">"beanName"</span>;

    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getBeanName</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> beanName;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setBeanName</span><span class="hljs-params">(String beanName)</span> {
        <span class="hljs-built_in">this</span>.beanName = beanName;
    }
}
</code></pre>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">beans</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://www.springframework.org/schema/beans"</span>
       <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span>
       <span class="hljs-attr">xmlns:context</span>=<span class="hljs-string">"http://www.springframework.org/schema/context"</span>
       <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">"http://www.springframework.org/schema/beans
       http://www.springframework.org/schema/beans/spring-beans.xsd http://www.springframework.org/schema/context https://www.springframework.org/schema/context/spring-context.xsd"</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"myBeanName"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.reray.spring.study.MySpringBean"</span>/&gt;</span>

<span class="hljs-tag">&lt;/<span class="hljs-name">beans</span>&gt;</span>
</code></pre>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Test</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test</span><span class="hljs-params">()</span> {
    <span class="hljs-type">XmlBeanFactory</span> <span class="hljs-variable">xmlBeanFactory</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">XmlBeanFactory</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassPathResource</span>(<span class="hljs-string">"application.xml"</span>));
    <span class="hljs-type">MySpringBean</span> <span class="hljs-variable">beanName</span> <span class="hljs-operator">=</span> (MySpringBean) xmlBeanFactory.getBean(<span class="hljs-string">"myBeanName"</span>);
    System.out.println(beanName.getBeanName());
}
</code></pre>
<h2 data-id="heading-1">2、核心类介绍</h2>
<h3 data-id="heading-2">2.1 DefaultListableBeanFactory</h3>
<p>XmlBeanFactory 继承自 DefaultListableBeanFactory，DefaultListableBeanFactory 是整个 bean 加载的核心部分，是 Spring 注册和加载 bean 的默认实现。XmlBeanFactory 和 DefaultListableBeanFactory 不同地方在于 XmlBeanFactory 使用了自定义的 xml 读取器 XmlBeanDefinitionReader 个性化的 BeanDefinition 读取。DefaultListableBeanFactory 的结构如下</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9c9ef014ca1c4263b571bc7ba580d804~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVG9Qb3NzZXNzTGlnaHQwOTAy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763285555&amp;x-signature=1VMywx%2FnrQWNpdJo0ybqvUBZfHE%3D" alt="image.png" loading="lazy"/></p>
<p>XmlBeanFactory 对 DefaultListableBeanFactory 进行拓展，主要用于从 xml 文档中读取 BeanDefinition，注册和获取 bean 都是使用的父类的 DefaultListableBeanFactory 方法实现，增加了 XmlBeanDefinitionReader 对资源文件进行读取和注册</p>
<h3 data-id="heading-3">2.2 XmlBeanDefinitionReader</h3>
<p>XmlBeanDefinitionReader 对资源文件进行读取、解析和注册</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c6c9007d411d416d88d1e2e5b644efe2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVG9Qb3NzZXNzTGlnaHQwOTAy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763285555&amp;x-signature=FskwBMAihZiqc8ngoW9g1nhKQW8%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li>ResourceLoader</li>
<li>BeanDefinitionReader</li>
<li>EnvironmentCapable</li>
<li>DocumentLoader</li>
<li>AbstractBeanDefinitionReader</li>
<li>BeanDefinitionDocumentReader</li>
<li>BeanDefinitionParserDelegate</li>
</ul>
<p>（1）通过 AbstractBeanDefinitionReader 的 ResourceLoader 将资源文件路径转化为 Resource 文件</p>
<p>（2）通过 DocumentLoader 对 Resource 转化为 Document 文件</p>
<p>（3）通过 BeanDefinitionDocumentReader 的实现类 DefaultBeanDefinitionDocumentReader 对 Document 进行解析，并通过 BeanDefinitionParserDelegate 对 Element 进行解析</p>
<h3 data-id="heading-4">2.3 容器基础 XmlBeanFactory</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">XmlBeanFactory</span> <span class="hljs-variable">xmlBeanFactory</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">XmlBeanFactory</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassPathResource</span>(<span class="hljs-string">"application.xml"</span>));
</code></pre>
<p>上面代码执行逻辑</p>
<ol>
<li>调用 ClassPathResource 构造函数创建 Resource 资源文件实例</li>
<li>Resource 传入 XmlBeanFactory 后调用 loadBeanDefinitions</li>
</ol>
<h4 data-id="heading-5">2.3.1 配置文件封装</h4>
<p>在 Java 中将不同来源的资源对象抽象为 URL，通过注册不同的 handler（URLStreamHandler）来处理不同来源的资源读取逻辑。Spring 对其内部使用到的资源实现了自己的抽象结构：Resource 接口来封装底层资源。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">InputStreamSource</span> {
    InputStream <span class="hljs-title function_">getInputStream</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException;
}
</code></pre>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Resource</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">InputStreamSource</span> {
    <span class="hljs-type">boolean</span> <span class="hljs-title function_">exists</span><span class="hljs-params">()</span>;
    <span class="hljs-type">boolean</span> <span class="hljs-title function_">isReadable</span><span class="hljs-params">()</span>;
    <span class="hljs-type">boolean</span> <span class="hljs-title function_">isOpen</span><span class="hljs-params">()</span>;
    URL <span class="hljs-title function_">getURL</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException;
    URI <span class="hljs-title function_">getURI</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException;
    File <span class="hljs-title function_">getFile</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException;
    <span class="hljs-type">long</span> <span class="hljs-title function_">contentLength</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException;
    <span class="hljs-type">long</span> <span class="hljs-title function_">lastModified</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException;
    Resource <span class="hljs-title function_">createRelative</span><span class="hljs-params">(String var1)</span> <span class="hljs-keyword">throws</span> IOException;
    String <span class="hljs-title function_">getFilename</span><span class="hljs-params">()</span>;
    String <span class="hljs-title function_">getDescription</span><span class="hljs-params">()</span>;
}
</code></pre>
<p>InputStreamSource 只有 getInputStream() 返回 InputStream，可以返回任何 InputStream 类。Resource 接口抽象了所有 Spring 内部使用到的底层资源，例如 File、URL、ClassPath 等，不同来源的资源文件都有其 Resource 实现：文件（FileSystemResource）、Classpath 资源（ClassPathResource）、URL 资源（UrlResource）、InputStream 资源（InputStreamResource）、Byte 数组（ByteArrayResource）等。</p>
<ul>
<li>exists：存在性</li>
<li>isReadable：可读性</li>
<li>isOpen：是否处于打开状态</li>
<li>getURL：获取 URL</li>
<li>getURI：获取 URI</li>
<li>getFile：获取 File 类型</li>
<li>lastModified：获取资源最后一次被修改的时间戳</li>
<li>getFilename：获取文件名</li>
<li>createRelative：基于当前资源创建一个相对资源</li>
<li>getDescription：在错误处理中打印信息</li>
</ul>
<p>通过 Resource 相关类对配置文件进行封装后配置文件的读取工作交给 XmlBeanDefinitionReader 处理。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-title function_">XmlBeanFactory</span><span class="hljs-params">(Resource resource)</span> <span class="hljs-keyword">throws</span> BeansException {
   <span class="hljs-built_in">this</span>(resource, <span class="hljs-literal">null</span>);
}

<span class="hljs-keyword">public</span> <span class="hljs-title function_">XmlBeanFactory</span><span class="hljs-params">(Resource resource, BeanFactory parentBeanFactory)</span> <span class="hljs-keyword">throws</span> BeansException {
   <span class="hljs-built_in">super</span>(parentBeanFactory);
   <span class="hljs-built_in">this</span>.reader.loadBeanDefinitions(resource);
}
</code></pre>
<p><code>this.reader.loadBeanDefinitions(resource)</code> 是资源加载的真正实现，在此之前调用父类的构造函数初始化过程 <code>super(parentBeanFactory)</code>，为父类 AbstractAutowireCapableBeanFactory 的构造函数。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-title function_">AbstractAutowireCapableBeanFactory</span><span class="hljs-params">()</span> {
   <span class="hljs-built_in">super</span>();
   ignoreDependencyInterface(BeanNameAware.class);
   ignoreDependencyInterface(BeanFactoryAware.class);
   ignoreDependencyInterface(BeanClassLoaderAware.class);
}
</code></pre>
<p><code>ignoreDependencyInterface</code> 的主要功能是忽略给定接口的自动装配功能，自动装配功能比如 A 中有属性 B，A 在初始化的过程中会默认初始化 B，也是 Spring 的一个重要特性。在某些情况下 B 不会被初始化，例如 B 实现了 BeanNameAware 接口，典型应用是通过其他方式解析 Application 上下文注册依赖，类似 BeanFactory 通过 BeanFactoryAware 注入或者 ApplicationContext 通过 ApplicationContextAware 注入。</p>
<h4 data-id="heading-6">2.3.2 加载 Bean</h4>
<p>XmlBeanDefinitionReader 的 loadBeanDefinitions 方法是整个资源加载的切入点</p>
<ol>
<li>new EncodedResource(resource)</li>
<li>loadBeanDefinitions(new EncodedResource(resource))</li>
<li>encodedResource.getResource().getInputStream()</li>
<li>new InputSource(inputStream)</li>
<li>doLoadBeanDefinitions(inputSource, encodedResource.getResource())</li>
</ol>
<p>调用逻辑如下：</p>
<ol>
<li>对 Resource 进行 EncodedResource 类封装，目的是考虑 Resource 可能存在的编码要求情况</li>
<li>获取 Resource 对应的 InputStream 并构造 InputSource，后续通过 SAX 读取 xml 文件</li>
<li>根据 InputSource 和 Resource 调用核心方法 doLoadBeanDefinitions</li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">loadBeanDefinitions</span><span class="hljs-params">(Resource resource)</span> <span class="hljs-keyword">throws</span> BeanDefinitionStoreException {
   <span class="hljs-keyword">return</span> loadBeanDefinitions(<span class="hljs-keyword">new</span> <span class="hljs-title class_">EncodedResource</span>(resource));
}
</code></pre>
<p>EncodedResource 的作用是对资源文件的编码进行处理，主要逻辑在 getReader 方法中</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> Reader <span class="hljs-title function_">getReader</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException {
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.charset != <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InputStreamReader</span>(<span class="hljs-built_in">this</span>.resource.getInputStream(), <span class="hljs-built_in">this</span>.charset);
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.encoding != <span class="hljs-literal">null</span> ? <span class="hljs-keyword">new</span> <span class="hljs-title class_">InputStreamReader</span>(<span class="hljs-built_in">this</span>.resource.getInputStream(), <span class="hljs-built_in">this</span>.encoding) : <span class="hljs-keyword">new</span> <span class="hljs-title class_">InputStreamReader</span>(<span class="hljs-built_in">this</span>.resource.getInputStream());
    }
}
</code></pre>
<p>回到 <code>loadBeanDefinitions(new EncodedResource(resource))</code> 方法</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">loadBeanDefinitions</span><span class="hljs-params">(EncodedResource encodedResource)</span> <span class="hljs-keyword">throws</span> BeanDefinitionStoreException {
   Assert.notNull(encodedResource, <span class="hljs-string">"EncodedResource must not be null"</span>);
   <span class="hljs-keyword">if</span> (logger.isInfoEnabled()) {
      logger.info(<span class="hljs-string">"Loading XML bean definitions from "</span> + encodedResource.getResource());
   }
   
   <span class="hljs-comment">// 记录已加载的资源</span>
   Set&lt;EncodedResource&gt; currentResources = <span class="hljs-built_in">this</span>.resourcesCurrentlyBeingLoaded.get();
   <span class="hljs-keyword">if</span> (currentResources == <span class="hljs-literal">null</span>) {
      currentResources = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;EncodedResource&gt;(<span class="hljs-number">4</span>);
      <span class="hljs-built_in">this</span>.resourcesCurrentlyBeingLoaded.set(currentResources);
   }
   <span class="hljs-keyword">if</span> (!currentResources.add(encodedResource)) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanDefinitionStoreException</span>(
            <span class="hljs-string">"Detected cyclic loading of "</span> + encodedResource + <span class="hljs-string">" - check your import definitions!"</span>);
   }
   <span class="hljs-keyword">try</span> {
      <span class="hljs-comment">// 获取 InputStream</span>
      <span class="hljs-type">InputStream</span> <span class="hljs-variable">inputStream</span> <span class="hljs-operator">=</span> encodedResource.getResource().getInputStream();
      <span class="hljs-keyword">try</span> {
         <span class="hljs-comment">// 封装为 org.xml.sax.InputSource 便于后面处理 xml 文件</span>
         <span class="hljs-type">InputSource</span> <span class="hljs-variable">inputSource</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InputSource</span>(inputStream);
         <span class="hljs-keyword">if</span> (encodedResource.getEncoding() != <span class="hljs-literal">null</span>) {
            inputSource.setEncoding(encodedResource.getEncoding());
         }
         <span class="hljs-comment">// 核心处理部分</span>
         <span class="hljs-keyword">return</span> doLoadBeanDefinitions(inputSource, encodedResource.getResource());
      }
      <span class="hljs-keyword">finally</span> {
         inputStream.close();
      }
   }
   <span class="hljs-keyword">catch</span> (IOException ex) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanDefinitionStoreException</span>(
            <span class="hljs-string">"IOException parsing XML document from "</span> + encodedResource.getResource(), ex);
   }
   <span class="hljs-keyword">finally</span> {
      currentResources.remove(encodedResource);
      <span class="hljs-keyword">if</span> (currentResources.isEmpty()) {
         <span class="hljs-built_in">this</span>.resourcesCurrentlyBeingLoaded.remove();
      }
   }
}
</code></pre>
<p>接下来进入核心处理方法 <code>doLoadBeanDefinitions</code></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">protected</span> <span class="hljs-type">int</span> <span class="hljs-title function_">doLoadBeanDefinitions</span><span class="hljs-params">(InputSource inputSource, Resource resource)</span>
      <span class="hljs-keyword">throws</span> BeanDefinitionStoreException {
   <span class="hljs-keyword">try</span> {
      <span class="hljs-type">int</span> <span class="hljs-variable">validationMode</span> <span class="hljs-operator">=</span> getValidationModeForResource(resource);
      <span class="hljs-type">Document</span> <span class="hljs-variable">doc</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.documentLoader.loadDocument(
            inputSource, getEntityResolver(), <span class="hljs-built_in">this</span>.errorHandler, validationMode, isNamespaceAware());
      <span class="hljs-keyword">return</span> registerBeanDefinitions(doc, resource);
   }
   <span class="hljs-keyword">catch</span> (BeanDefinitionStoreException ex) {
      <span class="hljs-keyword">throw</span> ex;
   }
   <span class="hljs-keyword">catch</span> (SAXParseException ex) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">XmlBeanDefinitionStoreException</span>(resource.getDescription(),
            <span class="hljs-string">"Line "</span> + ex.getLineNumber() + <span class="hljs-string">" in XML document from "</span> + resource + <span class="hljs-string">" is invalid"</span>, ex);
   }
   <span class="hljs-keyword">catch</span> (SAXException ex) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">XmlBeanDefinitionStoreException</span>(resource.getDescription(),
            <span class="hljs-string">"XML document from "</span> + resource + <span class="hljs-string">" is invalid"</span>, ex);
   }
   <span class="hljs-keyword">catch</span> (ParserConfigurationException ex) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanDefinitionStoreException</span>(resource.getDescription(),
            <span class="hljs-string">"Parser configuration exception parsing XML from "</span> + resource, ex);
   }
   <span class="hljs-keyword">catch</span> (IOException ex) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanDefinitionStoreException</span>(resource.getDescription(),
            <span class="hljs-string">"IOException parsing XML document from "</span> + resource, ex);
   }
   <span class="hljs-keyword">catch</span> (Throwable ex) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanDefinitionStoreException</span>(resource.getDescription(),
            <span class="hljs-string">"Unexpected exception parsing XML document from "</span> + resource, ex);
   }
}
</code></pre>
<p>不考虑异常处理，上面代码逻辑如下：</p>
<ol>
<li>获取 xml 文件的验证模式 <code>getValidationModeForResource</code></li>
<li>加载 xml 文件，获取对应的 Document <code>loadDocument</code></li>
<li>根据 Document 注册 Bean 信息 <code>registerBeanDefinitions</code></li>
</ol>
<p>接下来对这三个步骤进行分析</p>
<h3 data-id="heading-7">2.4 获取 xml 的验证模式</h3>
<p>xml 文件的验证模式保证 xml 文件的正确性，常见的验证模式为 DTD 和 XSD</p>
<h4 data-id="heading-8">2.4.1 DTD 和 XSD 区别</h4>
<p>DTD（Document Type Definition）即文档类型定义，是一种 xml 约束模式语言，是 xml 文件的验证机制，属于 xml 文件组成的一部分。DTD 是一种保证 xml 文档格式正确的有效方法，可以通过比较 xml 文档和 DTD 文件来看 xml 是否符合规范，元素和标签是否正确。DTD 文档包含：元素的定义规则，元素间关系的定义规则，元素可使用的属性，可使用的实体或符号规则。</p>
<p>Spring 中使用 DTD 文件的声明方式如下</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"UTF-8"</span>?&gt;</span>
<span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">beans</span> <span class="hljs-keyword">PUBLIC</span> <span class="hljs-string">"-//SPRING//DTD BEAN 2.0//EN"</span>
        <span class="hljs-string">"http://www.springframework.org/dtd/spring-beans-2.0.dtd"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">beans</span>&gt;</span>
...
<span class="hljs-tag">&lt;/<span class="hljs-name">beans</span>&gt;</span>
</code></pre>
<p>Spring 的 spring-beans-2.0.dtd 如下</p>
<pre><code class="hljs language-dtd" lang="dtd">&lt;!ELEMENT beans (
   description?,
   (import | alias | bean)*
)&gt;

&lt;!ATTLIST beans default-lazy-init (true | false) "false"&gt;
&lt;!ATTLIST beans default-merge (true | false) "false"&gt;
&lt;!ATTLIST beans default-autowire (no | byName | byType | constructor | autodetect) "no"&gt;
&lt;!ATTLIST beans default-dependency-check (none | objects | simple | all) "none"&gt;
&lt;!ATTLIST beans default-init-method CDATA #IMPLIED&gt;
&lt;!ATTLIST beans default-destroy-method CDATA #IMPLIED&gt;

&lt;!ELEMENT description (#PCDATA)&gt;
...
</code></pre>
<p>XML Schemas 是 XSD（XML Schemas Definition），描述了 xml 文档的结构，可以来指定 xml 文档所允许的结构，并由此来校验 xml 文档的结构是否是有效的。XML Schemas 本身就是一个 xml 文档，符合 xml 的语法结构，可以用通用的 xml 解析器解析。</p>
<p>XML Schemas 需要声明的部分如下：</p>
<ul>
<li>名称空间 <code>xmlns="http://www.springframework.org/schema/beans</code></li>
<li>XML Schemas 的存储位置 schemaLocation <code>xsi:schemaLocation="http://www.springframework.org/schema/beans      http://www.springframework.org/schema/beans/spring-beans.xsd</code>
<ul>
<li>名称空间 URI</li>
<li>该名称空间所标识的 XML Schemas 文件位置或 URL 地址</li>
</ul>
</li>
</ul>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"UTF-8"</span>?&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">beans</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://www.springframework.org/schema/beans"</span>
       <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span>
       <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">"http://www.springframework.org/schema/beans
       http://www.springframework.org/schema/beans/spring-beans.xsd"</span>&gt;</span>
...
<span class="hljs-tag">&lt;/<span class="hljs-name">beans</span>&gt;</span>
</code></pre>
<p>Spring 的 spring-beans-3.0.xsd 如下</p>
<pre><code class="hljs language-xsd" lang="xsd"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"UTF-8"</span> standalone=<span class="hljs-string">"no"</span>?&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">xsd:schema</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://www.springframework.org/schema/beans"</span>
      <span class="hljs-attr">xmlns:xsd</span>=<span class="hljs-string">"http://www.w3.org/2001/XMLSchema"</span>
      <span class="hljs-attr">targetNamespace</span>=<span class="hljs-string">"http://www.springframework.org/schema/beans"</span>&gt;</span>

   <span class="hljs-tag">&lt;<span class="hljs-name">xsd:import</span> <span class="hljs-attr">namespace</span>=<span class="hljs-string">"http://www.w3.org/XML/1998/namespace"</span>/&gt;</span>

   <span class="hljs-tag">&lt;<span class="hljs-name">xsd:annotation</span>&gt;</span>
....
</code></pre>
<h4 data-id="heading-9">2.4.2 验证模式的读取</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">protected</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getValidationModeForResource</span><span class="hljs-params">(Resource resource)</span> {
   <span class="hljs-comment">// VALIDATION_AUTO</span>
   <span class="hljs-type">int</span> <span class="hljs-variable">validationModeToUse</span> <span class="hljs-operator">=</span> getValidationMode();
   <span class="hljs-comment">// 如果手动指定了验证模式则使用指定验证模式</span>
   <span class="hljs-keyword">if</span> (validationModeToUse != VALIDATION_AUTO) {
      <span class="hljs-keyword">return</span> validationModeToUse;
   }
   <span class="hljs-comment">// 自动检测</span>
   <span class="hljs-type">int</span> <span class="hljs-variable">detectedMode</span> <span class="hljs-operator">=</span> detectValidationMode(resource);
   <span class="hljs-keyword">if</span> (detectedMode != VALIDATION_AUTO) {
      <span class="hljs-keyword">return</span> detectedMode;
   }
   <span class="hljs-keyword">return</span> VALIDATION_XSD;
}
</code></pre>
<p>上面代码如果指定了验证模式（可通过 <code>XmlBeanDefinitionReader</code> 的 <code>public void setValidationMode(int validationMode)</code> 指定）则用指定的验证模式，否则通过 <code>detectValidationMode</code> 自动检测，自动检测验证模式的有专门处理类 <code>XmlValidationModeDetector</code> 的 <code>detectValidationMode(InputStream inputStream)</code> 实现</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">protected</span> <span class="hljs-type">int</span> <span class="hljs-title function_">detectValidationMode</span><span class="hljs-params">(Resource resource)</span> {
   <span class="hljs-keyword">if</span> (resource.isOpen()) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanDefinitionStoreException</span>(
            <span class="hljs-string">"Passed-in Resource ["</span> + resource + <span class="hljs-string">"] contains an open stream: "</span> +
            <span class="hljs-string">"cannot determine validation mode automatically. Either pass in a Resource "</span> +
            <span class="hljs-string">"that is able to create fresh streams, or explicitly specify the validationMode "</span> +
            <span class="hljs-string">"on your XmlBeanDefinitionReader instance."</span>);
   }

   InputStream inputStream;
   <span class="hljs-keyword">try</span> {
      inputStream = resource.getInputStream();
   }
   <span class="hljs-keyword">catch</span> (IOException ex) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanDefinitionStoreException</span>(
            <span class="hljs-string">"Unable to determine validation mode for ["</span> + resource + <span class="hljs-string">"]: cannot open InputStream. "</span> +
            <span class="hljs-string">"Did you attempt to load directly from a SAX InputSource without specifying the "</span> +
            <span class="hljs-string">"validationMode on your XmlBeanDefinitionReader instance?"</span>, ex);
   }

   <span class="hljs-keyword">try</span> {
      <span class="hljs-comment">// 自动检测验证模式</span>
      <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.validationModeDetector.detectValidationMode(inputStream);
   }
   <span class="hljs-keyword">catch</span> (IOException ex) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanDefinitionStoreException</span>(<span class="hljs-string">"Unable to determine validation mode for ["</span> +
            resource + <span class="hljs-string">"]: an error occurred whilst reading from the InputStream."</span>, ex);
   }
}
</code></pre>
<p><code>XmlValidationModeDetector</code> 的 <code>detectValidationMode(InputStream inputStream)</code> 方法如下</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">detectValidationMode</span><span class="hljs-params">(InputStream inputStream)</span> <span class="hljs-keyword">throws</span> IOException {
    <span class="hljs-type">BufferedReader</span> <span class="hljs-variable">reader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedReader</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InputStreamReader</span>(inputStream));

    <span class="hljs-type">byte</span> var4;
    <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// 是否为 DTD 验证模式</span>
        <span class="hljs-type">boolean</span> <span class="hljs-variable">isDtdValidated</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;

        <span class="hljs-keyword">while</span>(<span class="hljs-literal">true</span>) {
            String content;
            <span class="hljs-keyword">if</span> ((content = reader.readLine()) != <span class="hljs-literal">null</span>) {
                content = <span class="hljs-built_in">this</span>.consumeCommentTokens(content);
                <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.inComment || !StringUtils.hasText(content)) {
                    <span class="hljs-keyword">continue</span>;
                }

                <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.hasDoctype(content)) {
                    isDtdValidated = <span class="hljs-literal">true</span>;
                } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">this</span>.hasOpeningTag(content)) {
                    <span class="hljs-keyword">continue</span>;
                }
            }

            <span class="hljs-type">int</span> <span class="hljs-variable">var5</span> <span class="hljs-operator">=</span> isDtdValidated ? VALIDATION_DTD : VALIDATION_XSD;
            <span class="hljs-keyword">return</span> var5;
        }
    } <span class="hljs-keyword">catch</span> (CharConversionException var9) {
        var4 = VALIDATION_AUTO;
    } <span class="hljs-keyword">finally</span> {
        reader.close();
    }

    <span class="hljs-keyword">return</span> var4;
}
</code></pre>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">hasDoctype</span><span class="hljs-params">(String content)</span> {
    <span class="hljs-keyword">return</span> content.indexOf(<span class="hljs-string">"DOCTYPE"</span>) &gt; -<span class="hljs-number">1</span>;
}
</code></pre>
<p>Spring 自动检测验证模式的方法是判断是否包含 DOCTYPE，若包含则为 DTD，否则为 XSD</p>
<h3 data-id="heading-10">2.5 获取 Document</h3>
<p>获取到 xml 验证模式后需要进行 Document 加载，使用的是 DocumentLoader 接口的 DefaultDocumentLoader 实现类 loadDocument 方法进行加载，代码如下</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-type">DocumentLoader</span> <span class="hljs-variable">documentLoader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultDocumentLoader</span>();

<span class="hljs-type">Document</span> <span class="hljs-variable">doc</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.documentLoader.loadDocument(
      inputSource, getEntityResolver(), <span class="hljs-built_in">this</span>.errorHandler, validationMode, isNamespaceAware());
</code></pre>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> Document <span class="hljs-title function_">loadDocument</span><span class="hljs-params">(InputSource inputSource, EntityResolver entityResolver,
      ErrorHandler errorHandler, <span class="hljs-type">int</span> validationMode, <span class="hljs-type">boolean</span> namespaceAware)</span> <span class="hljs-keyword">throws</span> Exception {

   <span class="hljs-type">DocumentBuilderFactory</span> <span class="hljs-variable">factory</span> <span class="hljs-operator">=</span> createDocumentBuilderFactory(validationMode, namespaceAware);
   <span class="hljs-keyword">if</span> (logger.isDebugEnabled()) {
      logger.debug(<span class="hljs-string">"Using JAXP provider ["</span> + factory.getClass().getName() + <span class="hljs-string">"]"</span>);
   }
   <span class="hljs-type">DocumentBuilder</span> <span class="hljs-variable">builder</span> <span class="hljs-operator">=</span> createDocumentBuilder(factory, entityResolver, errorHandler);
   <span class="hljs-keyword">return</span> builder.parse(inputSource);
}
</code></pre>
<p>通过 SAX 解析 xml 文档</p>
<ol>
<li>创建 DocumentBuilderFactory</li>
<li>通过 DocumentBuilderFactory 创建 DocumentBuilder</li>
<li>使用 DocumentBuilder 进行解析</li>
</ol>
<p>分析下 <code>loadDocument</code> 方法的 <code>EntityResolver</code> 参数，<code>getEntityResolver</code> 方法代码如下：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">protected</span> EntityResolver <span class="hljs-title function_">getEntityResolver</span><span class="hljs-params">()</span> {
   <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.entityResolver == <span class="hljs-literal">null</span>) {
      <span class="hljs-type">ResourceLoader</span> <span class="hljs-variable">resourceLoader</span> <span class="hljs-operator">=</span> getResourceLoader();
      <span class="hljs-keyword">if</span> (resourceLoader != <span class="hljs-literal">null</span>) {
         <span class="hljs-built_in">this</span>.entityResolver = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ResourceEntityResolver</span>(resourceLoader);
      }
      <span class="hljs-keyword">else</span> {
         <span class="hljs-built_in">this</span>.entityResolver = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DelegatingEntityResolver</span>(getBeanClassLoader());
      }
   }
   <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.entityResolver;
}
</code></pre>
<h4 data-id="heading-11">2.5.1 EntityResolver 用法</h4>
<p>对于解析一个 xml，SAX 会首先读取 xml 文档上的声明，根据声明去寻找相应的 DTD 定义来对文档进行验证。默认的寻找规则通过网络（声明 DTD 的 URI 地址）进行下载 DTD 声明然后验证。但是下载遇到网络中断或者不可用就会报错。</p>
<p>EntityResolver 的作用是项目本身可以提供寻找 DTD 声明的方法，由程序来实现寻找 DTD 的过程。EntityResolver 接口代码如下：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">EntityResolver</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> InputSource <span class="hljs-title function_">resolveEntity</span> <span class="hljs-params">(String publicId,
                                               String systemId)</span>
        <span class="hljs-keyword">throws</span> SAXException, IOException;
}
</code></pre>
<p>接收两个参数 publicId 和 systemId，返回 InputSource</p>
<p>（1）如果是 XSD 验证模式的配置文件，代码如下：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"UTF-8"</span>?&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">beans</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://www.springframework.org/schema/beans"</span>
       <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span>
       <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">"http://www.springframework.org/schema/beans
       http://www.springframework.org/schema/beans/spring-beans.xsd"</span>&gt;</span>
      
<span class="hljs-tag">&lt;/<span class="hljs-name">beans</span>&gt;</span>
</code></pre>
<p>其中关键部分是 <code>xsi:schemaLocation="http://www.springframework.org/schema/beans        http://www.springframework.org/schema/beans/spring-beans.xsd</code> 两个参数为：</p>
<ul>
<li><code>publicId: null</code></li>
<li><code>systemId: http://www.springframework.org/schema/beans/spring-beans.xsd</code></li>
</ul>
<p>（2）如果是 DTD 验证模式的配置文件，代码如下：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"UTF-8"</span>?&gt;</span>
<span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">beans</span> <span class="hljs-keyword">PUBLIC</span> <span class="hljs-string">"-//SPRING//DTD BEAN 2.0//EN"</span>
<span class="hljs-string">"http://www.springframework.org/dtd/spring-beans-2.0.dtd"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">beans</span>&gt;</span> 
... 
<span class="hljs-tag">&lt;/<span class="hljs-name">beans</span>&gt;</span>
</code></pre>
<p>上面的两个参数为：</p>
<ul>
<li><code>publicId: -//SPRING//DTD BEAN 2.0//EN</code></li>
<li><code>systemId: http://www.springframework.org/dtd/spring-beans-2.0.dtd</code></li>
</ul>
<p>如果将验证文件通过网络下载用户体验会有延迟，一般做法是将验证文件放到自己的工程里。在 Spring 中使用的是 DelegatingEntityResolver 作为 EntityResolver 的实现类，resolveEntity 实现方法如下：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">DTD_SUFFIX</span> <span class="hljs-operator">=</span> <span class="hljs-string">".dtd"</span>;
<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">XSD_SUFFIX</span> <span class="hljs-operator">=</span> <span class="hljs-string">".xsd"</span>;

<span class="hljs-keyword">public</span> InputSource <span class="hljs-title function_">resolveEntity</span><span class="hljs-params">(String publicId, String systemId)</span> <span class="hljs-keyword">throws</span> SAXException, IOException {
   <span class="hljs-keyword">if</span> (systemId != <span class="hljs-literal">null</span>) {
      <span class="hljs-keyword">if</span> (systemId.endsWith(DTD_SUFFIX)) {
         <span class="hljs-comment">// DTD 文件从这里解析</span>
         <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.dtdResolver.resolveEntity(publicId, systemId);
      }
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (systemId.endsWith(XSD_SUFFIX)) {
         <span class="hljs-comment">// XSD 文件从这里解析</span>
         <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.schemaResolver.resolveEntity(publicId, systemId);
      }
   }
   <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
}
</code></pre>
<p>从上面可以看到，DTD 和 XSD 文件使用不同的解析器进行解析</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0620611b5d28494eb28c0e53475b806d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVG9Qb3NzZXNzTGlnaHQwOTAy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763285555&amp;x-signature=Ahf0PA83OWLtzUitFcB%2FTEYTH74%3D" alt="image.png" loading="lazy"/></p>
<p>加载 DTD 类型的 <code>BeansDtdResolver</code> 截取 systemId 作为最后的 <code>.dtd</code> 然后从当前路径下寻找，代码如下：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">DTD_EXTENSION</span> <span class="hljs-operator">=</span> <span class="hljs-string">".dtd"</span>;

<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String[] DTD_NAMES = {<span class="hljs-string">"spring-beans-2.0"</span>, <span class="hljs-string">"spring-beans"</span>};

<span class="hljs-keyword">public</span> InputSource <span class="hljs-title function_">resolveEntity</span><span class="hljs-params">(String publicId, String systemId)</span> <span class="hljs-keyword">throws</span> IOException {
   <span class="hljs-keyword">if</span> (logger.isTraceEnabled()) {
      logger.trace(<span class="hljs-string">"Trying to resolve XML entity with public ID ["</span> + publicId +
            <span class="hljs-string">"] and system ID ["</span> + systemId + <span class="hljs-string">"]"</span>);
   }
   <span class="hljs-keyword">if</span> (systemId != <span class="hljs-literal">null</span> &amp;&amp; systemId.endsWith(DTD_EXTENSION)) {
      <span class="hljs-type">int</span> <span class="hljs-variable">lastPathSeparator</span> <span class="hljs-operator">=</span> systemId.lastIndexOf(<span class="hljs-string">"/"</span>);
      <span class="hljs-keyword">for</span> (String DTD_NAME : DTD_NAMES) {
         <span class="hljs-type">int</span> <span class="hljs-variable">dtdNameStart</span> <span class="hljs-operator">=</span> systemId.indexOf(DTD_NAME);
         <span class="hljs-keyword">if</span> (dtdNameStart &gt; lastPathSeparator) {
            <span class="hljs-type">String</span> <span class="hljs-variable">dtdFile</span> <span class="hljs-operator">=</span> systemId.substring(dtdNameStart);
            <span class="hljs-keyword">if</span> (logger.isTraceEnabled()) {
               logger.trace(<span class="hljs-string">"Trying to locate ["</span> + dtdFile + <span class="hljs-string">"] in Spring jar"</span>);
            }
            <span class="hljs-keyword">try</span> {
               <span class="hljs-type">Resource</span> <span class="hljs-variable">resource</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassPathResource</span>(dtdFile, getClass());
               <span class="hljs-type">InputSource</span> <span class="hljs-variable">source</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InputSource</span>(resource.getInputStream());
               source.setPublicId(publicId);
               source.setSystemId(systemId);
               <span class="hljs-keyword">if</span> (logger.isDebugEnabled()) {
                  logger.debug(<span class="hljs-string">"Found beans DTD ["</span> + systemId + <span class="hljs-string">"] in classpath: "</span> + dtdFile);
               }
               <span class="hljs-keyword">return</span> source;
            }
            <span class="hljs-keyword">catch</span> (IOException ex) {
               <span class="hljs-keyword">if</span> (logger.isDebugEnabled()) {
                  logger.debug(<span class="hljs-string">"Could not resolve beans DTD ["</span> + systemId + <span class="hljs-string">"]: not found in class path"</span>, ex);
               }
            }

         }
      }
   }
   <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
}
</code></pre>
<p>加载 XSD 类型的 <code>PluggableSchemaResolver</code> 默认从 <code>META-INF/spring.schemas</code> 文件中找到 systemId 对应的 XSD 文件并加载，代码如下：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">DEFAULT_SCHEMA_MAPPINGS_LOCATION</span> <span class="hljs-operator">=</span> <span class="hljs-string">"META-INF/spring.schemas"</span>;

<span class="hljs-keyword">public</span> InputSource <span class="hljs-title function_">resolveEntity</span><span class="hljs-params">(String publicId, String systemId)</span> <span class="hljs-keyword">throws</span> IOException {
   <span class="hljs-keyword">if</span> (logger.isTraceEnabled()) {
      logger.trace(<span class="hljs-string">"Trying to resolve XML entity with public id ["</span> + publicId +
            <span class="hljs-string">"] and system id ["</span> + systemId + <span class="hljs-string">"]"</span>);
   }

   <span class="hljs-keyword">if</span> (systemId != <span class="hljs-literal">null</span>) {
      <span class="hljs-type">String</span> <span class="hljs-variable">resourceLocation</span> <span class="hljs-operator">=</span> getSchemaMappings().get(systemId);
      <span class="hljs-keyword">if</span> (resourceLocation != <span class="hljs-literal">null</span>) {
         <span class="hljs-type">Resource</span> <span class="hljs-variable">resource</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassPathResource</span>(resourceLocation, <span class="hljs-built_in">this</span>.classLoader);
         <span class="hljs-keyword">try</span> {
            <span class="hljs-type">InputSource</span> <span class="hljs-variable">source</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InputSource</span>(resource.getInputStream());
            source.setPublicId(publicId);
            source.setSystemId(systemId);
            <span class="hljs-keyword">if</span> (logger.isDebugEnabled()) {
               logger.debug(<span class="hljs-string">"Found XML schema ["</span> + systemId + <span class="hljs-string">"] in classpath: "</span> + resourceLocation);
            }
            <span class="hljs-keyword">return</span> source;
         }
         <span class="hljs-keyword">catch</span> (FileNotFoundException ex) {
            <span class="hljs-keyword">if</span> (logger.isDebugEnabled()) {
               logger.debug(<span class="hljs-string">"Couldn't find XML schema ["</span> + systemId + <span class="hljs-string">"]: "</span> + resource, ex);
            }
         }
      }
   }
   <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
}

<span class="hljs-comment">/**
 * Load the specified schema mappings lazily.
 */</span>
<span class="hljs-keyword">private</span> Map&lt;String, String&gt; <span class="hljs-title function_">getSchemaMappings</span><span class="hljs-params">()</span> {
   <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.schemaMappings == <span class="hljs-literal">null</span>) {
      <span class="hljs-keyword">synchronized</span> (<span class="hljs-built_in">this</span>) {
         <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.schemaMappings == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">if</span> (logger.isDebugEnabled()) {
               logger.debug(<span class="hljs-string">"Loading schema mappings from ["</span> + <span class="hljs-built_in">this</span>.schemaMappingsLocation + <span class="hljs-string">"]"</span>);
            }
            <span class="hljs-keyword">try</span> {
               <span class="hljs-type">Properties</span> <span class="hljs-variable">mappings</span> <span class="hljs-operator">=</span>
                     PropertiesLoaderUtils.loadAllProperties(<span class="hljs-built_in">this</span>.schemaMappingsLocation, <span class="hljs-built_in">this</span>.classLoader);
               <span class="hljs-keyword">if</span> (logger.isDebugEnabled()) {
                  logger.debug(<span class="hljs-string">"Loaded schema mappings: "</span> + mappings);
               }
               Map&lt;String, String&gt; schemaMappings = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;String, String&gt;(mappings.size());
               CollectionUtils.mergePropertiesIntoMap(mappings, schemaMappings);
               <span class="hljs-built_in">this</span>.schemaMappings = schemaMappings;
            }
            <span class="hljs-keyword">catch</span> (IOException ex) {
               <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>(
                     <span class="hljs-string">"Unable to load schema mappings from location ["</span> + <span class="hljs-built_in">this</span>.schemaMappingsLocation + <span class="hljs-string">"]"</span>, ex);
            }
         }
      }
   }
   <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.schemaMappings;
}
</code></pre>
<h3 data-id="heading-12">2.6 解析及注册 BeanDefinitions</h3>
<p>获取到 Document 后，接下来对 <code>registerBeanDefinitions(doc, resource)</code> 进行分析，代码如下：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">registerBeanDefinitions</span><span class="hljs-params">(Document doc, Resource resource)</span> <span class="hljs-keyword">throws</span> BeanDefinitionStoreException {
   <span class="hljs-comment">// 使用 DefaultBeanDefinitionDocumentReader 实例化 BeanDefinitionDocumentReader</span>
   <span class="hljs-type">BeanDefinitionDocumentReader</span> <span class="hljs-variable">documentReader</span> <span class="hljs-operator">=</span> createBeanDefinitionDocumentReader();
   <span class="hljs-comment">// 设置环境变量</span>
   documentReader.setEnvironment(<span class="hljs-built_in">this</span>.getEnvironment());
   <span class="hljs-comment">// 实例化 BeanDefinitionReader 时默认传入 BeanDefinitionRegistry，实现是 DefaultListableBeanFactory。记录统计前的 BeanDefinition 的加载个数</span>
   <span class="hljs-type">int</span> <span class="hljs-variable">countBefore</span> <span class="hljs-operator">=</span> getRegistry().getBeanDefinitionCount();
   <span class="hljs-comment">// 加载及注册 bean</span>
   documentReader.registerBeanDefinitions(doc, createReaderContext(resource));
   <span class="hljs-comment">// 记录本次加载的 BeanDefinition 个数</span>
   <span class="hljs-keyword">return</span> getRegistry().getBeanDefinitionCount() - countBefore;
}
</code></pre>
<p>BeanDefinitionDocumentReader 是一个接口，实例化为 <code>DefaultBeanDefinitionDocumentReader</code>，进入后发现核心方法 <code>registerBeanDefinitions</code> 的重要目的之一是提取 root，以便再次使用 root 作为参数继续 BeanDefinition 的注册，代码如下：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">registerBeanDefinitions</span><span class="hljs-params">(Document doc, XmlReaderContext readerContext)</span> {
   <span class="hljs-built_in">this</span>.readerContext = readerContext;
   logger.debug(<span class="hljs-string">"Loading bean definitions"</span>);
   <span class="hljs-type">Element</span> <span class="hljs-variable">root</span> <span class="hljs-operator">=</span> doc.getDocumentElement();
   doRegisterBeanDefinitions(root);
}
</code></pre>
<p>可以看到核心逻辑的底部是 <code>doRegisterBeanDefinitions</code> 方法，代码如下：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">PROFILE_ATTRIBUTE</span> <span class="hljs-operator">=</span> <span class="hljs-string">"profile"</span>;

<span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doRegisterBeanDefinitions</span><span class="hljs-params">(Element root)</span> {
   <span class="hljs-comment">// 处理 profile 属性</span>
   <span class="hljs-type">String</span> <span class="hljs-variable">profileSpec</span> <span class="hljs-operator">=</span> root.getAttribute(PROFILE_ATTRIBUTE);
   <span class="hljs-keyword">if</span> (StringUtils.hasText(profileSpec)) {
      Assert.state(<span class="hljs-built_in">this</span>.environment != <span class="hljs-literal">null</span>, <span class="hljs-string">"Environment must be set for evaluating profiles"</span>);
      String[] specifiedProfiles = StringUtils.tokenizeToStringArray(
            profileSpec, BeanDefinitionParserDelegate.MULTI_VALUE_ATTRIBUTE_DELIMITERS);
      <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">this</span>.environment.acceptsProfiles(specifiedProfiles)) {
         <span class="hljs-keyword">return</span>;
      }
   }
   
   <span class="hljs-type">BeanDefinitionParserDelegate</span> <span class="hljs-variable">parent</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.delegate;
   <span class="hljs-built_in">this</span>.delegate = createHelper(<span class="hljs-built_in">this</span>.readerContext, root, parent);

   <span class="hljs-comment">// 解析前置处理，留给子类实现</span>
   preProcessXml(root);
   <span class="hljs-comment">// 解析并注册</span>
   parseBeanDefinitions(root, <span class="hljs-built_in">this</span>.delegate);
   <span class="hljs-comment">// 解析后置处理，留给子类实现</span>
   postProcessXml(root);

   <span class="hljs-built_in">this</span>.delegate = parent;
}
</code></pre>
<p>可以看到 <code>preProcessXml</code> 和 <code>postProcessXml</code> 代码为空，这是面向对象设计方法中，一个类要么是面向继承设计，要么是 final 修饰，而 DefaultBeanDefinitionDocumentReader 没有被修饰为 final，这也是模板方法模式，子类可以继承 DefaultBeanDefinitionDocumentReader 重写这两个方法在 Bean 解析前后做出一些处理。</p>
<h4 data-id="heading-13">2.6.1 profile 属性的使用</h4>
<p>profile 属性可以根据不同的环境（例如开发、测试、生产）来激活不同的配置，在上面的代码方法中，Spring 会先获取 beans 是否定义了 profile 属性，如果定义了需要从环境变量中获取，因此断言 environment 不为空，因为 profile 可能为多个，因此拆分解析验证每个 profile 是否符合环境变量中的定义。例子如下：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"UTF-8"</span>?&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">beans</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://www.springframework.org/schema/beans"</span>
       <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span>
       <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">"http://www.springframework.org/schema/beans
       http://www.springframework.org/schema/beans/spring-beans.xsd"</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">beans</span> <span class="hljs-attr">profile</span>=<span class="hljs-string">"dev"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"myBeanName"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.reray.spring.study.MySpringBeanDev"</span>/&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">beans</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">beans</span> <span class="hljs-attr">profile</span>=<span class="hljs-string">"prod"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"myBeanName"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.reray.spring.study.MySpringBeanProd"</span>/&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">beans</span>&gt;</span>

<span class="hljs-tag">&lt;/<span class="hljs-name">beans</span>&gt;</span>
</code></pre>
<h4 data-id="heading-14">2.6.2 解析注册 BeanDefinition</h4>
<p>处理完 profile 后对 xml 读取，进入 <code>parseBeanDefinitions(root, this.delegate)</code> 代码如下：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">parseBeanDefinitions</span><span class="hljs-params">(Element root, BeanDefinitionParserDelegate delegate)</span> {
   <span class="hljs-keyword">if</span> (delegate.isDefaultNamespace(root)) {
      <span class="hljs-type">NodeList</span> <span class="hljs-variable">nl</span> <span class="hljs-operator">=</span> root.getChildNodes();
      <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; nl.getLength(); i++) {
         <span class="hljs-type">Node</span> <span class="hljs-variable">node</span> <span class="hljs-operator">=</span> nl.item(i);
         <span class="hljs-keyword">if</span> (node <span class="hljs-keyword">instanceof</span> Element) {
            <span class="hljs-type">Element</span> <span class="hljs-variable">ele</span> <span class="hljs-operator">=</span> (Element) node;
            <span class="hljs-keyword">if</span> (delegate.isDefaultNamespace(ele)) {
               <span class="hljs-comment">// 对 Bean 处理</span>
               parseDefaultElement(ele, delegate);
            }
            <span class="hljs-keyword">else</span> {
               <span class="hljs-comment">// 对 Bean 处理</span>
               delegate.parseCustomElement(ele);
            }
         }
      }
   }
   <span class="hljs-keyword">else</span> {
      delegate.parseCustomElement(root);
   }
}
</code></pre>
<p>Spring 中 xml 配置有两种 Bean 声明方式，默认的和自定义的。如果节点使用默认命名空间则采用 <code>parseDefaultElement</code> 进行解析，否则使用 <code>parseCustomElement</code> 解析。判断是默认的还是自定义的则使用 <code>delegate.isDefaultNamespace</code> 进行判断，使用 <code>node.getNamespaceURI()</code> 获取命名空间后和 <code>http://www.springframework.org/schema/beans</code> 进行对比</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">BEANS_NAMESPACE_URI</span> <span class="hljs-operator">=</span> <span class="hljs-string">"http://www.springframework.org/schema/beans"</span>;

<span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isDefaultNamespace</span><span class="hljs-params">(String namespaceUri)</span> {
   <span class="hljs-keyword">return</span> (!StringUtils.hasLength(namespaceUri) || BEANS_NAMESPACE_URI.equals(namespaceUri));
}

<span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isDefaultNamespace</span><span class="hljs-params">(Node node)</span> {
   <span class="hljs-keyword">return</span> isDefaultNamespace(getNamespaceURI(node));
}
</code></pre>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> String <span class="hljs-title function_">getNamespaceURI</span><span class="hljs-params">(Node node)</span> {
   <span class="hljs-keyword">return</span> node.getNamespaceURI();
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[RocketMQ vs Kafka01 - 存储架构深度对比]]></title>    <link>https://juejin.cn/post/7569959427878961162</link>    <guid>https://juejin.cn/post/7569959427878961162</guid>    <pubDate>2025-11-09T09:29:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7569959427878961162" data-draft-id="7569959427878944778" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="RocketMQ vs Kafka01 - 存储架构深度对比"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-09T09:29:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ZZHHWW"/> <meta itemprop="url" content="https://juejin.cn/user/985627390911096"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            RocketMQ vs Kafka01 - 存储架构深度对比
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/985627390911096/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ZZHHWW
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-09T09:29:51.000Z" title="Sun Nov 09 2025 09:29:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1小时+
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">第一篇：存储架构深度对比</h2>
<blockquote>
<p>存储架构是消息队列的核心基础，直接决定了消息队列的性能、可靠性和扩展性。本文将从存储模型设计理念、文件结构、消息读写流程等多个维度，深入对比 Kafka 和 RocketMQ 的存储架构设计，并结合源码实现和生产实践案例，帮助读者深入理解两种消息队列的存储设计哲学。</p>
</blockquote>
<hr/>
<h3 data-id="heading-1">1.1 存储模型设计理念</h3>
<p>消息队列的存储模型设计，本质上是在解决一个核心问题：<strong>如何高效地存储和检索海量消息</strong>。Kafka 和 RocketMQ 给出了两种截然不同的答案，这两种设计理念的差异，深刻影响了它们在性能、可靠性和适用场景上的表现。</p>
<h4 data-id="heading-2">Kafka 的分区日志模型</h4>
<p>Kafka 采用了经典的<strong>分区日志（Partition Log）模型</strong>，这一设计理念源于其最初的应用场景：<strong>日志收集与流式处理</strong>。Kafka 将消息存储抽象为"日志流"的概念，每个 Topic 被划分为多个 Partition，每个 Partition 就是一个有序的、不可变的日志序列。</p>
<h5 data-id="heading-3">Partition + Segment 设计</h5>
<p>Kafka 的核心设计思想是：<strong>将每个 Partition 进一步切分为多个 Segment 文件</strong>。这种设计带来了几个关键优势：</p>
<ol>
<li><strong>文件大小可控</strong>：单个 Segment 文件大小有限（默认 1GB），避免了超大文件带来的性能问题</li>
<li><strong>删除操作高效</strong>：删除过期数据只需删除整个 Segment 文件，无需逐条删除</li>
<li><strong>索引管理简单</strong>：每个 Segment 对应一套索引文件，索引文件大小可控</li>
</ol>
<p><strong>Segment 文件命名规则</strong>：</p>
<pre><code class="hljs language-bash" lang="bash">00000000000000000000.<span class="hljs-built_in">log</span>
00000000000000000000.index
00000000000000000000.timeindex
</code></pre>
<p>文件名中的数字表示该 Segment 的起始 Offset（Base Offset）。例如，<code>00000000000000000000.log</code> 表示这个 Segment 从 Offset 0 开始，<code>00000000000000100000.log</code> 表示从 Offset 100000 开始。</p>
<p><strong>Segment 切分时机</strong>：</p>
<ul>
<li>当前 Segment 文件大小达到 <code>log.segment.bytes</code>（默认 1GB）</li>
<li>当前 Segment 创建时间超过 <code>log.segment.ms</code>（默认 7 天）</li>
</ul>
<p>这种设计使得 Kafka 能够高效处理海量消息：新消息总是追加到当前活跃的 Segment（Active Segment），而历史 Segment 可以被批量删除或归档。</p>
<h5 data-id="heading-4">稀疏索引机制（.index + .timeindex）</h5>
<p>Kafka 采用了**稀疏索引（Sparse Index）**的设计，这是其高性能的关键技术之一。稀疏索引的核心思想是：<strong>不是为每条消息建立索引，而是每隔一定数量的消息建立一条索引记录</strong>。</p>
<p><strong>Offset 索引（.index 文件）</strong>：</p>
<ul>
<li>索引项结构：<code>&lt;相对Offset, 物理位置&gt;</code>，其中相对Offset = 消息Offset - BaseOffset</li>
<li>默认索引密度：每 4KB 消息数据建立一条索引（<code>log.index.interval.bytes</code>）</li>
<li>索引文件大小：固定 10MB（<code>log.index.size.max.bytes</code>）</li>
</ul>
<p><strong>时间索引（.timeindex 文件）</strong>：</p>
<ul>
<li>索引项结构：<code>&lt;时间戳, 相对Offset&gt;</code></li>
<li>用途：支持按时间戳查询消息（<code>offsetsForTimes</code> API）</li>
<li>索引密度：与 Offset 索引相同</li>
</ul>
<p><strong>稀疏索引的优势</strong>：</p>
<ol>
<li><strong>索引文件小</strong>：相比稠密索引，稀疏索引文件大小减少 99% 以上</li>
<li><strong>内存占用低</strong>：索引文件可以完全加载到内存，提高查询速度</li>
<li><strong>查询效率高</strong>：虽然需要顺序扫描部分数据，但整体查询性能仍然很高</li>
</ol>
<p><strong>查询流程示例</strong>（查找 Offset 为 1000000 的消息）：</p>
<ol>
<li>根据文件名确定 Segment：<code>00000000000000000000.log</code>（BaseOffset = 0）</li>
<li>计算相对 Offset：1000000 - 0 = 1000000</li>
<li>在 .index 文件中二分查找，找到最接近的索引项（假设是 Offset 999000）</li>
<li>从 .log 文件的对应位置开始顺序扫描，找到 Offset 1000000 的消息</li>
</ol>
<p>这个过程虽然需要顺序扫描，但由于索引密度合理（每 4KB 一条），实际扫描的数据量很小，查询性能仍然很高。</p>
<h5 data-id="heading-5">Log Compaction 原理</h5>
<p>Log Compaction 是 Kafka 的一个高级特性，它允许 Kafka 在保留消息的同时，删除相同 Key 的旧消息，只保留最新的消息。这个特性使得 Kafka 能够作为<strong>可更新的日志存储系统</strong>使用。</p>
<p><strong>Compaction 触发条件</strong>：</p>
<ul>
<li>脏数据比例超过阈值：<code>min.cleanable.dirty.ratio</code>（默认 0.5）</li>
<li>日志头（Log Head）与清理点（Cleaner Checkpoint）的距离超过阈值</li>
</ul>
<p><strong>Compaction 流程</strong>：</p>
<ol>
<li><strong>扫描阶段</strong>：从日志头开始扫描，记录每个 Key 的最新 Offset</li>
<li><strong>复制阶段</strong>：从日志尾开始，将每个 Key 的最新消息复制到新的 Segment</li>
<li><strong>替换阶段</strong>：用新的 Segment 替换旧的 Segment</li>
</ol>
<p><strong>Compaction 的应用场景</strong>：</p>
<ul>
<li><strong>变更日志（Change Log）</strong>：存储数据库表的变更历史，Compaction 后只保留最新状态</li>
<li><strong>会话状态</strong>：存储用户会话信息，Compaction 后只保留最新会话</li>
<li><strong>配置管理</strong>：存储配置变更历史，Compaction 后只保留最新配置</li>
</ul>
<p><strong>Compaction 的性能影响</strong>：</p>
<ul>
<li>CPU 开销：Compaction 是 CPU 密集型操作，会占用一定的 CPU 资源</li>
<li>磁盘 IO：需要读取旧 Segment 并写入新 Segment，产生额外的磁盘 IO</li>
<li>内存占用：需要维护 Key 到 Offset 的映射表，占用一定内存</li>
</ul>
<h5 data-id="heading-6">为什么 Kafka 适合日志流场景？</h5>
<p>Kafka 的分区日志模型设计，使其天然适合日志流场景，原因如下：</p>
<ol>
<li>
<p><strong>顺序写入性能高</strong>：日志流场景下，消息总是追加写入，Kafka 的顺序写入性能可以达到磁盘顺序写入的极限（600MB/s+）</p>
</li>
<li>
<p><strong>批量处理友好</strong>：日志流场景下，消息通常批量产生，Kafka 的批量写入机制能够充分利用网络和磁盘带宽</p>
</li>
<li>
<p><strong>历史数据查询少</strong>：日志流场景下，主要关注实时数据，历史数据查询需求较少，稀疏索引的设计完全满足需求</p>
</li>
<li>
<p><strong>数据保留策略灵活</strong>：Kafka 支持基于时间或大小的数据保留策略，可以自动删除过期数据，适合日志流场景的数据生命周期管理</p>
</li>
<li>
<p><strong>流式处理集成</strong>：Kafka 与 Kafka Streams、Flink、Spark Streaming 等流处理框架深度集成，形成完整的流式数据处理生态</p>
</li>
</ol>
<h4 data-id="heading-7">RocketMQ 的 CommitLog + ConsumeQueue 模型</h4>
<p>RocketMQ 采用了<strong>混合存储模型</strong>：<strong>中心化的 CommitLog + 分布式的 ConsumeQueue</strong>。这一设计理念源于其应用场景：<strong>业务消息队列</strong>，需要支持多 Topic、多 Consumer Group、消息过滤等复杂需求。</p>
<h5 data-id="heading-8">为什么选择中心化 CommitLog？</h5>
<p>RocketMQ 的核心设计决策是：<strong>将所有 Topic 的消息统一写入一个 CommitLog 文件</strong>。这个设计看似违背了"分而治之"的原则，但实际上带来了巨大的优势：</p>
<p><strong>1. 顺序写入性能最大化</strong></p>
<p>所有消息写入同一个文件，意味着：</p>
<ul>
<li><strong>完全的顺序写入</strong>：无论有多少 Topic，磁盘磁头只需要在一个文件上顺序移动</li>
<li><strong>批量写入优化</strong>：可以将多个 Topic 的消息合并批量写入，提高写入效率</li>
<li><strong>Page Cache 利用最大化</strong>：所有消息共享同一个文件的 Page Cache，缓存命中率更高</li>
</ul>
<p><strong>2. 多 Topic 场景下的文件数量优势</strong></p>
<p>假设有 100 个 Topic，每个 Topic 有 4 个 Queue：</p>
<ul>
<li><strong>Kafka 方案</strong>：100 Topic × 4 Partition = 400 个数据文件（不考虑副本）</li>
<li><strong>RocketMQ 方案</strong>：1 个 CommitLog 文件 + 400 个 ConsumeQueue 文件</li>
</ul>
<p>虽然文件总数相近，但关键区别在于：</p>
<ul>
<li>Kafka 的 400 个文件都是<strong>数据文件</strong>（需要顺序写入）</li>
<li>RocketMQ 的 400 个 ConsumeQueue 文件是<strong>索引文件</strong>（轻量级，写入量小）</li>
</ul>
<p><strong>3. 存储空间利用率高</strong></p>
<p>中心化 CommitLog 避免了多文件带来的空间浪费：</p>
<ul>
<li><strong>文件预分配</strong>：每个文件都需要预分配空间，多文件意味着更多的预分配空间浪费</li>
<li><strong>文件对齐</strong>：多文件可能导致磁盘空间碎片化，降低空间利用率</li>
<li><strong>删除效率</strong>：删除过期数据时，只需要删除 CommitLog 文件，ConsumeQueue 可以异步清理</li>
</ul>
<p><strong>4. 简化了主从复制</strong></p>
<p>中心化 CommitLog 使得主从复制变得简单：</p>
<ul>
<li>只需要复制一个 CommitLog 文件流</li>
<li>复制进度管理简单（只需要一个 Offset）</li>
<li>复制性能高（顺序读取 + 顺序写入）</li>
</ul>
<p><strong>设计权衡</strong>：</p>
<p>当然，中心化 CommitLog 也带来了一些挑战：</p>
<ul>
<li><strong>读放大问题</strong>：读取消息需要先查 ConsumeQueue，再读 CommitLog，产生两次磁盘 IO</li>
<li><strong>文件大小限制</strong>：单个 CommitLog 文件不能无限增长（RocketMQ 限制为 1GB），需要定期切分</li>
<li><strong>并发写入控制</strong>：多个 Topic 并发写入需要加锁，可能成为性能瓶颈（RocketMQ 通过文件预分配和批量写入优化解决）</li>
</ul>
<h5 data-id="heading-9">ConsumeQueue 轻量级索引设计</h5>
<p>ConsumeQueue 是 RocketMQ 的核心创新之一，它是一个<strong>轻量级的消息索引队列</strong>，每个 Topic-Queue 对应一个 ConsumeQueue 文件。</p>
<p><strong>ConsumeQueue 文件结构</strong>：</p>
<p>每个 ConsumeQueue 文件固定大小 30 万条记录，每条记录 20 字节：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-operator">+</span><span class="hljs-comment">--------+--------+--------+--------+</span>
<span class="hljs-operator">|</span> <span class="hljs-keyword">Offset</span> <span class="hljs-operator">|</span> Size   <span class="hljs-operator">|</span> Tag    <span class="hljs-operator">|</span> CRC    <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">--------+--------+--------+--------+</span>
<span class="hljs-operator">|</span> <span class="hljs-number">8</span>字节  <span class="hljs-operator">|</span> <span class="hljs-number">4</span>字节  <span class="hljs-operator">|</span> <span class="hljs-number">8</span>字节  <span class="hljs-operator">|</span> <span class="hljs-number">4</span>字节  <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">--------+--------+--------+--------+</span>
</code></pre>
<ul>
<li><strong>Offset</strong>：消息在 CommitLog 中的物理偏移量（8 字节）</li>
<li><strong>Size</strong>：消息体大小（4 字节）</li>
<li><strong>Tag</strong>：消息 Tag 的 HashCode（8 字节），用于 Tag 过滤</li>
<li><strong>CRC</strong>：消息 CRC 校验码（4 字节）</li>
</ul>
<p><strong>ConsumeQueue 的设计优势</strong>：</p>
<ol>
<li><strong>文件小，加载快</strong>：单个 ConsumeQueue 文件只有 5.7MB（30万 × 20字节），可以快速加载到内存</li>
<li><strong>顺序写入</strong>：ConsumeQueue 是顺序追加写入的，写入性能高</li>
<li><strong>支持 Tag 过滤</strong>：Tag HashCode 存储在 ConsumeQueue 中，可以在不读取 CommitLog 的情况下进行 Tag 过滤</li>
<li><strong>消费进度管理简单</strong>：Consumer 的消费进度就是 ConsumeQueue 的读取位置（Offset）</li>
</ol>
<p><strong>ConsumeQueue 的构建流程</strong>：</p>
<p>ConsumeQueue 是<strong>异步构建</strong>的，这保证了写入性能：</p>
<ol>
<li><strong>消息写入 CommitLog</strong>：Producer 发送消息，Broker 将消息写入 CommitLog</li>
<li><strong>异步构建 ConsumeQueue</strong>：ReputMessageService 线程异步读取 CommitLog，构建各个 ConsumeQueue</li>
<li><strong>延迟可接受</strong>：由于是异步构建，ConsumeQueue 的更新可能有微小延迟（通常 &lt; 1ms），但这个延迟对业务影响很小</li>
</ol>
<p><strong>源码实现示例</strong>（简化版）：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ReputMessageService 核心逻辑</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doReput</span><span class="hljs-params">()</span> {
    <span class="hljs-comment">// 从 CommitLog 读取消息</span>
    <span class="hljs-type">SelectMappedBufferResult</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> commitLog.getData(reputFromOffset);
    
    <span class="hljs-keyword">while</span> (result != <span class="hljs-literal">null</span>) {
        <span class="hljs-comment">// 解析消息</span>
        <span class="hljs-type">DispatchRequest</span> <span class="hljs-variable">dispatchRequest</span> <span class="hljs-operator">=</span> parseMessage(result);
        
        <span class="hljs-comment">// 构建 ConsumeQueue</span>
        <span class="hljs-keyword">for</span> (String queue : dispatchRequest.getQueueId()) {
            <span class="hljs-type">ConsumeQueue</span> <span class="hljs-variable">cq</span> <span class="hljs-operator">=</span> findConsumeQueue(dispatchRequest.getTopic(), queue);
            cq.putMessagePositionInfo(
                dispatchRequest.getCommitLogOffset(),
                dispatchRequest.getMsgSize(),
                dispatchRequest.getTagsCode(),
                dispatchRequest.getConsumeQueueOffset()
            );
        }
        
        <span class="hljs-comment">// 继续读取下一条消息</span>
        reputFromOffset += result.getSize();
        result = commitLog.getData(reputFromOffset);
    }
}
</code></pre>
<h5 data-id="heading-10">IndexFile 的作用与查询优化</h5>
<p>IndexFile 是 RocketMQ 提供的<strong>消息 Key 索引文件</strong>，用于支持按消息 Key 查询消息。这是 RocketMQ 相比 Kafka 的一个优势特性。</p>
<p><strong>IndexFile 文件结构</strong>：</p>
<p>每个 IndexFile 文件大小固定 400MB，包含：</p>
<ul>
<li><strong>Header</strong>：文件头信息（40 字节）</li>
<li><strong>Hash Slot</strong>：哈希槽数组（500万个槽，每个槽 4 字节，共 20MB）</li>
<li><strong>Index Entry</strong>：索引项数组（2000万个索引项，每个 20 字节，共 380MB）</li>
</ul>
<p><strong>索引项结构</strong>：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-operator">+</span><span class="hljs-comment">--------+--------+--------+--------+</span>
<span class="hljs-operator">|</span> Hash   <span class="hljs-operator">|</span> <span class="hljs-keyword">Offset</span> <span class="hljs-operator">|</span> <span class="hljs-type">Time</span>   <span class="hljs-operator">|</span> Next   <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">--------+--------+--------+--------+</span>
<span class="hljs-operator">|</span> <span class="hljs-number">4</span>字节  <span class="hljs-operator">|</span> <span class="hljs-number">8</span>字节  <span class="hljs-operator">|</span> <span class="hljs-number">4</span>字节  <span class="hljs-operator">|</span> <span class="hljs-number">4</span>字节  <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">--------+--------+--------+--------+</span>
</code></pre>
<ul>
<li><strong>Hash</strong>：消息 Key 的 HashCode（4 字节）</li>
<li><strong>Offset</strong>：消息在 CommitLog 中的物理偏移量（8 字节）</li>
<li><strong>Time</strong>：消息存储时间戳（4 字节）</li>
<li><strong>Next</strong>：下一个索引项的指针（4 字节），用于解决 Hash 冲突</li>
</ul>
<p><strong>查询流程</strong>：</p>
<ol>
<li><strong>计算 Hash</strong>：根据消息 Key 计算 HashCode</li>
<li><strong>定位 Hash Slot</strong>：HashCode % 5000000，定位到对应的 Hash Slot</li>
<li><strong>遍历链表</strong>：从 Hash Slot 指向的 Index Entry 开始，沿着 Next 指针遍历链表</li>
<li><strong>匹配 Key</strong>：比较每个 Index Entry 对应的消息 Key，找到匹配的消息</li>
<li><strong>读取消息</strong>：根据 Offset 从 CommitLog 读取消息体</li>
</ol>
<p><strong>IndexFile 的优化技巧</strong>：</p>
<ol>
<li><strong>时间范围过滤</strong>：IndexFile 中存储了时间戳，可以先过滤时间范围，减少需要读取的消息数量</li>
<li><strong>多 IndexFile 查询</strong>：如果查询时间跨度大，可能需要查询多个 IndexFile，RocketMQ 会并行查询</li>
<li><strong>内存映射</strong>：IndexFile 使用内存映射（mmap）技术，提高查询性能</li>
</ol>
<p><strong>IndexFile 的局限性</strong>：</p>
<ol>
<li><strong>Hash 冲突</strong>：不同 Key 可能 Hash 到同一个 Slot，需要遍历链表，最坏情况下性能退化</li>
<li><strong>文件大小限制</strong>：单个 IndexFile 只能存储 2000 万条索引，超过需要创建新文件</li>
<li><strong>内存占用</strong>：IndexFile 需要加载到内存，400MB 的文件会占用一定的内存空间</li>
</ol>
<h5 data-id="heading-11">存储模型对多 Topic 场景的影响</h5>
<p>RocketMQ 的存储模型设计，使其在多 Topic 场景下具有显著优势：</p>
<p><strong>文件数量对比</strong>：</p>
<p>假设有 100 个 Topic，每个 Topic 有 4 个 Queue，消息保留 7 天：</p>
<ul>
<li>
<p><strong>Kafka 方案</strong>：</p>
<ul>
<li>数据文件：100 Topic × 4 Partition × 7 天 = 2800 个 Segment 文件（假设每天一个 Segment）</li>
<li>索引文件：2800 个 .index 文件 + 2800 个 .timeindex 文件</li>
<li><strong>总计：8400 个文件</strong></li>
</ul>
</li>
<li>
<p><strong>RocketMQ 方案</strong>：</p>
<ul>
<li>CommitLog：7 个文件（假设每天一个 1GB 文件）</li>
<li>ConsumeQueue：100 Topic × 4 Queue × 7 天 = 2800 个文件（假设每天一个文件）</li>
<li>IndexFile：7 个文件（假设每天一个文件）</li>
<li><strong>总计：2814 个文件</strong></li>
</ul>
</li>
</ul>
<p><strong>文件句柄占用对比</strong>：</p>
<ul>
<li><strong>Kafka</strong>：8400 个文件，每个文件至少占用 1 个文件句柄，总计 <strong>8400+ 个文件句柄</strong></li>
<li><strong>RocketMQ</strong>：2814 个文件，但 ConsumeQueue 和 IndexFile 可以按需打开，实际占用的文件句柄更少，总计 <strong>&lt; 3000 个文件句柄</strong></li>
</ul>
<p><strong>磁盘 IO 模式对比</strong>：</p>
<ul>
<li>
<p><strong>Kafka</strong>：</p>
<ul>
<li>写入：100 个 Topic 并发写入，可能产生随机 IO（如果 Topic 分布在不同 Partition）</li>
<li>读取：每个 Consumer 独立读取，可能产生随机 IO</li>
</ul>
</li>
<li>
<p><strong>RocketMQ</strong>：</p>
<ul>
<li>写入：所有 Topic 写入同一个 CommitLog，<strong>完全顺序 IO</strong></li>
<li>读取：先读 ConsumeQueue（顺序 IO），再读 CommitLog（可能随机 IO，但 CommitLog 顺序写入，Page Cache 命中率高）</li>
</ul>
</li>
</ul>
<p><strong>实际生产案例</strong>：</p>
<p>某电商系统有 500+ 个 Topic，使用 Kafka 时遇到了文件句柄耗尽的问题：</p>
<ul>
<li>Kafka 集群文件句柄数达到 10 万+</li>
<li>系统文件句柄限制为 65535，导致 Broker 频繁重启</li>
<li>解决方案：增加文件句柄限制 + 减少 Topic 数量 + 合并小 Topic</li>
</ul>
<p>切换到 RocketMQ 后：</p>
<ul>
<li>文件句柄数降低到 2 万以下</li>
<li>写入性能提升 30%（顺序写入优势）</li>
<li>运维成本降低（文件管理更简单）</li>
</ul>
<h4 data-id="heading-12">存储模型设计理念总结</h4>
<p>Kafka 和 RocketMQ 的存储模型设计，体现了两种不同的设计哲学：</p>
<p><strong>Kafka：分而治之，专为日志流优化</strong></p>
<ul>
<li>每个 Partition 独立存储，天然支持并行处理</li>
<li>稀疏索引 + 顺序写入，性能极致</li>
<li>适合日志流、流式处理场景</li>
</ul>
<p><strong>RocketMQ：中心化存储，专为业务消息优化</strong></p>
<ul>
<li>中心化 CommitLog + 轻量级索引，多 Topic 场景优势明显</li>
<li>支持消息过滤、按 Key 查询等业务特性</li>
<li>适合业务消息队列、事务消息场景</li>
</ul>
<hr/>
<h3 data-id="heading-13">1.2 存储文件结构与布局</h3>
<p>理解了存储模型的设计理念后，我们需要深入分析具体的文件结构与布局。文件结构的设计直接影响存储性能、空间利用率和运维复杂度。本节将从文件命名规则、文件内部结构、文件组织方式等多个维度，详细对比 Kafka 和 RocketMQ 的存储文件设计。</p>
<h4 data-id="heading-14">Kafka 存储文件</h4>
<p>Kafka 的存储文件组织遵循"分区独立、分段存储"的原则。每个 Partition 在磁盘上对应一个目录，目录内包含多个 Segment 文件及其索引文件。</p>
<h5 data-id="heading-15">Segment 文件命名规则（Offset 命名）</h5>
<p>Kafka 采用<strong>基于 Offset 的文件命名规则</strong>，这是其设计的核心特征之一：</p>
<p><strong>命名格式</strong>：</p>
<pre><code class="hljs language-bash" lang="bash">{baseOffset}.<span class="hljs-built_in">log</span>
{baseOffset}.index
{baseOffset}.timeindex
{baseOffset}.snapshot  (Leader Epoch Checkpoint)
</code></pre>
<p><strong>命名规则说明</strong>：</p>
<ul>
<li><strong>Base Offset</strong>：20 位数字，表示该 Segment 的起始 Offset</li>
<li><strong>文件类型</strong>：
<ul>
<li><code>.log</code>：消息数据文件</li>
<li><code>.index</code>：Offset 索引文件</li>
<li><code>.timeindex</code>：时间索引文件</li>
<li><code>.snapshot</code>：Leader Epoch Checkpoint 文件（Kafka 2.5+）</li>
</ul>
</li>
</ul>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-bash" lang="bash">/kafka-logs/topic-order-0/
├── 00000000000000000000.<span class="hljs-built_in">log</span>
├── 00000000000000000000.index
├── 00000000000000000000.timeindex
├── 00000000000000000000.snapshot
├── 00000000000000100000.<span class="hljs-built_in">log</span>
├── 00000000000000100000.index
├── 00000000000000100000.timeindex
└── 00000000000000100000.snapshot
</code></pre>
<p><strong>Offset 命名的优势</strong>：</p>
<ol>
<li><strong>快速定位 Segment</strong>：给定一个 Offset，可以通过文件名快速定位到对应的 Segment</li>
<li><strong>避免文件名冲突</strong>：Offset 全局唯一，不会产生文件名冲突</li>
<li><strong>简化删除逻辑</strong>：删除过期数据时，只需比较文件名中的 Offset 即可</li>
</ol>
<p><strong>Offset 命名的挑战</strong>：</p>
<ul>
<li><strong>文件名长度固定</strong>：20 位数字限制了最大 Offset 值（2^63 - 1，实际足够大）</li>
<li><strong>文件查找需要排序</strong>：虽然文件名有序，但文件系统可能不保证顺序，需要排序后查找</li>
</ul>
<h5 data-id="heading-16">.log、.index、.timeindex 文件结构</h5>
<p><strong>1. .log 文件结构（消息数据文件）</strong></p>
<p>.log 文件是 Kafka 的核心数据文件，存储实际的消息内容。文件结构如下：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-operator">+</span><span class="hljs-comment">--------+--------+--------+--------+--------+</span>
<span class="hljs-operator">|</span> <span class="hljs-keyword">Offset</span> <span class="hljs-operator">|</span> Size   <span class="hljs-operator">|</span> CRC    <span class="hljs-operator">|</span> Magic  <span class="hljs-operator">|</span> Attributes <span class="hljs-operator">|</span> Key Length <span class="hljs-operator">|</span> Key <span class="hljs-operator">|</span> <span class="hljs-keyword">Value</span> Length <span class="hljs-operator">|</span> <span class="hljs-keyword">Value</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">--------+--------+--------+--------+--------+</span>
<span class="hljs-operator">|</span> <span class="hljs-number">8</span>字节  <span class="hljs-operator">|</span> <span class="hljs-number">4</span>字节  <span class="hljs-operator">|</span> <span class="hljs-number">4</span>字节  <span class="hljs-operator">|</span> <span class="hljs-number">1</span>字节  <span class="hljs-operator">|</span> <span class="hljs-number">1</span>字节     <span class="hljs-operator">|</span> <span class="hljs-number">4</span>字节      <span class="hljs-operator">|</span> 变长<span class="hljs-operator">|</span> <span class="hljs-number">4</span>字节        <span class="hljs-operator">|</span> 变长  <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">--------+--------+--------+--------+--------+</span>
</code></pre>
<p><strong>字段说明</strong>：</p>
<ul>
<li><strong>Offset</strong>：消息的 Offset（8 字节，大端序）</li>
<li><strong>Size</strong>：消息总长度（4 字节，不包括 Offset 和 Size 字段本身）</li>
<li><strong>CRC</strong>：消息 CRC 校验码（4 字节）</li>
<li><strong>Magic</strong>：消息格式版本号（1 字节，0 或 1）</li>
<li><strong>Attributes</strong>：消息属性（1 字节，包含压缩类型、时间戳类型等）</li>
<li><strong>Key Length</strong>：Key 长度（4 字节，-1 表示 Key 为空）</li>
<li><strong>Key</strong>：消息 Key（变长）</li>
<li><strong>Value Length</strong>：Value 长度（4 字节，-1 表示 Value 为空）</li>
<li><strong>Value</strong>：消息体（变长）</li>
</ul>
<p><strong>消息格式版本演进</strong>：</p>
<ul>
<li><strong>Magic 0</strong>：Kafka 0.10.0 之前的格式，不包含时间戳</li>
<li><strong>Magic 1</strong>：Kafka 0.10.0+ 的格式，包含时间戳（CreateTime 或 LogAppendTime）</li>
</ul>
<p><strong>压缩消息格式</strong>：
当消息被压缩时，Value 字段存储的是压缩后的消息集合（Message Set），内部包含多条消息：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-operator">+</span><span class="hljs-comment">--------+--------+--------+--------+</span>
<span class="hljs-operator">|</span> <span class="hljs-keyword">Offset</span> <span class="hljs-operator">|</span> Size   <span class="hljs-operator">|</span> CRC    <span class="hljs-operator">|</span> Magic  <span class="hljs-operator">|</span> Attributes <span class="hljs-operator">|</span> Key Length <span class="hljs-operator">|</span> Key <span class="hljs-operator">|</span> <span class="hljs-keyword">Value</span> Length <span class="hljs-operator">|</span> Compressed Messages <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">--------+--------+--------+--------+</span>
<span class="hljs-operator">|</span>        <span class="hljs-operator">|</span>        <span class="hljs-operator">|</span>        <span class="hljs-operator">|</span>        <span class="hljs-operator">|</span> (compression flag <span class="hljs-keyword">set</span>) <span class="hljs-operator">|</span>     <span class="hljs-operator">|</span>              <span class="hljs-operator">|</span> (多条消息的压缩数据) <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">--------+--------+--------+--------+</span>
</code></pre>
<p><strong>2. .index 文件结构（Offset 索引文件）</strong></p>
<p>.index 文件是稀疏索引文件，用于快速定位消息在 .log 文件中的位置：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-operator">+</span><span class="hljs-comment">--------+--------+</span>
<span class="hljs-operator">|</span> <span class="hljs-keyword">Offset</span> <span class="hljs-operator">|</span> Position <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">--------+--------+</span>
<span class="hljs-operator">|</span> <span class="hljs-number">4</span>字节  <span class="hljs-operator">|</span> <span class="hljs-number">4</span>字节   <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">--------+--------+</span>
</code></pre>
<p><strong>字段说明</strong>：</p>
<ul>
<li><strong>Offset</strong>：相对 Offset（4 字节），相对 Offset = 消息 Offset - Base Offset</li>
<li><strong>Position</strong>：消息在 .log 文件中的物理位置（4 字节，从文件开头计算的字节偏移量）</li>
</ul>
<p><strong>索引密度控制</strong>：</p>
<ul>
<li><strong>log.index.interval.bytes</strong>：默认 4096 字节（4KB），表示每 4KB 消息数据建立一条索引</li>
<li><strong>log.index.size.max.bytes</strong>：默认 10485760 字节（10MB），表示索引文件最大 10MB</li>
</ul>
<p><strong>索引文件大小计算</strong>：</p>
<ul>
<li>每条索引记录 8 字节（4 字节 Offset + 4 字节 Position）</li>
<li>10MB 索引文件可以存储约 131 万条索引记录</li>
<li>对应约 5GB 的消息数据（131万 × 4KB）</li>
</ul>
<p><strong>3. .timeindex 文件结构（时间索引文件）</strong></p>
<p>.timeindex 文件用于支持按时间戳查询消息，文件结构与 .index 类似：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-operator">+</span><span class="hljs-comment">--------+--------+</span>
<span class="hljs-operator">|</span> <span class="hljs-type">Timestamp</span> <span class="hljs-operator">|</span> <span class="hljs-keyword">Offset</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">--------+--------+</span>
<span class="hljs-operator">|</span> <span class="hljs-number">8</span>字节     <span class="hljs-operator">|</span> <span class="hljs-number">4</span>字节  <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">--------+--------+</span>
</code></pre>
<p><strong>字段说明</strong>：</p>
<ul>
<li><strong>Timestamp</strong>：消息时间戳（8 字节，毫秒级）</li>
<li><strong>Offset</strong>：相对 Offset（4 字节）</li>
</ul>
<p><strong>时间索引的用途</strong>：</p>
<ul>
<li><strong>offsetsForTimes API</strong>：根据时间戳查找对应的 Offset</li>
<li><strong>日志清理</strong>：根据时间戳判断消息是否过期</li>
<li><strong>时间范围查询</strong>：支持查询某个时间范围内的消息</li>
</ul>
<p><strong>时间索引的局限性</strong>：</p>
<ul>
<li>时间索引是稀疏的，只能定位到大致位置，需要顺序扫描找到精确的消息</li>
<li>时间戳可能不准确（如果使用 CreateTime，客户端时间可能不同步）</li>
</ul>
<h5 data-id="heading-17">Leader Epoch Checkpoint 机制</h5>
<p>Leader Epoch Checkpoint 是 Kafka 2.5+ 引入的机制，用于解决数据截断（Data Truncation）问题。</p>
<p><strong>数据截断问题场景</strong>：</p>
<p>在 Kafka 的副本机制中，如果 Leader 发生故障切换，新的 Leader 可能包含旧 Leader 没有的数据。当旧 Leader 恢复后，如果直接作为 Follower 同步，可能会发生数据截断：</p>
<ol>
<li><strong>旧 Leader</strong>：有 Offset 0-100 的消息</li>
<li><strong>新 Leader</strong>：有 Offset 0-80 的消息（因为发生了数据丢失）</li>
<li><strong>旧 Leader 恢复</strong>：如果直接同步，会截断到 Offset 80，丢失 Offset 81-100 的数据</li>
</ol>
<p><strong>Leader Epoch 机制</strong>：</p>
<p>Leader Epoch 是一个单调递增的整数，每次 Leader 切换时递增。每个 Epoch 对应一个 Leader 和该 Leader 的起始 Offset。</p>
<p><strong>Checkpoint 文件结构</strong>：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-operator">+</span><span class="hljs-comment">--------+--------+--------+</span>
<span class="hljs-operator">|</span> Version <span class="hljs-operator">|</span> Epoch  <span class="hljs-operator">|</span> <span class="hljs-keyword">Offset</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">--------+--------+--------+</span>
<span class="hljs-operator">|</span> <span class="hljs-number">2</span>字节   <span class="hljs-operator">|</span> <span class="hljs-number">4</span>字节  <span class="hljs-operator">|</span> <span class="hljs-number">8</span>字节  <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">--------+--------+--------+</span>
</code></pre>
<p><strong>字段说明</strong>：</p>
<ul>
<li><strong>Version</strong>：文件格式版本（2 字节）</li>
<li><strong>Epoch</strong>：Leader Epoch（4 字节）</li>
<li><strong>Offset</strong>：该 Epoch 对应的起始 Offset（8 字节）</li>
</ul>
<p><strong>工作原理</strong>：</p>
<ol>
<li><strong>Leader 切换时</strong>：新的 Leader 会记录新的 Epoch 和起始 Offset</li>
<li><strong>Follower 同步时</strong>：Follower 会先查询 Leader Epoch，确定应该从哪个 Offset 开始同步</li>
<li><strong>数据截断检测</strong>：如果 Follower 的 Offset 大于 Leader 的起始 Offset，说明发生了数据截断，需要截断到 Leader 的起始 Offset</li>
</ol>
<p><strong>实际案例</strong>：</p>
<p>某 Kafka 集群在 Leader 切换后，出现了数据丢失问题：</p>
<ul>
<li><strong>问题现象</strong>：Consumer 消费到了一些"旧"消息（已经被删除的消息）</li>
<li><strong>根本原因</strong>：Follower 在同步时发生了数据截断，但旧的数据没有被正确清理</li>
<li><strong>解决方案</strong>：升级到 Kafka 2.5+，启用 Leader Epoch Checkpoint 机制</li>
</ul>
<h4 data-id="heading-18">RocketMQ 存储文件</h4>
<p>RocketMQ 的存储文件组织遵循"中心化 CommitLog + 分布式索引"的原则。所有消息写入 CommitLog，各个 Topic-Queue 通过 ConsumeQueue 索引定位消息。</p>
<h5 data-id="heading-19">CommitLog 文件（1GB 固定大小）</h5>
<p>CommitLog 是 RocketMQ 的核心数据文件，所有 Topic 的消息都写入这个文件。</p>
<p><strong>文件命名规则</strong>：</p>
<pre><code class="hljs language-erlang" lang="erlang"><span class="hljs-number">00000000000000000000</span>
<span class="hljs-number">00000000001073741824</span>
<span class="hljs-number">00000000002147483648</span>
...
</code></pre>
<p><strong>命名规则说明</strong>：</p>
<ul>
<li>文件名是 20 位数字，表示该文件的起始物理偏移量（字节）</li>
<li>每个文件固定大小 1GB（<code>mapedFileSizeCommitLog</code>，默认 1073741824 字节）</li>
<li>文件名 = 起始偏移量，例如 <code>00000000001073741824</code> 表示从 1073741824 字节（1GB）开始</li>
</ul>
<p><strong>文件目录结构</strong>：</p>
<pre><code class="hljs language-bash" lang="bash">/store/
├── commitlog/
│   ├── 00000000000000000000
│   ├── 00000000001073741824
│   └── 00000000002147483648
├── consumequeue/
│   ├── TopicA/
│   │   ├── 0/
│   │   │   ├── 00000000000000000000
│   │   │   └── 00000000000000500000
│   │   └── 1/
│   └── TopicB/
└── index/
    ├── 20231216000000
    └── 20231216000001
</code></pre>
<p><strong>CommitLog 消息格式</strong>：</p>
<pre><code class="hljs language-diff" lang="diff"><span class="hljs-addition">+--------+--------+--------+--------+--------+--------+--------+--------+</span>
| TotLen | Magic  | BodyCRC| QueueID| Flag   | QueueOffset | PhysicalOffset | SysFlag | BornTimestamp | BornHost | StoreTimestamp | StoreHost | ReconsumeTimes | PreparedTransactionOffset | Body Length | Body | Topic Length | Topic | Properties Length | Properties |
<span class="hljs-addition">+--------+--------+--------+--------+--------+--------+--------+--------+</span>
| 4字节  | 4字节  | 4字节  | 4字节  | 4字节  | 8字节   | 8字节        | 4字节   | 8字节        | 8字节   | 8字节         | 8字节    | 2字节          | 8字节                  | 4字节       | 变长 | 1字节        | 变长  | 2字节            | 变长      |
<span class="hljs-addition">+--------+--------+--------+--------+--------+--------+--------+--------+</span>
</code></pre>
<p><strong>关键字段说明</strong>：</p>
<ul>
<li><strong>TotLen</strong>：消息总长度（4 字节）</li>
<li><strong>Magic</strong>：魔数，用于标识消息格式（4 字节，固定为 0xdaa320a7）</li>
<li><strong>BodyCRC</strong>：消息体 CRC 校验码（4 字节）</li>
<li><strong>QueueID</strong>：队列 ID（4 字节）</li>
<li><strong>QueueOffset</strong>：队列偏移量（8 字节，ConsumeQueue 中的位置）</li>
<li><strong>PhysicalOffset</strong>：物理偏移量（8 字节，在 CommitLog 中的位置）</li>
<li><strong>Body</strong>：消息体（变长）</li>
<li><strong>Topic</strong>：Topic 名称（变长）</li>
<li><strong>Properties</strong>：消息属性（变长，Key-Value 格式）</li>
</ul>
<p><strong>文件预分配机制</strong>：</p>
<p>RocketMQ 使用**文件预分配（Pre-allocation）**机制，提前创建固定大小的文件：</p>
<ol>
<li><strong>预创建文件</strong>：启动时或文件写满时，提前创建下一个文件</li>
<li><strong>内存映射</strong>：使用 <code>mmap</code> 将文件映射到内存，提高读写性能</li>
<li><strong>顺序写入</strong>：消息总是追加写入当前活跃文件</li>
</ol>
<p><strong>文件切分时机</strong>：</p>
<ul>
<li>当前文件大小达到 1GB（<code>mapedFileSizeCommitLog</code>）</li>
<li>文件写满后，自动切换到下一个文件</li>
</ul>
<h5 data-id="heading-20">ConsumeQueue 文件（每个 Topic-Queue 一个目录）</h5>
<p>ConsumeQueue 是 RocketMQ 的轻量级索引文件，每个 Topic-Queue 对应一个目录，目录内包含多个 ConsumeQueue 文件。</p>
<p><strong>目录结构</strong>：</p>
<pre><code class="hljs language-bash" lang="bash">/store/consumequeue/
├── TopicA/
│   ├── 0/          <span class="hljs-comment"># Queue 0</span>
│   │   ├── 00000000000000000000
│   │   └── 00000000000000500000
│   ├── 1/          <span class="hljs-comment"># Queue 1</span>
│   └── 2/          <span class="hljs-comment"># Queue 2</span>
└── TopicB/
    └── 0/
</code></pre>
<p><strong>文件命名规则</strong>：</p>
<ul>
<li>文件名是 20 位数字，表示该文件的起始逻辑偏移量（ConsumeQueue Offset）</li>
<li>每个文件固定大小 5.7MB（30万条记录 × 20字节）</li>
<li>文件名 = 起始逻辑偏移量 × 20字节</li>
</ul>
<p><strong>ConsumeQueue 文件结构</strong>：</p>
<p>每个 ConsumeQueue 文件包含 30 万条记录，每条记录 20 字节：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-operator">+</span><span class="hljs-comment">--------+--------+--------+--------+</span>
<span class="hljs-operator">|</span> <span class="hljs-keyword">Offset</span> <span class="hljs-operator">|</span> Size   <span class="hljs-operator">|</span> Tag    <span class="hljs-operator">|</span> CRC    <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">--------+--------+--------+--------+</span>
<span class="hljs-operator">|</span> <span class="hljs-number">8</span>字节  <span class="hljs-operator">|</span> <span class="hljs-number">4</span>字节  <span class="hljs-operator">|</span> <span class="hljs-number">8</span>字节  <span class="hljs-operator">|</span> <span class="hljs-number">4</span>字节  <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">--------+--------+--------+--------+</span>
</code></pre>
<p><strong>字段详细说明</strong>：</p>
<ul>
<li><strong>Offset</strong>：消息在 CommitLog 中的物理偏移量（8 字节）</li>
<li><strong>Size</strong>：消息总长度（4 字节，包括消息头）</li>
<li><strong>Tag</strong>：消息 Tag 的 HashCode（8 字节），用于 Tag 过滤</li>
<li><strong>CRC</strong>：消息 CRC 校验码（4 字节），用于消息完整性校验</li>
</ul>
<p><strong>ConsumeQueue 的构建</strong>：</p>
<p>ConsumeQueue 是<strong>异步构建</strong>的，由 <code>ReputMessageService</code> 线程负责：</p>
<ol>
<li><strong>监听 CommitLog</strong>：ReputMessageService 监听 CommitLog 的写入事件</li>
<li><strong>解析消息</strong>：读取 CommitLog 中的消息，解析出 Topic、QueueID、Tag 等信息</li>
<li><strong>写入 ConsumeQueue</strong>：将消息的物理偏移量、大小、Tag HashCode 等信息写入对应的 ConsumeQueue</li>
</ol>
<p><strong>异步构建的优势</strong>：</p>
<ul>
<li><strong>写入性能高</strong>：Producer 写入 CommitLog 不需要等待 ConsumeQueue 更新</li>
<li><strong>批量优化</strong>：可以批量构建多个 ConsumeQueue，提高效率</li>
<li><strong>解耦设计</strong>：ConsumeQueue 的构建失败不影响消息写入</li>
</ul>
<p><strong>异步构建的延迟</strong>：</p>
<p>ConsumeQueue 的构建延迟通常在 1ms 以内，对业务影响很小。但在极端情况下（如系统负载极高），延迟可能达到 10ms+，此时可能出现：</p>
<ul>
<li>Consumer 拉取消息时，ConsumeQueue 还未更新，导致拉取不到最新消息</li>
<li>解决方案：RocketMQ 提供了同步刷盘 + 同步复制的模式，可以保证 ConsumeQueue 实时更新</li>
</ul>
<h5 data-id="heading-21">IndexFile（消息 Key 索引）</h5>
<p>IndexFile 是 RocketMQ 提供的消息 Key 索引文件，用于支持按消息 Key 查询消息。</p>
<p><strong>文件命名规则</strong>：</p>
<pre><code class="hljs language-bash" lang="bash">/store/index/
├── 20231216000000
├── 20231216000001
└── 20231216000002
</code></pre>
<p><strong>命名规则说明</strong>：</p>
<ul>
<li>文件名是时间戳格式：<code>yyyyMMddHHmmss</code></li>
<li>每个文件固定大小 400MB</li>
<li>文件按时间顺序创建，用于支持时间范围查询</li>
</ul>
<p><strong>IndexFile 文件结构</strong>：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-operator">+</span><span class="hljs-comment">--------+--------+--------+--------+</span>
<span class="hljs-operator">|</span> Header <span class="hljs-operator">|</span> Hash Slot <span class="hljs-keyword">Array</span> <span class="hljs-operator">|</span> Index Entry <span class="hljs-keyword">Array</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">--------+--------+--------+--------+</span>
<span class="hljs-operator">|</span> <span class="hljs-number">40</span>字节 <span class="hljs-operator">|</span> <span class="hljs-number">20</span>MB (<span class="hljs-number">500</span>万槽)  <span class="hljs-operator">|</span> <span class="hljs-number">380</span>MB (<span class="hljs-number">2000</span>万条目) <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">--------+--------+--------+--------+</span>
</code></pre>
<p><strong>1. Header（文件头，40 字节）</strong>：</p>
<pre><code class="hljs language-diff" lang="diff"><span class="hljs-addition">+--------+--------+--------+--------+--------+</span>
| BeginTimestamp | EndTimestamp | BeginPhyOffset | EndPhyOffset | HashSlotCount | IndexCount |
<span class="hljs-addition">+--------+--------+--------+--------+--------+</span>
| 8字节         | 8字节        | 8字节         | 8字节        | 4字节         | 4字节      |
<span class="hljs-addition">+--------+--------+--------+--------+--------+</span>
</code></pre>
<ul>
<li><strong>BeginTimestamp</strong>：索引文件覆盖的起始时间戳</li>
<li><strong>EndTimestamp</strong>：索引文件覆盖的结束时间戳</li>
<li><strong>BeginPhyOffset</strong>：索引文件覆盖的起始物理偏移量</li>
<li><strong>EndPhyOffset</strong>：索引文件覆盖的结束物理偏移量</li>
<li><strong>HashSlotCount</strong>：Hash 槽数量（固定 500 万）</li>
<li><strong>IndexCount</strong>：索引条目数量（最多 2000 万）</li>
</ul>
<p><strong>2. Hash Slot Array（哈希槽数组，20MB）</strong>：</p>
<pre><code class="hljs language-diff" lang="diff"><span class="hljs-addition">+--------+--------+--------+</span>
| Slot 0 | Slot 1 | ...    |
<span class="hljs-addition">+--------+--------+--------+</span>
| 4字节  | 4字节  | ...    |
<span class="hljs-addition">+--------+--------+--------+</span>
</code></pre>
<ul>
<li>每个 Slot 4 字节，存储指向 Index Entry 的指针（Index Entry 的索引位置）</li>
<li>如果 Slot 为空，值为 0</li>
<li>Hash 槽数量固定为 500 万（<code>hashSlotNum</code>）</li>
</ul>
<p><strong>3. Index Entry Array（索引条目数组，380MB）</strong>：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-operator">+</span><span class="hljs-comment">--------+--------+--------+--------+</span>
<span class="hljs-operator">|</span> Hash   <span class="hljs-operator">|</span> <span class="hljs-keyword">Offset</span> <span class="hljs-operator">|</span> <span class="hljs-type">Time</span>   <span class="hljs-operator">|</span> Next   <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">--------+--------+--------+--------+</span>
<span class="hljs-operator">|</span> <span class="hljs-number">4</span>字节  <span class="hljs-operator">|</span> <span class="hljs-number">8</span>字节  <span class="hljs-operator">|</span> <span class="hljs-number">4</span>字节  <span class="hljs-operator">|</span> <span class="hljs-number">4</span>字节  <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">--------+--------+--------+--------+</span>
</code></pre>
<ul>
<li><strong>Hash</strong>：消息 Key 的 HashCode（4 字节）</li>
<li><strong>Offset</strong>：消息在 CommitLog 中的物理偏移量（8 字节）</li>
<li><strong>Time</strong>：消息存储时间戳（4 字节，秒级）</li>
<li><strong>Next</strong>：下一个索引条目的指针（4 字节），用于解决 Hash 冲突</li>
</ul>
<p><strong>索引查询流程</strong>：</p>
<ol>
<li><strong>计算 Hash</strong>：根据消息 Key 计算 HashCode</li>
<li><strong>定位 Hash Slot</strong>：<code>slotIndex = hashCode % 5000000</code></li>
<li><strong>读取 Slot 值</strong>：从 Hash Slot Array 中读取对应 Slot 的值（Index Entry 的索引位置）</li>
<li><strong>遍历链表</strong>：从 Index Entry 开始，沿着 Next 指针遍历链表</li>
<li><strong>匹配 Key</strong>：比较每个 Index Entry 的 Hash 值，如果匹配，读取对应的消息</li>
<li><strong>时间过滤</strong>：如果指定了时间范围，先过滤时间戳</li>
</ol>
<p><strong>Hash 冲突处理</strong>：</p>
<p>IndexFile 使用<strong>链地址法</strong>解决 Hash 冲突：</p>
<ul>
<li>同一个 Hash 槽中的多个 Index Entry 通过 Next 指针连接成链表</li>
<li>查询时需要遍历链表，最坏情况下性能退化到 O(n)</li>
</ul>
<p><strong>IndexFile 的局限性</strong>：</p>
<ul>
<li><strong>文件大小限制</strong>：单个 IndexFile 最多存储 2000 万条索引，超过需要创建新文件</li>
<li><strong>Hash 冲突</strong>：如果某个 Key 的 Hash 冲突严重，查询性能会下降</li>
<li><strong>内存占用</strong>：IndexFile 需要加载到内存，400MB 的文件会占用一定的内存空间</li>
</ul>
<h5 data-id="heading-22">CheckPoint 与 Abort 文件</h5>
<p>RocketMQ 使用 CheckPoint 和 Abort 文件来管理存储状态和恢复。</p>
<p><strong>CheckPoint 文件</strong>：</p>
<p>CheckPoint 文件记录存储的关键状态信息：</p>
<pre><code class="hljs language-bash" lang="bash">/store/checkpoint
</code></pre>
<p><strong>文件内容</strong>：</p>
<pre><code class="hljs language-diff" lang="diff"><span class="hljs-addition">+--------+--------+--------+--------+</span>
| PhysicMsgTimestamp | LogicMsgTimestamp | IndexMsgTimestamp |
<span class="hljs-addition">+--------+--------+--------+--------+</span>
| 8字节             | 8字节            | 8字节            |
<span class="hljs-addition">+--------+--------+--------+--------+</span>
</code></pre>
<ul>
<li><strong>PhysicMsgTimestamp</strong>：CommitLog 最后刷盘时间戳</li>
<li><strong>LogicMsgTimestamp</strong>：ConsumeQueue 最后更新时间戳</li>
<li><strong>IndexMsgTimestamp</strong>：IndexFile 最后更新时间戳</li>
</ul>
<p><strong>用途</strong>：</p>
<ul>
<li><strong>恢复检查</strong>：Broker 启动时，根据 CheckPoint 判断是否需要恢复</li>
<li><strong>刷盘控制</strong>：控制各个文件的刷盘时机</li>
</ul>
<p><strong>Abort 文件</strong>：</p>
<p>Abort 文件用于标识 Broker 是否正常关闭：</p>
<pre><code class="hljs language-bash" lang="bash">/store/abort
</code></pre>
<p><strong>文件内容</strong>：</p>
<ul>
<li>如果文件存在，表示 Broker 异常关闭（如进程被 kill）</li>
<li>如果文件不存在，表示 Broker 正常关闭</li>
</ul>
<p><strong>用途</strong>：</p>
<ul>
<li><strong>恢复判断</strong>：Broker 启动时，如果 Abort 文件存在，需要进行恢复检查</li>
<li><strong>数据一致性</strong>：确保异常关闭后的数据一致性</li>
</ul>
<h4 data-id="heading-23">对比分析</h4>
<h5 data-id="heading-24">多 Topic 场景下的文件数量对比（Kafka 的文件爆炸问题）</h5>
<p><strong>场景假设</strong>：</p>
<ul>
<li>100 个 Topic</li>
<li>每个 Topic 4 个 Partition/Queue</li>
<li>消息保留 7 天</li>
<li>每天产生 1GB 数据（每个 Partition）</li>
</ul>
<p><strong>Kafka 文件数量</strong>：</p>
<p>每个 Partition 每天产生 1 个 Segment（1GB），7 天共 7 个 Segment：</p>
<ul>
<li>数据文件：100 Topic × 4 Partition × 7 天 = <strong>2800 个 .log 文件</strong></li>
<li>索引文件：2800 个 .index 文件 + 2800 个 .timeindex 文件 = <strong>5600 个索引文件</strong></li>
<li>Leader Epoch：2800 个 .snapshot 文件（如果启用）</li>
<li><strong>总计：8400+ 个文件</strong></li>
</ul>
<p><strong>RocketMQ 文件数量</strong>：</p>
<p>假设每天产生 100GB 数据（100 Topic × 4 Queue × 1GB）：</p>
<ul>
<li>CommitLog：100GB ÷ 1GB = <strong>100 个文件</strong>（7 天共 700 个文件，但实际会删除过期文件）</li>
<li>ConsumeQueue：100 Topic × 4 Queue × 7 天 = <strong>2800 个文件</strong>（假设每天一个文件）</li>
<li>IndexFile：7 个文件（假设每天一个文件）</li>
<li><strong>总计：2807 个文件</strong></li>
</ul>
<p><strong>文件数量对比</strong>：</p>
<ul>
<li><strong>Kafka</strong>：8400+ 个文件</li>
<li><strong>RocketMQ</strong>：2807 个文件</li>
<li><strong>差异</strong>：Kafka 的文件数量是 RocketMQ 的 <strong>3 倍</strong></li>
</ul>
<p><strong>文件句柄占用对比</strong>：</p>
<ul>
<li><strong>Kafka</strong>：8400+ 个文件，每个文件至少占用 1 个文件句柄</li>
<li><strong>RocketMQ</strong>：2807 个文件，但 ConsumeQueue 和 IndexFile 可以按需打开，实际占用的文件句柄更少</li>
</ul>
<p><strong>实际生产案例</strong>：</p>
<p>某互联网公司有 500+ 个 Topic，使用 Kafka 时遇到了文件句柄耗尽的问题：</p>
<ul>
<li><strong>问题现象</strong>：Broker 频繁重启，日志显示 "Too many open files"</li>
<li><strong>根本原因</strong>：文件句柄数达到 10 万+，超过了系统限制（65535）</li>
<li><strong>临时解决方案</strong>：增加文件句柄限制到 100 万</li>
<li><strong>根本解决方案</strong>：合并小 Topic，减少 Topic 数量</li>
</ul>
<p>切换到 RocketMQ 后：</p>
<ul>
<li>文件句柄数降低到 2 万以下</li>
<li>系统稳定性提升</li>
<li>运维成本降低</li>
</ul>
<h5 data-id="heading-25">磁盘 IO 模式对比（顺序写 vs 随机读）</h5>
<p><strong>Kafka 的 IO 模式</strong>：</p>
<p><strong>写入阶段</strong>：</p>
<ul>
<li><strong>顺序写入</strong>：每个 Partition 独立写入，如果 Partition 分布在不同文件，可能产生随机 IO</li>
<li><strong>优化</strong>：Kafka 通过 Partition 分配策略，尽量将相关 Partition 分配到同一个 Broker，减少随机 IO</li>
</ul>
<p><strong>读取阶段</strong>：</p>
<ul>
<li><strong>顺序读取</strong>：Consumer 通常顺序消费，读取是顺序的</li>
<li><strong>随机读取</strong>：如果 Consumer 跳转到历史 Offset，可能产生随机 IO</li>
<li><strong>Page Cache 优化</strong>：Kafka 依赖 Page Cache，随机读取如果命中 Page Cache，性能仍然很高</li>
</ul>
<p><strong>RocketMQ 的 IO 模式</strong>：</p>
<p><strong>写入阶段</strong>：</p>
<ul>
<li><strong>完全顺序写入</strong>：所有 Topic 的消息写入同一个 CommitLog，磁盘磁头只需要在一个文件上顺序移动</li>
<li><strong>批量写入优化</strong>：可以将多个 Topic 的消息合并批量写入，提高写入效率</li>
</ul>
<p><strong>读取阶段</strong>：</p>
<ul>
<li><strong>两阶段读取</strong>：
<ol>
<li>先读 ConsumeQueue（顺序 IO，文件小，可以完全加载到内存）</li>
<li>再读 CommitLog（可能随机 IO，但 CommitLog 顺序写入，Page Cache 命中率高）</li>
</ol>
</li>
<li><strong>读放大问题</strong>：读取一条消息需要两次磁盘 IO（ConsumeQueue + CommitLog）</li>
</ul>
<p><strong>IO 性能对比</strong>：</p>
<p><strong>顺序写入性能</strong>：</p>
<ul>
<li><strong>Kafka</strong>：单 Partition 顺序写入，性能取决于磁盘顺序写入性能（600MB/s+）</li>
<li><strong>RocketMQ</strong>：所有消息顺序写入 CommitLog，性能更高（可以充分利用磁盘带宽）</li>
</ul>
<p><strong>随机读取性能</strong>：</p>
<ul>
<li><strong>Kafka</strong>：依赖 Page Cache，如果命中缓存，性能很高；如果未命中，随机 IO 性能较差</li>
<li><strong>RocketMQ</strong>：ConsumeQueue 文件小，可以完全加载到内存；CommitLog 顺序写入，Page Cache 命中率高</li>
</ul>
<p><strong>实际测试数据</strong>：</p>
<p>某性能测试场景（100 个 Topic，每个 Topic 4 个 Partition/Queue，消息大小 1KB）：</p>






























<table><thead><tr><th>指标</th><th>Kafka</th><th>RocketMQ</th></tr></thead><tbody><tr><td>写入 TPS</td><td>50万</td><td>60万</td></tr><tr><td>写入延迟（P99）</td><td>2ms</td><td>1.5ms</td></tr><tr><td>读取 TPS</td><td>80万</td><td>70万</td></tr><tr><td>读取延迟（P99）</td><td>1ms</td><td>1.5ms</td></tr></tbody></table>
<p><strong>结论</strong>：</p>
<ul>
<li><strong>写入性能</strong>：RocketMQ 略优于 Kafka（中心化 CommitLog 的优势）</li>
<li><strong>读取性能</strong>：Kafka 略优于 RocketMQ（直接读取，无读放大）</li>
</ul>
<h5 data-id="heading-26">存储空间利用率对比</h5>
<p><strong>Kafka 的存储空间利用</strong>：</p>
<p><strong>空间占用</strong>：</p>
<ul>
<li>数据文件：消息实际大小</li>
<li>索引文件：约 20MB per Segment（10MB .index + 10MB .timeindex）</li>
<li><strong>总空间</strong>：消息大小 + 索引文件大小</li>
</ul>
<p><strong>空间浪费</strong>：</p>
<ul>
<li><strong>文件预分配</strong>：Kafka 不预分配文件，但 Segment 切分可能产生空间碎片</li>
<li><strong>索引文件</strong>：每个 Segment 都有索引文件，即使 Segment 很小，索引文件大小固定</li>
<li><strong>多文件开销</strong>：每个文件都有文件系统元数据开销</li>
</ul>
<p><strong>RocketMQ 的存储空间利用</strong>：</p>
<p><strong>空间占用</strong>：</p>
<ul>
<li>CommitLog：消息实际大小</li>
<li>ConsumeQueue：每条消息 20 字节索引</li>
<li>IndexFile：每条消息 20 字节索引（如果启用）</li>
<li><strong>总空间</strong>：消息大小 + ConsumeQueue 索引 + IndexFile 索引（可选）</li>
</ul>
<p><strong>空间浪费</strong>：</p>
<ul>
<li><strong>文件预分配</strong>：CommitLog 文件预分配 1GB，如果文件未写满，会产生空间浪费</li>
<li><strong>ConsumeQueue</strong>：每个文件固定 5.7MB，如果未写满，会产生空间浪费</li>
<li><strong>IndexFile</strong>：每个文件固定 400MB，如果未写满，会产生空间浪费</li>
</ul>
<p><strong>空间利用率对比</strong>：</p>
<p>假设场景：100 个 Topic，每个 Topic 4 个 Partition/Queue，消息大小 1KB，每天产生 100 万条消息：</p>
<p><strong>Kafka</strong>：</p>
<ul>
<li>消息数据：100万 × 1KB = 1GB</li>
<li>索引文件：假设 1 个 Segment，索引文件约 20MB</li>
<li><strong>总空间</strong>：约 1.02GB</li>
<li><strong>空间利用率</strong>：98%</li>
</ul>
<p><strong>RocketMQ</strong>：</p>
<ul>
<li>消息数据：100万 × 1KB = 1GB</li>
<li>ConsumeQueue：100万 × 20字节 = 20MB</li>
<li>IndexFile：100万 × 20字节 = 20MB（如果启用）</li>
<li><strong>总空间</strong>：约 1.04GB</li>
<li><strong>空间利用率</strong>：96%（如果 IndexFile 未启用，则为 98%）</li>
</ul>
<p><strong>结论</strong>：</p>
<ul>
<li><strong>空间利用率</strong>：Kafka 和 RocketMQ 的空间利用率相近，都在 95%+ 以上</li>
<li><strong>空间浪费</strong>：RocketMQ 的文件预分配可能产生更多空间浪费，但可以通过合理配置减少浪费</li>
</ul>
<hr/>
<h3 data-id="heading-27">1.3 消息存储流程</h3>
<p>消息存储流程是消息队列的核心环节，直接决定了消息的可靠性、性能和延迟。Kafka 和 RocketMQ 在消息存储流程上采用了不同的设计策略，本节将从消息写入流程、刷盘机制、主从复制等多个维度进行深入对比。</p>
<h4 data-id="heading-28">Kafka 消息写入流程</h4>
<p>Kafka 的消息写入流程遵循"Producer -&gt; Leader -&gt; Follower"的复制链路，充分利用了操作系统的 Page Cache 和零拷贝技术，实现了极高的写入性能。</p>
<h5 data-id="heading-29">Producer -&gt; Leader -&gt; Follower 复制链路</h5>
<p><strong>1. Producer 发送消息</strong></p>
<p>Producer 发送消息时，会经历以下步骤：</p>
<ol>
<li><strong>序列化消息</strong>：将消息 Key 和 Value 序列化为字节数组</li>
<li><strong>选择 Partition</strong>：根据 Key 的 Hash 值或自定义分区器选择目标 Partition</li>
<li><strong>批量收集</strong>：将消息添加到本地缓冲区（RecordAccumulator）</li>
<li><strong>发送请求</strong>：当满足以下条件之一时，批量发送消息：
<ul>
<li>缓冲区达到 <code>batch.size</code>（默认 16KB）</li>
<li>等待时间达到 <code>linger.ms</code>（默认 0ms）</li>
<li>缓冲区空间不足</li>
</ul>
</li>
</ol>
<p><strong>批量发送的优势</strong>：</p>
<ul>
<li><strong>减少网络请求</strong>：多条消息合并为一个请求，减少网络开销</li>
<li><strong>提高吞吐量</strong>：充分利用网络带宽</li>
<li><strong>降低延迟</strong>：通过 <code>linger.ms</code> 控制批量延迟，平衡吞吐量和延迟</li>
</ul>
<p><strong>2. Leader 接收消息</strong></p>
<p>Leader Broker 接收到 Producer 的请求后：</p>
<ol>
<li><strong>验证请求</strong>：检查 Topic、Partition 是否存在，权限是否足够</li>
<li><strong>追加到日志</strong>：将消息追加到对应 Partition 的当前活跃 Segment</li>
<li><strong>更新索引</strong>：异步更新 .index 和 .timeindex 文件</li>
<li><strong>返回响应</strong>：根据 <code>acks</code> 配置返回响应</li>
</ol>
<p><strong>关键配置：acks</strong></p>
<ul>
<li><strong>acks=0</strong>：Producer 不等待任何确认，直接返回。性能最高，但可能丢失消息</li>
<li><strong>acks=1</strong>：Producer 等待 Leader 确认。性能较高，但 Leader 故障可能丢失消息</li>
<li><strong>acks=all/-1</strong>：Producer 等待所有 ISR 副本确认。最可靠，但性能较低</li>
</ul>
<p><strong>3. Follower 复制消息</strong></p>
<p>Follower 通过以下机制从 Leader 复制消息：</p>
<ol>
<li><strong>拉取请求</strong>：Follower 定期向 Leader 发送 Fetch 请求</li>
<li><strong>数据复制</strong>：Leader 返回消息数据，Follower 追加到本地日志</li>
<li><strong>更新 HW</strong>：Follower 更新 High Watermark（HW），表示已复制的最高 Offset</li>
<li><strong>ISR 管理</strong>：Leader 根据 Follower 的复制进度，动态调整 ISR 列表</li>
</ol>
<p><strong>ISR（In-Sync Replicas）机制</strong>：</p>
<p>ISR 是 Kafka 高可用的核心机制，包含所有与 Leader 保持同步的副本：</p>
<ul>
<li><strong>加入 ISR</strong>：Follower 的 LEO（Log End Offset）与 Leader 的 LEO 差距小于 <code>replica.lag.time.max.ms</code>（默认 10 秒）</li>
<li><strong>移除 ISR</strong>：如果 Follower 长时间未同步，会被移除出 ISR</li>
<li><strong>Leader 选举</strong>：只有 ISR 中的副本才能被选为 Leader</li>
</ul>
<p><strong>复制性能优化</strong>：</p>
<ul>
<li><strong>批量复制</strong>：Follower 批量拉取消息，减少网络请求</li>
<li><strong>零拷贝</strong>：使用 <code>sendfile</code> 系统调用，减少数据拷贝次数</li>
<li><strong>并行复制</strong>：多个 Partition 可以并行复制，提高整体吞吐量</li>
</ul>
<h5 data-id="heading-30">Page Cache 利用</h5>
<p>Kafka 充分利用了操作系统的 Page Cache，这是其高性能的关键技术之一。</p>
<p><strong>Page Cache 工作原理</strong>：</p>
<ol>
<li>
<p><strong>写入流程</strong>：</p>
<ul>
<li>Producer 发送消息到 Leader</li>
<li>Leader 将消息写入 Page Cache（内存）</li>
<li>操作系统异步将 Page Cache 刷写到磁盘</li>
<li>Producer 收到确认（如果 acks=1 或 all，需要等待刷盘）</li>
</ul>
</li>
<li>
<p><strong>读取流程</strong>：</p>
<ul>
<li>Consumer 拉取消息</li>
<li>如果数据在 Page Cache 中，直接从内存读取（零拷贝）</li>
<li>如果数据不在 Page Cache 中，从磁盘读取并加载到 Page Cache</li>
</ul>
</li>
</ol>
<p><strong>Page Cache 的优势</strong>：</p>
<ul>
<li><strong>写入性能高</strong>：写入 Page Cache 的速度远快于直接写入磁盘</li>
<li><strong>读取性能高</strong>：如果数据在 Page Cache 中，读取速度接近内存速度</li>
<li><strong>自动管理</strong>：操作系统自动管理 Page Cache，无需手动控制</li>
</ul>
<p><strong>Page Cache 的挑战</strong>：</p>
<ul>
<li><strong>内存占用</strong>：Page Cache 占用系统内存，可能影响其他应用</li>
<li><strong>数据丢失风险</strong>：如果系统崩溃，Page Cache 中的数据可能丢失</li>
<li><strong>缓存污染</strong>：如果其他应用占用大量内存，可能挤占 Page Cache</li>
</ul>
<p><strong>实际案例</strong>：</p>
<p>某 Kafka 集群在高峰期性能突然下降：</p>
<ul>
<li><strong>问题现象</strong>：写入 TPS 从 50 万降到 10 万</li>
<li><strong>根本原因</strong>：其他应用占用了大量内存，Page Cache 被挤占</li>
<li><strong>解决方案</strong>：增加 Kafka Broker 的内存，或限制其他应用的内存使用</li>
</ul>
<h5 data-id="heading-31">mmap vs sendfile</h5>
<p>Kafka 使用了两种零拷贝技术：<code>mmap</code> 和 <code>sendfile</code>。</p>
<p><strong>1. mmap（内存映射）</strong></p>
<p>mmap 用于索引文件的读写：</p>
<ul>
<li><strong>工作原理</strong>：将文件映射到进程的虚拟地址空间，进程可以直接访问文件内容</li>
<li><strong>优势</strong>：减少数据拷贝，提高读写性能</li>
<li><strong>应用场景</strong>：.index 和 .timeindex 文件的读写</li>
</ul>
<p><strong>2. sendfile（零拷贝发送）</strong></p>
<p>sendfile 用于消息的发送：</p>
<ul>
<li><strong>工作原理</strong>：直接从文件描述符发送数据到网络套接字，无需经过用户空间</li>
<li><strong>优势</strong>：完全避免数据拷贝，性能极高</li>
<li><strong>应用场景</strong>：Consumer 拉取消息时，Broker 使用 sendfile 发送数据</li>
</ul>
<p><strong>sendfile 系统调用流程</strong>：</p>
<pre><code class="hljs language-rust" lang="rust">传统方式：
文件 <span class="hljs-punctuation">-&gt;</span> 内核缓冲区 <span class="hljs-punctuation">-&gt;</span> 用户缓冲区 <span class="hljs-punctuation">-&gt;</span> 内核缓冲区 <span class="hljs-punctuation">-&gt;</span> 网络套接字
（<span class="hljs-number">4</span> 次数据拷贝）

sendfile 方式：
文件 <span class="hljs-punctuation">-&gt;</span> 内核缓冲区 <span class="hljs-punctuation">-&gt;</span> 网络套接字
（<span class="hljs-number">2</span> 次数据拷贝，减少 <span class="hljs-number">50</span>%）
</code></pre>
<p><strong>性能对比</strong>：</p>
<p>某测试场景（消息大小 1KB，批量大小 100 条）：</p>




















<table><thead><tr><th>方式</th><th>吞吐量</th><th>CPU 使用率</th></tr></thead><tbody><tr><td>传统方式</td><td>100MB/s</td><td>80%</td></tr><tr><td>sendfile</td><td>200MB/s</td><td>40%</td></tr></tbody></table>
<p><strong>sendfile 的限制</strong>：</p>
<ul>
<li><strong>文件大小限制</strong>：sendfile 只能发送文件，不能发送内存中的数据</li>
<li><strong>操作系统支持</strong>：需要操作系统支持 sendfile 系统调用（Linux 2.4+）</li>
</ul>
<h5 data-id="heading-32">刷盘策略（log.flush.interval.messages）</h5>
<p>Kafka 的刷盘策略相对简单，主要通过配置控制刷盘时机。</p>
<p><strong>刷盘配置</strong>：</p>
<ul>
<li><strong>log.flush.interval.messages</strong>：默认 Long.MaxValue，表示不基于消息数量刷盘</li>
<li><strong>log.flush.interval.ms</strong>：默认 Long.MaxValue，表示不基于时间刷盘</li>
<li><strong>实际行为</strong>：Kafka 默认依赖操作系统的刷盘机制，不主动刷盘</li>
</ul>
<p><strong>为什么 Kafka 不主动刷盘？</strong></p>
<ol>
<li><strong>性能优先</strong>：主动刷盘会严重影响性能，降低吞吐量</li>
<li><strong>可靠性保证</strong>：通过副本机制（acks=all）保证可靠性，而不是依赖单机刷盘</li>
<li><strong>操作系统优化</strong>：操作系统会自动管理 Page Cache 的刷盘，无需手动控制</li>
</ol>
<p><strong>刷盘时机</strong>：</p>
<ul>
<li><strong>操作系统刷盘</strong>：操作系统根据内存压力自动刷盘</li>
<li><strong>进程退出</strong>：进程退出时，操作系统会刷盘</li>
<li><strong>系统调用</strong>：调用 <code>fsync</code> 或 <code>fdatasync</code> 强制刷盘</li>
</ul>
<p><strong>可靠性权衡</strong>：</p>
<ul>
<li><strong>不刷盘</strong>：性能最高，但单机故障可能丢失数据</li>
<li><strong>同步刷盘</strong>：最可靠，但性能下降 90%+</li>
<li><strong>Kafka 方案</strong>：不刷盘 + 多副本，通过副本机制保证可靠性</li>
</ul>
<h4 data-id="heading-33">RocketMQ 消息写入流程</h4>
<p>RocketMQ 的消息写入流程采用了"Broker 接收 -&gt; 写 CommitLog -&gt; 异步构建 ConsumeQueue"的设计，通过中心化 CommitLog 和异步索引构建，实现了高性能和高可靠性的平衡。</p>
<h5 data-id="heading-34">Broker 接收消息 -&gt; 写 CommitLog</h5>
<p><strong>1. Broker 接收消息</strong></p>
<p>Broker 接收到 Producer 的发送请求后：</p>
<ol>
<li><strong>请求解析</strong>：解析请求，提取消息内容、Topic、QueueID 等信息</li>
<li><strong>参数校验</strong>：校验 Topic 是否存在、消息大小是否超限等</li>
<li><strong>消息预处理</strong>：设置消息的存储时间戳、物理偏移量等属性</li>
<li><strong>写入 CommitLog</strong>：将消息追加写入 CommitLog</li>
</ol>
<p><strong>消息预处理</strong>：</p>
<p>RocketMQ 在写入 CommitLog 前，会设置以下属性：</p>
<ul>
<li><strong>BornTimestamp</strong>：消息创建时间戳</li>
<li><strong>StoreTimestamp</strong>：消息存储时间戳</li>
<li><strong>QueueOffset</strong>：消息在 ConsumeQueue 中的逻辑偏移量（初始为 0，后续更新）</li>
<li><strong>PhysicalOffset</strong>：消息在 CommitLog 中的物理偏移量</li>
</ul>
<p><strong>2. 写入 CommitLog</strong></p>
<p>CommitLog 的写入流程：</p>
<ol>
<li><strong>获取当前文件</strong>：获取当前活跃的 MappedFile（内存映射文件）</li>
<li><strong>追加消息</strong>：将消息序列化后追加到 MappedFile</li>
<li><strong>更新偏移量</strong>：更新文件的写入偏移量</li>
<li><strong>文件切换</strong>：如果文件写满（1GB），切换到下一个文件</li>
</ol>
<p><strong>MappedFile 机制</strong>：</p>
<p>RocketMQ 使用 <code>mmap</code> 将 CommitLog 文件映射到内存：</p>
<ul>
<li><strong>优势</strong>：读写性能高，接近内存速度</li>
<li><strong>管理</strong>：RocketMQ 管理 MappedFile 的生命周期，包括创建、切换、删除</li>
<li><strong>预分配</strong>：提前创建下一个文件，避免写入时的文件创建延迟</li>
</ul>
<p><strong>写入性能优化</strong>：</p>
<ol>
<li><strong>批量写入</strong>：Producer 可以批量发送消息，Broker 批量写入</li>
<li><strong>顺序写入</strong>：所有消息顺序写入同一个 CommitLog，磁盘磁头无需移动</li>
<li><strong>内存映射</strong>：使用 mmap，减少数据拷贝</li>
<li><strong>文件预分配</strong>：提前创建文件，避免动态分配的开销</li>
</ol>
<h5 data-id="heading-35">异步构建 ConsumeQueue</h5>
<p>ConsumeQueue 是异步构建的，由 <code>ReputMessageService</code> 线程负责。</p>
<p><strong>ReputMessageService 工作流程</strong>：</p>
<ol>
<li><strong>监听 CommitLog</strong>：监听 CommitLog 的写入事件，获取新的消息偏移量</li>
<li><strong>读取消息</strong>：从 CommitLog 读取消息，解析出 Topic、QueueID、Tag 等信息</li>
<li><strong>构建索引</strong>：将消息的物理偏移量、大小、Tag HashCode 写入对应的 ConsumeQueue</li>
<li><strong>更新 QueueOffset</strong>：更新消息的 QueueOffset（ConsumeQueue 中的逻辑偏移量）</li>
</ol>
<p><strong>异步构建的优势</strong>：</p>
<ul>
<li><strong>写入性能高</strong>：Producer 写入 CommitLog 不需要等待 ConsumeQueue 更新</li>
<li><strong>解耦设计</strong>：ConsumeQueue 的构建失败不影响消息写入</li>
<li><strong>批量优化</strong>：可以批量构建多个 ConsumeQueue，提高效率</li>
</ul>
<p><strong>异步构建的延迟</strong>：</p>
<ul>
<li><strong>正常情况</strong>：延迟通常在 1ms 以内</li>
<li><strong>高负载情况</strong>：延迟可能达到 10ms+</li>
<li><strong>影响</strong>：Consumer 拉取消息时，可能拉取不到最新消息（延迟可接受）</li>
</ul>
<p><strong>同步构建模式</strong>：</p>
<p>RocketMQ 也支持同步构建 ConsumeQueue（通过同步刷盘实现），但会严重影响性能：</p>
<ul>
<li><strong>性能下降</strong>：TPS 下降 50%+</li>
<li><strong>适用场景</strong>：对消息实时性要求极高的场景</li>
</ul>
<h5 data-id="heading-36">同步刷盘 vs 异步刷盘</h5>
<p>RocketMQ 提供了两种刷盘模式：同步刷盘和异步刷盘。</p>
<p><strong>1. 同步刷盘（SYNC_FLUSH）</strong></p>
<p>同步刷盘模式下，消息写入 CommitLog 后，必须等待刷盘完成才返回：</p>
<ul>
<li><strong>可靠性</strong>：最高，消息不会丢失（单机故障除外）</li>
<li><strong>性能</strong>：较低，TPS 下降 50%+</li>
<li><strong>延迟</strong>：较高，P99 延迟增加 5-10ms</li>
<li><strong>适用场景</strong>：金融支付、订单系统等对可靠性要求极高的场景</li>
</ul>
<p><strong>刷盘流程</strong>：</p>
<ol>
<li>消息写入 CommitLog（内存映射）</li>
<li>调用 <code>force()</code> 强制刷盘</li>
<li>等待刷盘完成</li>
<li>返回写入成功</li>
</ol>
<p><strong>2. 异步刷盘（ASYNC_FLUSH）</strong></p>
<p>异步刷盘模式下，消息写入 CommitLog 后立即返回，刷盘由后台线程异步执行：</p>
<ul>
<li><strong>可靠性</strong>：较高，依赖操作系统刷盘，单机故障可能丢失少量消息</li>
<li><strong>性能</strong>：最高，TPS 接近磁盘顺序写入性能</li>
<li><strong>延迟</strong>：最低，P99 延迟 &lt; 1ms</li>
<li><strong>适用场景</strong>：日志收集、监控数据等对性能要求高的场景</li>
</ul>
<p><strong>刷盘流程</strong>：</p>
<ol>
<li>消息写入 CommitLog（内存映射）</li>
<li>立即返回写入成功</li>
<li>后台线程定期刷盘（<code>flushCommitLogLeastPages</code>，默认 4 页）</li>
</ol>
<p><strong>刷盘配置</strong>：</p>
<ul>
<li><strong>flushCommitLogTimed</strong>：是否定时刷盘（默认 true）</li>
<li><strong>flushCommitLogInterval</strong>：定时刷盘间隔（默认 500ms）</li>
<li><strong>flushCommitLogLeastPages</strong>：最少刷盘页数（默认 4 页，16KB）</li>
</ul>
<p><strong>性能对比</strong>：</p>
<p>某测试场景（消息大小 1KB，100 个 Topic）：</p>























<table><thead><tr><th>刷盘模式</th><th>TPS</th><th>P99 延迟</th><th>可靠性</th></tr></thead><tbody><tr><td>同步刷盘</td><td>5万</td><td>10ms</td><td>最高</td></tr><tr><td>异步刷盘</td><td>50万</td><td>1ms</td><td>较高</td></tr></tbody></table>
<h5 data-id="heading-37">主从同步机制（SYNC_MASTER vs ASYNC_MASTER）</h5>
<p>RocketMQ 的主从同步机制决定了消息的可靠性级别。</p>
<p><strong>1. 同步复制（SYNC_MASTER）</strong></p>
<p>同步复制模式下，消息必须同步到 Slave 后才返回：</p>
<ul>
<li><strong>可靠性</strong>：最高，Master 和 Slave 数据完全一致</li>
<li><strong>性能</strong>：较低，TPS 下降 30%+</li>
<li><strong>延迟</strong>：较高，P99 延迟增加 3-5ms</li>
<li><strong>适用场景</strong>：金融支付、订单系统等对可靠性要求极高的场景</li>
</ul>
<p><strong>复制流程</strong>：</p>
<ol>
<li>消息写入 Master CommitLog</li>
<li>Master 将消息发送给 Slave</li>
<li>Slave 写入本地 CommitLog</li>
<li>Slave 返回确认</li>
<li>Master 返回写入成功</li>
</ol>
<p><strong>2. 异步复制（ASYNC_MASTER）</strong></p>
<p>异步复制模式下，消息写入 Master 后立即返回，复制由后台线程异步执行：</p>
<ul>
<li><strong>可靠性</strong>：较高，Master 故障可能丢失少量消息</li>
<li><strong>性能</strong>：最高，TPS 接近单机性能</li>
<li><strong>延迟</strong>：最低，P99 延迟 &lt; 1ms</li>
<li><strong>适用场景</strong>：日志收集、监控数据等对性能要求高的场景</li>
</ul>
<p><strong>复制流程</strong>：</p>
<ol>
<li>消息写入 Master CommitLog</li>
<li>立即返回写入成功</li>
<li>后台线程异步将消息发送给 Slave</li>
<li>Slave 异步写入本地 CommitLog</li>
</ol>
<p><strong>复制配置</strong>：</p>
<ul>
<li><strong>brokerRole</strong>：Broker 角色（SYNC_MASTER、ASYNC_MASTER、SLAVE）</li>
<li><strong>haSendHeartbeatInterval</strong>：心跳间隔（默认 5 秒）</li>
<li><strong>haHousekeepingInterval</strong>：清理间隔（默认 20 秒）</li>
</ul>
<p><strong>可靠性组合</strong>：</p>
<p>RocketMQ 提供了四种可靠性组合：</p>








































<table><thead><tr><th>刷盘模式</th><th>复制模式</th><th>可靠性</th><th>性能</th><th>适用场景</th></tr></thead><tbody><tr><td>同步刷盘</td><td>同步复制</td><td>最高</td><td>最低</td><td>金融支付</td></tr><tr><td>同步刷盘</td><td>异步复制</td><td>较高</td><td>较低</td><td>订单系统</td></tr><tr><td>异步刷盘</td><td>同步复制</td><td>较高</td><td>中等</td><td>一般业务</td></tr><tr><td>异步刷盘</td><td>异步复制</td><td>较高</td><td>最高</td><td>日志收集</td></tr></tbody></table>
<h4 data-id="heading-38">写入性能对比</h4>
<h5 data-id="heading-39">单机吞吐量测试（百万级 TPS）</h5>
<p><strong>测试环境</strong>：</p>
<ul>
<li>CPU：32 核</li>
<li>内存：128GB</li>
<li>磁盘：NVMe SSD（顺序写入 3GB/s）</li>
<li>网络：万兆网卡</li>
<li>消息大小：1KB</li>
<li>Topic 数量：100</li>
<li>Partition/Queue 数量：每个 Topic 4 个</li>
</ul>
<p><strong>Kafka 测试结果</strong>：</p>



































<table><thead><tr><th>配置</th><th>TPS</th><th>P99 延迟</th><th>CPU 使用率</th></tr></thead><tbody><tr><td>acks=0</td><td>120万</td><td>0.5ms</td><td>60%</td></tr><tr><td>acks=1</td><td>100万</td><td>1ms</td><td>70%</td></tr><tr><td>acks=all, min.insync.replicas=1</td><td>80万</td><td>2ms</td><td>80%</td></tr><tr><td>acks=all, min.insync.replicas=2</td><td>50万</td><td>5ms</td><td>90%</td></tr></tbody></table>
<p><strong>RocketMQ 测试结果</strong>：</p>



































<table><thead><tr><th>配置</th><th>TPS</th><th>P99 延迟</th><th>CPU 使用率</th></tr></thead><tbody><tr><td>异步刷盘 + 异步复制</td><td>150万</td><td>0.5ms</td><td>50%</td></tr><tr><td>异步刷盘 + 同步复制</td><td>100万</td><td>2ms</td><td>70%</td></tr><tr><td>同步刷盘 + 异步复制</td><td>60万</td><td>8ms</td><td>80%</td></tr><tr><td>同步刷盘 + 同步复制</td><td>30万</td><td>15ms</td><td>90%</td></tr></tbody></table>
<p><strong>性能分析</strong>：</p>
<ol>
<li>
<p><strong>最高性能</strong>：RocketMQ（异步刷盘 + 异步复制）&gt; Kafka（acks=0）</p>
<ul>
<li>RocketMQ 的中心化 CommitLog 优势明显</li>
<li>异步刷盘 + 异步复制性能最优</li>
</ul>
</li>
<li>
<p><strong>可靠性平衡</strong>：Kafka（acks=all）≈ RocketMQ（异步刷盘 + 同步复制）</p>
<ul>
<li>两者性能相近，都在 80-100 万 TPS</li>
<li>可靠性都较高（多副本保证）</li>
</ul>
</li>
<li>
<p><strong>最高可靠性</strong>：RocketMQ（同步刷盘 + 同步复制）&gt; Kafka（acks=all）</p>
<ul>
<li>RocketMQ 的同步刷盘保证单机可靠性</li>
<li>但性能下降明显（30 万 TPS）</li>
</ul>
</li>
</ol>
<h5 data-id="heading-40">延迟对比（P99、P999）</h5>
<p><strong>测试场景</strong>：单 Topic，4 个 Partition/Queue，消息大小 1KB，TPS 10 万</p>
<p><strong>Kafka 延迟</strong>：</p>





























<table><thead><tr><th>百分位</th><th>acks=0</th><th>acks=1</th><th>acks=all</th></tr></thead><tbody><tr><td>P50</td><td>0.2ms</td><td>0.5ms</td><td>1ms</td></tr><tr><td>P99</td><td>0.5ms</td><td>1ms</td><td>3ms</td></tr><tr><td>P999</td><td>1ms</td><td>2ms</td><td>10ms</td></tr></tbody></table>
<p><strong>RocketMQ 延迟</strong>：</p>





























<table><thead><tr><th>百分位</th><th>异步刷盘+异步复制</th><th>异步刷盘+同步复制</th><th>同步刷盘+同步复制</th></tr></thead><tbody><tr><td>P50</td><td>0.2ms</td><td>0.8ms</td><td>5ms</td></tr><tr><td>P99</td><td>0.5ms</td><td>2ms</td><td>15ms</td></tr><tr><td>P999</td><td>1ms</td><td>5ms</td><td>50ms</td></tr></tbody></table>
<p><strong>延迟分析</strong>：</p>
<ol>
<li>
<p><strong>最低延迟</strong>：Kafka（acks=0）≈ RocketMQ（异步刷盘+异步复制）</p>
<ul>
<li>两者 P99 延迟都在 0.5ms 左右</li>
<li>适合对延迟敏感的场景</li>
</ul>
</li>
<li>
<p><strong>可靠性平衡</strong>：Kafka（acks=all）≈ RocketMQ（异步刷盘+同步复制）</p>
<ul>
<li>两者 P99 延迟都在 2-3ms</li>
<li>可靠性较高，延迟可接受</li>
</ul>
</li>
<li>
<p><strong>最高可靠性</strong>：RocketMQ（同步刷盘+同步复制）</p>
<ul>
<li>P99 延迟 15ms，P999 延迟 50ms</li>
<li>适合对可靠性要求极高的场景</li>
</ul>
</li>
</ol>
<h5 data-id="heading-41">顺序写性能优化技巧</h5>
<p><strong>1. Kafka 优化技巧</strong>：</p>
<ul>
<li><strong>合理设置 Partition 数量</strong>：Partition 数量过多会导致文件碎片化，影响顺序写入性能</li>
<li><strong>使用 SSD</strong>：SSD 的顺序写入性能远高于 HDD</li>
<li><strong>调整 Segment 大小</strong>：合理设置 <code>log.segment.bytes</code>，避免频繁切分文件</li>
<li><strong>优化 Page Cache</strong>：确保有足够的内存用于 Page Cache</li>
</ul>
<p><strong>2. RocketMQ 优化技巧</strong>：</p>
<ul>
<li><strong>文件预分配</strong>：提前创建文件，避免动态分配的开销</li>
<li><strong>TransientStorePool</strong>：使用堆外内存池，减少 GC 压力</li>
<li><strong>批量写入</strong>：Producer 批量发送消息，Broker 批量写入</li>
<li><strong>异步刷盘</strong>：如果对可靠性要求不高，使用异步刷盘提高性能</li>
</ul>
<p><strong>3. 通用优化技巧</strong>：</p>
<ul>
<li><strong>使用 XFS 文件系统</strong>：XFS 对顺序写入性能更好</li>
<li><strong>调整 IO 调度器</strong>：使用 <code>deadline</code> 或 <code>noop</code> 调度器</li>
<li><strong>关闭文件系统特性</strong>：关闭 <code>atime</code>、<code>dirsync</code> 等不必要的特性</li>
<li><strong>RAID 配置</strong>：使用 RAID 0 或 RAID 10，提高 IO 性能</li>
</ul>
<hr/>
<hr/>
<h3 data-id="heading-42">1.4 消息读取流程</h3>
<p>消息读取流程是消息队列性能的关键环节，直接影响 Consumer 的消费速度和延迟。Kafka 和 RocketMQ 在消息读取上采用了不同的技术路线，本节将从 Consumer 拉取机制、零拷贝技术、消息过滤等多个维度进行深入对比。</p>
<h4 data-id="heading-43">Kafka 消息拉取</h4>
<p>Kafka 的消息拉取机制充分利用了零拷贝技术和 Page Cache，实现了极高的读取性能。</p>
<h5 data-id="heading-44">Consumer 拉取流程</h5>
<p><strong>1. Consumer 发送 Fetch 请求</strong></p>
<p>Consumer 通过以下步骤拉取消息：</p>
<ol>
<li><strong>确定拉取位置</strong>：根据当前消费进度（Offset）确定拉取的起始位置</li>
<li><strong>构建 Fetch 请求</strong>：包含 Topic、Partition、Offset、最大拉取大小等信息</li>
<li><strong>发送请求</strong>：向对应 Partition 的 Leader Broker 发送 Fetch 请求</li>
<li><strong>等待响应</strong>：等待 Broker 返回消息数据</li>
</ol>
<p><strong>Fetch 请求参数</strong>：</p>
<ul>
<li><strong>max.wait.ms</strong>：最大等待时间（默认 500ms），如果数据不足，等待新数据到达</li>
<li><strong>min.bytes</strong>：最小拉取字节数（默认 1 字节），如果数据不足，等待更多数据</li>
<li><strong>max.bytes</strong>：最大拉取字节数（默认 50MB），单次拉取的最大数据量</li>
<li><strong>fetch.min.bytes</strong>：最小拉取字节数（已废弃，使用 min.bytes）</li>
</ul>
<p><strong>批量拉取优化</strong>：</p>
<p>Kafka 支持批量拉取多个 Partition 的消息：</p>
<ul>
<li><strong>单次请求拉取多个 Partition</strong>：减少网络请求次数</li>
<li><strong>并行拉取</strong>：多个 Partition 可以并行拉取，提高吞吐量</li>
<li><strong>负载均衡</strong>：Consumer Group 内的多个 Consumer 可以并行拉取不同 Partition</li>
</ul>
<p><strong>2. Leader 处理 Fetch 请求</strong></p>
<p>Leader Broker 接收到 Fetch 请求后：</p>
<ol>
<li><strong>验证请求</strong>：检查 Partition 是否存在、Offset 是否有效</li>
<li><strong>定位消息</strong>：根据 Offset 定位到对应的 Segment 和消息位置</li>
<li><strong>读取消息</strong>：从 Segment 文件读取消息数据</li>
<li><strong>返回响应</strong>：使用 sendfile 零拷贝技术返回消息数据</li>
</ol>
<p><strong>消息定位流程</strong>：</p>
<ol>
<li><strong>确定 Segment</strong>：根据 Offset 和文件名确定目标 Segment</li>
<li><strong>查找索引</strong>：在 .index 文件中二分查找，找到最接近的索引项</li>
<li><strong>顺序扫描</strong>：从索引项指向的位置开始顺序扫描，找到目标消息</li>
<li><strong>批量读取</strong>：读取从目标 Offset 开始的所有消息（直到达到 max.bytes）</li>
</ol>
<p><strong>3. Consumer 处理响应</strong></p>
<p>Consumer 接收到消息数据后：</p>
<ol>
<li><strong>反序列化</strong>：将字节数组反序列化为消息对象</li>
<li><strong>提交 Offset</strong>：根据配置自动或手动提交消费进度</li>
<li><strong>业务处理</strong>：调用业务逻辑处理消息</li>
<li><strong>继续拉取</strong>：处理完成后继续拉取下一条消息</li>
</ol>
<h5 data-id="heading-45">Zero-Copy 技术（sendfile 系统调用）</h5>
<p>Kafka 使用 <code>sendfile</code> 系统调用实现零拷贝，这是其高性能读取的关键技术。</p>
<p><strong>传统读取方式</strong>：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> 磁盘 -&gt; 内核缓冲区（Page Cache）
<span class="hljs-bullet">2.</span> 内核缓冲区 -&gt; 用户缓冲区（read 系统调用）
<span class="hljs-bullet">3.</span> 用户缓冲区 -&gt; 内核缓冲区（write 系统调用）
<span class="hljs-bullet">4.</span> 内核缓冲区 -&gt; 网络套接字（发送）

总计：4 次数据拷贝，2 次系统调用
</code></pre>
<p><strong>sendfile 零拷贝方式</strong>：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> 磁盘 -&gt; 内核缓冲区（Page Cache）
<span class="hljs-bullet">2.</span> 内核缓冲区 -&gt; 网络套接字（sendfile 系统调用）

总计：2 次数据拷贝，1 次系统调用
</code></pre>
<p><strong>性能提升</strong>：</p>
<ul>
<li><strong>数据拷贝减少 50%</strong>：从 4 次减少到 2 次</li>
<li><strong>CPU 使用率降低</strong>：减少数据拷贝，降低 CPU 开销</li>
<li><strong>吞吐量提升</strong>：实测吞吐量提升 50%+</li>
</ul>
<p><strong>sendfile 的限制</strong>：</p>
<ol>
<li><strong>文件大小限制</strong>：sendfile 只能发送文件，不能发送内存中的数据</li>
<li><strong>操作系统支持</strong>：需要操作系统支持 sendfile（Linux 2.4+）</li>
<li><strong>数据修改</strong>：如果需要在发送前修改数据，无法使用 sendfile</li>
</ol>
<p><strong>实际案例</strong>：</p>
<p>某 Kafka 集群在高峰期读取性能下降：</p>
<ul>
<li><strong>问题现象</strong>：Consumer 拉取延迟从 1ms 增加到 10ms</li>
<li><strong>根本原因</strong>：Page Cache 命中率下降，大量数据需要从磁盘读取</li>
<li><strong>解决方案</strong>：增加 Broker 内存，提高 Page Cache 命中率</li>
</ul>
<h5 data-id="heading-46">Fetch Request 批量拉取优化</h5>
<p>Kafka 通过批量拉取机制提高读取性能。</p>
<p><strong>批量拉取策略</strong>：</p>
<ol>
<li><strong>等待更多数据</strong>：通过 <code>max.wait.ms</code> 和 <code>min.bytes</code> 控制等待时间</li>
<li><strong>合并多个 Partition</strong>：单次请求可以拉取多个 Partition 的消息</li>
<li><strong>预取机制</strong>：Consumer 可以提前拉取下一批消息</li>
</ol>
<p><strong>配置优化</strong>：</p>
<ul>
<li><strong>fetch.min.bytes</strong>：设置为较大的值（如 1MB），等待更多数据再返回</li>
<li><strong>fetch.max.wait.ms</strong>：设置合理的等待时间（如 500ms），平衡延迟和吞吐量</li>
<li><strong>max.partition.fetch.bytes</strong>：设置每个 Partition 的最大拉取大小（默认 1MB）</li>
</ul>
<p><strong>性能影响</strong>：</p>
<ul>
<li><strong>吞吐量提升</strong>：批量拉取可以减少网络请求次数，提高吞吐量</li>
<li><strong>延迟增加</strong>：等待更多数据会增加延迟，需要权衡</li>
<li><strong>内存占用</strong>：批量拉取会增加 Consumer 的内存占用</li>
</ul>
<h5 data-id="heading-47">Page Cache 命中率的影响</h5>
<p>Page Cache 命中率直接影响 Kafka 的读取性能。</p>
<p><strong>Page Cache 工作原理</strong>：</p>
<ol>
<li><strong>写入时</strong>：消息写入 Page Cache，操作系统异步刷盘</li>
<li><strong>读取时</strong>：如果数据在 Page Cache 中，直接从内存读取；否则从磁盘读取</li>
</ol>
<p><strong>命中率影响因素</strong>：</p>
<ol>
<li><strong>内存大小</strong>：内存越大，Page Cache 越大，命中率越高</li>
<li><strong>数据访问模式</strong>：顺序访问命中率高，随机访问命中率低</li>
<li><strong>其他应用</strong>：其他应用占用内存会挤占 Page Cache</li>
</ol>
<p><strong>提高命中率的策略</strong>：</p>
<ol>
<li><strong>增加内存</strong>：为 Kafka Broker 分配足够的内存（建议 70%+ 系统内存）</li>
<li><strong>限制其他应用</strong>：限制其他应用的内存使用，避免挤占 Page Cache</li>
<li><strong>顺序消费</strong>：Consumer 尽量顺序消费，提高命中率</li>
<li><strong>预热缓存</strong>：启动时预热 Page Cache，提前加载热点数据</li>
</ol>
<p><strong>实际案例</strong>：</p>
<p>某 Kafka 集群在高峰期读取性能突然下降：</p>
<ul>
<li><strong>问题现象</strong>：Consumer 拉取延迟从 1ms 增加到 50ms</li>
<li><strong>根本原因</strong>：其他应用占用了大量内存，Page Cache 被挤占，命中率从 95% 降到 30%</li>
<li><strong>解决方案</strong>：
<ol>
<li>增加 Broker 内存（从 32GB 增加到 64GB）</li>
<li>限制其他应用的内存使用</li>
<li>调整 Page Cache 的回收策略</li>
</ol>
</li>
</ul>
<h4 data-id="heading-48">RocketMQ 消息拉取</h4>
<p>RocketMQ 的消息拉取机制通过 ConsumeQueue 索引定位消息，然后从 CommitLog 读取消息体，实现了高效的消息检索。</p>
<h5 data-id="heading-49">Consumer 通过 ConsumeQueue 定位消息</h5>
<p><strong>1. Consumer 发送 Pull 请求</strong></p>
<p>Consumer 通过以下步骤拉取消息：</p>
<ol>
<li><strong>确定拉取位置</strong>：根据当前消费进度（QueueOffset）确定拉取的起始位置</li>
<li><strong>构建 Pull 请求</strong>：包含 Topic、QueueID、QueueOffset、最大拉取数量等信息</li>
<li><strong>发送请求</strong>：向对应的 Broker 发送 Pull 请求</li>
<li><strong>等待响应</strong>：等待 Broker 返回消息数据</li>
</ol>
<p><strong>Pull 请求参数</strong>：</p>
<ul>
<li><strong>maxMsgNums</strong>：最大拉取消息数量（默认 32 条）</li>
<li><strong>queueId</strong>：队列 ID</li>
<li><strong>queueOffset</strong>：队列偏移量（ConsumeQueue 中的逻辑偏移量）</li>
<li><strong>sysFlag</strong>：系统标志（包含订阅信息、消息过滤标志等）</li>
</ul>
<p><strong>2. Broker 处理 Pull 请求</strong></p>
<p>Broker 接收到 Pull 请求后：</p>
<ol>
<li><strong>验证请求</strong>：检查 Topic、QueueID 是否存在，Offset 是否有效</li>
<li><strong>查询 ConsumeQueue</strong>：根据 QueueOffset 从 ConsumeQueue 读取消息索引</li>
<li><strong>读取 CommitLog</strong>：根据索引中的物理偏移量从 CommitLog 读取消息体</li>
<li><strong>消息过滤</strong>：根据 Tag 或 SQL92 表达式过滤消息</li>
<li><strong>返回响应</strong>：返回符合条件的消息</li>
</ol>
<p><strong>消息定位流程</strong>：</p>
<ol>
<li><strong>计算 ConsumeQueue 文件</strong>：根据 QueueOffset 计算对应的 ConsumeQueue 文件</li>
<li><strong>读取索引项</strong>：从 ConsumeQueue 文件读取索引项（Offset、Size、Tag）</li>
<li><strong>Tag 过滤</strong>：如果指定了 Tag，先进行 Tag 过滤（无需读取 CommitLog）</li>
<li><strong>读取消息体</strong>：根据索引项中的物理偏移量从 CommitLog 读取消息体</li>
<li><strong>SQL92 过滤</strong>：如果使用 SQL92 过滤，解析消息属性进行过滤</li>
</ol>
<p><strong>3. Consumer 处理响应</strong></p>
<p>Consumer 接收到消息数据后：</p>
<ol>
<li><strong>反序列化</strong>：将字节数组反序列化为消息对象</li>
<li><strong>提交 Offset</strong>：根据配置自动或手动提交消费进度</li>
<li><strong>业务处理</strong>：调用业务逻辑处理消息</li>
<li><strong>继续拉取</strong>：处理完成后继续拉取下一条消息</li>
</ol>
<h5 data-id="heading-50">从 CommitLog 读取消息体</h5>
<p>RocketMQ 通过两阶段读取机制实现消息检索：先读 ConsumeQueue 索引，再读 CommitLog 消息体。</p>
<p><strong>读取流程</strong>：</p>
<ol>
<li>
<p><strong>读取 ConsumeQueue</strong>：</p>
<ul>
<li>根据 QueueOffset 定位到 ConsumeQueue 文件</li>
<li>读取索引项（Offset、Size、Tag）</li>
<li>文件小（5.7MB），可以完全加载到内存，读取速度快</li>
</ul>
</li>
<li>
<p><strong>读取 CommitLog</strong>：</p>
<ul>
<li>根据索引项中的物理偏移量定位到 CommitLog 文件</li>
<li>读取消息体（大小由索引项中的 Size 字段指定）</li>
<li>文件大（1GB），使用内存映射（mmap）提高读取性能</li>
</ul>
</li>
</ol>
<p><strong>读取性能优化</strong>：</p>
<ol>
<li><strong>批量读取</strong>：一次读取多条消息的索引，减少 ConsumeQueue 的读取次数</li>
<li><strong>内存映射</strong>：CommitLog 使用 mmap，减少数据拷贝</li>
<li><strong>Page Cache</strong>：CommitLog 顺序写入，Page Cache 命中率高</li>
<li><strong>预读机制</strong>：操作系统自动预读，提高顺序读取性能</li>
</ol>
<p><strong>读放大问题</strong>：</p>
<p>RocketMQ 的读取需要两次磁盘 IO：</p>
<ol>
<li>读取 ConsumeQueue（获取索引）</li>
<li>读取 CommitLog（获取消息体）</li>
</ol>
<p>这被称为"读放大"问题，但通过以下优化可以缓解：</p>
<ul>
<li>ConsumeQueue 文件小，可以完全加载到内存</li>
<li>CommitLog 顺序写入，Page Cache 命中率高</li>
<li>批量读取可以减少 IO 次数</li>
</ul>
<h5 data-id="heading-51">为什么 RocketMQ 读放大问题？</h5>
<p>RocketMQ 的读放大问题源于其存储架构设计：中心化 CommitLog + 分布式 ConsumeQueue。</p>
<p><strong>读放大的原因</strong>：</p>
<ol>
<li><strong>两阶段读取</strong>：需要先读 ConsumeQueue，再读 CommitLog</li>
<li><strong>索引分离</strong>：索引和数据分离存储，无法一次性读取</li>
<li><strong>设计权衡</strong>：为了写入性能（中心化 CommitLog），牺牲了读取性能</li>
</ol>
<p><strong>读放大的影响</strong>：</p>
<ul>
<li><strong>延迟增加</strong>：两次磁盘 IO 会增加读取延迟</li>
<li><strong>吞吐量下降</strong>：IO 次数增加会降低吞吐量</li>
<li><strong>CPU 开销</strong>：需要解析两次数据，增加 CPU 开销</li>
</ul>
<p><strong>读放大的优化</strong>：</p>
<ol>
<li><strong>ConsumeQueue 内存化</strong>：ConsumeQueue 文件小，可以完全加载到内存</li>
<li><strong>Page Cache 优化</strong>：CommitLog 顺序写入，Page Cache 命中率高</li>
<li><strong>批量读取</strong>：一次读取多条消息，减少 IO 次数</li>
<li><strong>预读机制</strong>：操作系统自动预读，提高顺序读取性能</li>
</ol>
<p><strong>实际性能</strong>：</p>
<p>虽然存在读放大问题，但通过优化，RocketMQ 的读取性能仍然很高：</p>
<ul>
<li><strong>ConsumeQueue 读取</strong>：&lt; 0.1ms（内存读取）</li>
<li><strong>CommitLog 读取</strong>：&lt; 1ms（Page Cache 命中）</li>
<li><strong>总延迟</strong>：&lt; 1.5ms（P99）</li>
</ul>
<h5 data-id="heading-52">消息过滤实现（Tag vs SQL92）</h5>
<p>RocketMQ 支持两种消息过滤方式：Tag 过滤和 SQL92 过滤。</p>
<p><strong>1. Tag 过滤</strong></p>
<p>Tag 过滤是 RocketMQ 最常用的过滤方式，性能高，实现简单。</p>
<p><strong>工作原理</strong>：</p>
<ol>
<li><strong>Tag HashCode 存储</strong>：消息的 Tag HashCode 存储在 ConsumeQueue 中</li>
<li><strong>快速过滤</strong>：Consumer 拉取时，先比较 Tag HashCode，无需读取 CommitLog</li>
<li><strong>精确匹配</strong>：如果 HashCode 匹配，再读取 CommitLog 进行精确匹配</li>
</ol>
<p><strong>优势</strong>：</p>
<ul>
<li><strong>性能高</strong>：过滤在 ConsumeQueue 层面完成，无需读取 CommitLog</li>
<li><strong>实现简单</strong>：只需要比较 HashCode</li>
<li><strong>内存占用低</strong>：Tag HashCode 只有 8 字节</li>
</ul>
<p><strong>限制</strong>：</p>
<ul>
<li><strong>Hash 冲突</strong>：不同 Tag 可能 Hash 到同一个值，需要精确匹配</li>
<li><strong>过滤粒度</strong>：只能按 Tag 过滤，无法按消息属性过滤</li>
</ul>
<p><strong>2. SQL92 过滤</strong></p>
<p>SQL92 过滤是 RocketMQ 的高级过滤功能，支持按消息属性过滤。</p>
<p><strong>工作原理</strong>：</p>
<ol>
<li><strong>属性解析</strong>：读取 CommitLog 中的消息属性（Properties）</li>
<li><strong>SQL 解析</strong>：解析 SQL92 表达式</li>
<li><strong>属性匹配</strong>：根据 SQL 表达式匹配消息属性</li>
</ol>
<p><strong>SQL92 语法</strong>：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 示例1：按数字属性过滤</span>
a <span class="hljs-operator">&gt;</span> <span class="hljs-number">10</span> <span class="hljs-keyword">AND</span> b <span class="hljs-operator">&lt;</span> <span class="hljs-number">20</span>

<span class="hljs-comment">-- 示例2：按字符串属性过滤</span>
name <span class="hljs-operator">=</span> <span class="hljs-string">'John'</span> <span class="hljs-keyword">AND</span> age <span class="hljs-operator">&gt;</span> <span class="hljs-number">18</span>

<span class="hljs-comment">-- 示例3：按布尔属性过滤</span>
isVip <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>
</code></pre>
<p><strong>优势</strong>：</p>
<ul>
<li><strong>灵活性强</strong>：支持复杂的过滤条件</li>
<li><strong>功能丰富</strong>：支持数字、字符串、布尔等类型</li>
<li><strong>业务友好</strong>：业务可以直接使用 SQL 表达式</li>
</ul>
<p><strong>限制</strong>：</p>
<ul>
<li><strong>性能较低</strong>：需要读取 CommitLog 解析属性，性能低于 Tag 过滤</li>
<li><strong>内存占用</strong>：需要解析 SQL 表达式，占用一定内存</li>
<li><strong>功能限制</strong>：不支持所有 SQL 语法，只支持部分操作符</li>
</ul>
<p><strong>性能对比</strong>：</p>























<table><thead><tr><th>过滤方式</th><th>延迟</th><th>吞吐量</th><th>适用场景</th></tr></thead><tbody><tr><td>Tag 过滤</td><td>&lt; 0.1ms</td><td>100万+ TPS</td><td>简单过滤</td></tr><tr><td>SQL92 过滤</td><td>&lt; 1ms</td><td>50万+ TPS</td><td>复杂过滤</td></tr></tbody></table>
<p><strong>最佳实践</strong>：</p>
<ol>
<li><strong>优先使用 Tag 过滤</strong>：如果过滤条件简单，优先使用 Tag 过滤</li>
<li><strong>合理使用 SQL92</strong>：只有在需要复杂过滤时才使用 SQL92</li>
<li><strong>避免过度过滤</strong>：过滤条件不要过于复杂，影响性能</li>
</ol>
<h4 data-id="heading-53">读性能对比</h4>
<h5 data-id="heading-54">消费延迟对比</h5>
<p><strong>测试场景</strong>：</p>
<ul>
<li>单 Topic，4 个 Partition/Queue</li>
<li>消息大小 1KB</li>
<li>Consumer 数量：4 个（每个 Partition/Queue 一个 Consumer）</li>
<li>TPS：10 万</li>
</ul>
<p><strong>Kafka 消费延迟</strong>：</p>

























<table><thead><tr><th>百分位</th><th>延迟</th><th>说明</th></tr></thead><tbody><tr><td>P50</td><td>0.5ms</td><td>中位数延迟</td></tr><tr><td>P99</td><td>1ms</td><td>99% 的请求延迟</td></tr><tr><td>P999</td><td>2ms</td><td>99.9% 的请求延迟</td></tr></tbody></table>
<p><strong>RocketMQ 消费延迟</strong>：</p>

























<table><thead><tr><th>百分位</th><th>延迟</th><th>说明</th></tr></thead><tbody><tr><td>P50</td><td>0.8ms</td><td>中位数延迟</td></tr><tr><td>P99</td><td>1.5ms</td><td>99% 的请求延迟</td></tr><tr><td>P999</td><td>3ms</td><td>99.9% 的请求延迟</td></tr></tbody></table>
<p><strong>延迟分析</strong>：</p>
<ol>
<li><strong>Kafka 优势</strong>：直接读取，无读放大，延迟更低</li>
<li><strong>RocketMQ 劣势</strong>：两阶段读取，存在读放大，延迟略高</li>
<li><strong>实际影响</strong>：延迟差异在 0.5-1ms，对大多数场景影响不大</li>
</ol>
<h5 data-id="heading-55">历史消息查询性能</h5>
<p>历史消息查询是消息队列的重要功能，Kafka 和 RocketMQ 的实现方式不同。</p>
<p><strong>Kafka 历史消息查询</strong>：</p>
<ol>
<li>
<p><strong>按 Offset 查询</strong>：</p>
<ul>
<li>根据 Offset 定位到 Segment</li>
<li>在 .index 文件中查找索引</li>
<li>顺序扫描找到目标消息</li>
<li><strong>性能</strong>：&lt; 10ms（Page Cache 命中）</li>
</ul>
</li>
<li>
<p><strong>按时间戳查询</strong>：</p>
<ul>
<li>根据时间戳在 .timeindex 文件中查找</li>
<li>定位到大致位置</li>
<li>顺序扫描找到精确消息</li>
<li><strong>性能</strong>：&lt; 50ms（Page Cache 命中）</li>
</ul>
</li>
</ol>
<p><strong>RocketMQ 历史消息查询</strong>：</p>
<ol>
<li>
<p><strong>按 QueueOffset 查询</strong>：</p>
<ul>
<li>根据 QueueOffset 定位到 ConsumeQueue 文件</li>
<li>读取索引项</li>
<li>从 CommitLog 读取消息体</li>
<li><strong>性能</strong>：&lt; 5ms（Page Cache 命中）</li>
</ul>
</li>
<li>
<p><strong>按消息 Key 查询</strong>：</p>
<ul>
<li>根据 Key 计算 HashCode</li>
<li>在 IndexFile 中查找索引</li>
<li>从 CommitLog 读取消息体</li>
<li><strong>性能</strong>：&lt; 20ms（Page Cache 命中）</li>
</ul>
</li>
</ol>
<p><strong>性能对比</strong>：</p>





























<table><thead><tr><th>查询方式</th><th>Kafka</th><th>RocketMQ</th><th>说明</th></tr></thead><tbody><tr><td>按 Offset/QueueOffset</td><td>&lt; 10ms</td><td>&lt; 5ms</td><td>RocketMQ 略优</td></tr><tr><td>按时间戳</td><td>&lt; 50ms</td><td>不支持</td><td>Kafka 优势</td></tr><tr><td>按消息 Key</td><td>不支持</td><td>&lt; 20ms</td><td>RocketMQ 优势</td></tr></tbody></table>
<h5 data-id="heading-56">消息堆积场景下的表现</h5>
<p>消息堆积是生产环境的常见场景，Kafka 和 RocketMQ 的表现不同。</p>
<p><strong>Kafka 消息堆积场景</strong>：</p>
<ol>
<li>
<p><strong>读取性能</strong>：</p>
<ul>
<li>顺序读取，性能稳定</li>
<li>Page Cache 命中率高，读取速度快</li>
<li><strong>性能</strong>：100万+ TPS</li>
</ul>
</li>
<li>
<p><strong>磁盘 IO</strong>：</p>
<ul>
<li>如果 Page Cache 未命中，需要从磁盘读取</li>
<li>磁盘 IO 可能成为瓶颈</li>
<li><strong>优化</strong>：增加内存，提高 Page Cache 命中率</li>
</ul>
</li>
<li>
<p><strong>消费进度管理</strong>：</p>
<ul>
<li>Offset 存储在 <code>__consumer_offsets</code> Topic</li>
<li>消费进度查询需要读取该 Topic</li>
<li><strong>性能</strong>：查询延迟 &lt; 10ms</li>
</ul>
</li>
</ol>
<p><strong>RocketMQ 消息堆积场景</strong>：</p>
<ol>
<li>
<p><strong>读取性能</strong>：</p>
<ul>
<li>ConsumeQueue 可以完全加载到内存，读取速度快</li>
<li>CommitLog 顺序写入，Page Cache 命中率高</li>
<li><strong>性能</strong>：80万+ TPS</li>
</ul>
</li>
<li>
<p><strong>磁盘 IO</strong>：</p>
<ul>
<li>ConsumeQueue 读取：内存读取，无磁盘 IO</li>
<li>CommitLog 读取：Page Cache 命中率高，磁盘 IO 少</li>
<li><strong>优化</strong>：增加内存，提高 Page Cache 命中率</li>
</ul>
</li>
<li>
<p><strong>消费进度管理</strong>：</p>
<ul>
<li>Offset 存储在 Broker 端</li>
<li>消费进度查询直接读取内存，速度快</li>
<li><strong>性能</strong>：查询延迟 &lt; 1ms</li>
</ul>
</li>
</ol>
<p><strong>堆积场景性能对比</strong>：</p>





























<table><thead><tr><th>指标</th><th>Kafka</th><th>RocketMQ</th><th>说明</th></tr></thead><tbody><tr><td>读取 TPS</td><td>100万+</td><td>80万+</td><td>Kafka 略优</td></tr><tr><td>查询延迟</td><td>&lt; 10ms</td><td>&lt; 1ms</td><td>RocketMQ 优势</td></tr><tr><td>内存占用</td><td>高（Page Cache）</td><td>中（ConsumeQueue + Page Cache）</td><td>Kafka 略高</td></tr></tbody></table>
<p><strong>实际案例</strong>：</p>
<p>某电商系统消息堆积到千万级：</p>
<ul>
<li>
<p><strong>Kafka 表现</strong>：</p>
<ul>
<li>读取性能稳定，TPS 保持在 100 万+</li>
<li>Page Cache 命中率 95%+</li>
<li>消费延迟 &lt; 2ms</li>
</ul>
</li>
<li>
<p><strong>RocketMQ 表现</strong>：</p>
<ul>
<li>读取性能稳定，TPS 保持在 80 万+</li>
<li>ConsumeQueue 完全在内存，读取速度快</li>
<li>CommitLog Page Cache 命中率 90%+</li>
<li>消费延迟 &lt; 2ms</li>
</ul>
</li>
</ul>
<p><strong>结论</strong>：</p>
<ol>
<li><strong>Kafka</strong>：顺序读取性能高，Page Cache 命中率高，适合消息堆积场景</li>
<li><strong>RocketMQ</strong>：ConsumeQueue 内存化，查询速度快，适合需要频繁查询消费进度的场景</li>
</ol>
<hr/>
<hr/>
<h3 data-id="heading-57">1.5 存储层优化技巧</h3>
<p>存储层优化是提升消息队列性能的关键手段，直接影响吞吐量、延迟和资源利用率。Kafka 和 RocketMQ 都提供了丰富的优化配置和技巧，本节将从文件管理、内存优化、过期清理等多个维度进行深入分析。</p>
<h4 data-id="heading-58">Kafka 优化</h4>
<p>Kafka 的存储优化主要围绕 Segment 管理、Log Compaction 和 Tiered Storage 等方面展开。</p>
<h5 data-id="heading-59">合理设置 Segment 大小</h5>
<p>Segment 大小是 Kafka 性能调优的重要参数，直接影响文件管理和查询性能。</p>
<p><strong>Segment 大小配置</strong>：</p>
<ul>
<li><strong>log.segment.bytes</strong>：单个 Segment 文件的最大大小（默认 1GB）</li>
<li><strong>log.segment.ms</strong>：Segment 切分的时间间隔（默认 7 天）</li>
</ul>
<p><strong>Segment 大小的影响</strong>：</p>
<ol>
<li>
<p><strong>文件数量</strong>：</p>
<ul>
<li>Segment 越小，文件数量越多，文件句柄占用越多</li>
<li>Segment 越大，文件数量越少，但单个文件越大</li>
</ul>
</li>
<li>
<p><strong>查询性能</strong>：</p>
<ul>
<li>Segment 越小，索引文件越小，查询速度越快</li>
<li>Segment 越大，索引文件越大，查询速度可能变慢</li>
</ul>
</li>
<li>
<p><strong>删除性能</strong>：</p>
<ul>
<li>Segment 越小，删除操作越快（删除整个文件）</li>
<li>Segment 越大，删除操作越慢</li>
</ul>
</li>
</ol>
<p><strong>最佳实践</strong>：</p>
<ul>
<li><strong>日志流场景</strong>：使用默认 1GB，平衡文件数量和查询性能</li>
<li><strong>高吞吐场景</strong>：可以增加到 2-5GB，减少文件数量</li>
<li><strong>低延迟场景</strong>：可以减少到 512MB，提高查询速度</li>
</ul>
<p><strong>实际案例</strong>：</p>
<p>某 Kafka 集群有 1000+ 个 Topic，文件句柄数达到 10 万+：</p>
<ul>
<li><strong>问题现象</strong>：Broker 频繁重启，系统文件句柄限制</li>
<li><strong>根本原因</strong>：Segment 大小默认 1GB，文件数量过多</li>
<li><strong>解决方案</strong>：将 Segment 大小增加到 5GB，文件数量减少 80%</li>
</ul>
<h5 data-id="heading-60">使用 Log Compaction 减少存储</h5>
<p>Log Compaction 是 Kafka 的高级特性，可以删除相同 Key 的旧消息，只保留最新消息，从而减少存储空间。</p>
<p><strong>Log Compaction 配置</strong>：</p>
<ul>
<li><strong>log.cleaner.enable</strong>：是否启用 Log Compaction（默认 true）</li>
<li><strong>log.cleanup.policy</strong>：清理策略（delete 或 compact）</li>
<li><strong>min.cleanable.dirty.ratio</strong>：触发 Compaction 的脏数据比例（默认 0.5）</li>
</ul>
<p><strong>Compaction 的优势</strong>：</p>
<ol>
<li><strong>减少存储空间</strong>：删除旧消息，只保留最新消息</li>
<li><strong>提高查询性能</strong>：数据量减少，查询速度更快</li>
<li><strong>支持变更日志</strong>：可以作为变更日志（Change Log）使用</li>
</ol>
<p><strong>Compaction 的代价</strong>：</p>
<ol>
<li><strong>CPU 开销</strong>：Compaction 是 CPU 密集型操作</li>
<li><strong>磁盘 IO</strong>：需要读取旧 Segment 并写入新 Segment</li>
<li><strong>内存占用</strong>：需要维护 Key 到 Offset 的映射表</li>
</ol>
<p><strong>最佳实践</strong>：</p>
<ul>
<li><strong>变更日志场景</strong>：启用 Compaction，只保留最新状态</li>
<li><strong>日志流场景</strong>：使用 delete 策略，按时间删除</li>
<li><strong>混合场景</strong>：根据 Topic 特点选择不同的清理策略</li>
</ul>
<p><strong>实际案例</strong>：</p>
<p>某电商系统使用 Kafka 存储订单状态变更：</p>
<ul>
<li><strong>问题现象</strong>：存储空间快速增长，7 天数据达到 10TB</li>
<li><strong>根本原因</strong>：订单状态频繁变更，相同订单有多条消息</li>
<li><strong>解决方案</strong>：启用 Log Compaction，只保留最新状态，存储空间减少 90%</li>
</ul>
<h5 data-id="heading-61">Tiered Storage（分层存储，Kafka 3.0+）</h5>
<p>Tiered Storage 是 Kafka 3.0+ 引入的新特性，支持将冷数据存储到对象存储（如 S3、HDFS），从而降低存储成本。</p>
<p><strong>Tiered Storage 架构</strong>：</p>
<ol>
<li><strong>热数据层</strong>：存储在本地磁盘，快速访问</li>
<li><strong>冷数据层</strong>：存储在对象存储，低成本存储</li>
</ol>
<p><strong>工作原理</strong>：</p>
<ol>
<li><strong>数据分层</strong>：根据时间或大小将数据分为热数据和冷数据</li>
<li><strong>自动迁移</strong>：热数据自动迁移到冷数据层</li>
<li><strong>透明访问</strong>：Consumer 可以透明访问冷数据，无需感知数据位置</li>
</ol>
<p><strong>优势</strong>：</p>
<ol>
<li><strong>存储成本低</strong>：对象存储成本远低于本地磁盘</li>
<li><strong>扩展性强</strong>：可以存储海量历史数据</li>
<li><strong>性能影响小</strong>：热数据仍然在本地，性能不受影响</li>
</ol>
<p><strong>配置示例</strong>：</p>
<pre><code class="hljs language-properties" lang="properties"># 启用 Tiered Storage
remote.log.storage.system.enable=true
remote.log.storage.system.class=org.apache.kafka.storage.internals.log.RemoteLogStorageManager

# 配置对象存储
remote.log.storage.manager.class.path=...
remote.log.storage.manager.impl.class.name=...
</code></pre>
<p><strong>适用场景</strong>：</p>
<ul>
<li><strong>长期数据保留</strong>：需要保留数月或数年的数据</li>
<li><strong>成本敏感</strong>：存储成本是主要考虑因素</li>
<li><strong>合规要求</strong>：需要长期保存数据以满足合规要求</li>
</ul>
<p><strong>实际案例</strong>：</p>
<p>某金融公司需要保留 3 年的交易数据：</p>
<ul>
<li><strong>问题现象</strong>：本地存储成本高，3 年数据需要 100TB 存储</li>
<li><strong>根本原因</strong>：所有数据存储在本地磁盘，成本高</li>
<li><strong>解决方案</strong>：使用 Tiered Storage，将 1 个月后的数据迁移到 S3，存储成本降低 80%</li>
</ul>
<h4 data-id="heading-62">RocketMQ 优化</h4>
<p>RocketMQ 的存储优化主要围绕文件预分配、堆外内存池、异步刷盘等方面展开。</p>
<h5 data-id="heading-63">文件预分配（MappedFile 预创建）</h5>
<p>RocketMQ 使用文件预分配机制，提前创建固定大小的文件，避免写入时的文件创建延迟。</p>
<p><strong>MappedFile 预分配机制</strong>：</p>
<ol>
<li><strong>预创建文件</strong>：启动时或文件写满时，提前创建下一个文件</li>
<li><strong>内存映射</strong>：使用 <code>mmap</code> 将文件映射到内存</li>
<li><strong>顺序写入</strong>：消息总是追加写入当前活跃文件</li>
</ol>
<p><strong>预分配的优势</strong>：</p>
<ol>
<li><strong>性能提升</strong>：避免写入时的文件创建延迟</li>
<li><strong>空间预分配</strong>：提前分配磁盘空间，避免碎片化</li>
<li><strong>内存映射</strong>：使用 mmap，读写性能高</li>
</ol>
<p><strong>预分配的配置</strong>：</p>
<ul>
<li><strong>mapedFileSizeCommitLog</strong>：CommitLog 文件大小（默认 1GB）</li>
<li><strong>mapedFileSizeConsumeQueue</strong>：ConsumeQueue 文件大小（默认 5.7MB）</li>
</ul>
<p><strong>最佳实践</strong>：</p>
<ul>
<li><strong>高吞吐场景</strong>：可以增加文件大小，减少文件切换次数</li>
<li><strong>低延迟场景</strong>：保持默认大小，平衡性能和延迟</li>
<li><strong>存储空间</strong>：根据磁盘空间合理设置文件大小</li>
</ul>
<p><strong>实际案例</strong>：</p>
<p>某 RocketMQ 集群在高并发场景下写入延迟增加：</p>
<ul>
<li><strong>问题现象</strong>：写入延迟从 1ms 增加到 5ms</li>
<li><strong>根本原因</strong>：文件切换时创建新文件产生延迟</li>
<li><strong>解决方案</strong>：启用文件预分配，提前创建下一个文件，延迟降低到 1ms</li>
</ul>
<h5 data-id="heading-64">TransientStorePool 堆外内存池</h5>
<p>TransientStorePool 是 RocketMQ 的堆外内存池机制，用于减少 GC 压力，提高写入性能。</p>
<p><strong>TransientStorePool 工作原理</strong>：</p>
<ol>
<li><strong>堆外内存分配</strong>：分配 DirectBuffer（堆外内存）</li>
<li><strong>消息写入</strong>：消息先写入堆外内存</li>
<li><strong>异步刷盘</strong>：后台线程将堆外内存刷写到磁盘</li>
</ol>
<p><strong>优势</strong>：</p>
<ol>
<li><strong>减少 GC 压力</strong>：堆外内存不受 GC 管理，减少 GC 频率</li>
<li><strong>提高写入性能</strong>：堆外内存写入速度快</li>
<li><strong>降低延迟</strong>：减少 GC 停顿时间，降低写入延迟</li>
</ol>
<p><strong>配置示例</strong>：</p>
<pre><code class="hljs language-properties" lang="properties"># 启用 TransientStorePool
transientStorePoolEnable=true
transientStorePoolSize=5
</code></pre>
<p><strong>配置说明</strong>：</p>
<ul>
<li><strong>transientStorePoolEnable</strong>：是否启用堆外内存池（默认 false）</li>
<li><strong>transientStorePoolSize</strong>：堆外内存池大小（默认 5，单位：GB）</li>
</ul>
<p><strong>最佳实践</strong>：</p>
<ul>
<li><strong>高吞吐场景</strong>：启用 TransientStorePool，提高写入性能</li>
<li><strong>低延迟场景</strong>：启用 TransientStorePool，减少 GC 停顿</li>
<li><strong>内存充足</strong>：如果内存充足，可以增加堆外内存池大小</li>
</ul>
<p><strong>实际案例</strong>：</p>
<p>某 RocketMQ 集群在高并发场景下 GC 频繁：</p>
<ul>
<li><strong>问题现象</strong>：GC 频率高，写入延迟波动大</li>
<li><strong>根本原因</strong>：消息写入堆内存，产生大量对象，GC 压力大</li>
<li><strong>解决方案</strong>：启用 TransientStorePool，GC 频率降低 70%，写入延迟稳定</li>
</ul>
<h5 data-id="heading-65">异步刷盘 + 主从复制平衡</h5>
<p>RocketMQ 提供了灵活的刷盘和复制配置，可以根据业务需求平衡性能和可靠性。</p>
<p><strong>配置组合</strong>：</p>








































<table><thead><tr><th>刷盘模式</th><th>复制模式</th><th>可靠性</th><th>性能</th><th>适用场景</th></tr></thead><tbody><tr><td>同步刷盘</td><td>同步复制</td><td>最高</td><td>最低</td><td>金融支付</td></tr><tr><td>同步刷盘</td><td>异步复制</td><td>较高</td><td>较低</td><td>订单系统</td></tr><tr><td>异步刷盘</td><td>同步复制</td><td>较高</td><td>中等</td><td>一般业务</td></tr><tr><td>异步刷盘</td><td>异步复制</td><td>较高</td><td>最高</td><td>日志收集</td></tr></tbody></table>
<p><strong>最佳实践</strong>：</p>
<ol>
<li><strong>金融支付场景</strong>：同步刷盘 + 同步复制，保证最高可靠性</li>
<li><strong>订单系统场景</strong>：同步刷盘 + 异步复制，平衡可靠性和性能</li>
<li><strong>日志收集场景</strong>：异步刷盘 + 异步复制，追求最高性能</li>
</ol>
<p><strong>配置优化</strong>：</p>
<ul>
<li><strong>flushCommitLogTimed</strong>：是否定时刷盘（默认 true）</li>
<li><strong>flushCommitLogInterval</strong>：定时刷盘间隔（默认 500ms）</li>
<li><strong>flushCommitLogLeastPages</strong>：最少刷盘页数（默认 4 页）</li>
</ul>
<p><strong>实际案例</strong>：</p>
<p>某订单系统使用 RocketMQ，需要平衡可靠性和性能：</p>
<ul>
<li><strong>初始配置</strong>：同步刷盘 + 同步复制，TPS 只有 5 万</li>
<li><strong>优化配置</strong>：同步刷盘 + 异步复制，TPS 提升到 30 万</li>
<li><strong>可靠性</strong>：仍然保证单机可靠性（同步刷盘），性能提升 6 倍</li>
</ul>
<h5 data-id="heading-66">过期文件清理策略</h5>
<p>RocketMQ 提供了灵活的过期文件清理策略，可以根据时间和大小清理过期数据。</p>
<p><strong>清理策略配置</strong>：</p>
<ul>
<li><strong>fileReservedTime</strong>：文件保留时间（默认 72 小时）</li>
<li><strong>deleteWhen</strong>：删除时间点（默认凌晨 4 点）</li>
<li><strong>diskMaxUsedSpaceRatio</strong>：磁盘最大使用率（默认 75%）</li>
</ul>
<p><strong>清理流程</strong>：</p>
<ol>
<li><strong>定时检查</strong>：每天凌晨 4 点检查过期文件</li>
<li><strong>删除 CommitLog</strong>：删除过期的 CommitLog 文件</li>
<li><strong>删除 ConsumeQueue</strong>：删除对应的 ConsumeQueue 文件</li>
<li><strong>删除 IndexFile</strong>：删除对应的 IndexFile 文件</li>
</ol>
<p><strong>清理策略优化</strong>：</p>
<ol>
<li><strong>合理设置保留时间</strong>：根据业务需求设置保留时间</li>
<li><strong>磁盘使用率监控</strong>：监控磁盘使用率，及时清理</li>
<li><strong>清理时间优化</strong>：选择业务低峰期清理，减少影响</li>
</ol>
<p><strong>实际案例</strong>：</p>
<p>某 RocketMQ 集群磁盘空间不足：</p>
<ul>
<li><strong>问题现象</strong>：磁盘使用率达到 90%，影响写入性能</li>
<li><strong>根本原因</strong>：文件保留时间设置过长（7 天），数据量大</li>
<li><strong>解决方案</strong>：将保留时间调整为 3 天，磁盘使用率降低到 60%</li>
</ul>
<h4 data-id="heading-67">对比总结</h4>
<p><strong>Kafka 优化重点</strong>：</p>
<ol>
<li><strong>Segment 管理</strong>：合理设置 Segment 大小，平衡文件数量和查询性能</li>
<li><strong>Log Compaction</strong>：使用 Compaction 减少存储空间</li>
<li><strong>Tiered Storage</strong>：使用分层存储降低存储成本</li>
</ol>
<p><strong>RocketMQ 优化重点</strong>：</p>
<ol>
<li><strong>文件预分配</strong>：提前创建文件，避免写入延迟</li>
<li><strong>堆外内存池</strong>：使用 TransientStorePool 减少 GC 压力</li>
<li><strong>刷盘复制平衡</strong>：根据业务需求选择合适的配置组合</li>
</ol>
<p><strong>优化建议</strong>：</p>
<ol>
<li><strong>性能优先</strong>：异步刷盘 + 异步复制，追求最高性能</li>
<li><strong>可靠性优先</strong>：同步刷盘 + 同步复制，保证最高可靠性</li>
<li><strong>平衡方案</strong>：同步刷盘 + 异步复制，平衡可靠性和性能</li>
</ol>
<hr/>
<h3 data-id="heading-68">1.6 实战案例</h3>
<p>本节将通过三个真实的生产案例，深入分析 Kafka 和 RocketMQ 在实际应用中的问题与解决方案，帮助读者更好地理解存储架构的设计与优化。</p>
<h4 data-id="heading-69">案例1：某电商系统 Kafka 文件句柄耗尽问题（500+ Topic）</h4>
<p><strong>背景</strong>：</p>
<p>某大型电商系统使用 Kafka 作为消息队列，有 500+ 个 Topic，每个 Topic 平均 4 个 Partition，消息保留 7 天。系统运行一段时间后，Kafka Broker 频繁重启。</p>
<p><strong>问题现象</strong>：</p>
<ol>
<li><strong>Broker 频繁重启</strong>：每隔几天 Broker 就会重启一次</li>
<li><strong>日志错误</strong>：日志中频繁出现 "Too many open files" 错误</li>
<li><strong>性能下降</strong>：重启后性能恢复正常，但一段时间后又出现问题</li>
</ol>
<p><strong>问题分析</strong>：</p>
<ol>
<li>
<p><strong>文件数量统计</strong>：</p>
<ul>
<li>Topic 数量：500+</li>
<li>Partition 数量：500 × 4 = 2000</li>
<li>Segment 数量：假设每天 1 个 Segment，7 天共 7 个</li>
<li>数据文件：2000 × 7 = 14000 个 .log 文件</li>
<li>索引文件：14000 × 2 = 28000 个索引文件（.index + .timeindex）</li>
<li><strong>总计：42000+ 个文件</strong></li>
</ul>
</li>
<li>
<p><strong>文件句柄占用</strong>：</p>
<ul>
<li>每个文件至少占用 1 个文件句柄</li>
<li>系统文件句柄限制：65535</li>
<li>实际占用：42000+，接近系统限制</li>
</ul>
</li>
<li>
<p><strong>根本原因</strong>：</p>
<ul>
<li>Kafka 的文件数量与 Topic 数量成正比</li>
<li>多 Topic 场景下，文件数量爆炸式增长</li>
<li>文件句柄数超过系统限制</li>
</ul>
</li>
</ol>
<p><strong>解决方案</strong>：</p>
<ol>
<li>
<p><strong>短期方案</strong>：</p>
<ul>
<li>增加系统文件句柄限制：<code>ulimit -n 1000000</code></li>
<li>修改系统配置：<code>/etc/security/limits.conf</code></li>
</ul>
</li>
<li>
<p><strong>中期方案</strong>：</p>
<ul>
<li>合并小 Topic：将相关的小 Topic 合并成大 Topic</li>
<li>减少 Partition 数量：将 Partition 数量从 4 减少到 2</li>
<li>优化 Segment 大小：将 Segment 大小从 1GB 增加到 5GB</li>
</ul>
</li>
<li>
<p><strong>长期方案</strong>：</p>
<ul>
<li>切换到 RocketMQ：RocketMQ 的文件数量远少于 Kafka</li>
<li>使用 Tiered Storage：将冷数据迁移到对象存储</li>
</ul>
</li>
</ol>
<p><strong>效果对比</strong>：</p>





























<table><thead><tr><th>方案</th><th>文件数量</th><th>文件句柄</th><th>性能影响</th></tr></thead><tbody><tr><td>增加文件句柄限制</td><td>42000+</td><td>1000000</td><td>无影响</td></tr><tr><td>合并 Topic</td><td>20000+</td><td>50000</td><td>轻微影响</td></tr><tr><td>切换到 RocketMQ</td><td>5000+</td><td>10000</td><td>无影响</td></tr></tbody></table>
<p><strong>经验总结</strong>：</p>
<ol>
<li><strong>多 Topic 场景</strong>：Kafka 的文件数量会爆炸式增长，需要提前规划</li>
<li><strong>文件句柄管理</strong>：需要监控文件句柄使用情况，及时调整</li>
<li><strong>架构选型</strong>：多 Topic 场景下，RocketMQ 的文件管理更有优势</li>
</ol>
<h4 data-id="heading-70">案例2：RocketMQ 消息堆积导致 ConsumeQueue 查询变慢</h4>
<p><strong>背景</strong>：</p>
<p>某金融系统使用 RocketMQ 作为消息队列，某个 Topic 消息堆积到千万级，Consumer 拉取消息时延迟明显增加。</p>
<p><strong>问题现象</strong>：</p>
<ol>
<li><strong>消费延迟增加</strong>：Consumer 拉取延迟从 1ms 增加到 10ms+</li>
<li><strong>查询变慢</strong>：ConsumeQueue 查询变慢，影响消息定位</li>
<li><strong>CPU 使用率高</strong>：Broker CPU 使用率达到 80%+</li>
</ol>
<p><strong>问题分析</strong>：</p>
<ol>
<li>
<p><strong>消息堆积情况</strong>：</p>
<ul>
<li>Topic：订单状态变更</li>
<li>消息数量：1000 万+</li>
<li>堆积时间：3 天</li>
<li>ConsumeQueue 文件数量：100+ 个</li>
</ul>
</li>
<li>
<p><strong>ConsumeQueue 查询流程</strong>：</p>
<ul>
<li>Consumer 拉取消息时，需要查询 ConsumeQueue</li>
<li>消息堆积后，ConsumeQueue 文件数量增加</li>
<li>查询时需要遍历多个文件，性能下降</li>
</ul>
</li>
<li>
<p><strong>根本原因</strong>：</p>
<ul>
<li>ConsumeQueue 文件数量过多，查询时需要遍历多个文件</li>
<li>文件未完全加载到内存，需要频繁磁盘 IO</li>
<li>消息堆积导致 ConsumeQueue 索引变大，查询变慢</li>
</ul>
</li>
</ol>
<p><strong>解决方案</strong>：</p>
<ol>
<li>
<p><strong>短期方案</strong>：</p>
<ul>
<li>增加 Consumer 实例：提高消费速度，减少堆积</li>
<li>优化消费逻辑：提高消费处理速度</li>
</ul>
</li>
<li>
<p><strong>中期方案</strong>：</p>
<ul>
<li>预热 ConsumeQueue：启动时预热 ConsumeQueue，加载到内存</li>
<li>优化查询逻辑：批量查询，减少 IO 次数</li>
</ul>
</li>
<li>
<p><strong>长期方案</strong>：</p>
<ul>
<li>消息清理：清理过期消息，减少 ConsumeQueue 文件数量</li>
<li>扩容 Consumer：增加 Consumer 实例，提高消费能力</li>
</ul>
</li>
</ol>
<p><strong>效果对比</strong>：</p>





























<table><thead><tr><th>方案</th><th>查询延迟</th><th>CPU 使用率</th><th>消费速度</th></tr></thead><tbody><tr><td>增加 Consumer</td><td>5ms</td><td>60%</td><td>提升 2 倍</td></tr><tr><td>预热 ConsumeQueue</td><td>2ms</td><td>50%</td><td>无变化</td></tr><tr><td>消息清理</td><td>1ms</td><td>40%</td><td>无变化</td></tr></tbody></table>
<p><strong>经验总结</strong>：</p>
<ol>
<li><strong>消息堆积</strong>：需要及时处理，避免堆积过多影响性能</li>
<li><strong>ConsumeQueue 优化</strong>：可以预热加载到内存，提高查询速度</li>
<li><strong>消费能力</strong>：需要根据消息量合理配置 Consumer 数量</li>
</ol>
<h4 data-id="heading-71">案例3：存储架构选型：什么场景选 Kafka？什么场景选 RocketMQ？</h4>
<p><strong>背景</strong>：</p>
<p>某互联网公司需要选择消息队列，在 Kafka 和 RocketMQ 之间犹豫不决。公司有多种业务场景，需要综合考虑。</p>
<p><strong>业务场景分析</strong>：</p>
<ol>
<li>
<p><strong>日志收集场景</strong>：</p>
<ul>
<li>特点：高吞吐、低延迟、多 Topic</li>
<li>需求：日志收集、流式处理</li>
<li><strong>推荐：Kafka</strong></li>
<li><strong>理由</strong>：
<ul>
<li>Kafka 专为日志流设计，性能高</li>
<li>与流处理框架（Flink、Spark）深度集成</li>
<li>支持 Tiered Storage，存储成本低</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>订单系统场景</strong>：</p>
<ul>
<li>特点：高可靠性、事务消息、消息重试</li>
<li>需求：订单状态变更、支付通知</li>
<li><strong>推荐：RocketMQ</strong></li>
<li><strong>理由</strong>：
<ul>
<li>RocketMQ 支持事务消息，保证最终一致性</li>
<li>支持消息重试和死信队列</li>
<li>多 Topic 场景下文件管理更优</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>实时数据管道场景</strong>：</p>
<ul>
<li>特点：高吞吐、流式处理、大数据集成</li>
<li>需求：实时数据同步、数据管道</li>
<li><strong>推荐：Kafka</strong></li>
<li><strong>理由</strong>：
<ul>
<li>Kafka Streams 提供流处理能力</li>
<li>Kafka Connect 提供数据集成能力</li>
<li>与大数据生态深度集成</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>微服务异步通信场景</strong>：</p>
<ul>
<li>特点：多 Topic、消息过滤、延迟消息</li>
<li>需求：服务间异步通信、事件驱动</li>
<li><strong>推荐：RocketMQ</strong></li>
<li><strong>理由</strong>：
<ul>
<li>支持 Tag 过滤和 SQL92 过滤</li>
<li>支持延迟消息，满足业务需求</li>
<li>多 Topic 场景下性能更优</li>
</ul>
</li>
</ul>
</li>
</ol>
<p><strong>选型决策矩阵</strong>：</p>





















































<table><thead><tr><th>场景</th><th>Kafka</th><th>RocketMQ</th><th>推荐</th></tr></thead><tbody><tr><td>日志收集</td><td>✅</td><td>❌</td><td>Kafka</td></tr><tr><td>订单系统</td><td>❌</td><td>✅</td><td>RocketMQ</td></tr><tr><td>实时数据管道</td><td>✅</td><td>❌</td><td>Kafka</td></tr><tr><td>微服务通信</td><td>⚠️</td><td>✅</td><td>RocketMQ</td></tr><tr><td>多 Topic 场景</td><td>⚠️</td><td>✅</td><td>RocketMQ</td></tr><tr><td>事务消息</td><td>❌</td><td>✅</td><td>RocketMQ</td></tr><tr><td>流式处理</td><td>✅</td><td>⚠️</td><td>Kafka</td></tr></tbody></table>
<p><strong>最终决策</strong>：</p>
<ol>
<li><strong>日志收集</strong>：使用 Kafka，利用其高吞吐和流处理能力</li>
<li><strong>订单系统</strong>：使用 RocketMQ，利用其事务消息和可靠性</li>
<li><strong>实时数据管道</strong>：使用 Kafka，利用其流处理和大数据集成能力</li>
<li><strong>微服务通信</strong>：使用 RocketMQ，利用其消息过滤和延迟消息能力</li>
</ol>
<p><strong>混合使用方案</strong>：</p>
<ul>
<li><strong>Kafka</strong>：用于日志收集和实时数据管道</li>
<li><strong>RocketMQ</strong>：用于订单系统和微服务通信</li>
<li><strong>统一治理</strong>：使用统一的消息治理平台管理两种消息队列</li>
</ul>
<p><strong>经验总结</strong>：</p>
<ol>
<li><strong>场景驱动</strong>：根据业务场景选择合适的技术，不要一刀切</li>
<li><strong>混合使用</strong>：可以同时使用 Kafka 和 RocketMQ，发挥各自优势</li>
<li><strong>统一治理</strong>：使用统一平台管理多种消息队列，降低运维成本</li>
</ol>
<hr/>
<h3 data-id="heading-72">总结</h3>
<p>本文从存储模型设计理念、文件结构与布局、消息存储流程、消息读取流程、存储层优化技巧和实战案例等多个维度，深入对比了 Kafka 和 RocketMQ 的存储架构。</p>
<p><strong>核心对比总结</strong>：</p>
<ol>
<li>
<p><strong>存储模型</strong>：</p>
<ul>
<li>Kafka：分区日志模型，适合日志流场景</li>
<li>RocketMQ：中心化 CommitLog + 分布式索引，适合业务消息场景</li>
</ul>
</li>
<li>
<p><strong>文件管理</strong>：</p>
<ul>
<li>Kafka：多文件，文件数量与 Topic 数量成正比</li>
<li>RocketMQ：中心化文件，文件数量远少于 Kafka</li>
</ul>
</li>
<li>
<p><strong>读写性能</strong>：</p>
<ul>
<li>Kafka：直接读写，性能高，无读放大</li>
<li>RocketMQ：两阶段读取，存在读放大，但通过优化性能仍然很高</li>
</ul>
</li>
<li>
<p><strong>可靠性</strong>：</p>
<ul>
<li>Kafka：通过副本机制保证可靠性</li>
<li>RocketMQ：通过刷盘和复制机制保证可靠性</li>
</ul>
</li>
<li>
<p><strong>适用场景</strong>：</p>
<ul>
<li>Kafka：日志收集、流式处理、实时数据管道</li>
<li>RocketMQ：订单系统、微服务通信、事务消息</li>
</ul>
</li>
</ol>
<p><strong>选型建议</strong>：</p>
<ul>
<li><strong>日志流场景</strong>：选择 Kafka</li>
<li><strong>业务消息场景</strong>：选择 RocketMQ</li>
<li><strong>混合场景</strong>：可以同时使用两种消息队列</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[跟 Blades 学 Agent 设计 - 01 用“提示词链”让你的 AI 助手变身超级特工]]></title>    <link>https://juejin.cn/post/7569977160275574827</link>    <guid>https://juejin.cn/post/7569977160275574827</guid>    <pubDate>2025-11-09T08:54:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7569977160275574827" data-draft-id="7569898158836482089" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="跟 Blades 学 Agent 设计 - 01 用“提示词链”让你的 AI 助手变身超级特工"/> <meta itemprop="keywords" content="Agent,LLM,Go"/> <meta itemprop="datePublished" content="2025-11-09T08:54:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Kratos开源社区"/> <meta itemprop="url" content="https://juejin.cn/user/26044009549918"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            跟 Blades 学 Agent 设计 - 01 用“提示词链”让你的 AI 助手变身超级特工
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/26044009549918/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Kratos开源社区
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-09T08:54:02.000Z" title="Sun Nov 09 2025 08:54:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>你是否曾感觉与 AI 沟通像“对牛弹琴”？你给它一个复杂的任务，期望它能一步到位，结果却常常是丢三落四、逻辑混乱，甚至一本正经地胡说八道。</p>
<p>问题出在哪里？也许不是 AI 不够聪明，而是我们与它沟通的方式需要升级。今天，我们就来介绍一个强大的技术——<strong>提示词链（Prompt Chaining）</strong>，它能将你的 AI 助手从一个偶尔犯傻的聊天机器人，调教成一个逻辑清晰、使命必达的超级特工。</p>
<h2 data-id="heading-0">什么是提示词链？别让 AI 一次想太多</h2>
<p>想象一下，你要组织一场复杂的市场活动。你不会对一个新员工说：“去，把活动搞定。”而是会把任务拆解：</p>
<ol>
<li><strong>第一步：</strong> “先去调研一下最近的市场趋势，给我一份总结报告。”</li>
<li><strong>第二步：</strong> “根据这份报告，找出三个最值得关注的趋势，并列出支持数据。”</li>
<li><strong>第三步：</strong> “用这些趋势和数据，给营销团队写一封邮件，说明我们的活动方向。”</li>
</ol>
<p>“提示词链”就是这个道理。它的核心思想是：<strong>化繁为简，分而治之</strong>。</p>
<p>我们不再用一个冗长复杂的提示词（Prompt）去“轰炸”AI，而是将一个大任务分解成一系列更小、更聚焦的子任务。上一个子任务的输出，会像接力棒一样，精准地传递给下一个子任务作为输入。</p>
<pre><code class="hljs language-text" lang="text"> [原始市场报告] -&gt; [提示词1: 总结] -&gt; [报告摘要] -&gt; [提示词2: 提取趋势] -&gt; [结构化JSON数据] -&gt; [提示词3: 起草邮件] -&gt; [最终邮件初稿]
</code></pre>
<p>这个过程就像一条精密的流水线，每一步都只做一个简单明确的操作，最终组合起来，就能高效、可靠地完成复杂工作。</p>
<h2 data-id="heading-1">为什么“链式思考”比“一锅端”更有效？</h2>
<p>使用单一、庞大的提示词，AI 很容易“认知过载”，导致：</p>
<ul>
<li><strong>指令遗忘</strong>：任务要求太多，AI 顾头不顾尾。</li>
<li><strong>上下文漂移</strong>：聊着聊着，AI 就忘了最初的目标是什么。</li>
<li><strong>错误传播</strong>：一个环节的小错误在后续被无限放大。</li>
<li><strong>胡说八道（幻觉）</strong>：信息处理负担太重，AI 开始自由发挥。</li>
</ul>
<p>而提示词链通过“流水线作业”，完美地解决了这些问题：</p>
<ul>
<li><strong>高可靠性</strong>：每一步都简单专注，大大提高了单步的准确率。</li>
<li><strong>强可控性</strong>：你可以清晰地看到每一步的结果，方便调试和优化。</li>
<li><strong>可解释性</strong>：如果结果出错，你能快速定位是哪一个环节出了问题。</li>
</ul>
<h2 data-id="heading-2">关键一步：用“结构化数据”打造标准化的“集装箱”</h2>
<p>为了让流水线上的信息传递不出错，我们需要一个标准化的“集装箱”。如果上一步的输出是一段模糊的自然语言，下一步的 AI 可能就无法准确理解。</p>
<p>因此，在关键步骤之间，强制 AI 使用 <strong>JSON</strong> 或 <strong>XML</strong> 这样的结构化格式来输出结果，就显得至关重要。</p>
<p>例如，在识别市场趋势的环节，我们可以要求 AI 这样输出：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"trends"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"trend_name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"AI驱动的个性化营销"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"supporting_data"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"73%的消费者更愿意与使用其个人信息来提升购物体验的品牌打交道。"</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"trend_name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"可持续和道德品牌"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"supporting_data"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"过去五年，有ESG（环境、社会和治理）声明的产品销售额增长了28%。"</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>这种机器可读的数据格式，确保了信息在链条中传递时，<strong>精确、无歧义</strong>，为整个任务的成功奠定了坚实基础。</p>
<h2 data-id="heading-3">提示词链的几种核心方法</h2>
<p>提示词链的应用场景非常广泛，它是构建高级 AI Agent（智能代理）的基石。以下是几种经过验证的、非常有效的方法：</p>
<h3 data-id="heading-4">方法一：信息处理工作流</h3>
<p>许多任务涉及对原始信息进行多次转换。提示词链可以完美地自动化这个过程。</p>
<ul>
<li><strong>场景</strong>：构建一个 AI 研究助手，自动分析报告。</li>
<li><strong>链条</strong>：
<ol>
<li><strong>提示词 1 (提取)</strong>：从给定的 URL 或文档中提取纯文本内容。</li>
<li><strong>提示词 2 (总结)</strong>：对提取的文本进行总结，提炼核心观点。</li>
<li><strong>提示词 3 (实体识别)</strong>：从摘要或原文中，提取出关键实体（如人名、公司名、日期）。</li>
<li><strong>提示词 4 (信息检索)</strong>：使用提取出的实体，去内部知识库或数据库中进行查询。</li>
<li><strong>提示词 5 (报告生成)</strong>：将总结、实体和检索结果整合，生成一份结构化的最终报告。</li>
</ol>
</li>
</ul>
<h3 data-id="heading-5">方法二：复杂问答系统</h3>
<p>对于那些无法一次性回答、需要多步推理的复杂问题，提示词链是理想的解决方案。</p>
<ul>
<li><strong>场景</strong>：回答历史问题：“1929年股市崩盘的主要原因是什么？当时的政府政策是如何应对的？”</li>
<li><strong>链条</strong>：
<ol>
<li><strong>提示词 1 (问题分解)</strong>：识别用户查询中的核心子问题（“崩盘原因”和“政府应对”）。</li>
<li><strong>提示词 2 (专题研究)</strong>：专门检索和整理关于“1929年崩盘原因”的信息。</li>
<li><strong>提示词 3 (专题研究)</strong>：专门检索和整理关于“政府对崩盘的政策响应”的信息。</li>
<li><strong>提示词 4 (答案综合)</strong>：将前两步的信息整合成一个逻辑连贯、全面的答案。</li>
</ol>
</li>
</ul>
<h3 data-id="heading-6">方法三：数据提取与转换（迭代式）</h3>
<p>将非结构化文本（如发票、简历）转换为结构化数据时，往往需要反复验证和修正。</p>
<ul>
<li><strong>场景</strong>：从一张发票图片中提取信息。</li>
<li><strong>链条</strong>：
<ol>
<li><strong>提示词 1 (初次提取)</strong>：尝试从发票文本中提取所有字段（如公司名、金额、日期）。</li>
<li><strong>处理与验证</strong>：程序检查提取的字段是否齐全、格式是否正确（例如，日期格式、金额是否为数字）。</li>
<li><strong>提示词 2 (条件性触发)</strong>：如果发现有字段缺失或格式错误，则生成一个新的、目标更明确的提示词，要求 AI “专门去寻找缺失的xx字段”或“请将日期修正为YYYY-MM-DD格式”，并把上次失败的尝试作为上下文提供给它。</li>
<li><strong>循环与输出</strong>：如有必要，重复步骤2和3，直到所有数据都得到验证，最后输出干净的结构化数据。</li>
</ol>
</li>
</ul>
<h3 data-id="heading-7">方法四：内容与代码生成工作流</h3>
<p>无论是写文章还是写代码，创作过程本身就是程序性的，可以分解为构思、起草和修订等阶段。</p>
<ul>
<li><strong>场景</strong>：让 AI 辅助你写一个功能模块。</li>
<li><strong>链条</strong>：
<ol>
<li><strong>提示词 1 (理解与规划)</strong>：理解用户的需求，并生成伪代码或实现大纲。</li>
<li><strong>提示词 2 (草稿编写)</strong>：根据大纲，编写出功能的初始代码草稿。</li>
<li><strong>提示词 3 (分析与测试)</strong>：识别代码中的潜在错误或改进点（可以调用另一个LLM，或集成静态分析工具）。</li>
<li><strong>提示词 4 (重构与完善)</strong>：根据发现的问题，重写或优化代码。</li>
<li><strong>提示词 5 (文档生成)</strong>：为最终的代码添加注释或生成使用文档。</li>
</ol>
</li>
</ul>
<p>通过这些方法，我们可以看到，提示词链不仅是一种技术，更是一种将复杂问题模块化、流程化的思维方式，它能极大地提升我们利用 AI 解决实际问题的稳定性和效率。</p>
<h2 data-id="heading-8">来一段简单的示例代码，看看 Bla</h2>
<p>下面是一个使用 Blades Agent 框架实现提示词链的示例: 实现了一个多步骤的故事生成器，它会根据用户输入的主题，生成一个故事大纲，检查大纲质量，然后基于大纲写一个简短的故事。</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"context"</span>
    <span class="hljs-string">"log"</span>

    <span class="hljs-string">"github.com/go-kratos/blades"</span>
    <span class="hljs-string">"github.com/go-kratos/blades/contrib/openai"</span>
    <span class="hljs-string">"github.com/go-kratos/blades/flow"</span>
)

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    provider := openai.NewChatProvider()
    storyOutline := blades.NewAgent(
        <span class="hljs-string">"story_outline_agent"</span>,
        blades.WithModel(<span class="hljs-string">"qwen-plus"</span>),
        blades.WithProvider(provider),
        blades.WithInstructions(<span class="hljs-string">"Generate a very short story outline based on the user's input."</span>),
    )
    storyChecker := blades.NewAgent(
        <span class="hljs-string">"outline_checker_agent"</span>,
        blades.WithModel(<span class="hljs-string">"qwen-plus"</span>),
        blades.WithProvider(provider),
        blades.WithInstructions(<span class="hljs-string">"Read the given story outline, and judge the quality. Also, determine if it is a scifi story."</span>),
    )
    storyAgent := blades.NewAgent(
        <span class="hljs-string">"story_agent"</span>,
        blades.WithModel(<span class="hljs-string">"qwen-plus"</span>),
        blades.WithProvider(provider),
        blades.WithInstructions(<span class="hljs-string">"Write a short story based on the given outline."</span>),
    )
    seq := flow.NewSequential(<span class="hljs-string">"story"</span>, <span class="hljs-literal">true</span>, storyOutline, storyChecker, storyAgent)
    <span class="hljs-comment">// Input prompt</span>
    prompt := blades.NewPrompt(
        blades.UserMessage(<span class="hljs-string">"A brave knight embarks on a quest to find a hidden treasure."</span>),
    )
    result, err := seq.Run(context.Background(), prompt)
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        log.Fatal(err)
    }
    log.Println(result.Text())
}
</code></pre>
<p>代码见：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fgo-kratos%2Fblades%2Ftree%2Ffix%2Fsequential%2Fexamples%2Fsequential" target="_blank" title="https://github.com/go-kratos/blades/tree/fix/sequential/examples/sequential" ref="nofollow noopener noreferrer">github.com/go-kratos/b…</a></p>
<pre><code class="hljs language-shell" lang="shell">2025/10/20 22:45:13 **Title: *The Last Spark of the Dying Star***

Long ago, when the world still remembered the names of winds and rivers spoke in riddles, there was a land called Eltharion—once green and singing, now silent beneath ashen skies. Crops withered in the fields, children’s laughter grew scarce, and even the birds had forgotten their songs. The elders whispered that the heart of the world had stilled, that the great Sky-Tree no longer drew light from the stars.

And so, they sent for Sir Alden.

Not because he was the strongest or swiftest knight—those days were behind him. His armor bore dents like old scars, and his cloak smelled faintly of rain and regret. But it was said that Alden had once turned back the Shadowfen Maw not with sword, but with silence. That he wept at funerals of strangers. That he carried no pride, only purpose.

He came not on a steed, but on foot, staff in hand, eyes weary but unbroken.

“The beacon must be reignited,” said the village elder, pointing to the peak of Mount Virelune, where the ancient spire stood—a needle of black stone piercing the clouds. “Only the last spark of the dying star can do it. It rests beyond the Veil Woods, guarded by trials older than memory.”

Alden bowed. Not out of duty. Out of hope.

...
</code></pre>
<h2 data-id="heading-9">更进一步：从“提示工程”到“上下文工程”</h2>
<p>如果说提示词链是战术，那么 <strong>上下文工程（Context Engineering）</strong> 就是战略。</p>
<p>它认为，AI 输出的质量，不仅取决于你“问了什么”，更取决于你为它提供了多么丰富的“信息环境”（上下文）。这包括：</p>
<ul>
<li><strong>系统指令</strong>：为 AI 设定一个明确的角色，如“你是一位资深的技术作家”。</li>
<li><strong>外部文档</strong>：让 AI 可以主动检索知识库来获取信息。</li>
<li><strong>工具输出</strong>：允许 AI 调用外部 API（如日历、计算器）来获取实时数据。</li>
<li><strong>隐式数据</strong>：用户的身份、历史交互记录等。</li>
</ul>
<p>简单来说，上下文工程就是为 AI 打造一个全面的“作战指挥室”，让它在充分了解背景信息的情况下做出决策。这才是将 AI 从一个聊天工具，提升为能够感知上下文、具备高度能力的智能 Agent 的关键。</p>
<h2 data-id="heading-10">总结</h2>
<p>当你需要 AI 完成一个复杂任务时，请记住：</p>
<ol>
<li><strong>拆解任务</strong>：像项目经理一样，把大任务分解成一系列逻辑清晰的子任务。</li>
<li><strong>链式执行</strong>：用提示词链的方式，引导 AI 一步步完成。</li>
<li><strong>结构化传递</strong>：在关键节点，要求 AI 使用 JSON 等格式，确保信息准确。</li>
</ol>
<p>掌握提示词链，你就能更高效地驾驭 AI。这不仅是一种技巧，更是一种与未来智能体协作的思维方式。现在就动手试试，开启你与 AI 沟通的新篇章吧！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[别卷 LangChain 了！Blades AI 框架让 Go 开发者轻松打造智能体]]></title>    <link>https://juejin.cn/post/7569977160275558443</link>    <guid>https://juejin.cn/post/7569977160275558443</guid>    <pubDate>2025-11-09T08:51:01.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7569977160275558443" data-draft-id="7569898158836465705" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" 别卷 LangChain 了！Blades AI 框架让 Go 开发者轻松打造智能体"/> <meta itemprop="keywords" content="Go,AI编程,Agent"/> <meta itemprop="datePublished" content="2025-11-09T08:51:01.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Kratos开源社区"/> <meta itemprop="url" content="https://juejin.cn/user/26044009549918"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             别卷 LangChain 了！Blades AI 框架让 Go 开发者轻松打造智能体
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/26044009549918/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Kratos开源社区
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-09T08:51:01.000Z" title="Sun Nov 09 2025 08:51:01 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>名字来源于：《战神》游戏以希腊神话为背景，讲述奎托斯（Kratos）由凡人成为战神并展开弑神屠杀的冒险经历，Blades 是奎托斯的标志性武器。</p>
</blockquote>
<p>在人工智能浪潮席卷全球的今天，大型语言模型（LLM）正在重塑软件开发的边界。然而，对于广大的 Go 开发者而言，一个普遍的痛点是：主流的 LLM 应用框架（如 LangChain）大多基于 Python，这使得在以 Go
为主要技术栈的团队中开发 Agent 应用变得不那么“原生”和高效。</p>
<p>为了解决这个挑战，今天我带着我的新作品来了，它就是 <strong>Blades</strong> ! Blades 是一个专为 Go 语言设计的、用于构建 AI Agent 应用的现代化框架。目处于初期阶段，当前已支持自定义模型、工具、记忆体、中间件等功能，适用于多轮对话、链式推理和结构化输出等场景。它保持着 Kratos 一贯的设计美学，结合 Go 语言的特性，提供了灵活且高效的 AI Agent 解决方案。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6fb48dea49e54be68ca1ebbc600388cb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgS3JhdG9z5byA5rqQ56S-5Yy6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763283061&amp;x-signature=QLYr4pQ6xUy1yWxbzJucfBfD1OI%3D" alt="" loading="lazy"/></p>
<ul>
<li>Go Idiomatic：完全依照 Go 的思维方式构建，代码风格、使用体验都让 Go 开发者感到亲切。</li>
<li>使用简单：通过简洁的代码生命，定义 AI Agent，实现需求快速交付，让复杂的逻辑变得清晰、易于管理和维护。</li>
<li>中间件生态：借鉴 Kratos 的中间件设计理念，无论是 Observability、Guardrails，都可以方便的集成到 AI Agent。</li>
<li>高度可扩展：通过统一的接口和可插拔的组件，实现高度的解耦和可扩展性，方便集成不同的 LLM 模型和外部工具。</li>
</ul>
<h2 data-id="heading-0">架构</h2>
<p>当前 Blades 主要由以下模块组成：</p>
<ul>
<li>Agent (智能体)：执行任务的核心单元，可以调用模型和工具。</li>
<li>Prompt (提示词)：用于与 LLM 交互的模板化文本，支持动态变量替换和复杂的上下文构建。</li>
<li>Chain (链)：将多个 Agent 或其他 Chain 串联起来，形成复杂的工作流。</li>
<li>ModelProvider (模型)：可插拔的 LLM 接口，您可以轻松切换和集成不同的语言模型服务（如 OpenAI 等）。</li>
<li>Tool (工具)：Agent 可以使用的外部能力，例如调用 API、查询数据库、访问文件系统等。</li>
<li>Memory (记忆)：为 Agent 提供短期或长期的记忆能力，实现具备上下文的连续对话。</li>
<li>Middleware (中间件)：类似于 Web 框架中的中间件，可以实现对 Agent 的横切面控制。</li>
</ul>
<h3 data-id="heading-1">核心接口</h3>
<p>其中 <code>Runner</code> 是 Blades 框架中最核心的接口，它定义了所有可执行组件的基本行为。</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// Runner represents an entity that can process prompts and generate responses.</span>
<span class="hljs-keyword">type</span> Runner <span class="hljs-keyword">interface</span> {
    <span class="hljs-comment">// Run 执行一个同步的、非流式的操作，返回一个完整的 Generation 结果。</span>
    Run(context.Context, *Prompt, ...ModelOption) (*Generation, <span class="hljs-type">error</span>)
    <span class="hljs-comment">// RunStream 执行一个异步的、流式的操作，返回一个 Streamer，用于逐步接收 Generation 结果。</span>
    RunStream(context.Context, *Prompt, ...ModelOption) (Streamer[*Generation], <span class="hljs-type">error</span>)
}
</code></pre>
<p>其设计旨在提供一个统一的执行范式，通过 <code>Run</code> 和 <code>RunStream</code> 方法，实现了框架内各种功能模块的<strong>解耦、标准化和高度可组合性</strong>。<code>Agent</code>、<code>Chain</code>、<code>ModelProvider</code> 等组件都实现了此接口，从而统一了它们的执行逻辑，使得不同组件能够像乐高积木一样灵活组合，构建复杂的 AI Agent。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d25c794da6f843a8a51988a9cd21db45~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgS3JhdG9z5byA5rqQ56S-5Yy6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763283061&amp;x-signature=DVk0BOmR04yegsA5lJLTFAcsKrk%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-2">ModelProvider</h3>
<p><code>ModelProvider</code> 是 <code>Blades</code> 框架与底层大语言模型（LLM）进行交互的核心抽象层。其设计目标在于通过统一的接口实现<strong>解耦和扩展性</strong>，使得框架核心逻辑与特定模型（如 OpenAI, DeepSeek, Gemini 等）的实现细节分离。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/841dc65375c042bb9b4aefba627ef387~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgS3JhdG9z5byA5rqQ56S-5Yy6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763283061&amp;x-signature=RW1hTDwGJX7lqI5w%2FZNUQt0vq0Q%3D" alt="" loading="lazy"/></p>
<p>其他模块设计，不再一一赘述，可以阅读代码，了解细节。</p>
<h2 data-id="heading-3">动手做一个电影推荐 Agent</h2>
<p>下面我们通过一个简单的例子，来展示如何使用 Blades 构建一个电影推荐 Agent。这个 Agent 会推荐一个中国明星，并列出他/她主演过的电影。</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"context"</span>
    <span class="hljs-string">"log"</span>

    <span class="hljs-string">"github.com/go-kratos/blades"</span>
    <span class="hljs-string">"github.com/go-kratos/blades/contrib/openai"</span>
)

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    agent := blades.NewAgent(
        <span class="hljs-string">"Template Agent"</span>,
        blades.WithModel(<span class="hljs-string">"qwen-plus"</span>),
        blades.WithProvider(openai.NewChatProvider()),
    )

    <span class="hljs-comment">// Define templates and params</span>
    params := <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]any{
        <span class="hljs-string">"actor"</span>:  <span class="hljs-string">"成龙"</span>,
        <span class="hljs-string">"movies"</span>: <span class="hljs-string">"10"</span>,
    }

    <span class="hljs-comment">// Build prompt using the template builder</span>
    <span class="hljs-comment">// Note: Use exported methods when calling from another package.</span>
    prompt, err := blades.NewPromptTemplate().
        System(<span class="hljs-string">"你是一个电影电视剧推荐大师，根据用户信息进行推荐 {{.movies}} 作品。"</span>, params).
        User(<span class="hljs-string">"请为我推荐 {{.actor}} 的电影，请按照“标题（年份）、类型/风格 、推荐理由”的格式输出。"</span>, params).
        Build()
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        log.Fatal(err)
    }

    log.Println(<span class="hljs-string">"Generated Prompt:"</span>, prompt.String())

    <span class="hljs-comment">// Run the agent with the templated prompt</span>
    result, err := agent.Run(context.Background(), prompt)
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        log.Fatal(err)
    }
    log.Println(result.AsText())
}


</code></pre>
<p>执行程序后，你会得到类似如下的输出：</p>
<pre><code class="hljs language-shell" lang="shell">2025/09/25 22:12:34 Generated Prompt: [Text: 你是一个电影电视剧推荐大师，根据用户信息进行推荐 10 作品。)][Text: 请为我推荐 成龙 的电影，请按照“标题（年份）、类型/风格 、推荐理由”的格式输出。)]
2025/09/25 22:12:34 Processing message: system [{你是一个电影电视剧推荐大师，根据用户信息进行推荐 10 作品。}]
2025/09/25 22:12:34 Processing message: user [{请为我推荐 成龙 的电影，请按照“标题（年份）、类型/风格 、推荐理由”的格式输出。}]
2025/09/25 22:13:00 当然可以！以下是10部成龙的经典电影推荐，涵盖动作、喜剧、冒险等多种风格，展现他独特的“功夫喜剧”魅力与特技表演：

1. **《警察故事》（1985）**  
   - 类型/风格：警匪 / 动作 / 犯罪  
   - 推荐理由：被誉为成龙最具代表性的作品之一，高难度实拍动作场面震撼影史，商场追击戏成为经典，充分展现其拼命三郎的敬业精神。

2. **《A计划》（1983）**  
   - 类型/风格：动作 / 喜剧 / 冒险  
   - 推荐理由：融合维多利亚时代背景与惊险钟楼跳伞戏，动作设计极具创意，幽默与紧张并存，是早期动作喜剧的巅峰之作。
....

</code></pre>
<h2 data-id="heading-4">说在最后</h2>
<p>邀请所有 Go 开发者和 AI 爱好者访问我们的 GitHub 仓库，亲自体验 Blades 带来的开发乐趣。</p>
<ul>
<li>GitHub 仓库: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fgo-kratos%2Fblades" target="_blank" title="https://github.com/go-kratos/blades" ref="nofollow noopener noreferrer">github.com/go-kratos/b…</a></li>
</ul>
<p>给项目一个 ⭐️ Star，探索 examples 目录下的更多用法，或者直接上手构建您的第一个 Go LLM 应用吧！</p>
<p><strong>项目当前处于初期阶段，持续迭代中，期待反馈、建议和贡献</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Python实战：用高德地图API批量获取地址所属街道并写回Excel]]></title>    <link>https://juejin.cn/post/7569825640851619875</link>    <guid>https://juejin.cn/post/7569825640851619875</guid>    <pubDate>2025-11-07T16:17:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7569825640851619875" data-draft-id="7569796512114999336" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Python实战：用高德地图API批量获取地址所属街道并写回Excel"/> <meta itemprop="keywords" content="后端,Python,IPython"/> <meta itemprop="datePublished" content="2025-11-07T16:17:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员爱钓鱼"/> <meta itemprop="url" content="https://juejin.cn/user/2799775299157614"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Python实战：用高德地图API批量获取地址所属街道并写回Excel
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2799775299157614/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员爱钓鱼
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-07T16:17:11.000Z" title="Fri Nov 07 2025 16:17:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-07
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>在日常的数据处理工作中，我们经常需要根据公司、事件或门店的<strong>注册地址</strong>，批量获取其所在的<strong>街道信息</strong>，例如“浦东新区张江镇”“徐汇区龙华街道”等。
手动查询显然低效，而借助 <strong>Python + 高德地图API</strong>，我们可以轻松实现自动化批量查询并将结果写入 Excel 文件中。</p>
</blockquote>
<p>本文将完整展示一个<strong>从 Excel 读取地址 → 调用高德API → 获取街道 → 写回Excel</strong>的实用脚本，并讲解实现细节与优化思路。</p>
<hr/>
<h2 data-id="heading-0">一、功能概述</h2>
<p>这段脚本的功能可以总结为四步：</p>
<ol>
<li>从 Excel 文件中读取地址数据；</li>
<li>调用高德地图地理编码（geocode）与逆地理编码（regeo）接口获取街道名称；</li>
<li>自动将查询结果写回到 Excel 的新列中；</li>
<li>对查询失败的地址进行<strong>重试与记录</strong>，保证数据尽量完整。</li>
</ol>
<hr/>
<h2 data-id="heading-1">二、项目依赖与准备工作</h2>
<p>在开始之前，请确保安装以下依赖：</p>
<pre><code class="hljs language-bash" lang="bash">pip install pandas openpyxl requests
</code></pre>
<p>并在高德开放平台申请一个 API Key，申请地址为：
👉 <a href="https://link.juejin.cn?target=https%3A%2F%2Flbs.amap.com%2Fapi%2Fwebservice%2Fguide%2Fcreate-project" target="_blank" title="https://lbs.amap.com/api/webservice/guide/create-project" ref="nofollow noopener noreferrer">lbs.amap.com/api/webserv…</a></p>
<p>拿到 key 后，将它填入脚本开头的配置部分：</p>
<pre><code class="hljs language-python" lang="python">key = <span class="hljs-string">"你的高德API_KEY"</span>
</code></pre>
<hr/>
<h2 data-id="heading-2">三、核心逻辑讲解</h2>
<h3 data-id="heading-3">1. Excel文件读取与列处理</h3>
<p>脚本使用 <code>pandas</code> 和 <code>openpyxl</code> 结合读取 Excel 文件：</p>
<pre><code class="hljs language-python" lang="python">df = pd.read_excel(input_file)
<span class="hljs-keyword">if</span> <span class="hljs-string">'注册地址'</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> df.columns:
    df[<span class="hljs-string">'注册地址'</span>] = df.iloc[:,<span class="hljs-number">16</span>]
addresses = df[<span class="hljs-string">'注册地址'</span>].tolist()
</code></pre>
<p>这段代码首先读取整个 Excel，然后确认是否存在“注册地址”列；
如果没有，则自动取第 17 列（索引16）作为地址列，保证兼容不同格式的表格。</p>
<p>随后，脚本用 <code>openpyxl</code> 打开同一个文件，以保留单元格样式，准备写入新的“街道”列：</p>
<pre><code class="hljs language-python" lang="python">wb = load_workbook(input_file)
ws = wb.active
ws.insert_cols(target_col)
ws.cell(row=header_row_index, column=target_col, value=<span class="hljs-string">"街道"</span>)
</code></pre>
<p>这样既能读取数据，又能保持表格原有格式，方便下游人员直接查看。</p>
<hr/>
<h3 data-id="heading-4">2. 调用高德API获取街道信息</h3>
<p>核心的查询函数如下：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_street_from_amap</span>(<span class="hljs-params">address, retries=max_retries</span>):
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">isinstance</span>(address, <span class="hljs-built_in">str</span>) <span class="hljs-keyword">or</span> <span class="hljs-keyword">not</span> address.strip():
        <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>
    <span class="hljs-keyword">for</span> attempt <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, retries+<span class="hljs-number">1</span>):
        <span class="hljs-keyword">try</span>:
            geo_resp = requests.get(
                <span class="hljs-string">"https://restapi.amap.com/v3/geocode/geo"</span>,
                params={<span class="hljs-string">"key"</span>: key, <span class="hljs-string">"address"</span>: address, <span class="hljs-string">"city"</span>: <span class="hljs-string">"上海"</span>},
                timeout=<span class="hljs-number">15</span>
            ).json()

            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> geo_resp.get(<span class="hljs-string">"geocodes"</span>):
                <span class="hljs-keyword">continue</span>

            location = geo_resp[<span class="hljs-string">"geocodes"</span>][<span class="hljs-number">0</span>][<span class="hljs-string">"location"</span>]

            regeo_resp = requests.get(
                <span class="hljs-string">"https://restapi.amap.com/v3/geocode/regeo"</span>,
                params={<span class="hljs-string">"key"</span>: key, <span class="hljs-string">"location"</span>: location, <span class="hljs-string">"extensions"</span>: <span class="hljs-string">"base"</span>, <span class="hljs-string">"radius"</span>:<span class="hljs-number">500</span>},
                timeout=<span class="hljs-number">15</span>
            ).json()

            <span class="hljs-keyword">if</span> regeo_resp.get(<span class="hljs-string">"regeocode"</span>):
                township = regeo_resp[<span class="hljs-string">"regeocode"</span>][<span class="hljs-string">"addressComponent"</span>].get(<span class="hljs-string">"township"</span>,<span class="hljs-string">""</span>) <span class="hljs-keyword">or</span> <span class="hljs-string">""</span>
                <span class="hljs-keyword">return</span> township
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"[尝试 <span class="hljs-subst">{attempt}</span>/<span class="hljs-subst">{retries}</span>] 地址查询失败: <span class="hljs-subst">{address}</span>, 错误: <span class="hljs-subst">{e}</span>"</span>)
        time.sleep(sleep_time + random.random()*<span class="hljs-number">0.5</span>)
    <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>
</code></pre>
<p>这段逻辑分为两步：</p>
<ol>
<li><strong>正向地理编码</strong>（geocode）：根据地址字符串获取经纬度；</li>
<li><strong>逆向地理编码</strong>（regeo）：根据经纬度反查街道名称（township）。</li>
</ol>
<p>并加入了<strong>异常重试机制</strong>与<strong>随机延时</strong>，防止频繁请求触发高德API限流。</p>
<hr/>
<h3 data-id="heading-5">3. 批量查询与缓存优化</h3>
<p>查询过程通过循环实现：</p>
<pre><code class="hljs language-python" lang="python">cache = {}
failed_addresses = []

<span class="hljs-keyword">for</span> row_idx, addr <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(addresses, start=header_row_index+<span class="hljs-number">1</span>):
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">isinstance</span>(addr,<span class="hljs-built_in">str</span>) <span class="hljs-keyword">or</span> <span class="hljs-keyword">not</span> addr.strip():
        ws.cell(row=row_idx, column=target_col, value=<span class="hljs-string">""</span>)
        <span class="hljs-keyword">continue</span>
    <span class="hljs-keyword">if</span> addr <span class="hljs-keyword">in</span> cache:
        township = cache[addr]
    <span class="hljs-keyword">else</span>:
        township = get_street_from_amap(addr)
        <span class="hljs-keyword">if</span> township <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
            failed_addresses.append((row_idx, addr))
            township = <span class="hljs-string">""</span>
        cache[addr] = township
        time.sleep(sleep_time + random.random()*<span class="hljs-number">0.5</span>)
    ws.cell(row=row_idx, column=target_col, value=township)
</code></pre>
<p>这里有几个优化点：</p>
<ul>
<li><strong>缓存（cache）机制</strong>：如果同一地址出现多次，只请求一次；</li>
<li><strong>延时策略</strong>：<code>sleep_time + random.random()*0.5</code>，避免被API风控；</li>
<li><strong>实时进度输出</strong>：每50行打印一次进度。</li>
</ul>
<hr/>
<h3 data-id="heading-6">4. 失败重试与错误记录</h3>
<p>对于第一次查询失败的地址，脚本会自动发起第二轮重查：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">if</span> failed_addresses:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"第一次查询失败地址共 <span class="hljs-subst">{<span class="hljs-built_in">len</span>(failed_addresses)}</span> 条，开始自动重查……"</span>)
    still_failed = []
    <span class="hljs-keyword">for</span> row_idx, addr <span class="hljs-keyword">in</span> failed_addresses:
        township = get_street_from_amap(addr)
        <span class="hljs-keyword">if</span> township <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
            still_failed.append((row_idx, addr))
            township = <span class="hljs-string">""</span>
        cache[addr] = township
        ws.cell(row=row_idx, column=target_col, value=township)
        time.sleep(sleep_time + random.random()*<span class="hljs-number">0.5</span>)
    failed_addresses = still_failed
</code></pre>
<p>最终仍查询失败的地址会被写入单独的 Excel 文件：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">if</span> failed_addresses:
    df_fail = pd.DataFrame([addr <span class="hljs-keyword">for</span> _, addr <span class="hljs-keyword">in</span> failed_addresses], columns=[<span class="hljs-string">"地址"</span>])
    df_fail.to_excel(failed_file, index=<span class="hljs-literal">False</span>)
</code></pre>
<p>这样可以方便人工二次处理，比如手动调整地址格式或补录缺失信息。</p>
<hr/>
<h2 data-id="heading-7">四、运行结果</h2>
<p>执行脚本后，控制台会显示类似输出：</p>
<pre><code class="hljs">已处理 50 行，最近地址：上海市浦东新区张江路123号 → 张江镇
已处理 100 行，最近地址：上海市浦东新区川沙路56号 → 川沙新镇
第一次查询失败地址共 5 条，开始自动重查……
完成，已保存：事件列表-上海浦东-带街道.xlsx
最终仍失败的地址已保存到 查询失败地址.xlsx
</code></pre>
<p>最终输出文件中会新增一列“街道”，完整保留原有格式：</p>

















<table><thead><tr><th>注册地址</th><th>街道</th></tr></thead><tbody><tr><td>上海市浦东新区张江路123号</td><td>张江镇</td></tr><tr><td>上海市浦东新区川沙路56号</td><td>川沙新镇</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-8">五、实用建议与扩展方向</h2>
<ol>
<li>
<p><strong>批量查询速度控制</strong></p>
<ul>
<li>高德API对单IP有请求频率限制，建议控制每秒请求数。</li>
<li>若数据量大，可考虑多线程+限速队列模式。</li>
</ul>
</li>
<li>
<p><strong>地址清洗预处理</strong></p>
<ul>
<li>可先对地址进行正则清洗，去掉多余标点、括号、空格等，提高命中率。</li>
</ul>
</li>
<li>
<p><strong>多城市适配</strong></p>
<ul>
<li>当前城市固定为“上海”，可通过参数配置实现全国适配。</li>
</ul>
</li>
<li>
<p><strong>异常日志记录</strong></p>
<ul>
<li>建议在重查阶段输出更多日志，例如返回状态码、错误类型，方便调试。</li>
</ul>
</li>
<li>
<p><strong>接口替代方案</strong></p>
<ul>
<li>若数据量巨大，可以使用高德地图的批量地理编码接口（支持最多 10 条一次），进一步提升效率。</li>
</ul>
</li>
</ol>
<hr/>
<h2 data-id="heading-9">六、总结</h2>
<p>本文通过一个实战案例展示了如何用 <strong>Python + 高德地图API</strong> 实现“批量地址→街道归属”的自动化处理。
整个过程涵盖了数据读取、接口调用、异常重试、结果写回等完整流程，既是一个实用工具脚本，也体现了 Python 在数据自动化中的强大能力。</p>
<p><strong>核心亮点：</strong></p>

























<table><thead><tr><th>模块</th><th>功能</th></tr></thead><tbody><tr><td>pandas + openpyxl</td><td>高效读取与写入 Excel</td></tr><tr><td>requests</td><td>调用高德API进行地理解析</td></tr><tr><td>缓存与重试机制</td><td>提高查询稳定性与速度</td></tr><tr><td>自动生成失败文件</td><td>方便人工补录与质量控制</td></tr></tbody></table>
<p>如果你日常需要处理大量企业、门店、事件地址，这个脚本可以帮你节省大量时间。</p>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一份实用的Vue3技术栈代码评审指南]]></title>    <link>https://juejin.cn/post/7569787313851170862</link>    <guid>https://juejin.cn/post/7569787313851170862</guid>    <pubDate>2025-11-07T23:42:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7569787313851170862" data-draft-id="7569787315293814811" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一份实用的Vue3技术栈代码评审指南"/> <meta itemprop="keywords" content="前端,Vue.js"/> <meta itemprop="datePublished" content="2025-11-07T23:42:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="至简简"/> <meta itemprop="url" content="https://juejin.cn/user/4212984286819384"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一份实用的Vue3技术栈代码评审指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4212984286819384/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    至简简
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-07T23:42:46.000Z" title="Fri Nov 07 2025 23:42:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-07
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    27
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读15分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"/>
<h2 data-id="heading-1">CSS</h2>
<h3 data-id="heading-2">优先使用 <code>**scoped**</code> </h3>
<p>防止样式污染全局，<strong>每个组件样式必须局部化</strong>。</p>
<p>错误示例：无作用域</p>
<pre><code class="hljs language-vue" lang="vue">&lt;style&gt;
.button {
  color: red;
}
&lt;/style&gt;
</code></pre>
<p> 不加 scoped 会影响全局所有 <code>.button</code></p>
<p>正确示例：使用 scoped</p>
<pre><code class="hljs language-vue" lang="vue">&lt;style scoped&gt;
.button {
  color: red;
}
&lt;/style&gt;
</code></pre>
<h3 data-id="heading-3">限制嵌套层级 ≤ 3 层</h3>
<p>嵌套超过 3 层说明选择器设计有问题，建议拆分样式或使用 BEM。</p>
<p>错误示例：嵌套过深（5 层）</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-selector-class">.card</span> {
  <span class="hljs-selector-class">.header</span> {
    <span class="hljs-selector-class">.title</span> {
      <span class="hljs-selector-class">.icon</span> {
        <span class="hljs-selector-tag">span</span> {
          <span class="hljs-attribute">color</span>: red;
        }
      }
    }
  }
}
</code></pre>
<p>正确方式是进行合理拆分</p>
<h3 data-id="heading-4">避免使用 !important</h3>
<p>!important 会带来样式权重混乱，除非必要不推荐使用 !important</p>
<p>错误示例</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.button</span> {
  <span class="hljs-attribute">color</span>: red <span class="hljs-meta">!important</span>;
}

<span class="hljs-selector-class">.alert</span> {
  <span class="hljs-attribute">display</span>: none <span class="hljs-meta">!important</span>;
}
</code></pre>
<p>正确示例：提升选择器权重</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 通过增加父级选择器权重覆盖 */</span>
<span class="hljs-selector-class">.container</span> <span class="hljs-selector-class">.button</span> {
  <span class="hljs-attribute">color</span>: red;
}
</code></pre>
<h3 data-id="heading-5">合理使用 v-deep </h3>
<p>在 Vue3 中，<strong>如果要覆盖子组件或第三方库的内部样式</strong>，必须使用 <code>::v-deep</code>。禁止使用老版的 <code>/deep/</code> 或 <code>&gt;&gt;&gt;</code>，因为它们已废弃。同时要避免滥用 <code>::v-deep</code>，只在必要时使用，并保持选择器短小。</p>
<p> 错误示例</p>
<pre><code class="hljs language-vue" lang="vue">&lt;style scoped&gt;
.child-component .btn {
  color: red;
}
&lt;/style&gt;

</code></pre>
<p>正确示例</p>
<pre><code class="hljs language-vue" lang="vue">&lt;style scoped&gt;
::v-deep(.btn) {
  color: red;
}
&lt;/style&gt;
</code></pre>
<h3 data-id="heading-6">优先使用 UnoCSS</h3>
<p>因为项目中引入 UnoCSS，首选使用 UnoCSS。</p>
<p>错误示例</p>
<p>使用了传统的 CSS 类名来定义样式，而不是利用 UnoCSS 的原子化类。这违背了优先使用 UnoCSS 的原则。</p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;div class="my-button"&gt;
    点击我
  &lt;/div&gt;
&lt;/template&gt;

&lt;style scoped&gt;
.my-button {
  background-color: #007bff;
  color: white;
  padding: 10px 20px;
  border-radius: 5px;
  cursor: pointer;
}
&lt;/style&gt;
</code></pre>
<p>正确示例</p>
<p>充分利用了 UnoCSS 的原子化类来定义相同的样式</p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;div class="bg-blue-500 text-white p-x-5 p-y-2 rounded-md cursor-pointer"&gt;
    点击我
  &lt;/div&gt;
&lt;/template&gt;

&lt;style scoped&gt;
/* 无需额外的 style 标签，因为样式已通过 UnoCSS 类名定义 */
&lt;/style&gt;
</code></pre>
<h2 data-id="heading-7">JavaScript</h2>
<h3 data-id="heading-8">变量与方法应采用统一的命名规范</h3>
<p>命名应遵循语义清晰、风格一致、可读性高的原则，变量名体现数据类型/用途，方法名体现行为。团队建议统一小驼峰（camelCase） 风格，并避免无意义缩写或混用语言。</p>
<p>错误示例：变量命名不语义化</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">let</span> a = <span class="hljs-literal">true</span>;
<span class="hljs-keyword">let</span> b = [];
<span class="hljs-keyword">let</span> c = <span class="hljs-string">"http://api.example.com"</span>;
</code></pre>
<p>正确示例如下</p>
<ol>
<li>
<p>语义化命名</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">let</span> isActive = <span class="hljs-literal">true</span>;
<span class="hljs-keyword">let</span> <span class="hljs-attr">userList</span>: <span class="hljs-title class_">User</span>[ ] = [ ];
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">API_BASE_URL</span> = <span class="hljs-string">"http://api.example.com"</span>;
</code></pre>
</li>
<li>
<p>方法名包含动词</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">function</span> <span class="hljs-title function_">fetchData</span>(<span class="hljs-params"/>) { ... }
<span class="hljs-keyword">function</span> <span class="hljs-title function_">saveUser</span>(<span class="hljs-params"/>) { ... }
<span class="hljs-keyword">function</span> <span class="hljs-title function_">deleteUser</span>(<span class="hljs-params"/>) { ... }
</code></pre>
</li>
<li>
<p>布尔值变量以 is/has 开头</p>
</li>
</ol>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> isVisible = <span class="hljs-literal">false</span>;
<span class="hljs-keyword">const</span> hasError = <span class="hljs-literal">true</span>;

</code></pre>
<p> &gt; 1. 布尔值遵循语法准确是前提 2 推荐用 has 开头</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdev.to%2Fmichi%2Ftips-on-naming-boolean-variables-cleaner-code-35ig" target="_blank" title="https://dev.to/michi/tips-on-naming-boolean-variables-cleaner-code-35ig" ref="nofollow noopener noreferrer">dev.to/michi/tips-…</a>  参考写布尔值的工具</p>
<h3 data-id="heading-9">使用可选链</h3>
<p>当访问对象的深层次属性时，如果中间某一级可能为 <code>null</code> 或 <code>undefined</code>，    (?.) 替代传统的逐层判断，代码更简洁且避免运行时异常。</p>
<p>错误示例</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">if</span> (
  response &amp;&amp;
  response.<span class="hljs-property">data</span> &amp;&amp;
  response.<span class="hljs-property">data</span>.<span class="hljs-property">user</span> &amp;&amp;
  response.<span class="hljs-property">data</span>.<span class="hljs-property">user</span>.<span class="hljs-property">profile</span>
) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(response.<span class="hljs-property">data</span>.<span class="hljs-property">user</span>.<span class="hljs-property">profile</span>.<span class="hljs-property">name</span>);
}
</code></pre>
<p>上面的代码示例中判断条件冗长且可读性差、容易漏掉某一级判断和难以维护</p>
<p>正确示例</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> name = response?.<span class="hljs-property">data</span>?.<span class="hljs-property">user</span>?.<span class="hljs-property">profile</span>?.<span class="hljs-property">name</span>;
<span class="hljs-keyword">if</span> (name) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(name);
}
</code></pre>
<h3 data-id="heading-10">函数参数超过 3 个应封装成对象</h3>
<p>当函数参数 超过 3 个 或存在多个相同类型的参数时，推荐将这些参数封装为一个对象。这样可以提升代码可读性、维护性，并支持命名参数调用，避免顺序错误。</p>
<p>错误示例：多个参数直接传递</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">createUser</span>(<span class="hljs-params">
  name: <span class="hljs-built_in">string</span>,
  age: <span class="hljs-built_in">number</span>,
  role: <span class="hljs-built_in">string</span>,
  isActive: <span class="hljs-built_in">boolean</span>,
  department: <span class="hljs-built_in">string</span>
</span>) {
  <span class="hljs-comment">// 创建用户逻辑</span>
}

<span class="hljs-title function_">createUser</span>(<span class="hljs-string">"Alice"</span>, <span class="hljs-number">28</span>, <span class="hljs-string">"admin"</span>, <span class="hljs-literal">true</span>, <span class="hljs-string">"Engineering"</span>);
</code></pre>
<p>正确示例</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">CreateUserOptions</span> {
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">age</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-attr">role</span>: <span class="hljs-built_in">string</span>;
  isActive?: <span class="hljs-built_in">boolean</span>;
  department?: <span class="hljs-built_in">string</span>;
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">createUser</span>(<span class="hljs-params">options: CreateUserOptions</span>) {
  <span class="hljs-keyword">const</span> { name, age, role, isActive = <span class="hljs-literal">true</span>, department = <span class="hljs-string">"General"</span> } = options;
  <span class="hljs-comment">// 创建用户逻辑</span>
}

<span class="hljs-title function_">createUser</span>({
  <span class="hljs-attr">name</span>: <span class="hljs-string">"Alice"</span>,
  <span class="hljs-attr">age</span>: <span class="hljs-number">28</span>,
  <span class="hljs-attr">role</span>: <span class="hljs-string">"admin"</span>,
  <span class="hljs-attr">department</span>: <span class="hljs-string">"Engineering"</span>,
});
</code></pre>
<h3 data-id="heading-11">使用 ResizeObserver 替代 onResize</h3>
<p>window.onresize 只能监听浏览器窗口尺寸变化，无法感知单个 DOM 元素尺寸变化。Vue3 项目应使用 ResizeObserver 监听任意 DOM 元素的尺寸变化，支持多元素、精准触发、性能更优。</p>
<p>错误示例</p>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup lang="ts"&gt;
const width = ref(0);

onMounted(() =&gt; {
  window.onresize = () =&gt; {
    const el = document.getElementById("container");
    width.value = el?.offsetWidth || 0;
  };
  window.onresize(); // 初始化
});
&lt;/script&gt;

&lt;template&gt;
  &lt;div id="container" style="width: 50%;"&gt;宽度：{{ width }}px&lt;/div&gt;
&lt;/template&gt;
</code></pre>
<p>问题</p>
<ul>
<li>
<p>无法感知父容器/内容变化，只能在窗口尺寸变化时触发。</p>
</li>
<li>
<p>多组件绑定 window.onresize 时，回调容易互相覆盖。</p>
</li>
<li>
<p>卸载时忘记移除监听，可能导致内存泄漏。</p>
</li>
</ul>
<p>正确示例</p>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup lang="ts"&gt;
const elRef = ref&lt;HTMLDivElement&gt;();
const size = ref({ width: 0, height: 0 });

onMounted(() =&gt; {
  const observer = new ResizeObserver((entries) =&gt; {
    const rect = entries[0].contentRect;
    size.value.width = rect.width;
    size.value.height = rect.height;
  });
  observer.observe(elRef.value!);

  onUnmounted(() =&gt; observer.disconnect());
});
&lt;/script&gt;

&lt;template&gt;
  &lt;div ref="elRef" style="width: 50%;"&gt;
    宽度：{{ size.width }}px，高度：{{ size.height }}px
  &lt;/div&gt;
&lt;/template&gt;
</code></pre>
<h2 data-id="heading-12">TypeScript</h2>
<h3 data-id="heading-13">避免在组件/逻辑中使用 any</h3>
<p>在 Vite + TS 项目里，一旦滥用 <code>any</code>，类型检查形同虚设。要尽量用明确类型或 <code>unknown</code>（再做类型收窄）。</p>
<p>错误示例</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">parseData</span>(<span class="hljs-params">data: <span class="hljs-built_in">any</span></span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(data);
}

<span class="hljs-keyword">const</span> <span class="hljs-attr">user</span>: <span class="hljs-built_in">any</span> = <span class="hljs-title function_">getUser</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(user.<span class="hljs-property">name</span>);
</code></pre>
<p>正确示例</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">parseData</span>(<span class="hljs-params">data: <span class="hljs-built_in">unknown</span></span>): <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">unknown</span>&gt; {
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> data === <span class="hljs-string">"string"</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(data);
  }
  <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"Invalid data type"</span>);
}

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">User</span> {
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">age</span>: <span class="hljs-built_in">number</span>;
}
<span class="hljs-keyword">const</span> <span class="hljs-attr">user</span>: <span class="hljs-title class_">User</span> = <span class="hljs-title function_">getUser</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(user.<span class="hljs-property">name</span>);
</code></pre>
<p>目前有两种情况，</p>
<ol>
<li>stores 中没有写类型 （旧的不补类型，新的 stores 补类型） 新接口，新枚举，新常量</li>
</ol>
<h3 data-id="heading-14">使用 enum 避免硬编码</h3>
<p>所有固定集合值（角色、状态、方向等）必须使用 TypeScript 的 <code>enum</code> 定义，禁止使用字符串字面量或硬编码。</p>
<p>错误示例：硬编码字符串</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">if</span> (user.<span class="hljs-property">role</span> === <span class="hljs-string">'admin'</span>) { ... }
<span class="hljs-keyword">if</span> (status === <span class="hljs-string">'PENDING'</span>) { ... }
</code></pre>
<p>正确示例：使用 enum</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">enum</span> <span class="hljs-title class_">UserRole</span> {
  <span class="hljs-title class_">Admin</span> = <span class="hljs-string">'admin'</span>,
  <span class="hljs-title class_">User</span> = <span class="hljs-string">'user'</span>,
  <span class="hljs-title class_">Guest</span> = <span class="hljs-string">'guest'</span>
}

<span class="hljs-keyword">enum</span> <span class="hljs-title class_">OrderStatus</span> {
  <span class="hljs-title class_">Pending</span> = <span class="hljs-string">'PENDING'</span>,
  <span class="hljs-title class_">Shipped</span> = <span class="hljs-string">'SHIPPED'</span>,
  <span class="hljs-title class_">Delivered</span> = <span class="hljs-string">'DELIVERED'</span>
}

<span class="hljs-keyword">if</span> (user.<span class="hljs-property">role</span> === <span class="hljs-title class_">UserRole</span>.<span class="hljs-property">Admin</span>) { ... }
<span class="hljs-keyword">if</span> (status === <span class="hljs-title class_">OrderStatus</span>.<span class="hljs-property">Pending</span>) { ... }
</code></pre>
<h3 data-id="heading-15">Props、Emits 必须类型化</h3>
<p>在 Vue3 的 SFC 中，<code>defineProps</code> 和 <code>defineEmits</code> 必须声明类型。</p>
<p>错误示例</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-title function_">defineProps</span>([<span class="hljs-string">'title'</span>, <span class="hljs-string">'count'</span>])
<span class="hljs-title function_">defineEmits</span>([<span class="hljs-string">'update'</span>])
</code></pre>
<p>正确示例</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">Props</span> {
  <span class="hljs-attr">title</span>: <span class="hljs-built_in">string</span>
  <span class="hljs-attr">count</span>: <span class="hljs-built_in">number</span>
}

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">Emits</span> {
  (<span class="hljs-attr">e</span>: <span class="hljs-string">'update'</span>, <span class="hljs-attr">value</span>: <span class="hljs-built_in">number</span>): <span class="hljs-built_in">void</span>
}

<span class="hljs-keyword">const</span> props = defineProps&lt;<span class="hljs-title class_">Props</span>&gt;()
<span class="hljs-keyword">const</span> emit = defineEmits&lt;<span class="hljs-title class_">Emits</span>&gt;()
</code></pre>
<p>3.3 以上有另一种方式</p>
<h3 data-id="heading-16">泛型必须具备边界约束</h3>
<p>使用泛型时必须加上约束，防止过宽的类型导致不安全操作。</p>
<p>错误示例</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">function</span> getValue&lt;T&gt;(<span class="hljs-attr">obj</span>: T, <span class="hljs-attr">key</span>: <span class="hljs-built_in">string</span>) {
  <span class="hljs-keyword">return</span> obj[key]
}
</code></pre>
<p>正确示例</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">function</span> getValue&lt;T <span class="hljs-keyword">extends</span> <span class="hljs-built_in">object</span>, K <span class="hljs-keyword">extends</span> keyof T&gt;(<span class="hljs-attr">obj</span>: T, <span class="hljs-attr">key</span>: K): T[K] {
  <span class="hljs-keyword">return</span> obj[key]
}
</code></pre>
<h3 data-id="heading-17">组合式 API 必须有返回值类型</h3>
<p>composables API 应该明确返回值类型，方便调用处类型推断。</p>
<p>错误示例</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useUser</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> user = ref&lt;<span class="hljs-title class_">User</span>&gt;()
  <span class="hljs-keyword">return</span> { user }
}
</code></pre>
<p>正确示例</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useUser</span>(<span class="hljs-params"/>): { <span class="hljs-attr">user</span>: <span class="hljs-title class_">Ref</span>&lt;<span class="hljs-title class_">User</span>&gt; } {
  <span class="hljs-keyword">const</span> user = ref&lt;<span class="hljs-title class_">User</span>&gt;()
  <span class="hljs-keyword">return</span> { user }
}
</code></pre>
<h2 data-id="heading-18">Vue3</h2>
<h3 data-id="heading-19">不要在 defineProps() 里混用类型和 runtime 校验</h3>
<p>Vue3 允许 defineProps() 使用 runtime 声明和类型声明，但二者混用易出 bug。推荐统一使用 泛型声明类型。</p>
<p>错误示例</p>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup lang="ts"&gt;
defineProps({
  title: String,
});
interface Props {
  title: string;
}
&lt;/script&gt;
</code></pre>
<p>正确示例</p>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup lang="ts"&gt;
interface Props {
  title: string;
}
const props = defineProps&lt;Props&gt;();
&lt;/script&gt;
</code></pre>
<h3 data-id="heading-20">类型声明统一放在 types 文件夹或模块中</h3>
<p>全局类型或接口建议集中管理，避免散落在组件里难以维护。</p>
<p>错误示例</p>
<pre><code class="hljs language-vue" lang="vue">// 在多个组件里重复定义 interface User { name: string; age: number }
</code></pre>
<p>正确示例</p>
<pre><code class="hljs language-pgsql" lang="pgsql">src/types/user.d.ts
</code></pre>
<pre><code class="hljs language-vue" lang="vue">export interface User { name: string age: number }
</code></pre>
<h3 data-id="heading-21">在模板中使用类型提示</h3>
<p>通过 defineExpose 和 defineEmits 的泛型参数在模板中获得类型提示。</p>
<p>错误示例</p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;button @click="emit('save', 123)"&gt;Save&lt;/button&gt;
&lt;/template&gt;

&lt;script setup lang="ts"&gt;
const emit = defineEmits(["save"]);
&lt;/script&gt;
</code></pre>
<p>正确示例</p>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup lang="ts"&gt;
const emit = defineEmits&lt;{
  (e: "save", id: number): void;
}&gt;();
&lt;/script&gt;
</code></pre>
<h3 data-id="heading-22">优先使用 &lt;script setup&gt; 而不是 defineComponent</h3>
<p>Vue 3 的 &lt;script setup&gt; 更简洁、性能更好（编译优化），避免不必要的模板变量暴露。</p>
<p>错误示例</p>
<pre><code class="hljs language-vue" lang="vue">&lt;script lang="ts"&gt;
import { defineComponent, ref } from "vue";

export default defineComponent({
  setup() {
    const count = ref(0);
    return { count };
  },
});
&lt;/script&gt;

</code></pre>
<p>正确示例</p>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup lang="ts"&gt;
import { ref } from "vue";

const count = ref(0);
&lt;/script&gt;
</code></pre>
<h3 data-id="heading-23">在模板中避免复杂逻辑表达式</h3>
<p>模板里只做展示，不要做复杂逻辑，逻辑应移到计算属性或方法。</p>
<p>错误示例</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span></span>
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span></span>
<span class="hljs-code">    {{
      users
        .filter((u) =&gt; u.age &gt; 18)
        .map((u) =&gt; u.name)
        .join(", ")
    }}
  &lt;/div&gt;
&lt;/template&gt;
</span></code></pre>
<p>正确示例</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"ts"</span>&gt;</span></span>
const adultNames = computed(() =&gt;
  users.value
<span class="hljs-code">    .filter((u) =&gt; u.age &gt; 18)
    .map((u) =&gt; u.name)
    .join(", ")
);
&lt;/script&gt;
</span>
<span class="xml"><span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span></span></span>
  <span class="xml"><span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span></span></span>{{ adultNames }}<span class="xml"><span class="xml"><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span></span>
<span class="xml"><span class="xml"><span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span></span></span>
</code></pre>
<h3 data-id="heading-24">事件名统一使用 kebab-case</h3>
<p>Vue 3 推荐自定义事件名用 kebab-case，避免与 DOM 属性冲突。</p>
<p>错误示例</p>
<pre><code class="hljs language-vue" lang="vue">&lt;ChildComponent @saveData="handleSave" /&gt;
</code></pre>
<p>正确示例</p>
<pre><code class="hljs language-vue" lang="vue">&lt;ChildComponent @save-data="handleSave" /&gt;
</code></pre>
<h3 data-id="heading-25">组件通信避免滥用 $emit，优先使用 props + v-model</h3>
<p>小型数据通信用 props/v-model，大型数据或频繁通信建议使用 Pinia/Composable。</p>
<p>错误示例</p>
<pre><code class="hljs language-vue" lang="vue">&lt;ChildComponent @updateValue="parentValue = $event" /&gt;
</code></pre>
<p>正确示例</p>
<pre><code class="hljs language-vue" lang="vue">&lt;ChildComponent v-model="parentValue" /&gt;
</code></pre>
<h3 data-id="heading-26">避免复杂嵌套三元运算</h3>
<p>三元表达式适合简单条件切换，若逻辑复杂或嵌套，应使用 if-else、computed 或方法代替。 在模板中，复杂三元表达式严重降低可读性，且容易遗漏分支，Review 时应强制重构</p>
<p>错误示例</p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;div&gt;
    {{ status === "loading" ? "加载中" : status === "error" ? "错误" : "完成" }}
  &lt;/div&gt;
&lt;/template&gt;
</code></pre>
<p>正确示例</p>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup lang="ts"&gt;
const statusText = computed(() =&gt; {
  if (status.value === "loading") return "加载中";
  if (status.value === "error") return "错误";
  return "完成";
});
&lt;/script&gt;

&lt;template&gt;
  &lt;div&gt;{{ statusText }}&lt;/div&gt;
&lt;/template&gt;
</code></pre>
<h3 data-id="heading-27">定时器必须在卸载时清理</h3>
<p>在 Vue 组件中使用 setInterval、setTimeout、requestAnimationFrame 等定时器，必须在组件卸载（onUnmounted）时清理，否则会导致内存泄漏或意外触发逻辑</p>
<p>错误示例</p>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup lang="ts"&gt;
onMounted(() =&gt; {
  setInterval(() =&gt; {
    console.log("轮询接口");
  }, 1000);
});
&lt;/script&gt;
</code></pre>
<p>正确示例</p>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup lang="ts"&gt;
let timer: ReturnType&lt;typeof setInterval&gt;;

onMounted(() =&gt; {
  timer = setInterval(() =&gt; {
    console.log("轮询接口");
  }, 1000);
});

onUnmounted(() =&gt; {
  clearInterval(timer);
});
&lt;/script&gt;
</code></pre>
<h3 data-id="heading-28">IO（API 请求、文件处理等）必须做错误处理</h3>
<p>网络请求（fetch/axios）、文件操作等 IO 行为容易失败，必须捕获异常并反馈用户，防止应用无响应或白屏</p>
<p>错误示例</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">const</span> <span class="hljs-title function_">fetchData</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">"/api/data"</span>);
  <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> res.<span class="hljs-title function_">json</span>();
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(data);
};
</code></pre>
<p>正确示例</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">const</span> <span class="hljs-title function_">fetchData</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">"/api/data"</span>);
    <span class="hljs-keyword">if</span> (!res.<span class="hljs-property">ok</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"请求失败"</span>);
    <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> res.<span class="hljs-title function_">json</span>();
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(data);
  } <span class="hljs-keyword">catch</span> (err) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"数据请求错误:"</span>, err);
    <span class="hljs-title function_">alert</span>(<span class="hljs-string">"网络错误，请稍后重试"</span>);
  }
};
</code></pre>
<h3 data-id="heading-29">避免数据竞态（Race Condition）</h3>
<p>当组件内多次发起异步请求或副作用操作（如用户快速切换选项），后发出的请求可能比先发出的请求先返回，导致数据状态错乱。必须通过请求标记、AbortController 或最新响应检查防止。</p>
<p>错误示例 具体场景：用户快速切换 Item 1 → Item 2 → Item 1，可能 Item 1 的旧请求最后返回，把数据覆盖成错误值。</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"ts"</span>&gt;</span></span>
const selectedId = ref(1);
const data = ref(null);

watch(selectedId, async (id) =&gt; {
  const res = await fetch(<span class="hljs-code">`/api/item/${id}`</span>);
  data.value = await res.json();
});
<span class="xml"><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span></span>
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">"selectedId"</span>&gt;</span></span>
<span class="hljs-code">    &lt;option :value="1"&gt;Item 1&lt;/option&gt;
    &lt;option :value="2"&gt;Item 2&lt;/option&gt;
  &lt;/select&gt;
  &lt;div&gt;{{ data }}&lt;/div&gt;
&lt;/template&gt;
</span></code></pre>
<p>解决思路</p>
<p>正确示例 1：使用请求标记（Token）</p>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup lang="ts"&gt;
const selectedId = ref(1);
const data = ref(null);
let requestToken = 0;

watch(selectedId, async (id) =&gt; {
  const token = ++requestToken;
  const res = await fetch(`/api/item/${id}`);
  if (token !== requestToken) return; // 旧请求，丢弃
  data.value = await res.json();
});
&lt;/script&gt;
</code></pre>
<p>正确示例 2：使用 AbortController</p>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup lang="ts"&gt;
const selectedId = ref(1);
const data = ref(null);
let controller: AbortController;

watch(selectedId, async (id) =&gt; {
  controller?.abort(); // 中断上一个请求
  controller = new AbortController();

  try {
    const res = await fetch(`/api/item/${id}`, { signal: controller.signal });
    data.value = await res.json();
  } catch (err) {
    if (err.name !== "AbortError") console.error(err);
  }
});
&lt;/script&gt;
</code></pre>
<p>正确示例 3：封装 Composable，统一竞态处理</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-comment">// composables/useSafeFetch.ts</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useSafeFetch</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">let</span> <span class="hljs-attr">controller</span>: <span class="hljs-title class_">AbortController</span>;

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">safeFetch</span>(<span class="hljs-params">url: <span class="hljs-built_in">string</span></span>) {
    controller?.<span class="hljs-title function_">abort</span>();
    controller = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AbortController</span>();
    <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(url, { <span class="hljs-attr">signal</span>: controller.<span class="hljs-property">signal</span> });
    <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">json</span>();
  };
}
</code></pre>
<pre><code class="hljs language-tsx" lang="tsx">&lt;script setup lang=<span class="hljs-string">"ts"</span>&gt;
<span class="hljs-keyword">const</span> { safeFetch } = <span class="hljs-title function_">useSafeFetch</span>();
<span class="hljs-keyword">const</span> data = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">null</span>);

<span class="hljs-title function_">watch</span>(selectedId, <span class="hljs-keyword">async</span> (id) =&gt; {
  data.<span class="hljs-property">value</span> = <span class="hljs-keyword">await</span> <span class="hljs-title function_">safeFetch</span>(<span class="hljs-string">`/api/item/<span class="hljs-subst">${id}</span>`</span>);
});
&lt;/script&gt;
</code></pre>
<h3 data-id="heading-30">列表渲染中不推荐使用索引作为 key</h3>
<p>Vue 的虚拟 DOM 需要依赖 <code>key</code> 来准确地跟踪节点身份，保证列表渲染的高效与正确。<code>**key**</code> <strong>必须唯一且稳定</strong>，通常来自数据的唯一标识字段（如数据库 ID）。<strong>避免使用数组索引</strong> <code>**index**</code> <strong>作为</strong> <code>**key**</code><strong>，除非数据列表静态且无增删排序需求</strong>。</p>
<p>错误示例：使用索引作为 <code>key</code></p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;ul&gt;
    &lt;li v-for="(item, index) in items" :key="index"&gt;
      {{ item.name }}
    &lt;/li&gt;
  &lt;/ul&gt;
&lt;/template&gt;
</code></pre>
<p>正确示例：使用稳定唯一标识作为 <code>key</code></p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;ul&gt;
    &lt;li v-for="item in items" :key="item.id"&gt;
      {{ item.name }}
    &lt;/li&gt;
  &lt;/ul&gt;
&lt;/template&gt;
</code></pre>
<h3 data-id="heading-31">国际化</h3>
<ol>
<li>
<p>代码中的文案一定要做国际化处理 （比如中文正则表达式搜索检查）</p>
</li>
<li>
<p>国际化后的文案由 PM 提供，PM 不提供，使用 ChatGPT/Cursor 处理后与 PM 一起校对（拿不准找 Perry ）</p>
</li>
<li>
<p>标点符号与语言对应，比如英文中不能出现中文括号</p>
</li>
<li>
<p>新增的国际化内容设置独立命令空间或者全文检索，避免 key 冲突</p>
</li>
<li>
<p>国际化内容的 key 是英文短语，不能是中文 </p>
</li>
<li>
<p>PR 的 Code Review 中涉及国际化内容必须重点 review</p>
</li>
</ol>
<p> 正确示例</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
	<span class="hljs-string">'Administrator has enabled Multi-Factor Authentication (MFA)'</span>: <span class="hljs-string">'El administrador ha habilitado la autenticación de múltiples factores (MFA)'</span>,
  <span class="hljs-string">'Open your app store'</span>: <span class="hljs-string">'Abre tu tienda de aplicaciones'</span>,
};

</code></pre>
<p> 在组件中这样使用</p>
<pre><code class="hljs language-vue" lang="vue">&lt;li&gt;{{ t('Open your app store') }}&lt;/li&gt;
</code></pre>
<h2 data-id="heading-32">Vue 组件设计</h2>
<h3 data-id="heading-33">统一组件命名 / 文件命名策略</h3>
<p>统一组件名采用 PascalCase（或一致 kebab-case），基础组件保留 Base 前缀，名称应全拼避免缩写，提高可维护性</p>
<p>错误示例</p>
<pre><code class="hljs language-powershell" lang="powershell">components/
  myComp.vue
  btn.vue
</code></pre>
<p>正确示例</p>
<pre><code class="hljs language-shell" lang="shell">components/
  MyComponent.vue
  BaseButton.vue
</code></pre>
<p>在组件中这样使用</p>
<pre><code class="hljs language-vue" lang="vue">&lt;BaseButton/&gt;
</code></pre>
<p>如果是 element-plus  组件库，可以使用如下的使用方式</p>
<pre><code class="hljs language-vue" lang="vue">&lt;el-button/&gt;
</code></pre>
<h3 data-id="heading-34">统一文件夹（目录）命名规范</h3>
<p>项目中的所有目录名称必须遵循统一的命名风格，确保路径清晰、可预测、跨平台无大小写冲突。</p>
<p>错误示例：目录命名混乱</p>
<pre><code class="hljs language-shell" lang="shell">components/
  UserProfile/
  loginForm/
  Account_details/
  auth/
</code></pre>
<p>正确示例：统一 kebab-case</p>
<pre><code class="hljs language-shell" lang="shell">components/
  user-profile/
  login-form/
  account-details/
  auth/
</code></pre>
<h3 data-id="heading-35">TS 文件名命名</h3>
<p>项目中的 TS 文件命名应该是小驼峰格式</p>
<p>错误示例</p>
<pre><code class="hljs language-shell" lang="shell">user-list.ts
</code></pre>
<p> 正确示例</p>
<pre><code class="hljs language-shell" lang="shell">userList.ts
</code></pre>
<h3 data-id="heading-36">组件的状态与 UI 分离</h3>
<p>在 Vue3 组件开发中，所有数据处理逻辑（如 API 请求、数据格式化、状态管理等）应从 UI 层（模板 &amp; 样式）中分离，放入 Composable、Store、Utils。模板只负责展示，逻辑放在单独模块便于测试、复用和维护。</p>
<p>错误示例</p>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup lang="ts"&gt;
import { ref, onMounted } from "vue";

const users = ref([]);
const loading = ref(false);
const error = ref("");

onMounted(async () =&gt; {
  loading.value = true;
  try {
    const res = await fetch("/api/users");
    users.value = await res.json();
  } catch (e) {
    error.value = "加载用户失败";
  } finally {
    loading.value = false;
  }
});

const formatName = (user) =&gt; `${user.firstName} ${user.lastName}`;
&lt;/script&gt;

&lt;template&gt;
  &lt;div v-if="loading"&gt;加载中...&lt;/div&gt;
  &lt;div v-else-if="error"&gt;{{ error }}&lt;/div&gt;
  &lt;ul v-else&gt;
    &lt;li v-for="user in users" :key="user.id"&gt;
      {{ formatName(user) }}
    &lt;/li&gt;
  &lt;/ul&gt;
&lt;/template&gt;
</code></pre>
<p>上面的示例中存在的问题</p>
<ul>
<li>
<p>API 请求逻辑、数据状态和格式化函数都在组件里</p>
</li>
<li>
<p>组件职责太多：UI + 业务逻辑 + 状态管理</p>
</li>
<li>
<p>无法复用 fetchUsers 和 formatName</p>
</li>
</ul>
<p>正确示例 - 数据逻辑分离到 Composable</p>
<p>composables/useUsers.ts</p>
<pre><code class="hljs language-vue" lang="vue">import { ref } from "vue";

export function useUsers() {
  const users = ref([]);
  const loading = ref(false);
  const error = ref("");

  const fetchUsers = async () =&gt; {
    loading.value = true;
    try {
      const res = await fetch("/api/users");
      users.value = await res.json();
    } catch (e) {
      error.value = "加载用户失败";
    } finally {
      loading.value = false;
    }
  };

  const formatName = (user) =&gt; `${user.firstName} ${user.lastName}`;

  return { users, loading, error, fetchUsers, formatName };
}
</code></pre>
<p>UserList.vue</p>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup lang="ts"&gt;
import { onMounted } from "vue";
import { useUsers } from "@/composables/useUsers";

const { users, loading, error, fetchUsers, formatName } = useUsers();

onMounted(fetchUsers);
&lt;/script&gt;

&lt;template&gt;
  &lt;div v-if="loading"&gt;加载中...&lt;/div&gt;
  &lt;div v-else-if="error"&gt;{{ error }}&lt;/div&gt;
  &lt;ul v-else&gt;
    &lt;li v-for="user in users" :key="user.id"&gt;
      {{ formatName(user) }}
    &lt;/li&gt;
  &lt;/ul&gt;
&lt;/template&gt;
</code></pre>
<p>正确的案例中，UI 专注展示，逻辑由 useUsers 管理、useUsers 可被其他组件复用、只需要测试 useUsers 方法就行</p>
<h3 data-id="heading-37">UI组件 vs 业务组件</h3>
<p><strong>UI组件</strong>（Button, Modal, Table）：无业务逻辑，仅负责样式和交互</p>
<p><strong>业务组件</strong>（UserList, OrderForm）：封装具体业务逻辑，复用 UI 组件</p>
<p>错误示例：业务逻辑写在 UI 组件</p>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- Button.vue --&gt;
&lt;script setup&gt;
const handleSaveUser = async () =&gt; {
  await api.saveUser()
}
&lt;/script&gt;

&lt;template&gt;
  &lt;button @click="handleSaveUser"&gt;保存&lt;/button&gt;
&lt;/template&gt;

</code></pre>
<p>正确示例：UI 组件尽量保证纯组件</p>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- Button.vue --&gt;
&lt;template&gt;
  &lt;button&gt;&lt;slot /&gt;&lt;/button&gt;
&lt;/template&gt;

&lt;!-- UserForm.vue --&gt;
&lt;Button @click="saveUser"&gt;保存&lt;/Button&gt;
</code></pre>
<p>在写业务组件的时候，利用Composition API 分离逻辑，把 API 调用、数据处理抽离到 composable 中</p>
<h3 data-id="heading-38">避免直接操作 DOM</h3>
<p>除非必要尽量不要使用 <code>document.querySelector</code> 等直接操作 DOM</p>
<p>错误示例</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-title function_">onMounted</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> el = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.btn'</span>)
  el?.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-function">() =&gt;</span> { ... })
})
</code></pre>
<p>正确示例</p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;button @click="handleClick" class="btn"&gt;Click&lt;/button&gt;
&lt;/template&gt;

&lt;script setup lang="ts"&gt;
function handleClick() {
  // 处理逻辑
}
&lt;/script&gt;
</code></pre>
<h2 data-id="heading-39">单元测试</h2>
<h3 data-id="heading-40">1. 单元测试应覆盖核心业务逻辑，避免测试无意义的渲染细节</h3>
<p>测试应聚焦于组件的行为和业务逻辑，而非仅仅验证静态的 DOM 结构，避免脆弱且维护成本高的测试。</p>
<p><strong>错误示例</strong></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 测试仅验证 DOM 具体标签和类名，DOM 结构细节变动即破坏测试</span>
<span class="hljs-title function_">test</span>(<span class="hljs-string">'renders exact button markup'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> wrapper = <span class="hljs-title function_">mount</span>(<span class="hljs-title class_">MyButton</span>)
  <span class="hljs-title function_">expect</span>(wrapper.<span class="hljs-title function_">html</span>()).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">'&lt;button class="btn primary"&gt;Submit&lt;/button&gt;'</span>)
})

</code></pre>
<p><strong>正确示例</strong></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 测试按钮是否存在且包含正确文本，关注业务效果而非具体标签细节</span>
<span class="hljs-title function_">test</span>(<span class="hljs-string">'renders submit button'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> wrapper = <span class="hljs-title function_">mount</span>(<span class="hljs-title class_">MyButton</span>)
  <span class="hljs-keyword">const</span> button = wrapper.<span class="hljs-title function_">find</span>(<span class="hljs-string">'button'</span>)
  <span class="hljs-title function_">expect</span>(button.<span class="hljs-title function_">exists</span>()).<span class="hljs-title function_">toBe</span>(<span class="hljs-literal">true</span>)
  <span class="hljs-title function_">expect</span>(button.<span class="hljs-title function_">text</span>()).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">'Submit'</span>)
})

</code></pre>
<hr/>
<h3 data-id="heading-41">2. 使用 Vue Test Utils 的异步渲染工具时，要正确等待 nextTick</h3>
<p>Vue3 组件中很多行为是异步更新的，测试中操作后必须调用 <code>await nextTick()</code> 或使用 <code>flushPromises()</code> 等方法，确保断言是在 DOM 更新完成后进行。</p>
<p><strong>错误示例</strong></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-title function_">test</span>(<span class="hljs-string">'click increments count'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> wrapper = <span class="hljs-title function_">mount</span>(<span class="hljs-title class_">Counter</span>)
  wrapper.<span class="hljs-title function_">find</span>(<span class="hljs-string">'button'</span>).<span class="hljs-title function_">trigger</span>(<span class="hljs-string">'click'</span>)
  <span class="hljs-title function_">expect</span>(wrapper.<span class="hljs-title function_">text</span>()).<span class="hljs-title function_">toContain</span>(<span class="hljs-string">'Count: 1'</span>) <span class="hljs-comment">// 断言过早，失败</span>
})

</code></pre>
<p><strong>正确示例</strong></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> { nextTick } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-title function_">test</span>(<span class="hljs-string">'click increments count'</span>, <span class="hljs-keyword">async</span> () =&gt; {
  <span class="hljs-keyword">const</span> wrapper = <span class="hljs-title function_">mount</span>(<span class="hljs-title class_">Counter</span>)
  <span class="hljs-keyword">await</span> wrapper.<span class="hljs-title function_">find</span>(<span class="hljs-string">'button'</span>).<span class="hljs-title function_">trigger</span>(<span class="hljs-string">'click'</span>)
  <span class="hljs-keyword">await</span> <span class="hljs-title function_">nextTick</span>()
  <span class="hljs-title function_">expect</span>(wrapper.<span class="hljs-title function_">text</span>()).<span class="hljs-title function_">toContain</span>(<span class="hljs-string">'Count: 1'</span>)
})

</code></pre>
<hr/>
<h3 data-id="heading-42">3. 事件触发测试必须确保事件正确被捕获并处理</h3>
<p>测试组件自定义事件或原生事件时，需确保事件被正确监听，并使用 <code>emitted()</code> 方法断言事件触发，避免事件未触发测试通过的假象。</p>
<p><strong>错误示例</strong></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-title function_">test</span>(<span class="hljs-string">'emits submit event'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> wrapper = <span class="hljs-title function_">mount</span>(<span class="hljs-title class_">FormComponent</span>)
  wrapper.<span class="hljs-title function_">find</span>(<span class="hljs-string">'form'</span>).<span class="hljs-title function_">trigger</span>(<span class="hljs-string">'submit'</span>)
  <span class="hljs-title function_">expect</span>(wrapper.<span class="hljs-title function_">emitted</span>(<span class="hljs-string">'submit'</span>)).<span class="hljs-title function_">toBeTruthy</span>() <span class="hljs-comment">// 可能事件未触发，但断言粗略</span>
})

</code></pre>
<p><strong>正确示例</strong></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-title function_">test</span>(<span class="hljs-string">'emits submit event once'</span>, <span class="hljs-keyword">async</span> () =&gt; {
  <span class="hljs-keyword">const</span> wrapper = <span class="hljs-title function_">mount</span>(<span class="hljs-title class_">FormComponent</span>)
  <span class="hljs-keyword">await</span> wrapper.<span class="hljs-title function_">find</span>(<span class="hljs-string">'form'</span>).<span class="hljs-title function_">trigger</span>(<span class="hljs-string">'submit.prevent'</span>)
  <span class="hljs-keyword">const</span> submitEvents = wrapper.<span class="hljs-title function_">emitted</span>(<span class="hljs-string">'submit'</span>)
  <span class="hljs-title function_">expect</span>(submitEvents).<span class="hljs-title function_">toHaveLength</span>(<span class="hljs-number">1</span>)
})

</code></pre>
<hr/>
<h3 data-id="heading-43">4. 不要在测试中硬编码组件内部状态，尽量从外部输入和输出测试</h3>
<p>单元测试应以组件的公开接口（props、事件）为测试点，避免直接访问或修改组件内部私有数据，保持测试的稳健性和解耦。</p>
<p><strong>错误示例</strong></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-title function_">test</span>(<span class="hljs-string">'increments count internally'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> wrapper = <span class="hljs-title function_">mount</span>(<span class="hljs-title class_">Counter</span>)
  wrapper.<span class="hljs-property">vm</span>.<span class="hljs-property">count</span> = <span class="hljs-number">5</span>
  wrapper.<span class="hljs-property">vm</span>.<span class="hljs-title function_">increment</span>()
  <span class="hljs-title function_">expect</span>(wrapper.<span class="hljs-property">vm</span>.<span class="hljs-property">count</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-number">6</span>) <span class="hljs-comment">// 依赖内部状态</span>
})

</code></pre>
<p><strong>正确示例</strong></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-title function_">test</span>(<span class="hljs-string">'increments count via user interaction'</span>, <span class="hljs-keyword">async</span> () =&gt; {
  <span class="hljs-keyword">const</span> wrapper = <span class="hljs-title function_">mount</span>(<span class="hljs-title class_">Counter</span>)
  <span class="hljs-keyword">await</span> wrapper.<span class="hljs-title function_">find</span>(<span class="hljs-string">'button.increment'</span>).<span class="hljs-title function_">trigger</span>(<span class="hljs-string">'click'</span>)
  <span class="hljs-title function_">expect</span>(wrapper.<span class="hljs-title function_">text</span>()).<span class="hljs-title function_">toContain</span>(<span class="hljs-string">'Count: 1'</span>)
})

</code></pre>
<hr/>
<h3 data-id="heading-44">5. 避免在测试中使用复杂的真实 API 请求，应使用 Mock 或 Stub</h3>
<p>测试时不应依赖外部接口的真实请求，推荐使用 jest.mock、msw、sinon 等模拟数据，保证测试的独立性和稳定性。</p>
<p><strong>错误示例</strong></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-title function_">test</span>(<span class="hljs-string">'fetches data and renders'</span>, <span class="hljs-keyword">async</span> () =&gt; {
  <span class="hljs-keyword">const</span> wrapper = <span class="hljs-title function_">mount</span>(<span class="hljs-title class_">DataComponent</span>)
  <span class="hljs-keyword">await</span> wrapper.<span class="hljs-property">vm</span>.<span class="hljs-title function_">fetchData</span>() <span class="hljs-comment">// 真实请求导致测试不稳定</span>
  <span class="hljs-title function_">expect</span>(wrapper.<span class="hljs-title function_">text</span>()).<span class="hljs-title function_">toContain</span>(<span class="hljs-string">'Data loaded'</span>)
})

</code></pre>
<p><strong>正确示例</strong></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> axios <span class="hljs-keyword">from</span> <span class="hljs-string">'axios'</span>
jest.<span class="hljs-title function_">mock</span>(<span class="hljs-string">'axios'</span>)

<span class="hljs-title function_">test</span>(<span class="hljs-string">'fetches data and renders'</span>, <span class="hljs-keyword">async</span> () =&gt; {
  axios.<span class="hljs-property">get</span>.<span class="hljs-title function_">mockResolvedValue</span>({ <span class="hljs-attr">data</span>: { <span class="hljs-attr">items</span>: [<span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>] } })
  <span class="hljs-keyword">const</span> wrapper = <span class="hljs-title function_">mount</span>(<span class="hljs-title class_">DataComponent</span>)
  <span class="hljs-keyword">await</span> wrapper.<span class="hljs-property">vm</span>.<span class="hljs-title function_">fetchData</span>()
  <span class="hljs-title function_">expect</span>(wrapper.<span class="hljs-title function_">text</span>()).<span class="hljs-title function_">toContain</span>(<span class="hljs-string">'a'</span>)
})

</code></pre>
<hr/>
<h3 data-id="heading-45">6. 组件依赖的异步行为应通过 Mock 异步函数进行控制</h3>
<p>若组件依赖异步方法（如定时器、异步 API），应在测试中 Mock 这些异步行为，避免测试时间过长或不稳定。</p>
<p><strong>错误示例</strong></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-title function_">test</span>(<span class="hljs-string">'auto refresh updates data'</span>, <span class="hljs-keyword">async</span> () =&gt; {
  <span class="hljs-keyword">const</span> wrapper = <span class="hljs-title function_">mount</span>(<span class="hljs-title class_">AutoRefresh</span>)
  <span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function"><span class="hljs-params">r</span> =&gt;</span> <span class="hljs-built_in">setTimeout</span>(r, <span class="hljs-number">5000</span>)) <span class="hljs-comment">// 测试过慢且不确定</span>
  <span class="hljs-title function_">expect</span>(wrapper.<span class="hljs-title function_">text</span>()).<span class="hljs-title function_">toContain</span>(<span class="hljs-string">'Refreshed'</span>)
})

</code></pre>
<p><strong>正确示例</strong></p>
<pre><code class="hljs language-ts" lang="ts">jest.<span class="hljs-title function_">useFakeTimers</span>()

<span class="hljs-title function_">test</span>(<span class="hljs-string">'auto refresh updates data'</span>, <span class="hljs-keyword">async</span> () =&gt; {
  <span class="hljs-keyword">const</span> wrapper = <span class="hljs-title function_">mount</span>(<span class="hljs-title class_">AutoRefresh</span>)
  jest.<span class="hljs-title function_">advanceTimersByTime</span>(<span class="hljs-number">5000</span>)
  <span class="hljs-keyword">await</span> <span class="hljs-title function_">nextTick</span>()
  <span class="hljs-title function_">expect</span>(wrapper.<span class="hljs-title function_">text</span>()).<span class="hljs-title function_">toContain</span>(<span class="hljs-string">'Refreshed'</span>)
  jest.<span class="hljs-title function_">useRealTimers</span>()
})

</code></pre>
<hr/>
<h3 data-id="heading-46">7. 使用快照测试时应谨慎，避免大规模快照导致维护困难</h3>
<p>快照测试适合对关键 UI 做稳定性检测，但不应滥用，避免包含无关紧要的 DOM 变动。</p>
<p><strong>错误示例</strong></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-title function_">test</span>(<span class="hljs-string">'renders full component snapshot'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> wrapper = <span class="hljs-title function_">mount</span>(<span class="hljs-title class_">ComplexComponent</span>)
  <span class="hljs-title function_">expect</span>(wrapper.<span class="hljs-title function_">html</span>()).<span class="hljs-title function_">toMatchSnapshot</span>() <span class="hljs-comment">// 快照过大，难维护</span>
})

</code></pre>
<p><strong>正确示例</strong></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-title function_">test</span>(<span class="hljs-string">'renders header snapshot only'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> wrapper = <span class="hljs-title function_">mount</span>(<span class="hljs-title class_">ComplexComponent</span>)
  <span class="hljs-title function_">expect</span>(wrapper.<span class="hljs-title function_">find</span>(<span class="hljs-string">'header'</span>).<span class="hljs-title function_">html</span>()).<span class="hljs-title function_">toMatchSnapshot</span>()
})

</code></pre>
<hr/>
<h3 data-id="heading-47">8. 单元测试中避免使用全局依赖，推荐注入依赖或使用 provide/inject Mock</h3>
<p>Vue3 组件可能依赖全局插件或 provide/inject，测试时应 Mock 这些依赖，避免测试受全局状态影响。</p>
<p><strong>错误示例</strong></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-title function_">test</span>(<span class="hljs-string">'uses global i18n'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> wrapper = <span class="hljs-title function_">mount</span>(<span class="hljs-title class_">ComponentUsingI18</span>n)
  <span class="hljs-title function_">expect</span>(wrapper.<span class="hljs-title function_">text</span>()).<span class="hljs-title function_">toContain</span>(<span class="hljs-string">'Hello'</span>) <span class="hljs-comment">// 依赖真实 i18n，环境复杂</span>
})

</code></pre>
<p><strong>正确示例</strong></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> { createI18n } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue-i18n'</span>

<span class="hljs-keyword">const</span> i18n = <span class="hljs-title function_">createI18n</span>({ <span class="hljs-attr">locale</span>: <span class="hljs-string">'en'</span>, <span class="hljs-attr">messages</span>: { <span class="hljs-attr">en</span>: { <span class="hljs-attr">hello</span>: <span class="hljs-string">'Hello'</span> } } })

<span class="hljs-title function_">test</span>(<span class="hljs-string">'uses mocked i18n'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> wrapper = <span class="hljs-title function_">mount</span>(<span class="hljs-title class_">ComponentUsingI18</span>n, {
    <span class="hljs-attr">global</span>: { <span class="hljs-attr">plugins</span>: [i18n] }
  })
  <span class="hljs-title function_">expect</span>(wrapper.<span class="hljs-title function_">text</span>()).<span class="hljs-title function_">toContain</span>(<span class="hljs-string">'Hello'</span>)
})
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[我觉得可以试试 TOON —— 一个为 LLM 而生的极致压缩数据格式]]></title>    <link>https://juejin.cn/post/7569920331118657576</link>    <guid>https://juejin.cn/post/7569920331118657576</guid>    <pubDate>2025-11-08T09:03:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7569920331118657576" data-draft-id="7569895433235152911" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="我觉得可以试试 TOON —— 一个为 LLM 而生的极致压缩数据格式"/> <meta itemprop="keywords" content="前端,后端,架构"/> <meta itemprop="datePublished" content="2025-11-08T09:03:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="老码小张"/> <meta itemprop="url" content="https://juejin.cn/user/976022052799405"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            我觉得可以试试 TOON —— 一个为 LLM 而生的极致压缩数据格式
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/976022052799405/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    老码小张
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-08T09:03:21.000Z" title="Sat Nov 08 2025 09:03:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>有时候我真觉得，开发这行越来越像“数据运输业”。
我们每天都在运数据：前端到后端、后端到数据库、数据库再到模型。
只是现在的运输成本，不再是网络带宽，而是——<strong>LLM 的 token 费</strong>。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7961b61e8bb64f0b80133de9253afb10~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ICB56CB5bCP5byg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763197401&amp;x-signature=pUQeh0u%2ByfDbmRSnRgSokosbQSU%3D" alt="" loading="lazy"/></p>
<p>几毛钱一次 API，看着不心疼。
可一旦项目跑到几百上千次调用，就开始肉疼。
于是，有人动了脑筋：<strong>能不能在不损失语义的前提下，把 JSON 压得更紧？</strong></p>
<p>这，就是 TOON（Token-Oriented Object Notation） 想解决的问题。</p>
<hr/>
<h3 data-id="heading-0">一、JSON 的问题不在“好不好”，而在“贵不贵”</h3>
<p>JSON 是我们这些程序员的老朋友了。
它直观、标准、到处都能解析。
但问题在于——<strong>它太啰嗦了。</strong></p>
<p>看下面这段数据：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"users"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span> <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Alice"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"role"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"admin"</span> <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span> <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Bob"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"role"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"user"</span> <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>每一行都在重复 <code>id</code>, <code>name</code>, <code>role</code>，这在 LLM 里就意味着重复的 token。
你可能没意识到：LLM 看到 <code>"role": "admin"</code>，是要一个个词元分开的。
比如 <code>{</code>、<code>"role"</code>, <code>":"</code>, <code>"admin"</code>——全算钱。</p>
<p>如果你每天要给模型塞几百条这样的结构数据，那真是白花花的钱往外流。</p>
<hr/>
<h3 data-id="heading-1">二、TOON 是个什么玩意？</h3>
<p>一句话：
<strong>TOON 是一种为大模型优化的“压缩版 JSON”。</strong></p>
<p>举个例子，它会把上面的 JSON 写成这样：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">users</span>[2]{<span class="hljs-built_in">id</span>,name,role}:
  1,Alice,admin
  2,Bob,user
</code></pre>
<p>看到没？没有花哨的引号，没有重复的 key。
看起来像 CSV，又像 YAML，但其实都不是。</p>
<p>它的几个特点特别有意思：</p>
<ul>
<li><strong>结构简洁</strong>：像 YAML 一样靠缩进，不靠大括号。</li>
<li><strong>数组声明清晰</strong>：<code>users[2]{...}</code> 一眼就能看出长度。</li>
<li><strong>字段只声明一次</strong>：下面直接数据行，干净利落。</li>
<li><strong>LLM 解析更友好</strong>：模型一看就知道“哦，这是一张表”。</li>
</ul>
<hr/>
<h3 data-id="heading-2">三、这玩意真的省钱吗？</h3>
<p>官方的基准测试挺狠。
他们用 GPT-5 的 tokenizer 测了一堆结构数据，结果如下：</p>
<ul>
<li>对大数组（上百条结构相同的对象），<strong>token 减少 30%–60%</strong></li>
<li>对半结构化数据（部分字段不统一），<strong>减少约 15%–30%</strong></li>
<li>对纯表格类数据（类似 CSV），<strong>略大 5% 左右，但更可靠</strong></li>
</ul>
<p>意思是：
如果你是批量喂模型的，比如知识库 embedding、RAG 文档、批量问答输入，TOON 能让你的调用成本直接少一半。
这在预算紧张的公司里，简直是省命的优化。</p>
<hr/>
<h3 data-id="heading-3">四、但别太激动，TOON 也不是万能药</h3>
<p>我喜欢它，但我也要实话实说。</p>
<p>TOON 有几个“坑点”：</p>
<ol>
<li>
<p><strong>结构必须统一</strong>：
也就是说，数组里的对象字段要完全一样，否则格式就乱了。</p>
</li>
<li>
<p><strong>深层嵌套结构不划算</strong>：
如果你的 JSON 是那种嵌套好几层的配置树，那 TOON 的缩进反而更占 token。</p>
</li>
<li>
<p><strong>生态还在起步</strong>：
TOON 目前有 TypeScript SDK 和 CLI 工具，但生态远不如 JSON 成熟。
想用在 Python 或 Java 里？要么自己封装，要么等等。</p>
</li>
<li>
<p><strong>可读性不是人人喜欢</strong>：
有些同事第一次看到会问：“这 CSV 谁写的？”😂</p>
</li>
</ol>
<hr/>
<h3 data-id="heading-4">五、来点实战：怎么用？</h3>
<p>假设你装了包：</p>
<pre><code class="hljs language-bash" lang="bash">pnpm add @toon-format/toon
</code></pre>
<p>简单一行代码就能转：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> { encode } <span class="hljs-keyword">from</span> <span class="hljs-string">'@toon-format/toon'</span>

<span class="hljs-keyword">const</span> data = {
  <span class="hljs-attr">users</span>: [
    { <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'Alice'</span>, <span class="hljs-attr">role</span>: <span class="hljs-string">'admin'</span> },
    { <span class="hljs-attr">id</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'Bob'</span>, <span class="hljs-attr">role</span>: <span class="hljs-string">'user'</span> },
  ]
}

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">encode</span>(data))
</code></pre>
<p>输出就是：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">users</span>[2]{<span class="hljs-built_in">id</span>,name,role}:
  1,Alice,admin
  2,Bob,user
</code></pre>
<p>还可以反向解码回来：</p>
<pre><code class="hljs language-bash" lang="bash">npx @toon-format/cli data.toon --decode
</code></pre>
<p>如果想看 token 节省情况，加个 <code>--stats</code>：</p>
<pre><code class="hljs language-bash" lang="bash">npx @toon-format/cli input.json --stats
</code></pre>
<p>它会告诉你：“节省 48% token”，非常爽。</p>
<hr/>
<h3 data-id="heading-5">六、我个人的看法：TOON 是个信号</h3>
<p>我不认为 TOON 会取代 JSON。
但我认为它代表了一个趋势——
<strong>开发者开始认真对待 token 成本和模型输入结构了。</strong></p>
<p>过去几年，我们讨论优化时，都是“算法优化”、“前端性能优化”；
而未来几年，“<strong>提示结构优化（Prompt Structuring）</strong>”会变成一种新工程能力。</p>
<p>你看，过去我们在传输层压缩数据；
现在，我们在<strong>语义层压缩思维</strong>。
TOON 正好踩在这个分界点上。</p>
<hr/>
<h3 data-id="heading-6">七、习惯性的总结</h3>
<p>TOON 适合：</p>
<ul>
<li>给大模型批量输入结构化数据（表格类、日志类）</li>
<li>想减少 token 成本的 AI 应用</li>
<li>构建 RAG、Agent、自动化系统的开发者</li>
</ul>
<p>不适合：</p>
<ul>
<li>配置文件、树状嵌套结构</li>
<li>小型一次性输入（节省不明显）</li>
<li>要求通用生态兼容的生产系统</li>
</ul>
<p>一句话：
<strong>TOON 更像是 LLM 时代的“二级语言”——介于 JSON 和 Prompt 之间的那层中间语。</strong></p>
<hr/>
<p>我知道这类格式层出不穷，很多人会觉得“这又是个玩票的项目”。
但说实话，我挺喜欢这种“工程师式浪漫”——
当别人在追求更大的模型、更强的算力，总有人悄悄在研究：
<strong>怎么用更少的词，让机器更懂人话。</strong></p>
<hr/>
<blockquote>
<p>🧩 项目地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftoon-format%2Ftoon" target="_blank" title="https://github.com/toon-format/toon" ref="nofollow noopener noreferrer">github.com/toon-format…</a>
推荐朋友们收藏一下，
这可能是你未来写 LLM 工具时，用得最多的一种“小众神器”。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[寥寥几行代码实现 SwiftUI 超丝滑弹窗转场动画]]></title>    <link>https://juejin.cn/post/7569827641483460646</link>    <guid>https://juejin.cn/post/7569827641483460646</guid>    <pubDate>2025-11-08T05:08:01.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7569827641483460646" data-draft-id="7569827641483444262" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="寥寥几行代码实现 SwiftUI 超丝滑弹窗转场动画"/> <meta itemprop="keywords" content="Swift,SwiftUI,iOS"/> <meta itemprop="datePublished" content="2025-11-08T05:08:01.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="大熊猫侯佩"/> <meta itemprop="url" content="https://juejin.cn/user/4292907536222152"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            寥寥几行代码实现 SwiftUI 超丝滑弹窗转场动画
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4292907536222152/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    大熊猫侯佩
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-08T05:08:01.000Z" title="Sat Nov 08 2025 05:08:01 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cdd3d9805fc641d0963d283c02916581~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763183281&amp;x-signature=eXCfnBf0Z6VkOddmbXX0%2Be7JhLo%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h2 data-id="heading-0">概述</h2>
<p>各位微秃小码农们是否已经厌倦了 SwiftUI 中千篇一律、愣头愣脑的 sheet 弹窗动画？我们能否换一个范儿来弹出窗口呢？</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a1410bf6c4a845d6b259eeaa766cd19a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763183281&amp;x-signature=cO9uQFxrciYSp5np5gAuMIsTE68%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>答案是肯定！不仅可以，而且还很容易呢！</p>
<p>在本篇博文中，您将学到如下内容：</p>
<p>概述</p>
<ol>
<li>旧式转场的“尴尬”</li>
<li>SwiftUI 新转场范式
总结</li>
</ol>
<p>小伙伴们无需彷徨等待，让我们马上开始 SwiftUI 弹框转场动画的冒险之旅吧！
Let‘s go！！！;)</p>
<hr/>
<h2 data-id="heading-1">1. 旧式转场的“尴尬”</h2>
<p>在 SwiftUI 构建的 App 里，我们对于应用界面的总体架构来说有几种不同的组织方式。其中，弹出“模式视图”给人一种简单爽快的感觉，这是通过 sheet 修改器来实现的。</p>
<p>下面是通过 Cursor 提示词生成的 SheetContent 视图，用的是 chatGPT5 引擎：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// Sheet 内容视图</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">SheetContent</span>: <span class="hljs-title class_">View</span> {
    <span class="hljs-meta">@Environment</span>(\.dismiss) <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> dismiss    
    <span class="hljs-keyword">var</span> body: <span class="hljs-keyword">some</span> <span class="hljs-type">View</span> {
        <span class="hljs-type">NavigationView</span> {
            <span class="hljs-type">VStack</span>(spacing: <span class="hljs-number">30</span>) {
                <span class="hljs-comment">// 顶部图标 - 与源按钮匹配</span>
                <span class="hljs-type">Image</span>(systemName: <span class="hljs-string">"plus.circle.fill"</span>)
                    .font(.system(size: <span class="hljs-number">100</span>))
                    .foregroundColor(.blue)
                    .padding(.top, <span class="hljs-number">50</span>)
                
                <span class="hljs-type">Text</span>(<span class="hljs-string">"Zoom Transition 成功!"</span>)
                    .font(.title)
                    .fontWeight(.bold)
                
                <span class="hljs-type">Text</span>(<span class="hljs-string">"这个界面通过 Zoom 动画从底部按钮展开"</span>)
                    .font(.body)
                    .foregroundColor(.secondary)
                    .multilineTextAlignment(.center)
                    .padding(.horizontal)
                
                <span class="hljs-comment">// 示例内容</span>
                <span class="hljs-type">VStack</span>(spacing: <span class="hljs-number">16</span>) {
                    <span class="hljs-type">HStack</span> {
                        <span class="hljs-type">Image</span>(systemName: <span class="hljs-string">"checkmark.circle.fill"</span>)
                            .foregroundColor(.green)
                        <span class="hljs-type">Text</span>(<span class="hljs-string">"动画效果流畅"</span>)
                        <span class="hljs-type">Spacer</span>()
                    }
                    .padding()
                    .background(<span class="hljs-type">Color</span>.green.opacity(<span class="hljs-number">0.1</span>))
                    .cornerRadius(<span class="hljs-number">10</span>)
                    
                    <span class="hljs-type">HStack</span> {
                        <span class="hljs-type">Image</span>(systemName: <span class="hljs-string">"arrow.up.circle.fill"</span>)
                            .foregroundColor(.blue)
                        <span class="hljs-type">Text</span>(<span class="hljs-string">"从源元素展开"</span>)
                        <span class="hljs-type">Spacer</span>()
                    }
                    .padding()
                    .background(<span class="hljs-type">Color</span>.blue.opacity(<span class="hljs-number">0.1</span>))
                    .cornerRadius(<span class="hljs-number">10</span>)
                }
                .padding(.horizontal)
                
                <span class="hljs-type">Spacer</span>()
                
                <span class="hljs-comment">// 关闭按钮</span>
                <span class="hljs-type">Button</span>(<span class="hljs-string">"关闭"</span>) {
                    dismiss()
                }
                .font(.title2)
                .foregroundColor(.white)
                .padding()
                .background(<span class="hljs-type">Color</span>.blue)
                .cornerRadius(<span class="hljs-number">10</span>)
                .padding(.bottom, <span class="hljs-number">50</span>)
            }
            .navigationTitle(<span class="hljs-string">"详情"</span>)
            .navigationBarTitleDisplayMode(.inline)
            .toolbar {
                <span class="hljs-type">ToolbarItem</span>(placement: .navigationBarTrailing) {
                    <span class="hljs-type">Button</span>(<span class="hljs-string">"完成"</span>) {
                        dismiss()
                    }
                }
            }
        }
    }
}
</code></pre>
<p>生成的界面如下所示：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/067f9114ccea44f8829fde5279063079~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763183281&amp;x-signature=H29I5Tvo%2FChBVSyItEwjyNfZnpQ%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>看起来 AI 生成的代码还不错吧？</p>
<p>接下来，再由 chatGPT 5 大脑来搞定我们的主视图：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 主内容视图</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">MainView</span>: <span class="hljs-title class_">View</span> {
    <span class="hljs-keyword">var</span> body: <span class="hljs-keyword">some</span> <span class="hljs-type">View</span> {
        <span class="hljs-type">NavigationView</span> {
            <span class="hljs-type">VStack</span>(spacing: <span class="hljs-number">20</span>) {
                <span class="hljs-type">Text</span>(<span class="hljs-string">"Zoom Transition 演示"</span>)
                    .font(.largeTitle)
                    .fontWeight(.bold)
                
                <span class="hljs-type">Text</span>(<span class="hljs-string">"点击底部的加号按钮"</span>)
                    .font(.title2)
                    .foregroundColor(.secondary)
                
                <span class="hljs-type">Spacer</span>()
                
                <span class="hljs-comment">// 一些示例内容</span>
                <span class="hljs-type">VStack</span>(spacing: <span class="hljs-number">16</span>) {
                    <span class="hljs-type">HStack</span> {
                        <span class="hljs-type">Image</span>(systemName: <span class="hljs-string">"star.fill"</span>)
                            .foregroundColor(.yellow)
                        <span class="hljs-type">Text</span>(<span class="hljs-string">"这是一个示例界面"</span>)
                        <span class="hljs-type">Spacer</span>()
                    }
                    .padding()
                    .background(<span class="hljs-type">Color</span>.gray.opacity(<span class="hljs-number">0.1</span>))
                    .cornerRadius(<span class="hljs-number">10</span>)
                    
                    <span class="hljs-type">HStack</span> {
                        <span class="hljs-type">Image</span>(systemName: <span class="hljs-string">"heart.fill"</span>)
                            .foregroundColor(.red)
                        <span class="hljs-type">Text</span>(<span class="hljs-string">"点击底部按钮查看 Zoom 效果"</span>)
                        <span class="hljs-type">Spacer</span>()
                    }
                    .padding()
                    .background(<span class="hljs-type">Color</span>.gray.opacity(<span class="hljs-number">0.1</span>))
                    .cornerRadius(<span class="hljs-number">10</span>)
                }
                .padding(.horizontal)
                
                <span class="hljs-type">Spacer</span>()
            }
            .navigationTitle(<span class="hljs-string">"主界面"</span>)
        }
    }
}
</code></pre>
<p>最后，同样让 AI 操刀生成 ZoomTransitionDemo 视图，它将会是 sheet 弹窗的绝对主宰（驱动器）：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// Zoom transition 演示</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">ZoomTransitionDemo</span>: <span class="hljs-title class_">View</span> {    
    <span class="hljs-comment">// 控制 sheet 的显示状态</span>
    <span class="hljs-meta">@State</span> <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> isPresentedNoAnim <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>
    
    <span class="hljs-keyword">var</span> body: <span class="hljs-keyword">some</span> <span class="hljs-type">View</span> {
        <span class="hljs-type">MainView</span>()
            .safeAreaInset(edge: .bottom) {
                <span class="hljs-type">HStack</span> {
                    <span class="hljs-type">Button</span>(action: {
                        isPresentedNoAnim <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>
                    }) {
                        <span class="hljs-type">VStack</span>(spacing: <span class="hljs-number">10</span>) {
                            <span class="hljs-type">Text</span>(<span class="hljs-string">"旧式转场"</span>)
                            <span class="hljs-type">Image</span>(systemName: <span class="hljs-string">"plus.circle.fill"</span>)
                                .font(.largeTitle.weight(.black))
                        }
                        .font(.title3.bold())
                        .foregroundStyle(.red.gradient)
                    }
                    
                }
            }
            .sheet(isPresented: <span class="hljs-variable">$isPresentedNoAnim</span>) {
                <span class="hljs-type">SheetContent</span>()
            }
    }
}
</code></pre>
<p>现在，点击我们示例 App 主界面底部的 + 按钮，即可 sheet 蹦出急不可耐的小视图了：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5e7a777879924437a5b6283daae0fb9d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763183281&amp;x-signature=fct8Q6fGEN5%2BepMhWd4fAWrMgc0%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>不过，这种 sheet 弹出视图的转场方式貌似有点“腻歪”，它太其貌不扬，我们甚至有些审美疲劳了。</p>
<p>还好，Apple 及时为我们提供了全新的弹窗丝滑过渡方式，无需增加繁琐的撸码，我们即可实现漂亮的转场效果。</p>
<h2 data-id="heading-2">2. SwiftUI  新转场范式</h2>
<p>从 iOS 18（SwiftUI 6.0）开始，苹果为导航转场增加了全新的 navigationTransition 修改器方法，它的功用很简单——设置视图导航的转场样式：
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bc0a629f9bd24e75856a9e3c6d21749c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763183281&amp;x-signature=k2txTzJXZJJt%2FSXY7y3fr5zJuNI%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>除此之外，我们还需要在导航的源视图上使用 matchedTransitionSource 修改器方法才能确保“如鱼得水”：<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6ad99dc1a93d48fe8c0b64c81311b86c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763183281&amp;x-signature=004Q%2BlJLRn7Cd1IPq%2Bku9E2ZBFI%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>让我们利用上面两个修改器方法，将 ZoomTransitionDemo 视图的原代码进行些许修改：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">ZoomTransitionDemo</span>: <span class="hljs-title class_">View</span> {
    <span class="hljs-comment">// 用于定义共享坐标空间的命名空间</span>
    <span class="hljs-meta">@Namespace</span> <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> namespace
    
    <span class="hljs-comment">// 控制 sheet 的显示状态</span>
    <span class="hljs-meta">@State</span> <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> isPresented <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>
    
    <span class="hljs-keyword">var</span> body: <span class="hljs-keyword">some</span> <span class="hljs-type">View</span> {
        <span class="hljs-type">MainView</span>()
            .safeAreaInset(edge: .bottom) {
                <span class="hljs-type">HStack</span> {
                    <span class="hljs-type">Button</span>(action: {
                        isPresented <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>
                    }) {
                        <span class="hljs-type">VStack</span>(spacing: <span class="hljs-number">10</span>) {
                            <span class="hljs-type">Text</span>(<span class="hljs-string">"顺滑转场"</span>)
                            <span class="hljs-type">Image</span>(systemName: <span class="hljs-string">"plus.circle.fill"</span>)
                                .font(.largeTitle.weight(.black))
                        }
                        .font(.title3.bold())
                        .foregroundStyle(.blue.gradient)
                    }
                    .matchedTransitionSource(id: <span class="hljs-string">"transition-id"</span>, in: namespace)
                    .padding(.trailing)
                }
            }
            .sheet(isPresented: <span class="hljs-variable">$isPresented</span>) {
                <span class="hljs-type">SheetContent</span>()
                    .navigationTransition(.zoom(sourceID: <span class="hljs-string">"transition-id"</span>, in: namespace))
            }
    }
}
</code></pre>
<p>看到了吗？我们只是在原来主视图的弹出视图和源视图上增加了对应的视图修改器方法即可大功告成！</p>
<p>现在，欣赏一下全新的弹窗转场动画，小伙伴们是否爱了爱了呢？❤️</p>
<p>棒棒哒！💯</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ea3ee343a54342a6a23638f6bd2ee0d8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763183281&amp;x-signature=lrHj3SXC83uGG1XLc2Klnin%2FL78%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h2 data-id="heading-3">总结</h2>
<p>在本篇博文中，我们讨论了如何在 iOS 18+（SwiftUI 6）中仅用寥寥几行代码就让 sheet 弹窗转场动画有了焕然一新的进化，不禁让人眼前一亮！</p>
<p>感谢观赏，我们再会啦！8-)</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[# 关于初学者对于JS异步编程十大误区]]></title>    <link>https://juejin.cn/post/7569864390943490099</link>    <guid>https://juejin.cn/post/7569864390943490099</guid>    <pubDate>2025-11-08T10:45:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7569864390943490099" data-draft-id="7568425510793428992" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="# 关于初学者对于JS异步编程十大误区"/> <meta itemprop="keywords" content="前端,JavaScript,面试"/> <meta itemprop="datePublished" content="2025-11-08T10:45:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="拉不动的猪"/> <meta itemprop="url" content="https://juejin.cn/user/1429793504759630"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            # 关于初学者对于JS异步编程十大误区
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1429793504759630/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    拉不动的猪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-08T10:45:51.000Z" title="Sat Nov 08 2025 10:45:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#5f6368;background-image:linear-gradient(90deg,rgba(240,191,213,.1) 3%,transparent 0),linear-gradient(1turn,rgba(240,191,213,.1) 3%,transparent 0);background-size:20px 20px;background-position:50%;letter-spacing:1px;word-spacing:1px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{position:relative;line-height:1.5;margin-top:35px;margin-bottom:10px;padding-left:50px;padding-bottom:5px;color:#5f6368}.markdown-body h1:before,.markdown-body h2:before,.markdown-body h3:before,.markdown-body h4:before,.markdown-body h5:before,.markdown-body h6:before{position:absolute;left:0;display:block;content:""}.markdown-body h1{font-size:32px;margin-bottom:5px}.markdown-body h1:before{top:0;content:"🦄";font-size:32px}.markdown-body h2{padding-bottom:24px;border-bottom:1px solid #ececec}.markdown-body h2:before{top:0;left:8px;content:"🐳";font-size:24px}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h3:before{top:-2px;left:8px;content:"🐄";font-size:20px}.markdown-body h4{font-size:16px}.markdown-body h4:before{top:-2px;left:8px;content:"🦥";font-size:18px}.markdown-body h5{font-size:14px}.markdown-body h5:before{top:-2px;left:9px;content:"🦩";font-size:16px}.markdown-body h6{font-size:12px;margin-top:5px}.markdown-body h6:before{top:-1px;left:10px;content:"🐧";font-size:14px}.markdown-body p{line-height:1.9;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid rgba(253,121,168,.5);margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#a6accd;background:#292d3e;border-radius:8px}.markdown-body a{text-decoration:none;color:#fd79a8;border-bottom:1px solid #fd79a8;padding:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(253,121,168,.1);color:#ee69a9}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body th{color:#fd79a8}.markdown-body th,.markdown-body tr:hover{background:rgba(253,121,168,.1)}.markdown-body td{min-width:120px}.markdown-body blockquote{position:relative;color:#666;padding:23px;margin:22px 0;border-left:4px solid #ee69a9;background-color:rgba(253,121,168,.1)}.markdown-body blockquote:after,.markdown-body blockquote:before{position:absolute;display:block;font-size:27px;color:#fd79a8;opacity:.8}.markdown-body blockquote:before{left:10px;top:0;content:"❝"}.markdown-body blockquote:after{right:10px;bottom:0;content:"❞"}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body strong{position:relative;color:#fd79a8}.markdown-body strong:before{content:"· "}.markdown-body strong:after{content:" ·"}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit;color:#fd79a8}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#ee69a9}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}</style><style data-highlight="" data-highlight-key="vs2015">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#1e1e1e;color:#dcdcdc}.hljs-keyword,.hljs-link,.hljs-literal,.hljs-name,.hljs-symbol{color:#569cd6}.hljs-link{text-decoration:underline}.hljs-built_in,.hljs-type{color:#4ec9b0}.hljs-class,.hljs-number{color:#b8d7a3}.hljs-meta-string,.hljs-string{color:#d69d85}.hljs-regexp,.hljs-template-tag{color:#9a5334}.hljs-formula,.hljs-function,.hljs-params,.hljs-subst,.hljs-title{color:#dcdcdc}.hljs-comment,.hljs-quote{color:#57a64a;font-style:italic}.hljs-doctag{color:#608b4e}.hljs-meta,.hljs-meta-keyword,.hljs-tag{color:#9b9b9b}.hljs-template-variable,.hljs-variable{color:#bd63c5}.hljs-attr,.hljs-attribute,.hljs-builtin-name{color:#9cdcfe}.hljs-section{color:gold}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-bullet,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-id,.hljs-selector-pseudo,.hljs-selector-tag{color:#d7ba7d}.hljs-addition{background-color:#144212}.hljs-addition,.hljs-deletion{display:inline-block;width:100%}.hljs-deletion{background-color:#600}</style><p>前端开发中 Promise 与异步编程还存在大量易混淆、易踩坑的场景，以下按「基础概念」「方法使用」「异步协作」「与其他机制配合」四大类整理，附带代码示例和正确逻辑：</p>
<h2 data-id="heading-0">一、基础概念类误区</h2>
<h3 data-id="heading-1">误区 1：“Promise 新建后会立即执行，所以是同步的”</h3>
<ul>
<li>
<p><strong>错误理解</strong>：认为 <code>new Promise((resolve) =&gt; { ... })</code> 里的代码是同步的，或 Promise 整体是 “同步工具”。</p>
</li>
<li>
<p><strong>真实逻辑</strong>：Promise 的「执行器函数」（<code>new Promise</code> 里的回调）是<strong>立即同步执行</strong>的，但 Promise 的「回调函数」（<code>.then()</code>/<code>.catch()</code>）是<strong>异步微任务</strong>，会在当前同步代码执行完后才触发。</p>
</li>
<li>
<p><strong>示例验证</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'1: 同步开始'</span>);
<span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'2: Promise 执行器（同步）'</span>);
  <span class="hljs-title function_">resolve</span>();
}).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'4: .then() 回调（异步微任务）'</span>);
});
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'3: 同步结束'</span>);
<span class="hljs-comment">// 输出顺序：1 → 2 → 3 → 4（而非 1→2→4→3）</span>
</code></pre>
</li>
</ul>
<h3 data-id="heading-2">误区 2：“Promise 状态一旦确定，后续调用 .then () 不会触发”</h3>
<ul>
<li>
<p><strong>错误理解</strong>：认为 Promise 从 <code>pending</code> 变为 <code>fulfilled</code>/<code>rejected</code> 后，再调用 <code>.then()</code> 会 “失效”。</p>
</li>
<li>
<p><strong>真实逻辑</strong>：Promise 状态是「不可逆且记忆的」—— 状态确定后，后续再绑定的 <code>.then()</code>/<code>.catch()</code> 会<strong>立即触发</strong>（基于已记忆的结果）。</p>
</li>
<li>
<p><strong>示例验证</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 1. 先创建 Promise 并让其成功</span>
<span class="hljs-keyword">const</span> p = <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-string">'已成功'</span>);

<span class="hljs-comment">// 2. 1秒后再绑定 .then()</span>
<span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
  p.<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(res)); <span class="hljs-comment">// 1秒后输出 '已成功'（正常触发）</span>
}, <span class="hljs-number">1000</span>);
</code></pre>
</li>
</ul>
<h3 data-id="heading-3">误区 3：“Promise 链中，return 后的值会直接传给下一个 .then ()，无需 resolve”</h3>
<ul>
<li>
<p><strong>错误理解</strong>：认为在 <code>.then()</code> 中 return 普通值（非 Promise）时，需要手动调用 <code>resolve()</code> 才能传递，或 return Promise 时需要额外处理。</p>
</li>
<li>
<p><strong>真实逻辑</strong>：<code>.then()</code> 会<strong>自动包装返回值</strong>—— 若 return 普通值（如数字、对象），会自动用 <code>Promise.resolve(返回值)</code> 包装；若 return Promise，会等待该 Promise 状态确定后再传递结果。</p>
</li>
<li>
<p><strong>示例验证</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-number">1</span>)
  .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> {
    <span class="hljs-keyword">return</span> res * <span class="hljs-number">2</span>; <span class="hljs-comment">// 普通值，自动包装为 Promise.resolve(2)</span>
  })
  .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">resolve</span>(res * <span class="hljs-number">2</span>), <span class="hljs-number">500</span>)); <span class="hljs-comment">// 返回 Promise</span>
  })
  .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(res)); <span class="hljs-comment">// 500ms 后输出 4（无需手动 resolve）</span>
</code></pre>
</li>
</ul>
<h2 data-id="heading-4">二、方法使用类误区</h2>
<h3 data-id="heading-5">误区 4：“Promise.all () 会等待所有任务完成，包括失败的”</h3>
<ul>
<li>
<p><strong>错误理解</strong>：认为 <code>Promise.all([p1, p2, p3])</code> 会等 p1、p2、p3 全部执行完（无论成功失败），再返回结果。</p>
</li>
<li>
<p><strong>真实逻辑</strong>：<code>Promise.all()</code> 是「快速失败」机制 ——<strong>只要有一个任务变为 rejected，会立即触发 .catch ()，并忽略后续其他任务的结果</strong>，不会等待所有任务完成。</p>
</li>
<li>
<p><strong>反例验证</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> p1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">resolve</span>(<span class="hljs-string">'p1'</span>), <span class="hljs-number">1000</span>));
<span class="hljs-keyword">const</span> p2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">_, reject</span>) =&gt;</span> <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">reject</span>(<span class="hljs-string">'p2 失败'</span>), <span class="hljs-number">500</span>));
<span class="hljs-keyword">const</span> p3 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">resolve</span>(<span class="hljs-string">'p3'</span>), <span class="hljs-number">1500</span>));

<span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>([p1, p2, p3])
  .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(res)) <span class="hljs-comment">// 不执行</span>
  .<span class="hljs-keyword">catch</span>(<span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(err)); <span class="hljs-comment">// 500ms 后输出 'p2 失败'（p1、p3 仍在执行，但结果被忽略）</span>
</code></pre>
</li>
<li>
<p><strong>正确需求</strong>：若需等待所有任务完成（无论成败），应使用 <code>Promise.allSettled()</code>。</p>
</li>
</ul>
<h3 data-id="heading-6">误区 5：“Promise.race () 只关心第一个成功的任务”</h3>
<ul>
<li>
<p><strong>错误理解</strong>：认为 <code>Promise.race()</code> 会筛选 “第一个成功的任务”，忽略第一个失败的任务。</p>
</li>
<li>
<p><strong>真实逻辑</strong>：<code>Promise.race()</code> 关心的是「第一个状态确定的任务」—— 无论该任务是 <code>fulfilled</code>（成功）还是 <code>rejected</code>（失败），只要第一个确定状态，就返回该结果。</p>
</li>
<li>
<p><strong>反例验证</strong>（超时控制场景易踩坑）：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 需求：接口请求3秒内成功则用结果，超时则提示失败</span>
<span class="hljs-keyword">const</span> request = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">_, reject</span>) =&gt;</span> <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">reject</span>(<span class="hljs-string">'接口报错'</span>), <span class="hljs-number">2000</span>)); <span class="hljs-comment">// 2秒后失败</span>
<span class="hljs-keyword">const</span> timeout = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">_, reject</span>) =&gt;</span> <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">reject</span>(<span class="hljs-string">'请求超时'</span>), <span class="hljs-number">3000</span>)); <span class="hljs-comment">// 3秒后超时</span>

<span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">race</span>([request, timeout])
  .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(res)) <span class="hljs-comment">// 不执行</span>
  .<span class="hljs-keyword">catch</span>(<span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(err)); <span class="hljs-comment">// 2秒后输出 '接口报错'（第一个确定状态的是失败任务）</span>
</code></pre>
</li>
</ul>
<h3 data-id="heading-7">误区 6：“.then () 的第二个参数（onRejected）与 .catch () 完全等价”</h3>
<ul>
<li>
<p><strong>错误理解</strong>：认为 <code>.then(res =&gt; {}, err =&gt; {})</code> 中的 <code>err =&gt; {}</code> 和单独的 <code>.catch(err =&gt; {})</code> 功能一样，可随意替换。</p>
</li>
<li>
<p><strong>真实逻辑</strong>：<code>.then()</code> 的第二个参数<strong>只能捕获其上游 Promise 本身的错误</strong>，无法捕获 <code>.then()</code> 第一个参数（<code>onFulfilled</code>）中的错误；而 <code>.catch()</code> 能捕获<strong>其上游所有链路的错误</strong>（包括前一个 <code>.then()</code> 中抛出的错误）。</p>
</li>
<li>
<p><strong>示例对比</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 情况1：用 .then() 第二个参数</span>
<span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-number">1</span>)
  .<span class="hljs-title function_">then</span>(
    <span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> { <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'then 里抛错'</span>); }, <span class="hljs-comment">// 第一个参数中抛错</span>
    <span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'捕获到:'</span>, err) <span class="hljs-comment">// 不执行（无法捕获前一个 then 的错误）</span>
  )
  .<span class="hljs-keyword">catch</span>(<span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'最终捕获:'</span>, err)); <span class="hljs-comment">// 执行，输出 'then 里抛错'</span>

<span class="hljs-comment">// 情况2：用 .catch()</span>
<span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-number">1</span>)
  .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> { <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'then 里抛错'</span>); })
  .<span class="hljs-keyword">catch</span>(<span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'捕获到:'</span>, err)); <span class="hljs-comment">// 执行，直接捕获 then 里的错误</span>
</code></pre>
</li>
<li>
<p><strong>结论</strong>：推荐用 <code>.catch()</code> 统一处理错误，而非 <code>.then()</code> 的第二个参数。</p>
</li>
</ul>
<h2 data-id="heading-8">三、异步协作类误区</h2>
<h3 data-id="heading-9">误区 7：“用 for 循环遍历执行 Promise，会按顺序触发”</h3>
<ul>
<li>
<p><strong>错误理解</strong>：认为用 <code>for</code> 循环调用多个返回 Promise 的函数，会等前一个执行完再执行下一个（顺序执行）。</p>
</li>
<li>
<p><strong>真实逻辑</strong>：<code>for</code> 循环是同步代码，会<strong>一次性触发所有 Promise</strong>，它们会并行执行（而非顺序），最终结果的顺序取决于任务本身的执行速度。</p>
</li>
<li>
<p><strong>反例验证</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 模拟异步任务：传入延迟时间，延迟后输出数字</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">delayTask</span>(<span class="hljs-params">num, delay</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(num);
    <span class="hljs-title function_">resolve</span>(num);
  }, delay));
}

<span class="hljs-comment">// 错误写法：一次性触发所有任务，并行执行</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt;= <span class="hljs-number">3</span>; i++) {
  <span class="hljs-title function_">delayTask</span>(i, <span class="hljs-number">1000</span>); <span class="hljs-comment">// 1秒后同时输出 1、2、3（而非 1→2→3 依次间隔1秒）</span>
}
</code></pre>
</li>
<li>
<p><strong>正确需求</strong>（顺序执行）：需用 <code>async/await + for 循环</code> 或 Promise 链式调用：</p>
<pre><code class="hljs language-perl" lang="perl">// 正确写法：async/await + <span class="hljs-keyword">for</span> 循环（顺序执行）
async function runSe<span class="hljs-string">q()</span> {
  <span class="hljs-keyword">for</span> (let i = <span class="hljs-number">1</span>; i &lt;= <span class="hljs-number">3</span>; i++) {
    await delayTask(i, <span class="hljs-number">1000</span>); <span class="hljs-regexp">//</span> <span class="hljs-number">1</span>秒后输出<span class="hljs-number">1</span> → 再等<span class="hljs-number">1</span>秒输出<span class="hljs-number">2</span> → 再等<span class="hljs-number">1</span>秒输出<span class="hljs-number">3</span>
  }
}
runSe<span class="hljs-string">q()</span>;
</code></pre>
</li>
</ul>
<h3 data-id="heading-10">误区 8：“Promise 链中，return 了错误就会触发下一个 .catch ()”</h3>
<ul>
<li>
<p><strong>错误理解</strong>：认为在 <code>.then()</code> 中 return 一个错误对象（如 <code>return new Error('错了')</code>），会自动触发下一个 <code>.catch()</code>。</p>
</li>
<li>
<p><strong>真实逻辑</strong>：只有当 Promise 状态变为 <code>rejected</code> 时才会触发 <code>.catch()</code>—— return 普通错误对象（非 <code>throw</code> 或 <code>reject</code>）会被视为「成功的结果」，包装成 <code>Promise.resolve(错误对象)</code>，不会触发 <code>.catch()</code>。</p>
</li>
<li>
<p><strong>示例验证</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>()
  .<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'return 错误对象'</span>); <span class="hljs-comment">// 视为成功结果，非 rejected</span>
  })
  .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'then 接收:'</span>, res)) <span class="hljs-comment">// 执行，输出 "Error: return 错误对象"</span>
  .<span class="hljs-keyword">catch</span>(<span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'catch 接收:'</span>, err)); <span class="hljs-comment">// 不执行</span>

<span class="hljs-comment">// 正确触发 catch 的方式：throw 或 return Promise.reject()</span>
<span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>()
  .<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'throw 错误'</span>); <span class="hljs-comment">// 触发 rejected</span>
    <span class="hljs-comment">// 或 return Promise.reject(new Error('reject 错误'));</span>
  })
  .<span class="hljs-keyword">catch</span>(<span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'catch 接收:'</span>, err)); <span class="hljs-comment">// 执行</span>
</code></pre>
</li>
</ul>
<h2 data-id="heading-11">四、与其他机制配合类误区</h2>
<h3 data-id="heading-12">误区 9：“async 函数里的所有错误，都能被外层 try...catch 捕获”</h3>
<ul>
<li>
<p><strong>错误理解</strong>：认为 <code>async function</code> 中所有代码的错误，只要用 <code>try...catch</code> 包裹函数调用，就能全部捕获。</p>
</li>
<li>
<p><strong>真实逻辑</strong>：<code>try...catch</code> 只能捕获 <code>async</code> 函数中「<code>await</code> 标记的 Promise 错误」和「同步错误」；若 <code>async</code> 函数中存在「未被 <code>await</code> 的 Promise 错误」，会成为「未处理的 Promise 拒绝」，无法被外层 <code>try...catch</code> 捕获。</p>
</li>
<li>
<p><strong>示例验证</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">asyncTask</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 错误1：未被 await 的 Promise 错误</span>
  <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">_, reject</span>) =&gt;</span> <span class="hljs-title function_">reject</span>(<span class="hljs-string">'未 await 的错误'</span>)); 
  <span class="hljs-comment">// 错误2：被 await 的 Promise 错误</span>
  <span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">_, reject</span>) =&gt;</span> <span class="hljs-title function_">reject</span>(<span class="hljs-string">'已 await 的错误'</span>));
}

<span class="hljs-keyword">try</span> {
  <span class="hljs-title function_">asyncTask</span>(); <span class="hljs-comment">// 调用 async 函数</span>
} <span class="hljs-keyword">catch</span> (err) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'捕获到:'</span>, err); <span class="hljs-comment">// 只捕获到 "已 await 的错误"，"未 await 的错误" 会成为未处理拒绝</span>
}
</code></pre>
</li>
</ul>
<h3 data-id="heading-13">误区 10：“setTimeout 里的 Promise 错误，能被外层 try...catch 捕获”</h3>
<ul>
<li>
<p><strong>错误理解</strong>：认为用 <code>try...catch</code> 包裹 <code>setTimeout</code>，就能捕获 <code>setTimeout</code> 回调中 Promise 的错误。</p>
</li>
<li>
<p><strong>真实逻辑</strong>：<code>setTimeout</code> 回调是「宏任务」，会在当前同步代码（包括 <code>try...catch</code>）执行完后才触发；Promise 错误属于「微任务」，会在宏任务回调内部的同步代码执行完后触发，二者不在同一执行上下文，外层 <code>try...catch</code> 无法捕获。</p>
</li>
<li>
<p><strong>示例验证</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">try</span> {
  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// 该 Promise 错误在宏任务回调中，外层 try...catch 已执行完毕</span>
    <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(<span class="hljs-string">'setTimeout 里的错误'</span>);
  }, <span class="hljs-number">1000</span>);
} <span class="hljs-keyword">catch</span> (err) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'捕获到:'</span>, err); <span class="hljs-comment">// 不执行</span>
}
</code></pre>
</li>
<li>
<p><strong>正确处理</strong>：需在 <code>setTimeout</code> 回调内部或 Promise 链中处理错误：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(<span class="hljs-string">'setTimeout 里的错误'</span>)
    .<span class="hljs-keyword">catch</span>(<span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'捕获到:'</span>, err)); <span class="hljs-comment">// 执行</span>
}, <span class="hljs-number">1000</span>);
</code></pre>
</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[五分钟内重复登录 QQ 号定位：数据结构选型与高效实现方案]]></title>    <link>https://juejin.cn/post/7569882385467129898</link>    <guid>https://juejin.cn/post/7569882385467129898</guid>    <pubDate>2025-11-08T03:14:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7569882385467129898" data-draft-id="7569821690773504042" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="五分钟内重复登录 QQ 号定位：数据结构选型与高效实现方案"/> <meta itemprop="keywords" content="后端,分布式"/> <meta itemprop="datePublished" content="2025-11-08T03:14:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="回家路上绕了弯"/> <meta itemprop="url" content="https://juejin.cn/user/536217404587134"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            五分钟内重复登录 QQ 号定位：数据结构选型与高效实现方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/536217404587134/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    回家路上绕了弯
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-08T03:14:23.000Z" title="Sat Nov 08 2025 03:14:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">五分钟内重复登录 QQ 号定位：数据结构选型与高效实现方案</h2>
<p>在 QQ 安全风控、用户行为分析、登录异常告警等场景中，“快速识别五分钟内重复登录两次的 QQ 号” 是核心需求 —— 既要处理亿级 QQ 号的高频登录请求（如高峰时段登录 QPS 达 10 万 +），又要保证判断延迟低于 10ms，还要避免无效数据占用过多内存。</p>
<p>本文将从 “业务需求拆解→数据结构对比→方案落地→优化扩展” 四个维度，讲清如何选对数据结构、设计高效方案，解决这一高频问题。</p>
<h3 data-id="heading-1">一、先拆需求：定位重复登录的核心诉求与边界</h3>
<p>在选数据结构前，必须先明确 “判断逻辑” 和 “性能约束”，避免方案偏离实际场景：</p>
<h4 data-id="heading-2">1. 核心判断逻辑</h4>
<p>对单个 QQ 号，需满足：</p>
<p>当前登录时间 - 最近一次登录时间 ≤ 300秒（5分钟）</p>
<p>→ 满足则判定为 “五分钟内重复登录两次”，需触发后续动作（如安全校验、日志记录）。</p>
<h4 data-id="heading-3">2. 关键性能约束</h4>
<ul>
<li><strong>低延迟</strong>：每次登录请求的 “重复判断” 耗时需≤10ms（不能影响用户登录体验）；</li>
</ul>

<ul>
<li><strong>高并发</strong>：支撑 10 万 + QPS 的登录请求（如早高峰、节假日登录峰值）；</li>
</ul>

<ul>
<li><strong>低内存</strong>：QQ 号总量超 10 亿，但多数账号长期不登录，需避免存储无效历史数据；</li>
</ul>

<ul>
<li><strong>时效性</strong>：仅需保留 “五分钟内的登录记录”，过期数据需自动清理（避免内存泄漏）。</li>
</ul>
<h4 data-id="heading-4">3. 边界场景</h4>
<ul>
<li>场景 1：QQ 号首次登录（无历史记录）→ 不判定为重复；</li>
</ul>

<ul>
<li>场景 2：QQ 号 5 分钟内第三次登录（如 10:00、10:02、10:04 登录）→ 10:02 和 10:04 均需判定为重复；</li>
</ul>

<ul>
<li>场景 3：QQ 号登录间隔 5 分 1 秒（10:00→10:05:01）→ 不判定为重复。</li>
</ul>
<h3 data-id="heading-5">二、数据结构选型：为什么 “哈希表 + 双端队列” 是最优解？</h3>
<p>要满足 “快速查询（找 QQ 号的历史登录时间）+ 快速清理（删过期记录）+ 低内存”，需对比常见数据结构的适配性：</p>





















































<table><thead><tr><th>数据结构</th><th>查找效率</th><th>插入效率</th><th>过期清理效率</th><th>内存占用</th><th>适配性结论</th></tr></thead><tbody><tr><td>数组</td><td>O(n)</td><td>O(1)</td><td>O(n)</td><td>低</td><td>差（查找需遍历）</td></tr><tr><td>单向链表</td><td>O(n)</td><td>O(1)</td><td>O(n)</td><td>低</td><td>差（查找需遍历）</td></tr><tr><td>普通哈希表</td><td>O(1)</td><td>O(1)</td><td>O(n)</td><td>中</td><td>一般（清理需遍历所有记录）</td></tr><tr><td>哈希表 + 双端队列</td><td>O(1)</td><td>O(1)</td><td>O (k)（k 为过期条数）</td><td>低</td><td>优（兼顾查询、插入、清理）</td></tr><tr><td>Redis Sorted Set</td><td>O(log n)</td><td>O(log n)</td><td>O(log n)</td><td>中</td><td>优（适合分布式场景）</td></tr></tbody></table>
<h4 data-id="heading-6">核心选型逻辑：</h4>
<ol>
<li><strong>哈希表（HashMap）</strong> ：负责 “QQ 号→登录时间列表” 的映射，实现 O (1) 快速定位某 QQ 号的历史登录记录（key=QQ 号，value = 双端队列）；</li>
</ol>

<ol start="2">
<li><strong>双端队列（Deque）</strong> ：每个 QQ 号对应一个队列，存储 “五分钟内的登录时间戳”（按登录时间顺序排列），支持：</li>
</ol>
<ul>
<li>
<ul>
<li>队尾插入：新登录时间戳追加到队尾（O (1)）；</li>
</ul>
</li>
</ul>

<ul>
<li>
<ul>
<li>队头清理：登录时先删除队头 “超过 5 分钟的过期时间戳”（O (k)，k 通常为 1，因为只保留 5 分钟内记录）；</li>
</ul>
</li>
</ul>

<ul>
<li>
<ul>
<li>长度判断：清理后若队列长度≥1（说明有最近登录记录），则判定为重复登录。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-7">三、本地场景实现：哈希表 + 双端队列（单机高并发方案）</h3>
<p>适用于 “登录服务部署在单机 / 单集群，无需跨节点共享数据” 的场景（如小型应用、非分布式登录系统），用 Java 代码示例演示核心逻辑：</p>
<h4 data-id="heading-8">1. 方案架构</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-attr">[QQ登录请求]</span> → <span class="hljs-selector-attr">[拦截器/过滤器]</span> → <span class="hljs-selector-attr">[重复登录判断模块]</span> → <span class="hljs-selector-attr">[登录业务逻辑]</span>
                          ↓
                 <span class="hljs-selector-attr">[哈希表+双端队列]</span>（内存存储）
                          ↓
                 <span class="hljs-selector-attr">[过期数据清理]</span>（登录时触发）
</code></pre>
<h4 data-id="heading-9">2. 核心代码实现</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.util.Deque;
<span class="hljs-keyword">import</span> java.util.HashMap;
<span class="hljs-keyword">import</span> java.util.LinkedList;
<span class="hljs-keyword">import</span> java.util.Map;
<span class="hljs-comment">/**
 * 五分钟内重复登录QQ号检测器（本地内存版）
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">QQDuplicateLoginDetector</span> {
    <span class="hljs-comment">// 核心存储：key=QQ号（字符串，避免长数字溢出），value=登录时间戳队列（毫秒级）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;String, Deque&lt;Long&gt;&gt; loginRecordMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
    <span class="hljs-comment">// 时间窗口：5分钟=300000毫秒</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">TIME_WINDOW</span> <span class="hljs-operator">=</span> <span class="hljs-number">5</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000</span>;
    <span class="hljs-comment">// 并发安全锁：避免多线程操作同一QQ号的队列导致异常</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Object</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>();
    <span class="hljs-comment">/**
     * 判断当前登录是否为“五分钟内重复登录”
     * <span class="hljs-doctag">@param</span> qqNumber QQ号
     * <span class="hljs-doctag">@return</span> true=重复登录，false=非重复
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isDuplicateLogin</span><span class="hljs-params">(String qqNumber)</span> {
        <span class="hljs-comment">// 1. 获取当前时间戳（毫秒）</span>
        <span class="hljs-type">long</span> <span class="hljs-variable">currentTime</span> <span class="hljs-operator">=</span> System.currentTimeMillis();
        
        <span class="hljs-comment">// 2. 并发安全：同一QQ号的操作加锁（避免多线程同时修改队列）</span>
        <span class="hljs-keyword">synchronized</span> (lock) {
            <span class="hljs-comment">// 3. 获取该QQ号的登录记录队列，无则创建新队列</span>
            Deque&lt;Long&gt; loginTimes = loginRecordMap.computeIfAbsent(qqNumber, k -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedList</span>&lt;&gt;());
            
            <span class="hljs-comment">// 4. 清理队列中“超过5分钟的过期记录”（关键：只保留有效数据）</span>
            <span class="hljs-keyword">while</span> (!loginTimes.isEmpty()) {
                <span class="hljs-type">long</span> <span class="hljs-variable">earliestTime</span> <span class="hljs-operator">=</span> loginTimes.peekFirst(); <span class="hljs-comment">// 队头是最早的登录时间</span>
                <span class="hljs-keyword">if</span> (currentTime - earliestTime &gt; TIME_WINDOW) {
                    loginTimes.pollFirst(); <span class="hljs-comment">// 过期则删除</span>
                } <span class="hljs-keyword">else</span> {
                    <span class="hljs-keyword">break</span>; <span class="hljs-comment">// 队头未过期，后续记录更不会过期（队列按时间排序）</span>
                }
            }
            
            <span class="hljs-comment">// 5. 判断是否重复登录：清理后队列非空（说明有5分钟内的登录记录）</span>
            <span class="hljs-type">boolean</span> <span class="hljs-variable">isDuplicate</span> <span class="hljs-operator">=</span> !loginTimes.isEmpty();
            
            <span class="hljs-comment">// 6. 将当前登录时间加入队列（队尾追加）</span>
            loginTimes.offerLast(currentTime);
            
            <span class="hljs-comment">// 7. 优化：若队列长度超过2，删除最早的记录（仅需保留最近2条即可判断重复）</span>
            <span class="hljs-keyword">if</span> (loginTimes.size() &gt; <span class="hljs-number">2</span>) {
                loginTimes.pollFirst();
            }
            
            <span class="hljs-comment">// 8. 优化：若队列空，从哈希表中删除（释放内存，避免无效key占用空间）</span>
            <span class="hljs-keyword">if</span> (loginTimes.isEmpty()) {
                loginRecordMap.remove(qqNumber);
            }
            
            <span class="hljs-keyword">return</span> isDuplicate;
        }
    }
    <span class="hljs-comment">// 测试示例</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException {
        <span class="hljs-type">QQDuplicateLoginDetector</span> <span class="hljs-variable">detector</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">QQDuplicateLoginDetector</span>();
        <span class="hljs-type">String</span> <span class="hljs-variable">qq</span> <span class="hljs-operator">=</span> <span class="hljs-string">"123456789"</span>;
        
        <span class="hljs-comment">// 第一次登录：非重复</span>
        System.out.println(detector.isDuplicateLogin(qq)); <span class="hljs-comment">// false</span>
        
        <span class="hljs-comment">// 2分钟后第二次登录：重复</span>
        Thread.sleep(<span class="hljs-number">2</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000</span>);
        System.out.println(detector.isDuplicateLogin(qq)); <span class="hljs-comment">// true</span>
        
        <span class="hljs-comment">// 6分钟后第三次登录：非重复（前两次记录已过期）</span>
        Thread.sleep(<span class="hljs-number">6</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000</span>);
        System.out.println(detector.isDuplicateLogin(qq)); <span class="hljs-comment">// false</span>
    }
}
</code></pre>
<h4 data-id="heading-10">3. 关键优化点</h4>
<ul>
<li><strong>并发安全</strong>：用synchronized锁保证同一 QQ 号的队列操作原子性（避免多线程同时清理 / 插入导致数据混乱）；</li>
</ul>

<ul>
<li><strong>内存优化</strong>：</li>
</ul>

<ul>
<li>
<ul>
<li>队列长度限制为 2（仅需最近 2 条记录即可判断重复，多存无意义）；</li>
</ul>
</li>
</ul>

<ul>
<li>
<ul>
<li>队列空时删除哈希表中的 key（避免 “僵尸 QQ 号” 占用内存）；</li>
</ul>
</li>
</ul>

<ul>
<li><strong>清理效率</strong>：登录时触发清理（懒清理），无需定时任务（减少资源消耗，且只清理当前 QQ 号的过期记录，效率高）。</li>
</ul>
<h3 data-id="heading-11">四、分布式场景实现：Redis Sorted Set（跨节点共享方案）</h3>
<p>当登录服务部署在多节点（如分布式微服务），本地内存方案无法共享登录记录（节点 A 的登录记录，节点 B 无法获取），此时需用<strong>Redis</strong>实现分布式存储，推荐用<strong>Sorted Set（有序集合）</strong> 作为核心数据结构。</p>
<h4 data-id="heading-12">1. 为什么选 Redis Sorted Set？</h4>
<ul>
<li><strong>有序性</strong>：按 “登录时间戳” 作为 score 排序，方便清理过期记录；</li>
</ul>

<ul>
<li><strong>快速查询</strong>：通过ZCARD获取记录数，ZREMRANGEBYSCORE清理过期数据，均为 O (log n) 效率（n 为该 QQ 号的记录数，通常≤2）；</li>
</ul>

<ul>
<li><strong>分布式共享</strong>：Redis 集群可支撑百万级 QPS，多节点登录服务可共享数据；</li>
</ul>

<ul>
<li><strong>自动过期</strong>：可结合 Redis 的EXPIRE命令，给 QQ 号的 key 设置过期时间（如 6 分钟，比 5 分钟多 1 分钟缓冲），进一步释放内存。</li>
</ul>
<h4 data-id="heading-13">2. 方案架构</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-attr">[QQ登录请求]</span> → <span class="hljs-selector-attr">[API网关]</span> → <span class="hljs-selector-attr">[分布式登录服务集群]</span> → <span class="hljs-selector-attr">[Redis集群]</span>
                          ↓                      ↓
                    <span class="hljs-selector-attr">[重复登录判断]</span>         <span class="hljs-selector-attr">[Sorted Set存储登录记录]</span>
                          ↓
                    <span class="hljs-selector-attr">[安全告警/业务处理]</span>
</code></pre>
<h4 data-id="heading-14">3. 核心代码实现（基于 Jedis 客户端）</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> redis.clients.jedis.Jedis;
<span class="hljs-keyword">import</span> redis.clients.jedis.JedisPool;
<span class="hljs-keyword">import</span> redis.clients.jedis.params.ZAddParams;
<span class="hljs-keyword">import</span> java.util.Set;
<span class="hljs-comment">/**
 * 五分钟内重复登录QQ号检测器（分布式Redis版）
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisQQDuplicateLoginDetector</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> JedisPool jedisPool;
    <span class="hljs-comment">// 时间窗口：5分钟=300000毫秒</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">TIME_WINDOW</span> <span class="hljs-operator">=</span> <span class="hljs-number">5</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000</span>;
    <span class="hljs-comment">// Redis key前缀：避免与其他业务key冲突</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">KEY_PREFIX</span> <span class="hljs-operator">=</span> <span class="hljs-string">"qq:login:record:"</span>;
    <span class="hljs-comment">// Redis key过期时间：6分钟（比时间窗口多1分钟，确保过期记录被清理）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">KEY_EXPIRE_SECONDS</span> <span class="hljs-operator">=</span> <span class="hljs-number">6</span> * <span class="hljs-number">60</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">RedisQQDuplicateLoginDetector</span><span class="hljs-params">(JedisPool jedisPool)</span> {
        <span class="hljs-built_in">this</span>.jedisPool = jedisPool;
    }
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isDuplicateLogin</span><span class="hljs-params">(String qqNumber)</span> {
        <span class="hljs-type">long</span> <span class="hljs-variable">currentTime</span> <span class="hljs-operator">=</span> System.currentTimeMillis();
        <span class="hljs-type">String</span> <span class="hljs-variable">redisKey</span> <span class="hljs-operator">=</span> KEY_PREFIX + qqNumber;
        
        <span class="hljs-keyword">try</span> (<span class="hljs-type">Jedis</span> <span class="hljs-variable">jedis</span> <span class="hljs-operator">=</span> jedisPool.getResource()) {
            <span class="hljs-comment">// 1. 清理过期记录：删除score（时间戳）&lt; 当前时间-TIME_WINDOW的记录</span>
            jedis.zremrangeByScore(redisKey, <span class="hljs-number">0</span>, currentTime - TIME_WINDOW);
            
            <span class="hljs-comment">// 2. 判断是否重复登录：记录数≥1说明有5分钟内的登录</span>
            <span class="hljs-type">long</span> <span class="hljs-variable">recordCount</span> <span class="hljs-operator">=</span> jedis.zcard(redisKey);
            <span class="hljs-type">boolean</span> <span class="hljs-variable">isDuplicate</span> <span class="hljs-operator">=</span> recordCount &gt; <span class="hljs-number">0</span>;
            
            <span class="hljs-comment">// 3. 插入当前登录记录：score=currentTime，member=currentTime（避免重复member）</span>
            <span class="hljs-comment">// ZAddParams.xx()：仅当key存在时才插入（可选，避免无效插入）</span>
            jedis.zadd(redisKey, currentTime, String.valueOf(currentTime), ZAddParams.zAddParams().nx());
            
            <span class="hljs-comment">// 4. 优化：保留最近2条记录（删除最早的记录）</span>
            <span class="hljs-keyword">if</span> (recordCount &gt;= <span class="hljs-number">2</span>) {
                <span class="hljs-comment">// ZRANGE获取最早的记录（0-0是第一条），再删除</span>
                Set&lt;String&gt; earliestMembers = jedis.zrange(redisKey, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
                <span class="hljs-keyword">if</span> (!earliestMembers.isEmpty()) {
                    jedis.zrem(redisKey, earliestMembers.iterator().next());
                }
            }
            
            <span class="hljs-comment">// 5. 设置key过期时间（确保6分钟后自动删除，释放内存）</span>
            jedis.expire(redisKey, KEY_EXPIRE_SECONDS);
            
            <span class="hljs-keyword">return</span> isDuplicate;
        }
    }
    <span class="hljs-comment">// 测试示例（需提前启动Redis服务）</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException {
        <span class="hljs-type">JedisPool</span> <span class="hljs-variable">jedisPool</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JedisPool</span>(<span class="hljs-string">"localhost"</span>, <span class="hljs-number">6379</span>);
        <span class="hljs-type">RedisQQDuplicateLoginDetector</span> <span class="hljs-variable">detector</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RedisQQDuplicateLoginDetector</span>(jedisPool);
        <span class="hljs-type">String</span> <span class="hljs-variable">qq</span> <span class="hljs-operator">=</span> <span class="hljs-string">"987654321"</span>;
        
        <span class="hljs-comment">// 第一次登录：非重复</span>
        System.out.println(detector.isDuplicateLogin(qq)); <span class="hljs-comment">// false</span>
        
        <span class="hljs-comment">// 3分钟后第二次登录：重复</span>
        Thread.sleep(<span class="hljs-number">3</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000</span>);
        System.out.println(detector.isDuplicateLogin(qq)); <span class="hljs-comment">// true</span>
        
        <span class="hljs-comment">// 7分钟后第三次登录：非重复（key已过期）</span>
        Thread.sleep(<span class="hljs-number">7</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000</span>);
        System.out.println(detector.isDuplicateLogin(qq)); <span class="hljs-comment">// false</span>
        
        jedisPool.close();
    }
}
</code></pre>
<h4 data-id="heading-15">4. 分布式场景优化</h4>
<ul>
<li><strong>Redis 集群</strong>：用 Redis Cluster 或主从 + 哨兵架构，支撑高并发和高可用（避免单点故障）；</li>
</ul>

<ul>
<li><strong>批量操作</strong>：若需同时判断多个 QQ 号，用Pipeline批量执行 Redis 命令（减少网络往返次数）；</li>
</ul>

<ul>
<li><strong>缓存穿透</strong>：对不存在的 QQ 号（如恶意伪造的 QQ 号），可缓存空结果（设置短过期时间，如 10 秒），避免频繁访问 Redis；</li>
</ul>

<ul>
<li><strong>监控告警</strong>：监控 Redis 的zadd成功率、key 过期率，异常时触发告警（如 Redis 集群负载过高）。</li>
</ul>
<h3 data-id="heading-16">五、方案对比与选型建议</h3>

































<table><thead><tr><th>场景</th><th>推荐方案</th><th>优点</th><th>缺点</th><th>适用场景</th></tr></thead><tbody><tr><td>单机 / 单集群</td><td>哈希表 + 双端队列</td><td>延迟极低（内存操作，&lt;1ms）</td><td>无法跨节点共享</td><td>小型应用、非分布式登录系统</td></tr><tr><td>分布式微服务</td><td>Redis Sorted Set</td><td>跨节点共享、高可用</td><td>依赖 Redis，延迟略高（~5ms）</td><td>大型应用、多节点登录服务</td></tr><tr><td>超大规模（亿级 QPS）</td><td>Redis Cluster + 本地缓存</td><td>兼顾分布式共享与低延迟</td><td>实现复杂，需同步本地与 Redis</td><td>腾讯 QQ、微信等超大规模登录场景</td></tr></tbody></table>
<h3 data-id="heading-17">六、扩展场景：从 “定位重复” 到 “风控升级”</h3>
<p>基于上述方案，可轻松扩展更多风控需求：</p>
<ol>
<li><strong>五分钟内重复登录 N 次</strong>：将队列长度判断从 “≥1” 改为 “≥N-1”（如 N=3，判断队列长度≥2）；</li>
</ol>

<ol start="2">
<li><strong>异地重复登录</strong>：在队列中存储 “登录时间戳 + IP 地址”，判断时不仅看时间差，还看 IP 是否属于不同地域；</li>
</ol>

<ol start="3">
<li><strong>实时告警</strong>：当检测到重复登录时，调用消息队列（如 Kafka）发送告警消息，由风控系统处理（如发送验证码、冻结账号）；</li>
</ol>

<ol start="4">
<li><strong>登录频次统计</strong>：通过队列长度或 Redis ZCARD结果，统计某 QQ 号在 5 分钟内的登录次数，用于识别恶意登录行为。</li>
</ol>
<h3 data-id="heading-18">总结</h3>
<p>“定位五分钟内重复登录的 QQ 号” 的核心是 “<strong>快速查找 + 高效清理</strong>”：</p>
<ul>
<li>本地场景选 “哈希表 + 双端队列”，用 O (1) 查找和懒清理实现低延迟；</li>
</ul>

<ul>
<li>分布式场景选 “Redis Sorted Set”，用有序性和分布式特性实现跨节点共享；</li>
</ul>

<ul>
<li>无论哪种方案，都需兼顾 “内存优化”（避免无效数据）和 “并发安全”（避免多线程冲突）。</li>
</ul>
<p>最终，数据结构的选择不是 “选最复杂的”，而是 “选最适配业务场景的”—— 简单的组合结构，往往能解决复杂的高并发问题。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[自定义instanceof运算符行为API: Symbol.hasInstance]]></title>    <link>https://juejin.cn/post/7569987064688082978</link>    <guid>https://juejin.cn/post/7569987064688082978</guid>    <pubDate>2025-11-08T11:58:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7569987064688082978" data-draft-id="7569928387020898344" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="自定义instanceof运算符行为API: Symbol.hasInstance"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-08T11:58:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="桜吹雪"/> <meta itemprop="url" content="https://juejin.cn/user/1179091901098269"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            自定义instanceof运算符行为API: Symbol.hasInstance
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1179091901098269/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    桜吹雪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-08T11:58:02.000Z" title="Sat Nov 08 2025 11:58:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>今天翻zod的源码，发现有个之前没见过的，应该也没听说的API：Symbol.hasInstance</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">export</span> <span class="hljs-comment">/*@__NO_SIDE_EFFECTS__*/</span> <span class="hljs-keyword">function</span> $constructor&lt;T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ZodTrait</span>, D = T[<span class="hljs-string">"_zod"</span>][<span class="hljs-string">"def"</span>]&gt;(
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>,
  <span class="hljs-attr">initializer</span>: <span class="hljs-function">(<span class="hljs-params">inst: T, def: D</span>) =&gt;</span> <span class="hljs-built_in">void</span>,
  params?: { <span class="hljs-title class_">Parent</span>?: <span class="hljs-keyword">typeof</span> <span class="hljs-title class_">Class</span> }
): $constructor&lt;T, D&gt; {
  <span class="hljs-comment">// ...</span>
  <span class="hljs-comment">// </span>
  <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">defineProperty</span>(_, <span class="hljs-title class_">Symbol</span>.<span class="hljs-property">hasInstance</span>, {
    <span class="hljs-attr">value</span>: <span class="hljs-function">(<span class="hljs-params">inst: <span class="hljs-built_in">any</span></span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (params?.<span class="hljs-property">Parent</span> &amp;&amp; inst <span class="hljs-keyword">instanceof</span> params.<span class="hljs-property">Parent</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
      <span class="hljs-keyword">return</span> inst?.<span class="hljs-property">_zod</span>?.<span class="hljs-property">traits</span>?.<span class="hljs-title function_">has</span>(name);
    },
  });
}
</code></pre>
<p>发现有个写了几年代码都没发现的API，就拿去问ai了。</p>
<hr/>
<p><code>Symbol.hasInstance</code>是 JavaScript 的一个内置 Symbol，用于<strong>自定义 <code>instanceof</code>运算符的行为</strong>。</p>
<h2 data-id="heading-0">基本用法</h2>
<p>默认情况下，<code>instanceof</code>检查对象的原型链：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Animal</span> {}
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Dog</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Animal</span> {}

<span class="hljs-keyword">const</span> dog = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Dog</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(dog <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Dog</span>);     <span class="hljs-comment">// true</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(dog <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Animal</span>);   <span class="hljs-comment">// true</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(dog <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Object</span>);   <span class="hljs-comment">// true</span>
</code></pre>
<h2 data-id="heading-1">使用 Symbol.hasInstance 自定义行为</h2>
<p>你可以通过定义静态的 <code>Symbol.hasInstance</code>方法来改变 <code>instanceof</code>的行为：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyClass</span> {
    <span class="hljs-keyword">static</span> [<span class="hljs-title class_">Symbol</span>.<span class="hljs-property">hasInstance</span>](instance) {
        <span class="hljs-comment">// 自定义判断逻辑</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">typeof</span> instance === <span class="hljs-string">'object'</span> &amp;&amp; 
               instance !== <span class="hljs-literal">null</span> &amp;&amp; 
               instance.<span class="hljs-property">value</span> === <span class="hljs-number">42</span>;
    }
}

<span class="hljs-keyword">const</span> obj1 = { <span class="hljs-attr">value</span>: <span class="hljs-number">42</span> };
<span class="hljs-keyword">const</span> obj2 = { <span class="hljs-attr">value</span>: <span class="hljs-number">100</span> };
<span class="hljs-keyword">const</span> obj3 = <span class="hljs-literal">null</span>;

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(obj1 <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">MyClass</span>); <span class="hljs-comment">// true</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(obj2 <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">MyClass</span>); <span class="hljs-comment">// false</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(obj3 <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">MyClass</span>); <span class="hljs-comment">// false</span>
</code></pre>
<h2 data-id="heading-2">实际应用场景</h2>
<h3 data-id="heading-3">1. 基于属性的实例检查</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Validator</span> {
    <span class="hljs-keyword">static</span> [<span class="hljs-title class_">Symbol</span>.<span class="hljs-property">hasInstance</span>](obj) {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">typeof</span> obj === <span class="hljs-string">'object'</span> &amp;&amp; 
               obj !== <span class="hljs-literal">null</span> &amp;&amp; 
               <span class="hljs-keyword">typeof</span> obj.<span class="hljs-property">validate</span> === <span class="hljs-string">'function'</span>;
    }
}

<span class="hljs-keyword">const</span> validObj = {
    <span class="hljs-title function_">validate</span>(<span class="hljs-params"/>) { <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>; }
};

<span class="hljs-keyword">const</span> invalidObj = { <span class="hljs-attr">name</span>: <span class="hljs-string">"test"</span> };

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(validObj <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Validator</span>);   <span class="hljs-comment">// true</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(invalidObj <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Validator</span>);  <span class="hljs-comment">// false</span>
</code></pre>
<h3 data-id="heading-4">2. 数字范围检查</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">class</span> <span class="hljs-title class_">PrimeNumber</span> {
    <span class="hljs-keyword">static</span> <span class="hljs-title function_">isPrime</span>(<span class="hljs-params">num</span>) {
        <span class="hljs-keyword">if</span> (num &lt;= <span class="hljs-number">1</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">2</span>; i &lt;= <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sqrt</span>(num); i++) {
            <span class="hljs-keyword">if</span> (num % i === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
    
    <span class="hljs-keyword">static</span> [<span class="hljs-title class_">Symbol</span>.<span class="hljs-property">hasInstance</span>](num) {
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">Number</span>.<span class="hljs-title function_">isInteger</span>(num) &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">isPrime</span>(num);
    }
}

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">2</span> <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">PrimeNumber</span>);    <span class="hljs-comment">// true</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">7</span> <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">PrimeNumber</span>);    <span class="hljs-comment">// true</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">4</span> <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">PrimeNumber</span>);    <span class="hljs-comment">// false</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">9</span> <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">PrimeNumber</span>);    <span class="hljs-comment">// false</span>
</code></pre>
<h3 data-id="heading-5">3. 数组内容检查</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">class</span> <span class="hljs-title class_">NumericArray</span> {
    <span class="hljs-keyword">static</span> [<span class="hljs-title class_">Symbol</span>.<span class="hljs-property">hasInstance</span>](arr) {
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(arr) &amp;&amp; 
               arr.<span class="hljs-title function_">every</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> <span class="hljs-keyword">typeof</span> item === <span class="hljs-string">'number'</span>);
    }
}

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>([<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>] <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">NumericArray</span>);     <span class="hljs-comment">// true</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>([<span class="hljs-number">1</span>, <span class="hljs-string">'2'</span>, <span class="hljs-number">3</span>] <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">NumericArray</span>);   <span class="hljs-comment">// false</span>
</code></pre>
<h2 data-id="heading-6">注意事项</h2>
<ol>
<li>1.<strong>必须是静态方法</strong>：<code>Symbol.hasInstance</code>必须定义为类的静态方法</li>
<li>2.<strong>影响所有 instanceof 检查</strong>：会改变该类的所有实例检查行为</li>
<li>3.<strong>谨慎使用</strong>：过度使用可能使代码难以理解</li>
</ol>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomClass</span> {
    <span class="hljs-comment">// 正确：静态方法</span>
    <span class="hljs-keyword">static</span> [<span class="hljs-title class_">Symbol</span>.<span class="hljs-property">hasInstance</span>](instance) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>; <span class="hljs-comment">// 所有对象都是实例</span>
    }
    
    <span class="hljs-comment">// 错误：实例方法（不会生效）</span>
    [<span class="hljs-title class_">Symbol</span>.<span class="hljs-property">hasInstance</span>](instance) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
}

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>({} <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">CustomClass</span>); <span class="hljs-comment">// true（总是返回 true）</span>
</code></pre>
<h2 data-id="heading-7">总结</h2>
<p><code>Symbol.hasInstance</code>的主要用途是让开发者能够自定义 <code>instanceof</code>运算符的逻辑，实现更灵活的类型检查机制。这在创建验证器、特殊数据类型的类或者需要复杂实例检查的场景中非常有用。</p>
<h3 data-id="heading-8">为什么这样设计</h3>
<ul>
<li><strong>灵活性</strong>：允许对象通过特征标记而非严格的类继承来表示类型</li>
<li><strong>组合优于继承</strong>：支持特征组合，一个对象可以有多个特征</li>
<li><strong>运行时类型检查</strong>：可以在运行时动态添加/移除类型特征</li>
</ul>
<p>这种模式在需要灵活类型系统的库中很常见，特别是那些需要支持动态类型或混合类型的场景。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue SFC 编译器源码深度解析：processDefineEmits 与运行时事件生成机制]]></title>    <link>https://juejin.cn/post/7569913182035230730</link>    <guid>https://juejin.cn/post/7569913182035230730</guid>    <pubDate>2025-11-08T11:53:36.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7569913182035230730" data-draft-id="7569886315196907571" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue SFC 编译器源码深度解析：processDefineEmits 与运行时事件生成机制"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-08T11:53:36.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="excel"/> <meta itemprop="url" content="https://juejin.cn/user/2911162520062862"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue SFC 编译器源码深度解析：processDefineEmits 与运行时事件生成机制
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2911162520062862/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    excel
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-08T11:53:36.000Z" title="Sat Nov 08 2025 11:53:36 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>本文将深入剖析 Vue 单文件组件（SFC）编译器中的 <strong><code>defineEmits</code></strong> 处理逻辑，来自 <code>compiler-sfc</code> 模块的源码实现。<br/>
本文涵盖从概念、原理到实践的全链路分析，辅以详细注释与代码逐行解析。</p>
<hr/>
<h2 data-id="heading-0">一、概念：<code>defineEmits</code> 的定位与作用</h2>
<p>在 Vue 3 的 <code>&lt;script setup&gt;</code> 中，<code>defineEmits()</code> 用于声明组件可以触发的事件。<br/>
例如：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-type">const</span> emit = <span class="hljs-built_in">defineEmits</span>([<span class="hljs-string">'submit'</span>, <span class="hljs-string">'cancel'</span>])
<span class="hljs-built_in">emit</span>(<span class="hljs-string">'submit'</span>)
</code></pre>
<p>其核心目标是：</p>
<ul>
<li><strong>类型层面</strong>：提供 TypeScript 类型约束（确保事件名称正确）。</li>
<li><strong>运行时层面</strong>：生成可用的 <code>emits</code> 配置，供 Vue 组件选项使用。</li>
</ul>
<p>在编译阶段，Vue 会分析 <code>defineEmits()</code> 的调用，提取其中的事件定义或类型信息，并生成最终的运行时代码。</p>
<hr/>
<h2 data-id="heading-1">二、原理：编译器的处理流程总览</h2>
<p><code>defineEmits</code> 的编译处理分为三个核心步骤：</p>
<ol>
<li>
<p><strong>检测与记录调用</strong>：<code>processDefineEmits</code></p>
<ul>
<li>识别 <code>defineEmits()</code> 调用语句；</li>
<li>检查重复定义；</li>
<li>区分运行时参数和类型参数；</li>
<li>保存到上下文（<code>ScriptCompileContext</code>）。</li>
</ul>
</li>
<li>
<p><strong>提取运行时声明</strong>：<code>extractRuntimeEmits</code></p>
<ul>
<li>若使用 TypeScript 类型参数（<code>defineEmits&lt;{...}&gt;()</code>），提取其中的事件名称。</li>
</ul>
</li>
<li>
<p><strong>生成最终运行时代码</strong>：<code>genRuntimeEmits</code></p>
<ul>
<li>合并类型定义与 <code>v-model</code> 的事件（如 <code>update:modelValue</code>）；</li>
<li>生成最终字符串代码片段。</li>
</ul>
</li>
</ol>
<hr/>
<h2 data-id="heading-2">三、源码逐行解析与注释</h2>
<h3 data-id="heading-3">1. <code>processDefineEmits</code></h3>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-function"><span class="hljs-keyword">export</span> function <span class="hljs-title">processDefineEmits</span><span class="hljs-params">(
  ctx: ScriptCompileContext,
  node: Node,
  declId?: LVal,
)</span>: boolean {</span>
  <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">isCallOf</span>(node, DEFINE_EMITS)) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
  }
</code></pre>
<blockquote>
<p><strong>说明</strong>：<br/>
通过 <code>isCallOf()</code> 检查当前 AST 节点是否为 <code>defineEmits()</code> 的调用，若不是则跳过。</p>
</blockquote>
<hr/>
<pre><code class="hljs language-go" lang="go">  <span class="hljs-keyword">if</span> (ctx.hasDefineEmitCall) {
    ctx.<span class="hljs-type">error</span>(<span class="hljs-string">`duplicate ${DEFINE_EMITS}() call`</span>, node)
  }
</code></pre>
<blockquote>
<p><strong>说明</strong>：<br/>
Vue 组件中只能调用一次 <code>defineEmits</code>，此处用于防止重复定义。</p>
</blockquote>
<hr/>
<pre><code class="hljs language-ini" lang="ini">  <span class="hljs-attr">ctx.hasDefineEmitCall</span> = <span class="hljs-literal">true</span>
  <span class="hljs-attr">ctx.emitsRuntimeDecl</span> = node.arguments[<span class="hljs-number">0</span>]
</code></pre>
<blockquote>
<p><strong>说明</strong>：<br/>
记录运行时参数（如 <code>['click', 'submit']</code>）。</p>
</blockquote>
<hr/>
<pre><code class="hljs language-scss" lang="scss">  if (node.typeParameters) {
    if (ctx.emitsRuntimeDecl) {
      ctx<span class="hljs-selector-class">.error</span>(`${DEFINE_EMITS}() cannot accept both type and non-type arguments`, node)
    }
    ctx<span class="hljs-selector-class">.emitsTypeDecl</span> = node<span class="hljs-selector-class">.typeParameters</span><span class="hljs-selector-class">.params</span><span class="hljs-selector-attr">[0]</span>
  }
</code></pre>
<blockquote>
<p><strong>说明</strong>：<br/>
处理类型参数（如 <code>defineEmits&lt;{ change: (value: string) =&gt; void }&gt;()</code>）。<br/>
同时检查不能混用类型参数与运行时参数。</p>
</blockquote>
<hr/>
<pre><code class="hljs language-kotlin" lang="kotlin">  ctx.emitDecl = declId
  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
}
</code></pre>
<blockquote>
<p><strong>说明</strong>：<br/>
保存声明标识符（如 <code>const emit = defineEmits(...)</code>），供后续生成使用。</p>
</blockquote>
<hr/>
<h3 data-id="heading-4">2. <code>genRuntimeEmits</code></h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">genRuntimeEmits</span>(<span class="hljs-params">ctx: ScriptCompileContext</span>): string | <span class="hljs-literal">undefined</span> {
  <span class="hljs-keyword">let</span> emitsDecl = <span class="hljs-string">''</span>
  <span class="hljs-keyword">if</span> (ctx.<span class="hljs-property">emitsRuntimeDecl</span>) {
    emitsDecl = ctx.<span class="hljs-title function_">getString</span>(ctx.<span class="hljs-property">emitsRuntimeDecl</span>).<span class="hljs-title function_">trim</span>()
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (ctx.<span class="hljs-property">emitsTypeDecl</span>) {
    <span class="hljs-keyword">const</span> typeDeclaredEmits = <span class="hljs-title function_">extractRuntimeEmits</span>(ctx)
    emitsDecl = typeDeclaredEmits.<span class="hljs-property">size</span>
      ? <span class="hljs-string">`[<span class="hljs-subst">${<span class="hljs-built_in">Array</span>.<span class="hljs-keyword">from</span>(typeDeclaredEmits)
          .map(k =&gt; <span class="hljs-built_in">JSON</span>.stringify(k))
          .join(<span class="hljs-string">', '</span>)}</span>]`</span>
      : <span class="hljs-string">``</span>
  }
</code></pre>
<blockquote>
<p><strong>说明</strong>：<br/>
这里根据上下文选择不同模式：</p>
<ul>
<li>运行时参数：直接输出字符串。</li>
<li>类型参数：调用 <code>extractRuntimeEmits</code> 从类型信息中提取事件名。</li>
</ul>
</blockquote>
<hr/>
<pre><code class="hljs language-javascript" lang="javascript">  <span class="hljs-keyword">if</span> (ctx.<span class="hljs-property">hasDefineModelCall</span>) {
    <span class="hljs-keyword">let</span> modelEmitsDecl = <span class="hljs-string">`[<span class="hljs-subst">${<span class="hljs-built_in">Object</span>.keys(ctx.modelDecls)
      .map(n =&gt; <span class="hljs-built_in">JSON</span>.stringify(<span class="hljs-string">`update:<span class="hljs-subst">${n}</span>`</span>))
      .join(<span class="hljs-string">', '</span>)}</span>]`</span>
    emitsDecl = emitsDecl
      ? <span class="hljs-string">`/*@__PURE__*/<span class="hljs-subst">${ctx.helper(<span class="hljs-string">'mergeModels'</span>)}</span>(<span class="hljs-subst">${emitsDecl}</span>, <span class="hljs-subst">${modelEmitsDecl}</span>)`</span>
      : modelEmitsDecl
  }
  <span class="hljs-keyword">return</span> emitsDecl
}
</code></pre>
<blockquote>
<p><strong>说明</strong>：<br/>
若组件同时使用 <code>defineModel()</code>，需合并 <code>update:modelValue</code> 事件。<br/>
生成形如：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/*@__PURE__*/</span>_mergeModels(<span class="hljs-selector-attr">[<span class="hljs-string">"submit"</span>]</span>, <span class="hljs-selector-attr">[<span class="hljs-string">"update:modelValue"</span>]</span>)
</code></pre>
</blockquote>
<hr/>
<h3 data-id="heading-5">3. <code>extractRuntimeEmits</code></h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">extractRuntimeEmits</span>(<span class="hljs-params">ctx: TypeResolveContext</span>): <span class="hljs-title class_">Set</span>&lt;<span class="hljs-built_in">string</span>&gt; {
  <span class="hljs-keyword">const</span> emits = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>&lt;<span class="hljs-built_in">string</span>&gt;()
  <span class="hljs-keyword">const</span> node = ctx.<span class="hljs-property">emitsTypeDecl</span>!
</code></pre>
<blockquote>
<p><strong>说明</strong>：<br/>
当使用类型参数时，从类型 AST 中提取所有事件名称。</p>
</blockquote>
<hr/>
<pre><code class="hljs language-ini" lang="ini">  if (<span class="hljs-attr">node.type</span> === <span class="hljs-string">'TSFunctionType'</span>) {
    extractEventNames(ctx, node.parameters<span class="hljs-section">[0]</span>, emits)
    return emits
  }
</code></pre>
<blockquote>
<p><strong>说明</strong>：<br/>
若 <code>defineEmits</code> 是函数类型（如 <code>defineEmits&lt;(e: 'click' | 'submit')&gt;()</code>），从参数中提取字符串字面量。</p>
</blockquote>
<hr/>
<pre><code class="hljs language-csharp" lang="csharp">  <span class="hljs-keyword">const</span> { props, calls } = resolveTypeElements(ctx, node)
  <span class="hljs-keyword">let</span> hasProperty = <span class="hljs-function"><span class="hljs-literal">false</span>
  <span class="hljs-title">for</span> (<span class="hljs-params"><span class="hljs-keyword">const</span> key <span class="hljs-keyword">in</span> props</span>)</span> {
    emits.<span class="hljs-keyword">add</span>(key)
    hasProperty = <span class="hljs-literal">true</span>
  }
</code></pre>
<blockquote>
<p><strong>说明</strong>：<br/>
如果是对象类型 <code>{ change: (val: number) =&gt; void }</code>，将键名作为事件名。</p>
</blockquote>
<hr/>
<pre><code class="hljs language-vbnet" lang="vbnet">  <span class="hljs-keyword">if</span> (calls) {
    <span class="hljs-keyword">if</span> (hasProperty) {
      ctx.<span class="hljs-keyword">error</span>(`defineEmits() type cannot mixed <span class="hljs-keyword">call</span> signature <span class="hljs-built_in">and</span> <span class="hljs-keyword">property</span> syntax.`, node)
    }
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> <span class="hljs-keyword">call</span> <span class="hljs-keyword">of</span> calls) {
      extractEventNames(ctx, <span class="hljs-keyword">call</span>.parameters[<span class="hljs-number">0</span>], emits)
    }
  }
  <span class="hljs-keyword">return</span> emits
}
</code></pre>
<blockquote>
<p><strong>说明</strong>：<br/>
若类型中混合了函数签名与对象属性，会报错。<br/>
Vue 要求两者互斥，以保证一致性。</p>
</blockquote>
<hr/>
<h3 data-id="heading-6">4. <code>extractEventNames</code></h3>
<pre><code class="hljs language-ini" lang="ini">function extractEventNames(
  ctx: TypeResolveContext,
  eventName: ArrayPattern | Identifier | ObjectPattern | RestElement,
  emits: Set&lt;string&gt;,
) {
  if (
    <span class="hljs-attr">eventName.type</span> === <span class="hljs-string">'Identifier'</span> &amp;&amp;
    eventName.typeAnnotation &amp;&amp;
    <span class="hljs-attr">eventName.typeAnnotation.type</span> === <span class="hljs-string">'TSTypeAnnotation'</span>
  ) {
    const <span class="hljs-attr">types</span> = resolveUnionType(ctx, eventName.typeAnnotation.typeAnnotation)
</code></pre>
<blockquote>
<p><strong>说明</strong>：<br/>
此函数用于处理联合类型，如：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">defineEmits</span>&lt;(<span class="hljs-attribute">e</span>: <span class="hljs-string">'a'</span> | <span class="hljs-string">'b'</span> | <span class="hljs-string">'c'</span>)&gt;()
</code></pre>
</blockquote>
<hr/>
<pre><code class="hljs language-rust" lang="rust">    <span class="hljs-title function_ invoke__">for</span> (<span class="hljs-keyword">const</span> <span class="hljs-keyword">type</span> <span class="hljs-title class_">of</span> types) {
      <span class="hljs-title function_ invoke__">if</span> (<span class="hljs-keyword">type</span>.<span class="hljs-keyword">type</span> === <span class="hljs-symbol">'TSLiteralType</span>') {
        <span class="hljs-title function_ invoke__">if</span> (
          <span class="hljs-keyword">type</span>.literal.<span class="hljs-keyword">type</span> !== <span class="hljs-symbol">'UnaryExpression</span>' &amp;&amp;
          <span class="hljs-keyword">type</span>.literal.<span class="hljs-keyword">type</span> !== <span class="hljs-symbol">'TemplateLiteral</span>'
        ) {
          emits.<span class="hljs-title function_ invoke__">add</span>(<span class="hljs-title function_ invoke__">String</span>(<span class="hljs-keyword">type</span>.literal.value))
        }
      }
    }
  }
}
</code></pre>
<blockquote>
<p><strong>说明</strong>：<br/>
从联合类型中提取所有字面量值，并存入事件集合。</p>
</blockquote>
<hr/>
<h2 data-id="heading-7">四、对比分析：类型模式 vs 运行时模式</h2>





























<table><thead><tr><th>模式类型</th><th>示例</th><th>优点</th><th>缺点</th></tr></thead><tbody><tr><td>运行时参数</td><td><code>defineEmits(['click', 'change'])</code></td><td>简单直观</td><td>无类型约束</td></tr><tr><td>类型参数</td><td><code>defineEmits&lt;{ change: (v: number) =&gt; void }&gt;()</code></td><td>完整类型推导</td><td>仅 TS 支持</td></tr><tr><td>函数签名参数</td><td>`defineEmits&lt;(e: 'a'</td><td>'b')&gt;()`</td><td>可枚举事件字面量</td></tr></tbody></table>
<p>Vue 的编译器在生成代码时，会自动兼容这些模式。</p>
<hr/>
<h2 data-id="heading-8">五、实践示例：从源码到生成代码</h2>
<p>输入源代码：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> emit = defineEmits&lt;{ <span class="hljs-attr">submit</span>: <span class="hljs-function">(<span class="hljs-params">data: <span class="hljs-built_in">any</span></span>) =&gt;</span> <span class="hljs-built_in">void</span>, <span class="hljs-attr">cancel</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span> }&gt;()
</code></pre>
<p>编译器生成的运行时代码：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  emits: [<span class="hljs-string">"submit"</span>, <span class="hljs-string">"cancel"</span>]
}
</code></pre>
<p>如果存在 <code>defineModel('value')</code>：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  emits: <span class="hljs-comment">/*@__PURE__*/</span>_mergeModels([<span class="hljs-string">"submit"</span>, <span class="hljs-string">"cancel"</span>], [<span class="hljs-string">"update:value"</span>])
}
</code></pre>
<hr/>
<h2 data-id="heading-9">六、拓展：与 <code>defineProps</code>、<code>defineModel</code> 的关系</h2>
<ul>
<li><code>defineProps</code>：声明组件输入接口；</li>
<li><code>defineEmits</code>：声明组件输出事件；</li>
<li><code>defineModel</code>：语法糖，自动生成 <code>props</code> + <code>emits</code> 的绑定关系。</li>
</ul>
<p><code>genRuntimeEmits</code> 之所以会检测 <code>hasDefineModelCall</code>，正是为了保证双向绑定事件正确注入。</p>
<hr/>
<h2 data-id="heading-10">七、潜在问题与限制</h2>
<ol>
<li>
<p><strong>混用类型与运行时参数报错</strong><br/>
编译时强制互斥，否则抛出错误。</p>
</li>
<li>
<p><strong>函数签名与对象类型混合报错</strong><br/>
例如：</p>
<pre><code class="hljs language-c" lang="c">defineEmits&lt;{
  submit: () =&gt; <span class="hljs-type">void</span>
  (e: <span class="hljs-string">'cancel'</span>): <span class="hljs-type">void</span>
}&gt;()
</code></pre>
<p>这种混用是不被允许的。</p>
</li>
<li>
<p><strong>无法动态计算事件名</strong><br/>
所有事件名称必须为字面量常量，否则类型提取失败。</p>
</li>
</ol>
<hr/>
<h2 data-id="heading-11">八、总结</h2>
<p><code>processDefineEmits</code> 是 Vue SFC 编译过程中负责 <strong>事件定义提取</strong> 的关键函数。<br/>
它结合类型系统与运行时声明，生成统一的 <code>emits</code> 数组，保证组件在类型安全与运行时行为之间的平衡。</p>
<blockquote>
<p><strong>核心价值：</strong></p>
<ul>
<li>静态分析事件声明；</li>
<li>支持 TypeScript 类型提取；</li>
<li>自动合并 <code>v-model</code> 相关事件。</li>
</ul>
</blockquote>
<hr/>
<p><strong>本文部分内容借助 AI 辅助生成，并由作者整理审核。</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Kafka源码（七）事务消息]]></title>    <link>https://juejin.cn/post/7570239631846850594</link>    <guid>https://juejin.cn/post/7570239631846850594</guid>    <pubDate>2025-11-09T07:30:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7570239631846850594" data-draft-id="7570162891141644303" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Kafka源码（七）事务消息"/> <meta itemprop="keywords" content="后端,Java,源码阅读"/> <meta itemprop="datePublished" content="2025-11-09T07:30:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序猿阿越"/> <meta itemprop="url" content="https://juejin.cn/user/2902320841230280"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Kafka源码（七）事务消息
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2902320841230280/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序猿阿越
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-09T07:30:41.000Z" title="Sun Nov 09 2025 07:30:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读37分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:18px;overflow-x:hidden;color:#333}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin-top:40px;margin-bottom:20px;color:#007fff;display:flex;align-items:center}.markdown-body h1:hover:before,.markdown-body h2:hover:before,.markdown-body h3:hover:before,.markdown-body h4:hover:before,.markdown-body h5:hover:before,.markdown-body h6:hover:before{transition:All .4s ease-in-out;transform:rotate(1turn)}.markdown-body h1{font-size:30px;background:linear-gradient(#fff 60%,#c6e3ff 0)}.markdown-body h1:before{content:"";display:inline-block;width:32px;height:32px;margin-right:10px;background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC");background-size:100% 100%}.markdown-body h2{font-size:24px;background:linear-gradient(#fff 60%,#cce3fb 0)}.markdown-body h2:before{content:"";display:inline-block;width:24px;height:24px;margin-right:10px;background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC");background-size:100% 100%}.markdown-body h3{font-size:20px}.markdown-body h3:before{content:"";display:inline-block;width:18px;height:18px;margin-right:10px;background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC");background-size:100% 100%}.markdown-body h4{font-size:18px}.markdown-body h4:before{content:"";display:inline-block;width:16px;height:16px;margin-right:10px;background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC");background-size:100% 100%}.markdown-body h5{font-size:16px}.markdown-body h5:before{content:"";display:inline-block;width:15px;height:15px;margin-right:10px;background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC");background-size:100% 100%}.markdown-body h6{font-size:14px}.markdown-body h6:before{content:"";display:inline-block;width:12px;height:12px;margin-right:10px;background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC");background-size:100% 100%}.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{border-bottom:2px solid #007fff;color:#007fff;padding-right:10px}.markdown-body p{letter-spacing:1px;line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{display:block;max-width:100%;margin:10px auto}.markdown-body hr{border:none;border-top:1px dashed #92c8ff}.markdown-body hr:before{content:"✂";display:inline-block;position:relative;top:-12px;left:40px;padding:0 3px;color:#007fff;font-size:18px}.markdown-body hr:after{content:"按虚线剪开";position:relative;top:-15px;left:84%;padding:0 3px;color:#007fff;font-size:12px}.markdown-body del{color:#f44}.markdown-body em{color:#007fff;margin:0 2px}.markdown-body strong{color:#007fff;font-weight:bolder}.markdown-body code{word-break:break-word;border-radius:4px;overflow-x:auto;background-color:#e6f3ff;color:#007fff;font-weight:600;font-size:16px;padding:.065em .4em;border:1px solid #007fff}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:5px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:18px;font-weight:400;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8;border:none}.markdown-body a{text-decoration:none;color:#007fff;border-bottom:1px solid #007fff}.markdown-body a:before{content:"¶";margin-right:5px;font-size:22px}.markdown-body a:after{content:"↷";margin-left:2px;font-size:22px;display:none}.markdown-body a:active,.markdown-body a:hover{color:#275b8c;border-bottom:1px solid #275b8c}.markdown-body a:active:after,.markdown-body a:hover:after{display:inline-block}.markdown-body table{display:inline-block!important;font-size:16px;width:auto;max-width:100%;overflow:auto;border:1px solid #a5d3ff}.markdown-body thead{background:#c6e3ff;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#eef7ff}.markdown-body tbody&gt;tr:nth-child(odd){background-color:#f8fcff}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #007fff;background-color:#eef7ff}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#007fff}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="srcery">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#1c1b19;color:#fce8c3}.hljs-emphasis,.hljs-strong{color:#918175}.hljs-bullet,.hljs-link,.hljs-literal,.hljs-number,.hljs-quote,.hljs-regexp{color:#ff5c8f}.hljs-code,.hljs-selector-class{color:#68a8e4}.hljs-emphasis{font-style:italic}.hljs-attribute,.hljs-keyword,.hljs-section,.hljs-selector-tag,.hljs-variable{color:#ef2f27}.hljs-name,.hljs-title{color:#fbb829}.hljs-params,.hljs-type{color:#0aaeb3}.hljs-string{color:#98bc37}.hljs-addition,.hljs-built_in,.hljs-builtin-name,.hljs-selector-attr,.hljs-selector-id,.hljs-selector-pseudo,.hljs-subst,.hljs-symbol,.hljs-template-tag,.hljs-template-variable{color:#c07abe}.hljs-comment,.hljs-deletion,.hljs-meta{color:#918175}</style><h2 data-id="heading-0">前言</h2>
<p>本章学习Kafka的事务消息原理：</p>
<p>1）普通事务消息；</p>
<p>2）精确一次语义的事务消息；</p>
<p>注：本章基于Kafka2.6，无KRaft。</p>
<h2 data-id="heading-1">一、引入</h2>
<h3 data-id="heading-2">1-1、使用案例</h3>
<p>配置transactional.id事务id，同一时刻全局唯一。</p>
<p>Producer创建后需要执行一次<strong>initTransactions</strong>完成初始化工作。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception {
    <span class="hljs-type">Properties</span> <span class="hljs-variable">props</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Properties</span>();
    props.put(ProducerConfig.BOOTSTRAP_SERVERS_CONFIG, <span class="hljs-string">"localhost:9092"</span>);
    props.put(ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG, IntegerSerializer.class.getName());
    props.put(ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG, StringSerializer.class.getName());
    props.put(<span class="hljs-string">"transaction.timeout.ms"</span>, <span class="hljs-number">60000</span>);
    <span class="hljs-comment">// flink transactionalIdPrefix + "-" + subtaskId + "-" + checkpoint-id</span>
    props.put(<span class="hljs-string">"transactional.id"</span>, <span class="hljs-string">"kafkaSink-0-5"</span>);
    props.put(<span class="hljs-string">"enable.idempotence"</span>, <span class="hljs-literal">true</span>);
    <span class="hljs-keyword">try</span> (KafkaProducer&lt;Integer, String&gt; producer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">KafkaProducer</span>&lt;&gt;(props)) {
        <span class="hljs-comment">// 初始化FindCoordinatorRequest&amp;InitProducerIdRequest</span>
        producer.initTransactions();
        <span class="hljs-comment">// 执行5个事务</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++) {
            sendTx(producer);
        }
    }
}
</code></pre>
<p>Producer发送消息：</p>
<p>1）beginTransaction：纯内存状态变更，没有远程调用；</p>
<p>2）send：发送n条消息，可能涉及多个分区；</p>
<p>3）commitTransaction/abortTransaction：提交或回滚事务；</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendTx</span><span class="hljs-params">(KafkaProducer&lt;Integer, String&gt; producer)</span> {
    <span class="hljs-comment">// 执行一次事务</span>
    <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// State=READY-&gt;IN_TRANSACTION</span>
        producer.beginTransaction();
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">3</span>; i++) {
            <span class="hljs-comment">// 如果发送到新分区，将新分区加入事务 AddPartitionsToTxnRequest</span>
            <span class="hljs-comment">// i%2---指定发送分区0或1</span>
            ProducerRecord&lt;Integer, String&gt; record =
                        <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProducerRecord</span>&lt;&gt;(TOPIC, i % <span class="hljs-number">2</span>, i, <span class="hljs-string">"hello"</span>);
            Thread.sleep(<span class="hljs-number">1000L</span>);
        }
        <span class="hljs-comment">// 累积器满足条件，sender线程可能已经发送ProduceRequest...</span>
        <span class="hljs-comment">// 提交事务EndTxnRequest</span>
        producer.commitTransaction();
    } <span class="hljs-keyword">catch</span> (ProducerFencedException | InterruptException | TimeoutException e) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);
    } <span class="hljs-keyword">catch</span> (KafkaException e) {
        <span class="hljs-comment">// 回滚事务EndTxnRequest</span>
        producer.abortTransaction();
    }
}
</code></pre>
<h3 data-id="heading-3">1-2、流程概览</h3>
<p>initTransactions初始化：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7559b5d7d6df48f996aae6fc0eb14709~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP54y_6Zi_6LaK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763278241&amp;x-signature=WoV2tmd8iKlseXW2iLalCC6%2BT5o%3D" alt="image.png" loading="lazy"/></p>
<p>1）生产者→配置中的任意Broker：Metadata，获取所有broker节点信息用于建立连接；</p>
<p>2）生产者→最小负载Broker：FindCoordinator，获取事务协调者（和消费组协调者类似，一个transactional.id对应集群里的某个broker）；</p>
<p>3）生产者→协调者：InitProducerId，使用transactionId注册事务生产者，获取producerId和producerEpoch；</p>
<p>事务：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/08f92fef2b744c729230f7a9605fddc7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP54y_6Zi_6LaK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763278241&amp;x-signature=NZg1qkbCepFbP5FkGm77sliubjc%3D" alt="image.png" loading="lazy"/></p>
<p>1）生产者→最小负载Broker：Metadata，如果发送消息遇到没有元数据的topic，需要先获取topic元数据，得到分区信息，知道分区对应leaderBroker才能发送消息；</p>
<p>2）生产者→协调者：AddPartitionsToTxn * M，M=本轮事务中涉及的topic分区数量，如果发送消息遇到本轮事务中的新分区，需要将分区加入到事务中，后面协调者才能在提交或回滚时调用对应leaderBroker；</p>
<p>3）生产者→Broker1：Produce * X，X=消息批次数量；</p>
<p>4）生产者→Broker2：Produce * Y，Y=消息批次数量；</p>
<p>5）生产者→协调者：EndTxn * 1，告知事务提交或回滚；</p>
<p>6）协调者→Broker1：WriteTxnMarkers * 1，标记本轮事务提交或回滚；</p>
<p>7）协调者→Broker2：WriteTxnMarkers * 1；</p>
<h3 data-id="heading-4">1-3、配置说明</h3>
<p>在客户端侧有几个关联配置，相关逻辑见ProducerConfig#postProcessParsedConfig：</p>
<p>1）<strong>transactional.id</strong>：事务id，必须配置，<strong>同一时刻全局唯一</strong>，如果协调者发现冲突，则会返回ProducerFencedException异常，代表有另一个相同的事务生产者正在运行；</p>
<p>2）<strong>enable.idempotence</strong>：是否开启幂等，当配置transactional.id后，<strong>默认且强制为true</strong>；</p>
<p>3）<strong>acks</strong>：ack策略，当配置transactional.id后，<strong>默认且强制为-1</strong>，需要ISR都写入成功才响应客户端；</p>
<p>客户端其他配置：</p>
<p>1）<strong>transaction.timeout.ms</strong>：默认60s，超时事务协调者会自动回滚事务；</p>
<h3 data-id="heading-5">1-4、事务生产者概览</h3>
<p>KafkaProducer#configureTransactionState：事务生产者在KafkaProducer中会构建一个TransactionManager用于管理事务。</p>
<blockquote>
<p>如果未开启事务，仅开启幂等，也会构造TransactionManager。</p>
</blockquote>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> TransactionManager <span class="hljs-title function_">configureTransactionState</span><span class="hljs-params">(ProducerConfig config,
                                                 LogContext logContext)</span> {

  <span class="hljs-type">TransactionManager</span> <span class="hljs-variable">transactionManager</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
  <span class="hljs-keyword">if</span> (config.idempotenceEnabled()) {
      <span class="hljs-comment">// 只要开启幂等，就有TransactionManager</span>
      transactionManager = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransactionManager</span>(
          logContext,
          transactionalId,
          transactionTimeoutMs,
          retryBackoffMs,
          apiVersions,
          autoDowngradeTxnCommit);
      <span class="hljs-keyword">if</span> (transactionManager.isTransactional())
          log.info(<span class="hljs-string">"Instantiated a transactional producer."</span>);
      <span class="hljs-keyword">else</span>
          log.info(<span class="hljs-string">"Instantiated an idempotent producer."</span>);
  }
  <span class="hljs-keyword">return</span> transactionManager;
}
<span class="hljs-comment">// TransactionManager#isTransactional</span>
<span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isTransactional</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">return</span> transactionalId != <span class="hljs-literal">null</span>;
}
</code></pre>
<p>TransactionManager包含以下关键属性：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TransactionManager</span> {
    <span class="hljs-comment">// 事务id（transactional.id）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String transactionalId;
    <span class="hljs-comment">// 事务超时时间</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> transactionTimeoutMs;
    <span class="hljs-comment">// 管理分区当前发送序号</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> TopicPartitionBookkeeper topicPartitionBookkeeper;
    <span class="hljs-comment">// 分区 - 提交offset（暂时忽略，精确一次）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;TopicPartition, CommittedOffset&gt; pendingTxnOffsetCommits;
    <span class="hljs-comment">// 待发送的事务相关请求</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> PriorityQueue&lt;TxnRequestHandler&gt; pendingRequests;
    <span class="hljs-comment">// 事务中 Producer发送消息新包含的分区 待发送AddPartition</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Set&lt;TopicPartition&gt; newPartitionsInTransaction;
    <span class="hljs-comment">// 发送AddPartition还未收到响应的分区</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Set&lt;TopicPartition&gt; pendingPartitionsInTransaction;
    <span class="hljs-comment">// 完成AddPartition加入事务的分区</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Set&lt;TopicPartition&gt; partitionsInTransaction;
    <span class="hljs-keyword">private</span> TransactionalRequestResult pendingResult;
    <span class="hljs-comment">// 事务协调者Broker节点</span>
    <span class="hljs-keyword">private</span> Node transactionCoordinator;
    <span class="hljs-comment">// 消费组协调者Broker节点（暂时忽略，精确一次）</span>
    <span class="hljs-keyword">private</span> Node consumerGroupCoordinator;
    <span class="hljs-comment">// 状态</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> <span class="hljs-type">State</span> <span class="hljs-variable">currentState</span> <span class="hljs-operator">=</span> State.UNINITIALIZED;
    <span class="hljs-comment">// 上次异常</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> <span class="hljs-type">RuntimeException</span> <span class="hljs-variable">lastError</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
    <span class="hljs-comment">// producerId和producerEpoch</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> ProducerIdAndEpoch producerIdAndEpoch;
    <span class="hljs-comment">// 是否开始事务</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">transactionStarted</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;
    <span class="hljs-comment">// 是否需要升级producerEpoch</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">epochBumpRequired</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TopicPartitionBookkeeper</span> {
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;TopicPartition, TopicPartitionEntry&gt; 
                  topicPartitions = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
    }
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TopicPartitionEntry</span> {
        <span class="hljs-comment">// 下一个分配的序号</span>
        <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> nextSequence;
        <span class="hljs-comment">// 已发送消息的最后一个序号</span>
        <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> lastAckedSequence;
        <span class="hljs-comment">// 已发送批次，还未收到响应</span>
        <span class="hljs-keyword">private</span> SortedSet&lt;ProducerBatch&gt; inflightBatchesBySequence;
        <span class="hljs-comment">// 已发送消息的最后一个offset</span>
        <span class="hljs-keyword">private</span> <span class="hljs-type">long</span> lastAckedOffset;
    }
}
</code></pre>
<p>回顾Kafka生产者有两类线程：1）用户线程，调用KafkaProducer的api；2）Sender线程，与broker通讯。用户线程将消息放入消息累积器行成消息批次，Sender线程从累积器中获取消息批次发送给多个Broker。</p>
<p>Sender#runOnce：Sender线程无限循环逻辑。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">void</span> <span class="hljs-title function_">runOnce</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">if</span> (transactionManager != <span class="hljs-literal">null</span>) {
        <span class="hljs-comment">// 事务生产者特殊处理....</span>
        <span class="hljs-keyword">if</span> (maybeSendAndPollTransactionalRequest()) {
            <span class="hljs-comment">// 如果有事务相关请求发送，本轮不会发送ProduceRequest</span>
            <span class="hljs-keyword">return</span>;
        }
    }
    <span class="hljs-comment">// 非事务生产者，只需要发送ProduceRequest....</span>
    <span class="hljs-type">long</span> <span class="hljs-variable">currentTimeMs</span> <span class="hljs-operator">=</span> time.milliseconds();
    <span class="hljs-comment">// 从累积器拉取消息</span>
    <span class="hljs-type">long</span> <span class="hljs-variable">pollTimeout</span> <span class="hljs-operator">=</span> sendProducerData(currentTimeMs);
    <span class="hljs-comment">// 执行IO读写</span>
    client.poll(pollTimeout, currentTimeMs);
}
</code></pre>
<p>Sender#maybeSendAndPollTransactionalRequest：这里需要明确几点：</p>
<p>1）<strong>事务相关请求</strong>（如InitProducerId、AddPartitionsToTxn、EndTxn）<strong>会按序优先于ProduceRequest发送</strong>；</p>
<p>2）即使配置了linger.ms（默认0）等条件，只要事务提交，一定触发消息累积器的拉取条件；</p>
<p>3）发送事务请求前，需要事务协调者节点可达；</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">maybeSendAndPollTransactionalRequest</span><span class="hljs-params">()</span> {
    <span class="hljs-comment">// 如果仍有事务请求在处理中，则返回true，等待响应</span>
    <span class="hljs-keyword">if</span> (transactionManager.hasInFlightRequest()) {
        client.poll(retryBackoffMs, time.milliseconds());
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
    <span class="hljs-comment">// 事务回滚，响应所有消息批次异常</span>
    <span class="hljs-keyword">if</span> (transactionManager.hasAbortableError() 
                  || transactionManager.isAborting()) {
        <span class="hljs-keyword">if</span> (accumulator.hasIncomplete()) {
            <span class="hljs-type">RuntimeException</span> <span class="hljs-variable">exception</span> <span class="hljs-operator">=</span> transactionManager.lastError();
            accumulator.abortUndrainedBatches(exception);
        }
    }
    <span class="hljs-comment">// 一旦事务提交，强制触发累积器满足拉取条件</span>
    <span class="hljs-keyword">if</span> (transactionManager.isCompleting() &amp;&amp; !accumulator.flushInProgress()) {
        <span class="hljs-comment">// 标记累积器满足读取条件，sender线程会拉取消息批次投递到broker</span>
        accumulator.beginFlush();
    }
    <span class="hljs-comment">// pendingRequests中拉取事务请求</span>
    TransactionManager.<span class="hljs-type">TxnRequestHandler</span> <span class="hljs-variable">nextRequestHandler</span> <span class="hljs-operator">=</span> transactionManager.nextRequest(accumulator.hasIncomplete());
    <span class="hljs-comment">// 如果没有事务请求需要发送，可以发送ProduceRequest</span>
    <span class="hljs-keyword">if</span> (nextRequestHandler == <span class="hljs-literal">null</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    AbstractRequest.Builder&lt;?&gt; requestBuilder = nextRequestHandler.requestBuilder();
    <span class="hljs-type">Node</span> <span class="hljs-variable">targetNode</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// 1. 找事务协调者FindCoordinatorRequest --- 类似找消费组协调者</span>
        targetNode = awaitNodeReady(nextRequestHandler.coordinatorType());
        <span class="hljs-keyword">if</span> (targetNode == <span class="hljs-literal">null</span>) {
            maybeFindCoordinatorAndRetry(nextRequestHandler);
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        }
        <span class="hljs-keyword">if</span> (nextRequestHandler.isRetry())
            time.sleep(nextRequestHandler.retryBackoffMs());
        <span class="hljs-type">long</span> <span class="hljs-variable">currentTimeMs</span> <span class="hljs-operator">=</span> time.milliseconds();
        <span class="hljs-comment">// 2. 发送下一个事务请求</span>
        <span class="hljs-type">ClientRequest</span> <span class="hljs-variable">clientRequest</span> <span class="hljs-operator">=</span> client.newClientRequest(
            targetNode.idString(), requestBuilder, currentTimeMs, <span class="hljs-literal">true</span>, requestTimeoutMs, nextRequestHandler);
        client.send(clientRequest, currentTimeMs);
        <span class="hljs-comment">// 记录当前正在处理的请求id</span>
        transactionManager.setInFlightCorrelationId(clientRequest.correlationId());
        <span class="hljs-comment">// 执行IO操作</span>
        client.poll(retryBackoffMs, time.milliseconds());
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    } <span class="hljs-keyword">catch</span> (IOException e) {
        maybeFindCoordinatorAndRetry(nextRequestHandler);
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
}
</code></pre>
<h2 data-id="heading-6">二、初始化</h2>
<h3 data-id="heading-7">2-1、发现事务协调者</h3>
<p>每个事务id（transactional.id）对应一个事务协调者，处理事务相关请求。</p>
<p>Producer可以向任意Broker发起<strong>FindCoordinatorRequest</strong>，请求中key=事务id，keyType=1。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FindCoordinatorRequestData</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ApiMessage</span> {
    <span class="hljs-keyword">private</span> String key;
    <span class="hljs-comment">// 0-消费组协调者 1-事务协调者</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">byte</span> keyType;
}
<span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">CoordinatorType</span> {
    GROUP((<span class="hljs-type">byte</span>) <span class="hljs-number">0</span>), TRANSACTION((<span class="hljs-type">byte</span>) <span class="hljs-number">1</span>);
}
</code></pre>
<p>KafkaApis#handleFindCoordinatorRequest：Broker分配事务协调者的逻辑与消费组协调者完全一致。topic=__transaction_state默认有50个分区，计算分区=hash(事务id)%50，该分区对应leaderBroker即为当前事务id对应的协调者Broker。</p>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">handleFindCoordinatorRequest</span></span>(request: <span class="hljs-type">RequestChannel</span>.<span class="hljs-type">Request</span>): <span class="hljs-type">Unit</span> = {
    <span class="hljs-keyword">val</span> findCoordinatorRequest = request.body[<span class="hljs-type">FindCoordinatorRequest</span>]
    <span class="hljs-keyword">val</span> (partition, topicMetadata) = <span class="hljs-type">CoordinatorType</span>.forId(findCoordinatorRequest.data.keyType) <span class="hljs-keyword">match</span> {
      <span class="hljs-keyword">case</span> <span class="hljs-type">CoordinatorType</span>.<span class="hljs-type">GROUP</span> =&gt;
        <span class="hljs-comment">// 消费组协调者，topic=__consumer_offsets</span>
        <span class="hljs-keyword">val</span> partition = groupCoordinator.partitionFor(findCoordinatorRequest.data.key)
        <span class="hljs-keyword">val</span> metadata = getOrCreateInternalTopic(<span class="hljs-type">GROUP_METADATA_TOPIC_NAME</span>, request.context.listenerName)
        (partition, metadata)
      <span class="hljs-keyword">case</span> <span class="hljs-type">CoordinatorType</span>.<span class="hljs-type">TRANSACTION</span> =&gt;
        <span class="hljs-comment">// partition = hash(transactional.id)%50</span>
        <span class="hljs-keyword">val</span> partition = txnCoordinator.partitionFor(findCoordinatorRequest.data.key)
        <span class="hljs-comment">// 获取topic=__transaction_state元数据，如果没有则自动创建</span>
        <span class="hljs-keyword">val</span> metadata = getOrCreateInternalTopic(<span class="hljs-type">TRANSACTION_STATE_TOPIC_NAME</span>, request.context.listenerName)
        (partition, metadata)
    }
    <span class="hljs-comment">// 根据partitionId找到分区leader的端点</span>
    <span class="hljs-keyword">val</span> coordinatorEndpoint = topicMetadata.partitions.asScala
      .find(_.partitionIndex == partition)
      .filter(_.leaderId != <span class="hljs-type">MetadataResponse</span>.<span class="hljs-type">NO_LEADER_ID</span>)
      .flatMap(metadata =&gt; metadataCache.getAliveBroker(metadata.leaderId))
      .flatMap(_.getNode(request.context.listenerName))
      .filterNot(_.isEmpty)
}
</code></pre>
<h3 data-id="heading-8">2-2、获取producerId</h3>
<h4 data-id="heading-9">2-2-1、Producer</h4>
<p>KafkaProducer#initTransactions：用户线程block等待事务初始化完成。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 事务管理器</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> TransactionManager transactionManager;
<span class="hljs-comment">// IO线程</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Sender sender;
<span class="hljs-comment">// max.block.ms=60000 send最多block时长，默认60s</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> maxBlockTimeMs;
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initTransactions</span><span class="hljs-params">()</span> {
    <span class="hljs-type">TransactionalRequestResult</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> 
          transactionManager.initializeTransactions();
    sender.wakeup();
    result.await(maxBlockTimeMs, TimeUnit.MILLISECONDS);
}
</code></pre>
<p>TransactionManager#initializeTransactions：producer发送<strong>InitProducerIdRequest</strong>，获取ProducerIdAndEpoch。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> TransactionalRequestResult <span class="hljs-title function_">initializeTransactions</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">return</span> initializeTransactions(ProducerIdAndEpoch.NONE);
}
<span class="hljs-keyword">synchronized</span> TransactionalRequestResult <span class="hljs-title function_">initializeTransactions</span><span class="hljs-params">(ProducerIdAndEpoch producerIdAndEpoch)</span> {
    <span class="hljs-keyword">return</span> handleCachedTransactionRequestResult(() -&gt; {
        <span class="hljs-comment">// ...</span>
        <span class="hljs-comment">// InitProducerIdRequest入队</span>
        <span class="hljs-type">InitProducerIdRequestData</span> <span class="hljs-variable">requestData</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InitProducerIdRequestData</span>()
                <span class="hljs-comment">// 事务id</span>
                .setTransactionalId(transactionalId)
                <span class="hljs-comment">// 事务超时时间</span>
                .setTransactionTimeoutMs(transactionTimeoutMs)
                <span class="hljs-comment">// 当前pid和epoch（初始都是-1）</span>
                .setProducerId(producerIdAndEpoch.producerId)
                .setProducerEpoch(producerIdAndEpoch.epoch);
        <span class="hljs-type">InitProducerIdHandler</span> <span class="hljs-variable">handler</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InitProducerIdHandler</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InitProducerIdRequest</span>.Builder(requestData),
                isEpochBump);
        enqueueRequest(handler);
        <span class="hljs-keyword">return</span> handler.result;
    }, State.INITIALIZING);
}
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProducerIdAndEpoch</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> producerId;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-type">short</span> epoch;
}
</code></pre>
<h4 data-id="heading-10">2-2-2、协调者</h4>
<p>事务协调者Broker侧用<strong>TransactionStateManager</strong>管理事务状态。</p>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TransactionStateManager</span> </span>{
  <span class="hljs-comment">// __transaction_state协调者分区 - entry</span>
  <span class="hljs-keyword">val</span> transactionMetadataCache: mutable.<span class="hljs-type">Map</span>[<span class="hljs-type">Int</span>, <span class="hljs-type">TxnMetadataCacheEntry</span>];
}
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TxnMetadataCacheEntry</span>(<span class="hljs-params">
      // __transaction_state协调者分区leader epoch
      coordinatorEpoch: <span class="hljs-type">Int</span>,
      // 事务id - 事务元数据
      metadataPerTransactionalId: <span class="hljs-type">Pool</span>[<span class="hljs-type">String</span>, <span class="hljs-type">TransactionMetadata</span>]</span>) </span>{
}
<span class="hljs-comment">// 事务元数据</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TransactionMetadata</span>(<span class="hljs-params">
   // 事务id
   val transactionalId: <span class="hljs-type">String</span>,
   // producerId
   var producerId: <span class="hljs-type">Long</span>,
   var lastProducerId: <span class="hljs-type">Long</span>,
   // producerEpoch
   var producerEpoch: <span class="hljs-type">Short</span>,
   var lastProducerEpoch: <span class="hljs-type">Short</span>,
   // 事务超时时间 --- 客户端传入
   var txnTimeoutMs: <span class="hljs-type">Int</span>,
   // 当前事务状态
   var state: <span class="hljs-type">TransactionState</span>,
   // 处于事务中的消息所在topic分区
   val topicPartitions: mutable.<span class="hljs-type">Set</span>[<span class="hljs-type">TopicPartition</span>],
   // 事务开始时间
   @volatile var txnStartTimestamp: <span class="hljs-type">Long</span> = -1,
   // 上次更新时间
   @volatile var txnLastUpdateTimestamp: <span class="hljs-type">Long</span></span>) </span>
)
<span class="hljs-comment">// 事务元数据变更，属性几乎同TransactionMetadata</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TxnTransitMetadata</span>(<span class="hljs-params">producerId: <span class="hljs-type">Long</span>,
           lastProducerId: <span class="hljs-type">Long</span>,
           producerEpoch: <span class="hljs-type">Short</span>,
           lastProducerEpoch: <span class="hljs-type">Short</span>,
           txnTimeoutMs: <span class="hljs-type">Int</span>,
           txnState: <span class="hljs-type">TransactionState</span>,
           topicPartitions: immutable.<span class="hljs-type">Set</span>[<span class="hljs-type">TopicPartition</span>],
           txnStartTimestamp: <span class="hljs-type">Long</span>,
           txnLastUpdateTimestamp: <span class="hljs-type">Long</span></span>)</span>
</code></pre>
<p>TransactionCoordinator#handleInitProducerId：</p>
<p>1）如果只是幂等生产者，生成producerId直接返回；</p>
<p>2）客户端设置的事务超时时间不能大于服务端限制transaction.max.timeout.ms（默认15分钟）；</p>
<p>3）查询事务id是否已经存在<strong>TransactionMetadata</strong>事务元数据，否则生成一个producerId创建元数据；</p>
<p>4）组装元数据变更<strong>TxnTransitMetadata</strong>，比如producerEpoch++，事务超时时间更新；</p>
<p>5）将<strong>TxnTransitMetadata</strong>写入事务id对应的协调者分区，把<strong>TransactionMetadata</strong>更新到内存；</p>
<blockquote>
<p>producerId生成方式：每个broker从ZK的<strong>latest_producer_id_block</strong>节点获取步长1000的号段。如latest_producer_id_block={"version":1,"broker":111,"block_start":"11000","block_end":"11999"}，下次获取就是12000-12999。</p>
</blockquote>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">handleInitProducerId</span></span>(transactionalId: <span class="hljs-type">String</span>,
             transactionTimeoutMs: <span class="hljs-type">Int</span>,
             expectedProducerIdAndEpoch: <span class="hljs-type">Option</span>[<span class="hljs-type">ProducerIdAndEpoch</span>],
             responseCallback: <span class="hljs-type">InitProducerIdCallback</span>): <span class="hljs-type">Unit</span> = {
  <span class="hljs-keyword">if</span> (transactionalId == <span class="hljs-literal">null</span>) {
    <span class="hljs-comment">// 1. 如果是幂等生产者，则直接返回一个producerId</span>
    <span class="hljs-keyword">val</span> producerId = producerIdManager.generateProducerId()
    responseCallback(<span class="hljs-type">InitProducerIdResult</span>(producerId, producerEpoch = <span class="hljs-number">0</span>, <span class="hljs-type">Errors</span>.<span class="hljs-type">NONE</span>))
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!txnManager.validateTransactionTimeoutMs(transactionTimeoutMs)) {
    <span class="hljs-comment">// 2. 事务超时时间不能大于服务端限制transaction.max.timeout.ms=15分钟</span>
    responseCallback(initTransactionError(<span class="hljs-type">Errors</span>.<span class="hljs-type">INVALID_TRANSACTION_TIMEOUT</span>))
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">val</span> coordinatorEpochAndMetadata = txnManager.getTransactionState(transactionalId).flatMap {
      <span class="hljs-keyword">case</span> <span class="hljs-type">None</span> =&gt;
        <span class="hljs-comment">// 3. 如果transactionalId不存在，生成producerId，创建元数据</span>
        <span class="hljs-keyword">val</span> producerId = producerIdManager.generateProducerId()
        <span class="hljs-keyword">val</span> createdMetadata = <span class="hljs-keyword">new</span> <span class="hljs-type">TransactionMetadata</span>(
          transactionalId = transactionalId,
          producerId = producerId,
          lastProducerId = <span class="hljs-type">RecordBatch</span>.<span class="hljs-type">NO_PRODUCER_ID</span>,
          producerEpoch = <span class="hljs-type">RecordBatch</span>.<span class="hljs-type">NO_PRODUCER_EPOCH</span>,
          lastProducerEpoch = <span class="hljs-type">RecordBatch</span>.<span class="hljs-type">NO_PRODUCER_EPOCH</span>,
          txnTimeoutMs = transactionTimeoutMs,
          state = <span class="hljs-type">Empty</span>,
          topicPartitions = collection.mutable.<span class="hljs-type">Set</span>.empty[<span class="hljs-type">TopicPartition</span>],
          txnLastUpdateTimestamp = time.milliseconds())
        txnManager.putTransactionStateIfNotExists(createdMetadata)
        <span class="hljs-comment">// 否则直接用原来的元数据</span>
      <span class="hljs-keyword">case</span> <span class="hljs-type">Some</span>(epochAndTxnMetadata) =&gt; <span class="hljs-type">Right</span>(epochAndTxnMetadata)
    }
    <span class="hljs-keyword">val</span> result: <span class="hljs-type">ApiResult</span>[(<span class="hljs-type">Int</span>, <span class="hljs-type">TxnTransitMetadata</span>)] = coordinatorEpochAndMetadata.flatMap {
      existingEpochAndMetadata =&gt;
        <span class="hljs-keyword">val</span> coordinatorEpoch = existingEpochAndMetadata.coordinatorEpoch
        <span class="hljs-keyword">val</span> txnMetadata = existingEpochAndMetadata.transactionMetadata
        txnMetadata.inLock { <span class="hljs-comment">// 注意锁</span>
          <span class="hljs-comment">// 4. 组装元数据变更TxnTransitMetadata，如epoch++，事务超时时间变更</span>
          prepareInitProducerIdTransit(transactionalId, transactionTimeoutMs, coordinatorEpoch, txnMetadata,
            expectedProducerIdAndEpoch)
        }
    }
    result <span class="hljs-keyword">match</span> {
      <span class="hljs-keyword">case</span> <span class="hljs-type">Left</span>(error) =&gt;
        responseCallback(initTransactionError(error))
      <span class="hljs-keyword">case</span> <span class="hljs-type">Right</span>((coordinatorEpoch, newMetadata)) =&gt;
        <span class="hljs-keyword">if</span> (newMetadata.txnState == <span class="hljs-type">PrepareEpochFence</span>) {
            <span class="hljs-comment">// ... 事务id冲突</span>
        } <span class="hljs-keyword">else</span> {
          <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">sendPidResponseCallback</span></span>(error: <span class="hljs-type">Errors</span>): <span class="hljs-type">Unit</span> = {
            <span class="hljs-keyword">if</span> (error == <span class="hljs-type">Errors</span>.<span class="hljs-type">NONE</span>) {
              responseCallback(initTransactionMetadata(newMetadata))
            } <span class="hljs-keyword">else</span> {
              responseCallback(initTransactionError(error))
            }
          }
          <span class="hljs-comment">// 5. 写入__transaction_state协调者分区</span>
          <span class="hljs-comment">// key=transactionalId, value=TxnTransitMetadata(元数据变更)，更新内存元数据</span>
          txnManager.appendTransactionToLog(transactionalId, coordinatorEpoch, newMetadata, sendPidResponseCallback)
        }
    }
  }
}
</code></pre>
<p>TransactionCoordinator#prepareInitProducerIdTransit：在锁保护下，校验元数据是否允许初始化，返回元数据变更TxnTransitMetadata。</p>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">prepareInitProducerIdTransit</span></span>(transactionalId: <span class="hljs-type">String</span>,
      transactionTimeoutMs: <span class="hljs-type">Int</span>,
      coordinatorEpoch: <span class="hljs-type">Int</span>,
      txnMetadata: <span class="hljs-type">TransactionMetadata</span>,
      expectedProducerIdAndEpoch: <span class="hljs-type">Option</span>[<span class="hljs-type">ProducerIdAndEpoch</span>]):
                        <span class="hljs-type">ApiResult</span>[(<span class="hljs-type">Int</span>, <span class="hljs-type">TxnTransitMetadata</span>)] = {

    <span class="hljs-keyword">if</span> (txnMetadata.pendingTransitionInProgress) {
      <span class="hljs-comment">// 正在执行状态变更，返回重试</span>
      <span class="hljs-type">Left</span>(<span class="hljs-type">Errors</span>.<span class="hljs-type">CONCURRENT_TRANSACTIONS</span>)
    }
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!expectedProducerIdAndEpoch.forall(isValidProducerId)) {
      <span class="hljs-type">Left</span>(<span class="hljs-type">Errors</span>.<span class="hljs-type">INVALID_PRODUCER_EPOCH</span>)
    } <span class="hljs-keyword">else</span> {
      txnMetadata.state <span class="hljs-keyword">match</span> {
        <span class="hljs-keyword">case</span> <span class="hljs-type">PrepareAbort</span> | <span class="hljs-type">PrepareCommit</span> =&gt;
          <span class="hljs-comment">// 正在回滚/提交，返回重试</span>
          <span class="hljs-type">Left</span>(<span class="hljs-type">Errors</span>.<span class="hljs-type">CONCURRENT_TRANSACTIONS</span>)
        <span class="hljs-keyword">case</span> <span class="hljs-type">CompleteAbort</span> | <span class="hljs-type">CompleteCommit</span> | <span class="hljs-type">Empty</span> =&gt;
          <span class="hljs-comment">// 正常情况，进入这里</span>
          <span class="hljs-keyword">val</span> transitMetadataResult =
            <span class="hljs-keyword">if</span> (txnMetadata.isProducerEpochExhausted &amp;&amp;
                expectedProducerIdAndEpoch.forall(_.epoch == txnMetadata.producerEpoch)) {
              <span class="hljs-comment">// epoch已经到达Short.MaxValue - 1，生成新producerId</span>
              <span class="hljs-keyword">val</span> newProducerId = producerIdManager.generateProducerId()
              <span class="hljs-type">Right</span>(txnMetadata.prepareProducerIdRotation(newProducerId, transactionTimeoutMs, time.milliseconds(),
                expectedProducerIdAndEpoch.isDefined))
            } <span class="hljs-keyword">else</span> {
              <span class="hljs-comment">// 更新事务超时时间，epoch+1</span>
              txnMetadata.prepareIncrementProducerEpoch(transactionTimeoutMs, expectedProducerIdAndEpoch.map(_.epoch),
                time.milliseconds())
            }

          transitMetadataResult <span class="hljs-keyword">match</span> {
            <span class="hljs-keyword">case</span> <span class="hljs-type">Right</span>(transitMetadata) =&gt; <span class="hljs-type">Right</span>((coordinatorEpoch, transitMetadata))
            <span class="hljs-keyword">case</span> <span class="hljs-type">Left</span>(err) =&gt; <span class="hljs-type">Left</span>(err)
          }

        <span class="hljs-keyword">case</span> <span class="hljs-type">Ongoing</span> =&gt;
          <span class="hljs-comment">// 事务中，准备进入PrepareEpochFence</span>
          <span class="hljs-type">Right</span>(coordinatorEpoch, txnMetadata.prepareFenceProducerEpoch())
      }
    }
  }
</code></pre>
<p>TransactionStateManager#appendTransactionToLog：将元数据变更TxnTransitMetadata写入topic=__transaction_state下的协调者分区，最终应用到内存TransactionMetadata。</p>
<pre><code class="hljs language-scala" lang="scala">  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">appendTransactionToLog</span></span>(transactionalId: <span class="hljs-type">String</span>,
       coordinatorEpoch: <span class="hljs-type">Int</span>,
       newMetadata: <span class="hljs-type">TxnTransitMetadata</span>,
       responseCallback: <span class="hljs-type">Errors</span> =&gt; <span class="hljs-type">Unit</span>,
       retryOnError: <span class="hljs-type">Errors</span> =&gt; <span class="hljs-type">Boolean</span> = _ =&gt; <span class="hljs-literal">false</span>): <span class="hljs-type">Unit</span> = {
  <span class="hljs-keyword">val</span> keyBytes = <span class="hljs-type">TransactionLog</span>.keyToBytes(transactionalId)
  <span class="hljs-keyword">val</span> valueBytes = <span class="hljs-type">TransactionLog</span>.valueToBytes(newMetadata)
  <span class="hljs-keyword">val</span> timestamp = time.milliseconds()
  <span class="hljs-keyword">val</span> records = <span class="hljs-type">MemoryRecords</span>.withRecords(<span class="hljs-type">TransactionLog</span>.<span class="hljs-type">EnforcedCompressionType</span>, <span class="hljs-keyword">new</span> <span class="hljs-type">SimpleRecord</span>(timestamp, keyBytes, valueBytes))
  <span class="hljs-keyword">val</span> topicPartition = <span class="hljs-keyword">new</span> <span class="hljs-type">TopicPartition</span>(<span class="hljs-type">Topic</span>.<span class="hljs-type">TRANSACTION_STATE_TOPIC_NAME</span>, partitionFor(transactionalId))
  <span class="hljs-keyword">val</span> recordsPerPartition = <span class="hljs-type">Map</span>(topicPartition -&gt; records)
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">updateCacheCallback</span></span>(responseStatus: collection.<span class="hljs-type">Map</span>[<span class="hljs-type">TopicPartition</span>, <span class="hljs-type">PartitionResponse</span>]): <span class="hljs-type">Unit</span> = {
    <span class="hljs-keyword">if</span> (responseError == <span class="hljs-type">Errors</span>.<span class="hljs-type">NONE</span>) {
      getTransactionState(transactionalId) <span class="hljs-keyword">match</span> {
        <span class="hljs-keyword">case</span> <span class="hljs-type">Left</span>(err) =&gt;
          responseError = err
        <span class="hljs-keyword">case</span> <span class="hljs-type">Right</span>(<span class="hljs-type">Some</span>(epochAndMetadata)) =&gt;
          <span class="hljs-keyword">val</span> metadata = epochAndMetadata.transactionMetadata
          metadata.inLock {
            <span class="hljs-keyword">if</span> (epochAndMetadata.coordinatorEpoch != coordinatorEpoch) {
              responseError = <span class="hljs-type">Errors</span>.<span class="hljs-type">NOT_COORDINATOR</span>
            } <span class="hljs-keyword">else</span> {
              <span class="hljs-comment">// 2. 应用元数据变更TxnTransitMetadata到内存TransactionMetadata元数据</span>
              metadata.completeTransitionTo(newMetadata)
            }
          }
        <span class="hljs-keyword">case</span> <span class="hljs-type">Right</span>(<span class="hljs-type">None</span>) =&gt;
          responseError = <span class="hljs-type">Errors</span>.<span class="hljs-type">NOT_COORDINATOR</span>
      }
    } 
    responseCallback(responseError)
  }

  inReadLock(stateLock) {
    getTransactionState(transactionalId) <span class="hljs-keyword">match</span> {
      <span class="hljs-keyword">case</span> <span class="hljs-type">Right</span>(<span class="hljs-type">Some</span>(epochAndMetadata)) =&gt;
        <span class="hljs-comment">// 1. 写消息</span>
        replicaManager.appendRecords(
            <span class="hljs-comment">// 超时时间=事务超时时间</span>
            newMetadata.txnTimeoutMs.toLong,
            <span class="hljs-comment">// acks固定-1</span>
            <span class="hljs-type">TransactionLog</span>.<span class="hljs-type">EnforcedRequiredAcks</span>,
            internalTopicsAllowed = <span class="hljs-literal">true</span>,
            origin = <span class="hljs-type">AppendOrigin</span>.<span class="hljs-type">Coordinator</span>,
            recordsPerPartition,
            updateCacheCallback)
    }
  }
}
</code></pre>
<p><strong>后续所有的事务状态变化的流程大致都是</strong>：查询事务元数据TransactionMetadata→校验元数据→组装元数据变更TxnTransitMetadata→写消息到__transaction_state下的协调者分区→新元数据更新到内存。</p>
<p>可以想的到，只要写消息成功，后续所有事务状态都能通过回放消息恢复，更新状态到内存。这和消费组协调者的工作机制一样，只要__transaction_state的选出分区leader，回放消息，就可以把所有事务id的元数据TransactionMetadata更新到内存。</p>
<h2 data-id="heading-11">三、发消息</h2>
<h3 data-id="heading-12">3-1、分区加入事务</h3>
<p>考虑事务中存在<strong>不同分区的消息</strong>，而<strong>分区Leader是不同的Broker</strong>，生产者需要<strong>将事务中的分区上报给事务协调者</strong>，后续协调者提交或回滚事务需要通过分区找到相关Broker。</p>
<h4 data-id="heading-13">3-1-1、Producer</h4>
<p>KafkaProducer#doSend：Producer线程，将消息写入累积器后，将事务中新增的分区加入newPartitionsInTransaction。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> Future&lt;RecordMetadata&gt; <span class="hljs-title function_">doSend</span><span class="hljs-params">(ProducerRecord&lt;K, V&gt; record, Callback callback)</span> {
    <span class="hljs-comment">//【1】max.block.ms=60*1000，最多等待60s，要拿到metadata，包括集群broker信息，topic-partition信息</span>
    clusterAndWaitTime = waitOnMetadata(record.topic(), record.partition(), nowMs, maxBlockTimeMs);
    <span class="hljs-comment">// 【2】key/value序列化</span>
    <span class="hljs-comment">// ...</span>
    <span class="hljs-comment">// 【3】计算partition，如果ProducerRecord没显示指定分区，DefaultPartitioner</span>
    <span class="hljs-type">int</span> <span class="hljs-variable">partition</span> <span class="hljs-operator">=</span> partition(record, serializedKey, serializedValue, cluster);
    <span class="hljs-comment">// 【4】校验消息大小不能超过max.request.size = 1024 * 1024 = 1MB</span>
    <span class="hljs-type">int</span> <span class="hljs-variable">serializedSize</span> <span class="hljs-operator">=</span> AbstractRecords.estimateSizeInBytesUpperBound(...);
    <span class="hljs-comment">// 这里校验必须先执行producer.beginTransaction()，翻转内存状态为IN_TRANSACTION</span>
    <span class="hljs-keyword">if</span> (transactionManager != <span class="hljs-literal">null</span> &amp;&amp; transactionManager.isTransactional()) {
        transactionManager.failIfNotReadyForSend();
    }
    <span class="hljs-comment">// 【5】将消息加入累积器</span>
    RecordAccumulator.<span class="hljs-type">RecordAppendResult</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> accumulator.append(tp, timestamp, serializedKey,
            serializedValue, headers, interceptCallback, remainingWaitMs, <span class="hljs-literal">true</span>, nowMs);
    <span class="hljs-keyword">if</span> (transactionManager != <span class="hljs-literal">null</span> &amp;&amp; transactionManager.isTransactional())
        <span class="hljs-comment">// focus 分区加入事务</span>
        transactionManager.maybeAddPartitionToTransaction(tp);
    <span class="hljs-comment">// 【6】唤醒io线程发送消息</span>
    <span class="hljs-keyword">if</span> (result.batchIsFull || result.newBatchCreated) {
        <span class="hljs-built_in">this</span>.sender.wakeup();
    }
    <span class="hljs-keyword">return</span> result.future;
}
<span class="hljs-comment">// TransactionManager#maybeAddPartitionToTransaction</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">maybeAddPartitionToTransaction</span><span class="hljs-params">(TopicPartition topicPartition)</span> {
    <span class="hljs-comment">// 已经加入分区，忽略</span>
    <span class="hljs-keyword">if</span> (isPartitionAdded(topicPartition)
        || isPartitionPendingAdd(topicPartition))
        <span class="hljs-keyword">return</span>;
    <span class="hljs-comment">// 加入分区，待发送AddPartitionsToTxnRequest</span>
    topicPartitionBookkeeper.addPartition(topicPartition);
    newPartitionsInTransaction.add(topicPartition);
}
</code></pre>
<p>RecordAccumulator#shouldStopDrainBatchesForPartition：Sender线程，从累积器拉取消息批次，发现分区还未加入事务，则不会拉取并发送出去。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">shouldStopDrainBatchesForPartition</span><span class="hljs-params">(ProducerBatch first, TopicPartition tp)</span> {
    <span class="hljs-keyword">if</span> (transactionManager != <span class="hljs-literal">null</span>) {
        <span class="hljs-comment">// 分区还未加入事务（完成AddPartitionsToTxnRequest）不能发送出去</span>
        <span class="hljs-keyword">if</span> (!transactionManager.isSendToPartitionAllowed(tp))
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        <span class="hljs-comment">// ... 其他判断</span>
    }
}
<span class="hljs-comment">// TransactionManager#isSendToPartitionAllowed</span>
<span class="hljs-keyword">synchronized</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isSendToPartitionAllowed</span><span class="hljs-params">(TopicPartition tp)</span> {
    <span class="hljs-keyword">if</span> (hasFatalError())
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    <span class="hljs-comment">// 幂等生产者 || 分区还未进入事务</span>
    <span class="hljs-keyword">return</span> !isTransactional() || partitionsInTransaction.contains(tp);
}
</code></pre>
<p>TransactionManager#nextRequest：Sender线程，发现Producer发送消息导致有新分区加入事务，则发送<strong>AddPartitionsToTxnRequest</strong>，其中包含本次加入事务的n个分区。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">synchronized</span> TxnRequestHandler <span class="hljs-title function_">nextRequest</span><span class="hljs-params">(<span class="hljs-type">boolean</span> hasIncompleteBatches)</span> {
  <span class="hljs-comment">// producer线程发送的消息中，有新的分区加入事务，AddPartitionsToTxnRequest</span>
  <span class="hljs-keyword">if</span> (!newPartitionsInTransaction.isEmpty())
      enqueueRequest(addPartitionsToTransactionHandler());
  <span class="hljs-comment">// ...</span>
}
<span class="hljs-keyword">private</span> TxnRequestHandler <span class="hljs-title function_">addPartitionsToTransactionHandler</span><span class="hljs-params">()</span> {
    <span class="hljs-comment">// newPartitionsInTransaction -&gt; pendingPartitionsInTransaction</span>
    pendingPartitionsInTransaction.addAll(newPartitionsInTransaction);
    newPartitionsInTransaction.clear();
    AddPartitionsToTxnRequest.<span class="hljs-type">Builder</span> <span class="hljs-variable">builder</span> <span class="hljs-operator">=</span>
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">AddPartitionsToTxnRequest</span>.Builder(transactionalId,
            producerIdAndEpoch.producerId,
            producerIdAndEpoch.epoch,
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(pendingPartitionsInTransaction));
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AddPartitionsToTxnHandler</span>(builder);
}
</code></pre>
<p>AddPartitionsToTxnHandler：收到<strong>AddPartitionsToTxnResponse</strong>，部分异常可以reenqueue重试，部分异常直接fatal失败，正常情况下分区会正常进入事务，加入partitionsInTransaction集合。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AddPartitionsToTxnHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">TxnRequestHandler</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleResponse</span><span class="hljs-params">(AbstractResponse response)</span> {
        <span class="hljs-type">AddPartitionsToTxnResponse</span> <span class="hljs-variable">addPartitionsToTxnResponse</span> <span class="hljs-operator">=</span> (AddPartitionsToTxnResponse) response;
        <span class="hljs-comment">// 分区 - 是否成功加入事务</span>
        Map&lt;TopicPartition, Errors&gt; errors = addPartitionsToTxnResponse.errors();
        <span class="hljs-type">boolean</span> <span class="hljs-variable">hasPartitionErrors</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;
        Set&lt;String&gt; unauthorizedTopics = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;&gt;();
        retryBackoffMs = TransactionManager.<span class="hljs-built_in">this</span>.retryBackoffMs;
        <span class="hljs-keyword">for</span> (Map.Entry&lt;TopicPartition, Errors&gt; topicPartitionErrorEntry : errors.entrySet()) {
            <span class="hljs-type">TopicPartition</span> <span class="hljs-variable">topicPartition</span> <span class="hljs-operator">=</span> topicPartitionErrorEntry.getKey();
            <span class="hljs-type">Errors</span> <span class="hljs-variable">error</span> <span class="hljs-operator">=</span> topicPartitionErrorEntry.getValue();
            <span class="hljs-keyword">if</span> (error == Errors.NONE) {
                <span class="hljs-keyword">continue</span>;
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (error == Errors.COORDINATOR_NOT_AVAILABLE 
                       || error == Errors.NOT_COORDINATOR) {
                lookupCoordinator(FindCoordinatorRequest.CoordinatorType.TRANSACTION, transactionalId);
                reenqueue();
                <span class="hljs-keyword">return</span>;
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (error == Errors.CONCURRENT_TRANSACTIONS) {
                maybeOverrideRetryBackoffMs();
                reenqueue();
                <span class="hljs-keyword">return</span>;
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (error == Errors.INVALID_PRODUCER_EPOCH) {
                fatalError(error.exception());
                <span class="hljs-keyword">return</span>;
            } 
            <span class="hljs-comment">// ...</span>
        }
        Set&lt;TopicPartition&gt; partitions = errors.keySet();
        pendingPartitionsInTransaction.removeAll(partitions);
       <span class="hljs-comment">// ...</span>
        <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// 分区成功进入事务</span>
            partitionsInTransaction.addAll(partitions);
            transactionStarted = <span class="hljs-literal">true</span>;
            result.done();
        }
    }
}
</code></pre>
<h4 data-id="heading-14">3-1-2、协调者</h4>
<p>TransactionCoordinator#handleAddPartitionsToTransaction：</p>
<p>1）组装TxnTransitMetadata事务元数据变更，将请求中的分区加入；</p>
<p>2）写入__transaction_state对应协调者分区，并应用TxnTransitMetadata元数据变更到内存TransactionMetadata元数据；</p>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">handleAddPartitionsToTransaction</span></span>(transactionalId: <span class="hljs-type">String</span>,
               producerId: <span class="hljs-type">Long</span>,
               producerEpoch: <span class="hljs-type">Short</span>,
               partitions: collection.<span class="hljs-type">Set</span>[<span class="hljs-type">TopicPartition</span>],
               responseCallback: <span class="hljs-type">AddPartitionsCallback</span>): <span class="hljs-type">Unit</span> = {
  <span class="hljs-keyword">if</span> (transactionalId == <span class="hljs-literal">null</span> || transactionalId.isEmpty) {
    responseCallback(<span class="hljs-type">Errors</span>.<span class="hljs-type">INVALID_REQUEST</span>)
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">val</span> result: <span class="hljs-type">ApiResult</span>[(<span class="hljs-type">Int</span>, <span class="hljs-type">TxnTransitMetadata</span>)] = txnManager.getTransactionState(transactionalId).flatMap {
      <span class="hljs-keyword">case</span> <span class="hljs-type">None</span> =&gt; <span class="hljs-type">Left</span>(<span class="hljs-type">Errors</span>.<span class="hljs-type">INVALID_PRODUCER_ID_MAPPING</span>)
      <span class="hljs-keyword">case</span> <span class="hljs-type">Some</span>(epochAndMetadata) =&gt;
        <span class="hljs-keyword">val</span> coordinatorEpoch = epochAndMetadata.coordinatorEpoch
        <span class="hljs-keyword">val</span> txnMetadata = epochAndMetadata.transactionMetadata
        txnMetadata.inLock {
          <span class="hljs-comment">// 校验...</span>
          <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// 组装新的TxnTransitMetadata，producer加分区，状态Ongoing</span>
            <span class="hljs-type">Right</span>(coordinatorEpoch, txnMetadata.prepareAddPartitions(partitions.toSet, time.milliseconds()))
          }
        }
    }
    result <span class="hljs-keyword">match</span> {
      <span class="hljs-keyword">case</span> <span class="hljs-type">Left</span>(err) =&gt;
        responseCallback(err)
      <span class="hljs-keyword">case</span> <span class="hljs-type">Right</span>((coordinatorEpoch, newMetadata)) =&gt;
        <span class="hljs-comment">// 把新的TxnTransitMetadata写入__transaction_state，最终更新到transactionMetadataCache</span>
        txnManager.appendTransactionToLog(transactionalId, coordinatorEpoch, newMetadata, responseCallback)
    }
  }
}
<span class="hljs-comment">// TransactionMetadata#prepareAddPartitions</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">prepareAddPartitions</span></span>(addedTopicPartitions: immutable.<span class="hljs-type">Set</span>[<span class="hljs-type">TopicPartition</span>], updateTimestamp: <span class="hljs-type">Long</span>): <span class="hljs-type">TxnTransitMetadata</span> = {
  <span class="hljs-keyword">val</span> newTxnStartTimestamp = state <span class="hljs-keyword">match</span> {
    <span class="hljs-keyword">case</span> <span class="hljs-type">Empty</span> | <span class="hljs-type">CompleteAbort</span> | <span class="hljs-type">CompleteCommit</span> =&gt; updateTimestamp
    <span class="hljs-keyword">case</span> _ =&gt; txnStartTimestamp
  }
  prepareTransitionTo(<span class="hljs-type">Ongoing</span>, producerId, producerEpoch, lastProducerEpoch, txnTimeoutMs,
    (topicPartitions ++ addedTopicPartitions).toSet, newTxnStartTimestamp, updateTimestamp)
}
</code></pre>
<h3 data-id="heading-15">3-2、发送消息</h3>
<h4 data-id="heading-16">3-2-1、Producer</h4>
<p>RecordAccumulator#drainBatchesForOneNode：Sender线程从累积器拉取消息发送，需要为批次设置事务相关属性。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> List&lt;ProducerBatch&gt; <span class="hljs-title function_">drainBatchesForOneNode</span><span class="hljs-params">(Cluster cluster, Node node, <span class="hljs-type">int</span> maxSize, <span class="hljs-type">long</span> now)</span> {
    <span class="hljs-type">int</span> <span class="hljs-variable">size</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
    <span class="hljs-comment">// 遍历broker下的所有partition</span>
    List&lt;PartitionInfo&gt; parts = cluster.partitionsForNode(node.id());
    <span class="hljs-comment">// 需要发送的批次</span>
    List&lt;ProducerBatch&gt; ready = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
    <span class="hljs-type">int</span> <span class="hljs-variable">start</span> <span class="hljs-operator">=</span> drainIndex = drainIndex % parts.size();
    <span class="hljs-keyword">do</span> {
        <span class="hljs-type">PartitionInfo</span> <span class="hljs-variable">part</span> <span class="hljs-operator">=</span> parts.get(drainIndex);
        <span class="hljs-type">TopicPartition</span> <span class="hljs-variable">tp</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TopicPartition</span>(part.topic(), part.partition());
        <span class="hljs-built_in">this</span>.drainIndex = (<span class="hljs-built_in">this</span>.drainIndex + <span class="hljs-number">1</span>) % parts.size();
        <span class="hljs-keyword">if</span> (isMuted(tp))
            <span class="hljs-keyword">continue</span>;
        Deque&lt;ProducerBatch&gt; deque = getDeque(tp);
        <span class="hljs-keyword">if</span> (deque == <span class="hljs-literal">null</span>)
            <span class="hljs-keyword">continue</span>;
        <span class="hljs-keyword">synchronized</span> (deque) {
            <span class="hljs-type">ProducerBatch</span> <span class="hljs-variable">first</span> <span class="hljs-operator">=</span> deque.peekFirst();
            <span class="hljs-keyword">if</span> (first == <span class="hljs-literal">null</span>)
                <span class="hljs-keyword">continue</span>;
            <span class="hljs-comment">// 事务，部分场景下，不能发送消息，比如分区还未加入事务</span>
            <span class="hljs-keyword">if</span> (shouldStopDrainBatchesForPartition(first, tp))
                <span class="hljs-keyword">break</span>;
            <span class="hljs-type">boolean</span> <span class="hljs-variable">isTransactional</span> <span class="hljs-operator">=</span> transactionManager != <span class="hljs-literal">null</span> &amp;&amp; transactionManager.isTransactional();
            <span class="hljs-type">ProducerIdAndEpoch</span> <span class="hljs-variable">producerIdAndEpoch</span> <span class="hljs-operator">=</span>
                transactionManager != <span class="hljs-literal">null</span> ? transactionManager.producerIdAndEpoch() : <span class="hljs-literal">null</span>;
            <span class="hljs-type">ProducerBatch</span> <span class="hljs-variable">batch</span> <span class="hljs-operator">=</span> deque.pollFirst();
            <span class="hljs-keyword">if</span> (producerIdAndEpoch != <span class="hljs-literal">null</span> &amp;&amp; !batch.hasSequence()) {
                <span class="hljs-comment">// 设置 producerId+epoch+批次起始序号</span>
                <span class="hljs-comment">// 批次起始序号=每个producerEpoch从0开始的offset</span>
                batch.setProducerState(producerIdAndEpoch, transactionManager.sequenceNumber(batch.topicPartition), isTransactional);
                transactionManager.incrementSequenceNumber(batch.topicPartition, batch.recordCount);
                transactionManager.addInFlightBatch(batch);
            }
            <span class="hljs-comment">// 关闭批次，写入批次header</span>
            batch.close();
            size += batch.records().sizeInBytes();
            ready.add(batch);
            batch.drained(now);
        }
    } <span class="hljs-keyword">while</span> (start != drainIndex);
    <span class="hljs-keyword">return</span> ready;
}
</code></pre>
<p>ProducerBatch#setProducerState：对于每个消息批次，加入事务相关属性</p>
<p>1）producerId和producerEpoch；</p>
<p>2）baseSequence：当前事务id在这个分区下的消息序号，从0开始增加；</p>
<p>3）isTransactional：true</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setProducerState</span><span class="hljs-params">(ProducerIdAndEpoch producerIdAndEpoch, <span class="hljs-type">int</span> baseSequence, <span class="hljs-type">boolean</span> isTransactional)</span> {
    recordsBuilder.setProducerState(producerIdAndEpoch.producerId, producerIdAndEpoch.epoch, baseSequence, isTransactional);
}
<span class="hljs-comment">// MemoryRecordsBuilder#setProducerState</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setProducerState</span><span class="hljs-params">(<span class="hljs-type">long</span> producerId, <span class="hljs-type">short</span> producerEpoch, <span class="hljs-type">int</span> baseSequence, <span class="hljs-type">boolean</span> isTransactional)</span> {
    <span class="hljs-built_in">this</span>.producerId = producerId;
    <span class="hljs-built_in">this</span>.producerEpoch = producerEpoch;
    <span class="hljs-built_in">this</span>.baseSequence = baseSequence;
    <span class="hljs-built_in">this</span>.isTransactional = isTransactional;
}
</code></pre>
<p>TransactionManager：获取并增加分区消息序号。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 获取当前分区的发送序号</span>
<span class="hljs-keyword">synchronized</span> Integer <span class="hljs-title function_">sequenceNumber</span><span class="hljs-params">(TopicPartition topicPartition)</span> {
    <span class="hljs-keyword">return</span> topicPartitionBookkeeper.getPartition(topicPartition).nextSequence;
}
<span class="hljs-comment">// 增加序号 = 当前序号 + 本批次消息数量</span>
<span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">incrementSequenceNumber</span><span class="hljs-params">(TopicPartition topicPartition, <span class="hljs-type">int</span> increment)</span> {
    <span class="hljs-type">Integer</span> <span class="hljs-variable">currentSequence</span> <span class="hljs-operator">=</span> sequenceNumber(topicPartition);
    currentSequence = DefaultRecordBatch.incrementSequence(currentSequence, increment);
    topicPartitionBookkeeper.getPartition(topicPartition).nextSequence = currentSequence;
}
<span class="hljs-comment">// 管理每个分区的消息序号</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TopicPartitionBookkeeper</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;TopicPartition, TopicPartitionEntry&gt; topicPartitions;
}
<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TopicPartitionEntry</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> nextSequence;
}
</code></pre>
<p>最终ProduceRequest也会包含事务ID。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7ff36051bb6e4f069e64675b7af6013b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP54y_6Zi_6LaK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763278241&amp;x-signature=ht0kmLXj9ScCjqZNUoW5acwPdmM%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-17">3-2-2、Broker</h4>
<p>Log#append：在写用户消息流程中穿插事务处理。</p>
<p>1）analyzeAndValidateProducerState：maybeDuplicate幂等拦截+updatedProducers准备生产者事务状态更新；</p>
<p>2）segment.append：写数据；</p>
<p>3）producerStateManager.update：更新生产者事务状态；</p>
<p>4）maybeIncrementFirstUnstableOffset：更新LSO（lastStableOffset），RC隔离级别消费者在LSO之后的数据不可见；</p>
<blockquote>
<p>当前是写事务中的<strong>用户消息</strong>，部分逻辑不会经过。当提交/回滚事务，这里会写入<strong>控制消息</strong>。</p>
</blockquote>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">append</span></span>(records: <span class="hljs-type">MemoryRecords</span>,
                   origin: <span class="hljs-type">AppendOrigin</span>,
                   interBrokerProtocolVersion: <span class="hljs-type">ApiVersion</span>,
                   assignOffsets: <span class="hljs-type">Boolean</span>,
                   leaderEpoch: <span class="hljs-type">Int</span>,
                   ignoreRecordSize: <span class="hljs-type">Boolean</span>): <span class="hljs-type">LogAppendInfo</span> = {
  maybeHandleIOException(<span class="hljs-string">s"Error while appending records to <span class="hljs-subst">$topicPartition</span> in dir <span class="hljs-subst">${dir.getParent}</span>"</span>) {
    <span class="hljs-comment">// 1. 校验并组装LogAppendInfo</span>
    <span class="hljs-keyword">val</span> appendInfo = analyzeAndValidateRecords(records, origin, ignoreRecordSize)
    lock synchronized { <span class="hljs-comment">// log级别锁，同一个分区不能并发写</span>
      <span class="hljs-comment">// 校验并继续填充LogAppendInfo</span>
      <span class="hljs-comment">// ...</span>
      <span class="hljs-comment">// 2. 处理segment滚动</span>
      <span class="hljs-keyword">val</span> segment = maybeRoll(validRecords.sizeInBytes, appendInfo)
      <span class="hljs-keyword">val</span> logOffsetMetadata = <span class="hljs-type">LogOffsetMetadata</span>(
        messageOffset = appendInfo.firstOrLastOffsetOfFirstBatch,
        segmentBaseOffset = segment.baseOffset,
        relativePositionInSegment = segment.size)
      <span class="hljs-comment">// 【事务】幂等/事务处理（用户消息、控制消息）</span>
      <span class="hljs-comment">// case1 producer写入事务中的消息返回 updatedProducers = (producerId,ProducerAppendInfo生产者待更新状态)</span>
      <span class="hljs-comment">// case2 事务协调者写入控制批次 completedTxns（List[CompletedTxn]) = 当前写入控制批次（提交/回滚）</span>
      <span class="hljs-comment">// case3 maybeDuplicate（BatchMetadata） = 重复ProducerRequest幂等批次</span>
      <span class="hljs-keyword">val</span> (updatedProducers, completedTxns, maybeDuplicate) = analyzeAndValidateProducerState(
        logOffsetMetadata, validRecords, origin)
      <span class="hljs-comment">// 幂等命中直接返回（用户消息）</span>
      maybeDuplicate.foreach { duplicate =&gt;
        appendInfo.firstOffset = <span class="hljs-type">Some</span>(duplicate.firstOffset)
        appendInfo.lastOffset = duplicate.lastOffset
        appendInfo.logAppendTime = duplicate.timestamp
        appendInfo.logStartOffset = logStartOffset
        <span class="hljs-keyword">return</span> appendInfo
      }
      <span class="hljs-comment">// 3. 写segment（用户消息、控制消息）</span>
      segment.append(largestOffset = appendInfo.lastOffset,
        largestTimestamp = appendInfo.maxTimestamp,
        shallowOffsetOfMaxTimestamp = appendInfo.offsetOfMaxTimestamp,
        records = validRecords)
      <span class="hljs-comment">// 4. 更新LEO，下次append的批次的offset从这里开始</span>
      updateLogEndOffset(appendInfo.lastOffset + <span class="hljs-number">1</span>)
      <span class="hljs-comment">// 【事务】处理生产者状态（用户消息、控制消息）</span>
      <span class="hljs-comment">// 1. ongoingTxns.put(batch.first, List[TxnMetadata])</span>
      <span class="hljs-comment">// 2. 记录producerId最近n个BatchMetadata用于幂等校验</span>
      <span class="hljs-keyword">for</span> (producerAppendInfo &lt;- updatedProducers.values) {
        producerStateManager.update(producerAppendInfo)
      }
      <span class="hljs-comment">// 【事务】处理完成的事务（控制消息）</span>
      <span class="hljs-keyword">for</span> (completedTxn &lt;- completedTxns) {
        <span class="hljs-comment">// 计算分区新LSO</span>
        <span class="hljs-keyword">val</span> lastStableOffset = producerStateManager.lastStableOffset(completedTxn)
        <span class="hljs-comment">// 如果Abort，插入事务索引</span>
        segment.updateTxnIndex(completedTxn, lastStableOffset)
        <span class="hljs-comment">// ongoingTxns-批次-&gt;unreplicatedTxns</span>
        producerStateManager.completeTxn(completedTxn)
      }
      producerStateManager.updateMapEndOffset(appendInfo.lastOffset + <span class="hljs-number">1</span>)
      <span class="hljs-comment">// 【事务】更新unstable offset（用户消息、控制消息）</span>
      maybeIncrementFirstUnstableOffset()
      <span class="hljs-comment">// 5. 刷盘逻辑，flush.messages=Long.MAX_VALUE，配置成1则每次append都fsync</span>
      <span class="hljs-keyword">if</span> (unflushedMessages &gt;= config.flushInterval)
        flush()
      <span class="hljs-comment">// 返回LogAppendInfo</span>
      appendInfo
    }
  }
}
</code></pre>
<p><strong>ProducerStateManager</strong>维护了一个分区Log下的生产者状态和事务状态。</p>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Log</span>(<span class="hljs-params">val topicPartition: <span class="hljs-type">TopicPartition</span>,
          val producerStateManager: <span class="hljs-type">ProducerStateManager</span></span>) </span>{}
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ProducerStateManager</span>(<span class="hljs-params">val topicPartition: <span class="hljs-type">TopicPartition</span></span>) </span>{
  <span class="hljs-comment">// producerId -&gt; producer状态</span>
  <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> producers = mutable.<span class="hljs-type">Map</span>.empty[<span class="hljs-type">Long</span>, <span class="hljs-type">ProducerStateEntry</span>]
  <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> lastMapOffset = <span class="hljs-number">0</span>L
  <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> lastSnapOffset = <span class="hljs-number">0</span>L
  <span class="hljs-comment">// 还未提交的事务：消息批次起始offset -&gt; 事务元数据</span>
  <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> ongoingTxns = <span class="hljs-keyword">new</span> util.<span class="hljs-type">TreeMap</span>[<span class="hljs-type">Long</span>, <span class="hljs-type">TxnMetadata</span>]
  <span class="hljs-comment">// 已经提交/回滚的事务，但是还未复制到slave：消息批次起始offset -&gt; 事务元数据</span>
  <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> unreplicatedTxns = <span class="hljs-keyword">new</span> util.<span class="hljs-type">TreeMap</span>[<span class="hljs-type">Long</span>, <span class="hljs-type">TxnMetadata</span>]
}
</code></pre>
<p><strong>ProducerStateEntry</strong>维护了一个分区下一个生产者的状态，包含最近5个批次的元数据<strong>BatchMetadata</strong>。</p>
<p><strong>BatchMetadata</strong>批次元数据，包含批次的offset和seq序号（起始和结束）等，每次写入消息成功后会更新。</p>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-keyword">private</span>[log] <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ProducerStateEntry</span>(<span class="hljs-params">val producerId: <span class="hljs-type">Long</span>,
               // 最近5个批次的元数据
                val batchMetadata: mutable.<span class="hljs-type">Queue</span>[<span class="hljs-type">BatchMetadata</span>],
                // 当前producer的epoch
                var producerEpoch: <span class="hljs-type">Short</span>,
               // 协调者分区leaderEpoch
                var coordinatorEpoch: <span class="hljs-type">Int</span>,
                var lastTimestamp: <span class="hljs-type">Long</span>,
                // 当前处于事务中的第一个offset
                var currentTxnFirstOffset: <span class="hljs-type">Option</span>[<span class="hljs-type">Long</span>]</span>) </span>{}
<span class="hljs-keyword">private</span>[log] <span class="hljs-keyword">case</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BatchMetadata</span>(<span class="hljs-params">
  lastSeq: <span class="hljs-type">Int</span>, lastOffset: <span class="hljs-type">Long</span>, offsetDelta: <span class="hljs-type">Int</span>, timestamp: <span class="hljs-type">Long</span></span>) </span>{
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">firstSeq</span></span>: <span class="hljs-type">Int</span> = <span class="hljs-type">DefaultRecordBatch</span>.decrementSequence(lastSeq, offsetDelta)
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">firstOffset</span></span>: <span class="hljs-type">Long</span> = lastOffset - offsetDelta
}
</code></pre>
<h5 data-id="heading-18">幂等校验</h5>
<p>每个分区每个producerId缓存了5个消息批次元数据。写消息前根据消息批次序号，查询是否有重复的消息实现幂等。如果发现重复消息，像正常写入成功一样，直接响应客户端成功。</p>
<p>analyzeAndValidateProducerState→ProducerStateEntry#findDuplicateBatch：</p>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-keyword">val</span> batchMetadata: mutable.<span class="hljs-type">Queue</span>[<span class="hljs-type">BatchMetadata</span>]
<span class="hljs-comment">// 写消息前，从元数据队列中，根据序号查询相同的批次</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">findDuplicateBatch</span></span>(batch: <span class="hljs-type">RecordBatch</span>): <span class="hljs-type">Option</span>[<span class="hljs-type">BatchMetadata</span>] = {
  <span class="hljs-keyword">if</span> (batch.producerEpoch != producerEpoch)
     <span class="hljs-type">None</span>
  <span class="hljs-keyword">else</span>
    batchWithSequenceRange(batch.baseSequence, batch.lastSequence)
}
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">batchWithSequenceRange</span></span>(firstSeq: <span class="hljs-type">Int</span>, lastSeq: <span class="hljs-type">Int</span>): <span class="hljs-type">Option</span>[<span class="hljs-type">BatchMetadata</span>] = {
  <span class="hljs-keyword">val</span> duplicate = batchMetadata.filter { metadata =&gt;
    firstSeq == metadata.firstSeq &amp;&amp; lastSeq == metadata.lastSeq
  }
  duplicate.headOption
}
<span class="hljs-comment">// 写消息后，将批次元数据入队，只保留5个</span>
<span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">addBatchMetadata</span></span>(batch: <span class="hljs-type">BatchMetadata</span>): <span class="hljs-type">Unit</span> = {
  <span class="hljs-keyword">if</span> (batchMetadata.size == <span class="hljs-number">5</span>)
    batchMetadata.dequeue()
  batchMetadata.enqueue(batch)
}
</code></pre>
<p>这种幂等校验方式的前提是，<strong>每个分区每个生产者严格按照消息批次设置的序号发送</strong>。</p>
<p>一方面，客户端重试时，需要将消息批次按照顺序重新进入发送队列。</p>
<p>ProducerAppendInfo#checkSequence：另一方面，broker写消息前，需要<strong>校验序号连续</strong>。</p>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">checkSequence</span></span>(producerEpoch: <span class="hljs-type">Short</span>, appendFirstSeq: <span class="hljs-type">Int</span>, offset: <span class="hljs-type">Long</span>): <span class="hljs-type">Unit</span> = {
  <span class="hljs-keyword">if</span> (producerEpoch != updatedEntry.producerEpoch) {
    <span class="hljs-comment">// producerEpoch发生变化，所有序号会被清空</span>
    <span class="hljs-keyword">if</span> (appendFirstSeq != <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">if</span> (updatedEntry.producerEpoch != <span class="hljs-type">RecordBatch</span>.<span class="hljs-type">NO_PRODUCER_EPOCH</span>) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-type">OutOfOrderSequenceException</span>()
      }
    }
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// 当前迭代的批次，是本次ProduceRequest批次中非首个，取已经迭代的批次最后一个</span>
    <span class="hljs-keyword">val</span> currentLastSeq = <span class="hljs-keyword">if</span> (!updatedEntry.isEmpty)
      updatedEntry.lastSeq
    <span class="hljs-comment">// 当前迭代的批次，是本次ProduceRequest批次中第一个，取broker内存里的最后一个序号</span>
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (producerEpoch == currentEntry.producerEpoch)
      currentEntry.lastSeq
    <span class="hljs-keyword">else</span>
      <span class="hljs-type">RecordBatch</span>.<span class="hljs-type">NO_SEQUENCE</span>
    <span class="hljs-keyword">if</span> (!(currentEntry.producerEpoch == <span class="hljs-type">RecordBatch</span>.<span class="hljs-type">NO_PRODUCER_EPOCH</span> || inSequence(currentLastSeq, appendFirstSeq))) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-type">OutOfOrderSequenceException</span>()
    }
  }
}
<span class="hljs-comment">// lastSeq=已经校验通过的最后一个序号；nextSeq=待校验的起始序号</span>
<span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">inSequence</span></span>(lastSeq: <span class="hljs-type">Int</span>, nextSeq: <span class="hljs-type">Int</span>): <span class="hljs-type">Boolean</span> = {
  nextSeq == lastSeq + <span class="hljs-number">1</span>L || (nextSeq == <span class="hljs-number">0</span> &amp;&amp; lastSeq == <span class="hljs-type">Int</span>.<span class="hljs-type">MaxValue</span>)
}
</code></pre>
<h5 data-id="heading-19">消息不可见</h5>
<p>事务消息的另一个关键点就是可见性。</p>
<p>Log#lastStableOffset：为了让消息在事务提交前不可见，每个分区维护了一个<strong>LSO</strong>（last stable offset）。</p>
<p>如果分区没有事务，则LSO=高水位；反之LSO=当前事务中的最小offset=<strong>firstUnstableOffset</strong>。</p>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-comment">// 事务中最小offset</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> firstUnstableOffsetMetadata: <span class="hljs-type">Option</span>[<span class="hljs-type">LogOffsetMetadata</span>] = <span class="hljs-type">None</span>
<span class="hljs-comment">// LSO</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">lastStableOffset</span></span>: <span class="hljs-type">Long</span> = {
  firstUnstableOffsetMetadata <span class="hljs-keyword">match</span> {
    <span class="hljs-keyword">case</span> <span class="hljs-type">Some</span>(offsetMetadata) <span class="hljs-keyword">if</span> offsetMetadata.messageOffset &lt; highWatermark =&gt; offsetMetadata.messageOffset
    <span class="hljs-keyword">case</span> _ =&gt; highWatermark
  }
}
</code></pre>
<p>broker侧<strong>重置消费进度</strong>和<strong>拉取消息</strong>，都会根据隔离级别，限制消费者可见offset。</p>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-comment">// ListOffsetRequest消费组没有消费进度，重置消费进度，broker根据隔离级别返回</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">fetchOffsetForTimestamp</span></span>(timestamp: <span class="hljs-type">Long</span>,
                          isolationLevel: <span class="hljs-type">Option</span>[<span class="hljs-type">IsolationLevel</span>],
                          currentLeaderEpoch: <span class="hljs-type">Optional</span>[<span class="hljs-type">Integer</span>],
                          fetchOnlyFromLeader: <span class="hljs-type">Boolean</span>): <span class="hljs-type">Option</span>[<span class="hljs-type">TimestampAndOffset</span>] = inReadLock(leaderIsrUpdateLock) {
  <span class="hljs-comment">// 最大可拉取的offset</span>
  <span class="hljs-keyword">val</span> lastFetchableOffset = isolationLevel <span class="hljs-keyword">match</span> {
    <span class="hljs-comment">// 事务消息相关，消费者设置READ_COMMITTED隔离级别，只能消费LSO</span>
    <span class="hljs-keyword">case</span> <span class="hljs-type">Some</span>(<span class="hljs-type">IsolationLevel</span>.<span class="hljs-type">READ_COMMITTED</span>) =&gt; localLog.lastStableOffset
    <span class="hljs-comment">// 普通消费者，能消费HW之前的数据，HW高水位=min(ISR副本的写入进度LEO）</span>
    <span class="hljs-keyword">case</span> <span class="hljs-type">Some</span>(<span class="hljs-type">IsolationLevel</span>.<span class="hljs-type">READ_UNCOMMITTED</span>) =&gt; localLog.highWatermark
  }
  <span class="hljs-comment">// ...</span>
}
<span class="hljs-comment">// FetchRequest真实拉取消息</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">read</span></span>(startOffset: <span class="hljs-type">Long</span>,
           maxLength: <span class="hljs-type">Int</span>,
           isolation: <span class="hljs-type">FetchIsolation</span>,
           minOneMessage: <span class="hljs-type">Boolean</span>): <span class="hljs-type">FetchDataInfo</span> = {
    <span class="hljs-comment">// 根据隔离级别，决定最大可读offset</span>
    <span class="hljs-keyword">val</span> maxOffsetMetadata = isolation <span class="hljs-keyword">match</span> {
      <span class="hljs-comment">// slave同步，可以取LEO当前写入进度</span>
      <span class="hljs-keyword">case</span> <span class="hljs-type">FetchLogEnd</span> =&gt; endOffsetMetadata
      <span class="hljs-comment">// READ_UNCOMMITTED级别（默认），取HW高水位</span>
      <span class="hljs-keyword">case</span> <span class="hljs-type">FetchHighWatermark</span> =&gt; fetchHighWatermarkMetadata
      <span class="hljs-comment">// RC级别，取LSO</span>
      <span class="hljs-keyword">case</span> <span class="hljs-type">FetchTxnCommitted</span> =&gt; fetchLastStableOffsetMetadata
    }
}
</code></pre>
<p>综上，LSO取决于当前事务中的最小offset。现在关注broker接收用户事务消息。</p>
<p>生产者开启事务并没有远程调用，所以<strong>事务开始的标记取决于broker收到第一个事务消息批次</strong>。</p>
<p>ProducerStateManager#update：当消息写入完毕，如果生产者在这个分区首次发送消息批次，在<strong>ongoingTxns</strong>中记录事务开始的消息offset。</p>
<blockquote>
<p>ongoingTxns记录了这个分区下n个生产者正在执行的事务的起始offset。</p>
</blockquote>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-comment">// producerId -&gt; producer状态</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> producers = mutable.<span class="hljs-type">Map</span>.empty[<span class="hljs-type">Long</span>, <span class="hljs-type">ProducerStateEntry</span>]
<span class="hljs-comment">// 还未提交的事务：消息批次起始offset -&gt; 事务元数据</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> ongoingTxns = <span class="hljs-keyword">new</span> util.<span class="hljs-type">TreeMap</span>[<span class="hljs-type">Long</span>, <span class="hljs-type">TxnMetadata</span>]
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">update</span></span>(appendInfo: <span class="hljs-type">ProducerAppendInfo</span>): <span class="hljs-type">Unit</span> = {
  <span class="hljs-comment">// 更新producer状态</span>
  <span class="hljs-keyword">val</span> updatedEntry = appendInfo.toEntry
  producers.get(appendInfo.producerId) <span class="hljs-keyword">match</span> {
    <span class="hljs-keyword">case</span> <span class="hljs-type">Some</span>(currentEntry) =&gt;
      currentEntry.update(updatedEntry)
    <span class="hljs-keyword">case</span> <span class="hljs-type">None</span> =&gt;
      producers.put(appendInfo.producerId, updatedEntry)
  }
  <span class="hljs-comment">// 如果producer在这个分区刚发送第一条批次消息，代表刚开始一个事务，加入ongoingTxns</span>
  appendInfo.startedTransactions.foreach { txn =&gt;
    ongoingTxns.put(txn.firstOffset.messageOffset, txn)
  }
}
</code></pre>
<p>Log#<strong>maybeIncrementFirstUnstableOffset</strong>：当<strong>新事务开启</strong>或<strong>高水位增加</strong>，该方法会被调用，用于更新<strong>firstUnstableOffset</strong>。</p>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> firstUnstableOffsetMetadata: <span class="hljs-type">Option</span>[<span class="hljs-type">LogOffsetMetadata</span>] = <span class="hljs-type">None</span>
<span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">maybeIncrementFirstUnstableOffset</span></span>(): <span class="hljs-type">Unit</span> = lock synchronized {
  <span class="hljs-comment">// 计算firstUnstableOffset</span>
  <span class="hljs-keyword">val</span> updatedFirstStableOffset = producerStateManager.firstUnstableOffset
  <span class="hljs-comment">//...</span>
  <span class="hljs-keyword">if</span> (updatedFirstStableOffset != <span class="hljs-keyword">this</span>.firstUnstableOffsetMetadata) {
    <span class="hljs-keyword">this</span>.firstUnstableOffsetMetadata = updatedFirstStableOffset
  }
}
</code></pre>
<p>ProducerStateManager#firstUnstableOffset：LSO计算逻辑如下，注意虽然每个生产者实例会按照顺序开始和结束事务，事务offset是有序的；但是多个生产者在这个分区里的事务offset是无序的，所以需要取min(事务中offset，提交或回滚中offset)。</p>
<blockquote>
<p>这里是处理用户消息，还没涉及到unreplicatedTxns，unreplicatedTxns需要在用户提交或回滚事务后加入。</p>
</blockquote>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-comment">// 还未提交的事务：消息批次起始offset -&gt; 事务元数据</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> ongoingTxns = <span class="hljs-keyword">new</span> util.<span class="hljs-type">TreeMap</span>[<span class="hljs-type">Long</span>, <span class="hljs-type">TxnMetadata</span>]
<span class="hljs-comment">// 已经提交/回滚的事务，但是还未复制到slave：消息批次起始offset -&gt; 事务元数据</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> unreplicatedTxns = <span class="hljs-keyword">new</span> util.<span class="hljs-type">TreeMap</span>[<span class="hljs-type">Long</span>, <span class="hljs-type">TxnMetadata</span>]
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">firstUnstableOffset</span></span>: <span class="hljs-type">Option</span>[<span class="hljs-type">LogOffsetMetadata</span>] = {
  <span class="hljs-comment">// 处于正在提交或回滚的最小offset</span>
  <span class="hljs-keyword">val</span> unreplicatedFirstOffset = <span class="hljs-type">Option</span>(unreplicatedTxns.firstEntry).map(_.getValue.firstOffset)
  <span class="hljs-comment">// 事务中的最小offset</span>
  <span class="hljs-keyword">val</span> undecidedFirstOffset = <span class="hljs-type">Option</span>(ongoingTxns.firstEntry).map(_.getValue.firstOffset)
  <span class="hljs-comment">// case2 没有正在提交或回滚的事务，取正在事务中的最小offset</span>
  <span class="hljs-keyword">if</span> (unreplicatedFirstOffset.isEmpty)
    undecidedFirstOffset
  <span class="hljs-comment">// case3 没有事务中，取正在提交或回滚的事务的最小offset</span>
  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (undecidedFirstOffset.isEmpty)
    unreplicatedFirstOffset
  <span class="hljs-comment">// case1 如果两者都存在，则取min(事务中，提交或回滚中)</span>
  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (undecidedFirstOffset.get.messageOffset &lt; unreplicatedFirstOffset.get.messageOffset)
    undecidedFirstOffset
  <span class="hljs-keyword">else</span>
    unreplicatedFirstOffset
}
</code></pre>
<h2 data-id="heading-20">四、结束事务</h2>
<h3 data-id="heading-21">4-1、producer</h3>
<p>KafkaProducer提交和回滚都会阻塞等待协调者响应。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// max.block.ms=60000 最多block时长，默认60s</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> maxBlockTimeMs;
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">commitTransaction</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> ProducerFencedException {
    <span class="hljs-type">TransactionalRequestResult</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> transactionManager.beginCommit();
    sender.wakeup();
    result.await(maxBlockTimeMs, TimeUnit.MILLISECONDS);
}
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">abortTransaction</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> ProducerFencedException {
    <span class="hljs-type">TransactionalRequestResult</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> transactionManager.beginAbort();
    sender.wakeup();
    result.await(maxBlockTimeMs, TimeUnit.MILLISECONDS);
}
</code></pre>
<p>TransactionManager#beginCompletingTransaction：无论提交回滚，都是发送<strong>EndTxnRequest</strong>，区别是committed标志为true或false。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> TransactionalRequestResult <span class="hljs-title function_">beginCompletingTransaction</span><span class="hljs-params">(TransactionResult transactionResult)</span> {
    <span class="hljs-comment">// 入队EndTxnRequest</span>
    EndTxnRequest.<span class="hljs-type">Builder</span> <span class="hljs-variable">builder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">EndTxnRequest</span>.Builder(
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">EndTxnRequestData</span>()
                    .setTransactionalId(transactionalId)
                    .setProducerId(producerIdAndEpoch.producerId)
                    .setProducerEpoch(producerIdAndEpoch.epoch)
                    .setCommitted(transactionResult.id));
    <span class="hljs-type">EndTxnHandler</span> <span class="hljs-variable">handler</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">EndTxnHandler</span>(builder);
    enqueueRequest(handler);
}
<span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">TransactionResult</span> {
    ABORT(<span class="hljs-literal">false</span>), COMMIT(<span class="hljs-literal">true</span>);
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> id;
}
</code></pre>
<p>EndTxnHandler#handleResponse：处理结束事务响应，部分异常可以重新入队自动重试；部分异常fatalError直接抛给用户；</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleResponse</span><span class="hljs-params">(AbstractResponse response)</span> {
    <span class="hljs-type">EndTxnResponse</span> <span class="hljs-variable">endTxnResponse</span> <span class="hljs-operator">=</span> (EndTxnResponse) response;
    <span class="hljs-type">Errors</span> <span class="hljs-variable">error</span> <span class="hljs-operator">=</span> endTxnResponse.error();
    <span class="hljs-keyword">if</span> (error == Errors.NONE) {
        completeTransaction();
        result.done();
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (error == Errors.COORDINATOR_NOT_AVAILABLE || error == Errors.NOT_COORDINATOR) {
        lookupCoordinator(FindCoordinatorRequest.CoordinatorType.TRANSACTION, transactionalId);
        reenqueue();
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (error == Errors.COORDINATOR_LOAD_IN_PROGRESS || error == Errors.CONCURRENT_TRANSACTIONS) {
        reenqueue();
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (error == Errors.INVALID_PRODUCER_EPOCH) {
        fatalError(error.exception());
    } 
    <span class="hljs-comment">// ...</span>
}
</code></pre>
<p>TransactionManager#completeTransaction：正常结束事务，清空所有状态，清空事务中的分区。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">completeTransaction</span><span class="hljs-params">()</span> {
    transitionTo(State.READY);
    lastError = <span class="hljs-literal">null</span>;
    epochBumpRequired = <span class="hljs-literal">false</span>;
    transactionStarted = <span class="hljs-literal">false</span>;
    newPartitionsInTransaction.clear();
    pendingPartitionsInTransaction.clear();
    partitionsInTransaction.clear();
}
</code></pre>
<h3 data-id="heading-22">4-2、协调者</h3>
<p>协调者还是一样，查询事务元数据TransactionMetadata→校验元数据→组装元数据变更TxnTransitMetadata→写消息到_<em>transaction</em>state下的协调者分区→新元数据更新到内存。</p>
<p>TransactionCoordinator#endTransaction：</p>
<p>1）正常情况，事务处于Ongoing状态（事务中），元数据只变更状态为PrepareCommit/PrepareAbort，即预提交/回滚；</p>
<p>2）如果事务已经提交，即CompleteCommit，可能是客户端侧超时重试，重复发来提交请求，直接返回成功；</p>
<p>3）如果事务提交中，即PrepareCommit，可能是客户端侧超时重试，返回CONCURRENT_TRANSACTIONS，客户端框架层面会自行requeue，重试EndTxnRequest；</p>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-keyword">val</span> preAppendResult: <span class="hljs-type">ApiResult</span>[(<span class="hljs-type">Int</span>, <span class="hljs-type">TxnTransitMetadata</span>)] = 
   <span class="hljs-comment">// 1. 查询事务元数据TransactionMetadata</span>
   txnManager.getTransactionState(transactionalId).flatMap {
    <span class="hljs-keyword">case</span> <span class="hljs-type">Some</span>(epochAndTxnMetadata) =&gt;
      <span class="hljs-keyword">val</span> txnMetadata = epochAndTxnMetadata.transactionMetadata
      <span class="hljs-keyword">val</span> coordinatorEpoch = epochAndTxnMetadata.coordinatorEpoch
      txnMetadata.inLock {
        <span class="hljs-comment">//... 2. 校验元数据 producerId producerEpoch等</span>
        txnMetadata.state <span class="hljs-keyword">match</span> {
          <span class="hljs-keyword">case</span> <span class="hljs-type">Ongoing</span> =&gt;
            <span class="hljs-comment">// 正常提交/回滚，走这里</span>
            <span class="hljs-keyword">val</span> nextState = <span class="hljs-keyword">if</span> (txnMarkerResult == <span class="hljs-type">TransactionResult</span>.<span class="hljs-type">COMMIT</span>)
              <span class="hljs-type">PrepareCommit</span>
            <span class="hljs-keyword">else</span>
              <span class="hljs-type">PrepareAbort</span>
            <span class="hljs-comment">// 3. 组装元数据变更TxnTransitMetadata</span>
            <span class="hljs-type">Right</span>(coordinatorEpoch, txnMetadata.prepareAbortOrCommit(nextState, time.milliseconds()))
         <span class="hljs-keyword">case</span> <span class="hljs-type">CompleteCommit</span> =&gt;
          <span class="hljs-comment">// 如果已经提交，返回成功</span>
          <span class="hljs-keyword">if</span> (txnMarkerResult == <span class="hljs-type">TransactionResult</span>.<span class="hljs-type">COMMIT</span>)
            <span class="hljs-type">Left</span>(<span class="hljs-type">Errors</span>.<span class="hljs-type">NONE</span>)
         <span class="hljs-keyword">case</span> <span class="hljs-type">PrepareCommit</span> =&gt;
          <span class="hljs-comment">// 如果提交中，返回CONCURRENT_TRANSACTIONS，客户端自动重试</span>
          <span class="hljs-keyword">if</span> (txnMarkerResult == <span class="hljs-type">TransactionResult</span>.<span class="hljs-type">COMMIT</span>)
            <span class="hljs-type">Left</span>(<span class="hljs-type">Errors</span>.<span class="hljs-type">CONCURRENT_TRANSACTIONS</span>)
         <span class="hljs-comment">//...</span>
        }
      }
   }
}
</code></pre>
<p>TransactionCoordinator#endTransaction：</p>
<p>4）预提交状态写消息成功后，新元数据更新到内存；</p>
<p>5）准备最终状态变更，状态=CompleteCommit/CompleteAbort，事务中的分区=空；</p>
<p>6）这里就直接响应客户端提交成功了，实际上还并没真实提交，后续状态推进由协调者完成，如果协调者宕机，新的协调者（这个transactionalId对应协调者分区leader）也可以发现有事务处于预提交状态，从7开始恢复；</p>
<p>7）协调者执行最终提交；</p>
<pre><code class="hljs language-scala" lang="scala">preAppendResult <span class="hljs-keyword">match</span> {
  <span class="hljs-keyword">case</span> <span class="hljs-type">Left</span>(err) =&gt;
    responseCallback(err)
  <span class="hljs-keyword">case</span> <span class="hljs-type">Right</span>((coordinatorEpoch, newMetadata)) =&gt;
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">sendTxnMarkersCallback</span></span>(error: <span class="hljs-type">Errors</span>): <span class="hljs-type">Unit</span> = {
      <span class="hljs-keyword">if</span> (error == <span class="hljs-type">Errors</span>.<span class="hljs-type">NONE</span>) {
        <span class="hljs-comment">// 5. 写PrepareCommit日志成功，再次准备下一次状态变更，校验元数据</span>
        <span class="hljs-keyword">val</span> preSendResult: <span class="hljs-type">ApiResult</span>[(<span class="hljs-type">TransactionMetadata</span>, <span class="hljs-type">TxnTransitMetadata</span>)] = txnManager.getTransactionState(transactionalId).flatMap {
          <span class="hljs-comment">//...</span>
        }
        preSendResult <span class="hljs-keyword">match</span> {
          <span class="hljs-keyword">case</span> <span class="hljs-type">Left</span>(err) =&gt;
            responseCallback(err)
          <span class="hljs-keyword">case</span> <span class="hljs-type">Right</span>((txnMetadata, newPreSendMetadata)) =&gt;
            <span class="hljs-comment">// 6. 响应客户端成功</span>
            responseCallback(<span class="hljs-type">Errors</span>.<span class="hljs-type">NONE</span>)
            <span class="hljs-comment">// 7. 发送 marker 给 事务中的broker</span>
            <span class="hljs-comment">// coordinatorEpoch = 协调者分区leaderEpoch，txnMarkerResult=提交/回滚</span>
            <span class="hljs-comment">// txnMetadata 状态=PrepareCommit/PrepareAbort</span>
            <span class="hljs-comment">// newPreSendMetadata 状态=CompleteCommit/CompleteAbort，分区=Empty</span>
            txnMarkerChannelManager.addTxnMarkersToSend(coordinatorEpoch, txnMarkerResult, txnMetadata, newPreSendMetadata)
        }
      } <span class="hljs-keyword">else</span> {
        responseCallback(error)
      }
    }
    <span class="hljs-comment">// 4. 写TxnTransitMetadata到__transaction_state，状态变更为newMetadata（PrepareCommit/PrepareAbort）</span>
    txnManager.appendTransactionToLog(transactionalId, coordinatorEpoch, newMetadata, sendTxnMarkersCallback)
}
</code></pre>
<p>TransactionMarkerChannelManager#addTxnMarkersToSend：</p>
<p>1）异步向事务涉及的broker（事务中注册的分区对应的leaderBroker）发送WriteTxnMarkersRequest；</p>
<p>2）如果所有broker响应成功，将事务元数据最终状态=CompleteCommit/CompleteAbort，分区=Empty，写入__transaction_state；（如果这里失败，这里有重试，忽略）</p>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">addTxnMarkersToSend</span></span>(coordinatorEpoch: <span class="hljs-type">Int</span>,
                          txnResult: <span class="hljs-type">TransactionResult</span>,
                          txnMetadata: <span class="hljs-type">TransactionMetadata</span>,
                          newMetadata: <span class="hljs-type">TxnTransitMetadata</span>): <span class="hljs-type">Unit</span> = {
  <span class="hljs-keyword">val</span> transactionalId = txnMetadata.transactionalId
  <span class="hljs-keyword">val</span> pendingCompleteTxn = <span class="hljs-type">PendingCompleteTxn</span>(
    transactionalId,
    coordinatorEpoch,
    txnMetadata,
    newMetadata)

  <span class="hljs-comment">// 待提交事务</span>
  transactionsWithPendingMarkers.put(transactionalId, pendingCompleteTxn)
  <span class="hljs-comment">// 事务包含多个分区，按照leaderBroker分组，异步发送WriteTxnMarkersRequest</span>
  addTxnMarkersToBrokerQueue(transactionalId, txnMetadata.producerId,
    txnMetadata.producerEpoch, txnResult, coordinatorEpoch, txnMetadata.topicPartitions.toSet)
  <span class="hljs-comment">// 如果事务提交成功，newMetadata写入__transaction_state</span>
  maybeWriteTxnCompletion(transactionalId)
}
</code></pre>
<p>TransactionMarkerChannelManager自身是一个线程，可以与broker通讯，发送WriteTxnMarkersRequest。</p>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TransactionMarkerChannelManager</span>(<span class="hljs-params">config: <span class="hljs-type">KafkaConfig</span>,
            metadataCache: <span class="hljs-type">MetadataCache</span>,
            networkClient: <span class="hljs-type">NetworkClient</span>,
            txnStateManager: <span class="hljs-type">TransactionStateManager</span>,
            time: <span class="hljs-type">Time</span></span>) </span>
  <span class="hljs-keyword">extends</span> <span class="hljs-type">InterBrokerSendThread</span>(<span class="hljs-string">"TxnMarkerSenderThread-"</span> + config.brokerId, networkClient, time) 
                          <span class="hljs-keyword">with</span> <span class="hljs-type">Logging</span> <span class="hljs-keyword">with</span> <span class="hljs-type">KafkaMetricsGroup</span> {
  <span class="hljs-comment">// brokerId -&gt; 待发送WriteTxnMarkersRequest</span>
  <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> markersQueuePerBroker: concurrent.<span class="hljs-type">Map</span>[<span class="hljs-type">Int</span>, <span class="hljs-type">TxnMarkerQueue</span>]
      = <span class="hljs-keyword">new</span> <span class="hljs-type">ConcurrentHashMap</span>[<span class="hljs-type">Int</span>, <span class="hljs-type">TxnMarkerQueue</span>]().asScala
}
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TxnMarkerQueue</span>(<span class="hljs-params">@volatile var destination: <span class="hljs-type">Node</span></span>) </span>{
  <span class="hljs-comment">// 分区 -&gt; 待发送WriteTxnMarkersRequest（无界队列）</span>
  <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> markersPerTxnTopicPartition 
      = <span class="hljs-keyword">new</span> <span class="hljs-type">ConcurrentHashMap</span>[<span class="hljs-type">Int</span>, <span class="hljs-type">BlockingQueue</span>[<span class="hljs-type">TxnIdAndMarkerEntry</span>]]().asScala
}
</code></pre>
<p>WriteTxnMarkersRequest：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WriteTxnMarkersRequest</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractRequest</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> WriteTxnMarkersRequestData data;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WriteTxnMarkersRequestData</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ApiMessage</span> {
      <span class="hljs-comment">// n个producer的结束事务可以批量发送</span>
      <span class="hljs-keyword">private</span> List&lt;WritableTxnMarker&gt; markers;
    }
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WritableTxnMarker</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Message</span> {
        <span class="hljs-keyword">private</span> <span class="hljs-type">long</span> producerId;
        <span class="hljs-keyword">private</span> <span class="hljs-type">short</span> producerEpoch;
        <span class="hljs-comment">// true-提交 false-回滚</span>
        <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> transactionResult;
        <span class="hljs-comment">// 事务里的n个topic分区</span>
        <span class="hljs-keyword">private</span> List&lt;WritableTxnMarkerTopic&gt; topics;
        <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> coordinatorEpoch;
    }
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WritableTxnMarkerTopic</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Message</span> {
      <span class="hljs-keyword">private</span> String name;
      <span class="hljs-keyword">private</span> List&lt;Integer&gt; partitionIndexes;
    }
}
</code></pre>
<h3 data-id="heading-23">4-3、broker</h3>
<p>各个broker中的事务相关分区，由于事务消息的写入，导致存在LSO，限制了RC隔离级别消费者消费。</p>
<p>当各broker处理完成协调者的WriteTxnMarkersRequest，LSO可能会增加，从而消费者可以消费到提交后的消息。</p>
<p>注意到WriteTxnMarkersRequest中没有offset相关概念，因为事务消息有顺序，只需要通过producerId就能从broker找到挂起的offset（broker管理了producer状态），从而改变LSO。</p>
<p>kafka.server.KafkaApis#handleWriteTxnMarkersRequest：对所有事务内的分区，写入事务提交/回滚标记<strong>EndTransactionMarker</strong>消息，称为<strong>控制批次controlBatch</strong>。</p>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-comment">// 写入控制批次</span>
<span class="hljs-keyword">val</span> controlRecords = partitionsWithCompatibleMessageFormat.map { partition =&gt;
  <span class="hljs-keyword">val</span> controlRecordType = marker.transactionResult <span class="hljs-keyword">match</span> {
    <span class="hljs-keyword">case</span> <span class="hljs-type">TransactionResult</span>.<span class="hljs-type">COMMIT</span> =&gt; <span class="hljs-type">ControlRecordType</span>.<span class="hljs-type">COMMIT</span>
    <span class="hljs-keyword">case</span> <span class="hljs-type">TransactionResult</span>.<span class="hljs-type">ABORT</span> =&gt; <span class="hljs-type">ControlRecordType</span>.<span class="hljs-type">ABORT</span>
  }
  <span class="hljs-keyword">val</span> endTxnMarker = <span class="hljs-keyword">new</span> <span class="hljs-type">EndTransactionMarker</span>(controlRecordType, marker.coordinatorEpoch)
  <span class="hljs-comment">// 分区 -&gt; 控制批次(key=提交/回滚,value=controllerEpoch-协调者分区的leaderEpoch)</span>
  <span class="hljs-comment">// 批次头包含producerId等</span>
  partition -&gt; <span class="hljs-type">MemoryRecords</span>.withEndTransactionMarker(producerId, marker.producerEpoch, endTxnMarker)
}.toMap

replicaManager.appendRecords(
  timeout = config.requestTimeoutMs.toLong,
  <span class="hljs-comment">// acks=-1</span>
  requiredAcks = <span class="hljs-number">-1</span>,
  internalTopicsAllowed = <span class="hljs-literal">true</span>,
  origin = <span class="hljs-type">AppendOrigin</span>.<span class="hljs-type">Coordinator</span>,
  entriesPerPartition = controlRecords,
  responseCallback = maybeSendResponseCallback(producerId, marker.transactionResult))
</code></pre>
<p>Log#append：写消息过程中处理控制批次逻辑。</p>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">append</span></span>(records: <span class="hljs-type">MemoryRecords</span>,
                   origin: <span class="hljs-type">AppendOrigin</span>,
                   interBrokerProtocolVersion: <span class="hljs-type">ApiVersion</span>,
                   assignOffsets: <span class="hljs-type">Boolean</span>,
                   leaderEpoch: <span class="hljs-type">Int</span>,
                   ignoreRecordSize: <span class="hljs-type">Boolean</span>): <span class="hljs-type">LogAppendInfo</span> = {
  maybeHandleIOException(<span class="hljs-string">s"Error while appending records to <span class="hljs-subst">$topicPartition</span> in dir <span class="hljs-subst">${dir.getParent}</span>"</span>) {
    <span class="hljs-comment">// 1. 校验并组装LogAppendInfo</span>
    <span class="hljs-keyword">val</span> appendInfo = analyzeAndValidateRecords(records, origin, ignoreRecordSize)
    lock synchronized { <span class="hljs-comment">// log级别锁，同一个分区不能并发写</span>
      <span class="hljs-comment">// 校验并继续填充LogAppendInfo</span>
      <span class="hljs-comment">// ...</span>
      <span class="hljs-comment">// 2. 处理segment滚动...</span>
      <span class="hljs-keyword">val</span> segment = maybeRoll(validRecords.sizeInBytes, appendInfo)
      <span class="hljs-keyword">val</span> logOffsetMetadata = <span class="hljs-type">LogOffsetMetadata</span>(
        messageOffset = appendInfo.firstOrLastOffsetOfFirstBatch,
        segmentBaseOffset = segment.baseOffset,
        relativePositionInSegment = segment.size)
      <span class="hljs-comment">// 【事务】幂等/事务处理（用户消息、控制消息）</span>
      <span class="hljs-comment">// case2 事务协调者写入控制批次 completedTxns（List[CompletedTxn]) = 当前写入控制批次（提交/回滚）</span>
      <span class="hljs-keyword">val</span> (updatedProducers, completedTxns, maybeDuplicate) = analyzeAndValidateProducerState(
        logOffsetMetadata, validRecords, origin)
      <span class="hljs-comment">// 幂等命中直接返回（用户消息）....</span>
      <span class="hljs-comment">// 3. 写segment（用户消息、控制消息）</span>
      segment.append(largestOffset = appendInfo.lastOffset,
        largestTimestamp = appendInfo.maxTimestamp,
        shallowOffsetOfMaxTimestamp = appendInfo.offsetOfMaxTimestamp,
        records = validRecords)
      <span class="hljs-comment">// 4. 更新LEO，下次append的批次的offset从这里开始</span>
      updateLogEndOffset(appendInfo.lastOffset + <span class="hljs-number">1</span>)
      <span class="hljs-comment">// 【事务】处理生产者状态（用户消息、控制消息）...</span>
      <span class="hljs-comment">// 【事务】处理完成的事务（控制消息）</span>
      <span class="hljs-keyword">for</span> (completedTxn &lt;- completedTxns) {
        <span class="hljs-comment">// 计算分区新LSO</span>
        <span class="hljs-keyword">val</span> lastStableOffset = producerStateManager.lastStableOffset(completedTxn)
        <span class="hljs-comment">// 如果Abort，插入事务索引</span>
        segment.updateTxnIndex(completedTxn, lastStableOffset)
        <span class="hljs-comment">// ongoingTxns-批次-&gt;unreplicatedTxns</span>
        producerStateManager.completeTxn(completedTxn)
      }
      producerStateManager.updateMapEndOffset(appendInfo.lastOffset + <span class="hljs-number">1</span>)
      <span class="hljs-comment">// 【事务】更新unstable offset（用户消息、控制消息）</span>
      maybeIncrementFirstUnstableOffset()
      <span class="hljs-comment">// 5. 刷盘逻辑，flush.messages=Long.MAX_VALUE，配置成1则每次append都fsync</span>
      <span class="hljs-keyword">if</span> (unflushedMessages &gt;= config.flushInterval)
        flush()
      <span class="hljs-comment">// 返回LogAppendInfo</span>
      appendInfo
    }
  }
}
</code></pre>
<p>ProducerAppendInfo#append：写控制批次前，校验并构造CompletedTxn和需要更新的ProducerStateEntry。</p>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">append</span></span>(batch: <span class="hljs-type">RecordBatch</span>, firstOffsetMetadataOpt: <span class="hljs-type">Option</span>[<span class="hljs-type">LogOffsetMetadata</span>]): <span class="hljs-type">Option</span>[<span class="hljs-type">CompletedTxn</span>] = {
  <span class="hljs-keyword">if</span> (batch.isControlBatch) {
    <span class="hljs-comment">// 控制批次</span>
    <span class="hljs-keyword">val</span> recordIterator = batch.iterator
    <span class="hljs-keyword">if</span> (recordIterator.hasNext) {
      <span class="hljs-keyword">val</span> record = recordIterator.next()
      <span class="hljs-keyword">val</span> endTxnMarker = <span class="hljs-type">EndTransactionMarker</span>.deserialize(record)
      <span class="hljs-comment">// 构造CompletedTxn和需要更新的ProducerStateEntry</span>
      <span class="hljs-keyword">val</span> completedTxn = appendEndTxnMarker(endTxnMarker, batch.producerEpoch, batch.baseOffset, record.timestamp)
      <span class="hljs-type">Some</span>(completedTxn)
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-type">None</span>
    }
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// 正常事务中的消息</span>
    <span class="hljs-keyword">val</span> firstOffsetMetadata = firstOffsetMetadataOpt.getOrElse(<span class="hljs-type">LogOffsetMetadata</span>(batch.baseOffset))
    appendDataBatch(batch.producerEpoch, batch.baseSequence, batch.lastSequence, batch.maxTimestamp,
      firstOffsetMetadata, batch.lastOffset, batch.isTransactional)
    <span class="hljs-type">None</span>
  }
}
<span class="hljs-comment">// ProducerAppendInfo#appendEndTxnMarker</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">appendEndTxnMarker</span></span>(endTxnMarker: <span class="hljs-type">EndTransactionMarker</span>,
                       producerEpoch: <span class="hljs-type">Short</span>,
                       offset: <span class="hljs-type">Long</span>,
                       timestamp: <span class="hljs-type">Long</span>): <span class="hljs-type">CompletedTxn</span> = {
  checkProducerEpoch(producerEpoch, offset)
  <span class="hljs-comment">// 如果发现controllerEpoch变更，异常</span>
  checkCoordinatorEpoch(endTxnMarker, offset)
  <span class="hljs-comment">// 当前挂起的offset</span>
  <span class="hljs-keyword">val</span> firstOffset = updatedEntry.currentTxnFirstOffset
  <span class="hljs-comment">// ...</span>
  updatedEntry.maybeUpdateProducerEpoch(producerEpoch)
  <span class="hljs-comment">// 设置producer没有挂起的offset</span>
  updatedEntry.currentTxnFirstOffset = <span class="hljs-type">None</span>
  updatedEntry.coordinatorEpoch = endTxnMarker.coordinatorEpoch
  updatedEntry.lastTimestamp = timestamp
  <span class="hljs-type">CompletedTxn</span>(producerId, firstOffset, offset, endTxnMarker.controlType == <span class="hljs-type">ControlRecordType</span>.<span class="hljs-type">ABORT</span>)
}
</code></pre>
<p>Log#append：leader写完控制批次消息后，会插入事务索引，并将这批控制消息对应的事务标记为unreplicatedTxns，因为还没复制给follower。</p>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-comment">// 【事务】处理完成的事务（当前写入控制批次）</span>
<span class="hljs-keyword">for</span> (completedTxn &lt;- completedTxns) {
  <span class="hljs-comment">// 计算分区新LSO</span>
  <span class="hljs-keyword">val</span> lastStableOffset = producerStateManager.lastStableOffset(completedTxn)
  <span class="hljs-comment">// 如果Abort，插入事务索引</span>
  segment.updateTxnIndex(completedTxn, lastStableOffset)
  <span class="hljs-comment">// ongoingTxns-批次-&gt;unreplicatedTxns</span>
  producerStateManager.completeTxn(completedTxn)
}
</code></pre>
<p>事务索引结构为AbortedTxn，最终落盘后体现为.txnindex文件，和其他索引一样，每segment一个。</p>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-keyword">private</span>[log] <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AbortedTxn</span>(<span class="hljs-params">val buffer: <span class="hljs-type">ByteBuffer</span></span>) </span>{
  <span class="hljs-keyword">import</span> <span class="hljs-type">AbortedTxn</span>._
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">this</span></span>(producerId: <span class="hljs-type">Long</span>,
           firstOffset: <span class="hljs-type">Long</span>,
           lastOffset: <span class="hljs-type">Long</span>,
           lastStableOffset: <span class="hljs-type">Long</span>) = {
    <span class="hljs-keyword">this</span>(<span class="hljs-type">ByteBuffer</span>.allocate(<span class="hljs-type">AbortedTxn</span>.<span class="hljs-type">TotalSize</span>))
    <span class="hljs-comment">// 数据协议版本0</span>
    buffer.putShort(<span class="hljs-type">CurrentVersion</span>)
    buffer.putLong(producerId)
    <span class="hljs-comment">// 本事务消息的第一个offset</span>
    buffer.putLong(firstOffset)
    <span class="hljs-comment">// 本事务消息的最后一个offset（控制批次的offset）</span>
    buffer.putLong(lastOffset)
    <span class="hljs-comment">// 完成事务后的LSO</span>
    buffer.putLong(lastStableOffset)
    buffer.flip()
  }
}
</code></pre>
<p>ProducerStateManager#completeTxn：事务起始offset，从ongoingTxns移动到unreplicatedTxns。</p>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-comment">// 还未提交的事务：消息批次起始offset -&gt; 事务元数据</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> ongoingTxns = <span class="hljs-keyword">new</span> util.<span class="hljs-type">TreeMap</span>[<span class="hljs-type">Long</span>, <span class="hljs-type">TxnMetadata</span>]
<span class="hljs-comment">// 已经提交/回滚的事务，但是还未复制到follower：消息批次起始offset -&gt; 事务元数据</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> unreplicatedTxns = <span class="hljs-keyword">new</span> util.<span class="hljs-type">TreeMap</span>[<span class="hljs-type">Long</span>, <span class="hljs-type">TxnMetadata</span>]
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">completeTxn</span></span>(completedTxn: <span class="hljs-type">CompletedTxn</span>): <span class="hljs-type">Unit</span> = {
  <span class="hljs-keyword">val</span> txnMetadata = ongoingTxns.remove(completedTxn.firstOffset)
  txnMetadata.lastOffset = <span class="hljs-type">Some</span>(completedTxn.lastOffset)
  unreplicatedTxns.put(completedTxn.firstOffset, txnMetadata)
}
</code></pre>
<p>Log#updateHighWatermarkMetadata：follower从leader复制消息，导致HW高水位提升后，移除unreplicatedTxns中的事务，最终提升LSO（LastStableOffset），消息对RC隔离级别消费者可见。</p>
<blockquote>
<p>LSO的计算逻辑在前面写消息部分提到了，要用ongoingTxns和unreplicatedTxns共同决定。</p>
</blockquote>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">updateHighWatermarkMetadata</span></span>(newHighWatermark: <span class="hljs-type">LogOffsetMetadata</span>): <span class="hljs-type">Unit</span> = {
  lock synchronized {
    highWatermarkMetadata = newHighWatermark
    <span class="hljs-comment">// unreplicatedTxns移除HW之前的事务</span>
    producerStateManager.onHighWatermarkUpdated(newHighWatermark.messageOffset)
    <span class="hljs-comment">// 计算LSO</span>
    maybeIncrementFirstUnstableOffset()
  }
}
<span class="hljs-comment">// ProducerStateManager</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">onHighWatermarkUpdated</span></span>(highWatermark: <span class="hljs-type">Long</span>): <span class="hljs-type">Unit</span> = {
  removeUnreplicatedTransactions(highWatermark)
}
<span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">removeUnreplicatedTransactions</span></span>(offset: <span class="hljs-type">Long</span>): <span class="hljs-type">Unit</span> = {
  <span class="hljs-keyword">val</span> iterator = unreplicatedTxns.entrySet.iterator
  <span class="hljs-keyword">while</span> (iterator.hasNext) {
    <span class="hljs-keyword">val</span> txnEntry = iterator.next()
    <span class="hljs-keyword">val</span> lastOffset = txnEntry.getValue.lastOffset
    <span class="hljs-keyword">if</span> (lastOffset.exists(_ &lt; offset))
      iterator.remove()
  }
}
</code></pre>
<h3 data-id="heading-24">4-4、consumer</h3>
<p>consumer如果设置RC隔离级别，broker可以通过LSO控制在事务提交后才能消费到消息。</p>
<p>但是如果事务回滚，如何让消息不可见？</p>
<p>FetchResponse.PartitionData：实际上，消费者会从Broker拉取到回滚的消息，但同时也会拉到回滚的事务信息AbortedTransaction。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PartitionData</span>&lt;T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseRecords</span>&gt; {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> Errors error;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> highWatermark;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> lastStableOffset;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> logStartOffset;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> Optional&lt;Integer&gt; preferredReadReplica;
    <span class="hljs-comment">// 这批消息相关的回滚事务</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> List&lt;AbortedTransaction&gt; abortedTransactions;
    <span class="hljs-comment">// MemoryRecords 包含多个消息批次</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> T records;
}
</code></pre>
<p>Log#addAbortedTransactions：broker在拉取完消息后，如果隔离级别是RC，会拉取这批消息相关的中断事务信息，从事务索引中获取。</p>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-comment">// 收集AbortedTransaction</span>
<span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">addAbortedTransactions</span></span>(
                           <span class="hljs-comment">// 消费进度</span>
                           startOffset: <span class="hljs-type">Long</span>, 
                           <span class="hljs-comment">// 当前正在读取的segment 起始offset-&gt;segment</span>
                           segmentEntry: <span class="hljs-type">JEntry</span>[<span class="hljs-type">JLong</span>, <span class="hljs-type">LogSegment</span>],
                           <span class="hljs-comment">// 拉到的消息</span>
                           fetchInfo: <span class="hljs-type">FetchDataInfo</span>): <span class="hljs-type">FetchDataInfo</span> = {
  <span class="hljs-keyword">val</span> fetchSize = fetchInfo.records.sizeInBytes
  <span class="hljs-comment">// 起始offset --- 拉到的消息的第一个offset</span>
  <span class="hljs-keyword">val</span> startOffsetPosition = <span class="hljs-type">OffsetPosition</span>(fetchInfo.fetchOffsetMetadata.messageOffset,
    fetchInfo.fetchOffsetMetadata.relativePositionInSegment)
  <span class="hljs-comment">// 根据拉取大小 得到结束位点</span>
  <span class="hljs-keyword">val</span> upperBoundOffset = segmentEntry.getValue.fetchUpperBoundOffset(startOffsetPosition, fetchSize).getOrElse {
    <span class="hljs-keyword">val</span> nextSegmentEntry = segments.higherEntry(segmentEntry.getKey)
    <span class="hljs-keyword">if</span> (nextSegmentEntry != <span class="hljs-literal">null</span>)
      nextSegmentEntry.getValue.baseOffset
    <span class="hljs-keyword">else</span>
      logEndOffset
  }
  <span class="hljs-comment">// 收集中断事务</span>
  <span class="hljs-keyword">val</span> abortedTransactions = <span class="hljs-type">ListBuffer</span>.empty[<span class="hljs-type">AbortedTransaction</span>]
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">accumulator</span></span>(abortedTxns: <span class="hljs-type">List</span>[<span class="hljs-type">AbortedTxn</span>]): <span class="hljs-type">Unit</span> = abortedTransactions ++= abortedTxns.map(_.asAbortedTransaction)
  collectAbortedTransactions(startOffset, upperBoundOffset, segmentEntry, accumulator)
  <span class="hljs-type">FetchDataInfo</span>(fetchOffsetMetadata = fetchInfo.fetchOffsetMetadata,
    records = fetchInfo.records,
    firstEntryIncomplete = fetchInfo.firstEntryIncomplete,
    abortedTransactions = <span class="hljs-type">Some</span>(abortedTransactions.toList))
}

<span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">collectAbortedTransactions</span></span>(startOffset: <span class="hljs-type">Long</span>, 
               upperBoundOffset: <span class="hljs-type">Long</span>,
               startingSegmentEntry: <span class="hljs-type">JEntry</span>[<span class="hljs-type">JLong</span>, <span class="hljs-type">LogSegment</span>],
               accumulator: <span class="hljs-type">List</span>[<span class="hljs-type">AbortedTxn</span>] =&gt; <span class="hljs-type">Unit</span>): <span class="hljs-type">Unit</span> = {
  <span class="hljs-keyword">var</span> segmentEntry = startingSegmentEntry
  <span class="hljs-keyword">while</span> (segmentEntry != <span class="hljs-literal">null</span>) {
    <span class="hljs-keyword">val</span> searchResult = segmentEntry.getValue.collectAbortedTxns(startOffset, upperBoundOffset)
    accumulator(searchResult.abortedTransactions)
    <span class="hljs-keyword">if</span> (searchResult.isComplete)
      <span class="hljs-keyword">return</span>
    segmentEntry = segments.higherEntry(segmentEntry.getKey)
  }
}
<span class="hljs-comment">// LogSegment#collectAbortedTxns 从事务索引获取中断事务</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">collectAbortedTxns</span></span>(fetchOffset: <span class="hljs-type">Long</span>, upperBoundOffset: <span class="hljs-type">Long</span>): <span class="hljs-type">TxnIndexSearchResult</span> =
    txnIndex.collectAbortedTxns(fetchOffset, upperBoundOffset)
</code></pre>
<p>Fetcher.CompletedFetch#nextFetchedRecord：consumer处理消息，自行跳过回滚的事务消息和控制批次。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 回滚事务信息</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> PriorityQueue&lt;FetchResponse.AbortedTransaction&gt; abortedTransactions;
<span class="hljs-comment">// 遍历到处于回滚的producerId</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Set&lt;Long&gt; abortedProducerIds;
<span class="hljs-comment">// 正在迭代的n个消息批次</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Iterator&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">RecordBatch</span>&gt; batches;
<span class="hljs-keyword">private</span> Record <span class="hljs-title function_">nextFetchedRecord</span><span class="hljs-params">()</span> {
  <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
    <span class="hljs-comment">// ....</span>
    <span class="hljs-keyword">if</span> (isolationLevel == IsolationLevel.READ_COMMITTED &amp;&amp; currentBatch.hasProducerId()) {
      <span class="hljs-comment">// 1. 将中断producerId加入abortedProducerIds</span>
      consumeAbortedTransactionsUpTo(currentBatch.lastOffset());
      <span class="hljs-type">long</span> <span class="hljs-variable">producerId</span> <span class="hljs-operator">=</span> currentBatch.producerId();
      <span class="hljs-keyword">if</span> (containsAbortMarker(currentBatch)) {
          <span class="hljs-comment">// 3. 如果是【控制批次且回滚】，abortedProducerIds中移除该producerId，后续该producerId消息可见</span>
          abortedProducerIds.remove(producerId);
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (isBatchAborted(currentBatch)) {
          <span class="hljs-comment">// 2. 如果是【用户消息且被当前批次的producerId在abortedProducerIds中】，代表被回滚，跳过这批消息</span>
          nextFetchOffset = currentBatch.nextOffset();
          <span class="hljs-keyword">continue</span>;
      }
    }
    <span class="hljs-keyword">if</span> (!currentBatch.isControlBatch()) {
        <span class="hljs-keyword">return</span> record;
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// 跳过控制批次</span>
        nextFetchOffset = record.offset() + <span class="hljs-number">1</span>;
    }
  }
}
<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">consumeAbortedTransactionsUpTo</span><span class="hljs-params">(<span class="hljs-type">long</span> offset)</span> {
    <span class="hljs-keyword">if</span> (abortedTransactions == <span class="hljs-literal">null</span>)
        <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">while</span> (!abortedTransactions.isEmpty() &amp;&amp; abortedTransactions.peek().firstOffset &lt;= offset) {
        FetchResponse.<span class="hljs-type">AbortedTransaction</span> <span class="hljs-variable">abortedTransaction</span> <span class="hljs-operator">=</span> abortedTransactions.poll();
        abortedProducerIds.add(abortedTransaction.producerId);
    }
}
<span class="hljs-comment">// 是否是回滚控制批次</span>
<span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">containsAbortMarker</span><span class="hljs-params">(RecordBatch batch)</span> {
  <span class="hljs-keyword">if</span> (!batch.isControlBatch())
      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  Iterator&lt;Record&gt; batchIterator = batch.iterator();
  <span class="hljs-keyword">if</span> (!batchIterator.hasNext())
      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  <span class="hljs-type">Record</span> <span class="hljs-variable">firstRecord</span> <span class="hljs-operator">=</span> batchIterator.next();
  <span class="hljs-keyword">return</span> ControlRecordType.ABORT == ControlRecordType.parse(firstRecord.key());
}
<span class="hljs-comment">// 这个事务消息的批次被回滚了</span>
<span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isBatchAborted</span><span class="hljs-params">(RecordBatch batch)</span> {
  <span class="hljs-keyword">return</span> batch.isTransactional() 
      &amp;&amp; abortedProducerIds.contains(batch.producerId());
}
</code></pre>
<h3 data-id="heading-25">4-5、事务超时</h3>
<p>TransactionCoordinator#startup：事务协调者每10s扫描一次是否有事务超时。</p>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">startup</span></span>(enableTransactionalIdExpiration: <span class="hljs-type">Boolean</span> = <span class="hljs-literal">true</span>): <span class="hljs-type">Unit</span> = {
  <span class="hljs-comment">// 10s检测一次超时事务</span>
  scheduler.schedule(<span class="hljs-string">"transaction-abort"</span>,
    () =&gt; abortTimedOutTransactions(onEndTransactionComplete),
    txnConfig.abortTimedOutTransactionsIntervalMs,
    txnConfig.abortTimedOutTransactionsIntervalMs
  )
}
</code></pre>
<p>TransactionCoordinator#abortTimedOutTransactions：事务协调者，扫描所有超时事务，自动执行回滚，回滚完成后producerEpoch+1。</p>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-keyword">private</span>[transaction] <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">abortTimedOutTransactions</span></span>(onComplete: <span class="hljs-type">TransactionalIdAndProducerIdEpoch</span> =&gt; <span class="hljs-type">EndTxnCallback</span>): <span class="hljs-type">Unit</span> = {
    <span class="hljs-comment">// 1. 扫描所有超时事务</span>
    txnManager.timedOutTransactions().foreach { txnIdAndPidEpoch =&gt;
      txnManager.getTransactionState(txnIdAndPidEpoch.transactionalId).foreach {
        <span class="hljs-keyword">case</span> <span class="hljs-type">None</span> =&gt;
        <span class="hljs-keyword">case</span> <span class="hljs-type">Some</span>(epochAndTxnMetadata) =&gt;
          <span class="hljs-keyword">val</span> txnMetadata = epochAndTxnMetadata.transactionMetadata
          <span class="hljs-keyword">val</span> transitMetadataOpt = txnMetadata.inLock {
            <span class="hljs-keyword">if</span> (txnMetadata.producerId != txnIdAndPidEpoch.producerId) {
              <span class="hljs-type">None</span>
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (txnMetadata.pendingTransitionInProgress) {
              <span class="hljs-comment">// 2-1. 如果事务元数据正在变更，暂时不回滚</span>
              <span class="hljs-type">None</span>
            } <span class="hljs-keyword">else</span> {
              <span class="hljs-comment">// 2-2. 否则，需要回滚，回滚完成后producerEpoch+1</span>
              <span class="hljs-type">Some</span>(txnMetadata.prepareFenceProducerEpoch())
            }
          }
          <span class="hljs-comment">// 3. 回滚事务</span>
          transitMetadataOpt.foreach { txnTransitMetadata =&gt;
            endTransaction(txnMetadata.transactionalId,
              txnTransitMetadata.producerId,
              txnTransitMetadata.producerEpoch,
              <span class="hljs-type">TransactionResult</span>.<span class="hljs-type">ABORT</span>,
              isFromClient = <span class="hljs-literal">false</span>,
              onComplete(txnIdAndPidEpoch))
          }
      }
    }
}
</code></pre>
<p>TransactionStateManager#timedOutTransactions：协调者扫描超时事务</p>
<p>1）生产者初始化，上报事务超时时间<strong>transaction.timeout.ms</strong>默认60s；</p>
<p>2）生产者首次将分区加入事务，状态翻转Onging代表事务开始，记录事务开始时间；</p>
<p>3）即超时时间=分区首次加入事务+60s；</p>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-keyword">private</span>[transaction] <span class="hljs-keyword">val</span> transactionMetadataCache: mutable.<span class="hljs-type">Map</span>[<span class="hljs-type">Int</span>, <span class="hljs-type">TxnMetadataCacheEntry</span>] = mutable.<span class="hljs-type">Map</span>()
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">timedOutTransactions</span></span>(): <span class="hljs-type">Iterable</span>[<span class="hljs-type">TransactionalIdAndProducerIdEpoch</span>] = {
<span class="hljs-keyword">val</span> now = time.milliseconds()
inReadLock(stateLock) {
  transactionMetadataCache.flatMap { <span class="hljs-keyword">case</span> (_, entry) =&gt;
    entry.metadataPerTransactionalId.filter { <span class="hljs-keyword">case</span> (_, txnMetadata) =&gt;
      <span class="hljs-keyword">if</span> (txnMetadata.pendingTransitionInProgress) {
        <span class="hljs-literal">false</span>
      } <span class="hljs-keyword">else</span> {
        txnMetadata.state <span class="hljs-keyword">match</span> {
          <span class="hljs-comment">// 事务中第一次收到AddPartition</span>
          <span class="hljs-comment">// 状态 =&gt; Ongoing, 记录txnStartTimestamp事务开始时间</span>
          <span class="hljs-keyword">case</span> <span class="hljs-type">Ongoing</span> =&gt;
            txnMetadata.txnStartTimestamp + txnMetadata.txnTimeoutMs &lt; now
          <span class="hljs-keyword">case</span> _ =&gt; <span class="hljs-literal">false</span>
        }
      }
    }.map { <span class="hljs-keyword">case</span> (txnId, txnMetadata) =&gt;
      <span class="hljs-type">TransactionalIdAndProducerIdEpoch</span>(txnId, txnMetadata.producerId, txnMetadata.producerEpoch)
    }
  }
}
</code></pre>
<p>当生产者在超时后发起任何请求，比如发送消息给broker、结束事务给协调者，因为producerEpoch已经改变，都会响应ProducerFencedException，此时生产者会进入FATAL_ERROR状态，唯一处理方式是关闭后重新启动。</p>
<h2 data-id="heading-26">五、精确一次</h2>
<p>Kafka经常会提到精确一次ExcatlyOnce，常见使用场景是结合Flink的CheckPoint实现端到端精确一次，具体案例参考官方<strong>ExactlyOnceMessageProcessor</strong>。</p>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-comment">/**
 * A demo class for how to write a customized EOS app. It takes a consume-process-produce loop.
 * Important configurations and APIs are commented.
 */</span>
public <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ExactlyOnceMessageProcessor</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Thread</span> </span>{
}
</code></pre>
<p>精确一次指的是<strong>consume-process-produce</strong>循环：从来源topic消费消息，经过数据处理，写入目标topic。因为消费进度实际上会作为消息，由<strong>消费组协调者</strong>存储在 <strong>__<em>consume</em>offset</strong>中，所以可以一起加入事务（producer#sendOffsetsToTransaction）。</p>
<blockquote>
<p>注：每次poll到消息会改变consumer内存中的消费进度，所以如果回滚事务，需要重新通过seek api回滚消费进度。</p>
</blockquote>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> {
   <span class="hljs-comment">// 1. 事务生产者 初始化事务</span>
    producer.initTransactions();
    <span class="hljs-keyword">final</span> <span class="hljs-type">AtomicLong</span> <span class="hljs-variable">messageRemaining</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicLong</span>(Long.MAX_VALUE);
    <span class="hljs-comment">// 2. 消费者订阅</span>
    consumer.subscribe(Collections.singleton(inputTopic));
    <span class="hljs-type">int</span> <span class="hljs-variable">messageProcessed</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
    <span class="hljs-keyword">while</span> (messageRemaining.get() &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 3. 消费者拉消息</span>
            ConsumerRecords&lt;Integer, String&gt; records = consumer.poll(Duration.ofMillis(<span class="hljs-number">200</span>));
            <span class="hljs-keyword">if</span> (records.count() &gt; <span class="hljs-number">0</span>) {
                <span class="hljs-comment">// 4. 开启事务</span>
                producer.beginTransaction();
                <span class="hljs-keyword">for</span> (ConsumerRecord&lt;Integer, String&gt; record : records) {
                    <span class="hljs-comment">// 5. 数据处理</span>
                    ProducerRecord&lt;Integer, String&gt; customizedRecord = transform(record);
                    <span class="hljs-comment">// 6. 写事务消息</span>
                    producer.send(customizedRecord);
                }
                <span class="hljs-comment">// 7. 在事务里发送当前分区消费进度</span>
                Map&lt;TopicPartition, OffsetAndMetadata&gt; offsets = consumerOffsets();
                producer.sendOffsetsToTransaction(offsets, consumer.groupMetadata());
                <span class="hljs-comment">// 8. 提交事务</span>
                producer.commitTransaction();
                messageProcessed += records.count();
            }
        } <span class="hljs-keyword">catch</span> (ProducerFencedException e) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">KafkaException</span>(String.format(<span class="hljs-string">"The transactional.id %s has been claimed by another process"</span>, transactionalId));
        } <span class="hljs-keyword">catch</span> (FencedInstanceIdException e) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">KafkaException</span>(String.format(<span class="hljs-string">"The group.instance.id %s has been claimed by another process"</span>, groupInstanceId));
        } <span class="hljs-keyword">catch</span> (KafkaException e) {
            <span class="hljs-comment">// 9. 发生异常，回滚事务</span>
            producer.abortTransaction();
            <span class="hljs-comment">// 10. 重新从coordinator获取消费进度，回滚消费进度</span>
            resetToLastCommittedPositions(consumer);
        }
        messageRemaining.set(messagesRemaining(consumer));
    }
}
</code></pre>
<h3 data-id="heading-27">5-1、AddOffsetsToTxnRequest</h3>
<p>TransactionManager#sendOffsetsToTransaction：sendOffsetsToTransaction实际上是发送AddOffsetsToTxnRequest给事务协调者，包含<strong>消费组id</strong>。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> TransactionalRequestResult <span class="hljs-title function_">sendOffsetsToTransaction</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Map&lt;TopicPartition, OffsetAndMetadata&gt; offsets,
                                                                        <span class="hljs-keyword">final</span> ConsumerGroupMetadata groupMetadata)</span> {
    AddOffsetsToTxnRequest.<span class="hljs-type">Builder</span> <span class="hljs-variable">builder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AddOffsetsToTxnRequest</span>.Builder(
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">AddOffsetsToTxnRequestData</span>()
            .setTransactionalId(transactionalId)
            .setProducerId(producerIdAndEpoch.producerId)
            .setProducerEpoch(producerIdAndEpoch.epoch)
            .setGroupId(groupMetadata.groupId())
    );
    <span class="hljs-type">AddOffsetsToTxnHandler</span> <span class="hljs-variable">handler</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AddOffsetsToTxnHandler</span>(builder, offsets, groupMetadata);
    enqueueRequest(handler);
    <span class="hljs-keyword">return</span> handler.result;
}
</code></pre>
<p>KafkaApis#handleAddOffsetsToTxnRequest：<strong>事务协调者</strong>的处理方式，同<strong>AddPartitionsToTxnRequest</strong>普通事务消息的分区加入事务一样，只是这个分区是消费组id对应的<strong>消费组协调者</strong>分区（partition=hash(groupId)%50）。</p>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">handleAddOffsetsToTxnRequest</span></span>(request: <span class="hljs-type">RequestChannel</span>.<span class="hljs-type">Request</span>): <span class="hljs-type">Unit</span> = {
    <span class="hljs-keyword">val</span> addOffsetsToTxnRequest = request.body[<span class="hljs-type">AddOffsetsToTxnRequest</span>]
    <span class="hljs-keyword">val</span> transactionalId = addOffsetsToTxnRequest.data.transactionalId
    <span class="hljs-keyword">val</span> groupId = addOffsetsToTxnRequest.data.groupId
    <span class="hljs-comment">// 获取消费组对应__consumer_offsets消费组协调者分区</span>
    <span class="hljs-keyword">val</span> offsetTopicPartition = <span class="hljs-keyword">new</span> <span class="hljs-type">TopicPartition</span>(<span class="hljs-type">GROUP_METADATA_TOPIC_NAME</span>, groupCoordinator.partitionFor(groupId))
    <span class="hljs-comment">// ... 其他校验</span>
    txnCoordinator.handleAddPartitionsToTransaction(transactionalId,
      addOffsetsToTxnRequest.data.producerId,
      addOffsetsToTxnRequest.data.producerEpoch,
      <span class="hljs-type">Set</span>(offsetTopicPartition),
      sendResponseCallback)
}
</code></pre>
<h3 data-id="heading-28">5-2、TxnOffsetCommitRequest</h3>
<p>AddOffsetsToTxnHandler：producer收到<strong>AddOffsetsToTxnResponse</strong>成功，代表事务协调者分区已经成功加入事务，发送<strong>TxnOffsetCommitRequest</strong>事务offset提交请求给<strong>消费组协调者</strong>，其中的特点是，提交offset包含了producerId和epoch。</p>
<pre><code class="hljs language-java" lang="java"> <span class="hljs-keyword">private</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AddOffsetsToTxnHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">TxnRequestHandler</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> AddOffsetsToTxnRequest.Builder builder;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;TopicPartition, OffsetAndMetadata&gt; offsets;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ConsumerGroupMetadata groupMetadata;
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleResponse</span><span class="hljs-params">(AbstractResponse response)</span> {
        <span class="hljs-type">AddOffsetsToTxnResponse</span> <span class="hljs-variable">addOffsetsToTxnResponse</span> <span class="hljs-operator">=</span> (AddOffsetsToTxnResponse) response;
        <span class="hljs-type">Errors</span> <span class="hljs-variable">error</span> <span class="hljs-operator">=</span> Errors.forCode(addOffsetsToTxnResponse.data.errorCode());
        <span class="hljs-keyword">if</span> (error == Errors.NONE) {
            pendingRequests.add(txnOffsetCommitHandler(result, offsets, groupMetadata));
            transactionStarted = <span class="hljs-literal">true</span>;
        }
    }
 }
<span class="hljs-keyword">private</span> TxnOffsetCommitHandler <span class="hljs-title function_">txnOffsetCommitHandler</span><span class="hljs-params">(TransactionalRequestResult result,
                  Map&lt;TopicPartition, OffsetAndMetadata&gt; offsets,
                  ConsumerGroupMetadata groupMetadata)</span> {
    <span class="hljs-keyword">for</span> (Map.Entry&lt;TopicPartition, OffsetAndMetadata&gt; entry : offsets.entrySet()) {
        <span class="hljs-type">OffsetAndMetadata</span> <span class="hljs-variable">offsetAndMetadata</span> <span class="hljs-operator">=</span> entry.getValue();
        <span class="hljs-type">CommittedOffset</span> <span class="hljs-variable">committedOffset</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CommittedOffset</span>(offsetAndMetadata.offset(),
                offsetAndMetadata.metadata(), offsetAndMetadata.leaderEpoch());
        pendingTxnOffsetCommits.put(entry.getKey(), committedOffset);
    }
    <span class="hljs-keyword">final</span> TxnOffsetCommitRequest.<span class="hljs-type">Builder</span> <span class="hljs-variable">builder</span> <span class="hljs-operator">=</span>
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">TxnOffsetCommitRequest</span>.Builder(transactionalId,
            groupMetadata.groupId(),
            producerIdAndEpoch.producerId,
            producerIdAndEpoch.epoch,
            pendingTxnOffsetCommits,
            groupMetadata.memberId(),
            groupMetadata.generationId(),
            groupMetadata.groupInstanceId(),
            autoDowngradeTxnCommit
        );
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TxnOffsetCommitHandler</span>(result, builder);
}
</code></pre>
<p>GroupMetadataManager#storeOffsets：消费组协调者处理事务offset提交</p>
<p>1）消费进度消息中会包含producerId/epoch/是否事务提交，后续回放可以恢复内存状态；</p>
<p>2）内存记录：producerId→事务中groupId；producerId -&gt; (待提交消费分区,消费进度offset)；</p>
<p>3）写消费进度到_<em>consumer</em>offsets；</p>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">storeOffsets</span></span>(group: <span class="hljs-type">GroupMetadata</span>,
       consumerId: <span class="hljs-type">String</span>,
       offsetMetadata: immutable.<span class="hljs-type">Map</span>[<span class="hljs-type">TopicPartition</span>, <span class="hljs-type">OffsetAndMetadata</span>],
       responseCallback: immutable.<span class="hljs-type">Map</span>[<span class="hljs-type">TopicPartition</span>, <span class="hljs-type">Errors</span>] =&gt; <span class="hljs-type">Unit</span>,
       producerId: <span class="hljs-type">Long</span> = <span class="hljs-type">RecordBatch</span>.<span class="hljs-type">NO_PRODUCER_ID</span>,
       producerEpoch: <span class="hljs-type">Short</span> = <span class="hljs-type">RecordBatch</span>.<span class="hljs-type">NO_PRODUCER_EPOCH</span>): <span class="hljs-type">Unit</span> = {
  <span class="hljs-comment">// 有producerId的offset提交，认为是事务offset提交</span>
  <span class="hljs-keyword">val</span> isTxnOffsetCommit = producerId != <span class="hljs-type">RecordBatch</span>.<span class="hljs-type">NO_PRODUCER_ID</span>
  getMagic(partitionFor(group.groupId)) <span class="hljs-keyword">match</span> {
    <span class="hljs-keyword">case</span> <span class="hljs-type">Some</span>(magicValue) =&gt;
      <span class="hljs-comment">// ...</span>
      <span class="hljs-comment">// 消费进度记录，额外包含producerId/epoch/isTxnOffsetCommit</span>
      <span class="hljs-keyword">val</span> builder = <span class="hljs-type">MemoryRecords</span>.builder(buffer, magicValue, compressionType, timestampType, <span class="hljs-number">0</span>L, time.milliseconds(),
        producerId, producerEpoch, <span class="hljs-number">0</span>, isTxnOffsetCommit, <span class="hljs-type">RecordBatch</span>.<span class="hljs-type">NO_PARTITION_LEADER_EPOCH</span>)
      records.foreach(builder.append)
      <span class="hljs-keyword">val</span> entries = <span class="hljs-type">Map</span>(offsetTopicPartition -&gt; builder.build())
      <span class="hljs-keyword">if</span> (isTxnOffsetCommit) {
        <span class="hljs-comment">// 如果是 事务消费offset提交</span>
        group.inLock {
          <span class="hljs-comment">// 内存记录producerId -&gt; 事务中的groupId</span>
          addProducerGroup(producerId, group.groupId)
          <span class="hljs-comment">// 消费组元数据记录 producerId -&gt; (待提交消费分区,消费进度offset)</span>
          group.prepareTxnOffsetCommit(producerId, offsetMetadata)
        }
      } <span class="hljs-keyword">else</span> {
        group.inLock {
          group.prepareOffsetCommit(offsetMetadata)
        }
      }
      <span class="hljs-comment">// 写__consumer_offsets</span>
      appendForGroup(group, entries, putCacheCallback)
  }
}
</code></pre>
<h3 data-id="heading-29">5-3、OffsetFetchRequest</h3>
<p>事务中的消息对RC消费者的影响是不可见；事务中待提交的offset对同组消费者的影响是offset不可见。</p>
<p>低版本中一个消费组只能有一个消费者消费一个分区，事务中的待提交offset其实不影响其他消费者。</p>
<p>但是事务offset的提交取决于事务生产者，有可能消费者已经rebalance了，这个待提交offset的分区已经分配给其他消费者，但是事务还未提交，所以消费者拉取分区消费进度时需要做好隔离。</p>
<p>GroupMetadataManager#getOffsets：协调者收到consumer查询消费进度的请求，如果分区有待提交的offset，则返回<strong>UNSTABLE_OFFSET_COMMIT</strong>，consumer侧会自动重试。</p>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">getOffsets</span></span>(groupId: <span class="hljs-type">String</span>, 
               requireStable: <span class="hljs-type">Boolean</span>,
               topicPartitionsOpt: <span class="hljs-type">Option</span>[<span class="hljs-type">Seq</span>[<span class="hljs-type">TopicPartition</span>]]):
                        <span class="hljs-type">Map</span>[<span class="hljs-type">TopicPartition</span>, <span class="hljs-type">PartitionData</span>] = {
    <span class="hljs-comment">// ...</span>
  topicPartitions.map { topicPartition =&gt;
    <span class="hljs-keyword">if</span> (requireStable 
        &amp;&amp; group.hasPendingOffsetCommitsForTopicPartition(topicPartition)) {
      <span class="hljs-comment">// 如果分区有事务中的offset，返回UNSTABLE_OFFSET_COMMIT，消费者客户端会重试</span>
      topicPartition -&gt; <span class="hljs-keyword">new</span> <span class="hljs-type">PartitionData</span>(<span class="hljs-type">OffsetFetchResponse</span>.<span class="hljs-type">INVALID_OFFSET</span>,
        <span class="hljs-type">Optional</span>.empty(), <span class="hljs-string">""</span>, <span class="hljs-type">Errors</span>.<span class="hljs-type">UNSTABLE_OFFSET_COMMIT</span>)
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">// 正常获取消费进度...</span>
      <span class="hljs-keyword">val</span> partitionData = group.offset(topicPartition)
    }
  }.toMap
}
</code></pre>
<h3 data-id="heading-30">5-4、提交/回滚事务</h3>
<p>sendOffsetsToTransaction本质上和addPartition是一样的，将消息分区加入事务。</p>
<p>事务offset处理的区别仅在于broker处理事务协调者的WriteTxnMarkersRequest。</p>
<p>KafkaApis#handleWriteTxnMarkersRequest：写入控制批次后，如果发现本轮事务中包含__consumer_offsets的分区，则处理消费位点提交。</p>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">handleWriteTxnMarkersRequest</span></span>(request: <span class="hljs-type">RequestChannel</span>.<span class="hljs-type">Request</span>): <span class="hljs-type">Unit</span> = {
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">maybeSendResponseCallback</span></span>(producerId: <span class="hljs-type">Long</span>, result: <span class="hljs-type">TransactionResult</span>)(responseStatus: <span class="hljs-type">Map</span>[<span class="hljs-type">TopicPartition</span>, <span class="hljs-type">PartitionResponse</span>]): <span class="hljs-type">Unit</span> = {
      <span class="hljs-keyword">val</span> successfulOffsetsPartitions = responseStatus.filter { <span class="hljs-keyword">case</span> (topicPartition, partitionResponse) =&gt;
        <span class="hljs-comment">// 事务中包含__consumer_offsets</span>
        topicPartition.topic == <span class="hljs-type">GROUP_METADATA_TOPIC_NAME</span> &amp;&amp; partitionResponse.error == <span class="hljs-type">Errors</span>.<span class="hljs-type">NONE</span>
      }.keys
      <span class="hljs-keyword">if</span> (successfulOffsetsPartitions.nonEmpty) {
          <span class="hljs-comment">// 事务里包含消费位点提交 异步处理</span>
          groupCoordinator.scheduleHandleTxnCompletion(producerId, successfulOffsetsPartitions, result)
      }
      <span class="hljs-comment">// 响应事务协调者</span>
      sendResponseExemptThrottle(request, <span class="hljs-keyword">new</span> <span class="hljs-type">WriteTxnMarkersResponse</span>(errors))
    }
    <span class="hljs-comment">// 写入控制批次</span>
    replicaManager.appendRecords(
      timeout = config.requestTimeoutMs.toLong,
      <span class="hljs-comment">// acks=-1</span>
      requiredAcks = <span class="hljs-number">-1</span>,
      internalTopicsAllowed = <span class="hljs-literal">true</span>,
      origin = <span class="hljs-type">AppendOrigin</span>.<span class="hljs-type">Coordinator</span>,
      entriesPerPartition = controlRecords,
      responseCallback = maybeSendResponseCallback(producerId, marker.transactionResult))
  }
}
</code></pre>
<p>GroupMetadata#completePendingTxnOffsetCommit：如果提交，更新事务offset到实际offset；否则什么都不做。</p>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-comment">// 分区消费进度</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> offsets = <span class="hljs-keyword">new</span> mutable.<span class="hljs-type">HashMap</span>[<span class="hljs-type">TopicPartition</span>, <span class="hljs-type">CommitRecordMetadataAndOffset</span>]
<span class="hljs-comment">// producerId -&gt; (待提交消费分区,消费进度offset)</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> pendingTransactionalOffsetCommits = <span class="hljs-keyword">new</span> mutable.<span class="hljs-type">HashMap</span>[<span class="hljs-type">Long</span>, mutable.<span class="hljs-type">Map</span>[<span class="hljs-type">TopicPartition</span>, <span class="hljs-type">CommitRecordMetadataAndOffset</span>]]()
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">completePendingTxnOffsetCommit</span></span>(producerId: <span class="hljs-type">Long</span>, isCommit: <span class="hljs-type">Boolean</span>): <span class="hljs-type">Unit</span> = {
  <span class="hljs-comment">// producerId -&gt; (待提交消费分区,消费进度offset)</span>
  <span class="hljs-keyword">val</span> pendingOffsetsOpt = pendingTransactionalOffsetCommits.remove(producerId)
  <span class="hljs-keyword">if</span> (isCommit) {
    pendingOffsetsOpt.foreach { pendingOffsets =&gt;
      pendingOffsets.foreach { <span class="hljs-keyword">case</span> (topicPartition, commitRecordMetadataAndOffset) =&gt;
        <span class="hljs-keyword">val</span> currentOffsetOpt = offsets.get(topicPartition)
        <span class="hljs-keyword">if</span> (currentOffsetOpt.forall(_.olderThan(commitRecordMetadataAndOffset))) {
          <span class="hljs-comment">// 更新分区的消费进度为pending消费offset</span>
          offsets.put(topicPartition, commitRecordMetadataAndOffset)
        } 
      }
    }
  } 
}
</code></pre>
<h2 data-id="heading-31">总结</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/49c880d7e1cc45d6b49022b04a559a91~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP54y_6Zi_6LaK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763278241&amp;x-signature=%2BMk%2FY2NgwQbrAy7FomOkwNr3awQ%3D" alt="image.png" loading="lazy"/></p>
<p>事务生产者初始化：</p>
<p>1）事务生产者，发送FindCoordinator给任意Broker；</p>
<p>2）任意Broker，topic=__transaction_state默认有50个分区，协调者=leader(hash(transactionalId)%50)，响应事务生产者；</p>
<p>3）事务生产者，发送InitProducerId给事务协调者；</p>
<p>4）事务协调者，为每个transactionalId分配producerId和epoch给生产者，将元数据变更记录到__transaction_state；</p>
<p>5）事务生产者，记录producerId和epoch，后续所有请求都需要携带这个信息；</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ebdcd2797c614b6f95d1e96bc7a6fab4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP54y_6Zi_6LaK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763278241&amp;x-signature=JbTRK3r9WO%2FpxQCkah9l3Y6q7hg%3D" alt="image.png" loading="lazy"/></p>
<p>发送消息：</p>
<p>1）事务生产者：发送消息遇到事务中的新分区，先发送AddPartitions给事务协调者；</p>
<p>2）事务协调者：元数据记录事务中的分区（首次AddPartitions代表事务开始，记录事务开始时间），将元数据变更记录到__transaction_state；</p>
<p>3）事务生产者：发送消息给Broker，每个消息批次包含<strong>递增序号</strong>；</p>
<p>4）Broker：除了消息写入以外，每个topic分区维护producerId对应状态，包括：最近5个消息批次序号-用于幂等校验、producerId对应事务起始offset-用于计算LSO（LastStableOffset，如果RC级别消费者，只有LSO之前消息可见）；</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/33460c061dd542a49624608d86880bae~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP54y_6Zi_6LaK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763278241&amp;x-signature=URxQ0A10oBiuAa4xCXryw8C4g8s%3D" alt="image.png" loading="lazy"/></p>
<p>结束事务：</p>
<p>1）事务生产者：发送ExdTxn，提交和回滚通过一个标志位区分；</p>
<p>2）事务协调者：事务元数据变更状态，清空事务中分区，将元数据变更记录到__transaction_state，这一步完成后就会响应生产者成功；</p>
<p>3）事务协调者：异步发送WriteTxnMarkers给事务中所有分区涉及的broker；</p>
<p>4）Broker：在事务相关分区中写入<strong>控制批次</strong>(key=提交/回滚,value=controllerEpoch-协调者分区的leaderEpoch，批次头包含producerId)，当控制批次写入leader成功且follower复制导致HW增加超过本轮事务的offset，LSO增加从而消息对RC消费者可见。如果回滚事务，需要将本轮回滚事务的起始和结束offset记录到事务索引.txnindex文件，后续消费者拉取消息会返回回滚事务信息，由消费者自行过滤不可见消息；</p>
<p>精确一次：</p>
<p>1）指的是<strong>consume-process-produce</strong>循环，从来源topic消费消息，经过数据处理，写入目标topic；</p>
<p>2）消费进度存储在__consumer_offset这个topic中，本质也是写消息，所以可以纳入一个事务中；</p>
<p>3）生产者，sendOffsetsToTransaction，<strong>先调用事务协调者</strong>将__consumer_offset的消费组协调分区加入事务，再<strong>调用消费组协调者</strong>写入__consumer_offset消费进度（包含producerId，如果故障恢复，依然可以恢复状态，无论提交还是回滚，因为有控制批次）但是内存中挂起offset；</p>
<p>4）事务结束同正常事务消息，只不过消费组协调者broker发现事务中有__consumer_offset相关分区，则内存提交offset；</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[使用motion实现小宇宙节目广场的效果]]></title>    <link>https://juejin.cn/post/7569946369989836863</link>    <guid>https://juejin.cn/post/7569946369989836863</guid>    <pubDate>2025-11-09T07:20:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7569946369989836863" data-draft-id="7569910533509218323" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="使用motion实现小宇宙节目广场的效果"/> <meta itemprop="keywords" content="前端,交互设计"/> <meta itemprop="datePublished" content="2025-11-09T07:20:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="拜晨"/> <meta itemprop="url" content="https://juejin.cn/user/4160207732090168"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            使用motion实现小宇宙节目广场的效果
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4160207732090168/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    拜晨
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-09T07:20:13.000Z" title="Sun Nov 09 2025 07:20:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>本文可以在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fbaichen.vercel.app%2Fblog%2Fusing-motion-to-implement-xiaoyuzhou-plaza-effect" target="_blank" title="https://baichen.vercel.app/blog/using-motion-to-implement-xiaoyuzhou-plaza-effect" ref="nofollow noopener noreferrer">我的博客</a> 查看交互效果和完整代码</p>
<p>小宇宙app节目广场有一个效果，感觉特别好，想用motion复刻一下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0a36585984b447359d3853a1213a3eef~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ouc5pmo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763277613&amp;x-signature=xBDZDJnen%2BTOvvaSHyPol8AURNY%3D" alt="e867e352-ee23-4b09-b08a-24c92b6c6792.gif" loading="lazy"/></p>
<p>拆解一下，需要实现这几个效果：</p>
<ol>
<li>拖动效果</li>
<li>超出范围会复位</li>
<li>并且有弹性效果</li>
<li>拖动具有惯性</li>
<li>行列具有吸附效果</li>
<li>距离中间越近 卡片越大</li>
</ol>
<p>接下来一点一点实现：</p>
<h2 data-id="heading-0">实现静态页面</h2>
<p>定义好尺寸常量，卡片尺寸，间隔，视图大小（模拟手机）</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { motion } <span class="hljs-keyword">from</span> <span class="hljs-string">"motion/react"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Plaza</span>(<span class="hljs-params"/>) {

<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">COLS</span> = <span class="hljs-number">5</span>, <span class="hljs-variable constant_">ROWS</span> = <span class="hljs-number">5</span>, <span class="hljs-variable constant_">CARD</span> = <span class="hljs-number">100</span>, <span class="hljs-variable constant_">GAP</span> = <span class="hljs-number">10</span>, <span class="hljs-variable constant_">PAD</span> = <span class="hljs-number">20</span>;
<span class="hljs-keyword">const</span> viewportW = <span class="hljs-number">300</span>, viewportH = <span class="hljs-number">500</span>;

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">motion.div</span>
      <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span>
        <span class="hljs-attr">width:</span> <span class="hljs-attr">viewportW</span>,
        <span class="hljs-attr">height:</span> <span class="hljs-attr">viewportH</span>,
        <span class="hljs-attr">border:</span> "<span class="hljs-attr">2px</span> <span class="hljs-attr">solid</span> <span class="hljs-attr">red</span>",
        <span class="hljs-attr">overflow:</span> "<span class="hljs-attr">hidden</span>",
        <span class="hljs-attr">position:</span> "<span class="hljs-attr">relative</span>",
        <span class="hljs-attr">touchAction:</span> "<span class="hljs-attr">none</span>",
        <span class="hljs-attr">cursor:</span> "<span class="hljs-attr">grab</span>",
        <span class="hljs-attr">userSelect:</span> "<span class="hljs-attr">none</span>",
      }}
    &gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">motion.div</span>
        <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span>
          <span class="hljs-attr">position:</span> "<span class="hljs-attr">absolute</span>",
          <span class="hljs-attr">left:</span> <span class="hljs-attr">0</span>, <span class="hljs-attr">top:</span> <span class="hljs-attr">0</span>,
          <span class="hljs-attr">display:</span> "<span class="hljs-attr">grid</span>",
          <span class="hljs-attr">gridTemplateColumns:</span> `<span class="hljs-attr">repeat</span>(${<span class="hljs-attr">COLS</span>}, ${<span class="hljs-attr">CARD</span>}<span class="hljs-attr">px</span>)`,
          <span class="hljs-attr">gridAutoRows:</span> `${<span class="hljs-attr">CARD</span>}<span class="hljs-attr">px</span>`,
          <span class="hljs-attr">gap:</span> <span class="hljs-attr">GAP</span>,
          <span class="hljs-attr">padding:</span> <span class="hljs-attr">PAD</span>,
          <span class="hljs-attr">background:</span> "<span class="hljs-attr">rgba</span>(<span class="hljs-attr">0</span>,<span class="hljs-attr">0</span>,<span class="hljs-attr">0</span>,<span class="hljs-attr">.5</span>)",
        }}
      &gt;</span>
        {Array.from({ length: COLS * ROWS }).map((_, i) =&gt; (
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{i}</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span>
            <span class="hljs-attr">width:</span> "<span class="hljs-attr">100</span>%", <span class="hljs-attr">height:</span> "<span class="hljs-attr">100</span>%", <span class="hljs-attr">background:</span> "<span class="hljs-attr">green</span>",
            <span class="hljs-attr">borderRadius:</span> <span class="hljs-attr">8</span>, <span class="hljs-attr">color:</span> "#<span class="hljs-attr">fff</span>", <span class="hljs-attr">display:</span> "<span class="hljs-attr">flex</span>",
            <span class="hljs-attr">alignItems:</span> "<span class="hljs-attr">center</span>", <span class="hljs-attr">justifyContent:</span> "<span class="hljs-attr">center</span>"
          }}&gt;</span>
            {i + 1}
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        ))}
      <span class="hljs-tag">&lt;/<span class="hljs-name">motion.div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">motion.div</span>&gt;</span></span>
  );
}
</code></pre>
<h2 data-id="heading-1">实现拖动</h2>
<p>思路就是给视图容器绑定一个pan事件，拖动多少就给里面元素transform多少，这样就实现了跟手效果</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { motion, useMotionValue, animate } <span class="hljs-keyword">from</span> <span class="hljs-string">"motion/react"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Plaza</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> x = <span class="hljs-title function_">useMotionValue</span>(<span class="hljs-number">0</span>);
  <span class="hljs-keyword">const</span> y = <span class="hljs-title function_">useMotionValue</span>(<span class="hljs-number">0</span>);

  <span class="hljs-comment">// 你当前示例是 5x5、卡片 100、gap 10、padding 20</span>
  <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">COLS</span> = <span class="hljs-number">5</span>, <span class="hljs-variable constant_">ROWS</span> = <span class="hljs-number">5</span>, <span class="hljs-variable constant_">CARD</span> = <span class="hljs-number">100</span>, <span class="hljs-variable constant_">GAP</span> = <span class="hljs-number">10</span>, <span class="hljs-variable constant_">PAD</span> = <span class="hljs-number">20</span>;
  <span class="hljs-keyword">const</span> viewportW = <span class="hljs-number">300</span>, viewportH = <span class="hljs-number">500</span>;

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">onPan</span> = (<span class="hljs-params">_: <span class="hljs-built_in">any</span>, info: { delta: { x: <span class="hljs-built_in">number</span>; y: <span class="hljs-built_in">number</span> } }</span>) =&gt; {
    <span class="hljs-comment">// 先按正常增量计算</span>
    <span class="hljs-keyword">const</span> nextX = x.<span class="hljs-title function_">get</span>() + info.<span class="hljs-property">delta</span>.<span class="hljs-property">x</span>;
    <span class="hljs-keyword">const</span> nextY = y.<span class="hljs-title function_">get</span>() + info.<span class="hljs-property">delta</span>.<span class="hljs-property">y</span>;

    x.<span class="hljs-title function_">set</span>(nextX);
    y.<span class="hljs-title function_">set</span>(nextY);
  };

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">onPanEnd</span> = (<span class="hljs-params"/>) =&gt; {

  };

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">motion.div</span>
      <span class="hljs-attr">onPan</span>=<span class="hljs-string">{onPan}</span>
      <span class="hljs-attr">onPanEnd</span>=<span class="hljs-string">{onPanEnd}</span>
      <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span>
        <span class="hljs-attr">width:</span> <span class="hljs-attr">viewportW</span>,
        <span class="hljs-attr">height:</span> <span class="hljs-attr">viewportH</span>,
        <span class="hljs-attr">border:</span> "<span class="hljs-attr">2px</span> <span class="hljs-attr">solid</span> <span class="hljs-attr">red</span>",
        <span class="hljs-attr">overflow:</span> "<span class="hljs-attr">hidden</span>",
        <span class="hljs-attr">position:</span> "<span class="hljs-attr">relative</span>",
        <span class="hljs-attr">touchAction:</span> "<span class="hljs-attr">none</span>",
        <span class="hljs-attr">cursor:</span> "<span class="hljs-attr">grab</span>",
        <span class="hljs-attr">userSelect:</span> "<span class="hljs-attr">none</span>",
      }}
    &gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">motion.div</span>
        <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span>
          <span class="hljs-attr">x</span>, <span class="hljs-attr">y</span>,
          <span class="hljs-attr">position:</span> "<span class="hljs-attr">absolute</span>",
          <span class="hljs-attr">left:</span> <span class="hljs-attr">0</span>, <span class="hljs-attr">top:</span> <span class="hljs-attr">0</span>,
          <span class="hljs-attr">display:</span> "<span class="hljs-attr">grid</span>",
          <span class="hljs-attr">gridTemplateColumns:</span> `<span class="hljs-attr">repeat</span>(${<span class="hljs-attr">COLS</span>}, ${<span class="hljs-attr">CARD</span>}<span class="hljs-attr">px</span>)`,
          <span class="hljs-attr">gridAutoRows:</span> `${<span class="hljs-attr">CARD</span>}<span class="hljs-attr">px</span>`,
          <span class="hljs-attr">gap:</span> <span class="hljs-attr">GAP</span>,
          <span class="hljs-attr">padding:</span> <span class="hljs-attr">PAD</span>,
          <span class="hljs-attr">willChange:</span> "<span class="hljs-attr">transform</span>",
          <span class="hljs-attr">background:</span> "<span class="hljs-attr">rgba</span>(<span class="hljs-attr">0</span>,<span class="hljs-attr">0</span>,<span class="hljs-attr">0</span>,<span class="hljs-attr">.5</span>)",
        }}
      &gt;</span>
        {Array.from({ length: COLS * ROWS }).map((_, i) =&gt; (
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{i}</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span>
            <span class="hljs-attr">width:</span> "<span class="hljs-attr">100</span>%", <span class="hljs-attr">height:</span> "<span class="hljs-attr">100</span>%", <span class="hljs-attr">background:</span> "<span class="hljs-attr">green</span>",
            <span class="hljs-attr">borderRadius:</span> <span class="hljs-attr">8</span>, <span class="hljs-attr">color:</span> "#<span class="hljs-attr">fff</span>", <span class="hljs-attr">display:</span> "<span class="hljs-attr">flex</span>",
            <span class="hljs-attr">alignItems:</span> "<span class="hljs-attr">center</span>", <span class="hljs-attr">justifyContent:</span> "<span class="hljs-attr">center</span>"
          }}&gt;</span>
            {i + 1}
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        ))}
      <span class="hljs-tag">&lt;/<span class="hljs-name">motion.div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">motion.div</span>&gt;</span></span>
  );
}
</code></pre>
<p>首先声明2个变量，表示画布2个方向的偏移</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> x = <span class="hljs-title function_">useMotionValue</span>(<span class="hljs-number">0</span>);
<span class="hljs-keyword">const</span> y = <span class="hljs-title function_">useMotionValue</span>(<span class="hljs-number">0</span>);
</code></pre>
<p>给内容区域绑定这个偏移，由于motion是利用transform实现移动变换的，增加一个willChange: transform，告诉浏览器要针对transform事件进行优化</p>
<pre><code class="hljs language-typescript" lang="typescript">    &lt;motion.<span class="hljs-property">div</span>
            style={{
              x, y,
              <span class="hljs-attr">position</span>: <span class="hljs-string">"absolute"</span>,
              <span class="hljs-attr">left</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">top</span>: <span class="hljs-number">0</span>,
              <span class="hljs-attr">display</span>: <span class="hljs-string">"grid"</span>,
              <span class="hljs-attr">gridTemplateColumns</span>: <span class="hljs-string">`repeat(<span class="hljs-subst">${COLS}</span>, <span class="hljs-subst">${CARD}</span>px)`</span>,
              <span class="hljs-attr">gridAutoRows</span>: <span class="hljs-string">`<span class="hljs-subst">${CARD}</span>px`</span>,
              <span class="hljs-attr">gap</span>: <span class="hljs-variable constant_">GAP</span>,
              <span class="hljs-attr">padding</span>: <span class="hljs-variable constant_">PAD</span>,
              <span class="hljs-attr">willChange</span>: <span class="hljs-string">"transform"</span>,
              <span class="hljs-attr">background</span>: <span class="hljs-string">"rgba(0,0,0,.5)"</span>,
            }}
          &gt;
</code></pre>
<p>然后拖动时更新一下变量x y</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">onPan</span> = (<span class="hljs-params">_: <span class="hljs-built_in">any</span>, info: { delta: { x: <span class="hljs-built_in">number</span>; y: <span class="hljs-built_in">number</span> } }</span>) =&gt; {
    <span class="hljs-comment">// 先按正常增量计算</span>
    <span class="hljs-keyword">const</span> nextX = x.<span class="hljs-title function_">get</span>() + info.<span class="hljs-property">delta</span>.<span class="hljs-property">x</span>;
    <span class="hljs-keyword">const</span> nextY = y.<span class="hljs-title function_">get</span>() + info.<span class="hljs-property">delta</span>.<span class="hljs-property">y</span>;

    x.<span class="hljs-title function_">set</span>(nextX);
    y.<span class="hljs-title function_">set</span>(nextY);
  };
</code></pre>
<h2 data-id="heading-2">实现超出范围之后 回到原位</h2>
<p>上面例子中可以看到，黑色部分的内容区域被拖出了屏幕范围，这样显然不合理，我们想实现，拖出之后 他能自己反弹回来</p>
<p>那么第一步，我们首先要得到内容区域的宽高 才可以判断内容区域是否超出了边界，</p>
<p>尺寸计算：也就是卡片尺寸+卡片间隔+内容区padding</p>
<p>然后考虑2种情况，一种是内容区域比视口小，那么边界其实就是视口，最小的x，y都是0</p>
<p>一种是内容区域比视口大， 当前画布能最多往左移动 contentW - viewPortW，画个图好理解</p>
<p>最大x和y都是0 这个好理解，因为内容区域和视口都是左上角对齐，此时不允许在往右了，再移动就出现空白区域了</p>
<pre><code class="hljs language-typescript" lang="typescript">    <span class="hljs-keyword">const</span> viewportW = <span class="hljs-number">300</span>, viewportH = <span class="hljs-number">500</span>;
    <span class="hljs-keyword">const</span> contentW = <span class="hljs-variable constant_">COLS</span> * <span class="hljs-variable constant_">CARD</span> + (<span class="hljs-variable constant_">COLS</span> - <span class="hljs-number">1</span>) * <span class="hljs-variable constant_">GAP</span> + <span class="hljs-variable constant_">PAD</span> * <span class="hljs-number">2</span>;
    <span class="hljs-keyword">const</span> contentH = <span class="hljs-variable constant_">ROWS</span> * <span class="hljs-variable constant_">CARD</span> + (<span class="hljs-variable constant_">ROWS</span> - <span class="hljs-number">1</span>) * <span class="hljs-variable constant_">GAP</span> + <span class="hljs-variable constant_">PAD</span> * <span class="hljs-number">2</span>;

    <span class="hljs-keyword">const</span> minX = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(<span class="hljs-number">0</span>, viewportW - contentW);
    <span class="hljs-keyword">const</span> minY = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(<span class="hljs-number">0</span>, viewportH - contentH);
    <span class="hljs-keyword">const</span> maxX = <span class="hljs-number">0</span>, maxY = <span class="hljs-number">0</span>;
</code></pre>
<p>当x和y超出返回的时候，我们希望他回到合理的位置，也就是离他最近的边界。举个例子，x最小只能是-10，现在往左移动太多了，到了-30，那么我们希望他可以回到-10的位置</p>
<p>这个函数比较简单，如果在min和max之间就取value，如果超出了哪个边界 就以那个边界为准</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">clamp</span> = (<span class="hljs-params">v: <span class="hljs-built_in">number</span>, min: <span class="hljs-built_in">number</span>, max: <span class="hljs-built_in">number</span></span>) =&gt; <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(v, min), max);
</code></pre>
<p>接下来就要实现回弹了，在很多应用上有下拉刷新的动画，你会发现你可以一直往下拉，但是随着你拉的越多，页面下滑的反而越少，就像是在拉一个弹簧一样，我们就要实现这样的效果。</p>
<p>原来鼠标移动的距离跟内容区域移动距离是一样的，所以才会有跟手的效果。但现在由于有弹簧这样的效果，偏移的计算就会有变化</p>
<p>实现一个偏移计算函数，想象一样 你收到弹簧的力取决于两个参数：1. 弹簧本身弹性 2. 弹簧被拉长的长度</p>
<p>那么很容易想到这个偏移计算函数: 移动距离跟形变和弹性都成反比</p>
<p>其中constant是一个常数 可以理解为弹性，1是为了防止分母为0</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">rubber</span>(<span class="hljs-params">delta: <span class="hljs-built_in">number</span>, overflow: <span class="hljs-built_in">number</span>, constant = <span class="hljs-number">0.15</span></span>) {
  <span class="hljs-keyword">return</span> delta / (<span class="hljs-number">1</span> + overflow * constant);
}
</code></pre>
<p>接下来改造一下onPan拖动的回调函数，原来是拖动多少 就给内容区移动多少，现在则是要加上回弹的效果</p>
<p>先计算一下每个方向的溢出范围，可以理解为弹簧被拉动的长度，如果没超出范围 就是0</p>
<pre><code class="hljs language-typescript" lang="typescript">    <span class="hljs-keyword">const</span> overflowLeft   = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-number">0</span>, minX - nextX);
    <span class="hljs-keyword">const</span> overflowRight  = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-number">0</span>, nextX - maxX);
    <span class="hljs-keyword">const</span> overflowTop    = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-number">0</span>, minY - nextY);
    <span class="hljs-keyword">const</span> overflowBottom = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-number">0</span>, nextY - maxY);
</code></pre>
<p>然后利用刚刚的偏移计算函数，更新位置，这里x.get()是被拖动之前的距离，delta.x是鼠标拖动的距离，通过rubber函数得到被压缩的距离，然后累加到x上</p>
<pre><code class="hljs language-typescript" lang="typescript">
    <span class="hljs-keyword">if</span> (overflowLeft &gt; <span class="hljs-number">0</span> || overflowRight &gt; <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">const</span> overflow = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(overflowLeft, overflowRight);
      nextX = x.<span class="hljs-title function_">get</span>() + <span class="hljs-title function_">rubber</span>(info.<span class="hljs-property">delta</span>.<span class="hljs-property">x</span>, overflow);
    }
    <span class="hljs-keyword">if</span> (overflowTop &gt; <span class="hljs-number">0</span> || overflowBottom &gt; <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">const</span> overflow = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(overflowTop, overflowBottom);
      nextY = y.<span class="hljs-title function_">get</span>() + <span class="hljs-title function_">rubber</span>(info.<span class="hljs-property">delta</span>.<span class="hljs-property">y</span>, overflow);
    }

    x.<span class="hljs-title function_">set</span>(nextX); y.<span class="hljs-title function_">set</span>(nextY);
</code></pre>
<p>再想想下拉刷新的动画，我们下拉结束之后 内容会回到原位，这个我们也实现一下，也比较简单，就是在pan事件结束之后，把x和y通过clamp函数移动到边界，但是加上一个类似弹簧的动画，这个可以通过motion的animate函数来实现（它本身其实是一个插值）</p>
<pre><code class="hljs language-typescript" lang="typescript">
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">onPanEnd</span> = (<span class="hljs-params"/>) =&gt; {
      <span class="hljs-keyword">const</span> targetX = <span class="hljs-title function_">clamp</span>(x.<span class="hljs-title function_">get</span>(), minX, maxX);
      <span class="hljs-keyword">const</span> targetY = <span class="hljs-title function_">clamp</span>(y.<span class="hljs-title function_">get</span>(), minY, maxY);
      <span class="hljs-title function_">animate</span>(x, targetX, { <span class="hljs-attr">type</span>: <span class="hljs-string">"spring"</span>, <span class="hljs-attr">stiffness</span>: <span class="hljs-number">500</span>, <span class="hljs-attr">damping</span>: <span class="hljs-number">40</span> });
      <span class="hljs-title function_">animate</span>(y, targetY, { <span class="hljs-attr">type</span>: <span class="hljs-string">"spring"</span>, <span class="hljs-attr">stiffness</span>: <span class="hljs-number">500</span>, <span class="hljs-attr">damping</span>: <span class="hljs-number">40</span> });
    };
</code></pre>
<h2 data-id="heading-3">实现惯性效果</h2>
<p>在移动设备中，当我们用一个比较快的速度拖动元素的时候，松开手他会以一定的惯性继续移动，我们接下来要实现这个效果，但是要注意一下几点：</p>
<ol>
<li>拖拽阶段，rubber软边界（越界有阻力效果，已实现）</li>
<li>松手惯性阶段：当有一定速度的时候，给元素惯性，但是也要考虑越界的情况，越界的话 要使用spring回弹</li>
<li>低速松手：直接回弹，无惯性。</li>
<li>新一轮拖拽开始：停止惯性，确保跟手。就像你抓住了空中飞过来的飞盘</li>
</ol>
<p>松手惯性阶段要考虑：惯性、越界早停以及回弹</p>
<p>惯性这个好实现，motion提供的onPanEnd里提供了速度变量，我们可以偏移量=速度x一个常量，这样实现速度越大 偏移越大，从而实现惯性</p>
<p>然后考虑一下低速情况下松手，此时速度比较小，直接用上面的animate回弹就行</p>
<pre><code class="hljs language-typescript" lang="typescript">
    <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">SPEED_MIN</span> = <span class="hljs-number">60</span>;       <span class="hljs-comment">// 低速阈值（px/s），低于它直接回弹</span>


    <span class="hljs-keyword">const</span> <span class="hljs-title function_">onPanEnd</span> = (<span class="hljs-params">_: <span class="hljs-built_in">any</span>, info: { velocity: { x: <span class="hljs-built_in">number</span>; y: <span class="hljs-built_in">number</span> } }</span>) =&gt; {
        <span class="hljs-keyword">const</span> vx = info.<span class="hljs-property">velocity</span>.<span class="hljs-property">x</span>;
        <span class="hljs-keyword">const</span> vy = info.<span class="hljs-property">velocity</span>.<span class="hljs-property">y</span>;

        <span class="hljs-comment">// 低速松手：直接回弹，不进惯性</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">hypot</span>(vx, vy) &lt; <span class="hljs-variable constant_">SPEED_MIN</span>) {
          <span class="hljs-title function_">animate</span>(x, <span class="hljs-title function_">clamp</span>(x.<span class="hljs-title function_">get</span>(), minX, maxX), <span class="hljs-variable constant_">SPRING</span>);
          <span class="hljs-title function_">animate</span>(y, <span class="hljs-title function_">clamp</span>(y.<span class="hljs-title function_">get</span>(), minY, maxY), <span class="hljs-variable constant_">SPRING</span>);
          <span class="hljs-keyword">return</span>;
        }

        <span class="hljs-keyword">const</span> targetX = x.<span class="hljs-title function_">get</span>() + vx * <span class="hljs-number">0.5</span>;
        <span class="hljs-keyword">const</span> targetY = y.<span class="hljs-title function_">get</span>() + vy * <span class="hljs-number">0.5</span>;

        ....
    }
</code></pre>
<p>然后我们实现一个早停，这个效果有点像一个物体受到摩擦慢慢停下，在motion里它叫做inertia，他有两个参数：</p>
<ul>
<li>timeConstant用来控制速度时间衰减的所需时间，越小速度减少越快</li>
<li>power 控制初速度，越大 元素移动的越远</li>
</ul>
<p>下面函数，使用animate触发函数，返回值复制给一个ref，方便我们随时用停止动画</p>
<p>onUpdate回调，在每次位置变化都会调用，这里面我们要判断是否越界，如果不越界 不做处理</p>
<p>如果越界了，我们给他一个回弹的效果，这个实现起来也很简单，先计算越界的偏移量，越界越多，他实际移动距离越小，直到距离特别小的时候，使用回弹。</p>
<pre><code class="hljs language-typescript" lang="typescript">
    <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">SPEED_MIN</span> = <span class="hljs-number">60</span>;       <span class="hljs-comment">// 低速阈值（px），低于它直接回弹</span>
    <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">EPS_DELTA</span> = <span class="hljs-number">0.25</span>;     <span class="hljs-comment">// 越界早停阈值：本帧位移小于它就视为已停</span>

    <span class="hljs-comment">// 动画控制句柄（用于 stop）</span>
    <span class="hljs-keyword">const</span> axCtrlRef = useRef&lt;<span class="hljs-title class_">ReturnType</span>&lt;<span class="hljs-keyword">typeof</span> animate&gt; | <span class="hljs-literal">null</span>&gt;(<span class="hljs-literal">null</span>);
    <span class="hljs-keyword">const</span> ayCtrlRef = useRef&lt;<span class="hljs-title class_">ReturnType</span>&lt;<span class="hljs-keyword">typeof</span> animate&gt; | <span class="hljs-literal">null</span>&gt;(<span class="hljs-literal">null</span>);
    <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">INERTIA</span> = { <span class="hljs-attr">type</span>: <span class="hljs-string">"inertia"</span> <span class="hljs-keyword">as</span> <span class="hljs-keyword">const</span>, <span class="hljs-attr">power</span>: <span class="hljs-number">0.8</span>, <span class="hljs-attr">timeConstant</span>: <span class="hljs-number">350</span> };


    <span class="hljs-comment">// —— X 轴惯性</span>
        axCtrlRef.<span class="hljs-property">current</span> = <span class="hljs-title function_">animate</span>(x, targetX, {
          ...<span class="hljs-variable constant_">INERTIA</span>,
          <span class="hljs-attr">onUpdate</span>: <span class="hljs-function">(<span class="hljs-params">v</span>) =&gt;</span> {
            <span class="hljs-keyword">const</span> left = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-number">0</span>, minX - v);
            <span class="hljs-keyword">const</span> right = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-number">0</span>, v - maxX);
            <span class="hljs-keyword">if</span> (left &gt; <span class="hljs-number">0</span> || right &gt; <span class="hljs-number">0</span>) {
              <span class="hljs-keyword">const</span> overflow = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(left, right);
              <span class="hljs-keyword">const</span> last = x.<span class="hljs-title function_">get</span>();
              <span class="hljs-keyword">const</span> delta = v - last;
              <span class="hljs-keyword">const</span> next = last + <span class="hljs-title function_">rubber</span>(delta, overflow);
              <span class="hljs-comment">// 越界且步幅极小 → 立刻停止惯性并回弹</span>
              <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">abs</span>(next - last) &lt; <span class="hljs-variable constant_">EPS_DELTA</span>) {
                axCtrlRef.<span class="hljs-property">current</span>?.<span class="hljs-title function_">stop</span>();
                <span class="hljs-title function_">animate</span>(x, <span class="hljs-title function_">clamp</span>(next, minX, maxX), <span class="hljs-variable constant_">SPRING</span>);
              } <span class="hljs-keyword">else</span> {
                x.<span class="hljs-title function_">set</span>(next);
              }
            } <span class="hljs-keyword">else</span> {
              x.<span class="hljs-title function_">set</span>(v);
            }
          },
          <span class="hljs-attr">onComplete</span>: <span class="hljs-function">() =&gt;</span> {
            <span class="hljs-comment">// 兜底：即便没触发早停，也确保最终归位</span>
            <span class="hljs-title function_">animate</span>(x, <span class="hljs-title function_">clamp</span>(x.<span class="hljs-title function_">get</span>(), minX, maxX), <span class="hljs-variable constant_">SPRING</span>);
          },
        });

        <span class="hljs-comment">// —— Y 轴惯性</span>
        ayCtrlRef.<span class="hljs-property">current</span> = <span class="hljs-title function_">animate</span>(y, targetY, {
             ... 同上
      };
</code></pre>
<h2 data-id="heading-4">实现行列吸附效果</h2>
<p>上面我们实现了内容区域越界之后 自动clamp，吸附到视口边界的情况，现在我们要实现吸附到网格的位置。思路很简单：松手的时候，计算视口中心点距离所有网格中心点的距离，找到最小的那个，然后计算偏移，回弹</p>
<p>首先先改一下行列数目都是10，让横向纵向都能移动</p>
<pre><code class="hljs language-typescript" lang="typescript">    <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">COLS</span> = <span class="hljs-number">10</span>, <span class="hljs-variable constant_">ROWS</span> = <span class="hljs-number">10</span>, <span class="hljs-variable constant_">CARD</span> = <span class="hljs-number">100</span>, <span class="hljs-variable constant_">GAP</span> = <span class="hljs-number">10</span>, <span class="hljs-variable constant_">PAD</span> = <span class="hljs-number">20</span>;
</code></pre>
<p>定义一些常量，步长是卡片size+gap，得到第一个网格的中心坐标，方便用一个行列号得到所有网格的坐标</p>
<pre><code class="hljs language-typescript" lang="typescript">
    <span class="hljs-comment">// 网格步长 &amp; 首格中心（画布坐标）</span>
    <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">STEP_X</span> = <span class="hljs-variable constant_">CARD</span> + <span class="hljs-variable constant_">GAP</span>;
    <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">STEP_Y</span> = <span class="hljs-variable constant_">CARD</span> + <span class="hljs-variable constant_">GAP</span>;
    <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">BASE_X</span> = <span class="hljs-variable constant_">PAD</span> + <span class="hljs-variable constant_">CARD</span> / <span class="hljs-number">2</span>; <span class="hljs-comment">// 第1格中心x</span>
    <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">BASE_Y</span> = <span class="hljs-variable constant_">PAD</span> + <span class="hljs-variable constant_">CARD</span> / <span class="hljs-number">2</span>; <span class="hljs-comment">// 第1格中心y</span>
</code></pre>
<p>我们计算距离的时候，是假设画布没变的（如果计算每个网格偏移很麻烦），所以视口位置是在变化的</p>
<pre><code class="hljs language-typescript" lang="typescript">
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">snapToNearestBySearch</span>(<span class="hljs-params">
        xNow: <span class="hljs-built_in">number</span>,
        yNow: <span class="hljs-built_in">number</span>,
        viewportW: <span class="hljs-built_in">number</span>,
        viewportH: <span class="hljs-built_in">number</span>,
        cols: <span class="hljs-built_in">number</span>,
        rows: <span class="hljs-built_in">number</span>,
        minX: <span class="hljs-built_in">number</span>,
        maxX: <span class="hljs-built_in">number</span>,
        minY: <span class="hljs-built_in">number</span>,
        maxY: <span class="hljs-built_in">number</span>
      </span>) {
        <span class="hljs-keyword">const</span> <span class="hljs-title class_">Cx</span> = viewportW / <span class="hljs-number">2</span>;
        <span class="hljs-keyword">const</span> <span class="hljs-title class_">Cy</span> = viewportH / <span class="hljs-number">2</span>;

        <span class="hljs-comment">// 视口中心在“画布坐标系”下的位置</span>
        <span class="hljs-keyword">const</span> centerInCanvasX = <span class="hljs-title class_">Cx</span> - xNow;
        <span class="hljs-keyword">const</span> centerInCanvasY = <span class="hljs-title class_">Cy</span> - yNow;

        <span class="hljs-comment">// 穷举所有格心，找最近</span>
        <span class="hljs-keyword">let</span> bestCol = <span class="hljs-number">0</span>,
          bestRow = <span class="hljs-number">0</span>,
          bestD2 = <span class="hljs-title class_">Number</span>.<span class="hljs-property">POSITIVE_INFINITY</span>;
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> r = <span class="hljs-number">0</span>; r &lt; rows; r++) {
          <span class="hljs-keyword">const</span> cy = <span class="hljs-variable constant_">BASE_Y</span> + r * <span class="hljs-variable constant_">STEP_Y</span>;
          <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> c = <span class="hljs-number">0</span>; c &lt; cols; c++) {
            <span class="hljs-keyword">const</span> cx = <span class="hljs-variable constant_">BASE_X</span> + c * <span class="hljs-variable constant_">STEP_X</span>;
            <span class="hljs-keyword">const</span> dx = cx - centerInCanvasX;
            <span class="hljs-keyword">const</span> dy = cy - centerInCanvasY;
            <span class="hljs-keyword">const</span> d2 = dx * dx + dy * dy; <span class="hljs-comment">// 用平方距离避免开方</span>
            <span class="hljs-keyword">if</span> (d2 &lt; bestD2) {
              bestD2 = d2;
              bestCol = c;
              bestRow = r;
            }
          }
        }

        <span class="hljs-comment">// 最近格心（画布坐标）</span>
        <span class="hljs-keyword">const</span> snappedCx = <span class="hljs-variable constant_">BASE_X</span> + bestCol * <span class="hljs-variable constant_">STEP_X</span>;
        <span class="hljs-keyword">const</span> snappedCy = <span class="hljs-variable constant_">BASE_Y</span> + bestRow * <span class="hljs-variable constant_">STEP_Y</span>;

        <span class="hljs-comment">// 让该格心对齐到视口中心 → 需要的画布的偏移</span>
        <span class="hljs-keyword">let</span> targetX = <span class="hljs-title class_">Cx</span> - snappedCx;
        <span class="hljs-keyword">let</span> targetY = <span class="hljs-title class_">Cy</span> - snappedCy;

        <span class="hljs-comment">// 边界clamp</span>
        targetX = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(targetX, minX), maxX);
        targetY = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(targetY, minY), maxY);

        <span class="hljs-keyword">return</span> { targetX, targetY, bestCol, bestRow };
      }

然后写一个归位函数，同时移动x和y，防止有先后顺序 不太自然

    <span class="hljs-keyword">function</span> <span class="hljs-title function_">settleToNearest</span>(<span class="hljs-params">xNow: <span class="hljs-built_in">number</span>, yNow: <span class="hljs-built_in">number</span></span>) {
        <span class="hljs-keyword">if</span> (settledRef.<span class="hljs-property">current</span>) <span class="hljs-keyword">return</span>;
        settledRef.<span class="hljs-property">current</span> = <span class="hljs-literal">true</span>;

        <span class="hljs-comment">// 停掉两轴惯性，防止抢位置</span>
        axCtrlRef.<span class="hljs-property">current</span>?.<span class="hljs-title function_">stop</span>();
        ayCtrlRef.<span class="hljs-property">current</span>?.<span class="hljs-title function_">stop</span>();

        <span class="hljs-keyword">const</span> { targetX, targetY } = <span class="hljs-title function_">snapToNearestBySearch</span>(
          xNow, yNow, viewportW, viewportH, <span class="hljs-variable constant_">COLS</span>, <span class="hljs-variable constant_">ROWS</span>, minX, maxX, minY, maxY
        );

        <span class="hljs-comment">// 同时开两条 spring（同一时刻发出）</span>
        <span class="hljs-title function_">animate</span>(x, targetX, <span class="hljs-variable constant_">SPRING</span>);
        <span class="hljs-title function_">animate</span>(y, targetY, <span class="hljs-variable constant_">SPRING</span>);
      }
</code></pre>
<p>有了归位函数，我们需要明确调用时机:</p>
<ol>
<li>触发低速阈值</li>
<li>处罚早停阈值</li>
<li>惯性兜底，等动画结束后，防止没归位，在调用一次</li>
</ol>
<h2 data-id="heading-5">实现缩放效果</h2>
<p>想实现卡片的位置和尺寸有一种函数关系，最好的方法就是使用 useTransform 实现派生动画值，好处是动画变量更新时，不会触发React重渲染，只会在样式层更新，因此性能比较好</p>
<p>我们想实现卡片中心距离视口中心越近，卡片越大。当然这里是有个上限 不可能无限大和无限小，我们需要将距离归一化为0～1的一个数字，一个比较简单的方法就是直接把距离处以一个最大距离，这里规定最大距离为视口对角线一半</p>
<pre><code class="hljs language-typescript" lang="typescript">
    <span class="hljs-keyword">const</span> centerInCanvas = <span class="hljs-title function_">useTransform</span>([x, y], <span class="hljs-function">(<span class="hljs-params">[tx, ty]</span>) =&gt;</span> ({
      <span class="hljs-attr">cx</span>: viewportW / <span class="hljs-number">2</span> - tx,
      <span class="hljs-attr">cy</span>: viewportH / <span class="hljs-number">2</span> - ty,
    }));

    <span class="hljs-keyword">const</span> t = <span class="hljs-title function_">useTransform</span>(centerInCanvas, <span class="hljs-function">(<span class="hljs-params">{ cx, cy }</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> dx = cardCX - cx;
      <span class="hljs-keyword">const</span> dy = cardCY - cy;
      <span class="hljs-keyword">const</span> dist = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">hypot</span>(dx, dy);
      <span class="hljs-keyword">const</span> maxDist = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">hypot</span>(viewportW / <span class="hljs-number">2</span>, viewportH / <span class="hljs-number">2</span>); <span class="hljs-comment">// 对角的一半</span>
      <span class="hljs-keyword">return</span> <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(dist / maxDist, <span class="hljs-number">1</span>); <span class="hljs-comment">// 0=中心, 1=最远</span>
    });
</code></pre>
<p>这个t越小，距离中心越近，那么尺寸越大，所以我们用一个公式，scale = min + (max-min)*(1-t)</p>
<p>这是一个比较常见的归一化公式，通过线性插值缩放，这里如果是(1-t)就是反比，t就是正比</p>
<p>然后我们也希望，尺寸变化也是有一个过渡的，不能突变或者太线性，因此再用一个useSpring增加弹簧效果</p>
<pre><code class="hljs language-typescript" lang="typescript">
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">Card</span> = (<span class="hljs-params">{
      col,
      row,
      x,
      y,
      viewportW,
      viewportH,
      BASE_X,
      BASE_Y,
      STEP_X,
      STEP_Y,
      CARD,
      COLS,
      minScale = <span class="hljs-number">0.85</span>,
      maxScale = <span class="hljs-number">1.20</span>,
    }: CardProps</span>) =&gt; {
      <span class="hljs-comment">// 这张卡片在“画布坐标系”的中心点（不随位移而变）</span>
      <span class="hljs-keyword">const</span> cardCX = <span class="hljs-variable constant_">BASE_X</span> + col * <span class="hljs-variable constant_">STEP_X</span>;
      <span class="hljs-keyword">const</span> cardCY = <span class="hljs-variable constant_">BASE_Y</span> + row * <span class="hljs-variable constant_">STEP_Y</span>;

      <span class="hljs-comment">// 1) 由 [x,y] 派生“视口中心在画布坐标中的位置”</span>
      <span class="hljs-keyword">const</span> centerInCanvas = <span class="hljs-title function_">useTransform</span>([x, y], <span class="hljs-function">(<span class="hljs-params">[tx, ty]</span>) =&gt;</span> ({
        <span class="hljs-attr">cx</span>: viewportW / <span class="hljs-number">2</span> - tx,
        <span class="hljs-attr">cy</span>: viewportH / <span class="hljs-number">2</span> - ty,
      }));

      <span class="hljs-comment">// 2) 距离 → 归一化到 [0,1]</span>
      <span class="hljs-keyword">const</span> t = <span class="hljs-title function_">useTransform</span>(centerInCanvas, <span class="hljs-function">(<span class="hljs-params">{ cx, cy }</span>) =&gt;</span> {
        <span class="hljs-keyword">const</span> dx = cardCX - cx;
        <span class="hljs-keyword">const</span> dy = cardCY - cy;
        <span class="hljs-keyword">const</span> dist = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">hypot</span>(dx, dy);
        <span class="hljs-keyword">const</span> maxDist = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">hypot</span>(viewportW / <span class="hljs-number">2</span>, viewportH / <span class="hljs-number">2</span>); <span class="hljs-comment">// 对角的一半</span>
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(dist / maxDist, <span class="hljs-number">1</span>); <span class="hljs-comment">// 0=中心, 1=最远</span>
      });

      <span class="hljs-comment">// 3) t 越小越靠近中心：scale 从 minScale → maxScale</span>
      <span class="hljs-keyword">const</span> scaleRaw = <span class="hljs-title function_">useTransform</span>(t, <span class="hljs-function">(<span class="hljs-params">v</span>) =&gt;</span> minScale + (maxScale - minScale) * (<span class="hljs-number">1</span> - v));

      <span class="hljs-keyword">const</span> scale = <span class="hljs-title function_">useSpring</span>(scaleRaw, { <span class="hljs-attr">stiffness</span>: <span class="hljs-number">320</span>, <span class="hljs-attr">damping</span>: <span class="hljs-number">38</span>, <span class="hljs-attr">mass</span>: <span class="hljs-number">0.25</span> });


      <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">motion.div</span>
          <span class="hljs-attr">className</span>=<span class="hljs-string">"card"</span>
          <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span>
            <span class="hljs-attr">width:</span> <span class="hljs-attr">CARD</span>,
            <span class="hljs-attr">height:</span> <span class="hljs-attr">CARD</span>,
            <span class="hljs-attr">transformOrigin:</span> "<span class="hljs-attr">center</span>",
            <span class="hljs-attr">scale</span>,
            <span class="hljs-attr">background:</span> "<span class="hljs-attr">green</span>",
            <span class="hljs-attr">borderRadius:</span> <span class="hljs-attr">8</span>,
            <span class="hljs-attr">color:</span> "#<span class="hljs-attr">fff</span>",
            <span class="hljs-attr">display:</span> "<span class="hljs-attr">flex</span>",
            <span class="hljs-attr">alignItems:</span> "<span class="hljs-attr">center</span>",
            <span class="hljs-attr">justifyContent:</span> "<span class="hljs-attr">center</span>",
            <span class="hljs-attr">willChange:</span> "<span class="hljs-attr">transform</span>",
          }}
        &gt;</span>
          {row * COLS + col + 1}
        <span class="hljs-tag">&lt;/<span class="hljs-name">motion.div</span>&gt;</span></span>
      );
    }
</code></pre>
<h2 data-id="heading-6">需要注意的点</h2>
<ul>
<li>当动画出现卡顿/打架的情况，看看对于动画变量是不是出现了双写的情况</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[使用motion实现小宇宙贴纸墙效果]]></title>    <link>https://juejin.cn/post/7569904733718331411</link>    <guid>https://juejin.cn/post/7569904733718331411</guid>    <pubDate>2025-11-09T07:28:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7569904733718331411" data-draft-id="7569977160275492907" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="使用motion实现小宇宙贴纸墙效果"/> <meta itemprop="keywords" content="前端,交互设计"/> <meta itemprop="datePublished" content="2025-11-09T07:28:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="拜晨"/> <meta itemprop="url" content="https://juejin.cn/user/4160207732090168"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            使用motion实现小宇宙贴纸墙效果
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4160207732090168/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    拜晨
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-09T07:28:21.000Z" title="Sun Nov 09 2025 07:28:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>该文章的交互效果和完整代码可以在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fbaichen.vercel.app%2Fblog%2Fusing-motion-to-implement-sticker-wall" target="_blank" title="https://baichen.vercel.app/blog/using-motion-to-implement-sticker-wall" ref="nofollow noopener noreferrer">我的博客</a> 查看</p>
<p>小宇宙个人页面有一个贴纸墙的小功能，用来展示自己获得的一些成就，这个贴纸墙可以自己来调整贴纸位置，感觉是一个很好的功能，于是用motion复刻了一下</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e6c5016eac1d405b89662a63e748db56~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ouc5pmo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763278100&amp;x-signature=XyS2G4ExBYljbc1G4lhXAP8o1cY%3D" alt="ME1762673108603.png" loading="lazy"/></p>
<h2 data-id="heading-0">需要实现</h2>
<ul>
<li>拖拽移动贴纸</li>
<li>拖拽时有发光和放大效果</li>
<li>层级关系，点击之后置顶</li>
</ul>
<h2 data-id="heading-1">搭建框架</h2>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> {motion} <span class="hljs-keyword">from</span> <span class="hljs-string">'motion/react'</span>

<span class="hljs-keyword">const</span> stickers = [
  {
    <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>,
    <span class="hljs-attr">image</span>: <span class="hljs-string">'/stickers/fox.png'</span>,
    <span class="hljs-attr">width</span>: <span class="hljs-number">100</span>,
    <span class="hljs-attr">height</span>: <span class="hljs-number">100</span>,
  },
  {
    <span class="hljs-attr">id</span>: <span class="hljs-number">2</span>,
    <span class="hljs-attr">image</span>: <span class="hljs-string">'/stickers/santa-claus-1.png'</span>,
    <span class="hljs-attr">width</span>: <span class="hljs-number">100</span>,
    <span class="hljs-attr">height</span>: <span class="hljs-number">100</span>,
  },
  {
    <span class="hljs-attr">id</span>: <span class="hljs-number">3</span>,
    <span class="hljs-attr">image</span>: <span class="hljs-string">'/stickers/santa-claus-2.png'</span>,
    <span class="hljs-attr">width</span>: <span class="hljs-number">100</span>,
    <span class="hljs-attr">height</span>: <span class="hljs-number">100</span>,
  },
  {
    <span class="hljs-attr">id</span>: <span class="hljs-number">4</span>,
    <span class="hljs-attr">image</span>: <span class="hljs-string">'/stickers/santa-claus-3.png'</span>,
    <span class="hljs-attr">width</span>: <span class="hljs-number">100</span>,
    <span class="hljs-attr">height</span>: <span class="hljs-number">100</span>,
  },
]

<span class="hljs-keyword">const</span> <span class="hljs-title function_">StickerWall</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"sticker-wall container w-[800px] h-[800px] border border-dashed border-gray-300"</span>&gt;</span>
      {stickers.map((sticker) =&gt; (
        <span class="hljs-tag">&lt;<span class="hljs-name">motion.div</span>
          <span class="hljs-attr">key</span>=<span class="hljs-string">{sticker.id}</span>
          <span class="hljs-attr">className</span>=<span class="hljs-string">"sticker"</span>
          <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span>
            <span class="hljs-attr">width:</span> <span class="hljs-attr">sticker.width</span>,
            <span class="hljs-attr">height:</span> <span class="hljs-attr">sticker.height</span>,
            <span class="hljs-attr">backgroundImage:</span> `<span class="hljs-attr">url</span>(${<span class="hljs-attr">sticker.image</span>})`,
          }}
        &gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">img</span>
            <span class="hljs-attr">width</span>=<span class="hljs-string">{sticker.width}</span>
            <span class="hljs-attr">height</span>=<span class="hljs-string">{sticker.height}</span>
            <span class="hljs-attr">src</span>=<span class="hljs-string">{sticker.image}</span>
            <span class="hljs-attr">alt</span>=<span class="hljs-string">{sticker.id.toString()}</span>
          /&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">motion.div</span>&gt;</span>
      ))}
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">StickerWall</span>
</code></pre>
<h2 data-id="heading-2">实现拖拽</h2>
<p>实现拖拽这个很简单，只需要给图片元素增加<code>drag</code>属性，motion会自动给他绑定事件，实现拖拽效果</p>
<p>参考文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmotion.dev%2Fdocs%2Freact-drag" target="_blank" title="https://motion.dev/docs/react-drag" ref="nofollow noopener noreferrer">motion.dev/docs/react-…</a></p>
<p>这里我们不需要动量效果，也就是停止拖拽后还会继续移动，所以给他设置为<code>false</code></p>
<p>另外设置<code>dragConstraint</code>，控制元素能被拖动的范围，这里我们使用<code>constraintRef</code>设置为必须在父容器之内</p>
<pre><code class="hljs language-tsx" lang="tsx">&lt;motion.<span class="hljs-property">img</span>
  key={sticker.<span class="hljs-property">id</span>}
  drag
  dragConstraints={constraintsRef}
  dragElastic={<span class="hljs-number">0.1</span>}
  dragMomentum={<span class="hljs-literal">false</span>}
  width={<span class="hljs-variable constant_">STICKER_SIZE</span>}
  height={<span class="hljs-variable constant_">STICKER_SIZE</span>}
  src={sticker.<span class="hljs-property">image</span>}
  alt={sticker.<span class="hljs-property">id</span>.<span class="hljs-title function_">toString</span>()}
/&gt;
</code></pre>
<h2 data-id="heading-3">实现拖拽动画</h2>
<p>motion元素提供了<code>whileTap</code>，我们可以在拖拽时给元素修改<code>scale</code>样式。这里不能用<code>whileDrag</code>，因为<code>drag</code>事件必须是移动了3个像素才会触发，所以鼠标点下去的时候，元素并不会放大</p>
<pre><code class="hljs language-tsx" lang="tsx">&lt;motion.<span class="hljs-property">img</span>
  className=<span class="hljs-string">'sticker border-2 border-gray '</span>
  key={sticker.<span class="hljs-property">id</span>}
  drag
  dragConstraints={constraintsRef}
  dragElastic={<span class="hljs-number">0.1</span>}
  dragMomentum={<span class="hljs-literal">false</span>}
  whileTap={{ <span class="hljs-attr">scale</span>: <span class="hljs-number">1.2</span>, <span class="hljs-attr">cursor</span>: <span class="hljs-string">'grabbing'</span> }}
  transition={{ <span class="hljs-attr">type</span>: <span class="hljs-string">'spring'</span>, <span class="hljs-attr">stiffness</span>: <span class="hljs-number">400</span>, <span class="hljs-attr">damping</span>: <span class="hljs-number">30</span> }}
  width={<span class="hljs-variable constant_">STICKER_SIZE</span>}
  height={<span class="hljs-variable constant_">STICKER_SIZE</span>}
  src={sticker.<span class="hljs-property">image</span>}
  alt={sticker.<span class="hljs-property">id</span>.<span class="hljs-title function_">toString</span>()}
/&gt;
</code></pre>
<h2 data-id="heading-4">实现发光效果</h2>
<p>接下来我们要实现一个金属反光的效果，这个比较复杂，我们来拆解一下：</p>
<p>反光效果可以用一个白色的条从左到右运动实现，要实现这一的效果我们需要：</p>
<ul>
<li>手动触发动画，而且只播放一次</li>
<li>白色条有模糊效果，看起来更真实</li>
<li>初始位置在贴纸外侧，触发后移动到右侧</li>
</ul>
<p>由于这个反光条在图片上方，所以我们把这个容器写到img元素后面，根据层叠上下文："在一个相同父级里，DOM 元素按它们在文档流中的顺序依次叠放：后出现的兄弟元素会在视觉上覆盖前一个元素。"</p>
<p>外面容器只是用来定位，在里面渲染一个倾斜的矩形，这里为了方便调试，加上了边框。</p>
<pre><code class="hljs language-tsx" lang="tsx">&lt;motion.<span class="hljs-property">div</span>
  className=<span class="hljs-string">"pointer-events-none absolute inset-0 overflow-hidden rounded-md border-2"</span>
  initial=<span class="hljs-string">"initial"</span>
  animate={shineControls}
  variants={{
    <span class="hljs-attr">initial</span>: { <span class="hljs-attr">x</span>: <span class="hljs-string">'-100%'</span> },
    <span class="hljs-attr">active</span>: {
      <span class="hljs-attr">x</span>: <span class="hljs-string">'100%'</span>,
      <span class="hljs-attr">transition</span>: {
        <span class="hljs-attr">duration</span>: <span class="hljs-number">0.5</span>,
        <span class="hljs-attr">ease</span>: <span class="hljs-string">'easeInOut'</span>,
      },
    },
  }}
&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">motion.div</span>
    <span class="hljs-attr">className</span>=<span class="hljs-string">"absolute top-0 h-full w-1/3 bg-black rotate-12"</span>
  /&gt;</span></span>
&lt;/motion.<span class="hljs-property">div</span>&gt;
</code></pre>
<p>接着优化一下样式，白色条需要用渐变来渲染，从透明到白色再到透明</p>
<p>容器的透明度初始值也要为0，不然贴纸左边会有白色，显示有点怪。</p>
<p>要实现手动触发，需要用到<code>useAnimationControls</code>钩子，通过<code>start</code>、<code>stop</code>、<code>set</code>来控制动画播放，我们在<code>variants</code>定义了一些变量，通过<code>set</code>这些变量名来触发对应的效果。</p>
<pre><code class="hljs language-typescript" lang="typescript">
<span class="hljs-keyword">const</span> <span class="hljs-title function_">StickerItem</span> = (<span class="hljs-params">{
  sticker,
  constraintsRef,
}: {
  sticker: Sticker
  constraintsRef: MutableRefObject&lt;HTMLDivElement | <span class="hljs-literal">null</span>&gt;
}</span>) =&gt; {
  <span class="hljs-keyword">const</span> shineControls = <span class="hljs-title function_">useAnimationControls</span>()

  <span class="hljs-keyword">const</span> triggerShine = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> {
    shineControls.<span class="hljs-title function_">stop</span>()
    shineControls.<span class="hljs-title function_">set</span>(<span class="hljs-string">'initial'</span>)
    <span class="hljs-built_in">void</span> shineControls.<span class="hljs-title function_">start</span>(<span class="hljs-string">'active'</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {
      shineControls.<span class="hljs-title function_">set</span>(<span class="hljs-string">'initial'</span>)
    })
  }, [shineControls])

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">motion.div</span>
      <span class="hljs-attr">className</span>=<span class="hljs-string">"sticker relative flex items-center justify-center border-2 border-gray-200 bg-white shadow-sm"</span>
      <span class="hljs-attr">drag</span>
      <span class="hljs-attr">dragConstraints</span>=<span class="hljs-string">{constraintsRef}</span>
      <span class="hljs-attr">dragElastic</span>=<span class="hljs-string">{0.1}</span>
      <span class="hljs-attr">dragMomentum</span>=<span class="hljs-string">{false}</span>
      <span class="hljs-attr">whileTap</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">scale:</span> <span class="hljs-attr">1.2</span>, <span class="hljs-attr">cursor:</span> '<span class="hljs-attr">grabbing</span>' }}
      <span class="hljs-attr">transition</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">type:</span> '<span class="hljs-attr">spring</span>', <span class="hljs-attr">stiffness:</span> <span class="hljs-attr">400</span>, <span class="hljs-attr">damping:</span> <span class="hljs-attr">30</span> }}
      <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span>
        <span class="hljs-attr">width:</span> <span class="hljs-attr">STICKER_SIZE</span>,
        <span class="hljs-attr">height:</span> <span class="hljs-attr">STICKER_SIZE</span>,
      }}
      <span class="hljs-attr">onPointerDown</span>=<span class="hljs-string">{triggerShine}</span>
    &gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">img</span>
        <span class="hljs-attr">src</span>=<span class="hljs-string">{sticker.image}</span>
        <span class="hljs-attr">alt</span>=<span class="hljs-string">{sticker.id.toString()}</span>
        <span class="hljs-attr">className</span>=<span class="hljs-string">"pointer-events-none h-full w-full object-contain"</span>
      /&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">motion.div</span>
        <span class="hljs-attr">className</span>=<span class="hljs-string">"pointer-events-none absolute inset-0 overflow-hidden rounded-md"</span>
        <span class="hljs-attr">initial</span>=<span class="hljs-string">"initial"</span>
        <span class="hljs-attr">animate</span>=<span class="hljs-string">{shineControls}</span>
        <span class="hljs-attr">variants</span>=<span class="hljs-string">{{</span>
          <span class="hljs-attr">initial:</span> { <span class="hljs-attr">opacity:</span> <span class="hljs-attr">0</span>, <span class="hljs-attr">x:</span> '<span class="hljs-attr">-50</span>%' },
          <span class="hljs-attr">active:</span> {
            <span class="hljs-attr">opacity:</span> <span class="hljs-attr">1</span>,
            <span class="hljs-attr">x:</span> '<span class="hljs-attr">100</span>%',
            <span class="hljs-attr">transition:</span> {
              <span class="hljs-attr">duration:</span> <span class="hljs-attr">0.5</span>,
              <span class="hljs-attr">ease:</span> '<span class="hljs-attr">easeInOut</span>',
            },
          },
        }}
      &gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">motion.div</span>
          <span class="hljs-attr">className</span>=<span class="hljs-string">"absolute top-0 h-full w-1/3 rotate-12 bg-gradient-to-r from-transparent via-white to-transparent blur"</span>
        /&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">motion.div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">motion.div</span>&gt;</span></span>
  )
}

</code></pre>
<h2 data-id="heading-5">实现层级效果</h2>
<p>在小宇宙的贴纸墙中存在着层级关系，点击一个贴纸他会置顶，通过这样的方式可以实现贴纸层级的效果</p>
<p>那么在motion+react中我们怎么取维护层级关系呢</p>
<p>首先用一个state维护所有sticker的层级，给一个初始层级。点击贴纸的时候置顶，这里有两种实现方法，一种是点击之后让贴纸的index变成最大值+1，但是这样会导致index越来越大。</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">const</span> [zIndices, setZIndices] = useState&lt;<span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">number</span>, <span class="hljs-built_in">number</span>&gt;&gt;(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> <span class="hljs-attr">initial</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">number</span>, <span class="hljs-built_in">number</span>&gt; = {}
  stickers.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">sticker, index</span>) =&gt;</span> {
    initial[sticker.<span class="hljs-property">id</span>] = index + <span class="hljs-number">1</span>
  })
  <span class="hljs-keyword">return</span> initial
})

<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleActivate</span> = (<span class="hljs-params">id: <span class="hljs-built_in">number</span></span>) =&gt; {
  <span class="hljs-title function_">setZIndices</span>(<span class="hljs-function">(<span class="hljs-params">prev</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> nextTop = topZIndexRef.<span class="hljs-property">current</span> + <span class="hljs-number">1</span>
    topZIndexRef.<span class="hljs-property">current</span> = nextTop
    <span class="hljs-keyword">return</span> {
      ...prev,
      [id]: nextTop,
    }
  })
}
</code></pre>
<p>另一种方法是，利用队列的特性，激活贴纸的直接移动到队首。</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">const</span> [order, setOrder] = useState&lt;<span class="hljs-built_in">number</span>[]&gt;(<span class="hljs-function">() =&gt;</span>
  stickers.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">sticker</span>) =&gt;</span> sticker.<span class="hljs-property">id</span>)
)

<span class="hljs-keyword">const</span> handleActivate = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">(<span class="hljs-params">id: <span class="hljs-built_in">number</span></span>) =&gt;</span> {
  <span class="hljs-title function_">setOrder</span>(<span class="hljs-function">(<span class="hljs-params">prev</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> next = prev.<span class="hljs-title function_">filter</span>(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> item !== id)
    next.<span class="hljs-title function_">unshift</span>(id)
    <span class="hljs-keyword">return</span> next
  })
}, [])
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[浅入理解跨端渲染：从零实现 React DSL 跨端渲染机制]]></title>    <link>https://juejin.cn/post/7569817601976483866</link>    <guid>https://juejin.cn/post/7569817601976483866</guid>    <pubDate>2025-11-08T05:02:36.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7569817601976483866" data-draft-id="7569889957742215194" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="浅入理解跨端渲染：从零实现 React DSL 跨端渲染机制"/> <meta itemprop="keywords" content="前端,React.js,React Native"/> <meta itemprop="datePublished" content="2025-11-08T05:02:36.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="明远湖之鱼"/> <meta itemprop="url" content="https://juejin.cn/user/2370998127573751"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            浅入理解跨端渲染：从零实现 React DSL 跨端渲染机制
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2370998127573751/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    明远湖之鱼
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-08T05:02:36.000Z" title="Sat Nov 08 2025 05:02:36 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    11
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{position:relative;word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:30px;margin-bottom:5px}.markdown-body h2{font-size:24px;display:inline-block;font-weight:700;background:#ef7060;color:#fff;padding:6px 8px 0 0;border-top-right-radius:6px;margin-right:2px;box-shadow:6px 3px 0 0 rgba(239,112,96,.2)}.markdown-body h2:before{content:" ";display:inline-block;width:8px}.markdown-body h2:after{content:" ";position:absolute;display:block;width:calc(100% - 50px);border-bottom:3px solid #ef7060}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #3e3e3e;margin-top:32px;margin-bottom:32px;height:1px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(27,31,35,.05);color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:JetBranins Mono,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px;background-color:#fdfdfd}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#fdfdfd}.markdown-body a{text-decoration:none;font-weight:700;color:#ef7060;border-bottom:1px solid #ef7060}.markdown-body a:active,.markdown-body a:hover{color:#ef2d26}.markdown-body table tr td,.markdown-body table tr th{border:1px solid #ccc;padding:5px 10px}.markdown-body table{display:block!important;width:auto;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{background:#f0f0f0;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#f8f8f8}.markdown-body blockquote{margin-inline-start:0;margin-inline-end:0;border-left:3px solid #ef7060;background:#fff9f9;padding:1px 20px;margin-top:20px}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-light">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#383a42;background:#fafafa}.hljs-comment,.hljs-quote{color:#a0a1a7;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#a626a4}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e45649}.hljs-literal{color:#0184bb}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#50a14f}.hljs-built_in,.hljs-class .hljs-title{color:#c18401}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#986801}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#4078f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><h2 data-id="heading-0">前言</h2>
<p>在移动应用开发领域，跨端技术已经成为主流选择。React Native、Flutter、Weex 等框架让我们能够用一套代码运行在多个平台上。不同的框架实现的原理不同，更多的总结对比可以看这篇博客<a href="https://juejin.cn/post/7295750874181271603" target="_blank" title="https://juejin.cn/post/7295750874181271603">大厂自研跨端框架技术揭秘</a>。</p>
<p>笔者工作中使用的跨端框架叫做 Kun，是闲鱼基于 W3C 标准 &amp; Flutter 打造的混合高性能终端容器，其原理与 React Native 相似：</p>
<ol>
<li>使用 React 语法编写业务代码</li>
<li>编译打包成 JavaScript Bundle</li>
<li>在运行时通过桥接层渲染到各个平台</li>
</ol>
<p>本文将通过一个极简的 Web 模拟案例，带你深入理解这种 <strong>React DSL 跨端渲染的核心机制</strong>。</p>
<h2 data-id="heading-1">跨端渲染的本质</h2>
<p>跨端渲染的核心思想可以用一句话概括：<strong>用统一的 API 描述 UI，由框架负责在不同平台上完成渲染</strong>。</p>
<p>传统的移动端原生开发中，iOS 使用 UIKit，Android 使用 Android SDK，两者的 API 完全不同。而跨端框架通过引入一个中间层，让开发者用统一的方式描述 UI，然后由框架负责处理平台差异——可能是映射到原生组件（如 React Native、Kun），也可能是自己绘制 UI（如 Flutter），或是通过 WebView 渲染（如 H5、各家小程序方案等）。</p>
<h3 data-id="heading-2">架构分层</h3>
<p>一个典型的基于 React DSL 的跨端框架包含三个核心层次：</p>
<pre><code class="hljs language-scss" lang="scss">┌─────────────────────────────────┐
│      业务逻辑层 (JavaScript)      │  ← 开发者编写的代码
├─────────────────────────────────┤
│      桥接层 (Bridge)             │  ← 通信中枢
├─────────────────────────────────┤
│      渲染层 (Native)             │  ← 平台原生渲染
└─────────────────────────────────┘
</code></pre>
<p>完整的原理链路如下：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f941148f7d2147c0b7a5b64e0b65308f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5piO6L-c5rmW5LmL6bG8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763183333&amp;x-signature=ckEoERqbj9LkfVIgizkk2kp2STY%3D" alt="" loading="lazy"/></p>
<p>在编译时，可以通过 React DSL 脚手架工具，将 JSX 转化成 createElement 形式。最终的产物可以理解成一个 JS 文件，可以称之为 JSBundle。</p>
<p>重点来了，在运行时，我们分别从 web 应用 和 Native 应用 两个角度来解析流程：</p>
<ul>
<li>
<p>如果是 React DSL web 应用，那么可以通过浏览器加载 JSBundle ，然后通过运行时的 api 将页面结构，转化成虚拟 DOM , 虚拟 DOM 再转化成真实 DOM, 然后浏览器可以渲染真实 DOM 。</p>
</li>
<li>
<p>如果是 React DSL Native 应用，那么 Native 会通过一个 JS 引擎来运行 JSBundle ，然后同样通过运行时的 API 转化成虚拟 DOM, 接下来因为 Native 应用，所以不能直接转化的 DOM, 这个时候可以生成一些绘制指令，可以通过桥的方式，把指令传递给 Native 端，Native 端接收到指令之后，就可以绘制页面了。这样的好处就可以动态上传 bundle ，来<strong>实现动态化更新</strong>（个人认为没有动态化更新的跨端框架是没有灵魂的）。</p>
</li>
</ul>
<h2 data-id="heading-3">核心概念解析</h2>
<h3 data-id="heading-4">1. 虚拟 DOM (Virtual DOM)</h3>
<p>虚拟 DOM 是对真实 UI 的轻量级描述，它是一个纯 JavaScript 对象树。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 虚拟 DOM 节点结构</span>
{
  <span class="hljs-attr">tag</span>: <span class="hljs-string">'View'</span>,           <span class="hljs-comment">// 组件类型</span>
  <span class="hljs-attr">props</span>: { <span class="hljs-attr">id</span>: <span class="hljs-string">'root'</span> }, <span class="hljs-comment">// 属性</span>
  <span class="hljs-attr">children</span>: [            <span class="hljs-comment">// 子节点</span>
    {
      <span class="hljs-attr">tag</span>: <span class="hljs-string">'Text'</span>,
      <span class="hljs-attr">props</span>: { <span class="hljs-attr">text</span>: <span class="hljs-string">'Hello World'</span> },
      <span class="hljs-attr">children</span>: []
    }
  ]
}
</code></pre>
<p><strong>为什么需要虚拟 DOM？</strong></p>
<ul>
<li><strong>性能优化</strong>：直接操作原生 UI 成本高，虚拟 DOM 可以批量计算变更</li>
<li><strong>跨平台抽象</strong>：提供统一的 UI 描述方式</li>
<li><strong>Diff 算法</strong>：通过对比新旧虚拟 DOM，最小化实际渲染操作</li>
</ul>
<h3 data-id="heading-5">2. 桥接通信 (Bridge)</h3>
<p>桥接层是 JavaScript 层和 Native 层之间的通信管道。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Native → JS: 事件传递</span>
bridge.<span class="hljs-title function_">sendToJS</span>({
  <span class="hljs-attr">type</span>: <span class="hljs-string">'EVENT'</span>,
  <span class="hljs-attr">payload</span>: {
    <span class="hljs-attr">eventName</span>: <span class="hljs-string">'handleClick'</span>,
    <span class="hljs-attr">params</span>: { <span class="hljs-attr">x</span>: <span class="hljs-number">100</span>, <span class="hljs-attr">y</span>: <span class="hljs-number">200</span> }
  }
});

<span class="hljs-comment">// JS → Native: 渲染指令</span>
bridge.<span class="hljs-title function_">sendToNative</span>({
  <span class="hljs-attr">type</span>: <span class="hljs-string">'RENDER'</span>,
  <span class="hljs-attr">payload</span>: [
    { <span class="hljs-attr">type</span>: <span class="hljs-string">'CREATE'</span>, <span class="hljs-attr">payload</span>: {...} },
    { <span class="hljs-attr">type</span>: <span class="hljs-string">'UPDATE'</span>, <span class="hljs-attr">payload</span>: {...} }
  ]
});
</code></pre>
<p><strong>桥接通信的特点</strong>：</p>
<ul>
<li><strong>异步通信</strong>：避免阻塞主线程</li>
<li><strong>序列化传输</strong>：数据需要序列化为 JSON</li>
<li><strong>双向通道</strong>：支持 JS ↔ Native 双向消息传递</li>
</ul>
<h3 data-id="heading-6">3. 渲染指令 (Render Instructions)</h3>
<p>渲染指令是 JavaScript 层告诉 Native 层"如何渲染"的命令集。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 三种基本指令类型</span>
<span class="hljs-keyword">const</span> instructions = [
	{
		<span class="hljs-attr">type</span>: <span class="hljs-string">'CREATE'</span>, <span class="hljs-comment">// 创建新元素</span>
		<span class="hljs-attr">payload</span>: {
			<span class="hljs-attr">id</span>: <span class="hljs-string">'vdom_1'</span>,
			<span class="hljs-attr">tag</span>: <span class="hljs-string">'View'</span>,
			<span class="hljs-attr">props</span>: {},
			<span class="hljs-attr">parentId</span>: <span class="hljs-literal">null</span>
		}
	},
	{
		<span class="hljs-attr">type</span>: <span class="hljs-string">'UPDATE'</span>, <span class="hljs-comment">// 更新已有元素</span>
		<span class="hljs-attr">payload</span>: {
			<span class="hljs-attr">id</span>: <span class="hljs-string">'vdom_2'</span>,
			<span class="hljs-attr">props</span>: { <span class="hljs-attr">text</span>: <span class="hljs-string">'New Text'</span> }
		}
	},
	{
		<span class="hljs-attr">type</span>: <span class="hljs-string">'DELETE'</span>, <span class="hljs-comment">// 删除元素</span>
		<span class="hljs-attr">payload</span>: {
			<span class="hljs-attr">id</span>: <span class="hljs-string">'vdom_3'</span>
		}
	}
];
</code></pre>
<h2 data-id="heading-7">完整渲染流程</h2>
<p>让我们通过一个完整的交互流程，理解整个渲染机制：</p>
<h3 data-id="heading-8">阶段一：初始化渲染</h3>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> Native 层启动
   ↓
<span class="hljs-bullet">2.</span> 初始化 JS 引擎（JSCore/V8/Hermes）
   ↓
<span class="hljs-bullet">3.</span> 加载并执行 JavaScript 代码
   ↓
<span class="hljs-bullet">4.</span> JS 层创建虚拟 DOM 树
   ↓
<span class="hljs-bullet">5.</span> 生成渲染指令
   ↓
<span class="hljs-bullet">6.</span> 通过 Bridge 发送到 Native
   ↓
<span class="hljs-bullet">7.</span> Native 层执行渲染指令
   ↓
<span class="hljs-bullet">8.</span> 显示 UI
</code></pre>
<p><strong>代码示例</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// JS 层：初始化渲染</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ReactDSL</span> {
	<span class="hljs-title function_">mount</span>(<span class="hljs-params"/>) {
		<span class="hljs-comment">// 1. 执行 render 函数生成虚拟 DOM</span>
		<span class="hljs-keyword">const</span> vdom = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">render</span>();

		<span class="hljs-comment">// 2. 转换为渲染指令</span>
		<span class="hljs-keyword">const</span> instructions = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">vdomToInstructions</span>(vdom);

		<span class="hljs-comment">// 3. 发送到 Native</span>
		<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">sendToNative</span>({
			<span class="hljs-attr">type</span>: <span class="hljs-string">'RENDER'</span>,
			<span class="hljs-attr">payload</span>: instructions
		});
	}

	<span class="hljs-title function_">render</span>(<span class="hljs-params"/>) {
		<span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">createElement</span>(
			<span class="hljs-string">'View'</span>,
			{},
			<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'Text'</span>, {
				<span class="hljs-attr">text</span>: <span class="hljs-string">'欢迎使用 React Native'</span>
			})
		);
	}
}
</code></pre>
<h3 data-id="heading-9">阶段二：交互更新</h3>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> 用户点击按钮
   ↓
<span class="hljs-bullet">2.</span> Native 层捕获事件
   ↓
<span class="hljs-bullet">3.</span> 通过 Bridge 发送事件到 JS 层
   ↓
<span class="hljs-bullet">4.</span> JS 层执行事件处理函数
   ↓
<span class="hljs-bullet">5.</span> 更新状态 (setState)
   ↓
<span class="hljs-bullet">6.</span> 重新执行 render 生成新虚拟 DOM
   ↓
<span class="hljs-bullet">7.</span> Diff 算法对比新旧虚拟 DOM
   ↓
<span class="hljs-bullet">8.</span> 生成最小化的更新指令
   ↓
<span class="hljs-bullet">9.</span> 通过 Bridge 发送到 Native
   ↓
<span class="hljs-bullet">10.</span> Native 层执行更新指令
   ↓
<span class="hljs-bullet">11.</span> UI 更新完成
</code></pre>
<p><strong>代码示例</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// JS 层：状态更新流程</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ReactDSL</span> {
	<span class="hljs-title function_">handleIncrement</span>(<span class="hljs-params"/>) {
		<span class="hljs-comment">// 1. 更新状态</span>
		<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setState</span>({ <span class="hljs-attr">count</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>.<span class="hljs-property">count</span> + <span class="hljs-number">1</span> });
	}

	<span class="hljs-title function_">setState</span>(<span class="hljs-params">newState</span>) {
		<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = { ...<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>, ...newState };

		<span class="hljs-comment">// 2. 触发更新</span>
		<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">update</span>();
	}

	<span class="hljs-title function_">update</span>(<span class="hljs-params"/>) {
		<span class="hljs-comment">// 3. 生成新虚拟 DOM</span>
		<span class="hljs-keyword">const</span> newVDOM = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">render</span>();

		<span class="hljs-comment">// 4. Diff 算法</span>
		<span class="hljs-keyword">const</span> instructions = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">diff</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">currentVDOM</span>, newVDOM);

		<span class="hljs-comment">// 5. 更新缓存</span>
		<span class="hljs-variable language_">this</span>.<span class="hljs-property">currentVDOM</span> = newVDOM;

		<span class="hljs-comment">// 6. 发送更新指令</span>
		<span class="hljs-keyword">if</span> (instructions.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
			<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">sendToNative</span>({
				<span class="hljs-attr">type</span>: <span class="hljs-string">'RENDER'</span>,
				<span class="hljs-attr">payload</span>: instructions
			});
		}
	}
}
</code></pre>
<h2 data-id="heading-10">Diff 算法简析</h2>
<p>Diff 算法是跨端渲染的性能关键。它的目标是：<strong>找出新旧虚拟 DOM 的最小差异</strong>。</p>
<h3 data-id="heading-11">简化版 Diff 实现</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">diff</span>(<span class="hljs-params">oldVDOM, newVDOM</span>) {
  <span class="hljs-keyword">const</span> instructions = [];

  <span class="hljs-comment">// 策略1：如果节点类型不同，直接替换</span>
  <span class="hljs-keyword">if</span> (oldVDOM.<span class="hljs-property">tag</span> !== newVDOM.<span class="hljs-property">tag</span>) {
    instructions.<span class="hljs-title function_">push</span>(
      { <span class="hljs-attr">type</span>: <span class="hljs-string">'DELETE'</span>, <span class="hljs-attr">payload</span>: { <span class="hljs-attr">id</span>: oldVDOM.<span class="hljs-property">id</span> } },
      { <span class="hljs-attr">type</span>: <span class="hljs-string">'CREATE'</span>, <span class="hljs-attr">payload</span>: newVDOM }
    );
    <span class="hljs-keyword">return</span> instructions;
  }

  <span class="hljs-comment">// 策略2：对比属性变化</span>
  <span class="hljs-keyword">const</span> propsChanged = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">diffProps</span>(oldVDOM.<span class="hljs-property">props</span>, newVDOM.<span class="hljs-property">props</span>);
  <span class="hljs-keyword">if</span> (propsChanged) {
    instructions.<span class="hljs-title function_">push</span>({
      <span class="hljs-attr">type</span>: <span class="hljs-string">'UPDATE'</span>,
      <span class="hljs-attr">payload</span>: {
        <span class="hljs-attr">id</span>: oldVDOM.<span class="hljs-property">id</span>,
        <span class="hljs-attr">props</span>: newVDOM.<span class="hljs-property">props</span>
      }
    });
  }

  <span class="hljs-comment">// 策略3：递归对比子节点</span>
  <span class="hljs-keyword">const</span> childInstructions = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">diffChildren</span>(
    oldVDOM.<span class="hljs-property">children</span>,
    newVDOM.<span class="hljs-property">children</span>
  );
  instructions.<span class="hljs-title function_">push</span>(...childInstructions);

  <span class="hljs-keyword">return</span> instructions;
}
</code></pre>
<h3 data-id="heading-12">React 的 Diff 优化策略</h3>
<ol>
<li><strong>同层比较</strong>：只比较同一层级的节点，不跨层级</li>
<li><strong>Key 优化</strong>：通过 key 快速识别节点移动</li>
<li><strong>类型判断</strong>：不同类型的组件直接替换，不深入比较</li>
</ol>
<h2 data-id="heading-13">原理最简化实现及实战案例</h2>
<p>下面用一个非常简单案例，来用前端的方式模拟 React DSL Native 渲染流程。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/57d30c4240144febaf689d4677e6553a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5piO6L-c5rmW5LmL6bG8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763183333&amp;x-signature=l%2F2NG6QKzaKrvMOxsRyhIAKP9Is%3D" alt="" loading="lazy"/></p>
<ul>
<li>index.html 为视图层, 这里用视图层模拟代替了 Native 应用。</li>
<li>bridge 为 JS 层和 Native 层的代码。</li>
<li>service.js 为我们写在 js 业务层的代码。</li>
</ul>
<p>核心流程如下：</p>
<ul>
<li>本质上 service.js 运行在 Native 的 JS 引擎中，形成虚拟 DOM ，和绘制指令。</li>
<li>绘制指令可以通过 bridge 传递给 Native 端 （案例中的 html 和 js ）,然后渲染视图。</li>
<li>当触发更新时候，Native 端响应事件，然后把事件通过桥方式传递给 service.js， 接下来 service.js 处理逻辑，发生 diff 更新，产生新的绘制指令，通知给 Native 渲染视图。</li>
</ul>
<p>因为这个案例是用 web 应用模拟的 Native ，所以实现细节和真实场景有所不同，尽请谅解，本案例主要让读者更清晰了解渲染流程。</p>
<p>完整代码在仓库<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FXC0703%2Freact-dsl-renderer-demo" target="_blank" title="https://github.com/XC0703/react-dsl-renderer-demo" ref="nofollow noopener noreferrer">react-dsl-renderer-demo</a>中，直接运行仓库下面的<code>index.html</code>即可看到相关效果：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/16f521df6ca44066bc42596f243b67d1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5piO6L-c5rmW5LmL6bG8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763183333&amp;x-signature=1dGdtg13zLHoENxfS%2B2IibZPAQU%3D" alt="" loading="lazy"/></p>
<p>让我们通过一个完整的计数器应用，串联所有知识点：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// service.js - 业务逻辑层</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">CounterApp</span> {
	<span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
		<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = { <span class="hljs-attr">count</span>: <span class="hljs-number">0</span> };
	}

	<span class="hljs-comment">// 渲染函数</span>
	<span class="hljs-title function_">render</span>(<span class="hljs-params"/>) {
		<span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">createElement</span>(
			<span class="hljs-string">'View'</span>,
			{},
			<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'Text'</span>, {
				<span class="hljs-attr">text</span>: <span class="hljs-string">`计数: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.state.count}</span>`</span>
			}),
			<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'Button'</span>, {
				<span class="hljs-attr">title</span>: <span class="hljs-string">'增加'</span>,
				<span class="hljs-attr">onPress</span>: <span class="hljs-string">'handleIncrement'</span>
			})
		);
	}

	<span class="hljs-comment">// 事件处理</span>
	<span class="hljs-title function_">handleIncrement</span>(<span class="hljs-params"/>) {
		<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setState</span>({ <span class="hljs-attr">count</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>.<span class="hljs-property">count</span> + <span class="hljs-number">1</span> });
	}
}
</code></pre>
<p><strong>执行流程分析</strong>：</p>
<ol>
<li>
<p><strong>初始渲染</strong>：</p>
<ul>
<li>生成虚拟 DOM：<code>View -&gt; [Text, Button]</code></li>
<li>转换为 3 条 CREATE 指令</li>
<li>Native 创建对应的原生组件</li>
</ul>
</li>
<li>
<p><strong>点击按钮</strong>：</p>
<ul>
<li>Native 捕获点击事件</li>
<li>发送 <code>EVENT</code> 消息到 JS</li>
<li>JS 执行 <code>handleIncrement</code></li>
<li>状态从 <code>{count: 0}</code> 变为 <code>{count: 1}</code></li>
<li>重新 render 生成新虚拟 DOM</li>
<li>Diff 发现 Text 的 text 属性变化</li>
<li>生成 1 条 UPDATE 指令</li>
<li>Native 更新 Text 组件显示</li>
</ul>
</li>
</ol>
<h2 data-id="heading-14">总结</h2>
<p>通过本文的剖析，我们了解了 React DSL 跨端渲染的核心机制：</p>
<ol>
<li><strong>虚拟 DOM</strong> 提供了统一的 UI 描述方式</li>
<li><strong>Bridge</strong> 实现了 JS 与 Native 的通信桥梁</li>
<li><strong>Diff 算法</strong> 最小化了实际的渲染操作</li>
<li><strong>渲染指令</strong> 将 UI 变更转换为平台操作</li>
</ol>
<p>当然，用于生产环境的跨端框架在实现上会有更多细节和优化，使用的具体技术也可能不同，但核心原理是一致的。</p>
<p>跨端技术的本质是<strong>在性能和开发效率之间找到平衡</strong>。理解其底层原理，能帮助我们：</p>
<ul>
<li>写出更高性能的跨端应用</li>
<li>更好地调试和优化问题</li>
<li>为技术选型提供依据</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[前端画布类型编辑器项目，历史记录技术方案调研]]></title>    <link>https://juejin.cn/post/7570213477949538356</link>    <guid>https://juejin.cn/post/7570213477949538356</guid>    <pubDate>2025-11-09T08:46:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7570213477949538356" data-draft-id="7569547273114845234" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="前端画布类型编辑器项目，历史记录技术方案调研"/> <meta itemprop="keywords" content="前端,GitHub,架构"/> <meta itemprop="datePublished" content="2025-11-09T08:46:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="吃饺子不吃馅"/> <meta itemprop="url" content="https://juejin.cn/user/1148309742825495"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            前端画布类型编辑器项目，历史记录技术方案调研
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1148309742825495/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    吃饺子不吃馅
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-09T08:46:07.000Z" title="Sun Nov 09 2025 08:46:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a84c8bb492a84c0992032d35ff0ee935~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCD6aW65a2Q5LiN5ZCD6aaF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763282767&amp;x-signature=DGvoEojSNejMcc319AT0EEjDJEY%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/80309982376b4404aa5ce239fa61d2c7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCD6aW65a2Q5LiN5ZCD6aaF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763282767&amp;x-signature=vVZNJn7%2Bqd5bn73iHg%2FPtCmY7ls%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li><strong>GitHub 仓库</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fduchao-duchao%2Fweb-ppt" target="_blank" title="https://github.com/duchao-duchao/web-ppt" ref="nofollow noopener noreferrer">web-ppt</a></li>
<li><strong>在线体验</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fweb-ppt-omega.vercel.app%2F" target="_blank" title="https://web-ppt-omega.vercel.app/" ref="nofollow noopener noreferrer">Live Demo</a></li>
</ul>
<p>最近在做一个在线PPT编辑器，其中状态管理用到了Zustand，撤销重做功能用的是zundo，编辑器类型的项目一般都会有历史记录功能，但是记录用户的操作有哪些方案呐？</p>
<h2 data-id="heading-0">主流技术方案对比</h2>
<p>目前，业界主要有三种实现思路：<strong>命令模式</strong>、<strong>状态快照（备忘录模式）和差异-补丁（Diff-Patch）</strong> 。</p>
<h3 data-id="heading-1">方案一：命令模式 (Command Pattern)</h3>
<p>这是实现撤销/重做功能最经典、最正统的设计模式。</p>
<ul>
<li>
<p>核心思想：</p>
<p>将用户的每一个“操作”封装成一个包含execute（执行）和undo（撤销）方法的命令对象。</p>
</li>
<li>
<p>数据结构：</p>
<p>使用两个栈：undoStack（撤销栈）和redoStack（重做栈）。</p>
</li>
<li>
<p><strong>工作流程：</strong></p>
<ol>
<li><strong>执行操作：</strong> 用户执行一个新操作（如“添加矩形”）。</li>
<li>创建一个<code>AddRectangleCommand</code>对象。</li>
<li>调用<code>command.execute()</code>来执行该操作（更新画布状态）。</li>
<li>将该<code>command</code>压入<code>undoStack</code>。</li>
<li><strong>撤销 (Undo)：</strong></li>
<li>从<code>undoStack</code>弹出一个<code>command</code>。</li>
<li>调用<code>command.undo()</code>。</li>
<li>将该<code>command</code>压入<code>redoStack</code>。</li>
<li><strong>重做 (Redo)：</strong></li>
<li>从<code>redoStack</code>弹出一个<code>command</code>。</li>
<li>调用<code>command.execute()</code>。</li>
<li>将该<code>command</code>压入<code>undoStack</code>。</li>
</ol>
</li>
<li>
<p><strong>优点：</strong></p>
<ul>
<li><strong>内存占用低：</strong> 只存储“操作”本身，而不是完整的画布状态。</li>
<li><strong>逻辑清晰：</strong> <code>undo</code>和<code>execute</code>逻辑高度内聚，易于理解和测试。</li>
<li><strong>高性能：</strong> <code>undo/redo</code>操作通常很快，因为它们只执行逆向/正向操作。</li>
</ul>
</li>
<li>
<p><strong>缺点：</strong></p>
<ul>
<li><strong>实现复杂度高：</strong> 必须为<strong>每一个</strong>可撤销的操作（移动、缩放、变色、删除、组合...）编写一个具体的<code>Command</code>类及其<code>undo</code>逻辑。</li>
<li><strong><code>undo</code>的实现难度：</strong> <code>undo</code>操作（如“撤销删除”）可能需要存储被删除对象的状态，这会增加命令对象的复杂度。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-2">方案二：状态快照 (State Snapshots / Memento Pattern)</h3>
<p>这是一种实现上更简单粗暴，但在特定场景下非常有效的模式。</p>
<ul>
<li>
<p>核心思想：</p>
<p>在每次“有效操作”结束时，将整个画布的完整状态（通常是JSON数据）序列化并存储起来。</p>
</li>
<li>
<p>数据结构：</p>
<p>一个数组（historyStack）和一个指针（currentIndex）。</p>
</li>
<li>
<p><strong>工作流程：</strong></p>
<ol>
<li><strong>执行操作：</strong> 用户完成操作（如拖拽结束）。</li>
<li>获取当前画布的完整状态<code>newState</code>。</li>
<li>将<code>newState</code>添加到<code>historyStack</code>中<code>currentIndex</code>的位置。</li>
<li><code>currentIndex</code>加一。</li>
<li><strong>撤销 (Undo)：</strong></li>
<li><code>currentIndex</code>减一。</li>
<li>从<code>historyStack[currentIndex]</code>获取<code>previousState</code>。</li>
<li><strong>用<code>previousState</code>完全覆盖</strong>当前画布状态并重新渲染。</li>
<li><strong>重做 (Redo)：</strong></li>
<li><code>currentIndex</code>加一。</li>
<li>从<code>historyStack[currentIndex]</code>获取<code>nextState</code>。</li>
<li>用<code>nextState</code>覆盖当前状态并重新渲染。</li>
</ol>
</li>
<li>
<p><strong>优点：</strong></p>
<ul>
<li><strong>实现简单：</strong> 核心逻辑与业务操作解耦。历史记录系统不需要“理解”什么是“移动”，什么是“变色”，它只负责保存和恢复状态。</li>
<li><strong>绝对可靠：</strong> 只要状态的序列化和反序列化是正确的，<code>undo/redo</code>就绝对不会出错。</li>
</ul>
</li>
<li>
<p><strong>缺点：</strong></p>
<ul>
<li><strong>内存占用极大：</strong> 如果画布状态有10MB，100步历史就是1GB内存。这在Web端几乎是不可接受的。</li>
<li><strong>性能瓶颈：</strong> 序列化/反序列化/深拷贝大型状态对象（Deep Clone）可能非常耗时，导致UI卡顿。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-3">方案三：增量差异 (Diff-Patch)</h3>
<p>这是快照模式的进一步演进，也是目前在React等状态驱动框架中非常流行的一种方案。</p>
<ul>
<li>
<p>核心思想：</p>
<p>结合了命令模式（只存变化）和快照模式（不关心操作逻辑）的优点。它不存储完整的状态，也不存储操作命令，而是存储两个状态之间的差异（Diff/Patch）。</p>
</li>
<li>
<p>数据结构：</p>
<p>undoStack（存储逆向Patch）和redoStack（存储正向Patch）。</p>
</li>
<li>
<p><strong>工作流程：</strong></p>
<ol>
<li><strong>执行操作：</strong></li>
<li>（操作前）记录当前状态 <code>State A</code>。</li>
<li>（操作后）生成新状态 <code>State B</code>。</li>
<li><strong>计算差异：</strong> <code>Patch (A -&gt; B)</code>（正向补丁）和 <code>Inverse Patch (B -&gt; A)</code>（逆向补丁）。</li>
<li>将<code>Inverse Patch</code>压入<code>undoStack</code>。</li>
<li>将<code>Patch</code>压入<code>redoStack</code>（或在<code>undo</code>时再计算）。</li>
<li><strong>撤销 (Undo)：</strong></li>
<li>从<code>undoStack</code>弹出<code>Inverse Patch</code>。</li>
<li>将该补丁<strong>Apply</strong>到当前状态，使其回退到<code>State A</code>。</li>
<li><strong>重做 (Redo)：</strong></li>
<li>从<code>redoStack</code>弹出<code>Patch</code>。</li>
<li>将该补丁应用到当前状态，使其前进到<code>State B</code>。</li>
</ol>
</li>
<li>
<p><strong>优点：</strong></p>
<ul>
<li><strong>内存与性能均衡：</strong> 内存占用远小于全量快照（只存Diff），实现复杂度远低于命令模式（自动生成Diff和Patch）</li>
</ul>
</li>
<li>
<p><strong>缺点：</strong></p>
<ul>
<li><strong>Diff/Patch的开销：</strong> 如果一次操作改变了状态树的很多部分，计算Diff和生成Patch本身也可能有性能开销（但通常快于深拷贝）。</li>
<li><strong>依赖库：</strong> 通常需要依赖一个健壮的Diff/Patch库</li>
</ul>
</li>
</ul>
<hr/>
<h2 data-id="heading-4">方案对比总结</h2>









































<table><thead><tr><th><strong>特性</strong></th><th><strong>命令模式 (Command Pattern)</strong></th><th><strong>状态快照 (State Snapshot)</strong></th><th><strong>增量差异 (Diff-Patch)</strong></th></tr></thead><tbody><tr><td><strong>核心</strong></td><td>存储“操作”</td><td>存储“完整状态”</td><td>存储“状态差异”</td></tr><tr><td><strong>内存占用</strong></td><td><strong>极低</strong></td><td><strong>极高</strong></td><td><strong>较低</strong></td></tr><tr><td><strong>性能开销</strong></td><td><code>undo/redo</code>极快</td><td>存取时开销大 (深拷贝/序列化)</td><td>存取时有Diff/Patch计算开销</td></tr><tr><td><strong>实现复杂度</strong></td><td><strong>极高</strong> (需实现所有<code>undo</code>逻辑)</td><td><strong>极低</strong></td><td><strong>中等</strong> (需依赖Diff库)</td></tr><tr><td><strong>适用场景</strong></td><td>性能和内存要求苛刻的复杂应用</td><td>状态简单的小型应用</td><td><strong>现代前端框架 (React/Vue)</strong> ，状态驱动型应用</td></tr></tbody></table></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[大数据-147 Java 访问 Apache Kudu：从建表到 CRUD（含 KuduSession 刷新模式与多 Master 配置）]]></title>    <link>https://juejin.cn/post/7569904733718446099</link>    <guid>https://juejin.cn/post/7569904733718446099</guid>    <pubDate>2025-11-09T08:43:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7569904733718446099" data-draft-id="7569904733718429715" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="大数据-147 Java 访问 Apache Kudu：从建表到 CRUD（含 KuduSession 刷新模式与多 Master 配置）"/> <meta itemprop="keywords" content="后端,大数据,NoSQL"/> <meta itemprop="datePublished" content="2025-11-09T08:43:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="武子康"/> <meta itemprop="url" content="https://juejin.cn/user/149189314230039"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            大数据-147 Java 访问 Apache Kudu：从建表到 CRUD（含 KuduSession 刷新模式与多 Master 配置）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/149189314230039/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    武子康
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-09T08:43:25.000Z" title="Sun Nov 09 2025 08:43:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">TL;DR</h2>
<ul>
<li>场景：用 Java（kudu-client 1.4.0）在本地多 Master 集群上完成 Kudu 表的建表、增删改查全流程。</li>
<li>结论：示例能跑通，但存在 flush 顺序、表名不一致、地址尾逗号等易踩坑点；生产与示例配置差异大。</li>
<li>产出：可直接复用的代码骨架 + 常见错误定位与修复清单 + 版本/模式选择指引。</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/34d3f55b96444501a2984c4b666bc59e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763282605&amp;x-signature=q2X%2B2V%2FZA4%2F1FSBgfO5JHimnPHE%3D" alt="Java 访问 Apache Kudu：从建表到 CRUD（含 KuduSession 刷新模式与多 Master 配置）" loading="lazy"/></p>
<h2 data-id="heading-1">版本矩阵</h2>








































<table><thead><tr><th>组合</th><th>已验证</th><th>说明</th></tr></thead><tbody><tr><td>JDK 8/11 + kudu-client 1.4.0 + 本地多Master(7051/7151/7251) + Hash分区=3 + 副本=1</td><td>是</td><td>文中示例跑通：建表/增删改查均可；仅适用于本地/学习环境</td></tr><tr><td>kudu-client 1.4.0 + AUTO_FLUSH_SYNC</td><td>是</td><td>适合逐条写入，apply同步返回；批量场景效率一般</td></tr><tr><td>kudu-client 1.4.0 + MANUAL_FLUSH</td><td>是</td><td>需先apply后flush并检查getPendingErrors()；适合批量</td></tr><tr><td>kudu-client 1.4.0 + AUTO_FLUSH_BACKGROUND</td><td>否</td><td>文中未验证；并发写可能乱序，需评估一致性与背压</td></tr><tr><td>本地单Master</td><td>否</td><td>文中未验证；不建议生产使用，容错性差</td></tr><tr><td>生产：副本≥3、与服务端版本对齐（≥1.10/1.15/1.16）</td><td>否</td><td>文中未验证；建议按照集群实际版本对齐客户端以避免协议/特性差异</td></tr></tbody></table>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/135f79dcb97b4a11a9546289f78274ef~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763282605&amp;x-signature=hgmx%2BJXnrGkIIiy6c%2BpadbeUm8s%3D" alt="Apache Kudu" loading="lazy"/></p>
<h2 data-id="heading-2">新建工程</h2>
<p>由于重复了太多次，这里直接跳过了。</p>
<h2 data-id="heading-3">导入依赖</h2>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.kudu<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>kudu-client<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.4.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<h2 data-id="heading-4">创建新表</h2>
<ul>
<li>必须指定表连接到的Master节点主机名</li>
<li>必须定义Schema</li>
<li>必须指定副本数量、分区策略、数量</li>
</ul>
<h2 data-id="heading-5">编写代码</h2>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> icu.wzk.kudu;
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">KuduCreateTable</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> KuduException {
        <span class="hljs-type">String</span> <span class="hljs-variable">masterAddress</span> <span class="hljs-operator">=</span> <span class="hljs-string">"localhost:7051,localhost:7151,localhost:7251"</span>;
        KuduClient.<span class="hljs-type">KuduClientBuilder</span> <span class="hljs-variable">kuduClientBuilder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">KuduClient</span>.KuduClientBuilder(masterAddress);
        <span class="hljs-type">KuduClient</span> <span class="hljs-variable">kuduClient</span> <span class="hljs-operator">=</span> kuduClientBuilder.build();

        <span class="hljs-type">String</span> <span class="hljs-variable">tableName</span> <span class="hljs-operator">=</span> <span class="hljs-string">"student"</span>;
        List&lt;ColumnSchema&gt; columnSchemas = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
        <span class="hljs-type">ColumnSchema</span> <span class="hljs-variable">id</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ColumnSchema</span>
                .ColumnSchemaBuilder(<span class="hljs-string">"id"</span>, Type.INT32)
                .key(<span class="hljs-literal">true</span>)
                .build();
        columnSchemas.add(id);
        <span class="hljs-type">ColumnSchema</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ColumnSchema</span>
                .ColumnSchemaBuilder(<span class="hljs-string">"name"</span>, Type.STRING)
                .key(<span class="hljs-literal">false</span>)
                .build();
        columnSchemas.add(name);

        <span class="hljs-type">Schema</span> <span class="hljs-variable">schema</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Schema</span>(columnSchemas);
        <span class="hljs-type">CreateTableOptions</span> <span class="hljs-variable">options</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CreateTableOptions</span>();
        <span class="hljs-comment">// 副本数量为1</span>
        options.setNumReplicas(<span class="hljs-number">1</span>);
        List&lt;String&gt; colrule = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
        colrule.add(<span class="hljs-string">"id"</span>);
        options.addHashPartitions(colrule, <span class="hljs-number">3</span>);

        kuduClient.createTable(tableName, schema, options);
        kuduClient.close();
    }

}

</code></pre>
<h2 data-id="heading-6">测试运行</h2>
<pre><code class="hljs language-shell" lang="shell">控制台未输出内容
</code></pre>
<p>运行结果如下图所示：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/81ff397a00d848658e784e21f8578e15~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763282605&amp;x-signature=6xBF4xxEV2TiApQmn%2B9B4TpEv7w%3D" alt="测试Java访问Kudu" loading="lazy"/></p>
<h2 data-id="heading-7">查看Kudu</h2>
<p>我们查看Kudu的Tables，可以看到刚才创建的表如下：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/49ca565910f24237b374ab09dd4b4c1d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763282605&amp;x-signature=YckHGDo5X7yP7%2FgJnvotiOB5nOU%3D" alt="Kudu后台管理" loading="lazy"/></p>
<h2 data-id="heading-8">删除表</h2>
<h3 data-id="heading-9">编写代码</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> icu.wzk.kudu;
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">KuduDeleteTable</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> KuduException {
        <span class="hljs-type">String</span> <span class="hljs-variable">masterAddress</span> <span class="hljs-operator">=</span> <span class="hljs-string">"localhost:7051,localhost:7151,localhost:7251,"</span>;
        <span class="hljs-type">KuduClient</span> <span class="hljs-variable">client</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">KuduClient</span>.KuduClientBuilder(masterAddress)
                .defaultAdminOperationTimeoutMs(<span class="hljs-number">5000</span>)
                .build();
        client.deleteTable(<span class="hljs-string">"student"</span>);
        client.close();
    }

}

</code></pre>
<h2 data-id="heading-10">测试运行</h2>
<p>控制台没有输出内容，这里运行截图如下：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/59fb8cab37174c1c8b2a965db5459127~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763282605&amp;x-signature=w2rdQxhIHK7iGYWnbVeR9mtVdOg%3D" alt="Java 访问 Kudu" loading="lazy"/></p>
<h2 data-id="heading-11">查看Kudu</h2>
<p>查看Kudu服务的 Table 页，里边的数据表已经删除了。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/05180471dcc54c0f8d7a4f9713b37040~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763282605&amp;x-signature=q8pBh2oyekxbhTtX1sT0Cyx4LbI%3D" alt="Kudu后台服务" loading="lazy"/></p>
<h2 data-id="heading-12">插入数据</h2>
<ul>
<li>获取客户端</li>
<li>打开一张表</li>
<li>创建会话</li>
<li>设置刷新模式</li>
<li>获取插入实例</li>
<li>声明带插入的数据</li>
<li>刷入数据</li>
<li>应用插入实例</li>
<li>关闭会话</li>
</ul>
<h2 data-id="heading-13">创建新表</h2>
<p>我们运行刚才的创建新表代码，把student表先生成出来，具体运行这里跳过了。</p>
<h2 data-id="heading-14">编写代码</h2>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> icu.wzk.kudu;
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">KuduInsert</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> KuduException {
        <span class="hljs-type">String</span> <span class="hljs-variable">masterAddr</span> <span class="hljs-operator">=</span> <span class="hljs-string">"localhost:7051,localhost:7151,localhost:7251"</span>;
        <span class="hljs-type">KuduClient</span> <span class="hljs-variable">client</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">KuduClient</span>
                .KuduClientBuilder(masterAddr)
                .defaultAdminOperationTimeoutMs(<span class="hljs-number">5000</span>)
                .build();
        <span class="hljs-type">KuduTable</span> <span class="hljs-variable">stuTable</span> <span class="hljs-operator">=</span> client.openTable(<span class="hljs-string">"student"</span>);
        <span class="hljs-type">KuduSession</span> <span class="hljs-variable">kuduSession</span> <span class="hljs-operator">=</span> client.newSession();
        kuduSession.setFlushMode(SessionConfiguration.FlushMode.MANUAL_FLUSH);
        <span class="hljs-type">Insert</span> <span class="hljs-variable">insert</span> <span class="hljs-operator">=</span> stuTable.newInsert();
        insert.getRow().addInt(<span class="hljs-string">"id"</span>, <span class="hljs-number">1</span>);
        insert.getRow().addString(<span class="hljs-string">"name"</span>, <span class="hljs-string">"wzk"</span>);
        kuduSession.flush();
        kuduSession.apply(insert);
        kuduSession.close();
        client.close();
    }

}

</code></pre>
<p>在代码中，有一个叫：kuduSession.setFlushMode：</p>
<ul>
<li>AUTO_FLUSH_SYNC（默认）：意思是调用KuduSession apply方法后，客户端会在当前刷新到服务器后再返回，这种情况不能够批量插入数据，调用 flush 方法不会起作用，应为此时缓冲区已经被刷新到了服务器。</li>
<li>AUTO_FLUSH_BACKGROUD：意思是调用apply方法后，客户端会立即返回，但是写入将在后台发送，可能与来自同一会话的其他写入一起进行批处理。如果没有足够的缓冲空间，KuduSession apply会阻塞，缓冲空间不可用。因为写入操作是在后台进行的，因此任何一个错误都将存储在一个会话本地缓冲区中。注意：这个模式可能会导致插入是乱序的，这是因为在这种模式下，多个写操作可以并发的发送到服务器。且这是一个Kudu的BUG，详细请看：<a href="https://link.juejin.cn?target=https%3A%2F%2Fissues.apache.org%2Fjira%2Fbrowse%2FKUDU-1767https%3A%2F%2Fissues.apache.org%2Fjira%2Fbrowse%2FKUDU-1767" target="_blank" title="https://issues.apache.org/jira/browse/KUDU-1767https://issues.apache.org/jira/browse/KUDU-1767" ref="nofollow noopener noreferrer">issues.apache.org/jira/browse…</a></li>
<li>MANUAL_FLUSH：调用apply后，会非常快的返回，但是写操作不会发送，直到用户使用flush函数，如果缓冲区超过了限制大小，apply就会返回一个错误。</li>
</ul>
<h2 data-id="heading-15">测试运行</h2>
<p>控制台无输出内容，运行的截图如下图所示：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c51a97d9806d415198450f9ecc48d81e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763282605&amp;x-signature=rAaDJ%2Bf3oZDoscWzJXIyAdfo8QE%3D" alt="Java 访问 Kudu" loading="lazy"/></p>
<h2 data-id="heading-16">查询数据</h2>
<h3 data-id="heading-17">编写代码</h3>
<p>Kudu的查询数据用Scanner</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> icu.wzk.kudu;
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">KuduSelect</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> KuduException {
        <span class="hljs-type">String</span> <span class="hljs-variable">masterAddr</span> <span class="hljs-operator">=</span> <span class="hljs-string">"localhost:7051,localhost:7151,localhost:7251"</span>;
        <span class="hljs-type">KuduClient</span> <span class="hljs-variable">client</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">KuduClient</span>
                .KuduClientBuilder(masterAddr)
                .build();
        <span class="hljs-type">KuduTable</span> <span class="hljs-variable">kuduTable</span> <span class="hljs-operator">=</span> client.openTable(<span class="hljs-string">"user"</span>);
        <span class="hljs-type">KuduScanner</span> <span class="hljs-variable">kuduScanner</span> <span class="hljs-operator">=</span> client.newScannerBuilder(kuduTable).build();
        <span class="hljs-keyword">while</span> (kuduScanner.hasMoreRows()) {
            <span class="hljs-keyword">for</span> (RowResult result : kuduScanner.nextRows()) {
                <span class="hljs-type">int</span> <span class="hljs-variable">id</span> <span class="hljs-operator">=</span> result.getInt(<span class="hljs-string">"id"</span>);
                <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> result.getString(<span class="hljs-string">"name"</span>);
                <span class="hljs-type">int</span> <span class="hljs-variable">age</span> <span class="hljs-operator">=</span> result.getInt(<span class="hljs-string">"age"</span>);
                System.out.println(<span class="hljs-string">"id: "</span> + id + <span class="hljs-string">", name: "</span> + name + <span class="hljs-string">", age: "</span> + age);
            }
        }
        client.close();
    }

}

</code></pre>
<h3 data-id="heading-18">测试运行</h3>
<p>运行结果如下图所示：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8b40171063364c0aa8f0dd8ff1424bed~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763282605&amp;x-signature=I3CkOgKhu4BtHmSoWX61nj4dZlg%3D" alt="Java 访问 Kudu" loading="lazy"/></p>
<h2 data-id="heading-19">更改数据</h2>
<h3 data-id="heading-20">编写代码</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> icu.wzk.kudu;
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">KuduUpdate</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> KuduException {
        <span class="hljs-type">String</span> <span class="hljs-variable">masterAddress</span> <span class="hljs-operator">=</span> <span class="hljs-string">"localhost:7051,localhost:7151,localhost:7251"</span>;
        <span class="hljs-type">KuduClient</span> <span class="hljs-variable">client</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">KuduClient</span>
                .KuduClientBuilder(masterAddress)
                .build();
        <span class="hljs-type">KuduTable</span> <span class="hljs-variable">stuTable</span> <span class="hljs-operator">=</span> client.openTable(<span class="hljs-string">"student"</span>);
        <span class="hljs-type">KuduSession</span> <span class="hljs-variable">kuduSession</span> <span class="hljs-operator">=</span> client.newSession();
        kuduSession.setFlushMode(SessionConfiguration.FlushMode.MANUAL_FLUSH);
        <span class="hljs-type">Update</span> <span class="hljs-variable">update</span> <span class="hljs-operator">=</span> stuTable.newUpdate();
        update.getRow().addInt(<span class="hljs-string">"id"</span>, <span class="hljs-number">1</span>);
        update.getRow().addString(<span class="hljs-string">"name"</span>, <span class="hljs-string">"wzk_icu"</span>);
        kuduSession.apply(update);
        kuduSession.close();
        client.close();
    }

}

</code></pre>
<h2 data-id="heading-21">删除指定行</h2>
<h3 data-id="heading-22">编写代码</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> icu.wzk.kudu;
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">KuduDelete</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> KuduException {
        <span class="hljs-type">String</span> <span class="hljs-variable">masterAddress</span> <span class="hljs-operator">=</span> <span class="hljs-string">"localhost:7051,localhost:7151,localhost:7251"</span>;
        <span class="hljs-type">KuduClient</span> <span class="hljs-variable">client</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">KuduClient</span>
                .KuduClientBuilder(masterAddress)
                .build();
        <span class="hljs-type">KuduSession</span> <span class="hljs-variable">kuduSession</span> <span class="hljs-operator">=</span> client.newSession();
        <span class="hljs-type">KuduTable</span> <span class="hljs-variable">stuTable</span> <span class="hljs-operator">=</span> client.openTable(<span class="hljs-string">"student"</span>);
        kuduSession.setFlushMode(SessionConfiguration.FlushMode.MANUAL_FLUSH);
        <span class="hljs-type">Delete</span> <span class="hljs-variable">delete</span> <span class="hljs-operator">=</span> stuTable.newDelete();
        <span class="hljs-type">PartialRow</span> <span class="hljs-variable">row</span> <span class="hljs-operator">=</span> delete.getRow();
        row.addInt(<span class="hljs-string">"id"</span>, <span class="hljs-number">1</span>);
        kuduSession.flush();
        kuduSession.apply(delete);
        kuduSession.close();
        client.close();
    }

}

</code></pre>
<h3 data-id="heading-23">测试运行</h3>
<p>控制台没有输出任何内容，运行过程截图如下：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3931bc169afe4a86bb7ca292a91bc982~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763282605&amp;x-signature=l%2BjvF0OlzeHWiY9SwR%2B5WS8ZgE4%3D" alt="Java 访问 Kudu" loading="lazy"/></p>
<h2 data-id="heading-24">错误速查</h2>




























































<table><thead><tr><th>症状</th><th>根因定位</th><th>修复</th></tr></thead><tbody><tr><td>控制台无报错但表中无数据</td><td>MANUAL_FLUSH 先 flush 再 apply，顺序反了</td><td>开启 RPC/客户端日志；查 session.getPendingErrors()<br/>改为 先 apply 后 flush；批量写统一 flush，并检查错误</td></tr><tr><td>UnknownHostException/连接异常</td><td>Master 地址末尾多了逗号（如 ...,）</td><td>观察异常栈与传入的地址列表<br/>移除尾逗号，确保主机:端口列表正确</td></tr><tr><td>Not found: table user</td><td>查询表名与创建不一致（创建 student，查询 user）</td><td>服务端/客户端日志，异常信息清晰可见<br/>统一表名：改为同一张表或先创建目标表</td></tr><tr><td>读取列时报错（如 age）</td><td>Schema 不含该列</td><td>查看建表 Schema 与 RowResult.get*() 列名<br/>补齐 Schema 后重建表，或移除无效列</td></tr><tr><td>读取更新/删除无效</td><td>MANUAL_FLUSH 模式下未 flush 即 close</td><td>观察无效变更与会话关闭顺序<br/>apply 后显式 flush；或使用 AUTO_FLUSH_SYNC 简化写入</td></tr><tr><td>乱序/批次不可预期</td><td>AUTO_FLUSH_BACKGROUND 并发发送</td><td>日志对比主键顺序与服务端接收顺序<br/>对顺序敏感改用同步/手动批处理；必要时在上层做幂等</td></tr><tr><td>无法连接 Leader Master</td><td>Master 未启动/端口错误/选主未完成</td><td>Master Web UI 与日志（master.I）<br/>启动所有 Master，校验端口，等待选主完成</td></tr><tr><td>协议/特性不兼容</td><td>客户端 1.4.0 与服务端版本差距大</td><td>日志出现协议/特性相关错误<br/>对齐客户端与服务端版本；评估升级至集群当前版本</td></tr><tr><td>插入/更新看似成功但丢写</td><td>未检错或异步错误积压</td><td>session.getPendingErrors() 有堆积<br/>每次 flush 后检查并处理返回错误</td></tr><tr><td>扫描资源未释放</td><td>未关闭 KuduScanner/客户端</td><td>监控连接与句柄<br/>用 try-with-resources 或确保显式 close()</td></tr></tbody></table>
<h2 data-id="heading-25">其他系列</h2>
<h3 data-id="heading-26">🚀 AI篇持续更新中（长期更新）</h3>
<p><strong>AI炼丹日志-29 - 字节跳动 DeerFlow 深度研究框<em>斜体样式</em>架 私有部署 测试上手 架构研究</strong>，持续打造实用AI工具指南！
<strong>AI-调查研究-108-具身智能 机器人模型训练全流程详解：从预训练到强化学习与人类反馈</strong></p>
<h3 data-id="heading-27">💻 Java篇持续更新中（长期更新）</h3>
<p><strong>Java-154 深入浅出 MongoDB 用Java访问 MongoDB 数据库 从环境搭建到CRUD完整示例</strong>
MyBatis 已完结，Spring 已完结，Nginx已完结，Tomcat已完结，分布式服务正在更新！深入浅出助你打牢基础！</p>
<h3 data-id="heading-28">📊 大数据板块已完成多项干货更新（300篇）：</h3>
<p>包括 Hadoop、Hive、Kafka、Flink、ClickHouse、Elasticsearch 等二十余项核心组件，覆盖离线+实时数仓全栈！
<strong>大数据-278 Spark MLib - 基础介绍 机器学习算法 梯度提升树 GBDT案例 详解</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一文吃透：宏任务、微任务、事件循环、浏览器渲染、Vue 批处理与 Node 差异（含性能优化）]]></title>    <link>https://juejin.cn/post/7570239631847030818</link>    <guid>https://juejin.cn/post/7570239631847030818</guid>    <pubDate>2025-11-09T08:56:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7570239631847030818" data-draft-id="7510275399777157132" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一文吃透：宏任务、微任务、事件循环、浏览器渲染、Vue 批处理与 Node 差异（含性能优化）"/> <meta itemprop="keywords" content="前端,面试,架构"/> <meta itemprop="datePublished" content="2025-11-09T08:56:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="蚂小蚁"/> <meta itemprop="url" content="https://juejin.cn/user/1063982987485245"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一文吃透：宏任务、微任务、事件循环、浏览器渲染、Vue 批处理与 Node 差异（含性能优化）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1063982987485245/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    蚂小蚁
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-09T08:56:45.000Z" title="Sun Nov 09 2025 08:56:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.6em;font-weight:400;font-size:15px;overflow-x:hidden;color:#303133;font-family:Helvetica Neue,Helvetica,PingFang SC,Hiragino Sans GB,Microsoft YaHei,微软雅黑,Arial,sans-serif}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.6em;margin:1.3em 0}.markdown-body h1{font-size:30px;margin-top:50px;margin-bottom:10px}.markdown-body h2{margin-top:45px;margin-bottom:10px;font-size:26px}.markdown-body h3{margin-top:40px;margin-bottom:10px;font-size:22px}.markdown-body h4{font-size:18px}.markdown-body h5{font-size:16px}.markdown-body h6{font-size:15px;margin-top:5px}.markdown-body p{line-height:inherit;margin-top:1.6em;margin-bottom:1.6em}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{font-family:Menlo,Monaco,Consolas,Courier New,monospace;word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#e96900;font-size:.87em;margin:0 2px;padding:3px 5px;white-space:pre-wrap}.markdown-body .markdown-section&gt;:not(h1):not(h2):not(h3):not(h4):not(h5):not(h6) code{font-size:.8rem;font-family:Roboto Mono,Monaco,courier,monospace}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;border-radius:4px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#42b983;line-height:1.2em}.markdown-body a:active,.markdown-body a:hover{color:rgba(66,185,131,.85);border-bottom:1px solid rgba(66,185,131,.6)}.markdown-body table{display:inline-block!important;font-size:12px;max-width:100%;overflow:auto;border:1px solid #f6f6f6;border-collapse:collapse}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fafafa}.markdown-body td,.markdown-body th{padding:12px 6px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:rgba(52,73,94,.95);padding:1px 23px;margin:22px 0;border-left:4px solid #42b983;background-color:rgba(66,185,131,.1)}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><p>本文从一道面试题切入，系统梳理浏览器与 Node 的事件循环模型；解释宏任务与微任务的区别、执行顺序与常见坑；结合浏览器渲染时机；深入 Vue 3 批处理源码如何巧用微任务实现“同一轮内的合并更新”；最后从任务调度角度讨论性能优化策略。完整成文，便于一次性阅读与复盘。</p>
<h2 data-id="heading-0">1. 从一道面试题入手：宏任务微任务混杂的打印顺序（浏览器）</h2>
<p>示例代码（Chrome 环境；setImmediate 在浏览器一般不可用，若实现则顺序不稳定，不建议依赖）：</p>
<pre><code class="hljs language-js" lang="js">jsconsole.<span class="hljs-title function_">log</span>(<span class="hljs-number">1</span>);

setImmediate?.(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">2</span>);
});

<span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">3</span>);
  <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">10</span>);
    <span class="hljs-title function_">resolve</span>();
  }).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">11</span>);
  });
}, <span class="hljs-number">0</span>);

requestAnimationFrame?.(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">4</span>);
});

<span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">5</span>);
});

<span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =&gt;</span> {
  <span class="hljs-title function_">resolve</span>(<span class="hljs-number">6</span>);
}).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">7</span>);
});

(<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">8</span>);
  <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>();
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">9</span>);
})();

requestIdleCallback?.(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">12</span>);
}); 
</code></pre>
<p>常见输出（Chrome）：</p>
<p>1, 8, 5, 7, 9, 4, 3, 10, 11, 12</p>
<p>顺序解析：</p>
<p>同步：1、8</p>
<p>微任务（在当前宏任务末尾清空）：5、7、9</p>
<p>帧回调：requestAnimationFrame 在下一帧绘制前：4</p>
<p>计时器宏任务：setTimeout(0) 回调：3，回调内同步：10，回调末尾微任务：11</p>
<p>空闲回调：requestIdleCallback 优先级最低：12</p>
<h2 data-id="heading-1">2. 事件循环与宏/微任务：区别、原理，微任务会卡死吗？</h2>
<p>同步任务：立即执行、阻塞线程。例：普通代码、同步 I/O、大量计算、浏览器强制布局。</p>
<p>宏任务（task）：进入事件循环的任务队列，逐个取出执行。例：setTimeout/setInterval、用户事件、I/O 回调等。</p>
<p>微任务（microtask）：优先级更高，在“当前宏任务结束后、下一个宏任务开始前”被“清空”。</p>
<p>浏览器：Promise.then/catch/finally、queueMicrotask、MutationObserver</p>
<p>Node：Promise 微任务 + process.nextTick（优先级高于 Promise 微任务）</p>
<p>事件循环关键节拍：</p>
<ol>
<li>
<p>执行一个宏任务</p>
</li>
<li>
<p>清空当前产生的所有微任务（可能再产生微任务，继续清空直到无）</p>
</li>
<li>
<p>浏览器可能进入渲染阶段</p>
</li>
<li>
<p>进入下一轮宏任务</p>
</li>
</ol>
<p>微任务会卡死吗？会。若在微任务里不断排入新的微任务（微任务“自旋”），规范会“清空”队列，导致渲染和后续宏任务都被饿死。Node 中滥用 process.nextTick 风险更高。</p>
<h2 data-id="heading-2">3. 浏览器渲染机制与宏任务、微任务</h2>
<p>一帧（简化）：</p>
<ol>
<li>
<p>执行一个宏任务（如点击事件或计时器）</p>
</li>
<li>
<p>清空微任务</p>
</li>
<li>
<p>渲染步骤（样式计算 → 布局 → 绘制）</p>
</li>
<li>
<p>下一帧前执行 requestAnimationFrame</p>
</li>
<li>
<p>空闲阶段可能执行 requestIdleCallback（可带 deadline）</p>
</li>
</ol>
<p>要点：</p>
<p>微任务在渲染前清空，因此框架能在“同一轮交互”内合并多次状态到一次 DOM 提交。</p>
<p>requestAnimationFrame 用于动画，回调在下一帧绘制前；回调内产生的微任务会在该帧绘制前被清空。</p>
<p>requestIdleCallback 优先级最低，适合非关键、可延迟任务，最好带超时兜底。</p>
<p>实务建议：</p>
<p>动画逻辑 → requestAnimationFrame</p>
<p>次要任务 → requestIdleCallback</p>
<p>微任务只做“收尾”，避免自旋导致渲染饥饿</p>
<h2 data-id="heading-3">4. Node.js 的事件循环与浏览器区别</h2>
<p>Node（libuv）阶段（简化）：</p>
<ol>
<li>
<p>timers：到期的 setTimeout/setInterval</p>
</li>
<li>
<p>pending callbacks：系统级 I/O 回调</p>
</li>
<li>
<p>idle/prepare：内部使用</p>
</li>
<li>
<p>poll：拉取 I/O 事件，大多数 I/O 回调在此执行；队列空且有 timer 到期会回到 timers；否则可能阻塞等待 I/O</p>
</li>
<li>
<p>check：执行 setImmediate</p>
</li>
<li>
<p>close callbacks： 事件等</p>
</li>
<li>
<p>close</p>
</li>
</ol>
<p>微任务：</p>
<p>process.nextTick：每个阶段切换前先清空，优先于 Promise 微任务</p>
<p>Promise 微任务：与浏览器类似，宏任务后清空</p>
<p>典型对比：</p>
<p>setTimeout(0) vs setImmediate：顶层脚本中通常 setTimeout(0) 先；在 I/O 回调中注册时往往 setImmediate 先。</p>
<p>Node 无 requestAnimationFrame/requestIdleCallback（那是浏览器渲染相关 API）。</p>
<p>把第 1 节示例裁剪为 Node（去掉 rAF/rIC）常见顺序：</p>
<p>1, 8, 5, 7, 9, 3, 10, 11, 2</p>
<h2 data-id="heading-4">5.从 Vue 批处理源码看宏/微任务</h2>
<p>Vue 3 的“批处理（batching）”是把宏/微任务优势工程化的典型：</p>
<p>副作用函数（ReactiveEffect）包裹渲染与 watch，当依赖变更时不立即执行，而是交给 scheduler(job) 排队。</p>
<p>使用微任务 Promise.resolve().then(flushJobs) 统一触发 flush，把同一 tick 内多次状态变更合并为一次渲染与一次 DOM 提交。</p>
<p>多级队列与顺序：</p>
<p>pre 队列：flush: 'pre' 的 watch</p>
<p>主更新队列：组件更新 job（按 id 排序，保证父先子、稳定）</p>
<p>post 队列：flush: 'post'、onUpdated、指令后置等</p>
<p>Set 去重、执行计数与递归保护，防重复与无限循环。</p>
<p>简化伪码（核心思路）：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> <span class="hljs-attr">queue</span>: <span class="hljs-title class_">Job</span>[] = []
<span class="hljs-keyword">const</span> queued = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>&lt;<span class="hljs-title class_">Job</span>&gt;()
<span class="hljs-keyword">let</span> isFlushing = <span class="hljs-literal">false</span>, isFlushPending = <span class="hljs-literal">false</span>

<span class="hljs-keyword">function</span> <span class="hljs-title function_">queueJob</span>(<span class="hljs-params">job</span>) {
  <span class="hljs-keyword">if</span> (!queued.<span class="hljs-title function_">has</span>(job)) {
    queued.<span class="hljs-title function_">add</span>(job)
    queue.<span class="hljs-title function_">push</span>(job)
    <span class="hljs-keyword">if</span> (!isFlushing &amp;&amp; !isFlushPending) {
      isFlushPending = <span class="hljs-literal">true</span>
      <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>().<span class="hljs-title function_">then</span>(flushJobs) <span class="hljs-comment">// 微任务触发批处理</span>
    }
  }
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">flushJobs</span>(<span class="hljs-params"/>) {
  isFlushPending = <span class="hljs-literal">false</span>
  isFlushing = <span class="hljs-literal">true</span>
  <span class="hljs-title function_">flushPreFlushCbs</span>()
  queue.<span class="hljs-title function_">sort</span>(jobComparatorById)
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> job <span class="hljs-keyword">of</span> queue) <span class="hljs-title function_">job</span>()
  queue.<span class="hljs-property">length</span> = <span class="hljs-number">0</span>
  queued.<span class="hljs-title function_">clear</span>()
  <span class="hljs-title function_">flushPostFlushCbs</span>()
  isFlushing = <span class="hljs-literal">false</span>
} 
</code></pre>
<p>与渲染契合：</p>
<p>微任务清空发生在渲染之前，故框架可合并更新；nextTick() 等待这次 flush（含 post）完成，保证能读取到更新后的 DOM。</p>
<p>在 Node（SSR）：</p>
<p>无浏览器渲染阶段，但同样利用微任务合并计算，避免重复渲染逻辑。</p>
<p>若业务滥用 process.nextTick 可能扰动 flush 节奏，需理解阶段优先级。</p>
<h2 data-id="heading-5">6. 从宏任务、微任务来看性能优化（浏览器与 Node）</h2>
<p>切片长任务，避免长帧（&gt;16.67ms）</p>
<p>使用 setTimeout/MessageChannel/requestIdleCallback 将大计算拆成小片</p>
<p>示例（MessageChannel 分片）：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> chan = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MessageChannel</span>();
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">BATCH</span> = <span class="hljs-number">1000</span>;
<span class="hljs-keyword">function</span> <span class="hljs-title function_">work</span>(<span class="hljs-params">arr, i = <span class="hljs-number">0</span></span>) {
  <span class="hljs-keyword">const</span> end = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(i + <span class="hljs-variable constant_">BATCH</span>, arr.<span class="hljs-property">length</span>);
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> j = i; j &lt; end; j++) { <span class="hljs-comment">/* 计算 */</span> }
  <span class="hljs-keyword">if</span> (end &lt; arr.<span class="hljs-property">length</span>) {
    chan.<span class="hljs-property">port1</span>.<span class="hljs-title function_">postMessage</span>(<span class="hljs-literal">null</span>);
    chan.<span class="hljs-property">port2</span>.<span class="hljs-property">onmessage</span> = <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">work</span>(arr, end);
  }
}
<span class="hljs-title function_">work</span>(bigArray); 
</code></pre>
<h3 data-id="heading-6">动画与交互在正确时机</h3>
<p>动画/视觉更新 → requestAnimationFrame</p>
<p>非关键、可延迟 → requestIdleCallback（带超时）</p>
<p>避免强制重排：读写分离，读在一起，写放 rAF</p>
<p>微任务只做“收尾”，避免自旋</p>
<p>.then/queueMicrotask 用来合并与尾部处理，不要无限链式创建</p>
<p>框架已做批处理，业务少叠加微任务循环</p>
<p>Node：避免主线程被 CPU 任务绑死</p>
<p>用 worker_threads/子进程并行重计算；I/O 使用异步 API</p>
<p>合理选择 setImmediate（check 阶段尾部任务），谨慎 process.nextTick</p>
<h3 data-id="heading-7">限流与背压</h3>
<p>浏览器：节流/防抖高频事件，虚拟列表/切片渲染</p>
<p>Node：流式处理（背压）、并发控制（p-limit/Bottleneck）</p>
<h3 data-id="heading-8">监控与诊断</h3>
<p>浏览器：Performance 面板（Long Task、帧时间）、Lighthouse（TTI/TBT/LCP/CLS）</p>
<p>Node：perf_hooks.monitorEventLoopDelay()、APM、CPU/GC/堆快照</p>
<h3 data-id="heading-9">Vue 最佳实践</h3>
<p>顺应批处理：同一 tick 内多次 state 修改会合并；读 DOM 用 nextTick</p>
<p>watch 的 flush 选择恰当；避免在 effect 中无界 setState 循环</p>
<p>任务安排“策略表”：</p>
<p>关键视觉更新 → rAF</p>
<p>非关键低优先 → rIC（带 timeout）</p>
<p>批处理收束 → 微任务（适度）</p>
<p>重计算 → 切片/并行</p>
<p>I/O 密集 → 异步 + 背压</p>
<h3 data-id="heading-10">常见任务类型速查</h3>
<p>同步（阻塞）：普通 JS、复杂计算、大对象 JSON 处理、浏览器强制布局、Node 同步 I/O/加解密压缩</p>
<p>微任务：Promise.then/catch/finally、queueMicrotask、MutationObserver、Node process.nextTick</p>
<p>宏任务：setTimeout/setInterval、消息通道、浏览器事件回调、XHR/fetch 回调入队、requestAnimationFrame（渲染前）、requestIdleCallback（空闲）、Node I/O 回调（poll）、setImmediate（check）</p>
<h2 data-id="heading-11">总结</h2>
<p>事件循环主线：一个宏任务 → 清空微任务 →（浏览器）渲染 → 下一轮宏任务。</p>
<p>浏览器侧：微任务在渲染前清空；requestAnimationFrame 在下一帧绘制前；requestIdleCallback 在空闲时。</p>
<p>Node 侧：libuv 分阶段；setTimeout 在 timers，setImmediate 在 check；process.nextTick 优先级最高。</p>
<p>Vue 3 批处理：用微任务统一 flush，多级队列（pre/更新/post）+ 去重排序，合并多次状态为一次 DOM 提交；nextTick 保证读到已更新 DOM。</p>
<p>性能优化要点：根据任务类型和渲染时机安排工作，切片/并行重任务，避免微任务饿死事件循环，利用框架批处理节奏。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[栈与堆的精妙舞剧：JavaScript 数据类型深度解析]]></title>    <link>https://juejin.cn/post/7569909335909810185</link>    <guid>https://juejin.cn/post/7569909335909810185</guid>    <pubDate>2025-11-09T06:33:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7569909335909810185" data-draft-id="7569945160869134382" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="栈与堆的精妙舞剧：JavaScript 数据类型深度解析"/> <meta itemprop="keywords" content="JavaScript,前端"/> <meta itemprop="datePublished" content="2025-11-09T06:33:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="风止何安啊"/> <meta itemprop="url" content="https://juejin.cn/user/2517239724512420"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            栈与堆的精妙舞剧：JavaScript 数据类型深度解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2517239724512420/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    风止何安啊
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-09T06:33:45.000Z" title="Sun Nov 09 2025 06:33:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>在 JavaScript 的世界里，数据类型并非简单的分类，而是一场由<strong>调用栈</strong>与<strong>堆内存</strong>共同演绎的精妙舞剧。每一种数据类型都有其专属的 “舞台位置”，而 v8 引擎则是这场舞剧的幕后导演。让我们以色彩为笔，代码为证，拆解这场舞剧的每一个角色与舞台设计。</p>
<h3 data-id="heading-1">一、原始类型(简单类型)：调用栈上的 “轻骑兵”</h3>
<p>原始类型是 JavaScript 里的 “轻量级选手”，它们的<strong>值直接存储在调用栈</strong>中，访问速度极快。我们可以把调用栈想象成一个 “快速储物柜”，小而精的物品（原始值）就直接放在这里，无需额外寻址。</p>
<h4 data-id="heading-2">1. <code>string</code>（字符串）—— 彩色丝带般的文本载体</h4>
<p>字符串是字符的有序序列，用单引号、双引号或模板字符串包裹，像一条串联意义的彩色丝带。</p>
<p>例如：</p>
<pre><code class="hljs language-ini" lang="ini">let <span class="hljs-attr">myname</span> = <span class="hljs-string">'Henry'</span><span class="hljs-comment">;</span>
let <span class="hljs-attr">greeting</span> = <span class="hljs-string">"Hello, JavaScript!"</span><span class="hljs-comment">;</span>
// 模板字符串（支持变量嵌入与换行）
let <span class="hljs-attr">userInfo</span> = `Name: <span class="hljs-variable">${myname}</span>, Age: <span class="hljs-number">28</span>`<span class="hljs-comment">;</span>
console.log(userInfo)<span class="hljs-comment">; // 输出：Name: Henry, Age: 18</span>
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/779e87952bb24b16b7d7953176f2c296~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO5q2i5L2V5a6J5ZWK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763274825&amp;x-signature=15XZZscHdhIRkC0pU5tx%2Fr%2FNpeU%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-3">2. <code>number</code>（数字）—— 量化世界的基石</h4>
<p>包含整数、浮点数，甚至特殊值<code>NaN</code>（非数字）、<code>Infinity</code>（无穷大），是描述数量的核心类型。</p>
<p>看个例子：</p>
<pre><code class="hljs language-ini" lang="ini">let <span class="hljs-attr">age</span> = <span class="hljs-number">28</span><span class="hljs-comment">;               // 整数</span>
let <span class="hljs-attr">height</span> = <span class="hljs-number">1.75</span><span class="hljs-comment">;          // 浮点数</span>
let <span class="hljs-attr">total</span> = age + height<span class="hljs-comment">;   // 数字运算：29.75</span>
let <span class="hljs-attr">notANumber</span> = <span class="hljs-string">'abc'</span> * <span class="hljs-number">2</span><span class="hljs-comment">; // 非数字运算，结果为 NaN</span>
console.log(notANumber)<span class="hljs-comment">;    // 输出：NaN</span>
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e95e3c1b8d9341a6a331dc6449a8895f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO5q2i5L2V5a6J5ZWK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763274825&amp;x-signature=9DeyvObiKWNAl8yVb6k1h5w6ziM%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-4">3. <code>boolean</code>（布尔）—— 逻辑判断的 “红绿灯”</h4>
<p>仅有<code>true</code>（真）和<code>false</code>（假）两个值，是控制代码逻辑流向的关键，像红绿灯一样决定程序的 “通行” 与 “停止”。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">let</span> flag = <span class="hljs-literal">true</span> 
<span class="hljs-keyword">let</span> unFlag = <span class="hljs-literal">false</span>
<span class="hljs-keyword">if</span> (<span class="hljs-number">1</span>){
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'真'</span>);
} <span class="hljs-keyword">else</span>{
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'假'</span>);
}
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/14dcbc8fba8e48c88f13c31fb72d86d1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO5q2i5L2V5a6J5ZWK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763274825&amp;x-signature=%2FcheaaiCLGEnzc%2Bz7jL4F7jqlNo%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-5">4. <code>undefined</code>—— 未赋值的 “空白标签”</h4>
<p>变量声明后未赋值时的默认状态，代表 “值不存在”，是 JavaScript 自动分配的 “空白标签”。</p>
<pre><code class="hljs language-ini" lang="ini">let unassignedVar<span class="hljs-comment">;          // 仅声明未赋值 </span>
console.log(unassignedVar)<span class="hljs-comment">; // 输出：undefined </span>
let <span class="hljs-attr">num</span> = <span class="hljs-number">10</span><span class="hljs-comment">; </span>
<span class="hljs-attr">num</span> = undefined<span class="hljs-comment">;            // 手动赋值为 undefined </span>
console.log(num)<span class="hljs-comment">;           // 输出：undefined</span>
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/db277384df9e4e26994d6a888262b385~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO5q2i5L2V5a6J5ZWK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763274825&amp;x-signature=KEJnEv1HTM1ngsx%2BHqXfufDxmZE%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-6">5. <code>null</code>—— 主动声明的 “空盒子”</h4>
<p>与<code>undefined</code>不同，<code>null</code>是程序员主动赋值的 “空值”，代表 “刻意为空”，像一个被清空后特意标记的空盒子。</p>
<pre><code class="hljs language-ini" lang="ini">let <span class="hljs-attr">emptyObj</span> = null<span class="hljs-comment">; // 主动声明空对象</span>
let <span class="hljs-attr">user</span> = { name: <span class="hljs-string">'Henry'</span> }<span class="hljs-comment">;</span>
<span class="hljs-attr">user</span> = null<span class="hljs-comment">;         // 清空对象引用</span>
console.log(user)<span class="hljs-comment">;   // 输出：null</span>
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/542f1e3b89444004a2bb320f8ef1314b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO5q2i5L2V5a6J5ZWK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763274825&amp;x-signature=awSgUJxoOupqdHsTb1mL8Z8S5nY%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-7">6. <code>symbol</code>—— 独一无二的 “指纹”</h4>
<p>通过<code>Symbol()</code>创建，即使描述相同，也永远不会相等，专为对象属性的唯一性设计。</p>
<pre><code class="hljs language-ini" lang="ini">let <span class="hljs-attr">id1</span> = Symbol(<span class="hljs-string">'userID'</span>)<span class="hljs-comment">;</span>
let <span class="hljs-attr">id2</span> = Symbol(<span class="hljs-string">'userID'</span>)<span class="hljs-comment">;</span>
console.log(<span class="hljs-attr">id1</span> === id2)<span class="hljs-comment">;  // 输出：false（描述相同但本质不同）</span>
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/61857578e4d7409aad0b90f9aebf1d69~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO5q2i5L2V5a6J5ZWK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763274825&amp;x-signature=QOTh1foenPTK3RrsJlrifh8wBo0%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-8">7. <code>bigInt</code>—— 超大整数的 “专属容器”</h4>
<p>解决普通<code>number</code>无法精确表示超大整数（最大值为2的53次方，即<code>2 ** 53</code>）的问题，通过数字后加<code>n</code>或<code>BigInt()</code>创建。</p>
<pre><code class="hljs language-ini" lang="ini">let <span class="hljs-attr">bigNum1</span> = <span class="hljs-number">9007199254740993</span><span class="hljs-comment">;</span>
console.log(bigNum1)<span class="hljs-comment">;  // 输出：9007199254740992（精度丢失）</span>
let <span class="hljs-attr">bigNum2</span> = <span class="hljs-number">9007199254740993</span>n<span class="hljs-comment">;</span>
let <span class="hljs-attr">bigNum3</span> = BigInt(<span class="hljs-string">'9007199254740993'</span>)<span class="hljs-comment">;</span>
console.log(<span class="hljs-attr">bigNum2</span> === bigNum3)<span class="hljs-comment">; // 输出：true（精确匹配）</span>
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/03833587f6c74c548963bc36b4d97565~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO5q2i5L2V5a6J5ZWK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763274825&amp;x-signature=2krKvxPMyaPUuch%2BNlw4Xa9ynQg%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-9">二、引用类型：堆内存里的 “豪华庄园”</h3>
<p>引用类型是 JavaScript 里的 “重量级选手”，它们的<strong>值（复杂数据）存储在堆内存</strong>中，而调用栈里只保存一个 “指向堆的引用地址”（类似庄园的门牌号）。访问时需先通过栈中的 “门牌号” 找到堆中的实际数据。</p>
<h4 data-id="heading-10">1. 数组（<code>Array</code>）—— 线性存储的 “百宝箱”</h4>
<p>按下标顺序存储元素，可容纳任意类型数据，通过下标或数组方法操作元素，像一个有序的百宝箱。</p>
<pre><code class="hljs language-sql" lang="sql">let arr <span class="hljs-operator">=</span> [<span class="hljs-number">1</span>, <span class="hljs-string">'a'</span>, <span class="hljs-literal">true</span>, undefined, <span class="hljs-keyword">null</span>]
console.<span class="hljs-built_in">log</span>(arr[<span class="hljs-number">1</span>]);      <span class="hljs-operator">/</span><span class="hljs-operator">/</span> 下标<span class="hljs-number">1</span>对应的值是字符串<span class="hljs-string">'a'</span>，控制台输出<span class="hljs-string">'a'</span>
arr.push(<span class="hljs-number">123</span>n)            <span class="hljs-operator">/</span><span class="hljs-operator">/</span> 向数组末尾添加<span class="hljs-type">bigInt</span>类型元素<span class="hljs-number">123</span>n，添加后数组为[<span class="hljs-number">1</span>, <span class="hljs-string">'a'</span>, <span class="hljs-literal">true</span>, undefined, <span class="hljs-keyword">null</span>, <span class="hljs-number">123</span>n]
arr.pop()                 <span class="hljs-operator">/</span><span class="hljs-operator">/</span> 删除数组末尾的最后一个元素（即刚添加的<span class="hljs-number">123</span>n），数组恢复为[<span class="hljs-number">1</span>, <span class="hljs-string">'a'</span>, <span class="hljs-literal">true</span>, undefined, <span class="hljs-keyword">null</span>]
arr.unshift(Symbol(<span class="hljs-number">100</span>))  <span class="hljs-operator">/</span><span class="hljs-operator">/</span> 向数组开头添加symbol类型元素，添加后数组为[Symbol(<span class="hljs-number">100</span>), <span class="hljs-number">1</span>, <span class="hljs-string">'a'</span>, <span class="hljs-literal">true</span>, undefined, <span class="hljs-keyword">null</span>]
arr.shift()               <span class="hljs-operator">/</span><span class="hljs-operator">/</span> 删除数组开头的第一个元素（即刚添加的Symbol(<span class="hljs-number">100</span>)），数组恢复为[<span class="hljs-number">1</span>, <span class="hljs-string">'a'</span>, <span class="hljs-literal">true</span>, undefined, <span class="hljs-keyword">null</span>]
arr.splice(<span class="hljs-number">2</span>,<span class="hljs-number">1</span>)           <span class="hljs-operator">/</span><span class="hljs-operator">/</span> 从下标<span class="hljs-number">2</span>开始，删除<span class="hljs-number">1</span>个元素，执行后数组变为[<span class="hljs-number">1</span>, <span class="hljs-string">'a'</span>, undefined, <span class="hljs-keyword">null</span>]
arr.splice(<span class="hljs-number">4</span>, <span class="hljs-number">0</span>, <span class="hljs-number">123</span>n)    <span class="hljs-operator">/</span><span class="hljs-operator">/</span> 向数组末尾添加<span class="hljs-number">123</span>n，最终数组为[<span class="hljs-number">1</span>, <span class="hljs-string">'a'</span>, undefined, <span class="hljs-keyword">null</span>, <span class="hljs-number">123</span>n]
console.<span class="hljs-built_in">log</span>(arr);         <span class="hljs-operator">/</span><span class="hljs-operator">/</span> 输出[<span class="hljs-number">1</span>, <span class="hljs-string">'a'</span>, undefined, <span class="hljs-keyword">null</span>, <span class="hljs-number">123</span>n]
</code></pre>
<p>答案和我们分析的一致：
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ed9a877b768e42f3a81c8821a4735088~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO5q2i5L2V5a6J5ZWK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763274825&amp;x-signature=gdysdysS6jyaunKnkadpSQciTYg%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-11">2. 对象（<code>Object</code>）—— 键值对组成的 “精密仪器”</h4>
<p>以<code>key-value</code>（键值对）形式存储数据，<code>key</code>为字符串或<code>Symbol</code>，<code>value</code>可任意类型，支持嵌套，像一台结构精密的仪器。</p>
<p>例如：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">let</span> obj = {
    <span class="hljs-attr">name</span>: <span class="hljs-string">'Henry'</span>,
    <span class="hljs-attr">age</span>: <span class="hljs-number">19</span>,
    <span class="hljs-attr">girlFriend</span>: <span class="hljs-string">'无'</span>
}
obj.<span class="hljs-property">age</span> = <span class="hljs-number">20</span>            <span class="hljs-comment">// 将年龄改为20</span>

<span class="hljs-keyword">delete</span> obj.<span class="hljs-property">girlFriend</span>   <span class="hljs-comment">// 删除girlfriend键值对</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(obj);       
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5db3b083ed674820b820b876136e30d2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO5q2i5L2V5a6J5ZWK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763274825&amp;x-signature=60pJ0eSgHRD%2F%2F4vo7AUNWSd0C7E%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-12">3. 函数（<code>Function</code>）—— 可执行的 “魔法配方”</h4>
<p>函数是一段可重复执行的代码块，本质是 “可调用的对象”，调用时会触发预设逻辑，像一份能生成结果的魔法配方。</p>
<p>依旧上代码：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">var</span> <span class="hljs-selector-tag">a</span> = <span class="hljs-number">2</span>
<span class="hljs-selector-tag">function</span> <span class="hljs-selector-tag">add</span>() {
    <span class="hljs-selector-tag">var</span> <span class="hljs-selector-tag">b</span> = <span class="hljs-number">10</span>
    <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">a</span> + <span class="hljs-selector-tag">b</span>
}
<span class="hljs-selector-tag">console</span><span class="hljs-selector-class">.log</span>(<span class="hljs-built_in">add</span>());
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5ffdd430f475457e8d8131fe16fa53f1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO5q2i5L2V5a6J5ZWK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763274825&amp;x-signature=d%2BIG2r5frT6N4162YVwX%2BauL0iQ%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-13">三、v8 引擎的 “存储哲学”：栈与堆的分工艺术</h3>
<p>在 Chrome 的 v8 引擎眼中，内存被划分为<strong>调用栈</strong>和<strong>堆内存</strong>，二者各司其职，共同保证 JavaScript 的高效运行：</p>























<table><thead><tr><th>存储区域</th><th>存储内容</th><th>特点</th><th>对应数据类型</th></tr></thead><tbody><tr><td>调用栈</td><td>原始类型的值、引用地址</td><td>空间小、访问速度极快</td><td>7 种原始类型</td></tr><tr><td>堆内存</td><td>引用类型的实际数据</td><td>空间大、可存储复杂结构</td><td>数组、对象、函数等</td></tr></tbody></table>
<p>用函数的例子来解析：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f37bf9503f7c44249b566cbdf612695d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO5q2i5L2V5a6J5ZWK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763274825&amp;x-signature=d5YkYlgoQXmKe8wMK8kNw9hnLIE%3D" alt="image.png" loading="lazy"/></p>
<p>这段代码清晰展现了栈与堆的分工。</p>
<h2 data-id="heading-14">结语：舞剧的核心逻辑</h2>
<p>这场由栈与堆共同演绎的数据存储舞剧，让 JavaScript 既有 “轻骑兵”（原始类型）的迅捷响应，又有 “豪华庄园”（引用类型）的包容能力。通过代码示例，我们能直观看到不同数据类型的定义、操作方式，以及背后的存储逻辑 —— 原始类型 “值在栈中”，引用类型 “址在栈中，值在堆中”。</p>
<p>理解这份分工，就掌握了 JavaScript 内存管理的核心密码，在编写代码时，便能更清晰地预判变量的行为，避免因内存认知偏差导致的 bug，让代码既高效又稳健～</p>
<blockquote>
<p>感谢阅读，我会一直努力创造出高质量的文章！</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[在使用cloudflare workers时，假如有几十个请求，如何去控制并发？]]></title>    <link>https://juejin.cn/post/7570162891141545999</link>    <guid>https://juejin.cn/post/7570162891141545999</guid>    <pubDate>2025-11-09T06:07:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7570162891141545999" data-draft-id="7570058831559196707" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="在使用cloudflare workers时，假如有几十个请求，如何去控制并发？"/> <meta itemprop="keywords" content="前端,面试,架构"/> <meta itemprop="datePublished" content="2025-11-09T06:07:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员小jobleap"/> <meta itemprop="url" content="https://juejin.cn/user/2875978147692910"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            在使用cloudflare workers时，假如有几十个请求，如何去控制并发？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2875978147692910/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员小jobleap
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-09T06:07:34.000Z" title="Sun Nov 09 2025 06:07:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Cloudflare Workers 并发控制简易指南</h2>
<p>Cloudflare Workers 允许你在 Cloudflare 的边缘网络上运行代码，这意味着你的代码可以快速响应全球用户的请求。但同时，你需要合理控制并发请求的数量，以确保 Worker 的性能和稳定性。简单的说，并发控制就是管理同时有多少请求在处理，避免过多请求导致崩溃或变慢。</p>
<h3 data-id="heading-1">并发控制策略</h3>
<p>Cloudflare Workers 对并发请求有一些限制。例如，单个入站请求默认最多可以发起 6 个并发的出站请求。为了有效地利用这些资源，可以采用以下策略：</p>
<ul>
<li><strong>异步处理 (Async Processing)</strong> ：利用 JavaScript 的 <code>async/await</code> 和 <code>Promise</code> 来处理异步操作，避免阻塞 Worker 的执行。</li>
</ul>

<ul>
<li>
<ul>
<li><code>Promise.all()</code> <strong>的应用</strong>：<code>Promise.all()</code> 可以并行处理多个 Promise 对象，但需要注意并发限制。</li>
</ul>
</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleRequest</span>(<span class="hljs-params">request</span>) {
  <span class="hljs-keyword">const</span> urls = [
    <span class="hljs-string">'https://example.com/api/data1'</span>,
    <span class="hljs-string">'https://example.com/api/data2'</span>,
    <span class="hljs-string">'https://example.com/api/data3'</span>
  ];
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> responses = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>(urls.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">url</span> =&gt;</span> <span class="hljs-title function_">fetch</span>(url)));
    <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>(responses.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> res.<span class="hljs-title function_">json</span>()));
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Response</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(data), {
      <span class="hljs-attr">headers</span>: { <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'application/json'</span> },
    });
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Response</span>(<span class="hljs-string">'Error fetching data'</span>, { <span class="hljs-attr">status</span>: <span class="hljs-number">500</span> });
  }
}
<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'fetch'</span>, <span class="hljs-function"><span class="hljs-params">event</span> =&gt;</span> {
  event.<span class="hljs-title function_">respondWith</span>(<span class="hljs-title function_">handleRequest</span>(event.<span class="hljs-property">request</span>));
});
</code></pre>
<p>这个例子展示了如何使用 <code>Promise.all()</code> 并行获取多个 API 的数据，然后将它们合并成一个 JSON 响应。由于 Cloudflare Workers 限制并发请求的数量，需要确保并行请求的数量在限制范围内。</p>
<ul>
<li>
<ul>
<li><strong>分批处理 (Batch Processing)</strong> ：如果需要处理大量请求，可以将它们分成小批次，每次处理一批，处理完后再处理下一批。</li>
</ul>
</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">processInBatches</span>(<span class="hljs-params">items, batchSize, processItem</span>) {
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; items.<span class="hljs-property">length</span>; i += batchSize) {
    <span class="hljs-keyword">const</span> batch = items.<span class="hljs-title function_">slice</span>(i, i + batchSize);
    <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>(batch.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> <span class="hljs-title function_">processItem</span>(item)));
  }
}

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleRequest</span>(<span class="hljs-params">request</span>) {
  <span class="hljs-keyword">const</span> items = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>({ <span class="hljs-attr">length</span>: <span class="hljs-number">20</span> }, <span class="hljs-function">(<span class="hljs-params">_, i</span>) =&gt;</span> i + <span class="hljs-number">1</span>); <span class="hljs-comment">// 示例数据</span>
  <span class="hljs-keyword">const</span> batchSize = <span class="hljs-number">5</span>;

  <span class="hljs-keyword">await</span> <span class="hljs-title function_">processInBatches</span>(items, batchSize, <span class="hljs-keyword">async</span> (item) =&gt; {
    <span class="hljs-comment">// 模拟处理单个 item 的异步操作</span>
    <span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> <span class="hljs-built_in">setTimeout</span>(resolve, <span class="hljs-number">100</span>));
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Processed item <span class="hljs-subst">${item}</span>`</span>);
  });

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Response</span>(<span class="hljs-string">'Items processed in batches'</span>);
}

<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'fetch'</span>, <span class="hljs-function"><span class="hljs-params">event</span> =&gt;</span> {
  event.<span class="hljs-title function_">respondWith</span>(<span class="hljs-title function_">handleRequest</span>(event.<span class="hljs-property">request</span>));
});
</code></pre>
<p>在这个例子中，<code>processInBatches</code> 函数将 <code>items</code> 分成多个批次，每个批次的大小为 <code>batchSize</code>，然后使用 <code>Promise.all</code> 并行处理每个批次。</p>
<ul>
<li><strong>优先级设置 (Priority Setting)</strong> ：使用 <code>cf-priority</code> 请求头可以控制请求的优先级，确保关键资源优先加载。</li>
</ul>

<ul>
<li>
<ul>
<li><code>cf-priority</code> 请求头：通过设置 <code>cf-priority</code> 请求头，可以控制响应的优先级和并发性。例如，设置为 <code>"30/0"</code> 意味着该响应将以最高优先级顺序处理，而不会与其他请求并行处理。这可以帮助你优化关键资源的加载顺序。在实际应用中，可以根据资源的类型和重要性设置不同的优先级。例如，可以将关键的 CSS 和 JavaScript 资源设置为高优先级，而将不重要的图片资源设置为低优先级。</li>
</ul>
</li>
</ul>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function"><span class="hljs-keyword">async</span> function <span class="hljs-title">handleRequest</span>(<span class="hljs-params">request</span>)</span> {
    <span class="hljs-keyword">const</span> url = <span class="hljs-keyword">new</span> URL(request.url);
    <span class="hljs-keyword">if</span> (url.pathname === <span class="hljs-string">'/api/important'</span>) {
        <span class="hljs-keyword">const</span> <span class="hljs-keyword">init</span> = {
            headers: {
                <span class="hljs-string">'cf-priority'</span>: <span class="hljs-string">'30/0'</span> <span class="hljs-comment">// 最高优先级</span>
            }
        };
        <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> fetch(<span class="hljs-string">'https://example.com/important-resource'</span>, <span class="hljs-keyword">init</span>);
        <span class="hljs-keyword">return</span> response;
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> fetch(<span class="hljs-string">'https://example.com/normal-resource'</span>);
        <span class="hljs-keyword">return</span> response;
    }
}

addEventListener(<span class="hljs-string">'fetch'</span>, <span class="hljs-keyword">event</span> =&gt; {
    <span class="hljs-keyword">event</span>.respondWith(handleRequest(<span class="hljs-keyword">event</span>.request));
});
</code></pre>
<ul>
<li><strong>队列机制 (Queue Mechanism)</strong> ：实现一个简单的队列来限制并发数，特别适用于需要严格控制并发的场景。</li>
</ul>

<ul>
<li>
<ul>
<li>通过使用 JavaScript 的异步函数和状态管理来实现，可以创建一个队列，用于存储待处理的请求。然后，可以设置一个并发数限制，只有当队列中的请求数量小于限制时，才允许处理新的请求。</li>
</ul>
</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Queue</span> {
    <span class="hljs-title function_">constructor</span>(<span class="hljs-params">maxConcurrency</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxConcurrency</span> = maxConcurrency;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">running</span> = <span class="hljs-number">0</span>;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">queue</span> = [];
    }

    <span class="hljs-keyword">async</span> <span class="hljs-title function_">enqueue</span>(<span class="hljs-params">task</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">queue</span>.<span class="hljs-title function_">push</span>({ task, resolve, reject });
            <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">processNext</span>();
        });
    }

    <span class="hljs-keyword">async</span> <span class="hljs-title function_">processNext</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">running</span> &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxConcurrency</span> &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">queue</span>.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">const</span> { task, resolve, reject } = <span class="hljs-variable language_">this</span>.<span class="hljs-property">queue</span>.<span class="hljs-title function_">shift</span>();
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">running</span>++;

            <span class="hljs-keyword">try</span> {
                <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> <span class="hljs-title function_">task</span>();
                <span class="hljs-title function_">resolve</span>(result);
            } <span class="hljs-keyword">catch</span> (error) {
                <span class="hljs-title function_">reject</span>(error);
            } <span class="hljs-keyword">finally</span> {
                <span class="hljs-variable language_">this</span>.<span class="hljs-property">running</span>--;
                <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">processNext</span>();
            }
        }
    }
}

<span class="hljs-keyword">const</span> queue = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Queue</span>(<span class="hljs-number">3</span>); <span class="hljs-comment">// 限制并发数为 3</span>

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleRequest</span>(<span class="hljs-params">request</span>) {
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">task</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
        <span class="hljs-comment">// 模拟异步操作</span>
        <span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> <span class="hljs-built_in">setTimeout</span>(resolve, <span class="hljs-number">100</span>));
        <span class="hljs-keyword">return</span> <span class="hljs-string">`Task completed at <span class="hljs-subst">${<span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().toLocaleTimeString()}</span>`</span>;
    };

    <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> queue.<span class="hljs-title function_">enqueue</span>(task);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Response</span>(result);
}

<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'fetch'</span>, <span class="hljs-function"><span class="hljs-params">event</span> =&gt;</span> {
    event.<span class="hljs-title function_">respondWith</span>(<span class="hljs-title function_">handleRequest</span>(event.<span class="hljs-property">request</span>));
});
</code></pre>
<p>这个例子展示了如何使用队列来限制并发请求的数量。<code>Queue</code> 类维护一个任务队列，并限制同时运行的任务数量。</p>
<h3 data-id="heading-2">注意事项</h3>
<ul>
<li><strong>全局状态管理 (Global State Management)</strong> ：避免在全局作用域中存储数据，防止多个请求之间的数据冲突。确保每个请求的数据是独立的。</li>
<li><strong>监控和调试 (Monitoring and Debugging)</strong> ：使用 Cloudflare 的日志功能来监控 Worker 的行为，及时发现和解决并发处理中的问题。</li>
</ul>
<p>通过以上策略和注意事项，可以有效地控制 Cloudflare Workers 中的并发请求，保证系统的稳定性和性能。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[每周AI论文速递（251103-251107）]]></title>    <link>https://juejin.cn/post/7570213477949374516</link>    <guid>https://juejin.cn/post/7570213477949374516</guid>    <pubDate>2025-11-09T07:15:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7570213477949374516" data-draft-id="7570058831559278627" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="每周AI论文速递（251103-251107）"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-11-09T07:15:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="叶子的技术碎碎念"/> <meta itemprop="url" content="https://juejin.cn/user/2831954919569245"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            每周AI论文速递（251103-251107）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2831954919569245/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    叶子的技术碎碎念
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-09T07:15:58.000Z" title="Sun Nov 09 2025 07:15:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读22分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Thinking with Video: Video Generation as a Promising Multimodal Reasoning Paradigm</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fabs%2F2511.04570" target="_blank" title="https://arxiv.org/abs/2511.04570" ref="nofollow noopener noreferrer">视频思维：视频生成作为一种前景广阔的多模态推理范式</a></p>
<p>"文本思维"与"图像思维"范式显著提升了大语言模型 (LLMs) 和视觉语言模型 (VLMs) 的推理能力。然而，这些范式存在固有局限：(1) 图像仅能捕捉瞬时状态，无法表征动态过程或连续变化；(2) 文本与视觉作为独立模态相互分离，阻碍了统一的多模态理解与生成。为突破这些限制，我们提出"视频思维"新范式，通过 Sora-2 等视频生成模型，在统一时序框架中实现视觉与文本推理的融合。为支撑本研究，我们构建了视频思维基准 (VideoThinkBench)，涵盖两大任务类型：(1) 视觉中心任务 (如视觉推理谜题)；(2) 文本中心任务 (如 GSM8K、MMMU 的子集)。评估结果表明，Sora-2 具备卓越的推理能力：在视觉中心任务中，其性能与最先进 (SOTA) VLMs 相当，且在视觉推理游戏等任务中实现超越；在文本中心任务中，Sora-2 在 MATH 数据集上达到 92% 准确率，在 MMMU 上达到 75.53% 准确率。我们进一步系统分析了其能力来源，发现自洽性与上下文学习能有效提升模型性能。综上所述，本研究证实视频生成模型有望成为统一的多模态理解与生成模型，从而确立"视频思维"作为统一的多模态推理范式。</p>
<h2 data-id="heading-1">VCode: a Multimodal Coding Benchmark with SVG as Symbolic Visual Representation</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fabs%2F2511.02778" target="_blank" title="https://arxiv.org/abs/2511.02778" ref="nofollow noopener noreferrer">VCode：以 SVG 作为符号化视觉表示的多模态编码基准</a></p>
<p>在 AI 智能体时代，代码已成为推理与行动的一种精确且可执行的媒介。然而，相关进展主要集中于以语言为中心的任务，如程序合成与调试，导致视觉导向的编码研究相对不足。受人类基于草图进行推理的机制启发，我们提出将 SVG 代码作为一种紧凑、可解释且可执行的视觉表示形式。本文引入 VCode 基准，将多模态理解任务重新定义为代码生成问题：给定输入图像，模型必须生成能保留符号语义以支持下游推理的 SVG 代码。VCode 涵盖三大领域：通用常识（MM-Vet）、专业学科（MMMU）以及视觉核心感知（CV-Bench）。为评估符号保真度，我们提出 CodeVQA——一种创新评估协议，通过策略模型对渲染后的 SVG 进行问答，正确答案即表明符号信息被真实保留。实证研究表明，当前前沿视觉语言模型（VLM）在生成精确 SVG 方面仍面临困难，这暴露出语言导向与视觉导向编码能力之间存在显著差距。为弥合这一差距，我们开发了 VCoder 智能体框架，从两个维度增强 VLM 能力：（i）修订式思考，通过迭代分析差异持续优化 SVG 代码；（ii）视觉工具赋能，利用检测器与解析器提供模型固有能力之外的结构化线索（如物体、形状与文本）。在多项基准测试中，尽管具备强推理能力的前沿 VLM 整体表现良好，但在专业知识与三维推理方面仍存在局限。VCoder 相较性能最优的 Claude-4-Opus 实现了 12.3 个百分点的整体提升。人类研究表明，人类与 VLM 在渲染 SVG 任务上表现均有所下降，但二者表现的一致性印证了符号化视觉表示的巨大潜力。本基准与代码已开源于 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FCSU-JPG%2FVCode%25E3%2580%2582" target="_blank" title="https://github.com/CSU-JPG/VCode%E3%80%82" ref="nofollow noopener noreferrer">github.com/CSU-JPG/VCo…</a></p>
<h2 data-id="heading-2">Diffusion Language Models are Super Data Learners</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fabs%2F2511.03276" target="_blank" title="https://arxiv.org/abs/2511.03276" ref="nofollow noopener noreferrer">扩散语言模型是卓越的数据学习器</a></p>
<p>在严格控制的预训练条件下，我们观察到性能交叉现象：当唯一数据有限时，扩散语言模型 (DLMs) 通过增加训练周期数持续优于自回归 (AR) 模型。该交叉点随数据量增加或质量提升而延迟出现，随模型规模扩大而提前出现，且在密集与稀疏架构中均稳定存在。我们将性能提升归因于三个叠加因素：(1) 任意顺序建模能力，(2) 迭代双向去噪带来的超密集计算优势，以及 (3) 内置的蒙特卡洛数据增强；输入噪声或参数噪声虽能在数据受限时改善 AR 模型性能，但无法消除性能差距。在大规模训练中，使用约 1.5T token 计算预算、基于 100 亿唯一 Python token 训练的 17 亿参数 DLM，其性能超越了在严格匹配条件下训练的 AR 编码器。此外，10 亿参数 DLM 仅通过重复标准预训练数据（仅使用 10 亿 token），即在 HellaSwag 上获得 &gt;56% 准确率，在 MMLU 上获得 &gt;33% 准确率，且不依赖任何特殊技巧。我们还证实，在此数据受限的训练模式下，验证集交叉熵上升并不代表下游任务性能退化。</p>
<h2 data-id="heading-3">Don't Blind Your VLA: Aligning Visual Representations for OOD Generalization</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fabs%2F2510.25616" target="_blank" title="https://arxiv.org/abs/2510.25616" ref="nofollow noopener noreferrer">不要限制你的 VLA：对齐视觉表示以实现 OOD 泛化</a></p>
<p>视觉-语言-动作 (Vision-Language-Action, VLA) 模型的成功日益显著，这源于预训练视觉-语言模型 (Vision-Language Models, VLMs) 能够为智能体提供可迁移的世界知识和视觉-语言 (Vision-Language, VL) 基础，从而为具有更广泛泛化能力的动作模型奠定基础。然而，当这些 VLMs 被微调以适应动作模态时，其原始的 VL 表示和知识保留程度尚不明确。在本工作中，我们系统研究了 VLA 微调过程中的表示保留问题，发现简单的动作微调会导致视觉表示退化。为表征和量化这些影响，我们分析了 VLA 的隐藏表示和注意力图；进一步，我们设计了一组针对性任务和方法，将 VLA 模型与原始 VLM 进行对比，以分离动作微调引起的 VL 能力变化。我们还评估了多种对齐视觉表示的策略，并提出一种简单有效的方法，该方法可缓解退化并提升对分布外 (Out-of-Distribution, OOD) 场景的泛化性能。总体而言，我们的分析明确了动作微调与 VL 表示退化之间的权衡，并指出了恢复继承 VL 能力的实用途径。代码公开可用：<a href="https://link.juejin.cn?target=https%3A%2F%2Fblind-vla-paper.github.io" target="_blank" title="https://blind-vla-paper.github.io" ref="nofollow noopener noreferrer">blind-vla-paper.github.io</a></p>
<h2 data-id="heading-4">Every Activation Boosted: Scaling General Reasoner to 1 Trillion Open Language Foundation</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fabs%2F2510.22115" target="_blank" title="https://arxiv.org/abs/2510.22115" ref="nofollow noopener noreferrer">每次激活皆增强：将通用推理模型扩展至万亿级开放语言基础模型</a></p>
<p>我们推出 Ling 2.0 系列，这是一套以推理为导向的语言基础模型，其核心设计原则是每次激活操作均能提升推理能力。该系列在统一的混合专家 (MoE) 架构下，实现了从百亿级到万亿级参数的可扩展性，并基于经验缩放定律，着重优化了高稀疏性、跨尺度一致性与计算效率。系列包含三款指令调优模型（非自主推理型）——Ling-mini-2.0、Ling-flash-2.0 和 Ling-1T，总参数量覆盖 160 亿至 1 万亿，与稠密模型相比，激活计算效率提升最高达 7 倍。Ling 2.0 融合了模型架构、预训练、后训练及基础设施的协同创新：采用具备 MTP（多维张量并行）的高稀疏 MoE 以实现高效推理、注入推理导向数据与训练中程思维链 (CoT) 激活、应用基于强化学习的微调（DFT、Evo-CoT），并实现全精度 FP8 训练及细粒度异构流水线。在万亿参数规模上，Ling-1T 确立了推理精度与计算效率的新帕累托前沿，证明当稀疏激活与推理目标精准对齐时，能够实现可扩展的高效智能。总体而言，Ling 2.0 为未来推理与思维模型（包括基于同一基座的 Ring 系列）的发展提供了连贯、开放且高效的基础框架。</p>
<h2 data-id="heading-5">V-Thinker: Interactive Thinking with Images</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fabs%2F2511.04460" target="_blank" title="https://arxiv.org/abs/2511.04460" ref="nofollow noopener noreferrer">V-Thinker：基于图像的交互式思考</a></p>
<p>如何使大型多模态模型 (LMMs) 深度融合图像交互与长程推理能力，始终是该领域长期存在的挑战。近期以视觉为中心的推理研究探索出名为“基于图像的思考”的新范式，推动模型从图像辅助推理转向图像交互式思考。尽管这一突破使模型能专注于细粒度图像区域，但有限的视觉工具空间与任务定制化工作流设计仍制约着进一步发展。为突破此局限，我们提出 V-Thinker——一种通用多模态推理助手，通过端到端强化学习实现以视觉为中心的交互式思考。该系统包含两大核心组件：(1) 数据进化飞轮，可在多样性、质量与难度三个维度上自动合成、演进并验证交互式推理数据集；(2) 视觉渐进式训练课程，先通过点级监督实现感知对齐，再通过两阶段强化学习框架融合交互式推理。此外，我们推出 VTBench 专家验证基准，专门针对视觉交互式推理任务。大量实验表明，V-Thinker 在通用推理与交互式推理场景中均稳定超越基于 LMM 的强基线模型，为图像交互式推理应用的发展提供了重要洞见。</p>
<h2 data-id="heading-6">ThinkMorph: Emergent Properties in Multimodal Interleaved Chain-of-Thought Reasoning</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fabs%2F2510.27492" target="_blank" title="https://arxiv.org/abs/2510.27492" ref="nofollow noopener noreferrer">ThinkMorph：多模态交织思维链推理中的涌现性质</a></p>
<p>多模态推理需要语言与视觉的迭代协调，但何种交织思维链具有意义仍不明确。我们提出，文本与图像思维应作为互补（而非同构）的模态，共同推进推理。基于此原则，我们开发了ThinkMorph——一个统一模型，其在约2.4万条高质量交织推理序列上微调，覆盖多种视觉参与度的任务。ThinkMorph能够生成渐进的文本-图像推理步骤，在保持语言逻辑连贯的同时，具体操控视觉内容。该模型在以视觉为核心的基准测试中显著提升（平均优于基础模型34.7%），并能泛化至域外任务，性能匹配或超越更大规模的专有多模态大语言模型。除性能优势外，ThinkMorph展现出涌现的多模态智能特性，包括未见的视觉处理能力、推理模式的自适应切换，以及通过多样化多模态思维实现更优的测试阶段扩展。这些发现为探索统一多模态推理模型的涌现能力指明了潜力方向。</p>
<h2 data-id="heading-7">OS-Sentinel: Towards Safety-Enhanced Mobile GUI Agents via Hybrid Validation in Realistic Workflows</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fabs%2F2510.24411" target="_blank" title="https://arxiv.org/abs/2510.24411" ref="nofollow noopener noreferrer">OS-Sentinel：基于现实工作流混合验证的安全增强型移动 GUI 智能体</a></p>
<p>基于视觉语言模型 (VLM) 的计算机操作智能体在移动平台等数字环境中已展现出类人的操作能力。尽管这些智能体在推动数字自动化方面潜力巨大，但其可能引发的不安全操作（如系统破坏和隐私泄露）正引起高度关注。在移动环境广阔而复杂的操作空间中检测这些安全威胁是一项重大挑战，目前该领域的研究仍严重不足。为奠定移动智能体安全研究的基础，我们推出了 MobileRisk-Live——一个动态沙盒环境，并配套构建了包含细粒度标注现实轨迹的安全检测基准。在此基础上，我们提出 OS-Sentinel：一种新型混合安全检测框架，通过协同整合形式验证器（用于检测显式系统级违规）和基于 VLM 的上下文判断器（用于评估上下文风险与智能体行为），实现综合安全保障。实验表明，OS-Sentinel 在多项指标上相较现有方法提升 10%-30%。深入分析提供了关键见解，有力推动更安全、更可靠的自主移动智能体的发展。</p>
<h2 data-id="heading-8">INT v.s. FP: A Comprehensive Study of Fine-Grained Low-bit Quantization Formats</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fabs%2F2510.25602" target="_blank" title="https://arxiv.org/abs/2510.25602" ref="nofollow noopener noreferrer">INT vs. FP：细粒度低比特位量化格式的综合研究</a></p>
<p>现代 AI 硬件（如 Nvidia 的 Blackwell 架构）正日益广泛采用低精度浮点 (FP) 格式，以处理大语言模型 (LLMs) 中普遍存在的激活值异常值 (outliers)。尽管存在这一行业趋势，但针对不同粒度的 FP 与整数 (INT) 量化方法的统一比较仍属空白，导致算法与硬件协同设计缺乏明确指导。本文通过系统研究 FP 和 INT 格式之间的权衡，填补了这一空白。我们揭示了一个关键的性能转折点：虽然 FP 在粗粒度量化中表现优异，但在细粒度（块级）量化下的比较则更为复杂。全面的比较结果表明，对于流行的 8 位细粒度格式（如块大小为 32 的 MX），MXINT8 在算法精度和硬件效率上均优于其 FP 对应方案。然而，对于 4 位格式，FP（例如 MXFP4 和 NVFP4）通常具有精度优势，但我们证明，在应用 Hadamard 旋转等异常值缓解技术时，NVINT4 可以超越 NVFP4。我们还提出了一种对称裁剪方法，解决了细粒度低比特位 INT 训练中的梯度偏差 (gradient bias) 问题，使 MXINT8 训练实现近乎无损的性能。这些发现对当前硬件发展路径提出了挑战，表明通用型 FP 方法并非最优，并主张细粒度 INT 格式（尤其是 MXINT8）能为未来 AI 加速器在精度、功率和效率之间提供更佳平衡。</p>
<h2 data-id="heading-9">Continuous Autoregressive Language Models</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fabs%2F2510.27688" target="_blank" title="https://arxiv.org/abs/2510.27688" ref="nofollow noopener noreferrer">连续自回归语言模型</a></p>
<p>大语言模型 (LLMs) 的效率从根本上受限于其顺序、逐个 token 的生成过程。我们认为，要克服这一瓶颈，需要引入一个新的 LLM 扩展设计维度：提升每个生成步骤的语义带宽。为此，我们提出了连续自回归语言模型 (CALM)，实现了从离散的下一个 token 预测到连续的下一个向量预测的范式转变。CALM 采用高保真自编码器将 K 个 token 的块压缩为单个连续向量，并能以超过 99.9% 的准确率重建原始 token。这使得我们可以将语言建模为连续向量序列而非离散 token 序列，从而将生成步骤数量减少到原来的 1/K。这一范式转变需要新的建模工具；因此，我们开发了一套全面的无似然框架，支持在连续域中进行稳健的训练、评估和可控采样。实验表明，CALM 显著优化了性能与计算之间的权衡，在计算成本大幅降低的情况下，达到了性能强大的离散基线模型的水平。更重要的是，这些发现将下一个向量预测确立为一个强大且可扩展的路径，用于构建超高效语言模型。代码：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fshaochenze%2Fcalm%25E3%2580%2582%25E9%25A1%25B9%25E7%259B%25AE%25EF%25BC%259Ahttps%3A%2F%2Fshaochenze.github.io%2Fblog%2F2025%2FCALM%25E3%2580%2582" target="_blank" title="https://github.com/shaochenze/calm%E3%80%82%E9%A1%B9%E7%9B%AE%EF%BC%9Ahttps://shaochenze.github.io/blog/2025/CALM%E3%80%82" ref="nofollow noopener noreferrer">github.com/shaochenze/…</a></p>
<h2 data-id="heading-10">Scaling Agent Learning via Experience Synthesis</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fabs%2F2511.03773" target="_blank" title="https://arxiv.org/abs/2511.03773" ref="nofollow noopener noreferrer">通过经验合成实现智能体学习的规模化</a></p>
<p>尽管强化学习 (RL) 能够通过交互式自我改进增强大语言模型 (LLM) 智能体的能力，但其实际应用仍面临挑战：高成本的 rollout、有限的任务多样性、不可靠的奖励信号以及复杂的基础设施，这些问题都阻碍了可扩展经验数据的收集。为解决这些挑战，我们提出了 DreamGym——首个以可扩展性为核心设计的统一框架，通过合成多样化经验来实现自主智能体的高效在线 RL 训练。DreamGym 不依赖高成本的实境 rollout，而是将环境动态蒸馏为基于推理的经验模型，通过逐步推理生成一致的状态转移和反馈信号，从而为 RL 提供可扩展的智能体 rollout 收集。为提升状态转移的稳定性和质量，DreamGym 采用经验回放缓冲区，该缓冲区使用离线采集的真实世界数据初始化，并通过实时交互数据持续扩充，以主动支撑智能体训练。为优化知识获取，DreamGym 自适应生成针对当前智能体策略的新任务，实现更高效的在线课程学习。在不同环境与智能体骨干网络上的实验表明，DreamGym 在完全合成设置和仿真到实境迁移场景中均能显著提升 RL 训练效果。在 WebArena 等非 RL 就绪任务上，DreamGym 以超过 30% 的优势超越所有基线方法；在 RL 就绪但成本高昂的场景中，仅使用合成交互即可达到与 GRPO 和 PPO 相当的性能。当将纯合成经验训练的策略迁移至实境 RL 时，DreamGym 在大幅减少实境交互次数的同时，带来显著的额外性能提升，为通用 RL 提供了一种可扩展的热启动策略。</p>
<h2 data-id="heading-11">π_RL: Online RL Fine-tuning for Flow-based Vision-Language-Action Models</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fabs%2F2510.25889" target="_blank" title="https://arxiv.org/abs/2510.25889" ref="nofollow noopener noreferrer">π_RL：基于流的视觉-语言-动作模型的在线强化学习微调</a></p>
<p>视觉-语言-动作 (VLA) 模型能够使机器人根据多模态输入理解并执行复杂任务。尽管近期研究探索利用强化学习 (RL) 自动化扩展监督微调 (SFT) 中繁重的数据收集流程，但由于基于流的 VLA (如 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>π</mi><mn>0</mn></msub></mrow><annotation encoding="application/x-tex">\pi_0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>、<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>π</mi><mn>0.5</mn></msub></mrow><annotation encoding="application/x-tex">\pi_{0.5}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">0.5</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>) 通过迭代去噪产生的动作对数似然难以计算，大规模 RL 应用仍面临挑战。
我们提出 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>π</mi><mtext>RL</mtext></msub></mrow><annotation encoding="application/x-tex">\pi_{\text{RL}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">RL</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 解决这一难题，这是一个支持在并行仿真中训练基于流 VLA 的开源框架。<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>π</mi><mtext>RL</mtext></msub></mrow><annotation encoding="application/x-tex">\pi_{\text{RL}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">RL</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 实现两种 RL 算法：(1) {Flow-Noise} 将去噪过程建模为离散时间马尔可夫决策过程 (MDP)，通过可学习的噪声网络实现精确对数似然计算；(2) {Flow-SDE} 将去噪与智能体-环境交互相结合，构建双层 MDP，采用常微分方程至随机微分方程 (ODE-to-SDE) 转换以提升 RL 探索效率。
我们在 LIBERO 与 ManiSkill 基准测试中评估 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>π</mi><mtext>RL</mtext></msub></mrow><annotation encoding="application/x-tex">\pi_{\text{RL}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">RL</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>。在 LIBERO 上，<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>π</mi><mtext>RL</mtext></msub></mrow><annotation encoding="application/x-tex">\pi_{\text{RL}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">RL</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 将少样本 SFT 模型 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>π</mi><mn>0</mn></msub></mrow><annotation encoding="application/x-tex">\pi_0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 和 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>π</mi><mn>0.5</mn></msub></mrow><annotation encoding="application/x-tex">\pi_{0.5}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">0.5</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 的性能分别从 57.6% 提升至 97.6% 和从 77.1% 提升至 98.3%。在 ManiSkill 中，我们于 320 个并行环境中训练 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>π</mi><mtext>RL</mtext></msub></mrow><annotation encoding="application/x-tex">\pi_{\text{RL}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">RL</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>，在 4352 项抓取放置任务中，将 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>π</mi><mn>0</mn></msub></mrow><annotation encoding="application/x-tex">\pi_0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 从 41.6% 提升至 85.7%，<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>π</mi><mn>0.5</mn></msub></mrow><annotation encoding="application/x-tex">\pi_{0.5}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">0.5</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 从 40.0% 提升至 84.8%，证明了异构仿真环境下可扩展的多任务 RL 能力。
总体而言，<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>π</mi><mtext>RL</mtext></msub></mrow><annotation encoding="application/x-tex">\pi_{\text{RL}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">RL</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 相比 SFT 模型实现了显著性能提升与更强泛化能力，验证了在线 RL 对基于流 VLA 的有效性。</p>
<h2 data-id="heading-12">When Visualizing is the First Step to Reasoning: MIRA, a Benchmark for Visual Chain-of-Thought</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fabs%2F2511.02779" target="_blank" title="https://arxiv.org/abs/2511.02779" ref="nofollow noopener noreferrer">当可视化是推理的第一步：MIRA，一个视觉思维链基准</a></p>
<p>我们提出了 MIRA，这是一个新基准，旨在评估模型在生成中间视觉图像对成功推理至关重要的场景中的表现。与传统仅依赖文本的思维链方法不同，MIRA 中的任务要求模型生成并利用中间图像（如草图、结构图或路径图）来指导推理过程。这种设置模拟了人类通过“画图思考”解决复杂问题的方式。MIRA 专注于本质上具有挑战性的任务，这些任务涉及复杂结构、空间关系或难以仅用语言表达的推理步骤。为确保评估数据的高质量，我们包含了 546 个多模态问题，并标注了中间视觉图像和最终答案。我们还为 MIRA 设计了一个统一的评估协议，涵盖三个输入评估级别：仅图像和问题的直接输入、带图像和思考提示的纯文本思维链输入，以及带标注图像线索和文本思考提示的视觉思维链输入。为探索基准上模型能力的上限，我们报告了不同 k 设置下的 pass@k 和多数投票准确率。实验结果显示，现有多模态大语言模型（包括最强私有模型和强大开放权重模型）在仅依赖文本提示时表现不佳；但当提供中间视觉线索时，模型性能一致提升，在所有模型和任务中平均相对提升 33.7%。我们还通过扩展搜索空间和设计与视觉思维链对齐的文本提示来探索上限，但两者与视觉思维链设置相比改进有限。这些结果凸显了想象视觉信息在 MIRA 成功推理中的关键作用。</p>
<h2 data-id="heading-13">UniAVGen: Unified Audio and Video Generation with Asymmetric Cross-Modal Interactions</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fabs%2F2511.03334" target="_blank" title="https://arxiv.org/abs/2511.03334" ref="nofollow noopener noreferrer">UniAVGen：基于非对称跨模态交互的统一音视频生成</a></p>
<p>由于缺乏有效的跨模态建模，现有开源音视频生成方法通常存在唇形同步效果不佳和语义一致性不足的问题。为解决这些局限，我们提出UniAVGen——一个统一的联合音视频生成框架。UniAVGen采用双分支联合合成架构，通过两个并行扩散Transformer (DiTs) 构建统一的跨模态潜在空间。其核心是非对称跨模态交互机制，该机制实现双向、时序对齐的跨注意力，从而确保精确的时空同步与语义一致性。此外，通过面部感知调制模块增强跨模态交互，该模块在交互过程中动态聚焦于显著区域。为提升推理阶段的生成质量，我们额外引入模态感知无分类器引导策略，这种创新方法能够显式增强跨模态关联信号。值得注意的是，UniAVGen的鲁棒联合合成设计使其能在单一模型中无缝集成关键音视频任务，包括联合音视频生成与续写、视频到音频配音以及音频驱动视频合成。综合实验表明，在训练样本量显著减少的情况下 (1.3M vs. 30.1M) ，UniAVGen在音视频同步性、音色一致性和情感一致性方面均展现出全面优势。</p>
<h2 data-id="heading-14">EBT-Policy: Energy Unlocks Emergent Physical Reasoning Capabilities</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fabs%2F2510.27545" target="_blank" title="https://arxiv.org/abs/2510.27545" ref="nofollow noopener noreferrer">EBT-策略：能量解锁涌现的物理推理能力</a></p>
<p>基于生成模型 (如扩散策略) 的隐式策略，已成为机器人策略学习与视觉-语言-动作 (VLA) 模型的标准方法。然而，这些方法常面临高计算成本、暴露偏差及推理动态不稳定等问题，导致在分布偏移下容易发散。基于能量的模型 (EBMs) 通过端到端学习能量景观并建模平衡动力学，有效提高了鲁棒性并减少了暴露偏差。但传统上，基于EBMs的策略难以有效扩展。近期基于能量的Transformer (EBTs) 的研究证明了EBMs在高维空间的可扩展性，然而其在解决物理实体模型核心挑战方面的潜力仍待深入挖掘。我们提出了一种新型基于能量的架构——EBT-策略，旨在解决机器人及现实场景中的核心问题。在模拟与真实任务中，EBT-策略均持续优于基于扩散的策略，且所需训练与推理计算量更少。值得注意的是，对于某些任务，它仅需两个推理步骤即可收敛，较扩散策略的100步减少了50倍 (即步数降至1/50)。此外，EBT-策略展现出先前模型未见的涌现能力，例如仅通过行为克隆、无需显式重试训练，即可实现从失败动作序列的零样本恢复。通过利用其标量能量进行不确定性感知推理与动态计算分配，EBT-策略为在分布偏移下实现鲁棒、可泛化的机器人行为开辟了前景广阔的路径。</p>
<h2 data-id="heading-15">LEGO-Eval: Towards Fine-Grained Evaluation on Synthesizing 3D Embodied Environments with Tool Augmentation</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fabs%2F2511.03001" target="_blank" title="https://arxiv.org/abs/2511.03001" ref="nofollow noopener noreferrer">LEGO-Eval：基于工具增强的3D具身环境合成细粒度评估</a></p>
<p>尽管大语言模型 (LLMs) 在自动生成3D场景方面已取得进展，但生成结果常缺乏真实环境中的合理空间布局与对象属性。该问题根源在于指令描述过于粗略，因此需通过更精细、贴合现实场景的细粒度指令来改进3D场景合成。若缺乏真实场景，在虚拟环境中训练具身智能体会使其习得偏离真实物理规则与语义关系的先验知识，最终导致实际部署时性能下降。因此，验证细粒度指令与生成场景的一致性对有效学习至关重要。然而，现有评估方法（如CLIPScore与视觉语言模型VLMs）难以可靠衡量该一致性，主因在于其对3D场景理解不足，常导致场景元素关联错误。为此，我们提出LEGO-Eval评估框架，通过集成多类工具显式构建场景元素关联，从而实现更精准的一致性评估。同时，我们构建LEGO-Bench基准测试集，包含定义真实环境复杂布局与属性的详细指令集。实验表明，在场景-指令一致性评估中，LEGO-Eval的F1分数较VLM-as-a-judge提升0.41分。基于LEGO-Bench的测试揭示出现有生成方法的明显缺陷：所有被测方法生成完全符合细粒度指令场景的成功率最高仅为10%。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>