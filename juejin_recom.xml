<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[HarmonyOS弹窗+bindSheet半模态+浮层通用解决方案覆盖全业务场景]]></title>    <link>https://juejin.cn/post/7590608345923518490</link>    <guid>https://juejin.cn/post/7590608345923518490</guid>    <pubDate>2026-01-03T14:36:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590608345923518490" data-draft-id="7590592594674892810" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="HarmonyOS弹窗+bindSheet半模态+浮层通用解决方案覆盖全业务场景"/> <meta itemprop="keywords" content="HarmonyOS,Android"/> <meta itemprop="datePublished" content="2026-01-03T14:36:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="钟睿"/> <meta itemprop="url" content="https://juejin.cn/user/703287125625901"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            HarmonyOS弹窗+bindSheet半模态+浮层通用解决方案覆盖全业务场景
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/703287125625901/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    钟睿
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-03T14:36:02.000Z" title="Sat Jan 03 2026 14:36:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>从api9开始开发鸿蒙的大佬们想必一开始被弹窗折腾得有点难受，使用起来各种不顺手且不方便还有各种限制，
尤其是面对复杂且多样化的需求设计场景下太难受了，还好ComponentContent在api12的版本出现了</p>
<p><strong>ComponentContent的出现能解决什么问题？</strong></p>
<p>以CustomDialog弹窗为例，如果要使用弹窗CustomDialogController必须定义在页面中，通过CustomDialogController控制弹窗显示隐藏，这样就至少带来2个问题：</p>
<blockquote>
<p>1：哪里需要弹窗就需要在哪里声明CustomDialogController，不能直接在其他普通类（非@Component）直接使用弹窗，这样就导致把弹窗的部分逻辑强制耦合在页面上，业务越复杂，耦合度越高</p>
</blockquote>
<blockquote>
<p>2：在实际业务场景下弹窗不方便改成普通页面或者普通组件</p>
</blockquote>
<p><strong>而通过ComponentContent实现弹窗的方案只需要一个uiContext即可在任意地方控制弹窗显示，而且还能快速的改造成其他页面、组件、甚至是overlay(浮层)和bindSheet(半模态)且入侵性极低</strong></p>
<p><strong>基于ComponentContent实现的弹窗有多方便？</strong><br/>
显示弹窗的核心代码就三行(实例化Dialog，设置视图，显示弹窗)，以前做Android开发的应该对这个写法很熟悉</p>
<pre><code class="hljs language-text" lang="text">import { BaseDialog, ComponentParam } from '@zhongrui/easy_dialog'

@Entry
@Component
struct Page {
  build() {
    Column() {
      Button('显示弹窗').onClick(() =&gt; {
        //只要有uiContext，此处显示弹窗的代码可以写到主线程的任意地方
        const dialog = new BaseDialog(this.getUIContext())
        //传入弹窗视图和参数
        dialog.setContentView(wrapBuilder(dialogView), new ComponentParam('自定义参数'))
        dialog.show()
      })
      
      //弹窗的视图以组件的形式在页面中直接使用
      DialogView({ param: new ComponentParam('自定义参数') })
    }
    .height('100%')
    .width('100%')
  }
}

@Builder
function dialogView(param: ComponentParam&lt;string&gt;) {
  DialogView({ param: param })
}

@ComponentV2
struct DialogView {
  @Param param: ComponentParam&lt;string&gt; = new ComponentParam('')

  build() {
    Button('销毁弹窗').onClick(() =&gt; {
      this.param.dismiss()
    })
  }
}
</code></pre>
<p><strong>基于ComponentContent实现的弹窗如何快速改造成页面、组件、甚至是overlay(浮层)和bindSheet(半模态)</strong></p>
<pre><code class="hljs language-text" lang="text">//弹窗的视图以组件的形式在页面中直接使用,其他地方可以不做任何修改编译不会报错
DialogView({ param: new ComponentParam('自定义参数') })
</code></pre>
<pre><code class="hljs language-text" lang="text">//改成overlay浮层
const dialog = new BaseOverlay(this.getUIContext())
dialog.setContentView(wrapBuilder(dialogView), new ComponentParam('自定义参数'))
dialog.show()
</code></pre>
<pre><code class="hljs language-text" lang="text">//改成bindSheet半模态
const dialog = new BaseSheet(this.getUIContext(),'页面组件id')
dialog.setContentView(wrapBuilder(dialogView), new ComponentParam('自定义参数'))
dialog.show()
</code></pre>
<p>没错，只需要在实例化的时候，改个名字就行了</p>
<h2 data-id="heading-1">下载安装</h2>
<blockquote>
<p>ohpm install @zhongrui/easy_dialog</p>
</blockquote>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fohpm.openharmony.cn%2F%23%2Fcn%2Fdetail%2F%40zhongrui%252Feasy_dialog" target="_blank" title="https://ohpm.openharmony.cn/#/cn/detail/@zhongrui%2Feasy_dialog" ref="nofollow noopener noreferrer">easy_dialog开源库中心仓(<strong>api详细使用说明</strong>)</a><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitcode.com%2Fdeveloper_zhongrui%2FEasyDialog" target="_blank" title="https://gitcode.com/developer_zhongrui/EasyDialog" ref="nofollow noopener noreferrer">源码地址</a></p>
<h2 data-id="heading-2">效果图</h2>

















<table><thead><tr><th/><th/></tr></thead><tbody><tr><td><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3a91eb6c0ada4a0db5b73bec4c625887~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ZKf552_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768056170&amp;x-signature=Ax%2FS0IlDVFpOqd3YJxRllrwbMGs%3D" alt="11.gif" loading="lazy"/></td><td><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a7deca0fbb9d42229108ebaa4563b164~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ZKf552_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768056170&amp;x-signature=VqWhrWUaa8BZR2LvIBc2ngfwZK0%3D" alt="22.gif" loading="lazy"/></td></tr><tr><td><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c2f221726b11459d8d4b455cb28bcb38~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ZKf552_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768056170&amp;x-signature=HunJ0aeLPeMTA%2FvajSGpk6VOrls%3D" alt="33.gif" loading="lazy"/></td><td><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/657701258ed946718e35b3b6dbc86437~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ZKf552_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768056170&amp;x-signature=vYgNVATHMUrPe3%2BU6GcJTt%2BPFcg%3D" alt="44.gif" loading="lazy"/></td></tr></tbody></table>
<p><strong>当出现以下场景时使用easy_dialog轻松应对</strong></p>
<ul>
<li>
<p>场景1：不同页面显示同一个弹窗时，弹窗上面某些埋点上报需要上报不同页面来源（页面传递参数给弹窗视图）</p>
</li>
<li>
<p>场景2：在弹窗的视图上执行某个操作之后，需要将某些数据同步给页面（弹窗视图和页面通信）</p>
</li>
<li>
<p>场景3：页面满足某个状态时，需要将某些数据同步给弹窗视图（页面和弹窗视图通信）</p>
</li>
<li>
<p>场景4：页面出现多个运营活动弹窗，产品要求出现多个弹窗的场景，上一个弹窗消失时，下一个弹窗才能出现，不能同时显示</p>
</li>
<li>
<p>场景5：页面，弹窗，半模态之间切换<br/>
领导：这个登录页面你改成弹窗实现吧<br/>
我：修改这个大概需要1个小时(将页面改成弹窗用easy_dialog实际上10分钟不到就改完了)<br/>
领导：这个弹窗能不能滑上去，我看其他app有这个效果，能不能改成这样的效果？<br/>
我：我瞅瞅，噢~这个半模态效果啊，可以改的<br/>
领导：我听其他开发说这是bindSheet，你再花1小时研究下怎么实现的<br/>
我：好的好的（用2秒钟把BaseDialog改成了BaseSheet，然后摸鱼59分钟后去给领导演示效果）</p>
</li>
</ul>
<p>实现上述场景的需求，核心是解耦的条件下进行传参和通信，只要解决这两个问题那么该方案就能覆盖99%以上的业务场景</p>
<blockquote>
<p>场景1：不同页面显示同一个弹窗时，弹窗上面某些埋点上报需要上报不同页面来源</p>
</blockquote>
<pre><code class="hljs language-text" lang="text">const dialog = new BaseDialog(this.getUIContext())
dialog.setContentView(wrapBuilder(dialogView), new ComponentParam('自定义参数'))
//通过Tag给Dialog设置页面来源
dialog.addTag('pageSource','xxx')
dialog.show()

@Builder
function dialogView(param: ComponentParam&lt;string&gt;) {
  DialogView({ param: param })
}
</code></pre>
<pre><code class="hljs language-text" lang="text">@ComponentV2
struct DialogView {
  @Param param: ComponentParam&lt;string&gt; = new ComponentParam('')

  aboutToAppear(): void {
    //获取页面来源
    const pageSource = this.param.getTag('pageSource')
  }

  build() {
    Text()
  }
}
</code></pre>
<blockquote>
<p>场景2：在弹窗的视图上执行某个操作之后，需要将某些数据同步给页面</p>
</blockquote>
<pre><code class="hljs language-text" lang="text">@Entry
@Component
struct Page {
  build() {
    Column() {
      Button('显示弹窗').onClick(() =&gt; {
        const dialog = new BaseDialog(this.getUIContext())
        dialog.setContentView(wrapBuilder(dialogView), new ComponentParam('自定义参数'))
        //注册事件，接收弹窗视图发送的事件
        dialog.addEvent&lt;string&gt;('key', (data) =&gt; {
          //获取事件传的参数
          const result = data
          return '返回值'
        })
        dialog.show()
      })
    }
    .height('100%')
    .width('100%')
  }
}

@Builder
function dialogView(param: ComponentParam&lt;string&gt;) {
  DialogView({ param: param })
}
</code></pre>
<pre><code class="hljs language-text" lang="text">@ComponentV2
struct DialogView {
  @Param param: ComponentParam&lt;string&gt; = new ComponentParam('')

  build() {
    Text('xxx操作').onClick(() =&gt; {
      //给Dialog发送事件且获取结果
      const result = this.param.sendEvent('key', '自定义数据')
    })
  }
}
</code></pre>
<blockquote>
<p>场景3：页面满足某个状态时，需要将某些数据同步给弹窗视图（页面和弹窗视图通信）</p>
</blockquote>
<pre><code class="hljs language-text" lang="text">import { BaseDialog, ComponentParam } from '@zhongrui/easy_dialog'

@Entry
@Component
struct Page {
  build() {
    Column() {
      Button('显示弹窗').onClick(() =&gt; {
        const dialog = new BaseDialog(this.getUIContext())
        dialog.setContentView(wrapBuilder(dialogView), new ComponentParam('自定义参数'))
        dialog.show()

        setTimeout(() =&gt; {
          //模拟触发某个状态
          //给弹窗视图发送事件并获取返回值
          const result = dialog.sendEvent('key', '自定义数据')
        }, 2000)
      })
    }
    .height('100%')
    .width('100%')
  }
}

@Builder
function dialogView(param: ComponentParam&lt;string&gt;) {
  DialogView({ param: param })
}
</code></pre>
<pre><code class="hljs language-text" lang="text">@ComponentV2
struct DialogView {
  @Param param: ComponentParam&lt;string&gt; = new ComponentParam('')

  aboutToAppear(): void {
    //注册事件，接收dialog发送的事件
    this.param.addEvent&lt;string&gt;('key', (data) =&gt; {
      //获取事件传的参数
      const result = data
      return '返回值'
    })
  }

  build() {
  }
}
</code></pre>
<blockquote>
<p>场景4：页面出现多个运营活动弹窗，产品要求出现多个弹窗的场景，上一个弹窗消失时，下一个弹窗才能出现，不能同时显示</p>
</blockquote>
<pre><code class="hljs language-text" lang="text">import { BaseDialog, ComponentParam, DialogManager } from '@zhongrui/easy_dialog'

@Entry
@Component
struct Page {
  build() {
    Column() {
      Button('显示弹窗').onClick(() =&gt; {
        const dialog1 = new BaseDialog(this.getUIContext())
        dialog1.setContentView(wrapBuilder(dialogView), new ComponentParam('第1个弹窗'))

        const dialog2 = new BaseDialog(this.getUIContext())
        dialog2.setContentView(wrapBuilder(dialogView), new ComponentParam('第2个弹窗'))

        const dialog3 = new BaseDialog(this.getUIContext())
        dialog3.setContentView(wrapBuilder(dialogView), new ComponentParam('第3个弹窗'))

        DialogManager.get('def').show(dialog1)
        DialogManager.get('def').show(dialog2)
        DialogManager.get('def').show(dialog3)
        //或者
        DialogManager.get('def').addDialog(dialog1)
        DialogManager.get('def').addDialog(dialog2)
        DialogManager.get('def').addDialog(dialog3)
        DialogManager.get('def').show()
      })
    }
    .height('100%')
    .width('100%')
  }
}

@Builder
function dialogView(param: ComponentParam&lt;string&gt;) {
  DialogView({ param: param })
}
</code></pre>
<pre><code class="hljs language-text" lang="text">@ComponentV2
struct DialogView {
  @Param param: ComponentParam&lt;string&gt; = new ComponentParam('')

  build() {
    Button('取消弹窗').onClick(() =&gt; {
      this.param.dismissAndShowNext()
    })
  }
}
</code></pre>
<h2 data-id="heading-3">实际项目用法</h2>
<blockquote>
<p>1：新建一个普通类比如LoginDialog，继承BaseDialog或BaseOverlay或BaseSheet<br/>
2：创建一个静态方法对外提供，哪个页面需要显示弹窗，调用静态方法即可，页面不用关心弹窗的创建逻辑以及弹窗内部交互逻辑<br/>
3：@Builder装饰的function方法定义在LoginDialog文件里面<br/>
4：遇到复杂的业务场景，部分业务逻辑在LoginDialog类中单独闭环与外部页面完全解耦</p>
</blockquote>
<h3 data-id="heading-4">页面</h3>
<pre><code class="hljs language-text" lang="text">import { LoginDialog, LoginResult } from '../test/LoginDialog'

@Entry
@Component
struct Page {
  build() {
    Column() {
      Button('显示登录弹窗').onClick(() =&gt; {
        LoginDialog.showDialog(this.getUIContext(), '156xxx8888', (result: LoginResult) =&gt; {
          //获取登录结果
        })
      })
    }
    .height('100%')
    .width('100%')
  }
}
</code></pre>
<h3 data-id="heading-5">LoginDialog类</h3>
<pre><code class="hljs language-text" lang="text">import { BaseDialog, ComponentParam } from '@zhongrui/easy_dialog';
import { LoginDialogView } from './LoginDialogView';

export interface LoginParam {
  phone: string
}

export interface LoginResult {
  phone: string
  userName: string
  pwd: string
}

@Builder
function dialogView(param: ComponentParam&lt;LoginParam&gt;) {
  LoginDialogView({ param: param })
}

export class LoginDialog extends BaseDialog {
  public static showDialog(uiContext: UIContext, phone: string,
    loginSuccess: (data: LoginResult) =&gt; void): LoginDialog {
    //构造业务参数
    const data: ComponentParam&lt;LoginParam&gt; = new ComponentParam&lt;LoginParam&gt;({ phone: phone })
    //创建弹窗
    const dialog = new LoginDialog(uiContext)
    //设置视图
    dialog.setContentView(wrapBuilder(dialogView), data)
    //设置弹窗参数promptAction.BaseDialogOptions（和官网文档一致）
    //maskRect,alignment,offset,isModal,showInSubWindow,onWillDismiss,autoCancel
    //maskColor,transition,dialogTransition等
    dialog.setOption({})
    //设置tag
    dialog.addTag('key', '自定义参数')
    //注册登录成功事件
    dialog.addEvent&lt;LoginResult&gt;('success', (data: LoginResult | undefined) =&gt; {
      if (!data) {
        return
      }
      loginSuccess?.(data)
    })
    //显示弹窗
    dialog.show()
    return dialog
  }

  //可以定义其他方法根据实际场景处理一些额外的业务逻辑
  public otherMethod() {
    this.addTag('key', 'value')
  }
}
</code></pre>
<h3 data-id="heading-6">LoginDialog视图</h3>
<pre><code class="hljs language-text" lang="text">import { ComponentParam } from '@zhongrui/easy_dialog'
import { LoginParam, LoginResult } from './LoginDialog'

@ComponentV2
export struct LoginDialogView {
  @Param param: ComponentParam&lt;LoginParam&gt; = new ComponentParam&lt;LoginParam&gt;({ phone: '' })
  @Local phone: string = ''

  aboutToAppear(): void {
    this.phone = this.param.data.phone
    //可以获取其他参数
    this.param.getTag('key')
  }

  build() {
    Column() {
      Text("手机号：" + this.phone)
      Button('登录').onClick(() =&gt; {
        //登录成功
        const result: LoginResult = {
          phone: this.phone,
          userName: 'Harmony',
          pwd: 'OpenHarmony'
        }
        //发送登录成功事件
        this.param.sendEvent('success', result)
        //隐藏弹窗
        this.param.dismiss()
      })
    }
  }
}
</code></pre>
<h2 data-id="heading-7">进阶用法</h2>
<h3 data-id="heading-8">公共部分</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">//除了构造函数能设置业务参数，也可以通过setData设置，支持各种类型</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">data</span>: <span class="hljs-title class_">ComponentParam</span>&lt;<span class="hljs-built_in">string</span>&gt; = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ComponentParam</span>(<span class="hljs-string">'自定义参数'</span>)
data.<span class="hljs-title function_">setData</span>(<span class="hljs-string">'xxx'</span>)

<span class="hljs-comment">//Dialog(自定义弹窗)</span>
<span class="hljs-keyword">let</span> <span class="hljs-attr">dialog</span>: <span class="hljs-title class_">AbsDialog</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BaseDialog</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>())
<span class="hljs-comment">//Overlay(浮层)</span>
dialog = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BaseOverlay</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>())
<span class="hljs-comment">//bindSheet(半模态弹窗)</span>
dialog = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BaseSheet</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>(), <span class="hljs-string">'contentId'</span>)

<span class="hljs-comment">//Dialog(自定义弹窗)设置绑定的组件id</span>
<span class="hljs-comment">//虽然不设置也可以，但是后续Navigation跳转的页面都会被弹窗覆盖，根据实际场景调用即可</span>
dialog.<span class="hljs-title function_">setComponentId</span>(<span class="hljs-string">'contentId'</span>)

<span class="hljs-comment">//(和官方文档一致)设置实例化ComponentContent的参数，所以setBuildOption必须在setContentView之前调用</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">buildOption</span>: <span class="hljs-title class_">BuildOptions</span> = {}
dialog.<span class="hljs-title function_">setBuildOption</span>(buildOption)

<span class="hljs-comment">//设置弹窗视图</span>
dialog.<span class="hljs-title function_">setContentView</span>(<span class="hljs-title function_">wrapBuilder</span>(dialogView), data)

<span class="hljs-comment">//注册事件，接收视图发送的事件，获取事件参数的同时，支持设置返回值</span>
dialog.<span class="hljs-property">addEvent</span>&lt;<span class="hljs-built_in">number</span>&gt;(<span class="hljs-string">'key'</span>, <span class="hljs-function">(<span class="hljs-params">result: <span class="hljs-built_in">number</span> | <span class="hljs-literal">undefined</span></span>) =&gt;</span> {
  <span class="hljs-keyword">return</span> <span class="hljs-number">123</span>
})
dialog.<span class="hljs-property">addEvent</span>&lt;<span class="hljs-built_in">string</span>&gt;(<span class="hljs-string">'key'</span>, <span class="hljs-function">(<span class="hljs-params">result: <span class="hljs-built_in">string</span> | <span class="hljs-literal">undefined</span></span>) =&gt;</span> {
})
<span class="hljs-comment">//删除单个事件</span>
dialog.<span class="hljs-title function_">deleteEvent</span>(<span class="hljs-string">'key'</span>)

<span class="hljs-comment">//给组件视图发送事件(不是dialog.addEvent注册的事件)并获取事件的返回值</span>
<span class="hljs-keyword">const</span> result1 = dialog.<span class="hljs-title function_">sendEvent</span>(<span class="hljs-string">'key'</span>)
<span class="hljs-keyword">const</span> result2 = dialog.<span class="hljs-title function_">sendEvent</span>(<span class="hljs-string">'key'</span>, <span class="hljs-string">'自定义类型参数'</span>)

<span class="hljs-comment">//清除Dialog注册的所有事件</span>
dialog.<span class="hljs-title function_">clearDialogRegisterEvent</span>()

<span class="hljs-comment">//清除视图注册的所有事件</span>
dialog.<span class="hljs-title function_">clearComponentRegisterEvent</span>()

<span class="hljs-comment">//清除Dialog注册的事件+当前组件注册的事件</span>
dialog.<span class="hljs-title function_">clearAllEvent</span>()

<span class="hljs-comment">//设置tag，在dialog和组件视图中都可以通过getTag可以获取</span>
dialog.<span class="hljs-title function_">setTag</span>(<span class="hljs-string">'xxx'</span>)

<span class="hljs-comment">//添加tag，支持各种类型，在dialog和组件视图中都可以通过getTag(key)可以获取</span>
dialog.<span class="hljs-title function_">addTag</span>(<span class="hljs-string">'key'</span>, <span class="hljs-string">'value'</span>)

<span class="hljs-comment">//获取tag，不传key获取setTag('xxx')的值，传key获取addTag('key', 'value')的值</span>
<span class="hljs-comment">//在dialog和组件视图中都可以获取</span>
dialog.<span class="hljs-title function_">getTag</span>(<span class="hljs-string">'key'</span>)

<span class="hljs-comment">//删除tag</span>
dialog.<span class="hljs-title function_">deleteTag</span>(<span class="hljs-string">'key'</span>)

<span class="hljs-comment">//清除tag，true:清除所有tag，false:只清除addTag('key', 'value')的值,不清除setTag('xxx')的值</span>
dialog.<span class="hljs-title function_">clearTag</span>(<span class="hljs-literal">true</span>)

<span class="hljs-comment">//显示弹窗</span>
dialog.<span class="hljs-title function_">show</span>()

<span class="hljs-comment">//隐藏弹窗，下次直接调用show方法即可再次显示</span>
dialog.<span class="hljs-title function_">hide</span>()

<span class="hljs-comment">//销毁弹窗，下次显示必须重新实例化</span>
dialog.<span class="hljs-title function_">dismiss</span>()

<span class="hljs-comment">//隐藏弹窗/浮层/sheet，显示下一个(用于有序弹窗/浮层/sheet)</span>
dialog.<span class="hljs-title function_">hideAndShowNext</span>()

<span class="hljs-comment">//隐藏并销毁弹窗/浮层/sheet，显示下一个(用于有序弹窗/浮层/sheet)</span>
dialog.<span class="hljs-title function_">dismissAndShowNext</span>()

<span class="hljs-comment">//判断弹窗是否显示</span>
dialog.<span class="hljs-title function_">isShowing</span>()

<span class="hljs-comment">//判断弹窗是否隐藏</span>
dialog.<span class="hljs-title function_">isHide</span>()

<span class="hljs-comment">//判断弹窗是否销毁</span>
dialog.<span class="hljs-title function_">isDismiss</span>()

<span class="hljs-comment">//(和官方文档一致)用于更新WrappedBuilder对象封装的builder函数参数，与constructor传入的参数类型保持一致</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">newData</span>: <span class="hljs-title class_">ComponentParam</span>&lt;<span class="hljs-built_in">string</span>&gt; = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ComponentParam</span>(<span class="hljs-string">'自定义参数'</span>)
dialog.<span class="hljs-title function_">update</span>(newData)

<span class="hljs-comment">//触发ComponentContent中的自定义组件的复用</span>
dialog.<span class="hljs-title function_">reuse</span>()

<span class="hljs-comment">//触发ComponentContent中自定义组件的回收</span>
dialog.<span class="hljs-title function_">recycle</span>()

<span class="hljs-comment">//传递系统环境变化事件，触发节点的全量更新</span>
dialog.<span class="hljs-title function_">updateConfiguration</span>()
</code></pre>
<h3 data-id="heading-9">组件视图</h3>
<pre><code class="hljs language-txt" lang="txt">import { ComponentParam } from '@zhongrui/easy_dialog'

@ComponentV2
export struct DialogView {
  //固定写法
  @Param param: ComponentParam&lt;string&gt; = new ComponentParam('')
  @Local title: string = ''

  aboutToAppear(): void {
    //获取参数
    this.title = this.param.data
    
    //注册接收Dialog发送的事件
    this.param.addEvent&lt;string&gt;('key', (result: string | undefined) =&gt; {
      return 'xxx'
    })
    this.param.addEvent&lt;number&gt;('key', () =&gt; {
    })
    
    //删除注册的事件
    this.param.deleteEvent('key')
    
    //给Dialog发送事件并获取返回值
    const result1 = this.param.sendEvent('key')
    const result2 = this.param.sendEvent('key', 'xxx')

    //隐藏弹窗/浮层/sheet
    this.param.hide()
    
    //隐藏并销毁弹窗/浮层/sheet
    this.param.dismiss()
    
    //隐藏弹窗/浮层/sheet，显示下一个(用于有序弹窗/浮层/sheet)
    this.param.hideAndShowNext()
    
    //隐藏并销毁弹窗/浮层/sheet，显示下一个(用于有序弹窗/浮层/sheet)
    this.param.dismissAndShowNext()

    //设置tag，在dialog和组件视图中都可以通过getTag可以获取
    this.param.setTag('xxx')

    //添加tag，支持各种类型，在dialog和组件视图中都可以通过getTag(key)可以获取
    this.param.addTag('key', 'value')

    //获取tag，不传key获取setTag('xxx')的值，传key获取addTag('key', 'value')的值
    //在dialog和组件视图中都可以获取
    this.param.getTag('key')

    //删除tag
    this.param.deleteTag('key')

    //清除tag，true:清除所有tag，false:只清除addTag('key', 'value')的值,不清除setTag('xxx')的值
    this.param.clearTag(true)

    //清除Dialog注册的事件
    this.param.clearDialogRegisterEvent()
    
    //清除当前组件注册的事件
    this.param.clearComponentRegisterEvent()
    
    //清除Dialog注册的事件+当前组件注册的事件
    this.param.clearAllEvent()

  }

  build() {
    Text(this.title)
  }
}
</code></pre>
<h2 data-id="heading-10">差异部分</h2>
<h3 data-id="heading-11">Dialog(自定义弹窗)</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> <span class="hljs-attr">data</span>: <span class="hljs-title class_">ComponentParam</span>&lt;<span class="hljs-built_in">string</span>&gt; = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ComponentParam</span>(<span class="hljs-string">'自定义参数'</span>)
data.<span class="hljs-title function_">setData</span>(<span class="hljs-string">'xxx'</span>)

<span class="hljs-keyword">const</span> dialog = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BaseDialog</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>())
dialog.<span class="hljs-title function_">setContentView</span>(<span class="hljs-title function_">wrapBuilder</span>(dialogView), data)

<span class="hljs-comment">//(和官方文档一致)设置弹窗参数</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">options</span>: promptAction.<span class="hljs-property">BaseDialogOptions</span> = {}
dialog.<span class="hljs-title function_">setOption</span>(options)

<span class="hljs-comment">//(和官方文档一致)在弹窗显示的情况下可以更新弹窗参数</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">dialogOption</span>: promptAction.<span class="hljs-property">BaseDialogOptions</span> = {}
dialog.<span class="hljs-title function_">updateDialog</span>(dialogOption)

dialog.<span class="hljs-title function_">show</span>()
</code></pre>
<h3 data-id="heading-12">Overlay(浮层)</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> <span class="hljs-attr">data</span>: <span class="hljs-title class_">ComponentParam</span>&lt;<span class="hljs-built_in">string</span>&gt; = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ComponentParam</span>(<span class="hljs-string">'自定义参数'</span>)
data.<span class="hljs-title function_">setData</span>(<span class="hljs-string">'xxx'</span>)

<span class="hljs-keyword">const</span> dialog = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BaseOverlay</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>())
dialog.<span class="hljs-title function_">setContentView</span>(<span class="hljs-title function_">wrapBuilder</span>(dialogView), data)

<span class="hljs-comment">//(和官方文档一致)设置OverlayManager参数</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">options</span>: <span class="hljs-title class_">OverlayManagerOptions</span> = {}
dialog.<span class="hljs-title function_">setOverlayManagerOption</span>(options)

<span class="hljs-comment">//新增视图节点在OverlayManager上的层级位置，当index ≥ 0时，越大</span>
dialog.<span class="hljs-title function_">setIndex</span>(<span class="hljs-number">1</span>)

dialog.<span class="hljs-title function_">show</span>()
</code></pre>
<h3 data-id="heading-13">bindSheet(半模态弹窗)</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> <span class="hljs-attr">data</span>: <span class="hljs-title class_">ComponentParam</span>&lt;<span class="hljs-built_in">string</span>&gt; = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ComponentParam</span>(<span class="hljs-string">'自定义参数'</span>)
data.<span class="hljs-title function_">setData</span>(<span class="hljs-string">'xxx'</span>)

<span class="hljs-keyword">const</span> dialog = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BaseSheet</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>(), <span class="hljs-string">'contentId'</span>)
dialog.<span class="hljs-title function_">setContentView</span>(<span class="hljs-title function_">wrapBuilder</span>(dialogView), data)

<span class="hljs-comment">//(和官方文档一致)设置半模态参数</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">options</span>: <span class="hljs-title class_">SheetOptions</span> = {}
dialog.<span class="hljs-title function_">setSheetOption</span>(options)

dialog.<span class="hljs-title function_">show</span>()
</code></pre>
<h2 data-id="heading-14">历史文章</h2>
<p><a href="https://juejin.cn/post/7427050728719368202" target="_blank" title="https://juejin.cn/post/7427050728719368202"><strong>HarmonyOS NEXT多环境+多渠道+自定义路径输出+自定义名称一键打app和hap包</strong></a></p>
<p><a href="https://juejin.cn/post/7401358349877444642" target="_blank" title="https://juejin.cn/post/7401358349877444642"><strong>HarmonyOS NEXT一行代码实现任意处弹窗</strong></a></p>
<p><a href="https://juejin.cn/post/7397638569731358760" target="_blank" title="https://juejin.cn/post/7397638569731358760"><strong>HarmonyOS NEXT数据列表加载更多(无需监听列表滑到最底部)</strong></a></p>
<p><a href="https://juejin.cn/post/7395866502716702755" target="_blank" title="https://juejin.cn/post/7395866502716702755"><strong>HarmonyOS NEXT下拉刷新+上拉加载(纵向横向都支持)(v1+v2装饰器)</strong></a></p>
<p><a href="https://juejin.cn/post/7505633505980940297" target="_blank" title="https://juejin.cn/post/7505633505980940297"><strong>HarmonyOS NEXT图片压缩(支持fd,uri,网络图片,沙箱路径,base64,ArrayBuffer)</strong></a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[想让网页秒开？这些 CSS 优化方法帮你搞定]]></title>    <link>https://juejin.cn/post/7590961898398384166</link>    <guid>https://juejin.cn/post/7590961898398384166</guid>    <pubDate>2026-01-04T02:03:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590961898398384166" data-draft-id="7372393716092633139" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="想让网页秒开？这些 CSS 优化方法帮你搞定"/> <meta itemprop="keywords" content="前端,JavaScript,CSS"/> <meta itemprop="datePublished" content="2026-01-04T02:03:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Moment"/> <meta itemprop="url" content="https://juejin.cn/user/3782764966460398"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            想让网页秒开？这些 CSS 优化方法帮你搞定
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3782764966460398/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Moment
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-04T02:03:59.000Z" title="Sun Jan 04 2026 02:03:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><blockquote>
<p>我正在开发 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fxun082%2FDocFlow" target="_blank" title="https://github.com/xun082/DocFlow" ref="nofollow noopener noreferrer">DocFlow</a>，它是一个完整的 AI 全栈协同文档平台。该项目融合了多个技术栈，包括基于 <code>Tiptap</code> 的富文本编辑器、<code>NestJs</code> 后端服务、<code>AI</code> 集成功能和实时协作。在开发过程中，我积累了丰富的实战经验，涵盖了 <code>Tiptap</code> 的深度定制、性能优化和协作功能的实现等核心难点。</p>
</blockquote>
<p>如果你对 AI 全栈开发、Tiptap 富文本编辑器定制或 DocFlow 项目的完整技术方案感兴趣，欢迎加我微信 <code>yunmz777</code> 进行私聊咨询，获取详细的技术分享和最佳实践。</p>
<p>CSS 性能优化是前端开发中的重要一环，目的是提高页面加载速度和渲染性能，提供更好的用户体验。</p>
<p>接下来我们将讲解一些常见的案例。</p>
<h2 data-id="heading-0">减少 css 文件大小</h2>
<p>压缩 CSS 文件可以通过移除空白字符、注释和冗余代码来减少文件大小，从而提高加载速度。常用工具有 cssnano 和 clean-css。</p>
<p>使用 cssnano 压缩 CSS 文件：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> cssnano = <span class="hljs-built_in">require</span>(<span class="hljs-string">"cssnano"</span>);
<span class="hljs-keyword">const</span> postcss = <span class="hljs-built_in">require</span>(<span class="hljs-string">"postcss"</span>);
<span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">"fs"</span>);

fs.<span class="hljs-title function_">readFile</span>(<span class="hljs-string">"./style.css"</span>, <span class="hljs-function">(<span class="hljs-params">err, css</span>) =&gt;</span> {
  <span class="hljs-title function_">postcss</span>([cssnano])
    .<span class="hljs-title function_">process</span>(css, { <span class="hljs-attr">from</span>: <span class="hljs-string">"style.css"</span>, <span class="hljs-attr">to</span>: <span class="hljs-string">"styles.min.css"</span> })
    .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">result</span>) =&gt;</span> {
      fs.<span class="hljs-title function_">writeFile</span>(<span class="hljs-string">"styles.min.css"</span>, result.<span class="hljs-property">css</span>, <span class="hljs-function">() =&gt;</span> <span class="hljs-literal">true</span>);
    });
});
</code></pre>
<p>最终输出结果如下图所示：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/753a0a65f414496c9d001d3a7f29a6bc~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1637&amp;h=577&amp;s=57796&amp;e=png&amp;b=202020" alt="20240524112942" loading="lazy"/></p>
<p>style.css 文件会被压缩到 styles.min.css。</p>
<h2 data-id="heading-1">删除未使用的 CSS</h2>
<p>通过工具（如 PurgeCSS、UnCSS）扫描 HTML 和 JS 文件，删除未使用的 CSS 规则，减少不必要的样式，提高性能。</p>
<p>使用 PurgeCSS 删除未使用的 CSS：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> <span class="hljs-title class_">PurgeCSS</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">"purgecss"</span>).<span class="hljs-property">PurgeCSS</span>;
<span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">"fs"</span>);

<span class="hljs-keyword">new</span> <span class="hljs-title class_">PurgeCSS</span>()
  .<span class="hljs-title function_">purge</span>({
    <span class="hljs-attr">content</span>: [<span class="hljs-string">"*.html"</span>],
    <span class="hljs-attr">css</span>: [<span class="hljs-string">"styles.css"</span>],
  })
  .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">result</span>) =&gt;</span> {
    <span class="hljs-comment">// 保存优化后的 CSS 文件</span>
    fs.<span class="hljs-title function_">writeFile</span>(<span class="hljs-string">"./styles.purged.css"</span>, result[<span class="hljs-number">0</span>].<span class="hljs-property">css</span>, <span class="hljs-function">() =&gt;</span> <span class="hljs-literal">true</span>);
  });
</code></pre>
<p>代码执行完成之后，只有在使用的 css 规则才会被应用，其余的都会被删除掉，如下图所示：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/cbb4175eb7f0413ea39375223840e406~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1282&amp;h=710&amp;s=62226&amp;e=png&amp;b=1f1f1f" alt="20240524115043" loading="lazy"/></p>
<h2 data-id="heading-2">使用 CSS 预处理器</h2>
<p>使用 CSS 预处理器（如 Sass、Less、Stylus 等）可以为你的开发工作带来许多好处。以下是一些主要的优势和详细的解释：</p>
<h3 data-id="heading-3">变量</h3>
<p>在 CSS 预处理器中，你可以定义变量来存储重复使用的值（如颜色、字体大小、间距等）。这使得你的代码更加简洁和易于维护。</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-variable">$primary-color</span>: <span class="hljs-number">#3498db</span>;
<span class="hljs-variable">$font-size</span>: <span class="hljs-number">16px</span>;

<span class="hljs-selector-tag">body</span> {
  <span class="hljs-attribute">font-size</span>: <span class="hljs-variable">$font-size</span>;
  <span class="hljs-attribute">color</span>: <span class="hljs-variable">$primary-color</span>;
}
</code></pre>
<h3 data-id="heading-4">嵌套</h3>
<p>预处理器允许你嵌套 CSS 规则，这使得你的代码结构更加清晰，尤其是在处理复杂的选择器层次时。</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-selector-tag">nav</span> {
  <span class="hljs-selector-tag">ul</span> {
    <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span>;
    <span class="hljs-attribute">padding</span>: <span class="hljs-number">0</span>;
    <span class="hljs-attribute">list-style</span>: none;

    <span class="hljs-selector-tag">li</span> {
      <span class="hljs-attribute">display</span>: inline-block;
      <span class="hljs-selector-tag">a</span> {
        <span class="hljs-attribute">text-decoration</span>: none;
        <span class="hljs-attribute">color</span>: <span class="hljs-variable">$primary-color</span>;
      }
    }
  }
}
</code></pre>
<h3 data-id="heading-5">混合宏（Mixins）</h3>
<p>混合宏允许你定义一组样式，然后在其他地方重复使用。这对于实现可重用的响应式设计模式或其他复杂的样式非常有用。</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-keyword">@mixin</span> border-radius(<span class="hljs-variable">$radius</span>) {
  -webkit-<span class="hljs-attribute">border-radius</span>: <span class="hljs-variable">$radius</span>;
  -moz-<span class="hljs-attribute">border-radius</span>: <span class="hljs-variable">$radius</span>;
  -ms-<span class="hljs-attribute">border-radius</span>: <span class="hljs-variable">$radius</span>;
  <span class="hljs-attribute">border-radius</span>: <span class="hljs-variable">$radius</span>;
}

<span class="hljs-selector-class">.button</span> {
  <span class="hljs-keyword">@include</span> border-radius(<span class="hljs-number">5px</span>);
}
</code></pre>
<h3 data-id="heading-6">继承（Extend/Inherit）</h3>
<p>继承允许一个选择器继承另一个选择器的样式，从而减少代码重复，提高样式的可维护性。</p>
<pre><code class="hljs language-scss" lang="scss">%<span class="hljs-selector-tag">button</span>-styles {
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">10px</span> <span class="hljs-number">20px</span>;
  <span class="hljs-attribute">font-size</span>: <span class="hljs-number">16px</span>;
  <span class="hljs-attribute">color</span>: <span class="hljs-number">#fff</span>;
  <span class="hljs-attribute">background-color</span>: <span class="hljs-variable">$primary-color</span>;
}

<span class="hljs-selector-class">.button</span> {
  <span class="hljs-keyword">@extend</span> %button-styles;
}

<span class="hljs-selector-class">.alert-button</span> {
  <span class="hljs-keyword">@extend</span> %button-styles;
  <span class="hljs-attribute">background-color</span>: red;
}
</code></pre>
<h3 data-id="heading-7">运算</h3>
<p>你可以在 CSS 中进行数学运算，这对于动态计算宽度、高度、间距等非常有用。</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-selector-class">.container</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span> - <span class="hljs-number">20px</span>; <span class="hljs-comment">// 计算结果</span>
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">10px</span> + <span class="hljs-number">5px</span>; <span class="hljs-comment">// 计算结果</span>
}
</code></pre>
<h3 data-id="heading-8">模块化</h3>
<p>预处理器通常支持将 CSS 分割成多个文件，然后在一个主文件中导入这些文件。这使得你的 CSS 代码更具可维护性和组织性。</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 在 main.scss 文件中</span>
<span class="hljs-keyword">@import</span> <span class="hljs-string">"variables"</span>;
<span class="hljs-keyword">@import</span> <span class="hljs-string">"mixins"</span>;
<span class="hljs-keyword">@import</span> <span class="hljs-string">"header"</span>;
<span class="hljs-keyword">@import</span> <span class="hljs-string">"footer"</span>;
</code></pre>
<h3 data-id="heading-9">条件语句和循环</h3>
<p>预处理器支持使用条件语句和循环，从而可以在 CSS 中实现更复杂的逻辑和模式。</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-keyword">@for</span> <span class="hljs-variable">$i</span> from <span class="hljs-number">1</span> through <span class="hljs-number">3</span> {
  <span class="hljs-selector-class">.col-</span>#{<span class="hljs-variable">$i</span>} {
    <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span> / <span class="hljs-number">3</span> * <span class="hljs-variable">$i</span>;
  }
}

<span class="hljs-keyword">@mixin</span> responsive(<span class="hljs-variable">$device</span>) {
  <span class="hljs-keyword">@if</span> <span class="hljs-variable">$device</span> == <span class="hljs-string">"mobile"</span> {
    <span class="hljs-keyword">@media</span> (<span class="hljs-attribute">max-width</span>: <span class="hljs-number">600px</span>) {
      <span class="hljs-keyword">@content</span>;
    }
  } <span class="hljs-keyword">@else</span> if <span class="hljs-variable">$device</span> == <span class="hljs-string">"tablet"</span> {
    <span class="hljs-keyword">@media</span> (<span class="hljs-attribute">max-width</span>: <span class="hljs-number">800px</span>) {
      <span class="hljs-keyword">@content</span>;
    }
  }
}

<span class="hljs-selector-class">.container</span> {
  <span class="hljs-keyword">@include</span> responsive(<span class="hljs-string">"mobile"</span>) {
    <span class="hljs-attribute">background-color</span>: blue;
  }
  <span class="hljs-keyword">@include</span> responsive(<span class="hljs-string">"tablet"</span>) {
    <span class="hljs-attribute">background-color</span>: green;
  }
}
</code></pre>
<h3 data-id="heading-10">自动前缀</h3>
<p>一些预处理器插件可以自动添加浏览器前缀，这样你就不需要手动添加各种浏览器前缀。</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// Sass 文件</span>
<span class="hljs-selector-class">.box</span> {
  <span class="hljs-attribute">display</span>: flex;
}

<span class="hljs-comment">// 编译后的 CSS 文件（使用 Autoprefixer 处理）</span>
<span class="hljs-selector-class">.box</span> {
  <span class="hljs-attribute">display</span>: -webkit-box;
  <span class="hljs-attribute">display</span>: -ms-flexbox;
  <span class="hljs-attribute">display</span>: flex;
}
</code></pre>
<p>使用 CSS 预处理器可以极大地提高开发效率和代码可维护性。通过引入变量、嵌套、混合宏、继承、运算、模块化、条件语句和循环等高级功能，预处理器使得编写和管理复杂的 CSS 变得更加轻松和高效。</p>
<h2 data-id="heading-11">优化选择器</h2>
<p>避免使用低效选择器，减少选择器层级嵌套，使用更高效的类选择器。</p>
<p>低效选择器：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-tag">div</span> &gt; <span class="hljs-selector-tag">ul</span> &gt; <span class="hljs-selector-tag">li</span><span class="hljs-selector-pseudo">:first</span>-child {
  <span class="hljs-attribute">color</span>: red;
}
</code></pre>
<p>高效选择器：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.item-first</span> {
  <span class="hljs-attribute">color</span>: red;
}
</code></pre>
<h2 data-id="heading-12">减少重绘和重排</h2>
<p>频繁更改 DOM 和样式会导致重绘和重排，影响性能。尽量批量更新样式。</p>
<pre><code class="hljs language-js" lang="js">element.<span class="hljs-property">style</span>.<span class="hljs-property">cssText</span> = <span class="hljs-string">"background-color: blue; width: 100px; height: 100px;"</span>;
</code></pre>
<h2 data-id="heading-13">延迟加载和异步加载</h2>
<p>延迟加载非关键 CSS 文件，提高关键渲染路径的性能。</p>
<p>异步加载 CSS：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">link</span>
  <span class="hljs-attr">rel</span>=<span class="hljs-string">"preload"</span>
  <span class="hljs-attr">href</span>=<span class="hljs-string">"styles.css"</span>
  <span class="hljs-attr">as</span>=<span class="hljs-string">"style"</span>
  <span class="hljs-attr">onload</span>=<span class="hljs-string">"this.onload=null;this.rel='stylesheet'"</span>
/&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">noscript</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"stylesheet"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"styles.css"</span> /&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">noscript</span>&gt;</span>
</code></pre>
<h2 data-id="heading-14">使用字体优化</h2>
<p>减少字体文件大小，使用适当的字体显示策略。</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-keyword">@font-face</span> {
  <span class="hljs-attribute">font-family</span>: <span class="hljs-string">"MyFont"</span>;
  <span class="hljs-attribute">src</span>: <span class="hljs-built_in">url</span>(<span class="hljs-string">"myfont.woff2"</span>) <span class="hljs-built_in">format</span>(<span class="hljs-string">"woff2"</span>);
  <span class="hljs-attribute">font-display</span>: swap;
}
</code></pre>
<h2 data-id="heading-15">浏览器缓存</h2>
<p>通过设置缓存头和版本控制，提高 CSS 文件的加载速度。</p>
<p>在服务器上配置适当的缓存头，允许浏览器缓存 CSS 文件。例如，使用 Apache 服务器，可以在 .htaccess 文件中添加以下内容：</p>
<pre><code class="hljs language-apache" lang="apache">&lt;FilesMatch "\.(css|js)$"&gt;
  Header set Cache-Control "max-age=31536000, public"
&lt;/FilesMatch&gt;
</code></pre>
<p>通过文件名中包含版本号（如 style.v1.css）来控制缓存，确保更新后的 CSS 文件被重新加载。</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"stylesheet"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"styles.v1.css"</span> /&gt;</span>
</code></pre>
<h2 data-id="heading-16">总结</h2>
<p>通过以上这些优化方法和工具，我们可以显著提升 css 的性能，改善网页的加载和渲染速度，提供更流畅的用户体验。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[（ 教学 ）Agent 构建 Memory（提示词对话存储）3. ConversationTokenBufferMemory(根据“令牌长度”刷新对话内容, 版]]></title>    <link>https://juejin.cn/post/7590699877630476326</link>    <guid>https://juejin.cn/post/7590699877630476326</guid>    <pubDate>2026-01-03T12:48:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590699877630476326" data-draft-id="7590608345923256346" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="（ 教学 ）Agent 构建 Memory（提示词对话存储）3. ConversationTokenBufferMemory(根据“令牌长度”刷新对话内容, 版"/> <meta itemprop="keywords" content="Agent,LangChain"/> <meta itemprop="datePublished" content="2026-01-03T12:48:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="RedTiemr"/> <meta itemprop="url" content="https://juejin.cn/user/2140104538466522"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            （ 教学 ）Agent 构建 Memory（提示词对话存储）3. ConversationTokenBufferMemory(根据“令牌长度”刷新对话内容, 版
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2140104538466522/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    RedTiemr
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-03T12:48:10.000Z" title="Sat Jan 03 2026 12:48:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">（ 教学 ）Agent 构建 Memory（提示词对话存储）3. ConversationTokenBufferMemory(根据“令牌长度”刷新对话内容, 版本&gt;1.0和&lt;1.0的区别)</h2>
<p>“ConversationTokenBufferMemory”会将近期的对话历史记录存储在缓冲存储器中，并根据“令牌长度”而非对话数量来决定何时刷新对话内容。
关键参数：</p>
<ul>
<li><code>max_token_limit</code>： 设定用于存储对话内容的最大令牌长度</li>
<li><code>return_messages</code>： 当为 True 时，将以聊天格式返回消息。当为 False 时，返回字符串</li>
<li><code>human_prefix</code>： 在人类消息前添加的前缀（默认值："Human"）</li>
<li><code>ai_prefix</code>： 在 AI 消息前添加的前缀（默认值："AI"）</li>
</ul>
<h3 data-id="heading-1">该类，是之前的版本1.0以前的，版本1.0以后的。我会列出两个版本的使用方式和特点。</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_classic.memory <span class="hljs-keyword">import</span> ConversationTokenBufferMemory
<span class="hljs-keyword">from</span> langchain_openai <span class="hljs-keyword">import</span> ChatOpenAI


<span class="hljs-keyword">from</span> dotenv <span class="hljs-keyword">import</span> load_dotenv
<span class="hljs-keyword">import</span> os
<span class="hljs-keyword">from</span> langchain_openai <span class="hljs-keyword">import</span> ChatOpenAI
<span class="hljs-keyword">from</span> langchain_core.prompts <span class="hljs-keyword">import</span> PromptTemplate
load_dotenv()
<span class="hljs-comment"># 创建ChatOpenAI对象，配置为使用硅基流动API</span>
Qwen2_5_7B_Instruct_llm = ChatOpenAI(
    temperature=<span class="hljs-number">0.1</span>,  <span class="hljs-comment"># 控制输出的随机性和创造性，值越低输出越稳定可预测，值越高输出越有创意但可能偏离预期 (范围: 0.0 ~ 2.0)</span>
    model_name=<span class="hljs-string">"Qwen/Qwen2.5-7B-Instruct"</span>,  <span class="hljs-comment"># 硅基流动支持的模型名称</span>
    openai_api_key=os.getenv(<span class="hljs-string">"SILICONFLOW_API_KEY"</span>),  <span class="hljs-comment"># 从环境变量获取API密钥</span>
    openai_api_base=<span class="hljs-string">"https://api.siliconflow.cn/v1"</span>  <span class="hljs-comment"># 硅基流动API的基础URL</span>
)

<span class="hljs-comment"># Configure memory</span>
memory = ConversationTokenBufferMemory(
    llm=Qwen2_5_7B_Instruct_llm,
    max_token_limit=<span class="hljs-number">50</span>,
    return_messages=<span class="hljs-literal">True</span>,  <span class="hljs-comment"># Limit maximum token length to 50</span>
)

<span class="hljs-comment"># 添加任意对话</span>
memory.save_context(
    inputs={
        <span class="hljs-string">"human"</span>: <span class="hljs-string">"您好，我最近从贵公司购买了一台机床。请问如何安装？"</span>
    },
    outputs={
        <span class="hljs-string">"ai"</span>: <span class="hljs-string">"您好！感谢您的购买。请问您能告诉我机器的型号吗？"</span>
    },
)
memory.save_context(
    inputs={<span class="hljs-string">"human"</span>: <span class="hljs-string">"是的，型号是XG-200。"</span>},
    outputs={
        <span class="hljs-string">"ai"</span>: <span class="hljs-string">"谢谢。我来为您介绍XG-200型号的安装指南。首先，请检查安装地点的供电状态。这台机器需要220V电源。"</span>
    },
)
memory.save_context(
    inputs={<span class="hljs-string">"human"</span>: <span class="hljs-string">"我已经检查了电源。下一步该怎么做？"</span>},
    outputs={
        <span class="hljs-string">"ai"</span>: <span class="hljs-string">"很好。接下来，请将机器放置在平整稳固的表面上。然后，按照用户手册的说明进行线缆连接。"</span>
    },
)
memory.save_context(
    inputs={<span class="hljs-string">"human"</span>: <span class="hljs-string">"如何进行连接？"</span>},
    outputs={
        <span class="hljs-string">"ai"</span>: <span class="hljs-string">"请参考说明书第5页。那里有详细的线缆连接说明。如果您在这个过程中遇到任何困难，我很乐意为您提供进一步的帮助。"</span>
    },
)
memory.save_context(
    inputs={<span class="hljs-string">"human"</span>: <span class="hljs-string">"安装完成后我该做什么？"</span>},
    outputs={
        <span class="hljs-string">"ai"</span>: <span class="hljs-string">"安装完成后，请打开电源并进行初始运行测试。测试程序在说明书第10页有详细说明。如果机器有任何问题或者您需要额外支持，请随时与我们联系。"</span>
    },
)
memory.save_context(
    inputs={<span class="hljs-string">"human"</span>: <span class="hljs-string">"谢谢，这些信息对我很有帮助！"</span>},
    outputs={
        <span class="hljs-string">"ai"</span>: <span class="hljs-string">"我们随时准备为您提供帮助。如果您还有任何问题或需要支持，请随时询问。祝您使用愉快！"</span>
    },
)
</code></pre>
<p>打印memory中的对话内容</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-built_in">print</span>(memory.load_memory_variables({})[<span class="hljs-string">"history"</span>])
</code></pre>
<blockquote>
<p>[HumanMessage(content='您好，我最近从贵公司购买了一台机床。请问如何安装？', additional_kwargs={}, response_metadata={}),
AIMessage(content='您好！感谢您的购买。请问您能告诉我机器的型号吗？', additional_kwargs={}, response_metadata={}),
HumanMessage(content='您好，我最近从贵公司购买了一台机床。请问如何安装？', additional_kwargs={}, response_metadata={}),
AIMessage(content='您好！感谢您的购买。请问您能告诉我机器的型号吗？', additional_kwargs={}, response_metadata={})]</p>
</blockquote>
<h3 data-id="heading-2">使用最新版本逻辑实现</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langgraph.checkpoint.memory <span class="hljs-keyword">import</span> MemorySaver
<span class="hljs-keyword">from</span> langgraph.graph <span class="hljs-keyword">import</span> MessagesState, START, StateGraph
<span class="hljs-keyword">from</span> langchain_openai <span class="hljs-keyword">import</span> ChatOpenAI
<span class="hljs-keyword">from</span> langchain_core.messages <span class="hljs-keyword">import</span> HumanMessage, AIMessage
<span class="hljs-keyword">from</span> tiktoken <span class="hljs-keyword">import</span> get_encoding

checkpointer = MemorySaver()
model =  ChatOpenAI(
    temperature=<span class="hljs-number">0.1</span>,  <span class="hljs-comment"># 控制输出的随机性和创造性，值越低输出越稳定可预测，值越高输出越有创意但可能偏离预期 (范围: 0.0 ~ 2.0)</span>
    model_name=<span class="hljs-string">"Qwen/Qwen2.5-7B-Instruct"</span>,  <span class="hljs-comment"># 硅基流动支持的模型名称</span>
    openai_api_key=os.getenv(<span class="hljs-string">"SILICONFLOW_API_KEY"</span>),  <span class="hljs-comment"># 从环境变量获取API密钥</span>
    openai_api_base=<span class="hljs-string">"https://api.siliconflow.cn/v1"</span>  <span class="hljs-comment"># 硅基流动API的基础URL</span>
)

tokenizer = get_encoding(<span class="hljs-string">"cl100k_base"</span>)  <span class="hljs-comment"># tokenizer</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">chat_with_token_window</span>(<span class="hljs-params">state: MessagesState</span>):
    <span class="hljs-string">"""基于 token 限制的记忆管理（最大 2000 tokens）"""</span>
    messages = state[<span class="hljs-string">"messages"</span>]
    max_tokens = <span class="hljs-number">2000</span>
    
    <span class="hljs-comment"># 计算当前 token 总数</span>
    total_tokens = <span class="hljs-built_in">sum</span>(<span class="hljs-built_in">len</span>(tokenizer.encode(msg.content)) <span class="hljs-keyword">for</span> msg <span class="hljs-keyword">in</span> messages)
    
    <span class="hljs-comment"># 逐步移除最早消息直到符合 token 限制</span>
    <span class="hljs-keyword">while</span> total_tokens &gt; max_tokens <span class="hljs-keyword">and</span> <span class="hljs-built_in">len</span>(messages) &gt; <span class="hljs-number">1</span>:
        messages.pop(<span class="hljs-number">0</span>)
        total_tokens = <span class="hljs-built_in">sum</span>(<span class="hljs-built_in">len</span>(tokenizer.encode(msg.content)) <span class="hljs-keyword">for</span> msg <span class="hljs-keyword">in</span> messages)
    
    response = model.invoke(messages)
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"messages"</span>: [response]}

<span class="hljs-comment"># 构建图</span>
builder = StateGraph(state_schema=MessagesState)
builder.add_node(<span class="hljs-string">"chat"</span>, chat_with_token_window)
builder.add_edge(START, <span class="hljs-string">"chat"</span>)
graph = builder.<span class="hljs-built_in">compile</span>(checkpointer=checkpointer)

config = {<span class="hljs-string">"configurable"</span>: {<span class="hljs-string">"thread_id"</span>: <span class="hljs-string">"user-1"</span>}}

<span class="hljs-comment"># 测试长对话（会自动截断）</span>
long_dialogue = [
    <span class="hljs-string">"这是很长的第一条消息，包含很多内容..."</span> * <span class="hljs-number">10</span>,
    <span class="hljs-string">"第二条也很长..."</span> * <span class="hljs-number">8</span>,
    <span class="hljs-string">"第三条消息，问我的名字是什么？"</span>
]

<span class="hljs-keyword">for</span> msg <span class="hljs-keyword">in</span> long_dialogue:
    result = graph.invoke(
        {<span class="hljs-string">"messages"</span>: [HumanMessage(content=msg)]}, 
        config
    )
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"AI: <span class="hljs-subst">{result[<span class="hljs-string">'messages'</span>][-<span class="hljs-number">1</span>].content[:<span class="hljs-number">100</span>]}</span>..."</span>)
</code></pre>
<h4 data-id="heading-3">高级使用</h4>
<ul>
<li>自定义 token 计算： 您可以根据需要自定义 token 计算逻辑，例如考虑特殊字符或非英文文本。</li>
<li>动态调整 token 限制： 根据实际对话场景动态调整 token 限制，例如在用户问题复杂时增加限制。</li>
<li>结合其他记忆管理策略： 您可以将基于 token 长度的记忆管理与其他策略（如基于时间的记忆管理）结合使用，以获得更完善的对话管理。</li>
</ul>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">smart_token_memory</span>(<span class="hljs-params">state: MessagesState</span>):
    <span class="hljs-string">"""Token 窗口 + 智能总结"""</span>
    messages = state[<span class="hljs-string">"messages"</span>][:]
    max_tokens = <span class="hljs-number">1000</span>
    model = ChatOpenAI(
        temperature=<span class="hljs-number">0.1</span>,  <span class="hljs-comment"># 控制输出的随机性和创造性，值越低输出越稳定可预测，值越高输出越有创意但可能偏离预期 (范围: 0.0 ~ 2.0)</span>
        model_name=<span class="hljs-string">"Qwen/Qwen2.5-7B-Instruct"</span>,  <span class="hljs-comment"># 硅基流动支持的模型名称</span>
        openai_api_key=os.getenv(<span class="hljs-string">"SILICONFLOW_API_KEY"</span>),  <span class="hljs-comment"># 从环境变量获取API密钥</span>
        openai_api_base=<span class="hljs-string">"https://api.siliconflow.cn/v1"</span>  <span class="hljs-comment"># 硅基流动API的基础URL</span>
    )
    tokenizer = get_encoding(<span class="hljs-string">"cl100k_base"</span>)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">count_tokens</span>(<span class="hljs-params">msgs</span>):
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">sum</span>(<span class="hljs-built_in">len</span>(tokenizer.encode(m.content)) <span class="hljs-keyword">for</span> m <span class="hljs-keyword">in</span> msgs)
    
    <span class="hljs-comment"># 如果超过限制，先尝试总结早期对话</span>
    <span class="hljs-keyword">while</span> count_tokens(messages) &gt; max_tokens <span class="hljs-keyword">and</span> <span class="hljs-built_in">len</span>(messages) &gt; <span class="hljs-number">2</span>:
        <span class="hljs-comment"># 总结最早 50% 对话</span>
        mid_point = <span class="hljs-built_in">len</span>(messages) // <span class="hljs-number">2</span>
        early_msgs = messages[:mid_point]
        
        summary_prompt = <span class="hljs-string">f"总结以下对话（30字内）：<span class="hljs-subst">{<span class="hljs-string">' '</span>.join(m.content <span class="hljs-keyword">for</span> m <span class="hljs-keyword">in</span> early_msgs)}</span>"</span>
        summary = model.invoke([(<span class="hljs-string">"user"</span>, summary_prompt)])
        
        <span class="hljs-comment"># 用总结替换早期对话</span>
        messages = [AIMessage(content=<span class="hljs-string">f"总结：<span class="hljs-subst">{summary.content}</span>"</span>)] + messages[mid_point:]
    
    <span class="hljs-comment"># 最后精确截断</span>
    <span class="hljs-keyword">while</span> count_tokens(messages) &gt; max_tokens <span class="hljs-keyword">and</span> <span class="hljs-built_in">len</span>(messages) &gt; <span class="hljs-number">1</span>:
        messages.pop(<span class="hljs-number">0</span>)
    
    response = model.invoke(messages)
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"messages"</span>: [response]}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[使用 Selenium 模拟浏览器操作（完整实操指南）]]></title>    <link>https://juejin.cn/post/7590421489998250003</link>    <guid>https://juejin.cn/post/7590421489998250003</guid>    <pubDate>2026-01-03T13:40:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590421489998250003" data-draft-id="7590421489998233619" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="使用 Selenium 模拟浏览器操作（完整实操指南）"/> <meta itemprop="keywords" content="Python"/> <meta itemprop="datePublished" content="2026-01-03T13:40:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="刚哥的进化路"/> <meta itemprop="url" content="https://juejin.cn/user/71892859621675"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            使用 Selenium 模拟浏览器操作（完整实操指南）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/71892859621675/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    刚哥的进化路
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-03T13:40:39.000Z" title="Sat Jan 03 2026 13:40:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Selenium 核心价值在于<strong>模拟真实用户的浏览器操作行为</strong>，能够精准还原打开页面、输入文本、点击按钮、滚动页面等一系列操作，完美解决动态网页的数据爬取和自动化场景需求。本文将从实操角度出发，详细讲解 Selenium 模拟各类浏览器操作的核心方法，附带完整可运行代码。</p>
<h2 data-id="heading-0">一、前期准备（回顾必备）</h2>
<ol>
<li>已安装 Selenium 库：<code>pip install selenium -i https://pypi.doubanio.com/simple/</code></li>
<li>已配置对应浏览器驱动（ChromeDriver 优先，版本与浏览器大版本一致）</li>
<li>核心导入模块（后续示例默认包含以下导入）：</li>
</ol>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> selenium <span class="hljs-keyword">import</span> webdriver
<span class="hljs-keyword">from</span> selenium.webdriver.common.by <span class="hljs-keyword">import</span> By
<span class="hljs-keyword">from</span> selenium.webdriver.common.keys <span class="hljs-keyword">import</span> Keys
<span class="hljs-keyword">import</span> time
</code></pre>
<h2 data-id="heading-1">二、基础操作：初始化浏览器与访问网页</h2>
<p>这是模拟浏览器操作的第一步，完成浏览器的启动、配置与目标网页的访问。</p>
<h3 data-id="heading-2">1. 基础初始化（可视化模式）</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 1. 初始化 Chrome 浏览器驱动（启动浏览器）</span>
driver = webdriver.Chrome()

<span class="hljs-comment"># 2. 可选：最大化浏览器窗口（模拟用户正常使用习惯）</span>
driver.maximize_window()

<span class="hljs-comment"># 3. 访问目标网页（get 方法会等待页面初步加载完成）</span>
target_url = <span class="hljs-string">"https://www.baidu.com"</span>
driver.get(target_url)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"已成功访问：<span class="hljs-subst">{target_url}</span>，当前页面标题：<span class="hljs-subst">{driver.title}</span>"</span>)

<span class="hljs-comment"># 4. 可选：短暂延时，确保页面完全渲染（后续优先使用显式等待）</span>
time.sleep(<span class="hljs-number">2</span>)
</code></pre>
<h3 data-id="heading-3">2. 无界面模式（后台运行，不显示浏览器窗口）</h3>
<p>适合服务器运行或无需可视化的场景，节省系统资源：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 1. 构造 Chrome 配置对象</span>
chrome_options = webdriver.ChromeOptions()
<span class="hljs-comment"># 启用无界面模式（Selenium 4.x 推荐写法）</span>
chrome_options.add_argument(<span class="hljs-string">"--headless=new"</span>)
<span class="hljs-comment"># 禁用 GPU 加速，避免部分环境报错</span>
chrome_options.add_argument(<span class="hljs-string">"--disable-gpu"</span>)

<span class="hljs-comment"># 2. 传入配置初始化浏览器</span>
driver = webdriver.Chrome(options=chrome_options)
driver.get(<span class="hljs-string">"https://www.baidu.com"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"无界面模式：页面标题为 <span class="hljs-subst">{driver.title}</span>"</span>)
</code></pre>
<h2 data-id="heading-4">三、核心操作1：定位页面元素（操作的前提）</h2>
<p>模拟浏览器操作的核心是「先定位元素，再执行操作」，Selenium 提供了 6 种常用定位方式，其中 <strong>ID、XPath、CSS 选择器</strong> 最为实用，优先掌握。</p>








































<table><thead><tr><th>定位方式</th><th>语法（By.XXX）</th><th>适用场景</th></tr></thead><tbody><tr><td>ID 定位</td><td><code>By.ID</code></td><td>元素 ID 唯一（高效精准，优先使用）</td></tr><tr><td>XPath 定位</td><td><code>By.XPATH</code></td><td>万能灵活，可应对复杂页面（无唯一 ID/Class 时首选）</td></tr><tr><td>CSS 选择器</td><td><code>By.CSS_SELECTOR</code></td><td>高效，与前端开发语法一致</td></tr><tr><td>Name 定位</td><td><code>By.NAME</code></td><td>元素有唯一 name 属性</td></tr><tr><td>标签名定位</td><td><code>By.TAG_NAME</code></td><td>批量查找相同标签（如所有 <code>&lt;a&gt;</code> 标签）</td></tr><tr><td>链接文本定位</td><td><code>By.LINK_TEXT</code></td><td>精准匹配 <code>&lt;a&gt;</code> 标签的完整文本</td></tr></tbody></table>
<h3 data-id="heading-5">实操示例（以百度首页为例）</h3>
<pre><code class="hljs language-python" lang="python">driver = webdriver.Chrome()
driver.maximize_window()
driver.get(<span class="hljs-string">"https://www.baidu.com"</span>)
time.sleep(<span class="hljs-number">2</span>)

<span class="hljs-comment"># 1. ID 定位（百度搜索框 ID 为 "kw"）</span>
search_input = driver.find_element(By.ID, <span class="hljs-string">"kw"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"ID 定位成功："</span>, search_input.tag_name)

<span class="hljs-comment"># 2. XPath 定位（相对路径，容错性强）</span>
search_button = driver.find_element(By.XPATH, <span class="hljs-string">'//input[@id="su"]'</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"XPath 定位成功："</span>, search_button.tag_name)

<span class="hljs-comment"># 3. CSS 选择器定位（# 表示 ID，. 表示 Class）</span>
news_link = driver.find_element(By.CSS_SELECTOR, <span class="hljs-string">'a[href="https://news.baidu.com"]'</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"CSS 选择器定位成功："</span>, news_link.text)

driver.quit()
</code></pre>
<blockquote>
<p>说明：<code>driver.find_element()</code> 返回第一个匹配元素，<code>driver.find_elements()</code> 返回所有匹配元素列表（无匹配返回空列表）。</p>
</blockquote>
<h2 data-id="heading-6">四、核心操作2：模拟用户常用交互行为</h2>
<h3 data-id="heading-7">1. 输入与清空文本（如搜索框、登录输入框）</h3>
<p>使用 <code>send_keys()</code> 输入文本，<code>clear()</code> 清空输入框内容，是表单操作的核心方法。</p>
<pre><code class="hljs language-python" lang="python">driver = webdriver.Chrome()
driver.maximize_window()
driver.get(<span class="hljs-string">"https://www.baidu.com"</span>)
time.sleep(<span class="hljs-number">2</span>)

<span class="hljs-comment"># 1. 定位搜索框，输入关键词</span>
search_input = driver.find_element(By.ID, <span class="hljs-string">"kw"</span>)
search_input.send_keys(<span class="hljs-string">"Selenium 模拟浏览器操作"</span>)  <span class="hljs-comment"># 输入任意文本（支持中文）</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"已输入搜索关键词"</span>)
time.sleep(<span class="hljs-number">2</span>)

<span class="hljs-comment"># 2. 清空搜索框内容（可选）</span>
search_input.clear()
<span class="hljs-built_in">print</span>(<span class="hljs-string">"已清空搜索框"</span>)
time.sleep(<span class="hljs-number">1</span>)

<span class="hljs-comment"># 3. 重新输入并回车提交搜索（结合 Keys 类模拟键盘操作）</span>
search_input.send_keys(<span class="hljs-string">"Python 爬虫进阶"</span>)
search_input.send_keys(Keys.ENTER)  <span class="hljs-comment"># 模拟按下回车键</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"已提交搜索，等待结果加载"</span>)
time.sleep(<span class="hljs-number">3</span>)

driver.quit()
</code></pre>
<h3 data-id="heading-8">2. 模拟点击操作（按钮、链接、复选框等）</h3>
<p>使用 <code>click()</code> 方法模拟用户左键点击，支持所有可点击元素（按钮、<code>&lt;a&gt;</code> 标签、单选框等）。</p>
<pre><code class="hljs language-python" lang="python">driver = webdriver.Chrome()
driver.maximize_window()
driver.get(<span class="hljs-string">"https://www.baidu.com"</span>)
time.sleep(<span class="hljs-number">2</span>)

<span class="hljs-comment"># 1. 定位搜索框，输入关键词</span>
search_input = driver.find_element(By.ID, <span class="hljs-string">"kw"</span>)
search_input.send_keys(<span class="hljs-string">"Selenium 教程"</span>)

<span class="hljs-comment"># 2. 定位搜索按钮，模拟点击提交</span>
search_button = driver.find_element(By.ID, <span class="hljs-string">"su"</span>)
search_button.click()  <span class="hljs-comment"># 核心点击方法</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"点击搜索按钮，提交查询"</span>)
time.sleep(<span class="hljs-number">3</span>)

<span class="hljs-comment"># 3. 定位搜索结果中的链接，点击跳转</span>
first_result = driver.find_element(By.XPATH, <span class="hljs-string">'//div[@id="content_left"]//a[1]'</span>)
first_result.click()
<span class="hljs-built_in">print</span>(<span class="hljs-string">"点击第一条搜索结果，跳转新页面"</span>)
time.sleep(<span class="hljs-number">3</span>)

driver.quit()
</code></pre>
<h3 data-id="heading-9">3. 模拟页面滚动（应对滚动加载、查看更多内容）</h3>
<p>动态网页常需要滚动页面才能加载更多数据，Selenium 推荐使用 <code>execute_script()</code> 执行 JavaScript 脚本实现滚动，万能且稳定。</p>
<pre><code class="hljs language-python" lang="python">driver = webdriver.Chrome()
driver.maximize_window()
driver.get(<span class="hljs-string">"https://www.runoob.com/python/python-blog.html"</span>)
time.sleep(<span class="hljs-number">2</span>)

<span class="hljs-comment"># 1. 滚动到页面底部（获取完整动态数据）</span>
driver.execute_script(<span class="hljs-string">"window.scrollTo(0, document.body.scrollHeight);"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"已滚动到页面底部"</span>)
time.sleep(<span class="hljs-number">3</span>)

<span class="hljs-comment"># 2. 滚动到页面顶部</span>
driver.execute_script(<span class="hljs-string">"window.scrollTo(0, 0);"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"已滚动到页面顶部"</span>)
time.sleep(<span class="hljs-number">2</span>)

<span class="hljs-comment"># 3. 滚动到指定位置（横向 x=0，纵向 y=800 像素）</span>
driver.execute_script(<span class="hljs-string">"window.scrollTo(0, 800);"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"已滚动到页面 y=800 位置"</span>)
time.sleep(<span class="hljs-number">2</span>)

<span class="hljs-comment"># 4. 模拟逐页滚动（PageDown 键）</span>
driver.find_element(By.TAG_NAME, <span class="hljs-string">"body"</span>).send_keys(Keys.PAGE_DOWN)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"已向下滚动一页"</span>)
time.sleep(<span class="hljs-number">2</span>)

driver.quit()
</code></pre>
<h3 data-id="heading-10">4. 浏览器窗口辅助操作（刷新、前进、后退、关闭）</h3>
<p>模拟用户对浏览器窗口的常用操作，完善自动化流程：</p>
<pre><code class="hljs language-python" lang="python">driver = webdriver.Chrome()
driver.maximize_window()
driver.get(<span class="hljs-string">"https://www.baidu.com"</span>)
time.sleep(<span class="hljs-number">2</span>)

<span class="hljs-comment"># 1. 刷新当前页面</span>
driver.refresh()
<span class="hljs-built_in">print</span>(<span class="hljs-string">"已刷新页面"</span>)
time.sleep(<span class="hljs-number">2</span>)

<span class="hljs-comment"># 2. 访问新页面（为后续前进/后退做准备）</span>
driver.get(<span class="hljs-string">"https://www.runoob.com"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"已访问菜鸟教程"</span>)
time.sleep(<span class="hljs-number">2</span>)

<span class="hljs-comment"># 3. 后退到上一个页面（百度首页）</span>
driver.back()
<span class="hljs-built_in">print</span>(<span class="hljs-string">"已后退到百度首页"</span>)
time.sleep(<span class="hljs-number">2</span>)

<span class="hljs-comment"># 4. 前进到下一个页面（菜鸟教程）</span>
driver.forward()
<span class="hljs-built_in">print</span>(<span class="hljs-string">"已前进到菜鸟教程"</span>)
time.sleep(<span class="hljs-number">2</span>)

<span class="hljs-comment"># 5. 关闭浏览器（释放所有资源，推荐使用 quit() 而非 close()）</span>
<span class="hljs-comment"># driver.close()  # 关闭当前窗口（多窗口时适用）</span>
driver.quit()  <span class="hljs-comment"># 退出浏览器，释放所有资源</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"浏览器已关闭"</span>)
</code></pre>
<h2 data-id="heading-11">五、关键优化：等待元素加载（避免操作失败）</h2>
<p>动态网页存在加载延迟，直接执行操作可能会因元素未加载完成而抛出 <code>NoSuchElementException</code> 异常。Selenium 提供 3 种等待策略，<strong>显式等待</strong> 是最优选择。</p>
<h3 data-id="heading-12">1. 强制等待（最简单，不推荐）</h3>
<p>即 <code>time.sleep(seconds)</code>，固定延时，无论页面是否加载完成都等待，适合简单场景或临时调试。</p>
<pre><code class="hljs language-python" lang="python">driver.get(<span class="hljs-string">"https://www.baidu.com"</span>)
time.sleep(<span class="hljs-number">2</span>)  <span class="hljs-comment"># 固定等待 2 秒</span>
</code></pre>
<h3 data-id="heading-13">2. 隐式等待（全局生效，中等推荐）</h3>
<p>通过 <code>driver.implicitly_wait(seconds)</code> 设置全局等待时间，在指定时间内会不断尝试定位元素，直到找到或超时。</p>
<pre><code class="hljs language-python" lang="python">driver = webdriver.Chrome()
<span class="hljs-comment"># 设置隐式等待 10 秒（全局生效，仅对元素定位操作有效）</span>
driver.implicitly_wait(<span class="hljs-number">10</span>)
driver.get(<span class="hljs-string">"https://www.baidu.com"</span>)

<span class="hljs-comment"># 若 10 秒内找到元素则立即执行，否则抛出异常</span>
search_input = driver.find_element(By.ID, <span class="hljs-string">"kw"</span>)
search_input.send_keys(<span class="hljs-string">"隐式等待测试"</span>)
driver.quit()
</code></pre>
<h3 data-id="heading-14">3. 显式等待（灵活高效，强烈推荐）</h3>
<p>通过 <code>WebDriverWait</code> 配合 <code>expected_conditions</code>，针对单个元素设置个性化等待条件（如元素可见、可点击），超时后抛出明确异常，适合复杂动态页面。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> selenium.webdriver.support.ui <span class="hljs-keyword">import</span> WebDriverWait
<span class="hljs-keyword">from</span> selenium.webdriver.support <span class="hljs-keyword">import</span> expected_conditions <span class="hljs-keyword">as</span> EC

driver = webdriver.Chrome()
driver.maximize_window()
driver.get(<span class="hljs-string">"https://www.baidu.com"</span>)

<span class="hljs-comment"># 1. 构造显式等待对象（最长等待 10 秒，每 0.5 秒检查一次条件）</span>
wait = WebDriverWait(driver, <span class="hljs-number">10</span>, poll_frequency=<span class="hljs-number">0.5</span>)

<span class="hljs-comment"># 2. 等待搜索框可点击（常用条件：element_to_be_clickable）</span>
search_input = wait.until(
    EC.element_to_be_clickable((By.ID, <span class="hljs-string">"kw"</span>)),
    message=<span class="hljs-string">"超时：未找到可点击的百度搜索框"</span>
)

<span class="hljs-comment"># 3. 元素加载完成后执行操作</span>
search_input.send_keys(<span class="hljs-string">"显式等待测试"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"输入成功，等待条件满足"</span>)

driver.quit()
</code></pre>
<blockquote>
<p>常用等待条件：<code>EC.visibility_of_element_located()</code>（元素可见）、<code>EC.presence_of_element_located()</code>（元素存在于 DOM 中）、<code>EC.element_to_be_clickable()</code>（元素可点击）。</p>
</blockquote>
<h2 data-id="heading-15">六、完整实战：模拟浏览器完成搜索+滚动+数据提取</h2>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> selenium <span class="hljs-keyword">import</span> webdriver
<span class="hljs-keyword">from</span> selenium.webdriver.common.by <span class="hljs-keyword">import</span> By
<span class="hljs-keyword">from</span> selenium.webdriver.common.keys <span class="hljs-keyword">import</span> Keys
<span class="hljs-keyword">from</span> selenium.webdriver.support.ui <span class="hljs-keyword">import</span> WebDriverWait
<span class="hljs-keyword">from</span> selenium.webdriver.support <span class="hljs-keyword">import</span> expected_conditions <span class="hljs-keyword">as</span> EC
<span class="hljs-keyword">from</span> bs4 <span class="hljs-keyword">import</span> BeautifulSoup
<span class="hljs-keyword">import</span> time

<span class="hljs-keyword">def</span> <span class="hljs-title function_">simulate_browser_operation</span>():
    <span class="hljs-comment"># 1. 初始化浏览器</span>
    driver = webdriver.Chrome()
    driver.maximize_window()
    target_url = <span class="hljs-string">"https://www.baidu.com"</span>
    
    <span class="hljs-keyword">try</span>:
        <span class="hljs-comment"># 2. 访问网页</span>
        driver.get(target_url)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"已访问：<span class="hljs-subst">{target_url}</span>"</span>)
        
        <span class="hljs-comment"># 3. 显式等待搜索框，输入关键词并提交</span>
        wait = WebDriverWait(driver, <span class="hljs-number">10</span>)
        search_input = wait.until(
            EC.element_to_be_clickable((By.ID, <span class="hljs-string">"kw"</span>)),
            message=<span class="hljs-string">"超时：搜索框未加载完成"</span>
        )
        search_input.send_keys(<span class="hljs-string">"Selenium 模拟浏览器操作 实战"</span>)
        search_input.send_keys(Keys.ENTER)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"已提交搜索，等待结果加载"</span>)
        time.sleep(<span class="hljs-number">3</span>)
        
        <span class="hljs-comment"># 4. 模拟滚动页面，查看更多结果</span>
        driver.execute_script(<span class="hljs-string">"window.scrollTo(0, 1000);"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"已滚动到搜索结果中部"</span>)
        time.sleep(<span class="hljs-number">2</span>)
        
        <span class="hljs-comment"># 5. 获取页面源码，提取第一条结果标题</span>
        html_source = driver.page_source
        soup = BeautifulSoup(html_source, <span class="hljs-string">"lxml"</span>)
        first_result_title = soup.find(<span class="hljs-string">"h3"</span>, class_=<span class="hljs-string">"t"</span>).get_text(strip=<span class="hljs-literal">True</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n第一条搜索结果标题：<span class="hljs-subst">{first_result_title}</span>"</span>)
    
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"操作过程中出现错误：<span class="hljs-subst">{e}</span>"</span>)
    
    <span class="hljs-keyword">finally</span>:
        <span class="hljs-comment"># 6. 关闭浏览器</span>
        time.sleep(<span class="hljs-number">2</span>)
        driver.quit()
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n浏览器已关闭，操作流程结束"</span>)

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    simulate_browser_operation()
</code></pre>
<h2 data-id="heading-16">七、常见问题与解决办法</h2>
<ol>
<li><strong><code>NoSuchElementException</code>（未找到元素）</strong>：① 检查定位表达式（ID、XPath）是否正确；② 页面未加载完成，替换为显式等待；③ 元素在 <code>iframe</code> 中，需先切换：<code>driver.switch_to.frame(iframe_element)</code>。</li>
<li><strong>驱动与浏览器版本不匹配</strong>：下载与浏览器大版本一致的驱动（如 Chrome 119.x 对应 ChromeDriver 119.x），避免过新或过旧。</li>
<li><strong>点击操作无响应</strong>：① 元素被遮挡（如广告弹窗），先关闭弹窗；② 元素不可点击，等待 <code>EC.element_to_be_clickable()</code> 条件满足。</li>
<li><strong>中文输入乱码</strong>：Selenium 4.x 已良好支持中文，确保浏览器编码为 UTF-8，直接使用 <code>send_keys()</code> 传入中文即可。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[6小时从0到1:我用AI造了个分片SQL生成器]]></title>    <link>https://juejin.cn/post/7590433626560348195</link>    <guid>https://juejin.cn/post/7590433626560348195</guid>    <pubDate>2026-01-03T13:54:26.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590433626560348195" data-draft-id="7590433626560331811" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="6小时从0到1:我用AI造了个分片SQL生成器"/> <meta itemprop="keywords" content="后端,SQL,AI编程"/> <meta itemprop="datePublished" content="2026-01-03T13:54:26.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="半瓶入梦"/> <meta itemprop="url" content="https://juejin.cn/user/2757990117802792"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            6小时从0到1:我用AI造了个分片SQL生成器
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2757990117802792/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    半瓶入梦
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-03T13:54:26.000Z" title="Sat Jan 03 2026 13:54:26 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">TL;DR</h2>
<p>2025年12月初,因旧系统数据修复需要,我在没有db-proxy的情况下,用6小时时间让AI从零开发了一个分片SQL生成器。纯Node.js原生实现,支持6种分片算法,包含完整UI界面和Docker部署方案。代码已开源,体验地址:shard-sql-generator-demo.bpdream.com</p>
<hr/>
<h2 data-id="heading-1">The Incident:周四下午的未定级问题</h2>
<p>那是12月初的一个周四下午,用户资金划转数据异常。</p>
<p>具体场景是这样的:我们有一个项目,需要通过脚本批量操作用户资金。脚本执行后,发现数据错误——幸运的是,错误金额小于应划转金额,没有造成资损。</p>
<p>但问题来了:需要修复数据。</p>
<p>监控系统有1小时延时,等我们发现问题时,已经过去很久了。我赶紧找相关RD拉数据,对方问:"你要哪个分片的数据?"</p>
<p>我愣住了:"分片?db-proxy不是自动路由吗?"</p>
<p>对方:"这个旧系统没有db-proxy,需要手动指定分片ID。"</p>
<p>那一刻,我脑子里闪过一个念头:这不就是典型的"日常琐事"吗?</p>
<hr/>
<h2 data-id="heading-2">The Struggle:LLM救场,但痛点犹在</h2>
<p>对方RD说:"没事,我让LLM帮我生成分片SQL。"</p>
<p>几分钟后,他发来了一堆SQL语句,每个都带着不同的分片后缀:<code>user_account_0</code>, <code>user_account_1</code>, <code>user_account_2</code>...</p>
<p>问题解决了,但我的职业病犯了:</p>
<blockquote>
<p><strong>为什么每次都要问LLM?</strong>
<strong>为什么没有一个统一的工具来处理这种需求?</strong>
<strong>为什么分片规则要记在脑子里,而不是可视化配置?</strong></p>
</blockquote>
<p>我决定:写一个工具网站。</p>
<hr/>
<h2 data-id="heading-3">The Epiphany:AI开发,6小时交付</h2>
<p>我打开Trae IDE,选择了标准智能体,模型用的是doubao-seed-code。</p>
<p>整个过程是这样的:</p>
<pre><code class="hljs language-mermaid" lang="mermaid">gantt
    title 6小时开发时间线
    dateFormat  HH:mm
    axisFormat %H:%M

    section 需求阶段
    需求分析与技术选型        :a1, 14:00, 30m
    架构设计                :a2, after a1, 30m

    section 开发阶段
    后端核心功能实现        :b1, after a2, 2h
    前端界面开发            :b2, after b1, 2h
    API接口对接            :b3, after b2, 30m

    section 测试与部署
    功能测试与修复          :c1, after b3, 30m
    Docker部署配置          :c2, after c1, 30m
</code></pre>
<p>从下午2点开始,到晚上8点,一个完整的分片SQL生成器就上线了。</p>
<hr/>
<h2 data-id="heading-4">The System:架构设计</h2>
<h3 data-id="heading-5">技术选型:纯原生,零依赖</h3>
<p>为什么不用Express/Koa/React/Vue?</p>
<p><strong>理由很简单:</strong></p>
<ol>
<li><strong>部署成本</strong>:第三方依赖越多,部署越复杂</li>
<li><strong>安全性</strong>:依赖越少,攻击面越小</li>
<li><strong>学习成本</strong>:纯原生代码,任何Node.js开发者都能看懂</li>
<li><strong>性能</strong>:原生实现,没有框架开销</li>
</ol>
<h3 data-id="heading-6">核心架构</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TD
    A[用户浏览器] --&gt; B[HTTP请求]
    B --&gt; C[Node.js原生服务器]
    C --&gt; D[路由处理]
    D --&gt; E[SQL生成器]
    D --&gt; F[分片算法引擎]
    D --&gt; G[脚本管理器]
    E --&gt; H[返回分片SQL]
    F --&gt; H
    G --&gt; H
    H --&gt; A

    style A fill:#e1f5ff
    style C fill:#fff4e1
    style H fill:#e8f5e9
</code></pre>
<h3 data-id="heading-7">分片算法支持</h3>








































<table><thead><tr><th>算法类型</th><th>适用场景</th><th>参数说明</th></tr></thead><tbody><tr><td>取模算法</td><td>数据均匀分布</td><td><code>mod</code>:取模基数</td></tr><tr><td>范围分片</td><td>有明确范围划分</td><td><code>rangeRules</code>:范围规则配置</td></tr><tr><td>哈希分片</td><td>字符串类型分片键</td><td><code>hashAlgorithm</code>:哈希算法<br/><code>numShards</code>:分片数量</td></tr><tr><td>一致性哈希</td><td>动态增减分片</td><td><code>nodes</code>:节点配置<br/><code>virtualNodes</code>:虚拟节点数</td></tr><tr><td>日期分片</td><td>时间序列数据</td><td><code>dateFormat</code>:日期格式</td></tr><tr><td>自定义脚本</td><td>特殊需求场景</td><td><code>script</code>:自定义脚本内容</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-8">The Implementation:核心代码解析</h2>
<h3 data-id="heading-9">SQL生成器:从原始SQL到分片SQL</h3>
<p>核心逻辑在<code>core/sql-generator.js</code>:</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">generateShardSQL</span>(<span class="hljs-params">originalSQL, shardKey, shardValue, shardId</span>) {
  <span class="hljs-keyword">let</span> shardSQL = originalSQL;

  <span class="hljs-comment">// 1. 处理表名,添加分片后缀</span>
  <span class="hljs-keyword">const</span> fromTableRegex = <span class="hljs-regexp">/\bFROM\s+([a-zA-Z0-9_.]+)(?:\s+AS\s+([a-zA-Z0-9_]+))?\b/gi</span>;
  shardSQL = shardSQL.<span class="hljs-title function_">replace</span>(fromTableRegex, <span class="hljs-function">(<span class="hljs-params">match, table, alias</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> tableParts = table.<span class="hljs-title function_">split</span>(<span class="hljs-string">'.'</span>);
    <span class="hljs-keyword">const</span> baseTable = tableParts[tableParts.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>];
    <span class="hljs-keyword">const</span> schemaPrefix = tableParts.<span class="hljs-property">length</span> &gt; <span class="hljs-number">1</span> ? tableParts.<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, -<span class="hljs-number">1</span>).<span class="hljs-title function_">join</span>(<span class="hljs-string">'.'</span>) + <span class="hljs-string">'.'</span> : <span class="hljs-string">''</span>;
    <span class="hljs-keyword">const</span> shardedTable = <span class="hljs-string">`<span class="hljs-subst">${schemaPrefix}</span><span class="hljs-subst">${baseTable}</span>_<span class="hljs-subst">${shardId}</span>`</span>;
    <span class="hljs-keyword">return</span> alias ? <span class="hljs-string">`FROM <span class="hljs-subst">${shardedTable}</span> AS <span class="hljs-subst">${alias}</span>`</span> : <span class="hljs-string">`FROM <span class="hljs-subst">${shardedTable}</span>`</span>;
  });

  <span class="hljs-comment">// 2. 添加分片键条件</span>
  <span class="hljs-keyword">const</span> shardCondition = <span class="hljs-string">`<span class="hljs-subst">${shardKey}</span> = <span class="hljs-subst">${<span class="hljs-keyword">typeof</span> shardValue === <span class="hljs-string">'number'</span> ? shardValue : <span class="hljs-string">`'<span class="hljs-subst">${shardValue}</span>'`</span>}</span>`</span>;
  <span class="hljs-keyword">const</span> whereIndex = shardSQL.<span class="hljs-title function_">toLowerCase</span>().<span class="hljs-title function_">indexOf</span>(<span class="hljs-string">' where '</span>);

  <span class="hljs-keyword">if</span> (whereIndex !== -<span class="hljs-number">1</span>) {
    <span class="hljs-comment">// 已有WHERE子句,添加AND条件</span>
    <span class="hljs-keyword">const</span> whereEnd = whereIndex + <span class="hljs-number">7</span>;
    shardSQL = shardSQL.<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, whereEnd) + <span class="hljs-string">`<span class="hljs-subst">${shardCondition}</span> AND `</span> + shardSQL.<span class="hljs-title function_">slice</span>(whereEnd);
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// 没有WHERE子句,直接添加</span>
    shardSQL += <span class="hljs-string">` WHERE <span class="hljs-subst">${shardCondition}</span>`</span>;
  }

  <span class="hljs-keyword">return</span> shardSQL;
}
</code></pre>
<p><strong>原始SQL:</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> user_account <span class="hljs-keyword">WHERE</span> status <span class="hljs-operator">=</span> <span class="hljs-number">1</span>
</code></pre>
<p><strong>生成后(分片ID=2,分片键=user_id=12345):</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> user_account_2 <span class="hljs-keyword">WHERE</span> user_id <span class="hljs-operator">=</span> <span class="hljs-number">12345</span> <span class="hljs-keyword">AND</span> status <span class="hljs-operator">=</span> <span class="hljs-number">1</span>
</code></pre>
<h3 data-id="heading-10">分片算法:取模算法示例</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> shardAlgorithms = {
  <span class="hljs-attr">mod</span>: <span class="hljs-function">(<span class="hljs-params">value, config</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> num = <span class="hljs-built_in">parseInt</span>(value);
    <span class="hljs-keyword">const</span> mod = <span class="hljs-built_in">parseInt</span>(config.<span class="hljs-property">mod</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">isNaN</span>(num) ? <span class="hljs-number">0</span> : num % mod;
  }
};
</code></pre>
<p><strong>示例:</strong></p>
<ul>
<li><code>user_id = 12345</code>, <code>mod = 4</code></li>
<li><code>12345 % 4 = 1</code></li>
<li>路由到分片1</li>
</ul>
<hr/>
<h2 data-id="heading-11">The UI:现代化界面设计</h2>
<h3 data-id="heading-12">主界面布局</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[左侧面板&lt;br/&gt;分片规则配置] --&gt; B[中间面板&lt;br/&gt;SQL输入与生成]
    B --&gt; C[右侧面板&lt;br/&gt;结果展示与历史]

    style A fill:#e3f2fd
    style B fill:#f3e5f5
    style C fill:#e8f5e9
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c118e669384f4a8f9a316fe3c2f5b830~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2K55O25YWl5qKm:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768053266&amp;x-signature=o924%2FyTlWAX5nvMz%2BxovQatnudM%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-13">核心功能模块</h3>
<ol>
<li>
<p><strong>分片规则配置</strong></p>
<ul>
<li>6种分片算法选择</li>
<li>动态参数配置</li>
<li>自定义脚本编辑器</li>
</ul>
</li>
<li>
<p><strong>SQL输入与生成</strong></p>
<ul>
<li>SQL语法高亮</li>
<li>批量分片键值输入</li>
<li>一键生成</li>
</ul>
</li>
<li>
<p><strong>结果展示</strong></p>
<ul>
<li>分片SQL列表</li>
<li>聚合SQL生成</li>
<li>一键复制/导出</li>
</ul>
</li>
<li>
<p><strong>历史记录</strong></p>
<ul>
<li>操作历史保存</li>
<li>快速回溯</li>
<li>本地存储</li>
</ul>
</li>
</ol>
<hr/>
<h2 data-id="heading-14">The Deployment:双重部署方案</h2>
<h3 data-id="heading-15">裸机部署</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 克隆项目</span>
git <span class="hljs-built_in">clone</span> https://github.com/skys-mission/ai-dev-demo.git
<span class="hljs-built_in">cd</span> ai-dev-demo/shard-sql-generator

<span class="hljs-comment"># 2. 启动服务</span>
node server.js

<span class="hljs-comment"># 3. 访问应用</span>
<span class="hljs-comment"># http://localhost:3000</span>
</code></pre>
<p><strong>环境要求:</strong></p>
<ul>
<li>Node.js 14.0.0 或更高版本</li>
<li>512MB 以上内存</li>
<li>100MB 以上磁盘空间</li>
</ul>
<h3 data-id="heading-16">Docker部署</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 构建镜像</span>
docker build -t shard-sql-generator .

<span class="hljs-comment"># 2. 运行容器</span>
docker run -d -p 3000:3000 --name shard-sql-generator shard-sql-generator

<span class="hljs-comment"># 3. 使用Docker Compose</span>
docker-compose up -d
</code></pre>
<p><strong>Dockerfile:</strong></p>
<pre><code class="hljs language-dockerfile" lang="dockerfile">FROM node:14-alpine

WORKDIR /app

COPY package*.json ./
RUN npm install

COPY . .

EXPOSE 3000

CMD ["node", "server.js"]
</code></pre>
<hr/>
<h2 data-id="heading-17">The Impact:实际应用价值</h2>
<h3 data-id="heading-18">解决的问题</h3>
<ol>
<li><strong>效率提升</strong>:从"问LLM+手动修改"到"一键生成",节省90%时间</li>
<li><strong>错误减少</strong>:避免手动修改SQL时的拼写错误</li>
<li><strong>知识沉淀</strong>:分片规则可视化配置,不再依赖个人记忆</li>
<li><strong>团队协作</strong>:统一的工具,降低沟通成本</li>
</ol>
<h3 data-id="heading-19">适用场景</h3>
<ul>
<li><strong>数据修复</strong>:批量修复分片表数据</li>
<li><strong>数据迁移</strong>:跨分片数据迁移</li>
<li><strong>数据分析</strong>:分析特定分片的数据</li>
<li><strong>日常运维</strong>:快速生成分片SQL</li>
</ul>
<hr/>
<h2 data-id="heading-20">The Reflection:AI开发的思考</h2>
<h3 data-id="heading-21">为什么能6小时完成?</h3>
<ol>
<li><strong>需求明确</strong>:从实际问题出发,没有过度设计</li>
<li><strong>技术选型简单</strong>:纯原生实现,避免框架学习成本</li>
<li><strong>AI辅助</strong>:Trae智能体+doubao-seed-code模型,代码生成效率高</li>
<li><strong>MVP思维</strong>:先实现核心功能,再迭代优化</li>
</ol>
<h3 data-id="heading-22">AI开发的局限性</h3>
<ol>
<li><strong>上下文理解</strong>:AI对业务逻辑的理解不如人类,需要明确的需求描述</li>
<li><strong>代码质量</strong>:AI生成的代码需要人工review和优化</li>
<li><strong>调试成本</strong>:AI生成的bug需要人类调试,可能比手写更耗时</li>
<li><strong>维护性</strong>:AI生成的代码可读性可能不如手写</li>
</ol>
<h3 data-id="heading-23">最佳实践</h3>
<ol>
<li><strong>需求先行</strong>:明确需求,再让AI实现</li>
<li><strong>迭代开发</strong>:分阶段实现,每阶段验证</li>
<li><strong>代码Review</strong>:AI生成后,人工review必不可少</li>
<li><strong>测试驱动</strong>:写测试用例,确保功能正确</li>
</ol>
<hr/>
<h2 data-id="heading-24">The Code:开源与贡献</h2>
<h3 data-id="heading-25">项目地址</h3>
<ul>
<li><strong>GitHub</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fskys-mission%2Fai-dev-demo%2Ftree%2Fmain%2Fshard-sql-generator" target="_blank" title="https://github.com/skys-mission/ai-dev-demo/tree/main/shard-sql-generator" ref="nofollow noopener noreferrer">github.com/skys-missio…</a></li>
<li><strong>体验地址</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fshard-sql-generator-demo.bpdream.com" target="_blank" title="https://shard-sql-generator-demo.bpdream.com" ref="nofollow noopener noreferrer">shard-sql-generator-demo.bpdream.com</a></li>
</ul>
<h3 data-id="heading-26">项目结构</h3>
<pre><code class="hljs language-csharp" lang="csharp">shard-sql-generator/
├── core/                 <span class="hljs-meta"># 核心功能模块</span>
│   ├── sql-generator.js  <span class="hljs-meta"># 分片SQL生成器</span>
│   └── script-manager.js <span class="hljs-meta"># 脚本管理器</span>
├── <span class="hljs-keyword">public</span>/               <span class="hljs-meta"># 静态文件目录</span>
│   ├── index.html        <span class="hljs-meta"># 主页面</span>
│   ├── styles.css        <span class="hljs-meta"># 样式文件</span>
│   ├── app.js            <span class="hljs-meta"># 前端逻辑</span>
│   └── modules/          <span class="hljs-meta"># 功能模块</span>
│       ├── shard-algorithm.js
│       ├── sql-handler.js
│       ├── script-manager.js
│       └── history-manager.js
├── server.js             <span class="hljs-meta"># 服务器入口</span>
├── Dockerfile            <span class="hljs-meta"># Docker配置</span>
├── docker-compose.yml    <span class="hljs-meta"># Docker Compose配置</span>
└── package.json          <span class="hljs-meta"># 项目配置</span>
</code></pre>
<h3 data-id="heading-27">技术栈</h3>
<ul>
<li><strong>后端</strong>:Node.js 原生 (无第三方依赖)</li>
<li><strong>前端</strong>:HTML5 + CSS3 + JavaScript (原生)</li>
<li><strong>存储</strong>:localStorage + JSON文件</li>
<li><strong>部署</strong>:裸机部署 / Docker容器</li>
</ul>
<hr/>
<h2 data-id="heading-28">Conclusion</h2>
<p>6小时,从0到1,一个完整的分片SQL生成器。</p>
<p>这不是什么"革命性"的技术创新,但它解决了一个真实存在的痛点。</p>
<p>在大厂,我们每天都在处理各种"琐事":数据修复、SQL生成、脚本编写...这些事情看似简单,但重复劳动会消耗大量时间。</p>
<p><strong>AI的价值不在于替代人类,而在于把人类从重复劳动中解放出来,让我们专注于更有价值的事情。</strong></p>
<p>这个项目只是一个开始。未来,我会继续用AI解决更多日常琐事,并把经验分享出来。</p>
<p>如果你也有类似的需求,欢迎试用,也欢迎贡献代码。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[实战硬核！手把手教你用 Python 打造企业级 LLM 网关 (FastAPI + Asyncio 架构篇)]]></title>    <link>https://juejin.cn/post/7590654281036873771</link>    <guid>https://juejin.cn/post/7590654281036873771</guid>    <pubDate>2026-01-03T15:02:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590654281036873771" data-draft-id="7590309337861619753" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="实战硬核！手把手教你用 Python 打造企业级 LLM 网关 (FastAPI + Asyncio 架构篇)"/> <meta itemprop="keywords" content="架构"/> <meta itemprop="datePublished" content="2026-01-03T15:02:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="一直在追"/> <meta itemprop="url" content="https://juejin.cn/user/239028506736411"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            实战硬核！手把手教你用 Python 打造企业级 LLM 网关 (FastAPI + Asyncio 架构篇)
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/239028506736411/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    一直在追
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-03T15:02:00.000Z" title="Sat Jan 03 2026 15:02:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">💎 本文价值提示</h3>
<blockquote>
<p><strong>你将获得什么？</strong></p>
<ol>
<li><strong>从零构建</strong>：不再是写脚本，而是构建一个可扩展的微服务架构。</li>
<li><strong>企业级思维</strong>：掌握限流、熔断、流式传输等生产环境必备技能。</li>
<li><strong>代码即资产</strong>：一套可直接复用的 LLM Gateway 核心代码骨架。</li>
<li><strong>转型视角</strong>：看懂大数据高吞吐思维如何映射到 AI 高并发架构。</li>
</ol>
</blockquote>
<hr/>
<p>👋 <strong>大家好，我是你们的老朋友，那个正在从大数据转型 AI 架构的“老司机”。</strong></p>
<p>在前三篇文章中，我们已经完成了 Python 的“脱胎换骨”：</p>
<ul>
<li><strong>第一篇</strong>：我们用 <strong>Type Hints 和 Pydantic</strong> 戒掉了“弱类型”的随意，像写 Java 一样严谨；</li>
<li><strong>第二篇</strong>：我们用 <strong>Asyncio</strong> 征服了高并发 I/O，不再让 CPU 傻等；</li>
<li><strong>第三篇</strong>：我们用 <strong>Generator 和 Decorator</strong> 搞定了流式输出和 AOP 切面编程。</li>
</ul>
<p>今天，是时候把这些散落的珍珠串成项链了！我们将进入 <strong>Phase 4：工程化落地与架构设计</strong>。</p>
<p>我们要一起做一个 <strong>Capstone Project（毕业设计）</strong> —— <strong>企业级 LLM Gateway（大模型网关）</strong>。</p>
<hr/>
<h3 data-id="heading-1">🏗️ 为什么要造一个 LLM Gateway？</h3>
<p>在企业里，直接让业务代码调用 OpenAI 或 DeepSeek 的 API 是非常危险的。这就好比让公司的每辆车都自己去海关报关，效率低且无法管控。</p>
<p>我们需要一个 <strong>“海关总署” (Gateway)</strong> ：</p>
<ol>
<li><strong>统一计费</strong>：谁用了多少 Token，得算清楚。</li>
<li><strong>流量控制</strong>：防止某个业务线把 API Rate Limit 刷爆。</li>
<li><strong>协议转换</strong>：前端要 SSE 流式，后端要统一接口。</li>
<li><strong>安全审计</strong>：敏感词过滤，防止数据泄露。</li>
</ol>
<p><strong>技术栈选型</strong>：</p>
<ul>
<li><strong>框架</strong>：<code>FastAPI</code> (Python 界的最强黑马，性能直逼 Go)。</li>
<li><strong>校验</strong>：<code>Pydantic V2</code> (数据契约的守护神)。</li>
<li><strong>并发</strong>：<code>Asyncio</code> (高并发的核心引擎)。</li>
</ul>
<hr/>
<h3 data-id="heading-2">🧩 架构蓝图：数据是如何流动的？</h3>
<p>在我们开始写代码之前，先像设计 Flink 拓扑图一样，画出我们的架构流向。</p>
<p><img src="http://openwrite.cn/uploads/20235/58127/860d1052-faec-42e2-82b2-3b44abe459a4.png" alt="image.png" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-3">🛠️ 第一步：立规矩 —— 定义数据契约 (Pydantic)</h3>
<p>做大数据出身的我们，最怕数据格式乱七八糟。在 AI 架构中，<strong>Prompt 就是 SQL，Schema 就是 Table Schema</strong>。</p>
<p>我们需要定义“输入”和“输出”的严格标准。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> pydantic <span class="hljs-keyword">import</span> BaseModel, Field, field_validator
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">List</span>, <span class="hljs-type">Optional</span>, <span class="hljs-type">Literal</span>

<span class="hljs-comment"># 1. 定义消息体</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Message</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    role: <span class="hljs-type">Literal</span>[<span class="hljs-string">"system"</span>, <span class="hljs-string">"user"</span>, <span class="hljs-string">"assistant"</span>]
    content: <span class="hljs-built_in">str</span>

<span class="hljs-comment"># 2. 定义请求契约 (Request Contract)</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ChatCompletionRequest</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    model: <span class="hljs-built_in">str</span> = Field(..., description=<span class="hljs-string">"模型名称，如 gpt-4, deepseek-chat"</span>)
    messages: <span class="hljs-type">List</span>[Message]
    temperature: <span class="hljs-built_in">float</span> = Field(<span class="hljs-number">0.7</span>, ge=<span class="hljs-number">0.0</span>, le=<span class="hljs-number">2.0</span>)
    stream: <span class="hljs-built_in">bool</span> = <span class="hljs-literal">False</span>

    <span class="hljs-comment"># 💡 亮点：自定义校验，防止恶意注入过长文本</span>
<span class="hljs-meta">    @field_validator(<span class="hljs-params"><span class="hljs-string">'messages'</span></span>)</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">validate_message_length</span>(<span class="hljs-params">cls, v</span>):
        total_len = <span class="hljs-built_in">sum</span>(<span class="hljs-built_in">len</span>(m.content) <span class="hljs-keyword">for</span> m <span class="hljs-keyword">in</span> v)
        <span class="hljs-keyword">if</span> total_len &gt; <span class="hljs-number">10000</span>:
            <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">"Prompt 内容过长，请精简后重试"</span>)
        <span class="hljs-keyword">return</span> v

<span class="hljs-comment"># 3. 定义响应契约 (Response Contract)</span>
<span class="hljs-comment"># 这里我们模拟 OpenAI 的标准返回格式</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ChatCompletionResponse</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    <span class="hljs-built_in">id</span>: <span class="hljs-built_in">str</span>
    <span class="hljs-built_in">object</span>: <span class="hljs-built_in">str</span> = <span class="hljs-string">"chat.completion"</span>
    created: <span class="hljs-built_in">int</span>
    choices: <span class="hljs-type">List</span>[<span class="hljs-built_in">dict</span>]
</code></pre>
<p><strong>👨‍💻 架构师旁白</strong>：
这不仅仅是代码，这是<strong>协议</strong>。有了它，前端开发和后端开发就有了“法律依据”，不再需要口头对齐字段。</p>
<hr/>
<h3 data-id="heading-4">🚀 第二步：高并发引擎 —— 异步请求 (Asyncio)</h3>
<p>LLM 的响应通常很慢（几秒到几十秒）。如果用传统的同步代码（像 JDBC 那样），一个请求卡住，整个服务就挂了。</p>
<p>我们要用 <code>Asyncio</code> + <code>httpx</code>，实现<strong>非阻塞调用</strong>。这就像 Node.js 的事件循环，或者 Netty 的 IO 线程。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> httpx
<span class="hljs-keyword">import</span> os
<span class="hljs-keyword">from</span> fastapi <span class="hljs-keyword">import</span> HTTPException

<span class="hljs-comment"># 模拟从环境变量获取 Key</span>
LLM_API_KEY = os.getenv(<span class="hljs-string">"LLM_API_KEY"</span>)
LLM_BASE_URL = <span class="hljs-string">"https://api.deepseek.com/v1"</span>

<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">call_llm_api</span>(<span class="hljs-params">request: ChatCompletionRequest</span>):
    <span class="hljs-string">"""
    异步调用上游大模型接口
    """</span>
    headers = {
        <span class="hljs-string">"Authorization"</span>: <span class="hljs-string">f"Bearer <span class="hljs-subst">{LLM_API_KEY}</span>"</span>,
        <span class="hljs-string">"Content-Type"</span>: <span class="hljs-string">"application/json"</span>
    }
    
    <span class="hljs-comment"># 💡 亮点：使用异步上下文管理器，自动释放连接</span>
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> httpx.AsyncClient(timeout=<span class="hljs-number">60.0</span>) <span class="hljs-keyword">as</span> client:
        <span class="hljs-keyword">try</span>:
            response = <span class="hljs-keyword">await</span> client.post(
                <span class="hljs-string">f"<span class="hljs-subst">{LLM_BASE_URL}</span>/chat/completions"</span>,
                json=request.model_dump(), <span class="hljs-comment"># Pydantic V2 序列化</span>
                headers=headers
            )
            response.raise_for_status()
            <span class="hljs-keyword">return</span> response.json()
        <span class="hljs-keyword">except</span> httpx.HTTPStatusError <span class="hljs-keyword">as</span> e:
            <span class="hljs-comment"># 记录日志...</span>
            <span class="hljs-keyword">raise</span> HTTPException(status_code=e.response.status_code, detail=<span class="hljs-string">"上游服务报错"</span>)
</code></pre>
<hr/>
<h3 data-id="heading-5">🌊 第三步：极致体验 —— 流式透传 (Generator)</h3>
<p>用户不想盯着空白屏幕等 10 秒。他们想要 ChatGPT 那种“打字机”效果。
这就需要用到 Python 的 <strong>Generator (生成器)</strong> ，配合 FastAPI 的 <code>StreamingResponse</code>。</p>
<p>这在大数据领域，就是 <strong>Spark Streaming</strong> 或 <strong>Flink DataStream</strong> —— 数据来一条，处理一条，发走一条。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> json
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> AsyncGenerator

<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">stream_llm_api</span>(<span class="hljs-params">request: ChatCompletionRequest</span>) -&gt; AsyncGenerator[<span class="hljs-built_in">str</span>, <span class="hljs-literal">None</span>]:
    <span class="hljs-string">"""
    流式生成器：像水管一样接通上游和下游
    """</span>
    headers = {
        <span class="hljs-string">"Authorization"</span>: <span class="hljs-string">f"Bearer <span class="hljs-subst">{LLM_API_KEY}</span>"</span>,
        <span class="hljs-string">"Content-Type"</span>: <span class="hljs-string">"application/json"</span>
    }
    
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> httpx.AsyncClient() <span class="hljs-keyword">as</span> client:
        <span class="hljs-comment"># 开启流式请求</span>
        <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> client.stream(
            <span class="hljs-string">"POST"</span>, 
            <span class="hljs-string">f"<span class="hljs-subst">{LLM_BASE_URL}</span>/chat/completions"</span>, 
            json=request.model_dump(), 
            headers=headers
        ) <span class="hljs-keyword">as</span> response:
            
            <span class="hljs-comment"># 💡 亮点：逐行读取上游数据，并实时 yield 给前端</span>
            <span class="hljs-keyword">async</span> <span class="hljs-keyword">for</span> line <span class="hljs-keyword">in</span> response.aiter_lines():
                <span class="hljs-keyword">if</span> line:
                    <span class="hljs-comment"># 这里可以做数据清洗、计费统计等中间处理</span>
                    <span class="hljs-keyword">yield</span> <span class="hljs-string">f"<span class="hljs-subst">{line}</span>\n\n"</span> <span class="hljs-comment"># 符合 SSE 格式</span>
</code></pre>
<hr/>
<h3 data-id="heading-6">🛡️ 第四步：稳定性保障 —— 熔断器 (Decorator)</h3>
<p>如果上游 DeepSeek 挂了，或者网络抖动，我们不能让请求堆积把自己的网关压垮。我们需要一个 <strong>熔断器 (Circuit Breaker)</strong> 。</p>
<p>利用 Python 的 <strong>Decorator (装饰器)</strong> ，我们可以优雅地实现 AOP（面向切面编程）。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> time
<span class="hljs-keyword">from</span> functools <span class="hljs-keyword">import</span> wraps

<span class="hljs-comment"># 简单的熔断器状态</span>
CIRCUIT_OPEN = <span class="hljs-literal">False</span>
ERROR_COUNT = <span class="hljs-number">0</span>
LAST_ERROR_TIME = <span class="hljs-number">0</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">circuit_breaker</span>(<span class="hljs-params">threshold=<span class="hljs-number">5</span>, recovery_time=<span class="hljs-number">60</span></span>):
    <span class="hljs-string">"""
    装饰器：当错误次数超过 threshold 时，暂停服务 recovery_time 秒
    """</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">decorator</span>(<span class="hljs-params">func</span>):
<span class="hljs-meta">        @wraps(<span class="hljs-params">func</span>)</span>
        <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">wrapper</span>(<span class="hljs-params">*args, **kwargs</span>):
            <span class="hljs-keyword">global</span> CIRCUIT_OPEN, ERROR_COUNT, LAST_ERROR_TIME
            
            <span class="hljs-comment"># 1. 检查是否熔断</span>
            <span class="hljs-keyword">if</span> CIRCUIT_OPEN:
                <span class="hljs-keyword">if</span> time.time() - LAST_ERROR_TIME &gt; recovery_time:
                    <span class="hljs-comment"># 尝试恢复</span>
                    CIRCUIT_OPEN = <span class="hljs-literal">False</span>
                    ERROR_COUNT = <span class="hljs-number">0</span>
                <span class="hljs-keyword">else</span>:
                    <span class="hljs-keyword">raise</span> HTTPException(status_code=<span class="hljs-number">503</span>, detail=<span class="hljs-string">"服务熔断中，请稍后重试"</span>)
            
            <span class="hljs-comment"># 2. 尝试执行</span>
            <span class="hljs-keyword">try</span>:
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> func(*args, **kwargs)
            <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
                ERROR_COUNT += <span class="hljs-number">1</span>
                LAST_ERROR_TIME = time.time()
                <span class="hljs-keyword">if</span> ERROR_COUNT &gt;= threshold:
                    CIRCUIT_OPEN = <span class="hljs-literal">True</span>
                    <span class="hljs-built_in">print</span>(<span class="hljs-string">"⚠️ 触发熔断保护！"</span>)
                <span class="hljs-keyword">raise</span> e
        <span class="hljs-keyword">return</span> wrapper
    <span class="hljs-keyword">return</span> decorator
</code></pre>
<hr/>
<h3 data-id="heading-7">🏰 第五步：集大成 —— FastAPI 入口</h3>
<p>最后，我们将所有组件组装到 <code>main.py</code> 中。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> fastapi <span class="hljs-keyword">import</span> FastAPI
<span class="hljs-keyword">from</span> fastapi.responses <span class="hljs-keyword">import</span> StreamingResponse

app = FastAPI(title=<span class="hljs-string">"Enterprise LLM Gateway"</span>)

<span class="hljs-meta">@app.post(<span class="hljs-params"><span class="hljs-string">"/v1/chat/completions"</span></span>)</span>
<span class="hljs-meta">@circuit_breaker() </span><span class="hljs-comment"># 挂载熔断器</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">chat_completions</span>(<span class="hljs-params">request: ChatCompletionRequest</span>):
    <span class="hljs-string">"""
    网关核心接口
    """</span>
    <span class="hljs-comment"># 1. 打印日志 (实际项目中应使用 logging 模块)</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"收到请求: <span class="hljs-subst">{request.model}</span> - <span class="hljs-subst">{<span class="hljs-built_in">len</span>(request.messages)}</span> msgs"</span>)
    
    <span class="hljs-comment"># 2. 判断是否流式</span>
    <span class="hljs-keyword">if</span> request.stream:
        <span class="hljs-comment"># 返回流式响应 (SSE)</span>
        <span class="hljs-keyword">return</span> StreamingResponse(
            stream_llm_api(request), 
            media_type=<span class="hljs-string">"text/event-stream"</span>
        )
    <span class="hljs-keyword">else</span>:
        <span class="hljs-comment"># 返回普通 JSON</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> call_llm_api(request)

<span class="hljs-comment"># 启动命令: uvicorn main:app --reload</span>
</code></pre>
<hr/>
<h3 data-id="heading-8">📝 总结与回顾</h3>
<p>恭喜你！你已经从一个写 <code>ETL</code> 脚本的大数据工程师，成功蜕变为能手写 <strong>高并发微服务</strong> 的 AI 架构师。</p>
<p>让我们回顾一下这个 <strong>LLM Gateway</strong> 涉及的核心能力：</p>
<ol>
<li><strong>Pydantic</strong>: 你的“数据安检员”，确保进来的数据都是合规的。</li>
<li><strong>Asyncio</strong>: 你的“交通指挥官”，让单线程也能处理成千上万的并发请求。</li>
<li><strong>Generator</strong>: 你的“流水线”，实现数据的实时流转，降低内存压力。</li>
<li><strong>Decorator</strong>: 你的“保镖”，在不侵入业务逻辑的情况下，提供熔断和重试保护。</li>
</ol>
<h4 data-id="heading-9">🧠 本文思维导图</h4>
<p><img src="http://openwrite.cn/uploads/20235/58127/88463e01-4a77-46d4-9ac4-0bf1244e3d2a.png" alt="image.png" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-10">🗣️ 互动话题</h3>
<p><strong>你在转型 AI 开发的过程中，遇到的最大“坑”是什么？</strong></p>
<ul>
<li>A. 习惯了 Java 的强类型，受不了 Python 的动态类型？</li>
<li>B. 搞不懂 <code>async/await</code>，代码经常卡死？</li>
<li>C. 流式输出 (Streaming) 总是断断续续？</li>
<li>D. 依赖管理太乱，<code>pip</code> 和 <code>conda</code> 打架？</li>
</ul>
<p>👇 <strong>在评论区告诉我你的答案，或者输入关键词【网关源码】，获取本文完整的项目代码包！</strong></p>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[全面进发 | 2025年度总结]]></title>    <link>https://juejin.cn/post/7590929624743804978</link>    <guid>https://juejin.cn/post/7590929624743804978</guid>    <pubDate>2026-01-04T02:14:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590929624743804978" data-draft-id="7590957076630781998" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="全面进发 | 2025年度总结"/> <meta itemprop="keywords" content="前端,JavaScript,面试"/> <meta itemprop="datePublished" content="2026-01-04T02:14:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="枣仁"/> <meta itemprop="url" content="https://juejin.cn/user/958429872270654"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            全面进发 | 2025年度总结
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/958429872270654/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    枣仁
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-04T02:14:20.000Z" title="Sun Jan 04 2026 02:14:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><h3 data-id="heading-0">前言</h3>
<p>今天是2026年的第一天，又到一年一度的年度总结环节。和往年一样，我今年依然在备忘录中记录下每天的Todolist，并且在完成"大事件"时记下完成情况。今年涉猎的方面会比较多，所以我愿意用<strong>全面进发</strong>这个关键字来总结我的2025。</p>
<p>对话一下2024年，当时的展望：</p>
<ol>
<li>保持锻炼，每周至少锻炼2次（一年差不多100次） ✅</li>
</ol>

<ol start="2">
<li>学会一项新的体育技能，能作为日常的锻炼项目（暂定羽毛球，争取练到能在低端局打野球的水平）✅</li>
</ol>

<ol start="3">
<li>锻炼厨艺，保持好的饮食习惯（在家庭菜谱中至少收录100道菜品）❌</li>
</ol>

<ol start="4">
<li>至少阅读10本书（15/ 10） ✅</li>
</ol>

<ol start="5">
<li>工作上除了稳定性以外，再深耕一个其他领域（除了稳定性，在其他方向上有有些收货） ✅</li>
</ol>

<ol start="6">
<li>探索新的帮助自己成长的方式（比如听播客？锻炼时听博客一举两得？）✅</li>
</ol>
<p>除了自己多做饭以外，其他差不多都完成了，主要原因是周末基本上都没在家，做饭不太熟练，做起来比较花时间。</p>
<h3 data-id="heading-1">工作</h3>
<p>工作方面，任然保持现状，但和去年相比，今年明显没有去年那么焦虑了，工作内容、同事、合作方都达成了一定程度的默契，做事效率提升了。当然那我也有在刻意的调整自己，工作已经占用了我们太多时间了，心灵上至少可以找机会释放一下。</p>
<p>上半年的时间，主要在做一些AI探索相关的内容，虽然后来进展缓慢，但还是积累了一些经验，对AI的现状有了一些基本的认知和积累。</p>
<p>下半年主要在支持重点的项目，以及团队在年底的时候有一波调整，目前正在逐步适应和接受变化中。</p>
<h3 data-id="heading-2">锻炼</h3>
<p>今年总共锻炼了<strong>158</strong>次</p>
<ol>
<li>跑步 🏃🏻‍♀️（48次）</li>
<li>游泳 🏊🏻（42次）</li>
<li>羽毛球🏸（36次）</li>
<li>健身 💪🏻（13次）</li>
<li>篮球 🏀（3次）</li>
<li>其他（爬山、飞盘、乒乓球🏓总计12次）</li>
</ol>
<p>总的来讲，今年的锻炼频次是健康且合理的。在10月份的时候完成了首次半马，成绩（1:57:22）。并且按照年初的规划，羽毛球达到了能在野球场打球的水平（大概L2 ~ L3？）。游泳在经过教练的动作指正之后二次腿四次腿也学会了，明年争取游的更久更远。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/95855b28f0344692bc7dd13b3e98ef13~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p6j5LuB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768097660&amp;x-signature=Au2h2%2BA%2FGRrTSd03TxQdqi29Qbk%3D" alt="cf531a27c12ac1467dbd74e25ae8add4.jpg" loading="lazy"/></p>
<h3 data-id="heading-3">阅读</h3>
<p>阅读对我来说不是一件很容易的事情，我大小就不是一个爱读书的人，但是今年下来也读了15本书</p>
<ul>
<li>《当下的力量》</li>
<li>《非暴力沟通》</li>
<li>《你有你的计划，世界另有计划》</li>
<li>《去遇见》</li>
<li>《好好说话》</li>
<li>《我不是教你诈》</li>
<li>《超越百岁》</li>
<li>《无伤跑法》</li>
<li>《我看见的世界》</li>
<li>《曾国藩传》</li>
<li>《我在西南联大的日子》</li>
<li>《深度工作》</li>
<li>《财富方程式》</li>
<li>《习惯的力量》</li>
<li>《理解人性》</li>
</ul>
<p>其中《当下的力量》对我当下的生活确实有了实质性的改变，治好了半夜醒来会胡思乱想的毛病，教会了我如何很好的关注当下。《超越百岁》这本书对我的帮助也很大，我读完这本书之后，让我第一次认同睡眠这件事情是真的重要的。这两本书是今年读完之后收货最大的。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f59e7393ddec479986787726275b1a04~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p6j5LuB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768097660&amp;x-signature=ockhqn9fQj3eStutkANGN0TgMyU%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-4"><strong>学习 &amp; 写作</strong></h3>
<h4 data-id="heading-5">写作</h4>
<p>今年在博客上写作的内容比较少，一部分原因是工作上的大部分内容都不方便分享，另外一方面确实也没有在仔细专研的技术内容（好吧，懈怠了）。但是工作上需要写的文档变多了，这是工作需要。</p>
<h4 data-id="heading-6">学习</h4>
<p>今年除了看书以外，学习了的有以下内容（综合）：</p>
<ol>
<li>《杨天真的32个高情商公式》</li>
<li>《贾杰的AI编程秘籍》</li>
<li>《李宇轩羽毛球》</li>
<li>《冴羽的知识星球》（这个内容有点杂，但是确实是认真看了不少）</li>
</ol>
<div>
  <img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3ab1e3092ce543e5b1e20efaca9c818d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p6j5LuB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768097660&amp;x-signature=5BmtGg8vAobcDiVFVyf14w5xQ6M%3D" alt="图片1描述转存失败，建议直接上传图片文件" loading="lazy"/>
  <img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/47d374d1b33648088b3281d2bc1205e1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p6j5LuB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768097660&amp;x-signature=Q9VkTFHmaHNHAKyIcbRrNoTqUMY%3D" alt="图片2描述转存失败，建议直接上传图片文件" loading="lazy"/>
</div>
<h3 data-id="heading-7">生活</h3>
<h4 data-id="heading-8">旅游</h4>
<p>今年累计去了8个城市旅游，映像最深的是在福鼎晕船到想死，宜兴的泡泡简直一绝，黄山的云雾美得动人，岱山岛宁静的夜晚，我独自一人骑车在长剑大道感受这个城市...</p>
<ul>
<li>福鼎</li>
<li>临海</li>
<li>天台</li>
<li>上海</li>
<li>宜兴</li>
<li>金华</li>
<li>黄山</li>
<li>岱山岛</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e25ff925bd0140539c143694e92328ba~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p6j5LuB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768097660&amp;x-signature=ithj74iisjdPJvtckpP%2B7JQxzpE%3D" alt="bb432278d59b1c5cf4e89416f4b2d9c7.jpg" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7aeec2827baa4dce969aa7142efb3245~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p6j5LuB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768097660&amp;x-signature=%2BdPObRb4bettFqCJqTz6RRlmJT4%3D" alt="f608b1e19088bb566c382c56ca7e2d4c.jpg" loading="lazy"/></p>
<h4 data-id="heading-9">演唱会</h4>
<p>今年去听了孙燕姿、张杰、新裤子的演唱会，还去了常州的太湖湾音乐节。对新裤子路转粉，把乐队的夏天第一季都看了一遍。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/26eeca4b9cb14e67887f9a7f18c7ec8a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p6j5LuB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768097660&amp;x-signature=SV%2Bk6t5v8UrgKnd8c59oLoQeUIk%3D" alt="9569b1e814c0f2bd79cd893f84cde99a.jpg" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7068b7fbd6e2489a9ac2f998e054da5f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p6j5LuB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768097660&amp;x-signature=uNtO54xMCTmY8i%2B6teOGGzbIvZQ%3D" alt="ea3fa3d3f84828b317b639b7360843b9.jpg" loading="lazy"/></p>
<h4 data-id="heading-10">综艺娱乐</h4>
<p>今年看了好些喜剧综艺，都是我喜欢的。在周末的晚上吃着晚饭，看着综艺，笑到停不下来，真的都强烈推荐！！！</p>
<ul>
<li>《花儿与少年 · 丝路季》 ⭐️⭐️⭐️⭐️⭐️</li>
<li>《乐队的夏天第一季》 ⭐️⭐️⭐️⭐️⭐️</li>
<li>《喜剧之王单口季》 ⭐️⭐️⭐️⭐️</li>
<li>《喜人奇妙夜2》 ⭐️⭐️⭐️⭐️⭐️</li>
<li>《现在就出发2》 ⭐️⭐️⭐️⭐️⭐️</li>
</ul>
<h4 data-id="heading-11">关于婚礼</h4>
<p>在国庆的时候，办了人生中最重要的一件事情，还算比较顺利</p>
<h4 data-id="heading-12">关于🚗和自驾</h4>
<p>10月份的时候，买了辆车子，虽然生活成本有所提升，但是生活品质确实不一样（就当是一项大宗消费了）。现在周末都会考虑短途旅行，200 ~300km能开到的，都能去，目前已经自驾去了黄山、宁波、舟山，明年计划去更多的地方玩耍。</p>
<h4 data-id="heading-13">关于两秒钟计划</h4>
<p>灵感来自同事在飞书上的分享，她会用2秒钟记录每天的生活，然后每个月发一个视频，来提升自己对生活的体验。所以，今年3/4月份的时候，我也记录下了我的每一天。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.douyin.com%2Fuser%2Fself%3Fmodal_id%3D7487914507407215887" target="_blank" title="https://www.douyin.com/user/self?modal_id=7487914507407215887" ref="nofollow noopener noreferrer">20253月份全记录</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.douyin.com%2Fuser%2Fself%3Fmodal_id%3D7499460451224489231" target="_blank" title="https://www.douyin.com/user/self?modal_id=7499460451224489231" ref="nofollow noopener noreferrer">20254月份全记录</a></p>
<h4 data-id="heading-14">关于冥想</h4>
<p>最近加入了一些前辈的星球，发现冥想这个话题也在重点讨论范围内，虽然这不是我第一次听到这个概念（第一次听到这个概念是在认知觉醒这本书中，第二次是在习惯的力量），但这次是我下定决心想要把冥想认真的当作一项技能来培养，希望通过冥想能够管理好自己的精力，提升自己的专注力，更好的管理自己的情绪和睡眠</p>
<h3 data-id="heading-15">理财</h3>
<p>看了孟岩写的《投资第一课》，开始学习理财知识，比较认同他的投资观念。拿零花钱进行理财投资，投资的纪律性和人性，管理好自己的预期。</p>
<p>现在的会每周定投3只基金，每只200，这样下来一年就是3w多，能坚持5 ~ 6年的话，我估计是一笔不小的钱。</p>
<p>我当下的投资逻辑：</p>
<ol>
<li><strong>纪律，纪律，还是纪律</strong>（不自作聪明瞎操作）</li>
<li>确定定投目的：30年之后，自己的退休钱</li>
<li>按照每个月<strong>闲钱</strong>的5% ~ 10%（或者说自己的零花钱，如此一来，市场的波动才不会影响你的情绪和判断，行为产生误导）</li>
</ol>
<h3 data-id="heading-16">意外收获</h3>
<p>今年有三个意外之喜：</p>
<ol>
<li>喜欢上了羽毛球这项运动，作为我的主要运动之一，冬天能在球馆打球，身体接触少，适合现阶段的我</li>
<li>罗振宇老师的文明之旅节目。本身我就对历史文化有一些兴趣，罗老师的这档节目视角独到、内容丰富，按他的说法，这档节目要做20年，从1000年一直讲到1919年</li>
<li>播客 - 知行小酒馆。“我们关注投资，更关注如何更好的生活”，好几档节目听完都醍醐灌顶，孟岩的投资第一课也作为我投资入门课程，正式开启学习投资。</li>
</ol>
<h3 data-id="heading-17">展望</h3>
<ol>
<li>
<p>希望新的一年，能够养成记录时间的习惯</p>
<ul>
<li>每周至少有2天能够详细的记录当天的时间，以30min为做小粒度）</li>
</ul>
</li>
<li>
<p>希望新的一年，能够养成记录感受的习惯</p>
<ul>
<li>每周至少有2天能够记录下当天的感受（开心的、糟心的、灵感）</li>
</ul>
</li>
<li>
<p>希望新的一年，鼻炎能够有所改善（先尝试脱敏治疗）</p>
<ul>
<li>先尝试脱敏治疗</li>
</ul>
</li>
<li>
<p>希望新的一年，发音和表达能力能够有所精进</p>
<ul>
<li>学会胸腹式呼吸法</li>
<li>表达能力在沟通中作为加分项，得到正反馈</li>
</ul>
</li>
<li>
<p>希望新的一年，在工作上继续保持稳定，保持对新事物的热情和好奇心</p>
</li>
<li>
<p>希望新的一年，任然坚持锻炼，维持体重65kg，继续完成1 ~ 2场半马，羽毛球水平达到业务4级，自由泳能够在45min内游到2km</p>
</li>
<li>
<p>希望新的一年，能够继续保持读书的习惯，一年至少能够阅读10本书</p>
</li>
<li>
<p>希望新的一年，如果幸运的话，能找到新的热爱的东西（就像今年的羽毛球、文明之旅、知行小酒馆）</p>
</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Spring AOP 专题]]></title>    <link>https://juejin.cn/post/7590929624743837746</link>    <guid>https://juejin.cn/post/7590929624743837746</guid>    <pubDate>2026-01-04T02:16:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590929624743837746" data-draft-id="7587368168621948934" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Spring AOP 专题"/> <meta itemprop="keywords" content="Spring,Spring Boot,Java"/> <meta itemprop="datePublished" content="2026-01-04T02:16:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="哪里的破水瓶"/> <meta itemprop="url" content="https://juejin.cn/user/4394111849466414"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Spring AOP 专题
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4394111849466414/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    哪里的破水瓶
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-04T02:16:27.000Z" title="Sun Jan 04 2026 02:16:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#444;background-image:linear-gradient(90deg,rgba(59,59,59,.1) 3%,transparent 0),linear-gradient(1turn,rgba(122,120,121,.1) 3%,transparent 0);background-size:30px 30px;background-position:50%;letter-spacing:1px;word-spacing:1px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{position:relative;margin-top:34px;margin-bottom:16px;font-weight:700;line-height:1.3;cursor:text;color:#444;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body h1{font-size:41px;margin-bottom:34px;line-height:1.5}.markdown-body h1:before{content:""}.markdown-body h2{font-size:30px;padding-left:.4em;border-left:.4em solid #5e5e5e;border-bottom:1px solid #444}.markdown-body h2:after{content:"🕛";position:absolute;top:0;right:0;transition:all;animation:rotate 10s linear infinite}@keyframes rotate{0%{transform:rotate(0deg)}to{transform:rotate(1turn)}}.markdown-body h3{border-left:.4em solid #8d8d8d;font-size:24px;padding-left:.4em}.markdown-body h4{font-size:20px}.markdown-body h5{font-size:16px}.markdown-body h6{font-size:14px}.markdown-body blockquote,.markdown-body dl,.markdown-body ol,.markdown-body p,.markdown-body table,.markdown-body ul{margin:.8em 0}.markdown-body strong{font-weight:1000;position:relative;color:#444;padding:0 3px}.markdown-body em{font-weight:inherit}.markdown-body a{box-sizing:border-box;color:grey;position:relative}.markdown-body a:before{position:absolute;box-sizing:border-box;content:"Go -&gt;";left:0;width:100%;max-width:0;color:#fff;background-color:hsla(0,0%,50.2%,.8);white-space:nowrap;transition:.2s ease;pointer-events:none;overflow:hidden}.markdown-body a:after{content:"";position:absolute;bottom:0;left:0;width:100%;height:1px;background-color:grey}.markdown-body a:active:before,.markdown-body a:hover:before{max-width:100%;padding-left:8px;border-radius:5px}.markdown-body hr{position:relative;width:100%;height:1px;border:none;margin-top:36px;margin-bottom:36px;background:linear-gradient(90deg,grey,#f1f1f1,#444,#444,#f1f1f1,grey);overflow:visible}.markdown-body ol,.markdown-body ul{padding-left:32px}.markdown-body ol li,.markdown-body ul li{margin-bottom:6px;list-style:inherit}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol{counter-reset:my-counter}.markdown-body ol&gt;li{padding-left:6px;list-style:none;counter-increment:my-counter;position:relative}.markdown-body ol&gt;li:before{position:absolute;left:-1.5em;content:counter(my-counter);font-weight:700}.markdown-body ol&gt;li:first-child:before{content:"1️⃣"}.markdown-body ol&gt;li:nth-child(2):before{content:"2️⃣"}.markdown-body ol&gt;li:nth-child(3):before{content:"3️⃣"}.markdown-body ol&gt;li:nth-child(4):before{content:"4️⃣"}.markdown-body ol&gt;li:nth-child(5):before{content:"5️⃣"}.markdown-body ol&gt;li:nth-child(6):before{content:"6️⃣"}.markdown-body ol&gt;li:nth-child(7):before{content:"7️⃣"}.markdown-body ol&gt;li:nth-child(8):before{content:"8️⃣"}.markdown-body ol&gt;li:nth-child(9):before{content:"9️⃣"}.markdown-body ol&gt;li:nth-child(10):before{content:"🔟"}.markdown-body ul&gt;li{list-style:none;position:relative}.markdown-body ul&gt;li:before{z-index:10;position:absolute;left:-1.57em;content:"🔹";margin-right:12px}.markdown-body ul&gt;li input{margin-left:8px!important}.markdown-body blockquote{position:relative;background-color:#d3d3d3;padding:5px 10px;border-left:.2em solid #000;border-radius:3px;transition:all .8s ease}.markdown-body blockquote:hover{opacity:.7}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(69,69,77,.8);color:#fff;font-size:.87em;padding:.07em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border-radius:7px;overflow:hidden}.markdown-body pre:before{z-index:10;position:absolute;top:14px;left:14px;width:12px;height:12px;border-radius:50%;background:#fc625d;-webkit-box-shadow:20px 0 #fdbc40,40px 0 #35cd4b;box-shadow:20px 0 #fdbc40,40px 0 #35cd4b;content:" "}.markdown-body pre:after{z-index:9;content:"";position:absolute;width:100%;height:40px;top:0;background-color:#1a1a1a}.markdown-body pre&gt;code{display:block;font-family:Menlo,Monaco,Consolas,Courier New,monospace;word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#171717;color:#bababa;font-size:14px;padding:40px 20px 20px}.markdown-body del{color:grey}.markdown-body table{margin-bottom:1.25rem;border-collapse:collapse}.markdown-body table td,.markdown-body table th{margin:0;padding:8px;line-height:20px;vertical-align:middle;border:1px solid #ddd}.markdown-body table thead,.markdown-body table tr:nth-child(2n){background-color:#fcfcfc}.markdown-body table thead th,.markdown-body table tr:nth-child(2n) th{font-weight:700;vertical-align:middle;color:#444}.markdown-body table tbody tr td{font-weight:400;color:#444}.markdown-body table tbody tr:hover{background-color:#d3d3d3}.markdown-body table tbody tr:hover td{color:#fff}.markdown-body img{max-width:100%;margin:0 12px}@media (max-width:720px){.markdown-body h1{font-size:32.8px}.markdown-body h2{font-size:24px}.markdown-body h3{font-size:19.2px}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:12.8px}}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><h2 data-id="heading-0">AOP 使用</h2>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-aop<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<p>AOP 实现</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Aspect</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RecordTimeAspect</span> {

    <span class="hljs-comment">// 我要代理的路径类中的方法</span>
    <span class="hljs-meta">@Around("execution(* com.example.controller.*.*(..))")</span>
    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">recordTime</span><span class="hljs-params">(ProceedingJoinPoint pjp)</span> <span class="hljs-keyword">throws</span> Throwable {
        System.out.println(<span class="hljs-string">"记录时间"</span>);
        <span class="hljs-type">long</span> <span class="hljs-variable">start</span> <span class="hljs-operator">=</span> System.currentTimeMillis();
        <span class="hljs-comment">// 目标方法执行</span>
        <span class="hljs-type">Object</span> <span class="hljs-variable">proceed</span> <span class="hljs-operator">=</span> pjp.proceed();

        <span class="hljs-comment">// 获取方法签名</span>
        pjp.getSignature();

        <span class="hljs-type">long</span> <span class="hljs-variable">end</span> <span class="hljs-operator">=</span> System.currentTimeMillis();
        System.out.println(<span class="hljs-string">"方法执行耗时："</span> + (end - start));
        <span class="hljs-keyword">return</span> proceed;
    }

}

</code></pre>
<h2 data-id="heading-1">AOP 的原理</h2>
<ul>
<li>连接点：表示JoinPoint 被AOP控制的方法，包含方法信息</li>
<li>通知：Advice 表示要升级的功能，也就是AOP中升级的方法</li>
<li>切入点：PointCut 表示要匹配哪些条件</li>
<li>切面：Aspect，通知+切入点</li>
<li>目标对象：Target 通知所应用的对象，也就是原始类</li>
</ul>
<p>用Service 打印命名，可以看出是代理对象还是原类。</p>
<pre><code class="hljs language-java" lang="java">helloService.getClass().getName() <span class="hljs-comment">// 下面输出表示是代理的。</span>
<span class="hljs-comment">// com.example.service.HelloService$$EnhancerBySpringCGLIB$$2a189639</span>
</code></pre>
<h2 data-id="heading-2">通知</h2>
<p>根据通知方法执行时机的不同，将通知类型分为以下常见的五类：</p>
<ul>
<li>@Around：环绕通知，此注解标注的通知方法在目标方法前、后都被执行</li>
<li>@Before：前置通知，此注解标注的通知方法在目标方法前被执行</li>
<li>@After ：后置通知，此注解标注的通知方法在目标方法后被执行，无论是否有异常都会执行</li>
<li>@AfterReturning： 返回后通知，此注解标注的通知方法在目标方法后被执行，有异常不会执行</li>
<li>@AfterThrowing ： 异常后通知，此注解标注的通知方法发生异常后执行</li>
</ul>
<blockquote>
<p>@Around环绕通知需要自己调用 ProceedingJoinPoint.proceed() 来让原始方法执行，其他通知不需要考虑目标方法执行<br/>
@Around环绕通知方法的返回值，必须指定为Object，来接收原始方法的返回值。</p>
</blockquote>
<pre><code class="hljs language-Java" lang="Java"><span class="hljs-meta">@Aspect</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RecordTimeAspect</span> {

    <span class="hljs-comment">// 定义切点</span>
    <span class="hljs-meta">@Pointcut("execution(* com.example.service.*.*(..))")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">pt</span><span class="hljs-params">()</span> {
    }

    <span class="hljs-meta">@Before("pt()")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">before</span><span class="hljs-params">(JoinPoint joinPoint)</span> {
        System.out.println(<span class="hljs-string">"开始执行方法："</span> + joinPoint.getSignature().getName());
    }

    <span class="hljs-meta">@Around("pt()")</span>
    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">recordTime</span><span class="hljs-params">(ProceedingJoinPoint pjp)</span> <span class="hljs-keyword">throws</span> Throwable {
        System.out.println(<span class="hljs-string">"记录时间"</span>);
        <span class="hljs-type">long</span> <span class="hljs-variable">start</span> <span class="hljs-operator">=</span> System.currentTimeMillis();
        <span class="hljs-comment">// 目标方法执行</span>
        <span class="hljs-type">Object</span> <span class="hljs-variable">proceed</span> <span class="hljs-operator">=</span> pjp.proceed();

        <span class="hljs-comment">// 获取方法签名</span>
        pjp.getSignature();

        <span class="hljs-type">long</span> <span class="hljs-variable">end</span> <span class="hljs-operator">=</span> System.currentTimeMillis();
        System.out.println(<span class="hljs-string">"方法执行耗时："</span> + (end - start));
        <span class="hljs-keyword">return</span> proceed;
    }

    <span class="hljs-meta">@After("pt()")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">after</span><span class="hljs-params">(JoinPoint joinPoint)</span> {
        System.out.println(<span class="hljs-string">"结束执行方法："</span> + joinPoint.getSignature().getName());
    }
    <span class="hljs-comment">// ret 方法的返回值</span>
    <span class="hljs-meta">@AfterReturning("pt()", returning = "ret")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">afterReturning</span><span class="hljs-params">(JoinPoint joinPoint, Object ret)</span> {
        System.out.println(<span class="hljs-string">"方法正常返回，返回结果为："</span> + joinPoint.getSignature().getName());
    }

    <span class="hljs-meta">@AfterThrowing("pt()", throwing = "t")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">afterThrowing</span><span class="hljs-params">(JoinPoint joinPoint, Throwable t)</span> {
        System.out.println(<span class="hljs-string">"方法异常返回，异常结果为："</span> + joinPoint.getSignature().getName());
    }

}
</code></pre>
<h2 data-id="heading-3">通知顺序</h2>
<p>如果一个方法被多个切面，切到了是都会执行的。</p>
<p>默认顺序按照类名的字母排序。</p>
<p>用 @Order(数字) 加在切面类上来控制顺序</p>
<ul>
<li>目标方法前的通知方法：数字小的先执行</li>
<li>目标方法后的通知方法：数字小的后执行</li>
</ul>
<p>大概流程是，环绕-&gt;方法运行之前，如果有多个切面，第二个切面执行，环绕-&gt;方法运行之前-&gt;方法运行结束或者方法报错 -&gt;回到环绕...如此执行。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Aspect</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-meta">@Order(3)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RecordTimeAspect</span> {
</code></pre>
<h2 data-id="heading-4">切入点表达式</h2>
<ul>
<li>介绍：描述切入点方法的一种表达式。</li>
<li>作用：用来决定项目中的哪些方法需要加入通知</li>
</ul>
<p>常见形式：</p>
<ul>
<li>execution(……)：根据方法的签名来匹配</li>
<li>@annotation(……) ：根据注解匹配</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/105fe17e053747c594ab3126f653e013~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq6YeM55qE56C05rC055O2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768098829&amp;x-signature=Zo%2FU9IS%2BCY%2FSe1XOMKNzsLvuBsE%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cb4e0af19ff9459995231d693c7b1650~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOq6YeM55qE56C05rC055O2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768098829&amp;x-signature=aZfw7MhmsYXyWCClJ%2F8%2Fz%2BkZUDs%3D" alt="image.png" loading="lazy"/></p>
<blockquote>
<p>注解方式</p>
</blockquote>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Before("@annotation(com.ruoyi.common.annotation.DataScope)")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doBefore</span><span class="hljs-params">(JoinPoint point)</span> {

}
</code></pre>
<blockquote>
<p>注解的第二种方式，可以直接获取注解</p>
</blockquote>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@DataScope(deptAlias = "dddd")</span>
<span class="hljs-keyword">public</span> String <span class="hljs-title function_">hello</span><span class="hljs-params">()</span> {

<span class="hljs-comment">// 切面类中</span>
<span class="hljs-meta">@DataScope(deptAlias = "dddd")</span>
<span class="hljs-keyword">public</span> String <span class="hljs-title function_">hello</span><span class="hljs-params">()</span> {
</code></pre>
<blockquote>
<p>JoinPoint 类</p>
</blockquote>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Before("@annotation(dataScope)")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">before</span><span class="hljs-params">(JoinPoint joinPoint, DataScope dataScope)</span> {
    <span class="hljs-comment">// 获取方法名</span>
    <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> joinPoint.getSignature().getName();
    <span class="hljs-comment">// 获取目标对象</span>
    <span class="hljs-type">Object</span> <span class="hljs-variable">target</span> <span class="hljs-operator">=</span> joinPoint.getTarget();
    <span class="hljs-comment">// 获取目标类</span>
    <span class="hljs-type">String</span> <span class="hljs-variable">name1</span> <span class="hljs-operator">=</span> target.getClass().getName();
    <span class="hljs-comment">// 获取目标方法参数</span>
    Object[] args = joinPoint.getArgs();
    <span class="hljs-comment">// 全限命名，包名+类名</span>
    <span class="hljs-type">String</span> <span class="hljs-variable">m</span> <span class="hljs-operator">=</span> signature.getDeclaringTypeName();
}
</code></pre>
<p>在Spring中用JoinPoint抽象了连接点，用它可以获得方法执行时的相关信息，如目标类名、方法名、方法参数等。</p>
<ul>
<li>对于 @Around 通知，获取连接点信息只能使用  ProceedingJoinPoint</li>
<li>对于其它四种通知，获取连接点信息只能使用 JoinPoint ，它是 ProceedingJoinPoint 的父类型</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【从0到1大模型应用开发实战】03｜写一个可解释的RAG规则检索器]]></title>    <link>https://juejin.cn/post/7590592594675695626</link>    <guid>https://juejin.cn/post/7590592594675695626</guid>    <pubDate>2026-01-03T15:43:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590592594675695626" data-draft-id="7590601860300881947" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【从0到1大模型应用开发实战】03｜写一个可解释的RAG规则检索器"/> <meta itemprop="keywords" content="后端,AIGC"/> <meta itemprop="datePublished" content="2026-01-03T15:43:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="我想问问天"/> <meta itemprop="url" content="https://juejin.cn/user/2031553218095256"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【从0到1大模型应用开发实战】03｜写一个可解释的RAG规则检索器
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2031553218095256/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    我想问问天
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-03T15:43:07.000Z" title="Sat Jan 03 2026 15:43:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">从 0 到 1 写一个“可解释”的 RAG 检索器：规则检索 V1 → V2（含可运行代码）</h2>
<p>上篇文章我们学习到了基本的Rag原理，用本地的ollama实现了一个非常简易版本的rag流程。</p>
<p>这一篇我们主要来学习下工程化的优化，用来给大模型更加准确的上下文，我们要知道： <strong>模型再强，如果某些知识不在模型训练的范围之内，甚至在网络上搜索不到很准确的信息，特别是在企业内部有很多文档和信息是网络上没有的，那么直接问大模型，输入上下文不可靠，输出就很难稳定。</strong></p>
<p>这就是 RAG（Retrieval-Augmented Generation，检索增强生成）在 AI 应用开发里最工程化的价值： <strong>把我该给模型什么上下文这件事，从玄学变成可控的检索系统。</strong></p>
<p>这一篇我们用一个完全可运行的小例子，专注讲清楚RAG里面这个R（检索）的部分： 如何在没有向量库、没有 embedding 的情况下，先实现一个 <strong>可解释、可控、可迭代</strong> 的“规则检索器”，并展示从 V1 到 V2 的演进思路。虽然没有用到哪些高级组件，但是手写的代码一步步迭代，其实我们更加能明白工程化为什么要做这些事情，为后面引入向量库，做混合检索做了铺垫。</p>
<p>本文代码对应 examples/rag/chapter02/ 下三个文件：</p>
<ul>
<li>ex04_rag_retrieve_rule_v1.py：规则检索 V1（基础可用）</li>
<li>ex05_retrieve_result.py：V2 的结果结构（可解释性）</li>
<li>ex05_rag_retrieve_rule_v2.py：规则检索 V2（打分 + 命中规则）</li>
</ul>
<h3 data-id="heading-1">1. 规则检索：它是什么？适合什么时候用？</h3>
<p>在 RAG 里，“检索”并不只有向量检索。我们完全可以先从 <strong>规则检索</strong> 起步。</p>
<h4 data-id="heading-2">1.1 规则检索 vs 向量检索（我们现在更需要哪个？）</h4>
<ul>
<li>
<p><strong>规则检索</strong></p>
<ul>
<li>优点：可解释、可控、上线快、无依赖（不需要向量库 / embedding）</li>
<li>缺点：覆盖面有限，规则维护成本会上升</li>
<li>适合：内部知识库早期、文档结构清晰、关键词/项目代号明显、需要强可控的场景</li>
</ul>
</li>
<li>
<p><strong>向量检索</strong></p>
<ul>
<li>优点：语义召回强，对同义改写更友好</li>
<li>缺点：解释性弱；需要 embedding、向量库；调参（chunk、topk、阈值）更“工程化”</li>
<li>适合：知识面大、表达多样、需要更强召回的场景</li>
</ul>
</li>
</ul>
<p><strong>一个很实用的路线</strong>： 先用规则检索把系统跑起来（保证可控 + 可解释），再逐步引入向量检索补召回，最终形成"混合检索"。RAG里面的R就是在用各种方式来提高检索的质量，一个是找到更多可能的信息，第二个是在可能的信息里面找到最相关的一些信息。下面的多个规则来检索就是为了找到更多的信息，保证不会漏掉有用的信息，然后里面的给信息打分就是为了找到最相关最匹配的文段。</p>
<h4 data-id="heading-3">1.2 规则检索 vs 搜索引擎（技术思路很相似）</h4>
<p>我们在举一个例子和我们平常用到非常多的浏览器搜索一样，如果你熟悉搜索引擎的工作原理，会发现规则检索的思路其实很相似：</p>
<ul>
<li><strong>查询预处理</strong>：搜索引擎会分词、去停用词、拼写纠错；我们的 normalize_query 也是去噪声词、提取关键词</li>
<li><strong>关键词匹配</strong>：搜索引擎用倒排索引（关键词 → 文档列表）；我们直接在 page_content 中匹配关键词</li>
<li><strong>评分排序</strong>：搜索引擎用 TF-IDF、BM25 等综合评分；我们的 V2 用 score 机制（内容命中+3、项目名+2 等）</li>
<li><strong>过滤机制</strong>：搜索引擎按时间、类型、站点过滤；我们按 metadata（项目、类型、权限）过滤</li>
<li><strong>可解释性</strong>：搜索引擎会高亮匹配词；我们的 V2 用 hit_rules 记录命中原因</li>
</ul>
<p><strong>核心区别</strong>：</p>
<ul>
<li>搜索引擎面向全网（亿级数据），目标是"找到相关网页，用户自己阅读"</li>
<li>RAG 规则检索面向企业内部知识库（千到万级），目标是"找到精确文档，给 LLM 做上下文"</li>
</ul>
<p>所以 RAG 检索对<strong>精确性</strong>要求更高（宁可少召回，也不能误导 LLM），而搜索引擎更注重<strong>召回率</strong>（宁可多召回，让用户自己筛选）。</p>
<hr/>
<h3 data-id="heading-4">2. 这三个文件在做什么（先建立整体视角）</h3>
<p>它们合起来的目标很简单： 给定用户 query，从一组 Document 里挑出最相关的 top_k 条。</p>
<p>我们可以把它理解成一个最小 RAG 检索模块：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a21ba0507fff4558975d332476dfc1cc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oiR5oOz6Zeu6Zeu5aSp:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768059787&amp;x-signature=qOyi9v9lVXHCwQLRlN5xI0X%2F%2FeU%3D" alt="image-20260103233046682" loading="lazy"/></p>
<p>在代码里我们用 langchain_core.documents.Document 来承载文档内容与元数据（page_content + metadata），而不是自己在造一个对象，是为了以后无缝接入 LangChain 的后续链路。</p>
<hr/>
<h3 data-id="heading-5">3. V1：能跑起来的规则检索（ex04_rag_retrieve_rule_v1.py）</h3>
<p>V1 的关键词：简单、直观、可运行。 它做了两件关键事：</p>
<ol start="0">
<li>把 query 做"降噪"，变成高信息密度关键词（normalize_query） 注：这一步其实非常重要，如果我们把这个步骤去掉，在我们使用纯规则去匹配的情况下，比如只用了关键词，然后问题是“什么是蓝精灵协议”，这个就匹配不出来。或者用户的问题有很多的没用信息“今天我吃了三个冰淇淋，两个水果，告诉我什么是蓝精灵协议？” 这也很令人头痛，用户带了很多没用的信息，甚至比要检索的东西还多，这个在真实场景里面是极有可能发生的。所以需要做降噪，去掉无用的信息（就是噪声），我们这里主要是为了方便演示，所以只做了简单的规则，去掉"什么是？"，“请介绍”等简单的词语，你只要明白要有个处理的过程就行，具体真正的生产场景比这个复杂太多。</li>
</ol>

<ol start="2">
<li>按一组规则筛选 Document，并返回 top_k（retrieve）</li>
</ol>
<h4 data-id="heading-6">3.1 Query 降噪：把自然语言变成关键词</h4>
<p>V1 的 normalize_query 用非常朴素但有效的方法：</p>
<ul>
<li>去掉“什么是/请介绍/吗/？”等口水词</li>
<li>按空格和标点切分</li>
<li>去掉过短的 token</li>
</ul>
<p>核心片段（与源码一致，做了缩短便于阅读）：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">normalize_query</span>(<span class="hljs-params">query: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>]:
    q = query.lower().strip()
    noise_patterns = [<span class="hljs-string">r"什么是"</span>, <span class="hljs-string">r"请介绍"</span>, <span class="hljs-string">r"介绍一下"</span>, <span class="hljs-string">r"是什么"</span>, <span class="hljs-string">r"如何"</span>, <span class="hljs-string">r"怎么"</span>, <span class="hljs-string">r"吗"</span>, <span class="hljs-string">r"?"</span>, <span class="hljs-string">r"？"</span>]
    <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> noise_patterns:
        q = re.sub(p, <span class="hljs-string">""</span>, q)
    tokens = re.split(<span class="hljs-string">r"\s+|，|,|。|；|;"</span>, q)
    tokens = [t.strip() <span class="hljs-keyword">for</span> t <span class="hljs-keyword">in</span> tokens <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(t.strip()) &gt;= <span class="hljs-number">2</span>]
    <span class="hljs-keyword">return</span> tokens
</code></pre>
<p>我们会发现：这一步不"智能"，但它是 <strong>工程上最划算的第一步</strong>。 因为它把后续规则命中率显著提高，同时可解释、可调。</p>
<h4 data-id="heading-7">3.2 V1 的五层规则（从强到弱）</h4>
<p>V1 的 retrieve 里，规则是分层的（非常重要）：</p>
<ol start="0">
<li><strong>强规则短路</strong>：项目名直命中（如 aurora-42）就直接返回（保证"我问项目就一定拿到项目文档"）</li>
<li><strong>关键词命中</strong>：任何关键词出现在正文，就收集为候选</li>
<li><strong>metadata 过滤</strong>：例如问协议,就只保留 doc_type == protocol</li>
<li><strong>去重</strong></li>
<li><strong>TopK 截断</strong></li>
</ol>
<p>我们可以把它当成一条"可控管道"，每一步都能解释。</p>
<h4 data-id="heading-8">3.3 运行 V1</h4>
<p>在项目根目录执行：</p>
<pre><code class="hljs language-bash" lang="bash">python examples/rag/chapter02/ex04_rag_retrieve_rule_v1.py
</code></pre>
<p>我们会看到每个 query 返回的 Document 列表。 这就是最小可用的规则检索器：不花哨，但能把检索这件事落地。</p>
<hr/>
<h3 data-id="heading-9">4. V2：加入打分与可解释性（ex05_retrieve_result.py + ex05_rag_retrieve_rule_v2.py）</h3>
<p>V1 的问题是： 命中了就是命中，但“谁更相关”缺少排序依据；也很难解释“为什么命中”。虽然反复执行得到的结果是一样的，但是你没法解释，哪一条应该是放到最前面，最可能是用户想问的。那么咱们就升级到V2版本。</p>
<p>V2 的升级目标很明确：</p>
<ol start="0">
<li>每个候选文档都有一个 <strong>score</strong></li>
<li>每个候选文档记录 <strong>命中规则 hit_rules</strong>（解释性）</li>
<li>最后按 score 排序，取 top_k</li>
</ol>
<h4 data-id="heading-10">4.1 用数据类承载“可解释结果”</h4>
<p>ex05_retrieve_result.py 定义了一个非常干净的结构：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> dataclasses <span class="hljs-keyword">import</span> dataclass
<span class="hljs-keyword">from</span> langchain_core.documents <span class="hljs-keyword">import</span> Document
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">List</span>
​
<span class="hljs-meta">@dataclass</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">RetrieveResult</span>:
    document: Document
    score: <span class="hljs-built_in">int</span>
    hit_rules: <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>]
</code></pre>
<p>这个结构特别关键： 它把检索结果从 Document 本体里拆开，避免把评分与解释塞进 metadata变得混乱。</p>
<h4 data-id="heading-11">4.2 V2 的打分规则（工程上最常用的套路）</h4>
<p>V2 做了三类规则，并给不同权重：</p>
<ul>
<li><strong>R1：内容关键词命中</strong>（+3）</li>
<li><strong>R2：项目名命中</strong>（+2）</li>
<li><strong>R3：协议类过滤命中</strong>（+2）</li>
</ul>
<p>同时把每次命中的规则写进 hit_rules，例如：</p>
<ul>
<li>content_hit:蓝精灵协议</li>
<li>project_hit:aurora-42</li>
<li>protocol_match</li>
</ul>
<p>核心逻辑：</p>
<pre><code class="hljs language-ini" lang="ini">def retrieve(query: str, top_k: <span class="hljs-attr">int</span> = <span class="hljs-number">3</span>) -&gt; List[Document]:
    <span class="hljs-attr">keywords</span> = normalize_query(query)
    results: List<span class="hljs-section">[RetrieveResult]</span> = <span class="hljs-section">[]</span>
​
    for doc in DOCUMENTS:
        <span class="hljs-attr">score</span> = <span class="hljs-number">0</span>
        <span class="hljs-attr">hit_rules</span> = []
​
        <span class="hljs-attr">content_lower</span> = doc.page_content.lower()
​
        <span class="hljs-comment"># ---------- R1：内容关键词命中 ----------</span>
        for kw in keywords:
            if kw in content_lower:
                score += 3
                hit_rules.append(f"content_hit:{kw}")
​
        <span class="hljs-comment"># ---------- R2：项目名命中 ----------</span>
        <span class="hljs-attr">project</span> = doc.metadata.get(<span class="hljs-string">"project"</span>, <span class="hljs-string">""</span>).lower()
        for kw in keywords:
            if kw in project:
                score += 2
                hit_rules.append(f"project_hit:{kw}")
​
        <span class="hljs-comment"># ---------- R3：协议类文档 ----------</span>
        if ("协议" in query or "protocol" in query.lower()) \
           and doc.metadata.get("doc_type") == "protocol":
            score += 2
            hit_rules.append("protocol_match")
​
        if score &gt; 0:
            results.append(
                RetrieveResult(
                    <span class="hljs-attr">document</span>=doc,
                    <span class="hljs-attr">score</span>=score,
                    <span class="hljs-attr">hit_rules</span>=hit_rules
                )
            )
​
    <span class="hljs-comment"># ---------- 排序 ----------</span>
    results.sort(<span class="hljs-attr">key</span>=lambda x: x.score, reverse=<span class="hljs-literal">True</span>)
​
    <span class="hljs-comment"># ---------- DEBUG（强烈建议我们保留） ----------</span>
    for r in results:
        print(f"<span class="hljs-section">[score={r.score}]</span> <span class="hljs-attr">rules</span>={r.hit_rules}<span class="hljs-string">")
        print(r.document.page_content)
        print("</span>----<span class="hljs-string">")
​
    return [r.document for r in results[:top_k]]
</span></code></pre>
<h4 data-id="heading-12">4.3 为什么 V2 更“能上线”？</h4>
<p>因为它解决了 RAG 检索工程化的两大痛点：</p>
<ul>
<li><strong>排序可控</strong>：我们可以通过权重调节"更相关"的定义</li>
<li><strong>解释可追踪</strong>：线上出现 badcase，可以快速定位规则与权重</li>
</ul>
<p>此外，V2 还保留了非常建议我们保留的 DEBUG 输出：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">for</span> r <span class="hljs-keyword">in</span> results:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"[score=<span class="hljs-subst">{r.score}</span>] rules=<span class="hljs-subst">{r.hit_rules}</span>"</span>)
</code></pre>
<h4 data-id="heading-13">4.4 运行 V2</h4>
<p>在项目根目录执行：</p>
<pre><code class="hljs language-bash" lang="bash">python examples/rag/chapter02/ex05_rag_retrieve_rule_v2.py
</code></pre>
<p>我们会看到每条候选文档的 score 与 hit_rules，从而直观看到"为什么它排在前面"。</p>
<hr/>
<h3 data-id="heading-14">5. 展示建议：生产场景一般怎么定义规则？</h3>
<p>下面给一套更贴近生产的规则定义方式（不讲概念，直接给方法）。核心原则：<strong>从强到弱</strong>、<strong>可解释</strong>、<strong>可开关</strong>、<strong>可回滚</strong>。</p>
<h4 data-id="heading-15">5.1 先定义强规则（必须命中、允许短路）</h4>
<p>强规则通常来自业务里的“唯一标识”，命中就直接返回（或强加分）：</p>
<ul>
<li><strong>ID/编号类</strong>：项目代号（aurora-42）、工单号、合同号、设备编号、产品型号</li>
<li><strong>专有名词类</strong>：协议名、系统名、模块名、内部缩写</li>
<li><strong>固定问法类</strong>：例如“某某项目启动时间”“某某协议定义是什么”</li>
</ul>
<p>落地建议：</p>
<ul>
<li><strong>先做抽取</strong>：用正则/词典把这些标识从 query 里抽出来（类似 V1 的 normalize_query，但更“业务化”）</li>
<li><strong>做索引</strong>：把文档按 project/doc_type/version/owner 等 metadata 建索引，强规则命中直接从索引取候选</li>
</ul>
<h4 data-id="heading-16">5.2 再定义加分规则（决定排序）</h4>
<p>把“相关性”拆成多条可加权的信号，并记录到 hit_rules（类似 V2 的做法）：</p>
<ul>
<li><strong>内容命中</strong>：关键词出现在 page_content（可按词频、位置、标题加权）</li>
<li><strong>字段命中</strong>：关键词命中 metadata（例如 project、doc_type、tags）</li>
<li><strong>意图匹配</strong>：query 含“协议/流程/报错/部署”等意图词 → 只给对应类型文档加分</li>
</ul>
<p>落地建议：</p>
<ul>
<li><strong>所有加分都要可追踪</strong>：像 content_hit:xxx、project_hit:xxx、protocol_match 这样记录命中原因</li>
<li><strong>权重用配置管理</strong>：把 +3/+2 做成可调参数，便于线上快速调优</li>
</ul>
<h4 data-id="heading-17">5.3 最后定义过滤规则（做安全与边界）</h4>
<p>过滤规则一般用于把“不该给模型看的”或“明显不相关的”剔掉：</p>
<ul>
<li><strong>权限过滤</strong>：按部门/角色/租户过滤（最常见）</li>
<li><strong>版本过滤</strong>：只保留最新版本或指定版本（避免旧文档污染）</li>
<li><strong>类型过滤</strong>：问"协议"只保留 doc_type == protocol</li>
</ul>
<p>落地建议：</p>
<ul>
<li><strong>过滤优先级高于加分</strong>：先过滤再排序，避免无权限文档进入候选集</li>
<li><strong>每条规则可独立开关</strong>：出问题可以快速回滚（线上非常关键）</li>
</ul>
<hr/>
<h3 data-id="heading-18">6. 总结：从规则开始，把 RAG 做成工程</h3>
<p>这篇我们用 chapter02 的三个文件，实现了一个可运行,可解释,可迭代 的规则检索器，并展示了 V1 → V2 的演进：</p>
<ul>
<li>V1：规则管道 + 简单可用</li>
<li>V2：引入结果结构 + 打分排序 + 命中规则解释</li>
</ul>
<p>后续我们可以继续往前走两步，就是我后面要写的教程：</p>
<ol start="0">
<li>用向量检索补召回（embedding + vector store）</li>
<li>做混合检索（规则检索做强约束，向量检索做召回补充）</li>
</ol>
<p>到这里，我们会真正把"AI 应用开发"从调用模型，走向可控的系统工程。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🚀 2025 年 12 月 GitHub 十大热门项目排行榜 🔥]]></title>    <link>https://juejin.cn/post/7591079707698315274</link>    <guid>https://juejin.cn/post/7591079707698315274</guid>    <pubDate>2026-01-04T02:38:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7591079707698315274" data-draft-id="7590735421261774889" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🚀 2025 年 12 月 GitHub 十大热门项目排行榜 🔥"/> <meta itemprop="keywords" content="GitHub,人工智能,前端"/> <meta itemprop="datePublished" content="2026-01-04T02:38:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="一点一木"/> <meta itemprop="url" content="https://juejin.cn/user/1063982986187486"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🚀 2025 年 12 月 GitHub 十大热门项目排行榜 🔥
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1063982986187486/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    一点一木
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-04T02:38:20.000Z" title="Sun Jan 04 2026 02:38:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>欢迎来到 <strong>2025 年 12 月 <code>GitHub</code> 热门开源项目排行榜</strong>！本月榜单继续聚焦 <code>AI Agent</code> 生态的深度演进、终端优先的开源替代、语音生成技术的全面爆发，以及高性能基础设施与标准化协作规范的崛起。这十个项目涵盖了从编码代理持久记忆到可视化 <code>Agent</code> 构建平台、从 <code>Rust</code> 高性能存储到领先开源 <code>TTS</code> 模型，清晰展现出当下三大核心趋势：</p>
<ul>
<li><strong><code>Agent</code> 生态成熟化</strong>：持久记忆、可视化构建、标准化指导与快速启动模板全面开花</li>
<li><strong>终端与开源替代浪潮</strong>：终端优先编码代理、<code>AI</code> 代理专用规范强势崛起</li>
<li><strong>多模态与基础设施升级</strong>：语音生成模型集体 <code>SOTA</code>、高性能存储与本地化框架并进</li>
</ul>
<p>它们不再是概念验证，而是真正能直接落地上线的生产力工具。快来一起看看本月十大热门！</p>
<ol>
<li>
<h3 data-id="heading-0"><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fthedotmack%2Fclaude-mem" target="_blank" title="https://github.com/thedotmack/claude-mem" ref="nofollow noopener noreferrer"><code>Claude-Mem</code></a></h3>
<p>🌟 <strong><code>Star</code> 数：<code>9.4K+</code></strong></p>
<p>🧠 <strong><code>Claude Code</code> 的持久记忆插件</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c24a6940c0654da6a14d995db73add5e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA54K55LiA5pyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768099100&amp;x-signature=RBA1FzfQOFEuBFzfVS0cv7qtovU%3D" alt="claude-men" loading="lazy"/></p>
<p><strong><code>Claude-Mem</code></strong> 能自动捕捉编码会话中 <code>Claude</code> 的所有操作，使用 <code>AI</code>（基于 <code>Claude agent-sdk</code>）压缩上下文，并在后续会话中智能注入相关记忆，实现真正的跨会话知识连续性，彻底解决 <code>Claude</code> 「失忆」的痛点。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ffbd56bfca0848d1829b6012ad978152~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA54K55LiA5pyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768099100&amp;x-signature=l8LeyCJAicgekyZUn9IAV4w4i8A%3D" alt="cm-preview" loading="lazy"/></p>
<p>它通过生命周期钩子、后台 <code>worker</code> 服务、<code>SQLite</code> 存储和 <code>Chroma</code> 向量数据库，实现语义摘要生成与高效检索，支持渐进式上下文注入，确保 <code>token</code> 使用最优化。</p>
<ul>
<li><strong>持久记忆</strong> ：上下文自动跨会话存活，新会话无需手动恢复历史</li>
<li><strong>渐进式披露</strong> ：分层注入记忆，显示 <code>token</code> 成本，避免 <code>overload</code></li>
<li><strong>技能搜索</strong> ：内置 <code>mem-search</code>，支持自然语言查询项目历史</li>
<li><strong><code>Web</code> 查看器 <code>UI</code></strong> ：实时监控记忆流</li>
<li><strong>隐私控制</strong> ：使用 <code>&lt;private&gt;</code> 标签排除敏感内容不存储</li>
<li><strong>自动运行</strong> ：全程后台智能处理，无需手动干预</li>
</ul>
<p>💡 <strong><code>Claude-Mem</code></strong> 适合重度使用 <code>Claude Code</code> 开发中大型项目的工程师，能显著提升开发连续性、节省 <code>token</code>，尤其在长期迭代场景下价值巨大。</p>
<p>👉 <strong>立即体验</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fthedotmack%2Fclaude-mem" target="_blank" title="https://github.com/thedotmack/claude-mem" ref="nofollow noopener noreferrer"><code>GitHub</code></a></p>
</li>
<li>
<h3 data-id="heading-1"><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fdatawhalechina%2Fhello-agents" target="_blank" title="https://github.com/datawhalechina/hello-agents" ref="nofollow noopener noreferrer"><code>Hello-Agents</code></a></h3>
<p>🌟 <strong><code>Star</code> 数：<code>13.2K+</code></strong></p>
<p>📚 <strong><code>Datawhale</code> 社区出品的从零构建 <code>AI Native Agent</code> 开源教程</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5438c2cf83ea4b22bde5653ef566b947~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA54K55LiA5pyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768099100&amp;x-signature=kOXtZa2%2Fpd4BktKlnMA74fKPz2k%3D" alt="hello-agents" loading="lazy"/></p>
<p><strong><code>Hello-Agents</code></strong> 是 <code>Datawhale</code> 推出的系统性智能体学习项目，在 2025 <code>Agent</code> 元年背景下填补了重实践教程的空白，帮助开发者从 <code>LLM</code> 使用者转变为真正的智能体系统构建者。</p>
<p>项目提供完整学习路径，涵盖 <code>Agent</code> 基础原理、经典范式（如 <code>ReAct</code>）、低代码平台与主流框架实战、记忆检索、通信协议、<code>Agentic-RL</code> 训练、性能评估，以及多个真实综合案例，全部内容开源免费并支持社区贡献。</p>
<ul>
<li><strong>理论实战并重</strong> ：从核心概念到自研框架 <code>HelloAgents</code> 的完整实现</li>
<li><strong>多路径学习</strong> ：覆盖 <code>Coze/Dify</code> 等低代码、<code>LangGraph/AutoGen</code> 等框架及从零构建</li>
<li><strong>高级技术覆盖</strong> ：记忆检索、上下文工程、<code>MCP/A2A</code> 协议、<code>Agentic-RL</code> 全流程</li>
<li><strong>真实案例驱动</strong> ：智能旅行助手、深度研究 <code>Agent</code>、赛博小镇等实战项目</li>
<li><strong>社区共建支持</strong> ：<code>Extra-Chapter</code> 贡献、面试题总结、<code>PDF</code> 下载与持续更新</li>
</ul>
<p>💡 <strong><code>Hello-Agents</code></strong> 适合具备 <code>Python</code> 基础、对 <code>LLM</code> 有初步了解的 <code>AI</code> 开发者、学生与自学者，尤其在求职面试、个人项目或深入 <code>Agent</code> 技术时价值巨大。</p>
<p>👉 <strong>立即探索</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fdatawhalechina%2Fhello-agents" target="_blank" title="https://github.com/datawhalechina/hello-agents" ref="nofollow noopener noreferrer"><code>GitHub</code></a></p>
</li>
<li>
<h3 data-id="heading-2"><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Frustfs%2Frustfs" target="_blank" title="https://github.com/rustfs/rustfs" ref="nofollow noopener noreferrer"><code>RustFS</code></a></h3>
<p>🌟 <strong><code>Star</code> 数：<code>18.5K+</code></strong></p>
<p><strong>🚀 用 <code>Rust</code> 编写的 <code>S3</code> 兼容高性能分布式对象存储</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4e2b25084e954f88bee3de5c3a67b175~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA54K55LiA5pyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768099100&amp;x-signature=pbh71ZZUFgbeMHmmJx1lY6kXOMw%3D" alt="RustFS" loading="lazy"/></p>
<p><strong><code>RustFS</code></strong> 是一个开源的分布式对象存储系统，结合 <code>MinIO</code> 的简易性和 <code>Rust</code> 的内存安全与极致性能，提供完整的 <code>S3 API</code> 兼容性，支持与 <code>MinIO</code>、<code>Ceph</code> 等平台的无缝迁移与共存，尤其适合数据湖、<code>AI</code> 和大数据工作负载。</p>
<p>它在小对象场景下性能突出（4KB 对象负载比 <code>MinIO</code> 快 2.3 倍），采用 <code>Apache 2.0</code> 开源协议、无遥测数据上传，确保合规性，同时支持单节点与分布式部署（分布式模式持续完善中）。</p>
<ul>
<li><strong>极致性能</strong> ：<code>Rust</code> 实现，<code>4KB</code> 小对象场景下 2.3x 快于 <code>MinIO</code></li>
<li><strong>完整 <code>S3</code> 兼容</strong> ：无缝替代或迁移 <code>MinIO/Ceph</code> 等现有系统</li>
<li><strong>分布式架构</strong> ：支持水平扩展与容错，适用于大规模存储</li>
<li><strong><code>Apache 2.0</code> 许可</strong> ：无 <code>AGPL</code> 限制，完全开源无遥测</li>
<li><strong>数据保护</strong> ：内置 <code>Bitrot</code> 保护与版本控制</li>
<li><strong>易部署管理</strong> ：提供 <code>Helm</code> 图表、<code>Docker</code> 多架构镜像与 <code>Nix</code> 支持</li>
</ul>
<p>💡 <strong><code>RustFS</code></strong> 适合需要高性能 <code>S3</code> 兼容存储的企业、<code>AI</code>/大数据团队，以及追求许可自由与隐私合规的开发者，尤其在边缘/<code>IoT</code> 或小对象密集场景下优势明显。</p>
<p>👉 <strong>立即探索</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Frustfs%2Frustfs" target="_blank" title="https://github.com/rustfs/rustfs" ref="nofollow noopener noreferrer"><code>GitHub</code></a></p>
</li>
<li>
<h3 data-id="heading-3"><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fsimstudioai%2Fsim" target="_blank" title="https://github.com/simstudioai/sim" ref="nofollow noopener noreferrer"><code>sim</code></a></h3>
<p>🌟 <strong><code>Star</code> 数：<code>24.6K+</code></strong></p>
<p>🤖 <strong>开源可视化平台，用于构建和部署 <code>AI Agent</code> 工作流</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ed320e9b476d4c7192c0904b12148f49~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA54K55LiA5pyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768099100&amp;x-signature=XH1VE3sp4BCbvESCtnD2Atb2k8E%3D" alt="sim" loading="lazy"/></p>
<p><strong><code>sim</code></strong> 是一个强大的开源工具，让开发者通过拖拽式画布可视化设计、连接和运行 <code>AI Agent</code> 工作流，支持自然语言 <code>Copilot</code> 辅助生成节点，帮助快速构建复杂自动化流程。</p>
<p>它内置向量数据库支持文档上传与 <code>RAG</code> 问答，完美兼容本地/自托管模型（如 <code>Ollama</code> 和 <code>vLLM</code>），提供完整自部署能力，彻底实现隐私可控的 <code>Agent</code> 系统开发与生产部署。</p>
<ul>
<li><strong>可视化画布</strong> ：拖拽连接 <code>Agent</code>、工具和模块，快速设计复杂工作流</li>
<li><strong><code>Copilot</code> 辅助</strong> ：自然语言生成节点、修复错误、迭代优化流程</li>
<li><strong>向量数据库集成</strong> ：上传文档实现内容接地式 <code>RAG</code> 查询</li>
<li><strong>本地模型支持</strong> ：无缝对接 <code>Ollama</code>（<code>CPU/GPU</code>）和 <code>vLLM</code> 自托管推理</li>
<li><strong>完整自部署</strong> ：<code>Docker</code>、一键 <code>NPM</code> 或手动 <code>Bun/Node</code> 部署，无云依赖</li>
<li><strong>实时与后台任务</strong> ：<code>Socket.io</code> 实时交互 + <code>Trigger.dev</code> 后台作业</li>
</ul>
<p>💡 <strong><code>sim</code></strong> 适合希望快速原型化、测试和生产部署 <code>AI Agent</code> 工作流的开发者与团队，尤其在需要本地化、隐私保护或自定义 RAG 场景下表现出色。</p>
<p>👉 <strong>立即体验</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fsimstudioai%2Fsim" target="_blank" title="https://github.com/simstudioai/sim" ref="nofollow noopener noreferrer"><code>GitHub</code></a></p>
</li>
<li>
<h3 data-id="heading-4"><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fsst%2Fopencode" target="_blank" title="https://github.com/sst/opencode" ref="nofollow noopener noreferrer"><code>OpenCode</code></a></h3>
<p>🌟 <strong><code>Star</code> 数：<code>43.6K+</code></strong></p>
<p>🤖 <strong>开源终端优先的 <code>AI</code> 编码代理</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5de4a08ffe29424584e081d02746e31c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA54K55LiA5pyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768099100&amp;x-signature=rwh5tEfLQRGH7Kvod1TEZ94AOxk%3D" alt="OpenCode" loading="lazy"/></p>
<p><strong><code>OpenCode</code></strong> 是完全开源的 <code>AI</code> 编码代理，采用终端界面（<code>TUI</code>）设计，支持多模型提供商，通过客户端/服务器架构实现灵活部署，帮助开发者高效处理代码编写、分析与规划任务。</p>
<p>它提供双代理模式（<code>build</code> 全权限开发、<code>plan</code> 只读探索）、内置通用子代理处理复杂任务，并原生支持 <code>LSP</code> 协议，定位为 <code>Claude Code</code> 等闭源工具的强大开源替代品。</p>
<ul>
<li><strong>完全开源无绑定</strong> ：支持 <code>Claude</code>、<code>OpenAI</code>、<code>Google</code>、本地模型等多种提供商</li>
<li><strong>双代理模式</strong> ：<code>build</code> 代理全访问开发，<code>plan</code> 代理只读安全探索</li>
<li><strong>客户端/服务器架构</strong> ：支持远程控制，本地运行更灵活</li>
<li><strong>内置通用子代理</strong> ：<code>@general</code> 调用处理多步骤复杂搜索任务</li>
<li><strong>原生 <code>LSP</code> 支持</strong> ：开箱即用增强代码补全与智能辅助</li>
<li><strong>多平台部署</strong> ：<code>CLI</code>、桌面 <code>App</code>（<code>macOS/Windows/Linux</code>）、多种包管理器安装</li>
</ul>
<p>💡 <strong><code>OpenCode</code></strong> 适合终端重度用户、<code>Neovim</code> 爱好者以及需要开源、可自定义 <code>AI</code> 编码助手的开发者，尤其在处理大型或陌生代码库时表现出色。</p>
<p>👉 <strong>立即体验</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fsst%2Fopencode" target="_blank" title="https://github.com/sst/opencode" ref="nofollow noopener noreferrer"><code>GitHub</code></a></p>
</li>
<li>
<h3 data-id="heading-5"><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fagentsmd%2Fagents.md" target="_blank" title="https://github.com/agentsmd/agents.md" ref="nofollow noopener noreferrer"><code>AGENTS.md</code></a></h3>
<p>🌟 <strong><code>Star</code> 数：<code>13.5K+</code></strong></p>
<p>📝 <strong>专为 <code>AI</code> 编码代理设计的开源指导文件格式</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3e620f6dd35c4dc9a3c7beba60de0c27~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA54K55LiA5pyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768099100&amp;x-signature=cU9mXICPkZuQ0gPAsh2SJ7M7cbw%3D" alt="AGENTS" loading="lazy"/></p>
<p><strong><code>AGENTS.md</code></strong> 提出了一种简单开放的标准：在项目根目录放置一个名为 <code>AGENTS.md</code> 的文件，专门为 <code>AI</code> 编码代理（如 <code>Claude Code</code>、<code>OpenCode</code> 等）提供上下文、开发流程、测试规范和 PR 规则，帮助代理快速理解并高效贡献代码。</p>
<p>它将传统 <code>README</code> 中的人类阅读部分与机器导向的精确指令分离，通过可预测的位置和结构化内容，显著降低 <code>AI</code> 代理在陌生代码库中的摩擦，目前已配套官网示例和社区讨论，正在推动成为行业事实标准。</p>
<ul>
<li><strong>专用代理 <code>README</code></strong> ：独立于人类 <code>README</code>，专供 <code>AI</code> 代理读取上下文和指令</li>
<li><strong>标准化结构</strong> ：涵盖开发环境、测试流程、PR 规范等关键环节</li>
<li><strong><code>Monorepo</code> 友好</strong> ：内置 <code>pnpm/Turborepo/Vitest</code> 等常见工具链指导</li>
<li><strong>强制质量门控</strong> ：明确要求 <code>lint</code>、<code>typecheck</code> 和测试通过后再提交</li>
<li><strong><code>PR</code> 标题规范</strong> ：强制带项目范围的前缀，确保变更清晰可溯源</li>
<li><strong>社区驱动开源</strong> ：完全开放格式，配套网站提供示例</li>
</ul>
<p>💡 <strong><code>AGENTS.md</code></strong> 适合所有希望与 <code>AI</code> 编码代理深度协作的团队，尤其在 <code>monorepo</code>、大型 <code>TypeScript/React</code> 项目中，能大幅提升代理贡献的准确性和效率。</p>
<p>👉 <strong>立即探索</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fagentsmd%2Fagents.md" target="_blank" title="https://github.com/agentsmd/agents.md" ref="nofollow noopener noreferrer"><code>GitHub</code></a></p>
</li>
<li>
<h3 data-id="heading-6"><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fanthropics%2Fclaude-quickstarts" target="_blank" title="https://github.com/anthropics/claude-quickstarts" ref="nofollow noopener noreferrer"><code>Claude Quickstarts</code></a></h3>
<p>🌟 <strong><code>Star</code> 数：<code>13K+</code></strong></p>
<p>🚀 <strong><code>Anthropic</code> 官方 <code>Claude API</code> 快速启动项目合集</strong></p>
<p><strong><code>Claude Quickstarts</code></strong> 是 <code>Anthropic</code> 官方推出的开源项目集合，提供多个开箱即用的模板，帮助开发者快速构建并部署基于 <code>Claude API</code> 的生产级应用，涵盖从客服代理到自主编码的多种真实场景。</p>
<p>每个 <code>Quickstart</code> 都配备完整代码、依赖和运行指南，支持最新 <code>Claude</code> 模型与工具（如浏览器自动化、电脑控制），便于自定义扩展，已成为使用 <code>Claude API</code> 开发者的首选起点。</p>
<ul>
<li><strong>多场景模板</strong> ：客服支持代理、金融数据分析师、浏览器自动化、电脑控制演示、自主编码代理</li>
<li><strong>最新工具支持</strong> ：完整实现 <code>browser_use</code> 和 <code>computer_use API</code>，包括缩放、坐标操作</li>
<li><strong>双语言实现</strong> ：<code>Python</code> 与 <code>TypeScript/JavaScript</code> 双版本覆盖主流后端/前端</li>
<li><strong>生产就绪</strong> ：集成 <code>Agent SDK</code>、<code>Playwright</code>、交互可视化与持久化进度</li>
<li><strong>持续更新</strong> ：最近新增浏览器演示与 <code>Claude Haiku 4.5</code> 支持</li>
</ul>
<p>💡 <strong><code>Claude Quickstarts</code></strong> 适合想要快速原型化或生产部署 <code>Claude</code> 应用的开发者，尤其在探索计算机使用、浏览器自动化或自主 <code>Agent</code> 场景时，能大幅缩短从零到落地的周期。</p>
<p>👉 <strong>立即探索</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fanthropics%2Fclaude-quickstarts" target="_blank" title="https://github.com/anthropics/claude-quickstarts" ref="nofollow noopener noreferrer"><code>GitHub</code></a></p>
</li>
<li>
<h3 data-id="heading-7"><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTencent%2FWeKnora" target="_blank" title="https://github.com/Tencent/WeKnora" ref="nofollow noopener noreferrer"><code>WeKnora</code></a></h3>
<p>🌟 <strong><code>Star</code> 数：<code>10.6K+</code></strong></p>
<p>🧠 <strong>腾讯开源的 <code>LLM</code> 驱动深度文档理解与 <code>RAG</code> 框架</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8ad57c02e01d4d48885233efc5d81eed~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA54K55LiA5pyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768099100&amp;x-signature=Uww1fHsWhKovYjYV0nhL1UHZGCE%3D" alt="WeKnora" loading="lazy"/></p>
<p><strong><code>WeKnora</code></strong> 是腾讯推出的开源框架，专注于复杂异构文档的深度理解、语义检索与上下文感知问答，采用 <code>RAG</code> 范式结合多模态预处理、向量索引、智能检索和大模型推理，提供企业级知识管理解决方案。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f8521818b32a4136a399fed145fa10a8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA54K55LiA5pyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768099100&amp;x-signature=l1YMZvJR73Isnq0rT6kuEvff9yw%3D" alt="WeKnora-architecture.png" loading="lazy"/>
它模块化架构高度解耦，支持本地/云端模型接入、混合检索策略与 <code>Agent</code> 模式扩展，已成为微信对话开放平台的核心技术框架，适用于隐私敏感与高精度文档场景。</p>
<ul>
<li><strong>深度文档解析</strong> ：精准提取 <code>PDF</code>、<code>Word</code>、图像等异构文档的结构化语义内容</li>
<li><strong>智能 <code>Agent</code> 模式</strong> ：<code>ReAct Agent</code> 支持内置工具、<code>MCP</code> 扩展与网页搜索，多轮反思生成报告</li>
<li><strong>高效混合检索</strong> ：结合关键词、向量与知识图谱，支持跨知识库检索</li>
<li><strong>多类型知识库</strong> ：支持 <code>FAQ</code>/文档库、文件夹/<code>URL</code> 导入与标签管理</li>
<li><strong>灵活扩展</strong> ：所有组件解耦，便于自定义解析、嵌入与生成流程</li>
<li><strong>本地隐私部署</strong> ：兼容 <code>Ollama</code> 等本地模型，无外部数据泄露风险</li>
</ul>
<p>💡 <strong><code>WeKnora</code></strong> 适合企业知识管理、学术研究分析、技术支持、法律合规审查与医疗知识辅助等需要高精度文档问答与本地化部署的场景。</p>
<p>👉 <strong>立即体验</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTencent%2FWeKnora" target="_blank" title="https://github.com/Tencent/WeKnora" ref="nofollow noopener noreferrer"><code>GitHub</code></a></p>
</li>
<li>
<h3 data-id="heading-8"><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fresemble-ai%2Fchatterbox" target="_blank" title="https://github.com/resemble-ai/chatterbox" ref="nofollow noopener noreferrer"><code>Chatterbox</code></a></h3>
<p>🌟 <strong><code>Star</code> 数：<code>19.2K+</code></strong></p>
<p>🗣️ <strong><code>Resemble AI</code> 开源的最先进文本转语音（<code>TTS</code>）模型家族</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3f96d75294104ee7b5079258137834d4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA54K55LiA5pyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768099100&amp;x-signature=tLVLDWA7jIw6z1yXibf0EEZrR%2Bc%3D" alt="Chatterbox-Turbo" loading="lazy"/></p>
<p><strong><code>Chatterbox</code></strong> 是 <code>Resemble AI</code> 推出的三个开源 <code>TTS</code> 模型系列，包括低延迟的 <code>Chatterbox-Turbo</code>（<code>350M</code> 参数、单步生成）、支持 23+ 语言的多语言版以及原版高表现力模型，提供零样本语音克隆、拟声标签和高效推理能力。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/28194cf9e8474a48b59d6d332c0b2602~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA54K55LiA5pyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768099100&amp;x-signature=Fh1DFpHZnEj45j1tAh3ggoAS%2Bf4%3D" alt="Chatterbox-test" loading="lazy"/></p>
<p>它内置神经水印（<code>Perth</code>）确保输出可追溯，支持夸张度调节与副语言表达（如 <code>[laugh]</code>、<code>[cough]</code>），在语音自然度、延迟和多语言支持上达到当前开源领先水平，成为构建语音代理和内容生成的首选。</p>
<ul>
<li><strong><code>Chatterbox-Turbo</code></strong> ：<code>350M</code> 参数单步生成，专为低延迟语音代理设计</li>
<li><strong>多语言零样本克隆</strong> ：<code>500M</code> 多语言模型支持 23+ 语言与参考音频即时克隆</li>
<li><strong>拟声标签支持</strong> ：原生解析 <code>[laugh]</code>、<code>[cough]</code> 等标签，提升表达真实感</li>
<li><strong>零样本语音克隆</strong> ：仅需参考音频即可合成指定声音</li>
<li><strong>内置水印保护</strong> ：所有输出嵌入 <code>Perth</code> 不可感知水印，便于追踪与负责 <code>AI</code></li>
<li><strong>高效推理</strong> ：更低显存占用，支持夸张度与 <code>CFG</code> 调节</li>
</ul>
<p>💡 <strong><code>Chatterbox</code></strong> 适合构建实时语音代理、游戏配音、多语言内容本地化、有声书制作以及需要高自然度与表达力的 <code>TTS</code> 应用开发者，尤其在低延迟或隐私敏感场景下优势突出。</p>
<p>👉 <strong>立即体验</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fresemble-ai%2Fchatterbox" target="_blank" title="https://github.com/resemble-ai/chatterbox" ref="nofollow noopener noreferrer"><code>GitHub</code></a></p>
</li>
<li>
<h3 data-id="heading-9"><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FFunAudioLLM%2FCosyVoice" target="_blank" title="https://github.com/FunAudioLLM/CosyVoice" ref="nofollow noopener noreferrer"><code>CosyVoice</code></a></h3>
<p>🌟 <strong><code>Star</code> 数：<code>18.6K+</code></strong></p>
<p>🗣️ <strong>多语言大模型驱动的语音生成框架</strong></p>
<p><strong><code>CosyVoice</code></strong> 是 <code>FunAudioLLM</code> 团队推出的开源多语言文本转语音（<code>TTS</code>）系统，最新 <code>Fun-CosyVoice 3.0</code> 版本在内容一致性、说话人相似度和韵律自然度上达到 <code>SOTA</code>，支持零样本多语言/跨语言语音克隆与低延迟流式合成。</p>
<p>它覆盖 9 种主流语言（中、英、日、韩、德、西、法、意、俄）及 18+ 种中文方言，支持指令控制情绪、语速、音量等，提供完整推理、训练与部署能力（包括 <code>WebUI</code>、<code>Docker</code>、<code>TensorRT-LLM</code> 加速），已成为当前开源 <code>TTS</code> 领域领先选择。</p>
<ul>
<li><strong>零样本多/跨语言克隆</strong> ：仅需参考音频即可合成目标声音，支持多语言无缝切换</li>
<li><strong>低延迟流式合成</strong> ：双向流式支持，最低 <code>150ms</code> 延迟，实时交互友好</li>
<li><strong>指令精细控制</strong> ：通过自然语言指定语言、方言、情绪、语速与音量</li>
<li><strong>高自然度 <code>SOTA</code></strong> ：<code>Fun-CosyVoice 3.0</code> 在一致性、相似度与韵律上全面领先</li>
<li><strong>文本标准化</strong> ：内置处理数字、符号与拼音/音素，无需额外前端模块</li>
<li><strong>完整部署支持</strong> ：<code>WebUI</code>、<code>FastAPI/gRPC</code> 服务、<code>TensorRT-LLM 4x</code> 加速</li>
</ul>
<p>💡 <strong><code>CosyVoice</code></strong> 适合构建实时语音代理、多语言内容生成、有声书、游戏配音以及需要高自然度与本地化部署的语音应用开发者，尤其在多语言与情感表达场景下表现突出。</p>
<p>👉 <strong>立即体验</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FFunAudioLLM%2FCosyVoice" target="_blank" title="https://github.com/FunAudioLLM/CosyVoice" ref="nofollow noopener noreferrer"><code>GitHub</code></a></p>
</li>
</ol>
<h3 data-id="heading-10">结论</h3>
<p>2025 年 12 月的榜单，清晰勾勒出开源社区的三大新主旋律：</p>
<ul>
<li><strong><code>Agent</code> 生态全面成熟</strong>：从持久记忆、可视化构建到标准化协作规范，<code>Agent</code> 开发门槛与效率双双飞跃</li>
<li><strong>终端优先与开源替代</strong>：终端 <code>AI</code> 编码代理与专用指导文件强势崛起，挑战闭源霸权</li>
<li><strong>多模态能力爆发</strong>：语音生成模型集体突破 <code>SOTA</code>，高自然度、低延迟、多语言支持成为新标配</li>
</ul>
<p>这些项目正推动 <code>AI</code> 从云端实验走向本地生产、从单点工具走向完整生态。未来，已在这些仓库中悄然展开。</p>
<p>📌 喜欢就去点个 <code>Star</code>，每一个 <code>Star</code> 都是对开源最大的支持！</p>
<p>📬 欢迎收藏、转发，也欢迎评论区安利你心目中的 2026 年 1 月黑马项目～</p>
<hr/>
<h3 data-id="heading-11">往期推荐</h3>
<p>喜欢本期的热门项目？以下是一些值得一读的往期精彩内容：</p>
<ol>
<li><a href="https://juejin.cn/post/7434159897197133836" target="_blank" title="https://juejin.cn/post/7434159897197133836">🚀 2024年11月 GitHub 十大热门项目排行榜 🔥</a></li>
<li><a href="https://juejin.cn/post/7434159897197133836" target="_blank" title="https://juejin.cn/post/7434159897197133836">🚀 2024年12月 GitHub 十大热门项目排行榜 🔥</a></li>
<li><a href="https://juejin.cn/post/7461822837532213267" target="_blank" title="https://juejin.cn/post/7461822837532213267">🚀 2025年01月 GitHub 十大热门项目排行榜 🔥</a></li>
<li><a href="https://juejin.cn/post/7475237484085346355" target="_blank" title="https://juejin.cn/post/7475237484085346355">🚀 2025年02月 GitHub 十大热门项目排行榜 🔥</a></li>
<li><a href="https://juejin.cn/post/7486316823253565474" target="_blank" title="https://juejin.cn/post/7486316823253565474">🚀 2025年03月 GitHub 十大热门项目排行榜 🔥</a></li>
<li><a href="https://juejin.cn/post/7503762078386700298" target="_blank" title="https://juejin.cn/post/7503762078386700298">🚀 2025年04月 GitHub 十大热门项目排行榜 🔥</a></li>
<li><a href="https://juejin.cn/post/7508914438659735589" target="_blank" title="https://juejin.cn/post/7508914438659735589">🚀 2025年05月 GitHub 十大热门项目排行榜 🔥</a></li>
<li><a href="https://juejin.cn/post/7525688196605722670" target="_blank" title="https://juejin.cn/post/7525688196605722670">🚀 2025年06月 GitHub 十大热门项目排行榜 🔥</a></li>
<li><a href="https://juejin.cn/post/7533169614206861339" target="_blank" title="https://juejin.cn/post/7533169614206861339">🚀 2025年07月 GitHub 十大热门项目排行榜 🔥</a></li>
<li><a href="https://juejin.cn/post/7543830033606246419" target="_blank" title="https://juejin.cn/post/7543830033606246419">🚀 2025年08月 GitHub 十大热门项目排行榜 🔥</a></li>
<li><a href="https://juejin.cn/post/7555056825693634601" target="_blank" title="https://juejin.cn/post/7555056825693634601">🚀 2025年09月 GitHub 十大热门项目排行榜 🔥</a></li>
<li><a href="https://juejin.cn/post/7567208390368198696" target="_blank" title="https://juejin.cn/post/7567208390368198696">🚀 2025年10月 GitHub 十大热门项目排行榜 🔥</a></li>
<li><a href="https://juejin.cn/post/7579889969986502707" target="_blank" title="https://juejin.cn/post/7579889969986502707">🚀 2025年11月 GitHub 十大热门项目排行榜 🔥</a></li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[告警的艺术：从 node_exporter 指标到生产级规则]]></title>    <link>https://juejin.cn/post/7590330924002312255</link>    <guid>https://juejin.cn/post/7590330924002312255</guid>    <pubDate>2026-01-04T02:45:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590330924002312255" data-draft-id="7590283328177504299" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="告警的艺术：从 node_exporter 指标到生产级规则"/> <meta itemprop="keywords" content="后端,监控,架构"/> <meta itemprop="datePublished" content="2026-01-04T02:45:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="踏浪无痕"/> <meta itemprop="url" content="https://juejin.cn/user/2834988091055719"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            告警的艺术：从 node_exporter 指标到生产级规则
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2834988091055719/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    踏浪无痕
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-04T02:45:43.000Z" title="Sun Jan 04 2026 02:45:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读16分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>凌晨 3 点，手机震动。</p>
<pre><code class="hljs language-makefile" lang="makefile">告警：server-01 CPU 使用率超过 80%
<span class="hljs-section">触发时间：03:12:45</span>
持续时长：2 分钟
</code></pre>
<p>你睁开惺忪的眼睛，登录服务器查看，发现只是 Jenkins 在跑定时编译任务。</p>
<p>这已经是本周第 12 次误报。</p>
<p>问题不在 Prometheus，也不在 node_exporter，而在<strong>告警规则的设计</strong>。</p>
<hr/>
<p>在<a href="https://juejin.cn/post/7589481566424596534" target="_blank" title="https://juejin.cn/post/7589481566424596534">《从 node-exporter 学如何写出可复用的监控指标》</a>中，我们学习了 node_exporter 的设计哲学：暴露事实，不是观点。</p>
<ul>
<li>CPU 暴露的是累计时间，不是使用率</li>
<li>内存暴露的是多个 Gauge，不是一个"使用率"</li>
<li>磁盘容量和 IO 分开设计</li>
</ul>
<p>这些"事实"很完整，但问题来了：<strong>有了指标，怎么变成告警？</strong></p>
<p>这不是简单设个阈值就行。你真的需要在 CPU 达到 80% 时立即告警吗？还是应该等它持续 10 分钟再打扰你？</p>
<p>本文聚焦一个核心问题：**基于 node_exporter 的数据，如何设计一套生产级的虚拟机告警规则？</p>
<h2 data-id="heading-0">1. 为什么需要告警规则的设计智慧</h2>
<h3 data-id="heading-1">1.1 Alertmanager 的局限</h3>
<p>很多人觉得 Prometheus 有 Alertmanager，为什么还要自研告警引擎？</p>
<p><strong>Alertmanager 的三个痛点：</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># Alertmanager 的配置</span>
<span class="hljs-attr">route:</span>
  <span class="hljs-attr">group_by:</span> [<span class="hljs-string">'alertname'</span>]
  <span class="hljs-attr">group_wait:</span> <span class="hljs-string">30s</span>
  <span class="hljs-attr">group_interval:</span> <span class="hljs-string">5m</span>
  <span class="hljs-attr">repeat_interval:</span> <span class="hljs-string">4h</span>
  <span class="hljs-attr">receiver:</span> <span class="hljs-string">'team-pager'</span>
</code></pre>

























<table><thead><tr><th>问题</th><th>表现</th><th>影响</th></tr></thead><tbody><tr><td><strong>配置复杂</strong></td><td>YAML 难理解</td><td>运维成本高，改规则要重启</td></tr><tr><td><strong>无状态可见</strong></td><td>不知道当前有哪些告警</td><td>无法追溯告警历史</td></tr><tr><td><strong>难以扩展</strong></td><td>加功能要改源码</td><td>无法融入业务逻辑</td></tr></tbody></table>
<p><strong>一个真实场景：</strong></p>
<pre><code class="hljs language-arduino" lang="arduino">运维：<span class="hljs-string">"CPU 使用率高的告警触发了多少次？"</span>
Alertmanager：<span class="hljs-string">"不知道，我不存历史。"</span>

运维：<span class="hljs-string">"这个告警持续多久了？"</span>
Alertmanager：<span class="hljs-string">"不知道，我只管通知。"</span>

运维：<span class="hljs-string">"能不能在发布窗口屏蔽告警？"</span>
Alertmanager：<span class="hljs-string">"可以，但要写复杂的 YAML。"</span>
</code></pre>
<p><strong>自研的价值：</strong></p>
<ul>
<li>Web UI 管理规则，不用改 YAML</li>
<li>数据库存储历史，可以分析趋势</li>
<li>灵活扩展，融入业务场景（如发布窗口自动静默）</li>
</ul>
<h3 data-id="heading-2">1.2 Google 的两个方法论</h3>
<p>Google SRE 给了我们两个黄金法则：</p>
<p><strong>USE 方法（资源监控）：</strong></p>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart LR
    A[Utilization&lt;br/&gt;利用率] --&gt; B[提前预警]
    C[Saturation&lt;br/&gt;饱和度] --&gt; D[确认拥塞]
    E[Errors&lt;br/&gt;错误] --&gt; F[确认故障]
    
    style A fill:#fff4e1
    style C fill:#ffe1f5
    style E fill:#ffcccc
</code></pre>
<ul>
<li><strong>Utilization</strong>：资源用了多少？（CPU 80% → 需要关注）</li>
<li><strong>Saturation</strong>：是否有排队？（IO 队列长 → 性能下降）</li>
<li><strong>Errors</strong>：是否有错误？（磁盘错误 → 硬件故障）</li>
</ul>
<p><strong>四个黄金信号（服务监控）：</strong></p>
<p>虽然虚拟机不是"服务"，但可以映射：</p>
<ul>
<li><strong>Latency</strong>：IO 延迟高 → 影响上层应用</li>
<li><strong>Traffic</strong>：网络流量异常 → 可能被攻击</li>
<li><strong>Errors</strong>：硬件错误 → 需要介入</li>
<li><strong>Saturation</strong>：资源饱和 → 需要扩容</li>
</ul>
<p><strong>启示：告警不是简单设阈值，而是要理解系统在不同阶段的表现。</strong></p>
<h3 data-id="heading-3">1.3 从指标到告警的核心挑战</h3>
<p>node_exporter 给了我们"事实"：</p>
<pre><code class="hljs language-ini" lang="ini">node_cpu_seconds_total{<span class="hljs-attr">mode</span>=<span class="hljs-string">"user"</span>} <span class="hljs-number">123456</span>   <span class="hljs-comment"># CPU 累计时间</span>
node_memory_MemAvailable_bytes 8388608000    <span class="hljs-comment"># 可用内存</span>
node_filesystem_avail_bytes 53687091200      <span class="hljs-comment"># 磁盘可用空间</span>
</code></pre>
<p>但这些是 Counter 和 Gauge，怎么变成告警？</p>
<p><strong>三个核心问题：</strong></p>
<ol>
<li><strong>阈值怎么定？</strong> —— 80% 合适还是 90% 合适？</li>
<li><strong>怎么过滤毛刺？</strong> —— 短暂峰值要不要告警？</li>
<li><strong>如何提前预警？</strong> —— 等到真出问题才告是不是太晚了？</li>
</ol>
<p>接下来，我们用 CPU、内存、磁盘、网络四个维度，看看如何设计告警规则。</p>
<hr/>
<h2 data-id="heading-4">2. CPU 告警：不只是设个 80%</h2>
<h3 data-id="heading-5">2.1 错误示例</h3>
<p>很多人第一反应是这样：</p>
<pre><code class="hljs language-promql" lang="promql"># 错误示例：CPU 使用率 &gt; 80% 就告警
(1 - avg(rate(node_cpu_seconds_total{mode="idle"}[5m]))) * 100 &gt; 80
</code></pre>
<p><strong>会发生什么？</strong></p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">10:00 - CPU 85%（代码编译，正常）  → 告警</span>
<span class="hljs-section">10:01 - CPU 60%（编译结束）        → 恢复</span>
<span class="hljs-section">10:05 - CPU 85%（定时任务，正常）  → 告警</span>
<span class="hljs-section">10:06 - CPU 50%                    → 恢复</span>

一天收到几十条告警，都是正常的业务波动。
</code></pre>
<p><strong>问题：</strong></p>
<ul>
<li>没有时间维度，瞬时峰值也告警</li>
<li>80% 的阈值太低，正常繁忙就会触发</li>
<li>不区分"临时忙"和"持续忙"</li>
</ul>
<h3 data-id="heading-6">2.2 正确示例 1：加上时间维度</h3>
<pre><code class="hljs language-promql" lang="promql"># 正确示例：CPU 持续 10 分钟 &gt; 90%
(1 - avg(rate(node_cpu_seconds_total{mode="idle"}[5m])) by (instance)) * 100 &gt; 90
for: 10m
</code></pre>
<p><strong>改进点：</strong></p>

























<table><thead><tr><th>参数</th><th>值</th><th>作用</th></tr></thead><tbody><tr><td><code>[5m]</code></td><td>评估窗口</td><td>平滑 15 秒抓取间隔的抖动</td></tr><tr><td><code>&gt; 90</code></td><td>阈值提高</td><td>留 10% 缓冲，避免误报</td></tr><tr><td><code>for: 10m</code></td><td>持续时长</td><td>过滤临时波动（编译、备份）</td></tr></tbody></table>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart LR
    A[首次超过 90%] --&gt; B[观察 10 分钟]
    B --&gt; C{持续超过?}
    C --&gt;|是| D[触发告警]
    C --&gt;|否| E[取消]
    
    style A fill:#fff4e1
    style D fill:#ffcccc
    style E fill:#ccffcc
</code></pre>
<p><strong>效果：</strong></p>
<ul>
<li>短暂的编译、备份不会告警</li>
<li>只有真正持续繁忙才告警</li>
<li>误报率从 80% 降到 &lt; 10%</li>
</ul>
<h3 data-id="heading-7">2.3 正确示例 2：区分 CPU 模式</h3>
<p>整机 CPU 告诉你"忙不忙"，但不知道"为什么忙"。</p>
<pre><code class="hljs language-promql" lang="promql"># 用户态 CPU 过高 → 应用代码效率问题
avg(rate(node_cpu_seconds_total{mode="user"}[5m])) by (instance) &gt; 0.8
for: 10m

# 系统态 CPU 过高 → 系统调用过多（网络/磁盘 IO）
avg(rate(node_cpu_seconds_total{mode="system"}[5m])) by (instance) &gt; 0.3
for: 10m

# iowait 过高 → 磁盘 IO 瓶颈
avg(rate(node_cpu_seconds_total{mode="iowait"}[5m])) by (instance) &gt; 0.2
for: 5m
</code></pre>
<p><strong>价值：不只知道"CPU 高"，还知道"为什么高"。</strong></p>
<pre><code class="hljs language-erlang" lang="erlang">场景 <span class="hljs-number">1</span>：整机 CPU <span class="hljs-number">90</span><span class="hljs-comment">%，同时 user 高</span>
→ 运维：应用代码有问题，去排查业务

场景 <span class="hljs-number">2</span>：整机 CPU <span class="hljs-number">90</span><span class="hljs-comment">%，同时 iowait 高</span>
→ 运维：磁盘 IO 慢，去排查磁盘

场景 <span class="hljs-number">3</span>：整机 CPU <span class="hljs-number">90</span><span class="hljs-comment">%，同时 system 高</span>
→ 运维：系统调用多，可能是网络问题
</code></pre>
<p>这就是区分模式的价值：同样是 CPU 90%，但问题的根因完全不同，处理方式也不同。</p>
<hr/>
<h2 data-id="heading-8">3. 内存告警：Linux 的内存不是你想的那样</h2>
<h3 data-id="heading-9">3.1 错误示例</h3>
<pre><code class="hljs language-promql" lang="promql"># 错误示例：用 MemFree 计算使用率
(1 - node_memory_MemFree_bytes / node_memory_MemTotal_bytes) * 100 &gt; 90
</code></pre>
<p><strong>会发生什么？</strong></p>
<pre><code class="hljs language-makefile" lang="makefile">16G 内存的服务器：
<span class="hljs-section">MemTotal: 16G</span>
<span class="hljs-section">MemFree:  1G   (真正空闲)</span>
<span class="hljs-section">Cached:   8G   (文件缓存，可释放)</span>

错误计算：使用率 = (16 - 1) / 16 = 93.75%
→ 告警：<span class="hljs-string">"内存不足！"</span>
→ 运维登录查看
→ 发现 8G 是 cache，随时可以释放
→ 误报！
</code></pre>
<p><strong>问题：不理解 Linux 内存管理机制。</strong></p>
<p>Linux 会把空闲内存用来做 cache，提升文件读取性能。这些 cache 在应用需要内存时会自动释放，不应该算作"已使用"。</p>
<h3 data-id="heading-10">3.2 正确示例 1：用 MemAvailable</h3>
<pre><code class="hljs language-promql" lang="promql"># 正确示例：用 MemAvailable 计算
(1 - node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes) * 100 &gt; 90
for: 5m
</code></pre>
<p><strong>MemAvailable 是什么？</strong></p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">MemAvailable</span> = MemFree + 可回收的 Cache + 可回收的 Buffer
</code></pre>
<p>这才是真正可用的内存。</p>
<blockquote>
<p>注意：<code>node_memory_MemAvailable_bytes</code> 在 node_exporter v0.16+ 版本才可用。如果你的版本较旧，需要先升级。</p>
</blockquote>
<p><strong>对比：</strong></p>
<pre><code class="hljs language-ini" lang="ini">场景：16G 内存服务器

MemFree:      1G
Cached:       8G (可回收)
MemAvailable: 9G

用 MemFree：
使用率 = (16 - 1) / <span class="hljs-attr">16</span> = <span class="hljs-number">93.75</span>%  → 误报

用 MemAvailable：
使用率 = (16 - 9) / <span class="hljs-attr">16</span> = <span class="hljs-number">43.75</span>%  → 正确
</code></pre>
<h3 data-id="heading-11">3.3 正确示例 2：预测未来耗尽</h3>
<p>当前可用内存充足，但如果有内存泄漏，迟早会耗尽。</p>
<pre><code class="hljs language-promql" lang="promql"># 预测 4 小时后可用内存是否耗尽
predict_linear(node_memory_MemAvailable_bytes[1h], 4*3600) &lt; 0
for: 10m
</code></pre>
<p><strong>predict_linear 的原理：</strong></p>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart LR
    A[过去 1 小时数据] --&gt; B[线性回归]
    B --&gt; C[预测 4 小时后]
    C --&gt; D{&lt; 0?}
    D --&gt;|是| E[告警]
    
    style A fill:#e1f5ff
    style E fill:#ffcccc
</code></pre>
<p><strong>案例：</strong></p>
<pre><code class="hljs language-ini" lang="ini">10:00 - <span class="hljs-attr">MemAvailable</span> = <span class="hljs-number">10</span>G
10:30 - <span class="hljs-attr">MemAvailable</span> = <span class="hljs-number">8</span>G
11:00 - <span class="hljs-attr">MemAvailable</span> = <span class="hljs-number">6</span>G

每小时下降 4G
→ 预测 4 小时后：6G - <span class="hljs-attr">16G</span> = -<span class="hljs-number">10</span>G &lt; <span class="hljs-number">0</span>
→ 触发告警："预计 4 小时后内存耗尽"
</code></pre>
<p><strong>价值：提前 4 小时发现风险，而不是等到真的耗尽。</strong></p>
<p>这就是 <code>predict_linear()</code> 的威力：从"被动应对"变成"主动预防"。</p>
<hr/>
<h2 data-id="heading-12">4. 磁盘告警：当前值和未来趋势</h2>
<h3 data-id="heading-13">4.1 错误示例</h3>
<pre><code class="hljs language-promql" lang="promql"># 错误示例：磁盘使用率 &gt; 85% 就告警
(1 - node_filesystem_avail_bytes / node_filesystem_size_bytes) * 100 &gt; 85
</code></pre>
<p><strong>会发生什么？</strong></p>
<pre><code class="hljs language-erlang" lang="erlang">场景 <span class="hljs-number">1</span>：磁盘使用率 <span class="hljs-number">86</span><span class="hljs-comment">%，但日志增长很快</span>
→ 触发告警
→ 运维去清理日志
→ 但 <span class="hljs-number">2</span> 小时后磁盘满了
→ 服务挂了

为什么？因为 <span class="hljs-number">85</span><span class="hljs-comment">% 的阈值太晚了！</span>
</code></pre>
<p><strong>问题：</strong></p>
<ul>
<li>不知道磁盘增长速度</li>
<li>等到 85% 再告警，可能来不及处理</li>
<li>没有考虑"未来会怎样"</li>
</ul>
<h3 data-id="heading-14">4.2 正确示例 1：预测式告警</h3>
<pre><code class="hljs language-promql" lang="promql"># 基于过去 6 小时数据，预测 24 小时后磁盘是否满
predict_linear(node_filesystem_avail_bytes[6h], 24*3600) &lt; 0
for: 1h
</code></pre>
<p><strong>价值：</strong></p>
<pre><code class="hljs language-erlang" lang="erlang">场景 <span class="hljs-number">1</span>：磁盘使用率 <span class="hljs-number">82</span><span class="hljs-comment">%，但增长很快</span>
→ 规则 <span class="hljs-number">1</span> 告警：<span class="hljs-string">"预测 24h 后满"</span>
→ 运维：优先处理，明天就会满

场景 <span class="hljs-number">2</span>：磁盘使用率 <span class="hljs-number">82</span><span class="hljs-comment">%，但增长很慢</span>
→ 规则 <span class="hljs-number">1</span> 不告警：预测 <span class="hljs-number">7</span> 天后才满
→ 运维：不紧急，排期清理即可
</code></pre>
<p><strong>同样是 82%，但处理优先级完全不同。</strong></p>
<h3 data-id="heading-15">4.3 正确示例 2：容量和 IO 分开</h3>
<p>磁盘有两类问题：</p>
<ul>
<li><strong>容量问题</strong>：快满了</li>
<li><strong>性能问题</strong>：IO 慢了</li>
</ul>
<pre><code class="hljs language-promql" lang="promql"># 容量告警：使用率 &gt; 90%
# 注意：过滤掉临时目录和虚拟文件系统
(1 - node_filesystem_avail_bytes{
    fstype=~"ext4|xfs",
    mountpoint!~"/tmp|/var/lib/docker|/boot"
  } / node_filesystem_size_bytes) * 100 &gt; 90
for: 10m

# 性能告警：IO 使用率 &gt; 80%
rate(node_disk_io_time_seconds_total{device=~"sd.*|vd.*"}[5m]) &gt; 0.8
for: 10m

# 性能告警：IO 队列长度 &gt; 10
rate(node_disk_io_time_weighted_seconds_total{device=~"sd.*|vd.*"}[5m]) &gt; 10
for: 5m
</code></pre>
<p><strong>为什么要过滤路径？</strong></p>
<pre><code class="hljs language-diff" lang="diff">不需要告警的挂载点：
<span class="hljs-deletion">- /tmp：临时目录，满了也无所谓</span>
<span class="hljs-deletion">- /var/lib/docker：容器存储，由 Docker 管理</span>
<span class="hljs-deletion">- /boot：引导分区，通常很小且不会变化</span>

只关注业务数据盘：
<span class="hljs-deletion">- /：根分区</span>
<span class="hljs-deletion">- /data：数据分区</span>
<span class="hljs-deletion">- /home：用户目录</span>
</code></pre>
<p><strong>为什么要分开？</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">场景</span> <span class="hljs-number">1</span><span class="hljs-string">：磁盘使用率</span> <span class="hljs-number">50</span><span class="hljs-string">%，但</span> <span class="hljs-string">IO</span> <span class="hljs-string">队列很长</span>
<span class="hljs-string">→</span> <span class="hljs-string">容量充足，但性能差</span>
<span class="hljs-string">→</span> <span class="hljs-string">需要优化</span> <span class="hljs-string">IO（换</span> <span class="hljs-string">SSD、减少小文件操作）</span>

<span class="hljs-string">场景</span> <span class="hljs-number">2</span><span class="hljs-string">：磁盘使用率</span> <span class="hljs-number">95</span><span class="hljs-string">%，但</span> <span class="hljs-string">IO</span> <span class="hljs-string">正常</span>
<span class="hljs-string">→</span> <span class="hljs-string">容量不足，但性能正常</span>
<span class="hljs-string">→</span> <span class="hljs-string">需要清理磁盘或扩容</span>

<span class="hljs-string">两类问题，两种处理方式。</span>

<span class="hljs-string">**运维口诀**：容量看趋势，性能看队列。</span>

<span class="hljs-meta">---
</span>
<span class="hljs-comment">## 5. 网络告警：流量和错误</span>

<span class="hljs-comment">### 5.1 错误示例</span>

<span class="hljs-string">```promql</span>
<span class="hljs-comment"># 错误示例：网络流量 &gt; 100MB/s 就告警</span>
<span class="hljs-string">rate(node_network_receive_bytes_total[5m])</span> <span class="hljs-string">/</span> <span class="hljs-number">1024</span> <span class="hljs-string">/</span> <span class="hljs-number">1024</span> <span class="hljs-string">&gt;</span> <span class="hljs-number">100</span>
</code></pre>
<p><strong>问题：</strong></p>
<ul>
<li>100MB/s 对千兆网卡是正常的（125MB/s 满载）</li>
<li>没有区分"流量大"和"异常流量"</li>
<li>没有考虑错误率</li>
</ul>
<h3 data-id="heading-16">5.2 正确示例：流量 + 错误率</h3>
<pre><code class="hljs language-promql" lang="promql"># 网络流量超过带宽的 80%
# 注意：排除回环接口和虚拟接口
rate(node_network_receive_bytes_total{
    device!~"lo|docker.*|veth.*|br-.*"
  }[5m]) / (node_network_speed_bytes * 0.8) &gt; 1
for: 5m

# 网络错误率 &gt; 0.1%
rate(node_network_receive_errs_total{
    device!~"lo|docker.*|veth.*|br-.*"
  }[5m]) 
/ 
rate(node_network_receive_packets_total{
    device!~"lo|docker.*|veth.*|br-.*"
  }[5m]) &gt; 0.001
for: 5m
</code></pre>
<p><strong>为什么要过滤接口？</strong></p>
<pre><code class="hljs language-markdown" lang="markdown">不需要监控的网络接口：
<span class="hljs-bullet">-</span> lo：回环接口，本地通信
<span class="hljs-bullet">-</span> docker0, br-<span class="hljs-emphasis">*：Docker 网桥
- veth*</span>：容器虚拟网卡

只监控物理网卡：
<span class="hljs-bullet">-</span> eth0, eth1：传统命名
<span class="hljs-bullet">-</span> ens<span class="hljs-emphasis">*, enp*</span>：systemd 命名
<span class="hljs-bullet">-</span> bond<span class="hljs-emphasis">*：网卡绑定
</span></code></pre>
<p><strong>改进点：</strong></p>
<ul>
<li>相对阈值（带宽的 80%）而不是绝对值</li>
<li>关注错误率，不只是流量</li>
<li>错误率 0.1% 很小，但可能是硬件问题的信号</li>
</ul>
<p><strong>场景：</strong></p>
<pre><code class="hljs">场景 1：流量高，错误率正常
→ 业务正常繁忙，无需告警

场景 2：流量正常，错误率高
→ 网卡/交换机有问题，需要排查硬件

场景 3：流量高，错误率也高
→ 可能是 DDoS 攻击或网络故障
</code></pre>
<hr/>
<h2 data-id="heading-17">6. 告警规则设计方法论</h2>
<p>基于上面的案例，可以总结出告警规则设计的三个维度：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TB
    A[告警规则设计] --&gt; B[时间维度]
    A --&gt; C[严重程度]
    A --&gt; D[业务上下文]
    
    B --&gt; E[评估窗口: 5m/15m&lt;br/&gt;平滑抖动]
    B --&gt; F[持续时长: for 10m&lt;br/&gt;过滤毛刺]
    
    C --&gt; G[P0: 服务不可用&lt;br/&gt;立即处理]
    C --&gt; H[P1: 性能下降&lt;br/&gt;1小时内]
    C --&gt; I[P2: 资源紧张&lt;br/&gt;当天处理]
    
    D --&gt; J[区分场景&lt;br/&gt;生产/测试]
    D --&gt; K[关联指标&lt;br/&gt;多维度判断]
    
    style A fill:#e1f5ff
    style B fill:#fff4e1
    style C fill:#ffcccc
    style D fill:#ccffcc
</code></pre>
<h3 data-id="heading-18">6.1 时间维度</h3>
<p><strong>评估窗口 <code>[5m]</code>：</strong></p>
<ul>
<li>作用：平滑 15 秒抓取间隔的抖动</li>
<li>选择：CPU/内存用 5m，磁盘用 6h（变化慢）</li>
</ul>
<p><strong>持续时长 <code>for: 10m</code>：</strong></p>
<ul>
<li>作用：过滤短暂峰值</li>
<li>选择：CPU 用 10m，磁盘用 1h（不需要那么敏感）</li>
</ul>
<h3 data-id="heading-19">6.2 严重程度</h3>
<p><strong>三个级别：</strong></p>





























<table><thead><tr><th>级别</th><th>含义</th><th>响应时间</th><th>典型场景</th></tr></thead><tbody><tr><td>P0</td><td>服务不可用</td><td>立即</td><td>磁盘满、OOM</td></tr><tr><td>P1</td><td>性能下降</td><td>1 小时内</td><td>CPU 95%、内存 95%</td></tr><tr><td>P2</td><td>资源紧张</td><td>当天</td><td>CPU 85%、磁盘 80%</td></tr></tbody></table>
<p><strong>设计原则：</strong></p>
<ul>
<li>P0 的 <code>for</code> 更短（5m），不能等太久</li>
<li>P2 的 <code>for</code> 更长（30m），避免误报</li>
</ul>
<h3 data-id="heading-20">6.3 业务上下文</h3>
<p><strong>区分场景：</strong></p>
<pre><code class="hljs language-promql" lang="promql"># 生产环境 90% 告警
cpu_usage{env="prod"} &gt; 0.9

# 测试环境 95% 告警（更宽松）
cpu_usage{env="test"} &gt; 0.95
</code></pre>
<p><strong>关联指标：</strong></p>
<pre><code class="hljs language-promql" lang="promql"># CPU 高 + iowait 高 → 可能是磁盘慢
cpu_usage &gt; 0.9 and cpu_iowait &gt; 0.2

# CPU 高 + 网络流量高 → 可能是网络处理
cpu_usage &gt; 0.9 and network_traffic &gt; 100MB/s
</code></pre>
<p>这就是"因地制宜"的价值：不同场景用不同规则，不能一刀切。</p>
<hr/>
<h2 data-id="heading-21">7. 好的告警系统应该解决什么问题</h2>
<p>有了规则，还需要一个引擎来执行。好的告警系统应该解决这些问题：</p>
<h3 data-id="heading-22">7.1 Fingerprint：告警实例的唯一标识</h3>
<p>同一个规则可能命中多个实例：</p>
<pre><code class="hljs language-ini" lang="ini">规则: CPU 使用率 &gt; 90%

命中:
- {<span class="hljs-attr">instance</span>=<span class="hljs-string">"server-01"</span>, env=<span class="hljs-string">"prod"</span>} → Fingerprint = <span class="hljs-string">"abc123"</span>
- {<span class="hljs-attr">instance</span>=<span class="hljs-string">"server-02"</span>, env=<span class="hljs-string">"prod"</span>} → Fingerprint = <span class="hljs-string">"def456"</span>
</code></pre>
<p><strong>Fingerprint = hash(rule_id + labels)</strong></p>
<p>每个 Fingerprint 是一个独立的告警，需要单独追踪：</p>
<ul>
<li>什么时候开始的？</li>
<li>触发了几次？</li>
<li>现在状态如何？</li>
</ul>
<h3 data-id="heading-23">7.2 防抖动：避免告警风暴</h3>
<p><strong>两层防抖：</strong></p>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart LR
    A[首次命中] --&gt; B[pending&lt;br/&gt;观察期]
    B --&gt; C{持续 &gt;= for?}
    C --&gt;|是| D[firing&lt;br/&gt;确认告警]
    C --&gt;|否| A
    D --&gt; E{5分钟内重复?}
    E --&gt;|是| F[跳过处理]
    E --&gt;|否| G[写库/通知]
    
    style B fill:#fff4e1
    style D fill:#ffcccc
    style F fill:#cccccc
    style G fill:#ccffcc
</code></pre>
<p><strong>第一层：for_duration（规则层）</strong></p>
<ul>
<li>持续 10 分钟才从 pending 转为 firing</li>
<li>过滤短暂毛刺</li>
</ul>
<p><strong>第二层：时间窗口去重（消费层）</strong></p>
<ul>
<li>5 分钟内同一告警只处理一次</li>
<li>避免频繁写库和通知</li>
</ul>
<h3 data-id="heading-24">7.3 可扩展：插件化数据源</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart LR
    A[告警引擎] --&gt; B[Prometheus&lt;br/&gt;指标]
    A --&gt; C[日志扫描&lt;br/&gt;关键字]
    A --&gt; D[SQL 查询&lt;br/&gt;数据库]
    A --&gt; E[黑盒探测&lt;br/&gt;HTTP/TCP]
    
    style A fill:#e1f5ff
    style B fill:#fff4e1
    style C fill:#ffe1f5
    style D fill:#ffcccc
    style E fill:#ccffcc
</code></pre>
<p>不只是 Prometheus 指标，还可以扩展：</p>
<ul>
<li>日志关键字（如"OutOfMemoryError"）</li>
<li>SQL 规则（如"超时订单 &gt; 100"）</li>
<li>黑盒探测（如"API 5xx 错误"）</li>
</ul>
<h3 data-id="heading-25">7.4 静默管理：计划性维护</h3>
<p><strong>场景：</strong></p>
<pre><code class="hljs language-erlang" lang="erlang">晚上 <span class="hljs-number">22</span>:<span class="hljs-number">00</span>-<span class="hljs-number">23</span>:<span class="hljs-number">00</span> 发布新版本
→ 服务会重启
→ CPU 会短暂 <span class="hljs-number">100</span><span class="hljs-comment">%</span>
→ 不应该告警
</code></pre>
<p><strong>解决方案：时间窗口静默</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">静默规则:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">"发布窗口"</span>
  <span class="hljs-attr">start:</span> <span class="hljs-string">"22:00"</span>
  <span class="hljs-attr">end:</span> <span class="hljs-string">"23:00"</span>
  <span class="hljs-attr">match:</span>
    <span class="hljs-attr">env:</span> <span class="hljs-string">"prod"</span>
    <span class="hljs-attr">service:</span> <span class="hljs-string">"api"</span>
</code></pre>
<p>在发布窗口内，匹配的告警自动静默，不发通知。</p>
<h3 data-id="heading-26">7.5 告警历史：可追溯和分析</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 历史告警表</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> history_alerts (
  fingerprint <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">64</span>),
  rule_name <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">255</span>),
  start_at DATETIME,
  end_at DATETIME,
  duration <span class="hljs-type">INT</span>,
  trigger_count <span class="hljs-type">INT</span>
);
</code></pre>
<p><strong>价值：</strong></p>
<ul>
<li>查看某台服务器过去一周的告警次数</li>
<li>分析哪些规则误报率高</li>
<li>计算平均恢复时间（MTTR）</li>
</ul>
<p>告警历史不只是记录，更是持续改进的基础。没有数据就没有优化，好的系统要能自我进化。</p>
<hr/>
<h2 data-id="heading-27">8. 总结</h2>
<h3 data-id="heading-28">8.1 从指标到告警的核心思想</h3>
<p><strong>不是简单设阈值，而是：</strong></p>
<ol>
<li>
<p><strong>理解指标的本质</strong></p>
<ul>
<li>CPU 是累计时间，要用 rate() 转成使用率</li>
<li>内存要用 MemAvailable，不是 MemFree</li>
<li>磁盘要看趋势，不只看当前值</li>
</ul>
</li>
<li>
<p><strong>加上时间维度</strong></p>
<ul>
<li>评估窗口 <code>[5m]</code> 平滑抖动</li>
<li>持续时长 <code>for: 10m</code> 过滤毛刺</li>
</ul>
</li>
<li>
<p><strong>考虑业务上下文</strong></p>
<ul>
<li>区分生产和测试环境</li>
<li>关联多个指标（CPU + iowait）</li>
<li>预测未来（predict_linear）</li>
</ul>
</li>
</ol>
<h3 data-id="heading-29">8.2 好的告警规则长什么样</h3>






























<table><thead><tr><th>维度</th><th>坏规则</th><th>好规则</th></tr></thead><tbody><tr><td><strong>阈值</strong></td><td>CPU &gt; 80%</td><td>CPU &gt; 90%，for: 10m</td></tr><tr><td><strong>指标</strong></td><td>只看一个指标</td><td>关联多个指标</td></tr><tr><td><strong>时间</strong></td><td>只看当前值</td><td>看趋势（predict_linear）</td></tr><tr><td><strong>上下文</strong></td><td>一刀切</td><td>区分场景（生产/测试）</td></tr></tbody></table>
<h3 data-id="heading-30">8.3 好的告警系统解决什么问题</h3>
<p><strong>五个核心能力：</strong></p>
<ol>
<li><strong>Fingerprint</strong> —— 每个告警实例有唯一标识</li>
<li><strong>防抖动</strong> —— 两层过滤（for + 时间窗口去重）</li>
<li><strong>可扩展</strong> —— 不只是 Prometheus，还能接其他数据源</li>
<li><strong>静默管理</strong> —— 计划性维护不告警</li>
<li><strong>历史追溯</strong> —— 可分析、可改进</li>
</ol>
<h3 data-id="heading-31">8.4 三个核心洞察</h3>
<p>看完这篇文章，记住这三点就够了：</p>
<p><strong>1. 好的告警要能定位问题</strong></p>
<p>不只说"CPU 高"，还要说"是 user 高还是 iowait 高"。不只告诉你有问题，还要告诉你什么问题。</p>
<p><strong>2. 好的告警要能预测未来</strong></p>
<p>用 <code>predict_linear()</code> 提前 4 小时、24 小时发现风险，而不是等到真的出问题才知道。从"被动应对"变成"主动预防"。</p>
<p><strong>3. 好的系统要能自我进化</strong></p>
<p>记录告警历史，分析误报率，持续优化规则。没有数据就没有改进，没有历史就没有进化。</p>
<hr/>
<h2 data-id="heading-32">附录：告警规则自查清单</h2>
<p>在上线告警规则前，用这个清单检查一遍：</p>
<h3 data-id="heading-33">CPU 告警</h3>
<ul class="contains-task-list">
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 是否使用了 <code>rate()</code> 而不是直接用 Counter 值？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 阈值是否 &gt;= 90%（而不是 80%）？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 是否设置了 <code>for: 10m</code> 持续时长？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 是否区分了 user/system/iowait 模式？</li>
</ul>
<h3 data-id="heading-34">内存告警</h3>
<ul class="contains-task-list">
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 是否使用了 <code>MemAvailable</code> 而不是 <code>MemFree</code>？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 版本是否 &gt;= node_exporter v0.16？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 是否使用了 <code>predict_linear()</code> 预测未来？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> P0 告警阈值是否 &gt;= 95%？</li>
</ul>
<h3 data-id="heading-35">磁盘告警</h3>
<ul class="contains-task-list">
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 容量告警是否使用了 <code>predict_linear()</code>？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 是否过滤了 <code>/tmp</code>、<code>/boot</code> 等临时目录？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 是否只监控 <code>ext4</code> 和 <code>xfs</code> 文件系统？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 是否分别设置了容量告警和 IO 告警？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> IO 告警是否过滤了设备类型（如 <code>device=~"sd.*|vd.*"</code>）？</li>
</ul>
<h3 data-id="heading-36">网络告警</h3>
<ul class="contains-task-list">
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 是否过滤了 <code>lo</code>、<code>docker0</code>、<code>veth*</code> 等虚拟接口？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 流量告警是否使用了相对阈值（带宽的 80%）？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 是否同时监控了流量和错误率？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 错误率阈值是否足够敏感（如 0.1%）？</li>
</ul>
<h3 data-id="heading-37">通用检查</h3>
<ul class="contains-task-list">
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 所有规则是否都设置了 <code>for</code> 持续时长？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> P0/P1/P2 的严重级别是否合理？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 是否区分了生产和测试环境？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 规则名称是否清晰表达了告警内容？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 是否添加了 <code>annotations</code> 描述？</li>
</ul>
<hr/>
<h2 data-id="heading-38">快速参考：核心规则速查</h2>











































































<table><thead><tr><th>监控项</th><th>推荐规则</th><th>阈值</th><th>for</th><th>说明</th></tr></thead><tbody><tr><td><strong>CPU 整机</strong></td><td><code>(1 - avg(rate(node_cpu_seconds_total{mode="idle"}[5m]))) &gt; 0.9</code></td><td>90%</td><td>10m</td><td>基础告警</td></tr><tr><td><strong>CPU iowait</strong></td><td><code>avg(rate(node_cpu_seconds_total{mode="iowait"}[5m])) &gt; 0.2</code></td><td>20%</td><td>5m</td><td>磁盘瓶颈</td></tr><tr><td><strong>内存可用</strong></td><td><code>(1 - node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes) &gt; 0.9</code></td><td>90%</td><td>5m</td><td>基础告警</td></tr><tr><td><strong>内存预测</strong></td><td><code>predict_linear(node_memory_MemAvailable_bytes[1h], 4*3600) &lt; 0</code></td><td>-</td><td>10m</td><td>提前预警</td></tr><tr><td><strong>磁盘容量</strong></td><td><code>(1 - node_filesystem_avail_bytes / node_filesystem_size_bytes) &gt; 0.9</code></td><td>90%</td><td>10m</td><td>基础告警</td></tr><tr><td><strong>磁盘预测</strong></td><td><code>predict_linear(node_filesystem_avail_bytes[6h], 24*3600) &lt; 0</code></td><td>-</td><td>1h</td><td>提前预警</td></tr><tr><td><strong>磁盘 IO</strong></td><td><code>rate(node_disk_io_time_seconds_total[5m]) &gt; 0.8</code></td><td>80%</td><td>10m</td><td>性能问题</td></tr><tr><td><strong>网络流量</strong></td><td><code>rate(node_network_receive_bytes_total[5m]) / node_network_speed_bytes &gt; 0.8</code></td><td>80%</td><td>5m</td><td>带宽瓶颈</td></tr><tr><td><strong>网络错误</strong></td><td><code>rate(node_network_receive_errs_total[5m]) / rate(node_network_receive_packets_total[5m]) &gt; 0.001</code></td><td>0.1%</td><td>5m</td><td>硬件问题</td></tr></tbody></table>
<hr/>
<p><strong>从 node_exporter 的指标，到生产级的告警规则，核心是一套设计思想：</strong></p>
<ul>
<li>理解本质（指标的含义）</li>
<li>加上时间（评估窗口 + 持续时长）</li>
<li>结合上下文（业务场景 + 关联指标）</li>
<li>持续迭代（追踪历史 + 质量改进）</li>
</ul>
<p>这不是一篇操作手册，而是一套方法论。掌握了这套思想，你就能设计出适合自己业务的告警规则。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Rspack 1.7 发布：聚焦稳定性，下一站 2.0]]></title>    <link>https://juejin.cn/post/7590684822726557736</link>    <guid>https://juejin.cn/post/7590684822726557736</guid>    <pubDate>2026-01-04T02:48:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590684822726557736" data-draft-id="7590597231708520483" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Rspack 1.7 发布：聚焦稳定性，下一站 2.0"/> <meta itemprop="keywords" content="前端,JavaScript,前端框架"/> <meta itemprop="datePublished" content="2026-01-04T02:48:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="WebInfra"/> <meta itemprop="url" content="https://juejin.cn/user/3368492743792695"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Rspack 1.7 发布：聚焦稳定性，下一站 2.0
            <!----> <!----></h1> <div class="container team-follow" data-v-d326b38e="" data-v-61fb5e44=""><div class="left" data-v-d326b38e=""><a href="/team/6930945479362478092/posts" data-v-d326b38e=""><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/498f2ad5f4cf43dd9093b71c5648f50f~tplv-k3u1fbpfcp-watermark.image" class="icon" data-v-d326b38e=""/></a> <div class="content" data-v-d326b38e=""><div style="display: flex" data-v-d326b38e=""><a href="/team/6930945479362478092/posts" data-v-d326b38e=""><p class="title-line" data-v-d326b38e=""><span title="ByteDance Web Infra" class="title" data-v-d326b38e="">ByteDance Web Infra</span> <img src="//lf-web-assets.juejin.cn/obj/juejin-web/xitu_juejin_web/255e400027b783cbad76dc41527e7695.svg" alt="team icon" class="team-icon" data-v-d326b38e=""/></p></a></div> <div class="meta-box team" data-v-d326b38e="" data-v-61fb5e44=""><time datetime="2026-01-04T02:48:04.000Z" title="Sun Jan 04 2026 02:48:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-d326b38e="" data-v-61fb5e44="">
                2026-01-04
              </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-d326b38e="" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-d326b38e="" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-d326b38e="" data-v-61fb5e44=""/></svg> <span class="views-count" style="display:none;" data-v-d326b38e="" data-v-61fb5e44="">
                12
              </span> <span class="read-time" data-v-d326b38e="" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-d326b38e="" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-d326b38e="" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-d326b38e="" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-d326b38e="" data-v-61fb5e44=""/></svg>
                阅读8分钟
              </span> <!----> <!----></div></div></div> <button class="jj-follow-button follow-btn" style="display:none;" data-v-b60b2868="" data-v-d326b38e=""><span data-v-b60b2868="" data-v-d326b38e=""><i class="byte-icon byte-icon--plus" data-v-d326b38e=""><svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 48 48"><path fill="none" d="M0 0h48v48H0z"/><path d="M24.7 4c.4 0 .6 0 .8.1.2.1.3.2.4.4.1.2.1.3.1.8V22h16.7c.4 0 .6 0 .8.1.2.1.3.2.4.4.1.2.1.3.1.8v1.4c0 .4 0 .6-.1.8-.1.2-.2.3-.4.4-.2.1-.3.1-.8.1H26v16.7c0 .4 0 .6-.1.8-.1.2-.2.3-.4.4-.2.1-.3.1-.8.1h-1.4c-.4 0-.6 0-.8-.1-.2-.1-.3-.2-.4-.4-.1-.2-.1-.3-.1-.8V26H5.3c-.4 0-.6 0-.8-.1-.2-.1-.3-.2-.4-.4-.1-.2-.1-.3-.1-.8v-1.4c0-.4 0-.6.1-.8.1-.2.2-.3.4-.4.2-.1.3-.1.8-.1H22V5.3c0-.4 0-.6.1-.8.1-.2.2-.3.4-.4.2-.1.3-.1.8-.1h1.4z"/></svg></i>
        关注
      </span></button></div> <div class="team-user block-hidden" data-v-61fb5e44=""><div class="avatar jj-avatar avatar" data-v-03256cc6="" data-v-61fb5e44=""><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAAA8AQMAAAAAMksxAAAAA1BMVEUAAACnej3aAAAAAXRSTlMAQObYZgAAAA5JREFUKM9jGAWjAAcAAAIcAAE27nY6AAAAAElFTkSuQmCC" alt="avatar" class="lazy avatar-img" data-v-5244ef91="" data-v-03256cc6=""/> </div> <!----> <span class="position ellipsis" data-v-61fb5e44="">
              前端 @字节跳动  Web Infra
            </span></div> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ed46d882c248414288065090059dfaac~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgV2ViSW5mcmE=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768100229&amp;x-signature=HXGQdgrxwXnCvwVja%2Bk70rff%2BzA%3D" alt="Rspack 1.7" loading="lazy"/></p>
<p>我们很高兴地宣布 Rspack 1.7 已正式发布！这是 Rspack 1.x 的最后一个 minor 版本，主要聚焦于现有功能的稳定性改进。接下来，我们将很快带来 Rspack 2.0。</p>
<p>值得关注的变更如下：</p>
<ul>
<li>新特性
<ul>
<li>SWC 插件兼容性提升</li>
<li>支持 Import Bytes</li>
<li>Lazy compilation</li>
<li>实验特性稳定化</li>
</ul>
</li>
<li>Rstack 进展
<ul>
<li>Rsbuild 1.7</li>
<li>Rsdoctor 1.4</li>
<li>Rslib 0.19</li>
<li>Rstest 0.7</li>
<li>Rspress 2.0 RC</li>
</ul>
</li>
</ul>
<h2 data-id="heading-0">新特性</h2>
<h3 data-id="heading-1">SWC 插件兼容性提升</h3>
<p>在过去的版本中，SWC Wasm 插件的升级成本一直较高。这是由于 SWC 的 AST 结构会随着版本演进发生变化，已有插件在 SWC 升级后可能无法继续工作，插件作者需要进行适配，插件使用者也需要同步升级依赖，这在一定程度上影响了项目的稳定性和升级体验。</p>
<p>为缓解这一问题，我们向 SWC 社区贡献了一系列 <a href="https://link.juejin.cn?target=https%3A%2F%2Fswc.rs%2Fdocs%2Fplugin%2Fecmascript%2Fcompatibility" target="_blank" title="https://swc.rs/docs/plugin/ecmascript/compatibility" ref="nofollow noopener noreferrer">兼容性改进</a>，包括：</p>
<ul>
<li>使用自描述式的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.rfc-editor.org%2Frfc%2Frfc8949.html" target="_blank" title="https://www.rfc-editor.org/rfc/rfc8949.html" ref="nofollow noopener noreferrer">cbor</a> 序列化方案，取代原先对版本敏感的 <a href="https://link.juejin.cn?target=https%3A%2F%2Frkyv.org%2F" target="_blank" title="https://rkyv.org/" ref="nofollow noopener noreferrer">rkyv</a>，使 Wasm 插件能更好地适应 AST 结构的变更</li>
<li>为 AST 中的枚举类型引入 <code>Unknown</code> 变体，从而在遇到新字段或新节点时提升容错能力</li>
</ul>
<p>在 Rspack 1.7 中，我们升级了使用的 SWC 版本并支持了上述方案。在此之后，多数场景下 SWC 的升级将不会影响基于旧版本 SWC 构建的插件的正常使用。</p>
<p>目前，该方案已在大部分流行的 SWC Wasm 插件中完成接入。如果你是 SWC Wasm 插件作者，可参考 <a href="https://link.juejin.cn?target=https%3A%2F%2Fswc.rs%2Fdocs%2Fplugin%2Fecmascript%2Fcompatibility%23make-your-plugin-compatible" target="_blank" title="https://swc.rs/docs/plugin/ecmascript/compatibility#make-your-plugin-compatible" ref="nofollow noopener noreferrer">官方指南</a>，接入该方案，以降低后续版本演进中的维护成本。</p>
<h3 data-id="heading-2">支持 Import Bytes</h3>
<p>Rspack 现已原生支持 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftc39%2Fproposal-import-bytes" target="_blank" title="https://github.com/tc39/proposal-import-bytes" ref="nofollow noopener noreferrer">Import Bytes</a> 提案，可以将静态资源作为 <code>Uint8Array</code> 导入，并通过 <code>TextDecoder</code> 解码。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 静态导入</span>
<span class="hljs-keyword">import</span> fileBytes <span class="hljs-keyword">from</span> <span class="hljs-string">'./file.bin'</span> <span class="hljs-keyword">with</span> { <span class="hljs-attr">type</span>: <span class="hljs-string">'bytes'</span> };
<span class="hljs-keyword">const</span> decoder = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TextDecoder</span>(<span class="hljs-string">'utf-8'</span>);
<span class="hljs-keyword">const</span> text = decoder.<span class="hljs-title function_">decode</span>(fileBytes);

<span class="hljs-comment">// 动态导入</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable language_">module</span> = <span class="hljs-keyword">await</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'./file.bin'</span>, { <span class="hljs-attr">with</span>: { <span class="hljs-attr">type</span>: <span class="hljs-string">'bytes'</span> } });
<span class="hljs-keyword">const</span> decoder = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TextDecoder</span>(<span class="hljs-string">'utf-8'</span>);
<span class="hljs-keyword">const</span> text = decoder.<span class="hljs-title function_">decode</span>(<span class="hljs-variable language_">module</span>.<span class="hljs-property">default</span>);
</code></pre>
<h3 data-id="heading-3">Lazy compilation</h3>
<p>在 Rspack 1.5 中，我们完成了 <a href="https://link.juejin.cn?target=http%3A%2F%2Frspack.rs%2Fzh%2Fguide%2Ffeatures%2Flazy-compilation" target="_blank" title="http://rspack.rs/zh/guide/features/lazy-compilation" ref="nofollow noopener noreferrer">Lazy Compilation</a> 特性的稳定化，并在 Rsbuild 中默认对动态导入的模块启用了按需编译。</p>
<p>从 Rspack 1.7 开始，Rspack CLI 在构建 web 应用时也将默认对动态导入的模块启用按需编译。这一改进可以减少首次构建的模块数量，从而加快开发服务器的启动速度。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// rspack.config.mjs</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-comment">// 当前默认配置</span>
  <span class="hljs-attr">lazyCompilation</span>: {
    <span class="hljs-attr">imports</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">entries</span>: <span class="hljs-literal">false</span>,
  },
};
</code></pre>
<p>如果你有特殊需求，例如需要调试完整构建的产物，或分析完整的模块图，可以通过将 <a href="https://link.juejin.cn?target=http%3A%2F%2Frspack.rs%2Fzh%2Fconfig%2Flazy-compilation" target="_blank" title="http://rspack.rs/zh/config/lazy-compilation" ref="nofollow noopener noreferrer">lazyCompilation</a> 设置为 <code>false</code> 来显式关闭该功能。</p>
<h3 data-id="heading-4">实验特性稳定化</h3>
<p>在 Rspack 1.7 中，我们稳定化了多项实验性特性。以下能力已完成生产验证并进入稳定阶段，相关实验开关也随之废弃，或调整为默认行为：</p>
<ul>
<li><strong>常量内联优化</strong>：该优化已正式稳定，并在生产构建中默认启用。
<ul>
<li>原有的 <a href="https://link.juejin.cn?target=http%3A%2F%2Frspack.rs%2Fzh%2Fconfig%2Fdeprecated-options%23experimentsinlineconst" target="_blank" title="http://rspack.rs/zh/config/deprecated-options#experimentsinlineconst" ref="nofollow noopener noreferrer">experiments.inlineConst</a> 选项已废弃</li>
<li>如需关闭该行为，可通过 <a href="https://link.juejin.cn?target=http%3A%2F%2Frspack.rs%2Fzh%2Fconfig%2Foptimization%23optimizationinlineexports" target="_blank" title="http://rspack.rs/zh/config/optimization#optimizationinlineexports" ref="nofollow noopener noreferrer">optimization.inlineExports</a> 来控制</li>
</ul>
</li>
<li><strong>TypeScript enum 内联优化</strong>：该优化已正式稳定。
<ul>
<li>原有的 <a href="https://link.juejin.cn?target=http%3A%2F%2Frspack.rs%2Fzh%2Fconfig%2Fdeprecated-options%23experimentsinlineenum" target="_blank" title="http://rspack.rs/zh/config/deprecated-options#experimentsinlineenum" ref="nofollow noopener noreferrer">experiments.inlineEnum</a> 选项已废弃</li>
<li>使用 <a href="https://link.juejin.cn?target=http%3A%2F%2Frspack.rs%2Fzh%2Fguide%2Ffeatures%2Fbuiltin-swc-loader%23collecttypescriptinfoexportedenum" target="_blank" title="http://rspack.rs/zh/guide/features/builtin-swc-loader#collecttypescriptinfoexportedenum" ref="nofollow noopener noreferrer">collectTypeScriptInfo.exportedEnum</a> 控制是否收集导出的 <code>enum</code> 信息</li>
<li>使用 <a href="https://link.juejin.cn?target=http%3A%2F%2Frspack.rs%2Fzh%2Fconfig%2Foptimization%23optimizationinlineexports" target="_blank" title="http://rspack.rs/zh/config/optimization#optimizationinlineexports" ref="nofollow noopener noreferrer">optimization.inlineExports</a> 来控制是否内联 <code>enum</code></li>
</ul>
</li>
<li><strong>类型重导出检查</strong>：该优化已正式稳定。
<ul>
<li>原有的 <a href="https://link.juejin.cn?target=http%3A%2F%2Frspack.rs%2Fzh%2Fconfig%2Fdeprecated-options%23experimentstypereexportspresence" target="_blank" title="http://rspack.rs/zh/config/deprecated-options#experimentstypereexportspresence" ref="nofollow noopener noreferrer">experiments.typeReexportsPresence</a> 选项已废弃</li>
</ul>
</li>
</ul>
<blockquote>
<p>参考 <a href="#%E5%8D%87%E7%BA%A7%E6%8C%87%E5%8D%97" title="#%E5%8D%87%E7%BA%A7%E6%8C%87%E5%8D%97">升级指南</a> 了解如何调整相关配置。</p>
</blockquote>
<h2 data-id="heading-5">Rstack 进展</h2>
<h3 data-id="heading-6">Rsbuild 1.7</h3>
<h4 data-id="heading-7">Error overlay 改进</h4>
<p>Rsbuild 的 error overlay 现在支持显示<strong>运行时错误</strong>。当应用在运行过程中抛出异常时，错误会直接渲染到 overlay 上，帮助你更快发现并定位问题。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1cfbf1e4fd1c4029b52c213460dc60bb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgV2ViSW5mcmE=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768100229&amp;x-signature=Ojf5PiN2Ido%2FEAtbPzdJFysHq9o%3D" alt="Rsbuild 1.7 Error Overlay" loading="lazy"/></p>
<p>该功能默认关闭，可通过 <a href="https://link.juejin.cn?target=https%3A%2F%2Frsbuild.rs%2Fzh%2Fconfig%2Fdev%2Fclient%23overlayruntime" target="_blank" title="https://rsbuild.rs/zh/config/dev/client#overlayruntime" ref="nofollow noopener noreferrer">dev.client.overlay.runtime</a> 选项按需开启：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// rsbuild.config.ts</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">dev</span>: {
    <span class="hljs-attr">client</span>: {
      <span class="hljs-attr">overlay</span>: {
        <span class="hljs-attr">runtime</span>: <span class="hljs-literal">true</span>,
      },
    },
  },
};
</code></pre>
<h4 data-id="heading-8">产物体积对比</h4>
<p>Rsbuild 现在支持输出产物体积对比，用来查看构建结果是否发生了体积变化。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c180bedf361246ada3b8253fe3d007cf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgV2ViSW5mcmE=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768100229&amp;x-signature=V4ANgnAOucx4677Htqx02%2BRx4iE%3D" alt="Rsbuild 1.7 Print Size Diff" loading="lazy"/></p>
<p>开启 <a href="https://link.juejin.cn?target=https%3A%2F%2Frsbuild.rs%2Fzh%2Fconfig%2Fperformance%2Fprint-file-size%23diff" target="_blank" title="https://rsbuild.rs/zh/config/performance/print-file-size#diff" ref="nofollow noopener noreferrer">performance.printFileSize.diff</a> 选项后，Rsbuild 构建完成时会记录一份产物体积快照，后续构建会自动与上一次结果对比，并在日志中直接展示体积变化。你可以清楚地看到每个文件是变大还是变小，以及整体体积的增减情况，适合在日常开发和性能回归中快速发现体积变化。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// rsbuild.config.ts</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">performance</span>: {
    <span class="hljs-attr">printFileSize</span>: {
      <span class="hljs-attr">diff</span>: <span class="hljs-literal">true</span>,
    },
  },
};
</code></pre>
<h4 data-id="heading-9">create-rsbuild 改进</h4>
<p><code>create-rsbuild</code> 现在包含了更多开箱即用的工具。</p>
<p>在创建 Rsbuild 项目时，你现在可以选择自动集成 <a href="https://link.juejin.cn?target=https%3A%2F%2Frstest.rs%2F" target="_blank" title="https://rstest.rs/" ref="nofollow noopener noreferrer">Rstest</a> 作为测试框架，或启用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fstorybook.rsbuild.rs%2F" target="_blank" title="https://storybook.rsbuild.rs/" ref="nofollow noopener noreferrer">Storybook</a> 用于 UI 组件的开发与调试。相关依赖和配置都会在初始化时一次性完成，减少重复的手动配置成本。</p>
<pre><code class="hljs language-text" lang="text">◆  Select additional tools (Use &lt;space&gt; to select, &lt;enter&gt; to continue)
│  ◼ Rstest - testing
│  ◻ Biome - linting &amp; formatting
│  ◻ ESLint - linting
│  ◻ Prettier - formatting
│  ◻ Storybook - component development
└
</code></pre>
<h3 data-id="heading-10">Rsdoctor 1.4</h3>
<h4 data-id="heading-11">新的 Treemap 视图</h4>
<p>Rsdoctor 1.4 对原有的 <a href="https://link.juejin.cn?target=https%3A%2F%2Frsdoctor.rs%2Fzh%2Fguide%2Fusage%2Fbundle-size" target="_blank" title="https://rsdoctor.rs/zh/guide/usage/bundle-size" ref="nofollow noopener noreferrer">Treemap</a> 视图进行了改进。新的交互设计可以帮助你更直观地分析 bundle 的整体构成，以及各类资源和模块的体积占比。</p>
<p>在该视图中，你可以通过搜索快速定位到具体的模块或资源。点击某个模块或资源后，视图会自动聚焦并放大对应区域。双击模块还可以展开其依赖链路，逐层查看模块之间的引用关系，从而更清晰地分析体积来源。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e1fceebd3afc46d0827dc1699d22aec2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgV2ViSW5mcmE=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768100229&amp;x-signature=%2BNE1KzKL%2BYXQeFwj7RnlaR7T28M%3D" alt="Rsdoctor Treemap" loading="lazy"/></p>
<h3 data-id="heading-12">Rslib 0.19</h3>
<h4 data-id="heading-13">ESM 产物稳定化</h4>
<p>在此前的版本中，Rslib 通过实验性配置 <a href="https://link.juejin.cn?target=https%3A%2F%2Frslib.rs%2Fzh%2Fconfig%2Flib%2Fexperiments%23experimentsadvancedesm" target="_blank" title="https://rslib.rs/zh/config/lib/experiments#experimentsadvancedesm" ref="nofollow noopener noreferrer">experiments.advancedEsm</a> 来启用 Rspack 的 <a href="https://link.juejin.cn?target=http%3A%2F%2Frspack.rs%2Fzh%2Fplugins%2Frspack%2Fesm-library-plugin%23esmlibraryplugin" target="_blank" title="http://rspack.rs/zh/plugins/rspack/esm-library-plugin#esmlibraryplugin" ref="nofollow noopener noreferrer">新版 ESM 库产物</a>，用于提升 ESM 产物的整体质量。经过多个版本的验证与打磨，该能力现已完成稳定化。</p>
<p>自 Rslib 0.19 起，Rslib 的 bundle 模式将默认启用该特性。开发者无需进行任何额外配置，即可直接获得对静态分析更友好、并完整支持代码分割的 ESM 产物。</p>
<h4 data-id="heading-14">JavaScript API</h4>
<p>Rslib 0.19 引入了 <a href="https://link.juejin.cn?target=https%3A%2F%2Frslib.rs%2Fapi%2Fstart" target="_blank" title="https://rslib.rs/api/start" ref="nofollow noopener noreferrer">JavaScript API</a>，使开发者可以在 JavaScript 代码中以编程方式直接调用 Rslib 的构建能力。</p>
<p>下面是一个基础示例：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { createRslib } <span class="hljs-keyword">from</span> <span class="hljs-string">'@rslib/core'</span>;

<span class="hljs-comment">// 创建 Rslib 实例</span>
<span class="hljs-keyword">const</span> rslib = <span class="hljs-keyword">await</span> <span class="hljs-title function_">createRslib</span>();
<span class="hljs-comment">// 构建生产环境输出</span>
<span class="hljs-keyword">await</span> rslib.<span class="hljs-title function_">build</span>();
</code></pre>
<blockquote>
<p>更多使用方式请参考 <a href="https://link.juejin.cn?target=https%3A%2F%2Frslib.rs%2Fapi%2Fjavascript-api%2Fcore" target="_blank" title="https://rslib.rs/api/javascript-api/core" ref="nofollow noopener noreferrer">API 文档</a>。</p>
</blockquote>
<h3 data-id="heading-15">Rstest 0.7</h3>
<h4 data-id="heading-16">配置适配器</h4>
<p>Rstest 0.7 引入了 <a href="https://link.juejin.cn?target=https%3A%2F%2Frstest.rs%2Fzh%2Fconfig%2Ftest%2Fextends" target="_blank" title="https://rstest.rs/zh/config/test/extends" ref="nofollow noopener noreferrer">extends</a> 选项和适配器机制，用于直接复用现有的工具或框架配置。适配器是一个配置转换函数，可以将其他工具的配置转换为 Rstest 的配置，从而降低 Rstest 的集成成本。</p>
<p>例如，在一个使用 Rslib 的库项目中，通过 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.npmjs.com%2Fpackage%2F%40rstest%2Fadapter-rslib" target="_blank" title="https://www.npmjs.com/package/@rstest/adapter-rslib" ref="nofollow noopener noreferrer">@rstest/adapter-rslib</a> 适配器，你可以直接复用已有的 Rslib 配置：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// rstest.config.ts</span>
<span class="hljs-keyword">import</span> { defineConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">'@rstest/core'</span>;
<span class="hljs-keyword">import</span> { withRslibConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">'@rstest/adapter-rslib'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({
  <span class="hljs-comment">// 自动读取 rslib.config.ts 并转换为 Rstest 配置</span>
  <span class="hljs-attr">extends</span>: <span class="hljs-title function_">withRslibConfig</span>(),
  <span class="hljs-comment">// 其他测试配置</span>
  <span class="hljs-attr">coverage</span>: {
    <span class="hljs-comment">// ...</span>
  },
});
</code></pre>
<p>适配器则负责将不同工具的配置转换为 Rstest 的配置（如 <code>define</code>、<code>alias</code> 等），而 <code>extends</code> 则负责将转换后的配置与 Rstest 的配置进行合并。通过二者的配合，任何基于 Rspack 的工具或框架，都可以以最小成本与 Rstest 集成。</p>
<p>目前 <code>@rstest/adapter-rslib</code> 适配器已正式发布，后续我们还将推出更多适配器，以对接 Rstack 的各个工具。你也可以参考 <a href="https://link.juejin.cn?target=https%3A%2F%2Frstest.rs%2Fzh%2Fguide%2Fintegration%2Fadapters" target="_blank" title="https://rstest.rs/zh/guide/integration/adapters" ref="nofollow noopener noreferrer">Rstest - 适配器</a> 来编写自定义的适配器。</p>
<h4 data-id="heading-17">测试反馈优化</h4>
<p>Rstest 针对本地开发与调试场景进行了多项体验优化，让测试反馈更加直观：</p>
<ul>
<li>
<p><strong>更早发现卡住的测试:</strong> Rstest 现已支持在本地运行时标记长时间未完成的测试用例。当测试过程变慢时，你可以直接看到是哪个用例正在执行、可能已经卡住，而不再只能盯着终端等待整个测试超时结束。</p>
</li>
<li>
<p><strong>更清晰的超时失败反馈:</strong> 当测试因超时失败时，Rstest 现在会在错误信息中展示已执行的断言数量。这能帮助你快速判断测试是否已经部分执行，或是卡在了某个异步逻辑中，从而更快定位问题。</p>
</li>
</ul>
<h3 data-id="heading-18">Rspress 2.0 RC</h3>
<h4 data-id="heading-19">SSG-MD 特性</h4>
<p>在基于 React 动态渲染的前端框架中，往往存在静态信息难以提取的问题，Rspress 也遇到了相同的问题。Rspress 允许用户通过 <a href="https://link.juejin.cn?target=https%3A%2F%2Fv2.rspress.rs%2Fzh%2Fguide%2Fuse-mdx%2Fcomponents" target="_blank" title="https://v2.rspress.rs/zh/guide/use-mdx/components" ref="nofollow noopener noreferrer">MDX 片段</a>、React 组件、Hooks 以及 TSX 路由等动态特性来增强文档表现力。但这些动态内容在转换为 Markdown 文本时会面临以下问题：</p>
<ul>
<li>直接将 MDX 输入给 AI 会包含大量代码语法噪音，并丢失 React 组件内容</li>
<li>将 SSG 生成的 HTML 转为 Markdown 往往效果不佳，信息质量难以保证</li>
</ul>
<p>为了解决这个问题，Rspress 2.0 引入了 <a href="https://link.juejin.cn?target=https%3A%2F%2Fv2.rspress.rs%2Fzh%2Fguide%2Fbasic%2Fssg-md" target="_blank" title="https://v2.rspress.rs/zh/guide/basic/ssg-md" ref="nofollow noopener noreferrer">SSG-MD</a> 特性。这是一个全新的功能，见名知意，与 <a href="https://link.juejin.cn?target=https%3A%2F%2Fv2.rspress.rs%2Fzh%2Fguide%2Fbasic%2Fssg" target="_blank" title="https://v2.rspress.rs/zh/guide/basic/ssg" ref="nofollow noopener noreferrer">静态站点生成（SSG）</a> 唯一的不同在于它将你的页面渲染为 Markdown 文件，而非 HTML 文件，并生成 <a href="https://link.juejin.cn?target=https%3A%2F%2Fllmstxt.org%2F" target="_blank" title="https://llmstxt.org/" ref="nofollow noopener noreferrer">llms.txt</a> 及 llms-full.txt 相关文件。相比与将 HTML 转化为 Markdown 等传统方式，SSG-MD 在渲染期间拥有更好的信息源，比如 React 虚拟 DOM，因此拥有更好的静态信息质量和灵活性。</p>
<p>启用方式非常简单：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// rspress.config.mjs</span>
<span class="hljs-keyword">import</span> { defineConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">'@rspress/core'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({
  <span class="hljs-attr">llms</span>: <span class="hljs-literal">true</span>,
});
</code></pre>
<p>构建后将生成如下结构：</p>
<pre><code class="hljs language-bash" lang="bash">doc_build
├── llms.txt          <span class="hljs-comment"># 摘要版，包含关键文档索引</span>
├── llms-full.txt     <span class="hljs-comment"># 完整版，包含所有文档内容</span>
├── guide
│   └── start
│       └── introduction.md
└── ...
</code></pre>
<p>对于自定义组件，你可以通过环境变量来控制其在 SSG-MD 模式下的渲染行为：</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Tab</span>(<span class="hljs-params">{ label }: { label: <span class="hljs-built_in">string</span> }</span>) {
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">env</span>.<span class="hljs-property">SSG_MD</span>) {
    <span class="hljs-comment">// SSG-MD 模式下输出纯文本描述</span>
    <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;&gt;</span>{`**Tab: ${label}**`}<span class="hljs-tag">&lt;/&gt;</span></span>;
  }
  <span class="hljs-comment">// 正常渲染交互式组件</span>
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"tab"</span>&gt;</span>{label}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
}
</code></pre>
<p>这样既保证了文档的交互体验，也能帮助 AI 理解组件的语义信息。</p>
<blockquote>
<p>详见 <a href="https://link.juejin.cn?target=https%3A%2F%2Fv2.rspress.rs%2Fzh%2Fguide%2Fbasic%2Fssg-md" target="_blank" title="https://v2.rspress.rs/zh/guide/basic/ssg-md" ref="nofollow noopener noreferrer">SSG-MD 使用指南</a></p>
</blockquote>
<h2 data-id="heading-20">升级指南</h2>
<h3 data-id="heading-21">升级 SWC 插件</h3>
<p>如果你的项目中使用了 SWC Wasm 插件（如 <code>@swc/plugin-emotion</code> 等），请升级插件至兼容 <code>swc_core@54</code> 及以上版本，否则可能因版本不兼容导致构建失败或运行异常。</p>
<blockquote>
<p>详情请查阅：<a href="https://link.juejin.cn?target=http%3A%2F%2Frspack.rs%2Fzh%2Ferrors%2Fswc-plugin-version" target="_blank" title="http://rspack.rs/zh/errors/swc-plugin-version" ref="nofollow noopener noreferrer">常见问题 - SWC 插件版本不匹配</a>。</p>
</blockquote>
<h3 data-id="heading-22">移除废弃配置</h3>
<ul>
<li>以下实验性选项已废弃，可以直接移除：</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// rspack.config.mjs</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-comment">// [!code --]</span>
  <span class="hljs-attr">experiments</span>: {
    <span class="hljs-comment">// [!code --]</span>
    <span class="hljs-attr">inlineConst</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-comment">// [!code --]</span>
    <span class="hljs-attr">inlineEnum</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-comment">// [!code --]</span>
    <span class="hljs-attr">typeReexportsPresence</span>: <span class="hljs-literal">true</span>,
  },
};
</code></pre>
<ul>
<li>调整 <code>builtin:swc-loader</code> 中的 <a href="https://link.juejin.cn?target=http%3A%2F%2Frspack.rs%2Fzh%2Fguide%2Ffeatures%2Fbuiltin-swc-loader%23collecttypescriptinfo" target="_blank" title="http://rspack.rs/zh/guide/features/builtin-swc-loader#collecttypescriptinfo" ref="nofollow noopener noreferrer">collectTypeScriptInfo</a> 选项位置，移除 <code>rspackExperiments</code> 层级：</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// rspack.config.mjs</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">module</span>: {
    <span class="hljs-attr">rules</span>: [
      {
        <span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.ts$/</span>,
        <span class="hljs-attr">loader</span>: <span class="hljs-string">'builtin:swc-loader'</span>,
        <span class="hljs-attr">options</span>: {
          <span class="hljs-comment">// [!code --]</span>
          <span class="hljs-attr">rspackExperiments</span>: {
            <span class="hljs-attr">collectTypeScriptInfo</span>: {
              <span class="hljs-attr">exportedEnum</span>: <span class="hljs-literal">true</span>,
              <span class="hljs-attr">typeExports</span>: <span class="hljs-literal">true</span>,
            },
            <span class="hljs-comment">// [!code --]</span>
          },
        },
      },
    ],
  },
};
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[三个核心概念，帮你彻底打通 TypeScript 泛型]]></title>    <link>https://juejin.cn/post/7590961898398744614</link>    <guid>https://juejin.cn/post/7590961898398744614</guid>    <pubDate>2026-01-04T02:51:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590961898398744614" data-draft-id="7591066233669664794" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="三个核心概念，帮你彻底打通 TypeScript 泛型"/> <meta itemprop="keywords" content="前端,TypeScript"/> <meta itemprop="datePublished" content="2026-01-04T02:51:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="皮蛋小精灵"/> <meta itemprop="url" content="https://juejin.cn/user/219558056559278"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            三个核心概念，帮你彻底打通 TypeScript 泛型
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/219558056559278/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    皮蛋小精灵
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-04T02:51:38.000Z" title="Sun Jan 04 2026 02:51:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">1. 核心痛点：丢失的“身份证”</h3>
<p>在没有泛型之前，我们想写一个通用的函数（比如返回你传给它的值），通常会遇到两个极端：</p>
<ul>
<li><strong>写死类型：</strong> 只能传 <code>number</code>，传 <code>string</code> 就报错。太死板。</li>
<li><strong>使用 <code>any</code>：</strong> 什么都能传，但进去之后 <strong>“身份证”丢了</strong>。</li>
</ul>
<p><strong>举个“丢失身份证”的例子：</strong></p>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-comment">// 使用 any，就像一个黑盒</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">heuristic</span>(<span class="hljs-params">val: <span class="hljs-built_in">any</span></span>): <span class="hljs-built_in">any</span> {
  <span class="hljs-keyword">return</span> val;
}

<span class="hljs-keyword">const</span> result = <span class="hljs-title function_">heuristic</span>(<span class="hljs-string">"hello"</span>);
<span class="hljs-comment">// 🚨 问题来了：TypeScript 现在只知道 result 是 any 类型。</span>
<span class="hljs-comment">// 你打 result. specifically... 这里的代码提示全没了！</span>
<span class="hljs-comment">// 甚至写 result.toFixed() （这是数字的方法）它都不报错，直到运行时崩溃。</span>
</code></pre>
<p><strong>泛型的真正作用：</strong> 它是用来<strong>保住类型“身份证”的</strong>。</p>
<hr/>
<h3 data-id="heading-1">2. 思维模型：透明管道（The Transparent Tunnel）</h3>
<p>把泛型函数想象成一个<strong>透明的管道</strong>，而 <code>&lt;T&gt;</code> 就是管道入口的一个<strong>扫描仪</strong>。</p>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-keyword">function</span> tunnel&lt;T&gt;(<span class="hljs-attr">val</span>: T): T {
  <span class="hljs-keyword">return</span> val;
}
</code></pre>
<p>请跟着这个过程走一遍：</p>
<ol>
<li>当你调用 <code>tunnel("hello")</code> 时。</li>
<li><strong>扫描仪 <code>&lt;T&gt;</code></strong> 瞬间启动，它捕捉到了 <code>"hello"</code> 的类型是 <strong>String</strong>。</li>
<li>于是，在这个瞬间，函数内部所有的 <code>T</code> 自动变成了 <code>String</code>。</li>
<li><strong>最关键的一步：</strong> 它不仅处理了数据，还把 <strong>String</strong> 这个类型贴在了返回值上。</li>
</ol>
<p><strong>对比一下：</strong></p>
<ul>
<li><strong>any (黑盒):</strong> 苹果进去 -&gt; 黑盒处理 -&gt; 吐出一个“东西”（可能是苹果，也可能是炸弹）。</li>
<li><strong>泛型 (透明管道):</strong> 苹果进去 -&gt; <strong>T 记录下“这是苹果”</strong> -&gt; 管道处理 -&gt; 吐出一个<strong>带着“苹果”标签</strong>的苹果。</li>
</ul>
<hr/>
<h3 data-id="heading-2">3. 现实生活类比：万能USB接口 vs 定制插座</h3>
<p>为了彻底弄懂，我们用<strong>接口</strong>做比喻。</p>
<h4 data-id="heading-3">场景：你需要生产一种“万能包装盒”</h4>
<p>方案 A（不用泛型 - 类似于 any）：</p>
<p>你造了一个巨大的袋子。</p>
<ul>
<li>用户放入一支口红。</li>
<li>拿出来时，系统只标注这是“一个物品”。</li>
<li>用户甚至可能试图把这个“物品”当成汉堡吃掉，因为系统没告诉他这是口红。</li>
</ul>
<p>方案 B（使用泛型）：</p>
<p>你造了一个智能模具。</p>
<ul>
<li>当用户把“口红”放进去的那一刻，模具自动变形卡住口红，并打上标签： <strong>“内含：口红”</strong> 。</li>
<li>当用户把“汉堡”放进去，模具自动变形卡住汉堡，并打上标签： <strong>“内含：汉堡”</strong> 。</li>
</ul>
<p><strong>代码映射：</strong></p>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-comment">// 这是一个智能盒子 (Box)</span>
<span class="hljs-comment">// &lt;T&gt; 是这一轮生产的“物品类型”</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">Box</span>&lt;T&gt; {
  <span class="hljs-attr">content</span>: T; <span class="hljs-comment">// 内容物就是 T 类型</span>
}

<span class="hljs-comment">// 场景 1：装口红</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">lipstickBox</span>: <span class="hljs-title class_">Box</span>&lt;<span class="hljs-title class_">Lipstick</span>&gt; = { <span class="hljs-attr">content</span>: myLipstick };
<span class="hljs-comment">// ✅ TypeScript 知道：lipstickBox.content 是口红，不能吃。</span>

<span class="hljs-comment">// 场景 2：装汉堡</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">burgerBox</span>: <span class="hljs-title class_">Box</span>&lt;<span class="hljs-title class_">Burger</span>&gt; = { <span class="hljs-attr">content</span>: myBurger };
<span class="hljs-comment">// ✅ TypeScript 知道：burgerBox.content 是汉堡，可以吃。</span>
</code></pre>
<hr/>
<h3 data-id="heading-4">4. 再次审视那个“难懂”的语法</h3>
<p>现在回头看最基础的语法，是不是清晰了？</p>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-comment">// 这里的 &lt;T&gt; 是一份“契约”</span>
<span class="hljs-comment">// 它在说：嗨，进来的是什么类型 (参数 val: T)，出去的必须也是同一种类型 (返回值: T)！</span>
<span class="hljs-keyword">function</span> identify&lt;T&gt;(<span class="hljs-attr">val</span>: T): T {
    <span class="hljs-keyword">return</span> val;
}
</code></pre>
<ul>
<li><strong>T 不是值</strong>，它是一个<strong>占位符</strong>。</li>
<li>它的作用是<strong>捕获</strong>你调用函数那一刻传入的具体类型，然后把这个类型<strong>传递</strong>给参数和返回值。</li>
</ul>
<h3 data-id="heading-5">5. 进阶：为什么要用 <code>extends</code> (泛型约束)？</h3>
<p>有时候管道太宽了，我们想限制一下。</p>
<p><strong>比喻：</strong> 这是一个<strong>微波炉</strong>泛型。</p>
<ul>
<li>你可以放汉堡、放牛奶（T 可以变）。</li>
<li>但你<strong>绝对不能放金属</strong>。</li>
</ul>
<p>所以我们需要给 T 加个过滤器：</p>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-comment">// 这里的 extends 表示“必须包含”</span>
<span class="hljs-comment">// T 必须包含 .length 属性，否则微波炉不工作</span>
<span class="hljs-keyword">function</span> logLength&lt;T <span class="hljs-keyword">extends</span> { <span class="hljs-attr">length</span>: <span class="hljs-built_in">number</span> }&gt;(<span class="hljs-attr">arg</span>: T) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(arg.<span class="hljs-property">length</span>);
}

<span class="hljs-title function_">logLength</span>(<span class="hljs-string">"abc"</span>); <span class="hljs-comment">// ✅ 字符串有 length</span>
<span class="hljs-title function_">logLength</span>([<span class="hljs-number">1</span>,<span class="hljs-number">2</span>]); <span class="hljs-comment">// ✅ 数组有 length</span>
<span class="hljs-title function_">logLength</span>(<span class="hljs-number">100</span>);   <span class="hljs-comment">// ❌ 报错！数字没有 length，被拒之门外</span>
</code></pre>
<h3 data-id="heading-6">总结</h3>
<p>现在请这样记住它：</p>
<p>泛型就是一种“类型传声筒”或者“类型关联器”。</p>
<p>它的核心目的只有两个：</p>
<ol>
<li><strong>灵活：</strong> <code>any</code>，允许你传入不同类型。</li>
<li><strong>严谨：</strong> 具体类型，<strong>记住</strong>你传了什么，并在后续操作中<strong>锁死</strong>这个关系，不让类型信息丢失。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Scrapy框架数据存储完全指南（实操为主，易落地）]]></title>    <link>https://juejin.cn/post/7590213554799067171</link>    <guid>https://juejin.cn/post/7590213554799067171</guid>    <pubDate>2026-01-03T14:33:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590213554799067171" data-draft-id="7590303618429403171" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Scrapy框架数据存储完全指南（实操为主，易落地）"/> <meta itemprop="keywords" content="Python"/> <meta itemprop="datePublished" content="2026-01-03T14:33:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="好汉学技术"/> <meta itemprop="url" content="https://juejin.cn/user/3704681342438299"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Scrapy框架数据存储完全指南（实操为主，易落地）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3704681342438299/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    好汉学技术
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-03T14:33:25.000Z" title="Sat Jan 03 2026 14:33:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>你想掌握Scrapy框架的数据存储方法，核心是围绕<strong>Item数据模型</strong>和**Pipeline（数据管道）**展开——Scrapy将爬取到的数据先封装到Item中，再通过Pipeline统一处理存储，支持本地文件、关系型数据库、非关系型数据库等多种存储方式，以下是详细实操教程，无冗余理论，可直接复刻运行。</p>
<h2 data-id="heading-0">一、前置基础：数据存储的核心流程</h2>
<ol>
<li>定义<code>Item</code>：在<code>items.py</code>中声明需要存储的字段，规范数据格式（避免杂乱数据）；</li>
<li>解析数据封装到<code>Item</code>：在爬虫文件中，将解析到的数据存入自定义<code>Item</code>对象并<code>yield</code>；</li>
<li>启用<code>Pipeline</code>：在<code>settings.py</code>中配置启用对应的管道（设置优先级，数字越小优先级越高）；</li>
<li>实现存储逻辑：在<code>pipelines.py</code>中编写具体的存储代码（文件/数据库等）；</li>
<li>运行爬虫：自动触发Pipeline，完成数据存储。</li>
</ol>
<h3 data-id="heading-1">必备前置准备（快速搭建测试环境）</h3>
<ol>
<li>已有Scrapy项目（若无，执行<code>scrapy startproject data_storage_spider</code>创建）；</li>
<li>简单爬虫示例（用于生成测试数据，后续所有存储方式均基于此）：</li>
</ol>
<ul>
<li>爬虫文件<code>spiders/test_spider.py</code>：</li>
</ul>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> scrapy
<span class="hljs-keyword">from</span> data_storage_spider.items <span class="hljs-keyword">import</span> DataStorageSpiderItem

<span class="hljs-keyword">class</span> <span class="hljs-title class_">TestSpider</span>(scrapy.Spider):
    name = <span class="hljs-string">"test_spider"</span>
    <span class="hljs-comment"># 测试用静态页面，无需处理动态渲染</span>
    start_urls = [<span class="hljs-string">"https://quotes.toscrape.com/"</span>]

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">parse</span>(<span class="hljs-params">self, response</span>):
        <span class="hljs-comment"># 解析名言数据</span>
        quote_items = response.xpath(<span class="hljs-string">"//div[@class='quote']"</span>)
        <span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> quote_items:
            <span class="hljs-comment"># 实例化自定义Item</span>
            quote_data = DataStorageSpiderItem()
            <span class="hljs-comment"># 封装数据（字段与items.py中定义一致）</span>
            quote_data[<span class="hljs-string">'content'</span>] = item.xpath(<span class="hljs-string">".//span[@class='text']/text()"</span>).extract_first() <span class="hljs-keyword">or</span> <span class="hljs-string">""</span>
            quote_data[<span class="hljs-string">'author'</span>] = item.xpath(<span class="hljs-string">".//small[@class='author']/text()"</span>).extract_first() <span class="hljs-keyword">or</span> <span class="hljs-string">""</span>
            quote_data[<span class="hljs-string">'tags'</span>] = <span class="hljs-string">","</span>.join(item.xpath(<span class="hljs-string">".//div[@class='tags']/a/text()"</span>).extract()) <span class="hljs-keyword">or</span> <span class="hljs-string">""</span>
            
            <span class="hljs-comment"># 提交数据到Pipeline（核心：yield Item对象）</span>
            <span class="hljs-keyword">yield</span> quote_data
</code></pre>
<ul>
<li>定义Item<code>items.py</code>：</li>
</ul>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> scrapy

<span class="hljs-keyword">class</span> <span class="hljs-title class_">DataStorageSpiderItem</span>(scrapy.Item):
    <span class="hljs-comment"># 定义需要存储的字段，scrapy.Field()仅用于标记，无额外逻辑</span>
    content = scrapy.Field()  <span class="hljs-comment"># 名言内容</span>
    author = scrapy.Field()   <span class="hljs-comment"># 作者</span>
    tags = scrapy.Field()     <span class="hljs-comment"># 标签（用逗号拼接为字符串，方便存储）</span>
</code></pre>
<h2 data-id="heading-2">二、方式1：本地文件存储（CSV/JSON/JSON Lines，最常用）</h2>
<p>本地文件存储无需额外安装依赖，适合小规模数据、快速验证结果，Scrapy提供两种实现方式：<strong>内置命令直接导出</strong>（快速便捷）、<strong>Pipeline自定义实现</strong>（灵活可控，支持复杂逻辑）。</p>
<h3 data-id="heading-3">1. 快速实现：Scrapy内置命令导出（无需编写Pipeline）</h3>
<p>直接在终端运行爬虫时，通过<code>-o</code>参数指定文件路径和格式，自动生成文件，支持<code>csv</code>、<code>json</code>、<code>jl</code>（JSON Lines）三种常用格式。</p>
<h4 data-id="heading-4">（1）导出为CSV文件（推荐，易用于Excel分析）</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 进入项目目录后执行</span>
scrapy crawl test_spider -o quotes.csv -s FEED_EXPORT_ENCODING=utf_8_sig
</code></pre>
<ul>
<li>关键参数说明：
<ul>
<li><code>-o quotes.csv</code>：指定导出为CSV文件，文件名<code>quotes.csv</code>；</li>
<li><code>-s FEED_EXPORT_ENCODING=utf_8_sig</code>：解决中文乱码问题（核心参数，必加）；</li>
</ul>
</li>
<li>结果：项目根目录生成<code>quotes.csv</code>，可用Excel直接打开，数据格式规整。</li>
</ul>
<h4 data-id="heading-5">（2）导出为JSON文件</h4>
<pre><code class="hljs language-bash" lang="bash">scrapy crawl test_spider -o quotes.json -s FEED_EXPORT_ENCODING=utf_8_sig
</code></pre>
<ul>
<li>特点：数据以数组格式存储，适合后续JSON解析处理，缺点是大文件加载耗时久。</li>
</ul>
<h4 data-id="heading-6">（3）导出为JSON Lines文件（推荐，大文件友好）</h4>
<pre><code class="hljs language-bash" lang="bash">scrapy crawl test_spider -o quotes.jl -s FEED_EXPORT_ENCODING=utf_8_sig
</code></pre>
<ul>
<li>特点：每行一条JSON数据，无需加载整个文件即可解析，适合大规模本地数据存储，兼容性更强。</li>
</ul>
<h3 data-id="heading-7">2. 灵活实现：Pipeline自定义文件存储（支持复杂逻辑）</h3>
<p>内置命令无法满足自定义需求（如：按日期拆分文件、过滤无效数据、追加写入），此时需通过Pipeline实现，以CSV文件为例（JSON格式同理）。</p>
<h4 data-id="heading-8">（1）编写Pipeline存储逻辑（<code>pipelines.py</code>）</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> csv
<span class="hljs-keyword">import</span> os

<span class="hljs-keyword">class</span> <span class="hljs-title class_">CsvFileStoragePipeline</span>:
    <span class="hljs-string">"""自定义CSV文件存储管道"""</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
        <span class="hljs-comment"># 1. 初始化文件对象和CSV写入器</span>
        self.file = <span class="hljs-literal">None</span>
        self.writer = <span class="hljs-literal">None</span>
        <span class="hljs-comment"># CSV文件路径和表头</span>
        self.csv_path = <span class="hljs-string">"custom_quotes.csv"</span>
        self.fieldnames = [<span class="hljs-string">"content"</span>, <span class="hljs-string">"author"</span>, <span class="hljs-string">"tags"</span>]
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">open_spider</span>(<span class="hljs-params">self, spider</span>):
        <span class="hljs-string">"""爬虫启动时执行（仅执行一次），用于打开文件、初始化写入器"""</span>
        <span class="hljs-comment"># 追加写入模式（a）：避免覆盖已有数据；newline=""：避免CSV出现空行</span>
        self.file = <span class="hljs-built_in">open</span>(self.csv_path, <span class="hljs-string">"a"</span>, newline=<span class="hljs-string">""</span>, encoding=<span class="hljs-string">"utf_8_sig"</span>)
        <span class="hljs-comment"># 检查文件是否为空，为空则写入表头</span>
        <span class="hljs-keyword">if</span> os.path.getsize(self.csv_path) == <span class="hljs-number">0</span>:
            self.writer = csv.DictWriter(self.file, fieldnames=self.fieldnames)
            self.writer.writeheader()
        <span class="hljs-keyword">else</span>:
            self.writer = csv.DictWriter(self.file, fieldnames=self.fieldnames)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">process_item</span>(<span class="hljs-params">self, item, spider</span>):
        <span class="hljs-string">"""核心：处理每个Item数据（爬虫提交一个Item，执行一次）"""</span>
        <span class="hljs-comment"># 过滤无效数据（自定义逻辑：排除空内容的记录）</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> item.get(<span class="hljs-string">"content"</span>) <span class="hljs-keyword">or</span> item.get(<span class="hljs-string">"content"</span>).strip() == <span class="hljs-string">""</span>:
            spider.logger.warning(<span class="hljs-string">"无效数据：内容为空，跳过存储"</span>)
            <span class="hljs-keyword">return</span> item
        
        <span class="hljs-comment"># 将Item转换为字典，写入CSV文件</span>
        self.writer.writerow(<span class="hljs-built_in">dict</span>(item))
        spider.logger.info(<span class="hljs-string">f"数据已写入CSV：<span class="hljs-subst">{item.get(<span class="hljs-string">'author'</span>)}</span> - <span class="hljs-subst">{item.get(<span class="hljs-string">'content'</span>)[:<span class="hljs-number">20</span>]}</span>..."</span>)
        <span class="hljs-keyword">return</span> item
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">close_spider</span>(<span class="hljs-params">self, spider</span>):
        <span class="hljs-string">"""爬虫关闭时执行（仅执行一次），用于关闭文件，释放资源"""</span>
        <span class="hljs-keyword">if</span> self.file:
            self.file.close()
            spider.logger.info(<span class="hljs-string">f"CSV文件存储完成，文件路径：<span class="hljs-subst">{self.csv_path}</span>"</span>)
</code></pre>
<h4 data-id="heading-9">（2）启用Pipeline（<code>settings.py</code>）</h4>
<p>找到<code>ITEM_PIPELINES</code>配置，取消注释并添加自定义管道（优先级300，可根据需求调整）：</p>
<pre><code class="hljs language-python" lang="python">ITEM_PIPELINES = {
   <span class="hljs-string">'data_storage_spider.pipelines.CsvFileStoragePipeline'</span>: <span class="hljs-number">300</span>,
}
</code></pre>
<h4 data-id="heading-10">（3）运行爬虫验证结果</h4>
<pre><code class="hljs language-bash" lang="bash">scrapy crawl test_spider
</code></pre>
<ul>
<li>结果：项目根目录生成<code>custom_quotes.csv</code>，无中文乱码，已过滤空内容数据，支持追加写入（重复运行爬虫，数据不会覆盖，而是新增到文件末尾）。</li>
</ul>
<h2 data-id="heading-11">三、方式2：关系型数据库存储（以MySQL为例，生产环境常用）</h2>
<p>适合大规模结构化数据存储，支持数据查询、更新、关联分析，核心依赖<code>pymysql</code>库，步骤如下：</p>
<h3 data-id="heading-12">1. 安装依赖库</h3>
<pre><code class="hljs language-bash" lang="bash">pip install pymysql
</code></pre>
<h3 data-id="heading-13">2. 提前创建MySQL数据库和表</h3>
<ul>
<li>创建数据库<code>scrapy_data</code>（字符集<code>utf8mb4</code>，支持所有中文和特殊字符）；</li>
<li>创建表<code>quotes</code>（字段与Item对应，结构如下）：</li>
</ul>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> DATABASE IF <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span> scrapy_data <span class="hljs-keyword">DEFAULT</span> <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8mb4 <span class="hljs-keyword">COLLATE</span> utf8mb4_unicode_ci;

USE scrapy_data;

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span> quotes (
    id <span class="hljs-type">INT</span> <span class="hljs-keyword">PRIMARY</span> KEY AUTO_INCREMENT COMMENT <span class="hljs-string">'自增主键'</span>,
    content TEXT <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'名言内容'</span>,
    author <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'作者'</span>,
    tags <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">''</span> COMMENT <span class="hljs-string">'标签'</span>,
    create_time DATETIME <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="hljs-string">'存储时间'</span>
) ENGINE<span class="hljs-operator">=</span>InnoDB <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8mb4 COMMENT <span class="hljs-string">'名言数据表'</span>;
</code></pre>
<h3 data-id="heading-14">3. 编写MySQL存储Pipeline（<code>pipelines.py</code>）</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> pymysql

<span class="hljs-keyword">class</span> <span class="hljs-title class_">MysqlStoragePipeline</span>:
    <span class="hljs-string">"""MySQL数据库存储管道"""</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
        <span class="hljs-comment"># 数据库连接配置（根据自身环境修改）</span>
        self.host = <span class="hljs-string">"localhost"</span>
        self.port = <span class="hljs-number">3306</span>
        self.user = <span class="hljs-string">"root"</span>
        self.password = <span class="hljs-string">"你的MySQL密码"</span>
        self.db_name = <span class="hljs-string">"scrapy_data"</span>
        self.charset = <span class="hljs-string">"utf8mb4"</span>
        
        <span class="hljs-comment"># 初始化连接和游标对象</span>
        self.conn = <span class="hljs-literal">None</span>
        self.cursor = <span class="hljs-literal">None</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">open_spider</span>(<span class="hljs-params">self, spider</span>):
        <span class="hljs-string">"""爬虫启动时，建立MySQL连接"""</span>
        <span class="hljs-keyword">try</span>:
            self.conn = pymysql.connect(
                host=self.host,
                port=self.port,
                user=self.user,
                password=self.password,
                db=self.db_name,
                charset=self.charset
            )
            self.cursor = self.conn.cursor()
            spider.logger.info(<span class="hljs-string">"MySQL数据库连接成功"</span>)
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            spider.logger.error(<span class="hljs-string">f"MySQL数据库连接失败：<span class="hljs-subst">{e}</span>"</span>)
            <span class="hljs-keyword">raise</span> e
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">process_item</span>(<span class="hljs-params">self, item, spider</span>):
        <span class="hljs-string">"""核心：将Item数据插入MySQL数据库"""</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> item.get(<span class="hljs-string">"content"</span>):
            <span class="hljs-keyword">return</span> item
        
        <span class="hljs-comment"># 1. 定义SQL插入语句（使用占位符%s，避免SQL注入）</span>
        insert_sql = <span class="hljs-string">"""
        INSERT INTO quotes (content, author, tags)
        VALUES (%s, %s, %s)
        """</span>
        
        <span class="hljs-comment"># 2. 提取Item数据，组装为参数元组（与SQL占位符顺序对应）</span>
        item_data = (
            item.get(<span class="hljs-string">"content"</span>),
            item.get(<span class="hljs-string">"author"</span>),
            item.get(<span class="hljs-string">"tags"</span>)
        )
        
        <span class="hljs-keyword">try</span>:
            <span class="hljs-comment"># 3. 执行SQL语句</span>
            self.cursor.execute(insert_sql, item_data)
            <span class="hljs-comment"># 4. 提交事务（关键：不提交则数据不会写入数据库）</span>
            self.conn.commit()
            spider.logger.info(<span class="hljs-string">f"数据已插入MySQL：<span class="hljs-subst">{item.get(<span class="hljs-string">'author'</span>)}</span>"</span>)
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            <span class="hljs-comment"># 5. 出错时回滚事务，避免数据混乱</span>
            self.conn.rollback()
            spider.logger.error(<span class="hljs-string">f"数据插入MySQL失败：<span class="hljs-subst">{e}</span>，数据：<span class="hljs-subst">{item_data}</span>"</span>)
        
        <span class="hljs-keyword">return</span> item
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">close_spider</span>(<span class="hljs-params">self, spider</span>):
        <span class="hljs-string">"""爬虫关闭时，关闭游标和连接"""</span>
        <span class="hljs-keyword">if</span> self.cursor:
            self.cursor.close()
        <span class="hljs-keyword">if</span> self.conn:
            self.conn.close()
        spider.logger.info(<span class="hljs-string">"MySQL数据库连接已关闭"</span>)
</code></pre>
<h3 data-id="heading-15">4. 启用MySQL Pipeline（<code>settings.py</code>）</h3>
<pre><code class="hljs language-python" lang="python">ITEM_PIPELINES = {
   <span class="hljs-comment"># 可同时启用多个Pipeline，分别存储为CSV和MySQL（优先级300&lt;400，CSV先执行）</span>
   <span class="hljs-string">'data_storage_spider.pipelines.CsvFileStoragePipeline'</span>: <span class="hljs-number">300</span>,
   <span class="hljs-string">'data_storage_spider.pipelines.MysqlStoragePipeline'</span>: <span class="hljs-number">400</span>,
}
</code></pre>
<h3 data-id="heading-16">5. 运行爬虫验证结果</h3>
<pre><code class="hljs language-bash" lang="bash">scrapy crawl test_spider
</code></pre>
<ul>
<li>验证：登录MySQL，查询<code>scrapy_data.quotes</code>表，可看到已成功插入数据，无乱码，字段对应完整。</li>
</ul>
<h2 data-id="heading-17">四、方式3：非关系型数据库存储（以MongoDB为例，灵活存储非结构化数据）</h2>
<p>适合存储非结构化/半结构化数据（如字段不固定的爬取数据），无需提前定义表结构，核心依赖<code>pymongo</code>库，步骤如下：</p>
<h3 data-id="heading-18">1. 安装依赖库</h3>
<pre><code class="hljs language-bash" lang="bash">pip install pymongo
</code></pre>
<h3 data-id="heading-19">2. 提前启动MongoDB服务</h3>
<ul>
<li>本地MongoDB：启动<code>mongod</code>服务（默认端口27017，无需手动创建数据库和集合，插入数据时自动创建）；</li>
<li>远程MongoDB：准备好连接地址、用户名、密码。</li>
</ul>
<h3 data-id="heading-20">3. 编写MongoDB存储Pipeline（<code>pipelines.py</code>）</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> pymongo

<span class="hljs-keyword">class</span> <span class="hljs-title class_">MongodbStoragePipeline</span>:
    <span class="hljs-string">"""MongoDB数据库存储管道"""</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
        <span class="hljs-comment"># MongoDB连接配置（本地无密码，远程需添加username、password、authSource）</span>
        self.host = <span class="hljs-string">"localhost"</span>
        self.port = <span class="hljs-number">27017</span>
        self.db_name = <span class="hljs-string">"scrapy_data"</span>
        self.collection_name = <span class="hljs-string">"quotes"</span>  <span class="hljs-comment"># 集合（类似MySQL的表）</span>
        
        <span class="hljs-comment"># 初始化数据库连接和集合对象</span>
        self.client = <span class="hljs-literal">None</span>
        self.db = <span class="hljs-literal">None</span>
        self.collection = <span class="hljs-literal">None</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">open_spider</span>(<span class="hljs-params">self, spider</span>):
        <span class="hljs-string">"""爬虫启动时，建立MongoDB连接"""</span>
        <span class="hljs-keyword">try</span>:
            <span class="hljs-comment"># 建立连接（本地无密码）</span>
            self.client = pymongo.MongoClient(host=self.host, port=self.port)
            <span class="hljs-comment"># 选择数据库（不存在则自动创建）</span>
            self.db = self.client[self.db_name]
            <span class="hljs-comment"># 选择集合（不存在则自动创建）</span>
            self.collection = self.db[self.collection_name]
            spider.logger.info(<span class="hljs-string">"MongoDB数据库连接成功"</span>)
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            spider.logger.error(<span class="hljs-string">f"MongoDB数据库连接失败：<span class="hljs-subst">{e}</span>"</span>)
            <span class="hljs-keyword">raise</span> e
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">process_item</span>(<span class="hljs-params">self, item, spider</span>):
        <span class="hljs-string">"""核心：将Item数据插入MongoDB（转换为字典即可）"""</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> item.get(<span class="hljs-string">"content"</span>):
            <span class="hljs-keyword">return</span> item
        
        <span class="hljs-comment"># 1. 将Item转换为字典（Scrapy Item对象可直接强转为dict）</span>
        item_dict = <span class="hljs-built_in">dict</span>(item)
        
        <span class="hljs-keyword">try</span>:
            <span class="hljs-comment"># 2. 插入数据（insert_one：插入单条数据；insert_many：插入多条数据）</span>
            self.collection.insert_one(item_dict)
            spider.logger.info(<span class="hljs-string">f"数据已插入MongoDB：<span class="hljs-subst">{item_dict.get(<span class="hljs-string">'author'</span>)}</span>"</span>)
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            spider.logger.error(<span class="hljs-string">f"数据插入MongoDB失败：<span class="hljs-subst">{e}</span>，数据：<span class="hljs-subst">{item_dict}</span>"</span>)
        
        <span class="hljs-keyword">return</span> item
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">close_spider</span>(<span class="hljs-params">self, spider</span>):
        <span class="hljs-string">"""爬虫关闭时，关闭MongoDB连接"""</span>
        <span class="hljs-keyword">if</span> self.client:
            self.client.close()
            spider.logger.info(<span class="hljs-string">"MongoDB数据库连接已关闭"</span>)
</code></pre>
<h3 data-id="heading-21">4. 启用MongoDB Pipeline（<code>settings.py</code>）</h3>
<pre><code class="hljs language-python" lang="python">ITEM_PIPELINES = {
   <span class="hljs-string">'data_storage_spider.pipelines.CsvFileStoragePipeline'</span>: <span class="hljs-number">300</span>,
   <span class="hljs-string">'data_storage_spider.pipelines.MysqlStoragePipeline'</span>: <span class="hljs-number">400</span>,
   <span class="hljs-string">'data_storage_spider.pipelines.MongodbStoragePipeline'</span>: <span class="hljs-number">500</span>,
}
</code></pre>
<h3 data-id="heading-22">5. 运行爬虫验证结果</h3>
<pre><code class="hljs language-bash" lang="bash">scrapy crawl test_spider
</code></pre>
<ul>
<li>验证：使用<code>mongo</code>终端连接，执行<code>use scrapy_data; db.quotes.find().pretty();</code>，可看到已成功插入数据，字段完整。</li>
</ul>
<h2 data-id="heading-23">五、核心注意事项与实操技巧</h2>
<ol>
<li><strong>Pipeline优先级</strong>：<code>ITEM_PIPELINES</code>中的数字（1-1000）越小，优先级越高，先执行的Pipeline处理后的Item会传递给后续Pipeline；</li>
<li><strong>数据去重</strong>：
<ul>
<li>MySQL：可给<code>content</code>字段添加唯一索引（<code>ALTER TABLE quotes ADD UNIQUE INDEX uk_content (content(255));</code>），避免重复插入；</li>
<li>MongoDB：使用<code>update_one()</code>，设置<code>upsert=True</code>（存在则更新，不存在则插入），基于唯一字段去重；</li>
</ul>
</li>
<li><strong>异常处理与事务</strong>：
<ul>
<li>数据库操作必须添加<code>try-except</code>，避免单个数据插入失败导致整个爬虫崩溃；</li>
<li>MySQL需手动提交事务（<code>conn.commit()</code>），出错时回滚（<code>conn.rollback()</code>）；MongoDB无需手动提交，默认自动写入；</li>
</ul>
</li>
<li><strong>中文乱码</strong>：
<ul>
<li>本地文件：必须使用<code>encoding="utf_8_sig"</code>（CSV/JSON）；</li>
<li>MySQL：数据库、表、字段均使用<code>utf8mb4</code>字符集；</li>
<li>MongoDB：默认支持UTF-8，无需额外配置；</li>
</ul>
</li>
<li><strong>资源释放</strong>：<code>open_spider()</code>建立连接，<code>close_spider()</code>关闭连接，避免资源泄露（尤其长期运行的分布式爬虫）；</li>
<li><strong>大规模数据优化</strong>：
<ul>
<li>本地文件：避免一次性写入大文件，可按批次拆分；</li>
<li>数据库：使用批量插入（MySQL<code>executemany()</code>、MongoDB<code>insert_many()</code>），减少数据库交互次数，提升效率。</li>
</ul>
</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[HarmonyOS：User-Agent开发指导]]></title>    <link>https://juejin.cn/post/7590681158716407848</link>    <guid>https://juejin.cn/post/7590681158716407848</guid>    <pubDate>2026-01-04T01:35:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590681158716407848" data-draft-id="7590597231707979811" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="HarmonyOS：User-Agent开发指导"/> <meta itemprop="keywords" content="HarmonyOS"/> <meta itemprop="datePublished" content="2026-01-04T01:35:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ChinaDragon"/> <meta itemprop="url" content="https://juejin.cn/user/3966693681410840"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            HarmonyOS：User-Agent开发指导
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3966693681410840/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ChinaDragon
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-04T01:35:05.000Z" title="Sun Jan 04 2026 01:35:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">一、简介</h3>
<blockquote>
<p>User-Agent（简称UA）是一个特殊的字符串，包含设备类型、操作系统及版本等关键信息。在Web开发中，这个字符串使服务器能够识别请求的来源设备及其特性，从而根据这些信息提供定制化的内容和服务。如果页面无法正确识别UA，可能会导致多种异常情况。例如，为移动设备优化的页面布局可能会在桌面设备上显示错乱，反之亦然。此外，某些特定的浏览器功能或CSS样式可能仅在特定的浏览器版本中受支持，如果页面无法根据UA字符串做出正确的判断，就可能导致渲染问题或逻辑错误。</p>
</blockquote>
<h3 data-id="heading-1">二、默认User-Agent结构</h3>
<h4 data-id="heading-2">2.1 默认User-Agent定义</h4>
<pre><code class="hljs language-bash" lang="bash">Mozilla/5.0 ({DeviceType}; {OSName} {OSVersion}) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/{ChromeCompatibleVersion}.0.0.0 Safari/537.36  ArkWeb/{ArkWeb VersionCode} {DeviceCompat} {扩展区}
</code></pre>
<p><strong>举例说明</strong></p>
<pre><code class="hljs language-bash" lang="bash">Mozilla/5.0 (Phone; OpenHarmony 5.0) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/114.0.0.0 Safari/537.36  ArkWeb/4.1.6.1 Mobile
</code></pre>
<p><strong>字段说明</strong></p>





































<table><thead><tr><th align="left">字段</th><th align="left">含义</th></tr></thead><tbody><tr><td align="left">DeviceType</td><td align="left">当前的设备类型。取值范围：<br/>- Phone：手机设备<br/>- Tablet：平板设备<br/>- PC：2in1设备</td></tr><tr><td align="left">OSName</td><td align="left">基础操作系统名称。<br/>默认取值：OpenHarmony</td></tr><tr><td align="left">OSVersion</td><td align="left">基础操作系统版本，两位数字，M.S。<br/>通过系统参数const.ohos.fullname解析版本号得到，取版本号部分M.S前两位。<br/>默认取值：例如5.0</td></tr><tr><td align="left">ChromeCompatibleVersion</td><td align="left">兼容Chrome主版本的版本号，从114版本开始演进。<br/>默认取值：114</td></tr><tr><td align="left">ArkWeb</td><td align="left">HarmonyOS版本Web内核名称。<br/>默认取值：ArkWeb<br/> ArkWeb VersionCode	<br/>ArkWeb版本号，格式a.b.c.d。<br/>默认取值：例如4.1.6.1</td></tr><tr><td align="left">DeviceCompat</td><td align="left">前向兼容字段。<br/> 默认取值：Mobile</td></tr><tr><td align="left">扩展区</td><td align="left">三方应用可以扩展的字段。 <br/> 三方应用使用ArkWeb组件时，可以做UA扩展，例如加入APP相关信息标识。</td></tr></tbody></table>
<blockquote>
<p><strong>说明</strong></p>
<ul>
<li>当前默认User-Agent的ArkWeb字段前有两个空格。</li>
<li>当前通过User-Agent中是否含有"Mobile"字段来判断是否开启前端HTML页面中meta标签的viewport属性。当User-Agent中不含有"Mobile"字段时，meta标签中viewport属性默认关闭，此时可通过显性设置metaViewport属性为true来覆盖关闭状态。</li>
<li>建议通过OpenHarmony关键字识别是否是HarmonyOS设备，同时可以通过DeviceType识别设备类型用于不同设备上的页面显示（ArkWeb关键字表示设备使用的web内核，OpenHarmony关键字表示设备使用的操作系统，因此推荐通过OpenHarmony关键字识别是否是HarmonyOS设备）。</li>
<li>{DistributionOSName}和{DistributionOSVersion}字段在API version 15之前的版本中未启用，从API version 15版本开始不在默认User-Agent中体现。</li>
</ul>
</blockquote>
<h3 data-id="heading-3">三、自定义User-Agent结构</h3>
<blockquote>
<p>在下面的示例中，通过调用getUserAgent()接口获取当前默认的用户代理（User-Agent）字符串。这一接口提供的默认User-Agent信息为开发者提供了基础，使开发者能够基于这个默认信息进行定制或扩展。</p>
</blockquote>
<blockquote>
<p><strong>示例效果图</strong> <br/>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/71420fa5f35244979d079e52ced04b75~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ2hpbmFEcmFnb24=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768095305&amp;x-signature=DUg4OrnR7wjfoS7I7MMGKxE%2Bh9c%3D" alt="在这里插入图片描述" loading="lazy"/></p>
</blockquote>
<p><strong>示例代码</strong></p>
<pre><code class="hljs language-bash" lang="bash">
import { webview } from <span class="hljs-string">'@kit.ArkWeb'</span>;
import { BusinessError } from <span class="hljs-string">'@kit.BasicServicesKit'</span>;

@Entry
@Component
struct TestUserAgent {
  @State message: string = <span class="hljs-string">'getUserAgent'</span>;
  controller: webview.WebviewController = new webview.WebviewController()

  <span class="hljs-function"><span class="hljs-title">build</span></span>() {
    Column({space: 20}) {
      Button(this.message)
        .<span class="hljs-built_in">id</span>(<span class="hljs-string">'TestUserAgentHelloWorld'</span>)
        .fontSize(<span class="hljs-variable">$r</span>(<span class="hljs-string">'app.float.page_text_font_20fp'</span>))
        .fontWeight(FontWeight.Bold)
        .onClick(() =&gt; {
          try {
            let userAgent = this.controller.getUserAgent();
            console.log("获取 userAgent: " + userAgent);
          } catch (error) {
            console.error(`ErrorCode: <span class="hljs-variable">${(error as BusinessError).code}</span>,  Message: <span class="hljs-variable">${(error as BusinessError).message}</span>`);
          }
        })
      Web({ src: 'www.baidu.com', controller: this.controller })
    }
    .height('<span class="hljs-number">100</span>%')
    .width('<span class="hljs-number">100</span>%')
  }
}
</code></pre>
<blockquote>
<p>以下示例通过 <strong>setCustomUserAgent()</strong> 接口设置自定义用户代理，但请注意，此操作会覆盖系统的用户代理。因此，我们建议将扩展字段追加在默认用户代理的末尾，比如三方应用程序的开发场景，可以在系统默认用户代理字符串的末尾追加特定的APP标识，这样既能保留原有用户代理信息，又能增加自定义的应用识别信息。 <br/>
当Web组件src设置了url时，建议在<strong>onControllerAttached</strong>回调事件中设置User-Agent，设置方式请参考示例。不建议将User-Agent设置在onLoadIntercept回调事件中，会概率性出现设置失败。如果未在onControllerAttached回调事件中设置User-Agent。再调用setCustomUserAgent方法时，可能会出现加载的页面与实际设置User-Agent不符的异常现象。 <br/>
当Web组件src设置为空字符串时，建议先调用setCustomUserAgent方法设置User-Agent，再通过loadUrl加载具体页面。</p>
</blockquote>
<blockquote>
<p><strong>示例效果图</strong> <br/>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/23cd7366741a43a7b418c27a3224231f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ2hpbmFEcmFnb24=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768095305&amp;x-signature=RQ9Z0rczoOyRY1BH4Gv8OAJpkTk%3D" alt="在这里插入图片描述" loading="lazy"/></p>
</blockquote>
<p><strong>示例代码</strong></p>
<pre><code class="hljs language-bash" lang="bash">
import { webview } from <span class="hljs-string">'@kit.ArkWeb'</span>;
import { BusinessError } from <span class="hljs-string">'@kit.BasicServicesKit'</span>;

const TAG = <span class="hljs-string">"TestUserAgent"</span>
@Entry
@Component
struct TestUserAgent {
  @State message: string = <span class="hljs-string">'getUserAgent'</span>;
  controller: webview.WebviewController = new webview.WebviewController()
  // 三方应用相关信息标识
  @State customUserAgent: string = <span class="hljs-string">' DemoApp 自定义用户代理'</span>;

  <span class="hljs-function"><span class="hljs-title">build</span></span>() {
    Column({space: 20}) {
      Button(this.message)
        .<span class="hljs-built_in">id</span>(<span class="hljs-string">'TestUserAgentHelloWorld'</span>)
        .fontSize(<span class="hljs-variable">$r</span>(<span class="hljs-string">'app.float.page_text_font_20fp'</span>))
        .fontWeight(FontWeight.Bold)
        .onClick(() =&gt; {
          try {
            let userAgent = this.controller.getUserAgent();
            let customUserAgent = this.controller.getCustomUserAgent()
            console.log("获取 userAgent: " + userAgent);
            console.log("获取 customUserAgent: " + customUserAgent);
          } catch (error) {
            console.error(`ErrorCode: <span class="hljs-variable">${(error as BusinessError).code}</span>,  Message: <span class="hljs-variable">${(error as BusinessError).message}</span>`);
          }
        })
      Web({ src: 'https://www.baidu.com/', controller: this.controller })
        .domStorageAccess(true)
        .onControllerAttached(() =&gt;{
          console.log("执行了 onControllerAttached 回调");
          try {
            let userAgent = this.controller.getUserAgent()+ this.customUserAgent
            this.controller.setCustomUserAgent(userAgent)
          }catch (error){
            console.error(TAG, `ErrorCode: <span class="hljs-variable">${(error as BusinessError).code}</span>,  Message: <span class="hljs-variable">${(error as BusinessError).message}</span>`);
          }
        })
    }
    .height('<span class="hljs-number">100</span>%')
    .width('<span class="hljs-number">100</span>%')
  }
}
</code></pre>
<blockquote>
<p>从<strong>API version 20</strong>开始，可通过 <strong>setAppCustomUserAgent()</strong> 接口设置应用级自定义用户代理，或者通过 <strong>setUserAgentForHosts()</strong> 对特定网站设置应用级自定义用户代理，覆盖系统的用户代理，应用内所有Web组件生效。 <br/>
建议在Web组件创建前先调用静态接口getDefaultUserAgent获取默认的用户代理（User-Agent）字符串，然后调用setAppCustomUserAgent，setUserAgentForHosts方法设置User-Agent，再创建指定src的Web组件或通过loadUrl加载具体页面。</p>
</blockquote>
<pre><code class="hljs language-bash" lang="bash">
import { webview } from <span class="hljs-string">'@kit.ArkWeb'</span>;
import { BusinessError } from <span class="hljs-string">'@kit.BasicServicesKit'</span>;

@Entry
@Component
struct TestUserAgent2 {
  controller: webview.WebviewController = new webview.WebviewController();
  @State userAgent: string = <span class="hljs-string">''</span>;

  aboutToAppear(): void {
    try {
      webview.WebviewController.initializeWebEngine();
      <span class="hljs-built_in">let</span> defaultUserAgent = webview.WebviewController.getDefaultUserAgent();
      <span class="hljs-built_in">let</span> appUA = defaultUserAgent + <span class="hljs-string">" appUA "</span>;
      webview.WebviewController.setAppCustomUserAgent(appUA+<span class="hljs-string">" application"</span>);
      webview.WebviewController.setUserAgentForHosts(
        appUA + <span class="hljs-string">"specific_net"</span>,
        [
          <span class="hljs-string">"developer.huawei.com"</span>,
          <span class="hljs-string">"www.deepseek.com"</span>,
          <span class="hljs-string">"www.baidu.com"</span>
        ]
      );
    } catch (error) {
      console.error(`ErrorCode: <span class="hljs-variable">${(error as BusinessError).code}</span>,  Message: <span class="hljs-variable">${(error as BusinessError).message}</span>`);
    }
  }

  <span class="hljs-function"><span class="hljs-title">build</span></span>() {
    Column({space: 20}) {
      Button(<span class="hljs-string">'getCustomUserAgent'</span>)
        .onClick(() =&gt; {
          try {
            this.userAgent = this.controller.getCustomUserAgent();
            console.log("通过getCustomUserAgent()接口获取自定义用户代理 userAgent: " + this.userAgent);
          } catch (error) {
            console.error(`ErrorCode: <span class="hljs-variable">${(error as BusinessError).code}</span>,  Message: <span class="hljs-variable">${(error as BusinessError).message}</span>`);
          }
        })
      Web({ src: 'https://www.baidu.com', controller: this.controller })
    }
  }
}
</code></pre>
<blockquote>
<p>在下面的示例中，通过getCustomUserAgent()接口获取自定义用户代理。</p>
</blockquote>
<pre><code class="hljs language-bash" lang="bash">
import { webview } from <span class="hljs-string">'@kit.ArkWeb'</span>;
import { BusinessError } from <span class="hljs-string">'@kit.BasicServicesKit'</span>;

@Entry
@Component
struct TestUserAgent2 {
  controller: webview.WebviewController = new webview.WebviewController();
  @State userAgent: string = <span class="hljs-string">''</span>;

  aboutToAppear(): void {
    try {
      webview.WebviewController.initializeWebEngine();
      <span class="hljs-built_in">let</span> defaultUserAgent = webview.WebviewController.getDefaultUserAgent();
      <span class="hljs-built_in">let</span> appUA = defaultUserAgent + <span class="hljs-string">" appUA "</span>;
      webview.WebviewController.setAppCustomUserAgent(appUA+<span class="hljs-string">" application"</span>);
      webview.WebviewController.setUserAgentForHosts(
        appUA + <span class="hljs-string">"spefical_net"</span>,
        [
          <span class="hljs-string">"developer.huawei.com"</span>,
          <span class="hljs-string">"www.deepseek.com"</span>,
          <span class="hljs-string">"www.baidu.com"</span>
        ]
      );
    } catch (error) {
      console.error(`ErrorCode: <span class="hljs-variable">${(error as BusinessError).code}</span>,  Message: <span class="hljs-variable">${(error as BusinessError).message}</span>`);
    }
  }

  <span class="hljs-function"><span class="hljs-title">build</span></span>() {
    Column({space: 20}) {
      Button(<span class="hljs-string">'getCustomUserAgent'</span>)
        .onClick(() =&gt; {
          try {
            this.userAgent = this.controller.getCustomUserAgent();
            console.log("通过getCustomUserAgent()接口获取自定义用户代理 userAgent: " + this.userAgent);
          } catch (error) {
            console.error(`ErrorCode: <span class="hljs-variable">${(error as BusinessError).code}</span>,  Message: <span class="hljs-variable">${(error as BusinessError).message}</span>`);
          }
        })
      Web({ src: 'https://www.baidu.com', controller: this.controller })
    }
  }
}
</code></pre>
<h3 data-id="heading-4">四、相关User-Agent接口优先级</h3>






























<table><thead><tr><th align="left">接口名称</th><th align="left">优先级</th><th align="left">说明</th></tr></thead><tbody><tr><td align="left">setCustomUserAgent</td><td align="left">最高</td><td align="left">对调用的Web组件生效。</td></tr><tr><td align="left">setUserAgentForHosts</td><td align="left">低于setCustomUserAgent</td><td align="left">对应用中所有Web组件访问指定网站生效。</td></tr><tr><td align="left">setAppCustomUserAgent</td><td align="left">低于setUserAgentForHosts</td><td align="left">对应用中所有Web组件生效。</td></tr><tr><td align="left">ArkWeb默认UA</td><td align="left">最低</td><td align="left">对应用中所有Web组件生效，只读，通过getDefaultUserAgent获取。</td></tr></tbody></table>
<h3 data-id="heading-5">五、常见问题</h3>
<h4 data-id="heading-6">5.1 如何通过User-Agent来识别HarmonyOS操作系统中不同设备</h4>
<blockquote>
<p>HarmonyOS设备的识别主要通过User-Agent中的系统、系统版本和设备类型三个维度来判断。建议同时检查系统、系统版本和设备类型，以确保更准确的设备识别。</p>
</blockquote>
<h5 data-id="heading-7">5.1.1 系统识别</h5>
<blockquote>
<p>通过User-Agent中的{OSName}字段识别HarmonyOS系统。</p>
</blockquote>
<pre><code class="hljs language-bash" lang="bash">const isHarmonyOS = () =&gt; /OpenHarmony/i.test(navigator.userAgent);   
</code></pre>
<h5 data-id="heading-8">5.1.2 系统版本识别</h5>
<blockquote>
<p>通过User-Agent中的{OSName}和{OSVersion}字段识别HarmonyOS系统及系统版本。格式为：OpenHarmony + 版本号。</p>
</blockquote>
<pre><code class="hljs language-bash" lang="bash">// 检测是否是HarmonyOS系统
const matches = navigator.userAgent.match(/OpenHarmony (\d+\.?\d*)/);  
matches?.length &amp;&amp; Number(matches[1]) &gt; 0
// 检测是否是HarmonyOS NEXT系统
const matches = navigator.userAgent.match(/OpenHarmony (\d+\.?\d*)/);  
matches?.length &amp;&amp; Number(matches[1]) &gt;= 5;   
</code></pre>
<h5 data-id="heading-9">5.1.3 设备类型识别</h5>
<blockquote>
<p>通过deviceType字段来识别不同设备类型。</p>
</blockquote>
<pre><code class="hljs language-bash" lang="bash">// 检测是否为手机设备
const isPhone = () =&gt; /Phone/i.test(navigator.userAgent);

// 检测是否为平板设备  
const isTablet = () =&gt; /Tablet/i.test(navigator.userAgent);

// 检测是否为2in1设备  
const is2in1 = () =&gt; /PC/i.test(navigator.userAgent);
</code></pre>
<h4 data-id="heading-10">5.2 如何模拟HarmonyOS操作系统的User-Agent进行前端调试</h4>
<blockquote>
<p>在Windows/Mac/Linux等操作系统中，可以通过Chrome/Edge/Firefox等浏览器DevTools提供的User-Agent复写能力，模拟HarmonyOS User-Agent。</p>
</blockquote>
<h4 data-id="heading-11">5.3 如何在HarmonyOS中自定义User-Agent以实现H5兼容性</h4>
<blockquote>
<p>HarmonyOS提供setCustomUserAgent接口以支持User-Agent的自定义设置。为适配移动端H5页面通常依赖的UA标识检测（如Mobile、Android等），并确保不覆盖系统默认UA信息，推荐按如下方式操作：首先通过setCustomUserAgent()接口获取系统默认User-Agent字符串，随后将H5兼容所需的自定义标识字段追加至该字符串末尾，最后调用setCustomUserAgent接口设置修改后的完整UA字符串。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[简析 Kotlin 内联函数：与inline相关的关键字]]></title>    <link>https://juejin.cn/post/7590957076630552622</link>    <guid>https://juejin.cn/post/7590957076630552622</guid>    <pubDate>2026-01-04T01:38:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590957076630552622" data-draft-id="7590929624743395378" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="简析 Kotlin 内联函数：与inline相关的关键字"/> <meta itemprop="keywords" content="Java,Android,Kotlin"/> <meta itemprop="datePublished" content="2026-01-04T01:38:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="愤怒的代码"/> <meta itemprop="url" content="https://juejin.cn/user/4125023358426190"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            简析 Kotlin 内联函数：与inline相关的关键字
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4125023358426190/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    愤怒的代码
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-04T01:38:23.000Z" title="Sun Jan 04 2026 01:38:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>我们知道 <code>inline</code> 函数的作用是可以在调用处替换为函数体实现，可以减少函数调用栈的使用，从而提升效率，本文会一起看看跟 <code>inline</code> 一起配合使用的几个关键字</p>
<h2 data-id="heading-0">0x00 inline + reified</h2>
<p>在Kotlin中经常会看到一些内联函数是配合 reified 关键字使用</p>
<ul>
<li>保留运行时的类型</li>
<li>原理是在调用处将范型替换为实际类型</li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">inline</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T&gt;</span> <span class="hljs-title">checkType</span><span class="hljs-params">(obj: <span class="hljs-type">Any</span>)</span></span> {
    <span class="hljs-keyword">if</span> (obj <span class="hljs-keyword">is</span> T) { <span class="hljs-comment">// ❌ 这里会编译出错！</span>
				println(<span class="hljs-string">"<span class="hljs-subst">${obj}</span> 是 <span class="hljs-subst">${T::class.simpleName}</span> 类型"</span>)
		}
}
</code></pre>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 添加 reified 关键字（必须配合 inline 使用）</span>
<span class="hljs-keyword">inline</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;<span class="hljs-keyword">reified</span> T&gt;</span> <span class="hljs-title">checkType</span><span class="hljs-params">(obj: <span class="hljs-type">Any</span>)</span></span> {
    <span class="hljs-keyword">if</span> (obj <span class="hljs-keyword">is</span> T) { <span class="hljs-comment">// ✅ 现在可以了！</span>
        println(<span class="hljs-string">"<span class="hljs-subst">${obj}</span> 是 <span class="hljs-subst">${T::class.simpleName}</span> 类型"</span>)
    }
}

<span class="hljs-comment">// 使用示例</span>
checkType&lt;String&gt;(<span class="hljs-string">"Hello"</span>)  <span class="hljs-comment">// 输出：Hello 是 String 类型</span>
checkType&lt;<span class="hljs-built_in">Int</span>&gt;(<span class="hljs-string">"Text"</span>)      <span class="hljs-comment">// 无输出，类型不匹配</span>
</code></pre>
<h3 data-id="heading-1"><strong>简化Activity启动（无需传递Class参数）</strong></h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 使用 reified 的优雅方式</span>
<span class="hljs-keyword">inline</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;<span class="hljs-keyword">reified</span> T : Activity&gt;</span> Context.<span class="hljs-title">startActivity</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> intent = Intent(<span class="hljs-keyword">this</span>, T::<span class="hljs-keyword">class</span>.java) <span class="hljs-comment">// 直接访问泛型类型的Class</span>
    startActivity(intent)
}
<span class="hljs-comment">// 调用 - 类型清晰，无需::class.java</span>
startActivity&lt;DetailActivity&gt;()
</code></pre>
<h3 data-id="heading-2"><strong>Retrofit + reified 简化API响应处理</strong></h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 传统方式：需要传递Type</span>
apiService.getUser().enqueue(<span class="hljs-keyword">object</span> : Callback&lt;User&gt; {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onResponse</span><span class="hljs-params">(call: <span class="hljs-type">Call</span>&lt;<span class="hljs-type">User</span>&gt;, response: <span class="hljs-type">Response</span>&lt;<span class="hljs-type">User</span>&gt;)</span></span> {
        <span class="hljs-comment">// 处理响应</span>
    }
})

<span class="hljs-comment">// 使用 reified 的扩展函数</span>
<span class="hljs-keyword">inline</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;<span class="hljs-keyword">reified</span> T&gt;</span> Call<span class="hljs-type">&lt;T&gt;</span>.<span class="hljs-title">enqueueSimplified</span><span class="hljs-params">(
    <span class="hljs-keyword">crossinline</span> onSuccess: (<span class="hljs-type">T</span>) -&gt; <span class="hljs-type">Unit</span>,
    <span class="hljs-keyword">crossinline</span> onError: (<span class="hljs-type">Throwable</span>) -&gt; <span class="hljs-type">Unit</span>
)</span></span> {
    enqueue(<span class="hljs-keyword">object</span> : Callback&lt;T&gt; {
        <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onResponse</span><span class="hljs-params">(call: <span class="hljs-type">Call</span>&lt;<span class="hljs-type">T</span>&gt;, response: <span class="hljs-type">Response</span>&lt;<span class="hljs-type">T</span>&gt;)</span></span> {
            <span class="hljs-keyword">if</span> (response.isSuccessful) {
                onSuccess(response.body()!!)
            }
        }
        <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onFailure</span><span class="hljs-params">(call: <span class="hljs-type">Call</span>&lt;<span class="hljs-type">T</span>&gt;, t: <span class="hljs-type">Throwable</span>)</span></span> {
            onError(t)
        }
    })
}

<span class="hljs-comment">// 调用更加简洁</span>
apiService.getUser().enqueueSimplified(
    onSuccess = { user -&gt; showUser(user) },
    onError = { error -&gt; showError(error) }
)
</code></pre>
<h2 data-id="heading-3">0x01 <strong><code>noinline</code>：阻止内联</strong></h2>
<p><strong>为什么需要它？<strong>当一个 Lambda 参数需要被</strong>存储</strong>、<strong>传递</strong>给其他非内联函数，或在<strong>非内联上下文中调用</strong>时，就必须使用 <code>noinline</code>.</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 示例：需要存储 Lambda</span>
<span class="hljs-keyword">inline</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">doSomething</span><span class="hljs-params">(
    <span class="hljs-keyword">crossinline</span> onStart: () -&gt; <span class="hljs-type">Unit</span>, <span class="hljs-comment">// 这个会被内联</span>
    <span class="hljs-keyword">noinline</span> onComplete: () -&gt; <span class="hljs-type">Unit</span>   <span class="hljs-comment">// 这个不会被内联</span>
)</span></span> {
    <span class="hljs-comment">// 1. onStart 可以直接调用（内联）</span>
    onStart()
    
    <span class="hljs-comment">// 2. onComplete 需要被存储或传递</span>
    <span class="hljs-keyword">val</span> completionCallback = onComplete  <span class="hljs-comment">// ✅ 可以存储，因为它是 noinline</span>
    runLater(completionCallback)         <span class="hljs-comment">// ✅ 可以传递给普通函数</span>
    
    <span class="hljs-comment">// 3. 尝试存储 onStart 会报错</span>
    <span class="hljs-comment">// val startCallback = onStart  // ❌ 错误：不能存储 crossinline lambda</span>
}

<span class="hljs-comment">// 一个普通（非内联）函数</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">runLater</span><span class="hljs-params">(callback: () -&gt; <span class="hljs-type">Unit</span>)</span></span> {
    <span class="hljs-comment">// 稍后执行...</span>
}·
</code></pre>
<p><strong>关键特性</strong>：</p>
<ul>
<li>变为普通函数对象，有内存开销</li>
<li>可以传递给其他非内联函数</li>
<li>可以存储在变量或属性中</li>
<li><strong>不支持非局部返回</strong>（因为它已经不是内联的了）</li>
</ul>
<h2 data-id="heading-4">0x02 <strong><code>crossinline</code>：禁止非局部返回</strong></h2>
<p><strong>作用</strong>：允许 Lambda 被内联，但<strong>禁止在 Lambda 内部使用非局部返回</strong>（即直接 <code>return</code>）。</p>
<p><strong>为什么需要它？</strong></p>
<p>当 Lambda 参数在另一个执行上下文中被调用时（如嵌套函数、另一个 Lambda），直接 <code>return</code> 会变得语义模糊，因此需要禁止</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 示例：Lambda 在嵌套上下文中执行</span>
<span class="hljs-keyword">inline</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">runInBackground</span><span class="hljs-params">(<span class="hljs-keyword">crossinline</span> task: () -&gt; <span class="hljs-type">Unit</span>)</span></span> {
    <span class="hljs-comment">// 将 task 传递给另一个执行上下文</span>
    Thread {
        task()  <span class="hljs-comment">// 这里 task 是在新线程中执行，不是从 runInBackground 返回</span>
    }.start()
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">testFunction</span><span class="hljs-params">()</span></span> {
    runInBackground {
        println(<span class="hljs-string">"在后台执行"</span>)
        <span class="hljs-comment">// return  // ❌ 如果允许，这个 return 是要从 testFunction 返回，还是从 Lambda 返回？</span>
        <span class="hljs-comment">// 编译器禁止这种模糊的语义，必须使用：</span>
        <span class="hljs-keyword">return</span><span class="hljs-symbol">@runInBackground</span>  <span class="hljs-comment">// ✅ 明确表示从 Lambda 返回</span>
    }
    println(<span class="hljs-string">"这行会被执行"</span>)
}
</code></pre>
<p><strong>典型应用场景</strong>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// Android 中的 View.post 就是一个典型例子</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">inline</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> View.<span class="hljs-title">post</span><span class="hljs-params">(<span class="hljs-keyword">crossinline</span> action: () -&gt; <span class="hljs-type">Unit</span>)</span></span> {
    <span class="hljs-keyword">val</span> runnable = Runnable { action() }  <span class="hljs-comment">// action 在 Runnable 中执行</span>
    handler.post(runnable)
}

<span class="hljs-comment">// 使用</span>
view.post {
    updateUI()
    <span class="hljs-comment">// 不能直接 return，必须用 return@post</span>
    <span class="hljs-keyword">if</span> (condition) <span class="hljs-keyword">return</span><span class="hljs-symbol">@post</span>  <span class="hljs-comment">// ✅ 局部返回</span>
}
</code></pre>
<p><strong>场景：结合使用多个修饰符</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">inline</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">processData</span><span class="hljs-params">(
    <span class="hljs-keyword">data</span>: <span class="hljs-type">String</span>,
    <span class="hljs-keyword">noinline</span> validator: (<span class="hljs-type">String</span>) -&gt; <span class="hljs-type">Boolean</span>, <span class="hljs-comment">// 需要传递给普通函数</span>
    <span class="hljs-keyword">crossinline</span> onSuccess: (<span class="hljs-type">String</span>) -&gt; <span class="hljs-type">Unit</span>, <span class="hljs-comment">// 在回调中执行，禁止非局部返回</span>
    onError: (<span class="hljs-type">Exception</span>) -&gt; <span class="hljs-type">Unit</span> <span class="hljs-comment">// 默认内联，允许非局部返回</span>
)</span></span> {
    <span class="hljs-comment">// validator 被传递给普通函数</span>
    <span class="hljs-keyword">if</span> (!validateInput(<span class="hljs-keyword">data</span>, validator)) {
        onError(IllegalArgumentException(<span class="hljs-string">"无效数据"</span>))
        <span class="hljs-keyword">return</span>
    }
    
    <span class="hljs-comment">// onSuccess 在异步回调中执行</span>
    doAsyncWork(<span class="hljs-keyword">data</span>) { result -&gt;
        onSuccess(result)  <span class="hljs-comment">// 这里禁止非局部返回</span>
    }
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">validateInput</span><span class="hljs-params">(input: <span class="hljs-type">String</span>, validator: (<span class="hljs-type">String</span>) -&gt; <span class="hljs-type">Boolean</span>)</span></span>: <span class="hljs-built_in">Boolean</span> {
    <span class="hljs-keyword">return</span> validator(input)  <span class="hljs-comment">// 普通函数接收 noinline lambda</span>
}
</code></pre>
<h2 data-id="heading-5">0x03 <strong>核心总结</strong></h2>
<ol>
<li><strong><code>noinline</code> 是“功能开关”</strong>：关闭内联，换取存储/传递能力</li>
<li><strong><code>crossinline</code> 是“安全限制”</strong>：保持内联，但禁止模糊的返回语义</li>
<li><strong>默认行为是最灵活的</strong>：既内联又允许非局部返回，但限制最多</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[HarmonyOS：管理Cookie及数据存储]]></title>    <link>https://juejin.cn/post/7590433626560905251</link>    <guid>https://juejin.cn/post/7590433626560905251</guid>    <pubDate>2026-01-04T01:39:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590433626560905251" data-draft-id="7590433626560839715" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="HarmonyOS：管理Cookie及数据存储"/> <meta itemprop="keywords" content="HarmonyOS"/> <meta itemprop="datePublished" content="2026-01-04T01:39:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ChinaDragon"/> <meta itemprop="url" content="https://juejin.cn/user/3966693681410840"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            HarmonyOS：管理Cookie及数据存储
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3966693681410840/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ChinaDragon
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-04T01:39:54.000Z" title="Sun Jan 04 2026 01:39:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">一、 概述</h3>
<blockquote>
<p>Cookie是服务端发送客户端的数据。客户端持有Cookie，便于服务端快速识别身份和状态。 <br/>
当Cookie的SameSite属性未指定时，默认值为SameSite=Lax。这种设置下，Cookie仅在用户导航到其源站点时发送，不会在跨站请求中发送。</p>
</blockquote>
<h3 data-id="heading-1">二、Cookie管理</h3>
<blockquote>
<p>Web组件提供WebCookieManager类来管理Cookie信息。Cookie信息存储在应用沙箱路径下/proc/{pid}/root/data/storage/el2/base/cache/web/Cookies的文件中。 <br/>
下面以configCookieSync()接口为例，为“<a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.baidu.com%25E2%2580%259D%25E8%25AE%25BE%25E7%25BD%25AE%25E5%258D%2595%25E4%25B8%25AACookie%25E7%259A%2584%25E5%2580%25BC%25E2%2580%259Cvalue%3Dtest%25E2%2580%259D%25E3%2580%2582%25E5%2585%25B6%25E4%25BB%2596Cookie%25E7%259A%2584%25E7%259B%25B8%25E5%2585%25B3%25E5%258A%259F%25E8%2583%25BD%25E5%258F%258A%25E4%25BD%25BF%25E7%2594%25A8%25EF%25BC%258C%25E8%25AF%25B7%25E5%258F%2582%25E8%2580%2583WebCookieManager()%25E6%258E%25A5%25E5%258F%25A3%25E6%2596%2587%25E6%25A1%25A3%25E3%2580%2582" target="_blank" title="http://www.baidu.com%E2%80%9D%E8%AE%BE%E7%BD%AE%E5%8D%95%E4%B8%AACookie%E7%9A%84%E5%80%BC%E2%80%9Cvalue=test%E2%80%9D%E3%80%82%E5%85%B6%E4%BB%96Cookie%E7%9A%84%E7%9B%B8%E5%85%B3%E5%8A%9F%E8%83%BD%E5%8F%8A%E4%BD%BF%E7%94%A8%EF%BC%8C%E8%AF%B7%E5%8F%82%E8%80%83WebCookieManager()%E6%8E%A5%E5%8F%A3%E6%96%87%E6%A1%A3%E3%80%82" ref="nofollow noopener noreferrer">www.baidu.com”设置单个Cookie的值“value=test”。其他Cookie的相关功能及使用，请参考WebCookieManager()接口文档。</a></p>
</blockquote>
<p><strong>示例代码</strong></p>
<pre><code class="hljs language-bash" lang="bash">
 import { webview } from <span class="hljs-string">'@kit.ArkWeb'</span>;
 import { BusinessError } from <span class="hljs-string">'@kit.BasicServicesKit'</span>;

 @Entry
 @Component
 struct TestCookie {
   controller: webview.WebviewController = new webview.WebviewController();

   <span class="hljs-function"><span class="hljs-title">build</span></span>() {
     <span class="hljs-function"><span class="hljs-title">Column</span></span>() {
       Button(<span class="hljs-string">'configCookieSync'</span>)
         .onClick(() =&gt; {
           try {
             webview.WebCookieManager.configCookieSync('https://www.baidu.com', 'value=test123sa');
           } catch (error) {
             console.error(`ErrorCode: <span class="hljs-variable">${(error as BusinessError).code}</span>,  Message: <span class="hljs-variable">${(error as BusinessError).message}</span>`);
           }
         })
       Web({ src: 'https://www.baidu.com', controller: this.controller })
     }
   }
 }
</code></pre>
<blockquote>
<p><strong>说明</strong>
Cookie每30s周期性保存到磁盘中，也可以使用接口saveCookieAsync进行强制落盘（PC/2in1和Tablet设备不会持久化session cookie，即使调用saveCookieAsync，也不会将session cookie写入磁盘）。</p>
</blockquote>
<h3 data-id="heading-2">三、缓存与存储管理</h3>
<blockquote>
<p>在访问网站时，网络资源请求通常需要较长的时间。开发者可以通过Cache和Dom Storage等手段将资源保存到本地，以提高访问同一网站的速度。</p>
</blockquote>
<h4 data-id="heading-3">3.1 Cache</h4>
<blockquote>
<p>使用 <strong>cacheMode()</strong> 配置页面资源的缓存模式，Web组件为开发者提供四种缓存模式，分别为：</p>
<ul>
<li>Default：优先使用未过期的缓存。如果缓存不存在，则从网络获取。</li>
<li>None：加载资源使用缓存。如果缓存中无该资源，则从网络中获取。</li>
<li>Online：加载资源不使用缓存。全部从网络中获取。</li>
<li>Only：只从缓存中加载资源。</li>
</ul>
</blockquote>
<p><strong>在下面的示例中，缓存设置为None模式。</strong></p>
<pre><code class="hljs language-bash" lang="bash">
 import { webview } from <span class="hljs-string">'@kit.ArkWeb'</span>;
 import { BusinessError } from <span class="hljs-string">'@kit.BasicServicesKit'</span>;

 @Entry
 @Component
 struct TestCookie {
   controller: webview.WebviewController = new webview.WebviewController();
   @State mode: CacheMode = CacheMode.None;
   <span class="hljs-function"><span class="hljs-title">build</span></span>() {
     <span class="hljs-function"><span class="hljs-title">Column</span></span>() {
       Button(<span class="hljs-string">'configCookieSync'</span>)
         .onClick(() =&gt; {
           try {
             webview.WebCookieManager.configCookieSync('https://www.baidu.com', 'value=test123sa');
           } catch (error) {
             console.error(`ErrorCode: <span class="hljs-variable">${(error as BusinessError).code}</span>,  Message: <span class="hljs-variable">${(error as BusinessError).message}</span>`);
           }
         })
       Web({ src: 'https://www.baidu.com', controller: this.controller })
         .cacheMode(this.mode)
     }
   }
 }

</code></pre>
<p><strong>为了获取最新资源，开发者可以通过removeCache()接口清除已经缓存的资源，示例代码如下：</strong></p>
<pre><code class="hljs language-bash" lang="bash">import { webview } from <span class="hljs-string">'@kit.ArkWeb'</span>;
import { BusinessError } from <span class="hljs-string">'@kit.BasicServicesKit'</span>;

@Entry
@Component
struct TestCookie {
  controller: webview.WebviewController = new webview.WebviewController();
  @State mode: CacheMode = CacheMode.None;

  <span class="hljs-function"><span class="hljs-title">build</span></span>() {
    Column({ space: 20 }) {
      Button(<span class="hljs-string">'configCookieSync'</span>)
        .onClick(() =&gt; {
          try {
            webview.WebCookieManager.configCookieSync('https://www.baidu.com', 'value=test123sa');
          } catch (error) {
            console.error(`ErrorCode: <span class="hljs-variable">${(error as BusinessError).code}</span>,  Message: <span class="hljs-variable">${(error as BusinessError).message}</span>`);
          }
        })
      Button('removeCache')
        .onClick(() =&gt; {
          try {
            // 设置为true时同时清除rom和ram中的缓存，设置为false时只清除ram中的缓存
            this.controller.removeCache(true);
          } catch (error) {
            console.error(`ErrorCode: <span class="hljs-variable">${(error as BusinessError).code}</span>,  Message: <span class="hljs-variable">${(error as BusinessError).message}</span>`);
          }
        })

      Web({ src: 'https://www.baidu.com', controller: this.controller })
        .cacheMode(this.mode)
    }
  }
}

</code></pre>
<h4 data-id="heading-4">3.2 Dom Storage</h4>
<blockquote>
<p>Dom Storage包含了Session Storage和Local Storage两类。Session Storage为临时数据，其存储与释放跟随会话生命周期；Local Storage为持久化数据，保存在应用目录下。两者的数据均通过Key-Value的形式存储，在访问需要客户端存储的页面时使用。开发者可以通过Web组件的属性接口domStorageAccess()进行使能配置，示例如下：</p>
</blockquote>
<pre><code class="hljs language-bash" lang="bash">import { webview } from <span class="hljs-string">'@kit.ArkWeb'</span>;
import { BusinessError } from <span class="hljs-string">'@kit.BasicServicesKit'</span>;

@Entry
@Component
struct TestCookie {
  controller: webview.WebviewController = new webview.WebviewController();
  @State mode: CacheMode = CacheMode.None;

  <span class="hljs-function"><span class="hljs-title">build</span></span>() {
    Column({ space: 20 }) {
      Button(<span class="hljs-string">'configCookieSync'</span>)
        .onClick(() =&gt; {
          try {
            webview.WebCookieManager.configCookieSync('https://www.baidu.com', 'value=test123sa');
          } catch (error) {
            console.error(`ErrorCode: <span class="hljs-variable">${(error as BusinessError).code}</span>,  Message: <span class="hljs-variable">${(error as BusinessError).message}</span>`);
          }
        })
      Button('removeCache')
        .onClick(() =&gt; {
          try {
            // 设置为true时同时清除rom和ram中的缓存，设置为false时只清除ram中的缓存
            this.controller.removeCache(true);
          } catch (error) {
            console.error(`ErrorCode: <span class="hljs-variable">${(error as BusinessError).code}</span>,  Message: <span class="hljs-variable">${(error as BusinessError).message}</span>`);
          }
        })

      Web({ src: 'https://www.baidu.com', controller: this.controller })
        .cacheMode(this.mode)
        .domStorageAccess(true)
    }
  }
}

</code></pre>
<h3 data-id="heading-5">四、获取指定url对应cookie的值</h3>
<blockquote>
<p>fetchCookieSync
获取指定url对应cookie的值。</p>
</blockquote>
<pre><code class="hljs language-bash" lang="bash">static fetchCookieSync(url: string, incognito?: boolean): string
</code></pre>
<blockquote>
<p><strong>说明</strong>
系统会自动清理过期的cookie，对于同名key的数据，新数据将会覆盖前一个数据。 <br/>
为了获取可正常使用的cookie值，fetchCookieSync需传入完整链接。 <br/>
fetchCookieSync用于获取所有的cookie值，每条cookie值之间会通过"; "进行分隔，但无法单独获取某一条特定的cookie值。</p>
</blockquote>
<blockquote>
<p><strong>系统能力</strong>： SystemCapability.Web.Webview.Core</p>
</blockquote>
<p><strong>参数</strong></p>























<table><thead><tr><th align="left">参数名</th><th align="left">类型</th><th align="left">必填</th><th align="left">说明</th></tr></thead><tbody><tr><td align="left">url</td><td align="left">string</td><td align="left">是</td><td align="left">要获取的cookie所属的url，建议使用完整的url。</td></tr><tr><td align="left">incognito</td><td align="left">boolean</td><td align="left">否</td><td align="left">true表示获取隐私模式下webview的内存cookies，false表示正常非隐私模式下的cookies。<br/>默认值：false。</td></tr></tbody></table>
<p><strong>返回值：</strong></p>













<table><thead><tr><th align="left">类型</th><th align="left">说明</th></tr></thead><tbody><tr><td align="left">string</td><td align="left">指定url对应的cookie的值。</td></tr></tbody></table>
<blockquote>
<p><strong>示例效果图</strong> <br/>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/17e1560d4ff840c78c1a1a30dcc464c7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ2hpbmFEcmFnb24=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768095606&amp;x-signature=dqHU%2FITycjvt81CyQvj8lqyCxdU%3D" alt="在这里插入图片描述" loading="lazy"/>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b7df999876564b2f9407cc8112fec54a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ2hpbmFEcmFnb24=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768095606&amp;x-signature=fPQ4yCIuoA86SQFP%2BXwquMzG5AI%3D" alt="在这里插入图片描述" loading="lazy"/></p>
</blockquote>
<p><strong>示例代码</strong></p>
<pre><code class="hljs language-bash" lang="bash">import { webview } from <span class="hljs-string">'@kit.ArkWeb'</span>;
import { BusinessError } from <span class="hljs-string">'@kit.BasicServicesKit'</span>;

@Entry
@Component
struct TestCookie {
  controller: webview.WebviewController = new webview.WebviewController();
  @State mode: CacheMode = CacheMode.None;

  <span class="hljs-function"><span class="hljs-title">build</span></span>() {
    Column({ space: 20 }) {
      Button(<span class="hljs-string">'configCookieSync'</span>)
        .onClick(() =&gt; {
          try {
            webview.WebCookieManager.configCookieSync('https://www.baidu.com', 'value=test123sa');
          } catch (error) {
            console.error(`ErrorCode: <span class="hljs-variable">${(error as BusinessError).code}</span>,  Message: <span class="hljs-variable">${(error as BusinessError).message}</span>`);
          }
        })

      Button('fetchCookieSync')
        .onClick(() =&gt; {
          try {
            let value = webview.WebCookieManager.fetchCookieSync('https://www.baidu.com');
            console.info("获取指定url对应cookie的值 fetchCookieSync cookie = " + value);
          } catch (error) {
            console.error(`ErrorCode: <span class="hljs-variable">${(error as BusinessError).code}</span>,  Message: <span class="hljs-variable">${(error as BusinessError).message}</span>`);
          }
        })

      Button('removeCache')
        .onClick(() =&gt; {
          try {
            // 设置为true时同时清除rom和ram中的缓存，设置为false时只清除ram中的缓存
            this.controller.removeCache(true);
          } catch (error) {
            console.error(`ErrorCode: <span class="hljs-variable">${(error as BusinessError).code}</span>,  Message: <span class="hljs-variable">${(error as BusinessError).message}</span>`);
          }
        })

      Web({ src: 'https://www.baidu.com', controller: this.controller })
        .cacheMode(this.mode)
        .domStorageAccess(true)
    }
  }
}

</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[C# 串口通信不再踩坑：一次发送、分包接收的零丢失实战秘籍]]></title>    <link>https://juejin.cn/post/7590403249560928271</link>    <guid>https://juejin.cn/post/7590403249560928271</guid>    <pubDate>2026-01-03T12:21:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590403249560928271" data-draft-id="7587261929383968820" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="C# 串口通信不再踩坑：一次发送、分包接收的零丢失实战秘籍"/> <meta itemprop="keywords" content="后端,C#,.NET"/> <meta itemprop="datePublished" content="2026-01-03T12:21:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小码编匠"/> <meta itemprop="url" content="https://juejin.cn/user/1308876155395739"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            C# 串口通信不再踩坑：一次发送、分包接收的零丢失实战秘籍
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1308876155395739/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小码编匠
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-03T12:21:39.000Z" title="Sat Jan 03 2026 12:21:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>工业控制、物联网设备通信中，是否遇到过这样的场景：向设备发送一个简单的查询指令，却发现返回的数据总是"分批到达"？明明应该收到完整的20字节响应，却只能收到几个零散的数据包？</p>
<p><strong>别急，这不是你的代码有问题！</strong></p>
<p>这是串口通信中最常见的"分包接收"现象。设备可能一次发送10字节，下一次发送剩余的10字节，而我们的程序却不知道什么时候才算接收完成。</p>
<p>今天我们就来彻底解决这个让无数 C# 开发头疼的问题！</p>
<h3 data-id="heading-1">为什么会分包接收？</h3>
<h4 data-id="heading-2">根本原因</h4>
<p>串口通信是<strong>异步</strong>的，数据传输会受到以下因素影响：</p>
<p><strong>硬件缓冲区大小限制</strong></p>
<p><strong>设备处理速度差异</strong></p>
<p><strong>网络延迟</strong>（对于串口转以太网设备）</p>
<p><strong>系统调度</strong></p>
<p>这些因素导致原本连续的数据流被操作系统或中间设备拆分成多个小块，逐次送达应用程序。</p>
<h4 data-id="heading-3">传统方案的痛点</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// ❌ 错误示例：只能收到第一包数据</span>
serialPort.Write(command, <span class="hljs-number">0</span>, command.Length);
Thread.Sleep(<span class="hljs-number">100</span>); <span class="hljs-comment">// 固定等待时间</span>
<span class="hljs-built_in">byte</span>[] buffer = <span class="hljs-keyword">new</span> <span class="hljs-built_in">byte</span>[<span class="hljs-number">1024</span>];
<span class="hljs-built_in">int</span> count = serialPort.Read(buffer, <span class="hljs-number">0</span>, <span class="hljs-number">1024</span>); <span class="hljs-comment">// 可能只读到部分数据</span>
</code></pre>
<p>这种写法的问题包括：</p>
<p>固定等待时间不可靠</p>
<p>无法判断数据是否接收完整</p>
<p>容易丢失后续数据包</p>
<h3 data-id="heading-4">四种灵活接收策略</h3>
<p>为应对不同应用场景，我们设计了以下四种策略：</p>
<h4 data-id="heading-5">方案一：数据间隔超时判断（⭐推荐）</h4>
<p><strong>适用场景</strong>：不知道数据长度，但设备发送完毕后会有明显时间间隔。</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">byte</span>[] <span class="hljs-title">SendQueryWithGapTimeout</span>(<span class="hljs-params"><span class="hljs-built_in">byte</span>[] command, <span class="hljs-built_in">int</span> gapTimeoutMs = <span class="hljs-number">100</span>, <span class="hljs-built_in">int</span> maxWaitMs = <span class="hljs-number">3000</span></span>)</span>
{
    <span class="hljs-comment">// 清空缓冲区并开始接收</span>
    <span class="hljs-keyword">lock</span> (bufferLock)
    {
        receivedBuffer.Clear();
        isWaitingForResponse = <span class="hljs-literal">true</span>;
        lastReceiveTime = DateTime.Now;
    }
    <span class="hljs-comment">// 发送指令</span>
    serialPort.Write(command, <span class="hljs-number">0</span>, command.Length);
    
    DateTime startTime = DateTime.Now;
    
    <span class="hljs-keyword">while</span> ((DateTime.Now - startTime).TotalMilliseconds &lt; maxWaitMs)
    {
        Thread.Sleep(<span class="hljs-number">10</span>);
        
        <span class="hljs-keyword">lock</span> (bufferLock)
        {
            <span class="hljs-comment">// 🔥 关键逻辑：有数据且间隔超时则认为接收完成</span>
            <span class="hljs-keyword">if</span> (receivedBuffer.Count &gt; <span class="hljs-number">0</span> &amp;&amp; 
                (DateTime.Now - lastReceiveTime).TotalMilliseconds &gt; gapTimeoutMs)
            {
                isWaitingForResponse = <span class="hljs-literal">false</span>;
                <span class="hljs-keyword">return</span> receivedBuffer.ToArray();
            }
        }
    }
    
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
}
</code></pre>
<blockquote>
<p>实际业务中，这个能解决大部分问题。</p>
</blockquote>
<h4 data-id="heading-6">方案二：结束符判断</h4>
<p><strong>适用场景</strong>：数据以特定字符结尾（如 <code>\r\n</code>、<code>\0</code> 等）。</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">byte</span>[] <span class="hljs-title">SendQueryWithEndMarker</span>(<span class="hljs-params"><span class="hljs-built_in">byte</span>[] command, <span class="hljs-built_in">byte</span>[] endMarker, <span class="hljs-built_in">int</span> maxWaitMs = <span class="hljs-number">3000</span></span>)</span>
{
    <span class="hljs-comment">// ... 发送逻辑相同 ...</span>
    
    <span class="hljs-keyword">while</span> ((DateTime.Now - startTime).TotalMilliseconds &lt; maxWaitMs)
    {
        <span class="hljs-keyword">lock</span> (bufferLock)
        {
            <span class="hljs-keyword">if</span> (receivedBuffer.Count &gt;= endMarker.Length)
            {
                <span class="hljs-comment">// 🔥 检查缓冲区末尾是否包含结束标记</span>
                <span class="hljs-built_in">bool</span> foundEndMarker = <span class="hljs-literal">true</span>;
                <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; endMarker.Length; i++)
                {
                    <span class="hljs-keyword">if</span> (receivedBuffer[receivedBuffer.Count - endMarker.Length + i] != endMarker[i])
                    {
                        foundEndMarker = <span class="hljs-literal">false</span>;
                        <span class="hljs-keyword">break</span>;
                    }
                }
                
                <span class="hljs-keyword">if</span> (foundEndMarker)
                {
                    <span class="hljs-keyword">return</span> receivedBuffer.ToArray();
                }
            }
        }
    }
}
</code></pre>
<h4 data-id="heading-7">方案三：协议帧结构判断</h4>
<p><strong>适用场景</strong>：数据有固定帧头和长度字段（如 Modbus 协议）。</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">byte</span>[] <span class="hljs-title">SendQueryWithFrameProtocol</span>(<span class="hljs-params"><span class="hljs-built_in">byte</span>[] command, <span class="hljs-built_in">byte</span> frameHeader, <span class="hljs-built_in">int</span> lengthFieldOffset, <span class="hljs-built_in">int</span> lengthFieldSize = <span class="hljs-number">1</span></span>)</span>
{
    <span class="hljs-comment">// ... 发送逻辑 ...</span>
    
    <span class="hljs-keyword">while</span> (<span class="hljs-comment">/* 超时检查 */</span>)
    {
        <span class="hljs-keyword">lock</span> (bufferLock)
        {
            <span class="hljs-keyword">if</span> (receivedBuffer.Count &gt; lengthFieldOffset + lengthFieldSize)
            {
                <span class="hljs-comment">// 检查帧头</span>
                <span class="hljs-keyword">if</span> (receivedBuffer[<span class="hljs-number">0</span>] == frameHeader)
                {
                    <span class="hljs-comment">// 🔥 从长度字段获取数据长度</span>
                    <span class="hljs-built_in">int</span> dataLength = lengthFieldSize == <span class="hljs-number">1</span> ? 
                        receivedBuffer[lengthFieldOffset] : 
                        (receivedBuffer[lengthFieldOffset] &lt;&lt; <span class="hljs-number">8</span>) | receivedBuffer[lengthFieldOffset + <span class="hljs-number">1</span>];
                    
                    <span class="hljs-built_in">int</span> expectedFrameLength = lengthFieldOffset + lengthFieldSize + dataLength;
                    
                    <span class="hljs-keyword">if</span> (receivedBuffer.Count &gt;= expectedFrameLength)
                    {
                        <span class="hljs-keyword">return</span> receivedBuffer.Take(expectedFrameLength).ToArray();
                    }
                }
            }
        }
    }
}
</code></pre>
<h4 data-id="heading-8">方案四：组合策略（⭐⭐推荐）</h4>
<p><strong>最灵活的方案</strong>，同时使用多种判断条件：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">byte</span>[] <span class="hljs-title">SendQueryWithCombinedStrategy</span>(<span class="hljs-params"><span class="hljs-built_in">byte</span>[] command,
    <span class="hljs-built_in">int</span> gapTimeoutMs = <span class="hljs-number">100</span>,     // 数据间隔超时
    <span class="hljs-built_in">byte</span>[] endMarker = <span class="hljs-literal">null</span>,    // 结束标记  
    <span class="hljs-built_in">int</span>? maxLength = <span class="hljs-literal">null</span>,      // 最大长度限制
    <span class="hljs-built_in">int</span> maxWaitMs = <span class="hljs-number">3000</span></span>)       <span class="hljs-comment">// 总超时时间</span></span>
{
    <span class="hljs-comment">// ... 发送逻辑 ...</span>
    
    <span class="hljs-keyword">while</span> (<span class="hljs-comment">/* 总超时检查 */</span>)
    {
        <span class="hljs-keyword">lock</span> (bufferLock)
        {
            <span class="hljs-keyword">if</span> (receivedBuffer.Count == <span class="hljs-number">0</span>) <span class="hljs-keyword">continue</span>;
            
            <span class="hljs-comment">// 🔥 条件1：达到最大长度限制</span>
            <span class="hljs-keyword">if</span> (maxLength.HasValue &amp;&amp; receivedBuffer.Count &gt;= maxLength.Value)
                <span class="hljs-keyword">return</span> receivedBuffer.ToArray();
            
            <span class="hljs-comment">// 🔥 条件2：发现结束标记</span>
            <span class="hljs-keyword">if</span> (endMarker != <span class="hljs-literal">null</span> &amp;&amp; <span class="hljs-comment">/* 检查结束标记逻辑 */</span>)
                <span class="hljs-keyword">return</span> receivedBuffer.ToArray();
            
            <span class="hljs-comment">// 🔥 条件3：数据间隔超时</span>
            <span class="hljs-keyword">if</span> ((DateTime.Now - lastReceiveTime).TotalMilliseconds &gt; gapTimeoutMs)
                <span class="hljs-keyword">return</span> receivedBuffer.ToArray();
        }
    }
}
</code></pre>
<h3 data-id="heading-9">核心机制：数据接收事件</h3>
<p>所有策略都依赖于统一的数据接收事件处理：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnDataReceived</span>(<span class="hljs-params"><span class="hljs-built_in">object</span> sender, SerialDataReceivedEventArgs e</span>)</span>
{
    <span class="hljs-keyword">if</span> (!isWaitingForResponse) <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">try</span>
    {
        <span class="hljs-built_in">int</span> bytesToRead = serialPort.BytesToRead;
        <span class="hljs-keyword">if</span> (bytesToRead &gt; <span class="hljs-number">0</span>)
        {
            <span class="hljs-built_in">byte</span>[] buffer = <span class="hljs-keyword">new</span> <span class="hljs-built_in">byte</span>[bytesToRead];
            <span class="hljs-built_in">int</span> bytesRead = serialPort.Read(buffer, <span class="hljs-number">0</span>, bytesToRead);
            <span class="hljs-keyword">lock</span> (bufferLock)
            {
                receivedBuffer.AddRange(buffer);
                lastReceiveTime = DateTime.Now; <span class="hljs-comment">// 🔥 更新最后接收时间</span>
                Console.WriteLine(<span class="hljs-string">$"收到数据包 (<span class="hljs-subst">{bytesRead}</span> 字节): <span class="hljs-subst">{BitConverter.ToString(buffer, <span class="hljs-number">0</span>, bytesRead)}</span>"</span>);
            }
        }
    }
    <span class="hljs-keyword">catch</span> (Exception ex)
    {
        Console.WriteLine(<span class="hljs-string">$"数据接收异常: <span class="hljs-subst">{ex.Message}</span>"</span>);
    }
}
</code></pre>
<h3 data-id="heading-10">完整代码</h3>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">using</span> System;
<span class="hljs-keyword">using</span> System.Collections.Generic;
<span class="hljs-keyword">using</span> System.IO.Ports;
<span class="hljs-keyword">using</span> System.Linq;
<span class="hljs-keyword">using</span> System.Text;
<span class="hljs-keyword">using</span> System.Threading.Tasks;

<span class="hljs-keyword">namespace</span> <span class="hljs-title">AppFlexSerialPort</span>
{
    <span class="hljs-keyword">internal</span> <span class="hljs-keyword">class</span> <span class="hljs-title">FlexibleSerialPort</span>
    {
        <span class="hljs-keyword">private</span> SerialPort serialPort;
        <span class="hljs-keyword">private</span> List&lt;<span class="hljs-built_in">byte</span>&gt; receivedBuffer;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">object</span> bufferLock = <span class="hljs-keyword">new</span> <span class="hljs-built_in">object</span>();
        <span class="hljs-keyword">private</span> Timer timeoutTimer;
        <span class="hljs-keyword">private</span> <span class="hljs-built_in">bool</span> isWaitingForResponse = <span class="hljs-literal">false</span>;
        <span class="hljs-keyword">private</span> DateTime lastReceiveTime;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> dataGapTimeout = <span class="hljs-number">100</span>; <span class="hljs-comment">// 数据间隔超时时间(ms)</span>

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">FlexibleSerialPort</span>()</span>
        {
            receivedBuffer = <span class="hljs-keyword">new</span> List&lt;<span class="hljs-built_in">byte</span>&gt;();
        }

        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-doctag">///</span> 初始化串口</span>
        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">bool</span> <span class="hljs-title">InitializePort</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> portName = <span class="hljs-string">"COM1"</span>, <span class="hljs-built_in">int</span> baudRate = <span class="hljs-number">9600</span>,
            Parity parity = Parity.None, <span class="hljs-built_in">int</span> dataBits = <span class="hljs-number">8</span>, StopBits stopBits = StopBits.One</span>)</span>
        {
            <span class="hljs-keyword">try</span>
            {
                serialPort = <span class="hljs-keyword">new</span> SerialPort(portName, baudRate, parity, dataBits, stopBits);
                serialPort.ReadTimeout = <span class="hljs-number">1000</span>;
                serialPort.WriteTimeout = <span class="hljs-number">1000</span>;
                serialPort.DataReceived += OnDataReceived;
                serialPort.Open();
                Console.WriteLine(<span class="hljs-string">$"串口 <span class="hljs-subst">{portName}</span> 已成功打开"</span>);
                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
            }
            <span class="hljs-keyword">catch</span> (Exception ex)
            {
                Console.WriteLine(<span class="hljs-string">$"串口初始化失败: <span class="hljs-subst">{ex.Message}</span>"</span>);
                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
            }
        }

        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-doctag">///</span> 方案1: 基于数据间隔超时判断接收完成</span>
        <span class="hljs-comment"><span class="hljs-doctag">///</span> 适用于：不知道数据长度，但设备发送完后会有明显的时间间隔</span>
        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">byte</span>[] <span class="hljs-title">SendQueryWithGapTimeout</span>(<span class="hljs-params"><span class="hljs-built_in">byte</span>[] command, <span class="hljs-built_in">int</span> gapTimeoutMs = <span class="hljs-number">100</span>, <span class="hljs-built_in">int</span> maxWaitMs = <span class="hljs-number">3000</span></span>)</span>
        {
            <span class="hljs-keyword">if</span> (serialPort == <span class="hljs-literal">null</span> || !serialPort.IsOpen)
            {
                Console.WriteLine(<span class="hljs-string">"串口未打开"</span>);
                <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
            }
            <span class="hljs-keyword">lock</span> (bufferLock)
            {
                receivedBuffer.Clear();
                isWaitingForResponse = <span class="hljs-literal">true</span>;
                lastReceiveTime = DateTime.Now;
            }
            <span class="hljs-keyword">try</span>
            {
                <span class="hljs-comment">// 发送查询指令</span>
                serialPort.Write(command, <span class="hljs-number">0</span>, command.Length);
                Console.WriteLine(<span class="hljs-string">$"已发送查询指令: <span class="hljs-subst">{BitConverter.ToString(command)}</span>"</span>);
                DateTime startTime = DateTime.Now;
                DateTime lastCheckTime = DateTime.Now;
                <span class="hljs-built_in">int</span> lastBufferSize = <span class="hljs-number">0</span>;
                <span class="hljs-keyword">while</span> ((DateTime.Now - startTime).TotalMilliseconds &lt; maxWaitMs)
                {
                    Thread.Sleep(<span class="hljs-number">10</span>);
                    <span class="hljs-keyword">lock</span> (bufferLock)
                    {
                        <span class="hljs-comment">// 如果有数据且数据间隔超过指定时间，认为接收完成</span>
                        <span class="hljs-keyword">if</span> (receivedBuffer.Count &gt; <span class="hljs-number">0</span> &amp;&amp;
                            (DateTime.Now - lastReceiveTime).TotalMilliseconds &gt; gapTimeoutMs)
                        {
                            isWaitingForResponse = <span class="hljs-literal">false</span>;
                            <span class="hljs-built_in">byte</span>[] result = receivedBuffer.ToArray();
                            Console.WriteLine(<span class="hljs-string">$"基于间隔超时判断接收完成，共收到 <span class="hljs-subst">{result.Length}</span> 字节"</span>);
                            <span class="hljs-keyword">return</span> result;
                        }
                    }
                }
                <span class="hljs-comment">// 最大等待时间超时</span>
                isWaitingForResponse = <span class="hljs-literal">false</span>;
                <span class="hljs-keyword">lock</span> (bufferLock)
                {
                    <span class="hljs-keyword">if</span> (receivedBuffer.Count &gt; <span class="hljs-number">0</span>)
                    {
                        <span class="hljs-built_in">byte</span>[] result = receivedBuffer.ToArray();
                        Console.WriteLine(<span class="hljs-string">$"最大等待时间超时，收到 <span class="hljs-subst">{result.Length}</span> 字节"</span>);
                        <span class="hljs-keyword">return</span> result;
                    }
                }
                Console.WriteLine(<span class="hljs-string">"接收超时，未收到任何数据"</span>);
                <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
            }
            <span class="hljs-keyword">catch</span> (Exception ex)
            {
                Console.WriteLine(<span class="hljs-string">$"发送指令失败: <span class="hljs-subst">{ex.Message}</span>"</span>);
                isWaitingForResponse = <span class="hljs-literal">false</span>;
                <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
            }
        }

        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-doctag">///</span> 方案2: 基于结束符判断接收完成</span>
        <span class="hljs-comment"><span class="hljs-doctag">///</span> 适用于：数据以特定字符或字节序列结尾</span>
        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">byte</span>[] <span class="hljs-title">SendQueryWithEndMarker</span>(<span class="hljs-params"><span class="hljs-built_in">byte</span>[] command, <span class="hljs-built_in">byte</span>[] endMarker, <span class="hljs-built_in">int</span> maxWaitMs = <span class="hljs-number">3000</span></span>)</span>
        {
            <span class="hljs-keyword">if</span> (serialPort == <span class="hljs-literal">null</span> || !serialPort.IsOpen)
            {
                Console.WriteLine(<span class="hljs-string">"串口未打开"</span>);
                <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
            }
            <span class="hljs-keyword">lock</span> (bufferLock)
            {
                receivedBuffer.Clear();
                isWaitingForResponse = <span class="hljs-literal">true</span>;
            }
            <span class="hljs-keyword">try</span>
            {
                serialPort.Write(command, <span class="hljs-number">0</span>, command.Length);
                Console.WriteLine(<span class="hljs-string">$"已发送查询指令: <span class="hljs-subst">{BitConverter.ToString(command)}</span>"</span>);
                DateTime startTime = DateTime.Now;
                <span class="hljs-keyword">while</span> ((DateTime.Now - startTime).TotalMilliseconds &lt; maxWaitMs)
                {
                    Thread.Sleep(<span class="hljs-number">10</span>);
                    <span class="hljs-keyword">lock</span> (bufferLock)
                    {
                        <span class="hljs-keyword">if</span> (receivedBuffer.Count &gt;= endMarker.Length)
                        {
                            <span class="hljs-comment">// 检查缓冲区末尾是否包含结束标记</span>
                            <span class="hljs-built_in">bool</span> foundEndMarker = <span class="hljs-literal">true</span>;
                            <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; endMarker.Length; i++)
                            {
                                <span class="hljs-keyword">if</span> (receivedBuffer[receivedBuffer.Count - endMarker.Length + i] != endMarker[i])
                                {
                                    foundEndMarker = <span class="hljs-literal">false</span>;
                                    <span class="hljs-keyword">break</span>;
                                }
                            }
                            <span class="hljs-keyword">if</span> (foundEndMarker)
                            {
                                isWaitingForResponse = <span class="hljs-literal">false</span>;
                                <span class="hljs-built_in">byte</span>[] result = receivedBuffer.ToArray();
                                Console.WriteLine(<span class="hljs-string">$"发现结束标记，接收完成，共收到 <span class="hljs-subst">{result.Length}</span> 字节"</span>);
                                <span class="hljs-keyword">return</span> result;
                            }
                        }
                    }
                }
                <span class="hljs-comment">// 超时处理</span>
                isWaitingForResponse = <span class="hljs-literal">false</span>;
                <span class="hljs-keyword">lock</span> (bufferLock)
                {
                    <span class="hljs-keyword">if</span> (receivedBuffer.Count &gt; <span class="hljs-number">0</span>)
                    {
                        <span class="hljs-built_in">byte</span>[] result = receivedBuffer.ToArray();
                        Console.WriteLine(<span class="hljs-string">$"等待结束标记超时，收到 <span class="hljs-subst">{result.Length}</span> 字节"</span>);
                        <span class="hljs-keyword">return</span> result;
                    }
                }
                <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
            }
            <span class="hljs-keyword">catch</span> (Exception ex)
            {
                Console.WriteLine(<span class="hljs-string">$"发送指令失败: <span class="hljs-subst">{ex.Message}</span>"</span>);
                isWaitingForResponse = <span class="hljs-literal">false</span>;
                <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
            }
        }

        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-doctag">///</span> 方案3: 基于协议帧结构判断接收完成</span>
        <span class="hljs-comment"><span class="hljs-doctag">///</span> 适用于：数据有固定的帧头和长度字段</span>
        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">byte</span>[] <span class="hljs-title">SendQueryWithFrameProtocol</span>(<span class="hljs-params"><span class="hljs-built_in">byte</span>[] command, <span class="hljs-built_in">byte</span> frameHeader, <span class="hljs-built_in">int</span> lengthFieldOffset,
            <span class="hljs-built_in">int</span> lengthFieldSize = <span class="hljs-number">1</span>, <span class="hljs-built_in">int</span> maxWaitMs = <span class="hljs-number">3000</span></span>)</span>
        {
            <span class="hljs-keyword">if</span> (serialPort == <span class="hljs-literal">null</span> || !serialPort.IsOpen)
            {
                Console.WriteLine(<span class="hljs-string">"串口未打开"</span>);
                <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
            }
            <span class="hljs-keyword">lock</span> (bufferLock)
            {
                receivedBuffer.Clear();
                isWaitingForResponse = <span class="hljs-literal">true</span>;
            }
            <span class="hljs-keyword">try</span>
            {
                serialPort.Write(command, <span class="hljs-number">0</span>, command.Length);
                Console.WriteLine(<span class="hljs-string">$"已发送查询指令: <span class="hljs-subst">{BitConverter.ToString(command)}</span>"</span>);
                DateTime startTime = DateTime.Now;
                <span class="hljs-keyword">while</span> ((DateTime.Now - startTime).TotalMilliseconds &lt; maxWaitMs)
                {
                    Thread.Sleep(<span class="hljs-number">10</span>);
                    <span class="hljs-keyword">lock</span> (bufferLock)
                    {
                        <span class="hljs-keyword">if</span> (receivedBuffer.Count &gt; lengthFieldOffset + lengthFieldSize)
                        {
                            <span class="hljs-comment">// 检查帧头</span>
                            <span class="hljs-keyword">if</span> (receivedBuffer[<span class="hljs-number">0</span>] == frameHeader)
                            {
                                <span class="hljs-comment">// 获取数据长度</span>
                                <span class="hljs-built_in">int</span> dataLength = <span class="hljs-number">0</span>;
                                <span class="hljs-keyword">if</span> (lengthFieldSize == <span class="hljs-number">1</span>)
                                {
                                    dataLength = receivedBuffer[lengthFieldOffset];
                                }
                                <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (lengthFieldSize == <span class="hljs-number">2</span>)
                                {
                                    dataLength = (receivedBuffer[lengthFieldOffset] &lt;&lt; <span class="hljs-number">8</span>) | receivedBuffer[lengthFieldOffset + <span class="hljs-number">1</span>];
                                }
                                <span class="hljs-built_in">int</span> expectedFrameLength = lengthFieldOffset + lengthFieldSize + dataLength;
                                <span class="hljs-keyword">if</span> (receivedBuffer.Count &gt;= expectedFrameLength)
                                {
                                    isWaitingForResponse = <span class="hljs-literal">false</span>;
                                    <span class="hljs-built_in">byte</span>[] result = receivedBuffer.Take(expectedFrameLength).ToArray();
                                    Console.WriteLine(<span class="hljs-string">$"根据帧长度判断接收完成，共收到 <span class="hljs-subst">{result.Length}</span> 字节"</span>);
                                    <span class="hljs-keyword">return</span> result;
                                }
                            }
                        }
                    }
                }
                <span class="hljs-comment">// 超时处理</span>
                isWaitingForResponse = <span class="hljs-literal">false</span>;
                <span class="hljs-keyword">lock</span> (bufferLock)
                {
                    <span class="hljs-keyword">if</span> (receivedBuffer.Count &gt; <span class="hljs-number">0</span>)
                    {
                        <span class="hljs-built_in">byte</span>[] result = receivedBuffer.ToArray();
                        Console.WriteLine(<span class="hljs-string">$"帧协议解析超时，收到 <span class="hljs-subst">{result.Length}</span> 字节"</span>);
                        <span class="hljs-keyword">return</span> result;
                    }
                }
                <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
            }
            <span class="hljs-keyword">catch</span> (Exception ex)
            {
                Console.WriteLine(<span class="hljs-string">$"发送指令失败: <span class="hljs-subst">{ex.Message}</span>"</span>);
                isWaitingForResponse = <span class="hljs-literal">false</span>;
                <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
            }
        }

        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-doctag">///</span> 方案4: 组合策略 - 最灵活的方案</span>
        <span class="hljs-comment"><span class="hljs-doctag">///</span> 同时使用多种判断条件，任一条件满足就结束接收</span>
        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">byte</span>[] <span class="hljs-title">SendQueryWithCombinedStrategy</span>(<span class="hljs-params"><span class="hljs-built_in">byte</span>[] command,
            <span class="hljs-built_in">int</span> gapTimeoutMs = <span class="hljs-number">100</span>,
            <span class="hljs-built_in">byte</span>[] endMarker = <span class="hljs-literal">null</span>,
            <span class="hljs-built_in">int</span>? maxLength = <span class="hljs-literal">null</span>,
            <span class="hljs-built_in">int</span> maxWaitMs = <span class="hljs-number">3000</span></span>)</span>
        {
            <span class="hljs-keyword">if</span> (serialPort == <span class="hljs-literal">null</span> || !serialPort.IsOpen)
            {
                Console.WriteLine(<span class="hljs-string">"串口未打开"</span>);
                <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
            }
            <span class="hljs-keyword">lock</span> (bufferLock)
            {
                receivedBuffer.Clear();
                isWaitingForResponse = <span class="hljs-literal">true</span>;
                lastReceiveTime = DateTime.Now;
            }
            <span class="hljs-keyword">try</span>
            {
                serialPort.Write(command, <span class="hljs-number">0</span>, command.Length);
                Console.WriteLine(<span class="hljs-string">$"已发送查询指令: <span class="hljs-subst">{BitConverter.ToString(command)}</span>"</span>);
                DateTime startTime = DateTime.Now;
                <span class="hljs-keyword">while</span> ((DateTime.Now - startTime).TotalMilliseconds &lt; maxWaitMs)
                {
                    Thread.Sleep(<span class="hljs-number">10</span>);
                    <span class="hljs-keyword">lock</span> (bufferLock)
                    {
                        <span class="hljs-keyword">if</span> (receivedBuffer.Count == <span class="hljs-number">0</span>) <span class="hljs-keyword">continue</span>;
                        <span class="hljs-comment">// 条件1: 检查最大长度限制</span>
                        <span class="hljs-keyword">if</span> (maxLength.HasValue &amp;&amp; receivedBuffer.Count &gt;= maxLength.Value)
                        {
                            isWaitingForResponse = <span class="hljs-literal">false</span>;
                            <span class="hljs-built_in">byte</span>[] result = receivedBuffer.ToArray();
                            Console.WriteLine(<span class="hljs-string">$"达到最大长度限制，接收完成，共收到 <span class="hljs-subst">{result.Length}</span> 字节"</span>);
                            <span class="hljs-keyword">return</span> result;
                        }
                        <span class="hljs-comment">// 条件2: 检查结束标记</span>
                        <span class="hljs-keyword">if</span> (endMarker != <span class="hljs-literal">null</span> &amp;&amp; receivedBuffer.Count &gt;= endMarker.Length)
                        {
                            <span class="hljs-built_in">bool</span> foundEndMarker = <span class="hljs-literal">true</span>;
                            <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; endMarker.Length; i++)
                            {
                                <span class="hljs-keyword">if</span> (receivedBuffer[receivedBuffer.Count - endMarker.Length + i] != endMarker[i])
                                {
                                    foundEndMarker = <span class="hljs-literal">false</span>;
                                    <span class="hljs-keyword">break</span>;
                                }
                            }
                            <span class="hljs-keyword">if</span> (foundEndMarker)
                            {
                                isWaitingForResponse = <span class="hljs-literal">false</span>;
                                <span class="hljs-built_in">byte</span>[] result = receivedBuffer.ToArray();
                                Console.WriteLine(<span class="hljs-string">$"发现结束标记，接收完成，共收到 <span class="hljs-subst">{result.Length}</span> 字节"</span>);
                                <span class="hljs-keyword">return</span> result;
                            }
                        }
                        <span class="hljs-comment">// 条件3: 检查数据间隔超时</span>
                        <span class="hljs-keyword">if</span> ((DateTime.Now - lastReceiveTime).TotalMilliseconds &gt; gapTimeoutMs)
                        {
                            isWaitingForResponse = <span class="hljs-literal">false</span>;
                            <span class="hljs-built_in">byte</span>[] result = receivedBuffer.ToArray();
                            Console.WriteLine(<span class="hljs-string">$"数据间隔超时，接收完成，共收到 <span class="hljs-subst">{result.Length}</span> 字节"</span>);
                            <span class="hljs-keyword">return</span> result;
                        }
                    }
                }
                <span class="hljs-comment">// 最大等待时间超时</span>
                isWaitingForResponse = <span class="hljs-literal">false</span>;
                <span class="hljs-keyword">lock</span> (bufferLock)
                {
                    <span class="hljs-keyword">if</span> (receivedBuffer.Count &gt; <span class="hljs-number">0</span>)
                    {
                        <span class="hljs-built_in">byte</span>[] result = receivedBuffer.ToArray();
                        Console.WriteLine(<span class="hljs-string">$"最大等待时间超时，收到 <span class="hljs-subst">{result.Length}</span> 字节"</span>);
                        <span class="hljs-keyword">return</span> result;
                    }
                }
                <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
            }
            <span class="hljs-keyword">catch</span> (Exception ex)
            {
                Console.WriteLine(<span class="hljs-string">$"发送指令失败: <span class="hljs-subst">{ex.Message}</span>"</span>);
                isWaitingForResponse = <span class="hljs-literal">false</span>;
                <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
            }
        }

        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-doctag">///</span> 数据接收事件处理</span>
        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span>
        <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnDataReceived</span>(<span class="hljs-params"><span class="hljs-built_in">object</span> sender, SerialDataReceivedEventArgs e</span>)</span>
        {
            <span class="hljs-keyword">if</span> (!isWaitingForResponse) <span class="hljs-keyword">return</span>;
            <span class="hljs-keyword">try</span>
            {
                <span class="hljs-built_in">int</span> bytesToRead = serialPort.BytesToRead;
                <span class="hljs-keyword">if</span> (bytesToRead &gt; <span class="hljs-number">0</span>)
                {
                    <span class="hljs-built_in">byte</span>[] buffer = <span class="hljs-keyword">new</span> <span class="hljs-built_in">byte</span>[bytesToRead];
                    <span class="hljs-built_in">int</span> bytesRead = serialPort.Read(buffer, <span class="hljs-number">0</span>, bytesToRead);
                    <span class="hljs-keyword">lock</span> (bufferLock)
                    {
                        receivedBuffer.AddRange(buffer);
                        lastReceiveTime = DateTime.Now; <span class="hljs-comment">// 更新最后接收时间</span>
                        Console.WriteLine(<span class="hljs-string">$"收到数据包 (<span class="hljs-subst">{bytesRead}</span> 字节): <span class="hljs-subst">{BitConverter.ToString(buffer, <span class="hljs-number">0</span>, bytesRead)}</span>"</span>);
                        Console.WriteLine(<span class="hljs-string">$"当前缓冲区总计: <span class="hljs-subst">{receivedBuffer.Count}</span> 字节"</span>);
                    }
                }
            }
            <span class="hljs-keyword">catch</span> (Exception ex)
            {
                Console.WriteLine(<span class="hljs-string">$"数据接收处理异常: <span class="hljs-subst">{ex.Message}</span>"</span>);
            }
        }

        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-doctag">///</span> 关闭串口</span>
        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Close</span>()</span>
        {
            <span class="hljs-keyword">try</span>
            {
                isWaitingForResponse = <span class="hljs-literal">false</span>;
                <span class="hljs-keyword">if</span> (serialPort != <span class="hljs-literal">null</span> &amp;&amp; serialPort.IsOpen)
                {
                    serialPort.Close();
                    Console.WriteLine(<span class="hljs-string">"串口已关闭"</span>);
                }
            }
            <span class="hljs-keyword">catch</span> (Exception ex)
            {
                Console.WriteLine(<span class="hljs-string">$"关闭串口异常: <span class="hljs-subst">{ex.Message}</span>"</span>);
            }
        }

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">string</span>[] <span class="hljs-title">GetAvailablePorts</span>()</span>
        {
            <span class="hljs-keyword">return</span> SerialPort.GetPortNames();
        }
    }
}
</code></pre>
<h3 data-id="heading-11">完整代码</h3>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">namespace</span> <span class="hljs-title">AppFlexSerialPort</span>
{
    <span class="hljs-keyword">internal</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Program</span>
    {
        <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Main</span>(<span class="hljs-params"><span class="hljs-built_in">string</span>[] args</span>)</span>
        {
            FlexibleSerialPort comm = <span class="hljs-keyword">new</span> FlexibleSerialPort();
            <span class="hljs-keyword">try</span>
            {
                <span class="hljs-keyword">if</span> (comm.InitializePort(<span class="hljs-string">"COM1"</span>, <span class="hljs-number">9600</span>))
                {
                    <span class="hljs-built_in">byte</span>[] queryCommand = { <span class="hljs-number">0x01</span>, <span class="hljs-number">0x03</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x84</span>, <span class="hljs-number">0x0A</span> };
                    Console.WriteLine(<span class="hljs-string">"=== 方案1: 基于数据间隔判断 ==="</span>);
                    <span class="hljs-built_in">byte</span>[] response1 = comm.SendQueryWithGapTimeout(queryCommand, <span class="hljs-number">150</span>, <span class="hljs-number">3000</span>);
                    Thread.Sleep(<span class="hljs-number">1000</span>);
                    Console.WriteLine(<span class="hljs-string">"\n=== 方案2: 基于结束符判断 ==="</span>);
                    <span class="hljs-built_in">byte</span>[] endMarker = { <span class="hljs-number">0x0D</span>, <span class="hljs-number">0x0A</span> }; <span class="hljs-comment">// CR LF</span>
                    <span class="hljs-built_in">byte</span>[] response2 = comm.SendQueryWithEndMarker(queryCommand, endMarker);
                    Thread.Sleep(<span class="hljs-number">1000</span>);
                    Console.WriteLine(<span class="hljs-string">"\n=== 方案3: 基于协议帧结构判断 ==="</span>);
                    <span class="hljs-built_in">byte</span>[] response3 = comm.SendQueryWithFrameProtocol(queryCommand, <span class="hljs-number">0x01</span>, <span class="hljs-number">2</span>, <span class="hljs-number">1</span>);
                    Thread.Sleep(<span class="hljs-number">1000</span>);
                    Console.WriteLine(<span class="hljs-string">"\n=== 方案4: 组合策略 ==="</span>);
                    <span class="hljs-built_in">byte</span>[] response4 = comm.SendQueryWithCombinedStrategy(
                        queryCommand,
                        gapTimeoutMs: <span class="hljs-number">100</span>,           <span class="hljs-comment">// 数据间隔100ms</span>
                        endMarker: <span class="hljs-keyword">new</span> <span class="hljs-built_in">byte</span>[] { <span class="hljs-number">0x0A</span> }, <span class="hljs-comment">// 或者以LF结尾</span>
                        maxLength: <span class="hljs-number">50</span>,               <span class="hljs-comment">// 或者最多50字节</span>
                        maxWaitMs: <span class="hljs-number">3000</span>              <span class="hljs-comment">// 最多等待3秒</span>
                    );
                }
                Console.WriteLine(<span class="hljs-string">"按任意键退出..."</span>);
                Console.ReadKey();
            }
            <span class="hljs-keyword">catch</span> (Exception ex)
            {
                Console.WriteLine(<span class="hljs-string">$"程序异常: <span class="hljs-subst">{ex.Message}</span>"</span>);
            }
            <span class="hljs-keyword">finally</span>
            {
                comm.Close();
            }
        }
    }
}
</code></pre>
<p><img src="https://mmbiz.qpic.cn/mmbiz_png/D1DJjmDXQdnFmJFU5J5rlfxb5AhPOUuHwlNHbtd3ficlnibmicicobrAiba2qciaD3dwekVo4FZNsq0GREL2dfia4lRsQ/640?wx_fmt=png&amp;from=appmsg" alt="" title="null" loading="lazy"/></p>
<p><img src="https://mmbiz.qpic.cn/mmbiz_png/D1DJjmDXQdnFmJFU5J5rlfxb5AhPOUuHMsvyqeGaTfgknLgoDprObt1cODjBMggygP1yTC9ylaRK5etf3FO6qQ/640?wx_fmt=png&amp;from=appmsg" alt="" loading="lazy"/></p>
<h3 data-id="heading-12">性能优化与实践</h3>
<h4 data-id="heading-13">关键参数调优</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// ✅ 推荐配置</span>
<span class="hljs-built_in">int</span> gapTimeoutMs = <span class="hljs-number">100</span>;    <span class="hljs-comment">// 100-200ms适合大多数设备</span>
<span class="hljs-built_in">int</span> maxWaitMs = <span class="hljs-number">3000</span>;      <span class="hljs-comment">// 总超时3秒，避免程序卡死</span>
Thread.Sleep(<span class="hljs-number">10</span>);          <span class="hljs-comment">// 轮询间隔10ms，平衡CPU占用和响应速度</span>
</code></pre>
<h4 data-id="heading-14">线程安全保障</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">object</span> bufferLock = <span class="hljs-keyword">new</span> <span class="hljs-built_in">object</span>();
<span class="hljs-comment">// 所有缓冲区操作都要加锁</span>
<span class="hljs-keyword">lock</span> (bufferLock)
{
    receivedBuffer.Clear();
    receivedBuffer.AddRange(buffer);
    <span class="hljs-comment">// ... 其他缓冲区操作</span>
}
</code></pre>
<h4 data-id="heading-15">常见提醒</h4>
<p>1、忘记清空缓冲区：每次查询前必须 <code>receivedBuffer.Clear()</code></p>
<p>2、超时时间设置不当：间隔超时太短会截断数据，太长会影响响应速度</p>
<p>3、线程安全问题：<code>DataReceived</code> 事件在不同线程中执行，必须加锁保护</p>
<p>4、资源释放：程序结束前记得调用 <code>Close()</code> 方法</p>
<h3 data-id="heading-16">适用场景对比</h3>



































<table><thead><tr><th align="left">方案</th><th align="left">适用场景</th><th align="left">优点</th><th align="left">缺点</th></tr></thead><tbody><tr><td align="left">间隔超时</td><td align="left">通用场景</td><td align="left">简单可靠</td><td align="left">需要调试最佳间隔时间</td></tr><tr><td align="left">结束符判断</td><td align="left">文本协议</td><td align="left">精确判断</td><td align="left">需要明确的结束符</td></tr><tr><td align="left">帧结构判断</td><td align="left">二进制协议</td><td align="left">最精确</td><td align="left">需要了解协议细节</td></tr><tr><td align="left">组合策略</td><td align="left">复杂场景</td><td align="left">最灵活</td><td align="left">代码稍复杂</td></tr></tbody></table>
<h3 data-id="heading-17">总结</h3>
<p>1、选择合适的策略：对于90%的场景，<strong>数据间隔超时判断</strong>就足够了</p>
<p>2、参数调优很重要：100-200ms 的间隔超时是经验值，需要根据实际设备调整</p>
<p>3、组合策略是王道：当单一策略无法满足需求时，组合策略提供了最大的灵活性</p>
<p>通过本文介绍的四种策略，开发者可以根据具体通信协议灵活选择最适合的接收方式，彻底告别"分包接收"带来的困扰。</p>
<h3 data-id="heading-18">关键词</h3>
<p>串口通信、分包接收、C#、SerialPort、数据间隔超时、结束符判断、协议帧结构、组合策略、线程安全、工业控制</p>
<h3 data-id="heading-19">最后</h3>
<p>如果你觉得这篇文章对你有帮助，不妨点个赞支持一下！你的支持是我继续分享知识的动力。如果有任何疑问或需要进一步的帮助，欢迎随时留言。</p>
<p>也可以加入微信公众号 <strong>[DotNet技术匠]</strong> 社区，与其他热爱技术的同行一起交流心得，共同成长！</p>
<p><strong>优秀是一种习惯，欢迎大家留言学习！</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[解构内存迷宫：串联虚拟地址、页表与内存使用（一）]]></title>    <link>https://juejin.cn/post/7590705425134305289</link>    <guid>https://juejin.cn/post/7590705425134305289</guid>    <pubDate>2026-01-03T12:48:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590705425134305289" data-draft-id="7590608345923239962" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="解构内存迷宫：串联虚拟地址、页表与内存使用（一）"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-03T12:48:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="风的归宿55"/> <meta itemprop="url" content="https://juejin.cn/user/2840793779297303"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            解构内存迷宫：串联虚拟地址、页表与内存使用（一）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2840793779297303/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    风的归宿55
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-03T12:48:55.000Z" title="Sat Jan 03 2026 12:48:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h4 data-id="heading-0">介绍</h4>
<p>说到内存，读者之前可能听说过很多概念，比如虚拟地址，虚拟内存，页表，内核，物理内存管理等，各个概念可能听上去都知道，但是却很少有文章将这些内存相关的概念串联起来，这篇文章就是通过几个使用场景将这些概念串联起来，让读者能更清楚的了解这些概念的同时，对内存使用的流程有个整体上的了解。 让我们开始吧，一起去探索 程序的一页数据是如何在计算机内存中“安家落户”的。</p>
<h4 data-id="heading-1">物理内存和物理地址</h4>
<p>我们先从物理内存说起，他是一个物理介质，在通电的情况下可以存储数据，而物理地址就是内存的一个坐标，我们可以通过提供一个物理地址和一个长度来读取内存上对应区域存储的数据。 我们程序在运行时，就经常需要使用内存来写入和读取数据，比如a=0 就是把a变量映射成了一个物理地址，然后在物理地址对应的内存区域上写上0，这样在读取a这个变量时，就可以通过a的物理地址从内存中找到0这个数据，就读取到了变量的值。</p>
<p>这个是理想情况，但是实际上操作系统并不会像是这样直接使用物理地址，而是<strong>使用一个称为虚拟地址的方式存储变量的地址，然后要访问变量值时，使用这个虚拟地址，加上一个称为页表的映射结构，转换成物理地址</strong>，然后再到对应的内存区域中获取变量的值。</p>
<h6 data-id="heading-2">使用物理地址的问题</h6>
<p>为什么要特意加上这个转换逻辑呢，直接使用物理地址存储不行么？ 其实早期是有直接使用物理内存存储数据的机器的，但是他有几个问题：</p>
<ol>
<li>安全问题：进程没有隔离，系统安全性大为下降，因为所有进程使用一个相同的“地址空间”，有可能恶意进程会访问不属于他的物理地址，造成权限问题，或者不小心覆盖了不属于他的数据，甚至是操作系统数据。</li>
<li>内存碎片问题：比如一个进程申请100M的空间，用完后释放了，但是这块内存地址的前后内存块都被使用了，这时候有个进程申请120M的连续内存，这100M就无法被使用，因为他前后的内存已经被占用了，这就造成操作系统上有很多内存空洞，空闲的内存总量是够用的，但是无法分配一个较大的连续内存，这就是内存碎片。</li>
<li>易用性问题：编程与管理的复杂度高，因为程序员或者编译器必须自己管理物理内存，每次程序启动的变量内存地址都不一样，很容易出错。</li>
<li>灵活性问题：内存共享与稀疏存储，很难实现内存共享，比如很多程序都需要用到标准库（如libc），使用物理内存的话，只能每个进程都在物理内存中保留一份，造成浪费。</li>
</ol>
<h4 data-id="heading-3">虚拟地址和页表</h4>
<p>那么，虚拟地址和页表是如何解决这些问题的呢？首先介绍下这两个概念，<strong>虚拟地址是每个进程都拥有的，从0开始的连续的内存地址空间</strong>，之所以称为虚拟，是因为程序使用这个地址访问时，并不是访问这个地址对应的物理内存。而页表，则是将虚拟地址映射成一个物理地址的数据结构。 <strong>需要注意的是，页表是一个数据结构，因此页表也是需要存在物理内存上的，会占用一定内存空间</strong>，你可以理解为类似一个java中的map，输入虚拟地址a，通过查询页表，可以一步一步找到a对应的物理地址b。</p>
<p>还有一个需要说明的是<strong>页</strong>这个概念，操作系统是将内存以4k大小为一个最小分配单位，每次进程申请内存时，就会分配多个4k大小的空闲内存页给进程。比如进程申请15k的内存，操作系统就会给他分配4个4k的内存块，然后在页表中增加四个页表项，将4个内存块的虚拟地址映射到实际的物理内存地址。页表页表，顾名思义，就是页的映射表。</p>
<h6 data-id="heading-4">虚拟地址的使用</h6>
<p>有了虚拟地址后，<strong>操作系统只会让程序使用虚拟地址，他会在进程启动时为每个进程生成一个独立的页表</strong>，之后不管程序访问什么地址，操作系统都会把这个地址当成虚拟地址，通过程序的页表进行转换成物理地址，然后再进行访问。</p>
<p>举个例子，比如进程访问一个地址为a的虚拟地址，操作系统并不会去访问b这个物理内存地址，而是会去查询页表，找到对应的物理内存b，然后访问b地址中的内存的数据。而且这个b地址不是固定的，他是随机的，是在程序申请a地址的内存时，操作系统取查找空闲的内存页，然后配置到页表上的。</p>
<h6 data-id="heading-5">虚拟地址和页表的好处</h6>
<p>使用虚拟地址和页表为什么能解决上述问题呢？</p>
<ol>
<li>安全问题：使用虚拟地址后，每个程序访问的地址都被当做虚拟地址处理，然后通过页表转换成物理地址，而页表的数据只有操作系统能管理，这样只要操作系统做好内存管理，不要把同一块空闲内存分配个多个进程，就能确保进程之间的隔离性，即使恶意进程想要访问一个别的进程使用的物理地址，他的访问地址也会被当做虚拟地址处理，访问到分配给他的一个他自己的空闲内存上。</li>
<li>内存碎片问题：在虚拟地址空间中，进程以为自己拥有一段非常长的连续内存，比如他认为自己有1G的连续空间，但是实际上，操作系统通过页表将这1G空间映射到物理内存中分散的内存块上，这样就能通过复用小块内存避免内存碎片问题，因为任何空闲的物理页都能被利用，大大提高了内存利用率</li>
<li>易用性问题：每个进程都从固定的地址（如0x400000）开始加载代码。链接器和编译器可以提前确定很多地址，编程模型简单统一。</li>
<li>灵活性问题：共享内存实现起来很简单，比如对于一些标准库，操作系统可以将其在内存中存储一份，然后在启动程序时，如果他们需要标准库的代码，就可以在进程启动时，让操作系统将不同进程的存储标准库代码的虚拟地址页表项映射到同一个物理页，这样，系统的动态链接库只需要在物理内存中保存一份，所有进程共享，节省大量内存。</li>
</ol>
<h4 data-id="heading-6">多级页表</h4>
<p>之前介绍了使用页表的原因，但是如果页表的实现只是单纯的将一个虚拟地址映射到另外一个物理地址，这也是有问题的，这种方式被称为单级页表，相当于每个虚拟地址是页表这个map的key，它对应的物理地址，也就是value可以不存在，但是每个key必须存在，所以操作系统必须为每一个虚拟地址生成一个页表项，这就会导致一个程序的页表项太多。之前说过，页表是个数据结构，他本身也是占用一定内存大小的，页表项太多的话就会占用较大内存。</p>
<p>这里有个地方需要注意下，因为linux系统是以4k为最小的内存分配单位，因此单级页表中的每个页表项指向的也是一个4k的内存，所以<strong>一个单级页表的总项目数量是 最大物理内存大小(字节) / (4*1024) 字节，比所有地址的数量要少</strong> 。两个连续的页表项之间相隔4kb，不是每个字节都有对应的页表项，访问时找的是根据虚拟地址计算出的他所属于的那个页的虚拟地址。</p>
<h6 data-id="heading-7">单级页表占用的内存</h6>
<p>假设使用的是一个32位的操作系统：</p>
<ol>
<li>一个进程的虚拟地址共有2^32=4G，这也是操作系统的最大内存。</li>
<li>换算成KB是： 4 GB = 4 × 1024 × 1024 KB = 4,194,304 KB</li>
<li>而一个系统的页大小是4KB，为了存储一个进程的所有虚拟地址，需要 4,194,304/4 = 1,048,576 个页表项。</li>
<li>每个页表项占用4字节，则 共需要 1,048,576*4/1024/1024=4M 的空间。</li>
<li>如果启动100个进程，别的内存不算，页表占用的内存就达到了4*100 = 400M,占了系统内存的10%，</li>
</ol>
<p>通过计算可以看出，单级页表造成了极大浪费，因为一般情况下进程不会使用到页表中大部分的虚拟地址空间。更糟糕的是，这4MB的页表必须是连续的物理内存，随着系统运行，分配一块连续的4MB内存会变得非常困难。</p>
<h6 data-id="heading-8">多级页表的优势</h6>
<p>那么使用多级页表是怎么解决这个问题的呢？首先介绍下多级页表，顾名思义，他就是采用了多个层级，当寻找一个虚拟地址对应的物理地址时，需要一级一级的查找，经过多次映射后才能找到对应的物理地址。就比如字典，查找一个字时，先找首字母，这个首字母就是顶级页表，找到后在字母中再根据拼音顺序找对应汉字，这个就是第二级，最后再是根据找到的页数，去对应页数找到汉字，这个就是通过三级页表找到了物理地址。</p>
<p>linux系统中一般默认使用四级页表，为了简化，我们假设使用二级列表来看下他是怎么节约内存的，以32位系统为例：</p>
<ol>
<li>我们将地址分为 10位（第1级索引） + 10位（第2级索引） + 12位（页内偏移）</li>
<li>前10位就是顶级页表，一共用了 2^10 = 1024 个条目</li>
<li>顶级页表的大小 = 1024 * 4字节 = 4KB（正好一页）。</li>
</ol>
<p>顶级页表是必须有的，但是二级列表可以等使用到内存时再分配，因此在一个程序启动时，只需要用到4k的页表项，这就比之前的4M要小的多了。</p>
<h6 data-id="heading-9">多级页表和单级页表的区别</h6>
<p>有人可能会问，为什么多级页表不需要提前存储后面几个层级的页表，而单级页表却需要存储所有页表项呢？因为单级页表是直接索引，虚拟地址直接作为索引，去一个巨大的、连续的数组中查找，为了能够通过索引直接定位，这个数组必须完整存在，所以单级页表不能缺少页表项。</p>
<p>而多级页表是间接索引，只要确保第一级存在，第二级可以在你需要用到时才去加载，这是一种“懒加载”策略。</p>
<p>举个例子，比如现在多级页表只有顶级页表，你需要存储一个数据时，输入指定虚拟地址去存数据，操作系统根据虚拟地址去顶级页表这个目录找到地址对应的二级页表地址时，发现二级页表的地址不存在，此时他就可以分配内存，生成需要访问的虚拟地址所在的二级页表的数据，即一个10位的二级页表，此时只是多了一个二级页表，即2^10* 4字节 = 4KB大小。</p>
<h4 data-id="heading-10">结语</h4>
<p>好了，先介绍到这里，本片文章主要讲解了虚拟地址和页表相关内容，后续内容在下一篇文章中呈现。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[登录验证全攻略：从会话技术到 JWT，结合过滤器与拦截器实战]]></title>    <link>https://juejin.cn/post/7590699877630574630</link>    <guid>https://juejin.cn/post/7590699877630574630</guid>    <pubDate>2026-01-03T13:13:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590699877630574630" data-draft-id="7590601860300587035" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="登录验证全攻略：从会话技术到 JWT，结合过滤器与拦截器实战"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-03T13:13:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员根根"/> <meta itemprop="url" content="https://juejin.cn/user/555679166786139"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            登录验证全攻略：从会话技术到 JWT，结合过滤器与拦截器实战
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/555679166786139/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员根根
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-03T13:13:02.000Z" title="Sat Jan 03 2026 13:13:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 Web 应用中，<strong>登录验证</strong>是保障系统安全的第一道防线 —— 只有通过身份认证的用户，才能访问系统的核心资源（如员工管理、部门数据、个人中心等）。实现登录验证的核心技术包括 “会话管理” 和 “请求拦截”，从传统的 Session-Cookie，到如今流行的 JWT 令牌，再配合过滤器（Filter）与拦截器（Interceptor）实现全局校验，形成了一套完整的登录验证体系。本文将以 “后台管理系统” 为场景，全面讲解登录验证的实现思路、核心技术及实战落地。</p>
<h2 data-id="heading-0">一、登录验证的核心诉求：为什么需要它？</h2>
<p>想象一个没有登录验证的后台系统：任何人都可以直接访问<code>/emp/list</code>（员工列表）、<code>/dept/delete</code>（删除部门）等核心接口，这会导致数据泄露、恶意篡改等严重安全问题。</p>
<p>登录验证的核心诉求有 3 点：</p>
<ol>
<li><strong>身份认证</strong>：验证用户输入的账号密码是否正确，确认用户身份合法性；</li>
<li><strong>身份保持</strong>：用户登录成功后，在一段时间内无需重复登录，可正常访问系统资源（会话技术实现）；</li>
<li><strong>权限控制</strong>：拦截未登录用户的非法请求，拒绝其访问受保护资源（过滤器 / 拦截器实现）。</li>
</ol>
<h2 data-id="heading-1">二、会话技术：实现用户身份保持</h2>
<p>用户登录成功后，如何让系统 “记住” 用户身份？这就需要<strong>会话技术</strong>，主流方案分为两类：传统的<code>Session-Cookie</code>和现代的<code>JWT</code>（Json Web Token）。</p>
<h4 data-id="heading-2">1. 传统方案：Session-Cookie 会话管理</h4>
<h5 data-id="heading-3">核心原理</h5>
<p><code>Session-Cookie</code>是基于服务器端存储的会话方案，核心流程如下：</p>
<ol>
<li>用户提交账号密码登录，服务器验证通过后，创建<code>HttpSession</code>对象（存储用户信息，如用户 ID、用户名），并生成唯一的<code>SessionId</code>；</li>
<li>服务器将<code>SessionId</code>通过<code>Set-Cookie</code>响应头写入客户端浏览器；</li>
<li>客户端后续发起请求时，浏览器会自动携带该<code>Cookie</code>（包含<code>SessionId</code>）到服务器；</li>
<li>服务器通过<code>SessionId</code>查找对应的<code>HttpSession</code>对象，确认用户身份，实现 “免登录” 访问。</li>
</ol>
<h5 data-id="heading-4">实战演示（Java Web）</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 1. 登录接口：验证账号密码，创建Session</span>
<span class="hljs-meta">@WebServlet("/login")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LoginServlet</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">HttpServlet</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doPost</span><span class="hljs-params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="hljs-keyword">throws</span> ServletException, IOException {
        req.setCharacterEncoding(<span class="hljs-string">"UTF-8"</span>);
        resp.setContentType(<span class="hljs-string">"application/json;charset=UTF-8"</span>);

        <span class="hljs-comment">// 获取前端提交的账号密码</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">username</span> <span class="hljs-operator">=</span> req.getParameter(<span class="hljs-string">"username"</span>);
        <span class="hljs-type">String</span> <span class="hljs-variable">password</span> <span class="hljs-operator">=</span> req.getParameter(<span class="hljs-string">"password"</span>);

        <span class="hljs-comment">// 模拟账号密码验证（实际需查询数据库）</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-string">"admin"</span>.equals(username) &amp;&amp; <span class="hljs-string">"123456"</span>.equals(password)) {
            <span class="hljs-comment">// 登录成功：创建Session，存储用户信息</span>
            <span class="hljs-type">HttpSession</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> req.getSession();
            session.setAttribute(<span class="hljs-string">"loginUser"</span>, username); <span class="hljs-comment">// 存储用户名</span>
            session.setMaxInactiveInterval(<span class="hljs-number">3600</span>); <span class="hljs-comment">// 设置Session过期时间：1小时（无操作超时）</span>

            resp.getWriter().write(<span class="hljs-string">"{"</span>code<span class="hljs-string">":200,"</span>msg<span class="hljs-string">":"</span>登录成功<span class="hljs-string">"}"</span>);
        } <span class="hljs-keyword">else</span> {
            resp.getWriter().write(<span class="hljs-string">"{"</span>code<span class="hljs-string">":500,"</span>msg<span class="hljs-string">":"</span>账号或密码错误<span class="hljs-string">"}"</span>);
        }
    }
}

<span class="hljs-comment">// 2. 核心资源接口：通过Session验证用户身份</span>
<span class="hljs-meta">@WebServlet("/emp/list")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EmpListServlet</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">HttpServlet</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doGet</span><span class="hljs-params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="hljs-keyword">throws</span> ServletException, IOException {
        resp.setContentType(<span class="hljs-string">"application/json;charset=UTF-8"</span>);

        <span class="hljs-comment">// 获取Session中的用户信息</span>
        <span class="hljs-type">HttpSession</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> req.getSession(<span class="hljs-literal">false</span>); <span class="hljs-comment">// false：不存在则返回null，不创建新Session</span>
        <span class="hljs-keyword">if</span> (session == <span class="hljs-literal">null</span> || session.getAttribute(<span class="hljs-string">"loginUser"</span>) == <span class="hljs-literal">null</span>) {
            <span class="hljs-comment">// 未登录：返回未授权提示</span>
            resp.getWriter().write(<span class="hljs-string">"{"</span>code<span class="hljs-string">":401,"</span>msg<span class="hljs-string">":"</span>请先登录<span class="hljs-string">"}"</span>);
            <span class="hljs-keyword">return</span>;
        }

        <span class="hljs-comment">// 已登录：返回员工列表数据</span>
        resp.getWriter().write(<span class="hljs-string">"{"</span>code<span class="hljs-string">":200,"</span>data<span class="hljs-string">":[{"</span>id<span class="hljs-string">":1,"</span>name<span class="hljs-string">":"</span>张三<span class="hljs-string">"},{"</span>id<span class="hljs-string">":2,"</span>name<span class="hljs-string">":"</span>李四<span class="hljs-string">"}]}"</span>);
    }
}
</code></pre>
<h5 data-id="heading-5">Session-Cookie 的优缺点</h5>





















<table><thead><tr><th>优点</th><th>缺点</th></tr></thead><tbody><tr><td>安全性较高（用户信息存储在服务器端，不易被篡改）</td><td>服务器压力大（大量 Session 存储在服务器内存 / 缓存中，高并发场景不友好）</td></tr><tr><td>支持会话失效手动控制（如用户退出登录，直接销毁 Session）</td><td>不支持跨域（Cookie 默认不允许跨域携带，需额外配置）</td></tr><tr><td>实现简单，无需额外依赖</td><td>不支持分布式部署（Session 存储在单个服务器，集群环境下需做 Session 共享）</td></tr></tbody></table>
<h4 data-id="heading-6">2. 现代方案：JWT 令牌认证</h4>
<h5 data-id="heading-7">核心原理</h5>
<p>JWT（Json Web Token）是一种基于<strong>客户端存储</strong>的无状态令牌方案，无需服务器存储会话信息，核心流程如下：</p>
<ol>
<li>用户提交账号密码登录，服务器验证通过后，根据用户信息（如用户 ID、用户名）和密钥，生成 JWT 令牌（包含头部、载荷、签名三部分）；</li>
<li>服务器将 JWT 令牌返回给客户端（客户端可存储在 LocalStorage/SessionStorage/Cookie 中）；</li>
<li>客户端后续发起请求时，通过请求头（如<code>Authorization: Bearer &lt;JWT令牌&gt;</code>）携带令牌到服务器；</li>
<li>服务器接收令牌后，通过密钥验证令牌的合法性（是否过期、是否被篡改），验证通过则确认用户身份。</li>
</ol>
<h5 data-id="heading-8">JWT 令牌结构</h5>
<p>JWT 令牌是一个字符串，由三部分组成，用<code>.</code>分隔：</p>
<ol>
<li>
<p><strong>Header（头部）</strong> ：指定令牌类型（JWT）和加密算法（如 HS256），示例：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span><span class="hljs-attr">"alg"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"HS256"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"typ"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"JWT"</span><span class="hljs-punctuation">}</span>
</code></pre>
</li>
<li>
<p><strong>Payload（载荷）</strong> ：存储用户自定义信息（如用户 ID、用户名）和过期时间等元数据，示例：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span><span class="hljs-attr">"userId"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"username"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"admin"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"exp"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1735689600</span><span class="hljs-punctuation">}</span>
</code></pre>
</li>
<li>
<p><strong>Signature（签名）</strong> ：服务器用头部指定的加密算法，将头部、载荷和密钥进行加密生成的签名，用于验证令牌是否被篡改。</p>
</li>
</ol>
<h5 data-id="heading-9">实战演示（Java + JJWT 依赖）</h5>
<h6 data-id="heading-10">（1）引入 JJWT 依赖（Maven）</h6>
<p>JJWT 是 Java 生态中常用的 JWT 工具库，简化 JWT 的生成与验证：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.jsonwebtoken<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jjwt-api<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.11.5<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.jsonwebtoken<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jjwt-impl<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.11.5<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>runtime<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.jsonwebtoken<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jjwt-jackson<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.11.5<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>runtime<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<h6 data-id="heading-11">（2）JWT 工具类</h6>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> io.jsonwebtoken.Claims;
<span class="hljs-keyword">import</span> io.jsonwebtoken.Jwts;
<span class="hljs-keyword">import</span> io.jsonwebtoken.security.Keys;
<span class="hljs-keyword">import</span> javax.crypto.SecretKey;
<span class="hljs-keyword">import</span> java.util.Date;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JwtUtils</span> {
    <span class="hljs-comment">// 密钥（生产环境需配置在配置文件中，且保证安全性）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">SECRET_KEY</span> <span class="hljs-operator">=</span> <span class="hljs-string">"my-secret-key-32bytes-long-12345678"</span>;
    <span class="hljs-comment">// 令牌过期时间：1小时（单位：毫秒）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">EXPIRE_TIME</span> <span class="hljs-operator">=</span> <span class="hljs-number">3600</span> * <span class="hljs-number">1000L</span>;

    <span class="hljs-comment">// 生成JWT令牌</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">generateToken</span><span class="hljs-params">(String username)</span> {
        <span class="hljs-comment">// 创建密钥（HS256算法要求密钥长度至少32位）</span>
        <span class="hljs-type">SecretKey</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> Keys.hmacShaKeyFor(SECRET_KEY.getBytes());
        <span class="hljs-comment">// 构建并生成令牌</span>
        <span class="hljs-keyword">return</span> Jwts.builder()
                .setSubject(username) <span class="hljs-comment">// 设置主题（存储用户名）</span>
                .setIssuedAt(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>()) <span class="hljs-comment">// 设置签发时间</span>
                .setExpiration(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(System.currentTimeMillis() + EXPIRE_TIME)) <span class="hljs-comment">// 设置过期时间</span>
                .signWith(key) <span class="hljs-comment">// 使用密钥签名</span>
                .compact();
    }

    <span class="hljs-comment">// 验证JWT令牌合法性，并获取令牌中的用户信息</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Claims <span class="hljs-title function_">verifyToken</span><span class="hljs-params">(String token)</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">SecretKey</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> Keys.hmacShaKeyFor(SECRET_KEY.getBytes());
            <span class="hljs-comment">// 验证令牌并解析载荷</span>
            <span class="hljs-keyword">return</span> Jwts.parserBuilder()
                    .setSigningKey(key)
                    .build()
                    .parseClaimsJws(token)
                    .getBody();
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-comment">// 令牌无效（过期、被篡改等），返回null</span>
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        }
    }

    <span class="hljs-comment">// 从令牌中获取用户名</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getUsernameFromToken</span><span class="hljs-params">(String token)</span> {
        <span class="hljs-type">Claims</span> <span class="hljs-variable">claims</span> <span class="hljs-operator">=</span> verifyToken(token);
        <span class="hljs-keyword">return</span> claims == <span class="hljs-literal">null</span> ? <span class="hljs-literal">null</span> : claims.getSubject();
    }
}
</code></pre>
<h6 data-id="heading-12">（3）JWT 登录与验证接口</h6>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@WebServlet("/jwt/login")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JwtLoginServlet</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">HttpServlet</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doPost</span><span class="hljs-params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="hljs-keyword">throws</span> ServletException, IOException {
        req.setCharacterEncoding(<span class="hljs-string">"UTF-8"</span>);
        resp.setContentType(<span class="hljs-string">"application/json;charset=UTF-8"</span>);

        <span class="hljs-type">String</span> <span class="hljs-variable">username</span> <span class="hljs-operator">=</span> req.getParameter(<span class="hljs-string">"username"</span>);
        <span class="hljs-type">String</span> <span class="hljs-variable">password</span> <span class="hljs-operator">=</span> req.getParameter(<span class="hljs-string">"password"</span>);

        <span class="hljs-comment">// 模拟账号密码验证</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-string">"admin"</span>.equals(username) &amp;&amp; <span class="hljs-string">"123456"</span>.equals(password)) {
            <span class="hljs-comment">// 生成JWT令牌</span>
            <span class="hljs-type">String</span> <span class="hljs-variable">token</span> <span class="hljs-operator">=</span> JwtUtil.generateToken(username);
            <span class="hljs-comment">// 返回令牌给客户端</span>
            resp.getWriter().write(<span class="hljs-string">"{"</span>code<span class="hljs-string">":200,"</span>msg<span class="hljs-string">":"</span>登录成功<span class="hljs-string">","</span>data<span class="hljs-string">":"</span><span class="hljs-string">" + token + "</span><span class="hljs-string">"}"</span>);
            <span class="hljs-keyword">return</span>;
        }

        resp.getWriter().write(<span class="hljs-string">"{"</span>code<span class="hljs-string">":500,"</span>msg<span class="hljs-string">":"</span>账号或密码错误<span class="hljs-string">"}"</span>);
    }
}

<span class="hljs-meta">@WebServlet("/jwt/emp/list")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JwtEmpListServlet</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">HttpServlet</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doGet</span><span class="hljs-params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="hljs-keyword">throws</span> ServletException, IOException {
        resp.setContentType(<span class="hljs-string">"application/json;charset=UTF-8"</span>);

        <span class="hljs-comment">// 获取请求头中的JWT令牌</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">authorization</span> <span class="hljs-operator">=</span> req.getHeader(<span class="hljs-string">"Authorization"</span>);
        <span class="hljs-keyword">if</span> (authorization == <span class="hljs-literal">null</span> || !authorization.startsWith(<span class="hljs-string">"Bearer "</span>)) {
            resp.getWriter().write(<span class="hljs-string">"{"</span>code<span class="hljs-string">":401,"</span>msg<span class="hljs-string">":"</span>请先登录<span class="hljs-string">"}"</span>);
            <span class="hljs-keyword">return</span>;
        }

        <span class="hljs-comment">// 提取令牌（去除"Bearer "前缀）</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">token</span> <span class="hljs-operator">=</span> authorization.substring(<span class="hljs-number">7</span>);
        <span class="hljs-comment">// 验证令牌并获取用户名</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">username</span> <span class="hljs-operator">=</span> JwtUtil.getUsernameFromToken(token);
        <span class="hljs-keyword">if</span> (username == <span class="hljs-literal">null</span>) {
            resp.getWriter().write(<span class="hljs-string">"{"</span>code<span class="hljs-string">":401,"</span>msg<span class="hljs-string">":"</span>令牌无效或已过期<span class="hljs-string">"}"</span>);
            <span class="hljs-keyword">return</span>;
        }

        <span class="hljs-comment">// 令牌有效：返回员工列表</span>
        resp.getWriter().write(<span class="hljs-string">"{"</span>code<span class="hljs-string">":200,"</span>data<span class="hljs-string">":[{"</span>id<span class="hljs-string">":1,"</span>name<span class="hljs-string">":"</span>张三<span class="hljs-string">"},{"</span>id<span class="hljs-string">":2,"</span>name<span class="hljs-string">":"</span>李四<span class="hljs-string">"}]}"</span>);
    }
}
</code></pre>
<h5 data-id="heading-13">JWT 的优缺点</h5>





















<table><thead><tr><th>优点</th><th>缺点</th></tr></thead><tbody><tr><td>无状态（服务器无需存储会话信息，降低服务器压力）</td><td>安全性较低（令牌存储在客户端，若泄露可能被恶意使用，需配合 HTTPS）</td></tr><tr><td>支持跨域（令牌通过请求头携带，不受跨域限制）</td><td>令牌一旦生成，无法主动作废（除非设置短期过期，或维护黑名单）</td></tr><tr><td>支持分布式部署（任意服务器均可通过密钥验证令牌，无需 Session 共享）</td><td>载荷部分 Base64 编码（非加密），敏感信息不可直接存储</td></tr></tbody></table>
<h2 data-id="heading-14">三、请求拦截：实现全局登录验证</h2>
<p>无论是 Session-Cookie 还是 JWT，若每个接口都单独编写身份验证逻辑，会造成代码冗余。此时需要 <strong>过滤器（Filter）</strong> 和 <strong>拦截器（Interceptor）</strong> 实现全局请求拦截，统一处理登录验证。</p>
<h4 data-id="heading-15">1. 过滤器（Filter）：Servlet 规范中的全局拦截</h4>
<p>Filter 是 Java Servlet 规范定义的组件，运行在 Servlet 之前，可对请求和响应进行统一拦截处理，支持对所有 Web 资源（Servlet、JSP、静态资源）进行过滤。</p>
<h5 data-id="heading-16">实战演示：JWT 全局验证过滤器</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.tgt.filters;

<span class="hljs-keyword">import</span> cn.hutool.core.util.StrUtil;
<span class="hljs-keyword">import</span> com.tgt.utils.JwtUtils;
<span class="hljs-keyword">import</span> io.jsonwebtoken.Claims;
<span class="hljs-keyword">import</span> jakarta.servlet.*;
<span class="hljs-keyword">import</span> jakarta.servlet.annotation.WebFilter;
<span class="hljs-keyword">import</span> jakarta.servlet.http.HttpServletRequest;
<span class="hljs-keyword">import</span> jakarta.servlet.http.HttpServletResponse;
<span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;

<span class="hljs-keyword">import</span> java.io.IOException;

<span class="hljs-meta">@Slf4j</span>
<span class="hljs-meta">@WebFilter("/*")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LoginFilter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Filter</span> {

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doFilter</span><span class="hljs-params">(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain)</span> <span class="hljs-keyword">throws</span> IOException, ServletException {
        <span class="hljs-comment">//1.获取请求url。</span>
        <span class="hljs-comment">// servletRequest.getRequestURI() 这个api是子接口HttpServletRequest才有</span>
        <span class="hljs-comment">// 将父接口 ServletRequest 转换为 子接口HttpServletRequest</span>
        <span class="hljs-type">HttpServletRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> (HttpServletRequest) servletRequest;
        <span class="hljs-type">HttpServletResponse</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> (HttpServletResponse) servletResponse;
        <span class="hljs-type">String</span> <span class="hljs-variable">uri</span> <span class="hljs-operator">=</span> request.getRequestURI();

        <span class="hljs-comment">//2.判断请求url中是否包含login，</span>
        <span class="hljs-keyword">if</span> (uri.contains(<span class="hljs-string">"/login"</span>)){
            <span class="hljs-comment">//如果包含，说明是登录操作，放行。</span>
            filterChain.doFilter(request,response);

            <span class="hljs-keyword">return</span>;
        }

        <span class="hljs-comment">//3.获取请求头中的令牌（token）</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">token</span> <span class="hljs-operator">=</span> request.getHeader(<span class="hljs-string">"token"</span>);

        <span class="hljs-comment">//4.判断令牌是否存在，如果不存在，响应401。</span>
        <span class="hljs-keyword">if</span> (StrUtil.isEmpty(token)){
            response.setStatus(<span class="hljs-number">401</span>);

            <span class="hljs-keyword">return</span>;
        }

        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">//5.解析token，如果解析失败，响应401</span>
            <span class="hljs-type">Claims</span> <span class="hljs-variable">claims</span> <span class="hljs-operator">=</span> JwtUtils.parseJWT(token);<span class="hljs-comment">//如果篡改或过期会发生异常</span>
            
            <span class="hljs-comment">//6.放行。</span>
            filterChain.doFilter(request,response);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            log.error(<span class="hljs-string">"登录校验失败，解析token失败："</span>,e);

            <span class="hljs-comment">//解析token失败 返回401</span>
            response.setStatus(<span class="hljs-number">401</span>);
        }
    }
}
</code></pre>
<h4 data-id="heading-17">2. 拦截器（Interceptor）：Spring 框架中的全局拦截</h4>
<p>Interceptor 是 Spring MVC 框架提供的组件，运行在 Controller 方法执行前后，仅对 Controller 请求进行拦截，功能更灵活（支持 Spring 容器管理，可注入 Service 等 Bean）。</p>
<h5 data-id="heading-18">实战演示：Spring MVC JWT 拦截器</h5>
<h6 data-id="heading-19">（1）编写 JWT 拦截器</h6>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> cn.hutool.core.util.StrUtil;
<span class="hljs-keyword">import</span> com.tgt.utils.JwtUtils;
<span class="hljs-keyword">import</span> io.jsonwebtoken.Claims;
<span class="hljs-keyword">import</span> jakarta.servlet.http.HttpServletRequest;
<span class="hljs-keyword">import</span> jakarta.servlet.http.HttpServletResponse;
<span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Component;
<span class="hljs-keyword">import</span> org.springframework.web.servlet.HandlerInterceptor;

<span class="hljs-meta">@Component</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LoginInterceptors</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">HandlerInterceptor</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">preHandle</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="hljs-keyword">throws</span> Exception {

        <span class="hljs-comment">//3.获取请求头中的令牌（token）</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">token</span> <span class="hljs-operator">=</span> request.getHeader(<span class="hljs-string">"token"</span>);

        <span class="hljs-comment">//4.判断令牌是否存在，如果不存在，响应401。</span>
        <span class="hljs-keyword">if</span> (StrUtil.isEmpty(token)){
            response.setStatus(<span class="hljs-number">401</span>);

            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }

        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">//5.解析token，如果解析失败，响应401</span>
            <span class="hljs-type">Claims</span> <span class="hljs-variable">claims</span> <span class="hljs-operator">=</span> JwtUtils.parseJWT(token);<span class="hljs-comment">//如果篡改或过期会发生异常</span>

            <span class="hljs-type">Integer</span> <span class="hljs-variable">empId</span> <span class="hljs-operator">=</span> Integer.valueOf(claims.get(<span class="hljs-string">"empId"</span>).toString());

            log.info(<span class="hljs-string">"登录成功，用户id为：{}"</span>,empId);

            <span class="hljs-comment">//6.放行。</span>
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        } <span class="hljs-keyword">catch</span> (Exception e) {
            log.error(<span class="hljs-string">"登录校验失败，解析token失败："</span>,e);

            <span class="hljs-comment">//解析token失败 返回401</span>
            response.setStatus(<span class="hljs-number">401</span>);
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
    }
}
</code></pre>
<h6 data-id="heading-20">（2）配置拦截器（Spring MVC 配置类）</h6>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WebConfig</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">WebMvcConfigurer</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> LoginInterceptors loginInterceptors;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addInterceptors</span><span class="hljs-params">(InterceptorRegistry registry)</span> {
        <span class="hljs-comment">//注册拦截器并绑定拦截路径，注意 是两个*,代表任意路径</span>
        registry.addInterceptor(loginInterceptors)
                .addPathPatterns(<span class="hljs-string">"/**"</span>)
                .excludePathPatterns(<span class="hljs-string">"/login"</span>);
    }
}
</code></pre>
<h4 data-id="heading-21">3. 过滤器 vs 拦截器：核心区别</h4>








































<table><thead><tr><th>对比维度</th><th>过滤器（Filter）</th><th>拦截器（Interceptor）</th></tr></thead><tbody><tr><td>所属规范</td><td>Servlet 规范（Java EE 标准）</td><td>Spring MVC 框架自定义</td></tr><tr><td>拦截范围</td><td>所有 Web 资源（Servlet、JSP、静态资源）</td><td>仅拦截 Controller 请求</td></tr><tr><td>执行时机</td><td>运行在 Servlet 容器层面，早于 Interceptor</td><td>运行在 Spring MVC 层面，晚于 Filter</td></tr><tr><td>依赖容器</td><td>不依赖 Spring 容器，可独立使用</td><td>依赖 Spring 容器，可注入 Bean（Service/Mapper）</td></tr><tr><td>执行次数</td><td>一次请求只执行一次</td><td>若存在视图转发，会执行多次</td></tr><tr><td>功能灵活性</td><td>功能单一，仅支持请求 / 响应拦截</td><td>功能丰富，支持前置拦截、后置处理、视图渲染后处理</td></tr></tbody></table>
<h2 data-id="heading-22">四、完整登录验证流程（实战总结）</h2>
<p>以 “JWT + 拦截器” 为例，完整的登录验证流程如下：</p>
<ol>
<li>
<p><strong>用户登录</strong>：前端提交账号密码到<code>/jwt/login</code>接口，后端验证通过后生成 JWT 令牌，返回给前端；</p>
</li>
<li>
<p><strong>前端存储令牌</strong>：前端将 JWT 令牌存储在 LocalStorage 中；</p>
</li>
<li>
<p><strong>前端发起请求</strong>：前端后续访问核心接口（如<code>/emp/list</code>）时，通过<code>Authorization</code>请求头携带 JWT 令牌；</p>
</li>
<li>
<p><strong>全局拦截验证</strong>：后端拦截器拦截请求，提取并验证 JWT 令牌；</p>
</li>
<li>
<p><strong>请求放行 / 拦截</strong>：</p>
<ul>
<li>令牌有效：放行请求，Controller 处理业务并返回数据；</li>
<li>令牌无效 / 未携带：拦截请求，返回 401 未授权提示，前端跳转至登录页。</li>
</ul>
</li>
</ol>
<h2 data-id="heading-23">五、登录验证最佳实践</h2>
<ol>
<li>
<p><strong>令牌安全存储</strong>：</p>
<ul>
<li>JWT 令牌优先存储在<code>HttpOnly</code> Cookie 中（防止 XSS 攻击），其次存储在 LocalStorage（需做 XSS 防护）；</li>
<li>敏感信息不存储在 JWT 载荷中（载荷仅 Base64 编码，可被解码）。</li>
</ul>
</li>
<li>
<p><strong>设置合理过期时间</strong>：</p>
<ul>
<li>短期令牌：访问令牌（Access Token）过期时间设为 1 小时，减少令牌泄露风险；</li>
<li>长期令牌：刷新令牌（Refresh Token）过期时间设为 7 天，用于过期后重新获取访问令牌，无需用户重复登录。</li>
</ul>
</li>
<li>
<p><strong>HTTPS 传输</strong>：所有请求（尤其是登录请求和携带令牌的请求）使用 HTTPS 协议，防止令牌被中间人劫持。</p>
</li>
<li>
<p><strong>避免匿名访问</strong>：除登录接口、静态资源外，所有核心接口均需拦截验证，禁止匿名访问。</p>
</li>
<li>
<p><strong>令牌黑名单机制</strong>：若用户退出登录（令牌未过期），后端需维护 JWT 黑名单，拦截已注销的令牌。</p>
</li>
</ol>
<h2 data-id="heading-24">六、总结与拓展</h2>
<p>本文全面讲解了登录验证的核心技术，包括 Session-Cookie、JWT 两种会话方案，以及 Filter、Interceptor 两种全局拦截方案，核心要点总结：</p>
<ol>
<li><strong>会话方案选择</strong>：传统单体应用可使用 Session-Cookie，分布式 / 跨域应用优先使用 JWT；</li>
<li><strong>拦截方案选择</strong>：简单场景用 Filter，Spring Boot/Spring MVC 项目优先用 Interceptor（更灵活）；</li>
<li><strong>安全核心</strong>：令牌存储需防 XSS、传输需用 HTTPS、过期时间需合理设置；</li>
<li><strong>代码规范</strong>：全局拦截统一处理登录验证，避免接口内重复编写验证逻辑。</li>
</ol>
<h4 data-id="heading-25">拓展方向：</h4>
<ul>
<li><strong>权限细化</strong>：基于 RBAC 模型（角色 - 权限 - 用户），实现 “基于角色的访问控制”（如管理员可删除部门，普通用户仅可查看）；</li>
<li><strong>单点登录（SSO）</strong> ：基于 JWT 或 CAS 协议，实现多系统统一登录（一次登录，多系统免登）；</li>
<li><strong>令牌刷新机制</strong>：实现 Access Token 过期后，通过 Refresh Token 自动刷新令牌，提升用户体验；</li>
<li><strong>防暴力破解</strong>：登录接口添加验证码、限流机制，防止恶意账号密码爆破。</li>
</ul>
<p>登录验证是 Web 系统安全的基石，掌握本文的核心技术，可搭建一套高效、安全的登录验证体系，为系统的稳定运行提供保障。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[ShardingSphere-JDBC 实战指南]]></title>    <link>https://juejin.cn/post/7590433626560266275</link>    <guid>https://juejin.cn/post/7590433626560266275</guid>    <pubDate>2026-01-03T13:36:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590433626560266275" data-draft-id="7590433626560167971" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="ShardingSphere-JDBC 实战指南"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-03T13:36:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="GKunLi"/> <meta itemprop="url" content="https://juejin.cn/user/430664725579725"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            ShardingSphere-JDBC 实战指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/430664725579725/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    GKunLi
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-03T13:36:21.000Z" title="Sat Jan 03 2026 13:36:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读18分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">目录</h2>
<ul>
<li><a href="#%E4%B8%80%E5%89%8D%E8%A8%80" title="#%E4%B8%80%E5%89%8D%E8%A8%80">一、前言</a></li>
<li><a href="#%E4%BA%8C%E4%BB%80%E4%B9%88%E6%98%AFshardingsphere-jdbc" title="#%E4%BA%8C%E4%BB%80%E4%B9%88%E6%98%AFshardingsphere-jdbc">二、什么是ShardingSphere-JDBC</a></li>
<li><a href="#%E4%B8%89%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8" title="#%E4%B8%89%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8">三、为什么需要分库分表</a></li>
<li><a href="#%E5%9B%9B%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5" title="#%E5%9B%9B%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5">四、核心概念</a></li>
<li><a href="#%E4%BA%94%E5%BF%AB%E9%80%9F%E5%BC%80%E5%A7%8B" title="#%E4%BA%94%E5%BF%AB%E9%80%9F%E5%BC%80%E5%A7%8B">五、快速开始</a></li>
<li><a href="#%E5%85%AD%E5%88%86%E7%89%87%E7%AD%96%E7%95%A5%E8%AF%A6%E8%A7%A3" title="#%E5%85%AD%E5%88%86%E7%89%87%E7%AD%96%E7%95%A5%E8%AF%A6%E8%A7%A3">六、分片策略详解</a></li>
<li><a href="#%E4%B8%83%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7" title="#%E4%B8%83%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7">七、高级特性</a></li>
<li><a href="#%E5%85%AB%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5" title="#%E5%85%AB%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5">八、生产环境最佳实践</a></li>
<li><a href="#%E4%B9%9D%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98%E4%B8%8E%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88" title="#%E4%B9%9D%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98%E4%B8%8E%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88">九、常见问题与解决方案</a></li>
</ul>
<hr/>
<h2 data-id="heading-1">一、前言</h2>
<p>随着业务数据量的增长,单库单表逐渐无法满足高并发、大数据量的需求。分库分表成为解决这一问题的有效方案。</p>
<p>ShardingSphere是Apache旗下的开源分布式数据库中间件,本文档基于实际项目,讲解ShardingSphere-JDBC的配置和使用方法。</p>
<hr/>
<h2 data-id="heading-2">二、什么是ShardingSphere-JDBC</h2>
<p>ShardingSphere-JDBC是Apache ShardingSphere的核心产品,定位为轻量级Java框架,在JDBC层提供分库分表服务。</p>
<p><strong>核心特点:</strong></p>
<ul>
<li><strong>透明化</strong> - 对业务代码零侵入,就像使用普通JDBC一样</li>
<li><strong>轻量级</strong> - 无需额外部署,仅作为JDBC驱动存在</li>
<li><strong>配置简单</strong> - 通过YAML配置即可实现分库分表</li>
</ul>
<p><strong>适用场景:</strong></p>
<ul>
<li>需要分库分表的应用</li>
<li>基于MyBatis、JPA等ORM框架的应用</li>
</ul>
<hr/>
<h2 data-id="heading-3">三、为什么需要分库分表</h2>
<h3 data-id="heading-4">3.1 单库单表的瓶颈</h3>
<p>当数据量达到千万级时,会遇到以下问题:</p>
<ol>
<li><strong>性能瓶颈</strong> - 单表数据量大,查询变慢</li>
<li><strong>存储瓶颈</strong> - 磁盘IO成为瓶颈</li>
<li><strong>连接限制</strong> - 数据库连接数不足</li>
</ol>
<h3 data-id="heading-5">3.2 分库分表的优势</h3>
<ol>
<li><strong>提升性能</strong> - 单表数据量减少,查询速度提升</li>
<li><strong>提高并发</strong> - 多库分担读写压力</li>
<li><strong>易于扩展</strong> - 可以动态增加数据源</li>
</ol>
<hr/>
<h2 data-id="heading-6">四、核心概念</h2>
<h3 data-id="heading-7">4.1 逻辑表与物理表</h3>
<p><strong>逻辑表</strong> - 应用层看到的表,比如<code>t_user</code></p>
<p><strong>物理表</strong> - 实际存储在数据库中的表,比如<code>t_user_0</code>、<code>t_user_1</code></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">t_user:</span>  <span class="hljs-comment"># 逻辑表</span>
  <span class="hljs-attr">actual-data-nodes:</span> <span class="hljs-string">ds$-&gt;{0..1}.t_user_$-&gt;{0..1}</span>  <span class="hljs-comment"># 物理表</span>
</code></pre>
<h3 data-id="heading-8">4.2 分片键</h3>
<p>决定数据路由到哪个分片的字段,必须包含在SQL中才能正确路由。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 正确:包含分片键,精确路由</span>
SELECT * FROM t_user <span class="hljs-type">WHERE</span> <span class="hljs-variable">user_id</span> <span class="hljs-operator">=</span> <span class="hljs-number">100</span>;

<span class="hljs-comment">// 错误:不包含分片键,全路由(查询所有分片)</span>
SELECT * FROM t_user <span class="hljs-type">WHERE</span> <span class="hljs-variable">username</span> <span class="hljs-operator">=</span> <span class="hljs-string">'zhangsan'</span>;
</code></pre>
<h3 data-id="heading-9">4.3 分片算法</h3>
<p>ShardingSphere通过分片算法决定数据路由到哪个分片。</p>




















<table><thead><tr><th>算法类型</th><th>说明</th><th>适用场景</th></tr></thead><tbody><tr><td>INLINE</td><td>基于Groovy表达式的简单算法</td><td>简单的取模分片</td></tr><tr><td>STANDARD</td><td>标准分片算法</td><td>需要精确和范围查询</td></tr></tbody></table>
<p><strong>本项目使用INLINE算法</strong>,配置简单,性能优秀。</p>
<h3 data-id="heading-10">4.4 主键生成器</h3>
<p>分布式环境下,需要全局唯一的主键生成策略。</p>















<table><thead><tr><th>生成器类型</th><th>说明</th><th>特点</th></tr></thead><tbody><tr><td>SNOWFLAKE</td><td>雪花算法</td><td>分布式、高性能、趋势递增</td></tr></tbody></table>
<h3 data-id="heading-11">4.5 广播表</h3>
<p>在所有数据源中都存在的表,数据完全一致。</p>
<p><strong>特点:</strong></p>
<ul>
<li>插入、更新、删除操作会在所有数据源执行</li>
<li>查询操作只在一个数据源执行</li>
<li>适用于字典表、配置表等小表</li>
</ul>
<p><strong>配置示例:</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">broadcast-tables:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">t_dict</span>
</code></pre>
<h3 data-id="heading-12">4.6 绑定表</h3>
<p>多个表使用相同的分片键和分片算法,确保关联数据在同一分片。</p>
<p><strong>配置示例:</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">binding-tables:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">t_order,t_order_item</span>
</code></pre>
<p><strong>优势:</strong></p>
<ul>
<li>避免跨库JOIN</li>
<li>提高查询性能</li>
<li>简化事务处理</li>
</ul>
<hr/>
<h2 data-id="heading-13">五、快速开始</h2>
<h3 data-id="heading-14">5.1 添加依赖</h3>
<p>在<code>pom.xml</code>中添加ShardingSphere-JDBC依赖:</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- ShardingSphere-JDBC核心依赖 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.shardingsphere<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>shardingsphere-jdbc-core-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>5.2.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    
    <span class="hljs-comment">&lt;!-- MySQL驱动 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>mysql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mysql-connector-java<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>runtime<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    
    <span class="hljs-comment">&lt;!-- MyBatis --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.3.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    
    <span class="hljs-comment">&lt;!-- Lombok --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.projectlombok<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>lombok<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.18.38<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>provided<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>
</code></pre>
<h3 data-id="heading-15">5.2 配置数据源</h3>
<p>在<code>application.yml</code>中配置4个数据源:</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">shardingsphere:</span>
    <span class="hljs-attr">datasource:</span>
      <span class="hljs-attr">names:</span> <span class="hljs-string">ds0,ds1,ds2,ds3</span>
      
      <span class="hljs-attr">ds0:</span>
        <span class="hljs-attr">type:</span> <span class="hljs-string">com.zaxxer.hikari.HikariDataSource</span>
        <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">com.mysql.cj.jdbc.Driver</span>
        <span class="hljs-attr">jdbc-url:</span> <span class="hljs-string">jdbc:mysql://127.0.0.1:3306/test_db1?useUnicode=true&amp;characterEncoding=utf8&amp;serverTimezone=GMT%2B8</span>
        <span class="hljs-attr">username:</span> <span class="hljs-string">root</span>
        <span class="hljs-attr">password:</span> <span class="hljs-number">123456</span>
        <span class="hljs-attr">hikari:</span>
          <span class="hljs-attr">minimum-idle:</span> <span class="hljs-number">10</span>
          <span class="hljs-attr">maximum-pool-size:</span> <span class="hljs-number">50</span>
          <span class="hljs-attr">connection-timeout:</span> <span class="hljs-number">30000</span>
          <span class="hljs-attr">idle-timeout:</span> <span class="hljs-number">600000</span>
          <span class="hljs-attr">max-lifetime:</span> <span class="hljs-number">1800000</span>
          <span class="hljs-attr">connection-test-query:</span> <span class="hljs-string">SELECT</span> <span class="hljs-number">1</span>
      
      <span class="hljs-attr">ds1:</span>
        <span class="hljs-attr">type:</span> <span class="hljs-string">com.zaxxer.hikari.HikariDataSource</span>
        <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">com.mysql.cj.jdbc.Driver</span>
        <span class="hljs-attr">jdbc-url:</span> <span class="hljs-string">jdbc:mysql://127.0.0.1:3306/test_db2?useUnicode=true&amp;characterEncoding=utf8&amp;serverTimezone=GMT%2B8</span>
        <span class="hljs-attr">username:</span> <span class="hljs-string">root</span>
        <span class="hljs-attr">password:</span> <span class="hljs-number">123456</span>
        <span class="hljs-attr">hikari:</span>
          <span class="hljs-attr">minimum-idle:</span> <span class="hljs-number">10</span>
          <span class="hljs-attr">maximum-pool-size:</span> <span class="hljs-number">50</span>
          <span class="hljs-attr">connection-timeout:</span> <span class="hljs-number">30000</span>
          <span class="hljs-attr">idle-timeout:</span> <span class="hljs-number">600000</span>
          <span class="hljs-attr">max-lifetime:</span> <span class="hljs-number">1800000</span>
          <span class="hljs-attr">connection-test-query:</span> <span class="hljs-string">SELECT</span> <span class="hljs-number">1</span>
      
      <span class="hljs-attr">ds2:</span>
        <span class="hljs-attr">type:</span> <span class="hljs-string">com.zaxxer.hikari.HikariDataSource</span>
        <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">com.mysql.cj.jdbc.Driver</span>
        <span class="hljs-attr">jdbc-url:</span> <span class="hljs-string">jdbc:mysql://127.0.0.1:3306/test_db3?useUnicode=true&amp;characterEncoding=utf8&amp;serverTimezone=GMT%2B8</span>
        <span class="hljs-attr">username:</span> <span class="hljs-string">root</span>
        <span class="hljs-attr">password:</span> <span class="hljs-number">123456</span>
        <span class="hljs-attr">hikari:</span>
          <span class="hljs-attr">minimum-idle:</span> <span class="hljs-number">10</span>
          <span class="hljs-attr">maximum-pool-size:</span> <span class="hljs-number">50</span>
          <span class="hljs-attr">connection-timeout:</span> <span class="hljs-number">30000</span>
          <span class="hljs-attr">idle-timeout:</span> <span class="hljs-number">600000</span>
          <span class="hljs-attr">max-lifetime:</span> <span class="hljs-number">1800000</span>
          <span class="hljs-attr">connection-test-query:</span> <span class="hljs-string">SELECT</span> <span class="hljs-number">1</span>
      
      <span class="hljs-attr">ds3:</span>
        <span class="hljs-attr">type:</span> <span class="hljs-string">com.zaxxer.hikari.HikariDataSource</span>
        <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">com.mysql.cj.jdbc.Driver</span>
        <span class="hljs-attr">jdbc-url:</span> <span class="hljs-string">jdbc:mysql://127.0.0.1:3306/test_db4?useUnicode=true&amp;characterEncoding=utf8&amp;serverTimezone=GMT%2B8</span>
        <span class="hljs-attr">username:</span> <span class="hljs-string">root</span>
        <span class="hljs-attr">password:</span> <span class="hljs-number">123456</span>
        <span class="hljs-attr">hikari:</span>
          <span class="hljs-attr">minimum-idle:</span> <span class="hljs-number">10</span>
          <span class="hljs-attr">maximum-pool-size:</span> <span class="hljs-number">50</span>
          <span class="hljs-attr">connection-timeout:</span> <span class="hljs-number">30000</span>
          <span class="hljs-attr">idle-timeout:</span> <span class="hljs-number">600000</span>
          <span class="hljs-attr">max-lifetime:</span> <span class="hljs-number">1800000</span>
          <span class="hljs-attr">connection-test-query:</span> <span class="hljs-string">SELECT</span> <span class="hljs-number">1</span>
</code></pre>
<p><strong>配置说明:</strong></p>
<ul>
<li><code>names</code> - 定义所有数据源的名称</li>
<li><code>hikari</code> - HikariCP连接池配置
<ul>
<li><code>minimum-idle</code> - 最小空闲连接数</li>
<li><code>maximum-pool-size</code> - 最大连接池大小</li>
<li><code>connection-timeout</code> - 连接超时时间(毫秒)</li>
</ul>
</li>
</ul>
<h3 data-id="heading-16">5.3 配置分片规则</h3>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">shardingsphere:</span>
    <span class="hljs-attr">rules:</span>
      <span class="hljs-attr">sharding:</span>
        <span class="hljs-attr">tables:</span>
          <span class="hljs-comment"># 用户表配置</span>
          <span class="hljs-attr">t_user:</span>
            <span class="hljs-comment"># 实际数据节点: ds0.t_user_0, ds0.t_user_1, ds1.t_user_0, ds1.t_user_1</span>
            <span class="hljs-attr">actual-data-nodes:</span> <span class="hljs-string">ds$-&gt;{0..1}.t_user_$-&gt;{0..1}</span>
            
            <span class="hljs-comment"># 分库策略</span>
            <span class="hljs-attr">database-strategy:</span>
              <span class="hljs-attr">standard:</span>
                <span class="hljs-attr">sharding-column:</span> <span class="hljs-string">user_id</span>
                <span class="hljs-attr">sharding-algorithm-name:</span> <span class="hljs-string">user-db-inline</span>
            
            <span class="hljs-comment"># 分表策略</span>
            <span class="hljs-attr">table-strategy:</span>
              <span class="hljs-attr">standard:</span>
                <span class="hljs-attr">sharding-column:</span> <span class="hljs-string">user_id</span>
                <span class="hljs-attr">sharding-algorithm-name:</span> <span class="hljs-string">user-table-inline</span>
            
            <span class="hljs-comment"># 主键生成策略</span>
            <span class="hljs-attr">key-generate-strategy:</span>
              <span class="hljs-attr">column:</span> <span class="hljs-string">user_id</span>
              <span class="hljs-attr">key-generator-name:</span> <span class="hljs-string">snowflake</span>
</code></pre>
<p><strong>配置说明:</strong></p>
<ul>
<li><code>actual-data-nodes</code> - 定义物理表的分布
<ul>
<li><code>ds$-&gt;{0..1}</code> - 表示ds0和ds1两个数据源</li>
<li><code>t_user_$-&gt;{0..1}</code> - 表示t_user_0和t_user_1两个表</li>
<li>组合后: ds0.t_user_0, ds0.t_user_1, ds1.t_user_0, ds1.t_user_1</li>
</ul>
</li>
</ul>
<h3 data-id="heading-17">5.4 配置分片算法</h3>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">shardingsphere:</span>
    <span class="hljs-attr">rules:</span>
      <span class="hljs-attr">sharding:</span>
        <span class="hljs-attr">sharding-algorithms:</span>
          <span class="hljs-comment"># 用户表分库算法</span>
          <span class="hljs-attr">user-db-inline:</span>
            <span class="hljs-attr">type:</span> <span class="hljs-string">INLINE</span>
            <span class="hljs-attr">props:</span>
              <span class="hljs-attr">algorithm-expression:</span> <span class="hljs-string">'ds$-&gt;{ (Math.abs(user_id.hashCode()) % 4).intdiv(2) }'</span>
          
          <span class="hljs-comment"># 用户表分表算法</span>
          <span class="hljs-attr">user-table-inline:</span>
            <span class="hljs-attr">type:</span> <span class="hljs-string">INLINE</span>
            <span class="hljs-attr">props:</span>
              <span class="hljs-attr">algorithm-expression:</span> <span class="hljs-string">'t_user_$-&gt;{ Math.abs(user_id.hashCode()) % 2 }'</span>
</code></pre>
<p><strong>算法说明:</strong></p>
<ol>
<li>
<p><strong>分库算法</strong>: <code>ds$-&gt;{ (Math.abs(user_id.hashCode()) % 4).intdiv(2) }</code></p>
<ul>
<li>计算user_id的hashCode取绝对值</li>
<li>对4取模,得到0、1、2、3</li>
<li>整除2,得到0、1</li>
<li>最终路由到ds0或ds1</li>
</ul>
</li>
<li>
<p><strong>分表算法</strong>: <code>t_user_$-&gt;{ Math.abs(user_id.hashCode()) % 2 }</code></p>
<ul>
<li>计算user_id的hashCode取绝对值</li>
<li>对2取模,得到0、1</li>
<li>最终路由到t_user_0或t_user_1</li>
</ul>
</li>
</ol>
<p><strong>数据分布示例:</strong></p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">user_id</span> = <span class="hljs-number">100</span>
- 分库: (100 % 4).intdiv(2) = 0 → ds0
- 分表: 100 % <span class="hljs-attr">2</span> = <span class="hljs-number">0</span> → t_user_0
- 最终路由: ds0.t_user_0
</code></pre>
<h3 data-id="heading-18">5.5 配置主键生成器</h3>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">shardingsphere:</span>
    <span class="hljs-attr">rules:</span>
      <span class="hljs-attr">sharding:</span>
        <span class="hljs-attr">key-generators:</span>
          <span class="hljs-attr">snowflake:</span>
            <span class="hljs-attr">type:</span> <span class="hljs-string">SNOWFLAKE</span>
</code></pre>
<p><strong>雪花算法原理:</strong></p>
<ul>
<li>1位符号位</li>
<li>41位时间戳(毫秒级)</li>
<li>10位机器ID</li>
<li>12位序列号</li>
</ul>
<h3 data-id="heading-19">5.6 配置广播表和绑定表</h3>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">shardingsphere:</span>
    <span class="hljs-attr">rules:</span>
      <span class="hljs-attr">sharding:</span>
        <span class="hljs-comment"># 绑定表配置</span>
        <span class="hljs-attr">binding-tables:</span>
          <span class="hljs-bullet">-</span> <span class="hljs-string">t_order,t_order_item</span>
        
        <span class="hljs-comment"># 广播表配置</span>
        <span class="hljs-attr">broadcast-tables:</span>
          <span class="hljs-bullet">-</span> <span class="hljs-string">t_dict</span>
</code></pre>
<h3 data-id="heading-20">5.7 配置属性</h3>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">shardingsphere:</span>
    <span class="hljs-attr">props:</span>
      <span class="hljs-comment"># 显示SQL(生产环境建议关闭)</span>
      <span class="hljs-attr">sql-show:</span> <span class="hljs-literal">true</span>
      <span class="hljs-comment"># 允许没有分片列的插入通过主键生成器</span>
      <span class="hljs-attr">check-table-metadata-enabled:</span> <span class="hljs-literal">false</span>
</code></pre>
<h3 data-id="heading-21">5.8 创建实体类</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.demo.model;

<span class="hljs-keyword">import</span> lombok.Data;
<span class="hljs-keyword">import</span> java.time.LocalDateTime;

<span class="hljs-meta">@Data</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> {
    
    <span class="hljs-comment">/**
     * 用户ID(主键,由ShardingSphere自动生成)
     */</span>
    <span class="hljs-keyword">private</span> Long userId;
    
    <span class="hljs-comment">/**
     * 用户名
     */</span>
    <span class="hljs-keyword">private</span> String username;
    
    <span class="hljs-comment">/**
     * 邮箱
     */</span>
    <span class="hljs-keyword">private</span> String email;
    
    <span class="hljs-comment">/**
     * 年龄
     */</span>
    <span class="hljs-keyword">private</span> Integer age;
    
    <span class="hljs-comment">/**
     * 创建时间
     */</span>
    <span class="hljs-keyword">private</span> LocalDateTime createdTime;
    
    <span class="hljs-comment">/**
     * 更新时间
     */</span>
    <span class="hljs-keyword">private</span> LocalDateTime updatedTime;
}
</code></pre>
<h3 data-id="heading-22">5.9 创建Mapper接口</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.demo.mapper;

<span class="hljs-keyword">import</span> com.example.demo.model.User;
<span class="hljs-keyword">import</span> org.apache.ibatis.annotations.*;
<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-meta">@Mapper</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserMapper</span> {
    
    <span class="hljs-comment">/**
     * 插入用户
     * 注意:不包含user_id字段,由ShardingSphere自动生成
     */</span>
    <span class="hljs-meta">@Insert("INSERT INTO t_user (username, email, age) VALUES (#{username}, #{email}, #{age})")</span>
    <span class="hljs-type">int</span> <span class="hljs-title function_">insert</span><span class="hljs-params">(User user)</span>;
    
    <span class="hljs-comment">/**
     * 根据ID更新用户
     */</span>
    <span class="hljs-meta">@Update("UPDATE t_user SET username = #{username}, email = #{email}, age = #{age} WHERE user_id = #{userId}")</span>
    <span class="hljs-type">int</span> <span class="hljs-title function_">updateById</span><span class="hljs-params">(User user)</span>;
    
    <span class="hljs-comment">/**
     * 根据ID查询用户
     */</span>
    <span class="hljs-meta">@Select("SELECT * FROM t_user WHERE user_id = #{userId}")</span>
    User <span class="hljs-title function_">selectById</span><span class="hljs-params">(Long userId)</span>;
    
    <span class="hljs-comment">/**
     * 根据用户名查询用户
     * 注意:此查询不包含分片键,会导致全路由
     */</span>
    <span class="hljs-meta">@Select("SELECT * FROM t_user WHERE username = #{username}")</span>
    User <span class="hljs-title function_">selectByUsername</span><span class="hljs-params">(String username)</span>;
    
    <span class="hljs-comment">/**
     * 查询所有用户
     * 注意:此查询不包含分片键,会导致全路由
     */</span>
    <span class="hljs-meta">@Select("SELECT * FROM t_user")</span>
    List&lt;User&gt; <span class="hljs-title function_">selectAll</span><span class="hljs-params">()</span>;
    
    <span class="hljs-comment">/**
     * 根据ID删除用户
     */</span>
    <span class="hljs-meta">@Delete("DELETE FROM t_user WHERE user_id = #{userId}")</span>
    <span class="hljs-type">int</span> <span class="hljs-title function_">deleteById</span><span class="hljs-params">(Long userId)</span>;
}
</code></pre>
<p><strong>重要说明:</strong></p>
<ul>
<li>INSERT语句中不包含分片键字段(user_id),由ShardingSphere自动生成</li>
<li>查询语句最好包含分片键,否则会导致全路由,性能较差</li>
</ul>
<h3 data-id="heading-23">5.10 创建Controller层</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.demo.controller;

<span class="hljs-keyword">import</span> com.example.demo.mapper.UserMapper;
<span class="hljs-keyword">import</span> com.example.demo.model.User;
<span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;
<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.*;

<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping("/users")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserController</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> UserMapper userMapper;
    
    <span class="hljs-meta">@PostMapping</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">insert</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> User user)</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> userMapper.insert(user);
        <span class="hljs-keyword">return</span> result &gt; <span class="hljs-number">0</span> ? <span class="hljs-string">"User inserted successfully"</span> : <span class="hljs-string">"Failed to insert user"</span>;
    }
    
    <span class="hljs-meta">@PutMapping</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">update</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> User user)</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> userMapper.updateById(user);
        <span class="hljs-keyword">return</span> result &gt; <span class="hljs-number">0</span> ? <span class="hljs-string">"User updated successfully"</span> : <span class="hljs-string">"Failed to update user"</span>;
    }
    
    <span class="hljs-meta">@GetMapping("/{userId}")</span>
    <span class="hljs-keyword">public</span> User <span class="hljs-title function_">selectById</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long userId)</span> {
        <span class="hljs-keyword">return</span> userMapper.selectById(userId);
    }
    
    <span class="hljs-meta">@GetMapping("/username/{username}")</span>
    <span class="hljs-keyword">public</span> User <span class="hljs-title function_">selectByUsername</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> String username)</span> {
        <span class="hljs-keyword">return</span> userMapper.selectByUsername(username);
    }
    
    <span class="hljs-meta">@GetMapping</span>
    <span class="hljs-keyword">public</span> List&lt;User&gt; <span class="hljs-title function_">selectAll</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> userMapper.selectAll();
    }
    
    <span class="hljs-meta">@DeleteMapping("/{userId}")</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">deleteById</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long userId)</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> userMapper.deleteById(userId);
        <span class="hljs-keyword">return</span> result &gt; <span class="hljs-number">0</span> ? <span class="hljs-string">"User deleted successfully"</span> : <span class="hljs-string">"Failed to delete user"</span>;
    }
}
</code></pre>
<h3 data-id="heading-24">5.11 初始化数据库</h3>
<p>执行SQL脚本创建数据库和表:</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 创建数据库</span>
<span class="hljs-keyword">CREATE</span> DATABASE IF <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span> test_db1 <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8mb4 <span class="hljs-keyword">COLLATE</span> utf8mb4_unicode_ci;
<span class="hljs-keyword">CREATE</span> DATABASE IF <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span> test_db2 <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8mb4 <span class="hljs-keyword">COLLATE</span> utf8mb4_unicode_ci;

<span class="hljs-comment">-- 创建用户表</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span> t_user_0
(
    user_id      <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">PRIMARY</span> KEY,
    username     <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
    email        <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">100</span>),
    age          <span class="hljs-type">INT</span>,
    created_time <span class="hljs-type">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>,
    updated_time <span class="hljs-type">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">UPDATE</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>
) ENGINE <span class="hljs-operator">=</span> InnoDB
  <span class="hljs-keyword">DEFAULT</span> CHARSET <span class="hljs-operator">=</span> utf8mb4
  <span class="hljs-keyword">COLLATE</span> <span class="hljs-operator">=</span> utf8mb4_unicode_ci;

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span> t_user_1
(
    user_id      <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">PRIMARY</span> KEY,
    username     <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
    email        <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">100</span>),
    age          <span class="hljs-type">INT</span>,
    created_time <span class="hljs-type">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>,
    updated_time <span class="hljs-type">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">UPDATE</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>
) ENGINE <span class="hljs-operator">=</span> InnoDB
  <span class="hljs-keyword">DEFAULT</span> CHARSET <span class="hljs-operator">=</span> utf8mb4
  <span class="hljs-keyword">COLLATE</span> <span class="hljs-operator">=</span> utf8mb4_unicode_ci;
</code></pre>
<h3 data-id="heading-25">5.12 启动项目</h3>
<pre><code class="hljs language-bash" lang="bash">mvn spring-boot:run
</code></pre>
<h3 data-id="heading-26">5.13 测试API</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 插入用户</span>
curl -X POST http://localhost:8080/users \
  -H <span class="hljs-string">"Content-Type: application/json"</span> \
  -d <span class="hljs-string">'{"username":"zhangsan","email":"zhangsan@example.com","age":25}'</span>

<span class="hljs-comment"># 根据ID查询用户</span>
curl http://localhost:8080/users/100

<span class="hljs-comment"># 根据用户名查询用户</span>
curl http://localhost:8080/users/username/zhangsan

<span class="hljs-comment"># 查询所有用户</span>
curl http://localhost:8080/users

<span class="hljs-comment"># 更新用户</span>
curl -X PUT http://localhost:8080/users \
  -H <span class="hljs-string">"Content-Type: application/json"</span> \
  -d <span class="hljs-string">'{"userId":100,"username":"lisi","email":"lisi@example.com","age":26}'</span>

<span class="hljs-comment"># 删除用户</span>
curl -X DELETE http://localhost:8080/users/100
</code></pre>
<hr/>
<h2 data-id="heading-27">六、分片策略详解</h2>
<h3 data-id="heading-28">6.1 标准分片策略</h3>
<p>标准分片策略是最常用的分片策略,支持精确分片和范围查询。</p>
<p><strong>配置示例:</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">t_user:</span>
  <span class="hljs-attr">actual-data-nodes:</span> <span class="hljs-string">ds$-&gt;{0..1}.t_user_$-&gt;{0..1}</span>
  <span class="hljs-attr">database-strategy:</span>
    <span class="hljs-attr">standard:</span>
      <span class="hljs-attr">sharding-column:</span> <span class="hljs-string">user_id</span>
      <span class="hljs-attr">sharding-algorithm-name:</span> <span class="hljs-string">user-db-inline</span>
  <span class="hljs-attr">table-strategy:</span>
    <span class="hljs-attr">standard:</span>
      <span class="hljs-attr">sharding-column:</span> <span class="hljs-string">user_id</span>
      <span class="hljs-attr">sharding-algorithm-name:</span> <span class="hljs-string">user-table-inline</span>
</code></pre>
<h3 data-id="heading-29">6.2 行表达式分片算法</h3>
<p>行表达式分片算法是最简单的分片算法,使用Groovy表达式定义分片规则。</p>
<p><strong>配置示例:</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">shardingsphere:</span>
    <span class="hljs-attr">rules:</span>
      <span class="hljs-attr">sharding:</span>
        <span class="hljs-attr">sharding-algorithms:</span>
          <span class="hljs-attr">user-db-inline:</span>
            <span class="hljs-attr">type:</span> <span class="hljs-string">INLINE</span>
            <span class="hljs-attr">props:</span>
              <span class="hljs-attr">algorithm-expression:</span> <span class="hljs-string">'ds$-&gt;{ (Math.abs(user_id.hashCode()) % 4).intdiv(2) }'</span>
          
          <span class="hljs-attr">user-table-inline:</span>
            <span class="hljs-attr">type:</span> <span class="hljs-string">INLINE</span>
            <span class="hljs-attr">props:</span>
              <span class="hljs-attr">algorithm-expression:</span> <span class="hljs-string">'t_user_$-&gt;{ Math.abs(user_id.hashCode()) % 2 }'</span>
</code></pre>
<p><strong>常用表达式:</strong></p>






























<table><thead><tr><th>表达式</th><th>说明</th><th>示例</th></tr></thead><tbody><tr><td><code>$-&gt;{column}</code></td><td>获取分片列的值</td><td><code>user_id</code></td></tr><tr><td><code>$-&gt;{column % n}</code></td><td>取模运算</td><td><code>user_id % 2</code></td></tr><tr><td><code>$-&gt;{Math.abs(column.hashCode())}</code></td><td>取绝对值</td><td><code>Math.abs(user_id.hashCode())</code></td></tr><tr><td><code>$-&gt;{column.intdiv(n)}</code></td><td>整除运算</td><td><code>(user_id % 4).intdiv(2)</code></td></tr></tbody></table>
<p><strong>示例:</strong></p>
<ol>
<li><strong>简单取模</strong></li>
</ol>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">algorithm-expression:</span> <span class="hljs-string">'t_user_$-&gt;{user_id % 2}'</span>
</code></pre>
<ol start="2">
<li><strong>Hash取模</strong></li>
</ol>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">algorithm-expression:</span> <span class="hljs-string">'t_user_$-&gt;{Math.abs(user_id.hashCode()) % 2}'</span>
</code></pre>
<p><strong>注意事项:</strong></p>
<ul>
<li>表达式必须返回字符串</li>
<li>表达式中的变量名必须与分片列名一致</li>
<li>复杂表达式建议使用自定义算法</li>
</ul>
<h3 data-id="heading-30">6.3 本项目分片策略总结</h3>
<p><strong>用户表 (t_user)</strong></p>
<ul>
<li>数据源: ds0, ds1 (对应数据库 test_db1, test_db2)</li>
<li>分片键: user_id</li>
<li>分库策略: 按 user_id % 4 后整除2 (偶数分到ds0, 奇数分到ds1)</li>
<li>分表策略: 按 user_id % 2 分表</li>
<li>表结构: 两个数据源共包含 t_user_0 和 t_user_1 四个分表</li>
</ul>
<p><strong>订单表 (t_order)</strong></p>
<ul>
<li>数据源: ds2, ds3 (对应数据库 test_db3, test_db4)</li>
<li>分片键: order_id</li>
<li>分库算法: 按 order_id % 2 映射到 ds2, ds3</li>
<li>分表算法: 按 order_id % 4 分片</li>
<li>表结构: 每个数据源包含 t_order_0 到 t_order_3 四个分表</li>
</ul>
<p><strong>订单项表 (t_order_item)</strong></p>
<ul>
<li>数据源: ds2, ds3 (对应数据库 test_db3, test_db4)</li>
<li>分片键: order_id</li>
<li>与订单表为绑定表关系</li>
</ul>
<p><strong>广播表 (t_dict)</strong></p>
<ul>
<li>在所有数据源中都存在</li>
<li>数据完全一致</li>
</ul>
<hr/>
<h2 data-id="heading-31">七、高级特性</h2>
<h3 data-id="heading-32">7.1 Hint分片策略</h3>
<p>Hint分片策略通过Hint指定分片，适用于需要强制路由的场景。</p>
<p><strong>使用场景:</strong></p>
<ul>
<li>批量操作时指定分片提高性能</li>
<li>需要强制路由到特定分片的场景</li>
<li>数据迁移场景</li>
</ul>
<p><strong>配置示例:</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">shardingsphere:</span>
    <span class="hljs-attr">rules:</span>
      <span class="hljs-attr">sharding:</span>
        <span class="hljs-attr">tables:</span>
          <span class="hljs-attr">t_order:</span>
            <span class="hljs-attr">actual-data-nodes:</span> <span class="hljs-string">ds$-&gt;{2..3}.t_order_$-&gt;{0..3}</span>
            <span class="hljs-attr">table-strategy:</span>
              <span class="hljs-attr">hint:</span>
                <span class="hljs-attr">sharding-algorithm-name:</span> <span class="hljs-string">order-hint</span>
        
        <span class="hljs-attr">sharding-algorithms:</span>
          <span class="hljs-attr">order-hint:</span>
            <span class="hljs-attr">type:</span> <span class="hljs-string">INLINE</span>
            <span class="hljs-attr">props:</span>
              <span class="hljs-attr">algorithm-expression:</span> <span class="hljs-string">'t_order_$-&gt;{value}'</span>
</code></pre>
<p><strong>使用Hint路由:</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.demo.controller;

<span class="hljs-keyword">import</span> com.example.demo.mapper.OrderMapper;
<span class="hljs-keyword">import</span> com.example.demo.model.Order;
<span class="hljs-keyword">import</span> org.apache.shardingsphere.infra.hint.HintManager;
<span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;
<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.*;

<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping("/orders")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderController</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> OrderMapper orderMapper;
    
    <span class="hljs-comment">/**
     * 使用Hint强制路由到指定分片查询
     * 
     * <span class="hljs-doctag">@param</span> orderId 订单ID
     * <span class="hljs-doctag">@param</span> tableIndex 表索引(0-3)
     * <span class="hljs-doctag">@return</span> 订单对象
     */</span>
    <span class="hljs-meta">@GetMapping("/hint/{orderId}/{tableIndex}")</span>
    <span class="hljs-keyword">public</span> Order <span class="hljs-title function_">selectByHint</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long orderId, <span class="hljs-meta">@PathVariable</span> <span class="hljs-type">int</span> tableIndex)</span> {
        <span class="hljs-keyword">try</span> (<span class="hljs-type">HintManager</span> <span class="hljs-variable">hintManager</span> <span class="hljs-operator">=</span> HintManager.getInstance()) {
            <span class="hljs-comment">// 设置Hint值，指定路由到哪个分片</span>
            hintManager.addTableShardingValue(<span class="hljs-string">"t_order"</span>, tableIndex);
            <span class="hljs-keyword">return</span> orderMapper.selectById(orderId);
        }
    }
    
    <span class="hljs-comment">/**
     * 批量查询，指定多个分片
     * 
     * <span class="hljs-doctag">@param</span> tableIndices 表索引列表(0-3)
     * <span class="hljs-doctag">@return</span> 订单列表
     */</span>
    <span class="hljs-meta">@GetMapping("/hint/batch/{tableIndices}")</span>
    <span class="hljs-keyword">public</span> List&lt;Order&gt; <span class="hljs-title function_">batchSelectByHint</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> List&lt;Integer&gt; tableIndices)</span> {
        <span class="hljs-keyword">try</span> (<span class="hljs-type">HintManager</span> <span class="hljs-variable">hintManager</span> <span class="hljs-operator">=</span> HintManager.getInstance()) {
            <span class="hljs-comment">// 设置多个Hint值</span>
            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> tableIndex : tableIndices) {
                hintManager.addTableShardingValue(<span class="hljs-string">"t_order"</span>, tableIndex);
            }
            <span class="hljs-keyword">return</span> orderMapper.selectAll();
        }
    }
}
</code></pre>
<p><strong>注意事项:</strong></p>
<ul>
<li>HintManager使用后需要关闭，可以使用try-with-resources</li>
<li>Hint只在当前线程有效</li>
<li>Hint优先级高于其他分片策略</li>
</ul>
<h3 data-id="heading-33">7.2 读写分离</h3>
<p>读写分离是提升系统性能的重要手段，将读操作分发到从库，写操作在主库执行。</p>
<p><strong>配置示例:</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">shardingsphere:</span>
    <span class="hljs-attr">datasource:</span>
      <span class="hljs-attr">names:</span> <span class="hljs-string">master,slave0,slave1</span>
      
      <span class="hljs-comment"># 主库配置</span>
      <span class="hljs-attr">master:</span>
        <span class="hljs-attr">type:</span> <span class="hljs-string">com.zaxxer.hikari.HikariDataSource</span>
        <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">com.mysql.cj.jdbc.Driver</span>
        <span class="hljs-attr">jdbc-url:</span> <span class="hljs-string">jdbc:mysql://127.0.0.1:3306/test_db?useUnicode=true&amp;characterEncoding=utf8&amp;serverTimezone=GMT%2B8</span>
        <span class="hljs-attr">username:</span> <span class="hljs-string">root</span>
        <span class="hljs-attr">password:</span> <span class="hljs-number">123456</span>
        <span class="hljs-attr">hikari:</span>
          <span class="hljs-attr">minimum-idle:</span> <span class="hljs-number">10</span>
          <span class="hljs-attr">maximum-pool-size:</span> <span class="hljs-number">50</span>
          <span class="hljs-attr">connection-timeout:</span> <span class="hljs-number">30000</span>
      
      <span class="hljs-comment"># 从库0配置</span>
      <span class="hljs-attr">slave0:</span>
        <span class="hljs-attr">type:</span> <span class="hljs-string">com.zaxxer.hikari.HikariDataSource</span>
        <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">com.mysql.cj.jdbc.Driver</span>
        <span class="hljs-attr">jdbc-url:</span> <span class="hljs-string">jdbc:mysql://127.0.0.1:3307/test_db?useUnicode=true&amp;characterEncoding=utf8&amp;serverTimezone=GMT%2B8</span>
        <span class="hljs-attr">username:</span> <span class="hljs-string">root</span>
        <span class="hljs-attr">password:</span> <span class="hljs-number">123456</span>
        <span class="hljs-attr">hikari:</span>
          <span class="hljs-attr">minimum-idle:</span> <span class="hljs-number">10</span>
          <span class="hljs-attr">maximum-pool-size:</span> <span class="hljs-number">50</span>
          <span class="hljs-attr">connection-timeout:</span> <span class="hljs-number">30000</span>
      
      <span class="hljs-comment"># 从库1配置</span>
      <span class="hljs-attr">slave1:</span>
        <span class="hljs-attr">type:</span> <span class="hljs-string">com.zaxxer.hikari.HikariDataSource</span>
        <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">com.mysql.cj.jdbc.Driver</span>
        <span class="hljs-attr">jdbc-url:</span> <span class="hljs-string">jdbc:mysql://127.0.0.1:3308/test_db?useUnicode=true&amp;characterEncoding=utf8&amp;serverTimezone=GMT%2B8</span>
        <span class="hljs-attr">username:</span> <span class="hljs-string">root</span>
        <span class="hljs-attr">password:</span> <span class="hljs-number">123456</span>
        <span class="hljs-attr">hikari:</span>
          <span class="hljs-attr">minimum-idle:</span> <span class="hljs-number">10</span>
          <span class="hljs-attr">maximum-pool-size:</span> <span class="hljs-number">50</span>
          <span class="hljs-attr">connection-timeout:</span> <span class="hljs-number">30000</span>
    
    <span class="hljs-attr">rules:</span>
      <span class="hljs-comment"># 读写分离规则</span>
      <span class="hljs-attr">readwrite-splitting:</span>
        <span class="hljs-attr">data-sources:</span>
          <span class="hljs-comment"># 读写分离数据源配置</span>
          <span class="hljs-attr">readwrite_ds:</span>
            <span class="hljs-attr">type:</span> <span class="hljs-string">Static</span>
            <span class="hljs-attr">props:</span>
              <span class="hljs-comment"># 写数据源</span>
              <span class="hljs-attr">write-data-source-name:</span> <span class="hljs-string">master</span>
              <span class="hljs-comment"># 读数据源列表</span>
              <span class="hljs-attr">read-data-source-names:</span> <span class="hljs-string">slave0,slave1</span>
              <span class="hljs-comment"># 负载均衡算法</span>
              <span class="hljs-attr">load-balancer-name:</span> <span class="hljs-string">round_robin</span>
        
        <span class="hljs-comment"># 负载均衡算法</span>
        <span class="hljs-attr">load-balancers:</span>
          <span class="hljs-attr">round_robin:</span>
            <span class="hljs-attr">type:</span> <span class="hljs-string">ROUND_ROBIN</span>
          <span class="hljs-attr">random:</span>
            <span class="hljs-attr">type:</span> <span class="hljs-string">RANDOM</span>
</code></pre>
<p><strong>负载均衡算法:</strong></p>




















<table><thead><tr><th>算法类型</th><th>说明</th><th>适用场景</th></tr></thead><tbody><tr><td>ROUND_ROBIN</td><td>轮询</td><td>从库性能相近</td></tr><tr><td>RANDOM</td><td>随机</td><td>从库性能相近</td></tr></tbody></table>
<p><strong>强制读主库:</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.demo.controller;

<span class="hljs-keyword">import</span> com.example.demo.mapper.UserMapper;
<span class="hljs-keyword">import</span> com.example.demo.model.User;
<span class="hljs-keyword">import</span> org.apache.shardingsphere.infra.hint.HintManager;
<span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;
<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.*;

<span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping("/users")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserController</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> UserMapper userMapper;
    
    <span class="hljs-comment">/**
     * 强制从主库读取数据
     * 用于需要读取最新数据的场景
     * 
     * <span class="hljs-doctag">@param</span> userId 用户ID
     * <span class="hljs-doctag">@return</span> 用户对象
     */</span>
    <span class="hljs-meta">@GetMapping("/master/{userId}")</span>
    <span class="hljs-keyword">public</span> User <span class="hljs-title function_">selectFromMaster</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long userId)</span> {
        <span class="hljs-keyword">try</span> (<span class="hljs-type">HintManager</span> <span class="hljs-variable">hintManager</span> <span class="hljs-operator">=</span> HintManager.getInstance()) {
            <span class="hljs-comment">// 设置从主库读取</span>
            hintManager.setWriteRouteOnly();
            <span class="hljs-keyword">return</span> userMapper.selectById(userId);
        }
    }
}
</code></pre>
<p><strong>注意事项:</strong></p>
<ul>
<li>读写分离依赖MySQL主从复制</li>
<li>主从复制有延迟，可能读到旧数据</li>
<li>需要读取最新数据时，使用Hint强制读主库</li>
<li>确保从库数据与主库一致</li>
</ul>
<h3 data-id="heading-34">7.3 数据加密</h3>
<p>ShardingSphere支持数据加密，保护敏感数据。</p>
<p><strong>配置示例:</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">shardingsphere:</span>
    <span class="hljs-attr">rules:</span>
      <span class="hljs-comment"># 加密规则</span>
      <span class="hljs-attr">encrypt:</span>
        <span class="hljs-attr">tables:</span>
          <span class="hljs-attr">t_user:</span>
            <span class="hljs-attr">columns:</span>
              <span class="hljs-comment"># 邮箱加密配置</span>
              <span class="hljs-attr">email:</span>
                <span class="hljs-attr">cipher-column:</span> <span class="hljs-string">email_cipher</span>  <span class="hljs-comment"># 加密列</span>
                <span class="hljs-attr">assisted-query-column:</span> <span class="hljs-string">email_assisted</span>  <span class="hljs-comment"># 辅助查询列</span>
                <span class="hljs-attr">encryptor-name:</span> <span class="hljs-string">aes_encryptor</span>  <span class="hljs-comment"># 加密器名称</span>
              <span class="hljs-comment"># 手机号加密配置</span>
              <span class="hljs-attr">phone:</span>
                <span class="hljs-attr">cipher-column:</span> <span class="hljs-string">phone_cipher</span>
                <span class="hljs-attr">encryptor-name:</span> <span class="hljs-string">aes_encryptor</span>
        
        <span class="hljs-comment"># 加密器配置</span>
        <span class="hljs-attr">encryptors:</span>
          <span class="hljs-attr">aes_encryptor:</span>
            <span class="hljs-attr">type:</span> <span class="hljs-string">AES</span>
            <span class="hljs-attr">props:</span>
              <span class="hljs-attr">aes-key-value:</span> <span class="hljs-number">1234567890123456</span>  <span class="hljs-comment"># AES密钥，16位</span>
</code></pre>
<p><strong>实体类调整:</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.demo.model;

<span class="hljs-keyword">import</span> lombok.Data;
<span class="hljs-keyword">import</span> java.time.LocalDateTime;

<span class="hljs-meta">@Data</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> {
    
    <span class="hljs-keyword">private</span> Long userId;
    <span class="hljs-keyword">private</span> String username;
    
    <span class="hljs-comment">/**
     * 邮箱（逻辑列，自动加密）
     */</span>
    <span class="hljs-keyword">private</span> String email;
    
    <span class="hljs-comment">/**
     * 手机号（逻辑列，自动加密）
     */</span>
    <span class="hljs-keyword">private</span> String phone;
    
    <span class="hljs-keyword">private</span> Integer age;
    <span class="hljs-keyword">private</span> LocalDateTime createdTime;
    <span class="hljs-keyword">private</span> LocalDateTime updatedTime;
}
</code></pre>
<p><strong>数据库表结构:</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span> t_user_0
(
    user_id            <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">PRIMARY</span> KEY,
    username           <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
    email_cipher       <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">255</span>),  <span class="hljs-comment">-- 加密后的邮箱</span>
    email_assisted     <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">255</span>),  <span class="hljs-comment">-- 辅助查询列</span>
    phone_cipher       <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">255</span>),  <span class="hljs-comment">-- 加密后的手机号</span>
    age                <span class="hljs-type">INT</span>,
    created_time       <span class="hljs-type">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>,
    updated_time       <span class="hljs-type">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">UPDATE</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>
) ENGINE <span class="hljs-operator">=</span> InnoDB
  <span class="hljs-keyword">DEFAULT</span> CHARSET <span class="hljs-operator">=</span> utf8mb4
  <span class="hljs-keyword">COLLATE</span> <span class="hljs-operator">=</span> utf8mb4_unicode_ci;
</code></pre>
<p><strong>加密算法类型:</strong></p>




















<table><thead><tr><th>算法类型</th><th>说明</th><th>适用场景</th></tr></thead><tbody><tr><td>AES</td><td>AES加密</td><td>通用加密</td></tr><tr><td>MD5</td><td>MD5加密</td><td>不可逆加密</td></tr></tbody></table>
<p><strong>注意事项:</strong></p>
<ul>
<li>加密后无法直接查询，需要使用辅助查询列</li>
<li>加密会影响性能，谨慎使用</li>
<li>密钥需要安全存储，建议使用密钥管理服务</li>
</ul>
<h3 data-id="heading-35">7.4 分布式主键生成策略</h3>
<p>除了Snowflake算法，ShardingSphere还支持其他主键生成策略。</p>
<p><strong>配置示例:</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">shardingsphere:</span>
    <span class="hljs-attr">rules:</span>
      <span class="hljs-attr">sharding:</span>
        <span class="hljs-attr">key-generators:</span>
          <span class="hljs-comment"># 雪花算法</span>
          <span class="hljs-attr">snowflake:</span>
            <span class="hljs-attr">type:</span> <span class="hljs-string">SNOWFLAKE</span>
            <span class="hljs-attr">props:</span>
              <span class="hljs-attr">max-vibration-offset:</span> <span class="hljs-number">1</span>  <span class="hljs-comment"># 最大抖动偏移量</span>
              <span class="hljs-attr">max-tolerate-time-difference-milliseconds:</span> <span class="hljs-number">10</span>  <span class="hljs-comment"># 最大容忍时间差(毫秒)</span>
</code></pre>
<p><strong>主键生成器类型:</strong></p>

























<table><thead><tr><th>生成器类型</th><th>说明</th><th>特点</th></tr></thead><tbody><tr><td>SNOWFLAKE</td><td>雪花算法</td><td>分布式、高性能、趋势递增</td></tr><tr><td>UUID</td><td>UUID</td><td>无序、长度长</td></tr><tr><td>NIL</td><td>不生成主键</td><td>需要手动指定</td></tr></tbody></table>
<p><strong>使用建议:</strong></p>
<ul>
<li>优先使用Snowflake算法</li>
<li>性能敏感场景考虑调整max-tolerate-time-difference-milliseconds</li>
<li>确保主键唯一性</li>
</ul>
<h3 data-id="heading-36">7.5 SQL解析与改写</h3>
<p>ShardingSphere支持SQL解析和改写，这是其核心能力之一。</p>
<p><strong>功能说明:</strong></p>
<ol>
<li><strong>自动路由</strong> - 根据分片键自动路由到目标分片</li>
<li><strong>结果归并</strong> - 合并多个分片的结果</li>
<li><strong>SQL改写</strong> - 修改SQL以适应分片场景</li>
</ol>
<p><strong>示例:</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 原始SQL</span>
SELECT * FROM t_user <span class="hljs-type">WHERE</span> <span class="hljs-variable">user_id</span> <span class="hljs-operator">=</span> <span class="hljs-number">100</span>

<span class="hljs-comment">// 改写后的SQL（路由到ds0.t_user_0）</span>
SELECT * FROM ds0.t_user_0 <span class="hljs-type">WHERE</span> <span class="hljs-variable">user_id</span> <span class="hljs-operator">=</span> <span class="hljs-number">100</span>
</code></pre>
<p><strong>使用建议:</strong></p>
<ul>
<li>理解SQL改写原理，优化SQL语句</li>
<li>避免全路由查询，性能较差</li>
<li>使用绑定表避免跨库JOIN</li>
</ul>
<h3 data-id="heading-37">7.6 配置中心</h3>
<p>ShardingSphere支持配置中心，实现动态配置管理。</p>
<p><strong>支持的配置中心:</strong></p>
<ul>
<li>Zookeeper</li>
<li>Nacos</li>
<li>Etcd</li>
<li>Apollo</li>
</ul>
<p><strong>配置示例:</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">shardingsphere:</span>
    <span class="hljs-attr">mode:</span>
      <span class="hljs-attr">type:</span> <span class="hljs-string">Cluster</span>
      <span class="hljs-attr">repository:</span>
        <span class="hljs-attr">type:</span> <span class="hljs-string">Zookeeper</span>
        <span class="hljs-attr">props:</span>
          <span class="hljs-attr">namespace:</span> <span class="hljs-string">sharding-sphere</span>
          <span class="hljs-attr">server-lists:</span> <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span><span class="hljs-string">:2181</span>
          <span class="hljs-attr">retry-interval-milliseconds:</span> <span class="hljs-number">500</span>
          <span class="hljs-attr">max-retries:</span> <span class="hljs-number">3</span>
          <span class="hljs-attr">time-to-live-milliseconds:</span> <span class="hljs-number">5000</span>
</code></pre>
<p><strong>优势:</strong></p>
<ul>
<li>配置动态更新，无需重启</li>
<li>配置集中管理</li>
<li>配置版本控制</li>
</ul>
<p><strong>使用建议:</strong></p>
<ul>
<li>生产环境使用配置中心</li>
<li>配置变更需要灰度发布</li>
<li>配置需要备份</li>
</ul>
<hr/>
<h2 data-id="heading-38">八、生产环境最佳实践</h2>
<h3 data-id="heading-39">7.1 配置优化</h3>
<p><strong>数据源配置:</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">shardingsphere:</span>
    <span class="hljs-attr">datasource:</span>
      <span class="hljs-attr">ds0:</span>
        <span class="hljs-attr">hikari:</span>
          <span class="hljs-attr">minimum-idle:</span> <span class="hljs-number">10</span>
          <span class="hljs-attr">maximum-pool-size:</span> <span class="hljs-number">50</span>
          <span class="hljs-attr">connection-timeout:</span> <span class="hljs-number">30000</span>
          <span class="hljs-attr">idle-timeout:</span> <span class="hljs-number">600000</span>
          <span class="hljs-attr">max-lifetime:</span> <span class="hljs-number">1800000</span>
          <span class="hljs-attr">connection-test-query:</span> <span class="hljs-string">SELECT</span> <span class="hljs-number">1</span>
</code></pre>
<p><strong>ShardingSphere配置:</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">shardingsphere:</span>
    <span class="hljs-attr">props:</span>
      <span class="hljs-comment"># 生产环境关闭SQL显示</span>
      <span class="hljs-attr">sql-show:</span> <span class="hljs-literal">false</span>
      <span class="hljs-comment"># 允许没有分片列的插入通过主键生成器</span>
      <span class="hljs-attr">check-table-metadata-enabled:</span> <span class="hljs-literal">false</span>
      <span class="hljs-comment"># 核心执行线程池大小</span>
      <span class="hljs-attr">kernel-executor-size:</span> <span class="hljs-number">16</span>
</code></pre>
<h3 data-id="heading-40">7.2 性能优化</h3>
<p><strong>1. 使用绑定表</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">shardingsphere:</span>
    <span class="hljs-attr">rules:</span>
      <span class="hljs-attr">sharding:</span>
        <span class="hljs-attr">binding-tables:</span>
          <span class="hljs-bullet">-</span> <span class="hljs-string">t_order,t_order_item</span>
</code></pre>
<p><strong>优势:</strong></p>
<ul>
<li>避免跨库JOIN</li>
<li>提高查询性能</li>
<li>简化事务处理</li>
</ul>
<p><strong>2. 避免全路由</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 不推荐:不包含分片键,全路由</span>
List&lt;User&gt; users = userMapper.selectAll();

<span class="hljs-comment">// 推荐:包含分片键,精确路由</span>
<span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> userMapper.selectById(<span class="hljs-number">100L</span>);
</code></pre>
<p><strong>3. 合理使用索引</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 在分片键上创建索引</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_user_id <span class="hljs-keyword">ON</span> t_user(user_id);

<span class="hljs-comment">-- 在常用查询字段上创建索引</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_username <span class="hljs-keyword">ON</span> t_user(username);
</code></pre>
<h3 data-id="heading-41">7.3 监控告警</h3>
<p><strong>监控指标:</strong></p>
<ol>
<li>
<p><strong>数据库指标</strong></p>
<ul>
<li>连接数使用率</li>
<li>慢查询数量</li>
<li>锁等待时间</li>
</ul>
</li>
<li>
<p><strong>应用指标</strong></p>
<ul>
<li>SQL执行时间</li>
<li>SQL错误率</li>
<li>分片路由时间</li>
</ul>
</li>
<li>
<p><strong>业务指标</strong></p>
<ul>
<li>请求响应时间</li>
<li>请求成功率</li>
<li>请求吞吐量</li>
</ul>
</li>
</ol>
<h3 data-id="heading-42">7.4 安全加固</h3>
<p><strong>1. SQL注入防护</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 不推荐:字符串拼接SQL</span>
<span class="hljs-type">String</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> <span class="hljs-string">"SELECT * FROM t_user WHERE username = '"</span> + username + <span class="hljs-string">"'"</span>;

<span class="hljs-comment">// 推荐:使用参数化查询</span>
<span class="hljs-meta">@Select("SELECT * FROM t_user WHERE username = #{username}")</span>
User <span class="hljs-title function_">selectByUsername</span><span class="hljs-params">(String username)</span>;
</code></pre>
<p><strong>2. 权限控制</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 创建只读用户</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">USER</span> <span class="hljs-string">'readonly'</span>@<span class="hljs-string">'%'</span> IDENTIFIED <span class="hljs-keyword">BY</span> <span class="hljs-string">'password'</span>;
<span class="hljs-keyword">GRANT</span> <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">ON</span> test_db.<span class="hljs-operator">*</span> <span class="hljs-keyword">TO</span> <span class="hljs-string">'readonly'</span>@<span class="hljs-string">'%'</span>;

<span class="hljs-comment">-- 创建读写用户</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">USER</span> <span class="hljs-string">'readwrite'</span>@<span class="hljs-string">'%'</span> IDENTIFIED <span class="hljs-keyword">BY</span> <span class="hljs-string">'password'</span>;
<span class="hljs-keyword">GRANT</span> <span class="hljs-keyword">SELECT</span>, <span class="hljs-keyword">INSERT</span>, <span class="hljs-keyword">UPDATE</span>, <span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">ON</span> test_db.<span class="hljs-operator">*</span> <span class="hljs-keyword">TO</span> <span class="hljs-string">'readwrite'</span>@<span class="hljs-string">'%'</span>;
</code></pre>
<h3 data-id="heading-43">7.5 运维建议</h3>
<p><strong>1. 定期备份</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 备份数据库</span>
mysqldump -h 127.0.0.1 -u root -p test_db1 &gt; test_db1_backup.sql

<span class="hljs-comment"># 恢复数据库</span>
mysql -h 127.0.0.1 -u root -p test_db1 &lt; test_db1_backup.sql
</code></pre>
<p><strong>2. 定期清理</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 清理过期数据</span>
<span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> t_user <span class="hljs-keyword">WHERE</span> created_time <span class="hljs-operator">&lt;</span> DATE_SUB(NOW(), <span class="hljs-type">INTERVAL</span> <span class="hljs-number">1</span> <span class="hljs-keyword">YEAR</span>);

<span class="hljs-comment">-- 优化表</span>
OPTIMIZE <span class="hljs-keyword">TABLE</span> t_user_0;
OPTIMIZE <span class="hljs-keyword">TABLE</span> t_user_1;
</code></pre>
<hr/>
<h2 data-id="heading-44">九、常见问题与解决方案</h2>
<h3 data-id="heading-45">9.1 分片键自动生成问题</h3>
<p><strong>问题:</strong> INSERT语句不包含分片键,导致路由失败。</p>
<p><strong>解决方案:</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">shardingsphere:</span>
    <span class="hljs-attr">props:</span>
      <span class="hljs-attr">check-table-metadata-enabled:</span> <span class="hljs-literal">false</span>
</code></pre>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Insert("INSERT INTO t_user (username, email, age) VALUES (#{username}, #{email}, #{age})")</span>
<span class="hljs-type">int</span> <span class="hljs-title function_">insert</span><span class="hljs-params">(User user)</span>;
</code></pre>
<h3 data-id="heading-46">9.2 全路由问题</h3>
<p><strong>问题:</strong> 查询不包含分片键,导致全路由,性能较差。</p>
<p><strong>解决方案:</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 不推荐:全路由</span>
List&lt;User&gt; users = userMapper.selectAll();

<span class="hljs-comment">// 推荐:精确路由</span>
<span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> userMapper.selectById(<span class="hljs-number">100L</span>);
</code></pre>
<h3 data-id="heading-47">9.3 跨库JOIN问题</h3>
<p><strong>问题:</strong> 跨库JOIN性能较差或无法执行。</p>
<p><strong>解决方案:</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">shardingsphere:</span>
    <span class="hljs-attr">rules:</span>
      <span class="hljs-attr">sharding:</span>
        <span class="hljs-attr">binding-tables:</span>
          <span class="hljs-bullet">-</span> <span class="hljs-string">t_order,t_order_item</span>
</code></pre>
<h3 data-id="heading-48">9.4 主键冲突问题</h3>
<p><strong>问题:</strong> 分布式主键生成器配置错误,导致主键冲突。</p>
<p><strong>解决方案:</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">shardingsphere:</span>
    <span class="hljs-attr">rules:</span>
      <span class="hljs-attr">sharding:</span>
        <span class="hljs-attr">key-generators:</span>
          <span class="hljs-attr">snowflake:</span>
            <span class="hljs-attr">type:</span> <span class="hljs-string">SNOWFLAKE</span>
</code></pre>
<h3 data-id="heading-49">9.5 连接池耗尽问题</h3>
<p><strong>问题:</strong> 连接池配置不合理,导致连接池耗尽。</p>
<p><strong>解决方案:</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">shardingsphere:</span>
    <span class="hljs-attr">datasource:</span>
      <span class="hljs-attr">ds0:</span>
        <span class="hljs-attr">hikari:</span>
          <span class="hljs-attr">minimum-idle:</span> <span class="hljs-number">10</span>
          <span class="hljs-attr">maximum-pool-size:</span> <span class="hljs-number">50</span>
          <span class="hljs-attr">connection-timeout:</span> <span class="hljs-number">30000</span>
</code></pre>
<h3 data-id="heading-50">9.6 Hint分片不生效问题</h3>
<p><strong>问题:</strong> 使用HintManager指定分片后，查询仍然路由到所有分片。</p>
<p><strong>解决方案:</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 确保使用try-with-resources或手动关闭HintManager</span>
<span class="hljs-keyword">try</span> (<span class="hljs-type">HintManager</span> <span class="hljs-variable">hintManager</span> <span class="hljs-operator">=</span> HintManager.getInstance()) {
    hintManager.addTableShardingValue(<span class="hljs-string">"t_order"</span>, <span class="hljs-number">0</span>);
    <span class="hljs-keyword">return</span> orderMapper.selectById(orderId);
}

<span class="hljs-comment">// 或者手动关闭</span>
<span class="hljs-type">HintManager</span> <span class="hljs-variable">hintManager</span> <span class="hljs-operator">=</span> HintManager.getInstance();
<span class="hljs-keyword">try</span> {
    hintManager.addTableShardingValue(<span class="hljs-string">"t_order"</span>, <span class="hljs-number">0</span>);
    <span class="hljs-keyword">return</span> orderMapper.selectById(orderId);
} <span class="hljs-keyword">finally</span> {
    hintManager.close();
}
</code></pre>
<h3 data-id="heading-51">9.7 读写分离主从延迟问题</h3>
<p><strong>问题:</strong> 读写分离导致主从延迟，读取到旧数据。</p>
<p><strong>解决方案:</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 强制读主库</span>
<span class="hljs-keyword">try</span> (<span class="hljs-type">HintManager</span> <span class="hljs-variable">hintManager</span> <span class="hljs-operator">=</span> HintManager.getInstance()) {
    hintManager.setWriteRouteOnly();
    <span class="hljs-keyword">return</span> userMapper.selectById(userId);
}
</code></pre>
<hr/>
<h2 data-id="heading-52">十、总结</h2>
<p>ShardingSphere-JDBC是一个功能强大的分库分表中间件,本文档详细介绍了其配置和使用方法。</p>
<p><strong>核心要点:</strong></p>
<ol>
<li><strong>分片键选择</strong> - 选择高频查询字段作为分片键</li>
<li><strong>分片算法</strong> - 使用INLINE算法,配置简单,性能优秀</li>
<li><strong>绑定表</strong> - 使用绑定表避免跨库JOIN</li>
<li><strong>主键生成</strong> - 使用Snowflake算法保证唯一性</li>
<li><strong>避免全路由</strong> - 查询语句最好包含分片键</li>
</ol>
<p><strong>最佳实践:</strong></p>
<ol>
<li>优先使用INLINE算法,性能好</li>
<li>避免全路由查询,性能差</li>
<li>使用绑定表,避免跨库操作</li>
<li>配置合理的连接池大小</li>
<li>生产环境关闭sql-show</li>
<li>定期备份,防止数据丢失</li>
</ol>
<p><strong>参考资料:</strong></p>
<ul>
<li>ShardingSphere官方文档: <a href="https://link.juejin.cn?target=https%3A%2F%2Fshardingsphere.apache.org%2F" target="_blank" title="https://shardingsphere.apache.org/" ref="nofollow noopener noreferrer">shardingsphere.apache.org/</a></li>
<li>ShardingSphere GitHub: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fapache%2Fshardingsphere" target="_blank" title="https://github.com/apache/shardingsphere" ref="nofollow noopener noreferrer">github.com/apache/shar…</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[大数据-202 sklearn 决策树实战：criterion、Graphviz 可视化与剪枝防过拟合]]></title>    <link>https://juejin.cn/post/7590957076630634542</link>    <guid>https://juejin.cn/post/7590957076630634542</guid>    <pubDate>2026-01-04T01:46:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590957076630634542" data-draft-id="7590849961727655963" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="大数据-202 sklearn 决策树实战：criterion、Graphviz 可视化与剪枝防过拟合"/> <meta itemprop="keywords" content="后端,大数据,机器学习"/> <meta itemprop="datePublished" content="2026-01-04T01:46:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="武子康"/> <meta itemprop="url" content="https://juejin.cn/user/149189314230039"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            大数据-202 sklearn 决策树实战：criterion、Graphviz 可视化与剪枝防过拟合
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/149189314230039/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    武子康
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-04T01:46:35.000Z" title="Sun Jan 04 2026 01:46:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">TL;DR</h2>
<ul>
<li>场景：用 sklearn 在 Wine 数据集上训练 DecisionTreeClassifier，并用 Graphviz 导出可视化</li>
<li>结论：criterion 影响分裂度量（gini/entropy/log_loss），random_state 与 splitter 决定稳定性与随机性；剪枝靠 max_depth/min_samples_leaf/ccp_alpha</li>
<li>产出：可复现实验流程 + export_graphviz 参数要点 + 环境版本矩阵 + 常见报错定位表</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b1a497d33a634769af93d49f2a219467~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768095995&amp;x-signature=ccoxLVQotg6Js%2F9memyJJ0yNIv8%3D" alt="大数据-202 sklearn 决策树实战：criterion、Graphviz 可视化与剪枝防过拟合" loading="lazy"/></p>
<h2 data-id="heading-1">版本矩阵</h2>





















<table><thead><tr><th>组件</th><th>已验证说明</th></tr></thead><tbody><tr><td>scikit-learn 1.8.0</td><td>PyPI 声明2025-12-10 发布；Requires: Python&gt;=3.11；DecisionTreeClassifier 的 criterion 支持 gini/entropy/log_loss <a href="https://link.juejin.cn?target=https%3A%2F%2Fscikit-learn.org%2Fstable%2Fmodules%2Fgenerated%2Fsklearn.tree.DecisionTreeClassifier.html" target="_blank" title="https://scikit-learn.org/stable/modules/generated/sklearn.tree.DecisionTreeClassifier.html" ref="nofollow noopener noreferrer">DecisionTreeClassifier API官方文档</a>；splitter 支持 best/random；criterion 见上 <a href="https://link.juejin.cn?target=https%3A%2F%2Fscikit-learn.org%2Fstable%2Fmodules%2Fgenerated%2Fsklearn.tree.export_graphviz.html" target="_blank" title="https://scikit-learn.org/stable/modules/generated/sklearn.tree.export_graphviz.html" ref="nofollow noopener noreferrer">export_graphviz官方文档</a> 导出 DOT；配合 dot 命令可生成 PNG/SVG 等</td></tr><tr><td>python-graphviz 0.21</td><td>PyPI 声明Requires: Python&gt;=3.9；渲染仍依赖系统 Graphviz（dot）与 PATH</td></tr><tr><td>系统 Graphviz（dot）</td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fgraphviz.org%2F" target="_blank" title="https://graphviz.org/" ref="nofollow noopener noreferrer">官方站点</a>需单独安装（Windows/macOS/Linux 方式不同）</td></tr></tbody></table>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6a3faf0f5190427892ebb8a183e2ef78~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768095995&amp;x-signature=vGI%2F6Re1A6uwODN55fXCoNXpMPc%3D" alt="大数据-202 sklearn 决策树实战：criterion、Graphviz 可视化与剪枝防过拟合" loading="lazy"/></p>
<h2 data-id="heading-2">使用sklearn实现决策树</h2>
<h3 data-id="heading-3">参数CRITERION</h3>
<p>criterion 这个参数使用来决定不纯度的计算方法，sklearn提供了两种选择：</p>
<ul>
<li>输入 entropy，使用信息熵（Entropy）</li>
<li>输入 gini，使用基尼系数（Gini Impurity）</li>
</ul>
<p>在机器学习中，基尼系数和信息熵都是常用的不纯度度量指标，用于决策树等算法的特征选择和节点划分。两者虽然计算方式和敏感性不同，但在实际应用中往往能达到相似的效果。</p>
<p>信息熵的计算公式为：H(X)=-Σp(x)log₂p(x)，其中p(x)是某个类别的概率。由于涉及对数运算，其计算复杂度比基尼系数要高。相比之下，基尼系数的计算公式Gini=1-Σp(x)²更加简单直接，不需要对数运算，因此计算速度更快。</p>
<p>具体来说，信息熵对数据不纯度的惩罚更强。例如：</p>
<ul>
<li>当某个节点中两个类别的样本比例为7:3时：
<ul>
<li>基尼系数=1-(0.7²+0.3²)=0.42</li>
<li>信息熵=-(0.7<em>log₂0.7+0.3</em>log₂0.3)≈0.88</li>
</ul>
</li>
<li>当比例变为8:2时：
<ul>
<li>基尼系数=0.32</li>
<li>信息熵≈0.72</li>
</ul>
</li>
</ul>
<p>这种敏感性差异导致：</p>
<ol>
<li>在高维数据场景下（如特征数超过1000），信息熵容易产生过拟合，因为它会倾向于选择更细粒度的划分方式。此时基尼系数表现更稳健。</li>
<li>在噪声数据较多时（如标签错误率超过10%），基尼系数的抗干扰能力更强。</li>
<li>当模型欠拟合时（训练集和测试集准确率都低于60%），使用信息熵可能获得更好的效果，因为它能驱动模型学习更精细的决策边界。</li>
</ol>
<p>实际应用建议：</p>
<ul>
<li>对于结构化数据（如表格数据），可以优先尝试基尼系数</li>
<li>在计算资源受限的实时系统中，基尼系数是更好的选择</li>
<li>当数据质量较高且维度适中时（如UCI数据集），可以比较两种指标的效果</li>
<li>在集成学习中（如随机森林），两种指标的差异通常会被弱化</li>
</ul>
<p>需要注意的是，这些规律并非绝对。在实践中，最好的方式是通过交叉验证来比较两种指标在特定数据集上的表现。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2c877d721cc34e0aaee7244d9fb7bb7e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768095995&amp;x-signature=i%2BVS3AWfS4ubVO5WK4DrUUA8r84%3D" alt="sklearn实现决策树" loading="lazy"/></p>
<h2 data-id="heading-4">初步建模</h2>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 导入需要的算法库和模块</span>
<span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd
<span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np
<span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt
%matplotlib inline
<span class="hljs-keyword">from</span> sklearn <span class="hljs-keyword">import</span> tree
<span class="hljs-keyword">from</span> sklearn.datasets <span class="hljs-keyword">import</span> load_wine
<span class="hljs-keyword">from</span> sklearn.model_selection <span class="hljs-keyword">import</span> train_test_split
plt.rcParams[<span class="hljs-string">'font.sans-serif'</span>]=[<span class="hljs-string">'Simhei'</span>]
plt.rcParams[<span class="hljs-string">'axes.unicode_minus'</span>]=<span class="hljs-literal">False</span>
</code></pre>
<p>加载数据</p>
<pre><code class="hljs language-python" lang="python">wine = load_wine()
wine.data.shape
wine.target
</code></pre>
<p>执行结果如下所示：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/381e98d5f85e435aac734029558a64c5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768095995&amp;x-signature=%2FoHbEPMLI1qmWJWEbwmeSyRmXsA%3D" alt="sklearn实现决策树" loading="lazy"/>
如果是 wine 是一张表，应该长这样：</p>
<pre><code class="hljs language-python" lang="python">wine_pd=pd.concat([pd.DataFrame(wine.data),pd.DataFrame(wine.target)],axis=<span class="hljs-number">1</span>).head()
wine.feature_names.append(<span class="hljs-string">"result"</span>)
wine_pd.columns=wine.feature_names
wine_pd
</code></pre>
<p>执行结果如下图所示：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/726d5daf9e8e48619a44ece8002a8551~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768095995&amp;x-signature=q%2Fv0oSP1OqMOHpSWi4vwy1iA1QI%3D" alt="sklearn实现决策树" loading="lazy"/>
编写代码查看形状：</p>
<pre><code class="hljs language-python" lang="python">Xtrain, Xtest, Ytrain, ytest = train_test_split(wine.data,wine.target,test_size=<span class="hljs-number">0.3</span>,random_state=<span class="hljs-number">420</span>)
<span class="hljs-built_in">print</span>(Xtrain.shape)
<span class="hljs-built_in">print</span>(Xtest.shape)
</code></pre>
<p>执行结果如下所示：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bbe0eecd47b84fe3b71973d6721d2bde~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768095995&amp;x-signature=ULqI3sMUG%2BXt1kZ6IX6%2BayP49BU%3D" alt="sklearn实现决策树" loading="lazy"/></p>
<h2 data-id="heading-5">建立模型</h2>
<pre><code class="hljs language-python" lang="python">clf = tree.DecisionTreeClassifier(criterion=<span class="hljs-string">"gini"</span>)
clf = clf.fit(Xtrain, Ytrain)
clf.score(Xtest, ytest) <span class="hljs-comment">#返回预测的准确度</span>
</code></pre>
<p>执行结果如下图所示：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5d78a27b69c24cc3a66fa96ed1424531~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768095995&amp;x-signature=6ViGovnqiqD5Gisp%2F39EMjWvsK8%3D" alt="sklearn实现决策树 建立模型" loading="lazy"/></p>
<h2 data-id="heading-6">画决策树</h2>
<p>我们可以利用 Graphviz 模块导出决策树模型，第一次使用 Graphviz 之前需要进行安装，若是使用从 pip 安装：</p>
<pre><code class="hljs language-shell" lang="shell">!pip install graphviz
</code></pre>
<p>执行结果如下所示：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/27cc0283bf334b5e90b3fdbca0f8db27~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768095995&amp;x-signature=WNkLu32Qw3DcpN%2Fgc90IqOW%2BJKM%3D" alt="决策树" loading="lazy"/>
对图案进行绘制：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt
<span class="hljs-keyword">import</span> graphviz
<span class="hljs-keyword">from</span> sklearn <span class="hljs-keyword">import</span> tree


feature_name = [<span class="hljs-string">'酒精'</span>,<span class="hljs-string">'苹果酸'</span>,<span class="hljs-string">'灰'</span>,<span class="hljs-string">'灰的碱性'</span>,<span class="hljs-string">'镁'</span>,<span class="hljs-string">'总酚'</span>,<span class="hljs-string">'类黄酮'</span>,<span class="hljs-string">'非黄烷类酚类'</span>,<span class="hljs-string">'花青素'</span>,<span class="hljs-string">'颜色强度'</span>,<span class="hljs-string">'色调'</span>,<span class="hljs-string">'od280/od315 稀释葡萄酒'</span>,<span class="hljs-string">'脯氨酸'</span>]
dot_data = tree.export_graphviz(clf, out_file = <span class="hljs-literal">None</span>, feature_names= feature_name, class_names=[<span class="hljs-string">"琴酒"</span>,<span class="hljs-string">"雪莉"</span>,<span class="hljs-string">"贝尔摩德"</span>], filled=<span class="hljs-literal">True</span>, rounded=<span class="hljs-literal">True</span>)
graph = graphviz.Source(dot_data)
graph
</code></pre>
<p>执行结果如下图所示：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1d15822b692f4e93a0208ea0718c2d58~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768095995&amp;x-signature=ArBePPfg%2Fa%2FeW6NQ3x5s2lazNE0%3D" alt="sklearn实现决策树" loading="lazy"/>
绘制的图片如下所示：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5a0fec3f96bf4c54a0c17a5393f0753e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768095995&amp;x-signature=TtfY6gv7uQS86OUzlJL8d81SB5w%3D" alt="sklearn实现决策树 绘制" loading="lazy"/></p>
<p>export_graphviz 生成了一个 DOT 格式的决策树：</p>
<ul>
<li>feature_names：每个属性的名字</li>
<li>class_names：每个因变量类别的名字</li>
<li>label：是否显示不纯度信息的标签，默认为 all 表都显示，可以是root或 none</li>
<li>filled：是否给每个节点的主分类绘制不同的颜色，默认为 False</li>
<li>out_file：输出的 dot 文件的名字，默认为 None表示不输出文件，可以是自定义名字如“tree.dot”</li>
<li>rounded：默认为 True，表示对每个节点的边框加圆角，使用 Helvetica 字体</li>
</ul>
<h2 data-id="heading-7">防止过拟合</h2>
<p>在不加限制的情况下，一颗决策树会持续生长直到满足以下任一条件：</p>
<ol>
<li>所有叶节点的基尼系数（Gini impurity）或信息熵（information entropy）等不纯度指标达到最优（通常为0）</li>
<li>没有更多的特征可用于进一步分割数据</li>
<li>每个叶节点仅包含单一类别的样本</li>
</ol>
<p>这种不加限制的生长方式往往会导致严重的过拟合问题。具体表现为：</p>
<ul>
<li>在训练集上可能达到100%的准确率</li>
<li>但在测试集上表现显著下降（如准确率骤降20-30个百分点）</li>
</ul>
<p>造成这种现象的根本原因在于：</p>
<ol>
<li>样本偏差问题：我们收集的训练数据不可能完全代表整体数据分布，总会存在抽样偏差</li>
<li>噪声敏感问题：当决策树过度生长时：
<ul>
<li>会捕捉到训练数据中的随机噪声（如5%的错误标注样本）</li>
<li>为这些噪声创建特定的分裂规则（例如"当特征X=3.14159时预测类别A"）</li>
<li>导致模型泛化能力下降</li>
</ul>
</li>
</ol>
<p>典型示例：
在房价预测任务中，一棵过拟合的决策树可能会：</p>
<ul>
<li>为训练集中某个异常低价样本（如输入错误的$1元房价）创建特殊分支</li>
<li>在实际预测时，遇到类似特征组合的房屋就会错误预测极低价格</li>
</ul>
<p>解决方法通常包括：</p>
<ol>
<li>预剪枝（Pre-pruning）：
<ul>
<li>设置最大深度（如max_depth=5）</li>
<li>设置叶节点最小样本数（如min_samples_leaf=10）</li>
</ul>
</li>
<li>后剪枝（Post-pruning）：
<ul>
<li>使用代价复杂度剪枝（CCP）</li>
<li>基于验证集性能进行剪枝</li>
</ul>
</li>
<li>集成方法：
<ul>
<li>随机森林（通过多棵树投票降低过拟合风险）</li>
<li>梯度提升树（通过迭代优化减少单棵树的影响）</li>
</ul>
</li>
</ol>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment">#我们的树对训练集的拟合程度如何?</span>
score_train = clf.score(Xtrain, Ytrain)
score_train
</code></pre>
<p>执行结果如下图所示：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7ac58d4df39d49f8be14ef1785a1437f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768095995&amp;x-signature=c%2BU0GuDSw9lqiYpvNdkMgP%2BRPcY%3D" alt="sklearn实现决策树 防止过拟合" loading="lazy"/>
为了让决策树有更好的泛化性，我们要对决策树进行剪枝。剪枝策略对决策树的影响巨大，正确的剪枝策略是优化决策树算法的核心。</p>
<h2 data-id="heading-8">random_state</h2>
<p>如果我们改动了 random_state，画出来的每一颗树都不一样，它为什么不稳定呢？如果使用其他数据集，它还会不稳定吗？
我们之前提过，无论决策树模型如何进化，在分支上的本质都还是追求某个不纯度相关的指标的优化，而正如我们提到的，不纯度是基于节点计算出来的，也就是说，决策树在建树时，是靠优化节点来追求一棵优化的树，但是最优的节点是能够保证最优的树吗？</p>
<p>集成算法被用来解决这个问题：sklearn 表示，既然一棵树不能保证最优，那就建更多不同的树，然后从中取最好的。怎么样从一组数据集中建不同的树呢？在每次分支的时候，不使用全部特征，而是随机选取一部分特征，从中选取不纯度相关指标最优的作为分支用的节点。
这样，每次生成的树叶不同了。</p>
<p>random_state 用来设置分支中的随机模型的参数，默认是 None，在高维度时随机性会表现更明显，低维度的数据随机性几乎不会显现。输入任意整数，会一直长出同一棵树，让模型稳定下来。</p>
<h2 data-id="heading-9">splitter</h2>
<p>splitter 也是用来控制决策树中随机选项的，有两种输入值：</p>
<ul>
<li>输入 best，决策树在分支时虽然随机，但是还是会优先选择更重要的特征进行分支（重要性可以通过属性 feature_importance 查看）</li>
<li>输入 random，决策树在分支时会更加随机，树会因为含有更多的不必要的信息而更深更大，并因为这些不必要信息而降低对训练集的拟合。这也是一种防止过拟合的方式。</li>
</ul>
<p>当你预测到你的模型会过拟合，用这两个参数来帮助你降低树建成之后的过拟合的可能性，当然，树一旦建成，我们依然是使用剪枝参数来防止拟合的。</p>
<pre><code class="hljs language-python" lang="python">clf = tree.DecisionTreeClassifier(criterion=<span class="hljs-string">"entropy"</span>,random_state=<span class="hljs-number">30</span>,splitter=<span class="hljs-string">"random"</span>)
clf = clf.fit(Xtrain, Ytrain)
score = clf.score(Xtest, ytest)
<span class="hljs-built_in">print</span>(score)
plt.rcParams[<span class="hljs-string">'font.sans-serif'</span>]=[<span class="hljs-string">'Simhei'</span>]
plt.rcParams[<span class="hljs-string">'axes.unicode_minus'</span>]=<span class="hljs-literal">False</span>
</code></pre>
<p>代码的执行结果如下所示：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/31afe0d1e2194e20ae71bd34bee833d8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768095995&amp;x-signature=rBzxInKP0xM75G1VUXKTds8dEA0%3D" alt="sklearn实现决策树 决策树分支" loading="lazy"/></p>
<h2 data-id="heading-10">版本矩阵</h2>


















































<table><thead><tr><th>症状</th><th>根因定位</th><th>修复</th></tr></thead><tbody><tr><td>ModuleNotFoundError: No module named 'graphviz'</td><td>未安装 python-graphviz 包</td><td><code>python -c "import graphviz"</code><br/><code>pip install graphviz</code></td></tr><tr><td>ExecutableNotFound: failed to execute 'dot' / 渲染为空</td><td>只装了 python 包，未装系统 Graphviz 或 PATH 未配</td><td><code>dot -V</code> 是否可用<br/>安装系统 Graphviz，并把 dot 所在目录加入 PATH</td></tr><tr><td>ValueError: Length of feature_names ...</td><td>feature_names 数量与 X 特征列不一致</td><td>对比 Xtrain.shape[1] 与 len(feature_name)<br/>统一特征数；Wine 为 13 维时 feature_names 也应为 13</td></tr><tr><td>图里类别名/计数顺序不对</td><td>class_names 顺序与内部类别编码不一致</td><td>查看 tree 图首节点 value=[...] 顺序<br/>class_names 按类别编码升序传入（如 0/1/2 对应的名称顺序）</td></tr><tr><td>NameError: name 'Ytrain' is not defined</td><td>变量名大小写不一致/拷贝时漏段</td><td>搜索 Ytrain/ytrain<br/>统一命名（训练/测试标签用同一风格）</td></tr><tr><td>SyntaxError 出现在 %matplotlib inline</td><td>该语法仅适用于 Jupyter</td><td>运行环境是 .py / IDE 脚本<br/>脚本环境移除该魔法命令</td></tr><tr><td>训练集 1.0、测试集明显下降</td><td>树无约束生长导致过拟合</td><td>对比 clf.score(Xtrain, Ytrain) vs clf.score(Xtest, ytest)<br/>加 max_depth/min_samples_leaf/min_samples_split，或用 ccp_alpha 做后剪枝</td></tr><tr><td>InvalidParameterError: The 'criterion' parameter ...</td><td>sklearn 版本差异或参数拼写</td><td>sklearn.<strong>version</strong>；检查 criterion 值<br/>用官方支持值；新版本支持 gini/entropy/log_loss</td></tr></tbody></table>
<h2 data-id="heading-11">其他系列</h2>
<h3 data-id="heading-12">🚀 AI篇持续更新中（长期更新）</h3>
<p><strong>AI炼丹日志-29 - 字节跳动 DeerFlow 深度研究框<em>斜体样式</em>架 私有部署 测试上手 架构研究</strong>，持续打造实用AI工具指南！
<strong>AI研究-132 Java 生态前沿 2025：Spring、Quarkus、GraalVM、CRaC 与云原生落地</strong></p>
<h3 data-id="heading-13">💻 Java篇持续更新中（长期更新）</h3>
<p><strong>Java-218 RocketMQ Java API 实战：同步/异步 Producer 与 Pull/Push Consumer</strong>
MyBatis 已完结，Spring 已完结，Nginx已完结，Tomcat已完结，分布式服务已完结，Dubbo已完结，MySQL已完结，MongoDB已完结，Neo4j已完结，FastDFS 已完结，OSS已完结，GuavaCache已完结，EVCache已完结，RabbitMQ已完结，RocketMQ正在更新... 深入浅出助你打牢基础！</p>
<h3 data-id="heading-14">📊 大数据板块已完成多项干货更新（300篇）：</h3>
<p>包括 Hadoop、Hive、Kafka、Flink、ClickHouse、Elasticsearch 等二十余项核心组件，覆盖离线+实时数仓全栈！
<strong>大数据-278 Spark MLib - 基础介绍 机器学习算法 梯度提升树 GBDT案例 详解</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[useEffect详解]]></title>    <link>https://juejin.cn/post/7590303618429173795</link>    <guid>https://juejin.cn/post/7590303618429173795</guid>    <pubDate>2026-01-03T12:42:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590303618429173795" data-draft-id="7590433626560151587" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="useEffect详解"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2026-01-03T12:42:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="写代码的皮筏艇"/> <meta itemprop="url" content="https://juejin.cn/user/4196178024218520"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            useEffect详解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4196178024218520/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    写代码的皮筏艇
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-03T12:42:55.000Z" title="Sat Jan 03 2026 12:42:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">React 中 useEffect 详解</h3>
<p><code>useEffect</code> 是 React Hooks 中用于处理<strong>副作用</strong>的核心 Hook，它替代了类组件中的生命周期方法（<code>componentDidMount</code>、<code>componentDidUpdate</code>、<code>componentWillUnmount</code>），让函数组件能够执行异步操作、修改 DOM、订阅事件、清理资源等副作用逻辑。而且现在函数组件才是主流，类组件多是一些老项目</p>
<h3 data-id="heading-1">一、核心概念：什么是 “副作用”？</h3>
<p>副作用（Side Effect）是指函数执行过程中，除了返回值之外对外部环境产生的影响，常见场景：</p>
<ul>
<li>数据请求（AJAX/fetch）</li>
<li>DOM 操作（修改样式、添加事件监听）</li>
<li>订阅 / 取消订阅（如 WebSocket、定时器）</li>
<li>本地存储（localStorage/sessionStorage）</li>
<li>手动修改 state（需谨慎）</li>
</ul>
<h3 data-id="heading-2">二、基本语法</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { useEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">Component</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 基础用法</span>
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// 副作用逻辑（执行时机：组件挂载/更新后）</span>
    
    <span class="hljs-comment">// 可选：清理函数（执行时机：组件卸载/下一次副作用执行前）</span>
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-comment">// 清理逻辑（如取消订阅、清除定时器）</span>
    };
  }, [依赖项数组]); <span class="hljs-comment">// 关键：依赖项决定副作用的执行时机</span>
}
</code></pre>
<h4 data-id="heading-3">语法拆解：</h4>
<ol>
<li>
<p><strong>第一个参数（必选）</strong> ：副作用函数</p>
<ul>
<li>可以是普通函数，执行核心的副作用逻辑；</li>
<li>可选返回一个<strong>清理函数</strong>（Cleanup Function），用于清除副作用（如取消定时器、解绑事件）。</li>
</ul>
</li>
<li>
<p><strong>第二个参数（可选）</strong> ：依赖项数组</p>
<ul>
<li>控制副作用的执行时机；</li>
<li>若省略：组件<strong>每次渲染后</strong>都会执行副作用；</li>
<li>若为空数组 <code>[]</code>：仅在组件<strong>挂载（mount）</strong>  时执行一次，清理函数在组件<strong>卸载（unmount）</strong>  时执行；</li>
<li>若包含依赖项（如 <code>[count, data]</code>）：仅在依赖项的值<strong>发生变化</strong>时执行副作用（挂载时执行第一次，后续仅依赖项变化触发）。</li>
</ul>
</li>
</ol>
<h3 data-id="heading-4">三、执行时机</h3>
<p><code>useEffect</code> 的执行时机是<strong>组件渲染完成后</strong>（浏览器绘制 DOM 之后），属于异步执行，不会阻塞浏览器的渲染，这一点与类组件的 <code>componentDidMount</code>/<code>componentDidUpdate</code> 一致。</p>
<h4 data-id="heading-5">不同依赖项的执行行为对比：</h4>






























<table><thead><tr><th>依赖项写法</th><th>执行时机</th><th>对应类组件生命周期</th></tr></thead><tbody><tr><td>无依赖项</td><td>每次组件渲染后（挂载 + 每次更新）</td><td>componentDidMount + componentDidUpdate</td></tr><tr><td>空数组 <code>[]</code></td><td>仅挂载时执行一次</td><td>componentDidMount</td></tr><tr><td>含依赖项 <code>[a, b]</code></td><td>挂载时执行 + 依赖项 a/b 变化时执行</td><td>自定义 componentDidUpdate</td></tr><tr><td>清理函数</td><td>卸载时执行 + 下一次副作用执行前执行</td><td>componentWillUnmount</td></tr></tbody></table>
<h3 data-id="heading-6">四、常见使用场景</h3>
<h4 data-id="heading-7">场景 1：仅挂载时执行（初始化）</h4>
<p>比如请求初始数据、添加全局事件监听：</p>
<pre><code class="hljs language-ini" lang="ini">import { useEffect, useState } from 'react'<span class="hljs-comment">;</span>

function UserList() {
  const <span class="hljs-section">[users, setUsers]</span> = useState(<span class="hljs-section">[]</span>)<span class="hljs-comment">;</span>

  // 仅挂载时请求数据（对应 componentDidMount）
  useEffect(() =&gt; {
    const <span class="hljs-attr">fetchUsers</span> = async () =&gt; {
      const <span class="hljs-attr">res</span> = await fetch(<span class="hljs-string">'https://api.example.com/users'</span>)<span class="hljs-comment">;</span>
      const <span class="hljs-attr">data</span> = await res.json()<span class="hljs-comment">;</span>
      setUsers(data)<span class="hljs-comment">;</span>
    }<span class="hljs-comment">;</span>
    fetchUsers()<span class="hljs-comment">;</span>
  }, <span class="hljs-section">[]</span>)<span class="hljs-comment">; // 空依赖：仅执行一次</span>

  return (
    &lt;ul&gt;
      {users.map(<span class="hljs-attr">user</span> =&gt; (
        &lt;li <span class="hljs-attr">key</span>={user.id}&gt;{user.name}&lt;/li&gt;
      ))}
    &lt;/ul&gt;
  )<span class="hljs-comment">;</span>
}
</code></pre>
<h4 data-id="heading-8">场景 2：依赖项变化时执行</h4>
<p>比如根据输入关键词筛选数据、监听状态变化：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { useEffect, useState } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">Search</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [keyword, setKeyword] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">''</span>);
  <span class="hljs-keyword">const</span> [result, setResult] = <span class="hljs-title function_">useState</span>([]);

  <span class="hljs-comment">// 关键词变化时请求数据</span>
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (!keyword) <span class="hljs-keyword">return</span>; <span class="hljs-comment">// 无关键词时不请求</span>

    <span class="hljs-keyword">const</span> timer = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-keyword">async</span> () =&gt; {
      <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">`https://api.example.com/search?kw=<span class="hljs-subst">${keyword}</span>`</span>);
      <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> res.<span class="hljs-title function_">json</span>();
      <span class="hljs-title function_">setResult</span>(data);
    }, <span class="hljs-number">300</span>); <span class="hljs-comment">// 防抖：300ms 后请求</span>

    <span class="hljs-comment">// 清理函数：取消定时器（关键词快速变化时避免无效请求）</span>
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">clearTimeout</span>(timer);
  }, [keyword]); <span class="hljs-comment">// 依赖：仅 keyword 变化时执行</span>

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{keyword}</span> <span class="hljs-attr">onChange</span>=<span class="hljs-string">{(e)</span> =&gt;</span> setKeyword(e.target.value)} /&gt;
      <span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span>{result.map(item =&gt; <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{item.id}</span>&gt;</span>{item.name}<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>)}<span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<h4 data-id="heading-9">场景 3：清理副作用（卸载时）</h4>
<p>比如清除定时器、取消 WebSocket 订阅、解绑事件：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { useEffect, useState } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">Timer</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// 挂载时启动定时器</span>
    <span class="hljs-keyword">const</span> timer = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-title function_">setCount</span>(<span class="hljs-function"><span class="hljs-params">prev</span> =&gt;</span> prev + <span class="hljs-number">1</span>);
    }, <span class="hljs-number">1000</span>);

    <span class="hljs-comment">// 清理函数：卸载时清除定时器（避免内存泄漏）</span>
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">clearInterval</span>(timer);
  }, []); <span class="hljs-comment">// 仅挂载时执行</span>

  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>Count: {count}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
}

<span class="hljs-comment">// 父组件控制 Timer 的挂载/卸载</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">Parent</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [show, setShow] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">true</span>);
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setShow(!show)}&gt;Toggle Timer<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      {show &amp;&amp; <span class="hljs-tag">&lt;<span class="hljs-name">Timer</span> /&gt;</span>}
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<h3 data-id="heading-10">五、关键注意事项</h3>
<h4 data-id="heading-11">1. 依赖项必须完整</h4>
<p>React 会根据依赖项数组的<strong>浅比较</strong>判断是否执行副作用，若依赖项缺失：</p>
<ul>
<li>副作用可能无法触发（依赖项变化但未声明）；</li>
<li>或捕获到过时的 state/prop（闭包陷阱）。</li>
</ul>
<p><strong>反例（错误）</strong> ：</p>
<pre><code class="hljs language-scss" lang="scss">function <span class="hljs-built_in">BadExample</span>() {
  const <span class="hljs-selector-attr">[count, setCount]</span> = <span class="hljs-built_in">useState</span>(<span class="hljs-number">0</span>);

  <span class="hljs-built_in">useEffect</span>(() =&gt; {
    <span class="hljs-comment">// 依赖 count，但未声明在数组中</span>
    const timer = <span class="hljs-built_in">setInterval</span>(() =&gt; {
      console<span class="hljs-selector-class">.log</span>(count); <span class="hljs-comment">// 始终打印 0（闭包捕获初始值）</span>
    }, <span class="hljs-number">1000</span>);
    return () =&gt; <span class="hljs-built_in">clearInterval</span>(timer);
  }, <span class="hljs-selector-attr">[]</span>); <span class="hljs-comment">// 错误：缺失 count 依赖</span>

  return &lt;<span class="hljs-selector-tag">button</span> onClick={() =&gt; <span class="hljs-built_in">setCount</span>(count + <span class="hljs-number">1</span>)}&gt;Click&lt;/<span class="hljs-selector-tag">button</span>&gt;;
}
</code></pre>
<p><strong>正例（正确）</strong> ：</p>
<pre><code class="hljs language-scss" lang="scss">function <span class="hljs-built_in">GoodExample</span>() {
  const <span class="hljs-selector-attr">[count, setCount]</span> = <span class="hljs-built_in">useState</span>(<span class="hljs-number">0</span>);

  <span class="hljs-built_in">useEffect</span>(() =&gt; {
    const timer = <span class="hljs-built_in">setInterval</span>(() =&gt; {
      console<span class="hljs-selector-class">.log</span>(count); <span class="hljs-comment">// 正确打印最新 count</span>
    }, <span class="hljs-number">1000</span>);
    return () =&gt; <span class="hljs-built_in">clearInterval</span>(timer);
  }, <span class="hljs-selector-attr">[count]</span>); <span class="hljs-comment">// 声明依赖 count</span>

  return &lt;<span class="hljs-selector-tag">button</span> onClick={() =&gt; <span class="hljs-built_in">setCount</span>(count + <span class="hljs-number">1</span>)}&gt;Click&lt;/<span class="hljs-selector-tag">button</span>&gt;;
}
</code></pre>
<h4 data-id="heading-12">2. 副作用函数不能是 async 函数</h4>
<p><code>useEffect</code> 的第一个参数若返回清理函数，则不能直接用 <code>async</code>（因为 <code>async</code> 函数返回 Promise，而非清理函数）。</p>
<p><strong>反例（错误）</strong> ：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">useEffect</span>(async () =&gt; {
  const res = await <span class="hljs-built_in">fetch</span>('/api/data');
  <span class="hljs-comment">// ...</span>
}, <span class="hljs-selector-attr">[]</span>); <span class="hljs-comment">// 错误：async 函数返回 Promise，无法返回清理函数</span>
</code></pre>
<p><strong>正例（正确）</strong> ：</p>
<pre><code class="hljs language-ini" lang="ini">useEffect(() =&gt; {
  // 内部定义 async 函数
  const <span class="hljs-attr">fetchData</span> = async () =&gt; {
    const <span class="hljs-attr">res</span> = await fetch(<span class="hljs-string">'/api/data'</span>)<span class="hljs-comment">;</span>
    // ...
  }<span class="hljs-comment">;</span>
  fetchData()<span class="hljs-comment">;</span>
}, <span class="hljs-section">[]</span>)<span class="hljs-comment">;</span>
</code></pre>
<h4 data-id="heading-13">3. 避免无限循环</h4>
<p>若副作用中修改了依赖项，且依赖项未正确控制，会导致无限执行：</p>
<p><strong>反例（错误）</strong> ：</p>
<pre><code class="hljs language-scss" lang="scss">function <span class="hljs-built_in">LoopExample</span>() {
  const <span class="hljs-selector-attr">[data, setData]</span> = <span class="hljs-built_in">useState</span>({});

  <span class="hljs-built_in">useEffect</span>(() =&gt; {
    <span class="hljs-comment">// 每次渲染都会创建新对象，依赖项浅比较为 false，触发无限执行</span>
    <span class="hljs-built_in">setData</span>({ name: 'test' });
  }, <span class="hljs-selector-attr">[data]</span>); <span class="hljs-comment">// 依赖 data，但修改了 data</span>

  return &lt;<span class="hljs-selector-tag">div</span>&gt;{data<span class="hljs-selector-class">.name</span>}&lt;/<span class="hljs-selector-tag">div</span>&gt;;
}
</code></pre>
<p><strong>解决方法</strong>：</p>
<ul>
<li>避免修改依赖项，或调整依赖项（如仅依赖必要字段）；</li>
<li>若必须修改，可使用函数式更新（<code>setData(prev =&gt; ({ ...prev, name: 'test' }))</code>）。</li>
</ul>
<h4 data-id="heading-14">4. 清理函数的执行时机</h4>
<p>清理函数不仅在组件卸载时执行，还会在<strong>下一次副作用执行前</strong>执行（比如依赖项变化时），用于清除上一次的副作用残留。</p>
<h3 data-id="heading-15">六、与类组件生命周期的对比</h3>

























<table><thead><tr><th>类组件生命周期</th><th>useEffect 实现方式</th></tr></thead><tbody><tr><td>componentDidMount</td><td><code>useEffect(() =&gt; { ... }, [])</code></td></tr><tr><td>componentDidUpdate</td><td><code>useEffect(() =&gt; { ... }, [dep1, dep2])</code></td></tr><tr><td>componentWillUnmount</td><td><code>useEffect(() =&gt; { return () =&gt; { ... } }, [])</code></td></tr><tr><td>合并三者</td><td><code>useEffect(() =&gt; { ... })</code>（无依赖项）</td></tr></tbody></table>
<h3 data-id="heading-16">总结</h3>
<p><code>useEffect</code> 的核心是<strong>声明式</strong>地处理副作用：</p>
<ol>
<li>通过依赖项数组控制执行时机，替代类组件的多个生命周期；</li>
<li>清理函数用于消除副作用的副作用（避免内存泄漏）；</li>
<li>依赖项必须完整且准确，避免闭包陷阱和无限循环；</li>
<li>异步逻辑需在副作用函数内部定义 <code>async</code> 函数，而非直接返回 Promise。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[吃透 npm、pnpm、npx：区别与实战用法全解析]]></title>    <link>https://juejin.cn/post/7590421489998168083</link>    <guid>https://juejin.cn/post/7590421489998168083</guid>    <pubDate>2026-01-03T13:03:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590421489998168083" data-draft-id="7590159073988804660" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="吃透 npm、pnpm、npx：区别与实战用法全解析"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-03T13:03:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Maxkim"/> <meta itemprop="url" content="https://juejin.cn/user/2768993424260451"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            吃透 npm、pnpm、npx：区别与实战用法全解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2768993424260451/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Maxkim
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-03T13:03:10.000Z" title="Sat Jan 03 2026 13:03:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252b3a}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px;color:#5e7ce0}.markdown-body h1{font-size:24px;margin-bottom:5px;margin-top:80px;position:relative;text-align:center}.markdown-body h2{font-size:20px;padding-bottom:12px;border-bottom:1px solid #dfe1e6}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:16px;margin-top:30px}.markdown-body h5{font-size:14px;margin-top:20px}.markdown-body h6{font-size:14px;margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #dfe1e6;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#ffeeed;color:#c73636;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#252b3a;background:#f8f8f8}.markdown-body a{position:relative;text-decoration:none;color:#5e7ce0;padding-right:18px;padding-bottom:4px}.markdown-body a[href^=http]:after{position:absolute;display:inline-block;width:16px;height:16px;margin-left:2px;margin-top:6px;content:"";background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAIRlWElmTU0AKgAAAAgABQESAAMAAAABAAEAAAEaAAUAAAABAAAASgEbAAUAAAABAAAAUgEoAAMAAAABAAIAAIdpAAQAAAABAAAAWgAAAAAAAABIAAAAAQAAAEgAAAABAAOgAQADAAAAAQABAACgAgAEAAAAAQAAACCgAwAEAAAAAQAAACAAAAAAX7wP8AAAAAlwSFlzAAALEwAACxMBAJqcGAAAAVlpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IlhNUCBDb3JlIDYuMC4wIj4KICAgPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4KICAgICAgPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIKICAgICAgICAgICAgeG1sbnM6dGlmZj0iaHR0cDovL25zLmFkb2JlLmNvbS90aWZmLzEuMC8iPgogICAgICAgICA8dGlmZjpPcmllbnRhdGlvbj4xPC90aWZmOk9yaWVudGF0aW9uPgogICAgICA8L3JkZjpEZXNjcmlwdGlvbj4KICAgPC9yZGY6UkRGPgo8L3g6eG1wbWV0YT4KGV7hBwAABWVJREFUWAnlVktsVFUY/s85997pC9BOTKxRWnEKsXWlxjWJj0RWJjrFAAXjAlewYWOkgauACVu7a2IiNUEyExM3yoZE3Wmi7qgPJthJBDE6JUNpO3Mf5/j95/bOTOcBlBgXejJ37rn/Of/7O/9/iP7vQ/zTAcjnC4ry+a5ii1OkiYTpuvjvEc0Gp51uivP+ZW+QBuSW4QjW5rptAa1Ey0uOGKOxwPetVyafN6p/52/PkNBbjdAhGaGEpMRjLZTryB8+9MUSYSGNRIcBvm8kBAY9tHYlHz78nTs392xIkwv9FA3Oe33bdoX1ZZKOS0bH0CXI6RugYLW6BwIu5gskkQ4sEG0wYF25PjBzbZfSYY6kDLUmWMt7FR7Lw3xYUkaTdjxHfTPnPwav0iEGYADVa9XIRIEyxrAA0jIQxgFL22gYwF7A8/DAzNVdksJvJaTEUZ2kYnZWziN5s1ADPHneEIXByotYuMSrf9JEbbsuv7VcvbaKML8plXtQR0EdIYDqWEmtOgAomZFH8EjWSnek2ulmtljljttHbmaIHCCCHzd9MjwfsmscBeZH9Jyd10nMvz92UQrtCBKvMF06mQy0SiEdRMEGg8mN0YjAlgoDDkPrMI5qJKSkKKydpbB2CZjJkhIBvOBw2CGQgii85bpx//dMqFRKam5uvH7w+K97oe+Cl0HO68uIBH0qyEzpOMwIbZIcFq0I+9cwoElizCjk2KFI1y7Nnx614W1db58fOXIlMzs7Xn/jeDmvBV2Q0mXjGf554O/m4LZHp2N8r61WPMvLZWLdiC4GMAk5BjeeB5lhv39l6+BIbu3m760hXMDKBD08XBKzR8fr04nygnIypOOAJUx/fHrsi0Mnys+vVK+V4VUohaiyPCo2Q9DFALvF/ikw8WS4QvVZALS5ksw47/7R8ejgTPk1UFqU6/3zp8bOM7B/kdu/fkguPGU5JibW+F0sTjWOUw8DklRrg4BiLGeBqbaRLxjlT4no0InFV402RcftJz41cH/f/JnHP3kZaaF6VX/liwist9vYG5+NU9Cg3MNkt/+lU5wS8fTxq3mc7ILjDlAE4CJpe89BOWPiIjBhi9O6PI4G1jsc6RGB3lZwmS76k8H0zOKTkFboG8jS2krFKCX2fvTeaPHIBwAkMHHgncURnL3nuCSnxSopdIzN5th0BIonJ0Lf9yUA9iMkzdRWl3BixOusfDcwQVcS4UKIFwYfGPnM8wY/DyP9NFMXaTE5BU39tGkDgGZz+fJJG0oYcSaOafLcqdECY4LzfSObSzyUOgxqtyisr8SSNOOAkubWoh3TTaeA2YtFEXPnm5x81/j+6MI6JqyS25WSNU6hbCMKHG84marJbdR+vwakRhQLRuQpbzHRLjmpmijI+OmWCtq+LzWtnX5v30gHSsqmWne74DtiACi2+Wz0iXbuLt9D2cDyoPEkWOiyp5XUIwLMi/wJY1FbH5B9ONtdC1KrsD/Q0MCQAS0wccILORDW25amAeOtooAj/KQxfzF17uwTSQ1v3dJ7jnLINwdZYRDa4tPU0sHVXFo/vxFF5BqFqxRfOmgPCk4ft2NgKTCy2Y47JIEg+MIhjYsLy5I25qUYTQlCjMRHsr/UwdYwIK33UO1J5fFNB9XNO6akcywJofVmXQDP2wfrSPcI2xG5BSs3I+IosHr4EtvO1TDAu16xHQq5+ykMblfRXLbhEoFIdDTBdhldvzl+3CMg60ZktI2vNzLW6IIp0waLklot9L63yzuUp8dJd7bglPFe3hIXstBEP58/s6Ocyr4rH2+866ZNbriTzA0RSOWCwakMl1QJgculxPt8Z7O5GLdtW6bvU8R/nO1vb+hMExVAVtEAAAAASUVORK5CYII=");background-size:100%}.markdown-body a:active,.markdown-body a:hover{border-bottom:2px solid #5e7ce0}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #5e7ce0;border-spacing:0}.markdown-body thead{color:#fff;text-align:left}.markdown-body thead tr{background:#5e7ce0}.markdown-body thead th{border-bottom:1px solid #dfe1e6}.markdown-body tr{background-color:#fff}.markdown-body tr:nth-child(2n){background-color:#f2f5fc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#252b3a;padding:1px 23px;margin:22px 0;border-left:4px solid #5e7ce0;background-color:#f2f5fc}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{padding-left:10px;margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#5e7ce0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body ul li::marker{content:"•";color:#5e7ce0}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}.markdown-body input[type=checkbox]:before{display:inline-block;width:16px;height:16px;content:"";background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEIAAABCCAYAAADjVADoAAAK2GlDQ1BJQ0MgUHJvZmlsZQAASImVlwdUU9kWhs+96Y0WiHRC70gngJTQQxGkg6iEJJBQYkgIKmJnUMGxoCKCZcSKKFhGQMaCWLANAopdJ8igoD4HC6Ki5t3AI8zMW++99fZaJ+dbO/vss/e55671XwAoYWyRKBdWAyBPWCCODQ2gJ6ek0nHPAQRgQAI2wIHNkYiYMTGRALHJ+a/28S4Sjdhte0Wuf///v5oGlyfhAAClIZzBlXDyEG5DxkuOSFwAAOoI4jddUCBScBfCmmKkQIR/V3DWBH9ScMY4o8njMfGxgQjTAcCT2WxxFgBkO8RPL+RkIXnIih4chVyBEOFihH05fDYX4TMI2+XlzVfwIMJWSLwIAApyOoCR8aecWX/Jn6HMz2ZnKXmir3HDBwkkolz2ov/zaP635eVKJ/ewQAaZLw6LVeyHnN/9nPkRShZmzIyeZAF3oiYF86VhCZPMkQSmTjKXHRShXJs7M3KSMwUhLGWeAlb8JPMkwXGTLJ4fq9wrUxzInGS2eHxfIsIyaU6C0s/nsZT5i/jxSZNcKEicOcmSnLiIqZhApV8sjVXWzxOGBkztG6LsPU/yp34FLOXaAn58mLJ39lT9PCFzKqckWVkblxcUPBWToIwXFQQo9xLlxijjebmhSr+kME65tgC5nFNrY5RnmM0Oj5lkIABRgA04dNVJAqCAt7BA0UjgfNEisSCLX0BnIm8bj84Schzs6M6Ozs4AKN7dievwnjb+TkK061O+NYjHr10ul5+e8oUi9/i4KfJYbk35LCsAUNUD4Op+jlRcOOFDK34wyNNTBZpABxgCU2AF7IEzcAfewB8Eg3AQDeJBCpiL1MoHeUAMFoBisAKUgnKwEWwF1WA32AsOgaPgBGgGZ8AFcAXcAF2gFzwCMjAAXoFh8BGMQRCEgygQFdKBjCBzyBZyhhiQLxQMRUKxUAqUDmVBQkgKFUOroHKoAqqG9kB10HHoNHQBugZ1Qw+gPmgIegd9gVEwGdaEDWALeDrMgJlwBBwPz4Gz4Hy4CC6B18NVcC18BG6CL8A34F5YBr+CR1AARULRUMYoexQDFYiKRqWiMlFi1FJUGaoSVYtqQLWiOlC3UTLUa9RnNBZNRdPR9mhvdBg6Ac1B56OXotehq9GH0E3oS+jb6D70MPo7hoLRx9hivDAsTDImC7MAU4qpxBzAnMJcxvRiBjAfsVgsDWuJ9cCGYVOw2djF2HXYndhGbBu2G9uPHcHhcDo4W5wPLhrHxhXgSnHbcUdw53E9uAHcJzwJb4R3xofgU/FC/Ep8Jf4w/hy+B/8CP0ZQI5gTvAjRBC5hEWEDYR+hlXCLMEAYI6oTLYk+xHhiNnEFsYrYQLxMfEx8TyKRTEiepFkkAWk5qYp0jHSV1Ef6TNYg25ADyWlkKXk9+SC5jfyA/J5CoVhQ/CmplALKekod5SLlKeWTClXFQYWlwlVZplKj0qTSo/JGlaBqrspUnatapFqpelL1luprNYKahVqgGlttqVqN2mm1e2oj6lR1J/Vo9Tz1deqH1a+pD2rgNCw0gjW4GiUaezUuavRTUVRTaiCVQ11F3Ue9TB3QxGpaarI0szXLNY9qdmoOa2louWolai3UqtE6qyWjoWgWNBYtl7aBdoJ2l/ZlmsE05jTetLXTGqb1TBvV1tP21+Zpl2k3avdqf9Gh6wTr5Ohs0mnWeaKL1rXRnaW7QHeX7mXd13qaet56HL0yvRN6D/VhfRv9WP3F+nv1b+qPGBgahBqIDLYbXDR4bUgz9DfMNtxieM5wyIhq5GskMNpidN7oJV2LzqTn0qvol+jDxvrGYcZS4z3GncZjJpYmCSYrTRpNnpgSTRmmmaZbTNtNh82MzKLMis3qzR6aE8wZ5nzzbeYd5qMWlhZJFqstmi0GLbUtWZZFlvWWj60oVn5W+Va1VnessdYM6xzrndZdNrCNmw3fpsbmli1s624rsN1p222HsfO0E9rV2t2zJ9sz7Qvt6+37HGgOkQ4rHZod3kw3m546fdP0junfHd0ccx33OT5y0nAKd1rp1Or0ztnGmeNc43zHheIS4rLMpcXlrautK891l+t9N6pblNtqt3a3b+4e7mL3BvchDzOPdI8dHvcYmowYxjrGVU+MZ4DnMs8znp+93L0KvE54/eFt753jfdh7cIblDN6MfTP6fUx82D57fGS+dN903598ZX7Gfmy/Wr9n/qb+XP8D/i+Y1sxs5hHmmwDHAHHAqYDRQK/AJYFtQaig0KCyoM5gjeCE4OrgpyEmIVkh9SHDoW6hi0PbwjBhEWGbwu6xDFgcVh1rONwjfEn4pQhyRFxEdcSzSJtIcWRrFBwVHrU56vFM85nCmc3RIJoVvTn6SYxlTH7ML7Ows2Jm1cx6HusUWxzbEUeNmxd3OO5jfED8hvhHCVYJ0oT2RNXEtMS6xNGkoKSKJFny9OQlyTdSdFMEKS2puNTE1AOpI7ODZ2+dPZDmllaadneO5ZyFc67N1Z2bO/fsPNV57Hkn0zHpSemH07+yo9m17JEMVsaOjGFOIGcb5xXXn7uFO8Tz4VXwXmT6ZFZkDmb5ZG3OGuL78Sv5rwWBgmrB2+yw7N3ZoznROQdz5LlJuY15+Lz0vNNCDWGO8NJ8w/kL53eLbEWlIlm+V/7W/GFxhPiABJLMkbQUaCIi6abUSvqDtK/Qt7Cm8NOCxAUnF6ovFC68uchm0dpFL4pCivYvRi/mLG4vNi5eUdy3hLlkz1JoacbS9mWmy0qWDSwPXX5oBXFFzopfVzqurFj5YVXSqtYSg5LlJf0/hP5QX6pSKi69t9p79e416DWCNZ1rXdZuX/u9jFt2vdyxvLL86zrOuus/Ov1Y9aN8feb6zg3uG3ZtxG4Ubry7yW/ToQr1iqKK/s1Rm5u20LeUbfmwdd7Wa5Wulbu3EbdJt8mqIqtatptt37j9azW/urcmoKZxh/6OtTtGd3J39uzy39Ww22B3+e4vPwl+ur8ndE9TrUVt5V7s3sK9z/cl7uvYz9hfd0D3QPmBbweFB2WHYg9dqvOoqzusf3hDPVwvrR86knak62jQ0ZYG+4Y9jbTG8mPgmPTYy+Ppx++eiDjRfpJxsuFn8593nKKeKmuCmhY1DTfzm2UtKS3dp8NPt7d6t576xeGXg2eMz9Sc1Tq74RzxXMk5+fmi8yNtorbXF7Iu9LfPa390MfninUuzLnVejrh89UrIlYsdzI7zV32unrnmde30dcb15hvuN5puut089avbr6c63Tubbnncauny7GrtntF9rsev58LtoNtX7rDu3Oid2dt9N+Hu/Xtp92T3ufcHH+Q+ePuw8OHYo+WPMY/Lnqg9qXyq/7T2N+vfGmXusrN9QX03n8U9e9TP6X/1u+T3rwMlzynPK18YvagbdB48MxQy1PVy9suBV6JXY69L/6H+jx1vrN78/If/HzeHk4cH3orfyt+te6/z/uAH1w/tIzEjTz/mfRwbLfuk8+nQZ8bnji9JX16MLfiK+1r1zfpb6/eI74/leXK5iC1mj0sBFDLgzEwA3h1EtHEKAFRElxNnT2jrcYMmvgfGCfwnntDf4+YOQAMyKWQR0x+Akwo5i8wqyKyQRPH+AHZxUY5/mSTTxXkiFxlRlphPcvl7AwBwrQB8E8vlYzvl8m/7kGIfANCWP6HpFYZFtHyD3vJRg6LbPe3g7zah9//U499noKjAFfx9/ieoZhkWVvYkwwAAAGxlWElmTU0AKgAAAAgABAEaAAUAAAABAAAAPgEbAAUAAAABAAAARgEoAAMAAAABAAIAAIdpAAQAAAABAAAATgAAAAAAAACQAAAAAQAAAJAAAAABAAKgAgAEAAAAAQAAAEKgAwAEAAAAAQAAAEIAAAAAgodoEQAAAAlwSFlzAAAWJQAAFiUBSVIk8AAAAhRJREFUeAHtnLEuBFEUhs9cu7JCskEhIrZAgYZGoREPwBuIygOoPITKA6jEG/AAolFoaFCgICIKZBNiY8Pyz5rNOWe9wNz5T7N3Z2eT/b/7zZlpziat3xKWBDJoEyh5EDd3DTk5r8vV7Yc8vzbl6zvfwvSERIYHyzI90SeLc1WZrFV85PR9oi+N/YMnOT6t/3tiLAeXFqqytjrSFacDYmfvQS6u37tOiPHA7FS/bK6PmWhpj4AJRYGA9MiKzLpK6An+cqiNVmRleUhArrec6PNzt/5sttLgh0cvcvfY6Px+ZNY9I6Ax6gKErY1xmZ8ZyD0E5MJGIgsyIZsunT3g7qALJuTdAp0nWyMTsunS2QNukbpwOcRaPpvOHvxzQow2ZBvrs+nsfLL8o0QQBJFdMO1XGkEjaIQlQCMsD/YIGkEjLAEaYXmwR9AIGmEJ0AjLgz2CRtAIS4BGWB7sETSCRlgCNMLyYI+gETTCEqARlgd7BI2gEZYAjbA82CNoBI2wBGiE5cEeQSNohCVAIywP9ggaQSMsARphebBH0AgaYQnQCMsjYC5SF2agYi2fTWcPGA7VFfO0n8+mswdMyOrCNJwnpz/P6xqZkE2Xzh4w8qcLI4Hbu/dydvkWBRAAQBZk0uOOyKyzp5PARRiF1puNtR+NTh+oMCvtJ+D8F2N6j6x+PrwzG46gRTDDm5BtsAGBg0X924Qfj7i23p7HNgQAAAAASUVORK5CYII=");background-size:100%;position:relative;right:2px;top:-5px}.markdown-body input[type=checkbox]:checked:before{background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEIAAABCCAYAAADjVADoAAAK2GlDQ1BJQ0MgUHJvZmlsZQAASImVlwdUU9kWhs+96Y0WiHRC70gngJTQQxGkg6iEJJBQYkgIKmJnUMGxoCKCZcSKKFhGQMaCWLANAopdJ8igoD4HC6Ki5t3AI8zMW++99fZaJ+dbO/vss/e55671XwAoYWyRKBdWAyBPWCCODQ2gJ6ek0nHPAQRgQAI2wIHNkYiYMTGRALHJ+a/28S4Sjdhte0Wuf///v5oGlyfhAAClIZzBlXDyEG5DxkuOSFwAAOoI4jddUCBScBfCmmKkQIR/V3DWBH9ScMY4o8njMfGxgQjTAcCT2WxxFgBkO8RPL+RkIXnIih4chVyBEOFihH05fDYX4TMI2+XlzVfwIMJWSLwIAApyOoCR8aecWX/Jn6HMz2ZnKXmir3HDBwkkolz2ov/zaP635eVKJ/ewQAaZLw6LVeyHnN/9nPkRShZmzIyeZAF3oiYF86VhCZPMkQSmTjKXHRShXJs7M3KSMwUhLGWeAlb8JPMkwXGTLJ4fq9wrUxzInGS2eHxfIsIyaU6C0s/nsZT5i/jxSZNcKEicOcmSnLiIqZhApV8sjVXWzxOGBkztG6LsPU/yp34FLOXaAn58mLJ39lT9PCFzKqckWVkblxcUPBWToIwXFQQo9xLlxijjebmhSr+kME65tgC5nFNrY5RnmM0Oj5lkIABRgA04dNVJAqCAt7BA0UjgfNEisSCLX0BnIm8bj84Schzs6M6Ozs4AKN7dievwnjb+TkK061O+NYjHr10ul5+e8oUi9/i4KfJYbk35LCsAUNUD4Op+jlRcOOFDK34wyNNTBZpABxgCU2AF7IEzcAfewB8Eg3AQDeJBCpiL1MoHeUAMFoBisAKUgnKwEWwF1WA32AsOgaPgBGgGZ8AFcAXcAF2gFzwCMjAAXoFh8BGMQRCEgygQFdKBjCBzyBZyhhiQLxQMRUKxUAqUDmVBQkgKFUOroHKoAqqG9kB10HHoNHQBugZ1Qw+gPmgIegd9gVEwGdaEDWALeDrMgJlwBBwPz4Gz4Hy4CC6B18NVcC18BG6CL8A34F5YBr+CR1AARULRUMYoexQDFYiKRqWiMlFi1FJUGaoSVYtqQLWiOlC3UTLUa9RnNBZNRdPR9mhvdBg6Ac1B56OXotehq9GH0E3oS+jb6D70MPo7hoLRx9hivDAsTDImC7MAU4qpxBzAnMJcxvRiBjAfsVgsDWuJ9cCGYVOw2djF2HXYndhGbBu2G9uPHcHhcDo4W5wPLhrHxhXgSnHbcUdw53E9uAHcJzwJb4R3xofgU/FC/Ep8Jf4w/hy+B/8CP0ZQI5gTvAjRBC5hEWEDYR+hlXCLMEAYI6oTLYk+xHhiNnEFsYrYQLxMfEx8TyKRTEiepFkkAWk5qYp0jHSV1Ef6TNYg25ADyWlkKXk9+SC5jfyA/J5CoVhQ/CmplALKekod5SLlKeWTClXFQYWlwlVZplKj0qTSo/JGlaBqrspUnatapFqpelL1luprNYKahVqgGlttqVqN2mm1e2oj6lR1J/Vo9Tz1deqH1a+pD2rgNCw0gjW4GiUaezUuavRTUVRTaiCVQ11F3Ue9TB3QxGpaarI0szXLNY9qdmoOa2louWolai3UqtE6qyWjoWgWNBYtl7aBdoJ2l/ZlmsE05jTetLXTGqb1TBvV1tP21+Zpl2k3avdqf9Gh6wTr5Ohs0mnWeaKL1rXRnaW7QHeX7mXd13qaet56HL0yvRN6D/VhfRv9WP3F+nv1b+qPGBgahBqIDLYbXDR4bUgz9DfMNtxieM5wyIhq5GskMNpidN7oJV2LzqTn0qvol+jDxvrGYcZS4z3GncZjJpYmCSYrTRpNnpgSTRmmmaZbTNtNh82MzKLMis3qzR6aE8wZ5nzzbeYd5qMWlhZJFqstmi0GLbUtWZZFlvWWj60oVn5W+Va1VnessdYM6xzrndZdNrCNmw3fpsbmli1s624rsN1p222HsfO0E9rV2t2zJ9sz7Qvt6+37HGgOkQ4rHZod3kw3m546fdP0junfHd0ccx33OT5y0nAKd1rp1Or0ztnGmeNc43zHheIS4rLMpcXlrautK891l+t9N6pblNtqt3a3b+4e7mL3BvchDzOPdI8dHvcYmowYxjrGVU+MZ4DnMs8znp+93L0KvE54/eFt753jfdh7cIblDN6MfTP6fUx82D57fGS+dN903598ZX7Gfmy/Wr9n/qb+XP8D/i+Y1sxs5hHmmwDHAHHAqYDRQK/AJYFtQaig0KCyoM5gjeCE4OrgpyEmIVkh9SHDoW6hi0PbwjBhEWGbwu6xDFgcVh1rONwjfEn4pQhyRFxEdcSzSJtIcWRrFBwVHrU56vFM85nCmc3RIJoVvTn6SYxlTH7ML7Ows2Jm1cx6HusUWxzbEUeNmxd3OO5jfED8hvhHCVYJ0oT2RNXEtMS6xNGkoKSKJFny9OQlyTdSdFMEKS2puNTE1AOpI7ODZ2+dPZDmllaadneO5ZyFc67N1Z2bO/fsPNV57Hkn0zHpSemH07+yo9m17JEMVsaOjGFOIGcb5xXXn7uFO8Tz4VXwXmT6ZFZkDmb5ZG3OGuL78Sv5rwWBgmrB2+yw7N3ZoznROQdz5LlJuY15+Lz0vNNCDWGO8NJ8w/kL53eLbEWlIlm+V/7W/GFxhPiABJLMkbQUaCIi6abUSvqDtK/Qt7Cm8NOCxAUnF6ovFC68uchm0dpFL4pCivYvRi/mLG4vNi5eUdy3hLlkz1JoacbS9mWmy0qWDSwPXX5oBXFFzopfVzqurFj5YVXSqtYSg5LlJf0/hP5QX6pSKi69t9p79e416DWCNZ1rXdZuX/u9jFt2vdyxvLL86zrOuus/Ov1Y9aN8feb6zg3uG3ZtxG4Ubry7yW/ToQr1iqKK/s1Rm5u20LeUbfmwdd7Wa5Wulbu3EbdJt8mqIqtatptt37j9azW/urcmoKZxh/6OtTtGd3J39uzy39Ww22B3+e4vPwl+ur8ndE9TrUVt5V7s3sK9z/cl7uvYz9hfd0D3QPmBbweFB2WHYg9dqvOoqzusf3hDPVwvrR86knak62jQ0ZYG+4Y9jbTG8mPgmPTYy+Ppx++eiDjRfpJxsuFn8593nKKeKmuCmhY1DTfzm2UtKS3dp8NPt7d6t576xeGXg2eMz9Sc1Tq74RzxXMk5+fmi8yNtorbXF7Iu9LfPa390MfninUuzLnVejrh89UrIlYsdzI7zV32unrnmde30dcb15hvuN5puut089avbr6c63Tubbnncauny7GrtntF9rsev58LtoNtX7rDu3Oid2dt9N+Hu/Xtp92T3ufcHH+Q+ePuw8OHYo+WPMY/Lnqg9qXyq/7T2N+vfGmXusrN9QX03n8U9e9TP6X/1u+T3rwMlzynPK18YvagbdB48MxQy1PVy9suBV6JXY69L/6H+jx1vrN78/If/HzeHk4cH3orfyt+te6/z/uAH1w/tIzEjTz/mfRwbLfuk8+nQZ8bnji9JX16MLfiK+1r1zfpb6/eI74/leXK5iC1mj0sBFDLgzEwA3h1EtHEKAFRElxNnT2jrcYMmvgfGCfwnntDf4+YOQAMyKWQR0x+Akwo5i8wqyKyQRPH+AHZxUY5/mSTTxXkiFxlRlphPcvl7AwBwrQB8E8vlYzvl8m/7kGIfANCWP6HpFYZFtHyD3vJRg6LbPe3g7zah9//U499noKjAFfx9/ieoZhkWVvYkwwAAAGxlWElmTU0AKgAAAAgABAEaAAUAAAABAAAAPgEbAAUAAAABAAAARgEoAAMAAAABAAIAAIdpAAQAAAABAAAATgAAAAAAAACQAAAAAQAAAJAAAAABAAKgAgAEAAAAAQAAAEKgAwAEAAAAAQAAAEIAAAAAgodoEQAAAAlwSFlzAAAWJQAAFiUBSVIk8AAABMtJREFUeAHtXM2KFDEQzrQKruIu4mEXRFlUVLz4A4K7B99AcO8io0/gwQfxDVzFuwu+gQf34EG8iOAPKAh6EFlBFMSf/qa2uqszlVR6ZtYxM5PDJNVVSer78nU6KrHzpyxuVlwx44AY2O0T8eb9D7f5fMu9fPvdff7y0/36nbdgdhUdd+jgHnf62JxbObvgjh/d60Pu2R35ajx49Mk9frqlBk7Kw8sXF9y1K4t9cCoi7tz/4F68/tYXMIkPzpzY725dP9yA1tsjoIRpIQHogRWYZSmwJ4Reh06nI2Nd7rYEA8zAzqXAxhgq/pc1d9vHKbEX+Dr4JbzypJDc/YxXYi/wifRLeOXpU5q7n/FK7EXsnBBeeRoqd7/EHj1ZhleeiMjdz8pArRKR+0pb+UsCuK0SkftKW/kzeFmrRHCAxWzufsaJOkqExWzufpOI8EpP1jnCJCK80pN1jjCJ4ICwMigidz/jRD3bI7bZUInIfaWt/KUSuK0SEd4jqFvufgYva5UIDrCYzd3POFFHifhfV/7k8lwPw7D5mUSEV3r854ju2pK7ffOIWzk/X+Go803Lr+ooGqoiwkyP9xzRXVt0q9sE3CgJYTLqfNPyE/irpkoEe2um6ck4bSiBSeD8JBl41jY/Hgd1lIiaaeoyLlsjgUGAjEH3DB4DtUpEW2Z3Mj5GAgA8efbVvXpX/200nln5IMYvKhHDrvylcwdc9+pSNdeg46WQsP7wo2s7fpWYaPT926fw9ZiVk4BpywYJkGuvlJs4EuWS0p/HTyHh3kbzH2najM85cR0lgpPiYMtukFB26m1u5Ua+vkFkWP3Zn0KCJDg1Px6f42Wtvhrhdyz8ncanrFKCmGH1wrwDMCrh/uxPIUFTAvdHbeVPsc1fVRE+c7Ud/k6fWt7XHFlYqcqQ5wTRvWpiY4wrIZwfDUL+akDRUBXB/jCzFCH9SHCzTDRUmsro7z+cEvrHwxOZn2ZTL/pVFcEBtRLoiWXfxQ5ehvoHHx4vpIwUEuJKSMvPz5/zQq0qwmIy5m+rjBQSwnsCQYnlgwjfT72av6oifOba2qnKcOXeGVIP0rT3BALTNr8mBWSpRHAgmJSTtLGhDHwj+A9GPCbX2DNiBSRoShg0H8zl5y/njxIhJ0WntralDJmIbO+UEvz85Zwt9wj7HIDB5Ttp7RkyGbRDSqC49vOjX50P9aexmr+qInzmajvtO13H02SpyrCVMNj8dT7/4BwByDXzRIC0LWXEldA/njVfip9GpV9VERxQM0lPhrVDyrCVMJr5/fwZJ+qWewR1lSuNJ21sXxnjVgIhck5VhM/cqG1WBpIAMX4Z9Xz+eP58sFUiOBArLQcZpQ0CNCXt1HzA5OfPOFGrrwYHyKTwbNJsxolaJUJbKeo0mu/4uMeXBHBbJSK88qP5jo97fAYva5UIDgivHEXk7mecqKNEhFeOhsjdbxKR+0pb+UsCuK0qIveVtvJn8LJWieAAi9nc/YwTdZQIi9nc/SYR4ZWenSO2yZvgcwTuRYZKWBnUI3e/xF7gcmio5L4HWPlL7AVuyPol95W28me8EnuBa8J+sZjM3c94JfYCd6VxTXjaCjDLe+K9cwTuSuOa8LQUYPXvh1d3w0HC7JK8kMK0/rcJfwHkVMYgi4xhOgAAAABJRU5ErkJggg==");background-size:100%}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>hello，大家新年快乐呀，最近在学习Vue源码时候，需要使用Monorepo进行包管理，结果运用到了“npx tsx --init”这个命令，于是我就开始疑惑为什么有的命令用 <code>npm i</code>，有的用 <code>pnpm add</code>，还有的要加 <code>npx</code> 前缀？于是便自己总结了如下的内容，分享给大家！</p>
</blockquote>
<h2 data-id="heading-0">一、先立核心认知：三者不是同一类工具</h2>
<p>很多人会把三者混为一谈，其实它们的定位天差地别！先看一张表快速 get 核心区别：</p>





























<table><thead><tr><th>工具名</th><th>核心定位</th><th>本质 / 所属关系</th><th>核心职责</th></tr></thead><tbody><tr><td><code>npm</code></td><td>Node.js 官方默认包管理器</td><td>随 Node.js 一同安装，官方标配</td><td>管理项目依赖（安装 / 卸载 / 更新 / 发布）</td></tr><tr><td><code>pnpm</code></td><td>高性能第三方替代包管理器</td><td>第三方工具，需手动安装</td><td>同 <code>npm</code> 核心职责，优化性能与磁盘占用</td></tr><tr><td><code>npx</code></td><td>Node 包执行工具</td><td>随 <code>npm@5.2.0+</code> 自带，非包管理器</td><td>执行 Node 包的可执行文件，不管理依赖</td></tr></tbody></table>
<p>划重点：<strong><code>npm</code> 和 <code>pnpm</code> 是「包管理器」，负责 “存放和管理依赖”；<code>npx</code> 是「执行工具」，负责 “运行依赖包”，三者不是同一维度的工具！</strong></p>
<h2 data-id="heading-1">二、逐个拆解：功能详解 + 代码示例</h2>
<h3 data-id="heading-2">1. npm：官方默认，稳字当头</h3>
<p><code>npm</code>（Node Package Manager）是前端开发者的入门标配，它的核心作用就是帮我们管理项目的依赖包，是生态最成熟、兼容性最好的包管理器。</p>
<h4 data-id="heading-3">核心功能（附代码示例）</h4>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/85c010baccff48848f77f0df48865660~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWF4a2lt:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768050191&amp;x-signature=TkbcibVbk5%2Faq%2BC5dVT3u5CQC8M%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-4">优点 &amp; 缺点</h4>
<ul>
<li>优点：兼容性拉满，无需额外配置，几乎支持所有 Node 项目，新手友好。</li>
<li>缺点：安装速度慢，磁盘占用高（嵌套 <code>node_modules</code>，依赖重复拷贝），部分场景会出现版本不一致问题，还可能产生幽灵依赖。</li>
</ul>
<h3 data-id="heading-5">2. pnpm：性能怪兽，省空间神器</h3>
<p><code>pnpm</code>（Performant npm）是针对 <code>npm</code> 痛点优化的第三方包管理器，核心功能和 <code>npm</code> 一致，但在「速度」和「磁盘占用」上实现了碾压级提升。而这一切的优势，都源于它的「全局缓存 + 硬链接 + 软链接」机制，同时它还能杜绝幽灵依赖。</p>
<h4 data-id="heading-6">核心优势（区别于 npm 的关键）</h4>
<ol>
<li><strong>安装速度超快</strong>：比 <code>npm</code> 快 2-5 倍，大型项目中差距更明显。</li>
<li><strong>极致省磁盘</strong>：采用「全局缓存 + 硬链接 / 符号链接」机制，同一个依赖的同一个版本，全局只存储 1 份，多个项目共享。比如：10 个项目都依赖 <code>react@18</code>，<code>npm</code> 会拷贝 10 份，<code>pnpm</code> 只存 1 份，大幅节省磁盘空间。</li>
<li><strong>杜绝幽灵依赖</strong>：<code>pnpm</code> 的 <code>node_modules</code> 结构更严谨，只有在 <code>package.json</code> 中声明的依赖才能被项目使用，避免隐式依赖问题。</li>
</ol>
<h4 data-id="heading-7">深度拆解：pnpm 核心机制（全局缓存 + 硬链接 + 软链接）</h4>
<p>在讲解之前，先给大家用通俗的语言解释两个概念，避免晦涩难懂：</p>
<ul>
<li><strong>硬链接（Hard Link）</strong> ：可以理解为「文件的副本快捷方式」,还可以直白理解成创建了一个word的副本，它和原文件共享同一份磁盘数据。比如你有一个文件 <code>A.txt</code>，给它创建一个硬链接 <code>B.txt</code>，修改 <code>A.txt</code> 内容，<code>B.txt</code> 也会同步变化；删除 <code>A.txt</code>，<code>B.txt</code> 依然可以正常使用（因为它指向的是磁盘数据，不是原文件本身）。</li>
<li><strong>软链接（Symbolic Link，也叫符号链接）</strong> ：可以理解为「Windows 的快捷方式 / Mac 的替身」，它本身不存储任何数据，只记录原文件的路径。比如给 <code>A.txt</code> 创建软链接 <code>C.txt</code>，打开 <code>C.txt</code> 其实是通过路径找到并打开 <code>A.txt</code>；如果删除 <code>A.txt</code>，<code>C.txt</code> 就会失效。</li>
<li><strong>全局缓存</strong>：<code>pnpm</code> 会在你的电脑上创建一个全局的缓存目录（Windows：<code>C:\Users&lt;用户名&gt;.pnpm-store</code>；Mac/Linux：<code>~/.pnpm-store</code>），所有通过 <code>pnpm</code> 下载的依赖包，都会先解压并存储到这个全局缓存中，同一个版本的依赖只存储一次。</li>
</ul>
<p>当你在项目中用 <code>pnpm add &lt;包名&gt;</code> 安装依赖时，<code>pnpm</code> 的工作流程是这样的：</p>
<ol>
<li>先检查全局缓存中是否存在该版本的依赖，如果不存在，就从 npm 仓库下载并存储到全局缓存；</li>
<li>在全局缓存中，给该依赖的文件创建「硬链接」到 <code>pnpm</code> 的虚拟存储目录；</li>
<li>在项目的 <code>node_modules</code> 中，创建「软链接」指向虚拟存储目录中的依赖文件；</li>
<li>最终项目的 <code>node_modules</code> 中，只有软链接，没有实际拷贝的依赖文件，实现了 “一份缓存，多项目共享”。</li>
</ol>
<p>通俗总结：<strong>全局缓存是 “仓库”，硬链接保证 “一份数据多处可用”，软链接负责 “项目找到依赖”，三者结合让 pnpm 既省空间又快。</strong></p>
<h4 data-id="heading-8">深度拆解：幽灵依赖（为什么 npm 有，pnpm 没有？）</h4>
<p>先明确：<strong>幽灵依赖（Phantom Dependency）就是项目中使用了没有在 <code>package.json</code> 中明确声明的依赖，但项目依然能正常运行的现象</strong>。</p>
<p>举个例子帮你理解：</p>
<ol>
<li>你在项目中用 <code>npm i react</code> 安装了 <code>react</code>，而 <code>react</code> 本身依赖 <code>react-dom</code>（这是 <code>react</code> 的依赖，不是你项目的直接依赖）；</li>
<li>由于 <code>npm</code> 会将所有依赖（直接依赖 + 间接依赖）扁平化到 <code>node_modules</code> 根目录，所以你在项目中即使没在 <code>package.json</code> 中声明 <code>react-dom</code>，也能直接导入并使用 <code>react-dom</code>；</li>
<li>这种情况就是幽灵依赖：你没明确安装 <code>react-dom</code>，却能使用它，看似方便，实则隐藏巨大风险 —— 如果某天 <code>react</code> 升级后不再依赖 <code>react-dom</code>，或者依赖的 <code>react-dom</code> 版本大幅变更，你的项目就会突然报错，难以排查。</li>
</ol>
<p>而 <code>pnpm</code> 为什么能杜绝幽灵依赖？因为 <code>pnpm</code> 的 <code>node_modules</code> 不是扁平化的，项目的 
<code>node_modules</code> 根目录下，只有你在 <code>package.json</code> 中明确声明的直接依赖，间接依赖会被放在虚拟存储目录中，项目无法直接访问未声明的间接依赖，自然就杜绝了幽灵依赖，让项目依赖更严谨、更可控。</p>
<h4 data-id="heading-9">核心功能（附代码示例，几乎兼容 npm 命令）</h4>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6a3d17e711a649b294f667c8f7393b67~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWF4a2lt:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768050191&amp;x-signature=O8n4Odc5s5Qh2Y7TSecJ66GVeJ8%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-10">优点 &amp; 缺点</h4>
<ul>
<li>优点：速度快、省磁盘、无幽灵依赖、完全兼容 <code>npm</code> 生态，依赖管理更严谨。</li>
<li>缺点：需要手动安装（非 Node 自带），极少数老旧项目可能存在兼容性问题（几乎可以忽略）。</li>
</ul>
<h3 data-id="heading-11">3. npx：包执行工具，告别全局安装</h3>
<p><code>npx</code> 最容易被误解为包管理器，但它<strong>根本不是用来管理依赖的</strong>，而是用来「执行 Node 包」的工具，解决了 <code>npm</code> 执行包的两大痛点。</p>
<h4 data-id="heading-12">解决的核心痛点</h4>
<ol>
<li>痛点 1：全局安装包容易导致版本冲突（比如 A 项目要 <code>create-react-app@5</code>，B 项目要 <code>create-react-app@4</code>）。</li>
<li>痛点 2：本地安装的包，无法直接在命令行执行（路径不在系统环境变量中）。</li>
</ol>
<h4 data-id="heading-13">核心功能（附代码示例，重点！）</h4>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2bf9e7feb58c47ba9353c07d56a15f39~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWF4a2lt:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768050191&amp;x-signature=xpHjaKeUVp8SZoSzscjYINVFsxI%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-14">核心特性</h4>
<ul>
<li>无需手动安装包，临时下载即执行。</li>
<li>优先使用本地包，避免版本冲突。</li>
<li>无需配置环境变量，自动识别可执行文件路径。</li>
</ul>
<h2 data-id="heading-15">三、实战场景：该用谁？怎么用？</h2>
<p>看完理论，我们结合实际开发场景，明确三者的使用选择：</p>








































<table><thead><tr><th>场景需求</th><th>推荐工具</th><th>命令示例</th></tr></thead><tbody><tr><td>新手入门、传统项目开发（追求兼容）</td><td>npm</td><td><code>npm i react</code>、<code>npm run dev</code></td></tr><tr><td>大型项目、多项目开发（追求性能 / 省空间 / 严谨性）</td><td>pnpm</td><td><code>pnpm add react</code>、<code>pnpm dev</code></td></tr><tr><td>临时执行脚手架（如 cra、vite）</td><td>npx</td><td><code>npx create-vite my-vite-app</code></td></tr><tr><td>临时运行 TS 文件、格式化代码等</td><td>npx</td><td><code>npx tsx src/index.ts</code>、<code>npx prettier --write .</code></td></tr><tr><td>执行本地安装的包（避免全局版本冲突）</td><td>npx</td><td><code>npx tsc --init</code>、<code>npx webpack</code></td></tr><tr><td>发布自己的 npm 包</td><td>npm/pnpm</td><td><code>npm publish</code>、<code>pnpm publish</code></td></tr></tbody></table>
<h2 data-id="heading-16">四、总结：核心区别一句话记牢</h2>
<ol>
<li><strong>身份差异</strong>：<code>npm</code>（官方包管理器）、<code>pnpm</code>（高性能包管理器）、<code>npx</code>（包执行工具，非包管理器）。</li>
<li><strong>职责差异</strong>：<code>npm</code>/<code>pnpm</code> 管「依赖的安装 / 卸载 / 管理」，<code>npx</code> 管「依赖的执行」。</li>
<li><strong>核心机制差异</strong>：<code>pnpm</code> 靠「全局缓存 + 硬链接 + 软链接」实现高性能和省磁盘，还能杜绝幽灵依赖；<code>npm</code> 无此机制，存在幽灵依赖风险。</li>
<li><strong>性能差异</strong>：<code>pnpm</code> &gt; <code>npm</code>（速度、磁盘占用全方位领先），<code>npx</code> 无此对比维度。</li>
<li><strong>使用差异</strong>：兼容优先用 <code>npm</code>，性能 / 严谨性优先用 <code>pnpm</code>，临时执行 / 避免版本冲突用 <code>npx</code>。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[自定义 Hooks 的用法和意义详解（结合案例）]]></title>    <link>https://juejin.cn/post/7590601860300619803</link>    <guid>https://juejin.cn/post/7590601860300619803</guid>    <pubDate>2026-01-03T13:13:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590601860300619803" data-draft-id="7590699877630558246" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="自定义 Hooks 的用法和意义详解（结合案例）"/> <meta itemprop="keywords" content="前端,React.js"/> <meta itemprop="datePublished" content="2026-01-03T13:13:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="冻梨政哥"/> <meta itemprop="url" content="https://juejin.cn/user/2373184444182659"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            自定义 Hooks 的用法和意义详解（结合案例）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2373184444182659/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    冻梨政哥
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-03T13:13:45.000Z" title="Sat Jan 03 2026 13:13:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">自定义 Hooks 的用法和意义详解（结合案例）</h2>
<h5 data-id="heading-1">一、什么是自定义 Hooks？</h5>
<p>自定义 Hooks 是 React 中<strong>复用状态逻辑</strong>的一种机制，本质是一个以<code>use</code>开头的函数，内部可以调用其他 Hooks（包括内置 Hooks 如<code>useState</code>、<code>useEffect</code>或其他自定义 Hooks）。它的核心作用是将组件中重复的状态管理、副作用处理等逻辑提取出来，实现逻辑复用，让组件更专注于 UI 渲染。</p>
<h5 data-id="heading-2">二、案例解析：自定义 Hooks 的实现与使用</h5>
<h6 data-id="heading-3">1. 案例 1：<code>useMouse</code>—— 封装鼠标位置监听逻辑</h6>
<p><strong>功能</strong>：实时获取鼠标在页面上的坐标，并在组件卸载时自动清除事件监听，避免内存泄漏。</p>
<h6 data-id="heading-4">（1）<code>useMouse</code>的实现（<code>useMouse.js</code>）</h6>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { useState, useEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>

<span class="hljs-comment">// 自定义Hooks必须以use开头</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">useMouse</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-comment">// 1. 用useState保存鼠标坐标状态</span>
  <span class="hljs-keyword">const</span> [x, setX] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);
  <span class="hljs-keyword">const</span> [y, setY] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);

  <span class="hljs-comment">// 2. 用useEffect处理副作用（添加/清除鼠标移动事件）</span>
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// 定义事件处理函数：更新鼠标坐标</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">update</span> = (<span class="hljs-params">event</span>) =&gt; {
      <span class="hljs-title function_">setX</span>(event.<span class="hljs-property">pageX</span>); <span class="hljs-comment">// 更新x坐标</span>
      <span class="hljs-title function_">setY</span>(event.<span class="hljs-property">pageY</span>); <span class="hljs-comment">// 更新y坐标</span>
    };

    <span class="hljs-comment">// 绑定鼠标移动事件</span>
    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'mousemove'</span>, update);

    <span class="hljs-comment">// 3. 清除副作用：组件卸载时移除事件监听（防止内存泄漏）</span>
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'mousemove'</span>, update);
    };
  }, []); <span class="hljs-comment">// 空依赖数组：只在组件挂载时执行一次</span>

  <span class="hljs-comment">// 4. 返回需要暴露的状态（鼠标坐标）</span>
  <span class="hljs-keyword">return</span> { x, y };
}
</code></pre>
<p>（2）<code>useMouse</code>的使用（<code>App.jsx</code>中的<code>MouseMove</code>组件）</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">MouseMove</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 直接调用自定义Hooks，获取鼠标坐标</span>
  <span class="hljs-keyword">const</span> { x, y } = <span class="hljs-title function_">useMouse</span>();
  
  <span class="hljs-keyword">return</span>(
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      鼠标位置: {x} {y} {/* 只专注于UI渲染，无需关心事件逻辑 */}
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  )
}
</code></pre>
<h6 data-id="heading-5">（3）逻辑解析</h6>
<ul>
<li><strong>复用性</strong>：如果其他组件也需要获取鼠标位置，直接调用<code>useMouse()</code>即可，无需重复编写事件绑定 / 清除逻辑。</li>
<li><strong>关注点分离</strong>：组件（<code>MouseMove</code>）只负责渲染 UI，鼠标监听的业务逻辑被封装在<code>useMouse</code>中，代码结构更清晰。</li>
<li><strong>避免内存泄漏</strong>：通过<code>useEffect</code>的返回函数清除事件监听，确保组件卸载后不再执行无用逻辑。</li>
</ul>
<h6 data-id="heading-6">2. 案例 2：<code>useTodos</code>—— 封装待办事项管理逻辑</h6>
<p><strong>功能</strong>：管理待办事项的增、删、改状态，并自动同步到<code>localStorage</code>（刷新页面后数据不丢失）。</p>
<h6 data-id="heading-7">（1）<code>useTodos</code>的实现（<code>useTodos.js</code>）</h6>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { useState, useEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">STORAGE_KEY</span> = <span class="hljs-string">'todos'</span>; <span class="hljs-comment">// 本地存储的key（便于维护）</span>

<span class="hljs-comment">// 从localStorage加载待办事项</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">loadFromStorage</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> storedTodos = <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(<span class="hljs-variable constant_">STORAGE_KEY</span>);
  <span class="hljs-keyword">return</span> storedTodos ? <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(storedTodos) : [];
}

<span class="hljs-comment">// 保存待办事项到localStorage</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">saveToStorage</span>(<span class="hljs-params">todos</span>) {
  <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">setItem</span>(<span class="hljs-variable constant_">STORAGE_KEY</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(todos));
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">useTodos</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-comment">// 1. 用useState初始化待办事项（从本地存储加载）</span>
  <span class="hljs-keyword">const</span> [todos, setTodos] = <span class="hljs-title function_">useState</span>(loadFromStorage);

  <span class="hljs-comment">// 2. 用useEffect同步数据到localStorage（todos变化时触发）</span>
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">saveToStorage</span>(todos);
  }, [todos]); <span class="hljs-comment">// 依赖todos：只有todos变化时才执行</span>

  <span class="hljs-comment">// 3. 定义添加待办事项的方法</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">addTodo</span> = (<span class="hljs-params">text</span>) =&gt; {
    <span class="hljs-title function_">setTodos</span>([
      ...todos,
      { <span class="hljs-attr">id</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>(), text, <span class="hljs-attr">completed</span>: <span class="hljs-literal">false</span> } <span class="hljs-comment">// 生成新的待办项</span>
    ]);
  };

  <span class="hljs-comment">// 4. 定义切换待办事项完成状态的方法</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">toggleTodo</span> = (<span class="hljs-params">id</span>) =&gt; {
    <span class="hljs-title function_">setTodos</span>(todos.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">todo</span> =&gt;</span> 
      todo.<span class="hljs-property">id</span> === id ? { ...todo, <span class="hljs-attr">completed</span>: !todo.<span class="hljs-property">completed</span> } : todo
    ));
  };

  <span class="hljs-comment">// 5. 定义删除待办事项的方法</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">deleteTodo</span> = (<span class="hljs-params">id</span>) =&gt; {
    <span class="hljs-title function_">setTodos</span>(todos.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">todo</span> =&gt;</span> todo.<span class="hljs-property">id</span> !== id));
  };

  <span class="hljs-comment">// 6. 返回状态和方法（供组件使用）</span>
  <span class="hljs-keyword">return</span> { todos, addTodo, toggleTodo, deleteTodo };
}
</code></pre>
<p>（2）<code>useTodos</code>的使用（<code>App.jsx</code>）</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { useTodos } <span class="hljs-keyword">from</span> <span class="hljs-string">'./hooks/useTodos.js'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">TodoList</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./components/TodoList.jsx'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">TodoInput</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./components/TodoInput.jsx'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 调用自定义Hooks，获取待办事项的状态和操作方法</span>
  <span class="hljs-keyword">const</span> { todos, addTodo, toggleTodo, deleteTodo } = <span class="hljs-title function_">useTodos</span>();

  <span class="hljs-keyword">return</span>(
    <span class="xml"><span class="hljs-tag">&lt;&gt;</span>
      {/* 传入addTodo方法给输入组件 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">TodoInput</span> <span class="hljs-attr">addTodo</span>=<span class="hljs-string">{addTodo}/</span>&gt;</span>
      {/* 根据todos状态渲染列表或提示文本 */}
      {
        todos.length &gt; 0 ? (
          <span class="hljs-tag">&lt;<span class="hljs-name">TodoList</span> 
            <span class="hljs-attr">onDelete</span>=<span class="hljs-string">{deleteTodo}</span>
            <span class="hljs-attr">onToggle</span>=<span class="hljs-string">{toggleTodo}</span>
            <span class="hljs-attr">todos</span>=<span class="hljs-string">{todos}</span>
          /&gt;</span>
        ) : (
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>暂无待办事项<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        )
      }
    <span class="hljs-tag">&lt;/&gt;</span></span>
  )
}
</code></pre>
<h6 data-id="heading-8">（3）逻辑解析</h6>
<ul>
<li><strong>状态复用</strong>：待办事项的加载、保存、增删改逻辑被完全封装，任何需要待办功能的组件都可以通过<code>useTodos</code>复用。</li>
<li><strong>简化组件</strong>：<code>App</code>组件无需关心<code>localStorage</code>操作、状态更新细节，只需调用方法和渲染 UI，代码量大幅减少。</li>
<li><strong>一致性</strong>：所有与待办相关的逻辑集中管理，避免多处重复代码导致的维护问题（如修改存储 key 时只需改一处）。</li>
</ul>
<h5 data-id="heading-9">三、自定义 Hooks 的核心意义</h5>
<ol>
<li><strong>逻辑复用</strong>解决了类组件中 “混入（mixin）” 带来的命名冲突、依赖混乱等问题，通过函数调用的方式优雅复用状态逻辑（如<code>useMouse</code>和<code>useTodos</code>可在任意组件中重复使用）。</li>
<li><strong>关注点分离</strong>将组件中的 “业务逻辑”（如事件监听、数据存储）与 “UI 渲染” 分离，使组件更简洁，便于阅读和维护（组件只关心渲染，Hooks 只关心逻辑）。</li>
<li><strong>可测试性</strong>自定义 Hooks 是纯函数，可独立于组件进行单元测试，验证逻辑正确性（如测试<code>useTodos</code>的<code>addTodo</code>方法是否正确添加数据）。</li>
<li><strong>代码一致性</strong>团队中可通过自定义 Hooks 统一业务逻辑的实现方式（如所有数据持久化都用类似<code>useTodos</code>的模式），降低协作成本。</li>
</ol>
<h5 data-id="heading-10">四、自定义 Hooks 的使用规范</h5>
<ul>
<li>必须以<code>use</code>开头（如<code>useMouse</code>、<code>useTodos</code>），React 通过命名识别 Hooks，确保 Hooks 的规则（如只能在顶层调用）被遵守。</li>
<li>内部可以调用其他 Hooks（内置或自定义），但不能在条件语句、循环中调用（需遵循 React Hooks 的调用规则）。</li>
<li>必须返回组件需要的状态或方法（通常是对象或数组，便于解构使用）。</li>
</ul>
<p>通过上述案例可以看出，自定义 Hooks 是 React 中提升代码复用性和可维护性的重要手段，尤其在中大型应用中能显著减少重复代码，让逻辑更清晰。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Python 效率飞升术：3基础进阶小工具，少写 100 行循环]]></title>    <link>https://juejin.cn/post/7590676494924103718</link>    <guid>https://juejin.cn/post/7590676494924103718</guid>    <pubDate>2026-01-03T13:55:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590676494924103718" data-draft-id="7590699877630656550" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Python 效率飞升术：3基础进阶小工具，少写 100 行循环"/> <meta itemprop="keywords" content="Python"/> <meta itemprop="datePublished" content="2026-01-03T13:55:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="AAA简单玩转程序设计"/> <meta itemprop="url" content="https://juejin.cn/user/4294056357689099"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Python 效率飞升术：3基础进阶小工具，少写 100 行循环
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4294056357689099/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    AAA简单玩转程序设计
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-03T13:55:10.000Z" title="Sat Jan 03 2026 13:55:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>还在手动写循环处理数据？Python 里这几个 “懒人神器”，看似基础却能直接拉高代码效率，新手也能秒上手！</p>
<h2 data-id="heading-0">1. <code>itertools</code> ：循环偷懒神器，少写 N 行重复代码</h2>
<p>处理迭代器时，<code>itertools</code> 里的方法能帮你实现各种花式循环，不用再手写嵌套逻辑。最常用的就是 <code>cycle</code>（无限循环）和 <code>chain</code>（拼接迭代器）。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> itertools

<span class="hljs-comment"># 需求1：循环遍历列表，到末尾后从头再来</span>
colors = [<span class="hljs-string">"red"</span>, <span class="hljs-string">"green"</span>, <span class="hljs-string">"blue"</span>]
color_cycle = itertools.cycle(colors)

<span class="hljs-comment"># 取前5个元素（演示用，实际可无限取）</span>
<span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">5</span>):
    <span class="hljs-built_in">print</span>(<span class="hljs-built_in">next</span>(color_cycle))
<span class="hljs-comment"># 输出：red green blue red green</span>

<span class="hljs-comment"># 需求2：拼接多个列表，避免创建新列表占用内存</span>
list1 = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>]
list2 = [<span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>]
combined = itertools.chain(list1, list2)

<span class="hljs-keyword">for</span> num <span class="hljs-keyword">in</span> combined:
    <span class="hljs-built_in">print</span>(num, end=<span class="hljs-string">" "</span>)  <span class="hljs-comment"># 输出：1 2 3 4 5 6</span>
</code></pre>
<h2 data-id="heading-1">2. <code>collections.defaultdict</code> ：字典分组不翻车，告别 KeyError</h2>
<p>用普通字典分组时，得先判断键是否存在，而 <code>defaultdict</code> 能直接指定默认值类型，分组代码一步到位。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> collections <span class="hljs-keyword">import</span> defaultdict

<span class="hljs-comment"># 需求：把学生按成绩等级分组</span>
students = [
    (<span class="hljs-string">"小明"</span>, <span class="hljs-string">"A"</span>),
    (<span class="hljs-string">"小红"</span>, <span class="hljs-string">"B"</span>),
    (<span class="hljs-string">"小刚"</span>, <span class="hljs-string">"A"</span>),
    (<span class="hljs-string">"小美"</span>, <span class="hljs-string">"B"</span>)
]

<span class="hljs-comment"># 传统字典写法：繁琐且易出错</span>
grade_dict = {}
<span class="hljs-keyword">for</span> name, grade <span class="hljs-keyword">in</span> students:
    <span class="hljs-keyword">if</span> grade <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> grade_dict:
        grade_dict[grade] = []
    grade_dict[grade].append(name)
<span class="hljs-built_in">print</span>(grade_dict)  <span class="hljs-comment"># {'A': ['小明', '小刚'], 'B': ['小红', '小美']}</span>

<span class="hljs-comment"># defaultdict 写法：简洁高效</span>
default_grade = defaultdict(<span class="hljs-built_in">list</span>)
<span class="hljs-keyword">for</span> name, grade <span class="hljs-keyword">in</span> students:
    default_grade[grade].append(name)
<span class="hljs-built_in">print</span>(<span class="hljs-built_in">dict</span>(default_grade))  <span class="hljs-comment"># 结果同上</span>
</code></pre>
<h2 data-id="heading-2">3. <code>enumerate</code> 进阶用法：自定义起始索引，循环更灵活</h2>
<p>基础的 <code>enumerate</code> 大家都会用，但自定义起始索引这个小细节，能让循环结果更贴合实际需求，不用再手动 <code>+1</code>。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 需求：打印学生排名，从1开始计数</span>
names = [<span class="hljs-string">"张三"</span>, <span class="hljs-string">"李四"</span>, <span class="hljs-string">"王五"</span>]

<span class="hljs-comment"># 基础用法：默认从0开始</span>
<span class="hljs-keyword">for</span> idx, name <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(names):
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"第<span class="hljs-subst">{idx+<span class="hljs-number">1</span>}</span>名：<span class="hljs-subst">{name}</span>"</span>)  <span class="hljs-comment"># 手动+1，麻烦</span>

<span class="hljs-comment"># 进阶用法：指定start参数，直接从1开始</span>
<span class="hljs-keyword">for</span> idx, name <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(names, start=<span class="hljs-number">1</span>):
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"第<span class="hljs-subst">{idx}</span>名：<span class="hljs-subst">{name}</span>"</span>)
<span class="hljs-comment"># 输出：</span>
<span class="hljs-comment"># 第1名：张三</span>
<span class="hljs-comment"># 第2名：李四</span>
<span class="hljs-comment"># 第3名：王五</span>
</code></pre>
<hr/>
<h3 data-id="heading-3">小总结</h3>
<ol>
<li><code>itertools</code> 能简化迭代器操作，减少重复循环代码；</li>
<li><code>defaultdict</code> 是字典分组的 “利器”，避免手动判断键是否存在；</li>
<li><code>enumerate</code> 指定 <code>start</code> 参数，能直接得到符合需求的索引。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Monorepo 各包间正确的通信方式]]></title>    <link>https://juejin.cn/post/7590608345923452954</link>    <guid>https://juejin.cn/post/7590608345923452954</guid>    <pubDate>2026-01-03T14:10:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590608345923452954" data-draft-id="7590676494924038182" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Monorepo 各包间正确的通信方式"/> <meta itemprop="keywords" content="前端,架构,代码规范"/> <meta itemprop="datePublished" content="2026-01-03T14:10:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="在西安放羊的牛油果"/> <meta itemprop="url" content="https://juejin.cn/user/2946346894233133"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Monorepo 各包间正确的通信方式
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2946346894233133/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    在西安放羊的牛油果
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-03T14:10:33.000Z" title="Sat Jan 03 2026 14:10:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">概述</h2>
<p>Monorepo（Monolithic Repository）指的是把多个包（项目）的代码，统一放在同一个代码仓库里进行管理的一种仓库组织方式。适合多个项目强相关且有大量共享代码的中大型项目。使用 Monorepo 管理项目的好处非常明显，它不用发 npm 包，不用来回同步版本，改完公共库，所有项目立即可用，使得共享代码更简单。
Monorepo 是存放多个包的仓库，包之间的通信方式至关重要，接下来我们以一个交易项目为例，一步一步了解 Monorepo 各包间正确的通信方式。</p>
<h2 data-id="heading-1">交易平台项目简述</h2>
<p>该项目是一个给用户提供股票交易服务的平台。项目包括交易（Trade）、资产（Portfolios）、行情（Quotes）、市场（Market）等模块。项目还有提供公共方法、UI、数据等公共模块。</p>
<h2 data-id="heading-2">交易平台各包之间的通信问题</h2>
<h3 data-id="heading-3">包之间的依赖关系不合理</h3>
<p>包之间出现循环依赖问题，业务包依赖业务包。</p>
<pre><code class="hljs language-ts" lang="ts">├── <span class="hljs-meta">@repo</span>/shared ←→ <span class="hljs-meta">@repo</span>/trade (循环依赖)
├── <span class="hljs-meta">@repo</span>/account → <span class="hljs-meta">@repo</span>/trade (不合理)
├── <span class="hljs-meta">@repo</span>/quote → <span class="hljs-meta">@repo</span>/trade (不合理)
├── <span class="hljs-meta">@repo</span>/portfolios → <span class="hljs-meta">@repo</span>/trade (不合理)
└── ...
</code></pre>
<h3 data-id="heading-4">封装性破坏：直接访问包内部实现</h3>
<p>直接导入其他包的内部路径</p>
<pre><code class="hljs language-ts" lang="ts">  <span class="hljs-comment">// packages/shared/utils/order.ts</span>
  <span class="hljs-keyword">import</span> { <span class="hljs-title class_">EOrderVerify</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@repo/trade/data'</span>;
  <span class="hljs-keyword">import</span> { canFillSearch } <span class="hljs-keyword">from</span> <span class="hljs-string">'@repo/trade/utils'</span>;
  
  <span class="hljs-comment">// packages/shared/reports/modules/trade.ts</span>
  <span class="hljs-keyword">import</span> { <span class="hljs-title class_">ECondOrderVerifyParaKey</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@pkg/trade/data/sensors'</span>;
  <span class="hljs-keyword">import</span> { getIsEntrustType } <span class="hljs-keyword">from</span> <span class="hljs-string">'@pkg/trade/utils/type'</span>;
  <span class="hljs-keyword">import</span> { useIndexSession, useNightTradeSession } <span class="hljs-keyword">from</span> <span class="hljs-string">'@repo/trade/utils/hooks'</span>;
</code></pre>
<h3 data-id="heading-5">紧耦合：直接依赖应用层 stores</h3>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// packages/shared/utils/order.ts</span>
<span class="hljs-keyword">import</span> { useConfigStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/stores/config'</span>;
<span class="hljs-keyword">import</span> { useMarketStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/stores/market.ts'</span>;
<span class="hljs-keyword">import</span> { usePasswordStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/stores/password'</span>;
<span class="hljs-keyword">import</span> { useTradeStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/stores/trade'</span>;
<span class="hljs-keyword">import</span> { useUserStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/stores/user'</span>;

<span class="hljs-comment">// packages/trade/utils/verify.ts</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">EStatementType</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/stores/quote-statement.ts'</span>;

<span class="hljs-comment">// packages/portfolios/components/orders/index.vue</span>
<span class="hljs-keyword">import</span> { useMarketStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/stores/market'</span>;
<span class="hljs-keyword">import</span> { useOrderStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/stores/order'</span>;
</code></pre>
<h2 data-id="heading-6">项目包间正确通信方式</h2>
<h3 data-id="heading-7">一、依赖层次原则</h3>
<h4 data-id="heading-8">1.1 依赖层次结构</h4>
<pre><code class="hljs language-ts" lang="ts">┌─────────────────────────────────────┐
│         apps/web (应用层)            │
│  依赖所有业务包，负责组装和路由      │
└─────────────────────────────────────┘
              │
              ├─────────────────────────────────────┐
              │                                     │
┌─────────────▼──────────────┐  ┌──────────────────▼──────────────┐
│   业务包 (<span class="hljs-title class_">Business</span>)        │  │   基础包 (<span class="hljs-title class_">Foundation</span>)            │
│  - trade                   │  │  - shared (不依赖其他业务包)     │
│  - account                 │  │  - data-center                  │
│  - quote                   │  │  - ui                            │
│  - portfolios              │  │                                  │
│  - company                 │  │                                  │
│  - market                  │  │                                  │
│  - ...                     │  │                                  │
└────────────────────────────┘  └──────────────────────────────────┘
</code></pre>
<h4 data-id="heading-9">1.2 依赖规则</h4>
<h5 data-id="heading-10">✅ 允许的依赖方向</h5>
<ol>
<li><strong>应用层</strong> → 所有包</li>
<li><strong>业务包</strong> → 基础包（shared, data-center, ui）</li>
<li><strong>基础包</strong> → 只依赖更底层的基础包或外部库</li>
<li><strong>shared 包</strong> → 不依赖任何业务包</li>
</ol>
<h5 data-id="heading-11">❌ 禁止的依赖方向</h5>
<ol>
<li><strong>基础包</strong> → 业务包（如 shared → trade）</li>
<li><strong>业务包</strong> → 业务包（如 account → trade）</li>
<li><strong>循环依赖</strong>（如 shared ↔ trade）</li>
</ol>
<h4 data-id="heading-12">1.3 依赖层次示例</h4>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// ✅ 正确：业务包依赖基础包</span>
<span class="hljs-comment">// packages/trade/package.json</span>
{
  <span class="hljs-string">"dependencies"</span>: {
    <span class="hljs-string">"@repo/shared"</span>: <span class="hljs-string">"workspace: "</span> ,
 <span class="hljs-string">"@repo/data-center"</span> :  <span class="hljs-string">"workspace: "</span>,
    <span class="hljs-string">"@repo/ui"</span>: <span class="hljs-string">"workspace:*"</span>
  }
}

<span class="hljs-comment">// ❌ 错误：基础包依赖业务包</span>
<span class="hljs-comment">// packages/shared/package.json</span>
{
  <span class="hljs-string">"dependencies"</span>: {
    <span class="hljs-string">"@repo/trade"</span>: <span class="hljs-string">"workspace:*"</span>  <span class="hljs-comment">// ❌ 不应该依赖业务包</span>
  }
}
</code></pre>
<h3 data-id="heading-13">二、通信模式</h3>
<h4 data-id="heading-14">2.1 事件通信模式（Event Bus）</h4>
<p><strong>适用场景</strong>：</p>
<ol>
<li>包间的松耦合通信</li>
<li>一对多的通知场景</li>
<li>异步事件通知</li>
</ol>
<p><strong>实现方式</strong>：</p>
<ol>
<li>定义事件类型（在 shared 包中）</li>
</ol>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// packages/shared/events/index.ts</span>
<span class="hljs-keyword">import</span> mitt <span class="hljs-keyword">from</span> <span class="hljs-string">'mitt'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">EEventBusType</span> {
  <span class="hljs-variable constant_">ORDER_SUCCESS</span> = <span class="hljs-string">'orderSuccess'</span>,
  <span class="hljs-variable constant_">USER_LOGIN_SUCCESS</span> = <span class="hljs-string">'userLoginSuccess'</span>,
  <span class="hljs-comment">// ...</span>
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">type</span> <span class="hljs-title class_">TEvents</span> = {
  [<span class="hljs-title class_">EEventBusType</span>.<span class="hljs-property">ORDER_SUCCESS</span>]?: {
    <span class="hljs-attr">orderId</span>: <span class="hljs-built_in">string</span>;
    <span class="hljs-attr">orderType</span>: <span class="hljs-built_in">string</span>;
  };
  [<span class="hljs-title class_">EEventBusType</span>.<span class="hljs-property">USER_LOGIN_SUCCESS</span>]?: <span class="hljs-built_in">unknown</span>;
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> eventBus = mitt&lt;<span class="hljs-title class_">TEvents</span>&gt;();
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> eventBus;
</code></pre>
<ol start="2">
<li>发送事件（在 trade 包中）</li>
</ol>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// packages/trade/order/index.vue</span>
<span class="hljs-keyword">import</span> eventBus, { <span class="hljs-title class_">EEventBusType</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@repo/shared/events'</span>;

<span class="hljs-comment">// 下单成功后发送事件</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleOrderSuccess</span> = (<span class="hljs-params"/>) =&gt; {
  eventBus.<span class="hljs-title function_">emit</span>(<span class="hljs-title class_">EEventBusType</span>.<span class="hljs-property">ORDER_SUCCESS</span>, {
    <span class="hljs-attr">orderId</span>: <span class="hljs-string">'123'</span>,
    <span class="hljs-attr">orderType</span>: <span class="hljs-string">'limit'</span>
  });
};
</code></pre>
<ol start="3">
<li>监听事件（在 portfolios 包中）</li>
</ol>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// packages/portfolios/components/orders/index.vue</span>
<span class="hljs-keyword">import</span> eventBus, { <span class="hljs-title class_">EEventBusType</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@repo/shared/events'</span>;
<span class="hljs-keyword">import</span> { onMounted, onUnmounted } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;

<span class="hljs-keyword">const</span> <span class="hljs-title function_">orderChangeCallBack</span> = (<span class="hljs-params">data: <span class="hljs-built_in">any</span></span>) =&gt; {
  <span class="hljs-comment">// 处理订单变化</span>
  <span class="hljs-title function_">refreshOrderList</span>();
};

<span class="hljs-title function_">onMounted</span>(<span class="hljs-function">() =&gt;</span> {
  eventBus.<span class="hljs-title function_">on</span>(<span class="hljs-title class_">EEventBusType</span>.<span class="hljs-property">ORDER_SUCCESS</span>, orderChangeCallBack);
});

<span class="hljs-title function_">onUnmounted</span>(<span class="hljs-function">() =&gt;</span> {
  eventBus.<span class="hljs-title function_">off</span>(<span class="hljs-title class_">EEventBusType</span>.<span class="hljs-property">ORDER_SUCCESS</span>, orderChangeCallBack);
});
</code></pre>
<p><strong>优点</strong>：</p>
<ol>
<li>解耦：发送者和接收者不需要直接依赖</li>
<li>灵活：可以动态添加/移除监听器</li>
<li>支持一对多通信</li>
</ol>
<p><strong>注意事项</strong>：</p>
<ol>
<li>事件类型定义应在 shared 包中，确保类型安全</li>
<li>及时清理事件监听器，避免内存泄漏</li>
<li>事件名称应清晰明确，避免命名冲突</li>
</ol>
<h4 data-id="heading-15">2.2 服务模式（Singleton Service）</h4>
<p><strong>适用场景</strong>：</p>
<ol>
<li>提供统一的数据访问接口</li>
<li>跨包共享服务实例</li>
<li>需要单例模式的服务</li>
<li/>
</ol>
<p><strong>实现方式</strong>：</p>
<ol>
<li>定义服务（在 data-center 包中）</li>
</ol>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// packages/data-center/core/index.ts</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Singleton</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@repo/shared/utils/singleton'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DataCenter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Singleton</span> {
  <span class="hljs-keyword">static</span> tag = <span class="hljs-string">'DataCenter'</span>;
  
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">getStockInfo</span>(<span class="hljs-params">code: <span class="hljs-built_in">string</span></span>) {
    <span class="hljs-comment">// 获取股票信息</span>
  }
  
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">getQuotes</span>(<span class="hljs-params">codes: <span class="hljs-built_in">string</span>[]</span>) {
    <span class="hljs-comment">// 获取行情数据</span>
  }
}

<span class="hljs-comment">// 2. 导出服务</span>
<span class="hljs-keyword">export</span> { <span class="hljs-title class_">DataCenter</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./core'</span>;
</code></pre>
<ol start="2">
<li>使用服务（在任何包中）</li>
</ol>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// packages/trade/utils/stock.ts</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">DataCenter</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@repo/data-center'</span>;

<span class="hljs-keyword">const</span> <span class="hljs-title function_">getStockData</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">code: <span class="hljs-built_in">string</span></span>) =&gt; {
  <span class="hljs-keyword">const</span> dataCenter = <span class="hljs-title class_">DataCenter</span>.<span class="hljs-title function_">getInstance</span>();
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> dataCenter.<span class="hljs-title function_">getStockInfo</span>(code);
};
</code></pre>
<p><strong>优点</strong>：</p>
<ol>
<li>统一接口：所有包通过相同的接口访问服务</li>
<li>单例保证：确保全局只有一个实例</li>
<li>易于测试：可以 mock 服务接口</li>
</ol>
<p><strong>注意事项</strong>：</p>
<ol>
<li>
<p>服务接口应稳定，避免频繁变更</p>
</li>
<li>
<p>服务应在 shared 或 data-center 等基础包中</p>
</li>
<li>
<p>避免在服务中直接依赖业务包</p>
</li>
</ol>
<h4 data-id="heading-16">2.3 共享类型和接口</h4>
<p><strong>适用场景</strong>：</p>
<ol>
<li>包间传递数据</li>
<li>定义公共接口</li>
<li>类型约束</li>
</ol>
<p><strong>实现方式</strong>：</p>
<ol>
<li>定义共享类型（在 shared 包中）</li>
</ol>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// packages/shared/types/order.ts</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">IOrderForm</span> {
  <span class="hljs-attr">stockCode</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">stockName</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">entrustType</span>: <span class="hljs-title class_">EEntrustType</span>;
  <span class="hljs-comment">// ...</span>
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">IMaxAvailableAsset</span> {
  <span class="hljs-attr">cashAvailable</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-attr">marginAvailable</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-comment">// ...</span>
}
</code></pre>
<ol start="2">
<li>使用共享类型（在 trade 包中）</li>
</ol>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// packages/trade/order/index.vue</span>
<span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">IOrderForm</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@repo/shared/types/order'</span>;

<span class="hljs-keyword">const</span> <span class="hljs-attr">form</span>: <span class="hljs-title class_">IOrderForm</span> = {
  <span class="hljs-attr">stockCode</span>: <span class="hljs-string">'AAPL'</span>,
  <span class="hljs-attr">stockName</span>: <span class="hljs-string">'Apple Inc.'</span>,
  <span class="hljs-comment">// ...</span>
};
</code></pre>
<ol start="3">
<li>使用共享类型（在 portfolios 包中）</li>
</ol>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// packages/portfolios/components/orders/index.vue</span>
<span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">IOrderForm</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@repo/shared/types/order'</span>;

<span class="hljs-keyword">const</span> <span class="hljs-title function_">displayOrder</span> = (<span class="hljs-params">order: IOrderForm</span>) =&gt; {
  <span class="hljs-comment">// 使用共享类型</span>
};
</code></pre>
<p><strong>优点</strong>：</p>
<ol>
<li>类型安全：TypeScript 提供编译时类型检查</li>
<li>一致性：确保数据结构一致</li>
<li>可维护性：类型定义集中管理</li>
</ol>
<p><strong>注意事项</strong>：</p>
<ol>
<li>共享类型应在 shared 包中定义</li>
<li>避免在业务包中定义共享类型</li>
<li>类型定义应向后兼容</li>
</ol>
<h4 data-id="heading-17">2.4 公共 API 导出模式</h4>
<p><strong>适用场景</strong>：</p>
<ol>
<li>包需要对外暴露功能</li>
<li>隐藏内部实现细节</li>
<li>提供稳定的接口</li>
</ol>
<p><strong>实现方式</strong>：</p>
<ol>
<li>建立公共 API（在 trade 包中）</li>
</ol>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// packages/trade/index.ts</span>
<span class="hljs-comment">// 导出常量</span>
<span class="hljs-keyword">export</span> { <span class="hljs-title class_">EOrderVerify</span>, <span class="hljs-title class_">EOrderErrorCode</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./data/constant'</span>;

<span class="hljs-comment">// 导出工具函数</span>
<span class="hljs-keyword">export</span> { canFillSearch, getOpenAccountUrl } <span class="hljs-keyword">from</span> <span class="hljs-string">'./utils'</span>;

<span class="hljs-comment">// 导出类型</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">IOrderForm</span>, <span class="hljs-title class_">IAttachedOrder</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./types'</span>;

<span class="hljs-comment">// 导出组件（如果需要）</span>
<span class="hljs-keyword">export</span> { <span class="hljs-keyword">default</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">OrderPanel</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./order/index.vue'</span>;
</code></pre>
<ol start="2">
<li>使用公共API（在其他包中）</li>
</ol>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// ✅ 正确：通过公共API导入</span>
<span class="hljs-keyword">import</span> { getOpenAccountUrl } <span class="hljs-keyword">from</span> <span class="hljs-string">'@repo/trade'</span>;

<span class="hljs-comment">// ❌ 错误：直接访问内部实现</span>
<span class="hljs-keyword">import</span> { getOpenAccountUrl } <span class="hljs-keyword">from</span> <span class="hljs-string">'@repo/trade/utils'</span>;
</code></pre>
<p><strong>优点</strong>：</p>
<ol>
<li>封装性：隐藏内部实现</li>
<li>稳定性：公共API相对稳定</li>
<li>可维护性：内部重构不影响外部使用</li>
</ol>
<p><strong>注意事项</strong>：</p>
<ol>
<li>
<p>每个包都应建立 index.ts 作为公共 API 入口</p>
</li>
<li>
<p>只导出需要对外暴露的功能</p>
</li>
<li>
<p>避免导出内部实现细节</p>
</li>
</ol>
<h4 data-id="heading-18">2.5 依赖注入模式</h4>
<p><strong>适用场景</strong>：</p>
<ol>
<li>需要解耦 stores 依赖</li>
<li>提高可测试性</li>
<li>支持不同的实现</li>
</ol>
<p><strong>实现方式</strong>：</p>
<ol>
<li>定义接口（在 shared 包中）</li>
</ol>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// packages/shared/interfaces/stores.ts</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">IUserStore</span> {
  <span class="hljs-attr">logined</span>: <span class="hljs-built_in">boolean</span>;
  <span class="hljs-attr">customerInfo</span>: <span class="hljs-built_in">any</span>;
  <span class="hljs-attr">goLogin</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span>;
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">IConfigStore</span> {
  <span class="hljs-attr">urlsConfig</span>: {
    <span class="hljs-attr">acOpen</span>: <span class="hljs-built_in">string</span>;
  };
}
</code></pre>
<ol start="2">
<li>通过参数注入（在 shared 包中）</li>
</ol>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// packages/shared/utils/order.ts</span>
<span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">IUserStore</span>, <span class="hljs-title class_">IConfigStore</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@repo/shared/interfaces/stores'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">preVerify</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">
  userStore: IUserStore,
  configStore: IConfigStore
</span>) =&gt; {
  <span class="hljs-keyword">if</span> (!userStore.<span class="hljs-property">logined</span>) {
    userStore.<span class="hljs-title function_">goLogin</span>();
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  }
  <span class="hljs-comment">// ...</span>
};
</code></pre>
<ol start="3">
<li>在应用层注入依赖（在 apps/web 中）</li>
</ol>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// apps/web/src/views/trade/index.vue</span>
<span class="hljs-keyword">import</span> { preVerify } <span class="hljs-keyword">from</span> <span class="hljs-string">'@repo/shared/utils/order'</span>;
<span class="hljs-keyword">import</span> { useUserStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/stores/user'</span>;
<span class="hljs-keyword">import</span> { useConfigStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/stores/config'</span>;

<span class="hljs-keyword">const</span> userStore = <span class="hljs-title function_">useUserStore</span>();
<span class="hljs-keyword">const</span> configStore = <span class="hljs-title function_">useConfigStore</span>();

<span class="hljs-keyword">const</span> <span class="hljs-title function_">handlePreVerify</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">await</span> <span class="hljs-title function_">preVerify</span>(userStore, configStore);
};
</code></pre>
<p><strong>优点</strong>：</p>
<ol>
<li>解耦：包不直接依赖 stores</li>
<li>可测试：可以轻松 mock 依赖</li>
<li>灵活：支持不同的实现</li>
</ol>
<p><strong>注意事项</strong>：</p>
<ol>
<li>
<p>接口定义应在 shared 包中</p>
</li>
<li>
<p>依赖注入会增加调用复杂度</p>
</li>
<li>
<p>适合复杂场景，简单场景可直接使用</p>
</li>
</ol>
<h4 data-id="heading-19">2.6 API Linker 模式</h4>
<p><strong>适用场景</strong>：</p>
<ol>
<li>通过 URL 参数调用 API</li>
<li>跨页面通信</li>
<li>外部系统集成</li>
</ol>
<p><strong>实现方式</strong>：</p>
<ol>
<li>注册 API（在 trade 包中）</li>
</ol>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// packages/trade/utils/api-linker.ts</span>
<span class="hljs-keyword">import</span> apiLinker <span class="hljs-keyword">from</span> <span class="hljs-string">'@repo/shared/app/router/api-linker'</span>;

apiLinker.<span class="hljs-title function_">registerLinkerApi</span>({
  <span class="hljs-attr">openTradePanel</span>: <span class="hljs-keyword">async</span> (<span class="hljs-attr">params</span>: { <span class="hljs-attr">stockCode</span>: <span class="hljs-built_in">string</span> }) =&gt; {
    <span class="hljs-comment">// 打开交易面板</span>
  },
  <span class="hljs-attr">submitOrder</span>: <span class="hljs-keyword">async</span> (<span class="hljs-attr">params</span>: <span class="hljs-title class_">IOrderForm</span>) =&gt; {
    <span class="hljs-comment">// 提交订单</span>
  }
});
</code></pre>
<ol start="2">
<li>创建 API 链接（在其他包中）</li>
</ol>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// packages/company/components/stock-card/index.vue</span>
<span class="hljs-keyword">import</span> apiLinker <span class="hljs-keyword">from</span> <span class="hljs-string">'@repo/shared/app/router/api-linker'</span>;

<span class="hljs-keyword">const</span> <span class="hljs-title function_">openTrade</span> = (<span class="hljs-params">stockCode: <span class="hljs-built_in">string</span></span>) =&gt; {
  <span class="hljs-keyword">const</span> url = apiLinker.<span class="hljs-title function_">createApiLink</span>(<span class="hljs-string">'/trade'</span>, {
    <span class="hljs-attr">apiNames</span>: [<span class="hljs-string">'openTradePanel'</span>],
    <span class="hljs-attr">apiOptions</span>: {
      <span class="hljs-attr">openTradePanel</span>: { stockCode }
    }
  });
  <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">open</span>(url);
};
</code></pre>
<p><strong>优点</strong>：</p>
<ol>
<li>跨页面通信</li>
<li>支持外部系统集成</li>
<li>解耦页面间依赖</li>
</ol>
<h3 data-id="heading-20">三、最佳实践</h3>
<h4 data-id="heading-21">3.1 包内导入规则</h4>
<h5 data-id="heading-22"><em>✅ 正确：包内使用相对路径</em></h5>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// packages/trade/utils/verify.ts</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">EOrderVerify</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../data/constant'</span>;
<span class="hljs-keyword">import</span> { canFillSearch } <span class="hljs-keyword">from</span> <span class="hljs-string">'./common'</span>;
</code></pre>
<h5 data-id="heading-23"><em>❌ 错误：包内使用包名路径</em></h5>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">EOrderVerify</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@repo/trade/data/constant'</span>;

<span class="hljs-comment">// 讨论：是否可以使用 @pkg/trade</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">EOrderVerify</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">' @pkg/trade/data/constant'</span>;
</code></pre>
<h5 data-id="heading-24"><em>✅ 正确：跨包使用包名路径</em></h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// packages/account/index.vue</span>
<span class="hljs-keyword">import</span> { getOpenAccountUrl } <span class="hljs-keyword">from</span> <span class="hljs-string">'@repo/trade'</span>;
<span class="hljs-keyword">import</span> { eventBus } <span class="hljs-keyword">from</span> <span class="hljs-string">'@repo/shared/events'</span>;
</code></pre>
<h4 data-id="heading-25">3.2 类型定义规则</h4>
<h5 data-id="heading-26"><em>✅ 正确：共享类型在 shared 包中</em></h5>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// packages/shared/types/order.ts</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">IOrderForm</span> {
  <span class="hljs-comment">// ...</span>
}
</code></pre>
<h5 data-id="heading-27"><em>✅ 正确：业务特定类型在业务包中</em></h5>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// packages/trade/types/condition.ts</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">IConditionOrder</span> {
  <span class="hljs-comment">// ...</span>
}
</code></pre>
<h4 data-id="heading-28">3.3 常量定义规则</h4>
<h5 data-id="heading-29"><em>✅ 正确：通用常量在 shared 包中</em></h5>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// packages/shared/constant/order.ts</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">EEntrustType</span> {
  <span class="hljs-variable constant_">LIMIT</span> = <span class="hljs-number">1</span>,
  <span class="hljs-variable constant_">MARKET</span> = <span class="hljs-number">2</span>,
}
</code></pre>
<h5 data-id="heading-30"><em>✅ 正确：业务特定常量在业务包中</em></h5>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// packages/trade/data/constant.ts</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">EOrderVerify</span> {
  <span class="hljs-variable constant_">NOT_LOGIN</span> = <span class="hljs-string">'not_login'</span>,
  <span class="hljs-comment">// ...</span>
}
</code></pre>
<h4 data-id="heading-31">3.4 工具函数规则</h4>
<h5 data-id="heading-32"><em>✅ 正确：通用工具函数在 shared 包中</em></h5>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// packages/shared/utils/order.ts</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">isTrue</span> = (<span class="hljs-params">flag: <span class="hljs-built_in">any</span></span>) =&gt; {
  <span class="hljs-comment">// 通用逻辑</span>
};
</code></pre>
<h5 data-id="heading-33"><em>✅ 正确：业务特定工具函数在业务包中</em></h5>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// packages/trade/utils/verify.ts</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">verifyOrder</span> = (<span class="hljs-params">order: IOrderForm</span>) =&gt; {
  <span class="hljs-comment">// 业务特定逻辑</span>
};
</code></pre>
<h3 data-id="heading-34">四、通信模式选择指南</h3>








































<table><thead><tr><th><strong>场景</strong></th><th><strong>推荐模式</strong></th><th><strong>示例</strong></th></tr></thead><tbody><tr><td>通知其他包某个事件发生</td><td>事件通信</td><td>订单成功、登录成功</td></tr><tr><td>获取共享数据</td><td>服务模式</td><td>获取股票信息、行情数据</td></tr><tr><td>传递数据</td><td>共享类型</td><td>订单表单、用户信息</td></tr><tr><td>调用其他包功能</td><td>公共 API</td><td>工具函数、组件</td></tr><tr><td>需要解耦 stores</td><td>依赖注入</td><td>验证函数、工具函数</td></tr><tr><td>跨页面通信</td><td>API Linker</td><td>打开交易面板</td></tr></tbody></table>
<h3 data-id="heading-35">五、重构建议</h3>
<h4 data-id="heading-36">5.1 解决循环依赖</h4>
<p><strong>步骤1：识别共享内容</strong></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 找出 shared 包中使用的 trade 包内容</span>
<span class="hljs-comment">// packages/shared/utils/order.ts</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">EOrderVerify</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@repo/trade/data'</span>;  <span class="hljs-comment">// 需要移到shared</span>
<span class="hljs-keyword">import</span> { canFillSearch } <span class="hljs-keyword">from</span> <span class="hljs-string">'@repo/trade/utils'</span>; <span class="hljs-comment">// 需要移到shared</span>
</code></pre>
<p><strong>步骤2：迁移到 shared 包</strong></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// packages/shared/constant/order.ts</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">EOrderVerify</span> {
  <span class="hljs-variable constant_">NOT_LOGIN</span> = <span class="hljs-string">'not_login'</span>,
  <span class="hljs-comment">// ...</span>
}

<span class="hljs-comment">// packages/shared/utils/order.ts</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">canFillSearch</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">params: <span class="hljs-built_in">any</span></span>) =&gt; {
  <span class="hljs-comment">// 实现逻辑</span>
};
</code></pre>
<p><strong>步骤3：更新引用</strong></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// packages/trade/utils/verify.ts</span>
<span class="hljs-comment">// 从 shared 包导入</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">EOrderVerify</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@repo/shared/constant/order'</span>;
<span class="hljs-keyword">import</span> { canFillSearch } <span class="hljs-keyword">from</span> <span class="hljs-string">'@repo/shared/utils/order'</span>;
</code></pre>
<p><strong>步骤4：移除依赖</strong></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// packages/shared/package.json</span>
{
  <span class="hljs-string">"dependencies"</span>: {
    <span class="hljs-comment">// 移除 "@repo/trade": "workspace:*"</span>
  }
</code></pre>
<h4 data-id="heading-37">5.2 建立公共 API</h4>
<p><strong>步骤1：在各包的根目录创建 index.ts</strong></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// packages/trade/index.ts</span>
<span class="hljs-comment">// 导出常量</span>
<span class="hljs-keyword">export</span> * <span class="hljs-keyword">from</span> <span class="hljs-string">'./data/constant'</span>;

<span class="hljs-comment">// 导出工具函数</span>
<span class="hljs-keyword">export</span> { canFillSearch } <span class="hljs-keyword">from</span> <span class="hljs-string">'./utils/verify'</span>;
<span class="hljs-keyword">export</span> { getOpenAccountUrl } <span class="hljs-keyword">from</span> <span class="hljs-string">'./utils/config'</span>;

<span class="hljs-comment">// 导出类型</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">IOrderForm</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./types'</span>;

<span class="hljs-comment">// 导出组件（可选）</span>
<span class="hljs-keyword">export</span> { <span class="hljs-keyword">default</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">OrderPanel</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./order/index.vue'</span>;
</code></pre>
<p><strong>步骤2：更新引用</strong></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// packages/account/index.vue （account 包）</span>
<span class="hljs-comment">// 其他包通过 trade 包的公共 API 访问</span>
<span class="hljs-keyword">import</span> { getOpenAccountUrl } <span class="hljs-keyword">from</span> <span class="hljs-string">'@repo/trade'</span>;
</code></pre>
<h4 data-id="heading-38">5.3 解耦 stores 依赖</h4>
<p><strong>步骤1：定义接口</strong></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// packages/shared/interfaces/stores.ts</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">IUserStore</span> {
  <span class="hljs-attr">logined</span>: <span class="hljs-built_in">boolean</span>;
  <span class="hljs-attr">customerInfo</span>: <span class="hljs-built_in">any</span>;
  <span class="hljs-attr">goLogin</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span>;
}
</code></pre>
<p><strong>步骤2：修改函数签名</strong></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// packages/shared/utils/order.ts</span>
<span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">IUserStore</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@repo/shared/interfaces/stores'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">preVerify</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">userStore: IUserStore</span>) =&gt; {
  <span class="hljs-keyword">if</span> (!userStore.<span class="hljs-property">logined</span>) {
    userStore.<span class="hljs-title function_">goLogin</span>();
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  }
<span class="hljs-comment">// ... </span>
</code></pre>
<p><strong>步骤3：在应用层注入</strong></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// apps/web/src/views/trade/index.vue</span>
<span class="hljs-keyword">import</span> { preVerify } <span class="hljs-keyword">from</span> <span class="hljs-string">'@repo/shared/utils/order'</span>;
<span class="hljs-keyword">import</span> { useUserStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/stores/user'</span>;

<span class="hljs-keyword">const</span> userStore = <span class="hljs-title function_">useUserStore</span>();
<span class="hljs-keyword">await</span> <span class="hljs-title function_">preVerify</span>(userStore);
</code></pre>
<h3 data-id="heading-39">六、检查清单</h3>
<p>在添加新的包间通信时，请检查：</p>
<ul>
<li>是否遵循依赖层次原则？</li>
<li>是否避免了循环依赖？</li>
<li>是否使用了合适的通信模式？</li>
<li>共享类型是否在 shared 包中？</li>
<li>是否建立了公共 API？</li>
<li>是否避免了直接访问内部实现？</li>
<li>是否避免了直接依赖 stores？</li>
<li>事件监听器是否及时清理？</li>
</ul>
<h3 data-id="heading-40">七、总结</h3>
<p>正确的包间通信应该是：</p>
<ol>
<li>
<p><strong>遵循依赖层次</strong>：基础包不依赖业务包</p>
</li>
<li>
<p><strong>使用合适的通信模式</strong>：根据场景选择事件、服务、类型等</p>
</li>
<li>
<p><strong>建立公共 API</strong>：通过 index.ts 导出，隐藏内部实现</p>
</li>
<li>
<p><strong>共享类型和常量</strong>：在 shared 包中定义</p>
</li>
<li>
<p><strong>解耦 stores</strong>：通过依赖注入或接口</p>
</li>
<li>
<p><strong>及时清理资源</strong>：事件监听器等</p>
</li>
</ol>
<p>遵循这些原则，可以确保包间的松耦合、高内聚，提高代码的可维护性和可测试性。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【高斯泼溅】破解大规模3DGS落地卡点：高效数据组织让“最后一公里”变坦途]]></title>    <link>https://juejin.cn/post/7590597231708258339</link>    <guid>https://juejin.cn/post/7590597231708258339</guid>    <pubDate>2026-01-04T01:54:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590597231708258339" data-draft-id="7590292192989691944" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【高斯泼溅】破解大规模3DGS落地卡点：高效数据组织让“最后一公里”变坦途​"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-04T01:54:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Mapmost"/> <meta itemprop="url" content="https://juejin.cn/user/1679709496936343"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【高斯泼溅】破解大规模3DGS落地卡点：高效数据组织让“最后一公里”变坦途​
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1679709496936343/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Mapmost
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-04T01:54:35.000Z" title="Sun Jan 04 2026 01:54:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">从分区训练到流式服务的最后一公里</h2>
<p>在3DGS专栏下的<a href="https://juejin.cn/post/7583892482599370767" target="_blank" title="https://juejin.cn/post/7583892482599370767">《Mapmost分区训练： 让大场景3DGS的建模从此高效且高质》</a>一文中，我们深入剖析了3DGS在应对大地理范围场景时所面临的显存与训练效率挑战，并提出通过<strong>空间分治策略</strong>实现可扩展建模。</p>
<p>然而，建模只是起点，<strong>高效使用才是关键</strong>。当用户期望在Web浏览器中流畅探索这些超大规模场景时，新的难题随之而来：<strong>如何让消费级显卡甚至移动设备，也能丝滑渲染远超本地显存容量的3DGS模型？</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/35d399c7993b4bcfa81ee7a397d15256~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768096475&amp;x-signature=y7dgBP%2FzJiNHSMn4FbttJkrS4K8%3D" alt="" loading="lazy"/></p>
<p><em>大规模3DGS模型需在Web端流畅渲染</em></p>
<p>这一问题的答案指向<strong>服务化发布</strong>——本质上是一套涵盖<strong>数据组织、网络传输与客户端渲染</strong>的全链路协同优化系统工程。</p>
<p>而本文将聚焦其中最基础却至关重要的环节：<strong>数据侧的高效组织</strong>。借鉴倾斜摄影模型的发展路径，我们将围绕<strong>空间索引构建</strong>与<strong>多细节层次(LOD)划分</strong>两大核心，探讨面向大规模3DGS的数据结构设计。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9d6f4a0eff134f8fa84498004a750cc7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768096475&amp;x-signature=qEtWcdJkbLS06Os753igTkXI3O0%3D" alt="" loading="lazy"/></p>
<p><em>空间网格构建与细节层级划分</em></p>
<h2 data-id="heading-1">分块化空间索引：将全局场景拆解为“数据砖块”</h2>
<h3 data-id="heading-2">01.分块索引的关键特性</h3>
<p>要实现大规模3DGS场景的服务化发布，意味着我们必须将一个动辄数十GB的“庞然大物”，拆解为一系列<strong>空间有序、粒度合理、可独立调度</strong>的**“数据砖块”**。</p>
<p>这种<strong>数据分块策略</strong>的核心目标，是通过空间逻辑切割，使每个单元具备以下特性：</p>
<ul>
<li>**大小均衡：**便于网络传输与内存管理；</li>
<li>**语义局部性：**单个块内包含完整的几何与外观信息；</li>
<li>**嵌入空间索引：**每个块可基于层次化索引结构快速查询；</li>
<li>**可独立加载与剔除：**支持按需流式渲染。</li>
</ul>
<p>其价值直接对应三大工程痛点：</p>
<ul>
<li>**突破网络瓶颈：**避免一次性传输GB级文件，实现“所见即所传”；</li>
<li>**缓解显存压力：**运行时仅驻留视域内数据，内存占用降低90%以上；</li>
<li>**消除加载卡顿：**小块并行预加载，首屏渲染从分钟级缩短至秒级。</li>
</ul>
<h3 data-id="heading-3">02.现有空间数据组织范式</h3>
<p>幸运的是，在智慧城市与高精地图等需求推动下，业界已发展出两类成熟的空间数据组织范式：</p>
<ul>
<li>**局部精细场景：**以Cesium 3D Tiles为代表，通过四叉树/八叉树构建带LOD的tile树，结合视锥剔除与屏幕空间误差(SSE)实现高效调度；</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/30678ed313b84d689dd533fa1cc10a7c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768096475&amp;x-signature=UyJOYl%2BLBXcL2mqbINqDsndxTLg%3D" alt="" loading="lazy"/></p>
<p><em>3D Tiles结构树</em></p>
<ul>
<li>**全球尺度覆盖：**采用 全球地理瓦片体系(如北斗网格、Google S2、Uber H3或OGC全球瓦片规范)，将地球表面划分为多层级规则网格，支持跨城市甚至全球范围的无缝索引。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8d85d4fff9ab44829da056eca4ab8b99~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768096475&amp;x-signature=mabI%2BgIbOfNZky3dlovAFHKWWfM%3D" alt="" loading="lazy"/></p>
<p><em>基于瓦片的地图组织方式</em></p>
<p>这些框架的共同优势在于<strong>与底层几何表示解耦</strong>：只要将数据按空间区域分块，并提供对应的包围体或地理边界，无论是三角网格、激光点云，还是3DGS中的高斯椭球，均可接入统一的索引与调度体系，为大规模3DGS的流式服务奠定基础。</p>
<h2 data-id="heading-4">多细节层次：给模型做"智能瘦身"，远近皆宜</h2>
<h3 data-id="heading-5">01.分多细节层次构建的必要性</h3>
<p>多细节层次(Level of Detail, LOD)的核心思想是 “近处精细、远处简化” ——根据相机距离与视觉贡献动态调整模型复杂度，避免将宝贵算力浪费在人眼无法感知的细节上。</p>
<p>对于3DGS而言，若全场景统一使用最高精度，将面临两大关键挑战：</p>
<ul>
<li>**视觉冗余：**远处高斯点密度过高，但单个点在屏幕上的覆盖率极低，人眼难以分辨；</li>
<li>**计算浪费：**大量远端高斯仍参与光栅化，却仅贡献零星像素，严重拖累渲染帧率。</li>
</ul>
<p>因此，构建高效的LOD体系，成为大规模3DGS流式服务的关键一环。</p>
<h3 data-id="heading-6">02.现有技术盘点：合并与抽稀</h3>
<p><strong><em>1. 高斯椭球合并</em></strong></p>
<p>这是目前较为主流的层次化压缩思路。其核心是将<strong>空间邻近、视觉相似</strong>的一组高斯椭球，<strong>融合为一个更具代表性的综合椭球</strong>，在视觉影响尽可能小的前提下显著降低数据密度。</p>
<ul>
<li>
<p>**融合逻辑：**不仅考虑位置、尺寸，还兼顾颜色、协方差方向与不透明度的一致性，确保合并后的椭球能有效“代理”原始群体的辐射贡献；</p>
</li>
<li>
<p><strong>优势：<strong>合并通过</strong>参数重拟合</strong>，在减少数量的同时保留了区域整体的光度与几何特征，更适合处理高斯密集、纹理连续的区域。</p>
</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/647f95b6a20e4da89b5c017595dfa9c6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768096475&amp;x-signature=aAIC8SAKP65A2n2XyI80hEFF9lo%3D" alt="" loading="lazy"/></p>
<p><em>高斯椭球合并示意图（AHierarchical 3D Gaussian Representation for Real-Time Rendering of Very Large Datasets）</em></p>
<p><strong><em>2. 结构化抽稀</em></strong></p>
<p>不同于“以合代简”的思路，结构化抽稀采用重要性驱动的剪枝策略，通过评估每个高斯点对最终图像的贡献度，有选择地移除冗余项。</p>
<ul>
<li>**评估指标：**基于梯度、透明度、视距贡献度给每个高斯点评分；</li>
<li>**动态裁剪：**移除低分冗余点，保留视觉关键特征；</li>
<li>**优势：**在相同压缩率下，<strong>结构信息保留更完整</strong>，建筑边缘更清晰。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5a7bb9950b444234bbf0c26e7bcd90ac~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768096475&amp;x-signature=kSu4Nj7ozjZZOkmMq%2B94uYpgK54%3D" alt="" loading="lazy"/></p>
<p><em>重要性驱动的3DGS剪枝示意图（LightGaussian: Unbounded 3D Gaussian Compression with 15x Reduction and 200+ FPS）</em></p>
<h2 data-id="heading-7">Mapmost高斯泼溅建模平台：一键发布，高效服务</h2>
<p>在可离线部署的<strong>Mapmost高斯泼溅建模平台</strong>，让超大规模3DGS场景的服务化发布变得前所未有的轻松——只需一次点击，让专业级3D应用触手可及。</p>
<p>平台核心能力包括：</p>
<ul>
<li>**统一空间索引：**基于地理一致的分块体系，支持跨区域场景无缝集成；</li>
<li>**自动LOD构建：**根据场景内容智能生成多级细节层次，兼顾视觉质量与运行效率；</li>
<li>**全链路优化：**从上传、处理到在线服务，实现分钟级发布与秒级加载。</li>
</ul>
<p>无需手动切块、调参或部署服务，<strong>Mapmost</strong>让超大规模3DGS真正“开箱即用”。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7a73d80a888b45f5a548434460ecc569~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768096475&amp;x-signature=9KszEbylBkQSA6eDIU70BnnqFg0%3D" alt="" loading="lazy"/></p>
<p><em>离线版建模平台服务发布参数设置</em></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7de6a5f2fee64f5db3d5031bf0b202dd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768096475&amp;x-signature=eBIKM3YbeXi9301eGITaSN4Hx1s%3D" alt="" loading="lazy"/></p>
<p><em>Mapmost SDK for WebGL 100km²大地理范围3DGS模型渲染</em></p>
<p>申请试用，请至<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.mapmost.com%2F%23%2F" target="_blank" title="https://www.mapmost.com/#/" ref="nofollow noopener noreferrer">Mapmost</a>官网联系客服</p>
<p><strong>Mapmost 3DGS Builder在线体验版已上线~</strong></p>
<p><strong>欢迎体验:</strong> <a href="https://link.juejin.cn?target=studio.mapmost.com%2F3dgs" target="_blank" title="studio.mapmost.com/3dgs" ref="nofollow noopener noreferrer">studio.mapmost.com/3dgs</a></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c970b8d47c8346128320dded0559885c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768096475&amp;x-signature=M59CL9OIH9Mz5%2FhNN5A9%2FGH01GI%3D" alt="" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[ng老狗的Vue 3 响应式系统源码分享]]></title>    <link>https://juejin.cn/post/7590654280900362283</link>    <guid>https://juejin.cn/post/7590654280900362283</guid>    <pubDate>2026-01-03T14:21:26.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590654280900362283" data-draft-id="7590330924001345599" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="ng老狗的Vue 3 响应式系统源码分享"/> <meta itemprop="keywords" content="Vue.js"/> <meta itemprop="datePublished" content="2026-01-03T14:21:26.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="TTt102207"/> <meta itemprop="url" content="https://juejin.cn/user/3843548383283469"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            ng老狗的Vue 3 响应式系统源码分享
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3843548383283469/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    TTt102207
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-03T14:21:26.000Z" title="Sat Jan 03 2026 14:21:26 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    16
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Ng老狗的Vue 3 响应式系统笔记</h2>
<p>响应式库 @vue/reactivity 学习记录</p>
<h3 data-id="heading-1">背景</h3>
<blockquote>
<p>作为一个多年Angular应用的开发者，提到响应式，第一反应就是Rxjs。</p>
</blockquote>
<p>相比于Promise的命令式编程分散的信号源，
Rxjs的声明式响应数据流，在 <strong>用户事件多样且频繁的组件</strong> 中，能更优雅地处理异步数据流，往往 <strong>一个Observable就能完整的体现整个数据流</strong> 。</p>
<blockquote>
<p>初见Vue 3的响应式，是一种既熟悉有新鲜的感觉。</p>
</blockquote>
<p>我不再需要各种各样的<code>Observable</code>, <code>Subject</code>, <code>BehaviorSubject</code> 来表达数据流，
而是通过简单的<code>ref</code>和<code>reactive</code>就能创建响应式数据;
我也不需要去订阅和取消订阅数据流，
Vue 3的响应式系统会 <strong>自动追踪依赖</strong>，并在数据变化时更新。</p>
<blockquote>
<p>响应式亦有不同</p>
</blockquote>
<p>诚然，Rxjs是一个强大的响应式编程库，适用于复杂的异步数据流处理，
而Vue 3的响应式系统更专注于UI层的数据绑定和状态管理，
在前端开发中，提供了极其便捷和高效的响应式编程体验。</p>
<p>Ps: Angular 16也引入了类似Vue 3的响应式系统，称为Signals。</p>
<h3 data-id="heading-2">基础概念</h3>
<blockquote>
<p>ref 和 reactive 对比 Observable</p>
</blockquote>
<p>reactivity中最重要的无疑是 <code>ref</code> 和 <code>reactive</code>，
他们类似 <code>Rxjs</code> 中的 <code>BehaviorSubject</code>,
用于收集下游事件，并在更新时 <strong>广播</strong> 订阅者。</p>
<p>而 <code>effect</code>, <code>computed</code> 则完成了响应式数据流的蜕变，
<strong>自动的依赖收集和触发</strong>，彻底摆脱了手动订阅和取消订阅的繁琐。</p>
<p>以自动加法，举一个栗子：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">/************* <span class="hljs-doctag">@vue</span>/reactivity ***************/</span>
<span class="hljs-keyword">import</span> { ref, reactive, computed, effect } <span class="hljs-keyword">from</span> <span class="hljs-string">'@vue/reactivity'</span>;
<span class="hljs-keyword">const</span> a = <span class="hljs-title function_">ref</span>(<span class="hljs-number">1</span>);
<span class="hljs-keyword">const</span> b = <span class="hljs-title function_">ref</span>(<span class="hljs-number">2</span>);
<span class="hljs-comment">// 响应式数据流</span>
<span class="hljs-keyword">const</span> sum = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> a.<span class="hljs-property">value</span> + b.<span class="hljs-property">value</span>);
<span class="hljs-comment">// 触发</span>
a.<span class="hljs-property">value</span> = <span class="hljs-number">3</span>;

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(sum.<span class="hljs-property">value</span>); <span class="hljs-comment">// 3 + 2 = 5</span>

<span class="hljs-comment">/************* Rxjs **************************/</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">BehaviorSubject</span>, combineLatest } <span class="hljs-keyword">from</span> <span class="hljs-string">'rxjs'</span>;
<span class="hljs-keyword">import</span> { map } <span class="hljs-keyword">from</span> <span class="hljs-string">'rxjs/operators'</span>;
<span class="hljs-keyword">const</span> a$ = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BehaviorSubject</span>(<span class="hljs-number">1</span>);
<span class="hljs-keyword">const</span> b$ = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BehaviorSubject</span>(<span class="hljs-number">2</span>);
<span class="hljs-keyword">const</span> sum$ = <span class="hljs-title function_">combineLatest</span>([a$, b$]).<span class="hljs-title function_">pipe</span>(
  <span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">[a, b]</span>) =&gt;</span> a + b)
);

<span class="hljs-comment">// 触发</span>
a$.<span class="hljs-title function_">next</span>(<span class="hljs-number">3</span>);
<span class="hljs-comment">// 特别的数据流只有在订阅时, 才会触发上游计算</span>
sum$.<span class="hljs-title function_">subscribe</span>(<span class="hljs-variable language_">console</span>.<span class="hljs-property">log</span>); <span class="hljs-comment">// 3 + 2 = 5</span>
</code></pre>
<h3 data-id="heading-3">源码阅读</h3>
<p>响应式系统的源码并不复杂，核心部分大约几百行代码。
主要包括以下几个模块：</p>
<ul>
<li>响应式数据创建：<code>ref</code>和<code>reactive</code>函数</li>
<li>依赖收集和触发：<code>effect</code>函数</li>
<li>计算属性：<code>computed</code>函数</li>
<li>响应式数据的代理和拦截：<code>Proxy</code>对象</li>
<li>响应式数据的只读和深度响应式：<code>readonly</code>和<code>shallowReactive</code>函数
...等等</li>
</ul>
<p>其中，依赖收集和触发是响应式系统的核心</p>
<h4 data-id="heading-4">一、依赖收集</h4>
<ul>
<li>看懂 <code>effect</code>，就基本了解依赖收集的核心原理</li>
</ul>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">//  例如：</span>
<span class="hljs-keyword">import</span> { effect, ref } <span class="hljs-keyword">from</span> <span class="hljs-string">'@vue/reactivity'</span>;
<span class="hljs-keyword">const</span> count = <span class="hljs-title function_">ref</span>(<span class="hljs-number">0</span>);
<span class="hljs-title function_">effect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`count is: <span class="hljs-subst">${count.value}</span>`</span>);
});
</code></pre>
<p>在这里如果把 <code>.value</code> 不要看作字段的取值，而是看成 <code>.subscribe(currentEffect)</code> 方法的调用，整个事情就变得很清晰了。</p>
<p>我只需要在 <code>effect</code> 的函数中执行时，
添加一个 <strong>currentEffect的全局变量</strong> ，作为上下文，
每次 <code>.subscribe()</code> 的时候，把这个上下文添加到依赖列表中, 就很方便地完成了依赖收集。</p>
<p><code>computed</code> 和 <code>watch</code> 也是类似的原理。</p>
<h4 data-id="heading-5">二、依赖触发</h4>
<p>由于值更新的场景更灵活，依赖触发的设计也就更加复杂些。</p>
<p>Vue中按照 <code>基本数据类型</code> 和 <code>对象类型</code> 分别处理。<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fvuejs%2Fcore%2Fblob%2Faac7e1898907445c8f89b22047a9bfcf0a6e91b8%2Fpackages%2Freactivity%2Fsrc%2Freactive.ts%23L421" target="_blank" title="https://github.com/vuejs/core/blob/aac7e1898907445c8f89b22047a9bfcf0a6e91b8/packages/reactivity/src/reactive.ts#L421" ref="nofollow noopener noreferrer">参考GitHub</a></p>
<ul>
<li>基本数据类型：直接在 <code>.value</code> 的 <code>setter</code> 中触发依赖 <a title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target=">参考RefImpl</a></li>
<li>对象类型：通过 <code>Proxy</code> 的 <code>set</code> 拦截器触发依赖<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fvuejs%2Fcore%2Fblob%2Faac7e1898907445c8f89b22047a9bfcf0a6e91b8%2Fpackages%2Freactivity%2Fsrc%2FbaseHandlers.ts%23L55" target="_blank" title="https://github.com/vuejs/core/blob/aac7e1898907445c8f89b22047a9bfcf0a6e91b8/packages/reactivity/src/baseHandlers.ts#L55" ref="nofollow noopener noreferrer">参考MutableReactiveHandler</a>。嵌套的对象会在 <code>get</code> 时递归地转换为响应式对象。<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fvuejs%2Fcore%2Fblob%2Faac7e1898907445c8f89b22047a9bfcf0a6e91b8%2Fpackages%2Freactivity%2Fsrc%2FbaseHandlers.ts%23L126" target="_blank" title="https://github.com/vuejs/core/blob/aac7e1898907445c8f89b22047a9bfcf0a6e91b8/packages/reactivity/src/baseHandlers.ts#L126" ref="nofollow noopener noreferrer">参考BaseReactiveHandler</a></li>
</ul>
<p>当然，非必要的场景下，Vue 也提供了 <code>shallowReactive</code> 和 <code>shallowRef</code> 来创建浅响应式对象。</p>
<h4 data-id="heading-6">三、计算属性</h4>
<p>计算属性 <code>computed</code> 的实现也很巧妙。
它本质上是一个带有缓存的 <code>effect</code>。
当计算属性的依赖发生变化时，计算属性会重新计算值，
但只有在访问计算属性的值时才会触发重新计算。</p>
<p>这点和Rxjs中的 <code>shareReplay</code> 操作符有些类似。</p>
<h4 data-id="heading-7">四、总结</h4>
<p>通过阅读 <code>Vue 3</code> 响应式系统的源码，
对响应式编程的有了新的理解。</p>
<p>核心的依赖清单通过数组管理、 相似的触发逻辑
和响应式数据流的理念，等等保留了发布订阅的稳定设计。</p>
<p><code>Vue 3</code> 的响应式库，不拘泥于刻板的设计模式，
而是根据实际需求，灵活地设计了响应式数据的创建、依赖收集和触发机制，
从而实现了高效且易用的响应式编程体验。</p>
<p>Vue团队中Anthony Fu在<a href="https://link.juejin.cn?target=https%3A%2F%2Fantfu.me%2Fposts%2Fwatch-with-reactivity" target="_blank" title="https://antfu.me/posts/watch-with-reactivity" ref="nofollow noopener noreferrer">这篇文章</a>中对设计理念有更清晰的阐述，推荐一读。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[思维重构：为什么 Class Component 逐渐式微，而 Function Component 成为主流]]></title>    <link>https://juejin.cn/post/7590654281036890155</link>    <guid>https://juejin.cn/post/7590654281036890155</guid>    <pubDate>2026-01-03T15:21:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590654281036890155" data-draft-id="7590421489998282771" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="思维重构：为什么 Class Component 逐渐式微，而 Function Component 成为主流"/> <meta itemprop="keywords" content="React.js"/> <meta itemprop="datePublished" content="2026-01-03T15:21:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="SakuraOnTheWay"/> <meta itemprop="url" content="https://juejin.cn/user/3035112839343709"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            思维重构：为什么 Class Component 逐渐式微，而 Function Component 成为主流
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3035112839343709/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    SakuraOnTheWay
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-03T15:21:58.000Z" title="Sat Jan 03 2026 15:21:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    13
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<p>在 <code>React 16.8</code> 发布 <code>Hooks</code> 以来， <code>class</code> 关键字在新建的项目中逐渐销声匿迹，取而代之的是更加简洁、轻量的 <code>Function Components</code>。</p>
<p>很多人认为这只是一次语法层面的“升级”——把 <code>render</code> 函数拆出来，把 <code>this.state</code> 换成 <code>useState</code>，一切就万事大吉了。</p>
<p>但事实并非如此。</p>
<p>如果你带着写 <code>Class</code> 组件的惯性思维（<code>Lifecycle Thinking</code>）去写 <code>Hooks</code>，你很快就会撞上一堵墙：无限循环的请求、过期的闭包变量（<code>Stale Closures</code>）、以及那个越写越长、让人望而生畏的 <code>useEffect</code> 依赖数组。</p>
<p>从 <code>Class</code> 到 <code>Function</code>，本质上不是语法的改变，而是心智模型（<code>Mental Model</code>）的重构：我们正在从“面向对象与生命周期”转向“函数式与逻辑聚合”。</p>
<p>在这篇文章中，我们将通过一个具体的 <code>WindowTracker</code> 案例，对比展示两种模式的本质差异；并且讨论如何避免 <code>useEffect</code> 陷阱。</p>
<h2 data-id="heading-1">1. 范式转移——从“生命周期”到“逻辑聚合”</h2>
<p>在 <code>Class</code> 组件时代，我们的代码组织方式是被 <code>React</code> 的<strong>生命周期方法（Lifecycle Methods）</strong> 强行切割的。为了说明这一点，我们来看一个经典的案例：<code>WindowTracker</code>（一个显示当前窗口宽度，并修改 <code>document.title</code> 的组件）。</p>
<h3 data-id="heading-2">1.1 Class Component：被割裂的逻辑</h3>
<p>我们先看看在<code>Class</code>组件中，这个需求是如何实现的</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">class</span> <span class="hljs-title class_">WindowTracker</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">React.Component</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">props</span>) {
    <span class="hljs-variable language_">super</span>(props);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = { <span class="hljs-attr">width</span>: <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span> };
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">handleResize</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">handleResize</span>.<span class="hljs-title function_">bind</span>(<span class="hljs-variable language_">this</span>);
  }

  <span class="hljs-title function_">componentDidMount</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 🔴 逻辑 A 的开始：订阅事件</span>
    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'resize'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">handleResize</span>);
    <span class="hljs-comment">// 🔵 逻辑 B 的开始：更新标题 --- 首次挂载</span>
    <span class="hljs-variable language_">document</span>.<span class="hljs-property">title</span> = <span class="hljs-string">`Width: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.state.width}</span>`</span>;
  }

  <span class="hljs-comment">// 🔵 逻辑 B 的重复：更新标题 --- state更新</span>
  <span class="hljs-title function_">componentDidUpdate</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">document</span>.<span class="hljs-property">title</span> = <span class="hljs-string">`Width: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.state.width}</span>`</span>;
  }

  <span class="hljs-comment">// 🔴 逻辑 A 的结束：取消订阅</span>
  <span class="hljs-title function_">componentWillUnmount</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'resize'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">handleResize</span>);
  }

  <span class="hljs-title function_">handleResize</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setState</span>({ <span class="hljs-attr">width</span>: <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span> });
  }

  <span class="hljs-title function_">render</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>Current Width: {this.state.width}px<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
  }
}
</code></pre>
<p>观察代码，你会发现<strong>相关的逻辑被强行拆分了</strong>，如果你想修改“更新标题”的逻辑，你必须同时修改 <code>DidMount</code> 和 <code>DidUpdate</code> 的代码。</p>
<p>这种 <strong>“关注点分离”（Scattered Concerns）</strong> 是导致大型 <code>Class</code> 组件难以维护的元凶。</p>
<h3 data-id="heading-3">1.2 Function Component： 逻辑的自然聚合 (Co-location)</h3>
<p><code>Hooks</code> 的出现，让我们得以按照<strong>代码的用途</strong>，而不是代码执行的时间点来组织逻辑。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">WindowTracker</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [width, setWidth] = <span class="hljs-title function_">useState</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span>);

  <span class="hljs-comment">// 🔴 逻辑 A：完整的窗口订阅逻辑</span>
  <span class="hljs-comment">// 订阅和取消订阅在一起，像一个独立的单元</span>
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleResize</span> = (<span class="hljs-params"/>) =&gt; <span class="hljs-title function_">setWidth</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span>);
    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'resize'</span>, handleResize);
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'resize'</span>, handleResize);
  }, []);

  <span class="hljs-comment">// 🔵 逻辑 B：完整的标题同步逻辑</span>
  <span class="hljs-comment">// 只要 width 变了，我就执行，不需要关心是 Mount 还是 Update</span>
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">document</span>.<span class="hljs-property">title</span> = <span class="hljs-string">`Width: <span class="hljs-subst">${width}</span>`</span>;
  }, [width]);

  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>Current Width: {width}px<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
}
</code></pre>
<p>核心优势： 这就是 <code>Co-location</code>（同地协作）。我们不再思考“这个组件挂载了吗？”，我们思考的是“这个副作用依赖什么数据？”</p>
<h3 data-id="heading-4">1.3 自定义 Hook ：逻辑复用</h3>
<p>既然逻辑 A 已经聚合在一起了，我们就可以把提取一个自定义<code>hooks</code>出来以供服用：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// hooks/useWindowWidth.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useWindowWidth</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [width, setWidth] = <span class="hljs-title function_">useState</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span>);
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleResize</span> = (<span class="hljs-params"/>) =&gt; <span class="hljs-title function_">setWidth</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span>);
    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'resize'</span>, handleResize);
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'resize'</span>, handleResize);
  }, []);
  <span class="hljs-keyword">return</span> width;
}

<span class="hljs-comment">// 组件代码缩减为：</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">WindowTracker</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> width = <span class="hljs-title function_">useWindowWidth</span>(); <span class="hljs-comment">// ✅ 逻辑复用，极度简洁</span>
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> { <span class="hljs-variable language_">document</span>.<span class="hljs-property">title</span> = <span class="hljs-string">`Width: <span class="hljs-subst">${width}</span>`</span>; }, [width]);
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>Current Width: {width}px<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
}
</code></pre>
<h2 data-id="heading-5">2. 谨防Effect陷阱</h2>
<p>当你开始享受 <code>Function Component</code> 的简洁时，很快就会遇到新的挑战：<code>useEffect</code> 并不是 <code>componentDidMount</code> 的简单替代品。如果你还带着命令式的思维，你一定会掉进坑里。</p>
<h3 data-id="heading-6">2.1 陷阱一：闭包陷阱 (Stale Closures)</h3>
<p>新手最容易犯的错误，就是以为 <code>Effect</code> 里的变量会自动更新。</p>
<p>❌ 错误示范：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Counter</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> id = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(count); <span class="hljs-comment">// 永远打印 0！</span>
      <span class="hljs-title function_">setCount</span>(count + <span class="hljs-number">1</span>); <span class="hljs-comment">// 永远重置为 1</span>
    }, <span class="hljs-number">1000</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">clearInterval</span>(id);
  }, []); <span class="hljs-comment">// 依赖为空，Effect 只运行一次</span>
}
</code></pre>
<p><code>JavaScript</code> 的闭包机制导致 <code>setInterval</code> 内部引用的 <code>count</code> 永远是第一次渲染时的那个值 <code>(0）</code>。它被“冻结”在过去的时间里了。</p>
<p>✅ 修正方案：函数式更新 我们不需要依赖当前的 <code>count</code>，而是告诉 <code>React</code> 如何计算下一个状态：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-title function_">setCount</span>(<span class="hljs-function"><span class="hljs-params">prevCount</span> =&gt;</span> prevCount + <span class="hljs-number">1</span>); <span class="hljs-comment">// ✅ 不需要依赖外部的 count 变量</span>
</code></pre>
<blockquote>
<p>这不仅仅是 React 的特性。
如果你用过 Jotai、Zustand 或 Redux，你会发现这种<strong>控制反转 (Inversion of Control)的设计模式</strong>无处不在。</p>
<p>在 Jotai 中，更新 Atom 时也是 set(atom, prev =&gt; prev + 1)。</p>
<p>在 Redux 中，Reducer 的 (state, action) =&gt; newState 也是同样的道理。</p>
</blockquote>
<h3 data-id="heading-7">2.2 陷阱二：依赖地狱 (Dependency Hell)</h3>
<p>随着业务逻辑变复杂，你的依赖数组可能会变得非常长：<code>[user, settings, history, socket, theme...]</code>。任何一个变量微小的变动，都会导致整个 <code>Effect</code> 重新执行。</p>
<p>面对“依赖地狱”，我们需要用三大原则进行逻辑拆解：</p>
<h4 data-id="heading-8">原则 A：按职责拆分 (Split by Concern)</h4>
<p>不要把所有逻辑塞进一个 <code>Effect</code>。</p>
<p>如果一个 <code>Effect</code> 既负责“埋点上报”又负责“连接 <code>WebSocket</code>”，请把它们拆成两个 <code>useEffect</code>。</p>
<h4 data-id="heading-9">原则 B：区分“事件”与“副作用” (Events vs Effects)</h4>
<p>这是最重要的原则。不要为了获取最新值，就把逻辑塞进 <code>Effect</code>。</p>
<p>❌ <strong>错误：</strong> 用户点击按钮提交，但我需要在 <code>Effect</code> 里监听 <code>isSubmitting</code> 状态来发送请求，导致不得不把所有表单数据加入依赖。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">LoginForm</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [text, setText] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">''</span>);
  <span class="hljs-keyword">const</span> [isSubmitting, setIsSubmitting] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);

  <span class="hljs-comment">// ❌ 错误：滥用 Effect 处理交互</span>
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// 只有当开关被打开时，才发送请求</span>
    <span class="hljs-keyword">if</span> (isSubmitting) {
      <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">postData</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">await</span> api.<span class="hljs-title function_">login</span>(text);
        <span class="hljs-title function_">setIsSubmitting</span>(<span class="hljs-literal">false</span>); <span class="hljs-comment">// 请求完把开关关掉</span>
      }
      <span class="hljs-title function_">postData</span>();
    }
  }, [isSubmitting, text]); <span class="hljs-comment">// sos灾难：不得不把 text 也加入依赖！</span>

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleSubmit</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-comment">// 点击按钮时不直接发送，而是去拨动开关</span>
    <span class="hljs-title function_">setIsSubmitting</span>(<span class="hljs-literal">true</span>);
  };

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">form</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{text}</span> <span class="hljs-attr">onChange</span>=<span class="hljs-string">{e</span> =&gt;</span> setText(e.target.value)} /&gt;
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{handleSubmit}</span>&gt;</span>登录<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span></span>
  );
}
</code></pre>
<p>✅ <strong>正确：</strong> 回到最朴素的编程思维-“用户点击时，发送请求”。在 <code>onClick</code> 事件处理函数中直接读取 <code>State</code> 发送请求。<code>Effect</code> 应该只用于同步（比如根据 <code>ID</code> 获取数据），而不是用于处理交互。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">LoginForm</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [text, setText] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">''</span>);
  <span class="hljs-comment">// 不需要 isSubmitting 这个状态来做触发器（虽然可以用它来控制 Loading UI）</span>

  <span class="hljs-comment">// ✅ 正确：事件处理函数包含所有逻辑</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleSubmit</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-comment">// 1. 直接在这里读取最新的 state</span>
    <span class="hljs-comment">// 这里读取 text 不需要经过依赖数组，它是直接可用的</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'正在提交:'</span>, text);
    
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">await</span> api.<span class="hljs-title function_">login</span>(text);
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'成功'</span>);
    } <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(e);
    }
  };

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">form</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{text}</span> <span class="hljs-attr">onChange</span>=<span class="hljs-string">{e</span> =&gt;</span> setText(e.target.value)} /&gt;
      {/* 直接绑定事件处理函数 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{handleSubmit}</span>&gt;</span>登录<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span></span>
  );
}
</code></pre>
<h4 data-id="heading-10">原则 C：使用 <code>Ref</code> 保持“沉默” (<code>Escape Hatch</code>)</h4>
<p>有时你确实需要在 <code>Effect</code> 中读取一个最新值，但不希望这个值的变化触发 <code>Effect</code> 重新执行。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 场景：聊天室连接后，记录当前的 theme，但切换 theme 不应该导致重连</span>
<span class="hljs-keyword">const</span> themeRef = <span class="hljs-title function_">useRef</span>(theme);

<span class="hljs-comment">// 保持 Ref 最新</span>
<span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
  themeRef.<span class="hljs-property">current</span> = theme;
});

<span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> connection = <span class="hljs-title function_">createConnection</span>();
  connection.<span class="hljs-title function_">on</span>(<span class="hljs-string">'connected'</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// ✅ 读取最新 theme，但不需要将 theme 加入依赖数组</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Connected with theme:'</span>, themeRef.<span class="hljs-property">current</span>);
  });
  <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> connection.<span class="hljs-title function_">disconnect</span>();
}, []); <span class="hljs-comment">// 只有挂载时连接一次</span>
</code></pre>
<h2 data-id="heading-11">结语：构建以“依赖”为核心的心智模型</h2>
<p>从 <code>Class Component</code> 到 <code>Function Component</code> 的迁移，表面上是一次语法的精简，实则是一场心智模型的彻底重构。</p>
<p>在 <code>Class</code> 时代，我们习惯于命令式地控制时间：</p>
<blockquote>
<p>“在组件挂载时（DidMount）做这件事，在更新时（DidUpdate）做那件事。”</p>
</blockquote>
<p>而在 <code>Hooks</code> 时代，<code>React</code> 强迫我们转向声明式的数据流：</p>
<blockquote>
<p>“在这个副作用中，我依赖了这些数据（Dependencies）。每当数据变化，副作用自然随之流转。”</p>
</blockquote>
<h3 data-id="heading-12">Hooks 的代价：手动管理“闭包的新鲜度”</h3>
<p>在 <code>Class</code> 组件中，<code>this.state</code> 像是一个永远指向最新值的全局指针，你随时去读，它都是实时的。</p>
<p>但在 <code>Function</code> 组件中，由于闭包的存在，每一次渲染都是一次独立的快照，每个 <code>Effect</code> 内部持有的数据都可能是“过期”的。</p>
<p><code>React</code> 无法在运行时通过静态分析知道你的闭包里引用了哪些外部变量。因此，依赖数组<code>（Dependency Array）</code> 本质上是你与 <code>React</code> 之间签署的一份 “缓存失效协议”。</p>
<p>你必须显式告诉 <code>React</code>：“当 <code>userId</code> 变化时，上一次的 <code>Effect</code> 闭包已经失效了（因为它引用的是旧的 <code>userId</code>），请销毁它，并运行本次渲染产生的新 <code>Effect</code>。”</p>
<p>这种机制虽然增加了心智负担，但它强迫我们将副作用与数据状态进行严格的同步绑定，从根本上消除了 <code>Class</code> 组件中常见的“数据已变但逻辑未响应”的一致性 <code>Bug</code>。</p>
<h3 data-id="heading-13">获得的巨大回报</h3>
<p>当你适应了这种 <strong>“数据驱动依赖”</strong> 的思维方式后，你会发现一个全新的世界：</p>
<ol>
<li>
<p><strong>逻辑高度内聚：</strong> 相关的业务代码终于可以摆脱生命周期的撕裂，聚合在一起<code>（Co-location）</code>。</p>
</li>
<li>
<p><strong>复用的极致：</strong> 提取一个 <code>useWindowWidth</code> 或 <code>useForm</code> 变得像提取一个普通函数一样简单，逻辑复用不再需要高阶组件的嵌套。</p>
</li>
<li>
<p><strong>原子化的思维：</strong> 正如我们在对比 <code>Jotai</code> 时所发现的，通过函数式更新<code>（prev =&gt; prev + 1）</code>，我们将状态管理的控制权交还给了框架，代码变得更加稳健和可预测。</p>
</li>
<li>
<p><strong>React</strong> 的进化方向很明确：<code>UI</code> 只是数据的投影，而副作用只是数据变化的涟漪。</p>
</li>
</ol>
<h3 data-id="heading-14">你的下一步 (Call to Action)</h3>
<p>不要试图一次性重构整个项目。</p>
<p>下次当你需要修改一个复杂的 <code>Class</code> 组件时，试着不只是“修补”它，而是用 <code>Hooks</code> “重写” 它。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android与JS交互]]></title>    <link>https://juejin.cn/post/7590292192989298728</link>    <guid>https://juejin.cn/post/7590292192989298728</guid>    <pubDate>2026-01-03T13:43:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590292192989298728" data-draft-id="7590403249560895503" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android与JS交互"/> <meta itemprop="keywords" content="JavaScript"/> <meta itemprop="datePublished" content="2026-01-03T13:43:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="XRay"/> <meta itemprop="url" content="https://juejin.cn/user/3966693685869288"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android与JS交互
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3966693685869288/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    XRay
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-03T13:43:45.000Z" title="Sat Jan 03 2026 13:43:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body .octicon{display:inline-block;fill:currentColor;vertical-align:text-bottom}.markdown-body .anchor{float:left;line-height:1;margin-left:-20px;padding-right:4px}.markdown-body .anchor:focus{outline:none}.markdown-body h1 .octicon-link,.markdown-body h2 .octicon-link,.markdown-body h3 .octicon-link,.markdown-body h4 .octicon-link,.markdown-body h5 .octicon-link,.markdown-body h6 .octicon-link{color:#1b1f23;vertical-align:middle;visibility:hidden}.markdown-body h1:hover .anchor,.markdown-body h2:hover .anchor,.markdown-body h3:hover .anchor,.markdown-body h4:hover .anchor,.markdown-body h5:hover .anchor,.markdown-body h6:hover .anchor{text-decoration:none}.markdown-body h1:hover .anchor .octicon-link,.markdown-body h2:hover .anchor .octicon-link,.markdown-body h3:hover .anchor .octicon-link,.markdown-body h4:hover .anchor .octicon-link,.markdown-body h5:hover .anchor .octicon-link,.markdown-body h6:hover .anchor .octicon-link{visibility:visible}.markdown-body h1:hover .anchor .octicon-link:before,.markdown-body h2:hover .anchor .octicon-link:before,.markdown-body h3:hover .anchor .octicon-link:before,.markdown-body h4:hover .anchor .octicon-link:before,.markdown-body h5:hover .anchor .octicon-link:before,.markdown-body h6:hover .anchor .octicon-link:before{width:16px;height:16px;content:" ";display:inline-block;background-image:url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' aria-hidden='true'%3E%3Cpath fill-rule='evenodd' d='M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z'/%3E%3C/svg%3E")}.markdown-body{-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;color:#24292e;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Helvetica,Arial,sans-serif,Apple Color Emoji,Segoe UI Emoji;font-size:16px;line-height:1.5;word-wrap:break-word}.markdown-body details{display:block}.markdown-body summary{display:list-item}.markdown-body a{background-color:initial}.markdown-body a:active,.markdown-body a:hover{outline-width:0}.markdown-body strong{font-weight:inherit;font-weight:bolder}.markdown-body h1{margin:.67em 0}.markdown-body img{border-style:none}.markdown-body code,.markdown-body kbd,.markdown-body pre{font-family:monospace,monospace;font-size:1em}.markdown-body hr{box-sizing:initial;overflow:visible}.markdown-body input{font:inherit;margin:0;overflow:visible}.markdown-body [type=checkbox]{box-sizing:border-box;padding:0}.markdown-body *{box-sizing:border-box}.markdown-body input{font-family:inherit;font-size:inherit;line-height:inherit}.markdown-body a{color:#0366d6;text-decoration:none}.markdown-body a:hover{text-decoration:underline}.markdown-body strong{font-weight:600}.markdown-body hr{height:0;margin:15px 0;overflow:hidden;background:transparent;border-bottom:1px solid #dfe2e5}.markdown-body hr:after,.markdown-body hr:before{display:table;content:""}.markdown-body hr:after{clear:both}.markdown-body table{border-spacing:0;border-collapse:collapse}.markdown-body td,.markdown-body th{padding:0}.markdown-body details summary{cursor:pointer}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin-top:0;margin-bottom:0}.markdown-body h1{font-size:32px}.markdown-body h1,.markdown-body h2{font-weight:600}.markdown-body h2{font-size:24px}.markdown-body h3{font-size:20px}.markdown-body h3,.markdown-body h4{font-weight:600}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:14px}.markdown-body h5,.markdown-body h6{font-weight:600}.markdown-body h6{font-size:12px}.markdown-body p{margin-top:0;margin-bottom:10px}.markdown-body blockquote{margin:0}.markdown-body ol,.markdown-body ul{padding-left:0;margin-top:0;margin-bottom:0}.markdown-body ol ol,.markdown-body ul ol{list-style-type:lower-roman}.markdown-body ol ol ol,.markdown-body ol ul ol,.markdown-body ul ol ol,.markdown-body ul ul ol{list-style-type:lower-alpha}.markdown-body dd{margin-left:0}.markdown-body code,.markdown-body pre{font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:12px}.markdown-body pre{margin-top:0;margin-bottom:0}.markdown-body input::-webkit-inner-spin-button,.markdown-body input::-webkit-outer-spin-button{margin:0;-webkit-appearance:none;appearance:none}.markdown-body :checked+.radio-label{position:relative;z-index:1;border-color:#0366d6}.markdown-body .border{border:1px solid #e1e4e8!important}.markdown-body .border-0{border:0!important}.markdown-body .border-bottom{border-bottom:1px solid #e1e4e8!important}.markdown-body .rounded-1{border-radius:3px!important}.markdown-body .bg-white{background-color:#fff!important}.markdown-body .bg-gray-light{background-color:#fafbfc!important}.markdown-body .text-gray-light{color:#6a737d!important}.markdown-body .pl-3,.markdown-body .px-3{padding-left:16px!important}.markdown-body .px-3{padding-right:16px!important}.markdown-body .f6{font-size:12px!important}.markdown-body .lh-condensed{line-height:1.25!important}.markdown-body .text-bold{font-weight:600!important}.markdown-body .pl-c{color:#6a737d}.markdown-body .pl-c1,.markdown-body .pl-s .pl-v{color:#005cc5}.markdown-body .pl-e,.markdown-body .pl-en{color:#6f42c1}.markdown-body .pl-s .pl-s1,.markdown-body .pl-smi{color:#24292e}.markdown-body .pl-ent{color:#22863a}.markdown-body .pl-k{color:#d73a49}.markdown-body .pl-pds,.markdown-body .pl-s,.markdown-body .pl-s .pl-pse .pl-s1,.markdown-body .pl-sr,.markdown-body .pl-sr .pl-cce,.markdown-body .pl-sr .pl-sra,.markdown-body .pl-sr .pl-sre{color:#032f62}.markdown-body .pl-smw,.markdown-body .pl-v{color:#e36209}.markdown-body .pl-bu{color:#b31d28}.markdown-body .pl-ii{color:#fafbfc;background-color:#b31d28}.markdown-body .pl-c2{color:#fafbfc;background-color:#d73a49}.markdown-body .pl-c2:before{content:"^M"}.markdown-body .pl-sr .pl-cce{font-weight:700;color:#22863a}.markdown-body .pl-ml{color:#735c0f}.markdown-body .pl-mh,.markdown-body .pl-mh .pl-en,.markdown-body .pl-ms{font-weight:700;color:#005cc5}.markdown-body .pl-mi{font-style:italic;color:#24292e}.markdown-body .pl-mb{font-weight:700;color:#24292e}.markdown-body .pl-md{color:#b31d28;background-color:#ffeef0}.markdown-body .pl-mi1{color:#22863a;background-color:#f0fff4}.markdown-body .pl-mc{color:#e36209;background-color:#ffebda}.markdown-body .pl-mi2{color:#f6f8fa;background-color:#005cc5}.markdown-body .pl-mdr{font-weight:700;color:#6f42c1}.markdown-body .pl-ba{color:#586069}.markdown-body .pl-sg{color:#959da5}.markdown-body .pl-corl{text-decoration:underline;color:#032f62}.markdown-body .mb-0{margin-bottom:0!important}.markdown-body .my-2{margin-bottom:8px!important;margin-top:8px!important}.markdown-body .pl-0{padding-left:0!important}.markdown-body .py-0{padding-top:0!important;padding-bottom:0!important}.markdown-body .pl-1{padding-left:4px!important}.markdown-body .pl-2{padding-left:8px!important}.markdown-body .py-2{padding-top:8px!important;padding-bottom:8px!important}.markdown-body .pl-3{padding-left:16px!important}.markdown-body .pl-4{padding-left:24px!important}.markdown-body .pl-5{padding-left:32px!important}.markdown-body .pl-6{padding-left:40px!important}.markdown-body .pl-7{padding-left:48px!important}.markdown-body .pl-8{padding-left:64px!important}.markdown-body .pl-9{padding-left:80px!important}.markdown-body .pl-10{padding-left:96px!important}.markdown-body .pl-11{padding-left:112px!important}.markdown-body .pl-12{padding-left:128px!important}.markdown-body hr{border-bottom-color:#eee}.markdown-body kbd{display:inline-block;padding:3px 5px;font:11px SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;line-height:10px;color:#444d56;vertical-align:middle;background-color:#fafbfc;border:1px solid #d1d5da;border-radius:3px;box-shadow:inset 0 -1px 0 #d1d5da}.markdown-body:after,.markdown-body:before{display:table;content:""}.markdown-body:after{clear:both}.markdown-body&gt;:first-child{margin-top:0!important}.markdown-body&gt;:last-child{margin-bottom:0!important}.markdown-body a:not([href]){color:inherit;text-decoration:none}.markdown-body blockquote,.markdown-body details,.markdown-body dl,.markdown-body ol,.markdown-body p,.markdown-body pre,.markdown-body table,.markdown-body ul{margin-top:0;margin-bottom:16px}.markdown-body hr{height:.25em;padding:0;margin:24px 0;background-color:#e1e4e8;border:0}.markdown-body blockquote{padding:0 1em;color:#6a737d;border-left:.25em solid #dfe2e5}.markdown-body blockquote&gt;:first-child{margin-top:0}.markdown-body blockquote&gt;:last-child{margin-bottom:0}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin-top:24px;margin-bottom:16px;font-weight:600;line-height:1.25}.markdown-body h1{font-size:2em}.markdown-body h1,.markdown-body h2{padding-bottom:.3em;border-bottom:1px solid #eaecef}.markdown-body h2{font-size:1.5em}.markdown-body h3{font-size:1.25em}.markdown-body h4{font-size:1em}.markdown-body h5{font-size:.875em}.markdown-body h6{font-size:.85em;color:#6a737d}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:0;margin-bottom:0}.markdown-body li{word-wrap:break-all}.markdown-body li&gt;p{margin-top:16px}.markdown-body li+li{margin-top:.25em}.markdown-body dl{padding:0}.markdown-body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:600}.markdown-body dl dd{padding:0 16px;margin-bottom:16px}.markdown-body table{display:block;width:100%;overflow:auto}.markdown-body table th{font-weight:600}.markdown-body table td,.markdown-body table th{padding:6px 13px;border:1px solid #dfe2e5}.markdown-body table tr{background-color:#fff;border-top:1px solid #c6cbd1}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}.markdown-body img{max-width:100%;box-sizing:initial;background-color:#fff}.markdown-body img[align=right]{padding-left:20px}.markdown-body img[align=left]{padding-right:20px}.markdown-body code{padding:.2em .4em;margin:0;font-size:85%;background-color:rgba(27,31,35,.05);border-radius:3px}.markdown-body pre{word-wrap:normal}.markdown-body pre&gt;code{padding:0;margin:0;font-size:100%;word-break:normal;white-space:pre;background:transparent;border:0}.markdown-body .highlight{margin-bottom:16px}.markdown-body .highlight pre{margin-bottom:0;word-break:normal}.markdown-body .highlight pre,.markdown-body pre{padding:16px;overflow:auto;font-size:85%;line-height:1.45;background-color:#f6f8fa;border-radius:3px}.markdown-body pre code{display:inline;max-width:auto;padding:0;margin:0;overflow:visible;line-height:inherit;word-wrap:normal;background-color:initial;border:0}.markdown-body .commit-tease-sha{display:inline-block;font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:90%;color:#444d56}.markdown-body .full-commit .btn-outline:not(:disabled):hover{color:#005cc5;border-color:#005cc5}.markdown-body .blob-wrapper{overflow-x:auto;overflow-y:hidden}.markdown-body .blob-wrapper-embedded{max-height:240px;overflow-y:auto}.markdown-body .blob-num{width:1%;min-width:50px;padding-right:10px;padding-left:10px;font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:12px;line-height:20px;color:rgba(27,31,35,.3);text-align:right;white-space:nowrap;vertical-align:top;cursor:pointer;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.markdown-body .blob-num:hover{color:rgba(27,31,35,.6)}.markdown-body .blob-num:before{content:attr(data-line-number)}.markdown-body .blob-code{position:relative;padding-right:10px;padding-left:10px;line-height:20px;vertical-align:top}.markdown-body .blob-code-inner{overflow:visible;font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:12px;color:#24292e;word-wrap:normal;white-space:pre}.markdown-body .pl-token.active,.markdown-body .pl-token:hover{cursor:pointer;background:#ffea7f}.markdown-body .tab-size[data-tab-size="1"]{-moz-tab-size:1;tab-size:1}.markdown-body .tab-size[data-tab-size="2"]{-moz-tab-size:2;tab-size:2}.markdown-body .tab-size[data-tab-size="3"]{-moz-tab-size:3;tab-size:3}.markdown-body .tab-size[data-tab-size="4"]{-moz-tab-size:4;tab-size:4}.markdown-body .tab-size[data-tab-size="5"]{-moz-tab-size:5;tab-size:5}.markdown-body .tab-size[data-tab-size="6"]{-moz-tab-size:6;tab-size:6}.markdown-body .tab-size[data-tab-size="7"]{-moz-tab-size:7;tab-size:7}.markdown-body .tab-size[data-tab-size="8"]{-moz-tab-size:8;tab-size:8}.markdown-body .tab-size[data-tab-size="9"]{-moz-tab-size:9;tab-size:9}.markdown-body .tab-size[data-tab-size="10"]{-moz-tab-size:10;tab-size:10}.markdown-body .tab-size[data-tab-size="11"]{-moz-tab-size:11;tab-size:11}.markdown-body .tab-size[data-tab-size="12"]{-moz-tab-size:12;tab-size:12}.markdown-body .task-list-item{list-style-type:none}.markdown-body .task-list-item+.task-list-item{margin-top:3px}.markdown-body .task-list-item input{margin:0 .2em .25em -1.6em;vertical-align:middle}</style><style data-highlight="" data-highlight-key="github">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1. 交互方式总结</h2>
<p>Android 调用 JS 代码的方法有 2 种：</p>
<ol>
<li>通过 WebView 的 loadUrl();</li>
<li>通过 WebView 的 evaluateJavascript();</li>
</ol>
<p>JS 调用 Android 代码的方法有 3 种：</p>
<ol>
<li>通过 WebView 的 addJavascriptInterface() 进行对象映射;</li>
<li>通过 WebViewClient 的 shouldOverrideUrlLoading() 方法回调拦截 url;</li>
<li>通过 WebChromeClient 的 onJsAlert()、onJsConfirm()、onJsPrompt() 方法回调拦截 JS 对话框的alert()、confirm()、prompt() 消息;</li>
</ol>
<p>二者沟通的桥梁是 WebView。</p>
<h2 data-id="heading-1">2. Android 调用 JS 代码</h2>
<h3 data-id="heading-2">2.1 通过 WebView 的 loadUrl()</h3>
<p>需要加载的 html 文件——javascript.html，把该文件放到 assets 目录下。</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"utf-8"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>JS Interaction<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
        This is a Web View
    <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
        <span class="hljs-keyword">function</span> <span class="hljs-title function_">callJS</span>(<span class="hljs-params"/>){
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Android 调用了 JS 的 callJS() 方法"</span>);
        }
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>

<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<p>MainActivity.java:</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.webviewtest;

<span class="hljs-keyword">import</span> android.os.Bundle;
<span class="hljs-keyword">import</span> android.view.View;
<span class="hljs-keyword">import</span> android.webkit.WebSettings;
<span class="hljs-keyword">import</span> android.webkit.WebView;
<span class="hljs-keyword">import</span> android.widget.Button;
<span class="hljs-keyword">import</span> androidx.appcompat.app.AppCompatActivity;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatActivity</span> {

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(Bundle savedInstanceState)</span> {
        <span class="hljs-built_in">super</span>.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);

        <span class="hljs-type">WebView</span> <span class="hljs-variable">mWebView</span> <span class="hljs-operator">=</span> findViewById(R.id.webview);

        <span class="hljs-type">WebSettings</span> <span class="hljs-variable">webSettings</span> <span class="hljs-operator">=</span> mWebView.getSettings();

        <span class="hljs-comment">// 允许在 WebView 中执行 JS</span>
        webSettings.setJavaScriptEnabled(<span class="hljs-literal">true</span>);
        <span class="hljs-comment">// 载入 url</span>
        mWebView.loadUrl(<span class="hljs-string">"file:///android_asset/javascript.html"</span>);

        <span class="hljs-type">Button</span> <span class="hljs-variable">button</span> <span class="hljs-operator">=</span> findViewById(R.id.button);
        button.setOnClickListener(<span class="hljs-keyword">new</span> <span class="hljs-title class_">View</span>.OnClickListener() {
            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onClick</span><span class="hljs-params">(View v)</span> {
                <span class="hljs-comment">// 调用 JS 的 callJS() 方法</span>
                mWebView.loadUrl(<span class="hljs-string">"javascript:callJS()"</span>);
            }
        });
    }
}
</code></pre>
<p>activity_main.xml:</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"utf-8"</span>?&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">RelativeLayout</span> <span class="hljs-attr">xmlns:android</span>=<span class="hljs-string">"http://schemas.android.com/apk/res/android"</span>
    <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"match_parent"</span>
    <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"match_parent"</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">WebView</span>
        <span class="hljs-attr">android:id</span>=<span class="hljs-string">"@+id/webview"</span>
        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"match_parent"</span>
        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"300dp"</span>/&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">Button</span>
        <span class="hljs-attr">android:id</span>=<span class="hljs-string">"@+id/button"</span>
        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"match_parent"</span>
        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"wrap_content"</span>
        <span class="hljs-attr">android:text</span>=<span class="hljs-string">"Call JS"</span>
        <span class="hljs-attr">android:textAllCaps</span>=<span class="hljs-string">"false"</span>
        <span class="hljs-attr">android:layout_below</span>=<span class="hljs-string">"@+id/webview"</span>
        <span class="hljs-attr">android:layout_marginTop</span>=<span class="hljs-string">"10dp"</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">RelativeLayout</span>&gt;</span>
</code></pre>
<p>这里直接通过 WebView 的 loadUrl() 方法传入字符串 javascript:callJS() 即可调用 JS 中的 callJS() 方法，但是 loadUrl() 会使页面刷新，并且该方法拿不到 JS 的返回值。</p>
<h3 data-id="heading-3">2.2 通过 WebView 的 evaluateJavascript()</h3>
<p>该方法与第一种方法的区别是：</p>
<ol>
<li>该方法比第一种方法执行效率更高，因为该方法的执行不会使页面刷新；</li>
<li>该方法在 Android 4.4 及以后才可以使用；</li>
<li>该方法可以拿到 JS 的返回值；</li>
</ol>
<p>把第一种方法中的 JS 改成下面这样：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"utf-8"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>JS Interaction<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
        This is a Web View
    <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
        <span class="hljs-keyword">function</span> <span class="hljs-title function_">callJS</span>(<span class="hljs-params"/>){
            <span class="hljs-keyword">return</span> <span class="hljs-string">"Android 调用了 JS 的 callJS() 方法"</span>;
        }
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>

<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<p>MainActivity.java 修改如下：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.webviewtest;

<span class="hljs-keyword">import</span> android.app.AlertDialog;
<span class="hljs-keyword">import</span> android.content.DialogInterface;
<span class="hljs-keyword">import</span> android.os.Bundle;
<span class="hljs-keyword">import</span> android.view.View;
<span class="hljs-keyword">import</span> android.webkit.ValueCallback;
<span class="hljs-keyword">import</span> android.webkit.WebSettings;
<span class="hljs-keyword">import</span> android.webkit.WebView;
<span class="hljs-keyword">import</span> android.widget.Button;

<span class="hljs-keyword">import</span> androidx.appcompat.app.AppCompatActivity;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatActivity</span> {

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(Bundle savedInstanceState)</span> {
        <span class="hljs-built_in">super</span>.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);

        <span class="hljs-type">WebView</span> <span class="hljs-variable">mWebView</span> <span class="hljs-operator">=</span> findViewById(R.id.webview);

        <span class="hljs-type">WebSettings</span> <span class="hljs-variable">webSettings</span> <span class="hljs-operator">=</span> mWebView.getSettings();

        webSettings.setJavaScriptEnabled(<span class="hljs-literal">true</span>);

        mWebView.loadUrl(<span class="hljs-string">"file:///android_asset/javascript.html"</span>);

        <span class="hljs-type">Button</span> <span class="hljs-variable">button</span> <span class="hljs-operator">=</span> findViewById(R.id.button);

        button.setOnClickListener(<span class="hljs-keyword">new</span> <span class="hljs-title class_">View</span>.OnClickListener() {
            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onClick</span><span class="hljs-params">(View v)</span> {

                mWebView.evaluateJavascript(<span class="hljs-string">"javascript:callJS()"</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">ValueCallback</span>&lt;String&gt;() {
                    <span class="hljs-meta">@Override</span>
                    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onReceiveValue</span><span class="hljs-params">(String value)</span> {
                        <span class="hljs-comment">// values 是 JS 的返回</span>

                        <span class="hljs-comment">// evaluateJavascript() 方法返回的值会被封装成一个 JSON 格式的字符串，</span>
                        <span class="hljs-comment">// 如果 JS 函数返回 "Hello from JavaScript!"，</span>
                        <span class="hljs-comment">// Android 端会接收到 "\"Hello from JavaScript!"\" 这样的结果,</span>
                        <span class="hljs-comment">// 所以需要转换</span>
                        <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> value != <span class="hljs-literal">null</span> ? value.replace(<span class="hljs-string">"\""</span>, <span class="hljs-string">""</span>) : <span class="hljs-string">""</span>;
                        AlertDialog.<span class="hljs-type">Builder</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AlertDialog</span>.Builder(MainActivity.<span class="hljs-built_in">this</span>);
                        b.setTitle(<span class="hljs-string">"Alert"</span>);
                        b.setMessage(result);
                        b.setPositiveButton(android.R.string.ok, <span class="hljs-keyword">new</span> <span class="hljs-title class_">DialogInterface</span>.OnClickListener() {
                            <span class="hljs-meta">@Override</span>
                            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onClick</span><span class="hljs-params">(DialogInterface dialog, <span class="hljs-type">int</span> which)</span> {
                                dialog.dismiss();
                            }
                        });
                        b.setCancelable(<span class="hljs-literal">false</span>);
                        b.create().show();
                    }
                });
            }
        });

    }
}
</code></pre>
<p>evaluateJavascript() 方法有两个参数，第一个参数是要执行的 JS 方法，第二个参数是 JS 执行后触发的回调，在这里可以拿到 JS 方法的返回值。</p>
<p>建议在 Android 4.4 以下使用第一种方法，Android 4.4 及以上使用第二种方法。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">version</span> <span class="hljs-operator">=</span> Build.VERSION.SDK_INT;
<span class="hljs-keyword">if</span> (version &lt; Build.VERSION_CODES.KITKAT) {
        mWebView.loadUrl(<span class="hljs-string">"javascript:callJS()"</span>);
    } <span class="hljs-keyword">else</span> {
        mWebView.evaluateJavascript(<span class="hljs-string">"javascript:callJS()"</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">ValueCallback</span>&lt;String&gt;() {
            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onReceiveValue</span><span class="hljs-params">(String value)</span> {

            }
        });
}
</code></pre>
<p>注意，我这里都是在点击事件中调用 JS 的代码，最好等 WebView 页面加载完，在在 WebViewClient 的 onPageFinished() 方法中调用 JS 的代码。</p>
<h3 data-id="heading-4">2.3 两种方法的对比</h3>























<table><thead><tr><th>调用方式</th><th>优点</th><th>缺点</th><th>使用建议</th></tr></thead><tbody><tr><td>loadUrl()</td><td>简单</td><td>执行效率低，获取返回值麻烦</td><td>Android 4.4 以下用这个方法</td></tr><tr><td>evaluateJavascript()</td><td>执行效率高</td><td>向下兼容性差（Android 4.4 以上可用）</td><td>Android 4.4 以上用这个方法</td></tr></tbody></table>
<h2 data-id="heading-5">3. JS 调用 Android 代码</h2>
<h3 data-id="heading-6">3.1 通过 WebView 的 addJavascriptInterface() 进行对象映射</h3>
<p>步骤 1 ：定义一个要注入到 JS 中的类：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.webviewtest;

<span class="hljs-keyword">import</span> android.webkit.JavascriptInterface;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JsObject</span> {

    <span class="hljs-comment">// 对于 Build.VERSION_CODES.JELLY_BEAN_MR1 及以上的版本，</span>
    <span class="hljs-comment">// 只有添加了 @JavascriptInterface 注解的 public 方法才能从 JavaScript 中访问</span>
    <span class="hljs-meta">@JavascriptInterface</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">hello</span><span class="hljs-params">(String msg)</span> {
        System.out.println(<span class="hljs-string">" JS 调用了 Android 的 hello 方法"</span>);
    }
}
</code></pre>
<p>步骤 2 ：在 assets 目录下添加需要加载的 JS 代码：javascript.html</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"utf-8"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>JS Interaction<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
        <span class="hljs-keyword">function</span> <span class="hljs-title function_">callAndroid</span>(<span class="hljs-params"/>){
            <span class="hljs-comment">// 由于对象映射，所以调用 test 对象等于调用 Android 中的对象</span>
            test.<span class="hljs-title function_">hello</span>(<span class="hljs-string">"js调用了android中的hello方法"</span>);
        }
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"button"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"button1"</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"callAndroid()"</span>&gt;</span>点击调用 Android 代码<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<p>步骤 3 ：在 Android 中通过 WebView 的 addJavascriptInterface() 方法将 Java 对象注入 WebView 中的 JavaScript。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.webviewtest;

<span class="hljs-keyword">import</span> android.os.Bundle;
<span class="hljs-keyword">import</span> android.webkit.WebSettings;
<span class="hljs-keyword">import</span> android.webkit.WebView;

<span class="hljs-keyword">import</span> androidx.appcompat.app.AppCompatActivity;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatActivity</span> {

    WebView mWebView;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(Bundle savedInstanceState)</span> {
        <span class="hljs-built_in">super</span>.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);

        mWebView = findViewById(R.id.webview);
        <span class="hljs-type">WebSettings</span> <span class="hljs-variable">webSettings</span> <span class="hljs-operator">=</span> mWebView.getSettings();

        webSettings.setJavaScriptEnabled(<span class="hljs-literal">true</span>);

        <span class="hljs-comment">// 通过 addJavascriptInterface() 方法将 Java 对象注入 WebView 中的 JavaScript</span>
        <span class="hljs-comment">// 参数1：注入的 Java 对象</span>
        <span class="hljs-comment">// 参数2：暴露在 JS 中对应的实例的名字</span>
        mWebView.addJavascriptInterface(<span class="hljs-keyword">new</span> <span class="hljs-title class_">JsObject</span>(), <span class="hljs-string">"test"</span>);

        mWebView.loadUrl(<span class="hljs-string">"file:///android_asset/javascript.html"</span>);
    }
}
</code></pre>
<p>activity_main.xml:</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"utf-8"</span>?&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">RelativeLayout</span> <span class="hljs-attr">xmlns:android</span>=<span class="hljs-string">"http://schemas.android.com/apk/res/android"</span>
    <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"match_parent"</span>
    <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"match_parent"</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">WebView</span>
        <span class="hljs-attr">android:id</span>=<span class="hljs-string">"@+id/webview"</span>
        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"match_parent"</span>
        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"wrap_content"</span>/&gt;</span>

<span class="hljs-tag">&lt;/<span class="hljs-name">RelativeLayout</span>&gt;</span>
</code></pre>
<p>这样点击 html 中的 button 会调用 callAndroid() 方法，然后会调用 test 实例的 hello() 方法，相应会调用 JsObject 实例的 hello() 方法。</p>
<p>这个方法的优点是简单，缺点是存在安全漏洞。Google 在 Android 4.2 及以上的版本中规定对被调用的函数要以 @JavascriptInterface 进行注解从而避免漏洞攻击，在 Android 4.2 以下 @JavascriptInterface 是无效的，存在安全漏洞。在 Android 4.2 以下需要采用拦截 prompt() 的方式进行漏洞修复。</p>
<h3 data-id="heading-7">3.2 通过 WebViewClient 的 shouldOverrideUrlLoading() 方法拦截 url</h3>
<p>javascript.html:</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"utf-8"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>JS Interaction<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
        <span class="hljs-keyword">function</span> <span class="hljs-title function_">callAndroid</span>(<span class="hljs-params"/>){
            <span class="hljs-variable language_">document</span>.<span class="hljs-property">location</span> = <span class="hljs-string">"js://webview?arg1=111&amp;arg2=222"</span>;
        }
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"button"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"button1"</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"callAndroid()"</span>&gt;</span>点击调用 Android 代码<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<p>MainActivity.java:</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.webviewtest;

<span class="hljs-keyword">import</span> android.net.Uri;
<span class="hljs-keyword">import</span> android.os.Build;
<span class="hljs-keyword">import</span> android.os.Bundle;
<span class="hljs-keyword">import</span> android.util.Log;
<span class="hljs-keyword">import</span> android.webkit.WebResourceRequest;
<span class="hljs-keyword">import</span> android.webkit.WebSettings;
<span class="hljs-keyword">import</span> android.webkit.WebView;
<span class="hljs-keyword">import</span> android.webkit.WebViewClient;

<span class="hljs-keyword">import</span> androidx.appcompat.app.AppCompatActivity;

<span class="hljs-keyword">import</span> java.util.Set;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatActivity</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">TAG</span> <span class="hljs-operator">=</span> MainActivity.class.getSimpleName();

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(Bundle savedInstanceState)</span> {
        <span class="hljs-built_in">super</span>.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);

        <span class="hljs-type">WebView</span> <span class="hljs-variable">mWebView</span> <span class="hljs-operator">=</span> findViewById(R.id.webview);

        <span class="hljs-type">WebSettings</span> <span class="hljs-variable">webSettings</span> <span class="hljs-operator">=</span> mWebView.getSettings();

        webSettings.setJavaScriptEnabled(<span class="hljs-literal">true</span>);

        mWebView.loadUrl(<span class="hljs-string">"file:///android_asset/javascript.html"</span>);

        mWebView.setWebViewClient(<span class="hljs-keyword">new</span> <span class="hljs-title class_">WebViewClient</span>() {

            <span class="hljs-comment">//该重载方法不建议使用了，Android 7.0 以上已经摒弃了</span>
            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">shouldOverrideUrlLoading</span><span class="hljs-params">(WebView view, String url)</span> {
                <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.shouldOverrideUrlLoading(view, url);
            }

            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">shouldOverrideUrlLoading</span><span class="hljs-params">(WebView view, WebResourceRequest request)</span> {
                <span class="hljs-comment">// 传入进来的 url = "js://webview?arg1=111&amp;arg2=222"</span>
                Uri uri;
                <span class="hljs-keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.LOLLIPOP) {
                    uri = request.getUrl();
                } <span class="hljs-keyword">else</span> {
                    uri = Uri.parse(request.toString());
                }
                <span class="hljs-comment">// 先判断 scheme</span>
                <span class="hljs-keyword">if</span> (<span class="hljs-string">"js"</span>.equals(uri.getScheme())) {
                    <span class="hljs-comment">// 再判断 authority</span>
                    <span class="hljs-keyword">if</span> (<span class="hljs-string">"webview"</span>.equals(uri.getAuthority())) {

                        <span class="hljs-comment">// 执行对应的代码</span>
                        Log.d(TAG, <span class="hljs-string">"JS 调用了 Android 的方法"</span>);
                        Set&lt;String&gt; sets = uri.getQueryParameterNames();
                        <span class="hljs-keyword">for</span> (String key : sets) {
                            Log.d(TAG, <span class="hljs-string">"param:"</span> + uri.getQueryParameter(key));
                        }
                        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
                    }
                }
                <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.shouldOverrideUrlLoading(view, request);
            }
        });
    }
}
</code></pre>
<p>原理就是通过解析 url 的协议调用相应的代码。</p>
<p>该方式的优点是不存在方式一的漏洞，缺点是如果 JS 想获取 Android 方法的返回值会比较麻烦。</p>
<p>如果 JS 想要拿到 Android 方法的返回值，只能通过 WebView 的 loadUrl() 去执行 JS 代码中的方法把返回值传递给 JS，代码如下：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Android：MainActivity.java</span>
mWebView.loadUrl(<span class="hljs-string">"javascript:returnResult("</span> + result + <span class="hljs-string">")"</span>);

<span class="hljs-comment">// JS：javascript.html</span>
function <span class="hljs-title function_">returnResult</span><span class="hljs-params">(result)</span>{
    alert(<span class="hljs-string">"result is"</span> + result);
}
</code></pre>
<h3 data-id="heading-8">3.3 通过 WebChromeClient 的 onJsAlert()、onJsConfirm()、onJsPrompt() 方法回调拦截</h3>
<p>在 JS 中，有三个常用的弹出对话框的方法：</p>
<ul>
<li>alert()，用于弹出警告框，没有返回值，在文本中加入 \n 可以换行；</li>
<li>confirm()，用于弹出确认框，有两个返回值，返回 true 表示点击了确认按钮，false 表示点击了取消按钮；</li>
<li>prompt()，用于弹出输入框，可以任意设置返回值，点击确认会返回输入框中的字符串，点击取消会返回 null；</li>
</ul>
<p>这 3 个方法分别会触发 WebChromeClient 的 onJsAlert()、onJsConfirm()、onJsPrompt() 方法。</p>
<p>最常用的是使用 JS 的 prompt() 方法，因为只有 prompt() 可以返回任意类型的值，看下面的示例：</p>
<p>javascript.html:</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"utf-8"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>JS Interactiion<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
        <span class="hljs-keyword">function</span> <span class="hljs-title function_">callPrompt</span>(<span class="hljs-params"/>){
            <span class="hljs-keyword">var</span> result = <span class="hljs-title function_">prompt</span>(<span class="hljs-string">"js://webview?arg1=8&amp;arg2=9"</span>);
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"result is:"</span> + result);
        }
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"button"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"button1"</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"callPrompt()"</span>&gt;</span>点击调用 Android 代码<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<p>MainActivity.java:</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.webviewtest;

<span class="hljs-keyword">import</span> android.net.Uri;
<span class="hljs-keyword">import</span> android.os.Bundle;
<span class="hljs-keyword">import</span> android.util.Log;
<span class="hljs-keyword">import</span> android.webkit.JsPromptResult;
<span class="hljs-keyword">import</span> android.webkit.WebChromeClient;
<span class="hljs-keyword">import</span> android.webkit.WebSettings;
<span class="hljs-keyword">import</span> android.webkit.WebView;

<span class="hljs-keyword">import</span> androidx.appcompat.app.AppCompatActivity;

<span class="hljs-keyword">import</span> java.util.Set;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatActivity</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">TAG</span> <span class="hljs-operator">=</span> MainActivity.class.getSimpleName();

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(Bundle savedInstanceState)</span> {
        <span class="hljs-built_in">super</span>.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);

        <span class="hljs-type">WebView</span> <span class="hljs-variable">mWebView</span> <span class="hljs-operator">=</span> findViewById(R.id.webview);

        <span class="hljs-type">WebSettings</span> <span class="hljs-variable">webSettings</span> <span class="hljs-operator">=</span> mWebView.getSettings();

        webSettings.setJavaScriptEnabled(<span class="hljs-literal">true</span>);

        mWebView.loadUrl(<span class="hljs-string">"file:///android_asset/javascript.html"</span>);

        mWebView.setWebChromeClient(<span class="hljs-keyword">new</span> <span class="hljs-title class_">WebChromeClient</span>() {
            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">onJsPrompt</span><span class="hljs-params">(WebView view, String url, String message, String defaultValue, JsPromptResult result)</span> {
                <span class="hljs-comment">// 传入进来的 url = "js://webview?arg1=8&amp;arg2=9"</span>

                <span class="hljs-type">Uri</span> <span class="hljs-variable">uri</span> <span class="hljs-operator">=</span> Uri.parse(message);
                <span class="hljs-keyword">if</span> (uri.getScheme().equals(<span class="hljs-string">"js"</span>)) {

                    <span class="hljs-keyword">if</span> (uri.getAuthority().equals(<span class="hljs-string">"webview"</span>)) {

                        <span class="hljs-comment">// 执行对应的代码</span>
                        Log.d(TAG, <span class="hljs-string">"JS 调用了 Android 的方法"</span>);
                        Set&lt;String&gt; sets = uri.getQueryParameterNames();
                        <span class="hljs-keyword">for</span> (String key : sets) {
                            Log.d(TAG, <span class="hljs-string">"param:"</span> + uri.getQueryParameter(key));
                        }

                        <span class="hljs-comment">// JsPromptResult 用于把结果返回给 JS</span>
                        result.confirm(<span class="hljs-string">"JS 调用 Android 的方法成功啦！"</span>);
                    }
                    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
                }
                <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.onJsPrompt(view, url, message, defaultValue, result);
            }
        });
    }
}
</code></pre>
<h3 data-id="heading-9">3.4 三种方法的对比</h3>





























<table><thead><tr><th>调用方式</th><th>优点</th><th>缺点</th><th>使用场景</th></tr></thead><tbody><tr><td>通过 WebView 的 addJavascriptInterface() 进行对象映射</td><td>简单</td><td>Android 4.2 以下存在漏洞</td><td>Android 4.2 以上用这个方法</td></tr><tr><td>通过 WebViewClient 的 shouldOverrideUrlLoading() 方法拦截 url</td><td>没有漏洞问题</td><td>相对复杂，需要解析 url</td><td>不需要 Android 端的方法的返回值的场景</td></tr><tr><td>通过 WebChromeClient 的 onJsAlert()、onJsConfirm()、onJsPrompt() 方法回调拦截</td><td>没有漏洞问题</td><td>相对复杂，需要解析 url</td><td>能满足大多数场景</td></tr></tbody></table></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Java学习第33天 - 微服务架构与云原生]]></title>    <link>https://juejin.cn/post/7590597231708241955</link>    <guid>https://juejin.cn/post/7590597231708241955</guid>    <pubDate>2026-01-04T01:53:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590597231708241955" data-draft-id="7590403249561550863" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Java学习第33天 - 微服务架构与云原生"/> <meta itemprop="keywords" content="Java"/> <meta itemprop="datePublished" content="2026-01-04T01:53:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="浮游本尊"/> <meta itemprop="url" content="https://juejin.cn/user/2533726710668696"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Java学习第33天 - 微服务架构与云原生
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2533726710668696/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    浮游本尊
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-04T01:53:44.000Z" title="Sun Jan 04 2026 01:53:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">学习目标</h2>
<p>深入理解微服务架构设计，掌握云原生技术栈，学习系统设计方法，准备技术面试，了解新技术趋势，完成项目实战。</p>
<hr/>
<h2 data-id="heading-1">1. 微服务架构深入</h2>
<h3 data-id="heading-2">1.1 服务注册与发现</h3>
<p><strong>Eureka服务注册中心：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Eureka Server配置</span>
<span class="hljs-meta">@SpringBootApplication</span>
<span class="hljs-meta">@EnableEurekaServer</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EurekaServerApplication</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        SpringApplication.run(EurekaServerApplication.class, args);
    }
}

<span class="hljs-comment">// Eureka Server配置类</span>
<span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EurekaServerConfig</span> {
    
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> EurekaInstanceConfigBean <span class="hljs-title function_">eurekaInstanceConfig</span><span class="hljs-params">()</span> {
        <span class="hljs-type">EurekaInstanceConfigBean</span> <span class="hljs-variable">config</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">EurekaInstanceConfigBean</span>();
        config.setHostname(<span class="hljs-string">"localhost"</span>);
        config.setInstanceId(<span class="hljs-string">"eureka-server"</span>);
        config.setLeaseRenewalIntervalInSeconds(<span class="hljs-number">30</span>);
        config.setLeaseExpirationDurationInSeconds(<span class="hljs-number">90</span>);
        <span class="hljs-keyword">return</span> config;
    }
}

<span class="hljs-comment">// Eureka Client配置</span>
<span class="hljs-meta">@SpringBootApplication</span>
<span class="hljs-meta">@EnableEurekaClient</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderServiceApplication</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        SpringApplication.run(OrderServiceApplication.class, args);
    }
}

<span class="hljs-comment">// Eureka Client配置类</span>
<span class="hljs-meta">@Configuration</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EurekaClientConfig</span> {
    
    <span class="hljs-meta">@Value("${eureka.instance.hostname}")</span>
    <span class="hljs-keyword">private</span> String hostname;
    
    <span class="hljs-meta">@Value("${server.port}")</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> port;
    
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> EurekaInstanceConfigBean <span class="hljs-title function_">eurekaInstanceConfig</span><span class="hljs-params">()</span> {
        <span class="hljs-type">EurekaInstanceConfigBean</span> <span class="hljs-variable">config</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">EurekaInstanceConfigBean</span>();
        config.setHostname(hostname);
        config.setInstanceId(hostname + <span class="hljs-string">":"</span> + port);
        config.setLeaseRenewalIntervalInSeconds(<span class="hljs-number">30</span>);
        config.setLeaseExpirationDurationInSeconds(<span class="hljs-number">90</span>);
        
        <span class="hljs-comment">// 健康检查配置</span>
        Map&lt;String, String&gt; metadataMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
        metadataMap.put(<span class="hljs-string">"management.port"</span>, String.valueOf(port));
        config.setMetadataMap(metadataMap);
        
        <span class="hljs-keyword">return</span> config;
    }
}

<span class="hljs-comment">// 服务发现客户端</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ServiceDiscoveryClient</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> DiscoveryClient discoveryClient;
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RestTemplate restTemplate;
    
    <span class="hljs-comment">// 获取服务实例</span>
    <span class="hljs-keyword">public</span> List&lt;ServiceInstance&gt; <span class="hljs-title function_">getServiceInstances</span><span class="hljs-params">(String serviceName)</span> {
        <span class="hljs-keyword">return</span> discoveryClient.getInstances(serviceName);
    }
    
    <span class="hljs-comment">// 负载均衡调用服务</span>
    <span class="hljs-keyword">public</span> &lt;T&gt; T <span class="hljs-title function_">callService</span><span class="hljs-params">(String serviceName, String path, Class&lt;T&gt; responseType)</span> {
        List&lt;ServiceInstance&gt; instances = getServiceInstances(serviceName);
        
        <span class="hljs-keyword">if</span> (instances.isEmpty()) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"服务不可用: "</span> + serviceName);
        }
        
        <span class="hljs-comment">// 简单轮询负载均衡</span>
        <span class="hljs-type">ServiceInstance</span> <span class="hljs-variable">instance</span> <span class="hljs-operator">=</span> instances.get(
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">Random</span>().nextInt(instances.size())
        );
        
        <span class="hljs-type">String</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> <span class="hljs-string">"http://"</span> + instance.getHost() + <span class="hljs-string">":"</span> + instance.getPort() + path;
        <span class="hljs-keyword">return</span> restTemplate.getForObject(url, responseType);
    }
    
    <span class="hljs-comment">// 使用Ribbon负载均衡</span>
    <span class="hljs-meta">@LoadBalanced</span>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> RestTemplate <span class="hljs-title function_">restTemplate</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RestTemplate</span>();
    }
    
    <span class="hljs-keyword">public</span> &lt;T&gt; T <span class="hljs-title function_">callServiceWithRibbon</span><span class="hljs-params">(String serviceName, String path, Class&lt;T&gt; responseType)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> <span class="hljs-string">"http://"</span> + serviceName + path;
        <span class="hljs-keyword">return</span> restTemplate.getForObject(url, responseType);
    }
}
</code></pre>
<h3 data-id="heading-3">1.2 配置中心</h3>
<p><strong>Spring Cloud Config配置中心：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Config Server配置</span>
<span class="hljs-meta">@SpringBootApplication</span>
<span class="hljs-meta">@EnableConfigServer</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConfigServerApplication</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        SpringApplication.run(ConfigServerApplication.class, args);
    }
}

<span class="hljs-comment">// Config Server配置类</span>
<span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConfigServerConfig</span> {
    
    <span class="hljs-comment">// Git仓库配置</span>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> GitRepository <span class="hljs-title function_">gitRepository</span><span class="hljs-params">()</span> {
        <span class="hljs-type">GitRepository</span> <span class="hljs-variable">repository</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">GitRepository</span>();
        repository.setUri(<span class="hljs-string">"https://github.com/example/config-repo.git"</span>);
        repository.setSearchPaths(<span class="hljs-string">"config"</span>);
        <span class="hljs-keyword">return</span> repository;
    }
}

<span class="hljs-comment">// Config Client配置</span>
<span class="hljs-meta">@SpringBootApplication</span>
<span class="hljs-meta">@EnableConfigClient</span>
<span class="hljs-meta">@RefreshScope</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderServiceApplication</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        SpringApplication.run(OrderServiceApplication.class, args);
    }
}

<span class="hljs-comment">// 动态配置服务</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DynamicConfigService</span> {
    
    <span class="hljs-meta">@Value("${app.order.timeout:5000}")</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> orderTimeout;
    
    <span class="hljs-meta">@Value("${app.order.retry-count:3}")</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> retryCount;
    
    <span class="hljs-meta">@Value("${app.feature.enable-new-payment:false}")</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> enableNewPayment;
    
    <span class="hljs-comment">// 获取配置值</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getOrderTimeout</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> orderTimeout;
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getRetryCount</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> retryCount;
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isEnableNewPayment</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> enableNewPayment;
    }
    
    <span class="hljs-comment">// 配置变更监听</span>
    <span class="hljs-meta">@EventListener</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleConfigChange</span><span class="hljs-params">(EnvironmentChangeEvent event)</span> {
        log.info(<span class="hljs-string">"配置变更: {}"</span>, event.getKeys());
        <span class="hljs-comment">// 处理配置变更逻辑</span>
    }
}

<span class="hljs-comment">// Nacos配置中心（替代方案）</span>
<span class="hljs-meta">@Configuration</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">NacosConfig</span> {
    
    <span class="hljs-meta">@NacosValue(value = "${app.order.timeout:5000}", autoRefreshed = true)</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> orderTimeout;
    
    <span class="hljs-meta">@NacosValue(value = "${app.order.retry-count:3}", autoRefreshed = true)</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> retryCount;
    
    <span class="hljs-comment">// 监听配置变更</span>
    <span class="hljs-meta">@NacosConfigListener(dataId = "order-service", groupId = "DEFAULT_GROUP")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onConfigChange</span><span class="hljs-params">(String newConfig)</span> {
        log.info(<span class="hljs-string">"配置变更: {}"</span>, newConfig);
        <span class="hljs-comment">// 解析并应用新配置</span>
    }
}
</code></pre>
<h3 data-id="heading-4">1.3 API网关</h3>
<p><strong>Spring Cloud Gateway：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Gateway配置</span>
<span class="hljs-meta">@SpringBootApplication</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GatewayApplication</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        SpringApplication.run(GatewayApplication.class, args);
    }
}

<span class="hljs-comment">// Gateway路由配置</span>
<span class="hljs-meta">@Configuration</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GatewayConfig</span> {
    
    <span class="hljs-comment">// 路由配置</span>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> RouteLocator <span class="hljs-title function_">customRouteLocator</span><span class="hljs-params">(RouteLocatorBuilder builder)</span> {
        <span class="hljs-keyword">return</span> builder.routes()
            <span class="hljs-comment">// 订单服务路由</span>
            .route(<span class="hljs-string">"order-service"</span>, r -&gt; r
                .path(<span class="hljs-string">"/api/orders/**"</span>)
                .filters(f -&gt; f
                    .stripPrefix(<span class="hljs-number">1</span>)
                    .addRequestHeader(<span class="hljs-string">"X-Gateway"</span>, <span class="hljs-string">"Spring-Cloud-Gateway"</span>)
                    .retry(config -&gt; config
                        .setRetries(<span class="hljs-number">3</span>)
                        .setStatuses(HttpStatus.INTERNAL_SERVER_ERROR)
                        .setMethods(HttpMethod.GET)
                    )
                )
                .uri(<span class="hljs-string">"lb://order-service"</span>)
            )
            <span class="hljs-comment">// 用户服务路由</span>
            .route(<span class="hljs-string">"user-service"</span>, r -&gt; r
                .path(<span class="hljs-string">"/api/users/**"</span>)
                .filters(f -&gt; f
                    .stripPrefix(<span class="hljs-number">1</span>)
                    .circuitBreaker(config -&gt; config
                        .setName(<span class="hljs-string">"user-service-circuit"</span>)
                        .setFallbackUri(<span class="hljs-string">"forward:/fallback/user"</span>)
                    )
                )
                .uri(<span class="hljs-string">"lb://user-service"</span>)
            )
            <span class="hljs-comment">// 限流路由</span>
            .route(<span class="hljs-string">"rate-limit-route"</span>, r -&gt; r
                .path(<span class="hljs-string">"/api/public/**"</span>)
                .filters(f -&gt; f
                    .requestRateLimiter(config -&gt; config
                        .setRateLimiter(redisRateLimiter())
                        .setKeyResolver(ipKeyResolver())
                    )
                )
                .uri(<span class="hljs-string">"lb://public-service"</span>)
            )
            .build();
    }
    
    <span class="hljs-comment">// Redis限流器</span>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> RedisRateLimiter <span class="hljs-title function_">redisRateLimiter</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RedisRateLimiter</span>(<span class="hljs-number">10</span>, <span class="hljs-number">20</span>); <span class="hljs-comment">// 每秒10个请求，突发20个</span>
    }
    
    <span class="hljs-comment">// 限流Key解析器（按IP限流）</span>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> KeyResolver <span class="hljs-title function_">ipKeyResolver</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> exchange -&gt; Mono.just(
            exchange.getRequest().getRemoteAddress().getAddress().getHostAddress()
        );
    }
    
    <span class="hljs-comment">// 全局过滤器</span>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> GlobalFilter <span class="hljs-title function_">customGlobalFilter</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> (exchange, chain) -&gt; {
            <span class="hljs-type">ServerHttpRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> exchange.getRequest();
            log.info(<span class="hljs-string">"请求路径: {}"</span>, request.getURI().getPath());
            
            <span class="hljs-comment">// 添加请求头</span>
            <span class="hljs-type">ServerHttpRequest</span> <span class="hljs-variable">modifiedRequest</span> <span class="hljs-operator">=</span> request.mutate()
                .header(<span class="hljs-string">"X-Request-Time"</span>, String.valueOf(System.currentTimeMillis()))
                .build();
            
            <span class="hljs-keyword">return</span> chain.filter(exchange.mutate().request(modifiedRequest).build());
        };
    }
    
    <span class="hljs-comment">// 自定义过滤器</span>
    <span class="hljs-meta">@Component</span>
    <span class="hljs-meta">@Slf4j</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AuthFilter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">GatewayFilter</span>, Ordered {
        
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> Mono&lt;Void&gt; <span class="hljs-title function_">filter</span><span class="hljs-params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> {
            <span class="hljs-type">ServerHttpRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> exchange.getRequest();
            <span class="hljs-type">String</span> <span class="hljs-variable">token</span> <span class="hljs-operator">=</span> request.getHeaders().getFirst(<span class="hljs-string">"Authorization"</span>);
            
            <span class="hljs-keyword">if</span> (token == <span class="hljs-literal">null</span> || !isValidToken(token)) {
                <span class="hljs-type">ServerHttpResponse</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> exchange.getResponse();
                response.setStatusCode(HttpStatus.UNAUTHORIZED);
                <span class="hljs-keyword">return</span> response.setComplete();
            }
            
            <span class="hljs-keyword">return</span> chain.filter(exchange);
        }
        
        <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isValidToken</span><span class="hljs-params">(String token)</span> {
            <span class="hljs-comment">// Token验证逻辑</span>
            <span class="hljs-keyword">return</span> token.startsWith(<span class="hljs-string">"Bearer "</span>);
        }
        
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getOrder</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">return</span> -<span class="hljs-number">100</span>;
        }
    }
}

<span class="hljs-comment">// 降级处理</span>
<span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FallbackController</span> {
    
    <span class="hljs-meta">@RequestMapping("/fallback/user")</span>
    <span class="hljs-keyword">public</span> ResponseEntity&lt;Map&lt;String, Object&gt;&gt; <span class="hljs-title function_">userFallback</span><span class="hljs-params">()</span> {
        Map&lt;String, Object&gt; result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
        result.put(<span class="hljs-string">"code"</span>, <span class="hljs-number">500</span>);
        result.put(<span class="hljs-string">"message"</span>, <span class="hljs-string">"用户服务暂时不可用，请稍后重试"</span>);
        <span class="hljs-keyword">return</span> ResponseEntity.status(HttpStatus.SERVICE_UNAVAILABLE).body(result);
    }
}
</code></pre>
<h3 data-id="heading-5">1.4 服务调用</h3>
<p><strong>OpenFeign服务调用：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Feign客户端接口</span>
<span class="hljs-meta">@FeignClient(name = "user-service", fallback = UserServiceFallback.class)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserServiceClient</span> {
    
    <span class="hljs-meta">@GetMapping("/api/users/{id}")</span>
    UserDTO <span class="hljs-title function_">getUserById</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable("id")</span> Long id)</span>;
    
    <span class="hljs-meta">@PostMapping("/api/users")</span>
    UserDTO <span class="hljs-title function_">createUser</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> CreateUserRequest request)</span>;
    
    <span class="hljs-meta">@GetMapping("/api/users")</span>
    List&lt;UserDTO&gt; <span class="hljs-title function_">getUsers</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam("ids")</span> List&lt;Long&gt; ids)</span>;
}

<span class="hljs-comment">// Feign降级处理</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserServiceFallback</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">UserServiceClient</span> {
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> UserDTO <span class="hljs-title function_">getUserById</span><span class="hljs-params">(Long id)</span> {
        log.warn(<span class="hljs-string">"用户服务降级，返回默认用户: {}"</span>, id);
        <span class="hljs-type">UserDTO</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserDTO</span>();
        user.setId(id);
        user.setName(<span class="hljs-string">"默认用户"</span>);
        <span class="hljs-keyword">return</span> user;
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> UserDTO <span class="hljs-title function_">createUser</span><span class="hljs-params">(CreateUserRequest request)</span> {
        log.warn(<span class="hljs-string">"用户服务降级，创建用户失败"</span>);
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"用户服务不可用"</span>);
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> List&lt;UserDTO&gt; <span class="hljs-title function_">getUsers</span><span class="hljs-params">(List&lt;Long&gt; ids)</span> {
        log.warn(<span class="hljs-string">"用户服务降级，返回空列表"</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
    }
}

<span class="hljs-comment">// Feign配置</span>
<span class="hljs-meta">@Configuration</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FeignConfig</span> {
    
    <span class="hljs-comment">// 请求拦截器</span>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> RequestInterceptor <span class="hljs-title function_">requestInterceptor</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> requestTemplate -&gt; {
            <span class="hljs-comment">// 添加请求头</span>
            requestTemplate.header(<span class="hljs-string">"X-Request-Id"</span>, UUID.randomUUID().toString());
            requestTemplate.header(<span class="hljs-string">"X-Service-Name"</span>, <span class="hljs-string">"order-service"</span>);
        };
    }
    
    <span class="hljs-comment">// 日志配置</span>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> Logger.Level <span class="hljs-title function_">feignLoggerLevel</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> Logger.Level.FULL;
    }
    
    <span class="hljs-comment">// 错误解码器</span>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> ErrorDecoder <span class="hljs-title function_">errorDecoder</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ErrorDecoder</span>() {
            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> Exception <span class="hljs-title function_">decode</span><span class="hljs-params">(String methodKey, Response response)</span> {
                <span class="hljs-keyword">if</span> (response.status() == <span class="hljs-number">404</span>) {
                    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ResourceNotFoundException</span>(<span class="hljs-string">"资源未找到"</span>);
                } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (response.status() &gt;= <span class="hljs-number">500</span>) {
                    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServiceException</span>(<span class="hljs-string">"服务异常"</span>);
                }
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"未知错误"</span>);
            }
        };
    }
    
    <span class="hljs-comment">// 重试配置</span>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> Retryer <span class="hljs-title function_">retryer</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Retryer</span>.Default(<span class="hljs-number">100</span>, <span class="hljs-number">1000</span>, <span class="hljs-number">3</span>);
    }
}

<span class="hljs-comment">// 使用Feign客户端</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderService</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> UserServiceClient userServiceClient;
    
    <span class="hljs-keyword">public</span> OrderDTO <span class="hljs-title function_">createOrder</span><span class="hljs-params">(CreateOrderRequest request)</span> {
        <span class="hljs-comment">// 调用用户服务</span>
        <span class="hljs-type">UserDTO</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> userServiceClient.getUserById(request.getUserId());
        
        <span class="hljs-keyword">if</span> (user == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"用户不存在"</span>);
        }
        
        <span class="hljs-comment">// 创建订单逻辑</span>
        <span class="hljs-type">OrderDTO</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderDTO</span>();
        order.setUserId(user.getId());
        order.setUserName(user.getName());
        <span class="hljs-comment">// ...</span>
        
        <span class="hljs-keyword">return</span> order;
    }
}
</code></pre>
<hr/>
<h2 data-id="heading-6">2. 云原生技术</h2>
<h3 data-id="heading-7">2.1 Docker容器化</h3>
<p><strong>Dockerfile编写：</strong></p>
<pre><code class="hljs language-dockerfile" lang="dockerfile"># 多阶段构建
# 第一阶段：构建应用
FROM maven:3.8.4-openjdk-17 AS builder
WORKDIR /app
COPY pom.xml .
RUN mvn dependency:go-offline
COPY src ./src
RUN mvn clean package -DskipTests

# 第二阶段：运行应用
FROM openjdk:17-jre-slim
WORKDIR /app

# 创建非root用户
RUN groupadd -r appuser &amp;&amp; useradd -r -g appuser appuser

# 复制构建产物
COPY --from=builder /app/target/*.jar app.jar

# 设置文件权限
RUN chown -R appuser:appuser /app

# 切换到非root用户
USER appuser

# 暴露端口
EXPOSE 8080

# 健康检查
HEALTHCHECK --interval=30s --timeout=3s --start-period=40s --retries=3 \
  CMD curl -f http://localhost:8080/actuator/health || exit 1

# 启动应用
ENTRYPOINT ["java", "-jar", "app.jar"]
</code></pre>
<p><strong>Docker Compose配置：</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">version:</span> <span class="hljs-string">'3.8'</span>

<span class="hljs-attr">services:</span>
  <span class="hljs-comment"># 订单服务</span>
  <span class="hljs-attr">order-service:</span>
    <span class="hljs-attr">build:</span>
      <span class="hljs-attr">context:</span> <span class="hljs-string">./order-service</span>
      <span class="hljs-attr">dockerfile:</span> <span class="hljs-string">Dockerfile</span>
    <span class="hljs-attr">container_name:</span> <span class="hljs-string">order-service</span>
    <span class="hljs-attr">ports:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"8080:8080"</span>
    <span class="hljs-attr">environment:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">SPRING_PROFILES_ACTIVE=docker</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE=http://eureka:8761/eureka/</span>
    <span class="hljs-attr">depends_on:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">mysql</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">redis</span>
    <span class="hljs-attr">networks:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">microservices-network</span>
    <span class="hljs-attr">restart:</span> <span class="hljs-string">unless-stopped</span>

  <span class="hljs-comment"># 用户服务</span>
  <span class="hljs-attr">user-service:</span>
    <span class="hljs-attr">build:</span>
      <span class="hljs-attr">context:</span> <span class="hljs-string">./user-service</span>
      <span class="hljs-attr">dockerfile:</span> <span class="hljs-string">Dockerfile</span>
    <span class="hljs-attr">container_name:</span> <span class="hljs-string">user-service</span>
    <span class="hljs-attr">ports:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"8081:8080"</span>
    <span class="hljs-attr">environment:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">SPRING_PROFILES_ACTIVE=docker</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE=http://eureka:8761/eureka/</span>
    <span class="hljs-attr">depends_on:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">mysql</span>
    <span class="hljs-attr">networks:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">microservices-network</span>
    <span class="hljs-attr">restart:</span> <span class="hljs-string">unless-stopped</span>

  <span class="hljs-comment"># Eureka服务注册中心</span>
  <span class="hljs-attr">eureka:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">springcloud/eureka</span>
    <span class="hljs-attr">container_name:</span> <span class="hljs-string">eureka-server</span>
    <span class="hljs-attr">ports:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"8761:8761"</span>
    <span class="hljs-attr">networks:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">microservices-network</span>
    <span class="hljs-attr">restart:</span> <span class="hljs-string">unless-stopped</span>

  <span class="hljs-comment"># MySQL数据库</span>
  <span class="hljs-attr">mysql:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">mysql:8.0</span>
    <span class="hljs-attr">container_name:</span> <span class="hljs-string">mysql</span>
    <span class="hljs-attr">environment:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">MYSQL_ROOT_PASSWORD=root123</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">MYSQL_DATABASE=order_db</span>
    <span class="hljs-attr">ports:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"3306:3306"</span>
    <span class="hljs-attr">volumes:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">mysql-data:/var/lib/mysql</span>
    <span class="hljs-attr">networks:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">microservices-network</span>
    <span class="hljs-attr">restart:</span> <span class="hljs-string">unless-stopped</span>

  <span class="hljs-comment"># Redis缓存</span>
  <span class="hljs-attr">redis:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">redis:7-alpine</span>
    <span class="hljs-attr">container_name:</span> <span class="hljs-string">redis</span>
    <span class="hljs-attr">ports:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"6379:6379"</span>
    <span class="hljs-attr">volumes:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">redis-data:/data</span>
    <span class="hljs-attr">networks:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">microservices-network</span>
    <span class="hljs-attr">restart:</span> <span class="hljs-string">unless-stopped</span>

<span class="hljs-attr">volumes:</span>
  <span class="hljs-attr">mysql-data:</span>
  <span class="hljs-attr">redis-data:</span>

<span class="hljs-attr">networks:</span>
  <span class="hljs-attr">microservices-network:</span>
    <span class="hljs-attr">driver:</span> <span class="hljs-string">bridge</span>
</code></pre>
<p><strong>Docker操作服务：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Docker操作服务</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DockerService</span> {
    
    <span class="hljs-comment">// 构建Docker镜像</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">buildImage</span><span class="hljs-params">(String dockerfilePath, String imageName, String tag)</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">ProcessBuilder</span> <span class="hljs-variable">processBuilder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProcessBuilder</span>(
                <span class="hljs-string">"docker"</span>, <span class="hljs-string">"build"</span>,
                <span class="hljs-string">"-f"</span>, dockerfilePath,
                <span class="hljs-string">"-t"</span>, imageName + <span class="hljs-string">":"</span> + tag,
                <span class="hljs-string">"."</span>
            );
            
            <span class="hljs-type">Process</span> <span class="hljs-variable">process</span> <span class="hljs-operator">=</span> processBuilder.start();
            <span class="hljs-type">int</span> <span class="hljs-variable">exitCode</span> <span class="hljs-operator">=</span> process.waitFor();
            
            <span class="hljs-keyword">if</span> (exitCode == <span class="hljs-number">0</span>) {
                log.info(<span class="hljs-string">"Docker镜像构建成功: {}:{}"</span>, imageName, tag);
            } <span class="hljs-keyword">else</span> {
                log.error(<span class="hljs-string">"Docker镜像构建失败，退出码: {}"</span>, exitCode);
            }
        } <span class="hljs-keyword">catch</span> (Exception e) {
            log.error(<span class="hljs-string">"构建Docker镜像异常"</span>, e);
        }
    }
    
    <span class="hljs-comment">// 运行Docker容器</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">runContainer</span><span class="hljs-params">(String imageName, String containerName, 
                           Map&lt;String, String&gt; envVars, <span class="hljs-type">int</span> port)</span> {
        <span class="hljs-keyword">try</span> {
            List&lt;String&gt; command = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
            command.add(<span class="hljs-string">"docker"</span>);
            command.add(<span class="hljs-string">"run"</span>);
            command.add(<span class="hljs-string">"-d"</span>);
            command.add(<span class="hljs-string">"--name"</span>);
            command.add(containerName);
            command.add(<span class="hljs-string">"-p"</span>);
            command.add(port + <span class="hljs-string">":8080"</span>);
            
            <span class="hljs-comment">// 添加环境变量</span>
            <span class="hljs-keyword">for</span> (Map.Entry&lt;String, String&gt; entry : envVars.entrySet()) {
                command.add(<span class="hljs-string">"-e"</span>);
                command.add(entry.getKey() + <span class="hljs-string">"="</span> + entry.getValue());
            }
            
            command.add(imageName);
            
            <span class="hljs-type">ProcessBuilder</span> <span class="hljs-variable">processBuilder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProcessBuilder</span>(command);
            <span class="hljs-type">Process</span> <span class="hljs-variable">process</span> <span class="hljs-operator">=</span> processBuilder.start();
            <span class="hljs-type">int</span> <span class="hljs-variable">exitCode</span> <span class="hljs-operator">=</span> process.waitFor();
            
            <span class="hljs-keyword">if</span> (exitCode == <span class="hljs-number">0</span>) {
                log.info(<span class="hljs-string">"Docker容器启动成功: {}"</span>, containerName);
            } <span class="hljs-keyword">else</span> {
                log.error(<span class="hljs-string">"Docker容器启动失败，退出码: {}"</span>, exitCode);
            }
        } <span class="hljs-keyword">catch</span> (Exception e) {
            log.error(<span class="hljs-string">"启动Docker容器异常"</span>, e);
        }
    }
}
</code></pre>
<h3 data-id="heading-8">2.2 Kubernetes部署</h3>
<p><strong>Kubernetes部署配置：</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># Deployment配置</span>
<span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">order-service</span>
  <span class="hljs-attr">labels:</span>
    <span class="hljs-attr">app:</span> <span class="hljs-string">order-service</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">replicas:</span> <span class="hljs-number">3</span>
  <span class="hljs-attr">selector:</span>
    <span class="hljs-attr">matchLabels:</span>
      <span class="hljs-attr">app:</span> <span class="hljs-string">order-service</span>
  <span class="hljs-attr">template:</span>
    <span class="hljs-attr">metadata:</span>
      <span class="hljs-attr">labels:</span>
        <span class="hljs-attr">app:</span> <span class="hljs-string">order-service</span>
    <span class="hljs-attr">spec:</span>
      <span class="hljs-attr">containers:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">order-service</span>
        <span class="hljs-attr">image:</span> <span class="hljs-string">order-service:latest</span>
        <span class="hljs-attr">ports:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">containerPort:</span> <span class="hljs-number">8080</span>
        <span class="hljs-attr">env:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">SPRING_PROFILES_ACTIVE</span>
          <span class="hljs-attr">value:</span> <span class="hljs-string">"k8s"</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE</span>
          <span class="hljs-attr">value:</span> <span class="hljs-string">"http://eureka-service:8761/eureka/"</span>
        <span class="hljs-attr">resources:</span>
          <span class="hljs-attr">requests:</span>
            <span class="hljs-attr">memory:</span> <span class="hljs-string">"512Mi"</span>
            <span class="hljs-attr">cpu:</span> <span class="hljs-string">"500m"</span>
          <span class="hljs-attr">limits:</span>
            <span class="hljs-attr">memory:</span> <span class="hljs-string">"1Gi"</span>
            <span class="hljs-attr">cpu:</span> <span class="hljs-string">"1000m"</span>
        <span class="hljs-attr">livenessProbe:</span>
          <span class="hljs-attr">httpGet:</span>
            <span class="hljs-attr">path:</span> <span class="hljs-string">/actuator/health/liveness</span>
            <span class="hljs-attr">port:</span> <span class="hljs-number">8080</span>
          <span class="hljs-attr">initialDelaySeconds:</span> <span class="hljs-number">60</span>
          <span class="hljs-attr">periodSeconds:</span> <span class="hljs-number">10</span>
        <span class="hljs-attr">readinessProbe:</span>
          <span class="hljs-attr">httpGet:</span>
            <span class="hljs-attr">path:</span> <span class="hljs-string">/actuator/health/readiness</span>
            <span class="hljs-attr">port:</span> <span class="hljs-number">8080</span>
          <span class="hljs-attr">initialDelaySeconds:</span> <span class="hljs-number">30</span>
          <span class="hljs-attr">periodSeconds:</span> <span class="hljs-number">5</span>

<span class="hljs-meta">---</span>
<span class="hljs-comment"># Service配置</span>
<span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">order-service</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">selector:</span>
    <span class="hljs-attr">app:</span> <span class="hljs-string">order-service</span>
  <span class="hljs-attr">ports:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span>
    <span class="hljs-attr">port:</span> <span class="hljs-number">80</span>
    <span class="hljs-attr">targetPort:</span> <span class="hljs-number">8080</span>
  <span class="hljs-attr">type:</span> <span class="hljs-string">ClusterIP</span>

<span class="hljs-meta">---</span>
<span class="hljs-comment"># Ingress配置</span>
<span class="hljs-attr">apiVersion:</span> <span class="hljs-string">networking.k8s.io/v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Ingress</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">order-service-ingress</span>
  <span class="hljs-attr">annotations:</span>
    <span class="hljs-attr">nginx.ingress.kubernetes.io/rewrite-target:</span> <span class="hljs-string">/</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">rules:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">host:</span> <span class="hljs-string">api.example.com</span>
    <span class="hljs-attr">http:</span>
      <span class="hljs-attr">paths:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">path:</span> <span class="hljs-string">/api/orders</span>
        <span class="hljs-attr">pathType:</span> <span class="hljs-string">Prefix</span>
        <span class="hljs-attr">backend:</span>
          <span class="hljs-attr">service:</span>
            <span class="hljs-attr">name:</span> <span class="hljs-string">order-service</span>
            <span class="hljs-attr">port:</span>
              <span class="hljs-attr">number:</span> <span class="hljs-number">80</span>

<span class="hljs-meta">---</span>
<span class="hljs-comment"># ConfigMap配置</span>
<span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">ConfigMap</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">order-service-config</span>
<span class="hljs-attr">data:</span>
  <span class="hljs-attr">application.yml:</span> <span class="hljs-string">|
    spring:
      datasource:
        url: jdbc:mysql://mysql-service:3306/order_db
      redis:
        host: redis-service
        port: 6379
</span>
<span class="hljs-meta">---</span>
<span class="hljs-comment"># Secret配置</span>
<span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Secret</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">order-service-secret</span>
<span class="hljs-attr">type:</span> <span class="hljs-string">Opaque</span>
<span class="hljs-attr">data:</span>
  <span class="hljs-attr">db-password:</span> <span class="hljs-string">cm9vdDEyMw==</span>  <span class="hljs-comment"># base64编码的密码</span>
</code></pre>
<p><strong>Kubernetes操作服务：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Kubernetes操作服务</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">KubernetesService</span> {
    
    <span class="hljs-comment">// 创建Deployment</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createDeployment</span><span class="hljs-params">(String name, String image, <span class="hljs-type">int</span> replicas)</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">ProcessBuilder</span> <span class="hljs-variable">processBuilder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProcessBuilder</span>(
                <span class="hljs-string">"kubectl"</span>, <span class="hljs-string">"create"</span>, <span class="hljs-string">"deployment"</span>,
                name,
                <span class="hljs-string">"--image="</span> + image,
                <span class="hljs-string">"--replicas="</span> + replicas
            );
            
            <span class="hljs-type">Process</span> <span class="hljs-variable">process</span> <span class="hljs-operator">=</span> processBuilder.start();
            <span class="hljs-type">int</span> <span class="hljs-variable">exitCode</span> <span class="hljs-operator">=</span> process.waitFor();
            
            <span class="hljs-keyword">if</span> (exitCode == <span class="hljs-number">0</span>) {
                log.info(<span class="hljs-string">"Kubernetes Deployment创建成功: {}"</span>, name);
            } <span class="hljs-keyword">else</span> {
                log.error(<span class="hljs-string">"Kubernetes Deployment创建失败，退出码: {}"</span>, exitCode);
            }
        } <span class="hljs-keyword">catch</span> (Exception e) {
            log.error(<span class="hljs-string">"创建Kubernetes Deployment异常"</span>, e);
        }
    }
    
    <span class="hljs-comment">// 扩缩容</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">scaleDeployment</span><span class="hljs-params">(String name, <span class="hljs-type">int</span> replicas)</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">ProcessBuilder</span> <span class="hljs-variable">processBuilder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProcessBuilder</span>(
                <span class="hljs-string">"kubectl"</span>, <span class="hljs-string">"scale"</span>, <span class="hljs-string">"deployment"</span>,
                name,
                <span class="hljs-string">"--replicas="</span> + replicas
            );
            
            <span class="hljs-type">Process</span> <span class="hljs-variable">process</span> <span class="hljs-operator">=</span> processBuilder.start();
            <span class="hljs-type">int</span> <span class="hljs-variable">exitCode</span> <span class="hljs-operator">=</span> process.waitFor();
            
            <span class="hljs-keyword">if</span> (exitCode == <span class="hljs-number">0</span>) {
                log.info(<span class="hljs-string">"Kubernetes Deployment扩缩容成功: {} -&gt; {}"</span>, name, replicas);
            } <span class="hljs-keyword">else</span> {
                log.error(<span class="hljs-string">"Kubernetes Deployment扩缩容失败，退出码: {}"</span>, exitCode);
            }
        } <span class="hljs-keyword">catch</span> (Exception e) {
            log.error(<span class="hljs-string">"Kubernetes Deployment扩缩容异常"</span>, e);
        }
    }
    
    <span class="hljs-comment">// 滚动更新</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">rollingUpdate</span><span class="hljs-params">(String name, String newImage)</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">ProcessBuilder</span> <span class="hljs-variable">processBuilder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProcessBuilder</span>(
                <span class="hljs-string">"kubectl"</span>, <span class="hljs-string">"set"</span>, <span class="hljs-string">"image"</span>,
                <span class="hljs-string">"deployment/"</span> + name,
                name + <span class="hljs-string">"="</span> + newImage
            );
            
            <span class="hljs-type">Process</span> <span class="hljs-variable">process</span> <span class="hljs-operator">=</span> processBuilder.start();
            <span class="hljs-type">int</span> <span class="hljs-variable">exitCode</span> <span class="hljs-operator">=</span> process.waitFor();
            
            <span class="hljs-keyword">if</span> (exitCode == <span class="hljs-number">0</span>) {
                log.info(<span class="hljs-string">"Kubernetes滚动更新成功: {} -&gt; {}"</span>, name, newImage);
            } <span class="hljs-keyword">else</span> {
                log.error(<span class="hljs-string">"Kubernetes滚动更新失败，退出码: {}"</span>, exitCode);
            }
        } <span class="hljs-keyword">catch</span> (Exception e) {
            log.error(<span class="hljs-string">"Kubernetes滚动更新异常"</span>, e);
        }
    }
}
</code></pre>
<h3 data-id="heading-9">2.3 Service Mesh</h3>
<p><strong>Istio Service Mesh配置：</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># VirtualService配置</span>
<span class="hljs-attr">apiVersion:</span> <span class="hljs-string">networking.istio.io/v1alpha3</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">VirtualService</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">order-service</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">hosts:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">order-service</span>
  <span class="hljs-attr">http:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">match:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">headers:</span>
        <span class="hljs-attr">version:</span>
          <span class="hljs-attr">exact:</span> <span class="hljs-string">v2</span>
    <span class="hljs-attr">route:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">destination:</span>
        <span class="hljs-attr">host:</span> <span class="hljs-string">order-service</span>
        <span class="hljs-attr">subset:</span> <span class="hljs-string">v2</span>
      <span class="hljs-attr">weight:</span> <span class="hljs-number">100</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">route:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">destination:</span>
        <span class="hljs-attr">host:</span> <span class="hljs-string">order-service</span>
        <span class="hljs-attr">subset:</span> <span class="hljs-string">v1</span>
      <span class="hljs-attr">weight:</span> <span class="hljs-number">90</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">destination:</span>
        <span class="hljs-attr">host:</span> <span class="hljs-string">order-service</span>
        <span class="hljs-attr">subset:</span> <span class="hljs-string">v2</span>
      <span class="hljs-attr">weight:</span> <span class="hljs-number">10</span>

<span class="hljs-meta">---</span>
<span class="hljs-comment"># DestinationRule配置</span>
<span class="hljs-attr">apiVersion:</span> <span class="hljs-string">networking.istio.io/v1alpha3</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">DestinationRule</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">order-service</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">host:</span> <span class="hljs-string">order-service</span>
  <span class="hljs-attr">subsets:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">v1</span>
    <span class="hljs-attr">labels:</span>
      <span class="hljs-attr">version:</span> <span class="hljs-string">v1</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">v2</span>
    <span class="hljs-attr">labels:</span>
      <span class="hljs-attr">version:</span> <span class="hljs-string">v2</span>
  <span class="hljs-attr">trafficPolicy:</span>
    <span class="hljs-attr">loadBalancer:</span>
      <span class="hljs-attr">simple:</span> <span class="hljs-string">ROUND_ROBIN</span>
    <span class="hljs-attr">connectionPool:</span>
      <span class="hljs-attr">tcp:</span>
        <span class="hljs-attr">maxConnections:</span> <span class="hljs-number">100</span>
      <span class="hljs-attr">http:</span>
        <span class="hljs-attr">http1MaxPendingRequests:</span> <span class="hljs-number">10</span>
        <span class="hljs-attr">http2MaxRequests:</span> <span class="hljs-number">100</span>
        <span class="hljs-attr">maxRequestsPerConnection:</span> <span class="hljs-number">2</span>
    <span class="hljs-attr">circuitBreaker:</span>
      <span class="hljs-attr">consecutiveErrors:</span> <span class="hljs-number">5</span>
      <span class="hljs-attr">interval:</span> <span class="hljs-string">30s</span>
      <span class="hljs-attr">baseEjectionTime:</span> <span class="hljs-string">30s</span>
      <span class="hljs-attr">maxEjectionPercent:</span> <span class="hljs-number">50</span>
      <span class="hljs-attr">minHealthPercent:</span> <span class="hljs-number">50</span>

<span class="hljs-meta">---</span>
<span class="hljs-comment"># Gateway配置</span>
<span class="hljs-attr">apiVersion:</span> <span class="hljs-string">networking.istio.io/v1alpha3</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Gateway</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">order-gateway</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">selector:</span>
    <span class="hljs-attr">istio:</span> <span class="hljs-string">ingressgateway</span>
  <span class="hljs-attr">servers:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">port:</span>
      <span class="hljs-attr">number:</span> <span class="hljs-number">80</span>
      <span class="hljs-attr">name:</span> <span class="hljs-string">http</span>
      <span class="hljs-attr">protocol:</span> <span class="hljs-string">HTTP</span>
    <span class="hljs-attr">hosts:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">api.example.com</span>
</code></pre>
<hr/>
<h2 data-id="heading-10">3. 系统设计实战</h2>
<h3 data-id="heading-11">3.1 高并发系统设计</h3>
<p><strong>高并发系统架构：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 限流服务</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RateLimitService</span> {
    
    <span class="hljs-comment">// 令牌桶限流</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">RateLimiter</span> <span class="hljs-variable">rateLimiter</span> <span class="hljs-operator">=</span> RateLimiter.create(<span class="hljs-number">100.0</span>); <span class="hljs-comment">// 每秒100个请求</span>
    
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryAcquire</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> rateLimiter.tryAcquire();
    }
    
    <span class="hljs-comment">// 滑动窗口限流</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;String, List&lt;Long&gt;&gt; requestWindows = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">WINDOW_SIZE</span> <span class="hljs-operator">=</span> <span class="hljs-number">60</span>; <span class="hljs-comment">// 60秒窗口</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">MAX_REQUESTS</span> <span class="hljs-operator">=</span> <span class="hljs-number">100</span>; <span class="hljs-comment">// 最大100个请求</span>
    
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isAllowed</span><span class="hljs-params">(String key)</span> {
        <span class="hljs-type">long</span> <span class="hljs-variable">currentTime</span> <span class="hljs-operator">=</span> System.currentTimeMillis() / <span class="hljs-number">1000</span>;
        List&lt;Long&gt; window = requestWindows.computeIfAbsent(key, k -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;());
        
        <span class="hljs-comment">// 移除过期请求</span>
        window.removeIf(time -&gt; time &lt; currentTime - WINDOW_SIZE);
        
        <span class="hljs-keyword">if</span> (window.size() &gt;= MAX_REQUESTS) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
        
        window.add(currentTime);
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
}

<span class="hljs-comment">// 缓存服务</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CacheService</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RedisTemplate&lt;String, Object&gt; redisTemplate;
    
    <span class="hljs-comment">// 多级缓存</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Cache&lt;String, Object&gt; localCache = Caffeine.newBuilder()
        .maximumSize(<span class="hljs-number">10000</span>)
        .expireAfterWrite(<span class="hljs-number">5</span>, TimeUnit.MINUTES)
        .build();
    
    <span class="hljs-keyword">public</span> &lt;T&gt; T <span class="hljs-title function_">get</span><span class="hljs-params">(String key, Class&lt;T&gt; type, Supplier&lt;T&gt; dataLoader)</span> {
        <span class="hljs-comment">// 一级缓存：本地缓存</span>
        <span class="hljs-type">T</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> (T) localCache.getIfPresent(key);
        <span class="hljs-keyword">if</span> (value != <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">return</span> value;
        }
        
        <span class="hljs-comment">// 二级缓存：Redis</span>
        value = (T) redisTemplate.opsForValue().get(key);
        <span class="hljs-keyword">if</span> (value != <span class="hljs-literal">null</span>) {
            localCache.put(key, value);
            <span class="hljs-keyword">return</span> value;
        }
        
        <span class="hljs-comment">// 三级缓存：数据库</span>
        value = dataLoader.get();
        <span class="hljs-keyword">if</span> (value != <span class="hljs-literal">null</span>) {
            redisTemplate.opsForValue().set(key, value, <span class="hljs-number">1</span>, TimeUnit.HOURS);
            localCache.put(key, value);
        }
        
        <span class="hljs-keyword">return</span> value;
    }
}

<span class="hljs-comment">// 异步处理服务</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AsyncProcessService</span> {
    
    <span class="hljs-meta">@Async("taskExecutor")</span>
    <span class="hljs-keyword">public</span> CompletableFuture&lt;Void&gt; <span class="hljs-title function_">processAsync</span><span class="hljs-params">(String data)</span> {
        <span class="hljs-comment">// 异步处理逻辑</span>
        log.info(<span class="hljs-string">"异步处理: {}"</span>, data);
        <span class="hljs-keyword">return</span> CompletableFuture.completedFuture(<span class="hljs-literal">null</span>);
    }
    
    <span class="hljs-comment">// 线程池配置</span>
    <span class="hljs-meta">@Bean(name = "taskExecutor")</span>
    <span class="hljs-keyword">public</span> ThreadPoolTaskExecutor <span class="hljs-title function_">taskExecutor</span><span class="hljs-params">()</span> {
        <span class="hljs-type">ThreadPoolTaskExecutor</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolTaskExecutor</span>();
        executor.setCorePoolSize(<span class="hljs-number">10</span>);
        executor.setMaxPoolSize(<span class="hljs-number">50</span>);
        executor.setQueueCapacity(<span class="hljs-number">200</span>);
        executor.setThreadNamePrefix(<span class="hljs-string">"async-task-"</span>);
        executor.setRejectedExecutionHandler(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>.CallerRunsPolicy());
        executor.initialize();
        <span class="hljs-keyword">return</span> executor;
    }
}
</code></pre>
<h3 data-id="heading-12">3.2 分布式系统设计</h3>
<p><strong>分布式系统架构：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 分布式任务调度</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DistributedTaskScheduler</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RedisTemplate&lt;String, String&gt; redisTemplate;
    
    <span class="hljs-comment">// 分布式锁实现任务调度</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">scheduleTask</span><span class="hljs-params">(String taskId, Runnable task)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">lockKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">"task:lock:"</span> + taskId;
        <span class="hljs-type">String</span> <span class="hljs-variable">lockValue</span> <span class="hljs-operator">=</span> UUID.randomUUID().toString();
        
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">if</span> (tryLock(lockKey, lockValue, <span class="hljs-number">30</span>)) {
                <span class="hljs-comment">// 检查任务是否已执行</span>
                <span class="hljs-type">String</span> <span class="hljs-variable">executedKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">"task:executed:"</span> + taskId;
                <span class="hljs-keyword">if</span> (redisTemplate.hasKey(executedKey)) {
                    log.info(<span class="hljs-string">"任务已执行: {}"</span>, taskId);
                    <span class="hljs-keyword">return</span>;
                }
                
                <span class="hljs-comment">// 执行任务</span>
                task.run();
                
                <span class="hljs-comment">// 标记任务已执行</span>
                redisTemplate.opsForValue().set(executedKey, <span class="hljs-string">"1"</span>, <span class="hljs-number">1</span>, TimeUnit.HOURS);
            }
        } <span class="hljs-keyword">finally</span> {
            releaseLock(lockKey, lockValue);
        }
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryLock</span><span class="hljs-params">(String lockKey, String lockValue, <span class="hljs-type">long</span> expireTime)</span> {
        <span class="hljs-type">Boolean</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> redisTemplate.opsForValue()
            .setIfAbsent(lockKey, lockValue, expireTime, TimeUnit.SECONDS);
        <span class="hljs-keyword">return</span> Boolean.TRUE.equals(result);
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">releaseLock</span><span class="hljs-params">(String lockKey, String lockValue)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">luaScript</span> <span class="hljs-operator">=</span> 
            <span class="hljs-string">"if redis.call('get', KEYS[1]) == ARGV[1] then "</span> +
            <span class="hljs-string">"  return redis.call('del', KEYS[1]) "</span> +
            <span class="hljs-string">"else return 0 end"</span>;
        
        DefaultRedisScript&lt;Long&gt; script = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultRedisScript</span>&lt;&gt;();
        script.setScriptText(luaScript);
        script.setResultType(Long.class);
        
        redisTemplate.execute(script, Collections.singletonList(lockKey), lockValue);
    }
}
</code></pre>
<hr/>
<h2 data-id="heading-13">4. 面试准备</h2>
<h3 data-id="heading-14">4.1 常见面试题</h3>
<p><strong>Java基础面试题：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 1. 单例模式实现</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Singleton</span> {
    <span class="hljs-comment">// 双重检查锁定</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> <span class="hljs-keyword">static</span> Singleton instance;
    
    <span class="hljs-keyword">private</span> <span class="hljs-title function_">Singleton</span><span class="hljs-params">()</span> {}
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Singleton <span class="hljs-title function_">getInstance</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">if</span> (instance == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">synchronized</span> (Singleton.class) {
                <span class="hljs-keyword">if</span> (instance == <span class="hljs-literal">null</span>) {
                    instance = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Singleton</span>();
                }
            }
        }
        <span class="hljs-keyword">return</span> instance;
    }
    
    <span class="hljs-comment">// 静态内部类实现</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SingletonHolder</span> {
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Singleton</span> <span class="hljs-variable">INSTANCE</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Singleton</span>();
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Singleton <span class="hljs-title function_">getInstance2</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> SingletonHolder.INSTANCE;
    }
}

<span class="hljs-comment">// 2. 线程安全的单例</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">SingletonEnum</span> {
    INSTANCE;
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doSomething</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 业务逻辑</span>
    }
}

<span class="hljs-comment">// 3. 生产者消费者模式</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProducerConsumer</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> BlockingQueue&lt;Integer&gt; queue = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedBlockingQueue</span>&lt;&gt;(<span class="hljs-number">10</span>);
    
    <span class="hljs-keyword">class</span> <span class="hljs-title class_">Producer</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Runnable</span> {
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100</span>; i++) {
                    queue.put(i);
                    System.out.println(<span class="hljs-string">"生产: "</span> + i);
                }
            } <span class="hljs-keyword">catch</span> (InterruptedException e) {
                Thread.currentThread().interrupt();
            }
        }
    }
    
    <span class="hljs-keyword">class</span> <span class="hljs-title class_">Consumer</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Runnable</span> {
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
                    <span class="hljs-type">Integer</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> queue.take();
                    System.out.println(<span class="hljs-string">"消费: "</span> + value);
                }
            } <span class="hljs-keyword">catch</span> (InterruptedException e) {
                Thread.currentThread().interrupt();
            }
        }
    }
}
</code></pre>
<h3 data-id="heading-15">4.2 算法题</h3>
<p><strong>常见算法实现：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 快速排序</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">QuickSort</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sort</span><span class="hljs-params">(<span class="hljs-type">int</span>[] arr, <span class="hljs-type">int</span> low, <span class="hljs-type">int</span> high)</span> {
        <span class="hljs-keyword">if</span> (low &lt; high) {
            <span class="hljs-type">int</span> <span class="hljs-variable">pivot</span> <span class="hljs-operator">=</span> partition(arr, low, high);
            sort(arr, low, pivot - <span class="hljs-number">1</span>);
            sort(arr, pivot + <span class="hljs-number">1</span>, high);
        }
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-title function_">partition</span><span class="hljs-params">(<span class="hljs-type">int</span>[] arr, <span class="hljs-type">int</span> low, <span class="hljs-type">int</span> high)</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">pivot</span> <span class="hljs-operator">=</span> arr[high];
        <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> low - <span class="hljs-number">1</span>;
        
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">j</span> <span class="hljs-operator">=</span> low; j &lt; high; j++) {
            <span class="hljs-keyword">if</span> (arr[j] &lt; pivot) {
                i++;
                swap(arr, i, j);
            }
        }
        
        swap(arr, i + <span class="hljs-number">1</span>, high);
        <span class="hljs-keyword">return</span> i + <span class="hljs-number">1</span>;
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">swap</span><span class="hljs-params">(<span class="hljs-type">int</span>[] arr, <span class="hljs-type">int</span> i, <span class="hljs-type">int</span> j)</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">temp</span> <span class="hljs-operator">=</span> arr[i];
        arr[i] = arr[j];
        arr[j] = temp;
    }
}

<span class="hljs-comment">// 二分查找</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BinarySearch</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">search</span><span class="hljs-params">(<span class="hljs-type">int</span>[] arr, <span class="hljs-type">int</span> target)</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">left</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>, right = arr.length - <span class="hljs-number">1</span>;
        
        <span class="hljs-keyword">while</span> (left &lt;= right) {
            <span class="hljs-type">int</span> <span class="hljs-variable">mid</span> <span class="hljs-operator">=</span> left + (right - left) / <span class="hljs-number">2</span>;
            
            <span class="hljs-keyword">if</span> (arr[mid] == target) {
                <span class="hljs-keyword">return</span> mid;
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (arr[mid] &lt; target) {
                left = mid + <span class="hljs-number">1</span>;
            } <span class="hljs-keyword">else</span> {
                right = mid - <span class="hljs-number">1</span>;
            }
        }
        
        <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;
    }
}

<span class="hljs-comment">// LRU缓存实现</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LRUCache</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> capacity;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;Integer, Node&gt; cache;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Node head;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Node tail;
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">LRUCache</span><span class="hljs-params">(<span class="hljs-type">int</span> capacity)</span> {
        <span class="hljs-built_in">this</span>.capacity = capacity;
        <span class="hljs-built_in">this</span>.cache = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
        <span class="hljs-built_in">this</span>.head = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Node</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
        <span class="hljs-built_in">this</span>.tail = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Node</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
        head.next = tail;
        tail.prev = head;
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">get</span><span class="hljs-params">(<span class="hljs-type">int</span> key)</span> {
        <span class="hljs-type">Node</span> <span class="hljs-variable">node</span> <span class="hljs-operator">=</span> cache.get(key);
        <span class="hljs-keyword">if</span> (node == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;
        }
        moveToHead(node);
        <span class="hljs-keyword">return</span> node.value;
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">put</span><span class="hljs-params">(<span class="hljs-type">int</span> key, <span class="hljs-type">int</span> value)</span> {
        <span class="hljs-type">Node</span> <span class="hljs-variable">node</span> <span class="hljs-operator">=</span> cache.get(key);
        <span class="hljs-keyword">if</span> (node == <span class="hljs-literal">null</span>) {
            <span class="hljs-type">Node</span> <span class="hljs-variable">newNode</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Node</span>(key, value);
            cache.put(key, newNode);
            addToHead(newNode);
            
            <span class="hljs-keyword">if</span> (cache.size() &gt; capacity) {
                <span class="hljs-type">Node</span> <span class="hljs-variable">tail</span> <span class="hljs-operator">=</span> removeTail();
                cache.remove(tail.key);
            }
        } <span class="hljs-keyword">else</span> {
            node.value = value;
            moveToHead(node);
        }
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addToHead</span><span class="hljs-params">(Node node)</span> {
        node.prev = head;
        node.next = head.next;
        head.next.prev = node;
        head.next = node;
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">removeNode</span><span class="hljs-params">(Node node)</span> {
        node.prev.next = node.next;
        node.next.prev = node.prev;
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">moveToHead</span><span class="hljs-params">(Node node)</span> {
        removeNode(node);
        addToHead(node);
    }
    
    <span class="hljs-keyword">private</span> Node <span class="hljs-title function_">removeTail</span><span class="hljs-params">()</span> {
        <span class="hljs-type">Node</span> <span class="hljs-variable">lastNode</span> <span class="hljs-operator">=</span> tail.prev;
        removeNode(lastNode);
        <span class="hljs-keyword">return</span> lastNode;
    }
    
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Node</span> {
        <span class="hljs-type">int</span> key;
        <span class="hljs-type">int</span> value;
        Node prev;
        Node next;
        
        Node(<span class="hljs-type">int</span> key, <span class="hljs-type">int</span> value) {
            <span class="hljs-built_in">this</span>.key = key;
            <span class="hljs-built_in">this</span>.value = value;
        }
    }
}
</code></pre>
<hr/>
<h2 data-id="heading-16">5. 新技术趋势</h2>
<h3 data-id="heading-17">5.1 响应式编程</h3>
<p><strong>Reactor响应式编程：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 响应式服务</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ReactiveService</span> {
    
    <span class="hljs-comment">// 创建Flux</span>
    <span class="hljs-keyword">public</span> Flux&lt;String&gt; <span class="hljs-title function_">getDataStream</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> Flux.range(<span class="hljs-number">1</span>, <span class="hljs-number">10</span>)
            .map(i -&gt; <span class="hljs-string">"数据"</span> + i)
            .delayElements(Duration.ofMillis(<span class="hljs-number">100</span>))
            .doOnNext(data -&gt; log.info(<span class="hljs-string">"处理数据: {}"</span>, data));
    }
    
    <span class="hljs-comment">// 创建Mono</span>
    <span class="hljs-keyword">public</span> Mono&lt;String&gt; <span class="hljs-title function_">getSingleData</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> Mono.just(<span class="hljs-string">"单个数据"</span>)
            .delayElement(Duration.ofMillis(<span class="hljs-number">100</span>))
            .doOnNext(data -&gt; log.info(<span class="hljs-string">"处理数据: {}"</span>, data));
    }
    
    <span class="hljs-comment">// 组合多个流</span>
    <span class="hljs-keyword">public</span> Flux&lt;String&gt; <span class="hljs-title function_">combineStreams</span><span class="hljs-params">()</span> {
        Flux&lt;String&gt; stream1 = Flux.just(<span class="hljs-string">"A"</span>, <span class="hljs-string">"B"</span>, <span class="hljs-string">"C"</span>);
        Flux&lt;String&gt; stream2 = Flux.just(<span class="hljs-string">"1"</span>, <span class="hljs-string">"2"</span>, <span class="hljs-string">"3"</span>);
        
        <span class="hljs-keyword">return</span> Flux.zip(stream1, stream2, (s1, s2) -&gt; s1 + s2);
    }
    
    <span class="hljs-comment">// 错误处理</span>
    <span class="hljs-keyword">public</span> Flux&lt;String&gt; <span class="hljs-title function_">handleError</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> Flux.range(<span class="hljs-number">1</span>, <span class="hljs-number">10</span>)
            .map(i -&gt; {
                <span class="hljs-keyword">if</span> (i == <span class="hljs-number">5</span>) {
                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"错误"</span>);
                }
                <span class="hljs-keyword">return</span> <span class="hljs-string">"数据"</span> + i;
            })
            .onErrorResume(error -&gt; {
                log.error(<span class="hljs-string">"处理错误"</span>, error);
                <span class="hljs-keyword">return</span> Flux.just(<span class="hljs-string">"错误恢复数据"</span>);
            });
    }
}

<span class="hljs-comment">// WebFlux控制器</span>
<span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ReactiveController</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> ReactiveService reactiveService;
    
    <span class="hljs-meta">@GetMapping("/api/data/stream")</span>
    <span class="hljs-keyword">public</span> Flux&lt;String&gt; <span class="hljs-title function_">getDataStream</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> reactiveService.getDataStream();
    }
    
    <span class="hljs-meta">@GetMapping("/api/data/single")</span>
    <span class="hljs-keyword">public</span> Mono&lt;String&gt; <span class="hljs-title function_">getSingleData</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> reactiveService.getSingleData();
    }
}
</code></pre>
<h3 data-id="heading-18">5.2 虚拟线程（Java 19+）</h3>
<p><strong>虚拟线程使用：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 虚拟线程服务</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">VirtualThreadService</span> {
    
    <span class="hljs-comment">// 使用虚拟线程</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processWithVirtualThread</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">try</span> (<span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> Executors.newVirtualThreadPerTaskExecutor()) {
            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10000</span>; i++) {
                <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">taskId</span> <span class="hljs-operator">=</span> i;
                executor.submit(() -&gt; {
                    log.info(<span class="hljs-string">"虚拟线程执行任务: {}"</span>, taskId);
                    <span class="hljs-comment">// 执行任务</span>
                });
            }
        }
    }
    
    <span class="hljs-comment">// 虚拟线程与CompletableFuture结合</span>
    <span class="hljs-keyword">public</span> CompletableFuture&lt;String&gt; <span class="hljs-title function_">processAsync</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> CompletableFuture.supplyAsync(() -&gt; {
            <span class="hljs-comment">// 业务逻辑</span>
            <span class="hljs-keyword">return</span> <span class="hljs-string">"处理结果"</span>;
        }, Executors.newVirtualThreadPerTaskExecutor());
    }
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[工厂模式]]></title>    <link>https://juejin.cn/post/7590213554798985251</link>    <guid>https://juejin.cn/post/7590213554798985251</guid>    <pubDate>2026-01-03T14:00:14.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590213554798985251" data-draft-id="7590213554798952483" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="工厂模式"/> <meta itemprop="keywords" content="设计模式"/> <meta itemprop="datePublished" content="2026-01-03T14:00:14.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="XRay"/> <meta itemprop="url" content="https://juejin.cn/user/3966693685869288"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            工厂模式
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3966693685869288/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    XRay
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-03T14:00:14.000Z" title="Sat Jan 03 2026 14:00:14 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h4 data-id="heading-0">简单工厂模式</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Product</span>{
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProductA</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Product</span>{
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProductB</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Product</span>{
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Factory</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Product <span class="hljs-title function_">produce</span><span class="hljs-params">(<span class="hljs-type">int</span> type)</span>{
        <span class="hljs-keyword">if</span>(type == <span class="hljs-number">1</span>){
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProductA</span>();
        }<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(type == <span class="hljs-number">2</span>){
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProductB</span>();
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    }
}
</code></pre>
<p>这种设计模式有什么优点？</p>
<p>它将调用 produce() 方法的调用方与生产 Product 的具体细节分离开了。</p>
<p>比如小王想生产产品 A，他直接调用 produce() 方法，传入 type，就可以拿到 ProductA，不需要关心 ProductA 是如何生产出来的，也不需要关心 ProductA 里面的具体细节。</p>
<p>这种设计模式又有什么缺点呢？</p>
<p>如果你想添加另外一种产品 ProductC ，就不得不修改 produce() 方法，这样就违背了 <code>开闭原则</code> 。</p>
<p>什么是开闭原则？</p>
<blockquote>
<p>开闭原则简单来说就是：<strong>对修改关闭，对拓展开放</strong>。即当我们想要拓展功能的时候最好不要修改已有的代码，以免产生 Bug，应该提前做好类的抽象，在抽象的基础上进行拓展。</p>
</blockquote>
<h4 data-id="heading-1">工厂方法模式</h4>
<p>使用工厂方法模式就可以解决上面这个问题，我们来看代码：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AbsFactory</span> {
    <span class="hljs-keyword">abstract</span> Product <span class="hljs-title function_">produce</span><span class="hljs-params">()</span>;
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FactoryA</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbsFactory</span>{
    <span class="hljs-meta">@Override</span>
    Product <span class="hljs-title function_">produce</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProductA</span>();
    }
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FactoryB</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbsFactory</span> {
    <span class="hljs-meta">@Override</span>
    Product <span class="hljs-title function_">produce</span><span class="hljs-params">()</span> {
       <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProductB</span>();
    }
}
</code></pre>
<p>调用方直接调用对应工厂类的 produce() 方法即可：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">AbsFactory</span> <span class="hljs-variable">factoryA</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FactoryA</span>();
        factoryA.produce();
    }
}
</code></pre>
<p>如果后续你想添加产品 ProductC，直接添加 ProductC 及 FactoryC 即可，不需要对已有的代码进行修改，符合开闭原则；同时符合单一职责原则，每个具体工厂类只负责创建对应的产品，不需要像简单工厂那样存在复杂的 if 逻辑判断。</p>
<p>Android 中<code>RecyclerView.Adapter</code>就运用了工厂方法模式：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Adapter</span>&lt;VH <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ViewHolder</span>&gt; {
    <span class="hljs-comment">//延迟实现构建细节到子类中</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> VH <span class="hljs-title function_">onCreateViewHolder</span><span class="hljs-params">(ViewGroup parent, <span class="hljs-type">int</span> viewType)</span>;
}
</code></pre>
<p>Adapter 不知道具体 ViewHolder 类型，由子类决定如何根据 viewType 创建对应的 ViewHolder，这正是工厂方法的精髓：<strong>把实例化推迟到子类</strong>。</p>
<h4 data-id="heading-2">抽象工厂模式</h4>
<p>如果产品A包含2个零件：PartOne 和 PartTwo，就可以使用抽象工厂模式来实现：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">//零件1</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PartOne</span> {
}

<span class="hljs-comment">//零件2</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PartTwo</span> {
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Factory</span> {
    PartOne <span class="hljs-title function_">produceOne</span><span class="hljs-params">()</span>;
    PartTwo <span class="hljs-title function_">produceTwo</span><span class="hljs-params">()</span>; 
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FactoryA</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Factory</span>{

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> PartOne <span class="hljs-title function_">produceOne</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PartOne</span>();
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> PartTwo <span class="hljs-title function_">produceTwo</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PartTwo</span>();
    }
}

<span class="hljs-comment">//产品A</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProductA</span> {
    <span class="hljs-keyword">private</span> PartOne partOne;
    <span class="hljs-keyword">private</span> PartTwo partTwo;

    <span class="hljs-keyword">private</span> Factory factory;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ProductA</span><span class="hljs-params">(Factory factory)</span>{
        <span class="hljs-built_in">this</span>.factory = factory;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">prepare</span><span class="hljs-params">()</span>{
        partOne = factory.produceOne();
        partTwo = factory.produceTwo();
    }

}
</code></pre>
<p>使用方法如下：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">Factory</span> <span class="hljs-variable">factory</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FactoryA</span>();
        <span class="hljs-type">ProductA</span> <span class="hljs-variable">productA</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProductA</span>(factory);
        productA.prepare();
    }
}
</code></pre>
<p>抽象工厂模式与工厂方法模式的区别在于抽象工厂模式适用于构建一组关联对象的场景，例如上例中 ProductA 中包含的两个对象：PartOne 和 PartTwo。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[SpringBoot LiquibasePlus 数据库版本管理工具加强使用指南]]></title>    <link>https://juejin.cn/post/7590403249561583631</link>    <guid>https://juejin.cn/post/7590403249561583631</guid>    <pubDate>2026-01-04T01:59:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590403249561583631" data-draft-id="7540566577622614079" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="SpringBoot LiquibasePlus 数据库版本管理工具加强使用指南"/> <meta itemprop="keywords" content="Spring Boot"/> <meta itemprop="datePublished" content="2026-01-04T01:59:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="昵称为空C"/> <meta itemprop="url" content="https://juejin.cn/user/1267096172897005"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            SpringBoot LiquibasePlus 数据库版本管理工具加强使用指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1267096172897005/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    昵称为空C
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-04T01:59:52.000Z" title="Sun Jan 04 2026 01:59:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>摘要：本文主要介绍了基于<code>springboot</code>+<code>liquibase</code>的数据库版本管理工具的使用说明；案例封装了<code>liquibase</code>的功能进行了业务增强，让实际生成环境使用更省心。</p>
<h2 data-id="heading-0">直接使用会遇到的问题</h2>
<ul>
<li>异常退出导致<code>databasechangeloglock</code>锁表，需要手动清理数据。</li>
<li>无法满足多租户使用。</li>
<li>无法满足多数据库适配。</li>
</ul>
<h2 data-id="heading-1"><code>LiquibasePlus</code>封装案例</h2>
<blockquote>
<p>只是在<code>Liquibase</code>上做了功能增强。</p>
</blockquote>
<h3 data-id="heading-2"><code>pom.xml</code></h3>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-jdbc<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.liquibase<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>liquibase-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>mysql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mysql-connector-java<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>
</code></pre>
<h3 data-id="heading-3"><code>LiquibaseApplication</code></h3>
<blockquote>
<p>启动类</p>
</blockquote>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@SpringBootApplication</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LiquibaseApplication</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"><span class="hljs-built_in">String</span>[] args</span>) {
        <span class="hljs-title class_">SpringApplication</span>.<span class="hljs-title function_">run</span>(<span class="hljs-title class_">LiquibaseApplication</span>.<span class="hljs-property">class</span>, args);
    }
}
</code></pre>
<h3 data-id="heading-4"><code>application.yml</code></h3>
<blockquote>
<p>配置文件</p>
</blockquote>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">datasource:</span>
    <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">com.mysql.cj.jdbc.Driver</span>
    <span class="hljs-attr">username:</span> <span class="hljs-string">super_admin</span>
    <span class="hljs-attr">password:</span> <span class="hljs-string">super_admin</span>
    <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:mysql://192.168.8.134:30635/test_1?useSSL=false&amp;serverTimezone=UTC</span>
  <span class="hljs-attr">liquibase:</span>
    <span class="hljs-attr">enabled:</span> <span class="hljs-literal">false</span>
  <span class="hljs-attr">liquibase-plus:</span>
    <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span>
    <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">com.mysql.cj.jdbc.Driver</span>
    <span class="hljs-attr">username:</span> <span class="hljs-string">super_admin</span>
    <span class="hljs-attr">password:</span> <span class="hljs-string">super_admin</span>
    <span class="hljs-attr">jdbc-url:</span> <span class="hljs-string">jdbc:mysql://192.168.8.134:30635/test_1?useSSL=false&amp;serverTimezone=UTC</span>
    <span class="hljs-attr">change-log:</span> <span class="hljs-string">classpath*:sql/mysql/changelog.xml</span>
</code></pre>
<h3 data-id="heading-5"><code>SpringLiquibasePlusProperties</code></h3>
<blockquote>
<p>属性配置类</p>
</blockquote>
<pre><code class="hljs language-arduino" lang="arduino">@Data
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SpringLiquibasePlusProperties</span> {

    <span class="hljs-comment">/** 是否开启 */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> enabled;
    <span class="hljs-comment">/** 驱动名称 */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> driverClassName;
    <span class="hljs-comment">/** 链接地址 */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> jdbcUrl;
    <span class="hljs-comment">/** 用户名 */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> username;
    <span class="hljs-comment">/** 密码 */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> password;
    <span class="hljs-comment">/** 数据库schema */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> schema;
    <span class="hljs-comment">/** 变更日志 */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> changeLog;

}
</code></pre>
<h3 data-id="heading-6"><code>SpringLiquibasePlusExecutor</code></h3>
<blockquote>
<p><code>liquibase</code>执行器</p>
</blockquote>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-keyword">@Slf</span>4j
public class SpringLiquibasePlusExecutor {

    private final ResourceLoader resourceLoader;

    public <span class="hljs-built_in">SpringLiquibasePlusExecutor</span>(ResourceLoader resourceLoader) {
        this<span class="hljs-selector-class">.resourceLoader</span> = resourceLoader;
    }

    <span class="hljs-comment">/**
     * 初始化数据库
     * @param properties
     */</span>
    public void <span class="hljs-built_in">execute</span>(SpringLiquibasePlusProperties properties) throws Exception{
        <span class="hljs-built_in">try</span>(HikariDataSource hikariDataSource = this.buildDataSource(properties)) {
            SpringLiquibase liquibase = new <span class="hljs-built_in">SpringLiquibase</span>();
            liquibase<span class="hljs-selector-class">.setDataSource</span>(hikariDataSource);
            liquibase<span class="hljs-selector-class">.setResourceLoader</span>(resourceLoader);
            liquibase<span class="hljs-selector-class">.setDatabaseChangeLogTable</span>("databasechangelog");
            liquibase<span class="hljs-selector-class">.setDatabaseChangeLogLockTable</span>("databasechangeloglock");
            <span class="hljs-comment">//指定changelog的位置，这里使用的一个master文件引用其他文件的方式</span>
            liquibase<span class="hljs-selector-class">.setChangeLog</span>(properties.getChangeLog());
            liquibase<span class="hljs-selector-class">.setShouldRun</span>(true);
            <span class="hljs-comment">// 检查锁表的情况</span>
            <span class="hljs-built_in">removeTimeoutLock</span>(hikariDataSource, liquibase.getDatabaseChangeLogLockTable());
            liquibase<span class="hljs-selector-class">.afterPropertiesSet</span>();
        }
    }

    <span class="hljs-comment">/**
     * 构建数据源
     * @param properties
     * @return
     */</span>
    private HikariDataSource <span class="hljs-built_in">buildDataSource</span>(SpringLiquibasePlusProperties properties){
        HikariDataSource hikariDataSource = new <span class="hljs-built_in">HikariDataSource</span>();
        hikariDataSource<span class="hljs-selector-class">.setDriverClassName</span>(properties.getDriverClassName());
        hikariDataSource<span class="hljs-selector-class">.setJdbcUrl</span>(properties.getJdbcUrl());
        hikariDataSource<span class="hljs-selector-class">.setUsername</span>(properties.getUsername());
        hikariDataSource<span class="hljs-selector-class">.setPassword</span>(properties.getPassword());
        hikariDataSource<span class="hljs-selector-class">.setSchema</span>(properties.getSchema());
        hikariDataSource<span class="hljs-selector-class">.setMinimumIdle</span>(<span class="hljs-number">1</span>);
        hikariDataSource<span class="hljs-selector-class">.setMaximumPoolSize</span>(<span class="hljs-number">1</span>);
        return hikariDataSource;
    }

    <span class="hljs-comment">/**
     * 移除超时的锁
     * 如果要写得更好，先判断表存在没有，存在了再执行SQL语句，我这里捕获异常处理的
     * @param dataSource
     * @param tableName
     */</span>
    public void <span class="hljs-built_in">removeTimeoutLock</span>(DataSource dataSource, String tableName){
        <span class="hljs-comment">// 超时5分钟就认为超时，这里可以自己自定义</span>
        Timestamp lastDBLockTime = new <span class="hljs-built_in">Timestamp</span>(new java.util.Date()<span class="hljs-selector-class">.getTime</span>() - (<span class="hljs-number">5</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000</span>));
        <span class="hljs-comment">// 这里的SQL语句需要按照自己的数据库方式来，现阶段我就遇到`oracle`写法不一样</span>
        String sql = String<span class="hljs-selector-class">.format</span>("UPDATE %s SET LOCKED = <span class="hljs-number">0</span>, LOCKGRANTED = NULL, LOCKEDBY = NULL WHERE LOCKED = <span class="hljs-number">1</span> AND LOCKGRANTED &lt; '%s'", tableName, lastDBLockTime);

        try (Connection connection = dataSource.getConnection(); Statement stmt = connection<span class="hljs-selector-class">.createStatement</span>()) {
            int updateCount = stmt<span class="hljs-selector-class">.executeUpdate</span>(sql);
            <span class="hljs-built_in">if</span>(updateCount &gt; <span class="hljs-number">0</span>){
                log<span class="hljs-selector-class">.info</span>("liquibase异常锁解除成功");
            }else {
                log<span class="hljs-selector-class">.info</span>("liquibase无异常锁");
            }
        } catch (Exception ex) {
            <span class="hljs-built_in">if</span>(!(ex instanceof SQLException)){
                <span class="hljs-comment">// 直接跳过不用处理异常了</span>
                log<span class="hljs-selector-class">.error</span>("liquibase解锁异常", ex);
            }else {
                log<span class="hljs-selector-class">.warn</span>("liquibase初次加载");
            }
        }
    }

}
</code></pre>
<h3 data-id="heading-7"><code>SpringLiquibasePlusConfig</code>启动配置</h3>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@Slf4j</span>
<span class="hljs-variable">@Configuration</span>
<span class="hljs-variable">@ConditionalOnProperty</span>(
        prefix = <span class="hljs-string">"spring.liquibase-plus"</span>,
        name = {<span class="hljs-string">"enabled"</span>}
)
public class SpringLiquibasePlusConfig {

    <span class="hljs-variable">@Autowired</span>
    private ResourceLoader resourceLoader;
    <span class="hljs-variable">@Autowired</span>
    private List&lt;CustomTaskChange&gt; customTaskChanges;

    <span class="hljs-variable">@Bean</span>
    <span class="hljs-variable">@ConfigurationProperties</span>(prefix = <span class="hljs-string">"spring.liquibase-plus"</span>,ignoreUnknownFields = false)
    public SpringLiquibasePlusProperties <span class="hljs-built_in">springLiquibasePlusProperties</span>() {
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">SpringLiquibasePlusProperties</span>();
    }

    @<span class="hljs-selector-tag">Bean</span>
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">SpringLiquibasePlusExecutor</span> <span class="hljs-selector-tag">springLiquibasePlusExecuter</span>(SpringLiquibasePlusProperties springLiquibasePlusProperties) <span class="hljs-selector-tag">throws</span> <span class="hljs-selector-tag">Exception</span> {
        <span class="hljs-selector-tag">log</span><span class="hljs-selector-class">.info</span>(<span class="hljs-string">"Liquibase CustomTaskChange size: {}, names: {}"</span>, customTaskChanges.<span class="hljs-built_in">size</span>(), customTaskChanges.<span class="hljs-built_in">stream</span>().<span class="hljs-built_in">map</span>(<span class="hljs-attribute">CustomTaskChange</span>::getClass).<span class="hljs-built_in">collect</span>(Collectors.<span class="hljs-built_in">toSet</span>()));
        <span class="hljs-selector-tag">customTaskChanges</span><span class="hljs-selector-class">.forEach</span>(<span class="hljs-attribute">CustomChange</span>::getConfirmationMessage);
        <span class="hljs-selector-tag">SpringLiquibasePlusExecutor</span> <span class="hljs-selector-tag">springLiquibasePlusExecutor</span> = <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">SpringLiquibasePlusExecutor</span>(resourceLoader);
        <span class="hljs-selector-tag">springLiquibasePlusExecutor</span><span class="hljs-selector-class">.execute</span>(springLiquibasePlusProperties);
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">springLiquibasePlusExecutor</span>;
    }

}
</code></pre>
<h3 data-id="heading-8"><code>V1_00_00_ClearCustomTaskChange</code></h3>
<blockquote>
<p><code>sql</code>中解决不了的，需要用<code>java</code>代码来进行版本管理的业务。</p>
</blockquote>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Slf4j</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">V1_00_00_ClearCustomTaskChange</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">CustomTaskChange</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-title class_">JdbcTemplate</span> jdbcTemplate;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">setJdbcTemplate</span>(<span class="hljs-params">JdbcTemplate jdbcTemplate</span>) {
        V1_00_00_ClearCustomTaskChange.<span class="hljs-property">jdbcTemplate</span> = jdbcTemplate;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">execute</span>(<span class="hljs-title class_">Database</span> database) throws <span class="hljs-title class_">CustomChangeException</span> {
        <span class="hljs-comment">// 这里写liquibase简单的sql语句做不了的复杂写法，我这里只做简单演示，这里强烈建议用jdbcTemplate查询其他的表，并且只查询自己需要的字段</span>
        <span class="hljs-title class_">List</span>&lt;<span class="hljs-title class_">Map</span>&lt;<span class="hljs-title class_">String</span>, <span class="hljs-title class_">Object</span>&gt;&gt; mapList = jdbcTemplate.<span class="hljs-title function_">queryForList</span>(<span class="hljs-string">"select * from school_01 where name = 'A'"</span>);
        <span class="hljs-keyword">if</span>(<span class="hljs-title class_">CollectionUtils</span>.<span class="hljs-title function_">isEmpty</span>(mapList)) {
            <span class="hljs-keyword">for</span> (int i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) {
                jdbcTemplate.<span class="hljs-title function_">update</span>(<span class="hljs-string">"insert into school_01(id, name) values (?, ?)"</span>, i, <span class="hljs-string">"A"</span> + i);
            }
        }
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getConfirmationMessage</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"SUCCESS"</span>;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">setUp</span>() throws <span class="hljs-title class_">SetupException</span> {

    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">setFileOpener</span>(<span class="hljs-params">ResourceAccessor resourceAccessor</span>) {

    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">ValidationErrors</span> <span class="hljs-title function_">validate</span>(<span class="hljs-params">Database database</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    }
}
</code></pre>
<h3 data-id="heading-9"><code>changelog.xml</code></h3>
<blockquote>
<p>主要的数据库版本管理文件</p>
</blockquote>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"UTF-8"</span>?&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">databaseChangeLog</span>
        <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://www.liquibase.org/xml/ns/dbchangelog"</span>
        <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span>
        <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">"http://www.liquibase.org/xml/ns/dbchangelog
         http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd"</span>&gt;</span>

    <span class="hljs-comment">&lt;!--  初始化表结构  --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">include</span> <span class="hljs-attr">file</span>=<span class="hljs-string">"/sql/mysql/V1.00.00.sql"</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">changeSet</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"V1.00.00-003-1"</span> <span class="hljs-attr">author</span>=<span class="hljs-string">"huzhihui"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">customChange</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.github.sp3.liquibase.config.custom.V1_00_00_ClearCustomTaskChange"</span>/&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">changeSet</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">include</span> <span class="hljs-attr">file</span>=<span class="hljs-string">"/sql/mysql/V1.00.01.sql"</span>/&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">databaseChangeLog</span>&gt;</span>
</code></pre>
<h3 data-id="heading-10"><code>V1.00.00.sql</code></h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">--liquibase formatted sql</span>

<span class="hljs-comment">--changeset huzhihui:V1.00.00-001-1</span>
<span class="hljs-comment">--preconditions onFail:MARK_RAN onError:MARK_RAN</span>
<span class="hljs-comment">--precondition-sql-check expectedResult:0 select count(1) from information_schema.tables where table_schema = (select database()) and table_name = 'school_01';</span>
<span class="hljs-comment">--comment 测试表</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `school_01` (
  `id` <span class="hljs-type">bigint</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  `name` <span class="hljs-type">varchar</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,
  `create_time` datetime <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,
  `time_zone` <span class="hljs-type">timestamp</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,
  `time_no_zone` datetime <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,
  <span class="hljs-keyword">PRIMARY</span> KEY (`id`)
) ENGINE<span class="hljs-operator">=</span>InnoDB;

<span class="hljs-comment">--changeset huzhihui:V1.00.00-002-1</span>
<span class="hljs-comment">--preconditions onFail:MARK_RAN onError:MARK_RAN</span>
<span class="hljs-comment">--precondition-sql-check expectedResult:0 select count(1) from information_schema.tables where table_schema = (select database()) and table_name = 'school_02';</span>
<span class="hljs-comment">--comment 测试表</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `school_02` (
 `id` <span class="hljs-type">bigint</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
 `name` <span class="hljs-type">varchar</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,
 `create_time` datetime <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,
 `time_zone` <span class="hljs-type">timestamp</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,
 `time_no_zone` datetime <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,
 <span class="hljs-keyword">PRIMARY</span> KEY (`id`)
) ENGINE<span class="hljs-operator">=</span>InnoDB;
</code></pre>
<h3 data-id="heading-11"><code>V1.00.01.sql</code></h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">--liquibase formatted sql</span>

<span class="hljs-comment">--changeset huzhihui:V1.00.01-001-1</span>
<span class="hljs-comment">--preconditions onFail:MARK_RAN onError:MARK_RAN</span>
<span class="hljs-comment">--precondition-sql-check expectedResult:0 select count(1) from information_schema.tables where table_schema = (select database()) and table_name = 'school_03';</span>
<span class="hljs-comment">--comment 测试表</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `school_03` (
  `id` <span class="hljs-type">bigint</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  `name` <span class="hljs-type">varchar</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,
  `create_time` datetime <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,
  `time_zone` <span class="hljs-type">timestamp</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,
  `time_no_zone` datetime <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,
  <span class="hljs-keyword">PRIMARY</span> KEY (`id`)
) ENGINE<span class="hljs-operator">=</span>InnoDB;
</code></pre>
<h2 data-id="heading-12">最终执行结果</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/71a3c708cc564645a333c548df64f9c1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pi156ew5Li656m6Qw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768096792&amp;x-signature=%2FpDEi12m%2FVVZqTA0Y2RruqahNkQ%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3990f674ad474230ae6f8dc51bf5e86d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pi156ew5Li656m6Qw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768096792&amp;x-signature=60J%2FmmJaMwC%2FWXwv%2BsoX2zrDP6w%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ed1cb86741334a758c66d34fde76e30f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pi156ew5Li656m6Qw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768096792&amp;x-signature=vEsepQ2L%2FEe7G0lkUZSCBE1W%2Bns%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b5dff566ad5a4cfebd8e63bb9c540d84~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pi156ew5Li656m6Qw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768096792&amp;x-signature=Os8ZEHQ4dF7QUm7Q5IR%2Fq5yam4w%3D" alt="image.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[7 个从入门到资深 PHP 开发者都在用的核心调试技能]]></title>    <link>https://juejin.cn/post/7590330924001493055</link>    <guid>https://juejin.cn/post/7590330924001493055</guid>    <pubDate>2026-01-04T00:02:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590330924001493055" data-draft-id="7590309337861767209" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="7 个从入门到资深 PHP 开发者都在用的核心调试技能"/> <meta itemprop="keywords" content="后端,PHP"/> <meta itemprop="datePublished" content="2026-01-04T00:02:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="BingoGo"/> <meta itemprop="url" content="https://juejin.cn/user/993614242266077"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            7 个从入门到资深 PHP 开发者都在用的核心调试技能
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/993614242266077/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    BingoGo
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-04T00:02:20.000Z" title="Sun Jan 04 2026 00:02:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">7 个从入门到资深 PHP 开发者都在用的核心调试技能</h2>
<h3 data-id="heading-1">调试的残酷真相</h3>
<p>大多数 PHP bug 难搞，不是因为它们"复杂"，而是因为它们<strong>看不见</strong>。</p>
<p>变量在比你预期早两层的地方就变成了 null。一个"不可能发生"的条件偏偏只在生产环境发生。请求在本地正常，放到代理后面就挂了。队列 worker 的行为和 HTTP 运行时不一样。还有经典场景：你修好了……下周它又回来了。</p>
<p>想快速成长为 PHP 开发者，别急着学更多框架特性。先学会<strong>观察系统实际在做什么</strong>。</p>
<p>下面是我认为每个 PHP 开发者从第一天就该掌握的 7 个调试技能。它们不是花招，而是会持续产生复利的习惯。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fcatchadmin.com%2Fpost%2F2026-01%2Fdebugging-php-like-a-pro" target="_blank" title="https://catchadmin.com/post/2026-01/debugging-php-like-a-pro" ref="nofollow noopener noreferrer">原文 7 个从入门到资深 PHP 开发者都在用的核心调试技能</a></p>
<h3 data-id="heading-2">错误要看得见，但别暴露给用户</h3>
<p>看不到错误，你就不是在调试——你是在猜。</p>
<p>PHP 提供了可靠的错误可见性原语：<code>error_reporting</code>、<code>display_errors</code> 和日志设置。关键是把开发环境和生产环境当作不同的可观测模式来对待。</p>
<p>PHP 官方手册强烈建议在生产网站上记录错误而非显示错误。</p>
<h4 data-id="heading-3">开发环境：全开</h4>
<p>在开发环境，你需要最大化的信号：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment">; php.ini (development)</span>
<span class="hljs-attr">error_reporting</span> = -<span class="hljs-number">1</span>
<span class="hljs-attr">display_errors</span> = <span class="hljs-literal">On</span>
<span class="hljs-attr">display_startup_errors</span> = <span class="hljs-literal">On</span>
<span class="hljs-attr">log_errors</span> = <span class="hljs-literal">On</span>
</code></pre>
<p>如果你用 Docker 或开发容器，确认容器内部的设置：</p>
<pre><code class="hljs language-bash" lang="bash">php -i | grep -E <span class="hljs-string">"error_reporting|display_errors|log_errors"</span>
</code></pre>
<h4 data-id="heading-4">生产环境：只记录，不显示</h4>
<p>在生产环境，<code>display_errors=On</code> 不是"有帮助"，而是漏洞。你要的是日志，不是泄露的堆栈跟踪。</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment">; php.ini (production)</span>
<span class="hljs-attr">error_reporting</span> = -<span class="hljs-number">1</span>
<span class="hljs-attr">display_errors</span> = <span class="hljs-literal">Off</span>
<span class="hljs-attr">display_startup_errors</span> = <span class="hljs-literal">Off</span>
<span class="hljs-attr">log_errors</span> = <span class="hljs-literal">On</span>
<span class="hljs-attr">error_log</span> = /var/log/php/app-error.log
</code></pre>
<p>然后在故障期间 tail 日志：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">tail</span> -f /var/log/php/app-error.log
</code></pre>
<h4 data-id="heading-5">异常日志要带上下文</h4>
<p>别完全依赖 PHP 默认的错误日志格式。在应用启动时添加一个顶层异常处理器（框架无关）：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-keyword">declare</span>(strict_types=<span class="hljs-number">1</span>);

<span class="hljs-title function_ invoke__">set_exception_handler</span>(function (<span class="hljs-built_in">Throwable</span> <span class="hljs-variable">$e</span>) {
    <span class="hljs-title function_ invoke__">error_log</span>(<span class="hljs-title function_ invoke__">json_encode</span>([
        <span class="hljs-string">'level'</span> =&gt; <span class="hljs-string">'error'</span>,
        <span class="hljs-string">'event'</span> =&gt; <span class="hljs-string">'uncaught_exception'</span>,
        <span class="hljs-string">'message'</span> =&gt; <span class="hljs-variable">$e</span>-&gt;<span class="hljs-title function_ invoke__">getMessage</span>(),
        <span class="hljs-string">'type'</span> =&gt; <span class="hljs-variable">$e</span>::<span class="hljs-variable language_">class</span>,
        <span class="hljs-string">'file'</span> =&gt; <span class="hljs-variable">$e</span>-&gt;<span class="hljs-title function_ invoke__">getFile</span>(),
        <span class="hljs-string">'line'</span> =&gt; <span class="hljs-variable">$e</span>-&gt;<span class="hljs-title function_ invoke__">getLine</span>(),
        <span class="hljs-string">'trace'</span> =&gt; <span class="hljs-title function_ invoke__">explode</span>(<span class="hljs-string">"\n"</span>, <span class="hljs-variable">$e</span>-&gt;<span class="hljs-title function_ invoke__">getTraceAsString</span>()),
    ], JSON_UNESCAPED_SLASHES));
});
</code></pre>
<p>这是"穷人版结构化日志"，但已经比经典的"崩了，不知道为啥"强多了。</p>
<p><strong>技能检验</strong>：如果有人给你一张生产环境的错误截图，你应该能说："关掉那个。放到日志里。加上关联 ID。然后复现。"</p>
<h3 data-id="heading-6">Xdebug 步进调试：别再瞎猜了</h3>
<p><code>var_dump()</code> 在探索时还行。步进调试才是你认真排查时用的工具。</p>
<p>Xdebug 的步进调试器让你可以逐步执行代码并交互式地检查状态。</p>
<h4 data-id="heading-7">理解它能干什么</h4>
<p>步进调试回答的问题：</p>
<ul>
<li>代码实际走了哪条路径？</li>
<li>这里的值是什么，不是你脑子里想的那个？</li>
<li>为什么这个分支被执行了？</li>
<li>是什么修改了这个变量？</li>
</ul>
<h4 data-id="heading-8">Xdebug 3 最小配置</h4>
<p>Xdebug 有多种模式和现代化的配置方式。官方文档覆盖了步进调试和所有设置。</p>
<p>在大多数环境中，可以这样配置：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment">; xdebug.ini</span>
<span class="hljs-attr">xdebug.mode</span> = debug
<span class="hljs-attr">xdebug.start_with_request</span> = <span class="hljs-literal">yes</span>
<span class="hljs-attr">xdebug.client_port</span> = <span class="hljs-number">9003</span>
</code></pre>
<p>为什么是 9003？Xdebug 3 改了默认端口（这是"连不上"问题的常见原因）。IDE 文档和社区答案通常把 9003 作为 Xdebug 3 的默认端口。</p>
<h4 data-id="heading-9">共享环境别常开调试</h4>
<p>更好的习惯是"需要时才调试"。这样能保持性能稳定，避免意外暴露调试行为。</p>
<p>尽量用环境变量：</p>
<pre><code class="hljs language-bash" lang="bash">XDEBUG_MODE=debug php -S localhost:8000 -t public
</code></pre>
<p>或者对于 PHP-FPM/容器，只在开发环境设置 <code>XDEBUG_MODE=debug</code>。</p>
<h4 data-id="heading-10">高效的调试流程</h4>
<ol>
<li>在可疑函数的第一行打断点</li>
<li>触发请求</li>
<li>步进进入函数</li>
<li>观察：
<ul>
<li>输入参数</li>
<li>分支条件</li>
<li>意外的 null / 空字符串</li>
<li>"神秘"变化的值</li>
</ul>
</li>
<li>找到错误假设后，停下来。用一句话写下来。</li>
</ol>
<p>最后一步很重要：目标不是"无限探索"，而是快速找到错误的假设。</p>
<h3 data-id="heading-11">告别 var_dump()，用更好的方式 dump</h3>
<p>dump 仍然有用。错误在于盲目 dump。</p>
<p>Symfony 的 VarDumper 组件提供了比 <code>var_dump()</code> 更易读的 <code>dump()</code> 函数。很多流行生态（包括 Laravel）的 <code>dd()</code> 便捷函数都基于 VarDumper 风格的 dump 构建。</p>
<h4 data-id="heading-12">dump 关键字段，别 dump 整个对象</h4>
<p>与其 dump 整个对象图然后滚动 5 分钟，不如 dump 你关心的形状。</p>
<p><strong>差</strong>：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-title function_ invoke__">dump</span>(<span class="hljs-variable">$request</span>);
</code></pre>
<p><strong>好</strong>：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-title function_ invoke__">dump</span>([
  <span class="hljs-string">'method'</span> =&gt; <span class="hljs-variable">$request</span>-&gt;<span class="hljs-title function_ invoke__">getMethod</span>(),
  <span class="hljs-string">'path'</span>   =&gt; <span class="hljs-variable">$request</span>-&gt;<span class="hljs-title function_ invoke__">getPathInfo</span>(),
  <span class="hljs-string">'userId'</span> =&gt; <span class="hljs-variable">$user</span>?-&gt;id,
]);
</code></pre>
<h4 data-id="heading-13">写个临时的调试辅助函数</h4>
<p>在纯 PHP 应用中，定义一个小辅助函数：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">dd</span>(<span class="hljs-params"><span class="hljs-keyword">mixed</span> <span class="hljs-variable">$value</span></span>): <span class="hljs-title">never</span> </span>{
    <span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">'Content-Type: text/plain; charset=utf-8'</span>);
    <span class="hljs-title function_ invoke__">var_dump</span>(<span class="hljs-variable">$value</span>);
    <span class="hljs-keyword">exit</span>(<span class="hljs-number">1</span>);
}
</code></pre>
<p>然后谨慎使用。重点是速度。</p>
<p><strong>规则</strong>：如果一个流程里有超过 3 个 dump，你可能需要步进调试或带关联 ID 的日志。</p>
<h3 data-id="heading-14">日志要像证据，不是流水账</h3>
<p>日志不应该是散落在代码里的随机句子。日志应该是<strong>证据</strong>。</p>
<p>如果你用 Laravel，它的日志系统是基于 channel 的，默认使用"stack" channel。Laravel 还有"context"能力，可以在请求/任务/命令中捕获共享元数据并包含在日志里。</p>
<p>即使你不用 Laravel，这个模式到处适用：一次性附加上下文，每行日志都变得更有用。</p>
<h4 data-id="heading-15">给每个请求加关联 ID</h4>
<p>这是投入产出比最高的调试手段之一。</p>
<p>框架无关的示例：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-keyword">declare</span>(strict_types=<span class="hljs-number">1</span>);

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getCorrelationId</span>(<span class="hljs-params"/>): <span class="hljs-title">string</span> </span>{
    <span class="hljs-variable">$hdr</span> = <span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">'HTTP_X_REQUEST_ID'</span>] ?? <span class="hljs-string">''</span>;
    <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">is_string</span>(<span class="hljs-variable">$hdr</span>) &amp;&amp; <span class="hljs-variable">$hdr</span> !== <span class="hljs-string">''</span>) <span class="hljs-keyword">return</span> <span class="hljs-variable">$hdr</span>;
    <span class="hljs-comment">// 如果没有就生成一个</span>
    <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">bin2hex</span>(<span class="hljs-title function_ invoke__">random_bytes</span>(<span class="hljs-number">16</span>));
}
<span class="hljs-variable">$reqId</span> = <span class="hljs-title function_ invoke__">getCorrelationId</span>();
<span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">'X-Request-Id: '</span> . <span class="hljs-variable">$reqId</span>);
</code></pre>
<p>然后加到日志里：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-title function_ invoke__">error_log</span>(<span class="hljs-title function_ invoke__">json_encode</span>([
  <span class="hljs-string">'level'</span> =&gt; <span class="hljs-string">'info'</span>,
  <span class="hljs-string">'event'</span> =&gt; <span class="hljs-string">'checkout.start'</span>,
  <span class="hljs-string">'request_id'</span> =&gt; <span class="hljs-variable">$reqId</span>,
  <span class="hljs-string">'user_id'</span> =&gt; <span class="hljs-variable">$userId</span> ?? <span class="hljs-literal">null</span>,
  <span class="hljs-string">'cart_items'</span> =&gt; <span class="hljs-title function_ invoke__">count</span>(<span class="hljs-variable">$items</span>),
]));
</code></pre>
<h4 data-id="heading-16">记录分支决策，而非流水事件</h4>
<p>决策点是行为分叉的地方：</p>
<ul>
<li>授权检查</li>
<li>选择支付提供商</li>
<li>回退逻辑</li>
<li>重试</li>
<li>功能开关</li>
</ul>
<p>示例：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-variable">$logger</span>-&gt;<span class="hljs-title function_ invoke__">info</span>(<span class="hljs-string">'payment.route'</span>, [
  <span class="hljs-string">'request_id'</span> =&gt; <span class="hljs-variable">$reqId</span>,
  <span class="hljs-string">'order_id'</span> =&gt; <span class="hljs-variable">$orderId</span>,
  <span class="hljs-string">'provider'</span> =&gt; <span class="hljs-variable">$providerName</span>,
  <span class="hljs-string">'reason'</span> =&gt; <span class="hljs-string">'currency_supported'</span>,
]);
</code></pre>
<h4 data-id="heading-17">敏感信息绝对不能进日志</h4>
<p>脱敏 token、密码、Authorization header、session ID。调试不值得让凭证永远泄露在日志里。</p>
<h3 data-id="heading-18">不能复现的 bug 等于没修</h3>
<p>不能复现的 bug 没有被修复，它只是在睡觉。</p>
<p>成为"调试高手"最快的方法是学会创建最小复现。</p>
<h4 data-id="heading-19">最小复现清单</h4>
<p>bug 报告来了，立刻捕获这些：</p>
<ul>
<li>精确的输入 payload（或脱敏版本）</li>
<li>环境差异（PHP 版本、扩展、配置）</li>
<li>时间相关条件（时区、当前日期、夏令时）</li>
<li>并发条件（1 个请求 vs 10 个并发）</li>
<li>数据前置条件（特定的数据库行）</li>
</ul>
<p>然后精简。</p>
<p>如果你的应用需要 20 步才能复现，目标是 3 步。如果需要 3 步，目标是 1 步。</p>
<h4 data-id="heading-20">把 bug 变成测试用例</h4>
<p>这是真正的团队阻止回归的方式。</p>
<p>示例：一个微妙的折扣舍入 bug，只在特定价格时出现。</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-keyword">declare</span>(strict_types=<span class="hljs-number">1</span>);

<span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Discount</span>
</span>{
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">apply</span>(<span class="hljs-params"><span class="hljs-keyword">int</span> <span class="hljs-variable">$priceCents</span>, <span class="hljs-keyword">int</span> <span class="hljs-variable">$percent</span></span>): <span class="hljs-title">int</span>
    </span>{
        <span class="hljs-variable">$cut</span> = (<span class="hljs-keyword">int</span>) <span class="hljs-title function_ invoke__">round</span>(<span class="hljs-variable">$priceCents</span> * (<span class="hljs-variable">$percent</span> / <span class="hljs-number">100</span>));
        <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">max</span>(<span class="hljs-number">0</span>, <span class="hljs-variable">$priceCents</span> - <span class="hljs-variable">$cut</span>);
    }
}
</code></pre>
<p>写回归测试：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-keyword">declare</span>(strict_types=<span class="hljs-number">1</span>);

<span class="hljs-keyword">use</span> <span class="hljs-title">PHPUnit</span>\<span class="hljs-title">Framework</span>\<span class="hljs-title">TestCase</span>;
<span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DiscountTest</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">TestCase</span>
</span>{
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">testRoundingEdgeCase</span>(<span class="hljs-params"/>): <span class="hljs-title">void</span>
    </span>{
        <span class="hljs-variable">$d</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Discount</span>();
        <span class="hljs-comment">// Bug 报告：999 分钱打 10% 折扣产生了 900 而非 899</span>
        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">assertSame</span>(<span class="hljs-number">899</span>, <span class="hljs-variable">$d</span>-&gt;<span class="hljs-title function_ invoke__">apply</span>(<span class="hljs-number">999</span>, <span class="hljs-number">10</span>));
    }
}
</code></pre>
<p>现在你有了：</p>
<ul>
<li>几秒钟就能跑完的复现</li>
<li>防止以后重新引入 bug 的安全网</li>
</ul>
<h4 data-id="heading-21">时间相关的 bug：冻结时间</h4>
<p>如果你的代码依赖时间，你会追鬼。</p>
<p>在应用代码中，包装"现在"：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">Clock</span> </span>{
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">now</span>(<span class="hljs-params"/>): <span class="hljs-title">DateTimeImmutable</span></span>;
}

<span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SystemClock</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Clock</span> </span>{
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">now</span>(<span class="hljs-params"/>): <span class="hljs-title">DateTimeImmutable</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DateTimeImmutable</span>(<span class="hljs-string">'now'</span>);
    }
}
</code></pre>
<p>在测试中，注入固定的 clock。你的调试就变得确定性了。</p>
<h3 data-id="heading-22">边界调试：数据库和外部 API</h3>
<p>在现代 PHP 应用中，bug 往往不在你的业务逻辑里。它在：</p>
<ul>
<li>返回意外结构的查询</li>
<li>N+1 查询模式</li>
<li>导致超时的慢事务</li>
<li>返回微妙不同 payload 的外部 API</li>
</ul>
<h4 data-id="heading-23">数据库：先看查询数量</h4>
<p>如果你的接口突然变慢，第一个问题往往是："这个请求执行了多少查询？"</p>
<p>框架无关的方式（PDO 包装器）可以计数查询。Laravel/Symfony 可以接入它们的数据库 profiler 功能。不管什么技术栈，习惯是一样的：</p>
<ul>
<li>捕获查询数量</li>
<li>捕获慢查询</li>
<li>小心捕获参数（避免泄露敏感信息）</li>
</ul>
<p>示例（概念性伪包装器）：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Db</span>
</span>{
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> <span class="hljs-variable">$count</span> = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-keyword">private</span> PDO <span class="hljs-variable">$pdo</span></span>) </span>{}
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">query</span>(<span class="hljs-params"><span class="hljs-keyword">string</span> <span class="hljs-variable">$sql</span>, <span class="hljs-keyword">array</span> <span class="hljs-variable">$params</span> = []</span>): <span class="hljs-title">array</span>
    </span>{
        <span class="hljs-variable language_">$this</span>-&gt;count++;
        <span class="hljs-variable">$stmt</span> = <span class="hljs-variable language_">$this</span>-&gt;pdo-&gt;<span class="hljs-title function_ invoke__">prepare</span>(<span class="hljs-variable">$sql</span>);
        <span class="hljs-variable">$stmt</span>-&gt;<span class="hljs-title function_ invoke__">execute</span>(<span class="hljs-variable">$params</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-variable">$stmt</span>-&gt;<span class="hljs-title function_ invoke__">fetchAll</span>(PDO::<span class="hljs-variable constant_">FETCH_ASSOC</span>);
    }
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">queryCount</span>(<span class="hljs-params"/>): <span class="hljs-title">int</span> </span>{ <span class="hljs-keyword">return</span> <span class="hljs-variable language_">$this</span>-&gt;count; }
}
</code></pre>
<p>请求结束时：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-variable">$logger</span>-&gt;<span class="hljs-title function_ invoke__">info</span>(<span class="hljs-string">'request.db'</span>, [
  <span class="hljs-string">'request_id'</span> =&gt; <span class="hljs-variable">$reqId</span>,
  <span class="hljs-string">'query_count'</span> =&gt; <span class="hljs-variable">$db</span>-&gt;<span class="hljs-title function_ invoke__">queryCount</span>(),
]);
</code></pre>
<h4 data-id="heading-24">外部 HTTP：记录元数据，别记 body</h4>
<p>你需要的是：</p>
<ul>
<li>method</li>
<li>host/path</li>
<li>status</li>
<li>duration</li>
<li>retries</li>
<li>关联 ID</li>
</ul>
<p>示例包装器：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">callPartnerApi</span>(<span class="hljs-params"><span class="hljs-keyword">string</span> <span class="hljs-variable">$url</span>, <span class="hljs-keyword">array</span> <span class="hljs-variable">$headers</span></span>): <span class="hljs-title">array</span>
</span>{
    <span class="hljs-variable">$start</span> = <span class="hljs-title function_ invoke__">microtime</span>(<span class="hljs-literal">true</span>);
    <span class="hljs-variable">$ch</span> = <span class="hljs-title function_ invoke__">curl_init</span>(<span class="hljs-variable">$url</span>);
    <span class="hljs-title function_ invoke__">curl_setopt_array</span>(<span class="hljs-variable">$ch</span>, [
        CURLOPT_RETURNTRANSFER =&gt; <span class="hljs-literal">true</span>,
        CURLOPT_HTTPHEADER =&gt; <span class="hljs-title function_ invoke__">array_map</span>(
            fn(<span class="hljs-variable">$k</span>, <span class="hljs-variable">$v</span>) =&gt; <span class="hljs-string">"<span class="hljs-subst">$k</span>: <span class="hljs-subst">$v</span>"</span>,
            <span class="hljs-title function_ invoke__">array_keys</span>(<span class="hljs-variable">$headers</span>),
            <span class="hljs-variable">$headers</span>
        ),
        CURLOPT_TIMEOUT =&gt; <span class="hljs-number">10</span>,
        CURLOPT_CONNECTTIMEOUT =&gt; <span class="hljs-number">3</span>,
    ]);
    <span class="hljs-variable">$body</span> = <span class="hljs-title function_ invoke__">curl_exec</span>(<span class="hljs-variable">$ch</span>);
    <span class="hljs-variable">$status</span> = <span class="hljs-title function_ invoke__">curl_getinfo</span>(<span class="hljs-variable">$ch</span>, CURLINFO_HTTP_CODE);
    <span class="hljs-variable">$durationMs</span> = (<span class="hljs-keyword">int</span>) ((<span class="hljs-title function_ invoke__">microtime</span>(<span class="hljs-literal">true</span>) - <span class="hljs-variable">$start</span>) * <span class="hljs-number">1000</span>);
    <span class="hljs-title function_ invoke__">curl_close</span>(<span class="hljs-variable">$ch</span>);
    <span class="hljs-title function_ invoke__">error_log</span>(<span class="hljs-title function_ invoke__">json_encode</span>([
        <span class="hljs-string">'event'</span> =&gt; <span class="hljs-string">'http.out'</span>,
        <span class="hljs-string">'url'</span> =&gt; <span class="hljs-variable">$url</span>,
        <span class="hljs-string">'status'</span> =&gt; <span class="hljs-variable">$status</span>,
        <span class="hljs-string">'duration_ms'</span> =&gt; <span class="hljs-variable">$durationMs</span>,
    ]));
    <span class="hljs-keyword">return</span> [<span class="hljs-string">'status'</span> =&gt; <span class="hljs-variable">$status</span>, <span class="hljs-string">'body'</span> =&gt; <span class="hljs-variable">$body</span>];
}
</code></pre>
<p><strong>调试收益</strong>：一旦你有了带请求 ID 的 duration 和 status 日志，你就不用再猜 bug 是"我们的问题"还是"合作方 API 负载过高"了。</p>
<h3 data-id="heading-25">硬核手段：二分法、git bisect、断言守卫</h3>
<p>卡住的时候，暴力往往比聪明更有效。</p>
<h4 data-id="heading-26">二分法定位代码路径</h4>
<p>如果你有一个复杂流程（结账、预订、审批流水线），别读整个代码库。缩小范围。</p>
<ol>
<li>在可疑区域的开头加一条日志</li>
<li>在结尾加一条日志</li>
<li>如果开头的日志出现了但结尾的没出现，bug 就在里面</li>
<li>把区域一分为二，重复</li>
</ol>
<p>这就是"代码的二分查找"。效果惊人。</p>
<h4 data-id="heading-27">回归 bug 用 git bisect</h4>
<p>如果一个 bug"最近才开始出现"，别争论了，直接 bisect。</p>
<pre><code class="hljs language-bash" lang="bash">git bisect start
git bisect bad HEAD
git bisect good &lt;已知正常的-commit-或-tag&gt;
</code></pre>
<p>然后运行一个能复现问题的脚本/测试，每一步标记 good/bad，直到 Git 找到引入 bug 的 commit。</p>
<p>如果你没有复现脚本，那就是你的第一个任务（见技能 5）。</p>
<h4 data-id="heading-28">在边界加断言守卫</h4>
<p>大量调试时间花在处理"不可能的状态变成了可能"上。</p>
<p>添加快速失败并带清晰消息的守卫：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-keyword">declare</span>(strict_types=<span class="hljs-number">1</span>);

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">requireNonEmptyString</span>(<span class="hljs-params"><span class="hljs-keyword">mixed</span> <span class="hljs-variable">$v</span>, <span class="hljs-keyword">string</span> <span class="hljs-variable">$name</span></span>): <span class="hljs-title">string</span> </span>{
    <span class="hljs-keyword">if</span> (!<span class="hljs-title function_ invoke__">is_string</span>(<span class="hljs-variable">$v</span>) || <span class="hljs-title function_ invoke__">trim</span>(<span class="hljs-variable">$v</span>) === <span class="hljs-string">''</span>) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">InvalidArgumentException</span>(<span class="hljs-string">"<span class="hljs-subst">$name</span> must be a non-empty string"</span>);
    }
    <span class="hljs-keyword">return</span> <span class="hljs-variable">$v</span>;
}
</code></pre>
<p>在 bug 聚集的地方使用它：解析输入、读取环境变量、处理外部 payload。</p>
<p>示例：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-variable">$apiKey</span> = <span class="hljs-title function_ invoke__">requireNonEmptyString</span>(<span class="hljs-title function_ invoke__">getenv</span>(<span class="hljs-string">'PARTNER_API_KEY'</span>), <span class="hljs-string">'PARTNER_API_KEY'</span>);
</code></pre>
<p>这不是"额外代码"。这是调试预防。</p>
<h3 data-id="heading-29">完整的调试工作流</h3>
<p>遇到 bug 时，跑这个循环：</p>
<h4 data-id="heading-30">第一步：让错误可见</h4>
<p>确认错误设置和日志（技能 1）。拿到真正的堆栈跟踪。</p>
<h4 data-id="heading-31">第二步：复现</h4>
<p>精简步骤。捕获输入。让它确定性（技能 5）。</p>
<h4 data-id="heading-32">第三步：选工具</h4>
<ul>
<li>一个变量错了？<code>dump()</code> 一个小形状（技能 3）</li>
<li>控制流不清楚？Xdebug 步进调试（技能 2）</li>
<li>分布式/系统问题？关联 ID + 结构化日志（技能 4）</li>
<li>回归？git bisect（技能 7）</li>
</ul>
<h4 data-id="heading-33">第四步：修复并锁定</h4>
<p>添加测试或守卫，让它不再回来（技能 5 / 技能 7）。</p>
<p>这就是整个游戏。</p>
<h3 data-id="heading-34">结语</h3>
<p>最好的 PHP 调试者没有神奇的直觉。他们有更好的反馈循环。</p>
<ul>
<li>错误可见但不泄露（PHP 官方也建议在生产环境记录而非显示）</li>
<li>猜不出来时有步进调试可用（Xdebug 就是为此而生）</li>
<li>dump 可读且有意识（VarDumper 的 <code>dump()</code> 存在是因为 <code>var_dump()</code> 太痛苦）</li>
<li>日志在执行过程中携带上下文（Laravel 明确支持在日志中包含 context）</li>
<li>bug 变成可复现的测试，而非反复出现的故事</li>
</ul>
<p>尽早掌握这七个技能，你的"调试时间"会大幅缩短——不是因为 bug 消失了，而是因为你的系统不再对你隐藏真相。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Java并发编程避坑指南：5个常见的CompletableFuture性能陷阱及解决方案]]></title>    <link>https://juejin.cn/post/7590433626560643107</link>    <guid>https://juejin.cn/post/7590433626560643107</guid>    <pubDate>2026-01-04T00:17:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590433626560643107" data-draft-id="7590597231707799587" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Java并发编程避坑指南：5个常见的CompletableFuture性能陷阱及解决方案"/> <meta itemprop="keywords" content="后端,前端,人工智能"/> <meta itemprop="datePublished" content="2026-01-04T00:17:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿橙的百宝箱"/> <meta itemprop="url" content="https://juejin.cn/user/1638743356481367"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Java并发编程避坑指南：5个常见的CompletableFuture性能陷阱及解决方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1638743356481367/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿橙的百宝箱
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-04T00:17:30.000Z" title="Sun Jan 04 2026 00:17:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>Java并发编程避坑指南：5个常见的CompletableFuture性能陷阱及解决方案</strong></h2>
<h2 data-id="heading-1">引言</h2>
<p>在Java 8引入的<code>CompletableFuture</code>为异步编程提供了强大的工具，它结合了<code>Future</code>的异步特性和函数式编程的灵活性。然而，在实际使用中，开发者往往会陷入一些性能陷阱，导致系统吞吐量下降、资源耗尽甚至死锁。本文深入剖析5个最常见的<code>CompletableFuture</code>性能陷阱，并提供经过生产验证的解决方案，帮助开发者编写高效可靠的并发代码。</p>
<h2 data-id="heading-2">1. 线程池滥用导致的资源耗尽</h2>
<h3 data-id="heading-3">问题现象</h3>
<p>默认情况下，<code>CompletableFuture</code>使用<code>ForkJoinPool.commonPool()</code>作为执行线程池。在高并发场景下：</p>
<ul>
<li>所有异步任务共享同一个公共线程池</li>
<li>I/O密集型任务长时间占用线程</li>
<li>最终导致公共池饱和，影响整个应用的响应能力</li>
</ul>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 危险示例：大量I/O任务阻塞公共池</span>
CompletableFuture.supplyAsync(() -&gt; blockingIOOperation());
</code></pre>
<h3 data-id="heading-4">解决方案</h3>
<p><strong>专用线程池隔离</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">ExecutorService</span> <span class="hljs-variable">ioExecutor</span> <span class="hljs-operator">=</span> Executors.newFixedThreadPool(<span class="hljs-number">50</span>);
CompletableFuture.supplyAsync(() -&gt; blockingIOOperation(), ioExecutor);
</code></pre>
<p><strong>最佳实践</strong>：</p>
<ul>
<li>CPU密集型任务：使用与CPU核心数相当的线程池</li>
<li>I/O密集型任务：使用更大的线程池（建议50-200）</li>
<li>不同业务域使用独立线程池隔离</li>
</ul>
<h2 data-id="heading-5">2. 回调地狱引发的栈溢出</h2>
<h3 data-id="heading-6">问题现象</h3>
<p>深层嵌套的<code>thenApply/thenAccept</code>调用链会导致：</p>
<pre><code class="hljs language-java" lang="java">future.thenApply(f1)
      .thenApply(f2)
      <span class="hljs-comment">// ...多层嵌套...</span>
      .thenApply(f20);
</code></pre>
<ul>
<li>StackOverflowError异常（JDK8存在此问题）</li>
<li>调试困难的可维护性问题</li>
</ul>
<h3 data-id="heading-7">解决方案</h3>
<p><strong>扁平化处理链</strong>：</p>
<pre><code class="hljs language-java" lang="java">CompletableFuture&lt;V&gt; result = future.thenApply(f1)
                                   .thenCompose(v -&gt; processStage2(v))
                                   .thenCompose(v -&gt; processStage3(v));
</code></pre>
<p><strong>组合式编程</strong>：</p>
<pre><code class="hljs language-java" lang="java">CompletableFuture.allOf(
    future.thenApplyAsync(f1),
    future.thenApplyAsync(f2)
).thenAccept(results -&gt; ...);
</code></pre>
<h2 data-id="heading-8">3. 阻塞获取破坏异步优势</h2>
<h3 data-id="heading-9">问题现象</h3>
<p>错误地混合同步阻塞调用：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">CompletableFuture</span> <span class="hljs-variable">future</span> <span class="hljs-operator">=</span> asyncOperation();
future.get(); <span class="hljs-comment">// 主线程被阻塞！</span>
</code></pre>
<p>导致：</p>
<ul>
<li>完全丧失异步优势</li>
<li>可能引发死锁（如果get()在回调线程中被调用）</li>
</ul>
<h3 data-id="heading-10">解决方案</h3>
<p><strong>纯异步编程范式</strong>：</p>
<pre><code class="hljs language-java" lang="java">asyncOperation()
    .thenAccept(result -&gt; handleResult(result))
    .exceptionally(ex -&gt; handleError(ex));
</code></pre>
<p><strong>强制超时保护（必须阻塞时）</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">try</span> {
    future.get(<span class="hljs-number">500</span>, TimeUnit.MILLISECONDS); 
} <span class="hljs-keyword">catch</span> (TimeoutException e) {
    future.cancel(<span class="hljs-literal">true</span>);
}
</code></pre>
<h2 data-id="heading-11">4. 异常处理缺失导致静默失败</h2>
<h3 data-id="heading-12">问题现象</h3>
<p>未处理的异常会导致：</p>
<pre><code class="hljs language-java" lang="java">future.thenApply(v -&gt; <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>())
     .thenAccept(v -&gt; System.out.println(<span class="hljs-string">"永远不会执行"</span>));
</code></pre>
<ul>
<li>任务链静默中断</li>
<li>错误无法追踪（除非主动调用join()）</li>
</ul>
<h3 data-id="heading-13">解决方案</h3>
<p><strong>全面异常处理策略</strong>：</p>
<p>方案1：全局异常处理器</p>
<pre><code class="hljs language-java" lang="java">future.exceptionally(ex -&gt; {
    metrics.recordFailure(ex);
    <span class="hljs-keyword">return</span> fallbackValue;
});
</code></pre>
<p>方案2：组合处理模式</p>
<pre><code class="hljs language-java" lang="java">future.handle((result, ex) -&gt; {
    <span class="hljs-keyword">if</span> (ex != <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">return</span> recoveryOperation();
    }
    <span class="hljs-keyword">return</span> result;
});
</code></pre>
<h2 data-id="heading-14">5. 不合理的依赖编排引发死锁</h2>
<h3 data-id="heading-15">问题现象</h3>
<p>复杂的依赖关系可能导致：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">CompletableFuture</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> futureA.thenCombine(futureB, (x,y) -&gt; x+y); 
<span class="hljs-type">CompletableFuture</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> futureB.thenCombine(futureA, (x,y) -&gt; x*y);
</code></pre>
<ul>
<li>A等待B完成，B同时等待A完成</li>
<li>ForkJoinPool工作窃取机制失效</li>
</ul>
<h3 data-id="heading-16">解决方案</h3>
<p><strong>依赖图分析技术</strong>：</p>
<ol>
<li>
<p><strong>可视化工具辅助设计</strong>：使用JProfiler等工具分析任务依赖图</p>
</li>
<li>
<p><strong>原子性编排原则</strong>：</p>
</li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Good:明确的串行关系 </span>
futureA.thenAcceptBoth(futureB, (a,b) -&gt; {
    <span class="hljs-comment">// a和b都已就绪才执行 </span>
});
</code></pre>
<ol start="3">
<li><strong>超时熔断机制</strong>：</li>
</ol>
<pre><code class="hljs language-java" lang="java">futureA.completeOnTimeout(defaultVal,<span class="hljs-number">100</span>,TimeUnit.MILLISECONDS);
</code></pre>
<h2 data-id="heading-17">JVM层面的深度优化</h2>
<h3 data-id="heading-18">JDK9+改进须知：</h3>
<ol>
<li><strong>延迟初始化优化</strong>：JDK9后<code>defaultExecutor()</code>改为按需初始化公共池</li>
<li><strong>内存屏障改进</strong>：JDK12优化了内部VarHandle的内存语义（JEP334）</li>
<li><strong>取消性能提升</strong>：JDK11后cancel()操作减少内存占用（8231914）</li>
</ol>
<h2 data-id="heading-19">Spring集成最佳实践</h2>
<p>对于Spring应用：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Bean</span> 
<span class="hljs-keyword">public</span> Executor <span class="hljs-title function_">asyncExecutor</span><span class="hljs-params">()</span> { <span class="hljs-comment">// Spring管理的线程池 </span>
    <span class="hljs-type">ThreadPoolTaskExecutor</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolTaskExecutor</span>();
    executor.setCorePoolSize(<span class="hljs-number">20</span>);
    executor.setQueueCapacity(<span class="hljs-number">100</span>); 
    executor.setThreadNamePrefix(<span class="hljs-string">"Async-"</span>);
    <span class="hljs-keyword">return</span> executor;
}

<span class="hljs-meta">@Service</span> 
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderService</span> {
    
    <span class="hljs-meta">@Async("asyncExecutor")</span> <span class="hljs-comment">// Spring与CF的完美结合 </span>
    <span class="hljs-keyword">public</span> CompletableFuture&lt;Order&gt; <span class="hljs-title function_">queryOrderAsync</span><span class="hljs-params">(Long id)</span> {
        <span class="hljs-keyword">return</span> CompletableFuture.completedStage(repository.findById(id));
    }
}
</code></pre>
<h2 data-id="heading-20">总结</h2>
<p>掌握这些避坑技巧后，开发者可以充分发挥<code>CompletableFuture</code>的强大威力。关键要点包括：合理配置线程池、保持纯异步编程风格、完善的异常处理机制、避免循环依赖以及及时跟进JDK版本的改进特性。正确使用的<code>CompletableFuture</code>可以实现数万TPS的高并发处理能力，同时保持代码的可读性和可维护性。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[PPO：那个让你在强化学习路上少摔几跤的“调酒师”]]></title>    <link>https://juejin.cn/post/7590705425135239177</link>    <guid>https://juejin.cn/post/7590705425135239177</guid>    <pubDate>2026-01-04T00:26:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590705425135239177" data-draft-id="7590915294446714907" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="PPO：那个让你在强化学习路上少摔几跤的“调酒师”"/> <meta itemprop="keywords" content="强化学习,人工智能,算法"/> <meta itemprop="datePublished" content="2026-01-04T00:26:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="都叫我大帅哥"/> <meta itemprop="url" content="https://juejin.cn/user/3956505282886506"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            PPO：那个让你在强化学习路上少摔几跤的“调酒师”
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3956505282886506/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    都叫我大帅哥
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-04T00:26:04.000Z" title="Sun Jan 04 2026 00:26:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读17分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">PPO：那个让你在强化学习路上少摔几跤的“调酒师”</h2>
<blockquote>
<p>本文适合以下人群阅读：</p>
<ol>
<li>想入门强化学习但被TRPO数学劝退的朋友</li>
<li>在PPO参数调试中怀疑人生的实践者</li>
<li>准备面试却被“为什么PPO要clip？”问懵的求职者</li>
<li>单纯想看看AI如何学习“走平衡木”的好奇宝宝</li>
</ol>
</blockquote>
<h3 data-id="heading-1">第一章：当强化学习遇到“中年危机”——PPO为何而生？</h3>
<h4 data-id="heading-2">1.1 强化学习的“过山车”之旅</h4>
<p>想象一下，你正在教一只AI仓鼠玩跑轮。传统强化学习的方法是：</p>
<ul>
<li><strong>REINFORCE算法</strong>（蒙特卡洛版）：“仓鼠兄弟，你随便跑，跑完一圈我告诉你这圈打得多少分”</li>
<li><strong>DQN</strong>（深度Q网络）：“我先预测一下每个动作能得多少分...等等，仓鼠怎么卡在轮子里了？”</li>
<li><strong>TRPO</strong>（信任域策略优化）：“我们做个复杂的数学体操，保证每次更新都不掉下悬崖...哦，这计算量够我训练一个GPT了”</li>
</ul>
<p>就在这个时候，OpenAI的研究员们端着酒杯说：“干嘛这么复杂？我们加个‘裁剪’不就好了？”</p>
<p>于是，<strong>PPO（Proximal Policy Optimization，近端策略优化）</strong> 在2017年诞生了！</p>
<h4 data-id="heading-3">1.2 PPO的“人设”：稳如老狗，快如闪电</h4>
<p>PPO的核心哲学很接地气：</p>
<blockquote>
<p>“我想让AI进步，但又怕它‘步子迈太大扯着蛋’，所以每次更新我都拉着它的衣角说：兄嘚，别跑太远，差不多得了”</p>
</blockquote>
<p>这种“既要...又要...”的精神，让PPO一举成为强化学习的“国民算法”：</p>
<ul>
<li>MuJoCo物理模拟？用PPO！</li>
<li>Dota 2游戏AI？用PPO！</li>
<li>股票交易策略？试试PPO！</li>
<li>连ChatGPT的强化学习微调也用PPO！</li>
</ul>
<h3 data-id="heading-4">第二章：PPO用法大全——从“Hello World”到“称霸健身房”</h3>
<h4 data-id="heading-5">2.1 安装与环境搭建</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 首先，让我们准备好工具箱</span>
!pip install gymnasium torch numpy matplotlib seaborn tqdm

<span class="hljs-keyword">import</span> torch
<span class="hljs-keyword">import</span> torch.nn <span class="hljs-keyword">as</span> nn
<span class="hljs-keyword">import</span> torch.optim <span class="hljs-keyword">as</span> optim
<span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np
<span class="hljs-keyword">import</span> gymnasium <span class="hljs-keyword">as</span> gym
<span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt
<span class="hljs-keyword">from</span> collections <span class="hljs-keyword">import</span> deque
<span class="hljs-keyword">import</span> random
<span class="hljs-keyword">from</span> tqdm <span class="hljs-keyword">import</span> tqdm
<span class="hljs-keyword">import</span> seaborn <span class="hljs-keyword">as</span> sns

<span class="hljs-comment"># 设置随机种子，保证结果可复现（玄学的一部分）</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">set_seed</span>(<span class="hljs-params">seed=<span class="hljs-number">42</span></span>):
    torch.manual_seed(seed)
    np.random.seed(seed)
    random.seed(seed)
    torch.backends.cudnn.deterministic = <span class="hljs-literal">True</span>
    
set_seed()
</code></pre>
<h4 data-id="heading-6">2.2 完整PPO实现案例：教AI玩“平衡木”</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ActorCriticNetwork</span>(nn.Module):
    <span class="hljs-string">"""演员-评论家网络：既决定动作，又评价状态"""</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, state_dim, action_dim, hidden_dim=<span class="hljs-number">64</span></span>):
        <span class="hljs-built_in">super</span>().__init__()
        
        <span class="hljs-comment"># 共享的特征提取层</span>
        self.shared = nn.Sequential(
            nn.Linear(state_dim, hidden_dim),
            nn.Tanh(),
            nn.Linear(hidden_dim, hidden_dim),
            nn.Tanh(),
        )
        
        <span class="hljs-comment"># 演员头：输出动作概率分布</span>
        self.actor = nn.Sequential(
            nn.Linear(hidden_dim, action_dim),
            nn.Softmax(dim=-<span class="hljs-number">1</span>)  <span class="hljs-comment"># 输出概率，和为1</span>
        )
        
        <span class="hljs-comment"># 评论家头：评估状态价值</span>
        self.critic = nn.Linear(hidden_dim, <span class="hljs-number">1</span>)
        
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x</span>):
        features = self.shared(x)
        action_probs = self.actor(features)
        state_value = self.critic(features)
        <span class="hljs-keyword">return</span> action_probs, state_value
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">act</span>(<span class="hljs-params">self, state, deterministic=<span class="hljs-literal">False</span></span>):
        <span class="hljs-string">"""根据状态选择动作"""</span>
        <span class="hljs-keyword">with</span> torch.no_grad():
            action_probs, _ = self.forward(state)
            
            <span class="hljs-keyword">if</span> deterministic:
                <span class="hljs-comment"># 测试时：选择概率最大的动作</span>
                action = torch.argmax(action_probs, dim=-<span class="hljs-number">1</span>)
            <span class="hljs-keyword">else</span>:
                <span class="hljs-comment"># 训练时：按概率采样（探索的关键！）</span>
                dist = torch.distributions.Categorical(action_probs)
                action = dist.sample()
                
            <span class="hljs-keyword">return</span> action.item()
            
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">evaluate</span>(<span class="hljs-params">self, state, action</span>):
        <span class="hljs-string">"""评估给定状态-动作对"""</span>
        action_probs, state_value = self.forward(state)
        dist = torch.distributions.Categorical(action_probs)
        
        <span class="hljs-comment"># 动作的对数概率</span>
        action_logprob = dist.log_prob(action)
        
        <span class="hljs-comment"># 动作的熵（用于鼓励探索）</span>
        dist_entropy = dist.entropy()
        
        <span class="hljs-keyword">return</span> action_logprob, state_value, dist_entropy


<span class="hljs-keyword">class</span> <span class="hljs-title class_">PPOBuffer</span>:
    <span class="hljs-string">"""PPO专用经验回放缓冲区"""</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, state_dim, buffer_size=<span class="hljs-number">2048</span>, gamma=<span class="hljs-number">0.99</span>, gae_lambda=<span class="hljs-number">0.95</span></span>):
        self.states = np.zeros((buffer_size, state_dim), dtype=np.float32)
        self.actions = np.zeros(buffer_size, dtype=np.int32)
        self.rewards = np.zeros(buffer_size, dtype=np.float32)
        self.dones = np.zeros(buffer_size, dtype=np.float32)
        self.values = np.zeros(buffer_size, dtype=np.float32)
        self.logprobs = np.zeros(buffer_size, dtype=np.float32)
        
        self.gamma = gamma
        self.gae_lambda = gae_lambda
        self.buffer_size = buffer_size
        self.ptr = <span class="hljs-number">0</span>
        self.path_start_idx = <span class="hljs-number">0</span>
        
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">store</span>(<span class="hljs-params">self, state, action, reward, done, value, logprob</span>):
        <span class="hljs-string">"""存储一条经验"""</span>
        idx = self.ptr
        
        self.states[idx] = state
        self.actions[idx] = action
        self.rewards[idx] = reward
        self.dones[idx] = done
        self.values[idx] = value
        self.logprobs[idx] = logprob
        
        self.ptr += <span class="hljs-number">1</span>
        
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">finish_path</span>(<span class="hljs-params">self, last_value=<span class="hljs-number">0</span></span>):
        <span class="hljs-string">"""当一个回合结束时，计算GAE和回报"""</span>
        path_slice = <span class="hljs-built_in">slice</span>(self.path_start_idx, self.ptr)
        
        rewards = np.append(self.rewards[path_slice], last_value)
        values = np.append(self.values[path_slice], last_value)
        dones = np.append(self.dones[path_slice], <span class="hljs-number">0</span>)
        
        <span class="hljs-comment"># 计算GAE（广义优势估计）</span>
        gae = <span class="hljs-number">0</span>
        advantages = np.zeros(<span class="hljs-built_in">len</span>(rewards) - <span class="hljs-number">1</span>, dtype=np.float32)
        
        <span class="hljs-keyword">for</span> t <span class="hljs-keyword">in</span> <span class="hljs-built_in">reversed</span>(<span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(rewards) - <span class="hljs-number">1</span>)):
            delta = rewards[t] + self.gamma * values[t+<span class="hljs-number">1</span>] * (<span class="hljs-number">1</span> - dones[t]) - values[t]
            gae = delta + self.gamma * self.gae_lambda * (<span class="hljs-number">1</span> - dones[t]) * gae
            advantages[t] = gae
            
        <span class="hljs-comment"># 计算回报</span>
        returns = advantages + self.values[path_slice]
        
        self.advantages = advantages <span class="hljs-keyword">if</span> <span class="hljs-built_in">hasattr</span>(self, <span class="hljs-string">'advantages'</span>) <span class="hljs-keyword">else</span> np.concatenate([self.advantages, advantages])
        self.returns = returns <span class="hljs-keyword">if</span> <span class="hljs-built_in">hasattr</span>(self, <span class="hljs-string">'returns'</span>) <span class="hljs-keyword">else</span> np.concatenate([self.returns, returns])
        
        self.path_start_idx = self.ptr
        
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""获取所有数据并归一化优势值"""</span>
        <span class="hljs-comment"># 归一化优势（重要技巧！）</span>
        advantages = (self.advantages - np.mean(self.advantages)) / (np.std(self.advantages) + <span class="hljs-number">1e-8</span>)
        
        <span class="hljs-keyword">return</span> (
            torch.FloatTensor(self.states[:self.ptr]),
            torch.LongTensor(self.actions[:self.ptr]),
            torch.FloatTensor(self.logprobs[:self.ptr]),
            torch.FloatTensor(self.returns[:self.ptr]),
            torch.FloatTensor(advantages),
        )
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">clear</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""清空缓冲区"""</span>
        self.ptr = <span class="hljs-number">0</span>
        self.path_start_idx = <span class="hljs-number">0</span>
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">hasattr</span>(self, <span class="hljs-string">'advantages'</span>):
            <span class="hljs-keyword">del</span> self.advantages
            <span class="hljs-keyword">del</span> self.returns


<span class="hljs-keyword">class</span> <span class="hljs-title class_">PPOAgent</span>:
    <span class="hljs-string">"""PPO智能体：真正的调酒师"""</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, env_name=<span class="hljs-string">"CartPole-v1"</span>, 
                 hidden_dim=<span class="hljs-number">64</span>, 
                 lr=<span class="hljs-number">3e-4</span>,
                 gamma=<span class="hljs-number">0.99</span>,
                 gae_lambda=<span class="hljs-number">0.95</span>,
                 clip_epsilon=<span class="hljs-number">0.2</span>,
                 ppo_epochs=<span class="hljs-number">10</span>,
                 batch_size=<span class="hljs-number">64</span></span>):
        
        <span class="hljs-comment"># 创建环境</span>
        self.env = gym.make(env_name)
        self.state_dim = self.env.observation_space.shape[<span class="hljs-number">0</span>]
        self.action_dim = self.env.action_space.n
        
        <span class="hljs-comment"># 初始化网络</span>
        self.policy = ActorCriticNetwork(self.state_dim, self.action_dim, hidden_dim)
        self.optimizer = optim.Adam(self.policy.parameters(), lr=lr)
        
        <span class="hljs-comment"># PPO超参数</span>
        self.gamma = gamma
        self.gae_lambda = gae_lambda
        self.clip_epsilon = clip_epsilon
        self.ppo_epochs = ppo_epochs
        self.batch_size = batch_size
        
        <span class="hljs-comment"># 经验缓冲区</span>
        self.buffer = PPOBuffer(self.state_dim, buffer_size=<span class="hljs-number">2048</span>, 
                                gamma=gamma, gae_lambda=gae_lambda)
        
        <span class="hljs-comment"># 记录器</span>
        self.episode_rewards = []
        self.episode_lengths = []
        
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">collect_experience</span>(<span class="hljs-params">self, max_steps=<span class="hljs-number">1000</span></span>):
        <span class="hljs-string">"""收集经验数据：让AI在环境中玩耍"""</span>
        state, _ = self.env.reset()
        episode_reward = <span class="hljs-number">0</span>
        episode_length = <span class="hljs-number">0</span>
        
        <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(max_steps):
            state_tensor = torch.FloatTensor(state).unsqueeze(<span class="hljs-number">0</span>)
            
            <span class="hljs-comment"># 选择动作</span>
            action = self.policy.act(state_tensor)
            
            <span class="hljs-comment"># 与环境交互</span>
            next_state, reward, terminated, truncated, _ = self.env.step(action)
            done = terminated <span class="hljs-keyword">or</span> truncated
            
            <span class="hljs-comment"># 评估当前状态-动作对</span>
            <span class="hljs-keyword">with</span> torch.no_grad():
                action_tensor = torch.LongTensor([action])
                logprob, value, _ = self.policy.evaluate(state_tensor, action_tensor)
            
            <span class="hljs-comment"># 存储经验</span>
            self.buffer.store(state, action, reward, done, 
                             value.item(), logprob.item())
            
            state = next_state
            episode_reward += reward
            episode_length += <span class="hljs-number">1</span>
            
            <span class="hljs-keyword">if</span> done:
                <span class="hljs-comment"># 处理回合结束</span>
                <span class="hljs-keyword">with</span> torch.no_grad():
                    next_state_tensor = torch.FloatTensor(next_state).unsqueeze(<span class="hljs-number">0</span>)
                    _, next_value, _ = self.policy.evaluate(next_state_tensor, 
                                                           torch.LongTensor([<span class="hljs-number">0</span>]))
                self.buffer.finish_path(next_value.item())
                
                <span class="hljs-comment"># 记录回合信息</span>
                self.episode_rewards.append(episode_reward)
                self.episode_lengths.append(episode_length)
                
                <span class="hljs-comment"># 重置环境</span>
                state, _ = self.env.reset()
                episode_reward = <span class="hljs-number">0</span>
                episode_length = <span class="hljs-number">0</span>
                
                <span class="hljs-keyword">if</span> self.buffer.ptr &gt;= self.buffer.buffer_size:
                    <span class="hljs-keyword">break</span>
        
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">update_policy</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""PPO的核心：用收集的经验更新策略"""</span>
        <span class="hljs-comment"># 获取所有数据</span>
        states, actions, old_logprobs, returns, advantages = self.buffer.get()
        
        <span class="hljs-comment"># 多次更新（PPO的关键：重复利用数据）</span>
        <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(self.ppo_epochs):
            <span class="hljs-comment"># 打乱数据顺序</span>
            indices = np.arange(<span class="hljs-built_in">len</span>(states))
            np.random.shuffle(indices)
            
            <span class="hljs-comment"># 小批量更新</span>
            <span class="hljs-keyword">for</span> start <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, <span class="hljs-built_in">len</span>(states), self.batch_size):
                end = start + self.batch_size
                batch_indices = indices[start:end]
                
                <span class="hljs-comment"># 获取批次数据</span>
                batch_states = states[batch_indices]
                batch_actions = actions[batch_indices]
                batch_old_logprobs = old_logprobs[batch_indices]
                batch_returns = returns[batch_indices]
                batch_advantages = advantages[batch_indices]
                
                <span class="hljs-comment"># 评估当前策略</span>
                new_logprobs, state_values, dist_entropy = self.policy.evaluate(
                    batch_states, batch_actions
                )
                
                <span class="hljs-comment"># 计算比率（新旧策略概率比）</span>
                ratios = torch.exp(new_logprobs - batch_old_logprobs)
                
                <span class="hljs-comment"># PPO的Clip目标函数</span>
                surr1 = ratios * batch_advantages
                surr2 = torch.clamp(ratios, <span class="hljs-number">1</span> - self.clip_epsilon, 
                                   <span class="hljs-number">1</span> + self.clip_epsilon) * batch_advantages
                
                <span class="hljs-comment"># 演员损失（策略损失）</span>
                actor_loss = -torch.<span class="hljs-built_in">min</span>(surr1, surr2).mean()
                
                <span class="hljs-comment"># 评论家损失（价值损失）</span>
                critic_loss = nn.MSELoss()(state_values.squeeze(), batch_returns)
                
                <span class="hljs-comment"># 总损失（加上熵正则项鼓励探索）</span>
                entropy_coeff = <span class="hljs-number">0.01</span>
                total_loss = actor_loss + <span class="hljs-number">0.5</span> * critic_loss - entropy_coeff * dist_entropy.mean()
                
                <span class="hljs-comment"># 反向传播</span>
                self.optimizer.zero_grad()
                total_loss.backward()
                
                <span class="hljs-comment"># 梯度裁剪（防止梯度爆炸）</span>
                torch.nn.utils.clip_grad_norm_(self.policy.parameters(), <span class="hljs-number">0.5</span>)
                
                self.optimizer.step()
        
        <span class="hljs-comment"># 清空缓冲区</span>
        self.buffer.clear()
        
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">train</span>(<span class="hljs-params">self, total_timesteps=<span class="hljs-number">100000</span></span>):
        <span class="hljs-string">"""训练主循环"""</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"开始PPO训练！"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"状态维度: <span class="hljs-subst">{self.state_dim}</span>, 动作维度: <span class="hljs-subst">{self.action_dim}</span>"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"="</span>*<span class="hljs-number">50</span>)
        
        timestep = <span class="hljs-number">0</span>
        episode = <span class="hljs-number">0</span>
        
        <span class="hljs-keyword">with</span> tqdm(total=total_timesteps, desc=<span class="hljs-string">"训练进度"</span>) <span class="hljs-keyword">as</span> pbar:
            <span class="hljs-keyword">while</span> timestep &lt; total_timesteps:
                <span class="hljs-comment"># 收集经验</span>
                self.collect_experience()
                timestep += self.buffer.ptr
                
                <span class="hljs-comment"># 更新策略</span>
                self.update_policy()
                
                <span class="hljs-comment"># 更新进度条</span>
                <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(self.episode_rewards) &gt; <span class="hljs-number">0</span>:
                    avg_reward = np.mean(self.episode_rewards[-<span class="hljs-number">10</span>:])  <span class="hljs-comment"># 最近10回合平均奖励</span>
                    pbar.set_postfix({
                        <span class="hljs-string">'平均奖励'</span>: <span class="hljs-string">f'<span class="hljs-subst">{avg_reward:<span class="hljs-number">.2</span>f}</span>'</span>,
                        <span class="hljs-string">'回合数'</span>: <span class="hljs-built_in">len</span>(self.episode_rewards)
                    })
                
                pbar.update(self.buffer.ptr)
                
                <span class="hljs-comment"># 每100回合评估一次</span>
                <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(self.episode_rewards) % <span class="hljs-number">100</span> == <span class="hljs-number">0</span>:
                    eval_reward = self.evaluate()
                    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n评估回合奖励: <span class="hljs-subst">{eval_reward:<span class="hljs-number">.2</span>f}</span>"</span>)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">evaluate</span>(<span class="hljs-params">self, n_episodes=<span class="hljs-number">5</span>, render=<span class="hljs-literal">False</span></span>):
        <span class="hljs-string">"""评估训练好的策略"""</span>
        total_rewards = []
        
        <span class="hljs-keyword">for</span> episode <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(n_episodes):
            state, _ = self.env.reset()
            episode_reward = <span class="hljs-number">0</span>
            done = <span class="hljs-literal">False</span>
            
            <span class="hljs-keyword">while</span> <span class="hljs-keyword">not</span> done:
                <span class="hljs-keyword">if</span> render <span class="hljs-keyword">and</span> episode == <span class="hljs-number">0</span>:
                    self.env.render()
                    
                state_tensor = torch.FloatTensor(state).unsqueeze(<span class="hljs-number">0</span>)
                action = self.policy.act(state_tensor, deterministic=<span class="hljs-literal">True</span>)
                
                next_state, reward, terminated, truncated, _ = self.env.step(action)
                done = terminated <span class="hljs-keyword">or</span> truncated
                
                state = next_state
                episode_reward += reward
                
            total_rewards.append(episode_reward)
        
        <span class="hljs-keyword">return</span> np.mean(total_rewards)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">plot_training_progress</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""可视化训练过程"""</span>
        fig, axes = plt.subplots(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, figsize=(<span class="hljs-number">12</span>, <span class="hljs-number">4</span>))
        
        <span class="hljs-comment"># 奖励曲线</span>
        axes[<span class="hljs-number">0</span>].plot(self.episode_rewards, alpha=<span class="hljs-number">0.6</span>)
        axes[<span class="hljs-number">0</span>].set_xlabel(<span class="hljs-string">'回合数'</span>)
        axes[<span class="hljs-number">0</span>].set_ylabel(<span class="hljs-string">'回合奖励'</span>)
        axes[<span class="hljs-number">0</span>].set_title(<span class="hljs-string">'训练奖励曲线'</span>)
        axes[<span class="hljs-number">0</span>].grid(<span class="hljs-literal">True</span>, alpha=<span class="hljs-number">0.3</span>)
        
        <span class="hljs-comment"># 滑动平均奖励</span>
        window_size = <span class="hljs-number">50</span>
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(self.episode_rewards) &gt;= window_size:
            moving_avg = np.convolve(self.episode_rewards, 
                                    np.ones(window_size)/window_size, 
                                    mode=<span class="hljs-string">'valid'</span>)
            axes[<span class="hljs-number">0</span>].plot(<span class="hljs-built_in">range</span>(window_size-<span class="hljs-number">1</span>, <span class="hljs-built_in">len</span>(self.episode_rewards)), 
                        moving_avg, <span class="hljs-string">'r-'</span>, linewidth=<span class="hljs-number">2</span>, label=<span class="hljs-string">f'<span class="hljs-subst">{window_size}</span>回合平均'</span>)
            axes[<span class="hljs-number">0</span>].legend()
        
        <span class="hljs-comment"># 回合长度分布</span>
        axes[<span class="hljs-number">1</span>].hist(self.episode_lengths, bins=<span class="hljs-number">30</span>, alpha=<span class="hljs-number">0.7</span>, color=<span class="hljs-string">'skyblue'</span>)
        axes[<span class="hljs-number">1</span>].set_xlabel(<span class="hljs-string">'回合长度'</span>)
        axes[<span class="hljs-number">1</span>].set_ylabel(<span class="hljs-string">'频次'</span>)
        axes[<span class="hljs-number">1</span>].set_title(<span class="hljs-string">'回合长度分布'</span>)
        axes[<span class="hljs-number">1</span>].grid(<span class="hljs-literal">True</span>, alpha=<span class="hljs-number">0.3</span>)
        
        plt.tight_layout()
        plt.show()


<span class="hljs-comment"># 让我们开始训练吧！</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():
    <span class="hljs-comment"># 初始化PPO智能体</span>
    agent = PPOAgent(
        env_name=<span class="hljs-string">"CartPole-v1"</span>,
        hidden_dim=<span class="hljs-number">64</span>,
        lr=<span class="hljs-number">3e-4</span>,
        clip_epsilon=<span class="hljs-number">0.2</span>,
        ppo_epochs=<span class="hljs-number">10</span>,
        batch_size=<span class="hljs-number">64</span>
    )
    
    <span class="hljs-comment"># 训练</span>
    agent.train(total_timesteps=<span class="hljs-number">50000</span>)
    
    <span class="hljs-comment"># 可视化训练结果</span>
    agent.plot_training_progress()
    
    <span class="hljs-comment"># 最终评估</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n"</span> + <span class="hljs-string">"="</span>*<span class="hljs-number">50</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"最终评估结果："</span>)
    eval_reward = agent.evaluate(n_episodes=<span class="hljs-number">10</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"平均评估奖励: <span class="hljs-subst">{eval_reward:<span class="hljs-number">.2</span>f}</span>"</span>)
    
    <span class="hljs-comment"># 展示AI的表演</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n观看AI的表演（按任意键退出）..."</span>)
    agent.evaluate(n_episodes=<span class="hljs-number">3</span>, render=<span class="hljs-literal">True</span>)
    
    <span class="hljs-keyword">return</span> agent

<span class="hljs-comment"># 运行主函数</span>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    trained_agent = main()
</code></pre>
<h3 data-id="heading-7">第三章：PPO原理深度剖析——数学不复杂，就是有点“绕”</h3>
<h4 data-id="heading-8">3.1 核心思想：策略更新的“安全带”</h4>
<p>PPO的核心公式其实很简单：</p>
<pre><code class="hljs language-python" lang="python">L(θ) = E[<span class="hljs-built_in">min</span>(
    r(θ) * A,          <span class="hljs-comment"># 原始目标</span>
    clip(r(θ), <span class="hljs-number">1</span>-ε, <span class="hljs-number">1</span>+ε) * A  <span class="hljs-comment"># 裁剪后目标</span>
)]
</code></pre>
<p>其中：</p>
<ul>
<li><code>r(θ) = π_θ(a|s) / π_θ_old(a|s)</code> 是新旧策略的概率比</li>
<li><code>A</code> 是优势函数（这个动作比平均水平好多少）</li>
<li><code>ε</code> 是裁剪参数（通常0.1~0.3）</li>
</ul>
<p><strong>通俗理解</strong>：</p>
<blockquote>
<p>想象你在教AI打篮球：</p>
<ol>
<li>如果某个动作让投篮命中率从30%提到60%（r=2.0，A为正），我们想多用它</li>
<li>但如果变化太大（比如r&gt;1.2），我们怕AI"动作变形"，就按住它："别太夸张，最多比原来多用20%"</li>
<li>如果某个动作让命中率下降（A为负），我们想少用它</li>
<li>但如果变化太大（比如r&lt;0.8），我们也按住："别完全不用啊，至少保留80%"</li>
</ol>
</blockquote>
<h4 data-id="heading-9">3.2 PPO的两个变体：CLIP vs KL散度</h4>
<p>PPO有两种实现方式，就像两种不同的"安全带"：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 变体1：PPO-CLIP（最常用的）</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">ppo_clip_loss</span>(<span class="hljs-params">new_logprob, old_logprob, advantage, epsilon=<span class="hljs-number">0.2</span></span>):
    ratio = torch.exp(new_logprob - old_logprob)  <span class="hljs-comment"># r(θ)</span>
    
    <span class="hljs-comment"># 裁剪目标</span>
    surr1 = ratio * advantage
    surr2 = torch.clamp(ratio, <span class="hljs-number">1</span>-epsilon, <span class="hljs-number">1</span>+epsilon) * advantage
    
    <span class="hljs-keyword">return</span> -torch.<span class="hljs-built_in">min</span>(surr1, surr2).mean()  <span class="hljs-comment"># 取负号因为我们要最大化</span>

<span class="hljs-comment"># 变体2：PPO-Penalty（自适应KL散度）</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">ppo_kl_loss</span>(<span class="hljs-params">new_logprob, old_logprob, advantage, kl_div, beta=<span class="hljs-number">0.5</span>, target_kl=<span class="hljs-number">0.01</span></span>):
    ratio = torch.exp(new_logprob - old_logprob)
    surr = ratio * advantage
    
    <span class="hljs-comment"># 自适应调整β</span>
    <span class="hljs-keyword">if</span> kl_div &gt; <span class="hljs-number">1.5</span> * target_kl:
        beta *= <span class="hljs-number">2</span>
    <span class="hljs-keyword">elif</span> kl_div &lt; target_kl / <span class="hljs-number">1.5</span>:
        beta /= <span class="hljs-number">2</span>
    
    <span class="hljs-keyword">return</span> -surr.mean() + beta * kl_div
</code></pre>
<h4 data-id="heading-10">3.3 GAE（广义优势估计）：PPO的"时光机"</h4>
<p>GAE的巧妙之处在于它平衡了"偏差"和"方差"：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">compute_gae</span>(<span class="hljs-params">rewards, values, dones, gamma=<span class="hljs-number">0.99</span>, gae_lambda=<span class="hljs-number">0.95</span></span>):
    <span class="hljs-string">"""计算广义优势估计"""</span>
    advantages = np.zeros_like(rewards)
    last_advantage = <span class="hljs-number">0</span>
    
    <span class="hljs-comment"># 从后往前计算</span>
    <span class="hljs-keyword">for</span> t <span class="hljs-keyword">in</span> <span class="hljs-built_in">reversed</span>(<span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(rewards))):
        <span class="hljs-keyword">if</span> t == <span class="hljs-built_in">len</span>(rewards) - <span class="hljs-number">1</span>:
            next_value = <span class="hljs-number">0</span>  <span class="hljs-comment"># 终止状态的价值为0</span>
        <span class="hljs-keyword">else</span>:
            next_value = values[t+<span class="hljs-number">1</span>] * (<span class="hljs-number">1</span> - dones[t])
        
        <span class="hljs-comment"># TD误差</span>
        delta = rewards[t] + gamma * next_value - values[t]
        
        <span class="hljs-comment"># GAE公式</span>
        advantages[t] = delta + gamma * gae_lambda * (<span class="hljs-number">1</span> - dones[t]) * last_advantage
        last_advantage = advantages[t]
    
    <span class="hljs-keyword">return</span> advantages
</code></pre>
<p><strong>通俗理解</strong>：</p>
<blockquote>
<p>GAE就像看电影时：</p>
<ul>
<li>λ=0：只看下一帧的预告（高偏差，低方差）</li>
<li>λ=1：直接看大结局（低偏差，高方差）</li>
<li>λ=0.95：看10分钟预告片再猜结局（平衡的艺术）</li>
</ul>
</blockquote>
<h3 data-id="heading-11">第四章：PPO vs 其他算法——强化学习"华山论剑"</h3>
<h4 data-id="heading-12">4.1 算法对比表</h4>















































<table><thead><tr><th>算法</th><th>优点</th><th>缺点</th><th>适用场景</th></tr></thead><tbody><tr><td><strong>PPO</strong></td><td>稳定、简单、样本效率高</td><td>超参数敏感、收敛可能慢</td><td>连续/离散动作、复杂环境</td></tr><tr><td><strong>DQN</strong></td><td>价值估计准确、理论成熟</td><td>只能处理离散动作、过估计问题</td><td>雅达利游戏、离散决策</td></tr><tr><td><strong>A2C/A3C</strong></td><td>并行效率高、实现简单</td><td>稳定性较差、需要精细调参</td><td>并行环境、简单任务</td></tr><tr><td><strong>TRPO</strong></td><td>理论保证、非常稳定</td><td>计算复杂、实现困难</td><td>学术研究、高安全性需求</td></tr><tr><td><strong>SAC</strong></td><td>自动调温度参数、探索性强</td><td>实现复杂、超参数多</td><td>连续控制、需要大量探索</td></tr><tr><td><strong>DDPG</strong></td><td>适用于连续动作</td><td>对超参数敏感、训练不稳定</td><td>机器人控制、连续动作空间</td></tr></tbody></table>
<h4 data-id="heading-13">4.2 PPO的"杀手锏"：Clipping机制的妙处</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 让我们可视化一下Clipping机制</span>
<span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt
<span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np

<span class="hljs-keyword">def</span> <span class="hljs-title function_">visualize_clipping</span>():
    advantages = np.linspace(-<span class="hljs-number">2</span>, <span class="hljs-number">2</span>, <span class="hljs-number">100</span>)
    ratios = np.linspace(<span class="hljs-number">0.5</span>, <span class="hljs-number">1.5</span>, <span class="hljs-number">100</span>)
    R, A = np.meshgrid(ratios, advantages)
    
    <span class="hljs-comment"># PPO-CLIP目标</span>
    epsilon = <span class="hljs-number">0.2</span>
    surr1 = R * A
    surr2 = np.clip(R, <span class="hljs-number">1</span>-epsilon, <span class="hljs-number">1</span>+epsilon) * A
    L = np.minimum(surr1, surr2)
    
    <span class="hljs-comment"># 绘图</span>
    fig = plt.figure(figsize=(<span class="hljs-number">12</span>, <span class="hljs-number">4</span>))
    
    <span class="hljs-comment"># 原始目标</span>
    ax1 = fig.add_subplot(<span class="hljs-number">131</span>, projection=<span class="hljs-string">'3d'</span>)
    ax1.plot_surface(R, A, surr1, cmap=<span class="hljs-string">'viridis'</span>, alpha=<span class="hljs-number">0.8</span>)
    ax1.set_title(<span class="hljs-string">'原始目标: r(θ)·A'</span>)
    ax1.set_xlabel(<span class="hljs-string">'概率比 r(θ)'</span>)
    ax1.set_ylabel(<span class="hljs-string">'优势 A'</span>)
    
    <span class="hljs-comment"># 裁剪目标</span>
    ax2 = fig.add_subplot(<span class="hljs-number">132</span>, projection=<span class="hljs-string">'3d'</span>)
    ax2.plot_surface(R, A, surr2, cmap=<span class="hljs-string">'plasma'</span>, alpha=<span class="hljs-number">0.8</span>)
    ax2.set_title(<span class="hljs-string">'裁剪目标: clip(r(θ))·A'</span>)
    ax2.set_xlabel(<span class="hljs-string">'概率比 r(θ)'</span>)
    
    <span class="hljs-comment"># PPO最终目标</span>
    ax3 = fig.add_subplot(<span class="hljs-number">133</span>, projection=<span class="hljs-string">'3d'</span>)
    ax3.plot_surface(R, A, L, cmap=<span class="hljs-string">'coolwarm'</span>, alpha=<span class="hljs-number">0.8</span>)
    ax3.set_title(<span class="hljs-string">'PPO目标: min(原始, 裁剪)'</span>)
    ax3.set_xlabel(<span class="hljs-string">'概率比 r(θ)'</span>)
    
    plt.suptitle(<span class="hljs-string">'PPO Clipping机制可视化'</span>, fontsize=<span class="hljs-number">14</span>, fontweight=<span class="hljs-string">'bold'</span>)
    plt.tight_layout()
    plt.show()

<span class="hljs-comment"># visualize_clipping()  # 运行可以看到漂亮的可视化</span>
</code></pre>
<h3 data-id="heading-14">第五章：PPO避坑指南——那些年我踩过的坑</h3>
<h4 data-id="heading-15">5.1 超参数调试的"玄学"</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">PPOHyperparameterTuner</span>:
    <span class="hljs-string">"""PPO超参数调试指南"""</span>
    
<span class="hljs-meta">    @staticmethod</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">common_pitfalls</span>():
        pitfalls = {
            <span class="hljs-string">'学习率太高'</span>: {
                <span class="hljs-string">'症状'</span>: <span class="hljs-string">'奖励剧烈震荡，策略崩溃'</span>,
                <span class="hljs-string">'解决方案'</span>: <span class="hljs-string">'从3e-4开始，逐渐减小'</span>,
                <span class="hljs-string">'代码'</span>: <span class="hljs-string">'lr=3e-4 → 1e-4 → 3e-5'</span>
            },
            <span class="hljs-string">'裁剪系数太大'</span>: {
                <span class="hljs-string">'症状'</span>: <span class="hljs-string">'学习缓慢，策略更新保守'</span>,
                <span class="hljs-string">'解决方案'</span>: <span class="hljs-string">'ε通常设为0.1~0.3'</span>,
                <span class="hljs-string">'代码'</span>: <span class="hljs-string">'clip_epsilon=0.2'</span>
            },
            <span class="hljs-string">'GAE λ不合适'</span>: {
                <span class="hljs-string">'症状'</span>: <span class="hljs-string">'优势估计偏差大或方差大'</span>,
                <span class="hljs-string">'解决方案'</span>: <span class="hljs-string">'通常设为0.9~0.99'</span>,
                <span class="hljs-string">'代码'</span>: <span class="hljs-string">'gae_lambda=0.95'</span>
            },
            <span class="hljs-string">'批次太小'</span>: {
                <span class="hljs-string">'症状'</span>: <span class="hljs-string">'训练不稳定，方差大'</span>,
                <span class="hljs-string">'解决方案'</span>: <span class="hljs-string">'增加批次大小到64~256'</span>,
                <span class="hljs-string">'代码'</span>: <span class="hljs-string">'batch_size=64'</span>
            },
            <span class="hljs-string">'熵系数太大'</span>: {
                <span class="hljs-string">'症状'</span>: <span class="hljs-string">'过度探索，策略不收敛'</span>,
                <span class="hljs-string">'解决方案'</span>: <span class="hljs-string">'逐渐减小熵系数'</span>,
                <span class="hljs-string">'代码'</span>: <span class="hljs-string">'entropy_coeff=0.01 → 0.001'</span>
            }
        }
        <span class="hljs-keyword">return</span> pitfalls
    
<span class="hljs-meta">    @staticmethod</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">recommended_configs</span>(<span class="hljs-params">env_type</span>):
        <span class="hljs-string">"""不同环境类型的推荐配置"""</span>
        configs = {
            <span class="hljs-string">'离散动作简单环境'</span>: {  <span class="hljs-comment"># 如CartPole, LunarLander</span>
                <span class="hljs-string">'lr'</span>: <span class="hljs-number">3e-4</span>,
                <span class="hljs-string">'clip_epsilon'</span>: <span class="hljs-number">0.2</span>,
                <span class="hljs-string">'gamma'</span>: <span class="hljs-number">0.99</span>,
                <span class="hljs-string">'gae_lambda'</span>: <span class="hljs-number">0.95</span>,
                <span class="hljs-string">'ppo_epochs'</span>: <span class="hljs-number">10</span>,
                <span class="hljs-string">'batch_size'</span>: <span class="hljs-number">64</span>,
                <span class="hljs-string">'hidden_dim'</span>: <span class="hljs-number">64</span>
            },
            <span class="hljs-string">'连续动作物理控制'</span>: {  <span class="hljs-comment"># 如MuJoCo, PyBullet</span>
                <span class="hljs-string">'lr'</span>: <span class="hljs-number">3e-4</span>,
                <span class="hljs-string">'clip_epsilon'</span>: <span class="hljs-number">0.2</span>,
                <span class="hljs-string">'gamma'</span>: <span class="hljs-number">0.99</span>,
                <span class="hljs-string">'gae_lambda'</span>: <span class="hljs-number">0.95</span>,
                <span class="hljs-string">'ppo_epochs'</span>: <span class="hljs-number">10</span>,
                <span class="hljs-string">'batch_size'</span>: <span class="hljs-number">256</span>,
                <span class="hljs-string">'hidden_dim'</span>: <span class="hljs-number">256</span>
            },
            <span class="hljs-string">'视觉输入环境'</span>: {  <span class="hljs-comment"># 如Atari</span>
                <span class="hljs-string">'lr'</span>: <span class="hljs-number">2.5e-4</span>,
                <span class="hljs-string">'clip_epsilon'</span>: <span class="hljs-number">0.1</span>,
                <span class="hljs-string">'gamma'</span>: <span class="hljs-number">0.99</span>,
                <span class="hljs-string">'gae_lambda'</span>: <span class="hljs-number">0.95</span>,
                <span class="hljs-string">'ppo_epochs'</span>: <span class="hljs-number">4</span>,
                <span class="hljs-string">'batch_size'</span>: <span class="hljs-number">256</span>,
                <span class="hljs-string">'hidden_dim'</span>: <span class="hljs-number">512</span>,
                <span class="hljs-string">'备注'</span>: <span class="hljs-string">'需要CNN处理图像'</span>
            }
        }
        <span class="hljs-keyword">return</span> configs.get(env_type, configs[<span class="hljs-string">'离散动作简单环境'</span>])
</code></pre>
<h4 data-id="heading-16">5.2 调试技巧：当PPO不工作时</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">ppo_debug_checklist</span>(<span class="hljs-params">agent, env</span>):
    <span class="hljs-string">"""PPO调试清单"""</span>
    checklist = []
    
    <span class="hljs-comment"># 1. 检查奖励缩放</span>
    rewards = []
    <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">10</span>):
        state, _ = env.reset()
        done = <span class="hljs-literal">False</span>
        <span class="hljs-keyword">while</span> <span class="hljs-keyword">not</span> done:
            action = agent.policy.act(torch.FloatTensor(state).unsqueeze(<span class="hljs-number">0</span>))
            state, reward, terminated, truncated, _ = env.step(action)
            done = terminated <span class="hljs-keyword">or</span> truncated
            rewards.append(reward)
    
    avg_reward = np.mean(rewards)
    <span class="hljs-keyword">if</span> avg_reward &lt; -<span class="hljs-number">10</span> <span class="hljs-keyword">or</span> avg_reward &gt; <span class="hljs-number">10</span>:
        checklist.append(<span class="hljs-string">f"⚠️ 奖励范围过大(<span class="hljs-subst">{avg_reward:<span class="hljs-number">.2</span>f}</span>)，建议缩放奖励"</span>)
    
    <span class="hljs-comment"># 2. 检查梯度</span>
    <span class="hljs-keyword">for</span> name, param <span class="hljs-keyword">in</span> agent.policy.named_parameters():
        <span class="hljs-keyword">if</span> param.grad <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:
            grad_norm = param.grad.norm().item()
            <span class="hljs-keyword">if</span> grad_norm &gt; <span class="hljs-number">100</span>:
                checklist.append(<span class="hljs-string">f"⚠️ 梯度爆炸: <span class="hljs-subst">{name}</span>的梯度范数为<span class="hljs-subst">{grad_norm:<span class="hljs-number">.2</span>f}</span>"</span>)
            <span class="hljs-keyword">elif</span> grad_norm &lt; <span class="hljs-number">1e-6</span>:
                checklist.append(<span class="hljs-string">f"⚠️ 梯度消失: <span class="hljs-subst">{name}</span>的梯度范数为<span class="hljs-subst">{grad_norm:<span class="hljs-number">.2</span>e}</span>"</span>)
    
    <span class="hljs-comment"># 3. 检查探索率</span>
    entropies = []
    states = torch.randn(<span class="hljs-number">100</span>, agent.state_dim)
    <span class="hljs-keyword">with</span> torch.no_grad():
        <span class="hljs-keyword">for</span> state <span class="hljs-keyword">in</span> states:
            probs, _ = agent.policy(state.unsqueeze(<span class="hljs-number">0</span>))
            dist = torch.distributions.Categorical(probs)
            entropies.append(dist.entropy().item())
    
    avg_entropy = np.mean(entropies)
    max_entropy = np.log(agent.action_dim)  <span class="hljs-comment"># 最大熵</span>
    
    <span class="hljs-keyword">if</span> avg_entropy &lt; <span class="hljs-number">0.1</span> * max_entropy:
        checklist.append(<span class="hljs-string">f"⚠️ 探索不足: 熵(<span class="hljs-subst">{avg_entropy:<span class="hljs-number">.3</span>f}</span>) &lt; 10%最大熵(<span class="hljs-subst">{max_entropy:<span class="hljs-number">.3</span>f}</span>)"</span>)
    
    <span class="hljs-keyword">return</span> checklist
</code></pre>
<h3 data-id="heading-17">第六章：PPO最佳实践——从"能用"到"好用"</h3>
<h4 data-id="heading-18">6.1 高级技巧：让PPO飞得更高</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">AdvancedPPO</span>(<span class="hljs-title class_ inherited__">PPOAgent</span>):
    <span class="hljs-string">"""增强版PPO，包含多种高级技巧"""</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, *args, **kwargs</span>):
        <span class="hljs-built_in">super</span>().__init__(*args, **kwargs)
        
        <span class="hljs-comment"># 添加学习率调度器</span>
        self.scheduler = optim.lr_scheduler.LambdaLR(
            self.optimizer,
            lr_lambda=<span class="hljs-keyword">lambda</span> epoch: <span class="hljs-number">0.999</span> ** epoch  <span class="hljs-comment"># 逐渐衰减</span>
        )
        
        <span class="hljs-comment"># 奖励归一化</span>
        self.reward_normalizer = RunningMeanStd(shape=())
        
        <span class="hljs-comment"># 状态归一化</span>
        self.state_normalizer = RunningMeanStd(shape=self.state_dim)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">normalize_state</span>(<span class="hljs-params">self, state</span>):
        <span class="hljs-string">"""状态归一化"""</span>
        self.state_normalizer.update(state)
        normalized = (state - self.state_normalizer.mean) / np.sqrt(self.state_normalizer.var + <span class="hljs-number">1e-8</span>)
        <span class="hljs-keyword">return</span> normalized
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">normalize_reward</span>(<span class="hljs-params">self, reward</span>):
        <span class="hljs-string">"""奖励归一化"""</span>
        self.reward_normalizer.update(np.array([reward]))
        normalized = reward / np.sqrt(self.reward_normalizer.var + <span class="hljs-number">1e-8</span>)
        <span class="hljs-keyword">return</span> normalized
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">collect_experience</span>(<span class="hljs-params">self, max_steps=<span class="hljs-number">1000</span></span>):
        <span class="hljs-string">"""增强的经验收集，包含归一化"""</span>
        state, _ = self.env.reset()
        state = self.normalize_state(state)
        
        <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(max_steps):
            <span class="hljs-comment"># ... 与基类类似，但添加归一化 ...</span>
            reward = self.normalize_reward(reward)
            <span class="hljs-comment"># ... 其余代码 ...</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">update_policy</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""增强的策略更新，包含学习率调度"""</span>
        <span class="hljs-built_in">super</span>().update_policy()
        self.scheduler.step()  <span class="hljs-comment"># 更新学习率</span>


<span class="hljs-keyword">class</span> <span class="hljs-title class_">RunningMeanStd</span>:
    <span class="hljs-string">"""在线计算均值和标准差"""</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, shape, epsilon=<span class="hljs-number">1e-4</span></span>):
        self.mean = np.zeros(shape, dtype=np.float32)
        self.var = np.ones(shape, dtype=np.float32)
        self.count = epsilon
        
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">update</span>(<span class="hljs-params">self, x</span>):
        <span class="hljs-string">"""更新统计量"""</span>
        batch_mean = np.mean(x, axis=<span class="hljs-number">0</span>)
        batch_var = np.var(x, axis=<span class="hljs-number">0</span>)
        batch_count = x.shape[<span class="hljs-number">0</span>] <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(x.shape) &gt; <span class="hljs-number">1</span> <span class="hljs-keyword">else</span> <span class="hljs-number">1</span>
        
        <span class="hljs-comment"># 合并统计量</span>
        delta = batch_mean - self.mean
        total_count = self.count + batch_count
        
        self.mean += delta * batch_count / total_count
        self.var = (
            self.count * self.var + 
            batch_count * batch_var + 
            delta**<span class="hljs-number">2</span> * self.count * batch_count / total_count
        ) / total_count
        self.count = total_count
</code></pre>
<h4 data-id="heading-19">6.2 并行PPO：让多个CPU核心为你打工</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> multiprocessing <span class="hljs-keyword">as</span> mp
<span class="hljs-keyword">from</span> multiprocessing <span class="hljs-keyword">import</span> Process, Queue

<span class="hljs-keyword">class</span> <span class="hljs-title class_">ParallelPPO</span>:
    <span class="hljs-string">"""并行PPO实现"""</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, env_name, num_workers=<span class="hljs-number">4</span></span>):
        self.num_workers = num_workers
        self.env_name = env_name
        
        <span class="hljs-comment"># 创建共享网络</span>
        self.global_policy = ActorCriticNetwork(
            gym.make(env_name).observation_space.shape[<span class="hljs-number">0</span>],
            gym.make(env_name).action_space.n
        )
        
        <span class="hljs-comment"># 创建工作进程</span>
        self.workers = []
        self.result_queue = Queue()
        
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">worker_process</span>(<span class="hljs-params">self, worker_id, global_params, queue</span>):
        <span class="hljs-string">"""工作进程函数"""</span>
        <span class="hljs-comment"># 创建本地网络</span>
        local_policy = ActorCriticNetwork(...)
        local_policy.load_state_dict(global_params)
        
        <span class="hljs-comment"># 收集经验</span>
        buffer = self.collect_experience(local_policy)
        
        <span class="hljs-comment"># 计算梯度</span>
        gradients = self.compute_gradients(local_policy, buffer)
        
        <span class="hljs-comment"># 发送回主进程</span>
        queue.put((worker_id, gradients))
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">train_parallel</span>(<span class="hljs-params">self, total_updates=<span class="hljs-number">1000</span></span>):
        <span class="hljs-string">"""并行训练"""</span>
        <span class="hljs-keyword">for</span> update <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(total_updates):
            <span class="hljs-comment"># 启动工作进程</span>
            processes = []
            <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(self.num_workers):
                p = Process(target=self.worker_process,
                          args=(i, self.global_policy.state_dict(), self.result_queue))
                p.start()
                processes.append(p)
            
            <span class="hljs-comment"># 收集梯度</span>
            all_gradients = []
            <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(self.num_workers):
                worker_id, gradients = self.result_queue.get()
                all_gradients.append(gradients)
            
            <span class="hljs-comment"># 等待所有进程结束</span>
            <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> processes:
                p.join()
            
            <span class="hljs-comment"># 平均梯度并更新全局网络</span>
            self.apply_gradients(all_gradients)
</code></pre>
<h3 data-id="heading-20">第七章：PPO面试考点大全——准备好了吗？</h3>
<h4 data-id="heading-21">7.1 理论面试题</h4>
<p><strong>Q1：为什么PPO要使用Clipping机制？直接比率最大化不行吗？</strong></p>
<p><strong>参考答案</strong>：</p>
<blockquote>
<p>直接最大化比率r(θ)会导致策略更新过大，容易"一步踏空"。想象你在走钢丝：</p>
<ul>
<li>直接最大化：听到"左边风大"，你猛向左倾——掉下去了！</li>
<li>PPO-CLIP：听到"左边风大"，你想向左倾，但系统拉住你："最多倾20%！"——安全通过！</li>
</ul>
<p>数学上，TRPO用复杂的二阶优化保证信任域，PPO用简单的clip近似实现同样效果。</p>
</blockquote>
<p><strong>Q2：GAE中λ参数的作用是什么？λ=0和λ=1分别对应什么？</strong></p>
<p><strong>参考答案</strong>：</p>
<blockquote>
<p>λ是偏差-方差权衡的超参数：</p>
<ul>
<li>λ=0：使用TD(0)，即单步优势估计。高偏差（短视），低方差</li>
<li>λ=1：使用蒙特卡洛回报，无偏差但高方差（看完全局才判断）</li>
<li>λ=0.95：折中方案，通常效果最好</li>
</ul>
<p>就像天气预报：只看今天（λ=0）不准，看全年平均（λ=1）没意义，看未来一周（λ=0.95）最实用。</p>
</blockquote>
<p><strong>Q3：PPO中的熵正则项有什么作用？</strong></p>
<p><strong>参考答案</strong>：</p>
<blockquote>
<p>熵正则项鼓励探索，防止策略过早收敛到局部最优。可以理解为：</p>
<ol>
<li><strong>探索激励</strong>：让AI保持好奇心，尝试新动作</li>
<li><strong>避免确定性</strong>：防止输出变成one-hot，保持一定随机性</li>
<li><strong>训练稳定性</strong>：在训练初期特别重要</li>
</ol>
<p>但要注意：熵系数需要衰减，否则后期还在"瞎探索"。</p>
</blockquote>
<h4 data-id="heading-22">7.2 代码面试题</h4>
<p><strong>Q1：实现PPO中的clip损失函数</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">ppo_clip_loss</span>(<span class="hljs-params">new_logprobs, old_logprobs, advantages, epsilon=<span class="hljs-number">0.2</span></span>):
    <span class="hljs-string">"""
    实现PPO-CLIP损失函数
    
    参数:
        new_logprobs: 新策略的对数概率 [batch_size]
        old_logprobs: 旧策略的对数概率 [batch_size]
        advantages: 优势估计 [batch_size]
        epsilon: 裁剪参数
    
    返回:
        policy_loss: 策略损失（标量）
    """</span>
    <span class="hljs-comment"># 计算概率比</span>
    ratio = torch.exp(new_logprobs - old_logprobs)
    
    <span class="hljs-comment"># 两种目标</span>
    surr1 = ratio * advantages
    surr2 = torch.clamp(ratio, <span class="hljs-number">1</span> - epsilon, <span class="hljs-number">1</span> + epsilon) * advantages
    
    <span class="hljs-comment"># 取最小值并求平均</span>
    policy_loss = -torch.<span class="hljs-built_in">min</span>(surr1, surr2).mean()
    
    <span class="hljs-keyword">return</span> policy_loss
</code></pre>
<p><strong>Q2：解释下面PPO训练代码的问题</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 有问题的代码</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">train_ppo</span>():
    <span class="hljs-keyword">for</span> episode <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1000</span>):
        <span class="hljs-comment"># 收集数据</span>
        states, actions, rewards = collect_one_episode()
        
        <span class="hljs-comment"># 每个episode都更新</span>
        update_policy(states, actions, rewards)
        
    <span class="hljs-comment"># 问题：没有重要性采样，没有clip，没有GAE...</span>
</code></pre>
<p><strong>参考答案</strong>：</p>
<blockquote>
<p>这段代码有多个问题：</p>
<ol>
<li><strong>样本效率低</strong>：每个episode只更新一次</li>
<li><strong>没有重要性采样</strong>：直接用新策略梯度更新，破坏理论保证</li>
<li><strong>没有Clipping</strong>：可能导致大幅度的策略更新</li>
<li><strong>没有优势归一化</strong>：梯度可能不稳定</li>
<li><strong>没有价值函数训练</strong>：缺少评论家网络</li>
</ol>
</blockquote>
<h3 data-id="heading-23">第八章：总结——PPO的过去、现在与未来</h3>
<h4 data-id="heading-24">8.1 PPO的成功秘诀</h4>
<p>PPO之所以成为RL领域的"瑞士军刀"，是因为它：</p>
<ol>
<li><strong>简单有效</strong>：几行代码就能实现，效果却不错</li>
<li><strong>稳定可靠</strong>：相比DQN、A3C等更不容易崩溃</li>
<li><strong>通用性强</strong>：连续/离散动作、各种环境都能用</li>
<li><strong>有理论依据</strong>：虽然不是严格保证，但有TRPO的理论基础</li>
</ol>
<h4 data-id="heading-25">8.2 PPO的局限性</h4>
<p>当然，PPO也不是万能的：</p>
<ol>
<li><strong>超参数敏感</strong>：ε、λ等参数需要仔细调整</li>
<li><strong>样本效率</strong>：相比SAC等off-policy算法，样本效率较低</li>
<li><strong>探索能力</strong>：依赖熵正则，探索可能不足</li>
<li><strong>收敛速度</strong>：有时候比TRPO慢</li>
</ol>
<h4 data-id="heading-26">8.3 PPO的未来发展</h4>
<p>PPO家族还在不断进化：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># PPO的未来变体可能包括：</span>
future_ppo_variants = {
    <span class="hljs-string">'PPO-λ'</span>: <span class="hljs-string">'自动调整λ参数的自适应PPO'</span>,
    <span class="hljs-string">'PPO-M'</span>: <span class="hljs-string">'结合模型预测的PPO'</span>,
    <span class="hljs-string">'PPO-H'</span>: <span class="hljs-string">'分层PPO，解决长期信用分配'</span>,
    <span class="hljs-string">'PPO-D'</span>: <span class="hljs-string">'分布式PPO，更好处理多模态奖励'</span>,
    <span class="hljs-string">'PPO-T'</span>: <span class="hljs-string">'结合Transformer的PPO，处理长序列'</span>
}
</code></pre>
<h4 data-id="heading-27">8.4 最后的话：给RL学习者的建议</h4>
<p>学习PPO（和强化学习）就像学骑自行车：</p>
<ol>
<li><strong>先跑起来</strong>：用默认参数让代码能运行</li>
<li><strong>别怕摔跤</strong>：调试是学习的一部分</li>
<li><strong>理解原理</strong>：知道为什么clip，为什么用GAE</li>
<li><strong>动手实践</strong>：在多种环境中尝试</li>
<li><strong>持续学习</strong>：RL领域日新月异，保持好奇心</li>
</ol>
<p>记住，每个RL大牛都曾经：</p>
<ul>
<li>调参调到怀疑人生</li>
<li>看着NaN损失发呆</li>
<li>以为训练好了，结果测试时崩了</li>
<li>读论文时"我懂了"，写代码时"我是谁？"</li>
</ul>
<p>但最终，当你的AI第一次学会平衡、学会行走、学会玩游戏时，那种成就感是无与伦比的！</p>
<hr/>
<p><strong>致谢</strong>：感谢OpenAI的研究员们提出了PPO，让强化学习不再那么"劝退"。也感谢坚持读到这里的你，未来的RL专家！</p>
<p><strong>下一步行动</strong>：</p>
<ol>
<li>运行上面的代码，看看AI怎么学会平衡木</li>
<li>尝试修改参数，观察效果变化</li>
<li>应用到你自己感兴趣的环境</li>
<li>读一读PPO原论文（其实不难懂！）</li>
</ol>
<p>祝你在强化学习的道路上越走越远！🚀</p>
<blockquote>
<p>"PPO最大的优点，就是它没有明显的缺点。" —— RL社区共识</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React 从入门到出门第二章 生命周期函数与内置 Hooks 整体认知]]></title>    <link>https://juejin.cn/post/7590309337861832745</link>    <guid>https://juejin.cn/post/7590309337861832745</guid>    <pubDate>2026-01-04T00:43:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590309337861832745" data-draft-id="7589838742552789011" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React 从入门到出门第二章  生命周期函数与内置 Hooks 整体认知"/> <meta itemprop="keywords" content="前端,JavaScript,React.js"/> <meta itemprop="datePublished" content="2026-01-04T00:43:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="怕浪猫"/> <meta itemprop="url" content="https://juejin.cn/user/2832784963939438"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React 从入门到出门第二章  生命周期函数与内置 Hooks 整体认知
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2832784963939438/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    怕浪猫
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-04T00:43:54.000Z" title="Sun Jan 04 2026 00:43:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/98bd667ad2354695944a091cfccc3383~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oCV5rWq54yr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768092399&amp;x-signature=i88iIR3QvgrJ3XdKdiu%2BHmFGM2Y%3D" alt="BLAb3hgs.jpeg" loading="lazy"/>
大家好～ 上一篇我们聊了 React 19 的 JSX 增强特性和函数组件基础，今天咱们聚焦另一个核心知识点——生命周期函数与内置 Hooks。</p>
<p>很多刚接触 React 的同学会有个误区：“只有 class 组件才有生命周期”。其实在 React 19 中，函数组件通过 Hooks 完全可以实现甚至优化生命周期的逻辑，而且 Hooks 是函数组件的核心能力，所有 React 19 新特性都围绕 Hooks 展开。</p>
<p>今天这篇文章，我们就从“生命周期的本质是什么”入手，先搞懂 React 组件的核心运行流程，再逐一认识 React 19 中 8 个常用内置 Hooks（useState、useEffect、useContext、useCallback、useRef、useMemo、useDeferredValue、useTransition），结合代码示例讲清“核心作用+应用场景+使用注意”，最后用精准的图例梳理清楚 Hooks 与生命周期的对应关系，帮大家建立完整的知识框架。</p>
<h2 data-id="heading-0">一、先搞懂：生命周期的本质是“组件的运行阶段”</h2>
<p>不管是 class 组件还是函数组件，React 组件的核心运行流程都可以分为三个阶段：<strong>挂载阶段（组件第一次渲染到页面）、更新阶段（组件数据变化重新渲染）、卸载阶段（组件从页面中移除）</strong> 。</p>
<p>生命周期函数，就是 React 提供的、允许我们在组件不同运行阶段插入自定义逻辑的“钩子”。比如：</p>
<ul>
<li>挂载阶段：我们可能需要请求初始化数据、绑定事件监听；</li>
<li>更新阶段：我们可能需要根据数据变化更新 DOM 、做性能优化；</li>
<li>卸载阶段：我们可能需要清除定时器、取消事件监听，避免内存泄漏。</li>
</ul>
<h3 data-id="heading-1">React 19 中生命周期的实现方式</h3>
<p>在 React 早期，class 组件通过 <code>componentDidMount</code>、<code>componentDidUpdate</code>、<code>componentWillUnmount</code> 等生命周期方法实现上述逻辑。但在 React 19 中，函数组件+ Hooks 已经成为主流，官方也更推荐这种方式——因为 Hooks 能让逻辑复用更简单，代码更简洁。</p>
<p>下面先通过一个精准的图例，直观看看 React 19 组件的完整生命周期流程，以及函数组件中对应的 Hooks
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2a90c83f90d84fefbafa7cbbc209f723~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oCV5rWq54yr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768092399&amp;x-signature=d3%2BzP070II4mRUmTMwuXj2BnhYk%3D" alt="ogimage.png" loading="lazy"/>
从图中可以看出：useEffect 是最核心的“生命周期 Hooks”，能覆盖挂载、更新、卸载三个阶段的逻辑；而 useState、useContext 等 Hooks 则聚焦于状态管理或性能优化，为生命周期中的逻辑提供支撑。</p>
<h2 data-id="heading-2">二、React 19 8 个核心内置 Hooks 详解（核心作用+应用场景+代码示例）</h2>
<p>React 19 提供了一系列内置 Hooks，每个 Hooks 都有明确的使用场景，遵循“命名以 use 开头、只能在函数组件顶层调用”的规则。下面我们逐一讲解 8 个常用核心 Hooks，重点突出应用场景，结合实战代码说明用法。</p>
<h3 data-id="heading-3">1. useState：组件状态管理的“基石”</h3>
<p><strong>核心作用</strong>：为函数组件添加“可变化的状态”（组件内部可修改、修改后触发重新渲染的数据），是实现组件更新生命周期的基础。</p>
<p><strong>应用场景</strong>：</p>
<ul>
<li>管理组件内部的简单状态（如计数器数值、表单输入值、弹窗显示/隐藏状态）；</li>
<li>存储组件渲染所需的动态数据（如列表数据、用户信息等，可配合 useEffect 请求后更新）；</li>
<li>实现组件内部的状态联动（如根据一个状态变化同步更新另一个状态）。</li>
</ul>
<p><strong>语法</strong>：<code>const [状态变量, 状态更新函数] = useState(初始值);</code></p>
<p><strong>使用注意</strong>：状态更新是异步的，若需基于前一个状态更新，需使用函数式更新（<code>setCount(prev =&gt; prev + 1)</code>）；更新对象/数组时需遵循“不可变原则”，不能直接修改原数据。</p>
<h4 data-id="heading-4">实战案例：表单输入与弹窗控制</h4>
<pre><code class="hljs language-ini" lang="ini">import { useState } from 'react'<span class="hljs-comment">;</span>

function FormWithModal() {
  // 场景1：管理表单输入状态（用户名、密码）
  const <span class="hljs-section">[formData, setFormData]</span> = useState({ username: '', password: '' })<span class="hljs-comment">;</span>
  // 场景2：管理弹窗显示/隐藏状态
  const <span class="hljs-section">[isModalOpen, setIsModalOpen]</span> = useState(false)<span class="hljs-comment">;</span>

  const <span class="hljs-attr">handleInputChange</span> = (e) =&gt; {
    const { name, value } = e.target<span class="hljs-comment">;</span>
    // 不可变更新对象状态
    setFormData(<span class="hljs-attr">prev</span> =&gt; ({ ...prev, [name]: value }))<span class="hljs-comment">;</span>
  }<span class="hljs-comment">;</span>

  const <span class="hljs-attr">handleSubmit</span> = (e) =&gt; {
    e.preventDefault()<span class="hljs-comment">;</span>
    // 表单验证通过后打开弹窗
    if (formData.username &amp;&amp; formData.password) {
      setIsModalOpen(true)<span class="hljs-comment">;</span>
    }
  }<span class="hljs-comment">;</span>

  return (
    &lt;div&gt;
      &lt;form <span class="hljs-attr">onSubmit</span>={handleSubmit}&gt;
        &lt;input
          <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span>
          <span class="hljs-attr">name</span>=<span class="hljs-string">"username"</span>
          <span class="hljs-attr">value</span>={formData.username}
          <span class="hljs-attr">onChange</span>={handleInputChange}
          <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"请输入用户名"</span>
        /&gt;
        &lt;input
          <span class="hljs-attr">type</span>=<span class="hljs-string">"password"</span>
          <span class="hljs-attr">name</span>=<span class="hljs-string">"password"</span>
          <span class="hljs-attr">value</span>={formData.password}
          <span class="hljs-attr">onChange</span>={handleInputChange}
          <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"请输入密码"</span>
        /&gt;
        &lt;button <span class="hljs-attr">type</span>=<span class="hljs-string">"submit"</span>&gt;提交&lt;/button&gt;
      &lt;/form&gt;

      {/* 弹窗组件，根据 isModalOpen 状态显示/隐藏 */}
      {isModalOpen &amp;&amp; (
        &lt;div <span class="hljs-attr">style</span>={{ position: <span class="hljs-string">'fixed'</span>, top: <span class="hljs-string">'50%'</span>, left: <span class="hljs-string">'50%'</span>, transform: <span class="hljs-string">'translate(-50%, -50%)'</span>, border: <span class="hljs-string">'1px solid #ccc'</span>, padding: <span class="hljs-string">'20px'</span> }}&gt;
          &lt;h3&gt;提交成功！&lt;/h3&gt;
          &lt;p&gt;用户名：{formData.username}&lt;/p&gt;
          &lt;button <span class="hljs-attr">onClick</span>={() =&gt; setIsModalOpen(<span class="hljs-literal">false</span>)}&gt;关闭&lt;/button&gt;
        &lt;/div&gt;
      )}
    &lt;/div&gt;
  )<span class="hljs-comment">;</span>
}
</code></pre>
<h3 data-id="heading-5">2. useEffect：处理副作用的“万能 Hooks”</h3>
<p><strong>核心作用</strong>：处理组件的“副作用”（即不直接参与 UI 渲染的逻辑，如数据请求、事件绑定、定时器、清理资源等），覆盖 class 组件 <code>componentDidMount</code>、<code>componentDidUpdate</code>、<code>componentWillUnmount</code> 三个生命周期方法的功能。</p>
<p><strong>应用场景</strong>：</p>
<ul>
<li>挂载阶段：初始化数据请求（如页面加载时请求列表数据）、绑定全局事件（如窗口大小监听、滚动监听）；</li>
<li>更新阶段：依赖数据变化后重新请求数据（如根据用户 ID 变化请求对应用户详情）、根据状态变化更新 DOM 样式；</li>
<li>卸载阶段：清理资源（如清除定时器、取消事件监听、取消未完成的请求），避免内存泄漏。</li>
</ul>
<p><strong>语法</strong>：<code>useEffect(() =&gt; { 副作用逻辑; return () =&gt; { 清理逻辑; }; }, [依赖数组]);</code></p>
<p><strong>使用注意</strong>：依赖数组需包含副作用逻辑中使用的所有状态/变量，避免遗漏导致使用旧值；空依赖数组（<code>[]</code>）仅在挂载时执行一次，无数组则每次渲染都执行。</p>
<h4 data-id="heading-6">实战案例：数据请求+事件监听+定时器清理</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { useEffect, useState } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">DataFetchWithCleanup</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [data, setData] = <span class="hljs-title function_">useState</span>([]);
  <span class="hljs-keyword">const</span> [loading, setLoading] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">true</span>);

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// 场景1：挂载时请求数据</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">fetchData</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
      <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'https://api.example.com/list'</span>);
        <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> res.<span class="hljs-title function_">json</span>();
        <span class="hljs-title function_">setData</span>(result);
      } <span class="hljs-keyword">catch</span> (err) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'请求失败：'</span>, err);
      } <span class="hljs-keyword">finally</span> {
        <span class="hljs-title function_">setLoading</span>(<span class="hljs-literal">false</span>);
      }
    };
    <span class="hljs-title function_">fetchData</span>();

    <span class="hljs-comment">// 场景2：绑定窗口滚动监听事件</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleScroll</span> = (<span class="hljs-params"/>) =&gt; {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'滚动位置：'</span>, <span class="hljs-variable language_">window</span>.<span class="hljs-property">scrollY</span>);
    };
    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'scroll'</span>, handleScroll);

    <span class="hljs-comment">// 场景3：开启定时器</span>
    <span class="hljs-keyword">const</span> timer = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'定时器执行中...'</span>);
    }, <span class="hljs-number">1000</span>);

    <span class="hljs-comment">// 清理逻辑：卸载时执行</span>
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'scroll'</span>, handleScroll); <span class="hljs-comment">// 移除事件监听</span>
      <span class="hljs-built_in">clearInterval</span>(timer); <span class="hljs-comment">// 清除定时器</span>
      <span class="hljs-comment">// 若有未完成的请求，可在此处取消（如使用 AbortController）</span>
    };
  }, []); <span class="hljs-comment">// 空依赖，仅挂载时执行</span>

  <span class="hljs-keyword">if</span> (loading) <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>加载中...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span>
      {data.map(item =&gt; (
        <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{item.id}</span>&gt;</span>{item.name}<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
      ))}
    <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span></span>
  );
}
</code></pre>
<h3 data-id="heading-7">3. useContext：跨组件状态共享的“快捷方式”</h3>
<p><strong>核心作用</strong>：解决“组件层级过深时的 props 透传问题”（即“props drilling”），允许子组件直接获取父组件提供的共享状态，无需通过中间组件层层传递。</p>
<p><strong>应用场景</strong>：</p>
<ul>
<li>共享全局基础状态（如主题色、语言设置、用户登录状态）；</li>
<li>共享组件树内的公共状态（如表单步骤组件间的步骤状态、列表页与详情页的共享筛选条件）；</li>
<li>简化跨层级组件的通信（如爷爷组件向孙子组件传递数据，无需父组件中转）。</li>
</ul>
<p><strong>使用步骤</strong>：</p>
<ol>
<li>创建 Context：<code>const MyContext = createContext(默认值);</code>（默认值仅在无 Provider 时生效）；</li>
<li>提供 Context：用 <code>&lt;MyContext.Provider value={共享数据/方法}&gt;</code> 包裹需要共享数据的组件树；</li>
<li>消费 Context：在子组件中用 <code>useContext(MyContext)</code> 获取共享数据。</li>
</ol>
<p><strong>使用注意</strong>：useContext 适合共享“变化不频繁”的状态，若需频繁更新且涉及复杂逻辑，建议结合 useReducer 或专门的状态管理库（如 Redux Toolkit）。</p>
<h4 data-id="heading-8">实战案例：全局主题切换（多组件共享主题状态）</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { createContext, useContext, useState } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-comment">// 1. 创建主题 Context</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">ThemeContext</span> = <span class="hljs-title function_">createContext</span>(<span class="hljs-string">'light'</span>);

<span class="hljs-comment">// 2. 提供 Context 的顶层组件（如 App 或专门的 Provider 组件）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">ThemeProvider</span>(<span class="hljs-params">{ children }</span>) {
  <span class="hljs-keyword">const</span> [theme, setTheme] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">'light'</span>);

  <span class="hljs-comment">// 共享的方法：切换主题</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">toggleTheme</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-title function_">setTheme</span>(<span class="hljs-function"><span class="hljs-params">prev</span> =&gt;</span> prev === <span class="hljs-string">'light'</span> ? <span class="hljs-string">'dark'</span> : <span class="hljs-string">'light'</span>);
  };

  <span class="hljs-comment">// 向子组件提供的共享数据（状态+方法）</span>
  <span class="hljs-keyword">const</span> contextValue = { theme, toggleTheme };

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ThemeContext.Provider</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{contextValue}</span>&gt;</span>
      {children} {/* 包裹需要共享主题的所有组件 */}
    <span class="hljs-tag">&lt;/<span class="hljs-name">ThemeContext.Provider</span>&gt;</span></span>
  );
}

<span class="hljs-comment">// 3. 消费 Context 的子组件1：主题按钮（任意层级）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">ThemeToggleButton</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> { theme, toggleTheme } = <span class="hljs-title function_">useContext</span>(<span class="hljs-title class_">ThemeContext</span>);
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span>
      <span class="hljs-attr">onClick</span>=<span class="hljs-string">{toggleTheme}</span>
      <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span>
        <span class="hljs-attr">background:</span> <span class="hljs-attr">theme</span> === <span class="hljs-string">'light'</span> ? '#<span class="hljs-attr">fff</span>' <span class="hljs-attr">:</span> '#<span class="hljs-attr">333</span>',
        <span class="hljs-attr">color:</span> <span class="hljs-attr">theme</span> === <span class="hljs-string">'light'</span> ? '#<span class="hljs-attr">333</span>' <span class="hljs-attr">:</span> '#<span class="hljs-attr">fff</span>',
        <span class="hljs-attr">padding:</span> '<span class="hljs-attr">8px</span> <span class="hljs-attr">16px</span>',
        <span class="hljs-attr">border:</span> '<span class="hljs-attr">1px</span> <span class="hljs-attr">solid</span> #<span class="hljs-attr">ccc</span>'
      }}
    &gt;</span>
      切换到 {theme === 'light' ? '深色' : '浅色'} 主题
    <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>
  );
}

<span class="hljs-comment">// 4. 消费 Context 的子组件2：主题内容区（任意层级）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">ThemeContent</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> { theme } = <span class="hljs-title function_">useContext</span>(<span class="hljs-title class_">ThemeContext</span>);
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>
      <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span>
        <span class="hljs-attr">width:</span> '<span class="hljs-attr">300px</span>',
        <span class="hljs-attr">height:</span> '<span class="hljs-attr">200px</span>',
        <span class="hljs-attr">margin:</span> '<span class="hljs-attr">20px</span> <span class="hljs-attr">0</span>',
        <span class="hljs-attr">background:</span> <span class="hljs-attr">theme</span> === <span class="hljs-string">'light'</span> ? '#<span class="hljs-attr">fff</span>' <span class="hljs-attr">:</span> '#<span class="hljs-attr">333</span>',
        <span class="hljs-attr">color:</span> <span class="hljs-attr">theme</span> === <span class="hljs-string">'light'</span> ? '#<span class="hljs-attr">333</span>' <span class="hljs-attr">:</span> '#<span class="hljs-attr">fff</span>',
        <span class="hljs-attr">padding:</span> '<span class="hljs-attr">20px</span>'
      }}
    &gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>当前主题：{theme}<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>跨组件共享主题状态示例<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}

<span class="hljs-comment">// 根组件</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ThemeProvider</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">ThemeToggleButton</span> /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">ThemeContent</span> /&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">ThemeProvider</span>&gt;</span></span>
  );
}
</code></pre>
<h3 data-id="heading-9">4. useCallback：缓存函数的“性能优化工具”</h3>
<p><strong>核心作用</strong>：缓存函数引用，避免函数在组件每次渲染时重新创建，减少因函数引用变化导致的子组件不必要重渲染。</p>
<p><strong>应用场景</strong>：</p>
<ul>
<li>向子组件传递回调函数时（尤其是子组件使用 React.memo 包裹进行性能优化时）；</li>
<li>函数作为 useEffect 的依赖时（避免因函数重新创建导致 useEffect 不必要执行）；</li>
<li>高频渲染的组件中（如列表项组件，每个列表项需传递点击事件函数）。</li>
</ul>
<p><strong>语法</strong>：<code>const 缓存的函数 = useCallback(原函数, [依赖数组]);</code></p>
<p><strong>使用注意</strong>：依赖数组需包含原函数中使用的所有外部变量/状态；若函数无依赖，依赖数组可为空（<code>[]</code>）；仅在函数引用变化会导致性能问题时使用，无需过度使用。</p>
<h4 data-id="heading-10">实战案例：优化子组件重渲染</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { useState, useCallback, memo } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-comment">// 子组件：用 React.memo 包裹，仅在 props 变化时重渲染</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">Child</span> = <span class="hljs-title function_">memo</span>(<span class="hljs-function">(<span class="hljs-params">{ onClick, name }</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`<span class="hljs-subst">${name}</span> 子组件渲染了`</span>);
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{onClick}</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">margin:</span> '<span class="hljs-attr">5px</span>' }}&gt;</span>
      {name} 按钮
    <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>
  );
});

<span class="hljs-keyword">function</span> <span class="hljs-title function_">UseCallbackDemo</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);

  <span class="hljs-comment">// 未使用 useCallback：每次渲染都会重新创建函数，导致 Child 重渲染</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleNormalClick</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'普通按钮点击'</span>);
  };

  <span class="hljs-comment">// 使用 useCallback：缓存函数引用，仅依赖变化时才重新创建</span>
  <span class="hljs-keyword">const</span> handleCachedClick = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'缓存按钮点击'</span>);
  }, []); <span class="hljs-comment">// 无依赖，永久缓存</span>

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>计数：{count}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setCount(prev =&gt; prev + 1)}&gt;+1（触发父组件渲染）<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Child</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{handleNormalClick}</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"普通"</span> /&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Child</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{handleCachedClick}</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"缓存"</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<p>运行结果：点击“+1”按钮触发父组件渲染时，“普通按钮”子组件会重新渲染（因 handleNormalClick 函数重新创建），而“缓存按钮”子组件不会重新渲染（因 handleCachedClick 引用未变）。</p>
<h3 data-id="heading-11">5. useRef：获取 DOM/保存持久值的“工具 Hooks”</h3>
<p><strong>核心作用</strong>：有两个核心用途——一是获取 DOM 元素或组件实例；二是保存“持久化值”（组件重新渲染时值不重置，且修改值不会触发组件重新渲染）。</p>
<p><strong>应用场景</strong>：</p>
<ul>
<li>获取 DOM 元素：实现输入框自动聚焦、获取 DOM 尺寸/位置、操作 DOM 元素（如设置样式、触发事件）；</li>
<li>保存持久值：记录组件渲染次数、保存定时器 ID、保存前一次的状态/Props 值、存储不希望触发重新渲染的数据。</li>
</ul>
<p><strong>语法</strong>：<code>const ref 对象 = useRef(初始值);</code>（通过 <code>ref.current</code> 访问/修改值）</p>
<p><strong>使用注意</strong>：修改 <code>ref.current</code> 是同步的，但不会触发组件重新渲染；若需基于 ref 值更新 UI，需配合 useState 或 useEffect。</p>
<h4 data-id="heading-12">实战案例：输入框自动聚焦+记录渲染次数</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { useRef, useState, useEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">UseRefDemo</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);
  <span class="hljs-comment">// 场景1：获取 DOM 元素（输入框）</span>
  <span class="hljs-keyword">const</span> inputRef = <span class="hljs-title function_">useRef</span>(<span class="hljs-literal">null</span>);
  <span class="hljs-comment">// 场景2：保存持久值（渲染次数）</span>
  <span class="hljs-keyword">const</span> renderCountRef = <span class="hljs-title function_">useRef</span>(<span class="hljs-number">0</span>);

  <span class="hljs-comment">// 每次渲染后更新渲染次数（useEffect 无依赖，每次渲染都执行）</span>
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    renderCountRef.<span class="hljs-property">current</span> += <span class="hljs-number">1</span>;
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'组件渲染次数：'</span>, renderCountRef.<span class="hljs-property">current</span>);
  });

  <span class="hljs-comment">// 挂载时让输入框自动聚焦</span>
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    inputRef.<span class="hljs-property">current</span>.<span class="hljs-title function_">focus</span>();
  }, []);

  <span class="hljs-comment">// 点击按钮滚动到输入框位置</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">scrollToInput</span> = (<span class="hljs-params"/>) =&gt; {
    inputRef.<span class="hljs-property">current</span>.<span class="hljs-title function_">scrollIntoView</span>({ <span class="hljs-attr">behavior</span>: <span class="hljs-string">'smooth'</span> });
  };

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">marginTop:</span> '<span class="hljs-attr">50px</span>' }}&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>计数：{count}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>组件渲染次数：{renderCountRef.current}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setCount(prev =&gt; prev + 1)}&gt;+1（触发渲染）<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{scrollToInput}</span>&gt;</span>滚动到输入框<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>

      {/* 输入框：通过 ref 关联 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">marginTop:</span> '<span class="hljs-attr">200px</span>' }}&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">input</span>
          <span class="hljs-attr">ref</span>=<span class="hljs-string">{inputRef}</span>
          <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span>
          <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"我会自动聚焦..."</span>
          <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">width:</span> '<span class="hljs-attr">300px</span>', <span class="hljs-attr">height:</span> '<span class="hljs-attr">30px</span>' }}
        /&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<h3 data-id="heading-13">6. useMemo：缓存计算结果的“性能优化工具”</h3>
<p><strong>核心作用</strong>：缓存“昂贵计算”的结果，避免组件每次渲染时重复执行相同的复杂计算，提升组件渲染性能。</p>
<p><strong>应用场景</strong>：</p>
<ul>
<li>执行复杂计算时（如大数据量列表排序、过滤、复杂数学计算）；</li>
<li>计算结果作为 props 传递给子组件时（避免因计算结果重新创建导致子组件不必要重渲染）；</li>
<li>基于多个状态/Props 推导衍生数据时（如根据筛选条件和排序规则推导过滤后的列表）。</li>
</ul>
<p><strong>语法</strong>：<code>const 缓存的计算结果 = useMemo(() =&gt; 计算逻辑, [依赖数组]);</code></p>
<p><strong>使用注意</strong>：依赖数组需包含计算逻辑中使用的所有外部变量/状态；仅用于“昂贵计算”，简单计算无需使用（缓存本身有轻微开销）；useMemo 是“备忘录”，仅在依赖变化时重新计算。</p>
<h4 data-id="heading-14">实战案例：优化大数据量排序</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { useState, useMemo } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">UseMemoDemo</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [list, setList] = <span class="hljs-title function_">useState</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// 模拟大数据量（10000 条数据）</span>
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>({ <span class="hljs-attr">length</span>: <span class="hljs-number">10000</span> }, <span class="hljs-function">(<span class="hljs-params">_, i</span>) =&gt;</span> ({ <span class="hljs-attr">id</span>: i, <span class="hljs-attr">value</span>: <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">1000</span> }));
  });
  <span class="hljs-keyword">const</span> [sortType, setSortType] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">'asc'</span>); <span class="hljs-comment">// asc：升序，desc：降序</span>

  <span class="hljs-comment">// 场景：复杂计算（大数据量排序），用 useMemo 缓存结果</span>
  <span class="hljs-keyword">const</span> sortedList = <span class="hljs-title function_">useMemo</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'执行排序计算...'</span>);
    <span class="hljs-comment">// 模拟昂贵计算（排序 10000 条数据）</span>
    <span class="hljs-keyword">return</span> [...list].<span class="hljs-title function_">sort</span>(<span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> {
      <span class="hljs-keyword">return</span> sortType === <span class="hljs-string">'asc'</span> ? a.<span class="hljs-property">value</span> - b.<span class="hljs-property">value</span> : b.<span class="hljs-property">value</span> - a.<span class="hljs-property">value</span>;
    });
  }, [list, sortType]); <span class="hljs-comment">// 仅 list 或 sortType 变化时重新排序</span>

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setSortType(prev =&gt; prev === 'asc' ? 'desc' : 'asc')}&gt;
        切换排序（当前：{sortType === 'asc' ? '升序' : '降序'}）
      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">marginTop:</span> '<span class="hljs-attr">20px</span>' }}&gt;</span>
        {/* 仅渲染前 10 条数据，避免页面卡顿 */}
        {sortedList.slice(0, 10).map(item =&gt; (
          <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{item.id}</span>&gt;</span>ID：{item.id}，值：{item.value.toFixed(2)}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
        ))}
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<p>运行结果：首次渲染和切换排序时会执行排序计算（控制台打印“执行排序计算...”），若仅触发其他不相关状态更新（如添加一个无关计数器），sortedList 会直接使用缓存结果，不会重新排序。</p>
<h3 data-id="heading-15">7. useDeferredValue：延迟更新非紧急状态的“体验优化工具”</h3>
<p><strong>核心作用</strong>：创建一个“延迟版本”的状态，当组件有紧急更新（如输入框输入）时，优先执行紧急更新，非紧急更新延迟到紧急更新完成后再执行，避免页面卡顿，提升用户体验。</p>
<p><strong>应用场景</strong>：</p>
<ul>
<li>输入框实时搜索（输入是紧急更新，搜索结果渲染是非紧急更新，避免输入卡顿）；</li>
<li>大数据量列表实时筛选（输入筛选条件是紧急更新，筛选结果渲染是非紧急更新）；</li>
<li>任何需要“优先响应用户操作”的场景（如拖拽时的非紧急状态更新）。</li>
</ul>
<p><strong>语法</strong>：<code>const 延迟状态 = useDeferredValue(原始状态);</code></p>
<p><strong>使用注意</strong>：useDeferredValue 是“被动延迟”，依赖原始状态变化；延迟状态会“追平”原始状态，最终与原始状态一致；无需手动清理，React 会自动处理。</p>
<h4 data-id="heading-16">实战案例：输入框实时搜索（优化输入体验）</h4>
<pre><code class="hljs language-ini" lang="ini">import { useState, useDeferredValue } from 'react'<span class="hljs-comment">;</span>

// 模拟大数据量列表（10000 条数据）
const <span class="hljs-attr">mockList</span> = Array.from({ length: <span class="hljs-number">10000</span> }, (_, i) =&gt; ({
  id: i,
  name: `商品 ${i + 1} - ${Math.random().toString(36).substring(2, 6)}`
}))<span class="hljs-comment">;</span>

function DeferredValueSearch() {
  // 紧急状态：输入框输入值（优先响应）
  const <span class="hljs-section">[searchValue, setSearchValue]</span> = useState('')<span class="hljs-comment">;</span>
  // 延迟状态：搜索值的延迟版本（非紧急，等输入完成后再更新）
  const <span class="hljs-attr">deferredSearchValue</span> = useDeferredValue(searchValue)<span class="hljs-comment">;</span>

  // 根据延迟搜索值筛选列表（非紧急操作）
  const <span class="hljs-attr">filteredList</span> = mockList.filter(item =&gt; {
    return item.name.includes(deferredSearchValue)<span class="hljs-comment">;</span>
  })<span class="hljs-comment">;</span>

  return (
    &lt;div&gt;
      &lt;input
        <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span>
        <span class="hljs-attr">value</span>={searchValue}
        <span class="hljs-attr">onChange</span>={(e) =&gt; setSearchValue(e.target.value)}
        <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"输入关键词搜索商品..."</span>
        <span class="hljs-attr">style</span>={{ width: <span class="hljs-string">'300px'</span>, height: <span class="hljs-string">'30px'</span>, padding: <span class="hljs-string">'0 8px'</span> }}
      /&gt;
      &lt;div <span class="hljs-attr">style</span>={{ marginTop: <span class="hljs-string">'20px'</span> }}&gt;
        {filteredList.slice(0, 10).map(<span class="hljs-attr">item</span> =&gt; (
          &lt;p <span class="hljs-attr">key</span>={item.id}&gt;{item.name}&lt;/p&gt;
        ))}
        {<span class="hljs-attr">filteredList.length</span> === <span class="hljs-number">0</span> &amp;&amp; &lt;p&gt;无匹配商品&lt;/p&gt;}
      &lt;/div&gt;
    &lt;/div&gt;
  )<span class="hljs-comment">;</span>
}
</code></pre>
<p>效果说明：若不使用 useDeferredValue，输入时会实时执行筛选逻辑（10000 条数据过滤），导致输入框卡顿；使用后，输入操作优先执行，筛选逻辑延迟到输入间隙执行，输入框流畅无卡顿。</p>
<h3 data-id="heading-17">8. useTransition：标记非紧急更新的“体验优化工具”</h3>
<p><strong>核心作用</strong>：将“非紧急的状态更新”标记为过渡更新，React 会优先处理紧急更新（如输入、点击等用户交互），非紧急更新在后台异步执行，避免阻塞用户操作，提升体验。</p>
<p><strong>应用场景</strong>：</p>
<ul>
<li>点击按钮触发的大数据量筛选/排序（点击是紧急操作，筛选/排序是非紧急更新）；</li>
<li>表单提交后的数据处理（提交操作是紧急的，后续数据加工是非紧急的）；</li>
<li>页面切换时的非紧急数据预加载（页面切换是紧急的，预加载数据是非紧急的）。</li>
</ul>
<p><strong>语法</strong>：<code>const [isPending, startTransition] = useTransition();</code></p>
<p>关键说明：</p>
<ul>
<li>startTransition：包裹非紧急的状态更新逻辑；</li>
<li>isPending：布尔值，标记过渡更新是否正在进行（可用于显示加载状态）。</li>
</ul>
<p><strong>使用注意</strong>：useTransition 是“主动标记”非紧急更新，需手动将更新逻辑放入 startTransition 中；过渡更新可被中断（如用户触发新的紧急更新），避免无效计算。</p>
<h4 data-id="heading-18">实战案例：按钮触发的大数据量排序（优化点击体验）</h4>
<pre><code class="hljs language-ini" lang="ini">import { useState, useTransition } from 'react'<span class="hljs-comment">;</span>

// 模拟大数据量（10000 条数据）
const <span class="hljs-attr">mockList</span> = Array.from({ length: <span class="hljs-number">10000</span> }, (_, i) =&gt; ({
  id: i,
  value: Math.random() * 1000
}))<span class="hljs-comment">;</span>

function TransitionSort() {
  const <span class="hljs-section">[list, setList]</span> = useState(mockList)<span class="hljs-comment">;</span>
  const <span class="hljs-section">[sortType, setSortType]</span> = useState('asc')<span class="hljs-comment">;</span>
  // 获取过渡更新状态（是否正在排序）和标记函数
  const <span class="hljs-section">[isPending, startTransition]</span> = useTransition()<span class="hljs-comment">;</span>

  const <span class="hljs-attr">handleSort</span> = () =&gt; {
    const <span class="hljs-attr">newSortType</span> = sortType === <span class="hljs-string">'asc'</span> ? <span class="hljs-string">'desc'</span> : <span class="hljs-string">'asc'</span><span class="hljs-comment">;</span>
    setSortType(newSortType)<span class="hljs-comment">; // 紧急更新：切换排序类型文字</span>

    // 非紧急更新：大数据量排序，标记为过渡更新
    startTransition(() =&gt; {
      const <span class="hljs-attr">sortedList</span> = [...mockList].sort((a, b) =&gt; {
        return <span class="hljs-attr">newSortType</span> === <span class="hljs-string">'asc'</span> ? a.value - b.value : b.value - a.value<span class="hljs-comment">;</span>
      })<span class="hljs-comment">;</span>
      setList(sortedList)<span class="hljs-comment">;</span>
    })<span class="hljs-comment">;</span>
  }<span class="hljs-comment">;</span>

  return (
    &lt;div&gt;
      &lt;button <span class="hljs-attr">onClick</span>={handleSort} disabled={isPending}&gt;
        {isPending ? '排序中...' : `切换排序（当前：${<span class="hljs-attr">sortType</span> === <span class="hljs-string">'asc'</span> ? <span class="hljs-string">'升序'</span> : <span class="hljs-string">'降序'</span>}）`}
      &lt;/button&gt;
      &lt;div <span class="hljs-attr">style</span>={{ marginTop: <span class="hljs-string">'20px'</span> }}&gt;
        {list.slice(0, 10).map(<span class="hljs-attr">item</span> =&gt; (
          &lt;p <span class="hljs-attr">key</span>={item.id}&gt;ID：{item.id}，值：{item.value.toFixed(<span class="hljs-number">2</span>)}&lt;/p&gt;
        ))}
      &lt;/div&gt;
    &lt;/div&gt;
  )<span class="hljs-comment">;</span>
}
</code></pre>
<p>效果说明：点击按钮后，排序类型文字（sortType）立即更新（紧急更新），排序逻辑在后台异步执行；排序过程中按钮显示“排序中...”并禁用，避免重复点击；若排序未完成时触发新的紧急操作，排序可被中断，提升整体体验。</p>
<h2 data-id="heading-19">三、React 19 生命周期与 Hooks 对应关系梳理（精准图例+核心总结）</h2>
<p>为了让大家更清晰地对应“生命周期阶段”与“ Hooks 用法”，我们用以下精准图例总结，覆盖所有核心场景：</p>
<h3 data-id="heading-20">核心总结</h3>
<ol>
<li><strong>生命周期是“阶段”，Hooks 是“实现工具”</strong> ：函数组件通过不同 Hooks 覆盖挂载、更新、卸载全阶段逻辑，其中 useEffect 是核心生命周期 Hooks，其他 Hooks 按需补充功能；</li>
<li><strong>8 个核心 Hooks 各司其职</strong>：状态管理（useState）、副作用处理（useEffect）、跨组件共享（useContext）、性能优化（useCallback、useMemo）、DOM/持久值（useRef）、体验优化（useDeferredValue、useTransition）；</li>
<li><strong>使用 Hooks 需遵循核心规则</strong>：仅在函数组件/自定义 Hooks 顶层调用，不能在条件/循环/嵌套函数中使用；命名以 use 开头；依赖数组需完整包含外部依赖；</li>
<li><strong>优化类 Hooks 避免过度使用</strong>：useCallback、useMemo、useDeferredValue、useTransition 均为优化手段，需结合实际场景使用，简单场景无需额外优化（优化本身有开销）。</li>
</ol>
<h2 data-id="heading-21">四、常见误区与避坑指南</h2>
<ul>
<li><strong>误区 1：过度依赖 useEffect</strong>：简单的状态计算、DOM 操作若可同步执行，无需放入 useEffect，避免不必要的渲染延迟；</li>
<li><strong>误区 2：useCallback/useMemo 滥用</strong>：简单函数、简单计算无需缓存，仅在确有性能问题时使用；</li>
<li><strong>误区 3：useDeferredValue 与 useTransition 混淆</strong>：useDeferredValue 是“被动延迟状态”，依赖原始状态；useTransition 是“主动标记更新”，需手动包裹更新逻辑；</li>
<li><strong>误区 4：useContext 替代状态管理库</strong>：useContext 适合共享少量固定状态，复杂状态更新（如多组件修改同一状态）建议结合 useReducer 或 Redux Toolkit；</li>
<li><strong>误区 5：修改 ref.current 期望触发渲染</strong>：ref.current 变化不会触发组件重新渲染，若需更新 UI，需配合 useState 或 useEffect。</li>
</ul>
<h2 data-id="heading-22">五、下一步学习方向</h2>
<p>今天我们建立了 React 19 生命周期与 8 个核心 Hooks 的完整认知，这是函数组件开发的核心基础。下一步可以重点学习：</p>
<ul>
<li>自定义 Hooks：将复用逻辑封装为自定义 Hooks（如 useFetch、useTimer），提升代码复用性；</li>
<li>useReducer：处理复杂状态逻辑，替代 useState 实现多状态联动；</li>
<li>React 19 新增 Hooks：如 use()、useOptimistic 等，简化异步数据处理和乐观更新；</li>
<li>Hooks 性能优化实战：结合 React DevTools 分析组件渲染，精准使用优化类 Hooks。</li>
</ul>
<p>如果这篇文章对你有帮助，欢迎点赞、收藏、转发～ 有任何问题也可以在评论区留言交流～ 我们下期再见！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[剑指offer-58、对称二叉树]]></title>    <link>https://juejin.cn/post/7590915294446878747</link>    <guid>https://juejin.cn/post/7590915294446878747</guid>    <pubDate>2026-01-04T00:57:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590915294446878747" data-draft-id="7589838742552461331" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="剑指offer-58、对称二叉树"/> <meta itemprop="keywords" content="Java"/> <meta itemprop="datePublished" content="2026-01-04T00:57:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="SevenCoding"/> <meta itemprop="url" content="https://juejin.cn/user/3261615728242467"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            剑指offer-58、对称二叉树
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3261615728242467/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    SevenCoding
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-04T00:57:54.000Z" title="Sun Jan 04 2026 00:57:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">题⽬描述</h2>
<p>请实现⼀个函数，⽤来判断⼀棵⼆叉树是不是对称的。注意，如果⼀个⼆叉树同此⼆叉树的镜像是同样
的，定义其为对称的。</p>
<p>例如：下⾯这棵⼆叉树是对称的</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1d6e9fee68764db7bd76b229093845c0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2V2ZW5Db2Rpbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768093073&amp;x-signature=SebiB2H49DFLjKM3wz8YdBAwIb8%3D" alt="" loading="lazy"/></p>
<p>下⾯这个就不是对称的：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9ab1d63fdfbe40caa91872d3d9f926a5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2V2ZW5Db2Rpbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768093073&amp;x-signature=im3RM6%2FiG%2BCNAGTQ9wAnNC5PYbQ%3D" alt="" loading="lazy"/></p>
<p>示例1</p>
<p>输⼊：{8,6,6,5,7,7,5}
返回值：true</p>
<p>示例2：</p>
<p>输⼊：{8,6,9,5,7,7,5}
返回值：false</p>
<h2 data-id="heading-1">思路及解答</h2>
<h3 data-id="heading-2">递归</h3>
<p>递归，先判断根节点是否为空，不为空则判断左右⼦树是不是对称。</p>
<p>如果左右⼦树都为空，则返回 true ，如果有⼀个为空，则返回 false ，如果两个都不为空的时候，除了对⽐左右两个节点的值，还需要递归，对⽐左⼦树的左⼦树和右⼦树的右⼦树是否相等，左⼦树的右⼦树和右⼦树的左⼦树是否相等。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">jude</span><span class="hljs-params">(TreeNode left, TreeNode right)</span> {
        <span class="hljs-comment">// 如果左右两个都为空，则对称</span>
        <span class="hljs-keyword">if</span> (left == <span class="hljs-literal">null</span> &amp;&amp; right == <span class="hljs-literal">null</span>) {
        	<span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (left == <span class="hljs-literal">null</span> || right == <span class="hljs-literal">null</span>) {
            <span class="hljs-comment">// 如果左右两个有⼀个为空，那么就不对称</span>
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
        
        <span class="hljs-comment">// 都不为空的情况，需要判断两个的值，是不是相等</span>
        <span class="hljs-keyword">if</span> (left.val != right.val) {
        	<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// 递归判断，左⼦树的左⼦树和右⼦树的右⼦树，左⼦树的右⼦树和右⼦树的左⼦树</span>
            <span class="hljs-keyword">return</span> jude(left.left, right.right) &amp;&amp; jude(left.right, right.left);
        }
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isSymmetrical</span><span class="hljs-params">(TreeNode pRoot)</span> {
        <span class="hljs-comment">// 判断根节点是否为空，如果不为空则判断左右⼦树</span>
        <span class="hljs-keyword">return</span> pRoot==<span class="hljs-literal">null</span> || jude(pRoot.left, pRoot.right);
    }
}
</code></pre>
<ul>
<li>时间复杂度：O(n)</li>
<li>空间复杂度：O(n),最坏情况下，⼆叉树退化为链表</li>
</ul>
<h3 data-id="heading-3">迭代</h3>
<p>是借助两个队列，按照层次，⼀个是按照从左到右添加元素，另外⼀个队列
是按照从右到左添加元素，挨个取出来，进⾏对⽐，不等则说明不对称，如果相等，则再把其左右⼦树
分别按照不同的顺序添加到队列中。代码如下</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> {
    <span class="hljs-comment">/**
    * 迭代法
     * 使用双端队列，相当于两个栈
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isSymmetric2</span><span class="hljs-params">(TreeNode root)</span> {
        Deque&lt;TreeNode&gt; deque = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedList</span>&lt;&gt;();
        deque.offerFirst(root.left);
        deque.offerLast(root.right);
        <span class="hljs-keyword">while</span> (!deque.isEmpty()) {
            <span class="hljs-type">TreeNode</span> <span class="hljs-variable">leftNode</span> <span class="hljs-operator">=</span> deque.pollFirst();
            <span class="hljs-type">TreeNode</span> <span class="hljs-variable">rightNode</span> <span class="hljs-operator">=</span> deque.pollLast();
            <span class="hljs-keyword">if</span> (leftNode == <span class="hljs-literal">null</span> &amp;&amp; rightNode == <span class="hljs-literal">null</span>) {
                <span class="hljs-keyword">continue</span>;
            }

            <span class="hljs-keyword">if</span> (leftNode == <span class="hljs-literal">null</span> || rightNode == <span class="hljs-literal">null</span> || leftNode.val != rightNode.val) {
                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
            }
            deque.offerFirst(leftNode.left);
            deque.offerFirst(leftNode.right);
            deque.offerLast(rightNode.right);
            deque.offerLast(rightNode.left);
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }

    <span class="hljs-comment">/**
     * 迭代法
     * 使用普通队列
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isSymmetric3</span><span class="hljs-params">(TreeNode root)</span> {
        Queue&lt;TreeNode&gt; deque = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedList</span>&lt;&gt;();
        deque.offer(root.left);
        deque.offer(root.right);
        <span class="hljs-keyword">while</span> (!deque.isEmpty()) {
            <span class="hljs-type">TreeNode</span> <span class="hljs-variable">leftNode</span> <span class="hljs-operator">=</span> deque.poll();
            <span class="hljs-type">TreeNode</span> <span class="hljs-variable">rightNode</span> <span class="hljs-operator">=</span> deque.poll();
            <span class="hljs-keyword">if</span> (leftNode == <span class="hljs-literal">null</span> &amp;&amp; rightNode == <span class="hljs-literal">null</span>) {
                <span class="hljs-keyword">continue</span>;
            }

            <span class="hljs-keyword">if</span> (leftNode == <span class="hljs-literal">null</span> || rightNode == <span class="hljs-literal">null</span> || leftNode.val != rightNode.val) {
                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
            }
            <span class="hljs-comment">// 这里顺序与使用Deque不同</span>
            deque.offer(leftNode.left);
            deque.offer(rightNode.right);
            deque.offer(leftNode.right);
            deque.offer(rightNode.left);
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
}
</code></pre>
<ul>
<li>空间复杂度为 O(n)</li>
<li>时间复杂度为 O(n) ,每个节点只会⼊队出队⼀次。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[MyBatis会话模块详解]]></title>    <link>https://juejin.cn/post/7590929624743231538</link>    <guid>https://juejin.cn/post/7590929624743231538</guid>    <pubDate>2026-01-04T01:02:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590929624743231538" data-draft-id="7590457413347295259" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="MyBatis会话模块详解"/> <meta itemprop="keywords" content="MyBatis"/> <meta itemprop="datePublished" content="2026-01-04T01:02:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="雨中飘荡的记忆"/> <meta itemprop="url" content="https://juejin.cn/user/694547077666606"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            MyBatis会话模块详解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/694547077666606/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    雨中飘荡的记忆
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-04T01:02:17.000Z" title="Sun Jan 04 2026 01:02:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>深入剖析MyBatis核心——SqlSession的前世今生</p>
</blockquote>
<h2 data-id="heading-0">一、MyBatis整体架构与会话模块</h2>
<p>MyBatis是一个优秀的持久层框架，它支持定制化SQL、存储过程以及高级映射。MyBatis避免了几乎所有的JDBC代码和手动设置参数以及获取结果集的工作。</p>
<h2 data-id="heading-1">1.1 MyBatis整体架构</h2>
<p>MyBatis采用分层架构设计，从上到下分为：</p>
<pre><code class="hljs language-sql" lang="sql">• 应用层 — 与用户应用程序直接交互
• 接口层 — 提供SqlSession和Mapper接口
• 核心处理层 — 包括<span class="hljs-keyword">SQL</span>解析、执行、结果映射
• 基础支撑层 — 包括反射、类型处理、日志、缓存、事务
• 数据层 — 数据源管理、连接池、JDBC驱动
</code></pre>
<p>会话模块位于接口层，是MyBatis与应用程序交互的主要入口。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3f3a231f2f3b486584e28511c97d91e0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768093336&amp;x-signature=aKbE%2BshF1J9oHLOWoOoJ8wApvrM%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-2">1.2 会话模块的核心职责</h2>
<p>会话模块在MyBatis中承担以下核心职责：</p>
<pre><code class="hljs language-sql" lang="sql">✅ 数据库操作接口 — 提供<span class="hljs-keyword">insert</span>、<span class="hljs-keyword">update</span>、<span class="hljs-keyword">delete</span>、<span class="hljs-keyword">select</span>等方法
✅ SqlSession生命周期管理 — 创建、使用、关闭SqlSession
✅ 事务控制 — 管理事务的开启、提交、回滚
✅ Mapper管理 — 获取Mapper接口的代理对象
✅ 批量操作支持 — 提供批量执行<span class="hljs-keyword">SQL</span>的能力
</code></pre>
<h2 data-id="heading-3">二、SqlSession接口详解</h2>
<p>SqlSession是MyBatis的核心接口之一，它定义了所有数据库操作的方法。</p>
<h2 data-id="heading-4">2.1 SqlSession核心方法分类</h2>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 查询单个对象</span>
&lt;T&gt; T <span class="hljs-built_in">selectOne</span>(String statement);
&lt;T&gt; T <span class="hljs-built_in">selectOne</span>(String statement, Object parameter);

<span class="hljs-comment">// 查询列表</span>
&lt;E&gt; List&lt;E&gt; <span class="hljs-built_in">selectList</span>(String statement);
&lt;E&gt; List&lt;E&gt; <span class="hljs-built_in">selectList</span>(String statement, Object parameter);

<span class="hljs-comment">// 查询Map</span>
&lt;K, V&gt; Map&lt;K, V&gt; <span class="hljs-built_in">selectMap</span>(String statement, String mapKey);

<span class="hljs-comment">// 游标查询</span>
&lt;T&gt; <span class="hljs-attribute">Cursor</span>&lt;T&gt; <span class="hljs-built_in">selectCursor</span>(String statement);
<span class="hljs-comment">// 插入</span>
int <span class="hljs-built_in">insert</span>(String statement);
int <span class="hljs-built_in">insert</span>(String statement, Object parameter);

<span class="hljs-comment">// 更新</span>
int <span class="hljs-built_in">update</span>(String statement);
int <span class="hljs-built_in">update</span>(String statement, Object parameter);

<span class="hljs-comment">// 删除</span>
int <span class="hljs-built_in">delete</span>(String statement);
int <span class="hljs-built_in">delete</span>(String statement, Object parameter);
<span class="hljs-comment">// 提交事务</span>
void <span class="hljs-built_in">commit</span>();
void <span class="hljs-built_in">commit</span>(boolean force);

<span class="hljs-comment">// 回滚事务</span>
void <span class="hljs-built_in">rollback</span>();
void <span class="hljs-built_in">rollback</span>(boolean force);
<span class="hljs-comment">// 获取Mapper代理对象</span>
&lt;T&gt; T <span class="hljs-built_in">getMapper</span>(Class&lt;T&gt; type);
<span class="hljs-comment">// 1. 获取SqlSessionFactory</span>
SqlSessionFactory factory = new <span class="hljs-built_in">SqlSessionFactoryBuilder</span>()
    <span class="hljs-selector-class">.build</span>(Resources.getResourceAsStream("mybatis-config.xml"));

<span class="hljs-comment">// 2. 打开SqlSession</span>
try (SqlSession session = factory.openSession()) {
    <span class="hljs-comment">// 3. 执行SQL</span>
    User user = session<span class="hljs-selector-class">.selectOne</span>(
        "com.example.mapper.UserMapper.selectById", <span class="hljs-number">1</span>);
    System<span class="hljs-selector-class">.out</span><span class="hljs-selector-class">.println</span>(user);
}
try (SqlSession session = factory.openSession()) {
    <span class="hljs-comment">// 获取Mapper代理对象</span>
    UserMapper mapper = session<span class="hljs-selector-class">.getMapper</span>(UserMapper.class);

    <span class="hljs-comment">// 调用Mapper方法</span>
    User user = mapper<span class="hljs-selector-class">.selectById</span>(<span class="hljs-number">1</span>);
    System<span class="hljs-selector-class">.out</span><span class="hljs-selector-class">.println</span>(user);

    session<span class="hljs-selector-class">.commit</span>();
}
</code></pre>
<h2 data-id="heading-5">三、SqlSession的实现类</h2>
<p>MyBatis提供了两个主要的SqlSession实现类。</p>
<h2 data-id="heading-6">3.1 DefaultSqlSession</h2>
<p>DefaultSqlSession是SqlSession的默认实现类，最常用的实现。</p>
<p>核心代码片段：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DefaultSqlSession</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">SqlSession</span> {

    <span class="hljs-keyword">private</span> final <span class="hljs-title class_">Configuration</span> configuration;
    <span class="hljs-keyword">private</span> final <span class="hljs-title class_">Executor</span> executor;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> &lt;T&gt; T <span class="hljs-title function_">selectOne</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> statement, <span class="hljs-built_in">Object</span> parameter</span>) {
        <span class="hljs-title class_">List</span>&lt;T&gt; list = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">selectList</span>(statement, parameter);
        <span class="hljs-keyword">if</span> (list.<span class="hljs-title function_">size</span>() == <span class="hljs-number">1</span>) {
            <span class="hljs-keyword">return</span> list.<span class="hljs-title function_">get</span>(<span class="hljs-number">0</span>);
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (list.<span class="hljs-title function_">size</span>() &gt; <span class="hljs-number">1</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TooManyResultsException</span>(
                <span class="hljs-string">"Expected one result but found: "</span> + list.<span class="hljs-title function_">size</span>());
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">commit</span>(<span class="hljs-params"><span class="hljs-built_in">boolean</span> force</span>) {
        <span class="hljs-keyword">try</span> {
            executor.<span class="hljs-title function_">commit</span>(<span class="hljs-title function_">isCommitOrRollbackRequired</span>(force));
            dirty = <span class="hljs-literal">false</span>;
        } <span class="hljs-keyword">catch</span> (<span class="hljs-title class_">Exception</span> e) {
            <span class="hljs-keyword">throw</span> <span class="hljs-title class_">ExceptionFactory</span>.<span class="hljs-title function_">wrapException</span>(
                <span class="hljs-string">"Error committing transaction."</span>, e);
        }
    }
}
</code></pre>
<h2 data-id="heading-7">3.2 SqlSessionManager</h2>
<p>SqlSessionManager同时实现了SqlSession和SqlSessionFactory接口，既可以作为SqlSession使用，也可以作为工厂使用。</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">SqlSessionManager</span> 
    <span class="hljs-title">implements</span> <span class="hljs-title">SqlSessionFactory</span>, <span class="hljs-title">SqlSession</span> {

    <span class="hljs-keyword">private</span> final SqlSessionFactory sqlSessionFactory;
    <span class="hljs-keyword">private</span> final SqlSession sqlSessionProxy;
    <span class="hljs-keyword">private</span> ThreadLocal&lt;SqlSession&gt; localSqlSession 
        = <span class="hljs-keyword">new</span> ThreadLocal&lt;&gt;();

    <span class="hljs-comment">// 开启本地Session</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">startManagedSession</span>()</span> {
        <span class="hljs-keyword">this</span>.localSqlSession.<span class="hljs-keyword">set</span>(openSession());
    }

    <span class="hljs-comment">// 关闭本地Session</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">closeManagedSession</span>()</span> {
        SqlSession sqlSession = localSqlSession.<span class="hljs-keyword">get</span>();
        <span class="hljs-keyword">if</span> (sqlSession != <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">try</span> {
                sqlSession.close();
            } <span class="hljs-keyword">finally</span> {
                localSqlSession.<span class="hljs-keyword">remove</span>();
            }
        }
    }
}
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a34283f2afa842d6a55efec67dac3c31~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768093336&amp;x-signature=%2BcHKb4WuXUn2EMHB69EthQbuf2Y%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-8">四、SqlSessionFactory工厂</h2>
<p>SqlSessionFactory是创建SqlSession的工厂接口。</p>
<h2 data-id="heading-9">4.1 SqlSessionFactory接口方法</h2>
<pre><code class="hljs language-scss" lang="scss">public interface SqlSessionFactory {

    <span class="hljs-comment">// 常用方法：打开Session</span>
    SqlSession <span class="hljs-built_in">openSession</span>();

    <span class="hljs-comment">// 指定ExecutorType</span>
    SqlSession <span class="hljs-built_in">openSession</span>(ExecutorType execType);

    <span class="hljs-comment">// 指定是否自动提交</span>
    SqlSession <span class="hljs-built_in">openSession</span>(boolean autoCommit);

    <span class="hljs-comment">// 指定事务隔离级别</span>
    SqlSession <span class="hljs-built_in">openSession</span>(TransactionIsolationLevel level);

    <span class="hljs-comment">// 使用指定连接</span>
    SqlSession <span class="hljs-built_in">openSession</span>(Connection connection);
}
</code></pre>
<h2 data-id="heading-10">4.2 DefaultSqlSessionFactory核心流程</h2>
<p>创建SqlSession的完整流程：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> SqlSession <span class="hljs-title function_">openSessionFromDataSource</span><span class="hljs-params">(
    ExecutorType execType,
    TransactionIsolationLevel level,
    <span class="hljs-type">boolean</span> autoCommit)</span> {

    <span class="hljs-type">Transaction</span> <span class="hljs-variable">tx</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">//获取环境配置</span>
        <span class="hljs-type">Environment</span> <span class="hljs-variable">environment</span> <span class="hljs-operator">=</span> configuration.getEnvironment();

        <span class="hljs-comment">//创建事务工厂</span>
        <span class="hljs-type">TransactionFactory</span> <span class="hljs-variable">transactionFactory</span> <span class="hljs-operator">=</span> 
            getTransactionFactoryFromEnvironment(environment);

        <span class="hljs-comment">//创建事务</span>
        tx = transactionFactory.newTransaction(
            environment.getDataSource(), level, autoCommit);

        <span class="hljs-comment">//创建执行器</span>
        <span class="hljs-type">Executor</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> configuration.newExecutor(tx, execType);

        <span class="hljs-comment">//创建DefaultSqlSession</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultSqlSession</span>(configuration, executor, autoCommit);
    } <span class="hljs-keyword">catch</span> (Exception e) {
        closeTransaction(tx);
        <span class="hljs-keyword">throw</span> ExceptionFactory.wrapException(
            <span class="hljs-string">"Error opening session."</span>, e);
    }
}
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b093cdd644e7426c83e82fcd94eb1d88~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768093336&amp;x-signature=7mdc3OuJ3zLozfnpCmErBegekV4%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-11">五、SqlSession生命周期管理</h2>
<p>SqlSession的生命周期管理非常重要，不当使用会导致资源泄漏。</p>
<h2 data-id="heading-12">5.1 SqlSession的三个阶段</h2>
<pre><code class="hljs language-ini" lang="ini">// 方式1：默认创建
SqlSession <span class="hljs-attr">session</span> = sqlSessionFactory.openSession()<span class="hljs-comment">;</span>

// 方式2：自动提交
SqlSession <span class="hljs-attr">session</span> = sqlSessionFactory.openSession(<span class="hljs-literal">true</span>)<span class="hljs-comment">;</span>

// 方式3：指定Executor类型
SqlSession <span class="hljs-attr">session</span> = sqlSessionFactory.openSession(
    ExecutorType.BATCH)<span class="hljs-comment">;</span>

// 方式4：事务隔离级别
SqlSession <span class="hljs-attr">session</span> = sqlSessionFactory.openSession(
    TransactionIsolationLevel.READ_COMMITTED)<span class="hljs-comment">;</span>
try (SqlSession <span class="hljs-attr">session</span> = factory.openSession()) {
    // 执行查询
    User <span class="hljs-attr">user</span> = session.selectOne(
        "com.example.mapper.UserMapper.selectById", 1)<span class="hljs-comment">;</span>

    // 执行更新
    User <span class="hljs-attr">updateUser</span> = new User()<span class="hljs-comment">;</span>
    updateUser.setId(1)<span class="hljs-comment">;</span>
    updateUser.setName("张三")<span class="hljs-comment">;</span>
    session.update(
        "com.example.mapper.UserMapper.update", updateUser)<span class="hljs-comment">;</span>

    // 提交事务
    session.commit()<span class="hljs-comment">;</span>
}
// 推荐方式：try-with-resources
try (SqlSession <span class="hljs-attr">session</span> = factory.openSession()) {
    // 使用session
} // 自动关闭

// 传统方式
SqlSession <span class="hljs-attr">session</span> = null<span class="hljs-comment">;</span>
try {
    <span class="hljs-attr">session</span> = factory.openSession()<span class="hljs-comment">;</span>
    // 使用session
} finally {
    if (session != null) {
        session.close()<span class="hljs-comment">;</span>
    }
}
</code></pre>
<blockquote>
<p>重要原则：SqlSession的作用域应该是方法级别的！</p>
</blockquote>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 错误：SqlSession作为成员变量</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {
    <span class="hljs-keyword">private</span> SqlSession session; <span class="hljs-comment">// ❌ 不要这样做！</span>

    <span class="hljs-keyword">public</span> User <span class="hljs-title function_">getUserById</span><span class="hljs-params">(<span class="hljs-type">int</span> id)</span> {
        <span class="hljs-keyword">return</span> session.selectOne(
            <span class="hljs-string">"com.example.mapper.UserMapper.selectById"</span>, id);
    }
}
<span class="hljs-comment">// 正确：SqlSession在方法中创建和关闭</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {
    <span class="hljs-keyword">private</span> SqlSessionFactory factory;

    <span class="hljs-keyword">public</span> User <span class="hljs-title function_">getUserById</span><span class="hljs-params">(<span class="hljs-type">int</span> id)</span> {
        <span class="hljs-keyword">try</span> (<span class="hljs-type">SqlSession</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> factory.openSession()) {
            <span class="hljs-keyword">return</span> session.selectOne(
                <span class="hljs-string">"com.example.mapper.UserMapper.selectById"</span>, id);
        }
    }
}
</code></pre>
<h2 data-id="heading-13">5.3 线程安全问题</h2>
<blockquote>
<p>SqlSession不是线程安全的，每个线程都应该有自己的SqlSession实例！</p>
</blockquote>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {
    <span class="hljs-comment">// ❌ 多个线程共享同一个SqlSession</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">SqlSession</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> factory.openSession();
}
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {
    <span class="hljs-keyword">private</span> SqlSessionFactory factory;

    <span class="hljs-keyword">public</span> User <span class="hljs-title function_">getUserById</span><span class="hljs-params">(<span class="hljs-type">int</span> id)</span> {
        <span class="hljs-comment">// ✅ 每次调用都创建新的SqlSession</span>
        <span class="hljs-keyword">try</span> (<span class="hljs-type">SqlSession</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> factory.openSession()) {
            <span class="hljs-keyword">return</span> session.selectOne(<span class="hljs-string">"..."</span>, id);
        }
    }
}
</code></pre>
<h2 data-id="heading-14">5.4 ThreadLocal管理模式</h2>
<p>在某些场景下，可以使用ThreadLocal管理SqlSession：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">SqlSessionManager</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> final ThreadLocal&lt;SqlSession&gt; LOCAL_SESSION 
        = <span class="hljs-keyword">new</span> ThreadLocal&lt;&gt;();
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> SqlSessionFactory factory;

    <span class="hljs-comment">// 获取当前线程的SqlSession</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> SqlSession <span class="hljs-title">getSession</span>()</span> {
        SqlSession session = LOCAL_SESSION.<span class="hljs-keyword">get</span>();
        <span class="hljs-keyword">if</span> (session == <span class="hljs-literal">null</span>) {
            session = factory.openSession();
            LOCAL_SESSION.<span class="hljs-keyword">set</span>(session);
        }
        <span class="hljs-keyword">return</span> session;
    }

    <span class="hljs-comment">// 关闭当前线程的SqlSession</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">closeSession</span>()</span> {
        SqlSession session = LOCAL_SESSION.<span class="hljs-keyword">get</span>();
        <span class="hljs-keyword">if</span> (session != <span class="hljs-literal">null</span>) {
            session.close();
            LOCAL_SESSION.<span class="hljs-keyword">remove</span>();
        }
    }
}
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/52459c703a78445e9d0c501ccf0860e6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768093336&amp;x-signature=v1Dd2yltusTF%2BG4eYJUuu6zNZAk%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-15">六、事务控制机制</h2>
<p>SqlSession提供了完善的事务控制机制。</p>
<h2 data-id="heading-16">6.1 自动提交 vs 手动提交</h2>
<pre><code class="hljs language-ini" lang="ini">// 不自动提交（默认）
SqlSession <span class="hljs-attr">session</span> = factory.openSession()<span class="hljs-comment">;</span>
session.insert("...")<span class="hljs-comment">;</span>
session.commit()<span class="hljs-comment">; // 需要手动提交</span>

//自动提交
SqlSession <span class="hljs-attr">session</span> = factory.openSession(<span class="hljs-literal">true</span>)<span class="hljs-comment">;</span>
session.insert("...")<span class="hljs-comment">; // 自动提交</span>
</code></pre>
<h2 data-id="heading-17">6.2 手动事务控制实战</h2>
<pre><code class="hljs language-scss" lang="scss">try (SqlSession session = factory.openSession()) {
    try {
        <span class="hljs-comment">// 1.插入用户</span>
        User user = new <span class="hljs-built_in">User</span>();
        user<span class="hljs-selector-class">.setName</span>("张三");
        user<span class="hljs-selector-class">.setEmail</span>("zhangsan@example.com");
        session<span class="hljs-selector-class">.insert</span>(
            "com.example.mapper.UserMapper.insert", user);

        <span class="hljs-comment">//2.插入订单</span>
        <span class="hljs-attribute">Order</span> <span class="hljs-attribute">order</span> = new <span class="hljs-attribute">Order</span>();
        <span class="hljs-attribute">order</span><span class="hljs-selector-class">.setUserId</span>(user.getId());
        <span class="hljs-attribute">order</span><span class="hljs-selector-class">.setAmount</span>(<span class="hljs-number">100.0</span>);
        session<span class="hljs-selector-class">.insert</span>(
            "com.example.mapper.OrderMapper.insert", order);

        <span class="hljs-comment">//3.提交事务</span>
        session<span class="hljs-selector-class">.commit</span>();
    } catch (Exception e) {
        <span class="hljs-comment">//4.回滚事务</span>
        session<span class="hljs-selector-class">.rollback</span>();
        throw e;
    }
}
</code></pre>
<h2 data-id="heading-18">6.3 事务隔离级别</h2>
<p>MyBatis支持设置事务隔离级别：</p>
<pre><code class="hljs language-ini" lang="ini">SqlSession <span class="hljs-attr">session</span> = factory.openSession(
    TransactionIsolationLevel.READ_COMMITTED)<span class="hljs-comment">;</span>
</code></pre>
<p>支持的隔离级别：</p>



































<table><thead><tr><th>隔离级别</th><th>说明</th><th>适用场景</th></tr></thead><tbody><tr><td>NONE</td><td>无事务隔离</td><td>不推荐</td></tr><tr><td>READ_UNCOMMITTED</td><td>读未提交</td><td>极少使用</td></tr><tr><td>READ_COMMITTED</td><td>读已提交</td><td>大多数数据库默认</td></tr><tr><td>REPEATABLE_READ</td><td>可重复读</td><td>MySQL默认</td></tr><tr><td>SERIALIZABLE</td><td>串行化</td><td>最高隔离级别</td></tr></tbody></table>
<h2 data-id="heading-19">6.4 批量操作的事务控制</h2>
<pre><code class="hljs language-ini" lang="ini">try (SqlSession <span class="hljs-attr">session</span> = factory.openSession(
    ExecutorType.BATCH, false)) {
    try {
        UserMapper <span class="hljs-attr">mapper</span> = session.getMapper(UserMapper.class)<span class="hljs-comment">;</span>

        // 批量插入
        for (int <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; 1000; i++) {</span>
            User <span class="hljs-attr">user</span> = new User()<span class="hljs-comment">;</span>
            user.setName("User" + i)<span class="hljs-comment">;</span>
            user.setEmail("user" + i + "@example.com")<span class="hljs-comment">;</span>
            mapper.insert(user)<span class="hljs-comment">;</span>
        }

        // 统一提交
        session.commit()<span class="hljs-comment">;</span>
    } catch (Exception e) {
        session.rollback()<span class="hljs-comment">;</span>
        throw e<span class="hljs-comment">;</span>
    }
}
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/83142af20c054c7c9992c49494a5442a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768093336&amp;x-signature=GzEuvaRRjuwr2tCIP77r3%2Bn4OGE%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-20">七、SqlSession与Mapper集成</h2>
<p>SqlSession与Mapper接口的集成是MyBatis最常用的方式。</p>
<h2 data-id="heading-21">7.1 定义Mapper接口</h2>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">interface</span> <span class="hljs-selector-tag">UserMapper</span> {
    <span class="hljs-selector-tag">User</span> <span class="hljs-selector-tag">selectById</span>(<span class="hljs-variable">@Param</span>(<span class="hljs-string">"id"</span>) Integer id);
    <span class="hljs-selector-tag">List</span>&lt;<span class="hljs-selector-tag">User</span>&gt; <span class="hljs-selector-tag">selectAll</span>();
    <span class="hljs-selector-tag">int</span> <span class="hljs-selector-tag">insert</span>(User user);
    <span class="hljs-selector-tag">int</span> <span class="hljs-selector-tag">update</span>(User user);
    <span class="hljs-selector-tag">int</span> <span class="hljs-selector-tag">deleteById</span>(<span class="hljs-variable">@Param</span>(<span class="hljs-string">"id"</span>) Integer id);
}
</code></pre>
<h2 data-id="heading-22">7.2 Mapper XML映射文件</h2>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"UTF-8"</span> ?&gt;</span>
<span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">mapper</span> <span class="hljs-keyword">PUBLIC</span> <span class="hljs-string">"-//mybatis.org//DTD Mapper 3.0//EN"</span>
    <span class="hljs-string">"http://mybatis.org/dtd/mybatis-3-mapper.dtd"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">mapper</span> <span class="hljs-attr">namespace</span>=<span class="hljs-string">"com.example.mapper.UserMapper"</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">resultMap</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"BaseResultMap"</span> 
               <span class="hljs-attr">type</span>=<span class="hljs-string">"com.example.entity.User"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">id</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"id"</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"id"</span> <span class="hljs-attr">jdbcType</span>=<span class="hljs-string">"INTEGER"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"name"</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"name"</span> 
                <span class="hljs-attr">jdbcType</span>=<span class="hljs-string">"VARCHAR"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"email"</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"email"</span> 
                <span class="hljs-attr">jdbcType</span>=<span class="hljs-string">"VARCHAR"</span>/&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">resultMap</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"selectById"</span> <span class="hljs-attr">resultMap</span>=<span class="hljs-string">"BaseResultMap"</span>&gt;</span>
        SELECT id, name, email, age
        FROM t_user
        WHERE id = #{id}
    <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">insert</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"insert"</span> <span class="hljs-attr">parameterType</span>=<span class="hljs-string">"com.example.entity.User"</span> 
            <span class="hljs-attr">useGeneratedKeys</span>=<span class="hljs-string">"true"</span> <span class="hljs-attr">keyProperty</span>=<span class="hljs-string">"id"</span>&gt;</span>
        INSERT INTO t_user (name, email, age)
        VALUES (#{name}, #{email}, #{age})
    <span class="hljs-tag">&lt;/<span class="hljs-name">insert</span>&gt;</span>

<span class="hljs-tag">&lt;/<span class="hljs-name">mapper</span>&gt;</span>
</code></pre>
<h2 data-id="heading-23">7.3 通过SqlSession获取Mapper</h2>
<pre><code class="hljs language-ini" lang="ini">try (SqlSession <span class="hljs-attr">session</span> = factory.openSession()) {
    // 获取Mapper代理对象
    UserMapper <span class="hljs-attr">mapper</span> = session.getMapper(UserMapper.class)<span class="hljs-comment">;</span>

    //调用Mapper方法
    User <span class="hljs-attr">user</span> = mapper.selectById(<span class="hljs-number">1</span>)<span class="hljs-comment">;</span>

    //插入数据
    User <span class="hljs-attr">newUser</span> = new User()<span class="hljs-comment">;</span>
    newUser.setName("李四")<span class="hljs-comment">;</span>
    newUser.setEmail("lisi@example.com")<span class="hljs-comment">;</span>
    mapper.insert(newUser)<span class="hljs-comment">;</span>

    //提交事务
    session.commit()<span class="hljs-comment">;</span>
}
</code></pre>
<h2 data-id="heading-24">7.4 MapperProxy工作原理</h2>
<p>MyBatis通过JDK动态代理为Mapper接口生成代理对象：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MapperProxy</span>&lt;<span class="hljs-type">T</span>&gt; <span class="hljs-title">implements</span> <span class="hljs-title">InvocationHandler</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> SqlSession sqlSession;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Class&lt;T&gt; mapperInterface;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Object invoke(Object proxy, Method method, 
                        Object[] args) throws Throwable {
        <span class="hljs-comment">// 如果是Object类的方法，直接执行</span>
        <span class="hljs-keyword">if</span> (Object.<span class="hljs-keyword">class</span>.equals(method.getDeclaringClass())) {
            <span class="hljs-keyword">return</span> method.invoke(<span class="hljs-keyword">this</span>, args);
        }

        <span class="hljs-comment">// 获取Mapper方法</span>
        <span class="hljs-keyword">final</span> MapperMethod mapperMethod = 
            cachedMapperMethod(method);

        <span class="hljs-comment">// 执行Mapper方法</span>
        <span class="hljs-keyword">return</span> mapperMethod.execute(sqlSession, args);
    }
}
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7c60ad67099e4dbf93410da0d9e2aa2d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768093336&amp;x-signature=Ns4x0Ve3d9wBJm6zjN2cOtlzp84%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-25">八、Executor执行器详解</h2>
<p>Executor是SqlSession的核心组件，负责实际执行SQL语句。</p>
<h2 data-id="heading-26">8.1 三种Executor类型</h2>
<pre><code class="hljs language-ini" lang="ini">// 默认的Executor，每次执行都会创建新的Statement
SqlSession <span class="hljs-attr">session</span> = factory.openSession(ExecutorType.SIMPLE)<span class="hljs-comment">;</span>
</code></pre>
<p>特点：简单直接，每次创建新Statement</p>
<p>适用场景：一般查询、单条操作</p>
<pre><code class="hljs language-ini" lang="ini">// 重用Statement，减少创建开销
SqlSession <span class="hljs-attr">session</span> = factory.openSession(ExecutorType.REUSE)<span class="hljs-comment">;</span>
</code></pre>
<p>特点：重用Statement，减少创建开销</p>
<p>适用场景：执行相同SQL多次</p>
<pre><code class="hljs language-ini" lang="ini">// 批量执行SQL，性能最高
SqlSession <span class="hljs-attr">session</span> = factory.openSession(ExecutorType.BATCH)<span class="hljs-comment">;</span>
</code></pre>
<p>特点：批量执行，性能最优</p>
<p>适用场景：批量插入、更新</p>
<h2 data-id="heading-27">8.2 Executor对比表</h2>





























<table><thead><tr><th>Executor类型</th><th>性能</th><th>Statement复用</th><th>适用场景</th></tr></thead><tbody><tr><td>SIMPLE</td><td>⭐⭐⭐</td><td>❌</td><td>一般查询</td></tr><tr><td>REUSE</td><td>⭐⭐⭐⭐</td><td>✅</td><td>相同SQL多次执行</td></tr><tr><td>BATCH</td><td>⭐⭐⭐⭐⭐</td><td>✅</td><td>批量操作</td></tr></tbody></table>
<h2 data-id="heading-28">8.3 实战示例</h2>
<pre><code class="hljs language-ini" lang="ini">//BATCH执行器批量插入示例
try (SqlSession <span class="hljs-attr">session</span> = factory.openSession(
    ExecutorType.BATCH)) {

    UserMapper <span class="hljs-attr">mapper</span> = session.getMapper(UserMapper.class)<span class="hljs-comment">;</span>

    for (int <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; 1000; i++) {</span>
        User <span class="hljs-attr">user</span> = new User()<span class="hljs-comment">;</span>
        user.setName("User" + i)<span class="hljs-comment">;</span>
        mapper.insert(user)<span class="hljs-comment">;</span>
    }

    // 批量提交
    session.commit()<span class="hljs-comment">;</span>
}
</code></pre>
<h2 data-id="heading-29">九、最佳实践</h2>
<h2 data-id="heading-30">9.1 SqlSession使用黄金法则</h2>
<pre><code class="hljs language-csharp" lang="csharp">✅ 及时关闭 — 使用<span class="hljs-keyword">try</span>-<span class="hljs-keyword">with</span>-resources确保资源释放
✅ 方法作用域 — SqlSession应该在方法级别创建和关闭
✅ 线程独立 — 每个线程使用独立的SqlSession
✅ 事务控制 — 明确提交或回滚事务
✅ 异常处理 — 捕获异常并回滚事务
</code></pre>
<h2 data-id="heading-31">9.2 Spring集成最佳实践</h2>
<p>在Spring中使用MyBatis时，SqlSession由容器管理：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">UserMapper</span> userMapper;

    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">createUser</span>(<span class="hljs-params">User user</span>) {
        <span class="hljs-comment">// SqlSession由Spring管理，无需手动关闭</span>
        userMapper.<span class="hljs-title function_">insert</span>(user);
    }
}
</code></pre>
<h2 data-id="heading-32">9.3 常见问题排查</h2>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 错误示例</span>
<span class="hljs-type">SqlSession</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> factory.openSession();
<span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> session.selectOne(<span class="hljs-string">"..."</span>);
<span class="hljs-comment">//忘记关闭 → 资源泄漏</span>

<span class="hljs-comment">//正确示例</span>
<span class="hljs-keyword">try</span> (<span class="hljs-type">SqlSession</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> factory.openSession()) {
    <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> session.selectOne(<span class="hljs-string">"..."</span>);
} <span class="hljs-comment">// 自动关闭</span>
<span class="hljs-comment">// 错误示例</span>
<span class="hljs-keyword">try</span> (<span class="hljs-type">SqlSession</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> factory.openSession()) {
    session.insert(<span class="hljs-string">"..."</span>);
    <span class="hljs-comment">// 忘记提交 → 数据未保存</span>
}

<span class="hljs-comment">//正确示例</span>
<span class="hljs-keyword">try</span> (<span class="hljs-type">SqlSession</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> factory.openSession()) {
    session.insert(<span class="hljs-string">"..."</span>);
    session.commit(); <span class="hljs-comment">// 记得提交</span>
}
<span class="hljs-comment">//错误示例</span>
<span class="hljs-keyword">private</span> <span class="hljs-type">SqlSession</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> factory.openSession();

<span class="hljs-comment">//正确示例</span>
<span class="hljs-keyword">public</span> User <span class="hljs-title function_">getUserById</span><span class="hljs-params">(Integer id)</span> {
    <span class="hljs-keyword">try</span> (<span class="hljs-type">SqlSession</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> factory.openSession()) {
        <span class="hljs-keyword">return</span> session.selectOne(<span class="hljs-string">"..."</span>, id);
    }
}
</code></pre>
<h2 data-id="heading-33">十、总结</h2>
<p>通过本文的学习，我们深入了解了MyBatis会话模块的核心内容：</p>
<pre><code class="hljs">SqlSession接口 — 定义了所有数据库操作方法
SqlSessionFactory — 负责创建和管理SqlSession实例
生命周期管理 — 方法级别创建，线程独立使用
事务控制 — 支持手动提交和自动提交两种模式
Mapper集成 — 通过动态代理实现类型安全操作
Executor类型 — SIMPLE、REUSE、BATCH各有千秋
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android Studio 的 AI Agent 有什么特别？未来会有惊艳什么功能？]]></title>    <link>https://juejin.cn/post/7590421489998610451</link>    <guid>https://juejin.cn/post/7590421489998610451</guid>    <pubDate>2026-01-03T23:04:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590421489998610451" data-draft-id="7590283328176717867" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android Studio 的 AI Agent 有什么特别？未来会有惊艳什么功能？"/> <meta itemprop="keywords" content="前端,Flutter,Android"/> <meta itemprop="datePublished" content="2026-01-03T23:04:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="恋猫de小郭"/> <meta itemprop="url" content="https://juejin.cn/user/817692379985752"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android Studio 的 AI Agent 有什么特别？未来会有惊艳什么功能？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/817692379985752/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    恋猫de小郭
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-03T23:04:56.000Z" title="Sat Jan 03 2026 23:04:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>相信大家都在之前的 <a href="https://juejin.cn/post/7579999793320247302" target="_blank" title="https://juejin.cn/post/7579999793320247302">《Android Studio Otter 2 Feature 发布》</a>已经了解过，为什么这是一个比较值得更新的 Android Studio 版本，与此同时，谷歌也和我们展示了未来（Canary）全新的 AI Agent 有什么特别之处。</p>
<p>对于一个 AI Agent 来说，最重要的有三个基础概念：<strong>工具 (Tools)</strong> 、<strong>上下文 (Context)</strong> 和 <strong>MCP (模型上下文协议)</strong> ，而大多数人对于它们的理解，可能还比较片面。</p>
<p>比如工具 ，<strong>实际上 AI Agent 不只是一个聊天场景，更多是 Agent 通过“工具”来执行任务</strong>，而不是单纯用来做文本回复，最重要的是，Agent 不会将整个代码库发送给模型，毕竟这太浪费 token ，而且还慢，事实上它只是根据用户的 Prompt（提示词），自行决定调用哪些工具 。</p>
<p>比如一般内置的有包括 <code>Find Files</code>（查找文件）、<code>read_file</code>（读取文件）、<code>version_lookup</code>（版本查询）、<code>gradle_sync</code> 等等，例如：</p>
<blockquote>
<p>开发者询问：“主题在哪里定义？”，Agent 会推断并使用 <code>Find Files</code> 搜索 <code>theme.kt</code>，而不是扫描所有文件 <img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a7fa4f17027044aaa74e62c8329ffc89~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768086296&amp;x-signature=%2B4EzlVkaQLXDLUYp5oIe14hWmLo%3D" alt="" loading="lazy"/></p>
</blockquote>
<p>你也可以通过收入 <code>/tools</code> 让 AI 展示现在存在的工具：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/72be84b624904230abc0c2581ee11b17~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768086296&amp;x-signature=K067KI%2F5XP2IopB4fzZ7lT8XTvc%3D" alt="" loading="lazy"/></p>
<p>另外的工具就是 <strong>Android 知识库 (Knowledge Base)</strong> ：为了解决大模型数据滞后的问题，例如不知道最新的 Navigation 3 API 等场景，Android Studio 集成了 <code>search_android_docs</code> 工具，它允许 Agent 搜索 Android 文档、Firebase 和 Kotlin 的最新资料等。</p>
<blockquote>
<p>所以官方建议，<strong>需要是可以在 Prompt 中加上“check the docs”（检查文档），增加触发工具执行的概率</strong> 。</p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/02b7167e21974b0a887c68d13b62e57f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768086296&amp;x-signature=bbMGdHsFsv2jSjVEs3POkZ0E%2FbY%3D" alt="" loading="lazy"/></p>
<blockquote>
<p>有了知识库之后，以后就算不更新 Android Studio ，AI 也可以通过最新知识库获取到最新的 API 和文档。</p>
</blockquote>
<p>而对于 (MCP - Model Context Protocol)，作为模型上下文协议 ，<strong>它属于扩展能力，可以让开发者连接外部服务</strong>，比如和 Figma 集成，连接本地运行的 Figma MCP 服务器，开发者可以直接在 IDE 中要求 Agent “截取我在 Figma 中选中的内容并转换当前屏幕”，从而打通设计与开发的流程 ：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c5388b889e11458a953cb94d7b63a22c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768086296&amp;x-signature=IlNrDb%2B2xBy0RuVI3J88SHn5RZE%3D" alt="" loading="lazy"/><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/92c6b04a05a34c2795cc06726910652d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768086296&amp;x-signature=IUPH%2B4I9h0iBFp0LS1hMTuzl2hE%3D" alt="" loading="lazy"/><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2867b1c458114fb5bd581ffb98c570d1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768086296&amp;x-signature=AWJllQiZxBlnZ1Xxc9WC5Ah9k7s%3D" alt="" loading="lazy"/></p>
<p>而 Context 则是用于智能感知， Agent 能够自动获取项目名称、当前打开的文件等信息作为上下文 ，而一般开发过程中，推荐用户添加自己的规则或者偏好，避免 AI 过渡自我发挥，例如：</p>
<ul>
<li><strong>agents.md</strong> ：团队共享的标准文件，可以在其中定义项目架构（如 Hilt）、代码风格或业务描述，Agent 会在执行任务时读取文件保持一致性</li>
<li><strong>层级结构</strong>：Agent 会从当前目录向上递归查找所有 <code>agents.md</code> 文件，允许在不同模块（如 data 模块）定义不同层级的上下文</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c12fba35da1f43c2b381385f47dfa138~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768086296&amp;x-signature=Zud%2FHlzJ4vm7kYRNYfLq8V40ftU%3D" alt="" loading="lazy"/><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7863a512bbd5442aa6f5dca3052bb971~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768086296&amp;x-signature=JJxT9mj9m5VKJ%2Bvij2NZVZAKzH8%3D" alt="" loading="lazy"/></p>
<p>而官方也演示了覆盖从“从零创建”到“微调完善”的 UI 开发全流程，注意这里用的也是 Canary 版本：</p>
<ul>
<li>
<p>通过自然语言 Prompt 生成完整的应用原型，Agent 会先生成一个计划（包含库和工具），用户确认后，它会生成 ViewModels、Compose UI 代码甚至单元测试</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7bec3c97c9ff45aea4d07e8e80de740d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768086296&amp;x-signature=TfSwsePIspgcqKQkMkmDBdXylr0%3D" alt="" loading="lazy"/><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7b2fa7a6b0284352b3c91f934926819a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768086296&amp;x-signature=vO5CSv1HtLEZv3fVq%2Fs7k%2FkjnvQ%3D" alt="" loading="lazy"/></p>
</li>
<li>
<p>之后用户可以将 UI 截图拖入会话，Agent 会分析并生成对应的 Jetpack Compose 代码 ，这个过程它会尝试重用现有组件，如果缺少资源（如特定图标），它甚至会尝试生成新的 Vector Drawable <img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cc0f4ecaf59f45a2b0a06775387c1e82~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768086296&amp;x-signature=auiIgMHwlT5nDDiqIpVnD6kMj08%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a0998d7f28d1489697781550150a873c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768086296&amp;x-signature=BOOm1PZukGIhS%2BDI54oNnKFCXGA%3D" alt="" loading="lazy"/><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/196dcfe04ed94639bbd7de3a79c4632c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768086296&amp;x-signature=5xZFgDB6qbx9sSvpT6T0ZTysqgQ%3D" alt="" loading="lazy"/></p>
</li>
<li>
<p>接着就是代码分析与修复，利用 IDE 现有的 Lint 和静态分析能力，通过 AI 自动修复问题（如未使用的导入、弃用的 API），避免运行耗时的 Gradle 构建 <img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7a30541bdd7347c4bc7cf3cd36e04870~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768086296&amp;x-signature=mOtROz0DgIMTLqlaQx6y2iC1XL0%3D" alt="" loading="lazy"/></p>
</li>
<li>
<p>然后是 UI 匹配，当现有组件需要根据新设计图进行迭代时使用，用户上传新设计图，Agent 会分析差异并自动调整现有代码从而匹配新设计 <img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/964242ecf91b47c78a1acc4c2fa54de2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768086296&amp;x-signature=v43B1LrXxVV8YsAFZNCxLzJ6KC0%3D" alt="" loading="lazy"/></p>
</li>
<li>
<p>然后是预览，Agent 会调用 <code>Render Compose Preview</code> 工具在聊天窗口中直接渲染预览，从而验证修改是否正确且可编译 <img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/759993ee3e2544949f41a21336bba6a4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768086296&amp;x-signature=TwNzdQ6y9%2FLgWVqfV0xxU2eNcoc%3D" alt="" loading="lazy"/></p>
</li>
<li>
<p>接着就是通过自然语言指令修改 UI，比如输入“左对齐设置、增大字体、添加柔和的渐变背景”，Agent 会将这些指令转化为代码修改</p>
</li>
<li>
<p>最后结合 UI Check 模式（用于检测可访问性、屏幕适配等问题），当 UI Check 检测到“颜色对比度不足”时，用户可以点击“Fix with AI”，Agent 会自动寻找合适的颜色代码并修复该可访问性问题，最后重新运行检查以确保问题已解决 <img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b7f3ce3224e345d8a99dc199a8ea5d1a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768086296&amp;x-signature=qz3%2B0BXzHyPZimaB4y801j%2BoKmo%3D" alt="" loading="lazy"/><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1c573450d5b0452e8198665e48529e4c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768086296&amp;x-signature=Xi%2F2IokxuZPhLZpB5gQPH62kcis%3D" alt="image-20251223112251073" loading="lazy"/></p>
</li>
</ul>
<p>可以看到，未来的 Android Studio Agent 会有更加丰富的多模态处理能力，比如更好的设计稿理解，图片理解，可以做到设计图和现有 UI 的差异识别并进行改动，甚至直接生成预览效果，同时还支持 UI 检测等，对于 Android 开发者来说，以后也许真的就是动动嘴皮子而已。</p>
<blockquote>
<p>对于 android 开发者来说， AI Agent 的 Android Studio 体验实际会比 antigravity 更好？</p>
</blockquote>
<h2 data-id="heading-0">参考链接</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.youtube.com%2Fwatch%3Fv%3DjTlW8JeCClA" target="_blank" title="https://www.youtube.com/watch?v=jTlW8JeCClA" ref="nofollow noopener noreferrer">www.youtube.com/watch?v=jTl…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[深入理解 Interlocked.CompareExchange：C#.NET 原子操作核心原理]]></title>    <link>https://juejin.cn/post/7590597231707783203</link>    <guid>https://juejin.cn/post/7590597231707783203</guid>    <pubDate>2026-01-03T22:59:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590597231707783203" data-draft-id="7590292192989495336" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="深入理解 Interlocked.CompareExchange：C#.NET 原子操作核心原理"/> <meta itemprop="keywords" content="C#,.NET"/> <meta itemprop="datePublished" content="2026-01-03T22:59:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="唐青枫"/> <meta itemprop="url" content="https://juejin.cn/user/3737995266234280"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            深入理解 Interlocked.CompareExchange：C#.NET 原子操作核心原理
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3737995266234280/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    唐青枫
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-03T22:59:38.000Z" title="Sat Jan 03 2026 22:59:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">什么是 Interlocked.CompareExchange？</h3>
<p><code>Interlocked.CompareExchange</code> 是 <code>.NET</code> 中 <code>System.Threading.Interlocked</code> 类的最核心原子操作方法。它执行比较并交换（<code>Compare-And-Swap</code>，简称 <code>CAS</code>） 操作：在多线程环境下，安全地将变量的值与预期值比较，如果相等则替换为新值，整个过程原子不可中断。</p>
<p>关键特性</p>
<ul>
<li>
<p>原子性：整个操作在CPU级别是原子的，不会被线程调度打断</p>
</li>
<li>
<p>无锁操作：无需使用锁即可实现线程安全</p>
</li>
<li>
<p>内存屏障：隐含完整内存屏障（<code>full fence</code>），确保操作前后内存访问顺序</p>
</li>
</ul>
<p>返回值重要性：返回值是判断操作是否成功的关键</p>
<ul>
<li>核心签名（常见重载）：</li>
</ul>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">int</span> <span class="hljs-title">CompareExchange</span>(<span class="hljs-params"><span class="hljs-keyword">ref</span> <span class="hljs-built_in">int</span> location, <span class="hljs-built_in">int</span> <span class="hljs-keyword">value</span>, <span class="hljs-built_in">int</span> comparand</span>)</span>;
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">long</span> <span class="hljs-title">CompareExchange</span>(<span class="hljs-params"><span class="hljs-keyword">ref</span> <span class="hljs-built_in">long</span> location, <span class="hljs-built_in">long</span> <span class="hljs-keyword">value</span>, <span class="hljs-built_in">long</span> comparand</span>)</span>;
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> T <span class="hljs-title">CompareExchange</span>&lt;<span class="hljs-title">T</span>&gt;(<span class="hljs-params"><span class="hljs-keyword">ref</span> T location, T <span class="hljs-keyword">value</span>, T comparand</span>) <span class="hljs-keyword">where</span> T : <span class="hljs-keyword">class</span></span>;
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">float</span> <span class="hljs-title">CompareExchange</span>(<span class="hljs-params"><span class="hljs-keyword">ref</span> <span class="hljs-built_in">float</span> location, <span class="hljs-built_in">float</span> <span class="hljs-keyword">value</span>, <span class="hljs-built_in">float</span> comparand</span>)</span>;
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">double</span> <span class="hljs-title">CompareExchange</span>(<span class="hljs-params"><span class="hljs-keyword">ref</span> <span class="hljs-built_in">double</span> location, <span class="hljs-built_in">double</span> <span class="hljs-keyword">value</span>, <span class="hljs-built_in">double</span> comparand</span>)</span>;
</code></pre>
<ul>
<li>
<p>参数解释：</p>
<ul>
<li>
<p><code>location</code>：要操作的共享变量（必须用 <code>ref</code> 传递）。</p>
</li>
<li>
<p><code>value</code>：如果比较成功，要写入的新值。</p>
</li>
<li>
<p><code>comparand</code>：预期旧值（用于比较）。</p>
</li>
<li>
<p>返回值：操作前 <code>location</code> 的实际值（无论成功与否都返回旧值）。</p>
</li>
</ul>
</li>
</ul>
<p><code>CAS</code> 是现代无锁（<code>lock-free</code>）并发编程的基础，许多高级结构（如 <code>ConcurrentDictionary</code>、<code>SpinLock</code>）内部都依赖它。</p>
<h3 data-id="heading-1">为什么使用 Interlocked.CompareExchange？</h3>
<p>在多线程中，直接读取-修改-写入（如 <code>if (count == 0) count = 1;</code>）会产生竞争条件：多个线程可能同时读取相同值，导致覆盖更新。</p>
<ul>
<li>
<p>传统锁的问题：<code>lock</code> 开销大（互斥锁、上下文切换），不适合高频轻量操作。</p>
</li>
<li>
<p><code>CAS</code> 的优势：</p>
<ul>
<li>
<p>无锁（<code>Lock-Free</code>）：不阻塞线程，高并发下性能极高。</p>
</li>
<li>
<p>乐观并发：假设冲突少，先尝试操作，失败则重试（自旋）。</p>
</li>
<li>
<p>原子性：硬件级保证（<code>x86 的 cmpxchg</code> 指令）。</p>
</li>
</ul>
</li>
<li>
<p>典型应用场景：</p>
<ul>
<li>
<p>实现线程安全的单例模式（双检查锁）。</p>
</li>
<li>
<p>自定义无锁队列/栈。</p>
</li>
<li>
<p>原子更新复杂状态（标志位 + 计数器）。</p>
</li>
<li>
<p>实现自定义同步原语（如 <code>SpinLock</code>、<code>SemaphoreSlim</code> 内部）。</p>
</li>
</ul>
</li>
</ul>
<p>传统的 “比较 + 赋值” 是两步非原子操作，多线程下会因竞态条件导致逻辑错误。</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 非原子操作：多线程下可能同时通过if判断，导致赋值错误</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">int</span> _value = <span class="hljs-number">0</span>;
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">UnsafeUpdate</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> oldVal, <span class="hljs-built_in">int</span> newVal</span>)</span>
{
    <span class="hljs-keyword">if</span> (_value == oldVal) <span class="hljs-comment">// 步骤1：读取并比较</span>
    {
        _value = newVal;  <span class="hljs-comment">// 步骤2：赋值</span>
    }
}
</code></pre>
<p>两个线程可能同时通过if判断（都读到 <code>_value=oldVal</code> ），最终都执行赋值，导致逻辑错误。</p>
<p><code>Interlocked.CompareExchange</code> 将 “比较” 和 “赋值” 合并为不可中断的原子操作，从底层杜绝竞态条件，且无需阻塞线程（无锁）。</p>
<p>与 <code>lock</code> 的根本区别</p>



































<table><thead><tr><th>维度</th><th>lock</th><th>CompareExchange</th></tr></thead><tbody><tr><td>是否阻塞</td><td>是</td><td>否</td></tr><tr><td>是否上下文切换</td><td>是</td><td>否</td></tr><tr><td>粒度</td><td>任意代码块</td><td>单变量</td></tr><tr><td>性能</td><td>较低</td><td>极高</td></tr><tr><td>适合</td><td>复杂逻辑</td><td>状态切换</td></tr></tbody></table>
<h3 data-id="heading-2">什么时候该用 CompareExchange？</h3>





























<table><thead><tr><th>场景</th><th>推荐</th></tr></thead><tbody><tr><td>简单状态切换</td><td>✔</td></tr><tr><td>计数、标志位</td><td>✔</td></tr><tr><td>高并发热点</td><td>✔</td></tr><tr><td>复杂业务流程</td><td>❌</td></tr><tr><td>多变量一致性</td><td>❌</td></tr></tbody></table>
<h3 data-id="heading-3">如何使用 Interlocked.CompareExchange？</h3>
<h4 data-id="heading-4">最简单的 CAS 操作（判断是否交换成功）</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">int</span> _counter = <span class="hljs-number">0</span>;

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">TestCas</span>()</span>
{
    <span class="hljs-comment">// 目标：如果_counter是0，就改为100</span>
    <span class="hljs-built_in">int</span> expected = <span class="hljs-number">0</span>;    <span class="hljs-comment">// 预期值</span>
    <span class="hljs-built_in">int</span> newValue = <span class="hljs-number">100</span>;  <span class="hljs-comment">// 新值</span>
    
    <span class="hljs-comment">// 执行CAS操作</span>
    <span class="hljs-built_in">int</span> original = Interlocked.CompareExchange(<span class="hljs-keyword">ref</span> _counter, newValue, expected);
    
    <span class="hljs-comment">// 判断是否交换成功（原始值 == 预期值 → 成功）</span>
    <span class="hljs-keyword">if</span> (original == expected)
    {
        Console.WriteLine(<span class="hljs-string">$"交换成功！原始值：<span class="hljs-subst">{original}</span>，新值：<span class="hljs-subst">{_counter}</span>"</span>);
    }
    <span class="hljs-keyword">else</span>
    {
        Console.WriteLine(<span class="hljs-string">$"交换失败！原始值：<span class="hljs-subst">{original}</span>，当前值：<span class="hljs-subst">{_counter}</span>"</span>);
    }
}
</code></pre>
<p>输出：交换成功！原始值：0，新值：100（若再次执行，会输出失败，因为<code>_counter</code> 已不是 0）。</p>
<h4 data-id="heading-5">原子条件更新</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">private</span> <span class="hljs-built_in">int</span> _status = <span class="hljs-number">0</span>;  <span class="hljs-comment">// 0: 未初始化, 1: 初始化中, 2: 已完成</span>

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Initialize</span>()</span>
{
    <span class="hljs-keyword">if</span> (Interlocked.CompareExchange(<span class="hljs-keyword">ref</span> _status, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>) == <span class="hljs-number">0</span>)
    {
        <span class="hljs-comment">// 只有第一个线程进入这里</span>
        <span class="hljs-keyword">try</span>
        {
            <span class="hljs-comment">// 执行初始化逻辑</span>
            DoInitialize();
        }
        <span class="hljs-keyword">finally</span>
        {
            <span class="hljs-comment">// 标记完成（原子操作，无需 CAS）</span>
            Interlocked.Exchange(<span class="hljs-keyword">ref</span> _status, <span class="hljs-number">2</span>);
        }
    }
    <span class="hljs-keyword">else</span>
    {
        <span class="hljs-comment">// 其他线程等待完成</span>
        <span class="hljs-keyword">while</span> (_status != <span class="hljs-number">2</span>) Thread.SpinWait(<span class="hljs-number">10</span>);
    }
}
</code></pre>
<ul>
<li>解释：只有当 <code>_status</code> 为 0 时才设置为 1 并执行初始化。</li>
</ul>
<h4 data-id="heading-6">实现自旋锁</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">SpinLock</span>
{
    <span class="hljs-keyword">private</span> <span class="hljs-built_in">int</span> _lock = <span class="hljs-number">0</span>; <span class="hljs-comment">// 0=未锁定, 1=已锁定</span>
    
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Enter</span>()</span>
    {
        <span class="hljs-keyword">while</span> (Interlocked.CompareExchange(<span class="hljs-keyword">ref</span> _lock, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>) != <span class="hljs-number">0</span>)
        {
            <span class="hljs-comment">// 等待 - 可以使用Thread.SpinWait优化</span>
            Thread.SpinWait(<span class="hljs-number">100</span>);
        }
    }
    
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Exit</span>()</span>
    {
        Interlocked.Exchange(<span class="hljs-keyword">ref</span> _lock, <span class="hljs-number">0</span>);
    }
}
</code></pre>
<h4 data-id="heading-7">经典场景：无锁计数器（循环 CAS）</h4>
<p>单次 <code>CAS</code> 可能因其他线程修改变量失败，需循环重试（自旋 <code>CAS</code>），实现线程安全的计数器：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">int</span> _casCounter = <span class="hljs-number">0</span>;

<span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span>
<span class="hljs-comment"><span class="hljs-doctag">///</span> 无锁原子递增（替代Interlocked.Increment）</span>
<span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">int</span> <span class="hljs-title">IncrementCounter</span>()</span>
{
    <span class="hljs-built_in">int</span> current;   <span class="hljs-comment">// 当前值</span>
    <span class="hljs-built_in">int</span> newValue;  <span class="hljs-comment">// 新值</span>
    <span class="hljs-keyword">do</span>
    {
        <span class="hljs-comment">// 1. 原子读取当前值（Interlocked保证可见性）</span>
        current = _casCounter;
        <span class="hljs-comment">// 2. 计算新值（仅本地计算，无竞态）</span>
        newValue = current + <span class="hljs-number">1</span>;
        <span class="hljs-comment">// 3. CAS操作：若当前值未被修改，就更新为新值</span>
        <span class="hljs-comment">// 返回值≠current → 被其他线程修改，重试</span>
    } <span class="hljs-keyword">while</span> (Interlocked.CompareExchange(<span class="hljs-keyword">ref</span> _casCounter, newValue, current) != current);
    
    <span class="hljs-keyword">return</span> newValue; <span class="hljs-comment">// 返回递增后的值</span>
}

<span class="hljs-comment">// 测试：1000个线程各调用1次，最终结果必为1000</span>
<span class="hljs-keyword">var</span> tasks = Enumerable.Range(<span class="hljs-number">0</span>, <span class="hljs-number">1000</span>)
    .Select(_ =&gt; Task.Run(IncrementCounter))
    .ToList();
Task.WaitAll(tasks.ToArray());
Console.WriteLine(<span class="hljs-string">$"最终计数器值：<span class="hljs-subst">{_casCounter}</span>"</span>); <span class="hljs-comment">// 输出：1000</span>
</code></pre>
<h3 data-id="heading-8">高级应用场景</h3>
<h4 data-id="heading-9">泛型版本：懒加载单例（双检查锁模式）</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">sealed</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Singleton</span>
{
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Singleton _instance = <span class="hljs-literal">null</span>;

    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-title">Singleton</span>()</span> { }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Singleton Instance
    {
        <span class="hljs-keyword">get</span>
        {
            <span class="hljs-keyword">if</span> (_instance == <span class="hljs-literal">null</span>)
            {
                <span class="hljs-keyword">var</span> temp = <span class="hljs-keyword">new</span> Singleton();
                Interlocked.CompareExchange(<span class="hljs-keyword">ref</span> _instance, temp, <span class="hljs-literal">null</span>);
            }
            <span class="hljs-keyword">return</span> _instance;
        }
    }
}
</code></pre>
<p>在 <code>.NET</code> 中需加 <code>Lazy&lt;T&gt;</code> 更安全：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Lazy&lt;Singleton&gt; _instance = <span class="hljs-keyword">new</span> Lazy&lt;Singleton&gt;(() =&gt; <span class="hljs-keyword">new</span> Singleton());
<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Singleton Instance =&gt; _instance.Value;
</code></pre>
<h4 data-id="heading-10">无锁状态机（原子状态转换）</h4>
<p>控制对象状态的原子转换（如从 <code>Idle→Running</code> ，避免状态混乱）：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 定义状态枚举</span>
<span class="hljs-keyword">public</span> <span class="hljs-built_in">enum</span> TaskState { Idle, Running, Completed, Failed }

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">TaskStateMachine</span>
{
    <span class="hljs-keyword">private</span> TaskState _state = TaskState.Idle;

    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span>
    <span class="hljs-comment"><span class="hljs-doctag">///</span> 原子转换：Idle → Running（仅当状态为Idle时成功）</span>
    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">bool</span> <span class="hljs-title">TryStart</span>()</span>
    {
        TaskState original = Interlocked.CompareExchange(
            <span class="hljs-keyword">ref</span> _state, 
            TaskState.Running,  <span class="hljs-comment">// 新值</span>
            TaskState.Idle      <span class="hljs-comment">// 预期值</span>
        );
        <span class="hljs-keyword">return</span> original == TaskState.Idle; <span class="hljs-comment">// 原始值=预期值 → 转换成功</span>
    }

    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span>
    <span class="hljs-comment"><span class="hljs-doctag">///</span> 原子转换：Running → Completed</span>
    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">bool</span> <span class="hljs-title">TryComplete</span>()</span>
    {
        TaskState original = Interlocked.CompareExchange(
            <span class="hljs-keyword">ref</span> _state, 
            TaskState.Completed, 
            TaskState.Running
        );
        <span class="hljs-keyword">return</span> original == TaskState.Running;
    }
}

<span class="hljs-comment">// 使用</span>
<span class="hljs-keyword">var</span> stateMachine = <span class="hljs-keyword">new</span> TaskStateMachine();
Console.WriteLine(stateMachine.TryStart());    <span class="hljs-comment">// true（状态变为Running）</span>
Console.WriteLine(stateMachine.TryStart());    <span class="hljs-comment">// false（已不是Idle）</span>
Console.WriteLine(stateMachine.TryComplete()); <span class="hljs-comment">// true（状态变为Completed）</span>
</code></pre>
<h4 data-id="heading-11">自旋实现原子加法（模拟 Interlocked.Add）</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">private</span> <span class="hljs-built_in">int</span> _counter = <span class="hljs-number">0</span>;

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> <span class="hljs-title">Increment</span>()</span>
{
    <span class="hljs-built_in">int</span> oldValue, newValue;
    <span class="hljs-keyword">do</span>
    {
        oldValue = _counter;
        newValue = oldValue + <span class="hljs-number">1</span>;
    } <span class="hljs-keyword">while</span> (Interlocked.CompareExchange(<span class="hljs-keyword">ref</span> _counter, newValue, oldValue) != oldValue);
    <span class="hljs-keyword">return</span> newValue;
}
</code></pre>
<ul>
<li>解释：循环直到 <code>CAS</code> 成功（自旋），实现无锁递增</li>
</ul>
<h4 data-id="heading-12">对象引用替换（线程安全赋值）</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">private</span> List&lt;<span class="hljs-built_in">int</span>&gt; _cache = <span class="hljs-literal">null</span>;

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">UpdateCache</span>(<span class="hljs-params">List&lt;<span class="hljs-built_in">int</span>&gt; newCache</span>)</span>
{
    Interlocked.CompareExchange(<span class="hljs-keyword">ref</span> _cache, newCache, _cache);  <span class="hljs-comment">// 仅当未被其他线程修改时更新</span>
}
</code></pre>
<h3 data-id="heading-13">Interlocked.CompareExchange 的内部实现</h3>
<ul>
<li>
<p>硬件支持：</p>
<ul>
<li>
<p><code>x86/x64</code>：<code>LOCK CMPXCHG</code> 指令，总线锁保证原子性。</p>
</li>
<li>
<p><code>ARM</code>：LDREX/STREX 指令对（<code>Load-Exclusive/Store-Exclusive</code>），失败重试。</p>
</li>
</ul>
</li>
</ul>
<p>同时，该操作会触发全内存屏障（<code>Full Memory Barrier</code>）：</p>
<ul>
<li>
<p>保证操作前后的内存读写不会被 <code>CPU</code> 重排序；</p>
</li>
<li>
<p>确保所有线程能立即看到变量的最新值（避免 <code>CPU</code> 缓存导致的 “脏读”）。</p>
</li>
<li>
<p><code>.NET</code> 实现（<code>CoreCLR</code> 简化伪码）：</p>
</li>
</ul>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">int</span> <span class="hljs-title">CompareExchange</span>(<span class="hljs-params"><span class="hljs-keyword">ref</span> <span class="hljs-built_in">int</span> location, <span class="hljs-built_in">int</span> <span class="hljs-keyword">value</span>, <span class="hljs-built_in">int</span> comparand</span>)</span>
{
    <span class="hljs-comment">// 内联为平台特定原子指令</span>
    <span class="hljs-keyword">fixed</span> (<span class="hljs-built_in">int</span>* ptr = &amp;location)
    {
        <span class="hljs-keyword">return</span> InterlockedCompareExchange(ptr, <span class="hljs-keyword">value</span>, comparand);
    }
}
</code></pre>
<ul>
<li>
<p>性能：</p>
<ul>
<li>
<p>无竞争：<code>O(1)</code>，极快。</p>
</li>
<li>
<p>高竞争：自旋消耗 <code>CPU</code>，但仍远优于锁（无上下文切换）。</p>
</li>
</ul>
</li>
</ul>
<h3 data-id="heading-14">注意事项与最佳实践</h3>
<ul>
<li>
<p>自旋循环：总是用 <code>do-while</code> 包装 <code>CAS</code>，形成“乐观循环”。</p>
</li>
<li>
<p><code>ABA</code> 问题：</p>
<ul>
<li>
<p>线程 1 读取值为A，准备 <code>CAS</code> 为C；线程 2 将A改为B，又改回A；线程 1 的 <code>CAS</code> 会成功，但中间状态已变化，可能导致逻辑错误</p>
</li>
<li>
<p>解决方法：版本号 + 引用 <code>CAS</code>。</p>
</li>
</ul>
</li>
<li>
<p>内存可见性：<code>Interlocked</code> 操作自带全内存屏障（<code>full fence</code>），无需额外 <code>volatile</code>。</p>
</li>
<li>
<p>避免过度使用：简单计数用 <code>Interlocked.Increment</code>；集合用 <code>Concurrent</code> 类。</p>
</li>
<li>
<p>替代方案：</p>
<ul>
<li>
<p>高层：<code>ConcurrentDictionary、BlockingCollection</code>。</p>
</li>
<li>
<p>现代：<code>System.Threading.Channels</code>（生产者-消费者）。</p>
</li>
<li>
<p><code>.NET 8+</code>：考虑 <code>System.Threading.Lock</code>（<code>C# 12</code> 新特性，更简洁）。</p>
</li>
</ul>
</li>
</ul>
<h3 data-id="heading-15">ABA 问题</h3>
<h4 data-id="heading-16">什么是 ABA 问题？</h4>
<p><code>ABA</code> 问题 是无锁（<code>lock-free</code>）编程中使用 <code>Compare-And-Swap</code> (<code>CAS</code>) 操作时的一种经典隐患。</p>
<p>场景描述：</p>
<ul>
<li>
<p>线程 A 读取共享变量值：A</p>
</li>
<li>
<p>线程 B 先将值改为 B，然后又改回 A</p>
</li>
<li>
<p>线程 A 执行 <code>CAS</code>：期望值是 A，当前值也是 A → <code>CAS</code> 成功！</p>
</li>
<li>
<p>但实际上值已经被其他线程修改过，语义已经改变，线程 A 却误以为“一切未变”。</p>
</li>
</ul>
<p>这会导致逻辑错误，尤其在无锁栈、队列等数据结构中，可能造成节点丢失、循环引用或内存泄漏。</p>
<h4 data-id="heading-17">解决方案：版本号 + 引用 CAS</h4>
<ol>
<li>定义「版本化状态对象」</li>
</ol>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">sealed</span> <span class="hljs-keyword">class</span> <span class="hljs-title">VersionedValue</span>
{
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> Value;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">int</span> Version;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">VersionedValue</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> <span class="hljs-keyword">value</span>, <span class="hljs-built_in">int</span> version</span>)</span>
    {
        Value = <span class="hljs-keyword">value</span>;
        Version = version;
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-built_in">string</span> <span class="hljs-title">ToString</span>()</span>
        =&gt; <span class="hljs-string">$"Value=<span class="hljs-subst">{Value}</span>, Version=<span class="hljs-subst">{Version}</span>"</span>;
}
</code></pre>
<p>关键点：</p>
<ul>
<li>
<p>不可变（<code>readonly</code>）</p>
</li>
<li>
<p>每次修改 → 新对象</p>
</li>
<li>
<p><code>CAS</code> 比较的是 对象引用</p>
</li>
</ul>
<ol start="2">
<li>运行示例</li>
</ol>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">using</span> System;
<span class="hljs-keyword">using</span> System.Threading;
<span class="hljs-keyword">using</span> System.Threading.Tasks;

<span class="hljs-keyword">class</span> <span class="hljs-title">Program</span>
{
    <span class="hljs-keyword">static</span> VersionedValue state = <span class="hljs-keyword">new</span> VersionedValue(<span class="hljs-number">1</span>, <span class="hljs-number">0</span>);

    <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Main</span>()</span>
    {
        <span class="hljs-keyword">var</span> t1 = Task.Run(Thread1);
        <span class="hljs-keyword">var</span> t2 = Task.Run(Thread2);

        Task.WaitAll(t1, t2);

        Console.WriteLine(<span class="hljs-string">$"Final state: <span class="hljs-subst">{state}</span>"</span>);
    }

    <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Thread1</span>()</span>
    {
        <span class="hljs-keyword">var</span> old = state; <span class="hljs-comment">// 读 A(v0)</span>
        Console.WriteLine(<span class="hljs-string">$"T1 read: <span class="hljs-subst">{old}</span>"</span>);

        Thread.Sleep(<span class="hljs-number">200</span>);

        <span class="hljs-keyword">var</span> newState = <span class="hljs-keyword">new</span> VersionedValue(<span class="hljs-number">3</span>, old.Version + <span class="hljs-number">1</span>);

        <span class="hljs-keyword">var</span> result = Interlocked.CompareExchange(
            <span class="hljs-keyword">ref</span> state,
            newState,
            old
        );

        <span class="hljs-keyword">if</span> (result == old)
        {
            Console.WriteLine(<span class="hljs-string">"T1 CAS succeeded"</span>);
        }
        <span class="hljs-keyword">else</span>
        {
            Console.WriteLine(<span class="hljs-string">$"T1 CAS failed, current = <span class="hljs-subst">{result}</span>"</span>);
        }
    }

    <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Thread2</span>()</span>
    {
        Thread.Sleep(<span class="hljs-number">50</span>);

        <span class="hljs-comment">// A → B</span>
        state = <span class="hljs-keyword">new</span> VersionedValue(<span class="hljs-number">2</span>, state.Version + <span class="hljs-number">1</span>);
        <span class="hljs-comment">// B → A</span>
        state = <span class="hljs-keyword">new</span> VersionedValue(<span class="hljs-number">1</span>, state.Version + <span class="hljs-number">1</span>);

        Console.WriteLine(<span class="hljs-string">$"T2 changed state twice: <span class="hljs-subst">{state}</span>"</span>);
    }
}
</code></pre>
<ol start="3">
<li>典型输出</li>
</ol>
<pre><code class="hljs language-ini" lang="ini">T1 read: <span class="hljs-attr">Value</span>=<span class="hljs-number">1</span>, Version=<span class="hljs-number">0</span>
T2 changed state twice: <span class="hljs-attr">Value</span>=<span class="hljs-number">1</span>, Version=<span class="hljs-number">2</span>
T1 CAS failed, <span class="hljs-attr">current</span> = Value=<span class="hljs-number">1</span>, Version=<span class="hljs-number">2</span>
Final state: <span class="hljs-attr">Value</span>=<span class="hljs-number">1</span>, Version=<span class="hljs-number">2</span>
</code></pre>
<p>核心结果：</p>
<ul>
<li>
<p>值还是 1</p>
</li>
<li>
<p>版本已经变了</p>
</li>
<li>
<p><code>CAS</code> 失败</p>
</li>
<li>
<p><code>ABA</code> 被成功识别</p>
</li>
</ul>
<h4 data-id="heading-18">为什么这个方案一定能防 ABA？</h4>
<blockquote>
<p>CAS 比较的是“对象引用”，而不是值</p>
</blockquote>
<p>即使：</p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">Value: 1 → 2 → 1</span>
</code></pre>
<p>但：</p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">Reference: A → B → C</span>
</code></pre>
<p>A ≠ C</p>
<p><code>CAS</code> 不可能误判成功</p>
<h4 data-id="heading-19">黄金组合</h4>

























<table><thead><tr><th>技术</th><th>作用</th></tr></thead><tbody><tr><td>Interlocked.CompareExchange</td><td>原子性</td></tr><tr><td>不可变对象</td><td>消除中间态</td></tr><tr><td>版本号</td><td>明确变化历史</td></tr><tr><td>GC</td><td>避免悬垂指针</td></tr></tbody></table>
<blockquote>
<p>.NET 官方并发集合、Immutable 系列，都是这个思想</p>
</blockquote>
<h4 data-id="heading-20">什么时候该用这一套？</h4>
<p>适合：</p>
<ul>
<li>
<p>自定义状态机</p>
</li>
<li>
<p><code>CAS</code> + 状态切换</p>
</li>
<li>
<p>无锁缓存</p>
</li>
<li>
<p>高频并发更新</p>
</li>
</ul>
<p>不适合：</p>
<ul>
<li>
<p>普通计数</p>
</li>
<li>
<p>简单标志位</p>
</li>
<li>
<p>低并发业务</p>
</li>
</ul>
<h3 data-id="heading-21">总结</h3>
<blockquote>
<p>Interlocked.CompareExchange 是 .NET 无锁并发的“原子开关”
用它可以：</p>
<ul>
<li>不加锁</li>
<li>不阻塞</li>
<li>在竞争中安全修改状态</li>
</ul>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[2025年终总结，智启]]></title>    <link>https://juejin.cn/post/7590421489998479379</link>    <guid>https://juejin.cn/post/7590421489998479379</guid>    <pubDate>2026-01-03T15:30:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590421489998479379" data-draft-id="7590309337861521449" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="2025年终总结，智启"/> <meta itemprop="keywords" content="AIGC,人工智能"/> <meta itemprop="datePublished" content="2026-01-03T15:30:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="袁庭新"/> <meta itemprop="url" content="https://juejin.cn/user/1207714136735408"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            2025年终总结，智启
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1207714136735408/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    袁庭新
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-03T15:30:13.000Z" title="Sat Jan 03 2026 15:30:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读15分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是袁庭新。2025年就这么溜走了，对我而言，是极为不寻常的一年，总是想着用文字把它记录下来。</p>
<h2 data-id="heading-0">文章输出</h2>
<p>写是为了更好的思考，坚持写作，力争更好的思考。</p>
<p>2025年累计发表54篇原创文章，平均1周更1篇，大多数是技术相关。2025年我有个转变——每个月写一篇月总结，对这个月主要做了什么事做一个系统的梳理，尽量以可量化的形式呈现，比如，这个月写了多少篇文章，拍了几条短视频，录了几节课，办了几场讲座等诸如此类。</p>
<p>为什么采用这种方式呢？前些年我也不是没写过年终总结，年底一回顾，感觉又稀里糊涂过了一年，好像什么事儿也没干。这种感觉让我很难受，同时我也觉得很可怕，因此在2025年我调整了自己的工作方式，每个月必须要有可量化的产出内容，不然那可真的就白活了一个月，如果每个月没有产出，那可就又白活了一年。</p>
<p>一句话总结为什么要坚持写文章，目的就是“以生产为导向”来倒逼自己不断输入。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/957d4f50d7584a4ca9e29e7a0048fd0f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KKB5bqt5paw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768059012&amp;x-signature=1A5CeDLXLszvlrsFqpAYxGsy8YM%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-1">短视频创作</h2>
<p>2025年共计录制52条短视频，一年刚好52个周，平均一周刚好更一条。说实话，2025年在短视频创作上偷懒了，最后一个季度基本上就没咋更新过，2026年还需要继续努力。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d454435f50694140b0f9016d72c063b3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KKB5bqt5paw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768059012&amp;x-signature=SBBOJIMjXjljaepTeBz8Wg7zIew%3D" alt="" loading="lazy"/></p>
<p>我为什么要坚持拍短视频？拍摄一条短视频内容，有很多个环节——编剧、导演、演出、拍摄、剪辑、配音/配乐、发行、宣传。随便一数就至少有8个环节，一条短视频从头到位都是由你一个人制作完成，你说对一个人锻炼大不大？</p>
<h2 data-id="heading-2">讲义研发</h2>
<p>2025年共计研发了14套讲义，分别是：《Lua教程-V1.1》、《Redis 7.x企业级开发实战教程》、《DeepSeek快速入门》、《LLM提示词工程》、《使用大模型高效学习》、《AI高效办公解决方案》、《用DeepSeek高效生成图文音频与视频》、《大模型本地部署》、《个人知识库搭建》、《搭建批量处理工作流》、《搭建AI Agent智能体》、《零代码搞定项目开发部署》、《微信商业生态平民创业》、《职业发展与求职类AI智能体》。</p>
<p>这些讲义都是图文并茂，可以边学边练，快速提升专业知识能力，部分讲义见下图：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d5788ebae4ee4f0e9a504e6811f7de35~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KKB5bqt5paw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768059012&amp;x-signature=wjOEwqrwgsj93WqBSeIZAX%2Fs1q0%3D" alt="" loading="lazy"/></p>
<p>我一直认为自己的研发能力很强，但今年7月、9月和10月却把大量时间投入在市场支持上，几乎没什么研发产出。如果当时不去开拓市场，至少还能多完成5套讲义的研发。</p>
<h2 data-id="heading-3">课程研发</h2>
<p>2025年，共计完成11门精品课程的录制，并在小鹅通、B站课堂和淘宝平台上架。其中，与人工智能技术应用相关的就有310节课程，软件开发的有404节课程。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d02c3c529f2244efa72a67a840078732~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KKB5bqt5paw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768059012&amp;x-signature=rf2037rBOyCa%2Fgx0ctot%2FOH1DOs%3D" alt="" loading="lazy"/></p>
<p>这里我要重点强调的是《职业技术认证培训课程》，2025年主要的时间精力都围绕在这门课程上，也是我花心思最多的一门课程，且在2026年是我重点去迭代维护的一门课程。</p>
<p>这套《职业技术认证培训课程》课程涵盖文案写作、PPT制作、数据分析、思维导图、会议纪要、视频生成、生活、教育、创业、政务、法律、投研、科研、自媒体、智能体、软件开发、等50余高频工作场景。课程内容还在陆续开发中。</p>
<h2 data-id="heading-4">上线专栏</h2>
<p>2025年1月，我上线了《Redis 7.x企业级开发实战教程》专栏，共计82篇文章，这也是我人生中上线的第一个付费专栏。本专栏全面覆盖Redis技术精髓，从基础概念到高级应用一网打尽。涵盖Redis基本操作、数据类型、分布式缓存、Lua脚本、性能优化及面试技巧。无论你是初学者还是进阶者，都能在此找到提升Redis技能的宝贵资源。实战导向，助力你在项目中高效运用Redis，成为缓存技术高手！</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/00a110ccb3ab40b784b6bd10e8ed63be~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KKB5bqt5paw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768059012&amp;x-signature=yZ172yJr8vBFmVYkcbM6GxiDLzo%3D" alt="" loading="lazy"/></p>
<p>专栏《Redis 7.x企业级开发实战教程》的核心大纲内容见下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fdf498d3dbf1423e8f41a357eeaca9ef~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KKB5bqt5paw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768059012&amp;x-signature=lne1bGtwJ%2BIPpMH1mpzvsRU6als%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-5">讲座授课</h2>
<p>2025年，共计开展了20场讲座或授课活动，覆盖1890人。与在校大学生或企业进行了面对面的深度交流，都是与AI相关的报告。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5d1ec8a8df0f48bf89754ba6c54fdb1d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KKB5bqt5paw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768059012&amp;x-signature=QQdBn%2BYubbSYSw201pNF1173iXw%3D" alt="" loading="lazy"/></p>
<p>这是同学们在现场学习的照片，看得出来大家对AI的学习热情非常高！</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7cb4beb002cb418e99021d462e67dbc2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KKB5bqt5paw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768059012&amp;x-signature=BKmqYQp1TRvmNdmu7dFxAhrBXA0%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-6">知识库搭建</h2>
<p>1.人人都要学AI知识库</p>
<p>未来是一个“人人都能学AI，人人都要学AI”的时代。我把我研发的提供保姆级教程、AI工具实操、案例解析及开源项目等教程都整理放在这个知识库里了，目的就是为大家构建一个系统化AI知识体系。截至今日，该知识库中共有98篇文档，271118字。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/54096b5cf421414db4e23aa5a618e392~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KKB5bqt5paw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768059012&amp;x-signature=%2FHNFzrNiGcwaDiPmWP%2ByufmrzeU%3D" alt="" loading="lazy"/></p>
<p>2.圆心学堂星球知识库</p>
<p>这个知识库我是从2024年开始维护的，这里有着循序渐进的Java学习体系，涵盖主流框架、中间件、分布式和微服务等领域技术，助你开启Java进阶之旅。截至今日，该知识库中共有189篇文档，1582791字。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/89d18348187c4b2cab279a0c4554495b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KKB5bqt5paw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768059012&amp;x-signature=Yf635Ux7CRSknIHJYHedZUWt5QM%3D" alt="" loading="lazy"/></p>
<p>3.圆心启点市场知识库</p>
<p>为便于各合作伙伴快速了解《人工智能应用认证培训课程》产品，我特别整理了本产品知识库。内容包含公司简介、证书介绍、课程简章、课程海报、报名表格、招生讲座、咨询话术、考试流程、练习题库等核心资料。目的就是希望我们的合作伙伴更加快速的了解我们的产品，用最快最短的时间实现合作共赢。截至今日，该知识库中共有21篇文档，48068字。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3c0e3aff5c8f4251bd734490594aafd6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KKB5bqt5paw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768059012&amp;x-signature=wBpIHqKQ0tm5FKLdLWWdv%2FMK0cI%3D" alt="" loading="lazy"/></p>
<p>我做了一个统计，以上三个知识库共计有308篇文档，1901977字。没想到差不多两年的时间，竟写了190万字，我还真的被自己惊艳到了，这就是长期积累的结果吧。</p>
<h2 data-id="heading-7">店铺运营</h2>
<p>在这个互联网时代，人人都可以做点小生意。要做生意就得开店，2025年我相继开通了小鹅通店铺、B站课堂小店、淘宝店铺、微信小店。</p>
<p>店铺的运营是需要花费巨大时间的，其实，时间主要花费在了商品封面和商品长图海报设计上。我是不懂设计的，那咋办？不懂就学呀，还能咋办，我又没钱请别人帮我设计。当然了，我对自己设计的海报还是挺满意的，大家觉得咋样呢？</p>
<p>下图是小鹅通店铺H5展示样式：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5c028c30dd864051944d6d748196fa60~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KKB5bqt5paw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768059012&amp;x-signature=TRpbxBOXxg6LdO05ZKLAEPnSwLM%3D" alt="" loading="lazy"/></p>
<p>下图是B站课堂小店展示样式：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dcafc566e75a47d28b426ab2ac6607b7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KKB5bqt5paw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768059012&amp;x-signature=J8asfDTXQCFmWFIjeugsAMb3Y4k%3D" alt="" loading="lazy"/></p>
<p>下图是淘宝店铺展示样式：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c501c1acf7b9401489d5ac9cef277cea~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KKB5bqt5paw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768059012&amp;x-signature=9Phu67MPSdwCGokB70dSqxlu1Ls%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-8">知识星球运营</h2>
<p>知识星球「圆心学堂」是我2024年7月22日创建的一个专注于后端软件开发知识分享的社群。涵盖Java主流技术栈，有着一套循序渐进的学习体系，帮助星友快速获取所需技能，助力职业生涯发展。该星球配套有1个知识库，现有42个专栏，830+内容数量。</p>
<p>今年5月份我又创建了一个星球——「人人都要学AI」，该星球是由袁庭新我本人发起的一站式AI学习社群。涵盖文案写作、PPT制作、数据分析、思维导图、会议纪要、视频生成、生活、教育、创业、政务、法律、投研、科研、自媒体、智能体、软件开发、等50余高频工作场景，100+提示词开箱即用。社群内每月设大咖直播答疑，支持全天候互动交流，致力于为大学生、职场人、创业者等不同群体，搭建从理论认知到实践落地的全链路成长平台，助你系统掌握AI知识与技能，拥抱数字化时代的核心竞争力。该星球配套有1个知识库，640+内容数量。</p>
<p>未来，我本人依旧会重点维护这两个社群，一方面专注于软件开发，另一方面核心聚焦于AIGC领域的前沿技术。</p>
<h2 data-id="heading-9">媒体平台账号运营</h2>
<p>“再小的个体，也有自己的品牌”。</p>
<p>我猜，在此之前，很多人（包括我）从未认真体会过这个简短句子的深意——可现在，我可谓感受颇深，感慨万千。非常后悔前些年一直没有重视自媒体平台运营，当然现在还不晚。</p>
<p>我现在运营有43个账号，是的你没听错。主体上这43个账号分为三类，第一类是以「袁庭新」为昵称的账号，这个账号主要分享软件开发的相关知识；第二类是以「袁庭新AI」为昵称的账号，该账号未来将聚焦人工智能前沿动态与发展，为了更好地分享AI相关知识；第三类是以「圆心星球」为昵称的账号，这个账号未来规划的是与公司相关的资讯、动态、产品等内容，都会发布到这个账号上。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/db55ffd9b59540c5bb77664a79c81021~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KKB5bqt5paw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768059012&amp;x-signature=1HYGGrfBmscyPUc79TpFT2qsKPc%3D" alt="" loading="lazy"/></p>
<p>无论是哪一类账号，都将持续输出优质内容，欢迎感兴趣的朋友们关注！</p>
<h2 data-id="heading-10">职业技术证书</h2>
<p>为推动实施人才强国战略，创新驱动发展战略，紧密围绕工业和信息化高质量发展步伐，立足新技术、新业态、新职业，进一步聚焦工业和信息化领域重点产业和关键技术，我司联合工业和信息化部教育与考试中心开发了《人工智能技术应用》和《生成式人工智能技术应用》两个方向的职业技术证书认证培训课程标准，这两个方向证书共设三个等级，分别为：初级、中级、高级。</p>
<p>我是工信部教考中心《人工智能技术应用》和《生成式人工智能技术应用》人才培养工程标准的编写人，其实就是教考中心请几位不同行业的专家，针对我所写的这份人才培养标准进行评审，主要就是给一些建议，然后我再进行修改调整内容。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/feaae69095fd4bb6ac23b6849f63d291~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KKB5bqt5paw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768059012&amp;x-signature=MnjrMgxfmJirDJ8phW9kuzGkdX0%3D" alt="" loading="lazy"/></p>
<p>在项目申报过程中，我写了大量的材料。其中，《人才培养工程培训站点申请表》就有35页。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f096bdadde904f9384bd795099703be3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KKB5bqt5paw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768059012&amp;x-signature=LchybIGNY0nxHUhhKx7ZqMK4HS4%3D" alt="" loading="lazy"/></p>
<p>在撰写人才培养标准时，需要结合一线企业用人需求和当下AI技术发展现状完成《工业和信息化人才培养工程培训课程标准》研发，光这个文件就写了27页。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ef2fa2d4ab3f4ca896b72f18e30bc130~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KKB5bqt5paw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768059012&amp;x-signature=qUAwDMpCRLm3HUsjCd439svQUtQ%3D" alt="" loading="lazy"/></p>
<p>针对《人工智能技术应用》和《生成式人工智能技术应用》两个方向的认证，出了8套试卷。每套试卷10余页试题，8套试卷合计超80页试题。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/df7dae072cac444cb2335b99470ee270~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KKB5bqt5paw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768059012&amp;x-signature=RWovVVtJ3ZixvnpU6uk7UDEZRXE%3D" alt="" loading="lazy"/></p>
<p>此外，还包括考试系统维护、学员信息整理、组织考试以及批阅试卷等工作，内容极为繁杂，我在2025年为这个项目投入了大量精力。所以，朋友们如果有《人工智能技术应用》和《生成式人工智能技术应用》证书需求可以找我，该证书具备高含金量与公信力，助力学员职业进阶与能力认证。</p>
<h2 data-id="heading-11">公司运营</h2>
<p>在AI时代，“一人公司”正从概念走向现实。我也在积极拥抱AI，尝试着利用人工智能技术来独立完成产品开发、运营、营销、客服等商业活动。</p>
<p>2025年，我也在尝试着运营公司，这方面完全就是一个小白。这一年纯粹是在“干中学”，了解了公司股权设置、银行对接、公户管理、报税扣税、公积金管理等等，学到了以前从未想过和看到的东西。</p>
<p>路老师在奋力的开拓市场，寻找合作伙伴，突然觉得我们的业务发展的还挺快，北京、河南、湖南、山西、陕西现在又到了甘肃，都有我们的业务合作伙伴。照这个势头下去，2026年要覆盖全国了呀！</p>
<p>一个好消息是，2025年年底，我们团队新加入了一位成员。新的一年里，我们将并肩同行、携手探索，在彼此支持中不断成长，一起奔赴更加美好的明天！</p>
<h2 data-id="heading-12">物料研发</h2>
<p>我现在已经是一个“全能型”的打工仔，不光负责课程的开发和录制，包括与之相关的产品物料都是我亲自设计的，如课程简章设计、学员手册设计、课程海报设计以及线下活动宣传物料等。</p>
<p>起初我对设计排版几乎一无所知，但在AI工具和在线设计平台的帮助下，即使毫无设计基础的我也能制作出可用的海报，只是需要多花些时间打磨。</p>
<p>课程简章是非常重要的市场支持物料文件，课程内容有新的迭代了，第一时间要同步到课程简章中，同时还要考虑排版设计，总不能太丑吧，那样看上去就很low。下图是百分百由我操刀设计的简章，大家觉得咋样呢？</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e72ff40f35d944f89bf0be1ce132a751~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KKB5bqt5paw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768059012&amp;x-signature=tQ48MynVCHiYxIDGuOc%2BAWKIuig%3D" alt="" loading="lazy"/></p>
<p>为了让学员高效学习，设计了《学员学习流程手册》，大家觉得，设计的如何？</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fbd0510dbbdd42619139cddf0d2f88c3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KKB5bqt5paw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768059012&amp;x-signature=THtoylQ4gIf2959%2FwUYAMbtau4Q%3D" alt="" loading="lazy"/></p>
<p>为了更好的支持市场小伙伴，我根据市场的特点，给制作了3种类型的PPT，分别是：技术类讲座PPT、实操类讲座PPT、营销类讲座PPT。在PPT制作上花费了巨大的时间。</p>
<p>技术类讲座：纯讲主流的前沿技术，技术框架，解决方案等，适合计算机类专业，共计93页。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0c27911c6f294491b1d170087380fce1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KKB5bqt5paw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768059012&amp;x-signature=HgmvgSb6dFgEikTqNz3uQ%2FpBqp0%3D" alt="" loading="lazy"/></p>
<p>实操类讲座：讲解AIGC工具的实操应用，通过快速案例演示吸引学员，适合所有专业，共计88页。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f91e876557e04ef3a0f4c403c3100ff2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KKB5bqt5paw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768059012&amp;x-signature=CON9%2Bo1I3X%2FaJVij5TBbRROaGPY%3D" alt="" loading="lazy"/></p>
<p>营销类讲座：讲AI发展趋势以及典型的应用案例，和证书的价值等，适合所有专业，共计70页。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eb4c47617c65447a973843ad45bc6724~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KKB5bqt5paw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768059012&amp;x-signature=dbMe3m0GmZjYuD9z7t1FjysiWR4%3D" alt="" loading="lazy"/></p>
<p>课程海报是我花了很多心思设计出来的，大家来看看我做的这张长图海报，觉得怎么样？欢迎提提意见！</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/df149a0a17b74a228e2cc55b94a2e873~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KKB5bqt5paw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768059012&amp;x-signature=ehdMX3ICXvKDups%2BGzcPe%2B6OdvM%3D" alt="" loading="lazy"/></p>
<p>这套课程还配套了职业技术证书，学完并通过考试后，可获得《人工智能技术应用》和《生成式人工智能技术应用》证书。</p>
<p>以上我只是挑了几个有代表性的物料研发做了介绍，其实还有非常多的其他物料研发，比如项目合伙人海报的创意与制作、线下集训营活动海报、证书相关海报、讲师介绍海报等等，就不一一赘述了。</p>
<h2 data-id="heading-13">强健体魄</h2>
<p>“身体是革命的本钱”这句话一点儿都不假，这一生想做点事，想多做一点事，拥有一个强健的体魄是前提，你看重要的道理总是这么简单。道理都知道，知道有什么用呢？关键是要做到呀！</p>
<p>2025年我也有意识的开始多运动。爬了三座山：渭南少华山、长安库峪太兴山、秦岭翠华山。年纪是真的大了，开始喜欢山山水水了，厌倦了城市的繁华，就想一个人静静地待着——看山看水！</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e5b6908517fd40b5b8f971e145eb1145~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KKB5bqt5paw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768059012&amp;x-signature=2OLB9JbaHhI4%2FeNsSNkD426%2BSdg%3D" alt="" loading="lazy"/></p>
<p>同时，还滑了4次雪，刚开始穿上雪橇连站都站不稳，现在基本上能滑了，摔倒了也能不依靠别人自己站起来，就是还没学会刹车减速，2026年必须得学会。</p>
<p>从2025年7月份开始，我有计划的开始健身，比如做俯卧撑、仰卧起坐、跑步等。运动确实可以改变一个人的状态，如果工作焦虑长期心烦意燥或者失眠，更应该多运动。今年我有一个观念转变就是：锻炼比学习甚至更重要。</p>
<h2 data-id="heading-14">个人荣誉</h2>
<p>2025年取得了两项个人荣誉。第一个是加入计算机教育学会，我本人也非常荣幸，在大会上经表决，被增补为陕西省计算机教育学会第九届理事会理事。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cbba6375e2cc474183ec9f934d37cdb5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KKB5bqt5paw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768059012&amp;x-signature=wgXj1sqzGOUDJjpgERiPUfU4ykA%3D" alt="" loading="lazy"/></p>
<p>同时在2025年7月22日，还赴汉中参加陕西省计算机教育学会第九届理事会2025年会员代表大会。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2f2343d8f9234c0c966fe6850f673f46~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KKB5bqt5paw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768059012&amp;x-signature=65dFsA3MtTa%2BxwTa3TAzoHQJJAM%3D" alt="" loading="lazy"/></p>
<p>第二个是，我很荣幸作为工信部教考中心《人工智能技术应用》和《生成式人工智能技术应用》人才培养工程标准主要参编人。学AI、考AI证书，说实话咱是真专业！</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e14880a5ba174dbe910b36b5e62b8154~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KKB5bqt5paw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768059012&amp;x-signature=MNgwjwcopgI6gErIkuS5%2FzNTSxk%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-15">其他事项</h2>
<p>读了几本书</p>
<p>见了几位多年未见的老友</p>
<p>回了三趟旬阳，可惜的是没有回老家</p>
<p>拍了一组长发写真，要像斗士一样活着</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7bf37968808341c19b0cb34358333ed6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KKB5bqt5paw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768059012&amp;x-signature=GAAjoBtaGa4WSTh6jp1I4khqMjw%3D" alt="" loading="lazy"/></p>
<p>2025，已成过往！2026，又会有怎样的故事呢？</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从 0 到 1 构建领先 DBaaS 平台：移动云架构师丁顺的 KubeBlocks 实践之路]]></title>    <link>https://juejin.cn/post/7590421489998299155</link>    <guid>https://juejin.cn/post/7590421489998299155</guid>    <pubDate>2026-01-03T14:10:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590421489998299155" data-draft-id="7590283328176537643" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" 从 0 到 1 构建领先 DBaaS 平台：移动云架构师丁顺的 KubeBlocks 实践之路"/> <meta itemprop="keywords" content="Kubernetes,DBA,云原生"/> <meta itemprop="datePublished" content="2026-01-03T14:10:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小猿姐"/> <meta itemprop="url" content="https://juejin.cn/user/1286882438155148"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             从 0 到 1 构建领先 DBaaS 平台：移动云架构师丁顺的 KubeBlocks 实践之路
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1286882438155148/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小猿姐
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-03T14:10:37.000Z" title="Sat Jan 03 2026 14:10:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0"><strong>引言：</strong></h3>
<p>在云原生浪潮席卷全球的今天，各行各业都在加速数字化转型。对于构建云数据库服务（DBaaS）的团队而言，如何在保证高性能、高可用性的同时，快速迭代、降低运维复杂度，成为了核心挑战。今天，我们有幸邀请到移动云大云海山数据库管控系统的架构师丁顺，他将与我们分享移动云团队如何利用 KubeBlocks，在资源与时间有限的情况下，高效构建起其核心 DBaaS 服务的故事。他的经历不仅展现了 KubeBlocks 在实际生产环境中的强大价值，也为我们带来了对云原生数据库管理未来发展的深刻洞察。</p>
<hr/>
<h2 data-id="heading-1"><strong>第一部分：与移动云 DBaaS 架构师丁顺对话</strong></h2>
<p><strong>Q1：丁顺您好，请您简单介绍一下自己和您的工作？</strong></p>
<p><strong>丁顺：</strong> 大家好，我是丁顺，目前在移动云担任大云海山数据库管控系统的架构师。我的主要职责是规划和实现移动云自研数据库大云海山数据库的云产品化，为用户提供高效、稳定的 DBaaS 服务。</p>
<p><strong>Q2：移动云在数据库领域扮演怎样的角色？</strong></p>
<p><strong>丁顺：</strong> 移动云是中国移动旗下的云计算品牌，致力于提供全面的云服务。我们是云服务提供商，主要深耕于云原生数据库领域，在 Kubernetes 之上构建大云海山数据库的 DBaaS 服务，以满足不同企业级客户对高性能、高可靠数据库的需求。</p>
<p><strong>Q3：刚刚您提到了移动云自研的大云海山数据库。能否展开讲讲这是一款怎样的数据库产品？</strong></p>
<p><strong>丁顺：</strong> 大云海山数据库是移动云自研的数据库，是中国移动重点打造的自有品牌。它具备高扩展、高性能、高可用、高安全及低成本等特性，并全面适配主流国产芯片和操作系统，旨在为业界提供即开即用、安全可靠的数据库服务。值得一提的是，今年 8 月，大云海山数据库顺利通过了<strong>国家安全可靠测评</strong>，这是国家对其产品能力、企业资质、运维能力、未来发展的认可。</p>
<p><strong>Q4：能否分享一下当前支撑移动云 DBaaS 平台的基础技术栈？</strong></p>
<p><strong>丁顺：</strong> 我们的核心技术栈完全基于 Kubernetes 构建。作为云提供商，我们利用 Kubernetes 的强大编排和管理能力，为大云海山数据库提供稳定、弹性的运行环境。我们目前专注于构建和维护大云海山数据库的 DBaaS 服务，确保其在云环境中能够提供业界领先的数据库管理能力。</p>
<hr/>
<h2 data-id="heading-2"><strong>第二部分：困境与破局：为什么是 KubeBlocks？</strong></h2>
<p><strong>Q1：您是如何发现 KubeBlocks 的？</strong></p>
<p><strong>丁顺：</strong> 当时我们正面临从零开始构建大云海山数据库的 DBaaS 管控系统的巨大挑战，时间紧、人力缺。在技术选型调研阶段，有同事推荐了 KubeBlocks，这为我们打开了一扇新的大门。</p>
<p><strong>Q2：在接触 KubeBlocks 之前，移动云在 Kubernetes 上构建数据库服务时，主要面临哪些核心痛点和挑战？</strong></p>
<p><strong>丁顺：</strong> 痛点非常明显，可以总结为内忧和外患。</p>
<p>首先是技术上的“<strong>烟囱式开发</strong>”和“<strong>伪云原生</strong>”问题。以往每引入一种新数据库，就得从头写 Operator 和 CRD，不仅重复造轮子，而且质量参差不齐。很多自研 Operator 只是把数据库简单的“搬”上 K8s，却没解决共享内存、ulimit 等深层问题，导致性能不如人意。</p>
<p>其次是项目背景带来的<strong>资源挑战</strong>。当时我们需要在极短的时间内、用极其有限的人力，从零构建出大云海山数据库的 DBaaS 服务。同时，我们还希望它不仅是为了解决眼下的问题，更要是一个能适配多种引擎的<strong>通用管控底座</strong>。这对我们当时的团队来说，几乎是一个“不可能三角”。</p>
<p><strong>Q3：这听起来确实极具挑战。那么，KubeBlocks 是凭借什么特性打动了您，让您觉得它可以解决这些难题？</strong></p>
<p><strong>丁顺：</strong> 主要是它的“<strong>低代码模式</strong>”、“<strong>通用架构</strong>”和“<strong>强大的抽象模型</strong>”完美契合了我们的需求。</p>
<p>第一，它把数据库复杂的生命周期管理抽象成了统一的 Operator，我们<strong>只需要编写配置文件的形式开发 Addon（插件）</strong>，就能快速接入新引擎。这直接将 Operator 开发的复杂度降维了，极大地缓解了我们人力不足的压力。</p>
<p>第二，我们在做通用性 DBaaS 管控系统设计的架构选型时其实对比过三种架构方案，KubeBlocks 的设计理念（即在 Operator 层展现通用能力）与我们构想的终极方案<strong>不谋而合</strong>。它不仅能救火（解决上线时间问题），又符合我们将来的长期战略（构建通用底座）。这种高度的契合，促使我们最终决定将其作为核心底座。</p>
<p>第三，大云海山数据库作为一个持续演进的自研数据库产品，它的内核架构需要不断迭代以适应新的业务场景。这对底层的 DBaaS 管控系统提出了极高的要求：Operator 必须具备极强的灵活性，以应对未来架构的升级变化。这也是我们选择 KubeBlocks 的关键原因——其强大的<strong>抽象模型</strong>能够灵活适配大云海山数据库未来的架构演进，为我们持续迭代、提供稳定的云上服务提供了坚实的底座保障。</p>
<hr/>
<h2 data-id="heading-3"><strong>第三部分：从 0 到 1 的落地实践与价值</strong></h2>
<p><strong>Q4：目前 KubeBlocks 在移动云的落地情况如何？主要应用在哪些场景？</strong></p>
<p><strong>丁顺：</strong> 我们已经在<strong>生产环境</strong>全量上线。目前，移动云的每个大云海山数据库部署区域（Region）都部署了一套 KubeBlocks，作为大云海山数据库管控系统的核心 <strong>Operator 层</strong>。</p>
<p>它不仅支撑了大云海山数据库实例的<strong>创建、备份/恢复、扩缩容、高可用管理</strong>等核心功能，我们也正在利用它的通用性适配更多开源数据库，以验证其作为通用底座的能力。</p>
<p><strong>Q5：在将 KubeBlocks 集成到移动云现有的庞大云管体系中时，你们团队做了哪些架构层面的设计？</strong></p>
<p><strong>丁顺：</strong> 我们把 KubeBlocks 作为<strong>原子能力的提供者</strong>，集成在我们的“大云海山数据库管控平台”内部。</p>
<p>我们构建了一套<strong>三层管控平台架构</strong>：最上层是<strong>统一的业务服务层</strong>，负责处理移动云特有的计费、鉴权及容量管理等业务逻辑；中间层是<strong>管控服务层</strong>，提供独立于特定业务底座的通用数据库管控能力；底层则是<strong>Operator 层</strong>，我们基于 KubeBlocks 框架，利用其 Addon 机制来实现不同数据库引擎的组件编排、高可用切换及备份等核心运维能力。</p>
<p>这种分层的架构设计，既保留了移动云业务的灵活性，又充分利用了开源社区的技术红利。这也是我们团队在 DBaaS 架构演进中的一次重要实践。</p>
<p><strong>Q6：将核心管控层交给 KubeBlocks 后，为移动云带来了哪些实质性的改变？</strong></p>
<p><strong>丁顺：</strong> 最直观的改变就是<strong>研发效率的质变</strong>。</p>
<p>以前我们对于每个产品都需要组建一支团队去开发和维护 Operator，现在我们投入比以前更少的人力开发 KubeBlocks Addon，就能获得成熟的数据库编排能力。这让我们能把宝贵的研发资源集中在<strong>数据库自研内核的优化</strong>上，而不是消耗在重复的 K8s 运维逻辑中。</p>
<p>此外，它帮我们实现了<strong>运维经验的复用</strong>。因为 API 模型是统一的，我们为大云海山数据库积累的运维能力，可以无缝迁移到其他数据库产品上，大大降低了长期的运维成本。</p>
<p><strong>Q7：在使用过程中，遇到过什么挑战或痛点吗？</strong></p>
<p><strong>丁顺：</strong> 虽然 KubeBlocks 带来了巨大价值，但在使用过程中我们也遇到了一些挑战，希望能与社区共同探讨：</p>
<ol>
<li>
<p><strong>Addon 开发调试：</strong> 目前 Addon 开发过程中的问题调试还是个难点，有时报错信息不够明确，排查难度较大。</p>
</li>
<li>
<p><strong>API 命名相似：</strong> 我们生产环境上线较早（从 0.8 版本开始），后续的 KubeBlocks 版本中由于前向兼容或其他原因, 某些 API 字段得以保留，但是导致了新版本的一些字段和这些历史遗留的字段名称过于相似，在使用新版本 KubeBlocks 接口开发 AddOn 时容易混淆，例如 <code>cluster.spec.componentSpecs.componentDef</code> (新版本) 和 <code>cluster.spec.componentSpecs.componentDefRef</code> (老版本) 。我觉得社区有一些其它开发者可能会有同样的困扰。</p>
</li>
</ol>
<p><strong>Q8：作为一个深耕云原生技术的团队，移动云在享用开源红利的同时，是否也参与了 KubeBlocks 社区的共建？</strong></p>
<p><strong>丁顺：</strong> 当然。我们团队始终秉持“源于开源，回馈开源”的理念。在适配大云海山数据库的实战过程中，我们将在 Addon 开发及大规模生产运维中遇到的深层问题，积极整理并反馈给社区。同时，我们也贡献了大量 PR，涵盖了<strong>对 KubeBlocks 框架本身的优化</strong>以及<strong>对现有开源 Addon 的功能增强</strong>。通过与社区的紧密协作，我们不仅提升了自身产品的稳定性，也共同推动了整个开源生态的成熟。这种技术与生态的“双向奔赴”，是我们非常看重的合作模式。</p>
<hr/>
<h2 data-id="heading-4"><strong>第四部分：对未来的展望</strong></h2>
<p><strong>Q1：您是否有其他反馈或建议想和社区分享？</strong></p>
<p><strong>丁顺：</strong> 我有一个大胆的想法，有没有可能把 KubeBlocks Addon 的开发相关的流程和最佳实践，打包为一个对应的 Claude Skill？这样让 Claude Code 这样的 AI agent 具有自动开发、修改和调试 KubeBlocks Addon 的能力，那将极大地提升开发效率！</p>
<p><strong>Q2：对于刚开始评估 KubeBlocks 的同行，您会给出什么建议？</strong></p>
<p><strong>丁顺：</strong> 结合我们的经验，KubeBlocks 对于希望在 Kubernetes 上构建通用、高性能 DBaaS 平台的团队来说，是一个极其有价值的解决方案。</p>
<p>它能帮助你<strong>大幅缩短开发周期，降低运维成本，并避免重复造轮子</strong>。虽然在刚开始学习 Addon 开发时会有些挑战，但其带来的长期收益，尤其是对于希望标准化数据库运营的团队来说，是巨大的。建议深入研究其设计理念，并多参考社区现有的 Addon 案例。</p>
<hr/>
<h3 data-id="heading-5"><strong>结语：</strong></h3>
<p>感谢丁顺的精彩分享！移动云利用 KubeBlocks 成功构建大云海山数据库 DBaaS 平台的经验，充分证明了 KubeBlocks 在云原生数据库管理领域的强大能力和巨大潜力。同时，丁顺提出的挑战和建议，也为 KubeBlocks 社区指明了未来的优化方向。KubeBlocks 社区将持续听取用户反馈，不断打磨产品，致力于为开发者提供更易用、更强大、更成熟的云原生数据库管理解决方案。我们期待与更多像丁顺一样的先行者，共同推动云原生数据库生态的发展！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[GDAL 实现自定义数据坐标系]]></title>    <link>https://juejin.cn/post/7590403249561092111</link>    <guid>https://juejin.cn/post/7590403249561092111</guid>    <pubDate>2026-01-03T14:58:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590403249561092111" data-draft-id="7590403249561075727" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="GDAL 实现自定义数据坐标系"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-03T14:58:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="GIS之路"/> <meta itemprop="url" content="https://juejin.cn/user/4346787284915481"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            GDAL 实现自定义数据坐标系
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4346787284915481/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    GIS之路
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-03T14:58:24.000Z" title="Sat Jan 03 2026 14:58:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">^ 关注我，带你一起学GIS ^</h2>
<h2 data-id="heading-1">前言</h2>
<blockquote>
<p>❝</p>
<p>在GIS开发中，经常需要进行数据的转换处理，特别是Shapefile数据的投影转换更是重中之重，如何高效、准确的将源数据坐标系转换到目标坐标系是我们需要研究解决的问题。</p>
</blockquote>
<p>在之前的文章中讲了如何使用<code>GDAL</code>或者<code>ogr2ogr</code>工具将<code>txt</code>以及<code>csv</code>文本数据转换为<code>Shp</code>格式，本篇教程在之前一系列文章的基础上讲解如何使用<code>GDAL</code>实现自定义数据坐标系。</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FQtb_BJw91nKrFMeoa7WcxA" target="_blank" title="https://mp.weixin.qq.com/s/Qtb_BJw91nKrFMeoa7WcxA" ref="nofollow noopener noreferrer">GDAL 简介</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FFLWfZItLj24JYicQEX-PbQ" target="_blank" title="https://mp.weixin.qq.com/s/FLWfZItLj24JYicQEX-PbQ" ref="nofollow noopener noreferrer">GDAL 下载安装</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2Fu0539e3CM2q4Y3MbMxxZKQ" target="_blank" title="https://mp.weixin.qq.com/s/u0539e3CM2q4Y3MbMxxZKQ" ref="nofollow noopener noreferrer">GDAL 开发起步</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F0DGoC0oFHizJbweBnEvI-g" target="_blank" title="https://mp.weixin.qq.com/s/0DGoC0oFHizJbweBnEvI-g" ref="nofollow noopener noreferrer">GDAL 实现 GIS 数据读取转换（全）</a></li>
</ul>
<p>如果你还没有看过，建议从以上内容开始。</p>
<h2 data-id="heading-2">1. 开发环境</h2>
<p>本文使用如下开发环境，以供参考。</p>
<p>时间：<code>2025年</code></p>
<p>系统：<code>Windows 11</code></p>
<p>Python：<code>3.11.7</code></p>
<p>GDAL：<code>3.11.1</code></p>
<h2 data-id="heading-3">2. 数据重投影</h2>
<p>定义一个方法<code>ShpProjection</code>用于实现Shp数据的投影转换，其中参数<code>sourcePath</code>为源数据路径，<code>targetPath</code>为目标文件路径。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-string">"""
说明：Shapfile 文件重投影
参数：
    -sourcePath：Shp 源文件路径
    -targetPath：投影文件目标路径
"""</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">ShpProjection</span>(<span class="hljs-params">sourcePath,targetPath</span>):
</code></pre>
<p>先检查源数据文件是否存在，若不存在则退出程序</p>
<pre><code class="hljs language-lua" lang="lua"># 检查Shp源文件是否存在
<span class="hljs-keyword">if</span> <span class="hljs-built_in">os</span>.<span class="hljs-built_in">path</span>.exists(sourcePath):
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"源文件存在！"</span>)
<span class="hljs-keyword">else</span>:
    <span class="hljs-built_in">print</span>(f<span class="hljs-string">"源文件不存在：{sourcePath}"</span>)
    <span class="hljs-keyword">return</span>
</code></pre>
<p>添加<code>Shp</code>数据驱动用于创建<code>Shp</code>数据源和图层，<code>GetDriverByName</code>方法需要一个驱动器名称。还需要检查一下目标数据路径是否正常，只有在目标路径正常时才创建数据源。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 获取Shp数据驱动</span>
shpDriver = gdal.GetDriverByName(<span class="hljs-string">"ESRI Shapefile"</span>)

<span class="hljs-comment"># 检查Shp文件是否存在</span>
<span class="hljs-keyword">if</span> os.path.exists(targetPath):
    <span class="hljs-keyword">try</span>:
        shpDriver.DeleteDataSource(targetPath)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"文件已删除！"</span>)
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"文件路径不存在！：<span class="hljs-subst">{e}</span>"</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>
<span class="hljs-comment"># 创建数据源</span>
targetDataSource = shpDriver.CreateDataSource(targetPath)
</code></pre>
<p>获取源数据图层信息并创建坐标系统。<code>osr</code>模块下的<code>SpatialReference</code>方法用于定义空间参考信息。其中空间参考信息具有三种形式，可以传递字符串名称，<code>EPSG</code>代码或者<code>wkt</code>形式的坐标定义内容。<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1639376ec055431b9fa77b590fa03f98~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768057104&amp;x-signature=n4DYVGxxLkyeDdBARLUS8CRw45c%3D" alt="" loading="lazy"/>如下采用<code>name</code>参数形式。</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 获取Shp数据图层</span>
<span class="hljs-attr">sourceDataSource</span> = ogr.Open(sourcePath)
<span class="hljs-attr">sourceLayer</span> = sourceDataSource.GetLayer()

<span class="hljs-comment"># 获取坐标系</span>
<span class="hljs-attr">srs</span> = osr.SpatialReference(epsg=<span class="hljs-number">5646</span>)
print(f"坐标系统名称：{srs.GetName()}")
</code></pre>
<p>打印坐标系统名称如下：<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7277df6c8ff24ab1b9c0e6f11ede6d38~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768057104&amp;x-signature=d4jnjq9uhuxcUa3XCd6urVLnj2g%3D" alt="" loading="lazy"/></p>
<p>使用<code>CreateLayer</code>方法创建目标图层，本例中数据类型为<code>LineString</code>，所以<code>geom_type</code>参数为<code>ogr.wkbLineString</code>。之后遍历源图层数据，将属性字段和要素值写入投影图层之中。</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 创建Shp投影数据图层</span>
<span class="hljs-attr">geomType</span> = sourceLayer.GetGeomType()
<span class="hljs-attr">shpProjectLayer</span> = targetDataSource.CreateLayer(
    "layer",
    <span class="hljs-attr">srs</span>=srs,
    <span class="hljs-attr">geom_type</span>=ogr.wkbLineString
)

<span class="hljs-comment"># 获取源图层属性结构</span>
<span class="hljs-attr">layerDefn</span> = sourceLayer.GetLayerDefn()
print(layerDefn.GetFieldCount())

<span class="hljs-attr">fieldCount</span> = layerDefn.GetFieldCount()

<span class="hljs-comment"># 添加属性字段</span>
for i in range(fieldCount):
    <span class="hljs-attr">fieldDefn</span> = layerDefn.GetFieldDefn(i)
    shpProjectLayer.CreateField(fieldDefn)

for feature in sourceLayer:
    shpProjectLayer.CreateFeature(feature)

if <span class="hljs-attr">__name__</span>  == <span class="hljs-string">"__main__"</span>:

    <span class="hljs-attr">sourcePath</span> = <span class="hljs-string">"E:\data\test_data\geojson\river.shp"</span>
    <span class="hljs-attr">targetPath</span> = <span class="hljs-string">"E:\data\test_data\geojson\river_project.shp"</span>

    ShpProjection(sourcePath,targetPath)
</code></pre>
<p>运行成功之后在<code>ArcGIS</code>中打开图层属性显示如下：<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/58e526113b684b6ab3c1af7cba6721c8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768057104&amp;x-signature=kJCNyeaK0ESY2WN1chJlvzZCLk8%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a1a4dc4a644747c482828b899e928d66~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768057104&amp;x-signature=TA%2Bdz3eLQy7BEMr9kaxycOyFzRo%3D" alt="" loading="lazy"/></p>
<p><strong><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/41ddc3c0830445109943f91df517fef6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768057104&amp;x-signature=5MeapY95NCsPpzrpD0U5vpjCbkk%3D" alt="" loading="lazy"/></strong></p>
<blockquote>
<p>❝</p>
<p>OpenLayers示例数据下载，请在公众号后台回复：<strong>ol数据</strong></p>
<p>全国信息化工程师－GIS 应用水平考试资料，请在公众号后台回复：<strong>GIS考试</strong></p>
</blockquote>
<blockquote>
<p>❝</p>
<p><em><strong>GIS之路</strong></em> 公众号已经接入了<strong>智能</strong> <strong>助手</strong>，可以在对话框进行提问，也可以直接搜索历史文章进行查看。</p>
</blockquote>
<p>都看到这了，不要忘记<em><strong>点赞、收藏</strong></em> <strong>+</strong> <em><strong>关注</strong></em> 哦 <strong>！</strong></p>
<p>本号不定时更新有关 <em><strong>GIS开发</strong></em> 相关内容，<em><strong>欢迎关注 <img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8788d47b19ab46e187f596a9b5b99b44~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768057104&amp;x-signature=MnbBwt0VVHVdoNfD9Adx1JhZTsY%3D" alt="" loading="lazy"/><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/669f936658fb476f860e9a0184728e8a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768057104&amp;x-signature=3tyqHSDgdtfMfXDZ7XrK4P4DNws%3D" alt="" loading="lazy"/></strong></em></p>
<hr/>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/394d4909e484434da58150e19f584944~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768057104&amp;x-signature=i%2FccFaDaXIXAe4ImwxN0xSFgzCI%3D" alt="" loading="lazy"/></p>
<p>   <img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/deb58e5f63a843d79505c4cfafe2d5f5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768057104&amp;x-signature=bL4umKNXBbiCXQGIpIdrlZQJ2qA%3D" alt="" loading="lazy"/> </p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzkwOTEzNjI5NQ%3D%3D%26mid%3D2247487953%26idx%3D1%26sn%3D0b2d5aeefdb290583cf8cdd82f3c2077%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzkwOTEzNjI5NQ==&amp;mid=2247487953&amp;idx=1&amp;sn=0b2d5aeefdb290583cf8cdd82f3c2077&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">GeoTools 开发合集（全）</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzkwOTEzNjI5NQ%3D%3D%26mid%3D2247487119%26idx%3D1%26sn%3Dc313efa84c27bf933ef2f2a47991ef2d%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzkwOTEzNjI5NQ==&amp;mid=2247487119&amp;idx=1&amp;sn=c313efa84c27bf933ef2f2a47991ef2d&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">OpenLayers 开发合集</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FPGxwhRbuiRUKIpT2D2cVGQ" target="_blank" title="https://mp.weixin.qq.com/s/PGxwhRbuiRUKIpT2D2cVGQ" ref="nofollow noopener noreferrer">GDAL 实现矢量数据读写</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2Fi77nCatd4V2nuybZFIs-xA" target="_blank" title="https://mp.weixin.qq.com/s/i77nCatd4V2nuybZFIs-xA" ref="nofollow noopener noreferrer">GDAL 数据类型大全</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FAVXeDrd13EexedVqOdLuxA" target="_blank" title="https://mp.weixin.qq.com/s/AVXeDrd13EexedVqOdLuxA" ref="nofollow noopener noreferrer">百度宣布，良心画图工具停服！</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F0DGoC0oFHizJbweBnEvI-g" target="_blank" title="https://mp.weixin.qq.com/s/0DGoC0oFHizJbweBnEvI-g" ref="nofollow noopener noreferrer">GDAL 实现 GIS 数据读取转换（全）</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2Frk-Jxqnn5E9aXDxQiomIIg" target="_blank" title="https://mp.weixin.qq.com/s/rk-Jxqnn5E9aXDxQiomIIg" ref="nofollow noopener noreferrer">GIS 数据转换：使用 GDAL 将 Shp 转换为 GeoJSON 数据</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FJg0-96t5C2CIlAB5K38kbw" target="_blank" title="https://mp.weixin.qq.com/s/Jg0-96t5C2CIlAB5K38kbw" ref="nofollow noopener noreferrer">GIS 数据转换：使用 GDAL 将 GeoJSON 转换为 Shp 数据</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F5lRetXg_dHYO-ZXKQnbi5Q" target="_blank" title="https://mp.weixin.qq.com/s/5lRetXg_dHYO-ZXKQnbi5Q" ref="nofollow noopener noreferrer">GIS 数据转换：使用 GDAL 将 TXT 转换为 Shp 数据</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[这可能是最懂人话的AI：阿里MAI-UI让手机自动驾驶成真]]></title>    <link>https://juejin.cn/post/7590654280900263979</link>    <guid>https://juejin.cn/post/7590654280900263979</guid>    <pubDate>2026-01-03T13:02:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590654280900263979" data-draft-id="7590421489998151699" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="这可能是最懂人话的AI：阿里MAI-UI让手机自动驾驶成真"/> <meta itemprop="keywords" content="AIGC"/> <meta itemprop="datePublished" content="2026-01-03T13:02:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="墨风如雪"/> <meta itemprop="url" content="https://juejin.cn/user/4064249017803927"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            这可能是最懂人话的AI：阿里MAI-UI让手机自动驾驶成真
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4064249017803927/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    墨风如雪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-03T13:02:56.000Z" title="Sat Jan 03 2026 13:02:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>说实话，我们已经听腻了“AI智能体”这个词。但在大多数时候，所谓的智能体还是像个只会答题的书呆子——你让它写首诗行，但让它帮你用手机订张从北京到上海的高铁票，再顺手发给秘书？它大概率会卡在第一步，或者胡乱点击一通。</p>
<p>为什么？因为它们不懂手机屏幕，也不懂人。</p>
<p>不过，阿里巴巴通义实验室最近扔出的这张王炸——<strong>MAI-UI</strong>，可能真的要改变这个局面了。这不仅仅是一个新的多模态模型，更像是一个给手机装上的“自动驾驶系统”。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2026%2F01%2F6390276979052866838949967.png" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2026/01/6390276979052866838949967.png" ref="nofollow noopener noreferrer"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f53fef54055248eabef1f09b98a04cf7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768050176&amp;x-signature=Lxwv%2Bfdp2N14XnPoG1zi9ENPaZw%3D" alt="6390276979052866838949967" loading="lazy"/></a></p>
<h2 data-id="heading-0">终于学会了“张嘴问人”</h2>
<p>现在的GUI Agent（图形界面智能体）有个通病：死脑筋。</p>
<p>举个例子，你跟它说：“把我的简历发给HR。” 传统的AI会直接愣住，或者开始在他的训练数据里瞎猜，甚至可能把你的购物清单发出去。</p>
<p>MAI-UI最大的不同在于，它拥有了<strong>原生的人机交互能力</strong>。面对模糊指令，它不会盲目操作，而是会暂停下来问你：“老板，你要发哪一份简历？HR的邮箱是哪个？”</p>
<p>这听起来很简单，但在技术上却是巨大的飞跃。阿里团队在训练中引入了“拒绝采样”和专门的交互动作，治好了AI喜欢“不懂装懂”的毛病。这让它不仅仅是一个执行脚本，更像是一个懂得和你确认需求的真实助理。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2026%2F01%2F6390276977443088257701246.png" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2026/01/6390276977443088257701246.png" ref="nofollow noopener noreferrer"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/464943b979be4fb79253c26df536882d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768050176&amp;x-signature=%2FOyog8Kd%2BmTmOwg0uZXAwPlTrSY%3D" alt="6390276977443088257701246" loading="lazy"/></a></p>
<h2 data-id="heading-1">抄近道：不只是傻傻点屏幕</h2>
<p>以前的屏幕智能体完全依赖视觉识别——找图标、模拟点击、滑动。这在复杂APP里很容易出错，效率也低。</p>
<p>MAI-UI引入了一个很极客的功能：<strong>MCP工具调用</strong>。</p>
<p>简单说，它是个“双面手”。对于简单的界面，它像人一样去点击；但对于复杂的任务，比如“查询GitHub某仓库的最近提交”或者“计算两地驾车距离”，它会直接跳过繁琐的UI操作，在后台调用API接口（MCP）直接拿数据。</p>
<p>这一招“抄近道”，把原本需要几十次点击、容易出错的流程，压缩成了几次精准的代码调用。在MobileWorld的测试中，这让它的成功率直接甩开了最好的竞争对手30多个百分点。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2026%2F01%2Fasfsdgdfg-1024x448.png" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2026/01/asfsdgdfg-1024x448.png" ref="nofollow noopener noreferrer"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/26086cf21b9740c98f0fff5fe5a47d3c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768050176&amp;x-signature=91zeQx0Y1IDMabXwbjI582TDJEU%3D" alt="asfsdgdfg" loading="lazy"/></a></p>
<h2 data-id="heading-2">大小脑配合，隐私也没落下</h2>
<p>把所有操作都交给云端大模型，不仅慢，还让人担心隐私——谁愿意把银行卡密码传到云端去识别？</p>
<p>MAI-UI搞了一套<strong>端云协同</strong>的架构。</p>
<ul>
<li><strong>端侧小模型（2B版本）：</strong> 住在你的手机里，反应快，负责处理日常琐事，盯着屏幕状态，绝不泄露隐私。</li>
<li><strong>云端大模型（235B版本）：</strong> 遇到复杂的逻辑推理难题时，端侧搞不定了，才会请云端的大脑介入。</li>
</ul>
<p>这种动态调度，让端侧任务成功率提升了33%，同时还可以减少40%的云端调用。既省了流量和算力，又保住了你的隐私。</p>
<h2 data-id="heading-3">战绩如何？数据说话</h2>
<p>别光听概念，看看硬指标。在目前的GUI智能体竞技场上，MAI-UI的表现可以用“霸榜”来形容。</p>
<p>在著名的<strong>AndroidWorld</strong>基准测试中，MAI-UI拿下了<strong>76.7%<strong>的成功率。 这个成绩意味着什么？它直接超越了Google的</strong>Gemini-2.5-Pro</strong>，也击败了之前的开源强者<strong>UI-Tars-2</strong>。即便是只有2B参数的端侧小模型，其表现也比同级别的Ferret-UI Lite高出了整整21个百分点。</p>
<p>这背后，是阿里在一个拥有500多个并行环境的“虚拟手机农场”里，通过大规模在线强化学习（Online RL）反复操练的结果。它见识过各种弹窗广告、UI漂移和突发状况，所以比温室里长大的模型更抗造。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2026%2F01%2Fasdasddfgsfg.jpg" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2026/01/asdasddfgsfg.jpg" ref="nofollow noopener noreferrer"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c4652c3f24374a2dade0c75619dab6ba~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768050176&amp;x-signature=wcQj1xDs6Rw93IkeXrUd1lKAmxU%3D" alt="asdasddfgsfg" loading="lazy"/></a></p>
<h2 data-id="heading-4">写在最后</h2>
<p>好消息是，通义实验室并没有把这个好东西藏着掖着。目前，<strong>MAI-UI的2B和8B模型权重、代码已经在GitHub开源</strong>，连同那个高难度的评测基准MobileWorld也一并放了出来。</p>
<p>对于开发者来说，这意味着我们离“动动嘴，手机自动帮我搞定一切”的科幻场景，又近了一大步。或许不久的将来，你的手机操作系统里，就住着这样一个不仅看得懂屏幕，还懂得这什么时候该问你、什么时候该自己动手的“真·智能助理”。</p>
<p><strong>如果你也对最新的AI信息感兴趣或者有疑问 都可以加入我的大家庭 第一时间分享最新AI资讯、工具、教程、文档 欢迎你的加入！！！😉😉😉</strong></p>
<p>公众号：墨风如雪小站</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[用另一种方式让《留白》继续存在下去]]></title>    <link>https://juejin.cn/post/7590592594675449866</link>    <guid>https://juejin.cn/post/7590592594675449866</guid>    <pubDate>2026-01-03T13:16:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590592594675449866" data-draft-id="7590608345923321882" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" 用另一种方式让《留白》继续存在下去"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-03T13:16:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="codelang"/> <meta itemprop="url" content="https://juejin.cn/user/184373682638727"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             用另一种方式让《留白》继续存在下去
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/184373682638727/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    codelang
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-03T13:16:00.000Z" title="Sat Jan 03 2026 13:16:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>最近翻阅相册，旧旧的照片有一张独特的排版，思绪一下就把我拉回了从前，这张照片是《留白》App 编辑生成的，一款非常具有艺术感的 App。《留白》是我前司创始人开发的 App，当时用户量还挺多的，首页还会推荐一些摄影师拍摄的作品。</p>
<p>最近想从 App Store 重新下载把玩下发现，该应用下架很多年了，并且从一些三方渠道拿到的 Apk 都是 32 位的，现在主流的手机已经无法安装了，通过知乎发现，已经很久没有维护了：</p>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/74e38667791f4f02953aaabf7afa0121~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZWxhbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768050959&amp;x-signature=Z41Ogiw49Fu8sN4sqHgbU%2BqutQ8%3D" alt="" width="50%" loading="lazy"/></p>
<p>这款独特又小众的 App 无法使用着实有点可惜，留白的 preview 页：</p>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eb00349a20b94d2594b4a2308891c7ce~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZWxhbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768050959&amp;x-signature=mck2h5tJ621XSN2xKz%2FWJUKX2%2B0%3D" alt="" width="30%" loading="lazy"/></p>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4b5756d58718459789f3f06c268c0d45~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZWxhbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768050959&amp;x-signature=UDcVQcUKYZXHWj5iGGDUHPEbw0U%3D" alt="" width="30%" loading="lazy"/></p>
<p>所以，我萌生了一个想法，基于强大的 AI 能力，让这款产品重新再现一下，说干就干。</p>
<p>开发步骤：</p>
<ul>
<li>技术选型：最主要是实现快，能快速验证思路与想法，最终敲定下来用 react</li>
<li>AI 编码：最终敲定下来是 claude clode(后文简称 cc) + 智谱 GLM-4.7</li>
<li>部署体验：将 react 部署到线上体验</li>
<li>终极体验：将 react 实现的能力，让 AI 翻译成微信小程序，部署到微信小程序中</li>
</ul>
<p>在技术选型中，我最先思考的是如何快速实现自己想要的效果，相比较知识库与社区的成熟度，对于 AI 来说，生成前端的正确率会比移动端会高点，并且能快速的调试。我将留白 preview 图片丢给了 cc，让 cc 按照该图生成前端应用，并为该图增加了滤镜、字体、主题等一类设置，如下是实现效果，你也可以访问 <a href="https://link.juejin.cn?target=https%3A%2F%2Fliubai-white.vercel.app%2F" target="_blank" title="https://liubai-white.vercel.app/" ref="nofollow noopener noreferrer">liubai-white.vercel.app/</a> 进行试玩：</p>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/31964fc0a39548f5ac52c0ae5421a470~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZWxhbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768050959&amp;x-signature=ioLPMdUyc6mQLDFMPHf5UHbQj8Q%3D" alt="" width="30%" loading="lazy"/></p>
<p>cc + 智谱 GLM-4.7 的生成效果与正确率还是蛮惊艳的，并没有因为一个错误的解决而无限陷入另一种错误。</p>
<p>在经过各种细节与优化中，我发现这种方案可行，但提供网页让用户使用的话，一个是体验不佳，另一个是没有人会记住一个网址，所以，我决定将这个方案的实现迁移到微信小程序。</p>
<p>起初，我了解到 Taro + react 是可以生成微信小程序代码的，我尝试让 cc 将 react 转成 Taro 模式，然后让 Taro 编译 react 代码生成微信小程序项目，但经过我各种调试，都无法达成满意的效果，最主要的原因是 react 很多库的实现，在微信小程序上没有，Taro 无法进行转译，所以，这种方案我立马放弃了。</p>
<p>最终还是直接让 cc 翻译了 react 的项目结构，并生成了项目的功能指南，接着我让 cc 重新创建了个 miniapp 的目录，让他读取 react 代码与功能指南，重新生成微信小程序项目。</p>
<blockquote>
<p><em>未来，AI 也可能是跨端的另一种实现</em></p>
</blockquote>
<p>转义的效果依然非常惊艳，第一把就成功了，预览效果与 react 差不多，但细节还需要再做下处理，本以为没啥大问题，当我将图片下载下来时发现，各种排版错乱。检查了下项目代码实现，在微信小程序中，页面布局的展示是通过 wxml 渲染的，但生成图片是通过 canvas 画的，也就是说，canvas 要对着 wxml 的 css 进行转义，而且 AI 的转义能力特别弱，即使我用 cursor+opus 尝试过，也是一塌糊涂，如果界面渲染排版发生了变动，AI 又会忘了 canvas 也要变动， 在这块的调试上吃了太多力气。那怎么办呢，只能给 cc 添加更多的 rules 规则，去定制规则并且限制他的随意发挥。</p>
<p>经过各种调试对垒，第一版的 留白 微信小程序实现啦，效果图如下：</p>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ed6829a1d65b4f3fbda8401d15784330~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZWxhbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768050959&amp;x-signature=yq4URonmqcw2Pq%2FfYAvMtyIc5fI%3D" alt="" width="30%" loading="lazy"/></p>
<p>如果你想体验的话，可以扫如下的小程序码：</p>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b519caccf89c4499bf0250eb2b20b89c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZWxhbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768050959&amp;x-signature=C6Yr8XXlm93u7GVXEvWr15zSUSI%3D" alt="" width="30%" loading="lazy"/></p>
<p>有任何体验的问题，或是对 AI Coding 有想法的，都可以在公众号中找到我的联系方式。</p>
<p>元旦这三天智谱的 tokens 消耗：</p>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a30c892a91c24216be5ade417fd9d903~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZWxhbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768050959&amp;x-signature=NSQhzkjXeKSD6%2F3Ze6RP2GtdNfE%3D" alt="image.png" width="50%" loading="lazy"/></p>
<p>对于 AI Coding ，我有一点想说：</p>
<blockquote>
<p>随着大模型越来越强，我觉得用谁家的模型会变得没那么重要，比如我用的智谱GLM 就能帮我实现非常惊艳的能力，我觉得当前最重要的还是工具，我非常推荐 claude code，Anthropic 这家公司一直走在 AI Coding 的最前沿，无论是 mcp、cli，还是最近非常火热的 skills 、subAgent，他总能从工程化思维去解决你的问题，让 AI 代码生成的更可靠。比如 prompt 的拆解与注入、token 如何减少消耗、上下文污染如何规避等等。</p>
<p>2026 年，AI Coding 一定是往更可靠的大方向走，但要想更可靠，交给开发者肯定是不足够的，一定是有很多工具去辅助开发者更可靠才行。</p>
<p>正如 Anthropic 首席产品官 Mike Krieger 所说的：</p>
<p><strong/> 能可靠地接过你手里的活儿。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[2025我常用的 AI 产品]]></title>    <link>https://juejin.cn/post/7590309337861373993</link>    <guid>https://juejin.cn/post/7590309337861373993</guid>    <pubDate>2026-01-03T13:40:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590309337861373993" data-draft-id="7590283328176504875" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="2025我常用的 AI 产品"/> <meta itemprop="keywords" content="程序员,全栈,招聘"/> <meta itemprop="datePublished" content="2026-01-03T13:40:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="KaneLogger"/> <meta itemprop="url" content="https://juejin.cn/user/3650034333917031"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            2025我常用的 AI 产品
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3650034333917031/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    KaneLogger
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-03T13:40:34.000Z" title="Sat Jan 03 2026 13:40:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>宗旨：用"好 AI"，用好 AI。</p>
</blockquote>
<p>之前专门写过一篇文章，里面有很多产品，但是品类太多了，其实平时用的也就那么几个，写这篇文章的目的也是总结自己平时使用的产品，以及自己是如何使用的。</p>
<p>在用好 AI 之前，应该多用用业界最好的 AI 产品。</p>
<p>如何知道现在哪类模型好呢？除了用户评价，还可以在 <a href="https://link.juejin.cn?target=https%3A%2F%2Flmarena.ai%2Fzh%2Fleaderboard" target="_blank" title="https://lmarena.ai/zh/leaderboard" ref="nofollow noopener noreferrer">lmarena</a> 大模型竞技场上找找，当然最重要的还是多用多体验。</p>
<h3 data-id="heading-0">对话</h3>









































<table><thead><tr><th>平台</th><th>响应速度</th><th>应用场景</th><th>费用</th></tr></thead><tbody><tr><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fgemini.google.com%2F" target="_blank" title="https://gemini.google.com/" ref="nofollow noopener noreferrer">Gemini</a></td><td>⭐⭐⭐⭐⭐</td><td>长文本、图片（nano banana）</td><td>Pro 版：140 元/月</td></tr><tr><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.doubao.com" target="_blank" title="https://www.doubao.com" ref="nofollow noopener noreferrer">豆包</a></td><td>⭐⭐⭐⭐⭐</td><td>日常对话、图片 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fjimeng.jianying.com%2Fai-tool%2Fhome" target="_blank" title="https://jimeng.jianying.com/ai-tool/home" ref="nofollow noopener noreferrer">即梦</a>)</td><td>免费</td></tr><tr><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.kimi.com" target="_blank" title="https://www.kimi.com" ref="nofollow noopener noreferrer">Kimi</a></td><td>⭐⭐⭐⭐</td><td>长文本</td><td>Andante 49 元/月</td></tr><tr><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fchat.qwen.ai%2F" target="_blank" title="https://chat.qwen.ai/" ref="nofollow noopener noreferrer">通义千问</a></td><td>⭐⭐⭐⭐⭐</td><td>日常对话、图片</td><td>免费</td></tr><tr><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fx.com%2Fi%2Fgrok" target="_blank" title="https://x.com/i/grok" ref="nofollow noopener noreferrer">Grok</a></td><td>⭐⭐⭐⭐</td><td>特攻：推特爬虫</td><td>免费就够用了</td></tr></tbody></table>
<h3 data-id="heading-1">图像</h3>
<p>这个赛道比较窄，z-image\mj\flux 能用，艺术感强，光影细节处理也很成熟，但是上手成本也比较高，适合专业人士做商业插图。我常用的只有：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgemini.google.com%2Fapp" target="_blank" title="https://gemini.google.com/app" ref="nofollow noopener noreferrer">nano banana</a> 可以在 <a href="https://link.juejin.cn?target=https%3A%2F%2Faistudio.google.com%2F" target="_blank" title="https://aistudio.google.com/" ref="nofollow noopener noreferrer">ai studio</a> 中使用，缺点是没有系统给的提示词，也可以在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fyoumind.com%2Fboards" target="_blank" title="https://youmind.com/boards" ref="nofollow noopener noreferrer">youmind</a> 这些产品中使用。官网每天三张，API 调用，平均一张 2k 图 1 元。</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fjimeng.jianying.com%2F" target="_blank" title="https://jimeng.jianying.com/" ref="nofollow noopener noreferrer">即梦</a> 基础会员 69 元/月，每日 60 免费积分，可生成 20-50 张图。</li>
</ul>
<h3 data-id="heading-2">编程</h3>
<ul>
<li>【terminal】Claude code + 国产模型 minmax/kimi k2/GLM-4.6 Pro</li>
<li>【IDE】trae 首月 21rmb/月 后续 70rmb/月</li>
<li>【IDE】cursor 付费 pro 140rmb/月 pro+ 420rmb/月 ultra400rmb/月</li>
<li>【terminal】gemini cli</li>
<li>【IDE】其他偶尔可薅羊毛 qcoder、CodeBuddy、antigravity、kiro、vs code</li>
</ul>
<h3 data-id="heading-3">全家桶</h3>
<ul>
<li>Gemini 全家桶
<ul>
<li>Gemini + nano banana + notebookLM 办公套件</li>
<li>Veo 文生视频</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fstitch.withgoogle.com%2F" target="_blank" title="https://stitch.withgoogle.com/" ref="nofollow noopener noreferrer">stitch</a> Google 推出的 AI 辅助 UI 原型设计工具</li>
<li>antigravity 编辑器</li>
<li>gemini cli 终端工具</li>
</ul>
</li>
<li>豆包 全家桶
<ul>
<li>豆包</li>
<li>seedream 文生图</li>
<li>seedance 文生视频</li>
<li>trae 编辑器</li>
</ul>
</li>
<li>gpt 全家桶
<ul>
<li>chatGPT 对话、图片</li>
<li>sora 视频</li>
<li>codex</li>
</ul>
</li>
</ul>
<h3 data-id="heading-4">我的订阅</h3>
<ul>
<li>对话(画图)部分：Gemini + 豆包 + kimi + 偶尔 qwen + 爬虫 Grok</li>
<li>编程：claude code(minmax) + cursor</li>
<li>知识库：<a href="https://link.juejin.cn?target=https%3A%2F%2Fnotebooklm.google.com%2F" target="_blank" title="https://notebooklm.google.com/" ref="nofollow noopener noreferrer">notebookLM(ppt 思维导图)</a> + <a href="https://link.juejin.cn?target=https%3A%2F%2Fima.qq.com%2F" target="_blank" title="https://ima.qq.com/" ref="nofollow noopener noreferrer">ima（知识库管理）</a> + <a href="https://link.juejin.cn?target=https%3A%2F%2Fyoumind.com%2Fzh-CN%2F" target="_blank" title="https://youmind.com/zh-CN/" ref="nofollow noopener noreferrer">youmind（整理碎片想法信息）</a></li>
<li>工作流：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.coze.cn%2F" target="_blank" title="https://www.coze.cn/" ref="nofollow noopener noreferrer">coze(配合飞书)</a> + <a href="https://link.juejin.cn?target=https%3A%2F%2Fn8n.io%2F" target="_blank" title="https://n8n.io/" ref="nofollow noopener noreferrer">n8n（本地工作流）</a></li>
</ul>
<h4 data-id="heading-5">智能体</h4>
<p>还没花过钱，基本上用在研报上。</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fspace.coze.cn%2Fspace-intro" target="_blank" title="https://space.coze.cn/space-intro" ref="nofollow noopener noreferrer">扣子空间</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.manus.ai%2F" target="_blank" title="https://www.manus.ai/" ref="nofollow noopener noreferrer">manus</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fautoglm.zhipuai.cn%2F" target="_blank" title="https://autoglm.zhipuai.cn/" ref="nofollow noopener noreferrer">AutoGLM</a></li>
<li>【DeepResearch】<a href="https://link.juejin.cn?target=https%3A%2F%2Fithy.com%2F" target="_blank" title="https://ithy.com/" ref="nofollow noopener noreferrer">ithy</a></li>
<li>【DeepResearch】<a href="https://link.juejin.cn?target=https%3A%2F%2Fmetaso.cn%2F" target="_blank" title="https://metaso.cn/" ref="nofollow noopener noreferrer">秘塔</a></li>
<li>【DeepResearch】<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.perplexity.ai%2F" target="_blank" title="https://www.perplexity.ai/" ref="nofollow noopener noreferrer">Perplexity（国外网站）</a></li>
<li>【DeepResearch】<a href="https://link.juejin.cn?target=https%3A%2F%2Fmetaso.cn%2F" target="_blank" title="https://metaso.cn/" ref="nofollow noopener noreferrer">秘塔 AI 搜索</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[基于 YOLOv8 的共享单车乱停放智能识别系统— 从数据集构建到可视化部署的完整项目]]></title>    <link>https://juejin.cn/post/7590330924001148991</link>    <guid>https://juejin.cn/post/7590330924001148991</guid>    <pubDate>2026-01-03T12:05:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7590330924001148991" data-draft-id="7590283328176422955" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="基于 YOLOv8 的共享单车乱停放智能识别系统— 从数据集构建到可视化部署的完整项目"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-03T12:05:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="我是杰尼"/> <meta itemprop="url" content="https://juejin.cn/user/4200579899599495"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            基于 YOLOv8 的共享单车乱停放智能识别系统— 从数据集构建到可视化部署的完整项目
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4200579899599495/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    我是杰尼
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-03T12:05:46.000Z" title="Sat Jan 03 2026 12:05:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">基于 YOLOv8 的共享单车乱停放智能识别系统— 从数据集构建到可视化部署的完整项目</h2>
<h3 data-id="heading-1">一、项目背景：为什么要做“乱停放识别”？</h3>
<p>随着共享单车在城市中的高密度投放，“最后一公里”出行问题得到了极大缓解，但随之而来的<strong>随意停放、占道堆积、盲道阻塞</strong>等问题，也成为城市治理中的一大痛点。</p>
<p>在实际城市管理中，传统处理方式主要依赖以下手段：</p>
<ul>
<li>人工巡查（成本高、效率低）</li>
<li>群众举报（滞后、不可控）</li>
<li>简单规则检测（误报率高）</li>
</ul>
<p>这些方式很难应对<strong>大规模、全天候、动态变化</strong>的街景环境。因此，<strong>基于计算机视觉的自动化识别方案</strong>成为一种必然选择。</p>
<p>本项目的目标是：</p>
<blockquote>
<p>🎯 <strong>构建一套完整、可落地的共享单车/自行车乱停放智能识别系统</strong>
覆盖：<strong>数据 → 训练 → 推理 → UI → 部署</strong>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f3a011a718814ebebcfa89fa2a0d3276~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oiR5piv5p2w5bC8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768046746&amp;x-signature=EMuSVG2QJHBt%2BMjPU6xwCqk0938%3D" alt="在这里插入图片描述" loading="lazy"/></p>
</blockquote>
<h4 data-id="heading-2">源码下载与效果演示</h4>
<p>哔哩哔哩视频下方观看：</p>
<blockquote>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1HxKbzSEco%2F" target="_blank" title="https://www.bilibili.com/video/BV1HxKbzSEco/" ref="nofollow noopener noreferrer">www.bilibili.com/video/BV1Hx…</a></p>
</blockquote>
<p>包含：</p>
<p>📦完整项目源码</p>
<p>📦 预训练模型权重</p>
<p>🗂️ 数据集地址（含标注脚本</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5ae2a78a2ee443b49eead838e20fbf1d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oiR5piv5p2w5bC8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768046746&amp;x-signature=YnLoovTWrUtxjAbHV5GXDljxZWU%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h3 data-id="heading-3">二、系统总体设计思路</h3>
<p>从工程角度出发，本项目并非“单一模型测试”，而是完整的软件系统，整体架构如下：</p>
<pre><code class="hljs language-markdown" lang="markdown">数据采集 → 数据标注 → YOLOv8模型训练
<span class="hljs-code">        ↓
   模型评估与调优
        ↓
PyQt5 可视化检测系统
        ↓
图片 / 视频 / 摄像头 / 批量检测
</span></code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/02eadcd68dd64b5ab658d627540a6c80~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oiR5piv5p2w5bC8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768046746&amp;x-signature=bCht76tGG1NlMQ96bRbU4kutmjU%3D" alt="在这里插入图片描述" loading="lazy"/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/124b8b176c804f628f43cb20330e1206~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oiR5piv5p2w5bC8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768046746&amp;x-signature=YWdzfvfft27MtoRLQnhi7hc2DLk%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h4 data-id="heading-4">系统核心组成模块</h4>

































<table><thead><tr><th>模块</th><th>说明</th></tr></thead><tbody><tr><td>目标检测模型</td><td>YOLOv8 Detection</td></tr><tr><td>深度学习框架</td><td>PyTorch</td></tr><tr><td>图形界面</td><td>PyQt5</td></tr><tr><td>推理方式</td><td>图片 / 文件夹 / 视频 / 摄像头</td></tr><tr><td>输出形式</td><td>标注图像 / 视频文件</td></tr><tr><td>使用方式</td><td>开箱即用 / 可二次开发</td></tr></tbody></table>
<hr/>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/90dbc7fbcbf448e29f1210bcd805b078~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oiR5piv5p2w5bC8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768046746&amp;x-signature=8BfBVWK6S4uGZRVSOaHbnEgsl2o%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h3 data-id="heading-5">三、YOLOv8 模型选型与原理分析</h3>
<h4 data-id="heading-6">3.1 为什么选择 YOLOv8？</h4>
<p>在众多目标检测模型中（Faster R-CNN、SSD、YOLOv5/7 等），YOLOv8 具备以下明显优势：</p>
<ul>
<li><strong>Anchor-Free 架构</strong>：减少人为超参依赖</li>
<li><strong>更高的推理速度</strong>：适合实时摄像头场景</li>
<li><strong>Ultralytics 官方生态完善</strong>：训练、推理、导出一步到位</li>
<li><strong>对小目标更友好</strong>：适合街景中密集单车检测</li>
</ul>
<h4 data-id="heading-7">3.2 YOLOv8 Detection 架构概览</h4>
<p>YOLOv8 仍然遵循经典的三段式结构：</p>
<ul>
<li><strong>Backbone</strong>：特征提取（C2f + CSP 思想）</li>
<li><strong>Neck</strong>：多尺度特征融合（FPN + PAN）</li>
<li><strong>Head</strong>：Anchor-Free 检测头</li>
</ul>
<p>其核心改进点在于：</p>
<ul>
<li>Task-Aligned Assigner</li>
<li>解耦式检测头</li>
<li>DFL（Distribution Focal Loss）</li>
</ul>
<p>这些设计显著提升了模型在复杂场景下的稳定性。</p>
<hr/>
<h3 data-id="heading-8">四、数据集构建与标注规范</h3>
<h4 data-id="heading-9">4.1 数据来源与采集</h4>
<p>数据主要来自：</p>
<ul>
<li>城市街景实拍</li>
<li>公共道路监控截图</li>
<li>不同天气 / 光照 / 角度场景</li>
</ul>
<p>重点覆盖以下情况：</p>
<ul>
<li>随意堆叠停放</li>
<li>占用盲道、人行道</li>
<li>路口密集区域</li>
<li>单车与背景高度相似场景</li>
</ul>
<h4 data-id="heading-10">4.2 YOLO 数据集结构</h4>
<p>采用标准 YOLOv8 数据集格式：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">dataset/
├── images/
│   ├── train/
│   └── <span class="hljs-keyword">val</span>/
├── labels/
│   ├── train/
│   └── <span class="hljs-keyword">val</span>/
</code></pre>
<h4 data-id="heading-11">4.3 标注格式说明</h4>
<p>每一行标签格式如下：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">class_id</span>&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-name">x_center</span>&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-name">y_center</span>&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-name">width</span>&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-name">height</span>&gt;</span>
</code></pre>
<p>坐标全部采用 <strong>归一化比例值</strong>，便于模型泛化。</p>
<hr/>
<h3 data-id="heading-12">五、模型训练流程与参数配置</h3>
<h4 data-id="heading-13">5.1 训练命令示例</h4>
<pre><code class="hljs language-bash" lang="bash">yolo detect train \
  data=dataset/bike.yaml \
  model=yolov8n.pt \
  epochs=100 \
  batch=16 \
  imgsz=640 \
  lr0=0.001
</code></pre>
<h4 data-id="heading-14">5.2 训练过程关注指标</h4>
<ul>
<li>box_loss（定位误差）</li>
<li>cls_loss（分类误差）</li>
<li>dfl_loss（边界框分布）</li>
<li>mAP@0.5 / mAP@0.5:0.95</li>
</ul>
<blockquote>
<p>在实验中，当 mAP@0.5 稳定在 <strong>90% 以上</strong>，模型已具备实际部署价值。</p>
</blockquote>
<hr/>
<h3 data-id="heading-15">六、模型推理与检测结果分析</h3>
<h4 data-id="heading-16">6.1 Python 推理示例</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> ultralytics <span class="hljs-keyword">import</span> YOLO

model = YOLO(<span class="hljs-string">"best.pt"</span>)
results = model(<span class="hljs-string">"test.jpg"</span>, conf=<span class="hljs-number">0.25</span>, save=<span class="hljs-literal">True</span>)
</code></pre>
<h4 data-id="heading-17">6.2 输出结果内容</h4>
<ul>
<li>检测框位置</li>
<li>类别名称</li>
<li>置信度评分</li>
<li>自动保存标注图像</li>
</ul>
<p>模型在复杂街景、遮挡场景下仍能保持较好鲁棒性。</p>
<hr/>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2ab73f230ad842a8ad2bbe8bce614cc4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oiR5piv5p2w5bC8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768046746&amp;x-signature=hJZBS6Qioq1WdLE72RqO69jOOYU%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h3 data-id="heading-18">七、PyQt5 可视化检测系统设计</h3>
<h4 data-id="heading-19">7.1 为什么要做 GUI？</h4>
<p>对于实际使用者（城管、运营人员、学生演示）来说：</p>
<blockquote>
<p>❌ 命令行 ≠ 易用
✅ 可视化界面 = 真正可用系统</p>
</blockquote>
<h4 data-id="heading-20">7.2 支持功能一览</h4>
<ul>
<li>📷 单张图片检测</li>
<li>📁 文件夹批量检测</li>
<li>🎞️ 视频文件检测</li>
<li>🎥 实时摄像头检测</li>
<li>💾 结果保存开关</li>
</ul>
<h4 data-id="heading-21">7.3 系统运行方式</h4>
<pre><code class="hljs language-bash" lang="bash">python main.py
</code></pre>
<p>无需任何深度学习基础，即可完成检测。</p>
<hr/>
<h3 data-id="heading-22">八、工程落地与应用场景</h3>
<p>本系统可直接应用于：</p>
<ul>
<li>🚦 城市智慧城管</li>
<li>🏙️ 智慧园区管理</li>
<li>🚴‍♂️ 共享单车运维监管</li>
<li>🎓 计算机视觉教学/毕设</li>
</ul>
<p>同时，该项目也可作为 <strong>YOLOv8 + GUI 工程模板</strong>，快速迁移到其他检测任务。</p>
<hr/>
<h3 data-id="heading-23">九、完整源码与资源说明</h3>
<p>项目已打包提供：</p>
<ul>
<li>✔️ 完整训练代码</li>
<li>✔️ 数据集与标注</li>
<li>✔️ 训练权重文件</li>
<li>✔️ PyQt5 可视化系统</li>
<li>✔️ 一键运行脚本</li>
</ul>
<p>适合：</p>
<blockquote>
<p>毕业设计 / 科研实验 / 技术复现 / 二次开发</p>
</blockquote>
<hr/>
<h3 data-id="heading-24">十、总结</h3>
<p>本项目不仅是一次 YOLOv8 模型实践，更是一套<strong>从算法到系统、从实验到落地</strong>的完整工程方案。</p>
<p>如果你希望：</p>
<ul>
<li>系统性掌握目标检测工程</li>
<li>做一个“真正能跑”的 AI 项目</li>
<li>拥有可展示、可部署、可扩展的成果</li>
</ul>
<p>那么，这个项目会是一个非常理想的起点。</p>
<p>本文围绕共享单车/自行车乱停放这一典型的城市治理痛点，完整介绍了一套基于 YOLOv8 目标检测模型 + PyQt5 可视化界面 的智能识别系统。从问题背景出发，系统性地阐述了模型选型理由、数据集构建方式、训练与评估流程，以及多输入源（图片、视频、摄像头、批量文件）的工程化落地实现。该项目不仅在算法层面验证了 YOLOv8 在复杂街景下的高精度与实时性优势，更通过图形化界面降低了使用门槛，使模型真正具备可部署、可使用、可扩展的工程价值。整体方案兼顾技术深度与实用性，既可直接应用于智慧城管与共享单车监管场景，也可作为目标检测教学、毕业设计和二次开发的完整实践范例。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>