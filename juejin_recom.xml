<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[Swift 常用框架Kingfisher、KingfisherWebP详解]]></title>    <link>https://juejin.cn/post/7599155566298136619</link>    <guid>https://juejin.cn/post/7599155566298136619</guid>    <pubDate>2026-01-26T10:00:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599155566298136619" data-draft-id="7599237603976560683" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Swift 常用框架Kingfisher、KingfisherWebP详解"/> <meta itemprop="keywords" content="Swift,iOS"/> <meta itemprop="datePublished" content="2026-01-26T10:00:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Haha_bj"/> <meta itemprop="url" content="https://juejin.cn/user/2612027844214647"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Swift 常用框架Kingfisher、KingfisherWebP详解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2612027844214647/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Haha_bj
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T10:00:33.000Z" title="Mon Jan 26 2026 10:00:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    10
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">1.1 什么是 Kingfisher 、KingfisherWebP</h3>
<p>Kingfisher 是一个功能强大的 Swift 库，专门用于处理图像的下载、缓存和展示。目前已成为 iOS/macOS 开发中最受欢迎的图像处理解决方案之一。</p>
<p>KingfisherWebP 是 Kingfisher 的官方扩展，用于支持 WebP 图像格式。WebP 是 Google 开发的一种现代图像格式，它可以在相同质量下提供比 JPEG 和 PNG 更小的文件大小，从而减少带宽使用和加快加载速度。</p>
<h3 data-id="heading-1">1.2 核心特性</h3>
<ul>
<li>异步下载 ：在后台线程下载图片，不阻塞主线程</li>
<li>多级缓存 ：内存缓存 + 磁盘缓存，提高加载速度</li>
<li>自动缓存管理 ：智能处理缓存大小和过期时间</li>
<li>图片处理 ：支持下载后处理，如圆角、模糊等</li>
<li>请求优先级 ：可设置不同图片请求的优先级</li>
<li>可扩展性 ：支持自定义缓存、下载器等组件</li>
<li>SwiftUI 支持 ：提供了便捷的 SwiftUI 视图扩展</li>
<li>动画支持 ：支持 GIF 等动画图片</li>
</ul>
<h3 data-id="heading-2">1.3 安装方式</h3>
<p>Kingfisher 支持多种安装方式：</p>
<p>CocoaPods:</p>
<pre><code class="hljs language-arduino" lang="arduino">pod <span class="hljs-string">'Kingfisher'</span>
pod <span class="hljs-string">'KingfisherWebP'</span>
</code></pre>
<h3 data-id="heading-3">2. Kingfisher 基础用法</h3>
<h3 data-id="heading-4">2.1 基本图片加载</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Kingfisher</span>

<span class="hljs-comment">// 基本用法</span>
imageView.<span class="hljs-property">kf</span>.<span class="hljs-title function_">setImage</span>(<span class="hljs-attr">with</span>: <span class="hljs-title function_">URL</span>(<span class="hljs-attr">string</span>: <span class="hljs-string">"https://example.com/image.jpg"</span>))

<span class="hljs-comment">// 带选项的用法</span>
imageView.<span class="hljs-property">kf</span>.<span class="hljs-title function_">setImage</span>(<span class="hljs-params">
    <span class="hljs-keyword">with</span>: URL(<span class="hljs-built_in">string</span>: <span class="hljs-string">"https://example.com/image.jpg"</span>),
    placeholder: UIImage(named: <span class="hljs-string">"placeholder"</span>),
    options: [
        .transition(.fade(<span class="hljs-number">0.2</span>)),
        .cacheOriginalImage
    ]
</span>) { result <span class="hljs-keyword">in</span>
    <span class="hljs-keyword">switch</span> result {
    <span class="hljs-keyword">case</span> .<span class="hljs-title function_">success</span>(<span class="hljs-keyword">let</span> value):
        <span class="hljs-title function_">print</span>(<span class="hljs-string">"Image loaded: \(value.image)"</span>)
        <span class="hljs-title function_">print</span>(<span class="hljs-string">"图片加载成功: \(value.source.url?.absoluteString ?? "</span><span class="hljs-string">")"</span>)
    <span class="hljs-keyword">case</span> .<span class="hljs-title function_">failure</span>(<span class="hljs-keyword">let</span> error):
        <span class="hljs-title function_">print</span>(<span class="hljs-string">"图片加载失败: \(error.localizedDescription)"</span>)
    }
}
</code></pre>
<h3 data-id="heading-5">2.2 缓存控制</h3>
<pre><code class="hljs language-scss" lang="scss"> <span class="hljs-comment">// 清除内存缓存</span>
KingfisherManager<span class="hljs-selector-class">.shared</span><span class="hljs-selector-class">.cache</span><span class="hljs-selector-class">.clearMemoryCache</span>()

<span class="hljs-comment">// 清除磁盘缓存</span>
KingfisherManager<span class="hljs-selector-class">.shared</span><span class="hljs-selector-class">.cache</span><span class="hljs-selector-class">.clearDiskCache</span>()

<span class="hljs-comment">// 清除所有缓存</span>
KingfisherManager<span class="hljs-selector-class">.shared</span><span class="hljs-selector-class">.cache</span><span class="hljs-selector-class">.clearCache</span>()

</code></pre>
<h3 data-id="heading-6">2.3 预加载图像</h3>
<p>预加载一组图像以提升加载速度，适合在应用启动时或预期需要时使用。</p>
<pre><code class="hljs language-scss" lang="scss"> let urls = <span class="hljs-selector-attr">[URL(string: <span class="hljs-string">"https://example.com/image1.png"</span>)!, URL(string: <span class="hljs-string">"https://example.com/image2.png"</span>)!]</span>
 <span class="hljs-built_in">ImagePrefetcher</span>(urls: urls)<span class="hljs-selector-class">.start</span>()
</code></pre>
<h3 data-id="heading-7">2.4 显示WebP</h3>
<pre><code class="hljs language-csharp" lang="csharp"> <span class="hljs-comment"><span class="hljs-doctag">///</span> 全局配置</span>
KingfisherManager.shared.defaultOptions += [.processor(WebPProcessor.<span class="hljs-literal">default</span>),.cacheSerializer(WebPSerializer.<span class="hljs-literal">default</span>)]

<span class="hljs-comment">// 使用 AnimatedImageView 定义ImageView</span>

 <span class="hljs-keyword">let</span> animageView = AnimatedImageView()
 animageView.kf.setImage(<span class="hljs-keyword">with</span>: URL(<span class="hljs-built_in">string</span>: <span class="hljs-string">"https://example.com/image.webp"</span>))

</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[langchain-向量数据库学习总结]]></title>    <link>https://juejin.cn/post/7599528186586431498</link>    <guid>https://juejin.cn/post/7599528186586431498</guid>    <pubDate>2026-01-26T10:01:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599528186586431498" data-draft-id="7599528186586415114" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="langchain-向量数据库学习总结"/> <meta itemprop="keywords" content="前端,后端"/> <meta itemprop="datePublished" content="2026-01-26T10:01:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="心在飞扬AI"/> <meta itemprop="url" content="https://juejin.cn/user/1556564194366823"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            langchain-向量数据库学习总结
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1556564194366823/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    心在飞扬AI
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T10:01:46.000Z" title="Mon Jan 26 2026 10:01:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    15
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">向量数据库学习总结</h2>
<hr/>
<h3 data-id="heading-1">一、FAISS 向量库</h3>
<h4 data-id="heading-2">1. FAISS 向量库创建与保存</h4>
<p><strong>这是什么</strong></p>
<ul>
<li>FAISS（Facebook AI Similarity Search）是Facebook开源的向量相似度搜索库</li>
<li>用于本地存储和检索高维向量数据，无需外部服务依赖</li>
</ul>
<p><strong>有什么用</strong></p>
<ul>
<li>本地开发环境快速搭建向量检索能力</li>
<li>小规模应用（&lt;10万条数据）的最佳选择</li>
<li>RAG系统的基础组件，为LLM提供知识库检索</li>
</ul>
<p><strong>示例代码</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_community.vectorstores <span class="hljs-keyword">import</span> FAISS
<span class="hljs-keyword">from</span> langchain_community.embeddings <span class="hljs-keyword">import</span> QianfanEmbeddingsEndpoint
<span class="hljs-keyword">from</span> langchain_core.documents <span class="hljs-keyword">import</span> Document

<span class="hljs-comment"># 初始化嵌入模型</span>
embedding = QianfanEmbeddingsEndpoint()

<span class="hljs-comment"># 准备文档数据</span>
documents = [
    Document(page_content=<span class="hljs-string">"我养了一只猫，叫笨笨"</span>, metadata={<span class="hljs-string">"id"</span>: <span class="hljs-number">1</span>}),
    Document(page_content=<span class="hljs-string">"我养了一只狗，叫旺财"</span>, metadata={<span class="hljs-string">"id"</span>: <span class="hljs-number">2</span>}),
]

<span class="hljs-comment"># 创建 FAISS 向量数据库</span>
db = FAISS.from_documents(documents, embedding)

<span class="hljs-comment"># 保存到本地</span>
db.save_local(<span class="hljs-string">"./vector-store/"</span>)
</code></pre>
<hr/>
<h4 data-id="heading-3">2.  FAISS 向量库加载与检索</h4>
<p><strong>这是什么</strong></p>
<ul>
<li>从本地加载已保存的FAISS索引文件</li>
<li>执行相似度搜索并返回匹配结果</li>
</ul>
<p><strong>有什么用</strong></p>
<ul>
<li>持久化向量数据，避免每次重新计算Embedding</li>
<li>生产环境中快速启动检索服务</li>
</ul>
<p><strong>示例代码</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_community.vectorstores <span class="hljs-keyword">import</span> FAISS
<span class="hljs-keyword">from</span> langchain_community.embeddings <span class="hljs-keyword">import</span> QianfanEmbeddingsEndpoint

embedding = QianfanEmbeddingsEndpoint()

<span class="hljs-comment"># 从本地加载向量库</span>
db = FAISS.load_local(
    <span class="hljs-string">"./vector-store/"</span>,
    embedding,
    allow_dangerous_deserialization=<span class="hljs-literal">True</span>
)

<span class="hljs-comment"># 执行相似度搜索（返回距离分数）</span>
results = db.similarity_search_with_score(<span class="hljs-string">"我养了一只猫，叫笨笨"</span>)
<span class="hljs-comment"># 输出：[(Document(...), 0.123), (Document(...), 0.456)]</span>
</code></pre>
<hr/>
<h3 data-id="heading-4">二、腾讯云 VectorDB</h3>
<h4 data-id="heading-5">3. 腾讯云VectorDB内置Embedding</h4>
<p><strong>这是什么</strong></p>
<ul>
<li>腾讯云托管的向量数据库服务</li>
<li>使用腾讯云自带的Embedding模型，无需额外配置</li>
</ul>
<p><strong>有什么用</strong></p>
<ul>
<li>快速接入云端向量检索能力</li>
<li>避免自行维护Embedding服务</li>
<li>适合生产环境大规模应用</li>
</ul>
<p><strong>示例代码</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_community.vectorstores <span class="hljs-keyword">import</span> TencentVectorDB
<span class="hljs-keyword">from</span> langchain_community.vectorstores.tencentvectordb <span class="hljs-keyword">import</span> ConnectionParams

db = TencentVectorDB(
    embedding=<span class="hljs-literal">None</span>,  <span class="hljs-comment"># 使用内置Embedding</span>
    connection_params=ConnectionParams(
        url=os.environ.get(<span class="hljs-string">"TC_VECTOR_DB_URL"</span>),
        username=os.environ.get(<span class="hljs-string">"TC_VECTOR_DB_USERNAME"</span>),
        key=os.environ.get(<span class="hljs-string">"TC_VECTOR_DB_KEY"</span>),
        timeout=<span class="hljs-built_in">int</span>(os.environ.get(<span class="hljs-string">"TC_VECTOR_DB_TIMEOUT"</span>)),
    ),
    database_name=<span class="hljs-string">"llmops-test"</span>,
    collection_name=<span class="hljs-string">"dataset-builtin"</span>,
)

<span class="hljs-comment"># 添加文本</span>
texts = [<span class="hljs-string">"笨笨是一只很喜欢睡觉的猫咪"</span>, <span class="hljs-string">"我喜欢在夜晚听音乐"</span>]
ids = db.add_texts(texts)

<span class="hljs-comment"># 相似度搜索（带相关性分数）</span>
results = db.similarity_search_with_relevance_scores(<span class="hljs-string">"我养了一只猫"</span>)
</code></pre>
<hr/>
<h4 data-id="heading-6">4. - 腾讯云VectorDB外部Embedding</h4>
<p><strong>这是什么</strong></p>
<ul>
<li>使用第三方Embedding模型（如OpenAI）与腾讯云VectorDB集成</li>
<li>灵活选择最适合业务的Embedding服务</li>
</ul>
<p><strong>有什么用</strong></p>
<ul>
<li>使用高质量Embedding模型提升检索精度</li>
<li>统一管理多种Embedding服务</li>
<li>支持自定义Embedding模型</li>
</ul>
<p><strong>示例代码</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_openai <span class="hljs-keyword">import</span> OpenAIEmbeddings
<span class="hljs-keyword">from</span> langchain_community.vectorstores <span class="hljs-keyword">import</span> TencentVectorDB

<span class="hljs-comment"># 使用OpenAI Embedding</span>
embedding = OpenAIEmbeddings(model=<span class="hljs-string">"text-embedding-3-small"</span>)

db = TencentVectorDB(
    embedding=embedding,
    connection_params=ConnectionParams(...),
    database_name=<span class="hljs-string">"llmops-test"</span>,
    collection_name=<span class="hljs-string">"dataset-external"</span>,
)

<span class="hljs-comment"># 添加文档并检索</span>
ids = db.add_texts(texts)
results = db.similarity_search_with_score(<span class="hljs-string">"我养了一只猫，叫笨笨"</span>)
</code></pre>
<hr/>
<h4 data-id="heading-7">5.  - 腾讯云VectorDB元数据过滤</h4>
<p><strong>这是什么</strong></p>
<ul>
<li>在向量相似度检索基础上增加结构化过滤条件</li>
<li>支持元数据字段定义（MetaField）和过滤表达式（expr）</li>
</ul>
<p><strong>有什么用</strong></p>
<ul>
<li>实现精准检索：如只搜索特定用户、特定时间范围的数据</li>
<li>多租户数据隔离</li>
<li>结合语义和结构化条件的混合检索</li>
</ul>
<p><strong>示例代码</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_community.vectorstores.tencentvectordb <span class="hljs-keyword">import</span> (
    MetaField, META_FIELD_TYPE_UINT64
)

db = TencentVectorDB(
    embedding=<span class="hljs-literal">None</span>,
    connection_params=ConnectionParams(...),
    meta_fields=[
        MetaField(name=<span class="hljs-string">"page"</span>, data_type=META_FIELD_TYPE_UINT64),
    ]
)

<span class="hljs-comment"># 添加带元数据的文档</span>
texts = [<span class="hljs-string">"笨笨是猫"</span>, <span class="hljs-string">"旺财是狗"</span>, <span class="hljs-string">"小飞是鸟"</span>]
metadatas = [{<span class="hljs-string">"page"</span>: <span class="hljs-number">1</span>}, {<span class="hljs-string">"page"</span>: <span class="hljs-number">5</span>}, {<span class="hljs-string">"page"</span>: <span class="hljs-number">10</span>}]
db.add_texts(texts, metadatas)

<span class="hljs-comment"># 带过滤条件的搜索：只检索 page &gt;= 9 的文档</span>
results = db.similarity_search_with_score(
    <span class="hljs-string">"宠物"</span>,
    expr=<span class="hljs-string">"page&gt;=9"</span>  <span class="hljs-comment"># 过滤表达式</span>
)
</code></pre>
<hr/>
<h3 data-id="heading-8">三、自定义向量存储</h3>
<h4 data-id="heading-9">6.  自定义 MemoryVectorStore 实现</h4>
<p><strong>这是什么</strong></p>
<ul>
<li>继承LangChain的VectorStore基类实现自定义向量存储</li>
<li>完整展示向量数据库的底层工作原理</li>
</ul>
<p><strong>有什么用</strong></p>
<ul>
<li>理解向量数据库核心机制：Embedding计算、距离度量、相似度排序</li>
<li>学习如何实现符合LangChain规范的向量存储</li>
<li>为特殊需求定制向量存储方案</li>
</ul>
<p><strong>示例代码</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_core.vectorstores <span class="hljs-keyword">import</span> VectorStore
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">List</span>, <span class="hljs-type">Optional</span>, <span class="hljs-type">Any</span>
<span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np

<span class="hljs-keyword">class</span> <span class="hljs-title class_">MemoryVectorStore</span>(<span class="hljs-title class_ inherited__">VectorStore</span>):
    store: <span class="hljs-built_in">dict</span> = {}

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, embedding: Embeddings</span>):
        self._embedding = embedding

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">add_texts</span>(<span class="hljs-params">self, texts: Iterable[<span class="hljs-built_in">str</span>], metadatas: <span class="hljs-type">Optional</span>[<span class="hljs-type">List</span>[<span class="hljs-built_in">dict</span>]] = <span class="hljs-literal">None</span></span>):
        <span class="hljs-comment"># 1. 将文本转换为向量</span>
        embeddings = self._embedding.embed_documents(texts)
        ids = [<span class="hljs-built_in">str</span>(uuid.uuid4()) <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> texts]

        <span class="hljs-comment"># 2. 存储向量与元数据</span>
        <span class="hljs-keyword">for</span> idx, text <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(texts):
            self.store[ids[idx]] = {
                <span class="hljs-string">"id"</span>: ids[idx],
                <span class="hljs-string">"text"</span>: text,
                <span class="hljs-string">"embedding"</span>: embeddings[idx],
                <span class="hljs-string">"metadata"</span>: metadatas[idx] <span class="hljs-keyword">if</span> metadatas <span class="hljs-keyword">else</span> {},
            }
        <span class="hljs-keyword">return</span> ids

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">similarity_search</span>(<span class="hljs-params">self, query: <span class="hljs-built_in">str</span>, k: <span class="hljs-built_in">int</span> = <span class="hljs-number">4</span></span>):
        <span class="hljs-comment"># 1. 计算查询向量</span>
        query_embedding = self._embedding.embed_query(query)

        <span class="hljs-comment"># 2. 计算与所有向量的欧几里得距离</span>
        result = []
        <span class="hljs-keyword">for</span> key, record <span class="hljs-keyword">in</span> self.store.items():
            distance = self._euclidean_distance(query_embedding, record[<span class="hljs-string">"embedding"</span>])
            result.append({<span class="hljs-string">"distance"</span>: distance, **record})

        <span class="hljs-comment"># 3. 排序并返回前k个结果</span>
        result = <span class="hljs-built_in">sorted</span>(result, key=<span class="hljs-keyword">lambda</span> x: x[<span class="hljs-string">"distance"</span>])[:k]
        <span class="hljs-keyword">return</span> [Document(page_content=item[<span class="hljs-string">"text"</span>], metadata=item[<span class="hljs-string">"metadata"</span>]) <span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> result]

<span class="hljs-meta">    @classmethod</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_euclidean_distance</span>(<span class="hljs-params">cls, vec1: <span class="hljs-built_in">list</span>, vec2: <span class="hljs-built_in">list</span></span>) -&gt; <span class="hljs-built_in">float</span>:
        <span class="hljs-string">"""计算两个向量的欧几里得距离"""</span>
        <span class="hljs-keyword">return</span> np.linalg.norm(np.array(vec1) - np.array(vec2))

<span class="hljs-comment"># 使用示例</span>
db = MemoryVectorStore(embedding=QianfanEmbeddingsEndpoint())
db.add_texts([<span class="hljs-string">"笨笨是猫"</span>, <span class="hljs-string">"旺财是狗"</span>], metadatas=[{<span class="hljs-string">"page"</span>: <span class="hljs-number">1</span>}, {<span class="hljs-string">"page"</span>: <span class="hljs-number">2</span>}])
results = db.similarity_search(<span class="hljs-string">"宠物"</span>, k=<span class="hljs-number">2</span>)
</code></pre>
<hr/>
<h3 data-id="heading-10">四、Weaviate 向量数据库</h3>
<h4 data-id="heading-11">- Weaviate 向量搜索引擎</h4>
<p><strong>这是什么</strong></p>
<ul>
<li>开源向量搜索引擎，支持云服务（WCS）和本地部署</li>
<li>提供强大的过滤查询能力和GraphQL接口</li>
</ul>
<p><strong>有什么用</strong></p>
<ul>
<li>构建企业级向量搜索引擎</li>
<li>支持复杂的多条件过滤查询</li>
<li>与LangChain深度集成，快速搭建RAG系统</li>
</ul>
<p><strong>示例代码</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> weaviate
<span class="hljs-keyword">from</span> langchain_weaviate <span class="hljs-keyword">import</span> WeaviateVectorStore
<span class="hljs-keyword">from</span> weaviate.auth <span class="hljs-keyword">import</span> AuthApiKey
<span class="hljs-keyword">from</span> weaviate.classes.query <span class="hljs-keyword">import</span> Filter

<span class="hljs-comment"># 创建连接客户端（云服务）</span>
client = weaviate.connect_to_wcs(
    cluster_url=<span class="hljs-string">"xxx.c0.asia-southeast1.gcp.weaviate.cloud"</span>,
    auth_credentials=AuthApiKey(<span class="hljs-string">"your-api-key"</span>),
)

<span class="hljs-comment"># 创建向量库实例</span>
db = WeaviateVectorStore(
    client=client,
    index_name=<span class="hljs-string">"MyTest"</span>,
    text_key=<span class="hljs-string">"text"</span>,
    embedding=QianfanEmbeddingsEndpoint(model=<span class="hljs-string">"embedding-v1"</span>),
)

<span class="hljs-comment"># 添加数据</span>
ids = db.add_texts(texts, metadatas)

<span class="hljs-comment"># 带过滤条件的相似度搜索</span>
filters = Filter.by_property(<span class="hljs-string">"page"</span>).greater_or_equal(<span class="hljs-number">5</span>)
results = db.similarity_search_with_score(<span class="hljs-string">"笨笨"</span>, filters=filters)

<span class="hljs-comment"># 转换为Retriever（用于RAG）</span>
retriever = db.as_retriever()
results = retriever.invoke(<span class="hljs-string">"笨笨"</span>)
</code></pre>
<hr/>
<h3 data-id="heading-12">五、Pinecone 向量数据库</h3>
<h4 data-id="heading-13">8.  Pinecone 托管向量数据库</h4>
<p><strong>这是什么</strong></p>
<ul>
<li>完全托管的向量数据库服务，无需运维</li>
<li>提供高性能的向量检索API和自动扩缩容能力</li>
</ul>
<p><strong>有什么用</strong></p>
<ul>
<li>生产环境首选：零运维、高可用、自动扩展</li>
<li>支持Namespace实现多租户数据隔离</li>
<li>丰富的过滤语法实现精准检索</li>
</ul>
<p><strong>示例代码</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_pinecone <span class="hljs-keyword">import</span> PineconeVectorStore
<span class="hljs-keyword">from</span> langchain_community.embeddings <span class="hljs-keyword">import</span> HuggingFaceEmbeddings

<span class="hljs-comment"># 使用HuggingFace中文Embedding模型</span>
embedding = HuggingFaceEmbeddings(
    model_name=<span class="hljs-string">"BAAI/bge-small-zh-v1.5"</span>
)

<span class="hljs-comment"># 创建向量库实例（指定namespace实现数据隔离）</span>
db = PineconeVectorStore(
    index_name=<span class="hljs-string">"llmops"</span>,
    embedding=embedding,
    namespace=<span class="hljs-string">"dataset"</span>  <span class="hljs-comment"># 命名空间</span>
)

<span class="hljs-comment"># 添加文档</span>
db.add_texts(texts, metadatas, namespace=<span class="hljs-string">"dataset"</span>)

<span class="hljs-comment"># 带过滤条件的检索</span>
results = db.similarity_search_with_relevance_scores(
    <span class="hljs-string">"我养了一只猫"</span>,
    <span class="hljs-built_in">filter</span>={<span class="hljs-string">"$or"</span>: [{<span class="hljs-string">"page"</span>: <span class="hljs-number">5</span>}, {<span class="hljs-string">"account_id"</span>: <span class="hljs-number">1</span>}]}  <span class="hljs-comment"># 复杂过滤条件</span>
)

<span class="hljs-comment"># 删除指定文档</span>
db.delete([<span class="hljs-string">"document-id"</span>], namespace=<span class="hljs-string">"dataset"</span>)
</code></pre>
<hr/>
<h3 data-id="heading-14">六、核心知识点总结</h3>
<h4 data-id="heading-15">1. 向量数据库选型指南</h4>



































<table><thead><tr><th>方案</th><th>适用场景</th><th>优势</th><th>劣势</th></tr></thead><tbody><tr><td><strong>FAISS</strong></td><td>本地开发、小规模应用</td><td>免费、快速、无依赖</td><td>单机、需手动持久化</td></tr><tr><td><strong>腾讯云VectorDB</strong></td><td>国内生产环境</td><td>低延迟、内置Embedding</td><td>仅国内可用</td></tr><tr><td><strong>Pinecone</strong></td><td>国际生产环境</td><td>零运维、自动扩展</td><td>需海外访问</td></tr><tr><td><strong>Weaviate</strong></td><td>自建搜索引擎</td><td>开源、功能丰富</td><td>需运维</td></tr></tbody></table>
<h4 data-id="heading-16">2. Embedding 模型选择</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 千帆（国内推荐）</span>
QianfanEmbeddingsEndpoint(model=<span class="hljs-string">"Embedding-V1"</span>)

<span class="hljs-comment"># OpenAI（国际推荐）</span>
OpenAIEmbeddings(model=<span class="hljs-string">"text-embedding-3-small"</span>)

<span class="hljs-comment"># HuggingFace（免费离线）</span>
HuggingFaceEmbeddings(model_name=<span class="hljs-string">"BAAI/bge-small-zh-v1.5"</span>)  <span class="hljs-comment"># 中文</span>
HuggingFaceEmbeddings(model_name=<span class="hljs-string">"sentence-transformers/all-MiniLM-L6-v2"</span>)  <span class="hljs-comment"># 英文</span>
</code></pre>
<h4 data-id="heading-17">3. 相似度计算方法</h4>





































<table><thead><tr><th>方法</th><th>公式</th><th>特点</th></tr></thead><tbody><tr><td><strong>欧几里得距离</strong></td><td>`</td><td/><td>v1 - v2</td><td/><td>`</td><td>距离越小越相似</td></tr><tr><td><strong>余弦相似度</strong></td><td>`cos(θ) = (v1·v2) / (</td><td/><td>v1</td><td/><td>·</td><td/><td>v2</td><td/><td>)`</td><td>值越大越相似</td></tr><tr><td><strong>内积</strong></td><td><code>v1·v2</code></td><td>计算最快</td></tr></tbody></table>
<h4 data-id="heading-18">4. 典型应用流程</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 1. 准备数据</span>
documents = [<span class="hljs-string">"文本1"</span>, <span class="hljs-string">"文本2"</span>, <span class="hljs-string">"文本3"</span>]
metadatas = [{<span class="hljs-string">"source"</span>: <span class="hljs-string">"A"</span>}, {<span class="hljs-string">"source"</span>: <span class="hljs-string">"B"</span>}, {<span class="hljs-string">"source"</span>: <span class="hljs-string">"C"</span>}]

<span class="hljs-comment"># 2. 创建向量库</span>
db = VectorStore.from_texts(documents, embedding, metadatas)

<span class="hljs-comment"># 3. 保存（可选）</span>
db.save_local(<span class="hljs-string">"./vector-store/"</span>)

<span class="hljs-comment"># 4. 检索</span>
results = db.similarity_search(<span class="hljs-string">"查询文本"</span>, k=<span class="hljs-number">3</span>)  <span class="hljs-comment"># 返回前3个最相似的</span>

<span class="hljs-comment"># 5. 带过滤检索</span>
results = db.similarity_search(
    <span class="hljs-string">"查询文本"</span>,
    <span class="hljs-built_in">filter</span>={<span class="hljs-string">"source"</span>: <span class="hljs-string">"A"</span>}  <span class="hljs-comment"># 只检索source=A的文档</span>
)

<span class="hljs-comment"># 6. 转换为Retriever（用于RAG）</span>
retriever = db.as_retriever(search_kwargs={<span class="hljs-string">"k"</span>: <span class="hljs-number">2</span>})
results = retriever.invoke(<span class="hljs-string">"查询文本"</span>)
</code></pre>
<h4 data-id="heading-19">5. RAG系统集成示例</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain.chains <span class="hljs-keyword">import</span> RetrievalQA
<span class="hljs-keyword">from</span> langchain_openai <span class="hljs-keyword">import</span> ChatOpenAI

<span class="hljs-comment"># 创建向量库的Retriever</span>
retriever = db.as_retriever(search_kwargs={<span class="hljs-string">"k"</span>: <span class="hljs-number">3</span>})

<span class="hljs-comment"># 创建RAG问答链</span>
qa_chain = RetrievalQA.from_chain_type(
    llm=ChatOpenAI(model=<span class="hljs-string">"gpt-4"</span>),
    chain_type=<span class="hljs-string">"stuff"</span>,
    retriever=retriever,
    return_source_documents=<span class="hljs-literal">True</span>  <span class="hljs-comment"># 返回参考文档</span>
)

<span class="hljs-comment"># 执行问答</span>
answer = qa_chain.invoke({<span class="hljs-string">"query"</span>: <span class="hljs-string">"笨笨是什么？"</span>})
<span class="hljs-built_in">print</span>(answer[<span class="hljs-string">"result"</span>])  <span class="hljs-comment"># LLM生成的答案</span>
<span class="hljs-built_in">print</span>(answer[<span class="hljs-string">"source_documents"</span>])  <span class="hljs-comment"># 参考的文档片段</span>
</code></pre>
<hr/>
<h3 data-id="heading-20">七、最佳实践</h3>
<ol>
<li><strong>中文场景</strong>：优先选择千帆或<code>bge-small-zh-v1.5</code>模型</li>
<li><strong>数据规模</strong>：&lt;10万用FAISS，&gt;100万用托管服务</li>
<li><strong>元数据设计</strong>：提前规划过滤字段，避免频繁重建索引</li>
<li><strong>性能优化</strong>：使用批量添加（<code>add_texts</code>）而非单条插入</li>
<li><strong>成本控制</strong>：开发阶段用FAISS，生产环境切换到托管服务</li>
<li><strong>安全隔离</strong>：多租户场景使用Pinecone的Namespace或元数据过滤</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[数据工程新范式：基于 NoETL 语义编织实现自助下钻分析]]></title>    <link>https://juejin.cn/post/7599506068046675968</link>    <guid>https://juejin.cn/post/7599506068046675968</guid>    <pubDate>2026-01-26T10:09:14.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599506068046675968" data-draft-id="7599469598882840591" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="数据工程新范式：基于 NoETL 语义编织实现自助下钻分析"/> <meta itemprop="keywords" content="数据分析"/> <meta itemprop="datePublished" content="2026-01-26T10:09:14.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Aloudata大应科技"/> <meta itemprop="url" content="https://juejin.cn/user/1579340474099927"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            数据工程新范式：基于 NoETL 语义编织实现自助下钻分析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1579340474099927/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Aloudata大应科技
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T10:09:14.000Z" title="Mon Jan 26 2026 10:09:14 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>本文首发于 Aloudata 官方技术博客：<a title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target=">《数据分析师如何能不依赖 IT，自助完成任意维度的下钻分析？》</a>转载请注明出处。</p>
<p><strong>摘要</strong>：本文探讨了数据分析师如何摆脱对 IT 和物理宽表的依赖，实现自助式任意维度下钻分析。通过引入基于 NoETL 语义编织的指标平台，将业务逻辑定义与物理实现解耦。分析师通过声明式配置定义指标与维度网络，平台利用智能物化引擎保障百亿级数据的秒级查询性能，从而将分析需求响应时间从“周级”缩短至“分钟级”，实现真正的自助探索与归因分析。</p>
<p>在数据驱动决策的今天，数据分析师却常常陷入一种困境：面对“为什么销售额突然下降？”这样的业务追问，分析思路总在“维度不足”或“等待取数”时被迫中断。据《数字化转型实战》（机械工业出版社，2023）的数据，企业通过自助式报表工具，数据分析效率平均提升了 57%，但这仍未能解决根本性的数据供给瓶颈。问题的根源，在于传统的“物理宽表”数据供给模式，它将分析师的探索能力限制在IT预先铺设好的有限轨道上。</p>
<h2 data-id="heading-0">传统分析范式的三大卡点：为何你总被“维度”卡住？</h2>
<p>传统基于物理宽表和固定 ETL 的数据供给模式，从根本上限制了数据分析的灵活性与响应速度，导致分析师陷入“提需求-等排期-分析中断”的恶性循环。这具体体现在三个核心卡点上：</p>
<p><strong>1.  卡点一：维度固化，探索受限</strong> 业务需求是发散的，但物理宽表是收敛的。当你从“地区”下钻到“门店”，再想下钻到“店员”或“具体订单”时，如果宽表未预先聚合这些维度，分析便戛然而止。分析师只能回头向 IT 提新需求，等待新的宽表开发。</p>
<p><strong>2.  卡点二：响应迟缓，思路断层</strong> 从提出新维度分析需求，到 IT 沟通、排期、开发、测试、上线，周期常以“周”计。等数据到位，业务时机已过，分析思路早已断层。这种延迟让数据分析从“主动洞察”降级为“事后解释”。</p>
<p><strong>3.  卡点三：口径混乱，归因无力</strong> 指标分散在不同报表和 BI 工具的数据集里，口径不一。当问“为什么销售额涨了？”时，基于聚合结果的浅层回答（如“因为A地区卖得好”）无法穿透到具体的门店、商品或用户行为，实现真正的明细级归因。</p>
<h2 data-id="heading-1">范式跃迁：从“物理宽表”到“语义编织”的 NoETL 新架构</h2>
<p>要打破上述僵局，必须进行架构层面的范式重构。NoETL 语义编织通过构建统一、虚拟的语义层，将业务逻辑定义与物理数据实现彻底解耦，为任意维度的灵活下钻提供了全新的架构基础。</p>
<ul>
<li>核心理念解耦：不再为每个分析场景创建物理宽表（DWS/ADS），而是在公共明细数据层（DWD）之上，通过声明式配置建立逻辑关联，形成一张覆盖全域的“虚拟业务事实网络”。</li>
<li>统一语义层：指标成为独立、可复用的业务对象，拥有明确的定义、血缘和版本。无论下游是 BI、报表还是 AI Agent，都消费同一份权威语义，确保口径 100% 一致。</li>
<li>自动化查询与加速：用户拖拽分析意图，语义引擎自动生成优化 SQL；智能物化引擎根据管理员声明的加速策略，按需创建并透明路由至加速表，保障百亿级明细数据的秒级响应，无需人工干预 ETL。</li>
</ul>
<p>这种“逻辑定义”与“物理执行”的分离，标志着从“以过程为中心”向“以语义为中心”的范式革命。</p>
<h2 data-id="heading-2">三步实践法：数据分析师的自助下钻分析路径</h2>
<p>基于 NoETL 语义编织平台，数据分析师可以通过以下三个标准化步骤，实现高效、灵活的自助分析，彻底摆脱对 IT 的依赖。</p>
<h3 data-id="heading-3">步骤一：声明式定义原子指标与维度网络</h3>
<ul>
<li>核心操作：在平台中，基于 DWD 明细表，通过界面化配置（而非写 SQL）定义核心原子指标（如“交易金额”）和业务维度（如“客户等级”、“商品品类”），并声明表间逻辑关联关系。</li>
<li>关键价值：一次定义，处处可用。确保了全公司分析口径的 100% 一致，为后续任意组合分析打下基础。平台支持定义“近30天消费金额&gt;5,000元的客户人数”等跨表限定、指标维度化的复杂指标。</li>
</ul>
<h3 data-id="heading-4">步骤二：按需配置智能物化加速策略</h3>
<ul>
<li>核心操作：针对高管驾驶舱、核心日报等高并发、低延迟场景，管理员可声明式配置需要加速的指标和维度组合（如“按日、地区、产品线聚合的交易额”），平台自动生成并运维物化任务。</li>
<li>关键价值：将“空间换时间”策略从高投入的猜测变为精准的自动化服务。查询时，引擎透明地进行 SQL 改写和智能路由，命中加速结果，在保障查询性能的同时，极大降低存储与计算成本。</li>
</ul>
<h3 data-id="heading-5">步骤三：任意维度拖拽与明细级归因探索</h3>
<ul>
<li>核心操作：在 BI 工具或平台分析界面中，直接从指标目录拖拽已定义的指标（如“交易额”），并自由组合、添加或切换任意维度（从时间、地区下钻至用户 ID、订单 ID）进行分析。</li>
<li>关键价值：分析思路不再被打断。利用平台内置的明细级多维度归因功能，可快速定位指标波动的关键贡献因子（如“华东地区某门店的 A 商品贡献了 80% 的增长”），从“描述现象”升级到“解释归因”。</li>
</ul>
<h2 data-id="heading-6">价值验证：从“周级等待”到“分钟级洞察”的效能革命</h2>
<p>采用 NoETL 语义编织新范式后，数据分析师的工作效能、分析深度及与业务的协作模式将发生根本性改变。</p>
<ol>
<li>效率质变：指标交付从平均两周缩短至分钟级。某头部券商案例显示，基于 Aloudata CAN 平台，业务分析师可自助完成逾 300 个维度与指标组合的灵活分析，响应临时需求的能力发生质变。</li>
<li>成本优化：消除冗余宽表开发，直接从源头减少 ETL 工作量。同一案例中，平台帮助客户节省了超过 70% 的 ETL 开发工作量，计算与存储资源得到精准控制。</li>
<li>分析深化：基于明细数据的归因成为可能，能回答“为什么”而不仅仅是“是什么”。例如，可快速定位销售额波动的具体贡献门店或商品，支撑精准的运营决策。</li>
<li>角色进化：数据分析师得以从繁重的“取数工人”角色中解放，转向“业务赋能者”和“语义模型设计师”，专注于更具战略价值的深度洞察与数据能力建设。</li>
</ol>
<h2 data-id="heading-7">行动指南：如何在你所在的企业启动变革？</h2>
<p>变革无需推倒重来，可以从选择一个有明确痛点的“灯塔”业务场景开始，采用平滑演进策略。</p>
<ol>
<li>
<p>选择试点场景：如“线上营销效果分析”或“门店日销售追踪”，组建包含数据架构师、分析师和业务专家的小组。</p>
</li>
<li>
<p>技术策略三步走：</p>
<ul>
<li>存量挂载：快速接入现有稳定宽表，提供统一出口，保护既有投资。</li>
<li>增量原生：所有新分析需求，直接基于 DWD 在语义层定义，禁止新建物理宽表。</li>
<li>存量替旧：逐步识别并下线高成本、高维护的旧宽表，用语义层逻辑替代。</li>
</ul>
</li>
<li>
<p>衡量与推广：在试点场景验证价值（如分析效率提升 10 倍），召开由业务负责人“现身说法”的内部分享会，逐步按业务优先级推广至其他领域。</p>
</li>
</ol>
<h2 data-id="heading-8">常见问题 (FAQ)</h2>
<p><strong>Q1: 不依赖 IT 做自助下钻，数据口径如何保证一致？</strong></p>
<p>通过 NoETL 语义编织，所有指标在统一的语义层中进行声明式定义和强校验。平台自动进行同名校验和逻辑判重，从技术上杜绝“同名不同义”。一旦定义发布，所有下游消费（BI、AI、报表）都调用同一个语义对象，确保全企业分析口径 100% 一致。</p>
<p><strong>Q2: 直接查询明细数据，查询性能慢怎么办？</strong></p>
<p>平台内置智能物化加速引擎。管理员可以声明需要加速的指标和维度组合，引擎会自动创建、运维最优的物化视图（加速表）。查询时，引擎透明地进行 SQL 改写和智能路由，让查询命中加速结果，从而在百亿级明细数据上实现秒级响应，对业务用户完全无感。</p>
<p><strong>Q3: 这种模式对现有数据仓库架构冲击大吗？需要推倒重来吗？</strong></p>
<p>完全不需要推倒重来。新范式倡导“平滑演进”。通过“存量挂载”利用现有宽表，“增量原生”处理新需求，逐步“存量替旧”。核心是构建一个独立的语义层，对接现有数据湖仓的公共明细层（DWD），做轻甚至替代数仓的汇总层（ADS），保护既有投资。</p>
<p><strong>Q4: 除了拖拽分析，能直接用自然语言提问吗？</strong></p>
<p>可以。基于坚实的语义层，可以构建如 Aloudata Agent 这样的数据分析智能体。它采用 NL2MQL2SQL 架构：大模型将你的自然语言问题转化为标准的指标查询请求（MQL），再由高确定性的语义引擎翻译成准确 SQL 执行，从根本上避免了大模型的“数据幻觉”，实现可信的对话式分析。</p>
<h2 data-id="heading-9">核心要点</h2>
<ol>
<li>架构解耦是前提：实现自助下钻分析的关键，是将业务逻辑定义（语义层）从物理数据实现（宽表 ETL）中彻底解耦，构建统一的“虚拟业务事实网络”。</li>
<li>声明式配置是核心：通过界面化配置定义指标、维度和关联关系，取代手写 SQL 和物理建模，是实现口径一致与灵活分析的工程基础。</li>
<li>智能加速是保障：基于声明式策略的智能物化引擎，在提供极致分析灵活性的同时，透明保障百亿级数据的秒级查询性能，控制总体成本。</li>
<li>平滑演进是路径：采用“存量挂载、增量原生、逐步替旧”的策略，可以在保护现有投资的同时，稳步向现代化数据架构转型，释放数据团队的更高价值。</li>
</ol>
<hr/>
<p>本文首发于 Aloudata 官方技术博客，查看更多技术细节与案例，请访问原文链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Faloudata.com%2Fknowledge_base%2Fdata-analysts-self-drill-down-analysis" target="_blank" title="https://aloudata.com/knowledge_base/data-analysts-self-drill-down-analysis" ref="nofollow noopener noreferrer">aloudata.com/knowledge_b…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🚀JS 为什么能跑这么快？一文把 V8 “翻译官 + 加速器” 机制讲透（AST / 字节码 / JIT / 去优化）]]></title>    <link>https://juejin.cn/post/7598574507347165219</link>    <guid>https://juejin.cn/post/7598574507347165219</guid>    <pubDate>2026-01-25T04:05:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598574507347165219" data-draft-id="7598588085596815400" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🚀JS 为什么能跑这么快？一文把 V8 “翻译官 + 加速器” 机制讲透（AST / 字节码 / JIT / 去优化）"/> <meta itemprop="keywords" content="前端,JavaScript,面试"/> <meta itemprop="datePublished" content="2026-01-25T04:05:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="swipe"/> <meta itemprop="url" content="https://juejin.cn/user/858052674727959"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🚀JS 为什么能跑这么快？一文把 V8 “翻译官 + 加速器” 机制讲透（AST / 字节码 / JIT / 去优化）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/858052674727959/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    swipe
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-25T04:05:15.000Z" title="Sun Jan 25 2026 04:05:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-25
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    26
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">你的 JS 到底怎么跑起来的？一文看懂 V8：从源码到机器码的“流水线”（含图解）</h2>
<blockquote>
<p>写下 <code>console.log('hi')</code> 的那一刻，CPU 其实完全看不懂。<br/>
真正让 JS “跑起来”的，是 <strong>JavaScript 引擎</strong>——尤其是 Chrome/Node.js 背后的 <strong>V8</strong>。<br/>
这篇文章用一条清晰的流水线，把 V8 的核心机制讲透：<strong>Parse → AST → Ignition(字节码) → TurboFan(机器码) → Deopt(去优化回退)</strong> 。</p>
</blockquote>
<hr/>
<p>文章推荐：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fcloud.tencent.com.cn%2Fdeveloper%2Farticle%2F2453762%3FpolicyId%3D1%26traceId%3D" target="_blank" title="https://cloud.tencent.com.cn/developer/article/2453762?policyId=1&amp;traceId=" ref="nofollow noopener noreferrer">代码10倍提速！吃透底层架构就是如此简单-腾讯云开发者社区-腾讯云</a></p>
<h3 data-id="heading-1">先建立直觉：V8 是一条“翻译+加速”的流水线</h3>
<p>可以把 V8 想象成一个“会学习的翻译官”：</p>
<ul>
<li><strong>第一目标：让代码尽快跑起来</strong>（启动快）</li>
<li><strong>第二目标：把经常跑的代码越跑越快</strong>（热点优化）</li>
<li><strong>第三目标：发现假设错了就回退重来</strong>（去优化 Deopt）</li>
</ul>
<p>接下来所有细节，都围绕这三句话展开。</p>
<hr/>
<h3 data-id="heading-2">01｜为什么 CPU 才是最终执行者</h3>
<p>计算机的大脑——<strong>CPU（中央处理器）</strong> ，只认识机器语言（指令集）。</p>
<ul>
<li><strong>高级语言</strong>：JavaScript, Python, Java（人类易读，抽象程度高）。</li>
<li><strong>机器语言</strong>：二进制指令（CPU 易读，直接控制硬件）。</li>
</ul>
<p><strong>JavaScript 引擎的本质</strong>，就是一个<strong>超级翻译官</strong>。它的核心职责就是：<strong>解释和执行 JS 代码，将其转换为 CPU 能看懂的机器指令。</strong></p>
<blockquote>
<p>所以：<strong>CPU 是“执行者”，V8 是“翻译官 + 加速器”。</strong></p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2f4846426c134e34af3ccec60e3e6cf7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc3dpcGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769938069&amp;x-signature=fge3sTL6p5wRIyz4kWLNm%2F968%2BI%3D" alt="" loading="lazy"/></p>
<p>再看一张更直观的图：代码最终一定要落到 CPU 可执行的机器码上。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/06f1b60e9f034fad8e4d2edc2d03d402~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc3dpcGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769938069&amp;x-signature=nBeMtJInP0ORwUmS6lHL3S3NWXU%3D" alt="" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-3">02｜JavaScript 引擎在浏览器里处在什么位置</h3>
<h4 data-id="heading-4">2.1 常见的翻译官（JS 引擎）</h4>
<p>虽然今天的主角是 V8，但在这个江湖里还有其他大佬：</p>
<ul>
<li><strong>SpiderMonkey</strong>：JS 之父 Brendan Eich 的作品，Firefox 的心脏。</li>
<li><strong>JavaScriptCore</strong>：苹果 WebKit 内核的一部分，Safari 的动力源。</li>
<li><strong>Chakra</strong>：微软 IE/Edge 时代的产物。</li>
<li><strong>V8</strong>：Google 的杰作，它不仅驱动了 Chrome，更是 Node.js 的核心。</li>
</ul>
<p>浏览器内核并不是“只有渲染”，它通常至少包含两大块：</p>
<ul>
<li><strong>渲染相关</strong>：HTML/CSS 解析、布局、绘制</li>
<li><strong>脚本相关</strong>：解析并执行 JavaScript</li>
</ul>
<p>以 WebKit 举例：它可以拆成 <code>WebCore</code> 和 <code>JavaScriptCore</code> 两部分（JS 引擎就是内核的一部分）。<strong>遇到 <code>&lt;script&gt;</code> 标签时</strong>，WebCore 会暂停工作，把控制权交给 JS 引擎。这就是为什么我们常说 JS 会阻塞 DOM 渲染。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/94eef3ea00f74d1284ef9ff43da40019~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc3dpcGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769938069&amp;x-signature=IJeOy8ZYx9dVUFQ%2FjZ1d9FH9lF4%3D" alt="" loading="lazy"/></p>
<hr/>
<h4 data-id="heading-5">2.2、 为什么 V8 能从众神中脱颖而出？</h4>
<p>V8 是用 <strong>C++</strong> 编写的高性能开源引擎。它之所以强，主要归功于这几点：</p>
<ol>
<li><strong>JIT (Just-In-Time) 即时编译</strong>：V8 抛弃了传统的“先转字节码再慢慢解释”或者“全量编译”的极端，而是采用了<strong>混合模式</strong>。它能在运行时将 JS 代码直接编译成机器码，速度极快。</li>
<li><strong>Node.js 的心脏</strong>：V8 证明了 JS 不仅仅能跑在浏览器，也能跑在服务器端，实现了全栈的可能。</li>
<li><strong>垃圾回收（GC）</strong> ：V8 拥有极其先进的分代式垃圾回收机制（后续文章我们将专门拆解）。</li>
</ol>
<h3 data-id="heading-6">03｜V8 全流程：从源码到机器码</h3>
<p>把 V8 的执行流程浓缩成 6 步，会非常清晰：</p>
<ol>
<li><strong>Parse（解析）</strong> ：源码 → AST（抽象语法树），并采用 <strong>Lazy Parsing</strong>（函数即将执行时才完整解析）</li>
<li><strong>Ignition（解释器）</strong> ：AST → <strong>字节码 Bytecode</strong></li>
<li><strong>执行字节码</strong>：先跑起来，并收集运行信息（类型、分支、调用频率…）</li>
<li><strong>TurboFan（优化编译器）</strong> ：热点代码 → <strong>优化后的机器码</strong></li>
<li><strong>Deopt（去优化）</strong> ：假设不成立（常见是类型变化）→ 回退到字节码</li>
<li><strong>机器码执行</strong>：最终交给 CPU</li>
</ol>
<p>用一张图把这条流水线钉死在脑子里：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d331e1cca4fd4142bdae3d2dc7f2372f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc3dpcGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769938069&amp;x-signature=GuCt9gG8sjgG8OmG45IwTtItaZI%3D" alt="" loading="lazy"/></p>
<p>同时，AST 长什么样？大概是这种结构化树形表示：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f20e5336bdb04b4dbffc38ae4a7044ef~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc3dpcGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769938069&amp;x-signature=L1NDOUSUItJhs8xpbQtLN9volE8%3D" alt="" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-7">04｜Parse 细节：词法分析、语法分析与 AST</h3>
<p>很多人卡在“Parse 解析”这一步，原因是：<strong>概念名词多，但直觉不够</strong>。</p>
<h4 data-id="heading-8">4.1 词法分析：把代码拆成 token（最小语法单元）</h4>
<p>在生成树之前，代码首先要被“打碎”。这就是 <strong>词法分析</strong>。</p>
<p>V8 会将代码拆解成一个个最小单元，称为 <strong>Tokens</strong>。</p>
<p>比如代码：<code>const name = "coderwhy"</code></p>
<p>会被拆解为：</p>
<ul>
<li><code>const</code> (Keyword 关键字)</li>
<li><code>name</code> (Identifier 标识符)</li>
<li><code>=</code> (Operator 操作符)</li>
<li><code>"coderwhy"</code> (StringLiteral 字符串字面量)</li>
</ul>
<h4 data-id="heading-9">4.2 语法分析：把 token 重新组装成树（AST）</h4>
<p>拿到 Tokens 后，V8 会依据语法规则，将其组装成一棵树——<strong>AST（抽象语法树）</strong> 。</p>
<p>AST 是前端工程化的基石，<strong>Babel 转译、ESLint 检查、Vue 模板编译</strong>，本质上都在操作 AST。</p>
<p>看看一段简单的代码生成的 AST 结构：</p>
<p>JavaScript</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">sayHi</span>(<span class="hljs-params">name</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Hi "</span> + name)
}
</code></pre>
<p>对应的 AST 结构概览：</p>
<ul>
<li>
<p><strong>FunctionDeclaration</strong> (函数声明: sayHi)</p>
<ul>
<li>
<p><strong>Identifier</strong> (参数: name)</p>
</li>
<li>
<p><strong>BlockStatement</strong> (函数体)</p>
<ul>
<li>
<p><strong>ExpressionStatement</strong> (表达式)</p>
<ul>
<li><strong>CallExpression</strong> (调用 console.log)</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<hr/>
<h3 data-id="heading-10">05｜为什么要保留“字节码”这一层</h3>
<p>直觉上会觉得：<strong>少一层转换就更快</strong>，那为什么不直接 AST → 机器码？</p>
<p>因为工程里真正的目标不是“某一步最快”，而是“整体更快、更稳、更可控”。保留字节码主要带来：</p>
<ol>
<li><strong>跨平台</strong>：字节码不绑定某一种 CPU 指令集</li>
<li><strong>优化更聪明</strong>：先跑字节码，收集运行数据，再决定怎么生成更优机器码</li>
<li><strong>更安全、更可控</strong>：更容易做隔离、策略、内存管理</li>
<li><strong>更容易调试</strong>：断点/单步在字节码层更容易实现</li>
</ol>
<p>配合这张图理解，会很顺：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b1c22d73a1974c83a354868f97bffadc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc3dpcGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769938069&amp;x-signature=v0eyE6gwcY8kDxCsYpuKUOHhVAw%3D" alt="" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-11">06｜架构拆解：Parse / Ignition / TurboFan 各做什么</h3>
<p>用“岗位职责”来记：</p>
<ul>
<li><strong>Parse</strong>：把 JS 代码变成 AST（解释器不直接认识 JS 源码）</li>
<li><strong>Ignition</strong>：把 AST 变成字节码并执行，同时收集 TurboFan 需要的运行信息（比如类型信息）</li>
<li><strong>TurboFan</strong>：把热点字节码编译成更快的机器码（并持续迭代优化）</li>
</ul>
<p>这里有一个非常关键的运行规律：</p>
<blockquote>
<p><strong>热点函数会被优化</strong>，但<strong>类型变化等情况会触发去优化回退</strong>。</p>
</blockquote>
<hr/>
<h3 data-id="heading-12">07｜预解析 vs 全量解析：Lazy Parsing 为什么能让启动更快</h3>
<p>V8 并不会“上来就把一切都解析得巨细无遗”，它会做取舍：</p>
<h4 data-id="heading-13">7.1 预解析（Pre-parsing）</h4>
<ul>
<li>目标：<strong>快速扫描</strong>，提取结构信息（变量/函数声明等）</li>
<li>特点：不深挖函数体内部逻辑 → <strong>更快</strong></li>
</ul>
<h4 data-id="heading-14">7.2 全量解析（Full parsing）</h4>
<ul>
<li>目标：把函数体、表达式、语句细节全部建出来</li>
<li>特点：AST 更完整 → 便于后续生成字节码与优化</li>
</ul>
<p>因此，“函数没执行会不会生成 AST？”更准确的回答是：</p>
<ul>
<li>会生成一个<strong>简化的结构架子</strong>（预解析）</li>
<li>真要执行之前，会补齐为<strong>完整 AST</strong>（全量解析）</li>
</ul>
<hr/>
<h3 data-id="heading-15">08｜走一遍官方图：token、AST、字节码到底怎么来的</h3>
<p>先准备一段模板代码：</p>
<pre><code class="hljs language-javascript" lang="javascript">name = <span class="hljs-string">"XiaoWu"</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(name)

<span class="hljs-keyword">function</span> <span class="hljs-title function_">sayHi</span>(<span class="hljs-params">name</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Hi "</span> + name)
}

<span class="hljs-title function_">sayHi</span>(name)
</code></pre>
<h4 data-id="heading-16">8.1 官方流程图：从输入到字节码</h4>
<p>这张图非常经典，建议收藏：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fb56f664de504858a28148774bbce437~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc3dpcGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769938069&amp;x-signature=tcIACPqj1rDe03%2FA6YrfI3zEWy4%3D" alt="" loading="lazy"/></p>
<p>按图理解就是：</p>
<ul>
<li><strong>Scanner</strong>：扫描字符流 → 生成 tokens</li>
<li><strong>PreParser</strong>：做预解析（快速判断结构）</li>
<li><strong>Parser</strong>：构建 AST</li>
<li><strong>Bytecode</strong>：AST → 字节码</li>
</ul>
<h4 data-id="heading-17">8.2 token 长什么样（词法分析结果）</h4>
<p>下面是典型 token 形态（摘取关键类型，方便理解）：</p>
<pre><code class="hljs language-ini" lang="ini">Token(<span class="hljs-attr">type</span>=<span class="hljs-string">'Keyword'</span>, value=<span class="hljs-string">'const'</span>)            // 关键字
Token(<span class="hljs-attr">type</span>=<span class="hljs-string">'Identifier'</span>, value=<span class="hljs-string">'name'</span>)          // 标识符
Token(<span class="hljs-attr">type</span>=<span class="hljs-string">'Operator'</span>, value=<span class="hljs-string">'='</span>)               // 运算符
Token(<span class="hljs-attr">type</span>=<span class="hljs-string">'StringLiteral'</span>, value=<span class="hljs-string">'"coderwhy and XiaoYu"'</span>) // 字符串字面量
Token(<span class="hljs-attr">type</span>=<span class="hljs-string">'Punctuation'</span>, value=<span class="hljs-string">';'</span>)            // 标点符号

Token(<span class="hljs-attr">type</span>=<span class="hljs-string">'Identifier'</span>, value=<span class="hljs-string">'console'</span>)
Token(<span class="hljs-attr">type</span>=<span class="hljs-string">'Punctuation'</span>, value=<span class="hljs-string">'.'</span>)
Token(<span class="hljs-attr">type</span>=<span class="hljs-string">'Identifier'</span>, value=<span class="hljs-string">'log'</span>)
Token(<span class="hljs-attr">type</span>=<span class="hljs-string">'Punctuation'</span>, value=<span class="hljs-string">'('</span>)
Token(<span class="hljs-attr">type</span>=<span class="hljs-string">'Identifier'</span>, value=<span class="hljs-string">'name'</span>)
Token(<span class="hljs-attr">type</span>=<span class="hljs-string">'Punctuation'</span>, value=<span class="hljs-string">')'</span>)
Token(<span class="hljs-attr">type</span>=<span class="hljs-string">'Punctuation'</span>, value=<span class="hljs-string">';'</span>)
</code></pre>
<h4 data-id="heading-18">8.3 语法分析：预解析如何参与</h4>
<p>这张图专门解释“预解析/解析”的关系：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/69d4f091bbd44a128203c9a3397c469a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc3dpcGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769938069&amp;x-signature=Hc3DJgH2%2BdXesCtbADkU2VPMmy4%3D" alt="" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-19">09｜热点优化与去优化：为什么“有时突然变慢”</h3>
<p>V8 会把被频繁执行的函数标记为 <strong>热点函数</strong>，然后交给 TurboFan 编译为更快的机器码。</p>
<p>但注意：<strong>优化是有前提假设的</strong>。最常见的假设就是“类型稳定”。</p>
<p>来看这个例子：</p>
<pre><code class="hljs language-scss" lang="scss">function sum (num1,num2){
  return num1 + num2
}

<span class="hljs-comment">// 多次调用 -&gt; 可能成为热点函数 -&gt; 被优化</span>
<span class="hljs-built_in">sum</span>(<span class="hljs-number">20</span>,<span class="hljs-number">20</span>)
<span class="hljs-built_in">sum</span>(<span class="hljs-number">20</span>,<span class="hljs-number">20</span>)

<span class="hljs-comment">// 类型突然变化 -&gt; 之前的机器码假设不成立 -&gt; 去优化回退</span>
<span class="hljs-built_in">sum</span>('xiaoyu','coderwhy')
</code></pre>
<p>发生了什么？</p>
<ul>
<li>前两次传入 <code>number</code>，优化器可能会假设“这里一直是 number 加法”</li>
<li>第三次突然变成 <code>string</code> 拼接，机器码可能无法正确处理 → <strong>回退到字节码重新收集信息，再决定是否重新优化</strong></li>
</ul>
<p>这就是性能“抖一下”的根源之一：<strong>Deopt（去优化）</strong> 。</p>
<hr/>
<h3 data-id="heading-20">10｜字节码与机器码（了解即可）：JIT 到底做了什么</h3>
<p>机器码的生成通常依赖 <strong>JIT（Just-In-Time Compilation，即时编译）</strong> ：</p>
<ul>
<li>把字节码转换成本地机器码</li>
<li>把结果缓存起来</li>
<li>后续执行直接复用缓存的机器码（更快）</li>
</ul>
<p>TurboFan 作为优化编译器，会基于 IR（中间表示）做多层优化（类型、内联、控制流等）：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9026bf89ba4e4ae293a03753ebf02b23~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc3dpcGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769938069&amp;x-signature=Uat8DUsKMT2ox%2Fe00Eaamn0REqI%3D" alt="" loading="lazy"/></p>
<p>同时，字节码到机器码的过程中，会存在不同优化策略：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c5f87e40aeb04e599978ce8cf1a20903~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc3dpcGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769938069&amp;x-signature=BmLOPuZZg%2BWrHH6Z5JcUHYjcKSE%3D" alt="" loading="lazy"/></p>
<p>这里还有两张配图（保持原样保留）：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ca7fe53e26f54a30beb3daaf60c0d034~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc3dpcGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769938069&amp;x-signature=uvn0YNPuO%2Flbxw5tG5zBPrDefm8%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/346599b792034889bd49dfada16ae9c5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc3dpcGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769938069&amp;x-signature=5Ox7Vt5Dt1jJ%2F3h14wl903towuM%3D" alt="" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-21">结尾：把知识用起来</h3>
<p>看到这里，你是否对那个黑盒子一样的浏览器有了新的认识？</p>
<p>我们简单回顾一下 V8 的奇幻旅程：</p>
<ol>
<li><strong>Scanner &amp; Parser</strong>：把代码拆解成 Tokens，再组装成 AST（注意预解析优化）。</li>
<li><strong>Ignition</strong>：把 AST 翻译成字节码，边解释边执行。</li>
<li><strong>TurboFan</strong>：在后台偷偷观察，把热点代码编译成机器码，但一旦类型变化，就会被打回原形。</li>
</ol>
<p><strong>下期预告：</strong></p>
<p>理解了执行流程，还有一个大魔王在等着我们——<strong>内存管理</strong>。</p>
<ul>
<li>JS 的闭包为什么会导致内存泄漏？</li>
<li>V8 的垃圾回收（GC）是如何区分“新生代”和“老年代”的？</li>
<li>全停顿（Stop-the-world）是什么？</li>
</ul>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Python异步编程：为什么90%的开发者都用错了这3个关键点？]]></title>    <link>https://juejin.cn/post/7598480267218485282</link>    <guid>https://juejin.cn/post/7598480267218485282</guid>    <pubDate>2026-01-25T00:19:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598480267218485282" data-draft-id="7598588085596602408" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Python异步编程：为什么90%的开发者都用错了这3个关键点？"/> <meta itemprop="keywords" content="后端,前端,人工智能"/> <meta itemprop="datePublished" content="2026-01-25T00:19:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿橙的百宝箱"/> <meta itemprop="url" content="https://juejin.cn/user/1638743356481367"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Python异步编程：为什么90%的开发者都用错了这3个关键点？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1638743356481367/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿橙的百宝箱
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-25T00:19:46.000Z" title="Sun Jan 25 2026 00:19:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-25
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    15
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>Python异步编程：为什么90%的开发者都用错了这3个关键点？</strong></h2>
<h3 data-id="heading-1">引言</h3>
<p>异步编程已经成为现代Python开发中不可或缺的一部分，尤其是在I/O密集型和高并发场景下。随着<code>asyncio</code>库的成熟和Python对异步支持的不断增强，越来越多的开发者开始尝试利用异步编程来提升性能。然而，在实践中，许多开发者并未真正理解异步编程的核心概念，导致代码效率低下、难以维护甚至出现难以调试的问题。</p>
<p>本文将深入探讨Python异步编程中最容易被误解或错误使用的3个关键点：<strong>事件循环的理解与使用</strong>、<strong>协程的正确调度</strong>以及<strong>资源管理与线程安全</strong>。通过分析这些常见误区，帮助开发者更好地掌握异步编程的精髓。</p>
<hr/>
<h3 data-id="heading-2">1. 事件循环：不仅仅是“后台任务调度器”</h3>
<h4 data-id="heading-3">误区：事件循环是一个黑匣子</h4>
<p>许多开发者将事件循环（Event Loop）简单地视为一个“后台任务调度器”，认为只要将任务丢给<code>asyncio.run()</code>或<code>loop.run_until_complete()</code>就能自动实现异步执行。这种理解过于肤浅，忽略了事件循环的核心作用：<strong>协调和管理所有协程的执行顺序和资源分配</strong>。</p>
<h4 data-id="heading-4">深入解析</h4>
<ul>
<li><strong>事件循环的本质</strong>：事件循环是单线程的，它通过轮询I/O事件和协程的状态来决定下一步执行哪个任务。它的核心是“非阻塞”和“协作式多任务”。</li>
<li><strong>常见错误</strong>：
<ol>
<li><strong>阻塞事件循环</strong>：在协程中调用同步阻塞操作（如<code>time.sleep()</code>或CPU密集型计算），导致整个事件循环被卡住。正确的做法是使用<code>await asyncio.sleep()</code>或将CPU密集型任务交给<code>loop.run_in_executor()</code>。</li>
<li><strong>滥用多个事件循环</strong>：在同一个线程中创建多个事件循环（如手动调用<code>asyncio.new_event_loop()</code>）会导致不可预测的行为。通常，一个线程只需要一个事件循环。</li>
</ol>
</li>
</ul>
<h4 data-id="heading-5">最佳实践</h4>
<ul>
<li>始终使用<code>asyncio.run()</code>作为入口点（Python 3.7+），避免手动管理事件循环的生命周期。</li>
<li>对于需要并行执行的I/O操作，优先使用<code>asyncio.gather()</code>或<code>asyncio.create_task()</code>，而不是手动操作事件循环。</li>
</ul>
<hr/>
<h3 data-id="heading-6">2. 协程的正确调度：从“Fire-and-Forget”到结构化并发</h3>
<h4 data-id="heading-7">误区：“启动即忘”的协程管理</h4>
<p>许多开发者习惯直接调用<code>asyncio.create_task()</code>而不保存返回的Task对象，导致无法跟踪任务状态或处理异常。这种“Fire-and-Forget”模式会引发以下问题：</p>
<ol>
<li><strong>无法捕获异常</strong>：未被等待的Task如果抛出异常，可能不会触发任何错误处理逻辑。</li>
<li><strong>资源泄漏</strong>：未完成的任务可能持有资源（如数据库连接），但无法被及时清理。</li>
</ol>
<h4 data-id="heading-8">深入解析</h4>
<ul>
<li><strong>结构化并发的重要性</strong>：异步代码应该像同步代码一样具有明确的任务边界和生命周期管理。Python 3.11引入的<code>TaskGroup</code>（通过<code>asyncio.TaskGroup</code>）正是为了解决这一问题。</li>
<li><strong>常见错误场景</strong>：
<ol>
<li><strong>未处理的Task异常</strong>：如果一个Task未被显式等待，其异常会被静默丢弃（除非调用<code>.exception()</code>或<code>.result()</code>）。</li>
<li><strong>取消传播问题</strong>：直接取消父Task不会自动取消子Task，需要手动管理取消逻辑。</li>
</ol>
</li>
</ul>
<h4 data-id="heading-9">最佳实践</h4>
<ul>
<li>使用<code>asyncio.TaskGroup</code>（Python 3.11+）或第三方库（如<code>trio</code>）实现结构化并发：
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> asyncio.TaskGroup() <span class="hljs-keyword">as</span> tg:
        tg.create_task(task1())
        tg.create_task(task2())
    <span class="hljs-comment"># 所有任务完成后继续执行</span>
</code></pre>
</li>
<li>对于旧版本Python，至少要通过<code>asyncio.gather(return_exceptions=True)</code>捕获所有任务的异常。</li>
</ul>
<hr/>
<h3 data-id="heading-10">3. 资源管理与线程安全：“异步上下文”不是万能的</h3>
<h4 data-id="heading-11">误区：认为异步代码天然线程安全</h4>
<p>由于异步编程基于协程的单线程模型，许多开发者误以为不需要考虑线程安全问题。然而，在以下场景中仍然存在风险：</p>
<ol>
<li><strong>混合同步与异步代码</strong>：例如在协程中调用同步数据库驱动（如psycopg2），可能导致死锁或竞争条件。</li>
<li><strong>共享状态访问</strong>：即使是单线程环境，如果多个协程同时修改共享变量（如全局字典），也可能因上下文切换导致数据不一致。</li>
</ol>
<h4 data-id="heading-12">深入解析</h4>
<ul>
<li><strong>GIL的限制</strong>：虽然GIL避免了真正的并行执行，但协程的切换是显式的（通过<code>await</code>），因此共享状态的修改仍需要同步机制（如<code>asyncio.Lock</code>）。</li>
<li><strong>常见陷阱案例</strong>：
<ol>
<li><strong>阻塞I/O破坏异步性</strong>：在协程中使用同步Redis客户端会导致整个事件循环阻塞；应改用异步客户端（如<code>aioredis</code>）。</li>
<li><strong>未受保护的共享状态</strong>：即使是无竞争的全局变量修改也需要锁保护（例如计数器递增操作）。</li>
</ol>
</li>
</ul>
<h4 data-id="heading-13">最佳实践</h4>
<ul>
<li><strong>严格分离同步与异步代码边界</strong>：使用适配器模式将同步代码封装为异步接口（如通过线程池执行）。</li>
<li><strong>显式同步机制选择原则</strong>：
<ul>
<li><code>asyncio.Lock</code>: 适用于单进程内的协程间互斥。</li>
<li><code>threading.Lock</code>: 仅用于与同步代码交互的场景。</li>
<li><code>multiprocessing.Lock</code>: 跨进程共享状态时使用。</li>
</ul>
</li>
</ul>
<hr/>
<h3 data-id="heading-14">总结</h3>
<p>Python异步编程的强大之处在于其高效和非阻塞的特性，但同时也对开发者的设计能力提出了更高要求。本文分析的三个关键点——事件循环、协程调度和资源管理——是大多数问题的根源所在。要真正掌握异步编程，必须理解其底层原理并遵循结构化并发的最佳实践：</p>
<ol>
<li><strong>尊重事件循环的单线程本质</strong>，避免阻塞操作。</li>
<li><strong>采用结构化并发模式管理任务生命周期</strong>。</li>
<li><strong>明确区分同步与异步边界并正确使用锁机制</strong>.</li>
</ol>
<p>只有将这些原则融入日常开发习惯才能真正发挥出Python异步编程的全部潜力！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Hono 路由器为什么这么快？]]></title>    <link>https://juejin.cn/post/7598801700050337830</link>    <guid>https://juejin.cn/post/7598801700050337830</guid>    <pubDate>2026-01-25T03:39:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598801700050337830" data-draft-id="7598818096753229875" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Hono 路由器为什么这么快？"/> <meta itemprop="keywords" content="Bun,性能优化"/> <meta itemprop="datePublished" content="2026-01-25T03:39:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="jump_jump"/> <meta itemprop="url" content="https://juejin.cn/user/4230576474692765"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Hono 路由器为什么这么快？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4230576474692765/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    jump_jump
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-25T03:39:19.000Z" title="Sun Jan 25 2026 03:39:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-25
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    17
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>从底层引擎优化角度，深入剖析 Hono 路由器的极致性能奥秘</p>
</blockquote>
<hr/>
<h2 data-id="heading-0">引言</h2>
<p>在众多 JavaScript Web 框架中，Hono 以其极致的性能表现脱颖而出。特别是在 <strong>Cloudflare Workers、Deno 等边缘计算环境</strong>中，Hono 的路由匹配速度在同类框架中名列前茅。这背后的秘密是什么？答案就藏在它的 <strong>RegExpRouter</strong> 实现中。</p>
<blockquote>
<p><strong>⚠️ 重要提示</strong>：本文重点讨论 RegExpRouter 的核心原理。在实际应用中，Hono 使用 SmartRouter 自动组合多种路由器（RegExpRouter、TrieRouter、LinearRouter）以达到最佳性能。</p>
</blockquote>
<p>本文将通过一个精简的实现，深入剖析 Hono 路由器的核心原理，帮助你理解：</p>
<ul>
<li>为什么 RegExp 路由比传统路由快</li>
<li>路由是如何预编译的</li>
<li>参数提取的巧妙设计</li>
</ul>
<hr/>
<p><strong>📌 关键要点</strong></p>





























<table><thead><tr><th>项目</th><th>说明</th></tr></thead><tbody><tr><td>核心原理</td><td>将路由预编译为正则表达式，利用引擎底层优化</td></tr><tr><td>性能优势</td><td>减少 JS 层开销，一次原生调用完成匹配</td></tr><tr><td>最佳环境</td><td>Cloudflare Workers、Deno 等边缘计算平台</td></tr><tr><td>实际架构</td><td>SmartRouter + RegExpRouter + TrieRouter 组合</td></tr><tr><td>权衡考虑</td><td>Node.js 环境性能打折扣，路由注册较慢</td></tr></tbody></table>
<h2 data-id="heading-1">传统路由的性能瓶颈</h2>
<p>在理解 Hono 的优化之前，我们先看看传统路由的处理方式：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 传统路由的典型实现</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">matchRoute</span>(<span class="hljs-params">path, routes</span>) {
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> route <span class="hljs-keyword">of</span> routes) {
    <span class="hljs-comment">// 1. 字符串分割</span>
    <span class="hljs-keyword">const</span> pathParts = path.<span class="hljs-title function_">split</span>(<span class="hljs-string">'/'</span>);
    <span class="hljs-keyword">const</span> routeParts = route.<span class="hljs-property">path</span>.<span class="hljs-title function_">split</span>(<span class="hljs-string">'/'</span>);

    <span class="hljs-comment">// 2. 逐段比较</span>
    <span class="hljs-keyword">if</span> (pathParts.<span class="hljs-property">length</span> !== routeParts.<span class="hljs-property">length</span>) <span class="hljs-keyword">continue</span>;

    <span class="hljs-keyword">const</span> params = {};
    <span class="hljs-keyword">let</span> matched = <span class="hljs-literal">true</span>;

    <span class="hljs-comment">// 3. JS 层面的循环和条件判断</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; pathParts.<span class="hljs-property">length</span>; i++) {
      <span class="hljs-keyword">if</span> (routeParts[i].<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">':'</span>)) {
        params[routeParts[i].<span class="hljs-title function_">slice</span>(<span class="hljs-number">1</span>)] = pathParts[i];
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (pathParts[i] !== routeParts[i]) {
        matched = <span class="hljs-literal">false</span>;
        <span class="hljs-keyword">break</span>;
      }
    }

    <span class="hljs-keyword">if</span> (matched) <span class="hljs-keyword">return</span> { route, params };
  }
  <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
}
</code></pre>
<p><strong>性能问题在哪里？</strong></p>
<ul>
<li>❌ 大量的字符串操作（<code>split</code>、<code>slice</code>）</li>
<li>❌ 多层循环和条件判断，全在 JavaScript 层面执行</li>
<li>❌ 每个请求都要重复这些操作</li>
</ul>
<h2 data-id="heading-2">Hono 的解决方案：下沉到引擎层</h2>
<p>Hono 的核心思想非常简单却极其巧妙：</p>
<blockquote>
<p><strong>将路由匹配逻辑从 JavaScript 层下沉到 JavaScript 引擎底层（C++ 实现的正则表达式引擎）</strong></p>
</blockquote>
<h3 data-id="heading-3">1. 预编译阶段（应用启动时）</h3>
<p>在应用启动时，Hono 会将路由路径转换为正则表达式：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 路由路径：/user/:id/posts/:postId</span>
<span class="hljs-comment">// 转换为正则：/^\/user\/([^/]+)\/posts\/([^/]+)$/</span>

<span class="hljs-keyword">const</span> <span class="hljs-attr">paramNames</span>: <span class="hljs-built_in">string</span>[] = [];

<span class="hljs-keyword">const</span> regexPath = path.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/:([a-zA-Z0-9_]+)/g</span>, <span class="hljs-function">(<span class="hljs-params">_, paramName</span>) =&gt;</span> {
  paramNames.<span class="hljs-title function_">push</span>(paramName); <span class="hljs-comment">// 记录参数名</span>
  <span class="hljs-keyword">return</span> <span class="hljs-string">'([^/]+)'</span>;           <span class="hljs-comment">// 替换为捕获组</span>
});

<span class="hljs-keyword">const</span> pattern = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RegExp</span>(<span class="hljs-string">`^<span class="hljs-subst">${regexPath}</span>$`</span>);
</code></pre>
<p><strong>关键点：</strong></p>
<ul>
<li><code>:id</code> → <code>([^/]+)</code>：匹配除 <code>/</code> 外的任意字符</li>
<li>参数名被保存在 <code>paramNames</code> 数组中</li>
<li>这个"昂贵"的编译过程只在启动时执行一次</li>
</ul>
<h3 data-id="heading-4">2. 匹配阶段（请求到来时）</h3>
<p>当请求到来时，只需要一行代码：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> match = pattern.<span class="hljs-title function_">exec</span>(path);
</code></pre>
<p><strong>这行代码的魔法：</strong></p>
<ul>
<li>✅ <code>exec</code> 是 JavaScript 引擎的原生方法，由 C++ 实现</li>
<li>✅ 正则引擎在底层进行了高度优化（状态机、JIT 编译等）</li>
<li>✅ 无需手动分割字符串、无需 JS 层循环</li>
<li>✅ 参数提取通过捕获组自动完成</li>
</ul>
<h3 data-id="heading-5">3. 参数提取</h3>
<p>匹配成功后，参数提取也非常简洁：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> <span class="hljs-attr">params</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">string</span>&gt; = {};
route.<span class="hljs-property">paramNames</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">name, index</span>) =&gt;</span> {
  params[name] = match[index + <span class="hljs-number">1</span>]; <span class="hljs-comment">// match[0] 是完整匹配</span>
});
</code></pre>
<h2 data-id="heading-6">完整实现解析</h2>
<p>让我们看完整的简化实现，包含所有必要的类型定义：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// ============ 类型定义 ============</span>

<span class="hljs-comment">/**
 * 路由处理函数类型
 * <span class="hljs-doctag">@param</span> <span class="hljs-variable">params</span> - 从 URL 中提取的参数对象
 */</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">Handler</span> = <span class="hljs-function">(<span class="hljs-params">params: Record&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">string</span>&gt;</span>) =&gt;</span> <span class="hljs-built_in">void</span>;

<span class="hljs-comment">/**
 * 路由信息接口
 */</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">Route</span> {
  <span class="hljs-attr">method</span>: <span class="hljs-built_in">string</span>;        <span class="hljs-comment">// HTTP 方法（GET, POST, etc.）</span>
  <span class="hljs-attr">path</span>: <span class="hljs-built_in">string</span>;          <span class="hljs-comment">// 原始路径模式（如 /user/:id）</span>
  <span class="hljs-attr">handler</span>: <span class="hljs-title class_">Handler</span>;      <span class="hljs-comment">// 路由处理函数</span>
  <span class="hljs-attr">paramNames</span>: <span class="hljs-built_in">string</span>[];  <span class="hljs-comment">// 参数名数组（如 ['id', 'postId']）</span>
}

<span class="hljs-comment">/**
 * 匹配结果接口
 */</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">MatchResult</span> {
  <span class="hljs-attr">handler</span>: <span class="hljs-title class_">Handler</span>;
  <span class="hljs-attr">params</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">string</span>&gt;;
}

<span class="hljs-comment">// ============ 核心路由器实现 ============</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DemoRegExpRouter</span> {
  <span class="hljs-comment">// 存储预编译的正则表达式和路由信息</span>
  <span class="hljs-keyword">private</span> <span class="hljs-attr">routes</span>: { <span class="hljs-attr">pattern</span>: <span class="hljs-title class_">RegExp</span>; <span class="hljs-attr">route</span>: <span class="hljs-title class_">Route</span> }[] = [];

  <span class="hljs-comment">// 注册路由：预编译</span>
  <span class="hljs-title function_">add</span>(<span class="hljs-params">method: <span class="hljs-built_in">string</span>, path: <span class="hljs-built_in">string</span>, handler: Handler</span>) {
    <span class="hljs-keyword">const</span> <span class="hljs-attr">paramNames</span>: <span class="hljs-built_in">string</span>[] = [];

    <span class="hljs-comment">// 将 :param 转为正则捕获组</span>
    <span class="hljs-keyword">const</span> regexPath = path.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/:([a-zA-Z0-9_]+)/g</span>, <span class="hljs-function">(<span class="hljs-params">_, paramName</span>) =&gt;</span> {
      paramNames.<span class="hljs-title function_">push</span>(paramName);
      <span class="hljs-keyword">return</span> <span class="hljs-string">'([^/]+)'</span>;
    });

    <span class="hljs-keyword">const</span> pattern = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RegExp</span>(<span class="hljs-string">`^<span class="hljs-subst">${regexPath}</span>$`</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">routes</span>.<span class="hljs-title function_">push</span>({ pattern, <span class="hljs-attr">route</span>: { method, path, handler, paramNames } });
  }

  <span class="hljs-comment">// 匹配路由：执行正则</span>
  <span class="hljs-title function_">match</span>(<span class="hljs-params">method: <span class="hljs-built_in">string</span>, path: <span class="hljs-built_in">string</span></span>) {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> { pattern, route } <span class="hljs-keyword">of</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">routes</span>) {
      <span class="hljs-keyword">if</span> (route.<span class="hljs-property">method</span> !== method &amp;&amp; route.<span class="hljs-property">method</span> !== <span class="hljs-string">'ALL'</span>) <span class="hljs-keyword">continue</span>;

      <span class="hljs-keyword">const</span> match = pattern.<span class="hljs-title function_">exec</span>(path); <span class="hljs-comment">// 核心：原生正则匹配</span>

      <span class="hljs-keyword">if</span> (match) {
        <span class="hljs-keyword">const</span> <span class="hljs-attr">params</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">string</span>&gt; = {};
        route.<span class="hljs-property">paramNames</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">name, index</span>) =&gt;</span> {
          params[name] = match[index + <span class="hljs-number">1</span>];
        });
        <span class="hljs-keyword">return</span> { <span class="hljs-attr">handler</span>: route.<span class="hljs-property">handler</span>, params };
      }
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
  }
}
</code></pre>
<h2 data-id="heading-7">实战示例</h2>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> router = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DemoRegExpRouter</span>();

<span class="hljs-comment">// 注册路由</span>
router.<span class="hljs-title function_">add</span>(<span class="hljs-string">'GET'</span>, <span class="hljs-string">'/user/:id'</span>, <span class="hljs-function">(<span class="hljs-params">params</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`获取用户详情，ID: <span class="hljs-subst">${params.id}</span>`</span>);
});

router.<span class="hljs-title function_">add</span>(<span class="hljs-string">'GET'</span>, <span class="hljs-string">'/user/:id/posts/:postId'</span>, <span class="hljs-function">(<span class="hljs-params">params</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`获取用户 <span class="hljs-subst">${params.id}</span> 的文章 <span class="hljs-subst">${params.postId}</span>`</span>);
});

<span class="hljs-comment">// 匹配请求</span>
<span class="hljs-keyword">const</span> result = router.<span class="hljs-title function_">match</span>(<span class="hljs-string">'GET'</span>, <span class="hljs-string">'/user/123/posts/456'</span>);
<span class="hljs-keyword">if</span> (result) {
  result.<span class="hljs-title function_">handler</span>(result.<span class="hljs-property">params</span>);
  <span class="hljs-comment">// 输出: 获取用户 123 的文章 456</span>
}
</code></pre>
<h2 data-id="heading-8">性能优势分析</h2>
<p><strong>为什么 RegExpRouter 更快？</strong></p>
<ol>
<li><strong>减少 JS 执行开销</strong>：从多层循环降到一次原生调用</li>
<li><strong>引擎优化</strong>：正则引擎经过数十年优化，包含 JIT、状态机等技术</li>
<li><strong>减少内存分配</strong>：无需频繁创建数组、对象</li>
<li><strong>一次性编译</strong>：预编译阶段完成所有准备工作，请求时零额外开销</li>
</ol>
<p><strong>性能对比概览</strong></p>























<table><thead><tr><th>方案</th><th>实现层次</th><th>执行效率</th><th>适用场景</th></tr></thead><tbody><tr><td>传统路由</td><td>JavaScript 层</td><td>中等</td><td>通用场景</td></tr><tr><td>RegExpRouter</td><td>引擎底层</td><td>极快</td><td>边缘计算、高并发</td></tr></tbody></table>
<blockquote>
<p><strong>📊 实际 Benchmark</strong>：根据 <a href="https://link.juejin.cn?target=https%3A%2F%2Fhono.dev%2Fdocs%2Fconcepts%2Fbenchmarks" target="_blank" title="https://hono.dev/docs/concepts/benchmarks" ref="nofollow noopener noreferrer">Hono 官方测试</a>，在 Cloudflare Workers 和 Deno 环境中，Hono 是同类框架中最快的。但在 Node.js 环境中，由于适配器开销，性能优势会打折扣。</p>
</blockquote>
<h2 data-id="heading-9">Hono 真实实现的进一步优化</h2>
<p>本文的简化版每个路由都是独立的正则表达式。而 Hono 的真实实现采用了<strong>多路由器协同</strong>的策略：</p>
<h3 data-id="heading-10">1. SmartRouter（智能路由器）</h3>
<p>Hono 默认使用 <strong>SmartRouter</strong>，它会：</p>
<ul>
<li>根据路由特征自动选择最快的路由器</li>
<li>动态组合 RegExpRouter、TrieRouter、LinearRouter</li>
<li>检测路由模式并持续使用最优方案</li>
</ul>
<h3 data-id="heading-11">2. 路由器分工</h3>

























<table><thead><tr><th>路由器</th><th>适用场景</th><th>特点</th></tr></thead><tbody><tr><td><strong>RegExpRouter</strong></td><td>动态参数路由</td><td>最快，但不支持所有模式</td></tr><tr><td><strong>TrieRouter</strong></td><td>复杂路由模式</td><td>支持所有模式，性能优秀</td></tr><tr><td><strong>LinearRouter</strong></td><td>少量路由</td><td>简单可靠，路由少时够用</td></tr></tbody></table>
<h3 data-id="heading-12">3. 实际优化策略</h3>
<ul>
<li><strong>静态路由优先</strong>：<code>/about</code>、<code>/contact</code> 等使用 Map 快速查找</li>
<li><strong>路由预分组</strong>：按 HTTP 方法分组，减少匹配次数</li>
<li><strong>延迟编译</strong>：RegExpRouter 编译较慢，适合应用启动时初始化，不适合无服务器环境的冷启动</li>
</ul>
<p>这些优化使得 Hono 在处理数百个路由时仍然保持极高性能。</p>
<h2 data-id="heading-13">局限性与权衡</h2>
<p>RegExpRouter 并非银弹，在使用时需要注意以下限制：</p>
<h3 data-id="heading-14">RegExpRouter 的局限</h3>
<ul>
<li><strong>不支持所有路由模式</strong>：某些复杂的路由规则无法用简单正则表示</li>
<li><strong>注册阶段较慢</strong>：路由编译需要时间，不适合每次请求都重新初始化的环境（如某些无服务器冷启动场景）</li>
<li><strong>调试难度</strong>：编译后的正则表达式可读性较差，出错时难以定位</li>
<li><strong>模式约束</strong>：如带严格约束的参数 <code>/:id(\\d+)</code> 需要额外处理</li>
</ul>
<h3 data-id="heading-15">运行环境差异</h3>






























<table><thead><tr><th>环境</th><th>性能表现</th><th>原因</th></tr></thead><tbody><tr><td>Cloudflare Workers</td><td>⭐⭐⭐⭐⭐ 极快</td><td>原生 Web 标准 API</td></tr><tr><td>Deno</td><td>⭐⭐⭐⭐⭐ 极快</td><td>原生 Web 标准 API</td></tr><tr><td>Bun</td><td>⭐⭐⭐⭐ 很快</td><td>高性能 JS 运行时</td></tr><tr><td>Node.js</td><td>⭐⭐⭐ 中等</td><td>需要适配器转换</td></tr></tbody></table>
<blockquote>
<p><strong>💡 选型建议</strong>：如果你的应用运行在边缘计算环境（Cloudflare Workers、Vercel Edge Functions 等），Hono 是绝佳选择。如果是传统 Node.js 服务器，Fastify 可能是更好的选择。</p>
</blockquote>
<p>但对于大多数 Web 应用场景，RegExpRouter 的性能与功能平衡已经足够优秀。</p>
<h2 data-id="heading-16">总结</h2>
<p>Hono 的 RegExpRouter 通过"预编译 + 引擎下沉"的策略，在特定环境中将路由匹配性能提升到极致：</p>
<h3 data-id="heading-17">核心优势</h3>
<ol>
<li><strong>预编译</strong>：启动时一次性将路由转为正则，摊销成本</li>
<li><strong>引擎下沉</strong>：利用 C++ 实现的正则引擎，避免 JS 层开销</li>
<li><strong>参数捕获</strong>：巧妙利用正则捕获组，无需手动解析</li>
<li><strong>智能组合</strong>：SmartRouter 自动选择最优路由器，兼顾性能与功能</li>
</ol>
<h3 data-id="heading-18">设计哲学</h3>
<p>这种设计哲学值得我们思考：<strong>性能优化的终极目标，往往是让"热路径"代码尽可能多地运行在更底层的优化环境中</strong>。</p>
<p>对于 Web 框架来说，路由匹配就是最热的路径之一。Hono 在边缘计算环境中找到了这个问题的最优解，同时通过多路由器架构保证了广泛的适用性。</p>
<h3 data-id="heading-19">最佳实践</h3>
<ul>
<li>✅ <strong>边缘计算/Serverless</strong>：Hono 是首选（Cloudflare Workers、Deno Deploy）</li>
<li>✅ <strong>高并发场景</strong>：充分发挥 RegExpRouter 性能优势</li>
<li>⚠️ <strong>Node.js 环境</strong>：考虑性能权衡，或选择 Fastify 等专门优化的框架</li>
<li>⚠️ <strong>复杂路由规则</strong>：了解 RegExpRouter 的限制，必要时使用 TrieRouter</li>
</ul>
<hr/>
<p><strong>延伸阅读：</strong></p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fhono.dev%2F" target="_blank" title="https://hono.dev/" ref="nofollow noopener noreferrer">Hono 官方文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fhono.dev%2Fdocs%2Fconcepts%2Frouters" target="_blank" title="https://hono.dev/docs/concepts/routers" ref="nofollow noopener noreferrer">Hono Routers 详解</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fhono.dev%2Fdocs%2Fconcepts%2Fbenchmarks" target="_blank" title="https://hono.dev/docs/concepts/benchmarks" ref="nofollow noopener noreferrer">Hono Benchmarks</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fv8.dev%2Fblog" target="_blank" title="https://v8.dev/blog" ref="nofollow noopener noreferrer">V8 正则引擎优化技术</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fweb-frameworks-benchmark.netlify.app%2F" target="_blank" title="https://web-frameworks-benchmark.netlify.app/" ref="nofollow noopener noreferrer">Web 框架性能对比工具</a></li>
</ul>
<p><strong>技术资源：</strong></p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fhonojs%2Fhono" target="_blank" title="https://github.com/honojs/hono" ref="nofollow noopener noreferrer">Hono GitHub 仓库</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fusualoma" target="_blank" title="https://github.com/usualoma" ref="nofollow noopener noreferrer">RegExpRouter 创建者：Taku Amano</a></li>
</ul>
<hr/>
<p><strong>📝 文章说明</strong></p>
<p>本文基于对 Hono 框架的学习和研究编写，代码示例为简化版实现，用于教学目的。实际的 Hono RegExpRouter 实现更加复杂和优化。</p>
<p>性能数据和对比来自 Hono 官方文档和社区测试，具体数值会因测试环境、负载类型、运行时版本等因素而异。实际使用时请根据自己的场景进行测试。</p>
<p>如果您发现文中有任何不准确之处，欢迎指正。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI专栏 | Prompt Engineering实战 [新闻助手实战，这样写Prompt，你的程序能用？]]]></title>    <link>https://juejin.cn/post/7598699872552173604</link>    <guid>https://juejin.cn/post/7598699872552173604</guid>    <pubDate>2026-01-25T05:50:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598699872552173604" data-draft-id="7598587406707064873" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI专栏 | Prompt Engineering实战 [新闻助手实战，这样写Prompt，你的程序能用？]"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2026-01-25T05:50:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="猿猿长成记"/> <meta itemprop="url" content="https://juejin.cn/user/4232463136874240"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI专栏 | Prompt Engineering实战 [新闻助手实战，这样写Prompt，你的程序能用？]
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4232463136874240/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    猿猿长成记
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-25T05:50:29.000Z" title="Sun Jan 25 2026 05:50:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-25
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">AI专栏 | Prompt Engineering实战 [新闻助手实战，这样写Prompt，你的程序能用？]</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2c3ae3388392474e9fb10ed1adfabcae~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54y_54y_6ZW_5oiQ6K6w:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769925029&amp;x-signature=BT%2BfHJ%2FxhAcOXi6VSH6w6JQ5kpQ%3D" alt="3 Prompt Engineering实战-黑板报.png" loading="lazy"/></p>
<blockquote>
<p>难度系数：★★★☆☆</p>
</blockquote>
<blockquote>
<p>本章知识：</p>
<ul>
<li>复习清单</li>
<li>新闻助手Prompt</li>
<li>Prompt分析 <span>[重点 ★★★★★]</span></li>
<li>改造验证 <span>[重点 ★★★★★]</span></li>
<li>继续改进思路</li>
<li>下一章预告: PromptEngineering进阶技巧</li>
</ul>
</blockquote>
<h3 data-id="heading-1">复习清单</h3>
<p>上一章我们提到了关于PromptEngineering的8条高能建议，本章基于新闻助手的场景，带你来观察一下Prompt这样写你的程序能用么。</p>
<p>先来回顾一下PromptEngineering的8条高能建议有哪些？</p>
<ol start="0">
<li>把AI当人来看</li>
<li>提供单一的任务</li>
<li>任务描述清晰且准确</li>
<li>给出适量参考样例</li>
<li>正向描述任务信息</li>
<li>不要提供过长的prompt</li>
<li>根据任务类型切换任务角色</li>
<li>A/B测试迭代找到最佳的prompt</li>
</ol>
<p>接下来我们会用这份清单，逐条对照分析一个真实 Prompt 在程序中的表现。</p>
<blockquote>
<p><strong>注意</strong> 本章内容实际已涉及Agent开发，此时我们主要关注Prompt的编写问题。</p>
</blockquote>
<h3 data-id="heading-2">新闻助手Prompt示例工程</h3>
<h4 data-id="heading-3">需求描述</h4>
<p>现在某公司要开发一个新闻助手，这个新闻助手会根据用户输入的关键词，从互联网上抓取相关的新闻，并返回给用户。</p>
<h4 data-id="heading-4">Code示例</h4>
<p>下面是一个简单的新闻助手，基于LLM的搜索能力，实现新闻查询及格式化输出，来我们分析一下代码中所犯的问题有哪些？</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 非完整代码，主要包括关键代码，完整见gitcode仓库</span>
<span class="hljs-comment"># https://gitcode.com/miasdz/ai-column-code.git</span>

sys_prompt = <span class="hljs-string">"""
你是一个新闻助手，负责进行新闻信息查询并格式化输出。

# 输出要求
## 输出格式
以JSON格式仅输出查询结果，确保输出结果可以被python中json.loads加载不报错。
## JSON内容要求
0. json总体结构为list嵌套dict结构
1. 每个dict结构表示一个企业的新闻信息查询结果
2. 每个dict结构存在两个key，name和news
3. name key对应value为企业名称，value值类型为string
4. news key对应value值为新闻列表，value值类型为list，list的每一项值类型为dict
5. 企业新闻信息查询结果的list的每一个dict类型的值包括三个要素：date（日期）、new_type（新闻类型）、news（新闻信息）
6. new_type类型包括：
- 重大事件/战略动态类
- 产品/技术创新类
- 企业成就/荣誉认可类
- 人事与组织变动类
- 合规、风险与监管类
- 社会责任/ESG/公益类
- 日常运营与业务动态类
- 招标、采购公告类
## 示例
[
    {
      "name":"xx企业",
      "news":[
        {
            "date":"2026年1月12日",
            "new_type":"合规、风险与监管类",
            "news": "xxx公司因xxx业务违规开展被处罚1000万元。"
        },
        {
            "date":"2026年1月5日",
            "new_type":"重大事件/战略动态类",
            "news": "xxx公司与yyy公司达成战略合作。"
        },
      ]
    },
    {
      "name":"zz企业",
      "news":[
        {
            "date":"2026年1月18日",
            "new_type":"合规、风险与监管类",
            "news": "zz企业因xxx业务违规开展被行政处罚85万元。"
        },
        {
            "date":"2026年1月19日",
            "new_type":"人事与组织变动类",
            "news": "zz企业新任命总经理uu。"
        },
      ]
    }
]
"""</span>

user_prompt = <span class="hljs-string">"""
查询山西银行和晋商银行近期的5条新闻
"""</span>

<span class="hljs-comment"># 对话消息</span>
messages = [
    {
        <span class="hljs-string">"role"</span>: <span class="hljs-string">"system"</span>,
        <span class="hljs-string">"content"</span>: sys_prompt
    },
    {
        <span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>,
        <span class="hljs-string">"content"</span>: user_prompt
    }
]

<span class="hljs-comment"># 调用llm接口</span>
chat_completion = client.chat.completions.create(
    model=model,
    messages=messages,
    extra_body={
        <span class="hljs-string">"enable_search"</span>: <span class="hljs-literal">True</span>,
        <span class="hljs-string">"search_options"</span>: {
            <span class="hljs-string">"search_strategy"</span>: <span class="hljs-string">"max"</span>,  <span class="hljs-comment"># 配置搜索策略为高性能模式</span>
            <span class="hljs-string">"forced_search"</span>: <span class="hljs-literal">True</span>
        }
    }
)
</code></pre>
<p><strong>...... 此处思考3分钟 ......</strong></p>
<h3 data-id="heading-5">Prompt分析</h3>
<h4 data-id="heading-6">运行结果</h4>
<p>先看一下运行结果，看看程序是否能正常返回结果。</p>
<blockquote>
<p><strong>注意</strong> 下述运行结果代码实测结果截取，再次执行无法保证完全一致。</p>
</blockquote>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"山西银行"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"news"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
            <span class="hljs-punctuation">{</span>
                <span class="hljs-attr">"date"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2026年1月7日"</span><span class="hljs-punctuation">,</span>
                <span class="hljs-attr">"new_type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"日常运营与业务动态类"</span><span class="hljs-punctuation">,</span>
                <span class="hljs-attr">"news"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"山西银行发布‘晋晟理财’理财产品净值公告。"</span>
            <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
            <span class="hljs-punctuation">{</span>
                <span class="hljs-attr">"date"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2025年12月31日"</span><span class="hljs-punctuation">,</span>
                <span class="hljs-attr">"new_type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"日常运营与业务动态类"</span><span class="hljs-punctuation">,</span>
                <span class="hljs-attr">"news"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"山西银行发布‘晋晟理财’理财产品净值公告。"</span>
            <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
            <span class="hljs-punctuation">{</span>
                <span class="hljs-attr">"date"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2025年12月24日"</span><span class="hljs-punctuation">,</span>
                <span class="hljs-attr">"new_type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"日常运营与业务动态类"</span><span class="hljs-punctuation">,</span>
                <span class="hljs-attr">"news"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"山西银行发布‘晋晟理财’理财产品净值公告。"</span>
            <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
            <span class="hljs-punctuation">{</span>
                <span class="hljs-attr">"date"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2025年12月18日"</span><span class="hljs-punctuation">,</span>
                <span class="hljs-attr">"new_type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"重大事件/战略动态类"</span><span class="hljs-punctuation">,</span>
                <span class="hljs-attr">"news"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"任凯与临汾市长王延峰座谈。"</span>
            <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
            <span class="hljs-punctuation">{</span>
                <span class="hljs-attr">"date"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2025年12月12日"</span><span class="hljs-punctuation">,</span>
                <span class="hljs-attr">"new_type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"重大事件/战略动态类"</span><span class="hljs-punctuation">,</span>
                <span class="hljs-attr">"news"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"邢毅赴省内金融同业拜访交流。"</span>
            <span class="hljs-punctuation">}</span>
        <span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"晋商银行"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"news"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
            <span class="hljs-punctuation">{</span>
                <span class="hljs-attr">"date"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2025年12月15日"</span><span class="hljs-punctuation">,</span>
                <span class="hljs-attr">"new_type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"合规、风险与监管类"</span><span class="hljs-punctuation">,</span>
                <span class="hljs-attr">"news"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"晋商消费金融成被执行人第一大股东为晋商银行。"</span>
            <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
            <span class="hljs-punctuation">{</span>
                <span class="hljs-attr">"date"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2025年12月10日"</span><span class="hljs-punctuation">,</span>
                <span class="hljs-attr">"new_type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"合规、风险与监管类"</span><span class="hljs-punctuation">,</span>
                <span class="hljs-attr">"news"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"山西最新批复！多家金融机构高管任职获批。"</span>
            <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
            <span class="hljs-punctuation">{</span>
                <span class="hljs-attr">"date"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2025年11月30日"</span><span class="hljs-punctuation">,</span>
                <span class="hljs-attr">"new_type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"人事与组织变动类"</span><span class="hljs-punctuation">,</span>
                <span class="hljs-attr">"news"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"山西银行党委副书记、行长(代)邢毅带队赴太重集团开展专项调研。"</span>
            <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
            <span class="hljs-punctuation">{</span>
                <span class="hljs-attr">"date"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2025年11月30日"</span><span class="hljs-punctuation">,</span>
                <span class="hljs-attr">"new_type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"人事与组织变动类"</span><span class="hljs-punctuation">,</span>
                <span class="hljs-attr">"news"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"山西银行党委副书记、副董事长、行长李颖耀拟进一步使用。"</span>
            <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
            <span class="hljs-punctuation">{</span>
                <span class="hljs-attr">"date"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2025年11月28日"</span><span class="hljs-punctuation">,</span>
                <span class="hljs-attr">"new_type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"重大事件/战略动态类"</span><span class="hljs-punctuation">,</span>
                <span class="hljs-attr">"news"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"山西银行新增高管人事变动引关注。"</span>
            <span class="hljs-punctuation">}</span>
        <span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">]</span>
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3f96070bbbf5411798f90187b69b761d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54y_54y_6ZW_5oiQ6K6w:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769925029&amp;x-signature=iBBkdr9fOdkIDYcAUlN4bvD3XDE%3D" alt="json校验" loading="lazy"/></p>
<p>观察上述结果，prompt要求的json格式是正确的。但是从内容上分析会发现明显的错误：</p>
<ol>
<li>同一个人的名字出现在了两家企业内，稍微了解一下是错误新闻</li>
<li>我要求的是近期新闻，截至我写作时间2026年1月19日，返回的新闻几乎全都是25年末的，近期目标效果差</li>
<li>新闻与公司关联错误，A公司新闻归类到B公司</li>
<li>从news字段中看不出来企业与这条新闻的关系</li>
<li>新闻类型错误，如“重大事件/战略动态类”</li>
</ol>
<h4 data-id="heading-7">问题分析</h4>
<p>基于前面的建议，我们逐条分析一下这段乍一看还不错的prompt，存在<strong>什么问题</strong>？</p>
<h5 data-id="heading-8">1. 提供单一的任务</h5>
<p>问题指数: ★★★★★</p>
<p><strong>基于上一章节对单一任务的理解，我们再看Prompt：</strong></p>
<p>SystemPrompt逻辑点：</p>
<ul>
<li>新闻信息查询</li>
<li>新闻归类</li>
<li>数据格式化</li>
</ul>
<p>根据单一任务理解，system prompt已经违反单一任务的限制，不做认知的切换，新闻信息查询和归类属于两类任务 <strong>信息提取</strong> 和 <strong>分类决策任务</strong>，不满足单一任务定义。</p>
<p>UserPrompt逻辑点:</p>
<ul>
<li>查询山西银行近期新闻</li>
<li>查询晋商银行近期新闻</li>
<li>近期是什么时候[隐性任务]</li>
<li>新闻筛选</li>
</ul>
<p>对于UserPrompt，要求同时查询两个企业的信息，涉及了两个信息聚合主题，也不符合单一任务定义。</p>
<p>根据执行结果，综合SystemPrompt和UserPrompt，经过A/B测试，主要问题体现在UserPrompt中存在两个信息实体，具体见新Prompt运行效果。</p>
<h5 data-id="heading-9">2. 任务描述清晰且准确</h5>
<p>从程序运行结果看，主要的prompt用于描述数据格式，返回符合预期要求，从描述层面足够清晰，满足该项。</p>
<h5 data-id="heading-10">3. 给出适量参考样例</h5>
<p>JSON格式正确，demo中给了明确的示例，满足该项。</p>
<h5 data-id="heading-11">4. 正向描述任务信息</h5>
<p>问题指数: ★☆☆☆☆☆</p>
<p>确保输出结果可以被python中json.loads加载不报错。非正面描述，不过问题不大，大模型实测是没问题的，也可以改为更合理的描述如"符合标准 RFC 8259 规范的 JSON 字符串"。</p>
<h5 data-id="heading-12">5. 不要提供过长的prompt</h5>
<p>使用openai的tokenizer计算约在gpt4模型下约600,从模型容量角度看不多，该条满足。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a077a532bbd344429f894587753cbb63~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54y_54y_6ZW_5oiQ6K6w:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769925029&amp;x-signature=d0j6ZOD2SNWsAEAvw8RpiHf7QZU%3D" alt="token统计" loading="lazy"/></p>
<blockquote>
<p>可参考OpenAI官方tokenizer计算结果（不同模型结算结果不同，仅供参考）</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fplatform.openai.com%2Ftokenizer" target="_blank" title="https://platform.openai.com/tokenizer" ref="nofollow noopener noreferrer">platform.openai.com/tokenizer</a></p>
</blockquote>
<h5 data-id="heading-13">6. 根据任务类型切换任务角色</h5>
<p>Systmem Prompt首行定义了任务角色，该条满足。</p>
<h5 data-id="heading-14">7. A/B测试迭代找到最佳的prompt</h5>
<p>A/B测试迭代属于持续优化的过程，接下来我们继续修改prompt测试的过程满足此条。</p>
<h3 data-id="heading-15">改造验证</h3>
<h4 data-id="heading-16">新版Prompt</h4>
<pre><code class="hljs language-python" lang="python">sys_prompt = <span class="hljs-string">"""
你是一个新闻助手，负责进行新闻信息查询并格式化输出。

# 输出要求
## 输出格式
以JSON格式仅输出查询结果，确保输出结果符合标准 RFC 8259 规范的 JSON 字符串。
## JSON内容要求
1. JSON结构存在两个key，name和news
2. name key对应value为企业名称，value值类型为string
3. news key对应value值为新闻列表，value值类型为list，list的每一项值类型为dict
4. 企业新闻信息查询结果的list的每一个dict类型的值包括三个要素：date（日期）、new_type（新闻类型）、new_info（新闻信息）
5. new_type类型包括：
- 重大事件/战略动态类
- 产品/技术创新类
- 企业成就/荣誉认可类
- 人事与组织变动类
- 合规、风险与监管类
- 社会责任/ESG/公益类
- 日常运营与业务动态类
- 招标、采购公告类
## 示例
{
  "name":"xx企业",
  "news":[
    {
        "date":"2026年1月12日",
        "new_type":"合规、风险与监管类",
        "news": "xxx公司因xxx业务违规开展被处罚1000万元。"
    },
    {
        "date":"2026年1月5日",
        "new_type":"重大事件/战略动态类",
        "news": "xxx公司与yyy公司达成战略合作。"
    },
  ]
}
# 约束
当未检索到可验证的有效新闻时，news 字段应返回一个空数组 []
"""</span>

user_prompt = <span class="hljs-string">"""
查询晋商银行近期的5条新闻
"""</span>
</code></pre>
<h4 data-id="heading-17">实测结果</h4>
<p>再看新prompt测试结果，在单一信息主体下，结果可用。</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"晋商银行"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"news"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"date"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2026年1月16日"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"new_type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"日常运营与业务动态类"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"news"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"晋商银行股份有限公司2026年第006期同业存单发行情况公告。"</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"date"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2026年1月14日"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"new_type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"日常运营与业务动态类"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"news"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"晋商银行股份有限公司2026年第004期同业存单即日起开始在银行间债券市场交易流通。"</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"date"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2026年1月6日"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"new_type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"合规、风险与监管类"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"news"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"晋商银行发布《关于加强个人银行账户安全管理的公告》。"</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"date"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2025年11月28日"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"new_type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"日常运营与业务动态类"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"news"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"晋商银行召开2025年四季度经营工作会。"</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"date"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2025年10月29日"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"new_type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"人事与组织变动类"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"news"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"晋商银行启动2026年度校园招聘，计划招聘11人。"</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-18">继续改进思路</h3>
<h4 data-id="heading-19">初始需求如何满足？</h4>
<p>再翻回来看user_prompt，要求查询两个信息主体的新闻，上述优化后的prompt仅查询一个主体好用，那多个怎么办？</p>
<p>这就涉及工作流的开发：</p>
<ol>
<li>用户意图识别：通过用户prompt摘取在新闻查询场景下的查询主体有几个</li>
<li>根据获取出的查询主体，多次调用新闻查询服务</li>
<li>聚合结果</li>
</ol>
<h4 data-id="heading-20">查询质量不满足、新闻总结不满足怎么办</h4>
<p>现在使用的是大模型提供的查询服务，如果需要相对稳定的查询数据源，那就需要依赖外部服务了，比如秘塔搜索API、百度搜索API甚至是外部稳定数据源的数据采购等方式来提升数据质量。</p>
<p>此时做法就变成了：</p>
<ol>
<li>用户意图识别获取查询主体</li>
<li>FuncationCalling获取外部数据</li>
<li>通过LLM进行新闻总结及归类</li>
<li>基于新闻总结及归类结果进行信息提取为JSON结构</li>
<li>多轮查询的信息聚合</li>
</ol>
<p>这些流程的窜连完成一个完整的新闻领域查询服务，详情查看gitcode源码。</p>
<blockquote>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgitcode.com%2Fmiasdz%2Fai-column-code.git" target="_blank" title="https://gitcode.com/miasdz/ai-column-code.git" ref="nofollow noopener noreferrer">gitcode.com/miasdz/ai-c…</a></p>
</blockquote>
<p>针对LLM单一任务，靠人识别可能因经验不足或者思维定式无法准确分析，后续将开发Prompt单一分析器Agent，用于优化Agent的Prompt准备。</p>
<h3 data-id="heading-21">下一章预告</h3>
<p>下一章节将通过介绍PromptEngineering中思维链、思维树、自洽性等进阶技巧。</p>
<hr/>
<p align="center">关注本专栏，让我们一起掌握方法、实践落地、共同发展。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【React-3/Lesson76(2025-12-18)】React Hooks 与函数式组件开发详解🧠]]></title>    <link>https://juejin.cn/post/7599450177057718282</link>    <guid>https://juejin.cn/post/7599450177057718282</guid>    <pubDate>2026-01-26T10:11:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599450177057718282" data-draft-id="7599528186586382346" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【React-3/Lesson76(2025-12-18)】React Hooks 与函数式组件开发详解🧠"/> <meta itemprop="keywords" content="React.js,前端,面试"/> <meta itemprop="datePublished" content="2026-01-26T10:11:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Jing_Rainbow"/> <meta itemprop="url" content="https://juejin.cn/user/1285809519198256"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【React-3/Lesson76(2025-12-18)】React Hooks 与函数式组件开发详解🧠
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1285809519198256/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Jing_Rainbow
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T10:11:23.000Z" title="Mon Jan 26 2026 10:11:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>🧠在现代前端开发中，React 已经全面拥抱函数式编程范式。通过 <strong>Hooks</strong>，开发者可以在不编写 class 的情况下使用状态（state）和生命周期等特性。本文将深入解析你所接触的代码片段，并系统性地补充相关知识，涵盖 <code>useState</code>、<code>useEffect</code>、纯函数、副作用、组件挂载/更新/卸载机制、响应式状态管理等核心概念。</p>
<hr/>
<h2 data-id="heading-0">🔁 useState：让函数组件拥有状态</h2>
<p>在传统 React 中，只有类组件才能拥有状态（state）。而 <code>useState</code> Hook 的出现，彻底改变了这一限制。</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">const</span> [num, setNum] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);
</code></pre>
<p>这行代码做了三件事：</p>
<ol>
<li>声明一个名为 <code>num</code> 的状态变量；</li>
<li>提供一个名为 <code>setNum</code> 的函数用于更新该状态；</li>
<li>初始值为 <code>0</code>。</li>
</ol>
<h3 data-id="heading-1">✨ 初始化支持函数形式（惰性初始化）</h3>
<p>当初始状态需要通过复杂计算获得时，可以传入一个<strong>初始化函数</strong>：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">const</span> [num, setNum] = <span class="hljs-title function_">useState</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> num1 = <span class="hljs-number">1</span> + <span class="hljs-number">2</span>;
  <span class="hljs-keyword">const</span> num2 = <span class="hljs-number">2</span> + <span class="hljs-number">3</span>;
  <span class="hljs-keyword">return</span> num1 + num2; <span class="hljs-comment">// 返回 6</span>
});
</code></pre>
<blockquote>
<p>⚠️ 注意：这个函数必须是<strong>同步的纯函数</strong>，不能包含异步操作（如 <code>fetch</code>），因为 React 需要确保状态的确定性和可预测性。</p>
</blockquote>
<h3 data-id="heading-2">🔄 状态更新函数支持回调形式</h3>
<p>更新状态时，可以传入一个函数，其参数是上一次的状态值：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-title function_">setNum</span>(<span class="hljs-function">(<span class="hljs-params">prevNum</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(prevNum); <span class="hljs-comment">// 打印旧值</span>
  <span class="hljs-keyword">return</span> prevNum + <span class="hljs-number">1</span>;   <span class="hljs-comment">// 返回新值</span>
});
</code></pre>
<p>这种方式在<strong>批量更新</strong>或<strong>异步环境中</strong>特别安全，避免因闭包捕获旧状态而导致错误。</p>
<hr/>
<h2 data-id="heading-3">⚙️ useEffect：处理副作用的瑞士军刀</h2>
<p><code>useEffect</code> 是 React 中处理<strong>副作用（side effects）<strong>的核心 Hook。所谓“副作用”，是指那些</strong>不在纯函数范畴内</strong>的操作，例如：</p>
<ul>
<li>数据获取（如 API 请求）</li>
<li>手动 DOM 操作</li>
<li>订阅事件（如 WebSocket）</li>
<li>启动定时器（<code>setInterval</code> / <code>setTimeout</code>）</li>
</ul>
<h3 data-id="heading-4">📌 基本用法</h3>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'effect'</span>);
}, [num]);
</code></pre>
<ul>
<li>第一个参数：副作用函数（在渲染后执行）</li>
<li>第二个参数：<strong>依赖数组（dependency array）</strong></li>
</ul>
<h3 data-id="heading-5">🔍 依赖项的三种情况</h3>

























<table><thead><tr><th>依赖项</th><th>行为</th><th>类比 Vue 生命周期</th></tr></thead><tbody><tr><td><code>[]</code>（空数组）</td><td>仅在组件<strong>挂载后</strong>执行一次</td><td><code>onMounted</code></td></tr><tr><td><code>[a, b]</code></td><td>当 <code>a</code> 或 <code>b</code> <strong>变化时</strong>重新执行</td><td><code>watch([a, b])</code></td></tr><tr><td><strong>无依赖项</strong>（省略第二个参数）</td><td><strong>每次渲染后都执行</strong></td><td><code>onMounted</code> + <code>onUpdated</code></td></tr></tbody></table>
<blockquote>
<p>💡 在 React 18 的 <code>&lt;StrictMode&gt;</code> 下，开发环境会<strong>故意双次调用</strong> <code>useEffect</code>（不含依赖或依赖为空时），以帮助开发者发现潜在的副作用问题（如未正确清理资源）。</p>
</blockquote>
<h3 data-id="heading-6">🧹 清理副作用：返回清理函数</h3>
<p>许多副作用需要在组件更新前或卸载时<strong>清理</strong>，否则会导致内存泄漏或重复订阅。</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> timer = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(num);
  }, <span class="hljs-number">1000</span>);

  <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'remove'</span>);
    <span class="hljs-built_in">clearInterval</span>(timer); <span class="hljs-comment">// 清理定时器</span>
  };
}, [num]);
</code></pre>
<ul>
<li>返回的函数会在<strong>下一次 effect 执行前</strong>调用，或在<strong>组件卸载时</strong>调用。</li>
<li>这利用了<strong>闭包</strong>机制：清理函数能访问到创建它时的 <code>timer</code> 变量。</li>
</ul>
<blockquote>
<p>✅ 最佳实践：<strong>所有开启的资源（定时器、订阅、监听器）都必须有对应的清理逻辑。</strong></p>
</blockquote>
<hr/>
<h2 data-id="heading-7">🧼 纯函数 vs 副作用</h2>
<p>理解 <code>useEffect</code> 的设计哲学，必须先理解**纯函数（Pure Function）**的概念。</p>
<h3 data-id="heading-8">✅ 纯函数的特点</h3>
<ul>
<li>相同输入 → 相同输出</li>
<li><strong>无副作用</strong>：不修改外部状态、不发起网络请求、不操作 DOM</li>
<li>无随机性（如 <code>Math.random()</code>）</li>
</ul>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// ✅ 纯函数</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">add</span> = (<span class="hljs-params">x, y</span>) =&gt; x + y;
</code></pre>
<h3 data-id="heading-9">❌ 非纯函数（有副作用）</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ❌ 修改传入的数组（改变外部状态）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">nums</span>) {
  nums.<span class="hljs-title function_">push</span>(<span class="hljs-number">3</span>); <span class="hljs-comment">// 副作用！</span>
  <span class="hljs-keyword">return</span> nums.<span class="hljs-title function_">reduce</span>(<span class="hljs-function">(<span class="hljs-params">pre, cur</span>) =&gt;</span> pre + cur, <span class="hljs-number">0</span>);
}
</code></pre>
<p>React 组件本身应尽可能接近纯函数：<strong>props → JSX</strong>。但现实应用离不开副作用，因此 <code>useEffect</code> 被设计为<strong>隔离副作用的沙盒</strong>。</p>
<hr/>
<h2 data-id="heading-10">🧩 组件生命周期在函数式组件中的映射</h2>





















<table><thead><tr><th>Class 组件生命周期</th><th>函数式组件（Hooks）</th></tr></thead><tbody><tr><td><code>componentDidMount</code></td><td><code>useEffect(() =&gt; {}, [])</code></td></tr><tr><td><code>componentDidUpdate</code></td><td><code>useEffect(() =&gt; {}, [dep])</code></td></tr><tr><td><code>componentWillUnmount</code></td><td><code>useEffect(() =&gt; { return () =&gt; {} }, [])</code></td></tr></tbody></table>
<blockquote>
<p>🔄 注意：<code>useEffect</code> <strong>合并了挂载、更新、卸载三个阶段</strong>，通过依赖项和返回函数实现精细控制。</p>
</blockquote>
<hr/>
<h2 data-id="heading-11">🏗️ 项目结构与入口分析</h2>
<h3 data-id="heading-12">📄 <code>main.jsx</code>：应用入口</h3>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-title function_">createRoot</span>(<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'root'</span>)).<span class="hljs-title function_">render</span>(<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">App</span> /&gt;</span></span>);
</code></pre>
<ul>
<li>使用 React 18 的 <strong><code>createRoot</code></strong> API（并发模式）</li>
<li>渲染 <code>&lt;App /&gt;</code> 到 <code>#root</code> 容器</li>
<li>注释掉的 <code>&lt;StrictMode&gt;</code> 是开发辅助工具，用于暴露潜在问题（如重复 effect）</li>
</ul>
<h3 data-id="heading-13">🎨 样式文件 <code>index.css</code> 与 <code>App.css</code></h3>
<ul>
<li>使用 CSS 自定义属性（<code>:root</code>）实现主题切换（亮色/暗色）</li>
<li>响应式设计（<code>min-width: 320px</code>）</li>
<li>悬停动画、焦点样式等增强用户体验</li>
</ul>
<hr/>
<h2 data-id="heading-14">🔍 深入 <code>Demo.jsx</code>：副作用与清理</h2>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Demo</span>(<span class="hljs-params"/>) {
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'123123'</span>); <span class="hljs-comment">// 模拟 onMounted</span>
    <span class="hljs-keyword">const</span> timer = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'timer'</span>);
    }, <span class="hljs-number">1000</span>);

    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'remove'</span>);
      <span class="hljs-built_in">clearInterval</span>(timer);
    };
  }, []); <span class="hljs-comment">// 仅挂载时执行</span>

  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>偶数Demo<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
}
</code></pre>
<ul>
<li>即使 <code>Demo</code> 组件被多次渲染（因父组件 <code>App</code> 更新），由于依赖项为空，<strong>定时器只创建一次</strong></li>
<li>当 <code>App</code> 卸载 <code>Demo</code>（如条件渲染切换），清理函数会执行，防止内存泄漏</li>
</ul>
<hr/>
<h2 data-id="heading-15">📊 状态驱动 UI：响应式核心</h2>
<p>在 <code>App.jsx</code> 中：</p>
<pre><code class="hljs language-jsx" lang="jsx">{num % <span class="hljs-number">2</span> == <span class="hljs-number">0</span> ? <span class="hljs-string">'偶数'</span> : <span class="hljs-string">'奇数'</span>}
</code></pre>
<p>这体现了 React 的核心思想：<strong>UI 是状态的函数</strong>。<br/>
每当 <code>num</code> 变化，React 会重新执行组件函数，生成新的 JSX，然后高效地更新 DOM。</p>
<hr/>
<h2 data-id="heading-16">🚫 为什么不能在 <code>useState</code> 中直接异步初始化？</h2>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// ❌ 错误！useState 不支持异步初始化</span>
<span class="hljs-keyword">const</span> [data, setData] = <span class="hljs-title function_">useState</span>(<span class="hljs-keyword">async</span> () =&gt; {
  <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(...);
  <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">json</span>();
});
</code></pre>
<p>原因：</p>
<ul>
<li>React 需要<strong>同步确定</strong>初始状态，以便进行协调（reconciliation）</li>
<li>异步操作结果不确定，破坏纯函数原则</li>
</ul>
<p>✅ 正确做法：在 <code>useEffect</code> 中请求数据</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-title function_">queryData</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> <span class="hljs-title function_">setNum</span>(data));
}, []);
</code></pre>
<p>其中 <code>queryData</code> 是一个模拟异步请求的函数（见 <code>App.jsx</code>）：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">queryData</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =&gt;</span> {
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">resolve</span>(<span class="hljs-number">666</span>), <span class="hljs-number">2000</span>);
  });
  <span class="hljs-keyword">return</span> data;
}
</code></pre>
<hr/>
<h2 data-id="heading-17">🧪 开发者工具与调试技巧</h2>
<ul>
<li>利用 <code>console.log</code> 观察 effect 执行时机</li>
<li>注意 Strict Mode 下的双次调用（仅开发环境）</li>
<li>使用 React DevTools 检查组件状态和依赖</li>
</ul>
<hr/>
<h2 data-id="heading-18">✅ 总结：React Hooks 最佳实践</h2>
<ol>
<li><strong>状态管理</strong>：用 <code>useState</code> 声明响应式状态，更新时优先使用回调形式</li>
<li><strong>副作用隔离</strong>：所有非纯操作放入 <code>useEffect</code></li>
<li><strong>依赖声明</strong>：精确列出 effect 所依赖的所有变量（ESLint 插件可自动检测）</li>
<li><strong>资源清理</strong>：务必在 effect 中返回清理函数</li>
<li><strong>避免异步初始化</strong>：数据请求放在 <code>useEffect</code> 中</li>
<li><strong>理解闭包</strong>：effect 和清理函数通过闭包捕获变量，注意 stale closure 问题（可通过 ref 解决）</li>
</ol>
<hr/>
<p>通过以上详尽解析，你应该已经掌握了 React Hooks 的核心机制与工程实践。记住：<strong>函数式组件 + Hooks = 现代 React 开发的黄金标准</strong>。继续深入，你将能构建出高性能、可维护、可预测的前端应用！🚀</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React Native 中 Styled Components 配置指南]]></title>    <link>https://juejin.cn/post/7599483794656985129</link>    <guid>https://juejin.cn/post/7599483794656985129</guid>    <pubDate>2026-01-26T10:17:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599483794656985129" data-draft-id="7599299048303493163" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React Native 中 Styled Components 配置指南"/> <meta itemprop="keywords" content="前端,React Native"/> <meta itemprop="datePublished" content="2026-01-26T10:17:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="sera"/> <meta itemprop="url" content="https://juejin.cn/user/3870740938759965"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React Native 中 Styled Components 配置指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3870740938759965/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    sera
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T10:17:00.000Z" title="Mon Jan 26 2026 10:17:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">React Native 中 Styled Components 配置指南</h2>
<h3 data-id="heading-1">什么是 Styled Components？</h3>
<p>Styled Components 是一个 CSS-in-JS 库，让你可以在 JavaScript/TypeScript 代码中编写样式，并将样式与组件紧密结合。</p>
<h4 data-id="heading-2">核心特性</h4>
<p><strong>1. CSS-in-JS</strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 传统方式</span>
<span class="hljs-keyword">const</span> styles = <span class="hljs-title class_">StyleSheet</span>.<span class="hljs-title function_">create</span>({
  <span class="hljs-attr">container</span>: { <span class="hljs-attr">padding</span>: <span class="hljs-number">16</span> }
});

<span class="hljs-comment">// Styled Components 方式</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">Container</span> = styled.<span class="hljs-property">View</span><span class="hljs-string">`
  padding: 16px;
`</span>;
</code></pre>
<p><strong>2. 自动样式隔离</strong>
每个 styled component 都有唯一的 class 名，避免样式冲突：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> <span class="hljs-title class_">Button</span> = styled.<span class="hljs-property">TouchableOpacity</span><span class="hljs-string">`...`</span>;
<span class="hljs-comment">// 生成类似：.Button-asdf1234 { ... }</span>
</code></pre>
<p><strong>3. 主题支持</strong>
内置主题系统，轻松实现深色/浅色主题：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> <span class="hljs-title class_">Title</span> = styled.<span class="hljs-property">Text</span><span class="hljs-string">`
  color: <span class="hljs-subst">${props =&gt; props.theme.colors.text}</span>;
`</span>;
</code></pre>
<p><strong>4. 动态样式</strong>
基于 props 动态改变样式：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> <span class="hljs-title class_">Button</span> = styled.<span class="hljs-property">TouchableOpacity</span>&lt;{ <span class="hljs-attr">variant</span>: <span class="hljs-string">'primary'</span> | <span class="hljs-string">'secondary'</span> }&gt;<span class="hljs-string">`
  background-color: <span class="hljs-subst">${props =&gt;
    props.variant === <span class="hljs-string">'primary'</span> ? <span class="hljs-string">'#007AFF'</span> : <span class="hljs-string">'#5856D6'</span>}</span>;
`</span>;
</code></pre>
<h4 data-id="heading-3">优势对比</h4>








































<table><thead><tr><th>特性</th><th>StyleSheet</th><th>Styled Components</th></tr></thead><tbody><tr><td>样式隔离</td><td>❌ 需要手动管理</td><td>✅ 自动隔离</td></tr><tr><td>主题支持</td><td>❌ 需要额外配置</td><td>✅ 内置支持</td></tr><tr><td>动态样式</td><td>⚠️ 条件语句复杂</td><td>✅ 简洁直观</td></tr><tr><td>TypeScript</td><td>✅ 支持</td><td>✅ 完整类型推断</td></tr><tr><td>样式复用</td><td>⚠️ 需要手动合并</td><td>✅ 继承机制</td></tr><tr><td>组件封装</td><td>❌ 样式和组件分离</td><td>✅ 样式与组件一体</td></tr></tbody></table>
<h3 data-id="heading-4">如何配置 Styled Components</h3>
<h4 data-id="heading-5">第一步：安装依赖</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 安装 styled-components</span>
yarn add styled-components

<span class="hljs-comment"># 安装类型定义和 Babel 插件</span>
yarn add -D @types/styled-components babel-plugin-styled-components
</code></pre>
<p><strong>依赖说明</strong>：</p>
<ul>
<li><code>styled-components</code>: 核心库</li>
<li><code>@types/styled-components</code>: TypeScript 类型定义</li>
<li><code>babel-plugin-styled-components</code>: 优化开发体验和性能</li>
</ul>
<h4 data-id="heading-6">第二步：配置 Babel</h4>
<p>编辑 <code>babel.config.js</code>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-attr">presets</span>: [<span class="hljs-string">'module:@react-native/babel-preset'</span>],
  <span class="hljs-attr">plugins</span>: [
    <span class="hljs-comment">// ... 其他插件</span>
    [
      <span class="hljs-string">'babel-plugin-styled-components'</span>,
      {
        <span class="hljs-attr">displayName</span>: <span class="hljs-literal">true</span>,              <span class="hljs-comment">// 开发模式下显示组件名</span>
        <span class="hljs-attr">meaninglessFileNames</span>: [<span class="hljs-string">"index"</span>, <span class="hljs-string">"styles"</span>],
        <span class="hljs-attr">pure</span>: <span class="hljs-literal">true</span>,                     <span class="hljs-comment">// 移除不必要的辅助代码</span>
      },
    ]
  ],
};
</code></pre>
<p><strong>配置说明</strong>：</p>
<ul>
<li><code>displayName: true</code> - 开发时在 React DevTools 中显示组件名称</li>
<li><code>meaninglessFileNames</code> - 忽略这些文件名，不生成 class 名</li>
<li><code>pure: true</code> - 启用 tree-shaking 优化</li>
</ul>
<h4 data-id="heading-7">第三步：配置 TypeScript 类型</h4>
<p>创建 <code>app/types/styled-components-native.d.ts</code>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> <span class="hljs-string">'styled-components/native'</span>;

<span class="hljs-keyword">declare</span> <span class="hljs-variable language_">module</span> <span class="hljs-string">'styled-components/native'</span> {
  <span class="hljs-comment">// 主题模式类型</span>
  <span class="hljs-keyword">type</span> <span class="hljs-title class_">ThemeModeType</span> = <span class="hljs-string">'dark'</span> | <span class="hljs-string">'light'</span>;

  <span class="hljs-comment">// 间距类型</span>
  <span class="hljs-keyword">type</span> <span class="hljs-title class_">SpacingType</span> = {
    <span class="hljs-attr">xs</span>: <span class="hljs-built_in">number</span>;
    <span class="hljs-attr">sm</span>: <span class="hljs-built_in">number</span>;
    <span class="hljs-attr">md</span>: <span class="hljs-built_in">number</span>;
    <span class="hljs-attr">lg</span>: <span class="hljs-built_in">number</span>;
    <span class="hljs-attr">xl</span>: <span class="hljs-built_in">number</span>;
    <span class="hljs-attr">xxl</span>: <span class="hljs-built_in">number</span>;
    <span class="hljs-attr">screenPadding</span>: <span class="hljs-built_in">number</span>;
    <span class="hljs-attr">cardPadding</span>: <span class="hljs-built_in">number</span>;
    <span class="hljs-attr">inputPadding</span>: <span class="hljs-built_in">number</span>;
    <span class="hljs-attr">negSm</span>: <span class="hljs-built_in">number</span>;
    <span class="hljs-attr">negMd</span>: <span class="hljs-built_in">number</span>;
    <span class="hljs-attr">negLg</span>: <span class="hljs-built_in">number</span>;
  };

  <span class="hljs-comment">// 字体类型</span>
  <span class="hljs-keyword">type</span> <span class="hljs-title class_">FontSizeType</span> = {
    <span class="hljs-attr">xs</span>: <span class="hljs-built_in">number</span>;
    <span class="hljs-attr">sm</span>: <span class="hljs-built_in">number</span>;
    <span class="hljs-attr">base</span>: <span class="hljs-built_in">number</span>;
    <span class="hljs-attr">lg</span>: <span class="hljs-built_in">number</span>;
    <span class="hljs-attr">xl</span>: <span class="hljs-built_in">number</span>;
    <span class="hljs-attr">xxl</span>: <span class="hljs-built_in">number</span>;
    <span class="hljs-attr">xxxl</span>: <span class="hljs-built_in">number</span>;
  };

  <span class="hljs-keyword">type</span> <span class="hljs-title class_">FontWeightType</span> = {
    <span class="hljs-attr">regular</span>: <span class="hljs-built_in">number</span>;
    <span class="hljs-attr">medium</span>: <span class="hljs-built_in">number</span>;
    <span class="hljs-attr">semibold</span>: <span class="hljs-built_in">number</span>;
    <span class="hljs-attr">bold</span>: <span class="hljs-built_in">number</span>;
  };

  <span class="hljs-keyword">type</span> <span class="hljs-title class_">TypographyType</span> = {
    <span class="hljs-attr">fontSize</span>: <span class="hljs-title class_">FontSizeType</span>;
    <span class="hljs-attr">fontWeight</span>: <span class="hljs-title class_">FontWeightType</span>;
  };

  <span class="hljs-comment">// 颜色类型</span>
  <span class="hljs-keyword">type</span> <span class="hljs-title class_">ColorsType</span> = {
    <span class="hljs-attr">primary</span>: <span class="hljs-built_in">string</span>;
    <span class="hljs-attr">secondary</span>: <span class="hljs-built_in">string</span>;
    <span class="hljs-attr">background</span>: <span class="hljs-built_in">string</span>;
    <span class="hljs-attr">text</span>: <span class="hljs-built_in">string</span>;
    <span class="hljs-attr">textWhite</span>: <span class="hljs-built_in">string</span>;
    <span class="hljs-attr">success</span>: <span class="hljs-built_in">string</span>;
    <span class="hljs-attr">warning</span>: <span class="hljs-built_in">string</span>;
    <span class="hljs-attr">error</span>: <span class="hljs-built_in">string</span>;
    <span class="hljs-attr">info</span>: <span class="hljs-built_in">string</span>;
    <span class="hljs-attr">border</span>: <span class="hljs-built_in">string</span>;
    <span class="hljs-attr">overlay</span>: <span class="hljs-built_in">string</span>;
    <span class="hljs-attr">transparent</span>: <span class="hljs-built_in">string</span>;
  };

  <span class="hljs-comment">// 主题接口</span>
  <span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">DefaultTheme</span> {
    <span class="hljs-attr">mode</span>: <span class="hljs-title class_">ThemeModeType</span>;
    <span class="hljs-attr">colors</span>: <span class="hljs-title class_">ColorsType</span>;
    <span class="hljs-attr">spacing</span>: <span class="hljs-title class_">SpacingType</span>;
    <span class="hljs-attr">typography</span>: <span class="hljs-title class_">TypographyType</span>;
  }
}
</code></pre>
<h4 data-id="heading-8">第四步：配置路径别名</h4>
<p>更新 <code>babel.config.js</code> 和 <code>tsconfig.json</code> 中的别名配置：</p>
<p><strong>babel.config.js</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-attr">plugins</span>: [
    [
      <span class="hljs-string">'module-resolver'</span>,
      {
        <span class="hljs-attr">root</span>: [<span class="hljs-string">'./app'</span>],
        <span class="hljs-attr">alias</span>: {
          <span class="hljs-string">'@'</span>: <span class="hljs-string">'./app'</span>,
          <span class="hljs-string">'@providers'</span>: <span class="hljs-string">'./app/providers'</span>,
          <span class="hljs-comment">// ... 其他别名</span>
        },
      },
    ],
  ],
};
</code></pre>
<p><strong>tsconfig.json</strong>：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"compilerOptions"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"baseUrl"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"paths"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"@providers"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"app/providers"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"@providers/*"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"app/providers/*"</span><span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h4 data-id="heading-9">第五步：创建主题系统</h4>
<h5 data-id="heading-10">1. 主题结构</h5>
<p>创建以下文件结构：</p>
<pre><code class="hljs language-bash" lang="bash">app/styles/theme/
├── custom/
│   ├── spacing.ts      <span class="hljs-comment"># 间距系统</span>
│   └── typography.ts   <span class="hljs-comment"># 字体系统</span>
├── dark/
│   └── index.ts        <span class="hljs-comment"># 深色主题颜色</span>
├── light/
│   └── index.ts        <span class="hljs-comment"># 浅色主题颜色</span>
└── index.tsx           <span class="hljs-comment"># 主题生成器</span>
</code></pre>
<h5 data-id="heading-11">2. 定义间距系统</h5>
<p><code>app/styles/theme/custom/spacing.ts</code>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> spacing = {
  <span class="hljs-comment">// 基础间距（4px 基准）</span>
  <span class="hljs-attr">xs</span>: <span class="hljs-number">4</span>,
  <span class="hljs-attr">sm</span>: <span class="hljs-number">8</span>,
  <span class="hljs-attr">md</span>: <span class="hljs-number">16</span>,
  <span class="hljs-attr">lg</span>: <span class="hljs-number">24</span>,
  <span class="hljs-attr">xl</span>: <span class="hljs-number">32</span>,
  <span class="hljs-attr">xxl</span>: <span class="hljs-number">48</span>,

  <span class="hljs-comment">// 特殊间距</span>
  <span class="hljs-attr">screenPadding</span>: <span class="hljs-number">16</span>,
  <span class="hljs-attr">cardPadding</span>: <span class="hljs-number">16</span>,
  <span class="hljs-attr">inputPadding</span>: <span class="hljs-number">12</span>,

  <span class="hljs-comment">// 负间距</span>
  <span class="hljs-attr">negSm</span>: -<span class="hljs-number">8</span>,
  <span class="hljs-attr">negMd</span>: -<span class="hljs-number">16</span>,
  <span class="hljs-attr">negLg</span>: -<span class="hljs-number">24</span>,
} <span class="hljs-keyword">as</span> <span class="hljs-keyword">const</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">type</span> <span class="hljs-title class_">Spacing</span> = <span class="hljs-keyword">typeof</span> spacing;
</code></pre>
<h5 data-id="heading-12">3. 定义字体系统</h5>
<p><code>app/styles/theme/custom/typography.ts</code>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> typography = {
  <span class="hljs-attr">fontSize</span>: {
    <span class="hljs-attr">xs</span>: <span class="hljs-number">12</span>,
    <span class="hljs-attr">sm</span>: <span class="hljs-number">14</span>,
    <span class="hljs-attr">base</span>: <span class="hljs-number">16</span>,
    <span class="hljs-attr">lg</span>: <span class="hljs-number">18</span>,
    <span class="hljs-attr">xl</span>: <span class="hljs-number">20</span>,
    <span class="hljs-attr">xxl</span>: <span class="hljs-number">24</span>,
    <span class="hljs-attr">xxxl</span>: <span class="hljs-number">32</span>,
  },
  <span class="hljs-attr">fontWeight</span>: {
    <span class="hljs-attr">regular</span>: <span class="hljs-number">400</span>,
    <span class="hljs-attr">medium</span>: <span class="hljs-number">500</span>,
    <span class="hljs-attr">semibold</span>: <span class="hljs-number">600</span>,
    <span class="hljs-attr">bold</span>: <span class="hljs-number">700</span>,
  },
} <span class="hljs-keyword">as</span> <span class="hljs-keyword">const</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">type</span> <span class="hljs-title class_">Typography</span> = <span class="hljs-keyword">typeof</span> typography;
</code></pre>
<h5 data-id="heading-13">4. 定义颜色</h5>
<p><code>app/styles/theme/light/index.ts</code>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">ColorsType</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"styled-components/native"</span>;

<span class="hljs-keyword">const</span> <span class="hljs-attr">colors</span>: <span class="hljs-title class_">ColorsType</span> = {
  <span class="hljs-attr">primary</span>: <span class="hljs-string">'#007AFF'</span>,
  <span class="hljs-attr">secondary</span>: <span class="hljs-string">'#5856D6'</span>,
  <span class="hljs-attr">background</span>: <span class="hljs-string">'#FFFFFF'</span>,
  <span class="hljs-attr">text</span>: <span class="hljs-string">'#000000'</span>,
  <span class="hljs-attr">textWhite</span>: <span class="hljs-string">'#FFFFFF'</span>,
  <span class="hljs-attr">success</span>: <span class="hljs-string">'#34C759'</span>,
  <span class="hljs-attr">warning</span>: <span class="hljs-string">'#FF9500'</span>,
  <span class="hljs-attr">error</span>: <span class="hljs-string">'#FF3B30'</span>,
  <span class="hljs-attr">info</span>: <span class="hljs-string">'#5AC8FA'</span>,
  <span class="hljs-attr">border</span>: <span class="hljs-string">'#C6C6C8'</span>,
  <span class="hljs-attr">overlay</span>: <span class="hljs-string">'rgba(0, 0, 0, 0.5)'</span>,
  <span class="hljs-attr">transparent</span>: <span class="hljs-string">'transparent'</span>
};

<span class="hljs-keyword">export</span> { colors };
</code></pre>
<p><code>app/styles/theme/dark/index.ts</code>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">ColorsType</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"styled-components/native"</span>;

<span class="hljs-keyword">const</span> <span class="hljs-attr">colors</span>: <span class="hljs-title class_">ColorsType</span> = {
  <span class="hljs-attr">primary</span>: <span class="hljs-string">'#0A84FF'</span>,
  <span class="hljs-attr">secondary</span>: <span class="hljs-string">'#5E5CE6'</span>,
  <span class="hljs-attr">background</span>: <span class="hljs-string">'#121212'</span>,
  <span class="hljs-attr">text</span>: <span class="hljs-string">'#FFFFFF'</span>,
  <span class="hljs-attr">textWhite</span>: <span class="hljs-string">'#FFFFFF'</span>,
  <span class="hljs-attr">success</span>: <span class="hljs-string">'#32D74B'</span>,
  <span class="hljs-attr">warning</span>: <span class="hljs-string">'#FF9F0A'</span>,
  <span class="hljs-attr">error</span>: <span class="hljs-string">'#FF453A'</span>,
  <span class="hljs-attr">info</span>: <span class="hljs-string">'#64D2FF'</span>,
  <span class="hljs-attr">border</span>: <span class="hljs-string">'#3A3A3C'</span>,
  <span class="hljs-attr">overlay</span>: <span class="hljs-string">'rgba(0, 0, 0, 0.7)'</span>,
  <span class="hljs-attr">transparent</span>: <span class="hljs-string">'transparent'</span>
};

<span class="hljs-keyword">export</span> { colors };
</code></pre>
<h5 data-id="heading-14">5. 创建主题生成器</h5>
<p><code>app/styles/theme/index.tsx</code>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">DefaultTheme</span>, <span class="hljs-title class_">ThemeModeType</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'styled-components/native'</span>;
<span class="hljs-keyword">import</span> { colors <span class="hljs-keyword">as</span> darkColor } <span class="hljs-keyword">from</span> <span class="hljs-string">'./dark'</span>;
<span class="hljs-keyword">import</span> { colors <span class="hljs-keyword">as</span> lightColor } <span class="hljs-keyword">from</span> <span class="hljs-string">'./light'</span>;
<span class="hljs-keyword">import</span> { spacing } <span class="hljs-keyword">from</span> <span class="hljs-string">'./custom/spacing'</span>;
<span class="hljs-keyword">import</span> { typography } <span class="hljs-keyword">from</span> <span class="hljs-string">'./custom/typography'</span>;

<span class="hljs-keyword">const</span> <span class="hljs-attr">getTheme</span>: <span class="hljs-function">(<span class="hljs-params"><span class="hljs-keyword">type</span>: ThemeModeType</span>) =&gt;</span> <span class="hljs-title class_">DefaultTheme</span> = <span class="hljs-function"><span class="hljs-params">type</span> =&gt;</span> {
  <span class="hljs-keyword">const</span> theme = <span class="hljs-keyword">type</span> === <span class="hljs-string">'dark'</span> ? darkColor : lightColor;
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">mode</span>: <span class="hljs-keyword">type</span>,
    spacing,
    typography,
    <span class="hljs-attr">colors</span>: theme,
  };
};

<span class="hljs-keyword">export</span> { getTheme };
</code></pre>
<h4 data-id="heading-15">第六步：创建 ThemeProvider</h4>
<p><code>app/providers/ThemeProvider/index.tsx</code>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { getTheme } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/styles'</span>;
<span class="hljs-keyword">import</span> { createContext, <span class="hljs-title class_">PropsWithChildren</span>, useCallback, useState } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> { useColorScheme } <span class="hljs-keyword">from</span> <span class="hljs-string">'react-native'</span>;
<span class="hljs-keyword">import</span> {
  <span class="hljs-title class_">DefaultTheme</span>,
  <span class="hljs-title class_">ThemeModeType</span>,
  <span class="hljs-title class_">ThemeProvider</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">StyledThemeProvider</span>,
} <span class="hljs-keyword">from</span> <span class="hljs-string">'styled-components/native'</span>;

<span class="hljs-comment">// Context 类型定义</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">ContextProps</span> = {
  <span class="hljs-attr">mode</span>: <span class="hljs-title class_">ThemeModeType</span>;
  <span class="hljs-attr">theme</span>: <span class="hljs-title class_">DefaultTheme</span>;
  <span class="hljs-attr">toggleTheme</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span>;
};

<span class="hljs-comment">// 默认主题</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">defaultTheme</span>: <span class="hljs-title class_">ContextProps</span> = {
  <span class="hljs-attr">mode</span>: <span class="hljs-string">'light'</span>,
  <span class="hljs-attr">theme</span>: <span class="hljs-title function_">getTheme</span>(<span class="hljs-string">'light'</span>),
  <span class="hljs-attr">toggleTheme</span>: <span class="hljs-function">() =&gt;</span> {},
};

<span class="hljs-comment">// 创建 Context</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">ThemeContext</span> = createContext&lt;<span class="hljs-title class_">ContextProps</span>&gt;(defaultTheme);

<span class="hljs-comment">// ThemeProvider 组件</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">ThemeProvider</span> = (<span class="hljs-params">{ children }: PropsWithChildren</span>) =&gt; {
  <span class="hljs-keyword">const</span> isDarkMode = <span class="hljs-title function_">useColorScheme</span>() === <span class="hljs-string">'dark'</span>;
  <span class="hljs-keyword">const</span> [mode, setMode] = useState&lt;<span class="hljs-title class_">ThemeModeType</span>&gt;(isDarkMode ? <span class="hljs-string">'dark'</span> : <span class="hljs-string">'light'</span>);

  <span class="hljs-comment">// 切换主题函数</span>
  <span class="hljs-keyword">const</span> toggleTheme = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">setMode</span>(<span class="hljs-function"><span class="hljs-params">prev</span> =&gt;</span> (prev === <span class="hljs-string">'light'</span> ? <span class="hljs-string">'dark'</span> : <span class="hljs-string">'light'</span>));
  }, []);

  <span class="hljs-keyword">const</span> theme = <span class="hljs-title function_">getTheme</span>(mode);

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ThemeContext.Provider</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">mode</span>, <span class="hljs-attr">theme</span>, <span class="hljs-attr">toggleTheme</span> }}&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">StyledThemeProvider</span> <span class="hljs-attr">theme</span>=<span class="hljs-string">{theme}</span>&gt;</span>
        {children}
      <span class="hljs-tag">&lt;/<span class="hljs-name">StyledThemeProvider</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">ThemeContext.Provider</span>&gt;</span></span>
  );
};
</code></pre>
<p><code>app/providers/index.ts</code>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">export</span> { <span class="hljs-title class_">ThemeContext</span>, <span class="hljs-title class_">ThemeProvider</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./ThemeProvider'</span>;
</code></pre>
<h4 data-id="heading-16">第七步：导出样式系统</h4>
<p><code>app/styles/index.ts</code>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 主题 Design Tokens</span>
<span class="hljs-keyword">export</span> * <span class="hljs-keyword">from</span> <span class="hljs-string">'./theme'</span>;

<span class="hljs-comment">// 通用样式</span>
<span class="hljs-keyword">export</span> * <span class="hljs-keyword">from</span> <span class="hljs-string">'./common'</span>;
</code></pre>
<h4 data-id="heading-17">第八步：验证配置</h4>
<p>创建一个测试组件 <code>app/index.tsx</code>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> styled <span class="hljs-keyword">from</span> <span class="hljs-string">'styled-components/native'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ThemeProvider</span>, <span class="hljs-title class_">ThemeContext</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@providers'</span>;
<span class="hljs-keyword">import</span> { useContext } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">const</span> <span class="hljs-title class_">Container</span> = styled.<span class="hljs-property">View</span><span class="hljs-string">`
  padding: <span class="hljs-subst">${props =&gt; props.theme.spacing.md}</span>px;
  background-color: <span class="hljs-subst">${props =&gt; props.theme.colors.background}</span>;
`</span>;

<span class="hljs-keyword">const</span> <span class="hljs-title class_">Title</span> = styled.<span class="hljs-property">Text</span><span class="hljs-string">`
  font-size: <span class="hljs-subst">${props =&gt; props.theme.typography.fontSize.xl}</span>px;
  font-weight: <span class="hljs-subst">${props =&gt; props.theme.typography.fontWeight.bold}</span>;
  color: <span class="hljs-subst">${props =&gt; props.theme.colors.text}</span>;
`</span>;

<span class="hljs-keyword">const</span> <span class="hljs-title class_">Button</span> = styled.<span class="hljs-property">TouchableOpacity</span><span class="hljs-string">`
  background-color: <span class="hljs-subst">${props =&gt; props.theme.colors.primary}</span>;
  padding: <span class="hljs-subst">${props =&gt; props.theme.spacing.md}</span>px;
  border-radius: 8px;
  margin-top: <span class="hljs-subst">${props =&gt; props.theme.spacing.md}</span>px;
`</span>;

<span class="hljs-keyword">const</span> <span class="hljs-title class_">ButtonText</span> = styled.<span class="hljs-property">Text</span><span class="hljs-string">`
  color: <span class="hljs-subst">${props =&gt; props.theme.colors.textWhite}</span>;
  text-align: center;
`</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ThemeProvider</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">AppContent</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">ThemeProvider</span>&gt;</span></span>
  );
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">AppContent</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> { toggleTheme, mode } = <span class="hljs-title function_">useContext</span>(<span class="hljs-title class_">ThemeContext</span>);

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Container</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Title</span>&gt;</span>Styled Components 配置成功！<span class="hljs-tag">&lt;/<span class="hljs-name">Title</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Title</span>&gt;</span>当前主题: {mode}<span class="hljs-tag">&lt;/<span class="hljs-name">Title</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Button</span> <span class="hljs-attr">onPress</span>=<span class="hljs-string">{toggleTheme}</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">ButtonText</span>&gt;</span>切换主题<span class="hljs-tag">&lt;/<span class="hljs-name">ButtonText</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">Button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">Container</span>&gt;</span></span>
  );
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">App</span>;
</code></pre>
<h4 data-id="heading-18">第九步：重新构建</h4>
<p>配置完成后，必须重新构建应用：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 清理缓存并重启</span>
yarn start --reset-cache

<span class="hljs-comment"># 或者重新构建</span>
<span class="hljs-comment"># iOS</span>
yarn ios

<span class="hljs-comment"># Android</span>
yarn android
</code></pre>
<h3 data-id="heading-19">配置检查清单</h3>
<ul>
<li>✅ 安装了 <code>styled-components</code></li>
<li>✅ 安装了 <code>@types/styled-components</code></li>
<li>✅ 安装了 <code>babel-plugin-styled-components</code></li>
<li>✅ 配置了 <code>babel.config.js</code></li>
<li>✅ 创建了类型定义文件</li>
<li>✅ 配置了路径别名（<code>@providers</code>）</li>
<li>✅ 创建了主题文件结构</li>
<li>✅ 定义了间距系统</li>
<li>✅ 定义了字体系统</li>
<li>✅ 定义了颜色（深色/浅色）</li>
<li>✅ 创建了主题生成器</li>
<li>✅ 创建了 ThemeProvider</li>
<li>✅ 导出了样式系统</li>
<li>✅ 重新构建了应用</li>
</ul>
<h3 data-id="heading-20">常见配置问题</h3>
<h4 data-id="heading-21">1. TypeScript 类型错误</h4>
<p><strong>问题</strong>：<code>props.theme</code> 报类型错误</p>
<p><strong>解决</strong>：</p>
<ul>
<li>确保 <code>app/types/styled-components-native.d.ts</code> 文件存在</li>
<li>确保 <code>DefaultTheme</code> 接口定义了所有需要的字段</li>
<li>重启 TypeScript 服务器（VSCode 中 Cmd+Shift+P -&gt; "Restart TS Server"）</li>
</ul>
<h4 data-id="heading-22">2. 主题切换不生效</h4>
<p><strong>问题</strong>：点击切换主题，样式不变</p>
<p><strong>检查</strong>：</p>
<ol>
<li>组件是否在 <code>ThemeProvider</code> 内部？</li>
<li>是否使用了 <code>props.theme.colors.xxx</code> 而不是硬编码颜色值？</li>
<li>是否重新构建了应用？</li>
</ol>
<h4 data-id="heading-23">3. Babel 配置不生效</h4>
<p><strong>解决</strong>：</p>
<ol>
<li>清理缓存：<code>yarn start --reset-cache</code></li>
<li>检查 <code>babel.config.js</code> 语法</li>
<li>重启 Metro bundler</li>
</ol>
<h4 data-id="heading-24">4. 找不到模块 '@providers'</h4>
<p><strong>解决</strong>：</p>
<ol>
<li>检查 <code>babel.config.js</code> 和 <code>tsconfig.json</code> 别名配置</li>
<li>确保路径正确：<code>'./app/providers'</code></li>
<li>重启 TS 服务器</li>
</ol>
<h3 data-id="heading-25">参考资源</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fstyled-components.com%2Fdocs" target="_blank" title="https://styled-components.com/docs" ref="nofollow noopener noreferrer">Styled Components 官方文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Freactnative.dev%2Fdocs%2Fstyle" target="_blank" title="https://reactnative.dev/docs/style" ref="nofollow noopener noreferrer">React Native 文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fstyled-components.com%2Fdocs%2Fapi%23typescript" target="_blank" title="https://styled-components.com/docs/api#typescript" ref="nofollow noopener noreferrer">TypeScript 类型定义</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从spec-kit看spec-driven coding及在后台管理开发的实践]]></title>    <link>https://juejin.cn/post/7598574507347460131</link>    <guid>https://juejin.cn/post/7598574507347460131</guid>    <pubDate>2026-01-25T07:18:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598574507347460131" data-draft-id="7598588085597077544" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从spec-kit看spec-driven coding及在后台管理开发的实践"/> <meta itemprop="keywords" content="AI编程"/> <meta itemprop="datePublished" content="2026-01-25T07:18:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户8048714355625"/> <meta itemprop="url" content="https://juejin.cn/user/2870164321471837"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从spec-kit看spec-driven coding及在后台管理开发的实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2870164321471837/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户8048714355625
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-25T07:18:59.000Z" title="Sun Jan 25 2026 07:18:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-25
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">什么是spec-driven coding</h2>
<p>我们正常的开发流程中，撰写产品需求文档（PRD）来指导开发，创建设计文档来告知实现细节，然后进行代码开发。</p>
<p>规范驱动开发（SDD）模拟了这一流程，但在SDD中，产品需求文档（PRD）不再是实现的指南，而是生成实现的源头。技术方案不再是指导编码的文档，而是生成代码的精确定义。因为现在AI能够理解和实现复杂的规范，并创建详细的实现方案。但没有结构的过程会让AI生成会产生混乱。SDD通过精确、完整且足够明确的规范，足以生成可运行的系统。</p>
<p>开发团队的意图通过自然语言可以生成相应的规范，代码只是最后一公里的实现方式。</p>
<h2 data-id="heading-1">spec-kit原理简介</h2>
<p>spec-kit仓库地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fgithub%2Fspec-kit" target="_blank" title="https://github.com/github/spec-kit" ref="nofollow noopener noreferrer">github.com/github/spec…</a> (安装可以参考这个地址)</p>
<p>从上面的地址可以看到，spec-kit通过一系列自定义slash command来生成对应的规范文件，最终根据这些规范文件生成代码</p>








































<table><thead><tr><th>顺序</th><th>Slash command</th><th>作用</th></tr></thead><tbody><tr><td>1</td><td>/speckit.constitution(如有则不需要执行)</td><td>生成项目规范</td></tr><tr><td>2</td><td>/speckit.specify</td><td>生成需求文档</td></tr><tr><td>3</td><td>/speckit.clarify (可选)</td><td>让AI识别可能需要澄清的最重要的5个问题</td></tr><tr><td>4</td><td>/speckit.plan</td><td>生成设计文档</td></tr><tr><td>5</td><td>/speckit.task</td><td>生成实施任务文档</td></tr><tr><td>6</td><td>/speckit.implement</td><td>实施代码</td></tr></tbody></table>
<p>这些自定义的 slash command 其实是利用了vscode copilot的自定义prompt文件，参考：<a href="https://link.juejin.cn?target=https%3A%2F%2Fcode.visualstudio.com%2Fdocs%2Fcopilot%2Fcustomization%2Fprompt-files%25E3%2580%2582" target="_blank" title="https://code.visualstudio.com/docs/copilot/customization/prompt-files%E3%80%82" ref="nofollow noopener noreferrer">code.visualstudio.com/docs/copilo…</a></p>
<p>执行 slash command命令实际上是将 .github/prompts/${命令}.prompt.md 的提示词及相关设置发给AI。比如</p>
<p>执行/speckit.constitution命令，实际上是让AI遵循 .github/prompts/speckit.constitution.prompt.md。</p>
<p>因此，实际上执行的每一个命令就是依据作者的思想，通过作者预置的提示词与AI交流，按照流程生成对应的规范文件，最终利用这些规范文件来指导AI写出符合要求的代码。通过这样一步步的规范，提高AI写出“好的”代码的概率。如果你有自己的一套开发规范，那么你也可以有自己的spec-driven development流程，写一个自己的spec-kit！</p>
<h2 data-id="heading-2">用spec-kit实践一个后台管理需求</h2>
<h3 data-id="heading-3">要做的是什么？</h3>
<p>实际查看：<a href="https://link.juejin.cn?target=https%3A%2F%2Fc-ai-admin.xiaopeng.com%2F%23%2Fai%2Fentry" target="_blank" title="https://c-ai-admin.xiaopeng.com/#/ai/entry" ref="nofollow noopener noreferrer">c-ai-admin.xiaopeng.com/#/ai/entry</a></p>
<p>这是一个常见的后台管理新增tab需求，包含列表查看、搜索，编辑、新增、复制、删除的功能。弹窗中，选择场景热门问题由全部配置中而来。</p>
<h3 data-id="heading-4">怎么做？</h3>
<p>接下来，我们就按照spec-kit的流程来实现这个需求。</p>
<h4 data-id="heading-5">/speckit.constitution 生成项目规范</h4>
<p>项目是第一次用spec-kit来进行spec-driven coding，因此需要先生成项目规范文件 .specify/memory/constitution.md，这个文件在后续的流程中都会用到，是非常重要的。</p>
<p>生成这个文件的时候，会参考工作区内的README.md, <code>docs/quickstart.md</code>，prompt输入，之前的constitution.md，仓库上下文等等……。因此，我们在这之前补充一些我们期望的项目规范信息是非常必要的，当然，你可以让AI帮你生成，你需要review一下生成的内容，并且补充一些必要的规范。</p>
<p>在这里我生成好了一份README.md【字数限制不放上来了】</p>
<p>同时，我希望在项目规范里面增加一些vue2的 best practice。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a00a8bcb03b840a5a29b0898e91c460f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3ODA0ODcxNDM1NTYyNQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769930338&amp;x-signature=Lxk61xut4nzSO4QQ37W3wn7RBUM%3D" alt="" loading="lazy"/></p>
<p>生成的的规范我们需要review一下是否满足要求，如果还有别的要求，可以继续通过命令+要求去更新。</p>
<p>最终的.specify/memory/constitution.md【字数限制不放上来了】</p>
<blockquote>
<p>Tips: 如果下次开发已经存在了.specify/memory/constitution.md，那么就不需要再次重新生成。但我们在上次开发时发现的一些AI容易误解或者遗漏的地方，我们可以重新更新到.specify/memory/constitution.md，来更好地指导AI。</p>
</blockquote>
<h4 data-id="heading-6">/speckit.specify 生成需求文档</h4>
<p>这个阶段prompt一定要详细描述清楚你要做什么，这要求我们先要缕清产品的需求。要求产品把需求文档写清楚可以减少我们很多工作量，然后我们稍作整理就可以。</p>
<p>在这个阶段，重点在what和why，而不是how，不要涉及到技术相关的描述</p>
<p>我们先整理prompt，将prompt整理到一个feature.md文件中【字数限制不放上来了】。</p>
<p>开始生成需求文档</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f067c5673cf642bebec2e4261c26eef2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3ODA0ODcxNDM1NTYyNQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769930338&amp;x-signature=Q5HvwcvbSrAHbtKbuaiyp7jjJbs%3D" alt="" loading="lazy"/></p>
<p>生成的的规范我们需要review一下是否满足要求，如果还有别的要求，可以继续通过命令+要求去更新。</p>
<p>最终的需求文档：specs\002-scenario-config\spec.md【字数限制不放上来了】。</p>
<h4 data-id="heading-7">/speckit.clarify (可选) 澄清不清楚的问题</h4>
<p>我们可以看到，上面生成的 specs\002-scenario-config\spec.md 里面有个 <strong>Edge Cases</strong> 板块，里面列举了一些边界情况，大部分是一些影响细节交互的问题，如果你希望做出来的系统更加人性化，可以使用 /speckit.clarify 帮你列出AI认为的最需要澄清的5个问题，并给出建议，同时会帮你写回到spec.md中。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4370b2b12d6c45e7bc20ec70ddefa875~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3ODA0ODcxNDM1NTYyNQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769930338&amp;x-signature=Tr0P2p%2B56thR0vxmFUq1vjA4Ub0%3D" alt="" loading="lazy"/></p>
<p>执行命令后</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/62a29db83a8a4baa8614426e8fa07990~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3ODA0ODcxNDM1NTYyNQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769930338&amp;x-signature=DAWaShDplGYlNLdub8zUYEeXu8I%3D" alt="" loading="lazy"/></p>
<p>交互式澄清5个问题并更新到spec.md中，按照你想要的答案选择选项或者输入新的解决办法。</p>
<h4 data-id="heading-8">/speckit.plan 生成概要设计</h4>
<p>这一步在我们要着重在如何实现它，重点在how，因此需要将足够的实现信息给AI，如后端接口文档，这样AI可以帮我们做准确合适的概要设计。</p>
<p>我这个需求里，我从后端提供的接口信息（最好让后端的概要设计做详细，包含接口的各种信息），整理了一份后端接口文档：可以看到，后端没有提供响应数据格式，因此后续字段对接这块可能会存在一些问题。</p>
<p>执行 /speckit.plan</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/859abe008bb24977bb4cd4f495646235~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3ODA0ODcxNDM1NTYyNQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769930338&amp;x-signature=YwiSmpQf7RFZ0rCbi9h8MOSPyL4%3D" alt="" loading="lazy"/></p>
<p>生成了以下文件：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ad85eb99c0d14dc385e5070cd8fb80e3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3ODA0ODcxNDM1NTYyNQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769930338&amp;x-signature=ZK%2FZysqQGw56f1QvluqJGsgJqEY%3D" alt="" loading="lazy"/></p>
<p>在这里，我们主要review plan.md，里面可能有一些需要确认的事项，根据需要进行删减更改。前面有提到我们提供的后端接口信息文档没有提供响应数据格式，但在contracts/api-endpoints.md文件中可以看到，AI自动根据我们提供的接口请求参数信息补充了接口返回信息！还是挺聪明的。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2e4463f2596f45ed8f5016ebbb9472e7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3ODA0ODcxNDM1NTYyNQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769930338&amp;x-signature=esMSiKErcQzh0%2BIhDUcxw%2FhgEhY%3D" alt="" loading="lazy"/></p>
<p>最终的plan.md【字数限制不放上来了】</p>
<h4 data-id="heading-9">/speckit.task 生成任务</h4>
<p>生成分阶段的、独立的任务，汇总到 <code>tasks.md</code></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2c6f6e0d42e54c3280bd910310d25867~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3ODA0ODcxNDM1NTYyNQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769930338&amp;x-signature=JM8W4%2B7clUhQOaTWxtqG11j5ih0%3D" alt="" loading="lazy"/></p>
<p>可以看到，这一步将我们要实现的需求分为了7个阶段，并按增量的形式划分为了4个执行期，非常清晰。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f176c6aa30134a14bafa9e7278476c6c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3ODA0ODcxNDM1NTYyNQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769930338&amp;x-signature=9OUTsxkTWaNNjwDWaFpXwZ%2B6vq8%3D" alt="" loading="lazy"/></p>
<p>终版task.md【字数限制不放上来了】</p>
<h3 data-id="heading-10">结果怎么样？</h3>
<p>我总结了一下：</p>
<ul>
<li>代码生成效果不错，90%以上的代码可用</li>
<li>逻辑部分几乎完全没问题，阻碍流程的地方几乎都是上下文错误或者上下文不够完全，AI偶尔有幻觉，见上表问题7</li>
<li>一些UI问题，UI交互优化通过AI能非常快速地修复</li>
</ul>
<h3 data-id="heading-11">有什么心得？</h3>
<ul>
<li>
<p>后台管理重简单逻辑、轻UI，这种类型的开发任务非常适合spec-driven development流程来开发</p>
</li>
<li>
<p>提供的需求上下文，接口上下文信息越准确，越完善，生成的代码质量越高</p>
</li>
<li>
<p>AI偶尔会出现幻觉，但从上面的例子来看，是可接受的范围内</p>
</li>
<li>
<p>我们可以采用sDd开发+手动测试的方式，发现的问题可以通过人工+AI排查的方式来修复，其中轻UI的修复可以全部交给AI来做，逻辑部分AI+人工的方式更加高效</p>
</li>
<li>
<p>修复问题阶段最优模式是：</p>
<ul>
<li>新建一个chat(而不是在原来的sdd开发chat上，上下文过长，影响生成效率)</li>
<li>采用edit方式(agent方式适合高难度的任务，会搜集各种信息，时间长)，效率更高，且可以直接编辑文件。edit模式下给出的上下文越准确，AI修复问题越准确。</li>
</ul>
</li>
<li>
<p>当对某次修改不满意时，利用chat的restore Checkpoint功能会非常方便，点击restore Checkpoint，AI会回撤这次的所有更改。这样你就可以在上次更改的基础上重新更改。</p>
</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/09082caa9b324f0dbe04c0aedc0aae41~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3ODA0ODcxNDM1NTYyNQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769930338&amp;x-signature=7fdXO2fRiPV80VFDMr3Hnxoi8ds%3D" alt="" loading="lazy"/></p>
<p>或者直接点击问题进入编辑模式，和上面的效果也是一样的</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0b5dd33cd71343738fe6b0c8273cb05d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3ODA0ODcxNDM1NTYyNQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769930338&amp;x-signature=BskwvhlEX%2BHvIcSHaRsrp9pREwA%3D" alt="" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[云原生 Profiling：零侵入、随用随取的动态采集实战]]></title>    <link>https://juejin.cn/post/7599474528239042600</link>    <guid>https://juejin.cn/post/7599474528239042600</guid>    <pubDate>2026-01-26T10:26:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599474528239042600" data-draft-id="7599220371666337832" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="云原生 Profiling：零侵入、随用随取的动态采集实战"/> <meta itemprop="keywords" content="监控,云原生"/> <meta itemprop="datePublished" content="2026-01-26T10:26:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="可观测性用观测云"/> <meta itemprop="url" content="https://juejin.cn/user/2392958212523102"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            云原生 Profiling：零侵入、随用随取的动态采集实战
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2392958212523102/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    可观测性用观测云
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T10:26:17.000Z" title="Mon Jan 26 2026 10:26:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">背景</h2>
<p>应用在运行过程中，开启性能分析（Profiling）通常是诊断性能瓶颈、内存泄漏和线程问题的关键手段。然而，持续开启 Profiling 会带来显著的性能开销（可能达 5%-20%），并可能生成大量数据，影响生产环境稳定性。动态开启 Profiling 允许开发或运维人员按需、实时地启动/停止数据收集，实现以下目标：</p>
<ol>
<li>降低持续开销：仅在需要时启用，避免长期性能损耗；</li>
<li>精准问题定位：针对特定时段（如流量高峰或故障期间）进行分析；</li>
<li>在线诊断：无需重启应用即可获取生产环境实时性能快照；</li>
<li>灵活控制：可结合监控指标（如 CPU 飙升）自动触发，或在安全审计时手动开启。</li>
</ol>
<p>通过动态控制，实现了观测能力与系统负载的平衡，保障了关键业务场景的效率和稳定性。</p>
<h2 data-id="heading-1">Flameshot</h2>
<p>Flameshot 是一个基于 Sidecar 模式运行的轻量级自动性能剖析（Profiling）工具。它通过监控目标进程的资源使用情况（CPU/内存），在达到预设阈值时自动触发底层 Profiler（如 <code>async-profiler</code> ），从而实现无侵入的现场快照采集。</p>
<p>Flameshot 采用 Sidecar 容器 模式部署。它必须与业务主容器（Main Container）运行在同一个 Pod 中，并开启 PID 命名空间共享。</p>
<ol>
<li>监控 (Monitor)：Flameshot 持续轮询主容器内目标进程的资源水位。</li>
<li>触发 (Trigger)：当满足阈值（如 CPU &gt; 80%）或收到 HTTP API 请求时，触发采集任务。</li>
<li>执行 (Execute)：根据配置的语言类型（目前支持 Java），调用对应的 Profiler 工具 attach 到目标进程。</li>
<li>收集 (Collect)：生成的 Profile 文件（如 <code>.jfr</code> ）存储于共享卷中，随后上传至数据观测中心。</li>
</ol>
<p>观测云 <code>datakit-operator</code> 从 <code>1.7.0</code> 版本开始支持工具 <code>flameshots</code>，实现动态开启应用 Profiling。</p>
<h2 data-id="heading-2">实践</h2>
<p>当前在 K8S 环境上部署 JAVA 应用，当 CPU、内存使用率达到 20%（演示方便）则触发 Profiling 数据采集。</p>
<h3 data-id="heading-3">前提条件</h3>
<ul>
<li>观测云帐号</li>
<li>K8S 环境</li>
</ul>
<h3 data-id="heading-4">DataKit</h3>
<p>DataKit 主要是用来采集数据并上报观测云。</p>
<h4 data-id="heading-5">1. 下载 &amp; 安装</h4>
<pre><code class="hljs language-arduino" lang="arduino">wget https:<span class="hljs-comment">//static.guance.com/datakit/datakit.yaml</span>
</code></pre>
<h4 data-id="heading-6">2. 配置 <code>datakit.yaml</code></h4>
<p>配置 DataWay 数据网关地址</p>
<pre><code class="hljs language-ini" lang="ini">name: ENV_DATAWAY
value: https://openway.guance.com?<span class="hljs-attr">token</span>=tkn_xxxxx
</code></pre>
<p>DataKit 会默认开启主机相关采集器，这里需要追加 <code>pyroscope</code></p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">name: ENV_DEFAULT_ENABLED_INPUTS</span>
<span class="hljs-section">value: cpu,disk,diskio,mem,swap,system,hostobject,net,host_processes,container,pyroscope</span>
</code></pre>
<h4 data-id="heading-7">3. 启动</h4>
<p>调整完配置后，启动 DataKit</p>
<pre><code class="hljs language-ruby" lang="ruby">root<span class="hljs-variable">@root</span><span class="hljs-symbol">:~</span><span class="hljs-variable">$ </span>kubectl apply -f datakit.yaml
root<span class="hljs-variable">@root</span><span class="hljs-symbol">:~</span><span class="hljs-variable">$ </span>kubectl get pods -n datakit
<span class="hljs-variable constant_">NAME</span>                                <span class="hljs-variable constant_">READY</span>   <span class="hljs-variable constant_">STATUS</span>    <span class="hljs-variable constant_">RESTARTS</span>   <span class="hljs-variable constant_">AGE</span>
datakit-4zg7q                       <span class="hljs-number">1</span>/<span class="hljs-number">1</span>     <span class="hljs-title class_">Running</span>   <span class="hljs-number">0</span>          14h
datakit-wdtdq                       <span class="hljs-number">1</span>/<span class="hljs-number">1</span>     <span class="hljs-title class_">Running</span>   <span class="hljs-number">0</span>          14h
</code></pre>
<h3 data-id="heading-8">DataKit Operator</h3>
<h4 data-id="heading-9">1. 下载</h4>
<p>下载最新的 <code>datakit-operator.yaml</code></p>
<pre><code class="hljs language-vbnet" lang="vbnet">wget https://<span class="hljs-keyword">static</span>.guance.com/datakit-<span class="hljs-keyword">operator</span>/datakit-<span class="hljs-keyword">operator</span>.yaml
</code></pre>
<h4 data-id="heading-10">2. 配置 <code>datakit-operator.yaml</code></h4>
<p>主要调整 <code>jsonconfig</code> 下的 <code>flameshots</code> 内容，参考如下：</p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">apiVersion: v1</span>
<span class="hljs-section">kind: ConfigMap</span>
<span class="hljs-section">metadata:</span>
  name: datakit-operator-config
  namespace: datakit
<span class="hljs-section">data:</span>
  jsonconfig: |-
    {
        <span class="hljs-string">"server_listen"</span>: <span class="hljs-string">"0.0.0.0:9543"</span>,
        <span class="hljs-string">"log_level"</span>:     <span class="hljs-string">"info"</span>,
        <span class="hljs-string">"admission_inject_v2"</span>: {
            ...
            <span class="hljs-string">"flameshots"</span>: [
                {
                    <span class="hljs-string">"namespace_selectors"</span>: [<span class="hljs-string">"default"</span>],
                    <span class="hljs-string">"label_selectors"</span>:     [],
                    <span class="hljs-string">"image"</span>: <span class="hljs-string">"pubrepo.jiagouyun.com/datakit/flameshot:0.1.1"</span>,
                    <span class="hljs-string">"envs"</span>: {
                        <span class="hljs-string">"FLAMESHOT_DATAKIT_ADDR"</span>:     <span class="hljs-string">"http://datakit-service.datakit.svc:9529/profiling/v1/input"</span>,
                        <span class="hljs-string">"FLAMESHOT_MONITOR_INTERVAL"</span>: <span class="hljs-string">"1s"</span>,
                        <span class="hljs-string">"FLAMESHOT_PROFILING_PATH"</span>:   <span class="hljs-string">"/flameshot-data"</span>,
                        <span class="hljs-string">"FLAMESHOT_HTTP_LOCAL_IP"</span>:    <span class="hljs-string">"{fieldRef:status.podIP}"</span>,
                        <span class="hljs-string">"FLAMESHOT_HTTP_LOCAL_PORT"</span>:  <span class="hljs-string">"8089"</span>,
                        <span class="hljs-string">"FLAMESHOT_SERVICE"</span>:          <span class="hljs-string">"{fieldRef:metadata.labels['app']}"</span>,
                        <span class="hljs-string">"POD_NAME"</span>:                <span class="hljs-string">"{fieldRef:metadata.name}"</span>,
                        <span class="hljs-string">"POD_NAMESPACE"</span>:           <span class="hljs-string">"{fieldRef:metadata.namespace}"</span>,
                        <span class="hljs-string">"NODE_NAME"</span>:               <span class="hljs-string">"{fieldRef:spec.nodeName}"</span>,
                        <span class="hljs-string">"FLAMESHOT_TAGS"</span>:          <span class="hljs-string">"pod_name:<span class="hljs-variable">$(POD_NAME)</span>,pod_namespace:<span class="hljs-variable">$(POD_NAMESPACE)</span>,host:<span class="hljs-variable">$(NODE_NAME)</span>"</span>
                        
                    },
                    <span class="hljs-string">"resources"</span>: {
                        <span class="hljs-string">"requests"</span>: {
                            <span class="hljs-string">"cpu"</span>:    <span class="hljs-string">"100m"</span>,
                            <span class="hljs-string">"memory"</span>: <span class="hljs-string">"128Mi"</span>
                        },
                        <span class="hljs-string">"limits"</span>: {
                           <span class="hljs-string">"cpu"</span>:    <span class="hljs-string">"200m"</span>,
                           <span class="hljs-string">"memory"</span>: <span class="hljs-string">"256Mi"</span>
                        }
                    },
                    <span class="hljs-string">"processes"</span>: <span class="hljs-string">"[{"</span>command<span class="hljs-string">":"</span>java<span class="hljs-string">","</span>duration<span class="hljs-string">":"</span>60s<span class="hljs-string">","</span>events<span class="hljs-string">":"</span>--all<span class="hljs-string">","</span>language<span class="hljs-string">":"</span>java<span class="hljs-string">","</span>jdk_version<span class="hljs-string">":"</span>-<span class="hljs-string">","</span>tags<span class="hljs-string">":["</span>env:testing<span class="hljs-string">","</span>version:1.0.0<span class="hljs-string">"],"</span>cpu_usage_percent<span class="hljs-string">":20,"</span>mem_usage_percent<span class="hljs-string">":20,"</span>mem_usage_mb<span class="hljs-string">":1024}]"</span>
                }
            ]
        },
        ...
    }
</code></pre>
<p>参数说明：</p>
<ul>
<li>namespace_selectors： 空间选择，即哪些空间需要开启 <code>flameshots</code></li>
<li>env: 配置环境变量信息</li>
<li>processes： 执行命令，如果为空，则 <code>flameshots</code> 不生效</li>
</ul>
<p>processes 通用字段说明：</p>
<ul>
<li><code>service</code> (String): 选填，上报到观测中心的服务名称。</li>
<li><code>language</code> (String): 目标进程语言。目前支持 java。</li>
<li><code>command</code> (String): 匹配进程命令行的正则表达式。</li>
<li><code>duration</code> (String): 单次采集时长（例如 <code>30s</code>，<code>1m</code>）。注意：受限于执行超时，建议不超过 5 分钟。</li>
<li><code>tags</code> (List): 自定义标签列表，建议包含 <code>env</code>，<code>version</code> 等元信息。</li>
<li><code>cpu_usage_percent</code> (Int): CPU 触发阈值 (0-N)。多核环境下数值可能超过 100。</li>
<li><code>mem_usage_percent</code> (Int): 内存使用率触发阈值 (0-100)。</li>
<li><code>mem_usage_mb</code> (Int): 内存使用量绝对值触发阈值 (MB)。</li>
</ul>
<p>当前配置 processes 可以实现所有 JAVA 服务，为了实践方便，当 cpu 使用率达到 20% 或内存使用率达到 20% 或内存使用值达到 1024m，则会触发执行 Profiling 操作。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-string">"processes"</span>: <span class="hljs-string">"[{"</span><span class="hljs-built_in">command</span><span class="hljs-string">":"</span>java<span class="hljs-string">","</span>duration<span class="hljs-string">":"</span>60s<span class="hljs-string">","</span>events<span class="hljs-string">":"</span>--all<span class="hljs-string">","</span>language<span class="hljs-string">":"</span>java<span class="hljs-string">","</span>jdk_version<span class="hljs-string">":"</span>-<span class="hljs-string">","</span>tags<span class="hljs-string">":["</span><span class="hljs-built_in">env</span>:testing<span class="hljs-string">","</span>version:1.0.0<span class="hljs-string">"],"</span>cpu_usage_percent<span class="hljs-string">":20,"</span>mem_usage_percent<span class="hljs-string">":20,"</span>mem_usage_mb<span class="hljs-string">":1024}]"</span>
</code></pre>
<h4 data-id="heading-11">3. 启动</h4>
<pre><code class="hljs language-ruby" lang="ruby">root<span class="hljs-variable">@root</span><span class="hljs-symbol">:~</span><span class="hljs-variable">$ </span>kubectl apply -f datakit-operator.yaml
root<span class="hljs-variable">@root</span><span class="hljs-symbol">:~</span><span class="hljs-variable">$ </span>kubectl get pods -n datakit
<span class="hljs-variable constant_">NAME</span>                                <span class="hljs-variable constant_">READY</span>   <span class="hljs-variable constant_">STATUS</span>    <span class="hljs-variable constant_">RESTARTS</span>   <span class="hljs-variable constant_">AGE</span>
datakit-4zg7q                       <span class="hljs-number">1</span>/<span class="hljs-number">1</span>     <span class="hljs-title class_">Running</span>   <span class="hljs-number">0</span>          15h
datakit-operator-849f868b78-zbcd9   <span class="hljs-number">1</span>/<span class="hljs-number">1</span>     <span class="hljs-title class_">Running</span>   <span class="hljs-number">0</span>          58s
datakit-wdtdq                       <span class="hljs-number">1</span>/<span class="hljs-number">1</span>     <span class="hljs-title class_">Running</span>   <span class="hljs-number">0</span>          15h
</code></pre>
<h3 data-id="heading-12">JAVA 应用</h3>
<h4 data-id="heading-13">1. Yaml 配置</h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">springboot-server</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">selector:</span>
    <span class="hljs-attr">matchLabels:</span>
      <span class="hljs-attr">app:</span> <span class="hljs-string">springboot-server</span>
  <span class="hljs-attr">replicas:</span> <span class="hljs-number">1</span>
  <span class="hljs-attr">template:</span>
    <span class="hljs-attr">metadata:</span>
      <span class="hljs-attr">labels:</span>
        <span class="hljs-attr">app:</span> <span class="hljs-string">springboot-server</span>
    <span class="hljs-attr">spec:</span>
      <span class="hljs-attr">containers:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">image:</span> <span class="hljs-string">registry.cn-shenzhen.aliyuncs.com/lr_715377484/springboot-server:flameshots</span>
          <span class="hljs-attr">name:</span> <span class="hljs-string">springboot-server</span>
          <span class="hljs-attr">imagePullPolicy:</span> <span class="hljs-string">IfNotPresent</span>
          <span class="hljs-attr">ports:</span>
            <span class="hljs-bullet">-</span> <span class="hljs-attr">containerPort:</span>  <span class="hljs-number">8080</span>
              <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span>

          <span class="hljs-attr">securityContext:</span>
            <span class="hljs-attr">seccompProfile:</span>
              <span class="hljs-attr">type:</span> <span class="hljs-string">Unconfined</span>
</code></pre>
<h4 data-id="heading-14">2. 启动应用</h4>
<pre><code class="hljs language-ruby" lang="ruby">root<span class="hljs-variable">@root</span><span class="hljs-symbol">:~</span><span class="hljs-variable">$ </span> kubectl apply -f springboot-server.yaml
root<span class="hljs-variable">@root</span><span class="hljs-symbol">:~</span><span class="hljs-variable">$ </span>kubectl get pods
<span class="hljs-variable constant_">NAME</span>                                <span class="hljs-variable constant_">READY</span>   <span class="hljs-variable constant_">STATUS</span>    <span class="hljs-variable constant_">RESTARTS</span>   <span class="hljs-variable constant_">AGE</span>
springboot-server-d55fc79dd-48c95   <span class="hljs-number">2</span>/<span class="hljs-number">2</span>     <span class="hljs-title class_">Running</span>   <span class="hljs-number">0</span>          3s
</code></pre>
<h4 data-id="heading-15">3. 查看 <code>flameshot</code> 执行日志</h4>
<p>需要指定 containerName 为 <code>-c datakit-flameshot</code></p>
<pre><code class="hljs language-bash" lang="bash">root@root:~$ kubectl logs -f springboot-server-d55fc79dd-48c95 -c datakit-flameshot
2026-01-15T03:55:58.090Z        ERROR        flameshot        flameshot/config.go:243        <span class="hljs-built_in">read</span> config file failed, err:open /flameshot/flameshot.conf: no such file or directory
2026-01-15T03:55:58.092Z        INFO        flameshot        flameshot/monitor.go:78        start monitor, interval: 1s
2026-01-15T03:55:58.092Z        INFO        flameshot        flameshot/http.go:77        start http server on 10.187.217.101:8089
2026-01-15T03:55:58.092Z        INFO        flameshot        flameshot/http.go:78        profile start at /v1/profile
2026-01-15T03:55:58.092Z        INFO        flameshot        flameshot/http.go:79        prom http start at /metrics
2026-01-15T03:56:58.093Z        INFO        flameshot        flameshot/monitor.go:102        match: PID=7, name=java or cmd=java -jar app.jar
</code></pre>
<p>从启动日志上分析，已经找到了 java 服务，且 PID 为 7，等待触发事件</p>
<h4 data-id="heading-16">4. 触发阈值</h4>
<p>访问应用</p>
<pre><code class="hljs language-perl" lang="perl">root@root:~$ kubectl <span class="hljs-keyword">exec</span> -it springboot-server-d55fc79dd-<span class="hljs-number">48</span>c95  -- <span class="hljs-regexp">/bin/</span>bash 
Defaulted container <span class="hljs-string">"springboot-server"</span> out of: springboot-server, datakit-flameshot
springboot-server-d55fc79dd-<span class="hljs-number">48</span>c95:<span class="hljs-regexp">/home/app</span><span class="hljs-comment">#</span>
springboot-server-d55fc79dd-<span class="hljs-number">48</span>c95:<span class="hljs-regexp">/home/app</span><span class="hljs-comment"># curl http://localhost:8080/profiling/generator</span>
<span class="hljs-keyword">write</span> success!springboot-server-d55fc79dd-<span class="hljs-number">48</span>c95:<span class="hljs-regexp">/home/app</span><span class="hljs-comment"># </span>
</code></pre>
<p>再来看看 <code>flameshot</code> 执行日志，已触发了阈值 <code>cpu_avg:36.60</code> 且正常上报数据。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6f554a7a775e4e2ab5a0842ad349ff33~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770027977&amp;x-signature=K62K%2BGbNQWF2aTBy8TDBgfYTO9s%3D" alt="" loading="lazy"/></p>
<p>之后恢复了正常，正常之后则不会再产生 Profiling 数据，除非再次触发了阈值。</p>
<h3 data-id="heading-17">观测云平台</h3>
<p>登录观测云平台，访问「应用性能检测」-「Profling」可以查看到刚刚上报的 Profling 信息</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/666a3bf27773494eb1f05da63ada3e73~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770027977&amp;x-signature=qWtEJuEcdVJZzQW1Kn1qaC9Z0zY%3D" alt="" loading="lazy"/></p>
<p>点击列表可以查看 Profling 详细信息，如 CPU 耗时、内存分配情况等，可以更深度的剖析应用代码性能损耗。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0efbac6898bf4d7d95f7eda85b5772b0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770027977&amp;x-signature=faNNZA0FXhuqRPY%2FbVzjI0N2AHc%3D" alt="" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[你的 AI 应用不要再只是Chat+RAG 了！深度拆解LinkedIn招聘AI Agent架构，附源码]]></title>    <link>https://juejin.cn/post/7599528186586497034</link>    <guid>https://juejin.cn/post/7599528186586497034</guid>    <pubDate>2026-01-26T10:11:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599528186586497034" data-draft-id="7599330434426601523" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="你的 AI 应用不要再只是Chat+RAG 了！深度拆解LinkedIn招聘AI Agent架构，附源码"/> <meta itemprop="keywords" content="GitHub"/> <meta itemprop="datePublished" content="2026-01-26T10:11:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="张居邪"/> <meta itemprop="url" content="https://juejin.cn/user/2154698522507927"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            你的 AI 应用不要再只是Chat+RAG 了！深度拆解LinkedIn招聘AI Agent架构，附源码
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2154698522507927/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    张居邪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T10:11:58.000Z" title="Mon Jan 26 2026 10:11:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、灵魂拷问：为什么你的AI项目总是死在Demo之后？</h2>
<p>上个月，一个做HR SaaS的朋友找我吐槽：</p>
<blockquote>
<p>"我们花了3个月做的AI招聘助手，Demo给老板看的时候，老板直呼'太牛了'。结果上线两周，HR们集体反馈'还不如我自己搜'，现在项目已经凉了..."</p>
</blockquote>
<p>我问他架构怎么设计的，他发来一张图：</p>
<pre><code class="hljs language-markdown" lang="markdown">用户输入 → Prompt → LLM → 输出结果
<span class="hljs-code">              ↑
           RAG检索
</span></code></pre>
<p>我说：<strong>这前期演示可以，但落地会有一堆的问题。</strong></p>
<p>他不服：市面上90%的AI应用不都这么搞的吗？</p>
<p>没错，所以90%的AI项目都死在了Demo之后。</p>

























<table><thead><tr><th>问题</th><th>你可能遇到过</th></tr></thead><tbody><tr><td><strong>无状态</strong></td><td>每次对话都是新开始，AI不记得用户上次说了啥</td></tr><tr><td><strong>单一能力</strong></td><td>一个Prompt打天下，稍微复杂点的任务就搞不定</td></tr><tr><td><strong>不可控</strong></td><td>LLM输出飘忽不定，生产环境天天提心吊胆</td></tr><tr><td><strong>人机割裂</strong></td><td>要么全自动要么全手动，没有中间态</td></tr></tbody></table>
<p>今天拆解一个<strong>真正跑在生产环境的AI Agent</strong>——LinkedIn Hiring Assistant，看看大厂是怎么解决这些问题的。</p>
<p>顺便说一句，我把核心架构用LangGraph复现了一遍，<strong>源码在文末</strong>。</p>
<hr/>
<h2 data-id="heading-1">二、LinkedIn Hiring Assistant：这数据超过了一般专业的HR了</h2>
<h3 data-id="heading-2">2.1 产品背景</h3>
<p>2024年10月，LinkedIn悄悄上线了一个叫Hiring Assistant的东西。</p>
<p>注意措辞——LinkedIn管它叫"Agent"，不是"AI功能"，也不是"智能助手"。这个定位本身就很有意思。</p>
<p>一年后，这产品已经铺到全球市场了。官方放出来的数据：</p>





























<table><thead><tr><th>指标</th><th>效果</th></tr></thead><tbody><tr><td>候选人浏览效率</td><td>提升 <strong>60%</strong></td></tr><tr><td>候选人联系效率</td><td>提升 <strong>40%</strong></td></tr><tr><td>初筛效率</td><td>提升 <strong>45%</strong></td></tr><tr><td>InMail回复率</td><td><strong>2.15倍</strong></td></tr><tr><td>自动化覆盖率</td><td>招聘流程的 <strong>80%</strong></td></tr></tbody></table>
<p>InMail回复率2.15倍这个数据最让我震惊——要知道LinkedIn上的InMail回复率一直是个老大难问题，很多HR发100封能收到5封回复就谢天谢地了。</p>
<p>这些数字背后，是一套完全不同于"Chat+RAG"的架构。</p>
<h3 data-id="heading-3">2.2 核心能力</h3>
<p>功能覆盖招聘全流程：<strong>JD生成 → 候选人搜索 → 智能筛选 → 个性化外联 → 持续学习</strong>。</p>
<p>但说实话，<strong>功能不是重点，架构才是</strong>。</p>
<hr/>
<h2 data-id="heading-4">三、核心架构拆解：为什么是Supervisor模式？</h2>
<h3 data-id="heading-5">3.1 先说结论：ReAct不够用</h3>
<p>市面上大多数AI Agent教程都在讲ReAct（Reasoning + Acting）模式。我之前也用这个模式做过几个项目，踩了不少坑。</p>
<p>直接上对比：</p>





























<table><thead><tr><th>模式</th><th>优点</th><th>坑在哪</th><th>适合干啥</th></tr></thead><tbody><tr><td><strong>ReAct单Agent</strong></td><td>简单直接，上手快</td><td>复杂任务容易跑偏，没法并行</td><td>简单问答</td></tr><tr><td><strong>Plan-and-Execute</strong></td><td>计划清晰，可预测</td><td>太死板，中途改不了</td><td>步骤固定的流程</td></tr><tr><td><strong>Supervisor Multi-Agent</strong></td><td>专业分工，能并行，好扩展</td><td>架构复杂，调试头疼</td><td><strong>复杂业务流程</strong></td></tr></tbody></table>
<p><strong>Supervisor模式的核心差异</strong>：它的"规划"是动态的、走一步看一步的，不是一开始就把整个计划定死。</p>
<p>举个例子你就懂了：</p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">用户: "帮我招一个后端工程师"</span>
     ↓
<span class="hljs-section">Supervisor: 先让Sourcing去搜人</span>
     ↓
<span class="hljs-section">Sourcing返回: 只找到3个人</span>
     ↓
<span class="hljs-section">Supervisor: 人太少，放宽条件再搜一次（动态调整）</span>
     ↓
<span class="hljs-section">Sourcing返回: 这次找到15个</span>
     ↓
<span class="hljs-section">Supervisor: 够了，让Screening去筛选</span>
     ↓
...每一步都根据上一步结果决定下一步
</code></pre>
<p>这种"边走边看"的模式，才是生产环境真正需要的。</p>
<h3 data-id="heading-6">3.2 架构全景图</h3>
<pre><code class="hljs language-scss" lang="scss">                    ┌─────────────────────────────────┐
                    │        Recruiter (用户)          │
                    └───────────────┬─────────────────┘
                                    │ 自然语言交互
                                    ▼
┌───────────────────────────────────────────────────────────────┐
│                      Supervisor Agent                          │
│  ┌─────────────────────────────────────────────────────────┐  │
│  │  • 意图理解：用户想做什么？                               │  │
│  │  • 任务分解：拆成哪些子任务？                             │  │
│  │  • 调度决策：分配给哪个Agent？                           │  │
│  │  • 结果聚合：如何整合各Agent的输出？                      │  │
│  │  • 异常处理：子Agent失败了怎么办？                        │  │
│  └─────────────────────────────────────────────────────────┘  │
└──────────────────────────┬────────────────────────────────────┘
                           │
         ┌─────────────────┼─────────────────┬─────────────────┐
         ▼                 ▼                 ▼                 ▼
┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│  Sourcing   │    │  Screening  │    │  Outreach   │    │  Evaluation │
│    Agent    │    │    Agent    │    │    Agent    │    │    Agent    │
├─────────────┤    ├─────────────┤    ├─────────────┤    ├─────────────┤
│ • 候选人搜索 │    │ • 简历解析  │    │ • 消息生成  │    │ • 匹配度评分│
│ • 技能匹配   │    │ • 条件筛选  │    │ • 个性化定制│    │ • 排序推荐  │
│ • 人才库检索 │    │ • 预筛选QA  │    │ • 多语言翻译│    │ • 对比分析  │
└──────┬──────┘    └──────┬──────┘    └──────┬──────┘    └──────┬──────┘
       │                  │                  │                  │
       └──────────────────┴──────────────────┴──────────────────┘
                                    │
                                    ▼
                    ┌───────────────────────────────┐
                    │       Skill Registry          │
                    │   (统一的能力注册与管理中心)    │
                    ├───────────────────────────────┤
                    │  • search_candidates          │
                    │  • parse_resume               │
                    │  • generate_inmail            │
                    │  • evaluate_fit               │
                    │  • ...                        │
                    └───────────────────────────────┘
                                    │
                                    ▼
                    ┌───────────────────────────────┐
                    │     LinkedIn Services         │
                    │  (Economic Graph, <span class="hljs-number">10</span>亿+用户)   │
                    └───────────────────────────────┘
</code></pre>
<h3 data-id="heading-7">3.3 三个关键设计决策</h3>
<p><strong>决策1：从Prompt Chain到Prompt Graph</strong></p>
<p>传统做法是线性的：</p>
<pre><code class="hljs language-css" lang="css">Prompt <span class="hljs-selector-tag">A</span> → Prompt <span class="hljs-selector-tag">B</span> → Prompt C → 输出
</code></pre>
<p>LinkedIn用的是图结构：</p>
<pre><code class="hljs language-css" lang="css">        ┌→ Prompt <span class="hljs-selector-tag">B</span> ─┐
Prompt <span class="hljs-selector-tag">A</span> ─┤           ├→ Prompt D → 输出
        └→ Prompt C ─┘
</code></pre>
<p>好处很直接：</p>
<ul>
<li>B和C可以并行跑，快</li>
<li>支持条件分支，灵活</li>
<li>某个节点挂了可以重试，稳</li>
</ul>
<p><strong>决策2：Supervisor只管调度，不干活</strong></p>
<p>这点很重要。Supervisor的职责是<strong>纯粹的协调</strong>，不直接调用工具或执行业务逻辑。</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># Supervisor的核心逻辑（伪代码）</span>
class SupervisorAgent:
    def process(self, user_request):
        <span class="hljs-comment"># 1. 搞清楚用户想干啥</span>
        <span class="hljs-attr">intent</span> = self.understand_intent(user_request)

        <span class="hljs-comment"># 2. 拆成小任务</span>
        <span class="hljs-attr">subtasks</span> = self.decompose_task(intent)

        <span class="hljs-comment"># 3. 分配给对应的Agent（可以并行）</span>
        <span class="hljs-attr">results</span> = []
        for task in subtasks:
            <span class="hljs-attr">agent</span> = self.select_agent(task)
            <span class="hljs-attr">result</span> = agent.execute(task)
            results.append(result)

        <span class="hljs-comment"># 4. 汇总结果</span>
        return self.aggregate_results(results)
</code></pre>
<p>为啥这么设计？</p>

























<table><thead><tr><th>设计</th><th>好处</th></tr></thead><tbody><tr><td>职责单一</td><td>Supervisor只管调度，不会因为业务逻辑复杂而出错</td></tr><tr><td>易于扩展</td><td>加新能力就加个子Agent，Supervisor不用改</td></tr><tr><td>便于调试</td><td>出问题能定位到具体哪个Agent，不是一团乱麻</td></tr><tr><td>支持并行</td><td>没依赖关系的任务可以同时跑</td></tr></tbody></table>
<p><strong>决策3：Skill Registry统一管理能力</strong></p>
<p>所有Agent的能力都注册在一个统一的Registry里：</p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-comment"># Skill Registry示例</span>
skill_registry = {
    <span class="hljs-string">"search_candidates"</span>: {
        <span class="hljs-string">"agent"</span>: <span class="hljs-string">"sourcing_agent"</span>,
        <span class="hljs-string">"description"</span>: <span class="hljs-string">"根据条件搜索候选人"</span>,
        <span class="hljs-string">"parameters"</span>: [<span class="hljs-string">"job_requirements"</span>, <span class="hljs-string">"filters"</span>],
        <span class="hljs-string">"output"</span>: <span class="hljs-string">"candidate_list"</span>
    },
    <span class="hljs-string">"generate_inmail"</span>: {
        <span class="hljs-string">"agent"</span>: <span class="hljs-string">"outreach_agent"</span>,
        <span class="hljs-string">"description"</span>: <span class="hljs-string">"生成个性化外联消息"</span>,
        <span class="hljs-string">"parameters"</span>: [<span class="hljs-string">"candidate_profile"</span>, <span class="hljs-string">"job_info"</span>, <span class="hljs-string">"tone"</span>],
        <span class="hljs-string">"output"</span>: <span class="hljs-string">"message_content"</span>
    },
    <span class="hljs-comment"># ...</span>
}
</code></pre>
<p>好处：</p>
<ul>
<li>Supervisor能动态发现有哪些能力可用</li>
<li>接口统一，集成成本低</li>
<li>方便做权限控制和审计</li>
</ul>
<hr/>
<h2 data-id="heading-8">四、用 LangGraph 框架来实现一个简单的版本</h2>
<p>下面是完整的实现思路。</p>
<h3 data-id="heading-9">4.1 为什么选LangGraph？</h3>
<p>先说结论，我对比了几个主流框架：</p>






























<table><thead><tr><th>框架</th><th>特点</th><th>适合场景</th></tr></thead><tbody><tr><td>LangChain</td><td>线性Chain，上手简单</td><td>单轮问答、简单RAG</td></tr><tr><td>AutoGen</td><td>对话式多Agent</td><td>研究探索、头脑风暴</td></tr><tr><td>CrewAI</td><td>角色扮演式协作</td><td>创意任务、内容生成</td></tr><tr><td><strong>LangGraph</strong></td><td><strong>状态图+可控流程</strong></td><td><strong>生产级工作流</strong></td></tr></tbody></table>
<p>选LangGraph的原因：</p>
<ol>
<li><strong>StateGraph</strong>：状态管理是显式的，每一步都能追溯</li>
<li><strong>条件边</strong>：支持复杂分支逻辑</li>
<li><strong>持久化</strong>：工作流可以中断、恢复，适合长时间任务</li>
<li><strong>Human-in-the-Loop</strong>：原生支持人工审批节点</li>
</ol>
<h3 data-id="heading-10">4.2 LangGraph核心概念</h3>
<pre><code class="hljs language-sql" lang="sql">┌─────────────────────────────────────────────────────────────┐
│                    LangGraph 核心概念                        │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  State（状态）                                               │
│  └─ TypedDict定义，节点之间传递和更新                        │
│                                                              │
│  Node（节点）                                                │
│  └─ 干活的函数，接收State，返回更新后的State                 │
│                                                              │
│  Edge（边）                                                  │
│  └─ 连接节点，定义执行顺序                                   │
│                                                              │
│  Conditional Edge（条件边）                                  │
│  └─ 根据State动态决定下一个节点                              │
│                                                              │
│  <span class="hljs-keyword">START</span> <span class="hljs-operator">/</span> <span class="hljs-keyword">END</span>                                                 │
│  └─ 图的入口和出口                                           │
│                                                              │
└─────────────────────────────────────────────────────────────┘
</code></pre>
<p>概念不多，直接看代码更清楚。</p>
<h3 data-id="heading-11">4.3 核心实现思路</h3>
<blockquote>
<p>完整代码见文末 GitHub 仓库，这里只说核心思路。</p>
</blockquote>
<p><strong>整体架构分5层：</strong></p>
<pre><code class="hljs language-scss" lang="scss">┌─────────────────────────────────────────────────────────┐
│  State层：HiringState (TypedDict)                       │
│  - 招聘任务信息、候选人数据、流程控制、审核状态          │
├─────────────────────────────────────────────────────────┤
│  Tools层：<span class="hljs-keyword">@tool</span> 装饰器定义的能力                        │
│  - search_talent_<span class="hljs-attribute">pool</span>: 搜索候选人                       │
│  - evaluate_<span class="hljs-attribute">candidate</span>: LLM评估匹配度                    │
│  - generate_<span class="hljs-attribute">inmail</span>: LLM生成个性化消息                   │
├─────────────────────────────────────────────────────────┤
│  Node层：工作流节点函数                                 │
│  - supervisor_<span class="hljs-attribute">node</span>: LLM智能决策下一步                   │
│  - sourcing_<span class="hljs-attribute">node</span>: 搜索+偏好排序                         │
│  - screening_<span class="hljs-attribute">node</span>: 逐个评估候选人                       │
│  - outreach_<span class="hljs-attribute">node</span>: 为批准的候选人生成消息                │
│  - human_review_<span class="hljs-attribute">node</span>: interrupt等待人工审核             │
├─────────────────────────────────────────────────────────┤
│  Graph层：StateGraph + 条件边                           │
│  - START → supervisor → 各节点 → supervisor（循环）     │
│  - 条件边根据next_action路由                            │
├─────────────────────────────────────────────────────────┤
│  Memory层：Experiential Memory                          │
│  - <span class="hljs-attribute">RecruiterMemory</span>: 存储用户偏好                        │
│  - <span class="hljs-attribute">MemoryStore</span>: 持久化+从反馈中学习                     │
└─────────────────────────────────────────────────────────┘
</code></pre>
<p><strong>关键实现点：</strong></p>






























<table><thead><tr><th>模块</th><th>核心逻辑</th><th>文件位置</th></tr></thead><tbody><tr><td>Supervisor决策</td><td>把当前状态摘要发给LLM，让它决定下一步</td><td><code>src/workflow.py</code></td></tr><tr><td>偏好排序</td><td>用LLM做语义匹配，给候选人加偏好分</td><td><code>src/llm_service.py</code></td></tr><tr><td>Human-in-the-Loop</td><td>用<code>interrupt()</code>暂停，<code>Command(resume=)</code>恢复</td><td><code>src/workflow.py</code></td></tr><tr><td>记忆更新</td><td>从用户的批准/拒绝动作中提取偏好信号</td><td><code>src/memory.py</code></td></tr></tbody></table>
<p><strong>工作流图示：</strong></p>
<pre><code class="hljs language-ini" lang="ini">                         ┌─────────────┐
                         │    START    │
                         └──────┬──────┘
                                │
                                ▼
                    ┌───────────────────────┐
              ┌────▶│     Supervisor        │◀────┐
              │     │  (LLM 智能决策)        │     │
              │     └───────────┬───────────┘     │
              │                 │                 │
              │     ┌───────────┼───────────┐     │
              │     ▼           ▼           ▼     │
              │ ┌────────┐ ┌──────────┐ ┌────────┐│
              │ │Sourcing│ │Screening │ │Outreach││
              │ │  Node  │ │   Node   │ │  Node  ││
              │ └───┬────┘ └────┬─────┘ └───┬────┘│
              │     │           │           │     │
              │     └───────────┴───────────┘     │
              │                 │                 │
              │                 ▼                 │
              │         ┌─────────────┐           │
              │         │Human Review │           │
              │         │(interrupt)  │───────────┘
              │         └─────────────┘
              │                 │
              └─────────────────┘
                                │
                                ▼ (<span class="hljs-attr">next_action</span> == <span class="hljs-string">"FINISH"</span>)
                         ┌─────────────┐
                         │     END     │
                         └─────────────┘
</code></pre>
<h3 data-id="heading-12">4.4 Human-in-the-Loop：关键代码片段</h3>
<p>这是整个架构里最关键的设计。用LangGraph的<code>interrupt</code>机制实现：</p>
<pre><code class="hljs language-makefile" lang="makefile">from langgraph.types import interrupt, Command

<span class="hljs-comment"># 在节点中暂停，等待人工输入</span>
user_feedback = interrupt({
    <span class="hljs-string">"type"</span>: <span class="hljs-string">"human_review"</span>,
    <span class="hljs-string">"review_content"</span>: {<span class="hljs-string">"candidates"</span>: screened[:5]},
    <span class="hljs-string">"prompt"</span>: <span class="hljs-string">"请审核候选人"</span>
})

<span class="hljs-comment"># 调用方恢复执行</span>
result = app.invoke(Command(resume=human_feedback), config)
</code></pre>
<p>核心就这几行，剩下的是业务逻辑处理。</p>
<h3 data-id="heading-13">4.5 Experiential Memory：核心思路</h3>
<p>AI记住用户偏好的关键：<strong>从每次人工审核中学习</strong>。</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 用户批准了某个候选人 → 提取他的技能作为正向信号</span>
for candidate in approved_candidates:
    for skill in candidate<span class="hljs-section">["skills"]</span>:
        memory.positive_signals.append(skill)

<span class="hljs-comment"># 下次搜索时，用LLM做语义匹配，给符合偏好的候选人加分</span>
<span class="hljs-attr">preference_scores</span> = match_preferences_with_llm(candidates, memory.positive_signals)
</code></pre>
<p>就这么简单，但效果很明显——用得越久，推荐越准。</p>
<hr/>
<h2 data-id="heading-14">五、为什么你的AI助手用久了还是不懂你？</h2>
<p>这是LinkedIn Hiring Assistant<strong>最值得抄的设计</strong>。</p>
<h3 data-id="heading-15">5.1 一个扎心的问题</h3>
<p>你有没有这种体验：</p>
<ul>
<li>ChatGPT用了一年，每次还是要重新解释你的背景</li>
<li>企业知识库问答，永远不知道你关心什么</li>
<li>AI助手推荐的东西，永远不对味</li>
</ul>
<p><strong>根本原因：无状态设计</strong>。每次对话都是全新开始，AI压根不记得你是谁。</p>
<p>LinkedIn的解法是<strong>Experiential Memory</strong>——三层记忆架构：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/76be88322d13444ba1d92c0aba77b9be~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5byg5bGF6YKq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770027118&amp;x-signature=U9aQRYCAx9GgGS7OujHuecP%2Fs7w%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-16">5.2 技术实现思路</h3>
<p><strong>层次1：短期记忆（Session Memory）</strong></p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-comment"># 会话级记忆：当前招聘任务的上下文</span>
session_memory = {
    <span class="hljs-string">"current_job"</span>: <span class="hljs-string">"Senior Backend Engineer"</span>,
    <span class="hljs-string">"discussed_candidates"</span>: [<span class="hljs-string">"Alice"</span>, <span class="hljs-string">"Bob"</span>],
    <span class="hljs-string">"user_feedback"</span>: {
        <span class="hljs-string">"Alice"</span>: <span class="hljs-string">"技术不错但经验不足"</span>,
        <span class="hljs-string">"Bob"</span>: <span class="hljs-string">"很匹配，已发InMail"</span>
    }
}
</code></pre>
<p><strong>层次2：长期记忆（User Profile Memory）</strong></p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-comment"># 用户级记忆：跨任务的偏好积累</span>
user_memory = {
    <span class="hljs-string">"recruiter_id"</span>: <span class="hljs-string">"12345"</span>,
    <span class="hljs-string">"preference_model"</span>: {
        <span class="hljs-string">"must_have_signals"</span>: [<span class="hljs-string">"大厂背景"</span>, <span class="hljs-string">"开源贡献"</span>],
        <span class="hljs-string">"red_flags"</span>: [<span class="hljs-string">"频繁跳槽"</span>, <span class="hljs-string">"技能描述模糊"</span>],
    },
    <span class="hljs-string">"historical_success"</span>: {
        <span class="hljs-string">"hired_profiles"</span>: [...],
        <span class="hljs-string">"common_patterns"</span>: [<span class="hljs-string">"平均5年经验"</span>, <span class="hljs-string">"70%有硕士学历"</span>]
    }
}
</code></pre>
<p><strong>层次3：组织记忆（Organization Memory）</strong></p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-comment"># 组织级记忆：公司层面的招聘知识</span>
org_memory = {
    <span class="hljs-string">"company_id"</span>: <span class="hljs-string">"linkedin"</span>,
    <span class="hljs-string">"culture_fit_signals"</span>: [<span class="hljs-string">"协作导向"</span>, <span class="hljs-string">"数据驱动"</span>],
    <span class="hljs-string">"compliance_rules"</span>: [<span class="hljs-string">"必须考虑多样性"</span>, <span class="hljs-string">"薪资范围限制"</span>]
}
</code></pre>
<h3 data-id="heading-17">5.3 跟RAG有啥区别？</h3>
<p>很多人会问：这不就是RAG吗？</p>
<p><strong>真不一样。</strong></p>



































<table><thead><tr><th>维度</th><th>RAG</th><th>Experiential Memory</th></tr></thead><tbody><tr><td><strong>存的是啥</strong></td><td>原始文档/对话</td><td>提炼后的偏好模型</td></tr><tr><td><strong>怎么找</strong></td><td>向量相似度匹配</td><td>结构化查询+模式匹配</td></tr><tr><td><strong>怎么更新</strong></td><td>手动更新文档</td><td>自动从交互中学习</td></tr><tr><td><strong>怎么用</strong></td><td>塞进Prompt当上下文</td><td>直接影响Agent决策逻辑</td></tr><tr><td><strong>个性化程度</strong></td><td>低</td><td>高（同样问题，不同用户不同结果）</td></tr></tbody></table>
<p><strong>一句话总结：Experiential Memory的核心是"学习"，不是"存储"。</strong></p>
<hr/>
<h2 data-id="heading-18">六、Human-in-the-Loop：为什么LinkedIn只自动化80%？</h2>
<h3 data-id="heading-19">6.1 不是做不到100%，是故意不做</h3>
<p>LinkedIn官方说Hiring Assistant可以自动化**80%**的招聘流程。</p>
<p>为什么不是100%？技术上做不到吗？</p>
<p><strong>不是做不到，是故意不做。</strong></p>
<pre><code class="hljs">┌─────────────────────────────────────────────────────────────┐
│                    任务自动化程度分层                         │
├─────────────────────────────────────────────────────────────┤
│  全自动（无需人工）                                          │
│  ├─ JD格式化和优化、候选人初筛、消息模板生成                  │
│                                                              │
│  半自动（AI建议 + 人工确认）                                 │
│  ├─ 候选人推荐排序、InMail内容定制、面试安排建议              │
│                                                              │
│  人工主导（AI辅助）                                          │
│  ├─ 最终录用决策、薪资谈判、文化匹配判断                      │
└─────────────────────────────────────────────────────────────┘
</code></pre>
<p><strong>主要有以下三个原因：</strong></p>





















<table><thead><tr><th>原因</th><th>说明</th></tr></thead><tbody><tr><td><strong>降低风险</strong></td><td>招聘是高风险决策，招错一个人可能损失几十万</td></tr><tr><td><strong>建立信任</strong></td><td>让用户先观察AI决策质量，信任建立后再逐步放开</td></tr><tr><td><strong>持续学习</strong></td><td>人工确认/拒绝的动作本身就是训练数据</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-20">七、写在最后</h2>
<p>LinkedIn Hiring Assistant不是最炫酷的AI产品，但它可能是<strong>最值得抄的</strong>。</p>
<p>它告诉我们一个朴素的道理：<strong>工业级AI系统的核心不是模型多强，而是架构多稳</strong>。</p>
<p><strong>4条核心原则，建议收藏：</strong></p>

























<table><thead><tr><th>原则</th><th>一句话总结</th></tr></thead><tbody><tr><td>Agent是架构范式</td><td>状态管理、异步执行、完整生命周期，一个都不能少</td></tr><tr><td>记忆系统是壁垒</td><td>用户偏好建模才是护城河，不是RAG</td></tr><tr><td>Human-in-the-Loop是设计</td><td>100%自动化不是目标，可信赖的自动化才是</td></tr><tr><td>生产化需要工程思维</td><td>幂等、状态机、异步、可观测，缺一不可</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-21">源码获取</h2>
<p>我把这套架构用LangGraph完整复现了一遍，代码已开源：</p>
<p><strong>GitHub：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fzhuzhaoyun%2Flinkedin-hiring-assistant-py" target="_blank" title="https://github.com/zhuzhaoyun/linkedin-hiring-assistant-py" ref="nofollow noopener noreferrer">github.com/zhuzhaoyun/…</a></p>
<p>包含：</p>
<ul>
<li>完整的Supervisor Multi-Agent工作流</li>
<li>Experiential Memory实现</li>
<li>Human-in-the-Loop中断恢复</li>
<li>可直接运行的Demo</li>
</ul>
<hr/>
<p><strong>关于我们</strong></p>
<p>我们是一家面向 AEC 行业的 AI 创业公司，专注企业级AI应用系统的设计与落地。如果你在做类似的AI应用工程化，或者对垂直行业AI落地感兴趣，欢迎评论区讨论或添加联系方式沟通。</p>
<p><strong>微信：Damondut</strong></p>
<p>本文使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fmarkdown.com.cn" target="_blank" title="https://markdown.com.cn" ref="nofollow noopener noreferrer">markdown.com.cn</a> 排版</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[isexe@3.1.1源码阅读]]></title>    <link>https://juejin.cn/post/7599155566298267691</link>    <guid>https://juejin.cn/post/7599155566298267691</guid>    <pubDate>2026-01-26T10:27:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599155566298267691" data-draft-id="7599237603975839787" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="isexe@3.1.1源码阅读"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-26T10:27:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="米丘"/> <meta itemprop="url" content="https://juejin.cn/user/1611227736052074"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            isexe@3.1.1源码阅读
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1611227736052074/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    米丘
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T10:27:06.000Z" title="Mon Jan 26 2026 10:27:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><em>发布日期 2023 年 8 月 3 日</em></p>
<p><code>isexe</code> 是<strong>跨平台检查文件是否为「可执行文件」的专用工具包</strong>，核心解决「Windows 和 Unix 系统判断可执行文件的规则完全不同」的问题。</p>
<p>unix系统根据文件权限判断；window系统根据文件扩展名判断。</p>
<h2 data-id="heading-0">入口文件 index.js</h2>
<p><code>isexe-3.1.1/src/index.ts</code></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> posix <span class="hljs-keyword">from</span> <span class="hljs-string">'./posix.js'</span> <span class="hljs-comment">// 导入 POSIX 系统（Linux/macOS 等）的实现</span>
<span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> win32 <span class="hljs-keyword">from</span> <span class="hljs-string">'./win32.js'</span> <span class="hljs-comment">// 导入 Windows 系统的实现</span>
<span class="hljs-keyword">export</span> * <span class="hljs-keyword">from</span> <span class="hljs-string">'./options.js'</span> <span class="hljs-comment">// 导出配置选项类型（如 IsexeOptions）</span>
<span class="hljs-keyword">export</span> { win32, posix }  <span class="hljs-comment">// 允许直接访问特定平台的实现</span>

<span class="hljs-keyword">const</span> platform = process.<span class="hljs-property">env</span>.<span class="hljs-property">_ISEXE_TEST_PLATFORM_</span> || process.<span class="hljs-property">platform</span>
<span class="hljs-keyword">const</span> impl = platform === <span class="hljs-string">'win32'</span> ? win32 : posix

<span class="hljs-comment">/**
 * Determine whether a path is executable on the current platform.
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> isexe = impl.<span class="hljs-property">isexe</span>
<span class="hljs-comment">/**
 * Synchronously determine whether a path is executable on the
 * current platform.
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> sync = impl.<span class="hljs-property">sync</span>

</code></pre>
<h2 data-id="heading-1">posix.isexe(异步)</h2>
<p><code>isexe-3.1.1/src/posix.ts</code></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> isexe = <span class="hljs-keyword">async</span> (
  <span class="hljs-attr">path</span>: string,  <span class="hljs-comment">// 要检查的文件路径（比如 "/usr/bin/node" 或 "C:\\node.exe"）</span>
  <span class="hljs-attr">options</span>: <span class="hljs-title class_">IsexeOptions</span> = {}  <span class="hljs-comment">// 配置项，默认空对象</span>
): <span class="hljs-title class_">Promise</span>&lt;boolean&gt; =&gt; {
  
  <span class="hljs-keyword">const</span> { ignoreErrors = <span class="hljs-literal">false</span> } = options

  <span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// await stat(path)：获取文件状态</span>
    <span class="hljs-comment">// checkStat(statResult, options)：判断是否可执行</span>
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">checkStat</span>(<span class="hljs-keyword">await</span> <span class="hljs-title function_">stat</span>(path), options)
  } <span class="hljs-keyword">catch</span> (e) {
    <span class="hljs-comment">// 把错误转为 Node.js 标准错误类型（带错误码）</span>
    <span class="hljs-keyword">const</span> er = e <span class="hljs-keyword">as</span> <span class="hljs-title class_">NodeJS</span>.<span class="hljs-property">ErrnoException</span>
    <span class="hljs-keyword">if</span> (ignoreErrors || er.<span class="hljs-property">code</span> === <span class="hljs-string">'EACCES'</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
    <span class="hljs-keyword">throw</span> er <span class="hljs-comment">// 非预期错误，向上抛出</span>
  }
}
</code></pre>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Stats</span>, statSync } <span class="hljs-keyword">from</span> <span class="hljs-string">'fs'</span>
<span class="hljs-keyword">import</span> { stat } <span class="hljs-keyword">from</span> <span class="hljs-string">'fs/promises'</span>
</code></pre>
<h3 data-id="heading-2">checkStat</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> <span class="hljs-title function_">checkStat</span> = (<span class="hljs-params">stat: Stats, options: IsexeOptions</span>) =&gt;
  stat.<span class="hljs-title function_">isFile</span>() &amp;&amp; <span class="hljs-title function_">checkMode</span>(stat, options)

</code></pre>
<h3 data-id="heading-3">checkMode</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> <span class="hljs-title function_">checkMode</span> = (<span class="hljs-params">
  <span class="hljs-comment">// 文件的 Stats 对象（通常由 fs.stat 或 fs.lstat 获取）</span>
  <span class="hljs-comment">// 包含文件的权限位（mode）、所有者 ID（uid）、所属组 ID（gid）等元数据。</span>
  stat: Stats, 
  <span class="hljs-comment">// 配置对象，允许自定义用户 ID（uid）、组 ID（gid）、用户所属组列表（groups），默认使用当前进程的用户信息。</span>
  options: IsexeOptions
</span>) =&gt; {
  <span class="hljs-comment">// 1、获取用户与组信息</span>
  <span class="hljs-comment">// 当前用户的 ID（优先使用 options.uid，否则调用 process.getuid() 获取当前进程的用户 ID）。</span>
  <span class="hljs-keyword">const</span> myUid = options.<span class="hljs-property">uid</span> ?? process.<span class="hljs-property">getuid</span>?.()
  <span class="hljs-comment">// 当前用户所属的组 ID 列表（优先使用 options.groups，否则调用 process.getgroups() 获取）。</span>
  <span class="hljs-keyword">const</span> myGroups = options.<span class="hljs-property">groups</span> ?? process.<span class="hljs-property">getgroups</span>?.() ?? []
  <span class="hljs-comment">// 当前用户的主组 ID（优先使用 options.gid，否则调用 process.getgid()，或从 myGroups 取第一个组 ID）。</span>
  <span class="hljs-keyword">const</span> myGid = options.<span class="hljs-property">gid</span> ?? process.<span class="hljs-property">getgid</span>?.() ?? myGroups[<span class="hljs-number">0</span>]
  <span class="hljs-comment">// 若无法获取 myUid 或 myGid，抛出错误（权限判断依赖这些信息）</span>
  <span class="hljs-keyword">if</span> (myUid === <span class="hljs-literal">undefined</span> || myGid === <span class="hljs-literal">undefined</span>) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'cannot get uid or gid'</span>)
  }

  <span class="hljs-comment">// 2、构建用户所属组集合</span>
  <span class="hljs-keyword">const</span> groups = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>([myGid, ...myGroups])

  <span class="hljs-comment">// 3、解析文件权限位与归属信息</span>
  <span class="hljs-keyword">const</span> mod = stat.<span class="hljs-property">mode</span> <span class="hljs-comment">// 文件的权限位（整数，如 0o755 表示 rwxr-xr-x）</span>
  <span class="hljs-keyword">const</span> uid = stat.<span class="hljs-property">uid</span> <span class="hljs-comment">// 文件所有者的用户 ID</span>
  <span class="hljs-keyword">const</span> gid = stat.<span class="hljs-property">gid</span> <span class="hljs-comment">// 文件所属组的组 ID</span>

  <span class="hljs-comment">// 4、定义权限位掩码</span>
  <span class="hljs-comment">// 八进制 100 → 十进制 64 → 对应所有者的执行权限位（x）</span>
  <span class="hljs-keyword">const</span> u = <span class="hljs-built_in">parseInt</span>(<span class="hljs-string">'100'</span>, <span class="hljs-number">8</span>)
  <span class="hljs-comment">// 八进制 010 → 十进制 8 → 对应所属组的执行权限位（x）</span>
  <span class="hljs-keyword">const</span> g = <span class="hljs-built_in">parseInt</span>(<span class="hljs-string">'010'</span>, <span class="hljs-number">8</span>)
  <span class="hljs-comment">// 八进制 001 → 十进制 1 → 对应其他用户的执行权限位（x）</span>
  <span class="hljs-keyword">const</span> o = <span class="hljs-built_in">parseInt</span>(<span class="hljs-string">'001'</span>, <span class="hljs-number">8</span>)
  <span class="hljs-comment">// 所有者和所属组的执行权限位掩码（64 | 8 = 72）</span>
  <span class="hljs-keyword">const</span> ug = u | g

  <span class="hljs-comment">// 5、权限判断逻辑</span>
  <span class="hljs-keyword">return</span> !!(
    mod &amp; o || <span class="hljs-comment">// 1. 其他用户有执行权限</span>
    (mod &amp; g &amp;&amp; groups.<span class="hljs-title function_">has</span>(gid)) || <span class="hljs-comment">// 2. 所属组有执行权限，且当前用户属于该组</span>
    (mod &amp; u &amp;&amp; uid === myUid) || <span class="hljs-comment">// 3. 所有者有执行权限，且当前用户是所有者</span>
    (mod &amp; ug &amp;&amp; myUid === <span class="hljs-number">0</span>)  <span class="hljs-comment">// 4. 所有者或组有执行权限，且当前用户是 root（UID=0）</span>
  )
}
</code></pre>
<p><code>mod</code> <strong>（权限位）</strong> ：Unix 系统中用 9 位二进制表示文件权限（分为所有者、所属组、其他用户三类，每类 3 位，分别控制读 <code>r</code>、写 <code>w</code>、执行 <code>x</code> 权限）。例如 <code>0o755</code> 对应二进制 <code>111 101 101</code>，表示：</p>
<ul>
<li>所有者（<code>u</code>）：可读、可写、可执行（<code>rwx</code>）。</li>
<li>所属组（<code>g</code>）：可读、可执行（<code>r-x</code>）。</li>
<li>其他用户（<code>o</code>）：可读、可执行（<code>r-x</code>）。</li>
</ul>
<h2 data-id="heading-4">posix.sync (同步)</h2>
<p><code>isexe-3.1.1/src/posix.ts</code></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> sync = (
  <span class="hljs-attr">path</span>: string,
  <span class="hljs-attr">options</span>: <span class="hljs-title class_">IsexeOptions</span> = {}
): <span class="hljs-function"><span class="hljs-params">boolean</span> =&gt;</span> {
  
  <span class="hljs-keyword">const</span> { ignoreErrors = <span class="hljs-literal">false</span> } = options
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">checkStat</span>(<span class="hljs-title function_">statSync</span>(path), options)
    
  } <span class="hljs-keyword">catch</span> (e) {
    <span class="hljs-keyword">const</span> er = e <span class="hljs-keyword">as</span> <span class="hljs-title class_">NodeJS</span>.<span class="hljs-property">ErrnoException</span>
    <span class="hljs-keyword">if</span> (ignoreErrors || er.<span class="hljs-property">code</span> === <span class="hljs-string">'EACCES'</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
    <span class="hljs-keyword">throw</span> er
  }
}
</code></pre>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Stats</span>, statSync } <span class="hljs-keyword">from</span> <span class="hljs-string">'fs'</span>
<span class="hljs-keyword">import</span> { stat } <span class="hljs-keyword">from</span> <span class="hljs-string">'fs/promises'</span>
</code></pre>
<h2 data-id="heading-5">win32.isexe （异步）</h2>
<p><code>isexe-3.1.1/src/win32.ts</code></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> isexe = <span class="hljs-keyword">async</span> (
  <span class="hljs-attr">path</span>: string,
  <span class="hljs-attr">options</span>: <span class="hljs-title class_">IsexeOptions</span> = {}
): <span class="hljs-title class_">Promise</span>&lt;boolean&gt; =&gt; {
  
  <span class="hljs-keyword">const</span> { ignoreErrors = <span class="hljs-literal">false</span> } = options
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">checkStat</span>(<span class="hljs-keyword">await</span> <span class="hljs-title function_">stat</span>(path), path, options)
  } <span class="hljs-keyword">catch</span> (e) {
    <span class="hljs-keyword">const</span> er = e <span class="hljs-keyword">as</span> <span class="hljs-title class_">NodeJS</span>.<span class="hljs-property">ErrnoException</span>
    <span class="hljs-keyword">if</span> (ignoreErrors || er.<span class="hljs-property">code</span> === <span class="hljs-string">'EACCES'</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
    <span class="hljs-keyword">throw</span> er
  }
}
</code></pre>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Stats</span>, statSync } <span class="hljs-keyword">from</span> <span class="hljs-string">'fs'</span>
<span class="hljs-keyword">import</span> { stat } <span class="hljs-keyword">from</span> <span class="hljs-string">'fs/promises'</span>
</code></pre>
<h3 data-id="heading-6">checkStat</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> <span class="hljs-title function_">checkStat</span> = (<span class="hljs-params">stat: Stats, path: string, options: IsexeOptions</span>) =&gt;
  stat.<span class="hljs-title function_">isFile</span>() &amp;&amp; <span class="hljs-title function_">checkPathExt</span>(path, options)
</code></pre>
<h3 data-id="heading-7">checkPathExt</h3>
<p><code>isexe-3.1.1/src/win32.ts</code></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> <span class="hljs-title function_">checkPathExt</span> = (<span class="hljs-params">path: string, options: IsexeOptions</span>) =&gt; {

  <span class="hljs-comment">// 获取可执行扩展名列表</span>
  <span class="hljs-keyword">const</span> { pathExt = process.<span class="hljs-property">env</span>.<span class="hljs-property">PATHEXT</span> || <span class="hljs-string">''</span> } = options

  <span class="hljs-keyword">const</span> peSplit = pathExt.<span class="hljs-title function_">split</span>(<span class="hljs-string">';'</span>)
  <span class="hljs-comment">// 特殊情况处理：空扩展名</span>
  <span class="hljs-comment">// 空扩展名通常表示 “任何文件都视为可执行”，这是一种特殊配置</span>
  <span class="hljs-keyword">if</span> (peSplit.<span class="hljs-title function_">indexOf</span>(<span class="hljs-string">''</span>) !== -<span class="hljs-number">1</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
  }

  <span class="hljs-comment">// 检查文件扩展名是否匹配</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; peSplit.<span class="hljs-property">length</span>; i++) {
    <span class="hljs-comment">// 转小写：避免大小写问题（比如.EXE和.exe视为同一个）</span>
    <span class="hljs-keyword">const</span> p = peSplit[i].<span class="hljs-title function_">toLowerCase</span>()
    <span class="hljs-comment">// 截取文件路径的最后N个字符（N是当前扩展名p的长度），也转小写</span>
    <span class="hljs-keyword">const</span> ext = path.<span class="hljs-title function_">substring</span>(path.<span class="hljs-property">length</span> - p.<span class="hljs-property">length</span>).<span class="hljs-title function_">toLowerCase</span>()

    <span class="hljs-comment">// 匹配条件：扩展名非空 + 文件扩展名和列表中的扩展名完全一致</span>
    <span class="hljs-keyword">if</span> (p &amp;&amp; ext === p) {
      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
    }
  }
  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
}
</code></pre>
<h2 data-id="heading-8">win32.sync（同步）</h2>
<p><code>isexe-3.1.1/src/win32.ts</code></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> sync = (
  <span class="hljs-attr">path</span>: string,
  <span class="hljs-attr">options</span>: <span class="hljs-title class_">IsexeOptions</span> = {}
): <span class="hljs-function"><span class="hljs-params">boolean</span> =&gt;</span> {
  
  <span class="hljs-keyword">const</span> { ignoreErrors = <span class="hljs-literal">false</span> } = options
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">checkStat</span>(<span class="hljs-title function_">statSync</span>(path), path, options)
    
  } <span class="hljs-keyword">catch</span> (e) {
    <span class="hljs-keyword">const</span> er = e <span class="hljs-keyword">as</span> <span class="hljs-title class_">NodeJS</span>.<span class="hljs-property">ErrnoException</span>
    <span class="hljs-keyword">if</span> (ignoreErrors || er.<span class="hljs-property">code</span> === <span class="hljs-string">'EACCES'</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
    <span class="hljs-keyword">throw</span> er
  }
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【LeetCode Hot100 刷题日记 （76/100）】295. 数据流的中位数 —— 双堆（优先队列）维护动态中位数 🧠]]></title>    <link>https://juejin.cn/post/7599155566298251307</link>    <guid>https://juejin.cn/post/7599155566298251307</guid>    <pubDate>2026-01-26T10:24:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599155566298251307" data-draft-id="7599155566298234923" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【LeetCode Hot100 刷题日记 （76/100）】295. 数据流的中位数 —— 双堆（优先队列）维护动态中位数 🧠"/> <meta itemprop="keywords" content="算法,面试,程序员"/> <meta itemprop="datePublished" content="2026-01-26T10:24:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Jing_Rainbow"/> <meta itemprop="url" content="https://juejin.cn/user/1285809519198256"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【LeetCode Hot100 刷题日记 （76/100）】295. 数据流的中位数 —— 双堆（优先队列）维护动态中位数 🧠
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1285809519198256/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Jing_Rainbow
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T10:24:00.000Z" title="Mon Jan 26 2026 10:24:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>📌 题目链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fleetcode.cn%2Fproblems%2Ffind-median-from-data-stream%2Fdescription%2F%3FenvType%3Dstudy-plan-v2%26envId%3Dtop-100-liked" target="_blank" title="https://leetcode.cn/problems/find-median-from-data-stream/description/?envType=study-plan-v2&amp;envId=top-100-liked" ref="nofollow noopener noreferrer">295. 数据流的中位数 - 力扣（LeetCode）</a></p>
<p>🔍 难度：<strong>困难</strong> | 🏷️ 标签：<strong>设计、堆（优先队列）、数据流、双指针</strong></p>
<p>⏱️ 目标时间复杂度：<strong>addNum: O(log n)，findMedian: O(1)</strong></p>
<p>💾 空间复杂度：<strong>O(n)</strong></p>
</blockquote>
<hr/>
<h2 data-id="heading-0">🎯 问题核心与面试价值</h2>
<p>在<strong>实时数据处理系统</strong>（如股票价格监控、在线评分系统、网络流量分析）中，我们经常需要动态维护一个不断增长的数据集合，并<strong>高效查询当前中位数</strong>。这道题考察的是：</p>
<ul>
<li><strong>如何用两个堆（优先队列）巧妙维护有序性</strong></li>
<li><strong>对“中位数”定义的精准理解（奇偶长度差异）</strong></li>
<li><strong>动态平衡思想</strong>（类似 AVL 树的旋转思想）</li>
<li><strong>C++ STL 中 <code>priority_queue</code> 的自定义比较器使用</strong></li>
</ul>
<p>这是<strong>高频系统设计+算法结合题</strong>，在 Google、Amazon、Meta 等大厂面试中多次出现，尤其适合考察候选人对<strong>数据结构组合使用</strong>的能力。</p>
<hr/>
<h2 data-id="heading-1">🧩 题目分析</h2>
<p>我们需要设计一个类 <code>MedianFinder</code>，支持两种操作：</p>
<ol>
<li><code>addNum(int num)</code>：向数据流中添加一个整数；</li>
<li><code>findMedian()</code>：返回当前所有数的中位数。</li>
</ol>
<p>关键约束：</p>
<ul>
<li>数据是<strong>动态流入</strong>的，不能预先知道全部数据；</li>
<li>每次 <code>findMedian</code> 必须<strong>高效</strong>（理想 O(1)）；</li>
<li>数据规模可达 <strong>5 × 10⁴</strong> 次操作，暴力排序（O(n log n) 每次）会超时 ❌。</li>
</ul>
<blockquote>
<p>✅ 正确思路：<strong>不显式维护整个有序数组，而是用两个堆分别维护“较小的一半”和“较大的一半”</strong> 。</p>
</blockquote>
<hr/>
<h2 data-id="heading-2">🧠 核心算法及代码讲解：双堆（Two Heaps）法</h2>
<h3 data-id="heading-3">📌 算法思想</h3>
<p>我们维护两个堆：</p>
<ul>
<li><strong><code>queMin</code></strong>：<strong>最大堆</strong>（C++ 默认 <code>priority_queue&lt;int&gt;</code> 是最大堆），存储<strong>较小的一半数字</strong>，堆顶是这部分的最大值；</li>
<li><strong><code>queMax</code></strong>：<strong>最小堆</strong>（用 <code>greater&lt;int&gt;</code> 实现），存储<strong>较大的一半数字</strong>，堆顶是这部分的最小值。</li>
</ul>
<blockquote>
<p>💡 <strong>不变量（Invariant）</strong> ：</p>
<ul>
<li><code>queMin.size() == queMax.size()</code> 或 <code>queMin.size() == queMax.size() + 1</code></li>
<li>所有 <code>queMin</code> 中的元素 ≤ 所有 <code>queMax</code> 中的元素</li>
</ul>
</blockquote>
<p>这样，中位数就是：</p>
<ul>
<li>若总个数为奇数 → <code>queMin.top()</code>（因为 <code>queMin</code> 多一个）</li>
<li>若为偶数 → <code>(queMin.top() + queMax.top()) / 2.0</code></li>
</ul>
<h3 data-id="heading-4">🔄 插入逻辑（关键！）</h3>
<p>当插入新数字 <code>num</code> 时：</p>
<ol>
<li>
<p><strong>若 <code>num ≤ queMin.top()</code></strong> → 应放入 <code>queMin</code></p>
<ul>
<li>但插入后可能破坏 size 不变量（<code>queMin</code> 比 <code>queMax</code> 多超过 1 个）</li>
<li>→ 把 <code>queMin</code> 的堆顶（最大值）移到 <code>queMax</code></li>
</ul>
</li>
<li>
<p><strong>否则</strong> → 放入 <code>queMax</code></p>
<ul>
<li>但若 <code>queMax</code> 比 <code>queMin</code> 大 → 把 <code>queMax</code> 的堆顶（最小值）移到 <code>queMin</code></li>
</ul>
</li>
</ol>
<blockquote>
<p>✅ 这样始终保证 <code>queMin</code> 存“左半部分”，<code>queMax</code> 存“右半部分”，且大小差 ≤1。</p>
</blockquote>
<h3 data-id="heading-5">💻 C++ 代码详解（带行注释）</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MedianFinder</span> {
<span class="hljs-keyword">public</span>:
    <span class="hljs-comment">// queMin: 最大堆，存较小的一半；queMax: 最小堆，存较大的一半</span>
    priority_queue&lt;<span class="hljs-type">int</span>, vector&lt;<span class="hljs-type">int</span>&gt;, less&lt;<span class="hljs-type">int</span>&gt;&gt; queMin;      <span class="hljs-comment">// 默认就是 less，可省略</span>
    priority_queue&lt;<span class="hljs-type">int</span>, vector&lt;<span class="hljs-type">int</span>&gt;, greater&lt;<span class="hljs-type">int</span>&gt;&gt; queMax;   <span class="hljs-comment">// greater&lt;int&gt; 实现最小堆</span>

    <span class="hljs-built_in">MedianFinder</span>() {}

    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">addNum</span><span class="hljs-params">(<span class="hljs-type">int</span> num)</span> </span>{
        <span class="hljs-comment">// 情况1：queMin 为空（首次插入）或 num &lt;= queMin 的最大值</span>
        <span class="hljs-keyword">if</span> (queMin.<span class="hljs-built_in">empty</span>() || num &lt;= queMin.<span class="hljs-built_in">top</span>()) {
            queMin.<span class="hljs-built_in">push</span>(num);  <span class="hljs-comment">// 先加入左半部分</span>
            <span class="hljs-comment">// 检查是否左半部分比右半部分多出超过1个</span>
            <span class="hljs-keyword">if</span> (queMax.<span class="hljs-built_in">size</span>() + <span class="hljs-number">1</span> &lt; queMin.<span class="hljs-built_in">size</span>()) {
                queMax.<span class="hljs-built_in">push</span>(queMin.<span class="hljs-built_in">top</span>());  <span class="hljs-comment">// 把左半部分的最大值移到右边</span>
                queMin.<span class="hljs-built_in">pop</span>();
            }
        } 
        <span class="hljs-comment">// 情况2：num &gt; queMin.top()，应加入右半部分</span>
        <span class="hljs-keyword">else</span> {
            queMax.<span class="hljs-built_in">push</span>(num);
            <span class="hljs-comment">// 注意：这里只允许 queMin 比 queMax 多1，不允许 queMax 更大！</span>
            <span class="hljs-keyword">if</span> (queMax.<span class="hljs-built_in">size</span>() &gt; queMin.<span class="hljs-built_in">size</span>()) {
                queMin.<span class="hljs-built_in">push</span>(queMax.<span class="hljs-built_in">top</span>());  <span class="hljs-comment">// 把右半部分的最小值移到左边</span>
                queMax.<span class="hljs-built_in">pop</span>();
            }
        }
    }

    <span class="hljs-function"><span class="hljs-type">double</span> <span class="hljs-title">findMedian</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-comment">// 奇数个：queMin 多一个，中位数是 queMin.top()</span>
        <span class="hljs-keyword">if</span> (queMin.<span class="hljs-built_in">size</span>() &gt; queMax.<span class="hljs-built_in">size</span>()) {
            <span class="hljs-keyword">return</span> queMin.<span class="hljs-built_in">top</span>();
        }
        <span class="hljs-comment">// 偶数个：取两个堆顶平均</span>
        <span class="hljs-keyword">return</span> (queMin.<span class="hljs-built_in">top</span>() + queMax.<span class="hljs-built_in">top</span>()) / <span class="hljs-number">2.0</span>;
    }
};
</code></pre>
<blockquote>
<p>🔍 <strong>为什么 <code>queMin</code> 允许多一个，而 <code>queMax</code> 不允许？</strong><br/>
这是设计选择！统一让 <code>queMin</code> 承担“多一个”的角色，简化逻辑。也可反过来，但需保持一致。</p>
</blockquote>
<hr/>
<h2 data-id="heading-6">🧭 解题思路（分步拆解）</h2>
<ol>
<li>
<p><strong>明确目标</strong>：动态维护中位数，避免每次排序。</p>
</li>
<li>
<p><strong>选择数据结构</strong>：</p>
<ul>
<li>数组？→ 插入 O(n)，排序 O(n log n) → ❌</li>
<li>平衡二叉搜索树？→ 可行，但实现复杂（如 <code>multiset</code> + 双指针，见官方方法二）</li>
<li><strong>双堆</strong> → 插入 O(log n)，查询 O(1) → ✅ 最优</li>
</ul>
</li>
<li>
<p><strong>设计不变量</strong>：</p>
<ul>
<li>左堆（最大堆）存小的一半，右堆（最小堆）存大的一半</li>
<li>左堆大小 ≥ 右堆大小，且最多多1</li>
</ul>
</li>
<li>
<p><strong>处理插入</strong>：</p>
<ul>
<li>先按值决定放哪边</li>
<li>再调整堆大小以维持不变量</li>
</ul>
</li>
<li>
<p><strong>查询中位数</strong>：直接取堆顶，按奇偶判断</p>
</li>
</ol>
<hr/>
<h2 data-id="heading-7">📊 算法分析</h2>





























<table><thead><tr><th>操作</th><th>时间复杂度</th><th>空间复杂度</th><th>说明</th></tr></thead><tbody><tr><td><code>addNum</code></td><td>O(log n)</td><td>O(n)</td><td>堆插入+可能的一次弹出</td></tr><tr><td><code>findMedian</code></td><td>O(1)</td><td>—</td><td>直接访问堆顶</td></tr><tr><td>总体</td><td>—</td><td>O(n)</td><td>存储所有数字</td></tr></tbody></table>
<blockquote>
<p>✅ 满足题目要求（5e4 次操作完全可行）</p>
</blockquote>
<hr/>
<h2 data-id="heading-8">💡 面试延伸 &amp; 进阶思考</h2>
<h3 data-id="heading-9">Q1：为什么不用一个堆？</h3>
<blockquote>
<p>A：单个堆无法直接获取中位数。最大堆只能得最大值，最小堆只能得最小值。</p>
</blockquote>
<h3 data-id="heading-10">Q2：能否用 <code>multiset</code> + 双指针？</h3>
<blockquote>
<p>A：可以（官方方法二），但：</p>
<ul>
<li><code>multiset</code> 插入 O(log n)，但移动迭代器需小心边界</li>
<li>实际性能可能不如双堆（常数更大）</li>
<li><strong>双堆更简洁、更常用</strong></li>
</ul>
</blockquote>
<h3 data-id="heading-11">Q3：如果数据范围有限（如 0~100）？</h3>
<blockquote>
<p>A：可用<strong>计数排序 + 双指针</strong>（桶排序思想）：</p>
<ul>
<li>开数组 <code>cnt[101]</code> 记录每个数出现次数</li>
<li>维护总数量 <code>total</code></li>
<li>查询中位数时从 0 开始累加，找到第 <code>total/2</code> 和 <code>total/2+1</code> 个数</li>
<li><strong>时间复杂度：addNum O(1)，findMedian O(100)=O(1)</strong> → 极优！</li>
</ul>
</blockquote>
<h3 data-id="heading-12">Q4：如何扩展到求第 k 小/大元素？</h3>
<blockquote>
<p>A：可用 <strong>QuickSelect（期望 O(n)）</strong> ，但不支持动态插入。<br/>
动态场景下可用 <strong>Order Statistic Tree（GNU pbds）</strong> ，但非标准库。</p>
</blockquote>
<hr/>
<h2 data-id="heading-13">💻 完整可运行代码</h2>
<h3 data-id="heading-14">C++ 版本</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;bits/stdc++.h&gt;</span></span>
<span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;
<span class="hljs-keyword">using</span> ll = <span class="hljs-type">long</span> <span class="hljs-type">long</span>;

<span class="hljs-keyword">class</span> <span class="hljs-title class_">MedianFinder</span> {
<span class="hljs-keyword">public</span>:
    priority_queue&lt;<span class="hljs-type">int</span>, vector&lt;<span class="hljs-type">int</span>&gt;, less&lt;<span class="hljs-type">int</span>&gt;&gt; queMin;
    priority_queue&lt;<span class="hljs-type">int</span>, vector&lt;<span class="hljs-type">int</span>&gt;, greater&lt;<span class="hljs-type">int</span>&gt;&gt; queMax;

    <span class="hljs-built_in">MedianFinder</span>() {}

    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">addNum</span><span class="hljs-params">(<span class="hljs-type">int</span> num)</span> </span>{
        <span class="hljs-keyword">if</span> (queMin.<span class="hljs-built_in">empty</span>() || num &lt;= queMin.<span class="hljs-built_in">top</span>()) {
            queMin.<span class="hljs-built_in">push</span>(num);
            <span class="hljs-keyword">if</span> (queMax.<span class="hljs-built_in">size</span>() + <span class="hljs-number">1</span> &lt; queMin.<span class="hljs-built_in">size</span>()) {
                queMax.<span class="hljs-built_in">push</span>(queMin.<span class="hljs-built_in">top</span>());
                queMin.<span class="hljs-built_in">pop</span>();
            }
        } <span class="hljs-keyword">else</span> {
            queMax.<span class="hljs-built_in">push</span>(num);
            <span class="hljs-keyword">if</span> (queMax.<span class="hljs-built_in">size</span>() &gt; queMin.<span class="hljs-built_in">size</span>()) {
                queMin.<span class="hljs-built_in">push</span>(queMax.<span class="hljs-built_in">top</span>());
                queMax.<span class="hljs-built_in">pop</span>();
            }
        }
    }

    <span class="hljs-function"><span class="hljs-type">double</span> <span class="hljs-title">findMedian</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">if</span> (queMin.<span class="hljs-built_in">size</span>() &gt; queMax.<span class="hljs-built_in">size</span>()) {
            <span class="hljs-keyword">return</span> queMin.<span class="hljs-built_in">top</span>();
        }
        <span class="hljs-keyword">return</span> (queMin.<span class="hljs-built_in">top</span>() + queMax.<span class="hljs-built_in">top</span>()) / <span class="hljs-number">2.0</span>;
    }
};

<span class="hljs-comment">// 测试</span>
<span class="hljs-function"><span class="hljs-type">signed</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span>{
    ios::<span class="hljs-built_in">sync_with_stdio</span>(<span class="hljs-literal">false</span>);
    cin.<span class="hljs-built_in">tie</span>(<span class="hljs-literal">nullptr</span>);
    cout.<span class="hljs-built_in">tie</span>(<span class="hljs-literal">nullptr</span>);

    MedianFinder medianFinder;
    medianFinder.<span class="hljs-built_in">addNum</span>(<span class="hljs-number">1</span>);    <span class="hljs-comment">// arr = [1]</span>
    medianFinder.<span class="hljs-built_in">addNum</span>(<span class="hljs-number">2</span>);    <span class="hljs-comment">// arr = [1, 2]</span>
    cout &lt;&lt; fixed &lt;&lt; <span class="hljs-built_in">setprecision</span>(<span class="hljs-number">5</span>) &lt;&lt; medianFinder.<span class="hljs-built_in">findMedian</span>() &lt;&lt; <span class="hljs-string">"\n"</span>; <span class="hljs-comment">// 输出 1.5</span>
    medianFinder.<span class="hljs-built_in">addNum</span>(<span class="hljs-number">3</span>);    <span class="hljs-comment">// arr = [1, 2, 3]</span>
    cout &lt;&lt; fixed &lt;&lt; <span class="hljs-built_in">setprecision</span>(<span class="hljs-number">5</span>) &lt;&lt; medianFinder.<span class="hljs-built_in">findMedian</span>() &lt;&lt; <span class="hljs-string">"\n"</span>; <span class="hljs-comment">// 输出 2.0</span>

    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<h3 data-id="heading-15">JavaScript 版本（使用 MinPriorityQueue / MaxPriorityQueue）</h3>
<blockquote>
<p>⚠️ LeetCode JS 环境已内置 <code>@datastructures-js/priority-queue</code></p>
</blockquote>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">var</span> <span class="hljs-title class_">MedianFinder</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">queMin</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MaxPriorityQueue</span>(); <span class="hljs-comment">// 较小的一半，最大堆</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">queMax</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MinPriorityQueue</span>(); <span class="hljs-comment">// 较大的一半，最小堆</span>
};

<span class="hljs-title class_">MedianFinder</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">addNum</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">num</span>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">queMin</span>.<span class="hljs-title function_">isEmpty</span>() || num &lt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">queMin</span>.<span class="hljs-title function_">front</span>().<span class="hljs-property">element</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">queMin</span>.<span class="hljs-title function_">enqueue</span>(num);
        <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">queMax</span>.<span class="hljs-title function_">size</span>() + <span class="hljs-number">1</span> &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">queMin</span>.<span class="hljs-title function_">size</span>()) {
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">queMax</span>.<span class="hljs-title function_">enqueue</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">queMin</span>.<span class="hljs-title function_">dequeue</span>().<span class="hljs-property">element</span>);
        }
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">queMax</span>.<span class="hljs-title function_">enqueue</span>(num);
        <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">queMax</span>.<span class="hljs-title function_">size</span>() &gt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">queMin</span>.<span class="hljs-title function_">size</span>()) {
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">queMin</span>.<span class="hljs-title function_">enqueue</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">queMax</span>.<span class="hljs-title function_">dequeue</span>().<span class="hljs-property">element</span>);
        }
    }
};

<span class="hljs-title class_">MedianFinder</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">findMedian</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">queMin</span>.<span class="hljs-title function_">size</span>() &gt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">queMax</span>.<span class="hljs-title function_">size</span>()) {
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">queMin</span>.<span class="hljs-title function_">front</span>().<span class="hljs-property">element</span>;
    }
    <span class="hljs-keyword">return</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">queMin</span>.<span class="hljs-title function_">front</span>().<span class="hljs-property">element</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">queMax</span>.<span class="hljs-title function_">front</span>().<span class="hljs-property">element</span>) / <span class="hljs-number">2.0</span>;
};
</code></pre>
<hr/>
<h2 data-id="heading-16">🌟 本期完结，下期见！🔥</h2>
<blockquote>
<p>👉 点赞收藏加关注，新文更新不迷路。关注专栏【算法】LeetCode Hot100刷题日记，持续为你拆解每一道热题的底层逻辑与面试技巧！</p>
<p>💬 <strong>欢迎留言交流你的解法或疑问！一起进步，冲向 Offer！💪</strong></p>
</blockquote>
<p>📌 <strong>记住</strong>：当你在刷题时，不要只看答案，要像写这篇文章一样，深入思考每一步背后的原理、优化空间和面试价值。这才是真正提升算法能力的方式！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一文读懂 Skills｜从概念到实操的完整指南]]></title>    <link>https://juejin.cn/post/7599528186586595338</link>    <guid>https://juejin.cn/post/7599528186586595338</guid>    <pubDate>2026-01-26T10:27:18.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599528186586595338" data-draft-id="7599485473707245606" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一文读懂 Skills｜从概念到实操的完整指南"/> <meta itemprop="keywords" content="Trae"/> <meta itemprop="datePublished" content="2026-01-26T10:27:18.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="TRAE_ai"/> <meta itemprop="url" content="https://juejin.cn/user/3048259110571032"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一文读懂 Skills｜从概念到实操的完整指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3048259110571032/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    TRAE_ai
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T10:27:18.000Z" title="Mon Jan 26 2026 10:27:18 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读16分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/498562aa9ed8432ba9e87cda7d4a062e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770028042&amp;x-signature=8yAuhMePtapSu%2FGOazhGCXYsOOU%3D" alt="" loading="lazy"/></p>
<blockquote>
<p>本文作者：咸鱼，TRAE 开发者用户</p>
</blockquote>
<blockquote>
<p>Agent 正在经历从“聊天机器人”到“得力干将”的进化，而 <strong>Skills</strong> 正是这场进化的关键催化剂。</p>
<p>你是否曾被 Agent 的“不听话”、“执行乱”和“工具荒”搞得焦头烂额？</p>
<p>本文将带你一文弄懂 <strong>Skills</strong> ——这个让 Agent 变得可靠、可控、可复用的“高级技能包”。</p>
<p>我们将从 Skills 是什么、如何工作，一路聊到怎样写好一个 Skills，并为你推荐实用的社区资源，带领大家在 TRAE 中实际使用 Skills 落地一个场景。</p>
<p>无论你是开发者还是普通用户，都能在这里找到让你的 Agent “开窍”的秘诀。</p>
</blockquote>
<p><strong>你是否也经历过或者正在经历这样的“ Agent 调教”崩溃时刻？</strong></p>
<ul>
<li>
<p><strong>规则失效：</strong> 在 Agent.md 里写下千言万语，Agent 却视若无睹，完全“已读不回”。</p>
</li>
<li>
<p><strong>执行失控：</strong> 精心打磨了无数 Prompt，Agent 执行起来依旧像无头苍蝇，混乱无序。</p>
</li>
<li>
<p><strong>工具迷失：</strong> 明明集成了强大的 MCP 工具库，Agent 却两手一摊说“没工具”，让人摸不着头脑。</p>
</li>
</ul>
<p>如果这些场景让你感同身受，别急着放弃。<strong>终结这场混乱的答案，可能就是 Skills。</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e689cd9039c147278c306e13ec24004b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770028042&amp;x-signature=rQmSbPXhzErYNi1J59HU%2BG28NpE%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-0"><strong>什么是 Skills</strong></h2>
<p>“Skills” 这个概念最早由 Anthropic 公司提出，作为其大模型 Claude 的一种能力扩展机制。简单来说，它允许用户为 Claude 添加自定义的功能和工具。随着这套做法越来越成熟，并被社区广泛接受，Skills 如今已成为大多数 Agent 开发工具和 IDE 都支持的一种标准扩展规范。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/30a3492ffbfb4f8c86543ba47e2714c4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770028042&amp;x-signature=ZAMUCjEIT1Qsuj9AL5ySwVGdSDg%3D" alt="" loading="lazy"/></p>
<p>一个 Skills 通常以一个文件夹的形式存在，里面主要装着三样东西：<strong>一份说明书（SKILL.md）、一堆操作脚本（Script）、以及一些参考资料（Reference）。</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cfdff3d6d6954816a0947ee5d3625652~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770028042&amp;x-signature=sfdkPQw4lDQu9Z0no9AlRw67wPE%3D" alt="640 (1).png" loading="lazy"/></p>
<p>你可以把一个 Skill 想象成一个打包好的“技能包”。它把完成某个特定任务所需的<strong>领域知识、操作流程、要用到的工</strong> <strong>具、以及最佳实践</strong>全都封装在了一起。当 AI 面对相应请求时，就能像一位经验丰富的专家那样，有条不紊地自主执行。</p>
<p><strong>一句话总结：</strong> 要是把 Agent 比作一个有很大潜力的大脑，那 <strong>Skills 就像是给这个大脑的一套套能反复用的“高级武功秘籍”。</strong> 有了它，Agent 能从一个“什么都略知一二”的通才，变成在特定领域“什么都擅长”的专家。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e2a8152998b547a08a8a54e8b8459b38~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770028042&amp;x-signature=YXPCIbBAv5x0stu2X3HnINwDbqk%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-1"><strong>Skill 原理介绍</strong></h2>
<p>📚 官方解释：<a href="https://link.juejin.cn?target=https%3A%2F%2Fplatform.claude.com%2Fdocs%2Fen%2Fagents-and-tools%2Fagent-skills%2Foverview" target="_blank" title="https://platform.claude.com/docs/en/agents-and-tools/agent-skills/overview" ref="nofollow noopener noreferrer">platform.claude.com/docs/en/age…</a></p>
<h4 data-id="heading-2"><strong>Skill 的架构原理：渐进式加载</strong></h4>
<p>Skill 的设计很巧妙，它运行在一个沙盒环境里，这个环境允许大模型访问文件系统和执行 <em><strong>bash</strong></em> 命令（可以理解为一种电脑操作指令）。在这个环境里，一个个 Skill 就像一个个文件夹。Agent 就像一个熟悉电脑操作的人，通过命令行来读取文件、执行脚本，然后利用结果去完成你交代的任务。这种“按需取用”的架构，让 Skill 成为一个既强大又高效的“工具箱”。</p>
<p>为了平衡效果和效率，Skill 设计了一套聪明的三层分级加载机制：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fde448de57f540409d9264c41d82cb2c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770028042&amp;x-signature=ovVLGJjnunTuBQBwoHOtruHUCEc%3D" alt="" loading="lazy"/><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f254ff2a09d2490fbfcb8147c257b216~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770028042&amp;x-signature=mBe29p0fLEw%2BVAU6tX%2B6aHe694M%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-3"><strong>Level 1：元数据（始终加载）</strong></h4>
<p>元数据就像是 Skill 的“名片”，里面有名称（<em><strong>name</strong></em>）和描述（<em><strong>description</strong></em>），是用 YAML 格式来定义的。Claude 在启动的时候，会把所有已经安装的 Skill 的元数据都加载进来，这样它就能知道每个 Skill 有什么用、什么时候该用。因为元数据很轻量，所以你可以安装很多 Skill，不用担心把上下文占满。</p>
<h4 data-id="heading-4"><strong>Level 2：说明文档（触发时加载）</strong></h4>
<p><em><strong>SKILL.md</strong></em> 文件的正文就是说明文档，里面有工作流程、最佳实践和操作指南。只有用户的请求和 Skills 元数据里的描述相符时，Claude 才会用 <em><strong>bash</strong></em> 指令读取这份文档，把内容加载到上下文里。这种“触发式加载”能保证只有相关的详细指令才会消耗 Token。</p>
<h4 data-id="heading-5"><strong>Level 3：资源与代码（按需加载）</strong></h4>
<p>Skills 还能打包一些更深入的资源，比如更详细的说明文档（<em><strong>FORMS.md</strong></em>）、可执行脚本（ <em><strong>.py</strong></em>）或者参考资料（像 API 文档、数据库结构等）。Claude 只有在需要的时候，才会通过 <em><strong>bash</strong></em> 去读取或执行这些文件，而且脚本代码本身不会进入上下文。这样一来，Skills 就能捆绑大量信息，几乎不会增加额外的上下文成本。</p>
<h3 data-id="heading-6"><strong>Skills 的调用逻辑：从理解意图到稳定执行</strong></h3>
<p>那么，Agent 是如何智能地选择并执行一个 Skill 的呢？整个过程就像一位经验丰富的助理在处理工作：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/56d095ed53234caca572363ae4de6a9d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770028042&amp;x-signature=%2FAivTlcRt5aFuEPnrm2Mv2vPQT0%3D" alt="" loading="lazy"/></p>
<ol>
<li>
<p><strong>意图匹配（找到对的人）：</strong> Agent 首先聆听你的需求，然后快速扫一眼自己手头所有 Skill 的“名片夹”（元数据），寻找最匹配的那一张。</p>
</li>
<li>
<p><strong>读取手册（看懂怎么干）：</strong> 找到合适的 Skills 后，Agent 会像模像样地翻开它的“操作手册”（<em><strong>SKILL.md</strong></em>），仔细研究详细的执行步骤和注意事项。</p>
</li>
<li>
<p><strong>按需执行（动手开干）：</strong> 根据手册的指引，Agent 开始工作。如果需要，它会随时从“工具箱”里拿出脚本或工具来完成具体操作。</p>
</li>
<li>
<p><strong>反馈结果（事毕复命）：</strong> 任务完成后，Agent 向你汇报最终结果，或者在遇到困难时，及时向你请教。</p>
</li>
</ol>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/be94cd4da1f84612aab5a51c9ad0891f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770028042&amp;x-signature=kfzTOJ2f%2FrSvosdXCKwQ1jG775o%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-7"><strong>Skills  vs.  其他概念的区别</strong></h2>
<p>为了更清晰地理解 Skills 的独特价值，我们不妨把它和另外两个容易混淆的概念——<strong>快捷指令（Command）</strong> 和<strong>原子工具（MCP）</strong> ——放在一起做个对比。用一个厨房的例子就很好懂了：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/46415a2bb9a74a72b49cd886e62cbb8f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770028042&amp;x-signature=H6Rn5XSrDc5azaMkgyh32pCPQ3A%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b51047922b214010b0b7d886fa290af8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770028042&amp;x-signature=iizVN7MLxbJ5Loaksvy%2BDDA07yw%3D" alt="" loading="lazy"/></p>
<p>我们也列举了几个大家容易混淆的其他功能，一起来对比看看。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4ae20becf7a54b9c8dd9d689096c4ada~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770028042&amp;x-signature=umQTI6W%2FXB%2BHCsNqSPZHqhqcr1g%3D" alt="" loading="lazy"/></p>
<p>📚 官方博客解释：<a href="https://link.juejin.cn?target=https%3A%2F%2Fclaude.com%2Fblog%2Fskills-explained" target="_blank" title="https://claude.com/blog/skills-explained" ref="nofollow noopener noreferrer">claude.com/blog/skills…</a></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0526612b042f4c788613b5eac6bc5155~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770028042&amp;x-signature=Q6da1excp3hmiXA8pHZF9Zkkrno%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-8"><strong>什么是好的 Skills：从“能用”到“好用”</strong></h2>
<p><strong>Good Skills vs Bad Skills</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/260567fa689b4cd0be8befc0ddfdfcb8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770028042&amp;x-signature=G1LvLKremMuB9DqfpkHT%2FwMoPmM%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-9"><strong>如何写好 Skills</strong></h3>
<ol>
<li>
<p><strong>原子性（Atomicity）：</strong> 坚持单一职责，让每个 Skill 都像一块积木，小而美，专注于解决一个具体问题，便于日后的复用和组合。</p>
</li>
<li>
<p><strong>给例子（Few-Shot Prompting）：</strong> <strong>这是最关键的一点</strong>，与其费尽口舌解释，不如直接给出几个清晰的输入输出示例。榜样的力量是无穷的，模型能通过具体例子，秒懂你想要的格式、风格和行为。</p>
</li>
<li>
<p><strong>立规矩（Structured Instructions）：</strong></p>
<p><strong>1) 定角色：</strong> 给它一个明确的专家人设，比如“你现在是一个资深的市场分析师”。</p>
<p><strong>2) 拆步骤：</strong> 把任务流程拆解成一步步的具体指令，引导它“思考”。</p>
<p><strong>3) 画红线：</strong> 明确告诉它“不能做什么”，防止它天马行空地“幻觉”</p>
</li>
<li>
<p><strong>造接口（Interface Design）：</strong> 像设计软件 API 一样，明确定义 Skill 的输入参数和输出格式（比如固定输出 JSON 或 Markdown）。这让你的 Skill 可以被其他程序稳定调用和集成。</p>
</li>
</ol>

<ol start="5">
<li><strong>勤复盘（Iterative Refinement）：</strong> 把 Skills 当作一个产品来迭代。在实际使用中留心那些不尽如人意的“Bad Case”，然后把它们变成新的规则或反例，补充到你的 Skills 定义里，让它持续进化，越来越聪明、越来越靠谱。</li>
</ol>
<p>📚 一些官方最佳实践指南 <a href="https://link.juejin.cn?target=https%3A%2F%2Fplatform.claude.com%2Fdocs%2Fzh-CN%2Fagents-and-tools%2Fagent-skills%2Fbest-practices" target="_blank" title="https://platform.claude.com/docs/zh-CN/agents-and-tools/agent-skills/best-practices" ref="nofollow noopener noreferrer">platform.claude.com/docs/zh-CN/…</a></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/90124ad767404c5da449c53d544012aa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770028042&amp;x-signature=urA0pky4RXmFjJIVB1Ho8wnJb%2Fo%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-10"><strong>社区热门 Skills 推荐</strong></h2>
<p>刚开始接触 Skills，不知从何下手？不妨从社区沉淀的这些热门 Skills 开始，寻找灵感，或直接在你的工作流中复用它们。</p>
<h3 data-id="heading-11"><strong>Claude 官方提供的 Skills</strong></h3>
<p>📚 官方 Skills 仓库  <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fanthropics%2Fskills" target="_blank" title="https://github.com/anthropics/skills" ref="nofollow noopener noreferrer">github.com/anthropics/…</a></p>
<p>学习 Claude 官方的 Skills 仓库可以帮助我们最快的了解 Skills 的最佳实践，便于我们沉淀出自己的 Skills。</p>
<blockquote>
<p><strong>如何快速使用官方 Skills？</strong></p>
<p>大多数官方 Skills 都能直接下载，或者通过 Git 克隆到本地。在 TRAE 等工具里，一般只需把这些 Skills 的文件夹放到指定的 <em><strong>Skills</strong></em> 目录，接着重启或刷新 Agent，它就会自动识别并加载这些新能力。具体操作可参考工具的使用文档。</p>
<p>更多细节可参考下面这部分内容：<strong>如何在 TRAE 里快速用起来</strong></p>
</blockquote>
<p><strong>Claude 官方提供的 Skills 列表</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2d3df5f253864939bfefa0c7ef8b5852~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770028042&amp;x-signature=jbuN31Rn4gWzYgvofxBB0YIqWr0%3D" alt="show_679493203_1769422730184.png" loading="lazy"/></p>
<h3 data-id="heading-12"><strong>社区其他最佳实践</strong></h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e34611085a1c475bb4b2f26285f21bca~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770028042&amp;x-signature=EdlPHC3DgsQUx3M2B%2BbVa%2FhNCa8%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/530b1a02e08f45e18af7f7b78cf14941~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770028042&amp;x-signature=a1gu3tF9yc%2FZSIU6omjYanf8yO8%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-13"><strong>如何在 TRAE 里快速使用</strong></h2>
<p>理论说再多，不如亲手一试。我们先讲一下如何在 TRAE SOLO 中创建并应用一个 Skill 并以基于飞书文档的 Spec Coding 为例讲解一下如何利用 Skills 快速解决一个实际问题。</p>
<h3 data-id="heading-14"><strong>Skill 创建</strong></h3>
<p><strong>方式一：设置中直接创建</strong></p>
<p>TRAE 支持在设置页面可以快速创建一个 Skill</p>
<p>按下快捷键 Cmd +/ Ctrl + 通过快捷键打开设置面板。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6894be68150545ddafcf6a2aed27535f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770028042&amp;x-signature=TYNNesb3q6i7yffMCBgn9CyPTM0%3D" alt="" loading="lazy"/></p>
<p>在设置面板左侧找到「规则技能」选项</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ec94a84497d24c56b026679c6bd190b1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770028042&amp;x-signature=5itKsgX1rjNRS2%2FJde7bVO9O4T8%3D" alt="" loading="lazy"/></p>
<p>找到技能板块，点击右侧的「创建」按钮。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/39b8d09b9a29433ca09059bae34c9f18~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770028042&amp;x-signature=r0T71CKdS%2FIy3Ky3cX%2FGqrGANQw%3D" alt="" loading="lazy"/></p>
<p>你会看到一个简洁的创建界面，包含三要素：<strong>Skill 名称、Skill 描述、Skill 主体</strong>。我们以创建一个“按规范提交 git commit”的 Skill 为例，填入相应内容后点击「确认」即可。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b45f17d81c4b4c1083bd0c3a209a6927~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770028042&amp;x-signature=epgAmv7m272oFkGSweS3o4hjhmU%3D" alt="" loading="lazy"/></p>
<p>填入我们需要的内容「确认」即可</p>
<p><strong>方式二：直接解析 SKILL.md</strong></p>
<p>在当前项目目录下，新增目录.<em><strong>trae/Skills/xxx</strong></em> 导入你需要文件夹，和 TRAE 进行对话，即可使用。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b54f715d553d4c68b517da01516f94e3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770028042&amp;x-signature=Ezz0ssjg2toioy99GRMnaRy5tx0%3D" alt="" loading="lazy"/></p>
<p>可以在「设置 - 规则技能」中看到已经成功导入</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fbc7108b9e804a7680d0ceea27012dfa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770028042&amp;x-signature=nugFbLMyBtdfy%2B4J1ycjChfUYdE%3D" alt="" loading="lazy"/></p>
<p><strong>方式三：在对话中创建</strong></p>
<p>目前 TRAE 中内置了 Skills-creator Skills ，你可以在对话中直接和 TRAE 要求创建需要的 Skills</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5b10a41b1e3b4ac1841e9c908c4a4c37~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770028042&amp;x-signature=bmyFQIg0HGR5ulMwl9TZbLOtAJc%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-15"><strong>Skill 使用</strong></h3>
<p>在 TRAE 里使用技能很容易，你加载好需要的技能后，只需在对话框中用日常语言说明你的需求就行。</p>
<ul>
<li>
<p>例如，输入“帮我设计一个有科技感的登录页面”，系统就会自动调用“frontend-design”技能。</p>
</li>
<li>
<p>例如，输入“帮我提取这个 PDF 里的所有表格”，系统会自动调用“document-Skills/pdf”技能。</p>
</li>
<li>
<p>例如，输入“帮我把这片技术文档转为飞书文档”，系统会自动调用“using-feishu-doc”技能。</p>
</li>
</ul>
<p>系统会自动分析你的需求，加载技能文档，还会一步步指导你完成任务！</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d5175bab9f2b4529b0f54eac980ae4e0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770028042&amp;x-signature=PfyED%2BwpHDPFoCnxTOJO7oe1RAE%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-16"><strong>实践场景举例</strong></h3>
<p>还记得引言里提到的那些问题吗？比如说，项目规则文件（<em><strong>project_rules</strong></em>）有字符数量的限制；又或者，就算你在根规则文件里明确写好了“在什么情况下读取哪个文件”，Agent 在执行任务时也不会按照要求来做。</p>
<p>这些问题的根本原因是，<strong>规则（Rules）对于 Agent 而言是固定不变的</strong>，它会在任务开始时就把所有规则一次性加载到上下文中，这样既占用空间，又不够灵活。而 <strong>技能（Skill）采用的是“逐步加载”的动态方式</strong>，刚好可以解决这个问题。所以，我们可以把之前那些复杂的规则场景，重新拆分成一个个独立的技能。</p>
<p><strong>接下来，我们通过一个基于飞书文档的“Spec Coding”简单流程，来实际操作一下如何用技能解决问题。</strong></p>
<h4 data-id="heading-17"><strong>什么是 Spec Coding？</strong></h4>
<p>Spec Coding 提倡“先思考后行动”，也就是通过详细定义可以执行的需求规范（Specification）来推动 AI 开发。它的流程包含“需求分析、技术设计、任务拆解”的文档编写过程，最后让 AI 根据规范来完成编码。这种一步步的工作流程能保证每一步都有依据，实现从需求到代码的准确转化。</p>
<p><strong>让我来分析一下这个场景</strong></p>
<p>上面提到将开发过程划分为四个关键阶段，所以要完成 “需求分析、技术设计、任务拆解” 的飞书文档撰写，还有最终的代码实现。为此，我们需要不同的技能来满足不同场景下的文档编写需求，并且要教会 Agent 如何使用飞书工具进行创作协同。</p>
<p><strong>下面我们就一起完成上面提到的 Skills 的设计实现。</strong></p>
<h4 data-id="heading-18"><strong>多角色专家 Skills</strong></h4>
<p>通过实现多角色 Skills 通过创建多个交付物过程文档，约束后续的编码，为编码提供足够且明确的上下文，每个Skill 专注完成一件事</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e3af5b203e7e446cbb42409995896ef7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770028042&amp;x-signature=x2DJMDCBO%2FKvmlfA8f5nD4EIO%2BM%3D" alt="" loading="lazy"/></p>
<ul>
<li><strong>下面让我们进一步详细设计</strong></li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dbbbe68dfda9491798c69f32a084deb2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770028042&amp;x-signature=whcmN6%2B0R4rMiB19SW6pl38vBOc%3D" alt="" loading="lazy"/></p>
<p>按照上述的表格我们就可以大致明确我们需要的 Skills 该如何实现了。</p>
<ul>
<li>本次只作为一个例子大家可以参考上面创建 Skill 的教程自己完成一下这个多角色 Skills 的创建和调试，当然正如上面所述好的 Skill 需要在实践中逐渐优化并通过场景调用不断进行优化的</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/046c201b33704525a24d8d32fdca1e9c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770028042&amp;x-signature=tx2MC2Em5jcPSBfbk%2BaJO0SNNZc%3D" alt="" loading="lazy"/><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f9a0bcd187364746b74ee2f272c8d73a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770028042&amp;x-signature=2tTeQMuH9IxdOP3XQlLvdlVWWLo%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-19"><strong>飞书文档使用 Skill</strong></h4>
<p>飞书文档的格式是 markdown 的超集，<strong>我们 Skill 的目的则是教会 Agent 飞书文档的语法</strong>，便于 Agent 写出符合格式的 md 文件。并通过约束 Agent 行为，<strong>充分利用飞书文档的评论的读写完成多人协作审阅的过程</strong>，用户通过在飞书文档评论完成相关建议的提出，Agent 重新阅读文档和评论，根据建议进一步优化文档，<strong>实现文档协作工作流。</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/330f2aeb47764d91b04fb728d4464f08~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770028042&amp;x-signature=VejIhkIHalFsBne1uvVTRCaw5UM%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-20"><strong>Spec Coding Skill</strong></h4>
<p>上面我们实现了多个角色 Skills 和一个功能 Skill，但实际使用时，还需要有一个能统筹全局的技能，来实现分工协作。把上述多个技能组合起来，告诉智能体（agent）整体的规格编码（spec coding）流程，完成工具技能和角色技能的组合与调度。</p>
<p>如此我们就能快速搭建一个规格编码工作流程，完成基础开发。当然也可以参考上面的逻辑，用技能来重新复刻社区里的规格编码实践（如 SpecKit、OpenSpec 等）。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c5701078e580497895f98d1efd77d5d0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770028042&amp;x-signature=vq%2BTCQxE%2F6DhdQKDYt7WFoPGPUw%3D" alt="" loading="lazy"/><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7925bbc8e2d14f1b80591c4e60cc2176~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770028042&amp;x-signature=oGg%2BqMgLQuYpKDdZUviIUAze4Pc%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-21"><strong>总结</strong></h4>
<p>上述场景提到了两种不同风格的 Skill（角色型，工具型），利用 <strong>Skill 的动态加载机制</strong>（取代固定规则的一次性加载方式），完成了复杂场景下的任务分解；通过 <strong>不同角色技能的分工协作</strong>（避免 Agent 什么都做导致执行混乱）；尝试借助<strong>飞书文档形成协作闭环</strong>（打通人机交互的最后一步），有效解决了 Agent “不听话、执行乱、工具少” 的问题，让 AI 从 “对话助手” 真正转变为 “可信赖的实干家”，实现从需求提出到代码产出的高效、精准、协作式交付。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/580d8eed249c4a98ae1233f298611cff~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770028042&amp;x-signature=s2iEalF5pfkW%2Fe6eCvci1rjS7tE%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-22"><strong>Q &amp; A | 一些常见问题</strong></h2>
<h3 data-id="heading-23"><strong>为什么我写的 Skills 不生效，或者效果不符合预期？</strong></h3>
<p><strong>那十有八九是你的“名片”（</strong> <em><strong>Description</strong></em> <strong>）没写好。</strong></p>
<p>记住，Agent 是通过读取 Skills 的 <em><strong>Description</strong></em> 来判断“什么时候该用哪个 Skill”的。要是你的描述写得含糊不清、太专业或者太简单，Agent 就很难明白你的意思，自然在需要的时候就不会调用这个 Skill。所以，<strong>用大白话写的清晰、准确的</strong> <em><strong>Description</strong></em> <strong>，对 Skill 能否起作用至关重要。</strong></p>
<h3 data-id="heading-24"><strong>使用 Skills 的效果，会受到我选择的大语言模型（LLM）的影响吗？</strong></h3>
<p><strong>会有影响，不过影响的方面不一样。</strong></p>
<ul>
<li>
<p><strong>一个更强大的模型，主要影响“挑选”和“安排”技能的能力。</strong> 它能更准确地明白你的真实想法，然后从一堆技能里挑出最适合的一个或几个来解决问题。它的优势体现在制定策略方面。</p>
</li>
<li>
<p><strong>而技能本身，决定了具体任务执行的“最低水平”和“稳定性”。</strong> 一旦某个技能被选中，它里面设定好的流程和代码是固定的，会稳定地运行。所以，技能编写得好不好，直接决定了具体任务能不能出色完成。。</p>
</li>
</ul>
<h3 data-id="heading-25"><strong>Skills 是不是万能的？有什么它不擅长做的事情吗？</strong></h3>
<p><strong>当然不是万能的。</strong> Skills 的主要优势是<strong>处理那些流程明确、边界清晰的任务。</strong> 在下面这些情况中，它可能就不是最好的选择了：</p>
<ul>
<li>
<p><strong>需要高度创造力的任务：</strong> 像写一首饱含情感的诗，或者设计一个全新的品牌标志。这类工作更需要大模型本身的“灵感”。</p>
</li>
<li>
<p><strong>需要实时、动态做决策的复杂策略游戏：</strong> 比如在变化极快的金融市场中做交易决策。</p>
</li>
<li>
<p><strong>单纯的知识问答或开放式闲聊：</strong> 如果你只是想问“文艺复兴三杰是谁？”，直接问大模型就可以，不用动用 Skills 这个“大杀器”。</p>
</li>
</ul>
<h3 data-id="heading-26"><strong>我发现一个社区的 Skills 很好用，但我可以修改它以适应我的特殊需求吗？</strong></h3>
<p><strong>当然可以，我们强烈建议你这么做！</strong></p>
<p>大多数共享的 Skill 都支持用户“Fork”（也就是“复制一份”）并进行二次开发。你可以把通用的 Skill 当作模板，在自己的工作空间里复制一份，然后修改里面的逻辑或参数，以适应你自己的业务需求。这对整个生态的共建和知识复用很重要。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a0c2dfe38cb3454f81679a9548f08458~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770028042&amp;x-signature=cJCENj%2BpTeNPQE468eNnku7SJfc%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-27"><strong>结语｜让 Agent 成为你真正的“行动派”</strong></h2>
<p>Skill 的出现，为 AI 从“对话式助手”转变为“可信赖的执行者”搭建了关键的技术桥梁。它用结构化的方法把领域知识、操作流程和工具调用逻辑封装起来，解决了 Agent 规则失效、执行失控的混乱问题，让 AI 的能力输出变得可以控制、值得信赖且高效。</p>
<p>Skill 的核心价值在于：</p>
<ul>
<li>
<p><strong>精准实际痛点：</strong> 通过巧妙的三级加载机制（元数据→说明文档→资源）平衡上下文效率与功能深度，在功能深度和上下文效率之间找到了一个绝佳的平衡点，既避免了宝贵 Token 的浪费，又确保了任务执行的精准性，实现了 Agent 上下文的动态加载能力。</p>
</li>
<li>
<p><strong>生态赋能，降低门槛：</strong> 无论是官方还是社区，都提供了丰富的资源（如 Claude 官方仓库、SkillsMP 市场等），让普通用户也能轻松站在巨人的肩膀上，快速复用各种成熟的能力。</p>
</li>
</ul>
<p>虽然 Skill 不是万能的，但它在“确定性流程任务”上的优势无可替代。未来，随着 AI 模型能力的提升与 Skill 生态的进一步完善，我们有望看到更多跨领域、可组合的 Skill 出现——<strong>让 AI 从“样样懂一点”的通才，真正进化为“事事做得好”的专家协作伙伴。</strong></p>
<p><strong>不妨从今天开始，尝试创建你的第一个 Skill：将你最擅长的领域经验封装成可复用的能力，让 AI 成为你延伸专业价值的放大器。</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[为什么 ES 的搜索结果只到 10,000？强制“数清楚”的代价有多大]]></title>    <link>https://juejin.cn/post/7599514071104765967</link>    <guid>https://juejin.cn/post/7599514071104765967</guid>    <pubDate>2026-01-26T10:33:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599514071104765967" data-draft-id="7599220371666272296" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="为什么 ES 的搜索结果只到 10,000？强制“数清楚”的代价有多大"/> <meta itemprop="keywords" content="搜索引擎"/> <meta itemprop="datePublished" content="2026-01-26T10:33:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿里云大数据AI技术"/> <meta itemprop="url" content="https://juejin.cn/user/2414974667341287"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            为什么 ES 的搜索结果只到 10,000？强制“数清楚”的代价有多大
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2414974667341287/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿里云大数据AI技术
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T10:33:09.000Z" title="Mon Jan 26 2026 10:33:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>“为什么搜出来的结果总数永远是 10,000？是不是数据丢了？”</p>
</blockquote>
<p>这是每一个 Elasticsearch 新手在 7.x 版本之后都会遇到的“灵魂发问”。</p>
<p>而在得知“这是 ES 的默认性能优化”后，绝大多数人的第一反应往往是抗拒：“我不想要优化，我要精准的数字！老板要看，前端分页也要用。”</p>
<p>于是，在许多项目的代码库里，我们都能看到这样一行“补丁”：</p>
<p><code>"track_total_hits": true</code></p>
<p>数字终于准了，变成了 854,321，大家都很满意。</p>
<p>但没人注意到，就在这行代码生效的瞬间，集群的 CPU 占用率可能直接翻倍，查询延迟从 20ms 劣化到了 500ms。</p>
<p>为什么一个简单的“计数”，会成为拖垮集群性能的隐形杀手？</p>
<p>今天，我们不谈玄学，从 Lucene 底层原理 层面，揭秘这背后的代价。</p>
<h2 data-id="heading-0">现象：消失的“尾部数据”</h2>
<p>在 ES 7.0 之前，查询默认会算出精确总数。但在 7.0 之后，默认的响应体变成了这样：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-attr">"hits"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"total"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"value"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">10000</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"relation"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"gte"</span>  <span class="hljs-comment">// 注意：Greater Than or Equal to (大于等于)</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    ...
<span class="hljs-punctuation">}</span>
</code></pre>
<p>这不仅是一个数字的变化，更是搜索引擎检索逻辑的根本性范式转移：</p>
<p>从“找出所有匹配文档”进化为“只找出最有价值的 Top N”。</p>
<h2 data-id="heading-1">深度解析：Block-Max WAND 算法的智慧</h2>
<p>要理解为什么“数不准”能带来性能飞跃，必须深入 Lucene 的底层，了解 Block-Max WAND (BMW) 算法。</p>
<h3 data-id="heading-2">1. 倒排索引的物理结构：Block</h3>
<p>在 Lucene 的倒排索引（Inverted Index）中，一个 Term（词项）对应的 Postings List（文档 ID 列表）并不是一整条长链，而是被切分成了多个 Block（块），通常包含 128 个文档 ID。</p>
<p>关键点在于：</p>
<p>每个 Block 都有一个 Block Header，里面记录了这个块的元数据，其中最重要的一个是：</p>
<p>Max Score（块内最大分数）：即这个 Block 里所有文档中，能产生的最高相关性得分是多少。</p>
<h3 data-id="heading-3">2. 竞速机制：Min Competitive Score</h3>
<p>当 ES 执行查询（比如查询“手机”）并索要 Top 10 结果时，它会维护一个 最小竞争分数（Min Competitive Score）。</p>
<ul>
<li>
<p>刚开始，Top 10 没满，最小竞争分数是 0。</p>
</li>
<li>
<p>随着扫描进行，找到了 10 个文档，第 10 名的分数是 5.0。</p>
</li>
<li>
<p>此时，最小竞争分数变成了 5.0。意味着：任何分数低于 5.0 的文档，连进决赛圈的资格都没有。</p>
</li>
</ul>
<h3 data-id="heading-4">3. “隔山打牛”的跳跃优化</h3>
<p>接下来，神奇的事情发生了。</p>
<p>当遍历指针来到下一个 Block（假设包含 ID 1000-1127）时，算法不需要解压这个 Block，也不需要计算具体的文档分数，而是直接看 Block Header：</p>
<blockquote>
<p>算法拷问： “这个 Block 的 Max Score 是多少？”Block 回答： “最高只能得 4.5 分。”算法判断： “现在的门槛（Min Competitive Score）已经是 5.0 了。你这个 Block 里的文档全是‘废柴’，整个 Block 直接跳过！”</p>
</blockquote>
<p>结果： ES 可能直接跳过了数百万个低分文档。</p>
<p>代价： 因为跳过了，ES 根本不知道刚才那个 Block 里有几个文档匹配（虽然分低，但确实匹配）。所以，它无法给出精确的总数。</p>
<h2 data-id="heading-5">隐形陷阱：为什么关了 track_total_hits 依然慢？</h2>
<p>你以为把 track_total_hits 设为 false 就万事大吉了？</p>
<p>别天真了。 在某些特定场景下，即使你显式关闭了计数，ES 依然无法使用 Block-Max WAND 进行剪枝，查询性能依然会很差。</p>
<p>这就好比你告诉司机“不用数路边有几棵树（不计数）”，但你同时又下令“把路边每棵树的叶子都摘一片下来（聚合）”。司机虽然不用数数，但他依然得停在每一棵树下。</p>
<h3 data-id="heading-6">1. 聚合（Aggregations）：WAND 的天敌</h3>
<p>WAND 算法的核心奥义是 “Skipping（跳过）”。</p>
<p>而聚合（Aggregations）的核心诉求是 “Traversing（遍历）”。</p>
<p>如果你在查询中包含任何聚合（例如 <code>terms</code>、<code>avg</code>、<code>date_histogram</code>），ES 必须访问所有匹配的文档来计算统计值。</p>
<ul>
<li>
<p>冲突点：你不能跳过一个 Block，因为那个被跳过的 Block 里可能包含聚合所需的数据。</p>
</li>
<li>
<p>结果：WAND 优化被迫关闭，全量扫描不可避免。</p>
</li>
</ul>
<h3 data-id="heading-7">2. 排序与分数的纠结（Sort + track_scores）</h3>
<p>Block-Max WAND 依赖于 Max Score 来进行跳跃。</p>
<ul>
<li>
<p>场景：你按时间排序 (<code>sort: [{"timestamp": "desc"}]</code>)。</p>
</li>
<li>
<p>陷阱：如果你手滑加了 <code>track_scores: true</code>（或者某些 Client 默认开启）。</p>
</li>
<li>
<p>后果：虽然是按时间排序，但因为你强行索要 <code>_score</code>，ES 必须对每个文档计算分数，导致无法利用 BKD Tree 的索引顺序进行快速跳跃，也难以通过 WAND 进行分数剪枝（因为排序不是按分数排的）。</p>
</li>
</ul>
<h2 data-id="heading-8">代价：track_total_hits 如何摧毁性能</h2>
<p>口说无凭，数据为证。我们在 Serverless 8.17 环境下，创建一个6分片1副本的索引，写入约 2 亿条 脱敏文档，总计约30G数据，查询qps控制在30 。用实测结果向你展示——track_total_hits 取不同值时的cu消耗及响应时长：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b42c37cdd0db4318af44b2873e09607b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770028389&amp;x-signature=%2Bz8vTJtg6%2BJbxbAYMp85ITEtTr4%3D" alt="" loading="lazy"/></p>
<p>CPU 资源消耗对比(true,false,10000)</p>
<p>​<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7d01ffef0e164ba09662dc008a1a59c2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770028389&amp;x-signature=8f4n1YHNv0N03LNaG8Y9Msihm%2FM%3D" alt="" loading="lazy"/></p>
<p>平均耗时和 P95 耗时对比(true,false,10000)</p>
<p>当你加上 "track_total_hits": true 时，你实际上是在对底层引擎下达一道“死命令”：</p>
<p>“禁用 Block-Max WAND 优化，禁止跳过任何一个 Block。”这带来的性能崩塌是显著的。</p>
<h3 data-id="heading-9">1. CPU 的燃烧（计算密集）</h3>
<ul>
<li>
<p>优化模式：只解压和计算高分 Block。</p>
</li>
<li>
<p>强制计数：必须解压所有匹配的 Block（使用 Frame Of Reference 编码），并对每一个文档 ID 进行解码和比对。</p>
</li>
<li>
<p>量级差异：如果查询匹配 1 亿条数据，原本只需计算 Top 1000 的分数，现在必须计算 1 亿次。CPU 消耗可能增加几个数量级。</p>
</li>
</ul>
<h3 data-id="heading-10">2. I/O 的雪崩（访存密集）</h3>
<ul>
<li>
<p>优化模式：低分 Block（通常是历史冷数据）直接跳过，不需要从磁盘读取。</p>
</li>
<li>
<p>强制计数：强制读取所有 Block。</p>
</li>
<li>
<p>后果：这会导致大量的随机 I/O。更致命的是，这些本该沉睡的冷数据被加载到内存中，会污染 Page Cache，把真正热点的数据（比如最近 5 分钟的日志）挤出去。</p>
</li>
<li>
<p>现象：你会发现，为了查一个总数，整个集群的写入性能和热查询性能都下降了。</p>
</li>
</ul>
<h2 data-id="heading-11">决策矩阵：到底什么时候该用？</h2>
<p>我们需要建立一个清晰的决策标准，而不是盲目地 <code>true</code>。</p>
<p><strong>场景</strong></p>
<p><strong>track_total_hits 设置</strong></p>
<p><strong>理由</strong></p>
<p><strong>C 端搜索 / App 列表</strong></p>
<p><code>false</code> 或 <code>10000</code> (默认)</p>
<p>用户只翻前几页。显示“10,000+”完全满足体验，性能最优。</p>
<p><strong>高频业务接口</strong></p>
<p><strong>(QPS &gt; 100)</strong></p>
<p><code>false</code></p>
<p>**绝对禁止开启。**高并发下开启全量计数是集群雪崩的导火索。</p>
<p><strong>后台管理 / 审核列表</strong></p>
<p><code>true</code> (慎用)</p>
<p>运营人员并发低，且必须知道确切的“待办数量”。</p>
<p><strong>数据大盘 / 趋势图</strong></p>
<p><code>false</code> (使用聚合)</p>
<p>不要用 hits.total 画图！请使用 <code>date_histogram</code> 或 <code>cardinality</code> 聚合。</p>
<p><strong>数据导出</strong></p>
<p><code>false</code></p>
<p>导出任务应使用 Scroll API 或 Point in Time (PIT) API，这些 API 针对全量遍历做了优化，不需要实时计算总数 。</p>
<h2 data-id="heading-12">Serverless 下的治理之道</h2>
<p>在自建集群中，很难限制开发者的代码行为。但在 阿里云 ES Serverless 中，我们建议通过配置进行防御性治理。</p>
<h3 data-id="heading-13">1. 软限制："Track Total Hits上限"</h3>
<p>你可以通过 ES Serverless 控制台—开启功能设置，给查询加上一道“保护锁”：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ea09ce16766a4fcd982a9831070dbb65~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770028389&amp;x-signature=f3h%2FjLvAZSfXxYfQYlpUWbWDrlk%3D" alt="" loading="lazy"/></p>
<ul>
<li>
<p>效果：一旦设置，即使客户端请求中带了 <code>"track_total_hits": true</code>，服务端也会强制忽略，只计算到 10,000。</p>
</li>
<li>
<p>价值：从根源上防止了某个实习生的一行代码搞挂整个生产集群。</p>
</li>
</ul>
<h3 data-id="heading-14">2. 拥抱“模糊的正确”</h3>
<p>在云原生时代，算力是按量计费的（CU）。</p>
<p>“无意义的精确计数” = “直接烧钱”。</p>
<p>利用 Serverless 的弹性与治理能力，将算力集中在真正产生业务价值的 Top N 搜索上，才是降本增效的关键。</p>
<h2 data-id="heading-15">附录：代码与实操</h2>
<h4 data-id="heading-16">1. 正确的查询姿势 (DSL)</h4>
<p><strong>场景 A：只要 Top 10 (性能最快)</strong></p>
<pre><code class="hljs language-json" lang="json">GET /logs/_search
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"query"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"match"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"message"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"error"</span> <span class="hljs-punctuation">}</span> <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"size"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">10</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"track_total_hits"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span>  <span class="hljs-comment">// 显式关闭，连 10000 都不数，最快</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><img alt="" title="点击并拖拽以移动" src="" loading="lazy"/></p>
<p><strong>场景 B：需要精确计数 (Java Client)</strong></p>
<pre><code class="hljs language-ini" lang="ini">SearchRequest <span class="hljs-attr">searchRequest</span> = new SearchRequest(<span class="hljs-string">"logs"</span>)<span class="hljs-comment">;</span>
SearchSourceBuilder <span class="hljs-attr">sourceBuilder</span> = new SearchSourceBuilder()<span class="hljs-comment">;</span>
sourceBuilder.query(QueryBuilders.matchQuery("message", "error"))<span class="hljs-comment">;</span>

// ⚠️ 警告：仅在必要时开启，注意性能损耗
sourceBuilder.trackTotalHits(true)<span class="hljs-comment">; </span>

// 或者设置一个具体的上限，例如 5万
// sourceBuilder.trackTotalHitsUpTo(50000)<span class="hljs-comment">; </span>

searchRequest.source(sourceBuilder)<span class="hljs-comment">;</span>
</code></pre>
<p><img alt="" title="点击并拖拽以移动" src="" loading="lazy"/></p>
<h3 data-id="heading-17">2. 高效替代方案：Cardinality 聚合</h3>
<p>如果你只是想知道“大概有多少条日志”，不要用 <code>track_total_hits</code>，请用 HyperLogLog 算法：</p>
<pre><code class="hljs language-json" lang="json">GET /logs/_search
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"size"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"aggs"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"total_count_approx"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"cardinality"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"field"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"_id"</span><span class="hljs-punctuation">,</span>  <span class="hljs-comment">// 或者其他高基数主键</span>
        <span class="hljs-attr">"precision_threshold"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">10000</span> 
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><img alt="" title="点击并拖拽以移动" src="" loading="lazy"/></p>
<ul>
<li>
<p>优点：性能极快，内存占用极低。</p>
</li>
<li>
<p>缺点：有约 5% 以内的误差。</p>
</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[大数据-222 离线数仓建模实战：事实表/维度表、三类事实表与雪花/星座模型]]></title>    <link>https://juejin.cn/post/7599478406238076937</link>    <guid>https://juejin.cn/post/7599478406238076937</guid>    <pubDate>2026-01-26T10:39:12.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599478406238076937" data-draft-id="7599294170000916531" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="大数据-222 离线数仓建模实战：事实表/维度表、三类事实表与雪花/星座模型"/> <meta itemprop="keywords" content="后端,大数据,Hadoop"/> <meta itemprop="datePublished" content="2026-01-26T10:39:12.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="武子康"/> <meta itemprop="url" content="https://juejin.cn/user/149189314230039"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            大数据-222 离线数仓建模实战：事实表/维度表、三类事实表与雪花/星座模型
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/149189314230039/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    武子康
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T10:39:12.000Z" title="Mon Jan 26 2026 10:39:12 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">TL;DR</h2>
<ul>
<li>场景：离线数仓主题建模，围绕事实表粒度、维度设计与模型选型落地。</li>
<li>结论：先定“粒度+事实类型”，再选星型/雪花/星座；累积快照允许更新但要管好里程碑日期键。</li>
<li>产出：事实表分类要点、模型选型边界、常见错误定位与修复清单。</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/654118d8b1c54b5db985ddf949215468~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770028752&amp;x-signature=Pp7DLR0JLw%2FGc46qkebFnotq%2Fc0%3D" alt="大数据-222 离线数仓建模实战：事实表/维度表、三类事实表与雪花/星座模型" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f8471afa6f5c47829bcc3edc3e0aa67c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770028752&amp;x-signature=fKRkO9xVmbdwXRz3JVndrWmnAcQ%3D" alt="离线数仓 架构图" loading="lazy"/></p>
<h2 data-id="heading-1">数仓模型</h2>
<h3 data-id="heading-2">事实表与维度表</h3>
<p>在数据仓库架构中，事实表（Fact Table）是存储业务过程度量值或事实的核心表结构。它是星型模式或雪花模式中的中心表，与多个维度表相关联。</p>
<p>事实表具有以下关键特征：</p>
<ol>
<li>包含业务过程的量化指标（事实），如销售额、订单数量、库存量等</li>
<li>通常包含外键（Foreign Key）用于关联维度表</li>
<li>数据量通常非常庞大，可能包含数百万甚至数十亿行记录</li>
<li>记录通常是只读的，反映历史业务活动</li>
</ol>
<p>事实表中的事实可以分为三种类型：</p>
<ul>
<li>可加性事实：可以按照任何维度进行汇总（如销售额）</li>
<li>半可加性事实：只能在部分维度上汇总（如账户余额）</li>
<li>不可加性事实：不能进行汇总（如单价、百分比）</li>
</ul>
<p>事实表的粒度（Granularity）是指表中每一行数据所代表的业务含义，常见粒度包括：</p>
<ul>
<li>交易级别：每条记录代表一个交易（如单个订单项）</li>
<li>快照级别：定期记录状态（如每日库存快照）</li>
<li>累积快照：跟踪业务过程多个阶段（如订单从创建到交付）</li>
</ul>
<p>例如，在零售数据仓库中，销售事实表可能包含以下字段：</p>
<ul>
<li>事实：销售金额、销售数量、折扣金额</li>
<li>外键：日期键、产品键、店铺键、客户键</li>
<li>退化维度：订单编号、发票编号</li>
</ul>
<p>事实表的设计直接影响数据仓库的性能和分析能力。合理选择事实表的粒度和事实类型，可以确保数据仓库既能满足分析需求，又能保持高效的查询性能。</p>
<p>在数据仓库架构中，事实表（Fact Table）是存储业务过程度量值或事实的核心表结构。它是星型模式或雪花模式中的中心表，与多个维度表相关联。</p>
<p>事实表具有以下关键特征：</p>
<ol>
<li>包含业务过程的量化指标（事实），如销售额、订单数量、库存量等</li>
<li>通常包含外键（Foreign Key）用于关联维度表</li>
<li>数据量通常非常庞大，可能包含数百万甚至数十亿行记录</li>
<li>记录通常是只读的，反映历史业务活动</li>
</ol>
<p>事实表中的事实可以分为三种类型：</p>
<ul>
<li>可加性事实：可以按照任何维度进行汇总（如销售额）</li>
<li>半可加性事实：只能在部分维度上汇总（如账户余额）</li>
<li>不可加性事实：不能进行汇总（如单价、百分比）</li>
</ul>
<p>事实表的粒度（Granularity）是指表中每一行数据所代表的业务含义，常见粒度包括：</p>
<ul>
<li>交易级别：每条记录代表一个交易（如单个订单项）</li>
<li>快照级别：定期记录状态（如每日库存快照）</li>
<li>累积快照：跟踪业务过程多个阶段（如订单从创建到交付）</li>
</ul>
<p>例如，在零售数据仓库中，销售事实表可能包含以下字段：</p>
<ul>
<li>事实：销售金额、销售数量、折扣金额</li>
<li>外键：日期键、产品键、店铺键、客户键</li>
<li>退化维度：订单编号、发票编号</li>
</ul>
<p>事实表的设计直接影响数据仓库的性能和分析能力。合理选择事实表的粒度和事实类型，可以确保数据仓库既能满足分析需求，又能保持高效的查询性能。</p>
<h4 data-id="heading-3">常见事实表</h4>
<p>常见的事实表：订单事实表
事实表的特点：表多（各种各样的事实表），数据量大
事实表根据数据的粒度可以分为：</p>
<ul>
<li>事务事实表</li>
<li>周期快照事实表</li>
<li>累积快照事实表</li>
</ul>
<h4 data-id="heading-4">常见维度表</h4>
<p>维度表（维表）可以看做是用来分析数据的角度，维度表中包含事实数据表在中事实记录的特性。有些特性提供描述性信息，有些特性指定如何汇总事实数据表数据，以便为分析者提供有用的信息。
常见维度表：</p>
<ul>
<li>时间维度</li>
<li>地域维度</li>
<li>商品维度</li>
</ul>
<h4 data-id="heading-5">简单小结</h4>
<ul>
<li>事实表是关注的内容（如：销售额、销售量）</li>
<li>维度表是观察事务的角度</li>
</ul>
<h3 data-id="heading-6">事实表分类</h3>
<h4 data-id="heading-7">事务事实表</h4>
<p>事务事实表记录的事务层面的事实，保存的是最原子的数据，也称为“原子事实表”。事务事实表中的数据在事务事件发生后产生，数据的粒度通常是每个事务一条记录。
一旦事务被提交，事实表数据被插入，数据就不再进行更改，其更新方式为增量更新。
事务事实表的日期维度记录的是事务发生的日期，它记录的事实是事务活动的内容。如：订单表。通过事务事实表，还可以建立聚集事实表，为用户提供高性能的分析。</p>
<h4 data-id="heading-8">周期快照事实表</h4>
<p>周期快照事实表以规律性的、可预见的时间间隔来记录事实，时间间隔如每天、每月、每年等等。典型的例子如销售日快照表、库存日快照表等。它统计的是间隔周期内的度量统计，如历史至今、自然年至今、季度至今等等。</p>
<h4 data-id="heading-9">累积快照事实表</h4>
<p>累积快照事实表和周期快照事实表虽然都是用于存储事务数据的快照信息，但在设计理念和应用场景上存在显著差异。以下是对两者更详细的对比说明：</p>
<ol>
<li>时间周期特性：</li>
</ol>
<ul>
<li>周期快照事实表：记录固定时间间隔（如每日、每周、每月）的静态快照数据。例如银行账户的月末余额快照。</li>
<li>累积快照事实表：跟踪跨越不确定时间段的完整业务流程，通常包含多个里程碑日期。例如订单处理流程中的各个关键节点时间。</li>
</ul>
<ol start="2">
<li>日期字段设计：</li>
</ol>
<ul>
<li>累积快照事实表包含多个日期维度：
<ul>
<li>流程起始日期（如订单创建日期）</li>
<li>中间过程日期（如审批日期、发货日期）</li>
<li>完成日期（如收货日期）</li>
<li>最后更新日期（记录数据补充时间）</li>
</ul>
</li>
<li>在初始加载时，未来日期通常使用特殊代理键（如-1表示"未发生"）占位</li>
</ul>
<ol start="3">
<li>数据更新机制：</li>
</ol>
<ul>
<li>周期快照事实表通常是只读的，反映特定时间点的状态</li>
<li>累积快照事实表支持更新操作，当业务流程推进时，可以补充后续日期信息。例如：
初始记录：订单创建日期=2023-01-01，发货日期=NULL
更新记录：当货物发出后，更新发货日期=2023-01-05</li>
</ul>
<ol start="4">
<li>典型应用场景：</li>
</ol>
<ul>
<li>累积快照事实表适用于：
<ul>
<li>订单处理全流程跟踪（创建→付款→发货→收货）</li>
<li>保险理赔流程（报案→定损→核赔→支付）</li>
<li>客户服务工单（创建→分配→处理→关闭）</li>
</ul>
</li>
</ul>
<ol start="5">
<li>示例字段说明：</li>
</ol>
<ul>
<li>订单处理累积快照可能包含：
<ul>
<li>时间维度：订货日期、审核通过日期、生产完成日期、发货日期、收货日期</li>
<li>业务度量：订单数量、商品金额、折扣金额、运费</li>
<li>状态标识：当前处理阶段、是否超期标志</li>
</ul>
</li>
</ul>
<p>这种设计方式特别适合需要分析业务流程时效性的场景，例如计算"订单创建到发货的平均时长"或"各环节的时间间隔分布"等分析需求。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/48db1aa62b364ad38982fe0ded9910eb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770028752&amp;x-signature=9174KxVjg9XTU8a0HxUaZzn3zuw%3D" alt="离线数仓 事实表 维度表" loading="lazy"/></p>
<h3 data-id="heading-10">雪花模型</h3>
<p>雪花模型是星型模型的变种，维表是规范化的，模型类似雪花的形状。
特点：雪花结构去除了数据冗余。
星型模型存在数据冗余，所以在查询统计时只需要做少量的表连接，查询效率高。星型模型不考虑维表正规化的因素，设计、实现容易。
在数据冗余可接受的情况下，实际上使用星型模型比较多。</p>
<h4 data-id="heading-11">雪花模型的结构</h4>
<p>事实表：
雪花模型的核心部分还是事实表，事实表通常存储了业务事件的度量数据，如销售额、订单数量等。
事实表包含指向维度表的外键。</p>
<p>维度表：
在雪花模型中，维度表进行规范化，意味着同一维度中的不同属性会拆分成多个子表。
例如，“客户”维度可能包含多个层级的属性：客户的基本信息可能存储在一个表中，而客户的地址信息可能存储在另一个单独的表中。这种方式使得维度表的数据冗余减少，提高了数据一致性。
子维度表：</p>
<p>雪花模型的一个特点是维度表的“分层”结构。例如，地理维度可能会被拆分成“国家”、“省/州”、“城市”等多个子维度表，每个表之间通过外键关联。</p>
<h4 data-id="heading-12">雪花模型的优缺点</h4>
<p>优点：</p>
<ul>
<li>数据冗余较低：由于维度表被规范化，雪花模型减少了数据的冗余。每个属性只会在相关的表中出现一次，这对于数据更新、删除和维护时，可以减少出现数据不一致的风险。</li>
<li>存储空间节省：由于规范化结构减少了重复数据，雪花模型相对于星型模型来说在存储上可以节省空间，特别是在处理大规模数据时，优势更加明显。</li>
<li>数据一致性较好：由于每个属性只存在于某个特定的维度表中，数据的一致性和完整性相对更容易保持。</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7e5a5602e36748bb90ca217e8713dab9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770028752&amp;x-signature=NyQCIbdUVbiQAhV1rWnnZ9tdR60%3D" alt="离线数仓事实表汇总" loading="lazy"/></p>
<h3 data-id="heading-13">事实星座</h3>
<p>数据仓库由多个主题构成，包含多个事实表，而维表是公共的，可以共享，这种模式可以看做星型模式的汇集。因而称作星系模式或者事实星座模式。
特点：公用维表</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0403e4b21ff7449b896c4cba873cb3db~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770028752&amp;x-signature=KXi7SWWyi1aEfBnk%2BL7n7fplN04%3D" alt="离线数仓事实星座" loading="lazy"/></p>
<h2 data-id="heading-14">元数据</h2>
<p>元数据（Metadata）是关于数据的数据，元数据打通了源数据、数据仓库、数据应用，记录了数据从产生到消费的全过程。元数据就相当于所有数据的地图，有了这张地图就能知道数据仓库中：</p>
<ul>
<li>有哪些数据</li>
<li>数据分布的情况</li>
<li>数据类型</li>
<li>数据之间有什么关系</li>
<li>哪些数据经常被使用，哪些数据很少有人光顾</li>
</ul>
<p>在大数据平台中，元数据贯穿大数据平台数据流动的全过程，主要包括数据源元数据、数据加工处理过程元数据、数据主题专题库元数据、服务层元数据、应用层元数据等。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/52409920a3194c00806da1bf3b1a2e9b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770028752&amp;x-signature=jItHhJ9sL1hIi2jxHE6dCjNWq1U%3D" alt="离线数仓元数据管理" loading="lazy"/>
业务通常把元数据分为以下类型：</p>
<ul>
<li>技术元数据：库表结构、数据模型、ETL程序、SQL程序等</li>
<li>业务元数据：业务指标、业务代码、业务术语等</li>
<li>管理元数据：数据所有者、数据质量、数据安全等</li>
</ul>
<h2 data-id="heading-15">错误速查</h2>



























































<table><thead><tr><th>症状</th><th>根因</th><th>定位修复指标</th><th>汇总结果</th></tr></thead><tbody><tr><td>忽大忽小、同一报表口径不一致</td><td>事实表粒度未固定；把不同粒度数据混进同一事实表或同一指标口径</td><td>逐条确认“事实表一行代表什么业务事件”；检查 join 前后的行数膨胀</td><td>先锁定粒度（交易/快照/累积）；必要时拆表：原子事实表 + 聚集事实表</td></tr><tr><td>SUM 后数据被重复计算</td><td>维度表一对多导致事实行被放大；维表主键不唯一</td><td>对维表做唯一性检查；对 join 结果做 count(distinct 事实主键)</td><td>维表补齐主键/去重；用桥表或 SCD 设计；在语义层限制 join 路径</td></tr><tr><td>半可加指标（余额/库存）按时间直接 SUM 错误</td><td>把半可加事实当可加事实处理</td><td>检查指标类型与聚合维度；看是否跨时间直接 sum</td><td>用“期末/期初/快照点”口径；改为 max/last_value 或按快照周期汇总</td></tr><tr><td>单价/折扣率等不可加指标被 SUM/AVG 后失真</td><td>指标本质不可加；平均未加权</td><td>找到指标的业务定义与分母；检查是否需要加权</td><td>改为加权平均（sum(分子)/sum(分母)）；或改成可加分子与分母分别入事实表</td></tr><tr><td>累积快照事实表里程碑日期缺失/乱序</td><td>业务流程未闭环；更新机制不清；“未发生”占位不一致</td><td>检查每个里程碑字段的取数逻辑与更新触发；核对代理键（-1 等）</td><td>统一占位规则；按阶段增量更新；为每个里程碑定义来源与可回填策略</td></tr><tr><td>雪花模型查询慢、SQL 复杂且容易写错</td><td>过度规范化导致 join 链过长</td><td>统计典型查询 join 数；观察执行计划与 shuffle</td><td>以星型为主：适度反规范化；为高频分析做宽表/维表冗余或物化视图</td></tr><tr><td>事实星座中跨主题分析结果对不上</td><td>公共维度未统一（编码/层级/主键体系不一致）</td><td>检查共享维表的主键、层级与业务口径；看是否存在多套维表</td><td>统一公共维（如时间/地域/商品）；做一致性维度建模与编码治理</td></tr><tr><td>元数据“有表无口径/有口径无血缘”，治理落空</td><td>只收技术元数据，缺业务口径与责任人；血缘未自动化</td><td>抽查指标：定义、负责人、来源链路、下游使用</td><td>同步补齐业务元数据与管理元数据；接入血缘采集（ETL/SQL/调度）并做质量与权限闭环</td></tr></tbody></table>
<h2 data-id="heading-16">其他系列</h2>
<h3 data-id="heading-17">🚀 AI篇持续更新中（长期更新）</h3>
<p><strong>AI炼丹日志-29 - 字节跳动 DeerFlow 深度研究框<em>斜体样式</em>架 私有部署 测试上手 架构研究</strong>，持续打造实用AI工具指南！
<strong>AI研究-132 Java 生态前沿 2025：Spring、Quarkus、GraalVM、CRaC 与云原生落地</strong></p>
<h3 data-id="heading-18">💻 Java篇持续更新中（长期更新）</h3>
<p><strong>Java-218 RocketMQ Java API 实战：同步/异步 Producer 与 Pull/Push Consumer</strong>
MyBatis 已完结，Spring 已完结，Nginx已完结，Tomcat已完结，分布式服务已完结，Dubbo已完结，MySQL已完结，MongoDB已完结，Neo4j已完结，FastDFS 已完结，OSS已完结，GuavaCache已完结，EVCache已完结，RabbitMQ已完结，RocketMQ正在更新... 深入浅出助你打牢基础！</p>
<h3 data-id="heading-19">📊 大数据板块已完成多项干货更新（300篇）：</h3>
<p>包括 Hadoop、Hive、Kafka、Flink、ClickHouse、Elasticsearch 等二十余项核心组件，覆盖离线+实时数仓全栈！
<strong>大数据-278 Spark MLib - 基础介绍 机器学习算法 梯度提升树 GBDT案例 详解</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[中文离线CPU环境下ASR模型技术选型指南]]></title>    <link>https://juejin.cn/post/7599474528238452776</link>    <guid>https://juejin.cn/post/7599474528238452776</guid>    <pubDate>2026-01-26T08:47:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599474528238452776" data-draft-id="7599474528238239784" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="中文离线CPU环境下ASR模型技术选型指南"/> <meta itemprop="keywords" content="后端,Python"/> <meta itemprop="datePublished" content="2026-01-26T08:47:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="马农可夫"/> <meta itemprop="url" content="https://juejin.cn/user/2541726616262061"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            中文离线CPU环境下ASR模型技术选型指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2541726616262061/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    马农可夫
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T08:47:02.000Z" title="Mon Jan 26 2026 08:47:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">中文离线CPU环境下ASR模型技术选型指南</h2>
<p>在语音识别（ASR）落地场景中，中文适配性、离线部署能力及CPU环境兼容性是核心诉求，尤其对于政务、客服、嵌入式终端等无GPU支持、需本地闭环运行的场景，选型直接决定项目落地效率与用户体验。本文基于PaddleSpeech、FunASR、Whisper V3等9款主流开源ASR模型，结合离线CPU部署需求，从适配性、效果、部署难度等维度展开分析，提供精准选型方案与落地建议。</p>
<h3 data-id="heading-1">一、选型核心评估维度</h3>
<p>针对中文离线CPU场景，需聚焦四大核心维度，避免因资源不匹配导致推理卡顿、精度不足等问题：</p>
<ol>
<li><strong>CPU适配性</strong>：核心关注模型量化能力（int8/int4）、内存占用、推理速度，优先选择对CPU线程优化、支持轻量推理框架的模型；</li>
<li><strong>中文效果</strong>：包括普通话识别准确率、逆文本正则化（数字、日期、专有名词转换）、方言适配性（可选），需贴合中文口语场景特点；</li>
<li><strong>部署难度</strong>：依赖库复杂度、是否提供预编译包/API、跨平台支持（Windows/Linux），降低项目集成成本；</li>
<li><strong>功能适配</strong>：是否支持流式识别（实时对话）、批量转写、VAD（语音活性检测）一体化，匹配具体业务场景。</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/99d0fbce84764a18a675b8e28b798222~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6ams5Yac5Y-v5aSr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770022021&amp;x-signature=j%2BWExdhW7PJ9MwsLCmQq3P%2FdKr8%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-2">二、主流模型分项评估与适配场景</h3>
<p>结合上述维度，对9款模型进行分级评估，按“优先推荐-可备选-不推荐”分类，明确各模型的适用边界。</p>
<h4 data-id="heading-3">（一）优先推荐模型（CPU离线场景最佳适配）</h4>
<p>此类模型在中文效果、CPU推理效率、部署便捷性上达到平衡，可直接落地工业级场景。</p>
<h5 data-id="heading-4">1. FunASR（阿里达摩院）</h5>
<p>作为阿里达摩院面向中文场景优化的开源ASR工具包，FunASR是CPU离线部署的首选方案。其核心优势的在于中文适配深度与轻量量化能力：提供专为CPU优化的Nano模型，int8量化后体积仅100MB左右，内存占用低至500MB以下，单CPU（4线程）推理速度可达实时1.5倍以上，满足批量转写与流式识别双重需求。</p>
<p>部署层面，FunASR基于onnxruntime实现纯CPU离线运行，无需复杂依赖，支持Python/C++双接口，Windows与Linux系统均能快速集成，同时提供丰富的预训练模型（覆盖通用场景、政务、客服等垂直领域），可直接调用无需额外微调。适合政务语音转写、客服质检、本地桌面应用等对精度与效率均有要求的场景。</p>
<h5 data-id="heading-5">2. WeNet（百度&amp;清华大学）</h5>
<p>WeNet是工业级端到端ASR工具包，以低延迟流式识别为核心优势，完美适配CPU离线实时场景。其中文预训练模型基于大规模中文语料训练，普通话识别准确率优异，支持int8量化优化，CPU推理延迟可控制在100ms以内，且内存占用稳定，不会因长音频推理出现内存溢出问题。</p>
<p>部署上，WeNet提供轻量C++推理库与Python SDK，支持容器化部署与边缘设备集成，可灵活配置线程数与量化策略，适配不同CPU资源场景。相较于FunASR，WeNet在实时对话转写场景更具优势，适合政务实时交互终端、智能客服话术实时记录等场景。</p>
<h5 data-id="heading-6">3. SenseVoice（阿里达摩院，基于sherpa-onnx）</h5>
<p>SenseVoice以“轻量化一体化”为核心亮点，int8量化后模型体积229MB，内置VAD+ASR+标点预测全链路能力，无需额外集成第三方VAD工具，极大简化离线部署流程。其逆文本正则化能力突出，可精准转换数字、日期、金额等中文特殊表述，贴合实际业务场景需求。</p>
<p>该模型基于onnx格式分发，支持纯CPU离线运行，适配Windows、macOS、Linux多系统，甚至可部署至嵌入式设备（如ARM架构CPU）。推理速度在单CPU环境下可满足实时需求，适合轻量化离线转写、移动政务终端、嵌入式语音设备等资源受限但需全链路能力的场景。</p>
<h4 data-id="heading-7">（二）可备选模型（需权衡资源与效果）</h4>
<p>此类模型存在部分短板，需根据具体场景取舍，仅在特定需求下考虑选用。</p>
<h5 data-id="heading-8">1. PaddleSpeech（百度）</h5>
<p>PaddleSpeech中文识别准确率极佳，且支持ASR+TTS+语音合成一体化能力，若项目需多语音功能联动，可作为备选。但其依赖PaddlePaddle框架，CPU环境下部署依赖项略多，模型量化后的体积与推理速度略逊于FunASR，单CPU推理实时性一般，适合结合飞桨生态、对多语音能力有需求的政务或企业级项目。</p>
<h5 data-id="heading-9">2. Faster-whisper</h5>
<p>作为Whisper V3的优化版本，Faster-whisper通过量化与推理引擎优化，提升了CPU适配性，支持int8量化后模型体积缩小至原版本的1/4。其优势在于多语种支持与中英混读能力，若场景涉及少量英文内容，可作为备选。但CPU环境下推理速度仍较慢，仅适合短音频转写，长音频批量处理效率不足，且中文专有名词识别准确率略低于FunASR、WeNet。</p>
<h5 data-id="heading-10">3. Vosk（Alpha Cephei）</h5>
<p>Vosk是极致轻量化的离线ASR工具，中文小模型体积仅40MB，内存占用低于500MB，支持树莓派等低配置CPU设备，开箱即用无需复杂配置，部署难度极低。但其中文识别准确率一般，仅能满足日常简单语音转写需求，不适合对精度要求较高的政务、客服场景，仅推荐用于资源极度受限的轻量嵌入式设备。</p>
<h5 data-id="heading-11">4. DeepSpeech（Mozilla）</h5>
<p>DeepSpeech基于CTC架构，模型轻量化且文档完善，适合新手入门学习或小型离线项目。其CPU适配性良好，支持多系统部署，但中文预训练语料不足，识别准确率与逆文本正则化能力较弱，推理速度中等，仅推荐用于学习研究、原型验证等非工业级场景。</p>
<h4 data-id="heading-12">（三）不推荐模型（CPU环境适配性极差）</h4>
<p>此类模型因体积过大、依赖GPU加速，在纯CPU环境下无法正常落地，直接排除。</p>
<ul>
<li><strong>GLM-ASR-Nano-2512</strong>：模型体积约4.5GB，纯CPU环境下推理极慢（单句10秒音频需数秒推理时间），且内存占用极高，易出现卡顿与内存溢出，仅适合GPU环境使用。</li>
<li><strong>Whisper V3</strong>：原生模型体积大，CPU推理耗时久，即使经过量化优化，效率仍远低于FunASR、WeNet，纯CPU场景无竞争优势。</li>
<li><strong>VibeVoice-ASR</strong>：模型参数达9B，严重依赖CUDA GPU加速，纯CPU环境下推理几乎不可用，且部署复杂度极高，不适合CPU离线场景。</li>
</ul>
<h3 data-id="heading-13">三、落地选型决策路径与优化建议</h3>
<h4 data-id="heading-14">（一）选型决策路径</h4>
<p>结合业务场景快速锁定模型，可遵循以下决策逻辑：</p>
<ol>
<li>若需<strong>高精度+高效率+易部署</strong>（通用工业级场景）：优先选FunASR；</li>
<li>若需<strong>实时流式识别</strong>（如实时对话、智能终端）：优先选WeNet；</li>
<li>若需<strong>极致轻量化+全链路能力</strong>（嵌入式/边缘设备）：选SenseVoice；</li>
<li>若需<strong>多语种/中英混读</strong>（短音频场景）：可备选Faster-whisper；</li>
<li>若为<strong>资源极度受限的轻量场景</strong>（非高精度需求）：备选Vosk。</li>
</ol>
<h4 data-id="heading-15">（二）CPU离线部署优化建议</h4>
<p>为进一步提升CPU环境下的推理效率，可采用以下优化策略：</p>
<ol>
<li><strong>模型量化</strong>：优先选用int8量化模型，相较于FP32模型，体积缩小4倍，推理速度提升2-3倍，且精度损失控制在1%-2%以内，几乎不影响业务使用；</li>
<li><strong>线程配置</strong>：根据CPU核心数合理设置推理线程（建议4-8线程），避免线程过多导致资源竞争，线程过少影响推理速度；</li>
<li><strong>推理框架</strong>：优先使用onnxruntime框架，启用CPU优化选项（如MKLDNN加速），进一步提升推理效率；</li>
<li><strong>音频预处理</strong>：统一音频格式为16kHz、单声道、16bit，减少模型预处理耗时，提升推理流畅度。</li>
</ol>
<h3 data-id="heading-16">四、总结</h3>
<p>中文离线CPU环境下的ASR选型，核心是平衡“精度、效率、部署成本”三者关系。FunASR、WeNet、SenseVoice三款模型覆盖了绝大多数工业级场景，其中FunASR综合表现最优，可作为首选；WeNet与SenseVoice分别在流式识别、轻量化场景中具备独特优势，可针对性选用。</p>
<p>选型时需坚决排除GPU依赖型模型，同时根据业务场景的精度需求、资源限制、功能诉求，灵活调整模型与优化策略，确保项目高效落地。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[通过重新生成来修复字体文件问题]]></title>    <link>https://juejin.cn/post/7599155566298071083</link>    <guid>https://juejin.cn/post/7599155566298071083</guid>    <pubDate>2026-01-26T09:43:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599155566298071083" data-draft-id="7594627998839423018" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="通过重新生成来修复字体文件问题"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-26T09:43:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="乘风转舵"/> <meta itemprop="url" content="https://juejin.cn/user/2260251640086279"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            通过重新生成来修复字体文件问题
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2260251640086279/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    乘风转舵
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T09:43:38.000Z" title="Mon Jan 26 2026 09:43:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">有没有遇到这种情况，</h2>
<blockquote>
<p>美术导出的字体，她用着可以，但是前端页面引用就不生效</p>
</blockquote>
<h2 data-id="heading-1">可能的原因</h2>
<h3 data-id="heading-2">1. 浏览器的“安检机制”：OTS 拦截</h3>
<p>现代浏览器（Chrome、Firefox、Safari）在加载 Web 字体时，都会运行一个叫作 <strong>OTS (OpenType Sanitizer)</strong> 的程序。</p>
<ul>
<li><strong>它的职责：</strong> 防止恶意字体利用解析漏洞攻击用户的系统。它会对字体的每一个二进制 Table（数据表）进行极其严格的校验。</li>
<li><strong>后果：</strong> 如果字体文件的校验和（Checksum）对不上，或者内部索引表有 1 字节的偏移错误，浏览器会<strong>直接拒绝加载</strong>该文件，并在控制台报错。</li>
<li><strong>Photoshop 的做法：</strong> PS 调用的是操作系统的字体引擎（或者是 Adobe 自家的引擎）。这些引擎为了兼容老旧字体，通常非常“宽容”。即使文件结构有瑕疵，只要它能找到笔画数据，它就能强行画出来。</li>
</ul>
<h3 data-id="heading-3">2. 权限与版权位（Embedding Bits）</h3>
<p>字体文件内部有一个字段叫 <code>fsType</code>，专门标记该字体是否允许“嵌入”。</p>
<ul>
<li><strong>网页端的限制：</strong> 如果这个位被设置为“受限（Restricted）”，浏览器会遵循版权协议，拒绝在网页上显示该字体。</li>
<li><strong>Photoshop 的做法：</strong> 既然设计师能把字体装进系统，PS 就认为你已经拥有了使用权，所以它不会限制你在设计稿里使用它。</li>
<li><strong>FontForge 的作用：</strong> 当你在 FontForge 里导出新字体时，默认设置通常会重置这些权限位，使其变为“可嵌入（Installable Embedding）”，从而解开了浏览器的枷锁。</li>
</ul>
<h3 data-id="heading-4">3. 命名空间与跨域（CORS）</h3>
<p>虽然这与字体内部结构关系较小，但也是前端常遇到的坑：</p>
<ul>
<li><strong>文件头信息：</strong> 有些字体内部的 <code>PostScript Name</code> 包含特殊字符或中文字符，PS 能够识别，但 CSS 引用时如果名称不匹配或包含非法字符，浏览器就找不到。</li>
<li><strong>FontForge 的作用：</strong> 导出过程会根据规范重新格式化字体的“名字表（Naming Table）”，消除了命名的歧义。</li>
<li/>
</ul>
<h2 data-id="heading-5">解决方法</h2>
<h3 data-id="heading-6">使用FontForge这类字体编辑器重新生成一下字体文件来解决</h3>
<p>重新生成会做如下的事情</p>
<ol>
<li><strong>清理冗余数据：</strong> FontForge 会丢弃原文件中不规范的自定义数据。</li>
<li><strong>重新计算校验：</strong> 它会为所有的 Table 重新计算正确的校验和（Checksum），这直接通过了浏览器的 <strong>OTS 安检</strong>。</li>
<li><strong>标准化格式：</strong> 它强制按照 OpenType/TrueType 最新的标准协议来排列文件的二进制结构。</li>
</ol>
<blockquote>
</blockquote>
<h3 data-id="heading-7">FontForge下载</h3>
<ul>
<li>开源免费</li>
<li>跨平台（Windows/macOS/Linux）</li>
<li>支持 TTF/OTF/WOFF/WOFF2/SVG/BDF 等互转</li>
</ul>
<p>官网  <a href="https://link.juejin.cn?target=https%3A%2F%2Ffontforge.org" target="_blank" title="https://fontforge.org" ref="nofollow noopener noreferrer">fontforge.org</a></p>
<p>使用文档  <a href="https://link.juejin.cn?target=https%3A%2F%2Ffontforge.org%2Fdocs%2Fui%2Fmenus.html" target="_blank" title="https://fontforge.org/docs/ui/menus.html" ref="nofollow noopener noreferrer">fontforge.org/docs/ui/men…</a></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/814ae29c63e8410c95c4ea6cef551c10~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LmY6aOO6L2s6Ii1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770025417&amp;x-signature=MjP4lFPe5Mpz88gfaWBT2RBTXbo%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-8">导入字体</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7cd6750de6cc4dbeb6f6956ae7a86931~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LmY6aOO6L2s6Ii1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770025417&amp;x-signature=i5PLeLJcFGrPhV4d3e9RdRZ6flg%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-9">这里可以查看字体的报错</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/83b3a0db54914b2dadee1243797e72f0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LmY6aOO6L2s6Ii1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770025417&amp;x-signature=%2FzFlAOVrsNz7yNdEJaizqN8HS2I%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b4a871797ae14a02926b69751cab4608~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LmY6aOO6L2s6Ii1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770025417&amp;x-signature=jVxWVmdVXz9WsBsRQ9QF7jx3kNk%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li>
<p><code>Missing Points at Extrema</code>（极值点缺失）：这主要影响字体在特定尺寸下的渲染清晰度（Hinting）。</p>
</li>
<li>
<p><code>Self Intersecting</code>（路径自相交）：这可能导致某些软件里填充色块异常。</p>
</li>
<li>
<p><strong>结论：</strong> 这些属于“绘图规范”问题，<strong>它们通常不会导致字体无法加载</strong>，只会让字看起来可能有点丑或渲染不完美</p>
</li>
</ul>
<h3 data-id="heading-10">重新生成字体文件</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/44c4714fb62f46178fe0c64843627e83~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LmY6aOO6L2s6Ii1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770025417&amp;x-signature=9ttgk76eIytWsOCX%2Fnae%2FObj8Xw%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-11">选择导出的文件格式</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9d66250a8de4492aaa75f4bd18b53ae1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LmY6aOO6L2s6Ii1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770025417&amp;x-signature=gNbqhh9T2AKCS9xOar%2FWs2O5%2Bkw%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li>
<p><strong>原始文件可能存在的问题：</strong> 原始字体可能存在损坏的偏移量、错误的校验和（Checksum）、或者不符合规范的 Header（头部信息）。浏览器（尤其是 Chrome/Firefox）对 Web 字体的安全性检查非常严格，只要结构有一点不合规，就会拒绝加载。</p>
</li>
<li>
<p><strong>FontForge 的作用：</strong> 当你点击“Generate”时，FontForge 并不是简单地“复制”旧文件，而是根据它内存中的数据模型，<strong>重新从零开始构建</strong>了一个全新的 <code>.ttf</code> 文件。它会自动生成符合标准的新 Table（如 <code>head</code>, <code>hhea</code>, <code>maxp</code>, <code>OS/2</code> 等）。这个“重写”过程自动修复了导致浏览器报错的底层结构问题。</p>
</li>
</ul>
<p><strong>导出之后新的字体文件就可以用了，对于前端来说了解到这就够用了</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Three.js 色彩空间的正确使用方式]]></title>    <link>https://juejin.cn/post/7599155566298087467</link>    <guid>https://juejin.cn/post/7599155566298087467</guid>    <pubDate>2026-01-26T09:44:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599155566298087467" data-draft-id="7599299048302575659" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Three.js 色彩空间的正确使用方式"/> <meta itemprop="keywords" content="前端,three.js"/> <meta itemprop="datePublished" content="2026-01-26T09:44:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="乘风转舵"/> <meta itemprop="url" content="https://juejin.cn/user/2260251640086279"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Three.js 色彩空间的正确使用方式
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2260251640086279/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    乘风转舵
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T09:44:34.000Z" title="Mon Jan 26 2026 09:44:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{line-height:1.75;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;letter-spacing:2px;background-image:linear-gradient(90deg,rgba(50,0,0,.05) 3%,transparent 0),linear-gradient(1turn,rgba(50,0,0,.05) 3%,transparent 0);background-size:20px 20px;background-position:50%;word-break:break-word;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body h1{font-size:23px;margin-bottom:5px;font-weight:700;padding-left:10px;border-left:5px solid #773098}.markdown-body h2{font-size:19px;font-weight:700;padding-left:10px;border-left:5px solid #916dd5}.markdown-body h3{font-size:17px;font-weight:700;padding-left:10px;border-left:5px solid #d89cf6}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{font-size:14px;margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{display:block;max-width:100%;margin:1em 0;border-radius:6px;box-shadow:2px 4px 7px #999;user-select:none}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{padding:.2em .5em;font-weight:700;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;font-size:1em;color:#916dd5;word-break:break-word;overflow-x:auto;background-color:none;border-radius:2px}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;font-weight:400;font-size:.9em;padding:16px 12px;margin:0;color:#333;word-break:normal;overflow-x:auto;background:#f8f8f8;scroll-behavior:smooth}.markdown-body a{text-decoration:none;color:#916dd5;font-weight:700;border-bottom:1px solid #916dd5}.markdown-body a:active,.markdown-body a:hover{color:#773098}.markdown-body table{display:inline-block!important;font-size:14px;width:auto;max-width:100%;overflow:auto;border:1px solid #916dd5;border-collapse:collapse}.markdown-body thead{background-color:#916dd5;color:#fff;text-align:left}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px;border:1px solid #916dd5}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #d89cf6;background-color:#f4eeff}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0;line-height:26px}.markdown-body ol,.markdown-body ul{padding-left:28px;list-style-type:circle}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body b,.markdown-body strong{color:#916dd5;font-weight:700}.markdown-body b:before,.markdown-body strong:before{content:"「"}.markdown-body b:after,.markdown-body strong:after{content:"」"}.markdown-body em,.markdown-body i{color:#916dd5}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="github-gist">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fff;color:#333}.hljs-comment,.hljs-meta{color:#969896}.hljs-emphasis,.hljs-quote,.hljs-strong,.hljs-template-variable,.hljs-variable{color:#df5000}.hljs-keyword,.hljs-selector-tag,.hljs-type{color:#d73a49}.hljs-attribute,.hljs-bullet,.hljs-literal,.hljs-symbol{color:#0086b3}.hljs-name,.hljs-section{color:#63a35c}.hljs-tag{color:#333}.hljs-attr,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-id,.hljs-selector-pseudo,.hljs-title{color:#6f42c1}.hljs-addition{color:#55a532;background-color:#eaffea}.hljs-deletion{color:#bd2c00;background-color:#ffecec}.hljs-link{text-decoration:underline}.hljs-number{color:#005cc5}.hljs-string{color:#032f62}</style><h2 data-id="heading-0">three中色彩空间常见用处</h2>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 给材质设置色彩空间</span>
material1.map.colorSpace = THREE.SRGBColorSpace;

<span class="hljs-comment">// 给渲染器的输出色彩空间, 不设置的话默认值也是SRGBColorSpace</span>
<span class="hljs-keyword">new</span> THREE.<span class="hljs-built_in">WebGLRenderer</span>( { outputColorSpace: THREE.SRGBColorSpace } );
</code></pre>
<blockquote>
<p>three.js r152+ 之后默认就是 <code>SRGBColorSpace</code>，老版本（<code>outputEncoding</code> 时代）行为不同</p>
</blockquote>
<h2 data-id="heading-1">色彩空间的选项</h2>
<ul>
<li>
<p>SRGBColorSpace-sRGB 色彩空间</p>
</li>
<li>
<p>LinearSRGBColorSpace-线性sRGB色彩空间</p>
</li>
</ul>
<h2 data-id="heading-2">区别？</h2>
<p><strong>SRGBColorSpace进行了伽马校正</strong></p>
<h2 data-id="heading-3">为什么会有伽马校正？</h2>
<ol>
<li>
<h3 data-id="heading-4">纠正硬件的问题</h3>
</li>
</ol>
<p>在液晶显示器普及之前，使用的是笨重的 <strong>CRT</strong> <strong>（阴影</strong> <strong>栅格</strong> <strong>显像管</strong> <strong>）</strong> 电视。CRT 的工作原理是用电子枪射出电子束轰击屏幕，科学家发现，电子枪的电压值和屏幕产生的亮度之间并不是 1:1 的线性关系，而是一个幂函数关系：</p>
<p>也就是如下图中红色曲线所示，跟原本蓝色虚线比较，亮度是偏低的</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/64c5ad22775e4c8bbe15f0becd4349ab~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LmY6aOO6L2s6Ii1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770025477&amp;x-signature=g614mGmcGMEw7bKVH55AlavzE5Q%3D" alt="" loading="lazy"/></p>
<p>所以为了还原真实效果，抵消调 <strong>CRT</strong>压低的亮度，那就把真实亮度数据提高，提高成绿色曲线那样，这样一抵消，显示就正常了，这个提高的过程就是伽马校正</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/14fe97c5b3f2465fbe306f521e83eaaf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LmY6aOO6L2s6Ii1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770025477&amp;x-signature=dXN9kq9iDejcOrQzG%2FaxZDpDx5Q%3D" alt="" loading="lazy"/></p>
<ol start="2">
<li>
<h3 data-id="heading-5">也能满足存储空间合理分配</h3>
</li>
</ol>
<ul>
<li>
<p><strong>人眼特性</strong>：我们对暗部的变化非常敏感，而对亮部的变化比较迟钝。</p>
</li>
<li>
<p><strong>数据分配的矛盾</strong>：如果我们在电脑里用“线性”方式存储亮度（比如 0 代表黑，128 代表半亮，255 代表全亮）：</p>
<ul>
<li>在 0 到 10 之间（暗部），只有 10 个档位。因为我们眼睛太敏感，这 10 个档位之间的跳变看起来会像阶梯一样，非常不自然（这就是“色彩断层”）。</li>
<li>在 200 到 250 之间（亮部），虽然有 50 个档位，但我们的眼睛根本分不出这 50 种亮度的区别。这部分昂贵的存储空间（位深）就被<strong>浪费</strong>了。</li>
</ul>
</li>
<li>
<p><strong>解决方案（伽马编码）</strong> ： 故意把 256 个档位中的大部分都分给“暗部”，只留少部分给“亮部”。这样既照顾了人眼的敏感度，又没有浪费存储空间。这样我们可以在 8 位（0-255）的空间里，把更多数值分配给敏感的暗部，让有限的资源发挥最大效用。如图所示（随便找一个以前的暗部区域值，映射后占居的区域明显变多）</p>
</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fb9888e1877b4336a9a2f3344490c4f4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LmY6aOO6L2s6Ii1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770025477&amp;x-signature=KaHZ%2FjNpcEZOjqiA0KTA58Fs3AE%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-6">为什么现在屏幕“正常”了，还需要它？</h2>
<p>现在的液晶（LCD）或 OLED 屏幕完全可以做到“给 128 就亮 50%”，为什么还要折腾？</p>
<h3 data-id="heading-7">行业标准的惯性</h3>
<p>全球互联网上 99% 的图片（JPEG）、视频（MP4）和网页标准（HTML/CSS）都是基于 <strong>sRGB</strong> 色彩空间存储的</p>
<ul>
<li>
<p>如果显示器突然改为“线性显示”，那么所有的互联网内容看起来都会变得<strong>非常亮</strong>。</p>
</li>
<li>
<p>并且图片大多还是如图所示8位，需要上面说过的满足存储空间并合理分配</p>
</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ebc0a6068a5740dabf5ad078436742ce~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LmY6aOO6L2s6Ii1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770025477&amp;x-signature=1KoT0lLRjTPLqMWe74jyjnzGt8Y%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-8">正确色彩空间处理的流程</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f3fdafe40b0f4b399c8f95bcd774a2d8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LmY6aOO6L2s6Ii1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770025477&amp;x-signature=OAbZ92yxjuxqdjoAU4iB7Ud9ggw%3D" alt="" loading="lazy"/></p>
<ol>
<li>
<p><strong>原始图片</strong> 默认是 sRGB 色彩空间，它自带一条 “上翘” 的伽马曲线</p>
</li>
<li>
<p><strong>转成</strong> <strong>线性空间</strong> ：在进入 GPU 运算前，需要先把图片从 sRGB 非线性空间转换为 <strong>Linear（线性）sRGB</strong> 空间。这一步会把上翘的曲线 “拉平” 成一条直线，让亮度数据恢复成物理上均匀的数值，确保后续的光照、混合等计算结果是准确的。</p>
</li>
<li>
<p><strong>程序运算</strong> ：在<strong>线性空间</strong>里进行渲染计算，比如光影追踪、材质混合、特效合成等。因为线性空间的亮度是均匀的，所以计算出来的光影效果才符合物理规律，不会出现颜色偏差或暗部丢失。</p>
</li>
<li>
<p><strong>渲染结果</strong> ：对计算结果，经过伽马校正后，得到的就是最终的 sRGB 格式渲染结果，它的亮度曲线和原始图片的格式是一致的。</p>
</li>
<li>
<p><strong>显示器显示</strong> 🖥️显示器接收到 sRGB 信号后，会用它自带的伽马曲线（通常 γ≈2.2）来显示，这个过程会把信号 “压暗”。因为我们已经提前做了伽马校正，所以两次曲线变化刚好抵消，最终显示在屏幕上的亮度就和我们计算的结果完全一致。</p>
</li>
<li>
<p><strong>人眼感知</strong> 👀最终画面被人眼看到，色彩和亮度都保持了设计和计算时的真实效果，不会出现过暗或过亮的问题。</p>
</li>
</ol>
<h3 data-id="heading-9">总结</h3>
<p>也就是我们要保证用来计算的时候是 <strong>Linear（</strong> <strong>线性</strong>空间，用来渲染的时候是<strong>sRGB</strong> 空间，那在three中如何做到？</p>
<h2 data-id="heading-10">Three.js从输入的角度</h2>
<p><strong>Three.js中我们只需要指定</strong> <strong>色彩空间</strong> <strong>类型即可，程序会帮我们转成线性，所以我们要做的就是把应该指定为SRGBColorSpace的纹理，指定为SRGBColorSpace</strong></p>
<h3 data-id="heading-11">举几种常见加载器对加载后的图片色彩空间的处理逻辑</h3>
<h4 data-id="heading-12">TextureLoader</h4>
<p>TextureLoader 不设置 colorSpace，保持默认 NoColorSpace，需要手动设置：</p>
<p>注意！颜色纹理需要手动指定色彩空间为SRGBColorSpace，像下文GLTFLoader中的逻辑一样，</p>
<p>例如</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">texture</span> = await loader.loadAsync( <span class="hljs-string">'textures/land_ocean_ice_cloud_2048.jpg'</span> )<span class="hljs-comment">;</span>
<span class="hljs-attr">texture.colorSpace</span> = THREE.SRGBColorSpace<span class="hljs-comment">;</span>
</code></pre>
<h4 data-id="heading-13">CubeTextureLoader</h4>
<p>CubeTextureLoader 固定设置为 SRGBColorSpace：</p>
<h4 data-id="heading-14">GLTFLoader</h4>
<p>只有颜色纹理会被设置为 SRGBColorSpace，其他纹理保持 NoColorSpace：</p>
<p>设置为 SRGBColorSpace 的纹理：</p>
<ul>
<li>
<p>baseColorTexture (map) → SRGBColorSpace</p>
</li>
<li>
<p>emissiveTexture (emissiveMap) → SRGBColorSpace</p>
</li>
<li>
<p>sheenColorTexture (sheenColorMap) → SRGBColorSpace</p>
</li>
<li>
<p>specularColorTexture (specularColorMap) → SRGBColorSpace</p>
</li>
</ul>
<h3 data-id="heading-15">这几种色彩空间标记的处理逻辑</h3>

























<table><thead><tr><th>exture.colorSpace</th><th>内部格式</th><th>sRGB → Linear 转换</th></tr></thead><tbody><tr><td>NoColorSpace（默认）</td><td>RGBA8</td><td>不转换，原样上传</td></tr><tr><td>SRGBColorSpace</td><td>SRGB8_ALPHA8</td><td>GPU 采样时自动转 SRGB8_ALPHA8 是 WebGL 2.0 的 sRGB 纹理格式 GPU 在采样时自动应用 sRGB EOTF（Electro-Optical Transfer Function）将 sRGB 转为线性</td></tr><tr><td>LinearSRGBColorSpace</td><td>RGBA8</td><td>不转换，已是线性</td></tr></tbody></table>
<h3 data-id="heading-16">也提供了方法可以手动转化，THREE.Color 类下即可调用</h3>
<p>src/math/ColorManagement.js</p>
<pre><code class="hljs language-r" lang="r">export <span class="hljs-keyword">function</span> SRGBToLinear<span class="hljs-punctuation">(</span> <span class="hljs-built_in">c</span> <span class="hljs-punctuation">)</span> <span class="hljs-punctuation">{</span>

    <span class="hljs-built_in">return</span> <span class="hljs-punctuation">(</span> <span class="hljs-built_in">c</span> <span class="hljs-operator">&lt;</span> <span class="hljs-number">0.04045</span> <span class="hljs-punctuation">)</span> <span class="hljs-operator">?</span> <span class="hljs-built_in">c</span> <span class="hljs-operator">*</span> <span class="hljs-number">0.0773993808</span> <span class="hljs-operator">:</span> Math.pow<span class="hljs-punctuation">(</span> <span class="hljs-built_in">c</span> <span class="hljs-operator">*</span> <span class="hljs-number">0.9478672986</span> <span class="hljs-operator">+</span> <span class="hljs-number">0.0521327014</span><span class="hljs-punctuation">,</span> <span class="hljs-number">2.4</span> <span class="hljs-punctuation">)</span>;

<span class="hljs-punctuation">}</span>

export <span class="hljs-keyword">function</span> LinearToSRGB<span class="hljs-punctuation">(</span> <span class="hljs-built_in">c</span> <span class="hljs-punctuation">)</span> <span class="hljs-punctuation">{</span>

    <span class="hljs-built_in">return</span> <span class="hljs-punctuation">(</span> <span class="hljs-built_in">c</span> <span class="hljs-operator">&lt;</span> <span class="hljs-number">0.0031308</span> <span class="hljs-punctuation">)</span> <span class="hljs-operator">?</span> <span class="hljs-built_in">c</span> <span class="hljs-operator">*</span> <span class="hljs-number">12.92</span> <span class="hljs-operator">:</span> <span class="hljs-number">1.055</span> <span class="hljs-operator">*</span> <span class="hljs-punctuation">(</span> Math.pow<span class="hljs-punctuation">(</span> <span class="hljs-built_in">c</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.41666</span> <span class="hljs-punctuation">)</span> <span class="hljs-punctuation">)</span> <span class="hljs-operator">-</span> <span class="hljs-number">0.055</span>;

<span class="hljs-punctuation">}</span>
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d9070e691940466e968df25690ff5008~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LmY6aOO6L2s6Ii1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770025477&amp;x-signature=tCUe2ZgeTYADV%2BeoOvblC37Xy9Y%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-17">Three.js中-从输出的角度</h2>
<p>threejs会在</p>
<ul>
<li>MeshBasicMaterial</li>
<li>MeshPhysicalMaterial</li>
<li>MeshPhongMaterial</li>
<li>MeshLambertMaterial</li>
<li>MeshToonMaterial</li>
<li>MeshMatcapMaterial</li>
<li>SpriteMaterial</li>
<li>PointsMaterial 等等</li>
</ul>
<p>材质输出的时候增加这样一段代码</p>
<p>src/renderers/shaders/ShaderChunk/colorspace_fragment.glsl.js</p>
<pre><code class="hljs language-ini" lang="ini"> <span class="hljs-attr">gl_FragColor</span> = linearToOutputTexel( gl_FragColor )<span class="hljs-comment">;</span>
</code></pre>
<h3 data-id="heading-18">linearToOutputTexel函数会根据outputColorSpace来动态配置</h3>
<pre><code class="hljs language-scss" lang="scss">  <span class="hljs-built_in">getTexelEncodingFunction</span>( 'linearToOutputTexel', parameters.outputColorSpace ),
</code></pre>
<p><strong>说白了就是输出的时候会跟你设置的outputColorSpace来判断需不需要转成SRGBColorSpace，默认是转成SRGBColorSpace</strong></p>
<h3 data-id="heading-19">我们自己写的ShaderMaterial输出的时候怎么办</h3>
<p>我们也可以调用linearToOutputTexel</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/83776e68709942b78217a1a192754bcc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LmY6aOO6L2s6Ii1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770025477&amp;x-signature=4g0WwmVpTOoaga50X9JcXgXEuLk%3D" alt="" loading="lazy"/></p>
<p>因为linearToOutputTexel</p>
<ul>
<li>
<p>注入时机：在 WebGLProgram 构造函数中构建 prefixFragment 时</p>
</li>
<li>
<p>注入方式：通过 getTexelEncodingFunction 动态生成函数代码，添加到 prefixFragment</p>
</li>
<li>
<p>可用性：所有非 RawShaderMaterial 的材质（包括 ShaderMaterial）都会自动注入</p>
</li>
</ul>
<h2 data-id="heading-20">总结</h2>
<p>在 three.js 中，默认的色彩空间配置已经覆盖了大多数使用场景。只要遵循<strong>颜色纹理使用 sRGB、渲染计算在</strong> <strong>线性空间</strong> <strong>、输出再转回 sRGB</strong>这一基本原则，画面通常就是正确的。但是理解色彩空间与伽马校正的原理，才能在自定义 Shader、特殊纹理或渲染需求出现时，<strong>有意识地手动调整配置，而不是盲目试参数</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一夜之间开发出AI小红书读书笔记发布技能，我的自动化内容创作之路]]></title>    <link>https://juejin.cn/post/7599478406237536265</link>    <guid>https://juejin.cn/post/7599478406237536265</guid>    <pubDate>2026-01-26T09:01:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599478406237536265" data-draft-id="7599237603976167467" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一夜之间开发出AI小红书读书笔记发布技能，我的自动化内容创作之路"/> <meta itemprop="keywords" content="AIGC,AI编程,MCP"/> <meta itemprop="datePublished" content="2026-01-26T09:01:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="nil"/> <meta itemprop="url" content="https://juejin.cn/user/2893570337422670"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一夜之间开发出AI小红书读书笔记发布技能，我的自动化内容创作之路
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2893570337422670/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    nil
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T09:01:30.000Z" title="Mon Jan 26 2026 09:01:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    13
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一夜之间开发出AI小红书读书笔记发布技能，我的自动化内容创作之路</h2>
<blockquote>
<p>告别手动排版！用AI自动生成精美读书笔记并一键发布到小红书</p>
</blockquote>
<p>大家好，今天想和大家分享一下我最近的"玩具"开发经历。作为一名热爱阅读的程序员，我经常想在小红书上分享自己的读书心得，但每次都要手动排版、找图、写文案，实在是一件费时费力的事。于是，我萌生了一个想法：能不能用AI帮我完成这一切？</p>
<h3 data-id="heading-1">项目背景</h3>
<p>小红书作为一个内容分享平台，对读书笔记这种垂直内容有着很大的需求。但是：</p>
<ol>
<li><strong>内容生成耗时</strong>：要写一篇优质的读书笔记，需要理解书籍、提炼观点、组织语言</li>
<li><strong>配图选择困难</strong>：需要找符合书籍主题的精美图片</li>
<li><strong>排版格式麻烦</strong>：小红书的排版有特定格式要求</li>
<li><strong>发布频率低</strong>：因为流程繁琐，很难坚持高频更新</li>
</ol>
<p>于是，我决定开发一个能够自动化完成这一切的技能。</p>
<h3 data-id="heading-2">技术选型</h3>
<h4 data-id="heading-3">小红书MCP</h4>
<p>首先，我发现Claude Code支持MCP（Model Context Protocol），可以连接各种外部服务。小红书官方提供了MCP服务器，让AI能够直接发布内容到小红书平台。</p>
<h4 data-id="heading-4">核心技术栈</h4>
<ol>
<li><strong>Claude Code AI</strong>：负责内容生成和逻辑判断</li>
<li><strong>Python脚本</strong>：处理数据抓取、图片下载等任务</li>
<li><strong>豆瓣API</strong>：获取书籍信息和评分</li>
<li><strong>免费图库API</strong>：Unsplash、Pexels、Pixabay</li>
<li><strong>小红书MCP</strong>：一键发布内容</li>
</ol>
<h3 data-id="heading-5">项目架构</h3>
<pre><code class="hljs language-bash" lang="bash">xiaohongshu-book-notes/
├── scripts/              <span class="hljs-comment"># 核心脚本</span>
│   ├── find_books.py     <span class="hljs-comment"># 豆瓣书籍搜索</span>
│   ├── generate_book_content.py  <span class="hljs-comment"># 内容生成</span>
│   ├── download_book_images.py   <span class="hljs-comment"># 图片下载</span>
│   └── main_xiaohongshu_poster.py <span class="hljs-comment"># 主程序</span>
├── references/           <span class="hljs-comment"># 资源文件</span>
│   ├── xiaohongshu_book_templates.md
│   └── douban_api_guide.md
└── assets/              <span class="hljs-comment"># 配置文件</span>
    └── engaging_questions.txt
</code></pre>
<h3 data-id="heading-6">核心功能实现</h3>
<h4 data-id="heading-7">1. 智能书籍选择</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_popular_books</span>():
    <span class="hljs-string">"""精选的高分书籍列表，涵盖多种类型"""</span>
    <span class="hljs-keyword">return</span> [
        {<span class="hljs-string">"title"</span>: <span class="hljs-string">"人类简史"</span>, <span class="hljs-string">"rating"</span>: <span class="hljs-number">9.1</span>, <span class="hljs-string">"author"</span>: <span class="hljs-string">"尤瓦尔·赫拉利"</span>},
        {<span class="hljs-string">"title"</span>: <span class="hljs-string">"百年孤独"</span>, <span class="hljs-string">"rating"</span>: <span class="hljs-number">9.2</span>, <span class="hljs-string">"author"</span>: <span class="hljs-string">"加西亚·马尔克斯"</span>},
        {<span class="hljs-string">"title"</span>: <span class="hljs-string">"原则"</span>, <span class="hljs-string">"rating"</span>: <span class="hljs-number">8.5</span>, <span class="hljs-string">"author"</span>: <span class="hljs-string">"瑞·达利欧"</span>},
        <span class="hljs-comment"># 更多书籍...</span>
    ]
</code></pre>
<p>如果没有指定书籍，系统会自动从豆瓣精选8分以上的经典书籍中选择，确保内容质量。</p>
<h4 data-id="heading-8">2. 个性化内容生成</h4>
<p>根据不同书籍类型，使用不同的模板生成内容：</p>
<ul>
<li><strong>自我提升类</strong>：聚焦实用建议和个人成长</li>
<li><strong>文学类</strong>：深度分析主题和人物</li>
<li><strong>哲学类</strong>：引发思考的观点提炼</li>
<li><strong>历史类</strong>：背景梳理和现实意义</li>
</ul>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">generate_book_content</span>(<span class="hljs-params">book_info</span>):
    <span class="hljs-string">"""根据书籍信息生成小红书风格的读书笔记"""</span>
    <span class="hljs-comment"># 分析书籍类型，选择合适的模板</span>
    <span class="hljs-comment"># 生成带emoji的标题</span>
    <span class="hljs-comment"># 组织书籍信息和个人见解</span>
    <span class="hljs-comment"># 添加相关标签</span>
</code></pre>
<h4 data-id="heading-9">3. 智能配图系统</h4>
<p>最让我兴奋的是图片处理功能：</p>
<ol>
<li><strong>主题匹配</strong>：根据书籍类型自动选择图片风格</li>
<li><strong>批量下载</strong>：从多个免费图库API获取高质量图片</li>
<li><strong>筛选优化</strong>：AI选择最适合的3-5张配图</li>
<li><strong>格式统一</strong>：所有图片保持小红书风格的视觉一致性</li>
</ol>
<h4 data-id="heading-10">4. 一键发布</h4>
<p>使用小红书MCP，只需一个命令就能完成：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 用户只需这样简单指令</span>
<span class="hljs-string">"帮我发布《原则》的读书笔记"</span>
</code></pre>
<p>系统会自动完成：</p>
<ul>
<li>豆瓣搜索书籍信息</li>
<li>生成个性化书评</li>
<li>下载精美配图</li>
<li>发布到小红书</li>
</ul>
<h3 data-id="heading-11">使用体验</h3>
<h4 data-id="heading-12">极简操作</h4>
<ol>
<li><strong>指定书籍</strong>："帮我发布《人类简史》的读书笔记"</li>
<li><strong>随机推荐</strong>："帮我发布一篇读书笔记"</li>
<li><strong>类型偏好</strong>："我想读一本关于自我提升的书"</li>
</ol>
<h4 data-id="heading-13">自动化流程</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TD
    A[用户输入] --&gt; B{是否有书名}
    B --&gt;|是| C[豆瓣搜索]
    B --&gt;|否| D[随机推荐高分书]
    C --&gt; E[获取书籍信息]
    D --&gt; E
    E --&gt; F[生成内容]
    F --&gt; G[下载配图]
    G --&gt; H[发布到小红书]
    H --&gt; I[完成分享]
</code></pre>
<h3 data-id="heading-14">实际效果展示</h3>
<h4 data-id="heading-15">生成的读书笔记示例</h4>
<p>📖 《原则》| 🚀</p>
<p>✨ 这本书就像一位智慧导师，用最朴实的话语教会我们最重要的道理。</p>
<p>📖 <strong>《原则》</strong>
⭐ <strong>豆瓣评分：8.5分</strong>
✍️ <strong>作者：瑞·达利欧</strong>
🏢 <strong>出版社：中信出版社</strong></p>
<p>🔑 <strong>核心观点</strong>
• 成功不是偶然，而是习惯的累积
• 思维方式决定行为模式
• 持续改进比完美更重要</p>
<p>💡 <strong>启发思考</strong>
读这本书让我明白，真正的改变来自于内心的觉醒...</p>
<p>#读书笔记 #好书推荐 #个人成长 #思维提升</p>
<h4 data-id="heading-16">配图效果</h4>
<p>系统会自动下载3-5张与书籍主题相关的高质量图片，包括：</p>
<ul>
<li>书籍封面（优先使用真实封面）</li>
<li>主题相关配图（职场、成功、个人成长等）</li>
<li>统一风格的视觉设计</li>
</ul>
<h3 data-id="heading-17">开发心得</h3>
<h4 data-id="heading-18">1. AI赋能的威力</h4>
<p>这个项目让我深刻体会到AI的强大：</p>
<ul>
<li><strong>内容创作</strong>：AI能快速生成符合平台调性的内容</li>
<li><strong>逻辑判断</strong>：能理解用户意图，选择合适的处理方式</li>
<li><strong>资源整合</strong>：自动调用多个API，完成复杂流程</li>
</ul>
<h4 data-id="heading-19">2. MCP的革新性</h4>
<p>小红书MCP让AI发布内容成为可能，这解决了内容创作的最后一公里问题。想象一下：</p>
<ul>
<li>AI写文章</li>
<li>AI找图片</li>
<li>AI发平台</li>
<li>AI做互动</li>
</ul>
<p>未来已来！</p>
<h4 data-id="heading-20">3. 效率提升对比</h4>

































<table><thead><tr><th>传统方式</th><th>AI自动化方式</th></tr></thead><tbody><tr><td>找书：30分钟</td><td>1秒</td></tr><tr><td>写稿：2小时</td><td>30秒</td></tr><tr><td>找图：1小时</td><td>自动完成</td></tr><tr><td>排版：30分钟</td><td>自动格式化</td></tr><tr><td>发布：手动操作</td><td>一键发布</td></tr><tr><td><strong>总计：4小时+</strong></td><td><strong>总计：1分钟</strong></td></tr></tbody></table>
<h3 data-id="heading-21">未来展望</h3>
<h4 data-id="heading-22">短期优化</h4>
<ol>
<li><strong>内容质量提升</strong>：加入更多个性化元素</li>
<li><strong>图片美化</strong>：添加文字水印和特效</li>
<li><strong>互动增强</strong>：自动生成评论回复模板</li>
</ol>
<h4 data-id="heading-23">长期规划</h4>
<ol>
<li><strong>多平台支持</strong>：同步发布到知乎、微博等</li>
<li><strong>数据统计</strong>：分析内容表现，优化策略</li>
<li><strong>用户画像</strong>：根据用户喜好推荐书籍</li>
</ol>
<h3 data-id="heading-24">项目开源</h3>
<p>我已经将这个项目开源到了GitHub：</p>
<p>🔗 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FZBIGBEAR%2Fxiaohongshu-book-notes" target="_blank" title="https://github.com/ZBIGBEAR/xiaohongshu-book-notes" ref="nofollow noopener noreferrer">xiaohongshu-book-notes</a></p>
<p>欢迎：</p>
<ul>
<li>Star支持</li>
<li>Fork使用</li>
<li>Issue交流</li>
<li>PR贡献</li>
</ul>
<p>另外，这里附上我使用的小红书mcp
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fxpzouying%2Fxiaohongshu-mcp" target="_blank" title="https://github.com/xpzouying/xiaohongshu-mcp" ref="nofollow noopener noreferrer">github.com/xpzouying/x…</a></p>
<h3 data-id="heading-25">总结</h3>
<p>这次开发经历让我收获颇丰：</p>
<ol>
<li><strong>技术成长</strong>：深入了解了MCP、API集成、AI应用</li>
<li><strong>效率革命</strong>：真正体会到AI如何改变工作方式</li>
<li><strong>产品思维</strong>：从用户痛点出发，打造实用工具</li>
<li><strong>分享精神</strong>：开源项目，帮助更多人</li>
</ol>
<p>如果你也是内容创作者，或者对AI自动化感兴趣，不妨试试这个技能。让我们一起，用AI的力量，让内容创作更简单、更有趣！</p>
<hr/>
<p><strong>最后送给大家一句话</strong>：</p>
<blockquote>
<p>不会AI的程序员，就像不会上网的画家。让我们一起拥抱变化，用技术让生活更美好！</p>
</blockquote>
<p><strong>你的下一个读书笔记，让AI来帮你写！</strong> 🚀</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Transformer 架构：从原理到公式推导]]></title>    <link>https://juejin.cn/post/7599053532169076777</link>    <guid>https://juejin.cn/post/7599053532169076777</guid>    <pubDate>2026-01-26T09:27:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599053532169076777" data-draft-id="7599053532169060393" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Transformer 架构：从原理到公式推导"/> <meta itemprop="keywords" content="面试,人工智能"/> <meta itemprop="datePublished" content="2026-01-26T09:27:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Hhang"/> <meta itemprop="url" content="https://juejin.cn/user/1994944446213274"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Transformer 架构：从原理到公式推导
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1994944446213274/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Hhang
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T09:27:20.000Z" title="Mon Jan 26 2026 09:27:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Transformer 架构深度解析：从原理到公式推导</h2>
<blockquote>
<p>本文将带你从零开始，彻底理解 Transformer 的工作原理和核心公式。无论你是初学者还是希望深入理解细节的开发者，都能从中获益。</p>
</blockquote>
<hr/>
<h3 data-id="heading-1">一、开篇：Transformer 为何如此重要？</h3>
<p>2017 年，Google 团队发表了论文《Attention Is All You Need》，提出了 Transformer 架构。这篇论文彻底改变了自然语言处理（NLP）领域，并逐渐影响到计算机视觉、语音等几乎所有 AI 领域。</p>
<p><strong>Transformer 的"战绩"</strong>：</p>
<ul>
<li><strong>GPT 系列</strong>：ChatGPT 的底层架构</li>
<li><strong>BERT</strong>：开创预训练语言模型时代</li>
<li><strong>ViT</strong>：将 Transformer 应用到图像识别</li>
<li><strong>Stable Diffusion</strong>：AI 绘画的核心组件</li>
</ul>
<p>可以说，<strong>没有 Transformer，就没有今天的 AI 大模型时代</strong>。</p>
<hr/>
<h3 data-id="heading-2">二、Transformer 解决了什么问题？</h3>
<h4 data-id="heading-3">2.1 传统序列模型的困境</h4>
<p>在 Transformer 之前，处理序列数据（如文本、语音）主要依赖 RNN（循环神经网络）和 LSTM。</p>
<p><strong>RNN 的工作方式</strong>：</p>
<pre><code class="hljs language-css" lang="css">"我 爱 中 国"

  我 → <span class="hljs-selector-attr">[RNN]</span> → h₁
              ↓
  爱 → <span class="hljs-selector-attr">[RNN]</span> → h₂
              ↓
  中 → <span class="hljs-selector-attr">[RNN]</span> → h₃
              ↓
  国 → <span class="hljs-selector-attr">[RNN]</span> → h₄
</code></pre>
<p><strong>问题 1：无法并行计算</strong></p>
<p>RNN 必须按顺序处理每个词，后一个词必须等前一个词处理完。这导致：</p>
<ul>
<li>训练速度慢</li>
<li>无法充分利用 GPU 的并行能力</li>
</ul>
<p><strong>问题 2：长距离依赖困难</strong></p>
<p>当句子很长时，早期词的信息在传递过程中会逐渐"遗忘"。比如：</p>
<blockquote>
<p>"那个我在<strong>北京</strong>上大学时认识的朋友，现在在<strong>那个城市</strong>工作。"</p>
</blockquote>
<p>要理解"那个城市"指的是"北京"，信息需要跨越很多词传递，RNN 很难做到。</p>
<h4 data-id="heading-4">2.2 Transformer 的解决方案</h4>

























<table><thead><tr><th>问题</th><th>RNN 的困境</th><th>Transformer 的解决</th></tr></thead><tbody><tr><td>并行计算</td><td>必须顺序处理</td><td>所有位置同时计算</td></tr><tr><td>长距离依赖</td><td>信息逐渐衰减</td><td>注意力机制直接关联任意两个位置</td></tr><tr><td>计算效率</td><td>O(n) 时间，无法并行</td><td>O(1) 层数，高度并行</td></tr></tbody></table>
<p>核心思想：<strong>用注意力机制（Attention）替代循环结构</strong>。</p>
<hr/>
<h3 data-id="heading-5">三、注意力机制：Transformer 的核心</h3>
<h4 data-id="heading-6">3.1 什么是注意力？</h4>
<p>想象你在阅读一句话：</p>
<blockquote>
<p>"小明把<strong>苹果</strong>放在桌上，然后<strong>吃掉了它</strong>。"</p>
</blockquote>
<p>当你理解"吃掉了它"时，大脑会自动"注意"到"苹果"这个词，而不是"桌上"或"小明"。</p>
<p>这就是<strong>注意力机制</strong>：让模型学会"该关注哪些信息"。</p>
<h4 data-id="heading-7">3.2 注意力的数学直觉</h4>
<p>注意力本质上是一种<strong>加权求和</strong>：</p>
<pre><code class="hljs language-erlang" lang="erlang">输出 = 权重₁ × 值₁ + 权重₂ × 值₂ + 权重₃ × 值₃ + ...
</code></pre>
<p>权重越大，表示对应的信息越重要。关键问题是：<strong>如何计算这些权重？</strong></p>
<h4 data-id="heading-8">3.3 Query、Key、Value：注意力的三要素</h4>
<p>Transformer 引入了三个核心概念：</p>

























<table><thead><tr><th>概念</th><th>含义</th><th>类比</th></tr></thead><tbody><tr><td><strong>Query (Q)</strong></td><td>查询：我想找什么？</td><td>你在搜索引擎输入的关键词</td></tr><tr><td><strong>Key (K)</strong></td><td>键：这个东西是什么？</td><td>网页的标题/描述</td></tr><tr><td><strong>Value (V)</strong></td><td>值：这个东西的内容</td><td>网页的实际内容</td></tr></tbody></table>
<p><strong>搜索引擎类比</strong>：</p>
<ol>
<li>你输入搜索关键词（Query）</li>
<li>搜索引擎用关键词和网页标题（Key）做匹配</li>
<li>匹配度高的网页（Value）排在前面</li>
<li>你看到的是加权后的结果</li>
</ol>
<hr/>
<h3 data-id="heading-9">四、自注意力机制详解与公式推导</h3>
<h4 data-id="heading-10">4.1 自注意力（Self-Attention）是什么？</h4>
<p>"自注意力"中的"自"表示：<strong>序列中的每个位置都和序列中的所有位置（包括自己）计算注意力</strong>。</p>
<pre><code class="hljs language-css" lang="css">输入序列：<span class="hljs-selector-attr">[我, 爱, 中, 国]</span>

          我    爱    中    国
       ┌──────────────────────┐
  我 → │ <span class="hljs-number">0.4</span>   <span class="hljs-number">0.3</span>   <span class="hljs-number">0.1</span>   <span class="hljs-number">0.2</span> │ → 我的新表示
  爱 → │ <span class="hljs-number">0.2</span>   <span class="hljs-number">0.5</span>   <span class="hljs-number">0.2</span>   <span class="hljs-number">0.1</span> │ → 爱的新表示
  中 → │ <span class="hljs-number">0.1</span>   <span class="hljs-number">0.2</span>   <span class="hljs-number">0.4</span>   <span class="hljs-number">0.3</span> │ → 中的新表示
  国 → │ <span class="hljs-number">0.1</span>   <span class="hljs-number">0.1</span>   <span class="hljs-number">0.3</span>   <span class="hljs-number">0.5</span> │ → 国的新表示
       └──────────────────────┘
              注意力权重矩阵
</code></pre>
<p>每个词都能"看到"其他所有词，并根据相关性分配权重。</p>
<h4 data-id="heading-11">4.2 公式推导：从输入到输出</h4>
<p>让我们一步步推导自注意力的完整公式。</p>
<p><strong>Step 1：准备输入</strong></p>
<p>假设输入序列有 n 个词，每个词用 d 维向量表示：</p>
<pre><code class="hljs language-ini" lang="ini">输入矩阵 X ∈ ℝⁿˣᵈ

例如：4个词，每个词64维
<span class="hljs-attr">X</span> = [x₁]   n=<span class="hljs-number">4</span>
    <span class="hljs-section">[x₂]</span>   
    <span class="hljs-section">[x₃]</span>   <span class="hljs-attr">d</span>=<span class="hljs-number">64</span>
    <span class="hljs-section">[x₄]</span>   
</code></pre>
<p><strong>Step 2：生成 Q、K、V</strong></p>
<p>通过三个可学习的权重矩阵，将输入转换为 Query、Key、Value：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">Q</span> = X · Wq    (Wq ∈ ℝᵈˣᵈᵏ)
<span class="hljs-attr">K</span> = X · Wk    (Wk ∈ ℝᵈˣᵈᵏ)  
<span class="hljs-attr">V</span> = X · Wv    (Wv ∈ ℝᵈˣᵈᵛ)
</code></pre>
<p>其中：</p>
<ul>
<li>Wq、Wk、Wv 是可学习的参数矩阵</li>
<li>dₖ 是 Key/Query 的维度</li>
<li>dᵥ 是 Value 的维度（通常 dₖ = dᵥ = d）</li>
</ul>
<p><strong>为什么需要三个不同的矩阵？</strong></p>
<p>这样 Q、K、V 可以从不同角度编码信息：</p>
<ul>
<li>Q：这个词"想要查找"什么</li>
<li>K：这个词"对外呈现"什么</li>
<li>V：这个词"实际包含"什么</li>
</ul>
<p><strong>Step 3：计算注意力分数</strong></p>
<p>用 Query 和 Key 的点积衡量相关性：</p>
<pre><code class="hljs language-ini" lang="ini">分数矩阵 <span class="hljs-attr">S</span> = Q · Kᵀ

S ∈ ℝⁿˣⁿ
</code></pre>
<p>S[i][j] 表示第 i 个词对第 j 个词的"关注程度"。</p>
<p><strong>点积的直觉</strong>：两个向量的点积越大，说明它们方向越一致，即越相似。</p>
<p><strong>Step 4：缩放（Scaling）</strong></p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">S_scaled</span> = S / √dₖ
</code></pre>
<p><strong>为什么要除以 √dₖ？</strong> 这是关键的细节！</p>
<p>假设 Q 和 K 的每个元素都是均值为 0、方差为 1 的独立随机变量。那么点积：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-tag">q</span> · k = Σᵢ <span class="hljs-selector-tag">q</span>ᵢ × kᵢ
</code></pre>
<p>这个和的方差 = dₖ（dₖ 个独立随机变量相加）</p>
<p>当 dₖ 很大时（比如 64 或 512），点积的值会非常大。这会导致 softmax 后的分布变得极端（接近 one-hot），梯度消失。</p>
<p>除以 √dₖ 可以让方差回到 1，保持数值稳定。</p>
<p><strong>Step 5：Softmax 归一化</strong></p>
<pre><code class="hljs language-ini" lang="ini">注意力权重 <span class="hljs-attr">A</span> = softmax(S_scaled)
</code></pre>
<p>对每一行做 softmax，确保权重和为 1：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-tag">A</span><span class="hljs-selector-attr">[i]</span><span class="hljs-selector-attr">[j]</span> = exp(S_scaled<span class="hljs-selector-attr">[i]</span><span class="hljs-selector-attr">[j]</span>) / Σₖ exp(S_scaled<span class="hljs-selector-attr">[i]</span><span class="hljs-selector-attr">[k]</span>)
</code></pre>
<p><strong>Step 6：加权求和得到输出</strong></p>
<pre><code class="hljs language-css" lang="css">输出 = <span class="hljs-selector-tag">A</span> · V
</code></pre>
<p>每个位置的输出是所有 Value 的加权和，权重就是注意力分数。</p>
<h4 data-id="heading-12">4.3 完整公式</h4>
<p>将上述步骤整合，得到著名的<strong>缩放点积注意力公式</strong>：</p>
<pre><code class="hljs language-scss" lang="scss">                    ┌────────────────────────────┐
                    │         QKᵀ                │
<span class="hljs-built_in">Attention</span>(Q,K,V) =  │ <span class="hljs-built_in">softmax</span>(────) · V          │
                    │         √dₖ               │
                    └────────────────────────────┘
</code></pre>
<p>用更规范的数学符号表示：</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>Attention</mtext><mo stretchy="false">(</mo><mi>Q</mi><mo separator="true">,</mo><mi>K</mi><mo separator="true">,</mo><mi>V</mi><mo stretchy="false">)</mo><mo>=</mo><mtext>softmax</mtext><mrow><mo fence="true">(</mo><mfrac><mrow><mi>Q</mi><msup><mi>K</mi><mi>T</mi></msup></mrow><msqrt><msub><mi>d</mi><mi>k</mi></msub></msqrt></mfrac><mo fence="true">)</mo></mrow><mi>V</mi></mrow><annotation encoding="application/x-tex">\text{Attention}(Q, K, V) = \text{softmax}\left(\frac{QK^T}{\sqrt{d_k}}\right)V</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord text"><span class="mord">Attention</span></span><span class="mopen">(</span><span class="mord mathnormal">Q</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:2.4684em;vertical-align:-0.95em;"/><span class="mord text"><span class="mord">softmax</span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">(</span></span><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.5183em;"><span style="top:-2.2528em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8572em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="mord" style="padding-left:0.833em;"><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span><span style="top:-2.8172em;"><span class="pstrut" style="height:3em;"/><span class="hide-tail" style="min-width:0.853em;height:1.08em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.08em" viewbox="0 0 400000 1080" preserveaspectratio="xMinYMin slice"><path d="M95,702&#10;c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14&#10;c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54&#10;c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10&#10;s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429&#10;c69,-144,104.5,-217.7,106.5,-221&#10;l0 -0&#10;c5.3,-9.3,12,-14,20,-14&#10;H400000v40H845.2724&#10;s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7&#10;c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z&#10;M834 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1828em;"><span/></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord mathnormal">Q</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.93em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">)</span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">V</span></span></span></span></span></div>
<h4 data-id="heading-13">4.4 计算示例</h4>
<p>假设我们有一个简化的例子：</p>
<pre><code class="hljs language-less" lang="less">输入：<span class="hljs-number">2</span>个词，每个词<span class="hljs-number">3</span>维

<span class="hljs-selector-tag">X</span> = <span class="hljs-selector-attr">[1, 0, 1]</span>    ← 词<span class="hljs-number">1</span>
    <span class="hljs-selector-attr">[0, 1, 1]</span>    ← 词<span class="hljs-number">2</span>

假设 <span class="hljs-selector-tag">Wq</span> = <span class="hljs-selector-tag">Wk</span> = <span class="hljs-selector-tag">Wv</span> = <span class="hljs-selector-tag">I</span>（单位矩阵，简化计算）

则 <span class="hljs-selector-tag">Q</span> = <span class="hljs-selector-tag">K</span> = <span class="hljs-selector-tag">V</span> = <span class="hljs-selector-tag">X</span>

<span class="hljs-selector-tag">Step</span> <span class="hljs-number">1</span>: 计算 <span class="hljs-selector-tag">QK</span>ᵀ
<span class="hljs-selector-tag">QK</span>ᵀ = <span class="hljs-selector-attr">[1,0,1]</span> <span class="hljs-selector-attr">[1, 0]</span>   = <span class="hljs-selector-attr">[1×1+0×0+1×1, 1×0+0×1+1×1]</span> = <span class="hljs-selector-attr">[2, 1]</span>
      <span class="hljs-selector-attr">[0,1,1]</span> <span class="hljs-selector-attr">[0, 1]</span>     <span class="hljs-selector-attr">[0×1+1×0+1×1, 0×0+1×1+1×1]</span>   <span class="hljs-selector-attr">[1, 2]</span>
              <span class="hljs-selector-attr">[1, 1]</span>

<span class="hljs-selector-tag">Step</span> <span class="hljs-number">2</span>: 缩放（<span class="hljs-selector-tag">d</span>ₖ=<span class="hljs-number">3</span>）
<span class="hljs-selector-tag">S_scaled</span> = <span class="hljs-selector-attr">[2, 1]</span> / √<span class="hljs-number">3</span> ≈ <span class="hljs-selector-attr">[1.15, 0.58]</span>
           <span class="hljs-selector-attr">[1, 2]</span>         <span class="hljs-selector-attr">[0.58, 1.15]</span>

<span class="hljs-selector-tag">Step</span> <span class="hljs-number">3</span>: <span class="hljs-selector-tag">Softmax</span>（按行）
第<span class="hljs-number">1</span>行：<span class="hljs-selector-tag">exp</span>(<span class="hljs-number">1.15</span>)/(<span class="hljs-built_in">exp</span>(<span class="hljs-number">1.15</span>)+<span class="hljs-built_in">exp</span>(<span class="hljs-number">0.58</span>)) ≈ <span class="hljs-number">0.64</span>, <span class="hljs-number">0.36</span>
第<span class="hljs-number">2</span>行：<span class="hljs-selector-tag">exp</span>(<span class="hljs-number">0.58</span>)/(<span class="hljs-built_in">exp</span>(<span class="hljs-number">0.58</span>)+<span class="hljs-built_in">exp</span>(<span class="hljs-number">1.15</span>)) ≈ <span class="hljs-number">0.36</span>, <span class="hljs-number">0.64</span>

<span class="hljs-selector-tag">A</span> ≈ <span class="hljs-selector-attr">[0.64, 0.36]</span>
    <span class="hljs-selector-attr">[0.36, 0.64]</span>

<span class="hljs-selector-tag">Step</span> <span class="hljs-number">4</span>: 计算输出
输出 = <span class="hljs-selector-tag">A</span> · <span class="hljs-selector-tag">V</span> = <span class="hljs-selector-attr">[0.64, 0.36]</span> × <span class="hljs-selector-attr">[1, 0, 1]</span>
               <span class="hljs-selector-attr">[0.36, 0.64]</span>   <span class="hljs-selector-attr">[0, 1, 1]</span>

词<span class="hljs-number">1</span>的新表示 = <span class="hljs-number">0.64</span>×<span class="hljs-selector-attr">[1,0,1]</span> + <span class="hljs-number">0.36</span>×<span class="hljs-selector-attr">[0,1,1]</span> = <span class="hljs-selector-attr">[0.64, 0.36, 1.0]</span>
词<span class="hljs-number">2</span>的新表示 = <span class="hljs-number">0.36</span>×<span class="hljs-selector-attr">[1,0,1]</span> + <span class="hljs-number">0.64</span>×<span class="hljs-selector-attr">[0,1,1]</span> = <span class="hljs-selector-attr">[0.36, 0.64, 1.0]</span>
</code></pre>
<p>可以看到，每个词的新表示融合了其他所有词的信息。</p>
<hr/>
<h3 data-id="heading-14">五、多头注意力：并行的多视角关注</h3>
<h4 data-id="heading-15">5.1 为什么需要多头注意力？</h4>
<p>单个注意力头只能学习一种"关注模式"。但在理解语言时，我们需要同时关注多种关系：</p>

























<table><thead><tr><th>关注角度</th><th>例子</th></tr></thead><tbody><tr><td>语法结构</td><td>主语-谓语-宾语</td></tr><tr><td>指代关系</td><td>"它"指代什么</td></tr><tr><td>语义相似</td><td>同义词、近义词</td></tr><tr><td>位置关系</td><td>相邻词的关联</td></tr></tbody></table>
<p><strong>多头注意力</strong>让模型同时学习多种注意力模式。</p>
<h4 data-id="heading-16">5.2 多头注意力的结构</h4>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-code">                    ┌─────────────┐
              ┌────►│ 注意力头 1  │────┐
              │     └─────────────┘    │
              │     ┌─────────────┐    │
输入 X ───────┼────►│ 注意力头 2  │────┼───► Concat ──► 线性变换 ──► 输出
              │     └─────────────┘    │
              │     ┌─────────────┐    │
              └────►│ 注意力头 h  │────┘
                    └─────────────┘
</span></code></pre>
<h4 data-id="heading-17">5.3 公式推导</h4>
<p><strong>Step 1：分头计算</strong></p>
<p>对于第 i 个头：</p>
<pre><code class="hljs language-scss" lang="scss">headᵢ = <span class="hljs-built_in">Attention</span>(Q·Wqⁱ, K·Wkⁱ, V·Wvⁱ)
</code></pre>
<p>其中：</p>
<ul>
<li>Wqⁱ, Wkⁱ ∈ ℝᵈˣ⁽ᵈ/ʰ⁾</li>
<li>Wvⁱ ∈ ℝᵈˣ⁽ᵈ/ʰ⁾</li>
<li>h 是头的数量</li>
</ul>
<p><strong>关键设计</strong>：每个头的维度是 d/h，所以 h 个头拼接后维度还是 d。</p>
<p><strong>Step 2：拼接所有头</strong></p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">MultiHead</span>(Q, K, V) = <span class="hljs-built_in">Concat</span>(head₁, head₂, ..., headₕ) · Wᵒ
</code></pre>
<p>其中 Wᵒ ∈ ℝᵈˣᵈ 是输出投影矩阵。</p>
<h4 data-id="heading-18">5.4 多头注意力的完整公式</h4>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>MultiHead</mtext><mo stretchy="false">(</mo><mi>Q</mi><mo separator="true">,</mo><mi>K</mi><mo separator="true">,</mo><mi>V</mi><mo stretchy="false">)</mo><mo>=</mo><mtext>Concat</mtext><mo stretchy="false">(</mo><msub><mtext>head</mtext><mn>1</mn></msub><mo separator="true">,</mo><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mo separator="true">,</mo><msub><mtext>head</mtext><mi>h</mi></msub><mo stretchy="false">)</mo><msup><mi>W</mi><mi>O</mi></msup></mrow><annotation encoding="application/x-tex">\text{MultiHead}(Q, K, V) = \text{Concat}(\text{head}_1, ..., \text{head}_h) W^O</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord text"><span class="mord">MultiHead</span></span><span class="mopen">(</span><span class="mord mathnormal">Q</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.1413em;vertical-align:-0.25em;"/><span class="mord text"><span class="mord">Concat</span></span><span class="mopen">(</span><span class="mord"><span class="mord text"><span class="mord">head</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">...</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord text"><span class="mord">head</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">h</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">O</span></span></span></span></span></span></span></span></span></span></span></span></div>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mtext>where head</mtext><mi>i</mi></msub><mo>=</mo><mtext>Attention</mtext><mo stretchy="false">(</mo><mi>Q</mi><msubsup><mi>W</mi><mi>i</mi><mi>Q</mi></msubsup><mo separator="true">,</mo><mi>K</mi><msubsup><mi>W</mi><mi>i</mi><mi>K</mi></msubsup><mo separator="true">,</mo><mi>V</mi><msubsup><mi>W</mi><mi>i</mi><mi>V</mi></msubsup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\text{where head}_i = \text{Attention}(QW_i^Q, KW_i^K, VW_i^V)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"/><span class="mord"><span class="mord text"><span class="mord">where head</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.2361em;vertical-align:-0.2769em;"/><span class="mord text"><span class="mord">Attention</span></span><span class="mopen">(</span><span class="mord mathnormal">Q</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9592em;"><span style="top:-2.4231em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.1809em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">Q</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2769em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-2.453em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">K</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-2.453em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.22222em;">V</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></div>
<h4 data-id="heading-19">5.5 一个直观的理解</h4>
<p>把多头注意力想象成<strong>多个专家同时看同一个问题</strong>：</p>
<ul>
<li>专家 1 关注语法结构</li>
<li>专家 2 关注指代关系</li>
<li>专家 3 关注情感倾向</li>
<li>...</li>
</ul>
<p>最后把所有专家的意见综合起来，得到更全面的理解。</p>
<hr/>
<h3 data-id="heading-20">六、Transformer 的完整架构</h3>
<h4 data-id="heading-21">6.1 整体结构</h4>
<pre><code class="hljs language-css" lang="css">               输入                              输出
                ↓                                 ↓
         <span class="hljs-selector-attr">[词嵌入 + 位置编码]</span>                 <span class="hljs-selector-attr">[词嵌入 + 位置编码]</span>
                ↓                                 ↓
         ┌─────────────┐                   ┌─────────────┐
         │   Encoder   │                   │   Decoder   │
         │  ×N 层      │ ─────────────────►│  ×N 层      │
         └─────────────┘                   └─────────────┘
                                                  ↓
                                           <span class="hljs-selector-attr">[线性层 + Softmax]</span>
                                                  ↓
                                              预测输出
</code></pre>
<h4 data-id="heading-22">6.2 编码器（Encoder）结构</h4>
<p>每个编码器层包含：</p>
<pre><code class="hljs language-sql" lang="sql">        输入
         ↓
    ┌────────────┐
    │  多头自注意力 │◄────┐
    └────────────┘     │ 残差连接
         ↓             │
       <span class="hljs-keyword">Add</span> <span class="hljs-operator">&amp;</span> Norm ─────┘
         ↓
    ┌────────────┐
    │  前馈神经网络 │◄────┐
    └────────────┘     │ 残差连接
         ↓             │
       <span class="hljs-keyword">Add</span> <span class="hljs-operator">&amp;</span> Norm ─────┘
         ↓
        输出
</code></pre>
<p><strong>残差连接（Add）</strong>：解决深层网络训练困难的问题（和 ResNet 思想一致）</p>
<p><strong>层归一化（Norm）</strong>：稳定训练，加速收敛</p>
<h4 data-id="heading-23">6.3 解码器（Decoder）结构</h4>
<p>解码器比编码器多了一个<strong>交叉注意力层</strong>：</p>
<pre><code class="hljs language-sql" lang="sql">        输入（已生成的部分）
         ↓
    ┌─────────────────┐
    │ 带掩码的多头自注意力 │◄────┐
    └─────────────────┘     │
         ↓                  │
       <span class="hljs-keyword">Add</span> <span class="hljs-operator">&amp;</span> Norm ──────────┘
         ↓
    ┌─────────────────┐
    │  交叉注意力      │◄────┐  ←── 接收编码器的输出
    │  (Encoder<span class="hljs-operator">-</span>Decoder)│     │
    └─────────────────┘     │
         ↓                  │
       <span class="hljs-keyword">Add</span> <span class="hljs-operator">&amp;</span> Norm ──────────┘
         ↓
    ┌────────────┐
    │  前馈神经网络 │◄────┐
    └────────────┘     │
         ↓             │
       <span class="hljs-keyword">Add</span> <span class="hljs-operator">&amp;</span> Norm ─────┘
         ↓
        输出
</code></pre>
<p><strong>带掩码的自注意力（Masked Self-Attention）</strong>：</p>
<p>在生成时，模型只能看到已经生成的词，不能"偷看"未来的词。掩码实现这一限制：</p>
<pre><code class="hljs language-css" lang="css">掩码矩阵（上三角为-∞）：
     词<span class="hljs-number">1</span>  词<span class="hljs-number">2</span>  词<span class="hljs-number">3</span>  词<span class="hljs-number">4</span>
词<span class="hljs-number">1</span> <span class="hljs-selector-attr">[ 0   -∞  -∞  -∞ ]</span>
词<span class="hljs-number">2</span> <span class="hljs-selector-attr">[ 0    0  -∞  -∞ ]</span>
词<span class="hljs-number">3</span> <span class="hljs-selector-attr">[ 0    0   0  -∞ ]</span>
词<span class="hljs-number">4</span> <span class="hljs-selector-attr">[ 0    0   0   0 ]</span>

加到注意力分数上后，-∞ 经过 softmax 变成 <span class="hljs-number">0</span>，即完全不关注未来的词。
</code></pre>
<hr/>
<h3 data-id="heading-24">七、位置编码：让模型知道顺序</h3>
<h4 data-id="heading-25">7.1 为什么需要位置编码？</h4>
<p>注意力机制是<strong>排列不变的</strong>：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">Attention</span>("我爱中国") = <span class="hljs-built_in">Attention</span>("国中爱我")  ？
</code></pre>
<p>如果不加处理，模型无法区分词的顺序！但语言中顺序至关重要。</p>
<h4 data-id="heading-26">7.2 位置编码的设计</h4>
<p>Transformer 使用<strong>正弦/余弦位置编码</strong>：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">PE</span>(pos, <span class="hljs-number">2</span>i)   = <span class="hljs-built_in">sin</span>(pos / <span class="hljs-number">10000</span>^(<span class="hljs-number">2</span>i/d))
<span class="hljs-built_in">PE</span>(pos, <span class="hljs-number">2</span>i+<span class="hljs-number">1</span>) = <span class="hljs-built_in">cos</span>(pos / <span class="hljs-number">10000</span>^(<span class="hljs-number">2</span>i/d))
</code></pre>
<p>其中：</p>
<ul>
<li>pos：词在序列中的位置（0, 1, 2, ...）</li>
<li>i：维度的索引（0, 1, 2, ..., d/2-1）</li>
<li>d：编码维度</li>
</ul>
<p><strong>为什么用正弦/余弦？</strong></p>
<ol>
<li><strong>有界性</strong>：值始终在 [-1, 1] 范围内</li>
<li><strong>周期性</strong>：可以表达相对位置关系</li>
<li><strong>可外推</strong>：理论上可以处理任意长度的序列</li>
</ol>
<p><strong>关键性质</strong>：对于固定的偏移量 k，PE(pos+k) 可以表示为 PE(pos) 的线性函数。这让模型容易学习相对位置关系。</p>
<h4 data-id="heading-27">7.3 位置编码的可视化</h4>
<pre><code class="hljs language-markdown" lang="markdown">位置
  ↓
  0  ━━━━━━━━━━━━━━━━━━━━
  1  ━━━━━━━━━━━━━━━━━━━∙
  2  ━━━━━━━━━━━━━━━━━━∙∙
  3  ━━━━━━━━━━━━━━━━━∙∙∙
  ...
<span class="hljs-code">     低频 ←────────────→ 高频
           维度方向
</span></code></pre>
<ul>
<li>低维度变化慢（表示粗粒度位置）</li>
<li>高维度变化快（表示细粒度位置）</li>
</ul>
<hr/>
<h3 data-id="heading-28">八、前馈神经网络（FFN）</h3>
<p>每个 Transformer 层还包含一个前馈神经网络：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">FFN</span>(x) = <span class="hljs-built_in">max</span>(<span class="hljs-number">0</span>, xW₁ + b₁)W₂ + <span class="hljs-selector-tag">b</span>₂
</code></pre>
<p>或者用更现代的 GELU 激活：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">FFN</span>(x) = <span class="hljs-built_in">GELU</span>(xW₁ + b₁)W₂ + <span class="hljs-selector-tag">b</span>₂
</code></pre>
<h4 data-id="heading-29">结构</h4>
<pre><code class="hljs language-css" lang="css">输入（d 维）
    ↓
<span class="hljs-selector-attr">[线性层]</span> → d → <span class="hljs-number">4</span>d（扩展）
    ↓
<span class="hljs-selector-attr">[激活函数 ReLU/GELU]</span>
    ↓
<span class="hljs-selector-attr">[线性层]</span> → <span class="hljs-number">4</span>d → d（收缩）
    ↓
输出（d 维）
</code></pre>
<p><strong>FFN 的作用</strong>：</p>
<ul>
<li>增加模型容量</li>
<li>引入非线性</li>
<li>每个位置独立处理（可并行）</li>
</ul>
<p><strong>为什么中间层要扩大 4 倍？</strong></p>
<p>这是经验设计。扩大维度增加了模型的表达能力，是参数量和效果的权衡。</p>
<hr/>
<h3 data-id="heading-30">九、训练与推理</h3>
<h4 data-id="heading-31">9.1 训练过程</h4>
<p><strong>任务</strong>：给定输入序列，预测下一个词</p>
<p><strong>损失函数</strong>：交叉熵</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">Loss</span> = -Σ log P(正确词 | 上下文)
</code></pre>
<p><strong>优化技巧</strong>：</p>
<ul>
<li><strong>学习率预热（Warmup）</strong>：开始时用小学习率，逐渐增大，然后再衰减</li>
<li><strong>Dropout</strong>：随机丢弃部分神经元，防止过拟合</li>
<li><strong>标签平滑（Label Smoothing）</strong>：软化目标分布，提高泛化能力</li>
</ul>
<h4 data-id="heading-32">9.2 推理过程（生成）</h4>
<p><strong>自回归生成</strong>：</p>
<pre><code class="hljs language-arduino" lang="arduino">输入：<span class="hljs-string">"今天天气"</span>

步骤<span class="hljs-number">1</span>：模型预测下一个词 → <span class="hljs-string">"很"</span>
步骤<span class="hljs-number">2</span>：输入变成 <span class="hljs-string">"今天天气很"</span>，预测 → <span class="hljs-string">"好"</span>
步骤<span class="hljs-number">3</span>：输入变成 <span class="hljs-string">"今天天气很好"</span>，预测 → [结束符]

输出：<span class="hljs-string">"今天天气很好"</span>
</code></pre>
<p>每一步都要重新计算，这就是为什么生成很慢。</p>
<p><strong>KV 缓存（KV Cache）</strong>：</p>
<p>为了加速，可以缓存已计算的 Key 和 Value，避免重复计算：</p>
<pre><code class="hljs language-scss" lang="scss">不用缓存：每步计算 <span class="hljs-built_in">O</span>(n²)，总共 <span class="hljs-built_in">O</span>(n³)
使用缓存：每步计算 <span class="hljs-built_in">O</span>(n)，总共 <span class="hljs-built_in">O</span>(n²)
</code></pre>
<hr/>
<h3 data-id="heading-33">十、Transformer 的变体与发展</h3>
<h4 data-id="heading-34">10.1 主流架构</h4>

























<table><thead><tr><th>架构类型</th><th>代表模型</th><th>特点</th></tr></thead><tbody><tr><td>Encoder-only</td><td>BERT</td><td>双向理解，适合分类、问答</td></tr><tr><td>Decoder-only</td><td>GPT</td><td>单向生成，适合文本生成</td></tr><tr><td>Encoder-Decoder</td><td>T5, BART</td><td>完整架构，适合翻译、摘要</td></tr></tbody></table>
<h4 data-id="heading-35">10.2 效率优化</h4>






























<table><thead><tr><th>优化方法</th><th>思路</th><th>代表工作</th></tr></thead><tbody><tr><td>稀疏注意力</td><td>只关注部分位置</td><td>Longformer, BigBird</td></tr><tr><td>线性注意力</td><td>将复杂度从 O(n²) 降到 O(n)</td><td>Linear Transformer</td></tr><tr><td>Flash Attention</td><td>优化内存访问模式</td><td>Flash Attention</td></tr><tr><td>分组查询注意力</td><td>多个头共享 K/V</td><td>GQA</td></tr></tbody></table>
<h4 data-id="heading-36">10.3 架构改进</h4>
<ul>
<li><strong>RMSNorm</strong>：替代 LayerNorm，更高效</li>
<li><strong>旋转位置编码（RoPE）</strong>：替代绝对位置编码，外推能力更强</li>
<li><strong>SwiGLU 激活</strong>：替代 ReLU/GELU，效果更好</li>
</ul>
<hr/>
<h3 data-id="heading-37">十一、总结</h3>
<p>让我们回顾 Transformer 的核心要点：</p>



































<table><thead><tr><th>组件</th><th>作用</th><th>创新点</th></tr></thead><tbody><tr><td>自注意力</td><td>建立序列内任意位置的关系</td><td>并行计算、长距离建模</td></tr><tr><td>多头注意力</td><td>多视角关注不同模式</td><td>增加表达能力</td></tr><tr><td>位置编码</td><td>引入位置信息</td><td>正弦编码，可外推</td></tr><tr><td>残差连接</td><td>训练深层网络</td><td>梯度直通</td></tr><tr><td>层归一化</td><td>稳定训练</td><td>加速收敛</td></tr></tbody></table>
<p><strong>Transformer 成功的关键</strong>：</p>
<ol>
<li><strong>并行性</strong>：摆脱 RNN 的顺序依赖</li>
<li><strong>长距离建模</strong>：注意力机制直接连接任意位置</li>
<li><strong>可扩展性</strong>：架构简洁，易于堆叠更多层</li>
</ol>
<p><strong>核心公式速记</strong>：</p>
<pre><code class="hljs language-scss" lang="scss"># 自注意力
<span class="hljs-built_in">Attention</span>(Q,K,V) = <span class="hljs-built_in">softmax</span>(QKᵀ/√dₖ) × V

# 多头注意力  
<span class="hljs-built_in">MultiHead</span>(Q,K,V) = <span class="hljs-built_in">Concat</span>(head₁,...,headₕ)Wᵒ
where headᵢ = <span class="hljs-built_in">Attention</span>(QWᵢQ, KWᵢK, VWᵢV)
</code></pre>
<hr/>
<h3 data-id="heading-38">延伸阅读</h3>
<p>如果你想进一步深入：</p>
<ol>
<li><strong>论文原文</strong>：<em>Attention Is All You Need</em>（Vaswani et al., 2017）</li>
<li><strong>经典解读</strong>：<em>The Illustrated Transformer</em>（Jay Alammar）</li>
<li><strong>代码实践</strong>：<em>The Annotated Transformer</em>（Harvard NLP）</li>
<li><strong>进阶内容</strong>：<em>FlashAttention</em>、<em>Rotary Position Embedding</em> 等优化技术</li>
</ol>
<p><strong>后记</strong>：Transformer 的设计之美在于其简洁性。"Attention Is All You Need"这个标题本身就是一种宣言：用一个统一的机制（注意力）替代复杂的循环结构、门控机制，反而取得了更好的效果。这告诉我们，有时候化繁为简才是真正的创新。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[残差网络：一文读懂 AI 大模型的基石技术]]></title>    <link>https://juejin.cn/post/7599237603976462379</link>    <guid>https://juejin.cn/post/7599237603976462379</guid>    <pubDate>2026-01-26T09:25:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599237603976462379" data-draft-id="7599237603976429611" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="残差网络：一文读懂 AI 大模型的基石技术"/> <meta itemprop="keywords" content="人工智能,面试"/> <meta itemprop="datePublished" content="2026-01-26T09:25:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Hhang"/> <meta itemprop="url" content="https://juejin.cn/user/1994944446213274"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            残差网络：一文读懂 AI 大模型的基石技术
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1994944446213274/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Hhang
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T09:25:37.000Z" title="Mon Jan 26 2026 09:25:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">从深度学习到残差网络：一文读懂 AI 大模型的基石技术</h2>
<blockquote>
<p>本文将带你从零开始，循序渐进地理解深度学习、卷积神经网络，以及革命性的残差网络（ResNet）。即使你不是技术专业人士，也能轻松读懂！</p>
</blockquote>
<hr/>
<h3 data-id="heading-1">一、开篇：为什么要了解残差网络？</h3>
<p>如果你关注过 AI 领域，一定听说过 ChatGPT、Stable Diffusion 这些大模型。但你可能不知道，支撑这些庞然大物的底层技术中，有一个关键的里程碑——<strong>残差网络（ResNet）</strong>。</p>
<p>2015 年，微软亚洲研究院的何恺明团队提出了残差网络，一举拿下了当年 ImageNet 图像识别大赛的冠军，错误率仅有 3.57%——这意味着 AI 的图像识别能力首次超越了人类！更重要的是，ResNet 的核心思想至今仍在影响着几乎所有的深度学习模型。</p>
<p>让我们从最基础的概念开始，一步步揭开它的神秘面纱。</p>
<hr/>
<h3 data-id="heading-2">二、什么是深度学习？</h3>
<h4 data-id="heading-3">2.1 从人脑到人工神经网络</h4>
<p>想象一下我们的大脑是如何工作的：当你看到一只猫时，眼睛接收光信号，然后信号通过无数个神经元层层传递、处理，最终你的大脑告诉你"这是一只猫"。</p>
<p><strong>人工神经网络</strong>就是模仿这个过程的数学模型：</p>
<pre><code class="hljs">输入层          隐藏层（多层）         输出层
  ○               ○  ○  ○              ○
  ○    →         ○  ○  ○      →       ○ （是猫的概率）
  ○               ○  ○  ○              ○ （是狗的概率）
（图像像素）    （特征提取）          （分类结果）
</code></pre>
<ul>
<li><strong>输入层</strong>：接收原始数据（比如图片的像素值）</li>
<li><strong>隐藏层</strong>：对数据进行加工处理（提取特征）</li>
<li><strong>输出层</strong>：给出最终结果（分类、预测等）</li>
</ul>
<h4 data-id="heading-4">2.2 "深度"是什么意思？</h4>
<p>所谓<strong>深度学习</strong>，就是"深层"的神经网络学习。这里的"深"指的是<strong>神经网络的层数多</strong>。</p>




















<table><thead><tr><th>网络类型</th><th>层数</th><th>特点</th></tr></thead><tbody><tr><td>浅层网络</td><td>2-3 层</td><td>只能学习简单模式</td></tr><tr><td>深层网络</td><td>数十到数百层</td><td>能学习复杂的抽象特征</td></tr></tbody></table>
<p>打个比方：</p>
<ul>
<li>浅层网络就像小学生，只能认识简单的字母和数字</li>
<li>深层网络就像大学教授，能理解复杂的概念和抽象的知识</li>
</ul>
<h4 data-id="heading-5">2.3 深度学习为什么这么强大？</h4>
<p>深度学习的魔力在于<strong>自动特征提取</strong>。</p>
<p>在传统机器学习中，工程师需要手动告诉机器"猫的特征是尖耳朵、胡须、毛茸茸..."而深度学习可以自己从大量数据中学习这些特征：</p>
<ul>
<li>第 1 层：学习边缘、颜色</li>
<li>第 2 层：学习纹理、局部形状</li>
<li>第 3 层：学习耳朵、眼睛等部位</li>
<li>第 N 层：学习整体"猫"的概念</li>
</ul>
<p>这种<strong>层层递进、从简单到复杂</strong>的学习方式，让深度学习在图像、语音、文本等领域取得了突破性进展。</p>
<hr/>
<h3 data-id="heading-6">三、卷积神经网络：计算机的"眼睛"</h3>
<h4 data-id="heading-7">3.1 为什么需要卷积神经网络（CNN）？</h4>
<p>普通的神经网络处理图像时有个大问题：<strong>参数太多了</strong>！</p>
<p>假设一张 224 x 224 的彩色图片：</p>
<ul>
<li>像素数：224 x 224 x 3 = 150,528 个输入</li>
<li>如果第一层有 1000 个神经元，参数数量 = 1.5 亿！</li>
</ul>
<p>这不仅计算量惊人，还容易导致过拟合（模型死记硬背，泛化能力差）。</p>
<h4 data-id="heading-8">3.2 卷积的核心思想：局部感知 + 参数共享</h4>
<p><strong>卷积神经网络</strong>用一个巧妙的方法解决了这个问题：</p>
<p><strong>1. 局部感知（Local Connectivity）</strong></p>
<p>与其让每个神经元看整张图片，不如只让它看一小块区域。就像我们看东西时，视觉焦点一次也只关注一小块区域。</p>
<pre><code class="hljs language-css" lang="css">原图：                     卷积核（滤波器）：
<span class="hljs-selector-attr">[ 1  2  3  4  5 ]</span>         <span class="hljs-selector-attr">[ 1  0 -1 ]</span>
<span class="hljs-selector-attr">[ 6  7  8  9  10]</span>    ×    <span class="hljs-selector-attr">[ 1  0 -1 ]</span>   =   特征图
<span class="hljs-selector-attr">[ 11 12 13 14 15]</span>         <span class="hljs-selector-attr">[ 1  0 -1 ]</span>
<span class="hljs-selector-attr">[ 16 17 18 19 20]</span>
<span class="hljs-selector-attr">[ 25 22 23 24 25]</span>

卷积核在图像上滑动，每次只处理一个 <span class="hljs-number">3</span>x3 的区域
</code></pre>
<p><strong>2. 参数共享（Parameter Sharing）</strong></p>
<p>同一个卷积核在整张图片上滑动，用相同的参数处理不同位置——这大大减少了参数数量！</p>

















<table><thead><tr><th>方式</th><th>参数数量</th></tr></thead><tbody><tr><td>全连接</td><td>1.5 亿</td></tr><tr><td>卷积（3x3核）</td><td>27 个</td></tr></tbody></table>
<p>差距惊人吧？这就是卷积的威力。</p>
<h4 data-id="heading-9">3.3 CNN 的经典结构</h4>
<p>一个典型的 CNN 包含以下组件：</p>
<pre><code class="hljs language-css" lang="css">输入图像
    ↓
<span class="hljs-selector-attr">[卷积层]</span> → 提取特征（边缘、纹理等）
    ↓
<span class="hljs-selector-attr">[激活函数 ReLU]</span> → 引入非线性
    ↓
<span class="hljs-selector-attr">[池化层]</span> → 降低分辨率，减少计算量
    ↓
<span class="hljs-selector-attr">[重复上述结构若干次...]</span>
    ↓
<span class="hljs-selector-attr">[全连接层]</span> → 综合特征，做出判断
    ↓
输出结果
</code></pre>
<p><strong>卷积层</strong>：用卷积核提取图像特征
<strong>激活函数（ReLU）</strong>：<code>f(x) = max(0, x)</code>，简单但有效，让网络能学习复杂模式
<strong>池化层</strong>：通常取局部最大值（Max Pooling），压缩信息的同时保留重要特征</p>
<h4 data-id="heading-10">3.4 CNN 的发展历程</h4>









































<table><thead><tr><th>年份</th><th>网络名称</th><th>层数</th><th>突破</th></tr></thead><tbody><tr><td>1998</td><td>LeNet-5</td><td>7</td><td>首个成功的 CNN，用于手写数字识别</td></tr><tr><td>2012</td><td>AlexNet</td><td>8</td><td>深度学习的复兴之作，ImageNet 冠军</td></tr><tr><td>2014</td><td>VGGNet</td><td>19</td><td>证明了网络越深效果越好</td></tr><tr><td>2014</td><td>GoogLeNet</td><td>22</td><td>引入 Inception 模块</td></tr><tr><td>2015</td><td>ResNet</td><td><strong>152</strong></td><td>残差学习，突破深度限制</td></tr></tbody></table>
<p>注意到了吗？网络越来越深，效果越来越好。但 VGG 到 ResNet 之间发生了什么？为什么层数能从 19 跃升到 152？</p>
<p>这就要说到 ResNet 解决的核心问题了。</p>
<hr/>
<h3 data-id="heading-11">四、残差网络：深度学习的里程碑</h3>
<h4 data-id="heading-12">ResNet 解决的核心问题（速览）</h4>
<p>在深入了解残差网络之前，让我们先明确它到底解决了什么问题：</p>

























<table><thead><tr><th>问题</th><th>表现</th><th>ResNet 的解决方案</th></tr></thead><tbody><tr><td><strong>退化问题</strong></td><td>网络层数增加后，训练和测试准确率都下降</td><td>残差学习 + 跳跃连接</td></tr><tr><td><strong>梯度消失/爆炸</strong></td><td>深层网络反向传播时，梯度变得极小或极大，导致浅层无法有效学习</td><td>跳跃连接提供梯度直通路径</td></tr><tr><td><strong>恒等映射难以学习</strong></td><td>网络即使只需要"什么都不做"，也很难学会</td><td>跳跃连接直接提供恒等映射</td></tr></tbody></table>
<p><strong>一句话总结</strong>：ResNet 通过引入<strong>跳跃连接（Skip Connection）</strong>，让信息和梯度能够"绕过"中间层直接传递，从而使训练非常深的网络成为可能。</p>
<p>下面我们详细看看这些问题是如何产生的，以及 ResNet 的解决思路。</p>
<hr/>
<h4 data-id="heading-13">4.1 深度网络的困境</h4>
<p>理论上，网络越深，能学习的特征越抽象、越复杂，效果应该越好。但现实中却出现了一个奇怪的现象：</p>
<p><strong>网络层数增加到一定程度后，准确率反而下降了！</strong></p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-code">                   准确率
                     ↑
                     │    ___
                     │   /   \
                     │  /     \___
                     │ /           \
                     │/             \_____
                     └─────────────────────→ 网络深度
                              ↑
                           这里开始下降！
</span></code></pre>
<p>这个问题叫做<strong>退化问题（Degradation Problem）</strong>，注意它不是过拟合（过拟合是训练集上表现好但测试集上差），而是训练集和测试集上的效果都变差了！</p>
<p>这说明更深的网络更难训练。主要原因有两个：</p>
<ol>
<li><strong>梯度消失/爆炸</strong>：反向传播时，梯度在层层传递中变得极小或极大，导致浅层几乎无法学习</li>
<li><strong>恒等映射难以学习</strong>：即使只需要让深层网络学会"什么都不做"（恒等映射），它也很难做到</li>
</ol>
<h4 data-id="heading-14">4.2 残差学习：一个天才的想法</h4>
<p>何恺明团队提出了一个简单却革命性的想法：</p>
<blockquote>
<p>如果深层网络难以学习恒等映射，那我们<strong>直接把恒等映射"送"给它</strong>！</p>
</blockquote>
<p>具体做法是引入<strong>跳跃连接（Skip Connection）</strong>：</p>
<pre><code class="hljs language-scss" lang="scss">传统网络：
输入 x → <span class="hljs-selector-attr">[卷积层1]</span> → <span class="hljs-selector-attr">[卷积层2]</span> → 输出 <span class="hljs-built_in">H</span>(x)
目标：学习 <span class="hljs-built_in">H</span>(x)

残差网络：
                    ┌──────────────────────────┐
                    │      跳跃连接（恒等映射）  │
                    ↓                          │
输入 x → <span class="hljs-selector-attr">[卷积层1]</span> → <span class="hljs-selector-attr">[卷积层2]</span> → (+) → 输出 <span class="hljs-built_in">H</span>(x) = <span class="hljs-built_in">F</span>(x) + x
                                 ↑
                            两者相加
目标：学习 <span class="hljs-built_in">F</span>(x) = <span class="hljs-built_in">H</span>(x) - x
</code></pre>
<p><strong>关键洞察</strong>：</p>
<ul>
<li>传统网络需要直接学习一个复杂的映射 <code>H(x)</code></li>
<li>残差网络只需要学习<strong>残差</strong> <code>F(x) = H(x) - x</code>，即输入和输出的<strong>差值</strong></li>
</ul>
<p>如果最优情况是恒等映射（什么都不做），那么：</p>
<ul>
<li>传统网络需要让每一层都精确学习 <code>H(x) = x</code>，很难！</li>
<li>残差网络只需要让 <code>F(x) = 0</code>，把所有权重推向零，容易得多！</li>
</ul>
<h4 data-id="heading-15">4.3 为什么残差学习有效？</h4>
<p>让我们用一个生活中的例子来理解：</p>
<p>假设你是一个学生，老师给了你两种考试方式：</p>
<p><strong>方式 A（传统网络）</strong>：直接写出答案（比如 3.14159265...）</p>
<p><strong>方式 B（残差网络）</strong>：给你一个参考答案 3.14，你只需要写出修正值（+0.00159265...）</p>
<p>显然，方式 B 更容易！因为：</p>
<ol>
<li>如果参考答案已经很准确，你可以直接写 0</li>
<li>你只需要关注"差异"在哪里，而不是从头开始</li>
</ol>
<p>这就是残差学习的精髓：<strong>让网络专注于学习"需要改变什么"，而不是"目标是什么"</strong>。</p>
<h4 data-id="heading-16">4.4 残差块的结构</h4>
<p>ResNet 的基本组成单元是<strong>残差块（Residual Block）</strong>：</p>
<pre><code class="hljs language-scss" lang="scss">基础版（用于 ResNet-<span class="hljs-number">18</span>/<span class="hljs-number">34</span>）：

         x
         │
         ├──────────────────────┐
         ↓                      │
    <span class="hljs-selector-attr">[3×3 卷积, 64]</span>              │
         ↓                      │
       <span class="hljs-selector-attr">[BN]</span>                     │
         ↓                      │
      <span class="hljs-selector-attr">[ReLU]</span>                    │
         ↓                      │
    <span class="hljs-selector-attr">[3×3 卷积, 64]</span>              │
         ↓                      │
       <span class="hljs-selector-attr">[BN]</span>                     │
         ↓                      │
        (+) ←───────────────────┘  跳跃连接
         ↓
      <span class="hljs-selector-attr">[ReLU]</span>
         ↓
       输出
</code></pre>
<pre><code class="hljs language-scss" lang="scss">瓶颈版（用于 ResNet-<span class="hljs-number">50</span>/<span class="hljs-number">101</span>/<span class="hljs-number">152</span>）：

         x
         │
         ├──────────────────────┐
         ↓                      │
    <span class="hljs-selector-attr">[1×1 卷积, 64]</span>   ← 降维     │
         ↓                      │
       <span class="hljs-selector-attr">[BN + ReLU]</span>              │
         ↓                      │
    <span class="hljs-selector-attr">[3×3 卷积, 64]</span>   ← 处理     │
         ↓                      │
       <span class="hljs-selector-attr">[BN + ReLU]</span>              │
         ↓                      │
    <span class="hljs-selector-attr">[1×1 卷积, 256]</span>  ← 升维     │
         ↓                      │
       <span class="hljs-selector-attr">[BN]</span>                     │
         ↓                      │
        (+) ←───────────────────┘
         ↓
      <span class="hljs-selector-attr">[ReLU]</span>
         ↓
       输出
</code></pre>
<p>瓶颈结构用 1x1 卷积先压缩维度，处理完再还原，大大减少了计算量。</p>
<h4 data-id="heading-17">4.5 当维度不匹配时怎么办？</h4>
<p>有时候，跳跃连接的输入 x 和 F(x) 的维度不一样（比如通道数不同，或者特征图尺寸不同），这时需要用一个<strong>投影连接</strong>来对齐：</p>
<pre><code class="hljs language-scss" lang="scss">         x
         │
         ├──────────────────────┐
         ↓                      ↓
    <span class="hljs-selector-attr">[残差分支]</span>            <span class="hljs-selector-attr">[1×1 卷积]</span>  ← 投影连接，调整维度
         ↓                      ↓
        (+) ←───────────────────┘
         ↓
       输出
</code></pre>
<h4 data-id="heading-18">4.6 ResNet 的完整结构</h4>
<p>以 ResNet-34 为例：</p>
<pre><code class="hljs language-scss" lang="scss">                              层数
输入图像 (<span class="hljs-number">224</span>×<span class="hljs-number">224</span>×<span class="hljs-number">3</span>)
         ↓
<span class="hljs-selector-attr">[7×7 卷积, stride=2]</span>           <span class="hljs-number">1</span>
         ↓
<span class="hljs-selector-attr">[3×3 最大池化, stride=2]</span>
         ↓
<span class="hljs-selector-attr">[残差块 × 3]</span> (<span class="hljs-number">64</span> 通道)          <span class="hljs-number">6</span>
         ↓
<span class="hljs-selector-attr">[残差块 × 4]</span> (<span class="hljs-number">128</span> 通道)         <span class="hljs-number">8</span>
         ↓
<span class="hljs-selector-attr">[残差块 × 6]</span> (<span class="hljs-number">256</span> 通道)        <span class="hljs-number">12</span>
         ↓
<span class="hljs-selector-attr">[残差块 × 3]</span> (<span class="hljs-number">512</span> 通道)         <span class="hljs-number">6</span>
         ↓
<span class="hljs-selector-attr">[全局平均池化]</span>
         ↓
<span class="hljs-selector-attr">[全连接层 → 1000 类]</span>           <span class="hljs-number">1</span>
                            ────
                             <span class="hljs-number">34</span> 层
</code></pre>
<p>ResNet 系列网络对比：</p>















































<table><thead><tr><th>网络</th><th>层数</th><th>残差块数</th><th>参数量</th><th>Top-5 错误率</th></tr></thead><tbody><tr><td>ResNet-18</td><td>18</td><td>8</td><td>11.7M</td><td>10.92%</td></tr><tr><td>ResNet-34</td><td>34</td><td>16</td><td>21.8M</td><td>9.46%</td></tr><tr><td>ResNet-50</td><td>50</td><td>16</td><td>25.6M</td><td>7.48%</td></tr><tr><td>ResNet-101</td><td>101</td><td>33</td><td>44.5M</td><td>6.52%</td></tr><tr><td>ResNet-152</td><td>152</td><td>50</td><td>60.2M</td><td>6.16%</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-19">五、残差网络的深远影响</h3>
<h4 data-id="heading-20">5.1 解锁了网络深度</h4>
<p>ResNet 之前，主流网络最多 20 多层。ResNet 证明了几百甚至上千层的网络是可行的！这直接启发了后来的"大模型"思路：模型越大、越深，潜力越大。</p>
<h4 data-id="heading-21">5.2 跳跃连接成为标配</h4>
<p>ResNet 的跳跃连接思想被广泛采用：</p>
<ul>
<li><strong>Transformer</strong>：用于 ChatGPT、BERT 等大语言模型，其中也使用了残差连接</li>
<li><strong>U-Net</strong>：医学图像分割的经典网络，使用类似的跳跃连接</li>
<li><strong>DenseNet</strong>：将跳跃连接发展到极致，每层都与之前所有层相连</li>
</ul>
<h4 data-id="heading-22">5.3 后续变体</h4>
<p>ResNet 启发了大量改进版本：</p>

























<table><thead><tr><th>变体</th><th>改进点</th></tr></thead><tbody><tr><td>ResNeXt</td><td>引入分组卷积，提升效率</td></tr><tr><td>SE-ResNet</td><td>加入通道注意力机制</td></tr><tr><td>Res2Net</td><td>多尺度特征提取</td></tr><tr><td>ResNeSt</td><td>分离注意力机制</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-23">六、从 ResNet 到大模型</h3>
<h4 data-id="heading-24">6.1 共同的设计哲学</h4>
<p>当今的大模型（如 GPT、BERT、ViT）虽然和 ResNet 处理的任务不同，但继承了它的核心思想：</p>
<ol>
<li><strong>残差连接</strong>：Transformer 的每个注意力层和前馈层都使用残差连接</li>
<li><strong>深度堆叠</strong>：GPT-3 有 96 层，没有残差连接根本无法训练</li>
<li><strong>预训练 + 微调</strong>：这种范式也受益于残差网络证明的"深度可行性"</li>
</ol>
<h4 data-id="heading-25">6.2 视觉大模型中的 ResNet</h4>
<p>在 CLIP、DALL-E 等视觉大模型中，ResNet（或其变体）常被用作图像编码器：</p>
<pre><code class="hljs language-css" lang="css">图像 → <span class="hljs-selector-attr">[ResNet 编码器]</span> → 图像特征向量
                            ↓
                     <span class="hljs-selector-attr">[多模态融合]</span>
                            ↓
文本 → <span class="hljs-selector-attr">[Transformer 编码器]</span> → 文本特征向量
</code></pre>
<p>可以说，没有 ResNet 解决深度网络的训练问题，就没有今天的 AI 大模型时代。</p>
<hr/>
<h3 data-id="heading-26">七、总结</h3>
<p>让我们回顾一下这趟旅程：</p>

























<table><thead><tr><th>阶段</th><th>核心概念</th><th>关键突破</th></tr></thead><tbody><tr><td>深度学习基础</td><td>神经网络、层层抽象</td><td>自动特征提取</td></tr><tr><td>卷积神经网络</td><td>局部感知、参数共享</td><td>高效处理图像</td></tr><tr><td>残差网络</td><td>跳跃连接、残差学习</td><td>解锁网络深度</td></tr></tbody></table>
<p>ResNet 的核心贡献用一句话概括就是：</p>
<blockquote>
<p><strong>让极深的神经网络成为可能，为 AI 打开了通往更强大模型的大门。</strong></p>
</blockquote>
<p>何恺明团队用一个简单优雅的想法——跳跃连接——解决了困扰学界多年的深度网络退化问题。这个故事告诉我们，有时候最伟大的创新不是复杂的算法，而是对问题本质的深刻洞察。</p>
<hr/>
<h3 data-id="heading-27">延伸阅读</h3>
<p>如果你想进一步了解这个领域，推荐以下资源：</p>
<ol>
<li><strong>论文原文</strong>：<em>Deep Residual Learning for Image Recognition</em>（何恺明等，2015）</li>
<li><strong>视频教程</strong>：吴恩达的深度学习课程（Coursera）</li>
<li><strong>实践项目</strong>：使用 PyTorch/TensorFlow 实现一个简单的 ResNet</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[打破聊天框的“第四面墙”：Clawdbot，给你的大模型装上“手脚”]]></title>    <link>https://juejin.cn/post/7599155566298021931</link>    <guid>https://juejin.cn/post/7599155566298021931</guid>    <pubDate>2026-01-26T09:29:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599155566298021931" data-draft-id="7599299048303099947" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="打破聊天框的“第四面墙”：Clawdbot，给你的大模型装上“手脚”"/> <meta itemprop="keywords" content="Agent"/> <meta itemprop="datePublished" content="2026-01-26T09:29:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="谁怕平生太急"/> <meta itemprop="url" content="https://juejin.cn/user/1189015203094144"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            打破聊天框的“第四面墙”：Clawdbot，给你的大模型装上“手脚”
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1189015203094144/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    谁怕平生太急
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T09:29:17.000Z" title="Mon Jan 26 2026 09:29:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>“在 LLM Agent 爆发的今天，我们缺的不是更聪明的模型，而是如何将模型能力安全、低延迟地映射到本地设备上。当 AI 不再满足于仅仅做一个‘聊天搭子’，它开始长出了‘手脚’——Clawdbot 就是那个连接大脑与手脚的神经中枢。”</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f5bb1cb651664b39b3a0661b97155c8e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LCB5oCV5bmz55Sf5aSq5oCl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770024559&amp;x-signature=nB%2BoPo74xc4nMQqvqbHSh0zqEUo%3D" alt="ClawdBot.jpeg" loading="lazy"/></p>
<h2 data-id="heading-0">01 -&gt; For Users：它能帮你做什么？</h2>
<h4 data-id="heading-1">（打破“对话框”的第四面墙）</h4>
<p>基于 Clawdbot “Gateway + Node + Tools” 的架构，它能让 AI 突破“聊天框”的限制，直接操作你的设备和网络。</p>
<p><strong>目前已集成：</strong></p>
<p><strong>1、消息平台集成 (Channels) —— 解决“在哪里对话”</strong></p>
<ul>
<li>WhatsApp, Telegram, Discord, Slack, Signal, iMessage</li>
</ul>
<p><strong>2、AI 模型集成 (The Brains) —— 解决“用谁的大脑”</strong></p>
<ul>
<li><strong>闭源大模型：</strong> Anthropic (Claude 3.5/4.5 系列)、OpenAI (GPT-4o/o1)、Google (Gemini)、xAI (Grok)。</li>
<li><strong>开源/本地模型：</strong> 支持通过 Ollama, MLX, llama.cpp 接入本地模型；支持 DeepSeek, Mistral, GLM 等。</li>
</ul>
<p><strong>3、生产力与知识库集成 (Skills &amp; Tools) —— 解决“能干什么”</strong>
通过各种 Skills 访问你的私人数据或操作软件：</p>
<ul>
<li><strong>笔记与任务：</strong> Notion, Obsidian, Apple Notes, Trello, Apple Reminders, Things 3, Bear Notes。</li>
<li><strong>代码与开发：</strong> GitHub (提交代码、管理 Issue)、Terminal/Shell 访问、浏览器自动化控制。</li>
<li><strong>邮件与日程：</strong> Gmail (读取、分类、撰写回复)、Google Calendar、Apple HealthKit (Oura/WHOOP 健身数据)。</li>
<li><strong>媒体与家居：</strong> Spotify, Sonos (控制音乐)；Philips Hue, Home Assistant (智能家居控制)。</li>
</ul>
<p><strong>4、系统级集成 (The Gateway) —— 解决“自动化”</strong></p>
<ul>
<li><strong>Cron Jobs：</strong> 支持设置定时任务（如每天早上 8 点发送晨报）。</li>
<li><strong>Webhooks：</strong> 接收外部触发器，实现联动。</li>
<li><strong>持久化记忆：</strong> 所有的对话上下文和任务进度都存储在本地（Markdown/文件夹形式），不依赖云端数据库。</li>
</ul>
<hr/>
<h3 data-id="heading-2">1.1 使用示例</h3>
<p><strong>1. 跨平台消息聚合与“替身”回复</strong></p>
<blockquote>
<p><strong>场景描述：</strong> 你正在开车或开会，不方便看手机，但微信、Telegram、Slack 都在弹消息。
<strong>如何工作：</strong> Clawdbot 将所有渠道的消息汇总到一个你指定的“主控渠道”（比如 Telegram 私聊）。
<strong>Agent 动作：</strong> Agent 根据你设定的提示词（Prompt）自动总结长消息，甚至根据你的语气草拟回复，你只需回一个 "Yes" 即可发送。
<strong>价值：</strong> 信息流统一入口，减少在不同 App 间切换的焦虑。</p>
</blockquote>
<p><strong>2. 自动化“稍后阅读”与摘要 (网页/文档)</strong></p>
<blockquote>
<p><strong>场景描述：</strong> 在手机上浏览到一篇很棒的技术长文或 PDF，但现在没时间细看。
<strong>如何工作：</strong> 直接把链接发给 Clawdbot。
<strong>Agent 动作：</strong> Gateway 调用服务器端的无头浏览器（Browser Tool）访问链接，提取正文，利用 LLM 进行深度摘要，并生成思维导图或 Key Takeaways 发回给你。如果是 PDF，它会进行解析和总结。
<strong>价值：</strong> 从“收藏夹吃灰”变为“即时知识消化”。</p>
</blockquote>
<p><strong>3. 智能家居与本地服务器运维</strong></p>
<blockquote>
<p><strong>场景描述：</strong> 你是开发者，想在外面重启家里的某个 Docker 容器，或者查询 NAS 的磁盘剩余空间。
<strong>如何工作：</strong> 通过 Telegram 发送指令“重启 Nginx 容器”。
<strong>Agent 动作：</strong> Gateway 路由指令到家里的 Linux Node，执行 docker restart nginx，并将执行结果（日志片段）回传给你。
<strong>价值：</strong> 无需复杂的 VPN 或 SSH 客户端，通过聊天窗口完成轻量级运维。</p>
</blockquote>
<p><strong>4. 语音笔记与日程整理 (Voice-to-Action)</strong></p>
<blockquote>
<p><strong>场景描述：</strong> 走路时突然想到一个点子，或者想起明天要给客户打电话。
<strong>如何工作：</strong> 给 Clawdbot 发送一条几十秒的语音消息。
<strong>Agent 动作：</strong> Clawdbot 调用 STT (语音转文字) 服务转录内容，识别出意图是“添加日程”。它会进一步调用日历 API (如 Google Calendar 工具) 帮你建好日程，并回复确认。
<strong>价值：</strong> 将非结构化的语音流转化为结构化的生产力动作。</p>
</blockquote>
<p><strong>5. 沉浸式“第二大脑”搜索</strong></p>
<blockquote>
<p><strong>场景描述：</strong> 你需要查询一个多年前看过的技术点，或者现在的实时股票信息，但不想打开浏览器被广告干扰。
<strong>如何工作：</strong> 直接问 Clawdbot。
<strong>Agent 动作：</strong> 它不仅能联网搜索（调用 Google/Bing），还能检索你之前的聊天记录（如果配置了向量数据库记忆），融合实时信息和个人记忆给出答案。
<strong>价值：</strong> 去广告、去干扰的纯净信息获取。</p>
</blockquote>
<hr/>
<h3 data-id="heading-3">1.2 使用起来 可能存在什么问题</h3>
<p>Clawdbot 很强大，但它不是万能的，特别是在中国互联网环境下。</p>
<h4 data-id="heading-4">1.2.1 使用场景方面</h4>
<p><strong>1. 对中文 App 的支持边界</strong></p>
<ul>
<li>
<p><strong>微信 (WeChat)：</strong> <strong>支持但极高风险。</strong></p>
</li>
<li>
<p><strong>原理：</strong> 通常通过 iPad 协议或 Web 协议挂载。</p>
</li>
<li>
<p><strong>现状：</strong> 腾讯风控非常严格，非官方客户端极易导致封号（从限制登录到永久封禁）。<strong>强烈建议不要用主号尝试。</strong></p>
</li>
<li>
<p><strong>企业微信/飞书/钉钉：</strong> <strong>有限支持。</strong></p>
</li>
<li>
<p>通常需要管理员权限开启 API 或 Bot 模式，个人用户很难直接接管自己的私人账号。</p>
</li>
<li>
<p><strong>小红书/抖音等内容平台：</strong> <strong>不支持。</strong></p>
</li>
<li>
<p>这些 App 没有开放 API，且 Web 端有复杂的反爬虫机制，Clawdbot 难以作为“客户端”接管。</p>
</li>
</ul>
<p><strong>2. 对中文网站的支持</strong></p>
<ul>
<li><strong>一般支持：</strong> 如果网站主要由 HTML 构成（如知乎文章、公众号文章网页版），Clawdbot 的浏览器工具可以完美解析。</li>
<li><strong>支持度中等：</strong> 对于知乎、雪球、财联社等资讯类网站，Clawdbot 的浏览器工具（基于 Puppeteer/Playwright 逻辑）通常能搞定。</li>
<li><strong>困难支持：</strong> 如果网站强依赖 App 验证、复杂的滑块验证码（可能会让 Agent 的爬虫失效）、必须登录才能查看内容的网站（如某些很多研报平台）、以及极其复杂的动态渲染页面、或者由于 IP 原因（如果你的 Gateway 部署在海外）无法访问国内特定资源，体验会很差。</li>
</ul>
<p><strong>3. 封禁风险 (Ban Risks)</strong></p>
<ul>
<li>🔴 <strong>高危区：</strong> 个人微信号。这是目前最大的雷区。</li>
<li>🟡 <strong>中危区：</strong> WhatsApp (如果短时间大量发送消息)、Telegram (如果是新号且频繁主动私聊陌生人)。</li>
<li>🟢 <strong>安全区：</strong> Slack, Discord, Telegram (正常使用)，这些平台对 Bot 更加友好。</li>
</ul>
<h4 data-id="heading-5">1.2.2 具体使用时</h4>
<p>同时在使用 Clawdbot 时，你可能会遇到以下具体的摩擦点：</p>
<p><strong>1. 部署维护门槛高 (Technical Debt)</strong>
这不是一个“下载即用”的 App。你需要懂 Docker，需要有一台 24小时运行的服务器 (或家里常开的 Mac/NAS)，还需要配置 API Key (OpenAI/Anthropic/GLM) 和网络环境。
一旦服务器宕机或网络波动，你的“助手”就失联了，你需要自己去排查日志。</p>
<p><strong>2. 成本问题 (Cost)</strong></p>
<ul>
<li><strong>API 费用：</strong> Clawdbot 本身免费，但它背后的 LLM (如 GPT-4, Claude 3.5 Sonnet) 是按 Token 收费的。如果你让它处理长文档或高频对话，一个月的 API 账单可能不菲。</li>
<li><strong>硬件/云服务器费用：</strong> 运行 Gateway 需要计算资源。</li>
</ul>
<p><strong>3. 隐私与安全 (Security)</strong>
虽然是“本地优先”，但你实际上是把你的聊天记录、屏幕截图、Shell 权限都开放给了这个 Bot。
如果你的 Gateway 服务器被黑客入侵，或者 API Key 泄露，你的个人隐私将面临巨大风险。你需要自己负责配置防火墙和鉴权。</p>
<p><strong>4. 移动端体验割裂</strong>
Clawdbot 在手机上没有独立的精美 App，它依附于 Telegram 或 WhatsApp 的聊天界面。这意味着你无法像用原生 App 那样进行复杂的交互（比如复杂的拖拽、多选、可视化的仪表盘），一切交互主要靠文字命令。</p>
<hr/>
<p><em>尽管使用方面有这么多的障碍，但是它的爆火已经说明大家对这样的工具非常期待、上述的问题迟早会被解决。</em></p>
<hr/>
<h2 data-id="heading-6">02 -&gt; For Developers：它是如何工作的？</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/24e97f7c11934a498e2756b4f740b34b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LCB5oCV5bmz55Sf5aSq5oCl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770024559&amp;x-signature=lkcM2aNVZnPxLB51uFBs6BriK8I%3D" alt="Gemini_Generated_Image_yfm9p6yfm9p6yfm9.png" loading="lazy"/></p>
<p>Clawdbot 是一个“本地优先”的个人 AI 网关 (Personal AI Gateway)。</p>
<p>它通过一个中心化的控制平面（Gateway），将你常用的所有通讯软件（微信、Telegram、Slack等）与你的本地设备（Mac/手机）连接起来，让 AI Agent 不仅能跨平台对话，还能直接调用本地设备的能力（如截屏、控制浏览器）。</p>
<h3 data-id="heading-7">2.1 核心架构</h3>
<p>Clawdbot 的架构设计呈现出典型的 “中心辐射型” (Hub-and-Spoke) 拓扑结构，其核心理念是 <strong>“Gateway is King” (网关即一切)</strong>。</p>
<p><strong>1. 核心中枢：Gateway (控制平面)</strong>
这是整个系统的“大脑”和交通枢纽。</p>
<ul>
<li><strong>角色：</strong> 它是一个运行在本地（如 Mac 或 Linux 服务器）的 WebSocket 服务。</li>
<li><strong>功能：</strong> 所有消息的收发、Agent 的调度、工具的执行、以及设备状态的管理，全都在这里统一处理。它不依赖云端 SaaS，数据掌握在你手中。</li>
</ul>
<p><strong>2. 输入/输出层：Channels (多渠道接入)</strong>
这是系统的“耳朵”和“嘴巴”，负责连接外部通讯平台。</p>
<ul>
<li><strong>支持协议：</strong> 它集成了 WhatsApp, Telegram, Slack, Discord, Signal, iMessage 甚至 WebChat 等平台的协议。</li>
<li><strong>工作方式：</strong> 它将不同平台的私有协议（如 WhatsApp 的 Baileys, Telegram 的 grammY）统一转化为 Clawdbot 内部的标准消息格式，传给 Gateway。这意味着你可以在任何聊天软件里跟同一个 AI 对话。</li>
</ul>
<p><strong>3. 执行终端：Nodes (设备节点)</strong>
这是系统的“手脚”，负责物理设备的具体操作。</p>
<ul>
<li><strong>差异化：</strong> Gateway 可以在云端运行，但 Node 必须运行在你的物理设备上（如 macOS App, iOS/Android 客户端）。</li>
<li><strong>能力：</strong> Node 通过 WebSocket 连接到 Gateway，暴露本地能力。例如：调用 Mac 的摄像头、进行屏幕录制、发送系统通知或执行 Shell 命令。</li>
</ul>
<p><strong>4. 智能引擎：Agent (Pi Agent)</strong>
这是系统的“思维”，通常是一个运行在 RPC 模式下的 AI 运行时。</p>
<ul>
<li><strong>机制：</strong> 它接收 Gateway 转发的用户意图，决策需要调用哪些工具（Tool Streaming），并将结果返回。</li>
</ul>
<h3 data-id="heading-8">2.2 示例说明</h3>
<p><strong>场景：</strong> 你在手机上用 Telegram 远程遥控家里的 Mac 截图并发送给你。
<strong>操作：</strong> 你在手机端的 Telegram 对机器人说：“帮我截一下 Mac 的屏幕，看看下载完成了吗？”</p>
<p><strong>背后架构的执行流程 (How it works)：</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a941e2e774c34d458dec64bf9b163f03~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LCB5oCV5bmz55Sf5aSq5oCl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770024559&amp;x-signature=FiICHgiLJwfUM38wRBMJl8lifTo%3D" alt="20260126-105054.jpg" loading="lazy"/></p>
<p><strong>1. 消息接收 (Channel Layer)</strong></p>
<ul>
<li>Telegram 的 Connector 收到消息，将其标准化为内部 Event。</li>
<li><em>架构支持：Channels 模块屏蔽了 Telegram 协议的复杂性。</em></li>
</ul>
<p><strong>↓</strong></p>
<p><strong>2. 意图路由 (Gateway Layer)</strong></p>
<ul>
<li>Gateway 收到消息，将其转发给当前的 Agent。</li>
<li><em>架构支持：Gateway 维护了会话上下文 (Session)，知道你是管理员，拥有执行权限。</em></li>
</ul>
<p><strong>↓</strong></p>
<p><strong>3. 决策与分发 (Agent Logic)</strong></p>
<ul>
<li>Agent 分析语义，决定调用 <code>screen.record</code> 或 <code>system.screenshot</code> 工具。</li>
<li>Agent 向 Gateway 发出“执行截图”的指令。</li>
</ul>
<p><strong>↓</strong></p>
<p><strong>4. 远程执行 (Node Layer)</strong></p>
<ul>
<li>Gateway 查找已连接的设备列表，找到注册为“MacBook Pro”的 macOS Node。</li>
<li>Gateway 通过 WebSocket 向该 Node 发送指令。</li>
<li><em>关键点：Gateway 可能跑在 Linux 服务器上，但它通过长连接“穿透”到了你家里的 Mac Node 上。</em></li>
</ul>
<p><strong>↓</strong></p>
<p><strong>5. 结果回传 (Feedback Loop)</strong></p>
<ul>
<li>Mac 上的 Node 执行本地截图命令，上传图片/数据流回 Gateway。</li>
<li>Gateway 将图片转交给 Telegram Connector。</li>
</ul>
<p><strong>✅ 最终你在手机 Telegram 上收到了一张 Mac 的实时屏幕截图。</strong></p>
<hr/>
<h2 data-id="heading-9">03 -&gt; For Geeks：核心概念通俗解构</h2>
<h4 data-id="heading-10">（网关、RPC与更多）</h4>
<h3 data-id="heading-11">网关 (Gateway)</h3>
<p>简单来说，网关（Gateway） 就像是一个小区的“大门卫室”，而 <strong>个人 AI 网关</strong> 则是专门为你个人服务的“AI 智能管家前台”。</p>
<p>在计算机网络中，网关是一个中间层。它介于“用户”和“后台服务”之间。
如果把服务器比作仓库，你（用户）去取货时，不能直接冲进仓库，而是要通过门卫室（网关）。这个门卫室负责：</p>
<ol>
<li><strong>身份验证：</strong> 检查你是否有权限进入（鉴权）。</li>
<li><strong>分流引导：</strong> 告诉你要去 1 号库房还是 2 号库房（路由/负载均衡）。</li>
<li><strong>安检：</strong> 拦截危险物品（安全防护/限流）。</li>
</ol>
<p><strong>个人 AI 网关</strong>
就是一个运行在你本地或私有云上的“统一中转站”。它不再只是传话筒，而是具备了智能大脑的门卫。
核心功能包括：</p>
<ul>
<li><strong>统一入口：</strong> 不管后台接的是哪个大模型，你对外只暴露一个标准接口（通常兼容 OpenAI 格式）。</li>
<li><strong>模型路由：</strong> 根据你的指令复杂程度自动分发。简单的对话发给轻量模型（省钱/快），复杂的算法逻辑发给最强模型。</li>
<li><strong>敏感信息拦截：</strong> 在数据发往云端大模型之前，网关可以自动识别并脱敏（保护你的个人隐私或私密代码）。</li>
<li><strong>缓存加速：</strong> 相似的算法问题，网关如果存有之前的答案，就不再请求云端，直接秒回。</li>
<li><strong>成本监控：</strong> 帮你盯着各个 API Key 扣了多少钱，防止超支。</li>
</ul>
<h3 data-id="heading-12">WebSocket 服务</h3>
<p>一种让服务器和客户端（比如你的浏览器）进行“持续对话”的技术。</p>
<p><strong>类比说明：</strong> 如果把传统的 HTTP 请求比作发短信（发一条，回一条），那么 WebSocket 就像是打通电话（通话不挂断，双方随时都能说话）。</p>
<h3 data-id="heading-13">RPC（Remote Procedure Call，远程过程调用）</h3>
<p>RPC 是一种设计模式，它的目标是透明化网络调用。</p>
<p><strong>核心思想就是：</strong> 让你像调用本地函数一样，去调用远程服务器上的函数。
在分布式系统或微服务架构中，RPC 是不同服务之间沟通的“普通话”。
RPC 屏蔽了底层的网络传输、序列化、协议转换等复杂细节。你不需要关心它是用 TCP 还是 HTTP 传输的，也不需要手动解析 JSON 或 Protobuf，它就像是在调用本地代码。</p>
<p><strong>常见的 RPC 协议/框架：</strong></p>
<ul>
<li><strong>gRPC (Google):</strong> 目前最流行，基于 HTTP/2，使用 Protobuf 定义接口，支持多语言。</li>
<li><strong>Thrift (Facebook):</strong> 性能极高，支持非常多的编程语言。</li>
<li><strong>Dubbo (Alibaba):</strong> 在 Java 生态中非常出名，自带治理功能。</li>
</ul>
<h3 data-id="heading-14">TypeScript</h3>
<ul>
<li><strong>一层“马甲”：</strong> TypeScript = JavaScript + 类型系统。 它不是一门全新的语言，它最终会被编译（Transpile）成普通的 JS。你可以把 TS 想象成给 JS 穿上了一套“外骨骼装甲”，增强了稳定性和力量，但核心还是那个 JS。</li>
<li><strong>“活的文档”：</strong> 在 TS 里，你定义 <code>processTensor(data: TensorConfig)</code>，编辑器（VS Code）会实时告诉你 data 里有哪些字段。代码即文档。</li>
<li><strong>“编译期检查”：</strong> JS 是动态语言（运行时才发现错），TS 引入了静态检查。</li>
</ul>
<hr/>
<h2 data-id="heading-15">04 相关链接</h2>
<ul>
<li><strong>官网：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fclawd.bot%2F" target="_blank" title="https://clawd.bot/" ref="nofollow noopener noreferrer">clawd.bot/</a></li>
<li><strong>Github：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fclawdbot%2Fclawdbot" target="_blank" title="https://github.com/clawdbot/clawdbot" ref="nofollow noopener noreferrer">github.com/clawdbot/cl…</a></li>
<li><strong>TypeScript:</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.typescriptlang.org%2Fdocs%2Fhandbook%2Ftypescript-from-scratch.html" target="_blank" title="https://www.typescriptlang.org/docs/handbook/typescript-from-scratch.html" ref="nofollow noopener noreferrer">www.typescriptlang.org/docs/handbo…</a></li>
<li><strong>Ts实战：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Ftypehero.dev%2F" target="_blank" title="https://typehero.dev/" ref="nofollow noopener noreferrer">typehero.dev/</a></li>
</ul>
<p>如果这篇文章对你有帮助，欢迎关注我的同名公众号。
我将持续分享 AI 工程化、Agent 实战及算法应用相关的深度内容。我们下期见。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[langchain-HuggingFace 文本嵌入（embeddings）学习总结]]></title>    <link>https://juejin.cn/post/7599330434426421299</link>    <guid>https://juejin.cn/post/7599330434426421299</guid>    <pubDate>2026-01-26T09:43:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599330434426421299" data-draft-id="7599543345979801627" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="langchain-HuggingFace 文本嵌入（embeddings）学习总结"/> <meta itemprop="keywords" content="前端,后端"/> <meta itemprop="datePublished" content="2026-01-26T09:43:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="心在飞扬AI"/> <meta itemprop="url" content="https://juejin.cn/user/1556564194366823"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            langchain-HuggingFace 文本嵌入（embeddings）学习总结
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1556564194366823/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    心在飞扬AI
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T09:43:50.000Z" title="Mon Jan 26 2026 09:43:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">HuggingFace 文本嵌入（embeddings）学习总结</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fhuggingface.co" target="_blank" title="https://huggingface.co" ref="nofollow noopener noreferrer">huggingface.co</a></p>
<h3 data-id="heading-1">1. HuggingFace 远程嵌入</h3>
<h4 data-id="heading-2">是什么</h4>
<p>通过 HuggingFace API 调用云端 embedding 模型，将文本转换为向量，无需本地下载模型文件。</p>
<h4 data-id="heading-3">有什么用</h4>
<ul>
<li>快速验证模型效果</li>
<li>无需本地算力资源</li>
<li>适合开发测试环境</li>
</ul>
<h4 data-id="heading-4">示例</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_huggingface <span class="hljs-keyword">import</span> HuggingFaceEndpointEmbeddings
<span class="hljs-keyword">import</span> dotenv

dotenv.load_dotenv()

embeddings = HuggingFaceEndpointEmbeddings(
    model=<span class="hljs-string">"sentence-transformers/all-MiniLM-L12-v2"</span>
)

vector = embeddings.embed_query(<span class="hljs-string">"你好，我是穆小课，我喜欢打篮球游泳"</span>)
<span class="hljs-comment"># 输出：[0.123, -0.456, ...]  384维向量</span>
</code></pre>
<hr/>
<h3 data-id="heading-5">2. HuggingFace 本地嵌入</h3>
<h4 data-id="heading-6">是什么</h4>
<p>将 HuggingFace 模型下载到本地运行，通过 <code>HuggingFaceEmbeddings</code> 完成离线文本向量化。</p>
<h4 data-id="heading-7">有什么用</h4>
<ul>
<li>数据隐私安全（文本不上传）</li>
<li>无网络依赖</li>
<li>可批量处理降成本</li>
<li>支持自定义缓存路径</li>
</ul>
<h4 data-id="heading-8">示例</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_huggingface <span class="hljs-keyword">import</span> HuggingFaceEmbeddings

embeddings = HuggingFaceEmbeddings(
    model_name=<span class="hljs-string">"sentence-transformers/all-MiniLM-L12-v2"</span>,
    cache_folder=<span class="hljs-string">"./embeddings/"</span>  <span class="hljs-comment"># 模型缓存目录</span>
)

vector = embeddings.embed_query(<span class="hljs-string">"你好，我是慕小课，我喜欢打篮球游泳"</span>)
<span class="hljs-comment"># 输出：[0.123, -0.456, ...]  384维向量</span>
</code></pre>
<hr/>
<h3 data-id="heading-9">3. 百度千帆文本嵌入</h3>
<h4 data-id="heading-10">是什么</h4>
<p>调用百度千帆平台的 embedding API，将中文文本转换为向量表示。</p>
<h4 data-id="heading-11">有什么用</h4>
<ul>
<li>中文场景优化</li>
<li>国产化 API 替代方案</li>
<li>配额管理灵活</li>
</ul>
<h4 data-id="heading-12">示例</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_community.embeddings.baidu_qianfan_endpoint <span class="hljs-keyword">import</span> QianfanEmbeddingsEndpoint
<span class="hljs-keyword">import</span> dotenv

dotenv.load_dotenv()

embeddings = QianfanEmbeddingsEndpoint()

vector = embeddings.embed_query(<span class="hljs-string">"我叫慕小课，我喜欢打篮球游泳"</span>)
<span class="hljs-comment"># 输出：百度返回的向量表示</span>
</code></pre>
<hr/>
<h3 data-id="heading-13">总结对比</h3>

























<table><thead><tr><th>方式</th><th>优势</th><th>适用场景</th></tr></thead><tbody><tr><td>HuggingFace 远程</td><td>零配置，即开即用</td><td>快速验证原型</td></tr><tr><td>HuggingFace 本地</td><td>隐私安全，离线可用</td><td>生产环境部署</td></tr><tr><td>百度千帆</td><td>中文优化，合规友好</td><td>国内业务场景</td></tr></tbody></table></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[为什么我的批量配置没生效？Hibernate 与 JdbcTemplate 执行流程大起底（二）]]></title>    <link>https://juejin.cn/post/7599053532169175081</link>    <guid>https://juejin.cn/post/7599053532169175081</guid>    <pubDate>2026-01-26T09:45:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599053532169175081" data-draft-id="7599237603976544299" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="为什么我的批量配置没生效？Hibernate 与 JdbcTemplate 执行流程大起底（二）"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-26T09:45:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="define9527"/> <meta itemprop="url" content="https://juejin.cn/user/414960194946937"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            为什么我的批量配置没生效？Hibernate 与 JdbcTemplate 执行流程大起底（二）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/414960194946937/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    define9527
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T09:45:46.000Z" title="Mon Jan 26 2026 09:45:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读22分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>上一篇文章搭建了项目并对比了二者效率，本文将深入源码，剖析 Hibernate 与 JdbcTemplate 批量操作的参数生效机制与执行流程</p>
</blockquote>
<h2 data-id="heading-0">源码解析</h2>
<p>现在将代码均按照支持批量插入和批量更新的要求进行配置</p>
<h3 data-id="heading-1">实现原理</h3>
<p>归根结底，所有上层框架（如 JPA/Hibernate、MyBatis、Spring JdbcTemplate 等）的批量插入或更新操作，最终都依赖于 JDBC 批处理（Batch Processing） 机制来实现真正的批量执行</p>
<blockquote>
<p>以下代码参考自 <a href="https://link.juejin.cn?target=https%3A%2F%2Fliaoxuefeng.com%2Fbooks%2Fjava%2Fjdbc%2Fbatch%2Findex.html" target="_blank" title="https://liaoxuefeng.com/books/java/jdbc/batch/index.html" ref="nofollow noopener noreferrer">JDBC 批处理</a></p>
</blockquote>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">try</span> (<span class="hljs-type">PreparedStatement</span> <span class="hljs-variable">ps</span> <span class="hljs-operator">=</span> conn.prepareStatement(<span class="hljs-string">"INSERT INTO students (name, gender, grade, score) VALUES (?, ?, ?, ?)"</span>)) {
    <span class="hljs-comment">// 对同一个PreparedStatement反复设置参数并调用addBatch()</span>
    <span class="hljs-keyword">for</span> (Student s : students) {
        ps.setString(<span class="hljs-number">1</span>, s.name);
        ps.setBoolean(<span class="hljs-number">2</span>, s.gender);
        ps.setInt(<span class="hljs-number">3</span>, s.grade);
        ps.setInt(<span class="hljs-number">4</span>, s.score);
        ps.addBatch();
    }
    <span class="hljs-comment">// 执行batch</span>
    <span class="hljs-type">int</span>[] ns = ps.executeBatch();
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> n : ns) {
        System.out.println(n + <span class="hljs-string">" inserted."</span>);
    }
}
</code></pre>
<p>JDBC（Java Database Connectivity）本身只是一套标准的 Java API 规范，由 Oracle（原 Sun Microsystems）定义，用于统一 Java 应用与关系型数据库的交互方式。它规定了接口（如 <code>Connection</code>、<code>Statement</code>、<code>PreparedStatement</code>、<code>ResultSet</code> 等）和行为，但不包含具体实现</p>
<p>具体的实现由数据库厂商或第三方驱动提供者完成，以 JDBC 驱动（Driver）的形式存在，这些驱动实现了 JDBC 规范中定义的接口，并封装了与各自数据库通信的底层协议</p>

























<table><thead><tr><th align="left">数据库</th><th align="left">JDBC 驱动实现（厂商提供）</th></tr></thead><tbody><tr><td align="left">MySQL</td><td align="left"><code>com.mysql.cj.jdbc.Driver</code>（由 Oracle/MySQL 官方维护）</td></tr><tr><td align="left">PostgreSQL</td><td align="left"><code>org.postgresql.Driver</code>（社区官方驱动）</td></tr><tr><td align="left">Oracle</td><td align="left"><code>oracle.jdbc.OracleDriver</code>（由 Oracle 提供）</td></tr><tr><td align="left">SQL Server</td><td align="left"><code>com.microsoft.sqlserver.jdbc.SQLServerDriver</code>（微软提供）</td></tr></tbody></table>
<p>所以 PreparedStatement 的 addBatch 和 executeBatch 方法的实现源码得去对应的驱动中找</p>
<h3 data-id="heading-2">JdbcTemplate 批处理</h3>
<p>直接使用 testJdbcTemplateBatchInsertPerformance 方法进行调试</p>
<h4 data-id="heading-3">JdbcTemplate 层的处理</h4>
<p>进入 batchUpdate 之后，便可以看到熟悉的 addBatch 和 executeBatch 方法</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JdbcTemplate</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">JdbcAccessor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">JdbcOperations</span> {

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> &lt;T&gt; <span class="hljs-type">int</span>[][] batchUpdate(
        String sql, 
        Collection&lt;T&gt; batchArgs, 
        <span class="hljs-type">int</span> batchSize,
        ParameterizedPreparedStatementSetter&lt;T&gt; pss
    ) <span class="hljs-keyword">throws</span> DataAccessException {
        <span class="hljs-comment">// ParameterizedPreparedStatementSetter 只有一个方法</span>
        <span class="hljs-comment">// setValues(PreparedStatement ps, T argument)</span>
        <span class="hljs-comment">// 它的作用就是给 PreparedStatement 设值，argument 参数值通常是实体对象</span>
        <span class="hljs-type">int</span>[][] result = execute(sql, (PreparedStatementCallback&lt;<span class="hljs-type">int</span>[][]&gt;) ps -&gt; {
            List&lt;<span class="hljs-type">int</span>[]&gt; rowsAffected = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
            <span class="hljs-keyword">try</span> {
                <span class="hljs-type">boolean</span> <span class="hljs-variable">batchSupported</span> <span class="hljs-operator">=</span> JdbcUtils.supportsBatchUpdates(ps.getConnection());
                <span class="hljs-type">int</span> <span class="hljs-variable">n</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
                <span class="hljs-keyword">for</span> (T obj : batchArgs) {
                    <span class="hljs-comment">// 利用 obj 给 PreparedStatement 设值</span>
                    pss.setValues(ps, obj);
                    n++;
                    <span class="hljs-keyword">if</span> (batchSupported) {
                        ps.addBatch();
                        <span class="hljs-keyword">if</span> (n % batchSize == <span class="hljs-number">0</span> || n == batchArgs.size()) {
                            <span class="hljs-keyword">try</span> {
                                <span class="hljs-type">int</span>[] updateCounts = ps.executeBatch();
                                rowsAffected.add(updateCounts);
                            }
                            <span class="hljs-keyword">catch</span> (BatchUpdateException ex) {
                                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AggregatedBatchUpdateException</span>(rowsAffected.toArray(<span class="hljs-type">int</span>[][]::<span class="hljs-keyword">new</span>), ex);
                            }
                        }
                    }
                    <span class="hljs-keyword">else</span> {
                        <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> ps.executeUpdate();
                        rowsAffected.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[] {i});
                    }
                }
                <span class="hljs-type">int</span>[][] result1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[rowsAffected.size()][];
                <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; result1.length; i++) {
                    result1[i] = rowsAffected.get(i);
                }
                <span class="hljs-keyword">return</span> result1;
            }
            <span class="hljs-keyword">finally</span> {
                <span class="hljs-keyword">if</span> (pss <span class="hljs-keyword">instanceof</span> ParameterDisposer parameterDisposer) {
                    parameterDisposer.cleanupParameters();
                }
            }
        });
        Assert.state(result != <span class="hljs-literal">null</span>, <span class="hljs-string">"No result array"</span>);
        <span class="hljs-keyword">return</span> result;
    }
}
</code></pre>
<p>execute 方法主要用于创建 PreparedStatement 对象和执行 PreparedStatementCallback 回调，所创建的 PreparedStatement 对象将作为参数传递给 PreparedStatementCallback 回调接口进行执行</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JdbcTemplate</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">JdbcAccessor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">JdbcOperations</span> {

    <span class="hljs-meta">@Override</span>
    <span class="hljs-meta">@Nullable</span>
    <span class="hljs-keyword">public</span> &lt;T&gt; T <span class="hljs-title function_">execute</span><span class="hljs-params">(String sql, PreparedStatementCallback&lt;T&gt; action)</span> <span class="hljs-keyword">throws</span> DataAccessException {
        <span class="hljs-keyword">return</span> execute(<span class="hljs-keyword">new</span> <span class="hljs-title class_">SimplePreparedStatementCreator</span>(sql), action, <span class="hljs-literal">true</span>);
    }

    <span class="hljs-meta">@Nullable</span>
    <span class="hljs-keyword">private</span> &lt;T&gt; T <span class="hljs-title function_">execute</span><span class="hljs-params">(PreparedStatementCreator psc, PreparedStatementCallback&lt;T&gt; action, <span class="hljs-type">boolean</span> closeResources)</span> <span class="hljs-keyword">throws</span> DataAccessException {
        <span class="hljs-comment">// 获取连接</span>
        <span class="hljs-type">Connection</span> <span class="hljs-variable">con</span> <span class="hljs-operator">=</span> DataSourceUtils.getConnection(obtainDataSource());
        <span class="hljs-type">PreparedStatement</span> <span class="hljs-variable">ps</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 创建 PreparedStatement 对象</span>
            ps = psc.createPreparedStatement(con);
            applyStatementSettings(ps);
            <span class="hljs-comment">// 传入 PreparedStatement 对象，执行 PreparedStatementCallback 回调</span>
            <span class="hljs-type">T</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> action.doInPreparedStatement(ps);
            handleWarnings(ps);
            <span class="hljs-keyword">return</span> result;
        }
        <span class="hljs-keyword">catch</span> (SQLException ex) {
            <span class="hljs-comment">// ...</span>
        }
        <span class="hljs-keyword">finally</span> {
            <span class="hljs-comment">// ...</span>
        }
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SimplePreparedStatementCreator</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">PreparedStatementCreator</span>, SqlProvider {

        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String sql;

        <span class="hljs-keyword">public</span> <span class="hljs-title function_">SimplePreparedStatementCreator</span><span class="hljs-params">(String sql)</span> {
            Assert.notNull(sql, <span class="hljs-string">"SQL must not be null"</span>);
            <span class="hljs-built_in">this</span>.sql = sql;
        }

        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> PreparedStatement <span class="hljs-title function_">createPreparedStatement</span><span class="hljs-params">(Connection con)</span> <span class="hljs-keyword">throws</span> SQLException {
            <span class="hljs-keyword">return</span> con.prepareStatement(<span class="hljs-built_in">this</span>.sql);
        }

        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getSql</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.sql;
        }
    }
}
</code></pre>
<p>在 JdbcTemplate#batchUpdate 方法里注册的 PreparedStatementCallback 回调中有一个 batchSupported 变量用于控制是否执行批量操作，而 <code>JdbcUtils#supportsBatchUpdates</code> 最终调用的是 <code>com.mysql.cj.jdbc.DatabaseMetaData#supportsBatchUpdates</code> 方法，且此方法直接返回 true</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JdbcUtils</span> {

    <span class="hljs-comment">/**
	 * Return whether the given JDBC driver supports JDBC batch updates.
	 * &lt;p&gt;Typically invoked right before execution of a given set of statements:
	 * to decide whether the set of SQL statements should be executed through
	 * the JDBC batch mechanism or simply in a traditional one-by-one fashion.
	 * &lt;p&gt;Logs a warning if the "supportsBatchUpdates" methods throws an exception
	 * and simply returns {<span class="hljs-doctag">@code</span> false} in that case.
	 * <span class="hljs-doctag">@param</span> con the Connection to check
	 * <span class="hljs-doctag">@return</span> whether JDBC batch updates are supported
	 * <span class="hljs-doctag">@see</span> java.sql.DatabaseMetaData#supportsBatchUpdates()
	 */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">supportsBatchUpdates</span><span class="hljs-params">(Connection con)</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">DatabaseMetaData</span> <span class="hljs-variable">dbmd</span> <span class="hljs-operator">=</span> con.getMetaData();
            <span class="hljs-keyword">if</span> (dbmd != <span class="hljs-literal">null</span>) {
                <span class="hljs-keyword">if</span> (dbmd.supportsBatchUpdates()) {
                    logger.debug(<span class="hljs-string">"JDBC driver supports batch updates"</span>);
                    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
                }
                <span class="hljs-keyword">else</span> {
                    logger.debug(<span class="hljs-string">"JDBC driver does not support batch updates"</span>);
                }
            }
        }
        <span class="hljs-keyword">catch</span> (SQLException ex) {
            logger.debug(<span class="hljs-string">"JDBC driver 'supportsBatchUpdates' method threw exception"</span>, ex);
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
}
</code></pre>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.mysql.cj.jdbc;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DatabaseMetaData</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">java</span>.sql.DatabaseMetaData {

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">supportsBatchUpdates</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLException {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
}
</code></pre>
<h4 data-id="heading-4">Driver 层的处理</h4>
<p>PreparedStatement 的 addBatch 和 executeBatch 方法由厂商实现，addBatch 的实现为 <code>com.mysql.cj.jdbc.ClientPreparedStatement#addBatch</code>，executeBatch 的实现为 <code>com.mysql.cj.jdbc.StatementImpl#executeBatch</code></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.mysql.cj.jdbc;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ClientPreparedStatement</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">com</span>.mysql.cj.jdbc.StatementImpl <span class="hljs-keyword">implements</span> <span class="hljs-title class_">JdbcPreparedStatement</span> {

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addBatch</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLException {
        <span class="hljs-type">Lock</span> <span class="hljs-variable">connectionLock</span> <span class="hljs-operator">=</span> checkClosed().getConnectionLock();
        connectionLock.lock();
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">QueryBindings</span> <span class="hljs-variable">queryBindings</span> <span class="hljs-operator">=</span> ((PreparedQuery) <span class="hljs-built_in">this</span>.query).getQueryBindings();
            queryBindings.checkAllParametersSet();
            <span class="hljs-comment">// 设值</span>
            <span class="hljs-built_in">this</span>.query.addBatch(queryBindings.clone());
        } <span class="hljs-keyword">finally</span> {
            connectionLock.unlock();
        }
    }
}
</code></pre>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.mysql.cj.jdbc;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StatementImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">JdbcStatement</span> {

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span>[] executeBatch() <span class="hljs-keyword">throws</span> SQLException {
        <span class="hljs-comment">// 调用 ClientPreparedStatement#executeBatchInternal 方法</span>
        <span class="hljs-keyword">return</span> Util.truncateAndConvertToInt(executeBatchInternal());
    }
}
</code></pre>
<p>ClientPreparedStatement 重写了 StatementImpl#executeBatchInternal 方法</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.mysql.cj.jdbc;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ClientPreparedStatement</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">com</span>.mysql.cj.jdbc.StatementImpl <span class="hljs-keyword">implements</span> <span class="hljs-title class_">JdbcPreparedStatement</span> {

    <span class="hljs-comment">/**
     * Does the batch (if any) contain "plain" statements added by Statement.addBatch(String)?
     *
     * If so, we can't re-write it to use multi-value or multi-queries.
     */</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">batchHasPlainStatements</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-type">long</span>[] executeBatchInternal() <span class="hljs-keyword">throws</span> SQLException {
        <span class="hljs-type">Lock</span> <span class="hljs-variable">connectionLock</span> <span class="hljs-operator">=</span> checkClosed().getConnectionLock();
        connectionLock.lock();
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// ...</span>
            <span class="hljs-keyword">try</span> (<span class="hljs-type">TelemetryScope</span> <span class="hljs-variable">scope</span> <span class="hljs-operator">=</span> span.makeCurrent()) {

                <span class="hljs-comment">// ...</span>

                <span class="hljs-comment">// 取值</span>
                <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.query.getBatchedArgs() == <span class="hljs-literal">null</span> || <span class="hljs-built_in">this</span>.query.getBatchedArgs().size() == <span class="hljs-number">0</span>) {
                    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">long</span>[<span class="hljs-number">0</span>];
                }
                <span class="hljs-comment">// we timeout the entire batch, not individual statements</span>
                <span class="hljs-type">long</span> <span class="hljs-variable">batchTimeout</span> <span class="hljs-operator">=</span> getTimeoutInMillis();
                setTimeoutInMillis(<span class="hljs-number">0</span>);
                resetCancelledState();
                <span class="hljs-keyword">try</span> {
                    statementBegins();
                    clearWarnings();
                    <span class="hljs-comment">// rewriteBatchedStatements是JDBC连接串中的rewriteBatchedStatements参数</span>
                    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">this</span>.batchHasPlainStatements &amp;&amp; <span class="hljs-built_in">this</span>.rewriteBatchedStatements.getValue()) {
                        <span class="hljs-comment">// Can this query be rewritten as a multi-values clause</span>
                        <span class="hljs-keyword">if</span> (getQueryInfo().isRewritableWithMultiValuesClause()) {
                            <span class="hljs-comment">// 走此分支</span>
                            <span class="hljs-keyword">return</span> executeBatchWithMultiValuesClause(batchTimeout);
                        }
                        <span class="hljs-comment">// ...</span>
                    }
                    <span class="hljs-comment">// 通过逐条执行的方式，执行当前批次中的所有语句</span>
                    <span class="hljs-keyword">return</span> executeBatchSerially(batchTimeout);
                } <span class="hljs-keyword">finally</span> {
                    <span class="hljs-built_in">this</span>.query.getStatementExecuting().set(<span class="hljs-literal">false</span>);
                    setTimeoutInMillis(batchTimeout);
                    clearBatch();
                }
            } <span class="hljs-keyword">catch</span> (Throwable t) {
                span.setError(t);
                <span class="hljs-keyword">throw</span> t;
            } <span class="hljs-keyword">finally</span> {
                span.end();
            }
        } <span class="hljs-keyword">finally</span> {
            connectionLock.unlock();
        }
    }
}
</code></pre>
<p>在 ClientPreparedStatement#executeBatchInternal 方法中，由 batchHasPlainStatements 和 rewriteBatchedStatements 两个变量来控制是否执行批量操作，rewriteBatchedStatements 其实就是 JDBC 连接串中的 rewriteBatchedStatements 参数</p>
<p>batchHasPlainStatements 的含义是：标记当前 JDBC 批处理中是否包含通过 <code>Statement.addBatch(String sql)</code> 添加的普通（plain）SQL 语句</p>
<p>JDBC 支持两种方式添加批处理</p>
<ol>
<li>使用 <code>PreparedStatement</code>（推荐）</li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">PreparedStatement</span> <span class="hljs-variable">ps</span> <span class="hljs-operator">=</span> connection.prepareStatement(<span class="hljs-string">"INSERT INTO users (name) VALUES (?)"</span>);
ps.setString(<span class="hljs-number">1</span>, <span class="hljs-string">"Alice"</span>);
ps.addBatch();
</code></pre>
<ol start="2">
<li>使用 <code>Statement</code> + 原始 SQL 字符串（不推荐用于批量）</li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">Statement</span> <span class="hljs-variable">stmt</span> <span class="hljs-operator">=</span> connection.createStatement();
stmt.addBatch(<span class="hljs-string">"INSERT INTO users (name) VALUES ('Alice')"</span>);
stmt.addBatch(<span class="hljs-string">"INSERT INTO users (name) VALUES ('Bob')"</span>);
</code></pre>
<p>当驱动（如 MySQL Connector/J）检测到批处理中混入了通过 <code>Statement.addBatch(String)</code> 添加的原始 SQL，就会将 <code>batchHasPlainStatements = true</code>，一旦该标志为 <code>true</code>，驱动将放弃对整个批处理进行优化重写（例如不会生成多值 INSERT 或多语句查询），而是按原始方式逐条执行</p>
<p>因此，要启用 rewriteBatchedStatements 的批量优化，必须全程使用 PreparedStatement，避免使用 <code>Statement.addBatch(String)</code></p>
<p>为什么要这么设计呢</p>
<ol>
<li>
<p>SQL 语义不可预测（Correctness First）：通过 <code>Statement.addBatch(String sql)</code> 添加的 SQL 是任意字符串</p>
<pre><code class="hljs language-java" lang="java">stmt.addBatch(<span class="hljs-string">"INSERT INTO users (name) VALUES ('Alice')"</span>);
stmt.addBatch(<span class="hljs-string">"UPDATE orders SET status = 'paid' WHERE id = 1"</span>);
stmt.addBatch(<span class="hljs-string">"DELETE FROM logs WHERE created &lt; '2020-01-01'"</span>);
</code></pre>
<p>这些语句类型不同（INSERT / UPDATE / DELETE）、操作不同表、语法结构完全不同，驱动无法安全地将它们合并成一条 SQL，强行重写会导致语法错误或逻辑错误（比如把 DELETE 和 INSERT 拼在一起）</p>
</li>
<li>
<p>无法保证同构性：<code>rewriteBatchedStatements</code> 的优化前提是所有批处理语句具有相同的 SQL 模板，即同构</p>
<pre><code class="hljs language-mysql" lang="mysql">-- 只是参数不同
INSERT INTO users (name, age) VALUES (?, ?)
</code></pre>
<p>只有这样，驱动才能安全地重写为</p>
<pre><code class="hljs language-mysql" lang="mysql">INSERT INTO users (name, age) VALUES (?, ?), (?, ?), (?, ?)
</code></pre>
<p>但 <code>Statement.addBatch(String)</code> 中的 SQL 可能是完全不同的表、不同的列数、包含子查询、函数、注释等复杂结构，一旦混入一条异构 SQL，整个批处理就不再同构，优化必须放弃</p>
</li>
<li>
<p>避免部分优化带来的不一致性：假设驱动尝试只优化看起来像的部分</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 批处理内容</span>
addBatch(<span class="hljs-string">"INSERT INTO t VALUES (1)"</span>);
addBatch(<span class="hljs-string">"INSERT INTO t VALUES (?)"</span>); <span class="hljs-comment">// ← PreparedStatement 添加的</span>
addBatch(<span class="hljs-string">"INSERT INTO t VALUES (2)"</span>);
</code></pre>
<p>如果驱动只把第1和第3条合并，而第2条单独处理，会导致</p>
<ul>
<li>执行顺序错乱（JDBC 要求按 addBatch 顺序执行）</li>
<li>事务语义破坏（中间失败时回滚行为不一致）</li>
<li>返回结果数组（update counts）顺序错位</li>
</ul>
<p>JDBC 规范要求 <code>executeBatch()</code> 返回的 <code>int[]</code> 必须与 <code>addBatch()</code> 的调用顺序一一对应。因此，要么全部优化，要么全部不优化，只要有一条 plain statement 就只能走保守路径</p>
</li>
<li>
<p>实现复杂度与收益不成正比：为了支持混合批处理的智能重写，驱动需要</p>
<ul>
<li>解析每条 SQL 字符串（开销大）</li>
<li>判断是否可合并（语法分析、AST 构建）</li>
<li>分组重写并保持顺序（逻辑复杂）</li>
</ul>
<p>而现实中：</p>
<ul>
<li>正确使用批量操作的开发者几乎不会混用 <code>Statement.addBatch(String)</code></li>
<li>真正需要高性能批量的场景（如数据导入）都会用 <code>PreparedStatement</code></li>
</ul>
<p>所以，直接禁用优化是最简单、最安全、最高效的设计</p>
</li>
</ol>
<p>这种设计看似一刀切，实则是在复杂性、安全性与性能之间做出的成熟工程取舍</p>
<h3 data-id="heading-5">Hibernate 批处理</h3>
<p>直接使用 testHibernateBatchUpdatePerformance 方法进行调试。实际上，最终底层仍会调用 MySQL 驱动中 <code>ClientPreparedStatement</code> 的 <code>addBatch()</code> 和 <code>executeBatchInternal()</code> 方法。因此，本节重点不在于 JDBC 驱动的执行细节，而在于说明 Hibernate 各相关配置参数（如 <code>order_inserts</code>、<code>jdbc.batch_size</code> 等）在批处理流程中实际生效的位置和作用机制</p>
<h4 data-id="heading-6">ActionQueue</h4>
<p><code>ActionQueue</code> 用于存放作为会话事务性写延迟（transactional write-behind）语义一部分而排队的 DML 操作，这些 DML 操作会在此队列中暂存，直到执行 flush 操作时才真正提交到数据库执行</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * Responsible for maintaining the queue of actions related to events.
 * &lt;p&gt;
 * The {<span class="hljs-doctag">@code</span> ActionQueue} holds the DML operations queued as part of a session's transactional-write-behind semantics.
 * The DML operations are queued here until a flush forces them to be executed against the database.
 *
 * <span class="hljs-doctag">@author</span> Steve Ebersole
 * <span class="hljs-doctag">@author</span> Gail Badner
 * <span class="hljs-doctag">@author</span> Anton Marsden
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ActionQueue</span> {
    <span class="hljs-comment">// Object insertions, updates, and deletions have list semantics because</span>
    <span class="hljs-comment">// they must happen in the right order to respect referential integrity</span>
    <span class="hljs-keyword">private</span> ExecutableList&lt;AbstractEntityInsertAction&gt; insertions;
    <span class="hljs-keyword">private</span> ExecutableList&lt;EntityDeleteAction&gt; deletions;
    <span class="hljs-keyword">private</span> ExecutableList&lt;EntityUpdateAction&gt; updates;
}
</code></pre>
<p>在调用 <code>EntityManager#persist()</code>（插入场景）或 <code>EntityManager#flush()</code>（触发脏检查和更新）等方法时，Hibernate 会通过事件监听机制将相应的数据库操作封装为动作（Action）并加入到 <code>ActionQueue</code> 中</p>
<ul>
<li>插入操作由 <code>DefaultPersistEventListener</code> 处理，生成 <code>EntityInsertAction</code> 并加入队列</li>
<li>更新操作由 <code>DefaultFlushEntityEventListener</code> 在 flush 阶段检测到脏数据后，生成 <code>EntityUpdateAction</code> 并加入队列</li>
<li>插入操作由 <code>DefaultDeleteEventListener</code> 处理，生成 <code>EntityDeleteAction</code> 并加入队列</li>
</ul>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ActionQueue</span> {

    <span class="hljs-keyword">private</span> ExecutableList&lt;AbstractEntityInsertAction&gt; insertions;
    <span class="hljs-keyword">private</span> ExecutableList&lt;EntityDeleteAction&gt; deletions;
    <span class="hljs-keyword">private</span> ExecutableList&lt;EntityUpdateAction&gt; updates;

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addAction</span><span class="hljs-params">(EntityInsertAction action)</span> {
        LOG.tracev( <span class="hljs-string">"Adding an EntityInsertAction for [{0}] object"</span>, action.getEntityName() );
        addInsertAction( action );
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addInsertAction</span><span class="hljs-params">(AbstractEntityInsertAction insert)</span> {

        <span class="hljs-comment">// ...</span>

        <span class="hljs-keyword">final</span> <span class="hljs-type">NonNullableTransientDependencies</span> <span class="hljs-variable">nonNullableTransientDependencies</span> <span class="hljs-operator">=</span> insert.findNonNullableTransientEntities();
        <span class="hljs-keyword">if</span> ( nonNullableTransientDependencies == <span class="hljs-literal">null</span> ) {
            LOG.tracev( <span class="hljs-string">"Adding insert with no non-nullable, transient entities: [{0}]"</span>, insert );
            addResolvedEntityInsertAction( insert );
        }

        <span class="hljs-comment">// ...</span>
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addResolvedEntityInsertAction</span><span class="hljs-params">(AbstractEntityInsertAction insert)</span> {
        <span class="hljs-keyword">if</span> ( insert.isEarlyInsert() ) {
            LOG.trace( <span class="hljs-string">"Executing insertions before resolved early-insert"</span> );
            executeInserts();
            LOG.debug( <span class="hljs-string">"Executing identity-insert immediately"</span> );
            execute( insert );
        }
        <span class="hljs-keyword">else</span> {
            LOG.trace( <span class="hljs-string">"Adding resolved non-early insert action."</span> );
            <span class="hljs-comment">// 初始化</span>
            OrderedActions.EntityInsertAction.ensureInitialized( <span class="hljs-built_in">this</span> );
            insertions.add( insert );
        }
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addAction</span><span class="hljs-params">(EntityDeleteAction action)</span> {
        <span class="hljs-comment">// 初始化</span>
        OrderedActions.EntityDeleteAction.ensureInitialized( <span class="hljs-built_in">this</span> );
        deletions.add( action );
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addAction</span><span class="hljs-params">(<span class="hljs-keyword">final</span> EntityUpdateAction action)</span> {
        <span class="hljs-comment">// 初始化</span>
        OrderedActions.EntityUpdateAction.ensureInitialized( <span class="hljs-built_in">this</span> );
        updates.add( action );
    }
}
</code></pre>
<p>在调用 <code>OrderedActions.EntityXXXAction.ensureInitialized()</code> 时，会初始化 <code>insertions</code>、<code>deletions</code> 和 <code>updates</code> 等操作队列，并根据配置（如 <code>order_inserts</code>、<code>order_updates</code>）设置相应的排序规则</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ActionQueue</span> {

    <span class="hljs-keyword">private</span> ExecutableList&lt;AbstractEntityInsertAction&gt; insertions;
    <span class="hljs-keyword">private</span> ExecutableList&lt;EntityDeleteAction&gt; deletions;
    <span class="hljs-keyword">private</span> ExecutableList&lt;EntityUpdateAction&gt; updates;

    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isOrderUpdatesEnabled</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> session.getFactory().getSessionFactoryOptions().isOrderUpdatesEnabled();
    }

    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isOrderInsertsEnabled</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> session.getFactory().getSessionFactoryOptions().isOrderInsertsEnabled();
    }

    <span class="hljs-comment">// The order of these operations is very important</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">OrderedActions</span> {
        EntityInsertAction {
            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> ExecutableList&lt;?&gt; getActions(ActionQueue instance) {
                <span class="hljs-keyword">return</span> instance.insertions;
            }
            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">ensureInitialized</span><span class="hljs-params">(<span class="hljs-keyword">final</span> ActionQueue instance)</span> {
                <span class="hljs-keyword">if</span> ( instance.insertions == <span class="hljs-literal">null</span> ) {
                    <span class="hljs-comment">// order_inserts 参数在此处使用</span>
                    instance.insertions = instance.isOrderInsertsEnabled()
                        ? <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExecutableList</span>&lt;&gt;( InsertActionSorter.INSTANCE )
                        : <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExecutableList</span>&lt;&gt;( <span class="hljs-literal">false</span> );
                }
            }
        },
        EntityUpdateAction {
            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> ExecutableList&lt;?&gt; getActions(ActionQueue instance) {
                <span class="hljs-keyword">return</span> instance.updates;
            }
            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">ensureInitialized</span><span class="hljs-params">(ActionQueue instance)</span> {
                <span class="hljs-keyword">if</span> ( instance.updates == <span class="hljs-literal">null</span> ) {
                    <span class="hljs-comment">// order_updates 参数在此处使用</span>
                    instance.updates = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExecutableList</span>&lt;&gt;( instance.isOrderUpdatesEnabled() );
                }
            }
        },
        EntityDeleteAction {
            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> ExecutableList&lt;?&gt; getActions(ActionQueue instance) {
                <span class="hljs-keyword">return</span> instance.deletions;
            }
            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">ensureInitialized</span><span class="hljs-params">(ActionQueue instance)</span> {
                <span class="hljs-keyword">if</span> ( instance.deletions == <span class="hljs-literal">null</span> ) {
                    instance.deletions = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExecutableList</span>&lt;&gt;( <span class="hljs-literal">false</span> );
                }
            }
        };
    }
}
</code></pre>
<p>在 <code>ActionQueue</code> 中，<code>insertions</code>、<code>deletions</code> 和 <code>updates</code> 三个队列中存储的均为 <code>EntityAction</code> 的子类。<code>EntityAction</code> 实现了 <code>Comparable</code> 接口，用于支持后续的排序操作，其排序依据是：先按实体名称排序，同名实体再按对象 ID 排序</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c83c2f7697464c78926d29e9d06cb5c6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZGVmaW5lOTUyNw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770025546&amp;x-signature=LygWeXWq9AZsOCAufffOiBNYsfI%3D" alt="image.png" loading="lazy"/></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * Base class for actions relating to insert/update/delete of an entity
 * instance.
 *
 * <span class="hljs-doctag">@author</span> Gavin King
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EntityAction</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ComparableExecutable</span>, AfterTransactionCompletionProcess {

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">compareTo</span><span class="hljs-params">(ComparableExecutable o)</span> {
        <span class="hljs-comment">// sort first by entity name</span>
        <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">roleComparison</span> <span class="hljs-operator">=</span> entityName.compareTo( o.getPrimarySortClassifier() );
        <span class="hljs-keyword">return</span> roleComparison != <span class="hljs-number">0</span>
            ? roleComparison
            <span class="hljs-comment">// then by id</span>
            : persister.getIdentifierType().compare( id, o.getSecondarySortIndex(), session.getSessionFactory() );
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getPrimarySortClassifier</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> entityName;
    }
}
</code></pre>
<p>在 <code>EntityManager#flush</code> 的执行流程中，<code>ActionQueue#sortActions()</code> 会被调用，对 <code>insertions</code> 和 <code>updates</code> 队列分别进行排序；值得注意的是，源码中并未对 <code>deletions</code> 队列执行排序操作</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ActionQueue</span> {

    <span class="hljs-keyword">private</span> ExecutableList&lt;AbstractEntityInsertAction&gt; insertions;
    <span class="hljs-keyword">private</span> ExecutableList&lt;EntityDeleteAction&gt; deletions;
    <span class="hljs-keyword">private</span> ExecutableList&lt;EntityUpdateAction&gt; updates;

    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isOrderUpdatesEnabled</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> session.getFactory().getSessionFactoryOptions().isOrderUpdatesEnabled();
    }

    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isOrderInsertsEnabled</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> session.getFactory().getSessionFactoryOptions().isOrderInsertsEnabled();
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sortActions</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">if</span> ( isOrderUpdatesEnabled() &amp;&amp; updates != <span class="hljs-literal">null</span> ) {
            <span class="hljs-comment">// sort the updates by pk</span>
            updates.sort();
        }
        <span class="hljs-keyword">if</span> ( isOrderInsertsEnabled() &amp;&amp; insertions != <span class="hljs-literal">null</span> ) {
            insertions.sort();
        }
    }
}
</code></pre>
<p>操作队列由 <code>ExecutableList</code> 实现，该类负责对其中的可执行操作进行排序</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * A list of {<span class="hljs-doctag">@link</span> Executable executeble actions}. Responsible for
 * {<span class="hljs-doctag">@linkplain</span> #sort() sorting} the executables, and calculating the
 * affected {<span class="hljs-doctag">@linkplain</span> #getQuerySpaces() query spaces}.
 *
 * <span class="hljs-doctag">@author</span> Steve Ebersole
 * <span class="hljs-doctag">@author</span> Anton Marsden
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ExecutableList</span>&lt;E <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ComparableExecutable</span>&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span>, Iterable&lt;E&gt;, Externalizable {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">INIT_QUEUE_LIST_SIZE</span> <span class="hljs-operator">=</span> <span class="hljs-number">5</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-meta">@Nullable</span> Sorter&lt;E&gt; sorter;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ExecutableList</span><span class="hljs-params">(<span class="hljs-type">boolean</span> requiresSorting)</span> {
        <span class="hljs-built_in">this</span>( INIT_QUEUE_LIST_SIZE, requiresSorting );
    }

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ExecutableList</span><span class="hljs-params">(<span class="hljs-type">int</span> initialCapacity, <span class="hljs-type">boolean</span> requiresSorting)</span> {
        <span class="hljs-built_in">this</span>.sorter = <span class="hljs-literal">null</span>;
        <span class="hljs-built_in">this</span>.executables = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;( initialCapacity );
        <span class="hljs-built_in">this</span>.querySpaces = <span class="hljs-literal">null</span>;
        <span class="hljs-built_in">this</span>.requiresSorting = requiresSorting;
        <span class="hljs-built_in">this</span>.sorted = requiresSorting;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ExecutableList</span><span class="hljs-params">(Sorter&lt;E&gt; sorter)</span> {
        <span class="hljs-built_in">this</span>( INIT_QUEUE_LIST_SIZE, sorter );
    }

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ExecutableList</span><span class="hljs-params">(<span class="hljs-type">int</span> initialCapacity, Sorter&lt;E&gt; sorter)</span> {
        <span class="hljs-built_in">this</span>.sorter = sorter;
        <span class="hljs-built_in">this</span>.executables = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;( initialCapacity );
        <span class="hljs-built_in">this</span>.querySpaces = <span class="hljs-literal">null</span>;
        <span class="hljs-comment">// require sorting by default, even if sorter is null to maintain original behavior</span>
        <span class="hljs-built_in">this</span>.requiresSorting = <span class="hljs-literal">true</span>;
        <span class="hljs-built_in">this</span>.sorted = <span class="hljs-literal">true</span>;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sort</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">if</span> ( sorted || !requiresSorting ) {
            <span class="hljs-comment">// nothing to do</span>
            <span class="hljs-keyword">return</span>;
        }
        <span class="hljs-comment">// sorter 不为 null 则使用 sorter 排序</span>
        <span class="hljs-keyword">if</span> ( sorter != <span class="hljs-literal">null</span> ) {
            sorter.sort( executables );
        }
        <span class="hljs-comment">// 当 sorter 为 null 时，将使用 Collections.sort(executables) 对操作列表进行排序，此时依赖 executables 中元素（EntityAction）自身实现的 Comparable 接口</span>
        <span class="hljs-keyword">else</span> {
            Collections.sort( executables );
        }
        sorted = <span class="hljs-literal">true</span>;
    }
}
</code></pre>
<p>从 OrderedActions 源码可知，只有 EntityInsertAction 在 order_inserts 为 true 时会传入 Sorter 对象</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ActionQueue</span> {

    <span class="hljs-keyword">private</span> ExecutableList&lt;AbstractEntityInsertAction&gt; insertions;

    <span class="hljs-comment">// The order of these operations is very important</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">OrderedActions</span> {
        EntityInsertAction {
            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> ExecutableList&lt;?&gt; getActions(ActionQueue instance) {
                <span class="hljs-keyword">return</span> instance.insertions;
            }
            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">ensureInitialized</span><span class="hljs-params">(<span class="hljs-keyword">final</span> ActionQueue instance)</span> {
                <span class="hljs-keyword">if</span> ( instance.insertions == <span class="hljs-literal">null</span> ) {
                    <span class="hljs-comment">//Special case of initialization</span>
                    instance.insertions = instance.isOrderInsertsEnabled()
                        ? <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExecutableList</span>&lt;&gt;( InsertActionSorter.INSTANCE )
                        : <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExecutableList</span>&lt;&gt;( <span class="hljs-literal">false</span> );
                }
            }
        }
    }
}
</code></pre>
<p>翻译了 InsertActionSorter 的源码注释，内容如下</p>
<ul>
<li>对插入队列进行排序，使得针对同一实体的插入操作被分组在一起（同时不违反数据库约束）原始的插入顺序由级联顺序决定，而级联顺序本身又基于外键的方向性。因此，尽管此处会对顺序进行调整，但我们必须确保绝不破坏这种外键顺序，以免引发约束违反</li>
<li>该算法首先为每个插入操作找出其传递性的入向依赖（即哪些其他实体必须先被插入），然后将所有插入操作按实体名称分组。最后，只要某个分组的所有依赖都已满足，就依次调度这些分组</li>
<li>该实现仅能为那些可以被完美串行调度的插入分组生成最优插入顺序。串行调度指的是存在一种顺序，能够完全满足外键约束依赖关系。对于无法被调度的插入分组（例如存在循环依赖）则会回退到使用原始的插入顺序</li>
</ul>
<p>简单来说，InsertActionSorter#sort 方法实现了基于实体依赖关系和实体类型的拓扑排序，确保在批量插入时</p>
<ol>
<li>先插入被依赖的实体（如父表），再插入依赖它的实体（如子表）</li>
<li>相同类型的实体连续排列，以支持 JDBC 批处理优化</li>
</ol>
<p>完整的代码就不贴出来了，详情可参见源码，以下内容为 AI 总结</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ActionQueue</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">InsertActionSorter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ExecutableList</span>.Sorter&lt;AbstractEntityInsertAction&gt; {
        <span class="hljs-comment">// 1. 为每个 InsertAction 构建元数据（InsertInfo），记录其位置和实体实例</span>
        <span class="hljs-keyword">final</span> InsertInfo[] insertInfos = <span class="hljs-keyword">new</span> <span class="hljs-title class_">InsertInfo</span>[insertInfoCount];
        <span class="hljs-comment">// A map of all insert infos keyed by the entity instance</span>
        <span class="hljs-comment">// This is needed to discover insert infos for direct dependencies</span>
        <span class="hljs-keyword">final</span> IdentityHashMap&lt;Object, InsertInfo&gt; insertInfosByEntity = <span class="hljs-keyword">new</span> <span class="hljs-title class_">IdentityHashMap</span>&lt;&gt;(...);
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; insertInfoCount; i++) {
            <span class="hljs-keyword">final</span> <span class="hljs-type">AbstractEntityInsertAction</span> <span class="hljs-variable">insertAction</span> <span class="hljs-operator">=</span> insertions.get(i);
            <span class="hljs-comment">// ← 封装动作 + 原始索引</span>
            <span class="hljs-keyword">final</span> <span class="hljs-type">InsertInfo</span> <span class="hljs-variable">insertInfo</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InsertInfo</span>(insertAction, i);
            insertInfosByEntity.put(insertAction.getInstance(), insertInfo);
            insertInfos[i] = insertInfo;
        }
        <span class="hljs-comment">// 2. 分析每个插入动作直接依赖的其他实体（例如 @JoinColumn 引用的未保存实体）</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; insertInfoCount; i++) {
            <span class="hljs-comment">// ← 建立直接依赖关系</span>
            insertInfos[i].buildDirectDependencies(insertInfosByEntity);
        }
        <span class="hljs-comment">// 3. 递归传播子依赖（如 A → B → C，则 A 也依赖 C）</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; insertInfoCount; i++) {
            <span class="hljs-comment">// ← 构建完整依赖链</span>
            insertInfos[i].propagateChildDependencies();
        }
        <span class="hljs-comment">// 4. 构建传递性依赖，并按 entityName 分组（关键！用于后续连续排列）</span>
        <span class="hljs-keyword">final</span> Map&lt;String, EntityInsertGroup&gt; insertInfosByEntityName = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedHashMap</span>&lt;&gt;();
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; insertInfoCount; i++) {
            <span class="hljs-comment">// ← 完成依赖闭包</span>
            insertInfo.buildTransitiveDependencies(visited);
            <span class="hljs-type">String</span> <span class="hljs-variable">entityName</span> <span class="hljs-operator">=</span> insertInfo.insertAction.getPersister().getEntityName();
            <span class="hljs-comment">// ← 按 entityName 分组，保证同类型连续</span>
            <span class="hljs-type">EntityInsertGroup</span> <span class="hljs-variable">group</span> <span class="hljs-operator">=</span> insertInfosByEntityName.computeIfAbsent(entityName, EntityInsertGroup::<span class="hljs-keyword">new</span>);
            group.add(insertInfo);
        }
        <span class="hljs-comment">// 5. 拓扑排序：循环调度所有依赖已满足的实体组</span>
        <span class="hljs-keyword">final</span> Set&lt;String&gt; scheduledEntityNames = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;&gt;();
        <span class="hljs-type">int</span> <span class="hljs-variable">schedulePosition</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
        <span class="hljs-keyword">do</span> {
            <span class="hljs-comment">// 遍历所有实体组，若其依赖的实体类型都已调度，则将其加入结果</span>
            <span class="hljs-keyword">for</span> (EntityInsertGroup group : ...) {
                <span class="hljs-keyword">if</span> (scheduledEntityNames.containsAll(group.dependentEntityNames)) {
                    <span class="hljs-comment">// ← 按组写入结果</span>
                    schedulePosition = schedule(insertInfos, group.insertInfos, schedulePosition);
                    scheduledEntityNames.add(group.entityName);
                }
            }
        } <span class="hljs-keyword">while</span> (有新实体被调度);
        <span class="hljs-comment">// 6. 若仍有未调度的实体，说明存在循环依赖（警告）</span>
        <span class="hljs-keyword">if</span> (!insertInfosByEntityName.isEmpty()) {
            <span class="hljs-comment">// ← 检测循环依赖</span>
            LOG.warn(<span class="hljs-string">"... circular entity relationship ..."</span>);
        }
        <span class="hljs-comment">// 7. 用排序后的新顺序覆盖原 insertions 列表</span>
        insertions.clear();
        <span class="hljs-keyword">for</span> (InsertInfo info : insertInfos) {
            <span class="hljs-comment">// ← 最终排序结果生效</span>
            insertions.add(info.insertAction);
        }
    }
}
</code></pre>
<p>以上便是 <code>order_inserts</code> 和 <code>order_updates</code> 的生效机制。简而言之，Hibernate 会将各类数据库操作（如插入、更新）收集到 <code>ActionQueue</code> 中。当 <code>order_inserts</code> 或 <code>order_updates</code> 配置为 <code>true</code> 时，会在 flush 阶段对相应的操作队列进行排序</p>
<h4 data-id="heading-7">执行操作</h4>
<p>此时，各类操作已收集到 <code>ActionQueue</code> 中并完成排序。接下来的执行阶段仍发生在 flush 阶段，由 <code>DefaultFlushEventListener#onFlush</code> 方法触发，依次取出队列中的操作并提交给数据库执行</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * Defines the default flush event listeners used by hibernate for 
 * flushing session state in response to generated flush events.
 *
 * <span class="hljs-doctag">@author</span> Steve Ebersole
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DefaultFlushEventListener</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractFlushingEventListener</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">FlushEventListener</span> {

    <span class="hljs-comment">/** Handle the given flush event.
	 *
	 * <span class="hljs-doctag">@param</span> event The flush event to be handled.
	 */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onFlush</span><span class="hljs-params">(FlushEvent event)</span> <span class="hljs-keyword">throws</span> HibernateException {
        <span class="hljs-keyword">final</span> <span class="hljs-type">EventSource</span> <span class="hljs-variable">source</span> <span class="hljs-operator">=</span> event.getSession();
        <span class="hljs-keyword">final</span> <span class="hljs-type">PersistenceContext</span> <span class="hljs-variable">persistenceContext</span> <span class="hljs-operator">=</span> source.getPersistenceContextInternal();
        <span class="hljs-keyword">final</span> <span class="hljs-type">EventManager</span> <span class="hljs-variable">eventManager</span> <span class="hljs-operator">=</span> source.getEventManager();
        <span class="hljs-keyword">if</span> ( persistenceContext.getNumberOfManagedEntities() &gt; <span class="hljs-number">0</span>
            || persistenceContext.getCollectionEntriesSize() &gt; <span class="hljs-number">0</span> ) {
            <span class="hljs-keyword">final</span> <span class="hljs-type">HibernateMonitoringEvent</span> <span class="hljs-variable">flushEvent</span> <span class="hljs-operator">=</span> eventManager.beginFlushEvent();
            <span class="hljs-keyword">try</span> {
                source.getEventListenerManager().flushStart();
                <span class="hljs-comment">// 调用 ActionQueue#sortActions 进行排序</span>
                flushEverythingToExecutions( event );
                <span class="hljs-comment">// 调用 AbstractFlushingEventListener#performExecutions 方法</span>
                performExecutions( source );
                postFlush( source );
            }
            <span class="hljs-keyword">finally</span> {
                eventManager.completeFlushEvent( flushEvent, event );
                source.getEventListenerManager().flushEnd(
                    event.getNumberOfEntitiesProcessed(),
                    event.getNumberOfCollectionsProcessed()
                );
            }
            postPostFlush( source );
            <span class="hljs-comment">// ...</span>
        }
        <span class="hljs-comment">// ...</span>
    }
}
</code></pre>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AbstractFlushingEventListener</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">JpaBootstrapSensitive</span> {

    <span class="hljs-comment">/**
	 * Execute all SQL (and second-level cache updates) in a special order so that foreign-key constraints cannot
	 * be violated: &lt;ol&gt;
	 * &lt;li&gt; Inserts, in the order they were performed
	 * &lt;li&gt; Updates
	 * &lt;li&gt; Deletion of collection elements
	 * &lt;li&gt; Insertion of collection elements
	 * &lt;li&gt; Deletes, in the order they were performed
	 * &lt;/ol&gt;
	 *
	 * <span class="hljs-doctag">@param</span> session The session being flushed
	 */</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">performExecutions</span><span class="hljs-params">(EventSource session)</span> {
        LOG.trace( <span class="hljs-string">"Executing flush"</span> );
        <span class="hljs-keyword">final</span> <span class="hljs-type">PersistenceContext</span> <span class="hljs-variable">persistenceContext</span> <span class="hljs-operator">=</span> session.getPersistenceContextInternal();
        <span class="hljs-keyword">final</span> <span class="hljs-type">JdbcCoordinator</span> <span class="hljs-variable">jdbcCoordinator</span> <span class="hljs-operator">=</span> session.getJdbcCoordinator();
        <span class="hljs-keyword">try</span> {
            jdbcCoordinator.flushBeginning();
            persistenceContext.setFlushing( <span class="hljs-literal">true</span> );
            <span class="hljs-comment">// we need to lock the collection caches before executing entity inserts/updates</span>
            <span class="hljs-comment">// in order to account for bidirectional associations</span>
            <span class="hljs-keyword">final</span> <span class="hljs-type">ActionQueue</span> <span class="hljs-variable">actionQueue</span> <span class="hljs-operator">=</span> session.getActionQueue();
            actionQueue.prepareActions();
            actionQueue.executeActions();
        }
        <span class="hljs-keyword">finally</span> {
            persistenceContext.setFlushing( <span class="hljs-literal">false</span> );
            jdbcCoordinator.flushEnding();
        }
    }
}
</code></pre>
<p>流程再次回到 <code>ActionQueue</code>，其 <code>executeActions</code> 方法负责依次取出已排序的操作队列中的各项操作，并逐个执行</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ActionQueue</span> {

    <span class="hljs-comment">// 已排序的各项操作</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> OrderedActions[] ORDERED_OPERATIONS = OrderedActions.values();

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">executeActions</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> HibernateException {
        <span class="hljs-comment">// ...</span>
        <span class="hljs-keyword">for</span> ( OrderedActions action : ORDERED_OPERATIONS ) {
            executeActions( action.getActions( <span class="hljs-built_in">this</span> ) );
        }
    }

    <span class="hljs-keyword">private</span> &lt;E <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ComparableExecutable</span>&gt; <span class="hljs-keyword">void</span> <span class="hljs-title function_">executeActions</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> ExecutableList&lt;E&gt; list)</span>
        <span class="hljs-keyword">throws</span> HibernateException {
        <span class="hljs-keyword">if</span> ( list == <span class="hljs-literal">null</span> || list.isEmpty() ) {
            <span class="hljs-keyword">return</span>;
        }
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 取出来的是一个个 XxxAction 对象</span>
            <span class="hljs-keyword">for</span> ( ComparableExecutable e : list ) {
                <span class="hljs-keyword">try</span> {
                    <span class="hljs-comment">// 最终会执行 ClientPreparedStatement#addBatch() 方法</span>
                    e.execute();
                }
                <span class="hljs-keyword">finally</span> {
                    <span class="hljs-comment">// ...</span>
                }
            }
        }
        <span class="hljs-keyword">finally</span> {
            <span class="hljs-comment">// ...</span>
        }
        list.clear();
        <span class="hljs-comment">// 最终会执行 ClientPreparedStatement#executeBatchInternal() 方法</span>
        session.getJdbcCoordinator().executeBatch();
    }
}
</code></pre>
<h5 data-id="heading-8">addBatch 流程</h5>
<p><code>ExecutableList&lt;E&gt;</code> 中存储的是各类 <code>XxxAction</code> 对象（如 <code>EntityInsertAction</code>、<code>EntityUpdateAction</code>、<code>EntityDeleteAction</code>），它们的 <code>execute()</code> 方法将执行委托给对应的 XxxCoordinator（协调器）</p>
<p>EntityInsertAction</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * The action for performing an entity insertion, for entities not defined to use IDENTITY generation.
 *
 * <span class="hljs-doctag">@see</span> EntityIdentityInsertAction
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EntityInsertAction</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractEntityInsertAction</span> {

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">execute</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> HibernateException {
        nullifyTransientReferencesIfNotAlready();
        <span class="hljs-comment">// Don't need to lock the cache here, since if someone</span>
        <span class="hljs-comment">// else inserted the same pk first, the insert would fail</span>
        <span class="hljs-keyword">final</span> <span class="hljs-type">SharedSessionContractImplementor</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> getSession();
        <span class="hljs-keyword">final</span> <span class="hljs-type">Object</span> <span class="hljs-variable">id</span> <span class="hljs-operator">=</span> getId();
        <span class="hljs-comment">// veto =&gt; 是否有一个或多个 PreInsertEventListener 监听器否决（veto）了当前实体的插入操作</span>
        <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">veto</span> <span class="hljs-operator">=</span> preInsert();
        <span class="hljs-keyword">if</span> ( !veto ) {
            <span class="hljs-keyword">final</span> <span class="hljs-type">EntityPersister</span> <span class="hljs-variable">persister</span> <span class="hljs-operator">=</span> getPersister();
            <span class="hljs-keyword">final</span> <span class="hljs-type">Object</span> <span class="hljs-variable">instance</span> <span class="hljs-operator">=</span> getInstance();
            <span class="hljs-comment">// 委托给 InsertCoordinator 执行</span>
            <span class="hljs-keyword">final</span> <span class="hljs-type">GeneratedValues</span> <span class="hljs-variable">generatedValues</span> <span class="hljs-operator">=</span> persister.getInsertCoordinator().insert(
                instance,
                id,
                getState(),
                session
            );
            <span class="hljs-comment">// ...</span>
        }
        <span class="hljs-comment">// ...</span>
    }

    <span class="hljs-keyword">protected</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">preInsert</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 获取所有的 PreInsertEventListener 监听器</span>
        <span class="hljs-keyword">final</span> EventListenerGroup&lt;PreInsertEventListener&gt; listenerGroup = getFastSessionServices().eventListenerGroup_PRE_INSERT;
        <span class="hljs-keyword">if</span> ( listenerGroup.isEmpty() ) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
        <span class="hljs-keyword">else</span> {
            <span class="hljs-type">boolean</span> <span class="hljs-variable">veto</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;
            <span class="hljs-comment">// 发布 PreInsertEvent 事件并执行所有 PreInsertEventListener 的 onPreInsert 方法</span>
            <span class="hljs-keyword">final</span> <span class="hljs-type">PreInsertEvent</span> <span class="hljs-variable">event</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PreInsertEvent</span>( getInstance(), getId(), getState(), getPersister(), eventSource() );
            <span class="hljs-keyword">for</span> ( PreInsertEventListener listener : listenerGroup.listeners() ) {
                <span class="hljs-comment">// 汇总执行结果</span>
                veto |= listener.onPreInsert( event );
            }
            <span class="hljs-keyword">return</span> veto;
        }
    }
}
</code></pre>
<p>EntityUpdateAction</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EntityUpdateAction</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">EntityAction</span> {

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">execute</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> HibernateException {
        <span class="hljs-keyword">if</span> ( !preUpdate() ) {
            <span class="hljs-keyword">final</span> <span class="hljs-type">EntityPersister</span> <span class="hljs-variable">persister</span> <span class="hljs-operator">=</span> getPersister();
            <span class="hljs-keyword">final</span> <span class="hljs-type">SharedSessionContractImplementor</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> getSession();
            <span class="hljs-keyword">final</span> <span class="hljs-type">Object</span> <span class="hljs-variable">id</span> <span class="hljs-operator">=</span> getId();
            <span class="hljs-keyword">final</span> <span class="hljs-type">Object</span> <span class="hljs-variable">instance</span> <span class="hljs-operator">=</span> getInstance();
            <span class="hljs-keyword">final</span> <span class="hljs-type">Object</span> <span class="hljs-variable">previousVersion</span> <span class="hljs-operator">=</span> getPreviousVersion();
            <span class="hljs-keyword">final</span> <span class="hljs-type">Object</span> <span class="hljs-variable">ck</span> <span class="hljs-operator">=</span> lockCacheItem( previousVersion );
            <span class="hljs-comment">// 委托给 UpdateCoordinator 执行</span>
            <span class="hljs-keyword">final</span> <span class="hljs-type">GeneratedValues</span> <span class="hljs-variable">generatedValues</span> <span class="hljs-operator">=</span> persister.getUpdateCoordinator().update(
                instance,
                id,
                rowId,
                state,
                previousVersion,
                previousState,
                dirtyFields,
                hasDirtyCollection,
                session
            );
            <span class="hljs-comment">// ...</span>
        }
    }

    <span class="hljs-keyword">protected</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">preUpdate</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">final</span> EventListenerGroup&lt;PreUpdateEventListener&gt; listenerGroup = getFastSessionServices().eventListenerGroup_PRE_UPDATE;
        <span class="hljs-keyword">if</span> ( listenerGroup.isEmpty() ) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
        <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">final</span> <span class="hljs-type">PreUpdateEvent</span> <span class="hljs-variable">event</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PreUpdateEvent</span>(
                getInstance(),
                getId(),
                state,
                previousState,
                getPersister(),
                eventSource()
            );
            <span class="hljs-type">boolean</span> <span class="hljs-variable">veto</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;
            <span class="hljs-keyword">for</span> ( PreUpdateEventListener listener : listenerGroup.listeners() ) {
                veto |= listener.onPreUpdate( event );
            }
            <span class="hljs-keyword">return</span> veto;
        }
    }
}
</code></pre>
<p>EntityDeleteAction</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EntityDeleteAction</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">EntityAction</span> {

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">execute</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> HibernateException {
        <span class="hljs-keyword">final</span> <span class="hljs-type">Object</span> <span class="hljs-variable">id</span> <span class="hljs-operator">=</span> getId();
        <span class="hljs-keyword">final</span> <span class="hljs-type">Object</span> <span class="hljs-variable">version</span> <span class="hljs-operator">=</span> getCurrentVersion();
        <span class="hljs-keyword">final</span> <span class="hljs-type">EntityPersister</span> <span class="hljs-variable">persister</span> <span class="hljs-operator">=</span> getPersister();
        <span class="hljs-keyword">final</span> <span class="hljs-type">SharedSessionContractImplementor</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> getSession();
        <span class="hljs-keyword">final</span> <span class="hljs-type">Object</span> <span class="hljs-variable">instance</span> <span class="hljs-operator">=</span> getInstance();
        <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">veto</span> <span class="hljs-operator">=</span> isInstanceLoaded() &amp;&amp; preDelete();
        <span class="hljs-keyword">final</span> <span class="hljs-type">Object</span> <span class="hljs-variable">ck</span> <span class="hljs-operator">=</span> lockCacheItem();
        <span class="hljs-keyword">if</span> ( !isCascadeDeleteEnabled &amp;&amp; !veto ) {
            <span class="hljs-comment">// 委托给 DeleteCoordinator 执行</span>
            persister.getDeleteCoordinator().delete( instance, id, version, session );
        }
        <span class="hljs-comment">// ...</span>
    }

    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isInstanceLoaded</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// A null instance signals that we're deleting an unloaded proxy.</span>
        <span class="hljs-keyword">return</span> getInstance() != <span class="hljs-literal">null</span>;
    }

    <span class="hljs-keyword">protected</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">preDelete</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">final</span> EventListenerGroup&lt;PreDeleteEventListener&gt; listenerGroup = getFastSessionServices().eventListenerGroup_PRE_DELETE;
        <span class="hljs-keyword">if</span> ( listenerGroup.isEmpty() ) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
        <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">final</span> <span class="hljs-type">PreDeleteEvent</span> <span class="hljs-variable">event</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PreDeleteEvent</span>( getInstance(), getId(), state, getPersister(), eventSource() );
            <span class="hljs-type">boolean</span> <span class="hljs-variable">veto</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;
            <span class="hljs-keyword">for</span> ( PreDeleteEventListener listener : listenerGroup.listeners() ) {
                veto |= listener.onPreDelete( event );
            }
            <span class="hljs-keyword">return</span> veto;
        }
    }
}
</code></pre>
<p><code>EntityPersister</code> 接口中定义的 <code>getInsertCoordinator()</code>、<code>getUpdateCoordinator()</code> 和 <code>getDeleteCoordinator()</code> 方法，目前仅有 <code>AbstractEntityPersister</code> 这一个实现类提供具体实现</p>
<p>InsertCoordinator、UpdateCoordinator、DeleteCoordinator 同样是接口，在 AbstractEntityPersister 中构造出的对应实现类为 InsertCoordinatorStandard、UpdateCoordinatorStandard、DeleteCoordinatorStandard</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * Basic functionality for persisting an entity via JDBC, using either generated or custom SQL.
 *
 * <span class="hljs-doctag">@author</span> Gavin King
 */</span>
<span class="hljs-meta">@Internal</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AbstractEntityPersister</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">InFlightEntityMappingType</span>, EntityMutationTarget, LazyPropertyInitializer, PostInsertIdentityPersister, FetchProfileAffectee, DeprecatedEntityStuff {

    <span class="hljs-keyword">private</span> InsertCoordinator insertCoordinator;
    <span class="hljs-keyword">private</span> UpdateCoordinator updateCoordinator;
    <span class="hljs-keyword">private</span> DeleteCoordinator deleteCoordinator;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">postInstantiate</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> MappingException {
        doLateInit();
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doLateInit</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// ...</span>
        insertCoordinator = buildInsertCoordinator();
        updateCoordinator = buildUpdateCoordinator();
        deleteCoordinator = buildDeleteCoordinator();
        <span class="hljs-comment">// ...</span>
    }

    <span class="hljs-keyword">protected</span> InsertCoordinator <span class="hljs-title function_">buildInsertCoordinator</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InsertCoordinatorStandard</span>( <span class="hljs-built_in">this</span>, factory );
    }

    <span class="hljs-keyword">protected</span> UpdateCoordinator <span class="hljs-title function_">buildUpdateCoordinator</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// we only have updates to issue for entities with one or more singular attributes</span>
        <span class="hljs-keyword">for</span> ( <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; attributeMappings.size(); i++ ) {
            <span class="hljs-keyword">final</span> <span class="hljs-type">AttributeMapping</span> <span class="hljs-variable">attributeMapping</span> <span class="hljs-operator">=</span> attributeMappings.get( i );
            <span class="hljs-keyword">if</span> ( attributeMapping <span class="hljs-keyword">instanceof</span> SingularAttributeMapping ) {
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UpdateCoordinatorStandard</span>( <span class="hljs-built_in">this</span>, factory );
            }
        }
        <span class="hljs-comment">// otherwise, nothing to update</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UpdateCoordinatorNoOp</span>( <span class="hljs-built_in">this</span> );
    }

    <span class="hljs-keyword">protected</span> DeleteCoordinator <span class="hljs-title function_">buildDeleteCoordinator</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">if</span> ( softDeleteMapping == <span class="hljs-literal">null</span> ) {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DeleteCoordinatorStandard</span>( <span class="hljs-built_in">this</span>, factory );
        }
        <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DeleteCoordinatorSoft</span>( <span class="hljs-built_in">this</span>, factory );
        }
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> InsertCoordinator <span class="hljs-title function_">getInsertCoordinator</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> insertCoordinator;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> UpdateCoordinator <span class="hljs-title function_">getUpdateCoordinator</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> updateCoordinator;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> DeleteCoordinator <span class="hljs-title function_">getDeleteCoordinator</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> deleteCoordinator;
    }
}
</code></pre>
<p>后续流程会根据操作类型（Insert、Update 或 Delete）分别调用 <code>InsertCoordinatorStandard#insert</code>、<code>UpdateCoordinatorStandard#update</code> 或 <code>DeleteCoordinatorStandard#delete</code> 方法。经过几层方法调用后，它们最终会汇聚到同一套核心逻辑：创建一个 <code>MutationExecutor</code> 实例，并将实际的数据库执行工作委托给它完成</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Internal</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AbstractMutationCoordinator</span> {

    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> MutationExecutorService mutationExecutorService;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">AbstractMutationCoordinator</span><span class="hljs-params">(AbstractEntityPersister entityPersister, SessionFactoryImplementor factory)</span> {
        <span class="hljs-comment">// StandardMutationExecutorService</span>
        <span class="hljs-built_in">this</span>.mutationExecutorService = factory.getServiceRegistry().getService( MutationExecutorService.class );
    }
}
</code></pre>
<p>InsertCoordinatorStandard</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Internal</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">InsertCoordinatorStandard</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractMutationCoordinator</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">InsertCoordinator</span> {

    <span class="hljs-keyword">protected</span> GeneratedValues <span class="hljs-title function_">doStaticInserts</span><span class="hljs-params">(Object id, Object[] values, Object object, SharedSessionContractImplementor session)</span> {
        <span class="hljs-keyword">final</span> <span class="hljs-type">MutationExecutor</span> <span class="hljs-variable">mutationExecutor</span> <span class="hljs-operator">=</span> executor( session, staticInsertGroup, <span class="hljs-literal">false</span> );
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">return</span> mutationExecutor.execute(...);
        }
        <span class="hljs-keyword">finally</span> {
            mutationExecutor.release();
        }
    }

    <span class="hljs-keyword">private</span> MutationExecutor <span class="hljs-title function_">executor</span><span class="hljs-params">(SharedSessionContractImplementor session, MutationOperationGroup group, <span class="hljs-type">boolean</span> dynamicUpdate)</span> {
        <span class="hljs-keyword">return</span> mutationExecutorService
            .createExecutor( resolveBatchKeyAccess( dynamicUpdate, session ), group, session );
    }
}
</code></pre>
<p>UpdateCoordinatorStandard</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UpdateCoordinatorStandard</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractMutationCoordinator</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">UpdateCoordinator</span> {

    <span class="hljs-keyword">protected</span> GeneratedValues <span class="hljs-title function_">doStaticUpdate</span><span class="hljs-params">(
        Object entity,
        Object id,
        Object rowId,
        Object[] values,
        Object[] oldValues,
        UpdateValuesAnalysisImpl valuesAnalysis,
        SharedSessionContractImplementor session
    )</span> {
        <span class="hljs-keyword">final</span> <span class="hljs-type">MutationExecutor</span> <span class="hljs-variable">mutationExecutor</span> <span class="hljs-operator">=</span> executor( session, staticUpdateGroup, <span class="hljs-literal">false</span> );
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">return</span> mutationExecutor.execute(...);
        }
        <span class="hljs-keyword">finally</span> {
            mutationExecutor.release();
        }
    }

    <span class="hljs-keyword">private</span> MutationExecutor <span class="hljs-title function_">executor</span><span class="hljs-params">(SharedSessionContractImplementor session, MutationOperationGroup group, <span class="hljs-type">boolean</span> dynamicUpdate)</span> {
        <span class="hljs-keyword">return</span> mutationExecutorService
            .createExecutor( resolveBatchKeyAccess( dynamicUpdate, session ), group, session );
    }
}
</code></pre>
<p>DeleteCoordinatorStandard</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DeleteCoordinatorStandard</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractDeleteCoordinator</span> {}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AbstractDeleteCoordinator</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractMutationCoordinator</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">DeleteCoordinator</span> {

    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doStaticDelete</span><span class="hljs-params">(
        Object entity,
        Object id,
        Object rowId,
        Object[] loadedState,
        Object version,
        SharedSessionContractImplementor session
    )</span> {
        <span class="hljs-keyword">final</span> <span class="hljs-type">MutationExecutor</span> <span class="hljs-variable">mutationExecutor</span> <span class="hljs-operator">=</span> executor( session, operationGroupToUse );
        <span class="hljs-keyword">try</span> {
            mutationExecutor.execute(...);
        }
        <span class="hljs-keyword">finally</span> {
            mutationExecutor.release();
        }
    }

    <span class="hljs-keyword">private</span> MutationExecutor <span class="hljs-title function_">executor</span><span class="hljs-params">(SharedSessionContractImplementor session, MutationOperationGroup group)</span> {
        <span class="hljs-keyword">return</span> mutationExecutorService.createExecutor( resolveBatchKeyAccess( <span class="hljs-literal">false</span>, session ), group, session );
    }
}
</code></pre>
<p><code>MutationExecutor</code> 是 Hibernate 中执行实体变更（插入、更新、删除）的核心接口，负责统一协调与数据库交互的具体细节，它的主要职责包括</p>
<ul>
<li>决定是否使用 JDBC 批处理（batching）</li>
<li>控制参数绑定日志的逻辑分组方式</li>
<li>......</li>
</ul>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * Main contract for performing the mutation.  Accounts for various
 * moving parts such as:&lt;ul&gt;
 *     &lt;li&gt;Should the statements be batched or not?&lt;/li&gt;
 *     &lt;li&gt;Should we "logically" group logging of the parameter bindings?&lt;/li&gt;
 *     &lt;li&gt;...&lt;/li&gt;
 * &lt;/ul&gt;
 *
 * <span class="hljs-doctag">@author</span> Steve Ebersole
 */</span>
<span class="hljs-meta">@Incubating</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">MutationExecutor</span> {

    GeneratedValues <span class="hljs-title function_">execute</span><span class="hljs-params">(
        Object modelReference,
        ValuesAnalysis valuesAnalysis,
        TableInclusionChecker inclusionChecker,
        OperationResultChecker resultChecker,
        SharedSessionContractImplementor session)</span>;
}
</code></pre>
<p>MutationExecutor 的 execute 方法目前仅有 <code>AbstractMutationExecutor</code> 这一个实现类提供具体实现，它的 execute 方法实现采用了标准的模板方法设计模式</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AbstractMutationExecutor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">MutationExecutor</span> {

    <span class="hljs-comment">/**
	 * Templated implementation of execution as &lt;ol&gt;
	 *     &lt;li&gt;{<span class="hljs-doctag">@link</span> #performNonBatchedOperations}&lt;/li&gt;
	 *     &lt;li&gt;{<span class="hljs-doctag">@link</span> #performSelfExecutingOperations}&lt;/li&gt;
	 *     &lt;li&gt;{<span class="hljs-doctag">@link</span> #performBatchedOperations}&lt;/li&gt;
	 * &lt;/ol&gt;
	 */</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> GeneratedValues <span class="hljs-title function_">execute</span><span class="hljs-params">(
        Object modelReference,
        ValuesAnalysis valuesAnalysis,
        TableInclusionChecker inclusionChecker,
        OperationResultChecker resultChecker,
        SharedSessionContractImplementor session
    )</span> {
        <span class="hljs-keyword">final</span> <span class="hljs-type">GeneratedValues</span> <span class="hljs-variable">generatedValues</span> <span class="hljs-operator">=</span> performNonBatchedOperations(
            modelReference,
            valuesAnalysis,
            inclusionChecker,
            resultChecker,
            session
        );
        performSelfExecutingOperations( valuesAnalysis, inclusionChecker, session );
        performBatchedOperations( valuesAnalysis, inclusionChecker );
        <span class="hljs-keyword">return</span> generatedValues;
    }

    <span class="hljs-keyword">protected</span> GeneratedValues <span class="hljs-title function_">performNonBatchedOperations</span><span class="hljs-params">(
        Object modelReference,
        ValuesAnalysis valuesAnalysis,
        TableInclusionChecker inclusionChecker,
        OperationResultChecker resultChecker,
        SharedSessionContractImplementor session)</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    }

    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">performSelfExecutingOperations</span><span class="hljs-params">(
        ValuesAnalysis valuesAnalysis,
        TableInclusionChecker inclusionChecker,
        SharedSessionContractImplementor session)</span> {
    }

    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">performBatchedOperations</span><span class="hljs-params">(
        ValuesAnalysis valuesAnalysis,
        TableInclusionChecker inclusionChecker)</span> {
    }
}
</code></pre>
<p>MutationExecutor 的继承树如下</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b2b6f4ed0d1b40e0b784c24ffb32ae5f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZGVmaW5lOTUyNw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770025546&amp;x-signature=Th6CD7DOcdgjnRLzE%2B3jOqcW1p8%3D" alt="image.png" loading="lazy"/></p>
<p>AbstractMutationExecutor 提供了 performNonBatchedOperations、performSelfExecutingOperations、performBatchedOperations 三个模板方法供子类去实现，从方法命名可推断，只有实现了 performBatchedOperations 方法的子类才真正支持批量操作</p>
<p>目前只有 <code>MutationExecutorSingleBatched</code> 和 <code>MutationExecutorStandard</code> 两个实现类重写了 <code>performBatchedOperations</code> 方法以支持批量操作。它们的实现中均调用了 <code>Batch#addToBatch</code> 方法，该方法经过若干层调用后，最终会触发 JDBC 驱动层的 <code>ClientPreparedStatement#addBatch()</code>，从而将 SQL 参数加入底层批处理队列</p>
<p>MutationExecutorSingleBatched</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MutationExecutorSingleBatched</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractSingleMutationExecutor</span> {

    <span class="hljs-keyword">private</span> Batch batch;

    <span class="hljs-keyword">private</span> Batch <span class="hljs-title function_">resolveBatch</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">if</span> ( batch == <span class="hljs-literal">null</span> ) {
            batch = session.getJdbcCoordinator().getBatch(
                batchKey,
                batchSize,
                () -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">PreparedStatementGroupSingleTable</span>( getMutationOperation(), session )
            );
            <span class="hljs-keyword">assert</span> batch != <span class="hljs-literal">null</span>;
        }
        <span class="hljs-keyword">return</span> batch;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">performBatchedOperations</span><span class="hljs-params">(ValuesAnalysis valuesAnalysis, TableInclusionChecker inclusionChecker)</span> {
        resolveBatch().addToBatch( getJdbcValueBindings(), inclusionChecker );
    }
}
</code></pre>
<p>MutationExecutorStandard</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MutationExecutorStandard</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractMutationExecutor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">JdbcValueBindingsImpl</span>.JdbcValueDescriptorAccess {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Batch batch;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">MutationExecutorStandard</span><span class="hljs-params">(
        MutationOperationGroup mutationOperationGroup,
        BatchKeyAccess batchKeySupplier,
        <span class="hljs-type">int</span> batchSize,
        SharedSessionContractImplementor session
    )</span> {
        <span class="hljs-keyword">if</span> ( batchedJdbcMutations == <span class="hljs-literal">null</span> || batchedJdbcMutations.isEmpty() ) {
            <span class="hljs-built_in">this</span>.batch = <span class="hljs-literal">null</span>;
        }
        <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">assert</span> generatedValuesDelegate == <span class="hljs-literal">null</span> : <span class="hljs-string">"Unsupported batched mutation for entity target with generated values delegate"</span>;
            <span class="hljs-keyword">final</span> List&lt;PreparableMutationOperation&gt; batchedMutationsRef = batchedJdbcMutations;
            <span class="hljs-built_in">this</span>.batch = session.getJdbcCoordinator().getBatch(
                batchKey,
                batchSize,
                () -&gt; ModelMutationHelper.toPreparedStatementGroup(
                    mutationOperationGroup.getMutationType(),
                    mutationOperationGroup.getMutationTarget(),
                    <span class="hljs-literal">null</span>,
                    batchedMutationsRef,
                    session
                )
            );
            <span class="hljs-keyword">assert</span> batch != <span class="hljs-literal">null</span>;
        }
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">performBatchedOperations</span><span class="hljs-params">(
        ValuesAnalysis valuesAnalysis,
        TableInclusionChecker inclusionChecker)</span> {
        <span class="hljs-keyword">if</span> ( batch == <span class="hljs-literal">null</span> ) {
            <span class="hljs-keyword">return</span>;
        }
        batch.addToBatch( valueBindings, inclusionChecker );
    }
}
</code></pre>
<p>因此，只要创建的 <code>MutationExecutor</code> 实例是 <code>MutationExecutorSingleBatched</code> 或 <code>MutationExecutorStandard</code>，就可以确定当前操作一定会走批量执行路径</p>
<p>那就让我们把目光放到 MutationExecutor 的创建逻辑</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// InsertCoordinatorStandard</span>
<span class="hljs-keyword">private</span> MutationExecutor <span class="hljs-title function_">executor</span><span class="hljs-params">(SharedSessionContractImplementor session, MutationOperationGroup group, <span class="hljs-type">boolean</span> dynamicUpdate)</span> {
    <span class="hljs-keyword">return</span> mutationExecutorService.createExecutor(
        resolveBatchKeyAccess( dynamicUpdate, session ),
        group,
        session
    );
}

<span class="hljs-comment">// UpdateCoordinatorStandard</span>
<span class="hljs-keyword">private</span> MutationExecutor <span class="hljs-title function_">executor</span><span class="hljs-params">(SharedSessionContractImplementor session, MutationOperationGroup group, <span class="hljs-type">boolean</span> dynamicUpdate)</span> {
    <span class="hljs-keyword">return</span> mutationExecutorService.createExecutor(
        resolveBatchKeyAccess( dynamicUpdate, session ),
        group,
        session
    );
}

<span class="hljs-comment">// AbstractDeleteCoordinator（DeleteCoordinatorStandard）</span>
<span class="hljs-keyword">private</span> MutationExecutor <span class="hljs-title function_">executor</span><span class="hljs-params">(SharedSessionContractImplementor session, MutationOperationGroup group)</span> {
    <span class="hljs-keyword">return</span> mutationExecutorService.createExecutor(
        resolveBatchKeyAccess( <span class="hljs-literal">false</span>, session ),
        group,
        session
    );
}
</code></pre>
<p>上述代码中的 mutationExecutorService 是 StandardMutationExecutorService 类，它会根据不同的条件创建出不同的 MutationExecutor 实现类</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StandardMutationExecutorService</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">MutationExecutorService</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> globalBatchSize;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">StandardMutationExecutorService</span><span class="hljs-params">(Map&lt;String, Object&gt; configurationValues)</span> {
        <span class="hljs-comment">// 获取 batch_size 参数值并赋值给 globalBatchSize 字段</span>
        <span class="hljs-built_in">this</span>( ConfigurationHelper.getInt( Environment.STATEMENT_BATCH_SIZE, configurationValues, <span class="hljs-number">1</span> ) );
    }

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">StandardMutationExecutorService</span><span class="hljs-params">(<span class="hljs-type">int</span> globalBatchSize)</span> {
        <span class="hljs-built_in">this</span>.globalBatchSize = globalBatchSize;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> MutationExecutor <span class="hljs-title function_">createExecutor</span><span class="hljs-params">(
        BatchKeyAccess batchKeySupplier,
        MutationOperationGroup operationGroup,
        SharedSessionContractImplementor session)</span> {
        <span class="hljs-comment">// decide whether to use batching - any number &gt; one means to batch</span>
        <span class="hljs-keyword">final</span> <span class="hljs-type">Integer</span> <span class="hljs-variable">sessionBatchSize</span> <span class="hljs-operator">=</span> session.getJdbcCoordinator()
            .getJdbcSessionOwner()
            .getJdbcBatchSize();
        <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">batchSizeToUse</span> <span class="hljs-operator">=</span> sessionBatchSize == <span class="hljs-literal">null</span>
            ? globalBatchSize
            : sessionBatchSize;
        <span class="hljs-comment">// 当前这个操作分组中包含的操作种类（INSERT、UPDATE、DELETE）数量，通常只包含一种操作类型</span>
        <span class="hljs-keyword">if</span> ( operationGroup.getNumberOfOperations() == <span class="hljs-number">1</span> ) {
            <span class="hljs-comment">// 走此分支</span>
            <span class="hljs-keyword">final</span> <span class="hljs-type">MutationOperation</span> <span class="hljs-variable">singleOperation</span> <span class="hljs-operator">=</span> operationGroup.getSingleOperation();
            <span class="hljs-keyword">if</span> ( singleOperation <span class="hljs-keyword">instanceof</span> SelfExecutingUpdateOperation ) {
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MutationExecutorSingleSelfExecuting</span>( (SelfExecutingUpdateOperation) singleOperation, session );
            }
            <span class="hljs-keyword">final</span> <span class="hljs-type">PreparableMutationOperation</span> <span class="hljs-variable">jdbcOperation</span> <span class="hljs-operator">=</span> (PreparableMutationOperation) singleOperation;
            <span class="hljs-comment">// 这两行代码很关键，它决定了后续能否走批量操作</span>
            <span class="hljs-keyword">final</span> <span class="hljs-type">BatchKey</span> <span class="hljs-variable">batchKey</span> <span class="hljs-operator">=</span> batchKeySupplier.getBatchKey();
            <span class="hljs-keyword">if</span> ( jdbcOperation.canBeBatched( batchKey, batchSizeToUse ) ) {
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MutationExecutorSingleBatched</span>( jdbcOperation, batchKey, batchSizeToUse, session );
            }
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MutationExecutorSingleNonBatched</span>(
                jdbcOperation,
                operationGroup.asEntityMutationOperationGroup() != <span class="hljs-literal">null</span> ?
                operationGroup.asEntityMutationOperationGroup().getMutationDelegate() :
                <span class="hljs-literal">null</span>,
                session
            );
        }
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MutationExecutorStandard</span>( operationGroup, batchKeySupplier, batchSizeToUse, session );
    }
}
</code></pre>
<p>先解析下 <code>BatchKey batchKey = batchKeySupplier.getBatchKey()</code> 这行代码，BatchKeyAccess 是一个函数式接口，此处它对应的值是 <code>AbstractMutationCoordinator#resolveBatchKeyAccess</code> 方法的返回值</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Internal</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AbstractMutationCoordinator</span> {

    <span class="hljs-keyword">protected</span> BatchKeyAccess <span class="hljs-title function_">resolveBatchKeyAccess</span><span class="hljs-params">(<span class="hljs-type">boolean</span> dynamicUpdate, SharedSessionContractImplementor session)</span> {
        <span class="hljs-keyword">if</span> ( !dynamicUpdate
            &amp;&amp; !entityPersister().optimisticLockStyle().isAllOrDirty()
            &amp;&amp; session.getTransactionCoordinator() != <span class="hljs-literal">null</span>
            &amp;&amp; session.getTransactionCoordinator().isTransactionActive()
            &amp;&amp; (
                <span class="hljs-comment">// batch_versioned_data 参数在此处使用</span>
                session.getSessionFactory().getSessionFactoryOptions()
                .isJdbcBatchVersionedData()
                || !entityPersister().isVersioned() ) ) {
            <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>::getBatchKey;
        }
        <span class="hljs-keyword">return</span> NoBatchKeyAccess.INSTANCE;
    }

    <span class="hljs-comment">// 交由各子类实现</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">abstract</span> BatchKey <span class="hljs-title function_">getBatchKey</span><span class="hljs-params">()</span>;
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">NoBatchKeyAccess</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">BatchKeyAccess</span> {
    <span class="hljs-comment">/**
	 * Singleton access
	 */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">NoBatchKeyAccess</span> <span class="hljs-variable">INSTANCE</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NoBatchKeyAccess</span>();

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> BatchKey <span class="hljs-title function_">getBatchKey</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    }
}
</code></pre>
<p>InsertCoordinatorStandard、UpdateCoordinatorStandard、AbstractDeleteCoordinator（DeleteCoordinatorStandard 父类） 均实现了 <code>getBatchKey()</code> 方法</p>
<p>InsertCoordinatorStandard</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Internal</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">InsertCoordinatorStandard</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractMutationCoordinator</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">InsertCoordinator</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> BasicBatchKey batchKey;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">InsertCoordinatorStandard</span><span class="hljs-params">(AbstractEntityPersister entityPersister, SessionFactoryImplementor factory)</span> {
        <span class="hljs-built_in">super</span>( entityPersister, factory );
        <span class="hljs-comment">// 为什么 GenerationType.IDENTITY 无法走批量插入？原因就在这儿</span>
        <span class="hljs-keyword">if</span> ( entityPersister.isIdentifierAssignedByInsert() || entityPersister.hasInsertGeneratedProperties() ) {
            <span class="hljs-comment">// disable batching in case of insert generated identifier or properties</span>
            batchKey = <span class="hljs-literal">null</span>;
        }
        <span class="hljs-keyword">else</span> {
            batchKey = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BasicBatchKey</span>(
                entityPersister.getEntityName() + <span class="hljs-string">"#INSERT"</span>,
                <span class="hljs-literal">null</span>
            );
        }
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> BatchKey <span class="hljs-title function_">getBatchKey</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> batchKey;
    }
}
</code></pre>
<p>UpdateCoordinatorStandard</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UpdateCoordinatorStandard</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractMutationCoordinator</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">UpdateCoordinator</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> BatchKey batchKey;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> BatchKey versionUpdateBatchkey;

    <span class="hljs-keyword">protected</span> BatchKey <span class="hljs-title function_">getBatchKey</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> batchKey;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">UpdateCoordinatorStandard</span><span class="hljs-params">(AbstractEntityPersister entityPersister, SessionFactoryImplementor factory)</span> {
        <span class="hljs-built_in">super</span>( entityPersister, factory );
        <span class="hljs-keyword">if</span> ( entityPersister.hasUpdateGeneratedProperties() ) {
            <span class="hljs-comment">// disable batching in case of update generated properties</span>
            <span class="hljs-built_in">this</span>.batchKey = <span class="hljs-literal">null</span>;
            <span class="hljs-built_in">this</span>.versionUpdateBatchkey = <span class="hljs-literal">null</span>;
        }
        <span class="hljs-keyword">else</span> {
            <span class="hljs-built_in">this</span>.batchKey = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BasicBatchKey</span>(
                entityPersister.getEntityName() + <span class="hljs-string">"#UPDATE"</span>,
                <span class="hljs-literal">null</span>
            );
            <span class="hljs-built_in">this</span>.versionUpdateBatchkey = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BasicBatchKey</span>(
                entityPersister.getEntityName() + <span class="hljs-string">"#UPDATE_VERSION"</span>,
                <span class="hljs-literal">null</span>
            );
        }
    }
}
</code></pre>
<p>AbstractDeleteCoordinator（DeleteCoordinatorStandard 父类）</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AbstractDeleteCoordinator</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractMutationCoordinator</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">DeleteCoordinator</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> BasicBatchKey batchKey;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">AbstractDeleteCoordinator</span><span class="hljs-params">(
        AbstractEntityPersister entityPersister,
        SessionFactoryImplementor factory
    )</span> {
        <span class="hljs-built_in">super</span>( entityPersister, factory );
        <span class="hljs-built_in">this</span>.batchKey = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BasicBatchKey</span>( entityPersister.getEntityName() + <span class="hljs-string">"#DELETE"</span> );
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> BasicBatchKey <span class="hljs-title function_">getBatchKey</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> batchKey;
    }
}
</code></pre>
<p>再来分析下 <code>jdbcOperation.canBeBatched( batchKey, batchSizeToUse )</code> 这行代码</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">PreparableMutationOperation</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">MutationOperation</span> {

    <span class="hljs-keyword">default</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">canBeBatched</span><span class="hljs-params">(BatchKey batchKey, <span class="hljs-type">int</span> batchSize)</span> {
        <span class="hljs-keyword">if</span> ( batchKey == <span class="hljs-literal">null</span> || batchSize &lt; <span class="hljs-number">2</span> ) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
        <span class="hljs-keyword">if</span> ( getMutationType() == MutationType.UPDATE ) {
            <span class="hljs-comment">// we cannot batch updates against optional tables</span>
            <span class="hljs-keyword">if</span> ( getTableDetails().isOptional() ) {
                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
            }
        }
        <span class="hljs-keyword">return</span> getExpectation().canBeBatched();
    }

    <span class="hljs-comment">// 交由各子类实现</span>
    Expectation <span class="hljs-title function_">getExpectation</span><span class="hljs-params">()</span>;
}
</code></pre>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Expectation</span> {

    <span class="hljs-comment">/**
	 * Is it acceptable to combine this expectation with JDBC
	 * {<span class="hljs-doctag">@linkplain</span> PreparedStatement#executeBatch() statement batching}?
	 * If this method returns {<span class="hljs-doctag">@code</span> false}, the use of batch updates
	 * is disabled.
	 *
	 * <span class="hljs-doctag">@return</span> True if batching can be combined with this expectation;
	 *         false otherwise.
	 *
	 * <span class="hljs-doctag">@see</span> PreparedStatement#executeBatch()
	 */</span>
    <span class="hljs-keyword">default</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">canBeBatched</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
}
</code></pre>
<h5 data-id="heading-9">executeBatchInternal 流程</h5>
<p>这个流程的起点从 ActionQueue#executeActions 方法讲起</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ActionQueue</span> {

    <span class="hljs-keyword">private</span> &lt;E <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ComparableExecutable</span>&gt; <span class="hljs-keyword">void</span> <span class="hljs-title function_">executeActions</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> ExecutableList&lt;E&gt; list)</span> <span class="hljs-keyword">throws</span> HibernateException {
        <span class="hljs-comment">// 最终会执行 ClientPreparedStatement#executeBatchInternal() 方法</span>
        session.getJdbcCoordinator().executeBatch();
    }
}
</code></pre>
<p>让我们思考一个问题：只要进入上述 <code>executeActions</code> 方法，最终都会执行 <code>session.getJdbcCoordinator().executeBatch()</code>，这是否意味着 <code>ActionQueue</code> 中的每一个操作都必须走批量流程？显然不是，接着往下看</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JdbcCoordinatorImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">JdbcCoordinator</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">transient</span> Batch currentBatch;

    <span class="hljs-comment">// MutationExecutorSingleBatched 和 MutationExecutorStandard 的流程会调用此方法</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Batch <span class="hljs-title function_">getBatch</span><span class="hljs-params">(BatchKey key, Integer batchSize, Supplier&lt;PreparedStatementGroup&gt; statementGroupSupplier)</span> {
        <span class="hljs-keyword">if</span> ( currentBatch != <span class="hljs-literal">null</span> ) {
            <span class="hljs-keyword">if</span> ( currentBatch.getKey().equals( key ) ) {
                <span class="hljs-keyword">return</span> currentBatch;
            }
            <span class="hljs-keyword">else</span> {
                currentBatch.execute();
                currentBatch.release();
            }
        }
        currentBatch = owner.getJdbcSessionContext().getBatchBuilder()
            .buildBatch( key, batchSize, statementGroupSupplier, <span class="hljs-built_in">this</span> );
        <span class="hljs-keyword">return</span> currentBatch;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">executeBatch</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">if</span> ( currentBatch != <span class="hljs-literal">null</span> ) {
            <span class="hljs-keyword">try</span> {
                currentBatch.execute();
            }
            <span class="hljs-keyword">finally</span> {
                currentBatch.release();
            }
        }
    }
}
</code></pre>
<p>在 <code>Batch#execute()</code> 方法中，是否真正执行数据库批处理操作，由 batchPosition 和 batchExecuted 这两个关键字段控制，这两个字段的值仅在调用 <code>Batch#addToBatch()</code> 时更新——而 <code>addToBatch()</code> 正是批量流程的入口方法。只有当操作满足批处理条件时，才会调用 <code>Batch#addToBatch()</code> 方法。因此，只有真正进入批量流程的操作，才会执行 performExecution() 方法</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BatchImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Batch</span> {

    <span class="hljs-comment">// 记录当前已累积但尚未执行的批处理语句数量</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> batchPosition;
    <span class="hljs-comment">// 标记当前批次是否已被执行过（用于避免重复执行）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> batchExecuted;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addToBatch</span><span class="hljs-params">(JdbcValueBindings jdbcValueBindings, TableInclusionChecker inclusionChecker)</span> {
        batchPosition++;
        <span class="hljs-keyword">if</span> ( batchPosition == batchSizeToUse ) {
            notifyObserversImplicitExecution();
            performExecution();
            batchPosition = <span class="hljs-number">0</span>;
            batchExecuted = <span class="hljs-literal">true</span>;
        }
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">execute</span><span class="hljs-params">()</span> {
        notifyObserversExplicitExecution();
        <span class="hljs-keyword">if</span> ( getStatementGroup().getNumberOfStatements() == <span class="hljs-number">0</span> ) {
            <span class="hljs-keyword">return</span>;
        }
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">if</span> ( batchPosition == <span class="hljs-number">0</span> ) {
                <span class="hljs-keyword">if</span>( !batchExecuted) {
                    <span class="hljs-keyword">if</span> ( BATCH_LOGGER.isDebugEnabled() ) {
                        BATCH_LOGGER.debugf(
                            <span class="hljs-string">"No batched statements to execute - %s"</span>,
                            getKey().toLoggableString()
                        );
                    }
                }
            }
            <span class="hljs-keyword">else</span> {
                <span class="hljs-comment">// 最终会调用 ClientPreparedStatement#executeBatchInternal() 方法</span>
                performExecution();
            }
        }
        <span class="hljs-keyword">finally</span> {
            releaseStatements();
        }
    }
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[RAG 深度实践系列（二）：工作流程、核心组件与高级优化策略]]></title>    <link>https://juejin.cn/post/7599475458720071680</link>    <guid>https://juejin.cn/post/7599475458720071680</guid>    <pubDate>2026-01-26T09:46:08.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599475458720071680" data-draft-id="7599474528238829608" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="RAG 深度实践系列（二）：工作流程、核心组件与高级优化策略"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2026-01-26T09:46:08.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="中杯可乐多加冰"/> <meta itemprop="url" content="https://juejin.cn/user/3435306702347432"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            RAG 深度实践系列（二）：工作流程、核心组件与高级优化策略
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3435306702347432/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    中杯可乐多加冰
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T09:46:08.000Z" title="Mon Jan 26 2026 09:46:08 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读18分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、 RAG 工作流程</h2>
<p>检索增强生成（RAG）系统代表了大型语言模型（LLM）应用架构的重大演进，它将 LLM 的强大生成能力与外部知识库的实时性、准确性相结合，形成了一个高效、可靠的知识闭环。理解 RAG 系统的完整工作流程，是构建和优化任何 RAG 应用的基础。这个流程并非简单的组件堆砌，而是一个精心设计、环环相扣的<strong>信息处理管道</strong>，主要由查询解析、文档检索、信息整合与回答生成四个阶段构成。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cab9b73af4ba40309d07e4eba7167905~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lit5p2v5Y-v5LmQ5aSa5Yqg5Yaw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770025567&amp;x-signature=Y1%2FJzkMkExjmsJ6x3V2ynvA6QeM%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<hr/>
<p>许多开发者在 RAG 实践中，往往止步于 <strong>向量数据库 + Prompt</strong> 的简单组合，却在面对文档切片策略、重排序 Rerank 引入、以及生产环境的部署调优等深水区问题时感到困惑。</p>
<p>为了帮助开发者填补从懂原理到能落地的关键拼图，AI大学堂基于大量的业务实战经验，精心打磨课程，正式推出 <strong>RAG工程师认证</strong>。这份证书将是你系统化掌握 AI 落地核心能力的绝佳机会，认证现已开启，<strong>限时免费</strong>，点击<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.aidaxue.com%2Fcourse%2F1151%3Fvideo_id%3D5093%26ch%3DCSDNRAG2" target="_blank" title="https://www.aidaxue.com/course/1151?video_id=5093&amp;ch=CSDNRAG2" ref="nofollow noopener noreferrer">🔗认证链接</a>开始学习！</p>
<hr/>
<h3 data-id="heading-1"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>1.1、 查询解析：捕获用户真实意图与查询优化</h3>
<p>RAG 流程始于用户输入的自然语言查询，而<strong>查询解析</strong>（Query Understanding）则是整个流程的起点和基石。用户查询往往是口语化、非结构化的，可能存在歧义、省略或措辞不精确的问题。因此，查询解析的目标是准确理解用户的<strong>信息需求</strong>和<strong>意图</strong>，并将其转化为系统能够高效处理的、优化的检索信号。</p>
<p>在基础处理层面，系统首先需要进行<strong>文本清洗与标准化</strong>，去除无关字符、处理拼写错误，并统一格式。在此基础上，更深层次的语义分析开始介入，包括<strong>命名实体识别（NER）</strong> ，以识别查询中的关键实体（如人名、产品、日期），以及<strong>意图识别</strong>，以判断用户是寻求事实、定义、还是操作指南。这些信息对于后续的<strong>元数据过滤</strong>和<strong>检索策略选择</strong>至关重要。</p>
<p>为了克服用户查询的简短性或模糊性，提高检索的<strong>召回率</strong>，RAG 系统常采用 LLM 驱动的查询优化技术。例如，在多轮对话场景中，LLM 可以进行<strong>查询重写</strong>（Query Rewriting），根据对话历史将模糊的指代（如“它”、“那个”）重写为明确、独立的查询。此外，<strong>查询扩展</strong>（Query Expansion）则通过生成多个语义等价或从不同角度提问的查询变体，来增加命中相关文档的可能性。这些优化后的查询信号，无论是关键词、实体还是新的查询语句，都将作为输入，传递给下一个阶段的检索模块。</p>
<h3 data-id="heading-2"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>1.2、 文档检索：海量知识的精准定位与策略选择</h3>
<p><strong>文档检索</strong>（Document Retrieval）是 RAG 的核心环节，它负责从大规模知识库中找出与优化后查询最相关的文档片段。检索的质量直接决定了 LLM 生成回答的<strong>事实准确性</strong>。</p>
<p>现代 RAG 系统主要依赖于三种检索策略：稀疏检索、密集检索和混合检索。稀疏检索主要基于关键词匹配，其中最具代表性的是 <strong>BM25</strong>（Best Match 25）算法。BM25 是一种基于概率的检索模型，它通过计算查询词在文档中的频率和在整个语料库中的稀有度，并引入了文档长度归一化和词频饱和度参数，来衡量文档与查询的相关性。稀疏检索的优势在于其<strong>可解释性强</strong>、<strong>计算效率高</strong>，并且对训练数据中未出现的<strong>领域外词汇</strong>具有天然的鲁棒性。然而，它的主要局限在于无法捕捉<strong>语义相似性</strong>，对同义词或不同表达方式的查询，检索效果往往不佳。</p>
<p>相比之下，<strong>密集检索</strong>则利用深度学习模型（如 Sentence-BERT）将查询和文档编码成低维、稠密的<strong>嵌入向量</strong>。这种方法通常采用 <strong>Bi-Encoder</strong>（双编码器）架构，通过计算向量之间的余弦相似度或内积来衡量相关性。密集检索的优势在于其强大的<strong>语义匹配能力</strong>，即使查询和文档在字面上不匹配，也能通过语义关系找到相关内容。其挑战在于计算资源消耗较大，需要专门的<strong>向量数据库</strong>支持高效的近似最近邻（ANN）搜索。</p>
<p>在实际应用中，为了兼顾关键词匹配的精确性和语义匹配的召回率，<strong>混合检索</strong>（Hybrid Retrieval）成为主流选择。它通常同时执行稀疏检索和密集检索，然后通过 <strong>RRF</strong>（Reciprocal Rank Fusion）等算法对两种结果进行融合排序，从而实现优势互补，最大化检索的鲁棒性和效果。下表对这三种策略进行了总结：</p>





























<table><thead><tr><th align="left">检索策略</th><th align="left">技术原理</th><th align="left">核心优势</th><th align="left">核心局限性</th></tr></thead><tbody><tr><td align="left"><strong>稀疏检索</strong></td><td align="left">基于关键词匹配（BM25），高维稀疏向量。</td><td align="left">可解释性强，计算效率高，对领域外词汇鲁棒。</td><td align="left">无法捕捉语义相似性，对查询措辞敏感。</td></tr><tr><td align="left"><strong>密集检索</strong></td><td align="left">基于深度学习模型（Bi-Encoder），低维稠密向量。</td><td align="left">强大的语义匹配能力，复杂查询效果好。</td><td align="left">计算资源消耗大，可解释性差。</td></tr><tr><td align="left"><strong>混合检索</strong></td><td align="left">结合稀疏和密集检索，通过 RRF 融合。</td><td align="left">兼顾关键词和语义匹配，召回率和鲁棒性最高。</td><td align="left">实现复杂度高，需要维护两套索引。</td></tr></tbody></table>
<h3 data-id="heading-3"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>1.3、 信息整合与回答生成：增强推理与内容创作</h3>
<p>检索模块返回的文档片段进入<strong>信息整合</strong>阶段，随后与原始查询一起输入给 LLM 进行最终的回答生成。这一阶段是 RAG 价值的最终体现。</p>
<p><strong>上下文构建与精炼</strong>是信息整合的核心任务。由于 LLM 的上下文窗口是有限的，检索到的信息必须经过精炼和组织，以确保提供给 LLM 的上下文是<strong>高质量、紧凑且相关</strong>的。这包括对检索结果进行初步的<strong>去重</strong>、<strong>摘要</strong>或<strong>关键信息提取</strong>。最终，系统将用户查询和经过筛选、排序的文档片段组合成一个结构化的输入序列，并以明确的<strong>提示词</strong>（Prompt）格式输入给 LLM。</p>
<p>在 RAG 系统中，LLM 的角色发生了本质性的转变。它不再是独立地从其内部参数化知识中生成回答，而是作为一个强大的<strong>推理引擎</strong>和<strong>文本生成器</strong>，其生成过程被外部知识所“增强”和“约束”。LLM 的核心作用在于：<strong>信息综合</strong>，能够从分散在不同文档片段中的信息中进行逻辑推理；<strong>事实核查</strong>，确保生成的内容与检索到的事实信息一致，从而显著降低“幻觉”的风险；以及<strong>自然语言生成</strong>，将综合后的信息以流畅、专业的语言形式表达出来。最终生成的答案必须同时满足<strong>准确性</strong>（Accuracy）和<strong>流畅性</strong>（Fluency）两个标准，并能够提供<strong>引用来源</strong>，以增强系统的可信度和可追溯性。</p>
<h2 data-id="heading-4"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>二、 核心组件深度解析</h2>
<p>RAG 系统的性能上限取决于其核心组件的技术选型和优化程度。从数据摄取到向量存储，每一个环节都蕴含着复杂的技术挑战和优化空间。</p>
<h3 data-id="heading-5"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>2.1、 数据预处理与文本分块</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7ce14de1e9074d1f927cf37d77875bac~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lit5p2v5Y-v5LmQ5aSa5Yqg5Yaw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770025567&amp;x-signature=Nc79xCi%2BugGtnOGOd0%2FsJ7Mz8ho%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p><strong>数据预处理</strong>是 RAG 系统的“地基”，其任务是将原始、异构的数据转化为统一、干净、适合检索和嵌入模型处理的格式。在实际部署中，RAG 系统需要处理各种复杂的数据源，例如包含复杂布局、表格和图片的 <strong>PDF 文档</strong>，需要使用 <strong>Layout-Aware Parsers</strong> 来提取文本并保留结构信息；以及包含大量冗余标签的 <strong>HTML 网页</strong>，需要进行内容提取以只保留文章正文。对于 <strong>结构化数据</strong>（如 SQL 数据库），则需要将其转化为自然语言描述，以便进行向量化。</p>
<p>在预处理流程中，<strong>文本分块</strong>（Chunking）无疑是最具艺术性和挑战性的环节。目标是创建大小适中、语义完整的“块”（Chunks），以最大化检索的<strong>相关性</strong>和 LLM 的<strong>处理效率</strong>。一个好的文本块应该包含足够的信息来回答一个问题，但又不能过长，以避免稀释关键信息。</p>
<p>在分块策略的选择上，需要进行精妙的权衡。<strong>固定大小分块</strong>虽然实现简单，但容易在语义边界处截断，破坏上下文。因此，业界更倾向于采用<strong>语义分块</strong>策略，例如基于段落、章节或标题进行分割。其中，<strong>递归字符文本分割器</strong>（RecursiveCharacterTextSplitter）是目前最流行的实践，它尝试使用一系列分隔符（如换行符、句号、空格）递归地分割文本，以优先保持语义完整性。下表总结了主要的文本分块策略：</p>





























<table><thead><tr><th align="left">分块策略</th><th align="left">描述</th><th align="left">核心优势</th><th align="left">核心挑战</th></tr></thead><tbody><tr><td align="left"><strong>固定大小分块</strong></td><td align="left">按固定字符数或 Token 数分割，设置重叠量。</td><td align="left">实现简单，大小可控。</td><td align="left">容易在语义边界处截断，破坏上下文。</td></tr><tr><td align="left"><strong>语义分块</strong></td><td align="left">基于段落、章节、标题等语义边界进行分割。</td><td align="left">保留语义完整性，每个块是独立的逻辑单元。</td><td align="left">实现复杂，依赖于文本的格式规范性。</td></tr><tr><td align="left"><strong>父文档检索</strong></td><td align="left">存储小块用于检索，返回包含该小块的更大“父文档”作为上下文。</td><td align="left">检索精确（小块），上下文丰富（大块）。</td><td align="left">索引和检索逻辑更复杂。</td></tr></tbody></table>
<p>在实践中，<strong>块大小</strong>（<code>chunk_size</code>）的选择需要根据所使用的嵌入模型和 LLM 的上下文窗口大小进行权衡，而<strong>重叠量</strong>（<code>chunk_overlap</code>）的设置则用于确保语义连续性，防止关键信息被分割到相邻块的边界。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6fe9febdb65349b1999def690e93e74e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lit5p2v5Y-v5LmQ5aSa5Yqg5Yaw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770025567&amp;x-signature=gHyEpYkySSMLlVzomKc%2Bj2erf5E%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h3 data-id="heading-6"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>2.2、 嵌入技术：语义空间的量化与模型选择</h3>
<p><strong>嵌入技术</strong>（Embedding）是 RAG 系统中实现语义匹配的基石。它将人类可读的文本转化为低维、稠密的数值向量，从而在向量空间中量化文本的语义信息。在这个向量空间中，语义相似的文本片段会被映射到彼此靠近的位置。<br/>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a879bc2418b44a3fb96b752d39b705af~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lit5p2v5Y-v5LmQ5aSa5Yqg5Yaw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770025567&amp;x-signature=2YSth1LSQgb%2F9R7WeXZhZDtdnDo%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>嵌入模型的质量直接决定了密集检索的上限。选择模型时，需要综合考虑其在 <strong>MTEB</strong>（Massive Text Embedding Benchmark）等基准测试上的<strong>性能</strong>、<strong>领域适应性</strong>、<strong>计算资源需求</strong>以及<strong>成本</strong>。例如，<strong>Sentence-BERT (SBERT)</strong>  系列模型因其在句子相似度任务上的出色表现和高计算效率而广受欢迎。对于需要处理中文或特定领域知识的 RAG 系统，则需要考虑使用在相关数据上进行过微调的 <strong>BGE</strong>（BAAI General Embedding）或 <strong>GTE</strong>（General Text Embeddings）等高性能模型。</p>
<p>一旦文本被转换为嵌入向量，相关性通常通过计算向量之间的<strong>余弦相似度</strong>来衡量。余弦相似度衡量的是两个向量方向的一致性，它能够有效地忽略文本长度的影响，专注于语义方向的匹配。在向量空间中，查询向量与文档片段向量越接近（余弦相似度越接近 1），则语义越相似，从而实现高效的语义检索。</p>
<h3 data-id="heading-7"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>2.3、 向量存储与索引：高效搜索与调优</h3>
<p>一旦文本被嵌入，就需要<strong>向量数据库</strong>（Vector Database）来高效存储、管理和查询这些高维向量。向量数据库（如 Pinecone, Milvus, Qdrant, Chroma）的核心价值在于支持高效的<strong>近似最近邻</strong>（Approximate Nearest Neighbor, ANN）搜索。</p>
<p>由于精确最近邻搜索（ENN）在高维空间中计算成本极高，向量数据库普遍采用 ANN 算法，通过牺牲少量精度来换取查询速度的显著提升。其中，<strong>HNSW</strong>（Hierarchical Navigable Small World）和 <strong>IVF</strong>（Inverted File Index）是目前最主流的两种索引结构。<br/>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fceba753c3b94529a7c2c819a512d062~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lit5p2v5Y-v5LmQ5aSa5Yqg5Yaw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770025567&amp;x-signature=tiuE541RJ%2F86%2FJ0aR9KJFfeAdMs%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>HNSW 是一种基于图的 ANN 算法，它构建了一个多层图结构，通过图遍历进行搜索。其优势在于<strong>召回率高</strong>、<strong>搜索速度快</strong>，但内存占用相对较高。在实践中，通过调整 <strong>efSearchefSearch</strong> 参数可以灵活地在<strong>召回率</strong>和<strong>查询延迟</strong>之间进行权衡：较大的 efSearchefSearch 值会提高召回率，但会增加延迟。</p>
<p>IVF 则是一种基于聚类的 ANN 算法，它首先将向量空间划分为多个单元，搜索时只在最近的几个单元内部进行精确搜索。IVF 的优势在于<strong>内存效率高</strong>，适用于超大规模数据集。下表总结了这两种主流 ANN 索引算法的特点：</p>























<table><thead><tr><th align="left">ANN 索引算法</th><th align="left">原理概述</th><th align="left">核心优势</th><th align="left">性能权衡</th></tr></thead><tbody><tr><td align="left"><strong>HNSW</strong></td><td align="left">基于图的算法，构建多层图结构进行搜索。</td><td align="left">召回率高，搜索速度快，支持动态更新。</td><td align="left">内存占用高；通过 efSearchefSearch 权衡召回率与延迟。</td></tr><tr><td align="left"><strong>IVF</strong></td><td align="left">基于聚类的算法，搜索时只检查最近的单元。</td><td align="left">内存效率高，适用于超大规模数据集。</td><td align="left">召回率可能略低；通过 nprobenprobe​ 权衡召回率与延迟。</td></tr></tbody></table>
<p>向量数据库还必须支持<strong>元数据过滤</strong>，允许用户在检索时根据文档的元数据（如日期、作者、主题）进行限制或筛选，从而实现更精确的<strong>混合搜索</strong>（Hybrid Search）。选择合适的向量数据库和索引策略，并进行精细的参数调优，是确保 RAG 系统在生产环境中稳定、高效运行的关键。</p>
<h2 data-id="heading-8"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>三、 高级优化策略</h2>
<p>为了将 RAG 系统的性能推向极致，必须在检索的前端和后端引入高级优化策略，对查询和检索结果进行精益求精的处理。</p>
<h3 data-id="heading-9"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>3.1、 预检索优化：主动增强查询信号</h3>
<p><strong>预检索优化</strong>旨在在实际检索发生之前，通过对查询进行智能处理，生成更强大的检索信号，以解决原始查询的局限性。<br/>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9267e540ba714cf6af8b7946c5cd0140~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lit5p2v5Y-v5LmQ5aSa5Yqg5Yaw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770025567&amp;x-signature=Pnnzjqd%2BEk7f7HVLOIGTUVXlVgs%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>其中最具创新性的技术之一是<strong>假设性文档嵌入（HyDE）</strong> 。HyDE 解决了<strong>词汇不匹配</strong>（Lexical Gap）的问题。其原理是：首先利用 LLM 根据原始查询生成一个<strong>假设性文档</strong>，这个文档是 LLM 认为最能回答原始查询的理想文档。然后，对这个假设性文档进行嵌入，并使用其嵌入向量进行检索。由于假设性文档通常比原始查询包含更丰富的语义信息和更接近文档的词汇，因此其嵌入向量能够更好地捕捉查询的意图，显著提高检索的准确性。然而，这种方法会增加额外的 LLM 调用，从而增加系统的<strong>延迟</strong>和<strong>运行成本</strong>。</p>
<p>此外，对于需要多步推理才能回答的复杂问题，系统需要引入 <strong>LLM Agent</strong> 来协调和规划检索步骤，实现<strong>多跳检索</strong>（Multi-Hop Retrieval）。Agent 会将一个复杂问题分解为多个子问题，并依次进行检索，将前一步的检索结果作为后一步查询的上下文，从而实现复杂的知识推理。</p>
<h3 data-id="heading-10"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>3.2、 检索后处理：精炼与重排序的二次筛选</h3>
<p><strong>检索后处理</strong>发生在文档检索之后、LLM 生成之前，是提升<strong>准确率</strong>（Precision）的关键环节。尽管检索器已经返回了 Top-K 结果，但这些结果可能仍然包含一些相关性较低或冗余的文档。<br/>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/696c85344af649c99d22ec827725ec9b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lit5p2v5Y-v5LmQ5aSa5Yqg5Yaw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770025567&amp;x-signature=Cegcsg%2BFo3d0u8ZOGqE0pFsg00Q%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p><strong>重排序</strong>（Re-ranking）是检索后处理中最常用的技术。它旨在对检索器返回的初步结果进行二次筛选和排序。重排序通常使用<strong>交叉编码器</strong>（Cross-Encoder）模型。与 Bi-Encoder 独立编码查询和文档不同，交叉编码器将查询和文档<strong>拼接</strong>在一起，然后将拼接后的文本输入到模型中。这种方式能够捕捉查询和文档之间<strong>细粒度的交互信息</strong>，从而在判断相关性方面比 Bi-Encoder 更准确，能够显著提高最终答案的质量。由于交叉编码器的计算成本较高，它通常只用于对 Bi-Encoder 返回的少量（如 Top-50）结果进行二次排序，选出最相关的 Top-N（如 Top-5）作为 LLM 的上下文。</p>
<p>除了重排序，系统还需要解决检索结果的<strong>冗余性</strong>和<strong>多样性</strong>问题。<strong>最大边际相关性（MMR）<strong>是一种常用的算法，它在选择下一个文档时，不仅考虑文档与查询的</strong>相关性</strong>，还考虑其与已选文档的<strong>多样性</strong>。MMR 的目标是选择一个既相关又与已选文档不重复的文档集合，从而确保提供给 LLM 的上下文既全面又精炼。</p>
<h3 data-id="heading-11"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>3.3、 模块协同与评估体系</h3>
<p>RAG 系统的卓越性能源于其各模块的紧密协同和持续的迭代优化。在复杂的 RAG 架构中，LLM 不仅是生成器，还可以作为 <strong>Agent</strong> 协调不同模块的调用，例如根据检索结果的质量，决定是否需要进行<strong>二次检索</strong>或调用外部工具。</p>
<p>一个成熟的 RAG 系统必须包含持续的<strong>反馈循环</strong>（Feedback Loop）。反馈可以来自用户（显式满意度评分或隐式后续查询行为）和系统内部（模型评估）。</p>
<p>RAG 系统的评估是一个多维度的挑战，需要同时评估检索质量和生成质量。<strong>检索质量</strong>通常通过 <strong>召回率</strong>（Recall）、<strong>MRR</strong>（Mean Reciprocal Rank）等指标来衡量；而<strong>生成质量</strong>则需要评估答案的<strong>忠实度</strong>（Faithfulness，即答案与上下文的一致性）、<strong>相关性</strong>（Relevance）和<strong>流畅性</strong>（Fluency）。下表总结了 RAG 系统的主要评估维度：</p>





























<table><thead><tr><th align="left">评估维度</th><th align="left">核心关注点</th><th align="left">关键指标/框架</th><th align="left">优化方向</th></tr></thead><tbody><tr><td align="left"><strong>检索质量</strong></td><td align="left">找到所有相关文档的能力和排序准确性。</td><td align="left">召回率、MRR、NDCG</td><td align="left">嵌入模型、分块策略、索引参数。</td></tr><tr><td align="left"><strong>生成质量</strong></td><td align="left">答案与上下文的一致性、与查询的相关性。</td><td align="left">忠实度、相关性、流畅性（RAGAS）</td><td align="left">Prompt 工程、LLM 参数、上下文精炼。</td></tr><tr><td align="left"><strong>端到端性能</strong></td><td align="left">系统在生产环境中的效率和经济性。</td><td align="left">延迟（Latency）、吞吐量（QPS）、成本</td><td align="left">ANN 算法、硬件资源、缓存策略。</td></tr></tbody></table>
<p><strong>RAGAS</strong>（Retrieval-Augmented Generation Assessment）等评估框架的出现，利用 LLM 自身的能力来评估 RAG 系统的忠实度和上下文相关性，为 RAG 系统的迭代优化提供了量化工具。通过这种持续的评估和优化，RAG 系统能够不断学习和适应新的数据和用户需求，从而提供越来越智能和可靠的服务。</p>
<h2 data-id="heading-12"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>四、 总结</h2>
<p>RAG 技术通过将 LLM 的强大生成能力与外部知识库的实时性、准确性相结合，为构建可靠、可信赖的 AI 应用提供了强大的技术框架。它代表了 LLM 从“知识黑箱”走向“知识透明”的关键一步。</p>
<p>RAG 的未来将聚焦于 <strong>多模态 RAG</strong>（处理文本、图像、视频）、<strong>多跳推理</strong>和 <strong>LLM Agent 协同</strong>，以应对更复杂的现实世界挑战。</p>
<p>本文深入解析了 RAG 的工作流程与核心组件，但从原理到工程化落地，仍有许多实战细节需要掌握，例如如何高效部署 RAGFlow、如何使用 RAGAS 进行量化评估，以及如何针对特定行业进行优化。</p>
<p>为了帮助您系统化地掌握这些进阶能力，AI大学堂基于大量的业务实战经验，精心打磨了 <strong>RAG工程师认证</strong> 课程。这份认证覆盖了从基础概念、核心组件、高级优化到工程化实战的全链路知识体系，旨在助您打破理论与落地的壁垒，将知识真正内化为职场竞争力。</p>
<p><strong>限时免费</strong>认证现已开启，立即点击下方链接，开启您的 RAG 进阶学习之旅：</p>
<p>🔗 <strong>认证链接：</strong><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.aidaxue.com%2Fcourse%2F1151%3Fvideo_id%3D5093%26ch%3DCSDNRAG2" target="_blank" title="https://www.aidaxue.com/course/1151?video_id=5093&amp;ch=CSDNRAG2" ref="nofollow noopener noreferrer">www.aidaxue.com/course/1151…</a></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c2ee8a2b2e824b7cb81961b1be140502~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lit5p2v5Y-v5LmQ5aSa5Yqg5Yaw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770025567&amp;x-signature=%2FLJbAfKe1DrPxkFJyms6WJiWm1g%3D" alt="在这里插入图片描述" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Claude-Mem：给 AI 编程助手装上"长期记忆"]]></title>    <link>https://juejin.cn/post/7599155566297808939</link>    <guid>https://juejin.cn/post/7599155566297808939</guid>    <pubDate>2026-01-26T08:51:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599155566297808939" data-draft-id="7599155566297514027" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Claude-Mem：给 AI 编程助手装上&quot;长期记忆&quot;"/> <meta itemprop="keywords" content="AI编程"/> <meta itemprop="datePublished" content="2026-01-26T08:51:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="云栈开源日记"/> <meta itemprop="url" content="https://juejin.cn/user/3643150216729880"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Claude-Mem：给 AI 编程助手装上"长期记忆"
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3643150216729880/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    云栈开源日记
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T08:51:37.000Z" title="Mon Jan 26 2026 08:51:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">写在前面</h2>
<p>你是不是也遇到过这种情况：昨天用 Claude Code 写了一段复杂业务逻辑，今天重新打开项目，AI 助手却像失忆了一样，完全不记得你们讨论过什么，只能从头再解释一遍？</p>
<p>这个痛点，Claude-Mem 给出了解决方案——一个专为 Claude Code 打造的持久化记忆系统，让 AI 助手真正记住你们的每一次协作。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cf965d410a0a40c38f4f21097ea6dbc1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LqR5qCI5byA5rqQ5pel6K6w:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770022300&amp;x-signature=uuUCGV1ba7u84Y268Jjia92gouw%3D" alt="图片" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-1">它到底解决了什么问题</h2>
<p>传统的 AI 编程助手每次启动都是"全新的大脑"，无法跨会话保留项目上下文。Claude-Mem 通过自动捕获、AI 压缩、智能检索三个步骤，实现了：</p>
<ul>
<li>✅ <strong>跨会话记忆保持</strong>：自动记录所有工具调用和代码操作</li>
<li>✅ <strong>智能内容压缩</strong>：用 Claude Agent SDK 将冗长对话压缩成精炼摘要</li>
<li>✅ <strong>按需精准检索</strong>：通过自然语言查询历史记忆，大幅节省 Token 成本</li>
</ul>
<hr/>
<h2 data-id="heading-2">技术架构解析</h2>
<h3 data-id="heading-3">核心组件构成</h3>
<pre><code class="hljs language-swift" lang="swift">系统架构：
<span class="hljs-operator">├──</span> 钩子系统（<span class="hljs-number">7</span> 个生命周期钩子）
<span class="hljs-operator">├──</span> <span class="hljs-type">Worker</span> 服务（<span class="hljs-type">HTTP</span> <span class="hljs-type">API</span> <span class="hljs-operator">+</span> <span class="hljs-type">Web</span> <span class="hljs-type">UI）</span>
<span class="hljs-operator">├──</span> 存储层（<span class="hljs-type">SQLite</span> <span class="hljs-type">FTS5</span> <span class="hljs-operator">+</span> <span class="hljs-type">Chroma</span> 向量库）
<span class="hljs-operator">└──</span> <span class="hljs-type">PM2</span> 进程管理
</code></pre>
<p><strong>主要技术栈</strong>：</p>
<ul>
<li><strong>Node.js + TypeScript</strong>：插件主体实现</li>
<li><strong>SQLite FTS5</strong>：全文检索引擎</li>
<li><strong>Chroma Vector DB</strong>：语义向量搜索</li>
<li><strong>Claude Agent SDK</strong>：AI 压缩核心能力</li>
</ul>
<hr/>
<h2 data-id="heading-4">工作原理拆解</h2>
<h3 data-id="heading-5">五大生命周期钩子</h3>
<p>Claude-Mem 采用观察者模式，在不干扰主会话的前提下，通过钩子捕获关键事件：</p>



































<table><thead><tr><th>钩子名称</th><th>触发时机</th><th>核心作用</th></tr></thead><tbody><tr><td>context-hook</td><td>会话启动时</td><td>注入最近记忆作为上下文</td></tr><tr><td>new-hook</td><td>用户提问时</td><td>创建新会话并保存提示词</td></tr><tr><td>save-hook</td><td>工具执行后</td><td>捕获文件读写等操作记录</td></tr><tr><td>summary-hook</td><td>会话结束时</td><td>生成 AI 摘要并持久化存储</td></tr><tr><td>cleanup-hook</td><td>停止指令时</td><td>清理临时数据</td></tr></tbody></table>
<h3 data-id="heading-6">渐进式披露策略</h3>
<p>这是 Claude-Mem 最巧妙的设计——不是一股脑把所有历史记录塞给 AI，而是分层展示：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">Level 1:</span> <span class="hljs-string">最近</span> <span class="hljs-number">3</span> <span class="hljs-string">条会话摘要（约</span> <span class="hljs-number">500</span> <span class="hljs-string">tokens）</span>
<span class="hljs-attr">Level 2:</span> <span class="hljs-string">相关观察记录（用户主动查询）</span>
<span class="hljs-attr">Level 3:</span> <span class="hljs-string">完整历史检索（mem-search</span> <span class="hljs-string">技能）</span>
</code></pre>
<p>这种策略借鉴了前端开发中的懒加载思想，在云栈社区的技术实践中，我们也常强调"按需加载"的性能优化原则。</p>
<hr/>
<h2 data-id="heading-7">实际应用场景</h2>
<h3 data-id="heading-8">场景一：Bug 修复追溯</h3>
<pre><code class="hljs language-sql" lang="sql">用户："上周修复的登录超时问题，具体改了哪些文件？"
Claude：[自动触发 mem<span class="hljs-operator">-</span><span class="hljs-keyword">search</span>]
       → 检索到 <span class="hljs-number">2</span> 条相关观察记录
       → 返回：修改了 auth.ts 和 session.middleware.ts
</code></pre>
<h3 data-id="heading-9">场景二：项目知识库构建</h3>
<p>长期使用后，Claude-Mem 会自动构建项目的"知识图谱"：</p>
<ul>
<li>架构决策记录</li>
<li>常用代码模式</li>
<li>踩过的坑和解决方案</li>
</ul>
<h3 data-id="heading-10">场景三：团队协作可视化</h3>
<p>通过 Web UI（localhost:37777）可以实时查看：</p>
<ul>
<li>记忆流动态</li>
<li>会话摘要时间线</li>
<li>Token 消耗统计</li>
</ul>
<hr/>
<h2 data-id="heading-11">快速上手指南</h2>
<h3 data-id="heading-12">安装步骤（3 步完成）</h3>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">在 Claude Code 终端执行</span>
<span class="hljs-meta prompt_">&gt; </span><span class="bash">/plugin marketplace add thedotmack/claude-mem</span>
<span class="hljs-meta prompt_">&gt; </span><span class="bash">/plugin install claude-mem</span>
<span class="hljs-meta prompt_"># </span><span class="bash">重启 Claude Code 即可使用</span>
</code></pre>
<h3 data-id="heading-13">核心技能使用</h3>
<p><strong>mem-search 技能</strong>：自然语言查询历史记忆</p>
<pre><code class="hljs language-sql" lang="sql">示例：mem<span class="hljs-operator">-</span><span class="hljs-keyword">search</span> "关于数据库迁移的讨论"
效果：相比传统 MCP 方式节省约 <span class="hljs-number">2</span>,<span class="hljs-number">250</span> tokens
</code></pre>
<hr/>
<h2 data-id="heading-14">架构设计亮点</h2>
<h3 data-id="heading-15">混合检索策略</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 结合传统全文检索和现代向量搜索</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">SearchStrategy</span> {
  fullText: SQLite FTS5,     <span class="hljs-comment">// 关键词精准匹配</span>
  semantic: Chroma Vector,   <span class="hljs-comment">// 语义相似度计算</span>
  hybrid: RRF 融合排序       <span class="hljs-comment">// 最佳结果输出</span>
}
</code></pre>
<h3 data-id="heading-16">隐私控制机制</h3>
<p>使用 <code>&lt;private&gt;</code> 标签排除敏感内容：</p>
<pre><code class="hljs language-makefile" lang="makefile">&lt;<span class="hljs-keyword">private</span>&gt;
API_KEY=sk-xxx  <span class="hljs-comment"># 不会被系统记录</span>
&lt;/<span class="hljs-keyword">private</span>&gt;
</code></pre>
<h3 data-id="heading-17">双标签系统（v7.0 新特性）</h3>
<ul>
<li><code>&lt;private&gt;</code>：完全排除观察记录</li>
<li><code>&lt;no-summary&gt;</code>：记录但不生成摘要</li>
</ul>
<hr/>
<h2 data-id="heading-18">性能表现数据</h2>





















<table><thead><tr><th>优化指标</th><th>实际效果</th></tr></thead><tbody><tr><td>Token 节省</td><td>每次启动节省 2,250 tokens</td></tr><tr><td>查询响应速度</td><td>向量检索 &lt; 50ms</td></tr><tr><td>存储压缩效率</td><td>10GB 代码库压缩至约 200MB</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-19">工程实践启示</h2>
<p>作为全栈工程师，Claude-Mem 展示了几个值得学习的工程实践：</p>
<ol>
<li><strong>插件化设计</strong>：标准的生命周期钩子系统</li>
<li><strong>AI 工程化</strong>：将 LLM 能力封装为可复用服务</li>
<li><strong>成本意识</strong>：Token 优化是 AI 原生应用的核心指标</li>
<li><strong>用户体验</strong>：渐进式披露配合可视化 UI</li>
</ol>
<p>对于想深入学习 Node.js 开发和 人工智能应用的朋友，这个项目提供了很好的参考范例。</p>
<hr/>
<h2 data-id="heading-20">写在最后</h2>
<p>Claude-Mem 不仅是一个工具，更是 AI 辅助编程的范式探索：如何让 AI 从"一次性对话"进化为"长期协作伙伴"。</p>
<p>如果你正在使用 Claude Code，不妨试试这个插件，让你的 AI 助手真正"记住"你们的每一次协作。更多优质开源项目解析，欢迎关注《云栈开源日记》！</p>
<hr/>
<h3 data-id="heading-21">项目资源</h3>
<ul>
<li><strong>GitHub 仓库</strong>：<code>thedotmack/claude-mem</code></li>
<li><strong>官方文档</strong>：<code>docs.claudemem.com</code></li>
<li><strong>AI 学习</strong>：<code>https://yunpan.plus/f/29</code></li>
<li><strong>TypeScript 学习</strong>：<code>https://yunpan.plus/f/18</code></li>
</ul>
<hr/>
<p>标签：#Claude #GitHub #AI编程助手 #向量数据库 #TypeScript #持久化存储 #开发工具</p>
<p>原文 <code>https://yunpan.plus/t/1920-1-1</code> 版权所有</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[总结2025展望2026]]></title>    <link>https://juejin.cn/post/7599101854645075978</link>    <guid>https://juejin.cn/post/7599101854645075978</guid>    <pubDate>2026-01-26T06:33:36.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599101854645075978" data-draft-id="7599268297222995978" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="总结2025展望2026"/> <meta itemprop="keywords" content="程序员,创业"/> <meta itemprop="datePublished" content="2026-01-26T06:33:36.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="速搭科技"/> <meta itemprop="url" content="https://juejin.cn/user/3292413843745596"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            总结2025展望2026
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3292413843745596/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    速搭科技
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T06:33:36.000Z" title="Mon Jan 26 2026 06:33:36 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>要说2025已经结束了，现在已经进入到2026了，阳历的年已经过完了，但是农历的年还没到，索性在这个间隙，写篇文章记录一下。</p>
<p>先来说说我自己吧，去年由于太过拼命的工作，导致身体出了各种问题。先是眼睛上的伤害，大概去年中旬的时候，经常晚上下班后，走在灯火通明的街道上，却感觉特别暗，起初以为这是外界的因素，后面才知道，是我的视力又下降了。再到后来大白天，眼前开始出行很多小虫子一样的黑影，后来才知道，这叫飞蚊症。</p>
<p>还有就是腰椎和脾胃，由于长期久坐，导致腰椎上也出现问题，今年年初，有次躺在床上，只是翻个身忽然就感觉腿抽的特别疼，到后来走路时也疼，从腿延伸到屁股，屁股疼完腿又疼。甚至有一次，弯腰洗头那么会儿功夫，都不能支撑下来。后来去医院检查，说是可能腰椎间盘突出导致的，也有人说屁股疼是因为梨状肌综合症，后期要自己注意。还有就是长期也断断续续，饥一顿饱一顿，暴饮暴食，导致脾胃上也出了问题，最直观的就是舌苔上的变化，先是地图舌，到后面裂纹舌。直到后面吃饭也疼，才重视起来。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b48dc834f92b415db4f8b6832b938b85~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCf5pCt56eR5oqA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770014021&amp;x-signature=uID4B7zWt3TvmMAXxT6cLlZH5IM%3D" alt="" loading="lazy"/></p>
<p>身体上的问题，相信大家从我的状态也能看出来。各种问题，让我一度产生怀疑，我才三十，这副躯壳，到底能不能，后面的就不想说了。还有就是年初的的时候，我媳妇怀孕了，前期经常去检查。所以总结下来，前半年，基本就是和医院在打交道。</p>
<p>说完不好的，也有好的。腰椎上的问题，检查后说是问题不大，只是有突出的迹象，吃点药就好了；脾胃上的问题，也只能慢慢调理，现在也按时吃饭了，辣椒基本上也戒了；视力上的问题，现在工作强度没以前大了，没有那么专注了，眼前的黑影，也基本消失了。</p>
<p>七月份的时候，媳妇胎位稳定了，也满三个月了，我俩跑到大西北转了一圈，从咸阳出发，先到青海西宁，再到甘肃敦煌，后进入新疆，第一站乌鲁木齐，完了又去了伊犁，看了大草原，打卡了赛里木湖，完了又跑去南疆，去喀什古城住了一段时间。明年，在各方面条件完善的情况下，希望有机会能带父母，带家里人多出去转一转吧。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/104529993006431ea2d172344392fbf6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCf5pCt56eR5oqA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770014021&amp;x-signature=dx72XOfeS2g1uyDHYPcNQMkIGyI%3D" alt="" loading="lazy"/></p>
<p>十月份的时候，忽然想起来还有个乔迁要办，事实上，从去年底房子装修好，今年我们就已经住进来了。有次和朋友聊天，说是最好弄个仪式意思下，于是就喊了家人一起来庆祝，房子不大，地理位置也不算很好，但总归在这偌大的城市，有个落脚点了吧，对应了那句，从此，万家灯火，有我一栈。</p>
<p>提起房子，其实这么多年出来，大部分积蓄，都砸在了房子上，真金白银进去的，已经小一百万了，还不算剩下的，有时候想想，到底划不划得来呢？也不想那么多了，有些事只有自己经历了才知道，有些事你也没办法去改变，那就硬着头皮往前走。好的是，在很多同龄人还考虑要不要上车的时候，我已经准备下车了。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a6a65429535c4004acf2d3209cd2155b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCf5pCt56eR5oqA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770014021&amp;x-signature=rBnn8ARPWKFYM3I4oslcSkQ9Myg%3D" alt="" loading="lazy"/></p>
<p>十二月份的时候，我媳妇终于要生了，淘气的宝贝拖堂了，到了预产期还没动静，到医院住了几天，顺利生产。到这里其实想说的，也是一点感触吧，一方面是鼓励生育，但是该收的，一分没少，有些流程，感觉已经成了潜规则，有些费用，你不交根本就没法进行下去，说难听点，甚至阻碍你进行。自费的不报，孩子的不报，床位不报，个别药不报，最终算下来，花了一万多，告诉我只能报一千六，我说为什么这么少？来一句，你才交了四百，一千六不少了，我也就呵呵了。当然这个是居民医保，其实联想到我们自己交的职工医保，养老，想一想，真的能保障吗？对未来的事情，我打个问号？</p>
<p>元旦的时候，去买了一辆汽车，一直在看车，男生也都喜欢车，但也一直没买车，原因是家里有车，可以用，再就是自己也不怎么用车，上下班坐地铁可能还更方便，买了放那就是个消耗品，每年的保险保养油费停车费，都是支出。但现在情况不一样了，一是有了孩子，后面出行的次数会更多，还有就是家里的车，有时候也要用。所以就去买了一辆。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/348c7e18ecdf47f7b85e22ae4757ffb4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCf5pCt56eR5oqA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770014021&amp;x-signature=iuQs%2FFlfpGtykzylQpe28NZDSqw%3D" alt="" loading="lazy"/></p>
<p>说了这么多，总结一下吧。我认为的人生五大件：房子，车子，票子，妻子，孩子。现在就差票子了。票子可以追求，但是不能一味的追求，这样会失去生活的本质，失去来这个世上的意义。到这里，能看到的，能看完的，都是有缘人；在这里，祝你们：身体健康 心情快乐 家庭和睦 事业有成。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Python 中不可变类型（整数）和可变类型（列表）的参数传递规则的理解]]></title>    <link>https://juejin.cn/post/7599220371665633320</link>    <guid>https://juejin.cn/post/7599220371665633320</guid>    <pubDate>2026-01-26T07:59:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599220371665633320" data-draft-id="7598112768147111942" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Python 中不可变类型（整数）和可变类型（列表）的参数传递规则的理解"/> <meta itemprop="keywords" content="Python"/> <meta itemprop="datePublished" content="2026-01-26T07:59:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="茄子好好吃"/> <meta itemprop="url" content="https://juejin.cn/user/2613977076215035"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Python 中不可变类型（整数）和可变类型（列表）的参数传递规则的理解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2613977076215035/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    茄子好好吃
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T07:59:06.000Z" title="Mon Jan 26 2026 07:59:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>最近刷二叉树的问题 用了很多递归 那么我就发现了一个问题  对于在递归中数组发生改变的函数  我们通常要进行一次回溯  而对于在递归中整数 也就是整型变量发生改变的函数中却不需要    我感觉是有所不同的  但是为了确定我心中的想法进行了一系列资料的查询  最终得出了想要的答案</p>
<h5 data-id="heading-0">问题来源</h5>
<p>让我产生问题的分别是<a href="https://link.juejin.cn?target=https%3A%2F%2Fleetcode.cn%2Fproblems%2Fpath-sum%2Fsubmissions%2F693436967%2F" target="_blank" title="https://leetcode.cn/problems/path-sum/submissions/693436967/" ref="nofollow noopener noreferrer">112. 路径总和 </a> <a href="https://link.juejin.cn?target=https%3A%2F%2Fleetcode.cn%2Fproblems%2Ffind-bottom-left-tree-value%2Fdescription%2F" target="_blank" title="https://leetcode.cn/problems/find-bottom-left-tree-value/description/" ref="nofollow noopener noreferrer">513. 找树左下角的值 </a>以及<a href="https://link.juejin.cn?target=https%3A%2F%2Fleetcode.cn%2Fproblems%2Fbinary-tree-paths%2F" target="_blank" title="https://leetcode.cn/problems/binary-tree-paths/" ref="nofollow noopener noreferrer">257. 二叉树的所有路径 </a></p>
<pre><code class="hljs language-py" lang="py">路径总和
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">rest</span>(<span class="hljs-params">self,node,summ</span>):
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> node:
            <span class="hljs-keyword">return</span>
        summ=summ-node.val
        <span class="hljs-keyword">if</span> summ==<span class="hljs-number">0</span> <span class="hljs-keyword">and</span> (<span class="hljs-keyword">not</span> node.left <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> node.right):
            <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>
        left=self.rest(node.left,summ)
        <span class="hljs-keyword">if</span> left==<span class="hljs-literal">True</span>:
            <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>
        right=self.rest(node.right,summ)
        <span class="hljs-keyword">if</span> right==<span class="hljs-literal">True</span>:
            <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>
        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">hasPathSum</span>(<span class="hljs-params">self, root: <span class="hljs-type">Optional</span>[TreeNode], targetSum: <span class="hljs-built_in">int</span></span>) -&gt; <span class="hljs-built_in">bool</span>:
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> root:
            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>
        t=self.rest(root,targetSum)
        <span class="hljs-keyword">return</span> t
</code></pre>
<p>这个是路径总和，变量summ每次都是同一个没有回溯</p>
<pre><code class="hljs language-py" lang="py">找树左下角的值
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">findBottomLeftValue</span>(<span class="hljs-params">self, root: <span class="hljs-type">Optional</span>[TreeNode]</span>) -&gt; <span class="hljs-built_in">int</span>:
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> root.left <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> root.right:
            <span class="hljs-keyword">return</span> root.val
        self.result=[]
        <span class="hljs-keyword">def</span> <span class="hljs-title function_">depth</span>(<span class="hljs-params">node,level</span>):
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> node:
                <span class="hljs-keyword">return</span>
            <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(self.result)==level:
                self.result.append([])
            self.result[level].append(node.val)
            depth(node.left,level+<span class="hljs-number">1</span>)
            depth(node.right,level+<span class="hljs-number">1</span>)
        
        depth(root,<span class="hljs-number">0</span>)
        <span class="hljs-keyword">return</span> self.result[-<span class="hljs-number">1</span>][<span class="hljs-number">0</span>]
</code></pre>
<p>这里的level也没有在做什么改变</p>
<pre><code class="hljs language-py" lang="py">二叉树的所有路径
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">binaryTreePaths</span>(<span class="hljs-params">self, root: <span class="hljs-type">Optional</span>[TreeNode]</span>) -&gt; <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>]:
        <span class="hljs-keyword">def</span> <span class="hljs-title function_">travel</span>(<span class="hljs-params">node,result,Pass</span>):
            Pass.append(node.val)
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> node.left <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> node.right:
                sPass=<span class="hljs-string">"-&gt;"</span>.join(<span class="hljs-built_in">map</span>(<span class="hljs-built_in">str</span>,Pass))
                result.append(sPass)
            <span class="hljs-keyword">if</span> node.left:
                travel(node.left,result,Pass)
                Pass.pop()
            <span class="hljs-keyword">if</span> node.right:
                travel(node.right,result,Pass)
                Pass.pop()
            <span class="hljs-keyword">return</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> root:
            <span class="hljs-keyword">return</span> 
        Pass=[]
        result=[]
        travel(root,result,Pass)
        <span class="hljs-keyword">return</span>(result)
</code></pre>
<p>先拆解一下这个函数吧，pass每次会储存节点，到达叶子节点后会加一个-&gt;变成spass 也就是一段路径 然后传到结果result当中，那么在这期间，每引用一次travel函数都会让pass增加一个数字，于是我们进行了一次回溯 确保在同一层中pass是相同的</p>
<h2 data-id="heading-1">解释和理解</h2>
<p>在查阅资料后我发现了问题所在： 对于整型变量来说  比如调用t，每次调用t都只是在当前层中复制一个t的值然后传进去，<strong>每个递归调用都会创建独立的函数栈帧，栈帧里的<code>remain_sum</code>是局部变量，只在当前递归层级有效。左子树里的<code>remain_sum</code>修改，不会影响当前层，更不会影响传给右子树的<code>remain_sum</code></strong>。
举个例子说明：
其实也就是说明了不可变类型的特点：就是修改时会创建一个新对象，而不是在原对象上修改，如同我们t=t-2一样，创建了一个新的t-2，然后把他赋给了一个变量t，而对于数组来说，我们修改数组（result.pop()）就可以在原数组上发生，而不需要再重新赋值。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[kotlin跨平台版本jieba分词]]></title>    <link>https://juejin.cn/post/7599485473706442790</link>    <guid>https://juejin.cn/post/7599485473706442790</guid>    <pubDate>2026-01-26T07:42:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599485473706442790" data-draft-id="7599101854645305354" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="kotlin跨平台版本jieba分词"/> <meta itemprop="keywords" content="Kotlin,开源"/> <meta itemprop="datePublished" content="2026-01-26T07:42:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="余半生"/> <meta itemprop="url" content="https://juejin.cn/user/2084329775983815"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            kotlin跨平台版本jieba分词
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2084329775983815/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    余半生
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T07:42:34.000Z" title="Mon Jan 26 2026 07:42:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">jieba-kmp</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FErolC%2Fjieba-kmp" target="_blank" title="https://github.com/ErolC/jieba-kmp" ref="nofollow noopener noreferrer">jieba-kmp</a>是<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ffxsjy%2Fjieba" target="_blank" title="https://github.com/fxsjy/jieba" ref="nofollow noopener noreferrer">jieba中文分词</a>的kotlin多平台版本</p>
<p>提供与jieba基本一致的功能与接口，但不支持其paddle模式。</p>
<h3 data-id="heading-1">特点</h3>
<ul>
<li>支持三种分词模式：
<ul>
<li>精确模式，试图将句子最精确地切开，适合文本分析；</li>
<li>全模式，把句子中所有的可以成词的词语都扫描出来, 速度非常快，但是不能解决歧义；</li>
<li>搜索引擎模式，在精确模式的基础上，对长词再次切分，提高召回率，适合用于搜索引擎分词。</li>
</ul>
</li>
<li>支持繁体分词</li>
<li>支持自定义词典</li>
<li>MIT 授权协议</li>
</ul>
<h3 data-id="heading-2">性能</h3>
<p>以下性能表现不同硬件会有所不同，仅供参考</p>
<h4 data-id="heading-3">初始化</h4>





















<table><thead><tr><th>平台</th><th>35万词</th><th>35万词+缓存</th><th>50万词</th><th>50万词+缓存</th><th>设备</th></tr></thead><tbody><tr><td>android</td><td>1.5秒</td><td>1秒（首次1.9秒）</td><td>2.1秒</td><td>1.0秒（首次3.1秒）</td><td>1+Ace5</td></tr></tbody></table>
<h4 data-id="heading-4">分词</h4>

















<table><thead><tr><th>长度</th><th>android</th></tr></thead><tbody><tr><td>1200</td><td>160ms</td></tr><tr><td>6000</td><td>500ms</td></tr></tbody></table>
<h3 data-id="heading-5">安装</h3>
<pre><code class="hljs language-kotlin" lang="kotlin">commonMain.dependencies {
    api(<span class="hljs-string">'cn.erolc.jieba:jieba-kmp:1.0.0'</span>)
}
</code></pre>
<p>如果只是android单独使用：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">dependencies {
    api(<span class="hljs-string">'cn.erolc.jieba:jieba-kmp-android:1.0.0'</span>)
}
</code></pre>
<blockquote>
<p>最新版本请前往<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FErolC%2Fjieba-kmp" target="_blank" title="https://github.com/ErolC/jieba-kmp" ref="nofollow noopener noreferrer">jieba-kmp</a>查看</p>
</blockquote>
<h3 data-id="heading-6">混淆规则</h3>
<pre><code class="hljs language-kotlin" lang="kotlin">-keep <span class="hljs-keyword">class</span> <span class="hljs-title class_">cn</span>.<span class="hljs-title">erolc</span>.<span class="hljs-title">jieba</span>.<span class="hljs-title">model</span>.<span class="hljs-title">FreqCache</span> { *; }
</code></pre>
<h3 data-id="heading-7">使用</h3>
<h4 data-id="heading-8">初始化</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">//android</span>
jiebaInit()
<span class="hljs-comment">//other </span>
Jieba.<span class="hljs-keyword">init</span>()
</code></pre>
<p>android需要在application中进行初始化</p>
<blockquote>
<p>在不初始化的情况下依旧可以使用分词功能，只是在第一次分词时内部会先进行初始化，所以第一次分词耗时会稍长些。android建议先初始化</p>
</blockquote>
<h4 data-id="heading-9">分词</h4>
<ul>
<li><code>Jieba.cut</code>方法接收两个参数：需要分词的字符串；模式；</li>
<li><code>Jieba.lcut</code>方法接收与<code>Jieba.cut</code>一致的参数；<code>cut</code>返回值是flow，<code>lcut</code>返回值是list</li>
<li><code>Jieba.cutForSearch</code>方法接受两个参数：需要分词的字符串；是否使用 HMM 模型。该方法适合用于搜索引擎构建倒排索引的分词，粒度比较细</li>
<li><code>Jieba.tokenize</code>方法接受三个参数：需要分词的字符串；模式；是否使用 HMM 模型。返回值会包含词的位置信息</li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> kotlinx.coroutines.flow.fold
<span class="hljs-keyword">import</span> kotlinx.coroutines.test.runTest
<span class="hljs-keyword">import</span> kotlin.test.Test
<span class="hljs-keyword">import</span> cn.erolc.jieba.Jieba
<span class="hljs-meta">@Test</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">test</span><span class="hljs-params">()</span></span> = runTest {
    <span class="hljs-keyword">val</span> seg_list = Jieba.cut(<span class="hljs-string">"我来到北京清华大学"</span>, Mode.Full)
    <span class="hljs-keyword">val</span> value = seg_list.fold(<span class="hljs-string">""</span>) { acc, value -&gt; <span class="hljs-keyword">if</span> (acc.isEmpty()) value <span class="hljs-keyword">else</span> <span class="hljs-string">"<span class="hljs-variable">$acc</span>/<span class="hljs-subst">${value}</span>"</span> }
    println(<span class="hljs-string">"Full mode: <span class="hljs-variable">$value</span>"</span>)
    <span class="hljs-keyword">val</span> seg_list2 = Jieba.cut(<span class="hljs-string">"我来到北京清华大学"</span>, Mode.HMM)
    <span class="hljs-keyword">val</span> value1 = seg_list2.fold(<span class="hljs-string">""</span>) { acc, value -&gt; <span class="hljs-keyword">if</span> (acc.isEmpty()) value <span class="hljs-keyword">else</span> <span class="hljs-string">"<span class="hljs-variable">$acc</span>/<span class="hljs-subst">${value}</span>"</span> }
    println(<span class="hljs-string">"HMM mode: <span class="hljs-variable">$value1</span>"</span>)
    <span class="hljs-keyword">val</span> seg_list3 = Jieba.cut(<span class="hljs-string">"他来到了网易杭研大厦"</span>)
    <span class="hljs-keyword">val</span> value2 = seg_list3.fold(<span class="hljs-string">""</span>) { acc, value -&gt; <span class="hljs-keyword">if</span> (acc.isEmpty()) value <span class="hljs-keyword">else</span> <span class="hljs-string">"<span class="hljs-variable">$acc</span>/<span class="hljs-subst">${value}</span>"</span> }
    println(<span class="hljs-string">"新词识别: <span class="hljs-variable">$value2</span>"</span>)
    <span class="hljs-keyword">val</span> seg_list4 = Jieba.cutForSearch(<span class="hljs-string">"小明硕士毕业于中国科学院计算所，后在日本京都大学深造"</span>)
    <span class="hljs-keyword">val</span> value3 = seg_list4.fold(<span class="hljs-string">""</span>) { acc, value -&gt; <span class="hljs-keyword">if</span> (acc.isEmpty()) value <span class="hljs-keyword">else</span> <span class="hljs-string">"<span class="hljs-variable">$acc</span>/<span class="hljs-subst">${value}</span>"</span> }
    println(<span class="hljs-string">"Search mode: <span class="hljs-variable">$value3</span>"</span>)
    Jieba.tokenize(<span class="hljs-string">"永和服装饰品有限公司"</span>).collect { println(it) }
    Jieba.tokenize(<span class="hljs-string">"永和服装饰品有限公司"</span>, <span class="hljs-string">"search"</span>).collect { println(it) }


}
</code></pre>
<h4 data-id="heading-10">输出</h4>
<pre><code class="hljs language-ini" lang="ini">cut(9)：382.907833ms
Full mode: 我/来到/北京/清华/清华大学/华大/大学
cut(9)：300.5us
HMM mode: 我/来到/北京/清华大学
cut(10)：2.267ms
新词识别: 他/来到/了/网易/杭研/大厦   (此处，“杭研”并没有在词典中，但是也被Viterbi算法识别出来了)
cutForSearch(26):4.532458ms
Search mode: 小明/硕士/毕业/于/中国/科学/学院/科学院/中国科学院/计算/计算所/，/后/在/日本/京都/大学/日本京都大学/深造
//默认模式
SegToken(<span class="hljs-attr">word</span>=永和, start<span class="hljs-literal">Off</span>set=<span class="hljs-number">0</span>, end<span class="hljs-literal">Off</span>set=<span class="hljs-number">2</span>)
SegToken(<span class="hljs-attr">word</span>=服装, start<span class="hljs-literal">Off</span>set=<span class="hljs-number">2</span>, end<span class="hljs-literal">Off</span>set=<span class="hljs-number">4</span>)
SegToken(<span class="hljs-attr">word</span>=饰品, start<span class="hljs-literal">Off</span>set=<span class="hljs-number">4</span>, end<span class="hljs-literal">Off</span>set=<span class="hljs-number">6</span>)
SegToken(<span class="hljs-attr">word</span>=有限公司, start<span class="hljs-literal">Off</span>set=<span class="hljs-number">6</span>, end<span class="hljs-literal">Off</span>set=<span class="hljs-number">10</span>)
tokenize(10):1.907375ms
//搜索模式
SegToken(<span class="hljs-attr">word</span>=永和, start<span class="hljs-literal">Off</span>set=<span class="hljs-number">0</span>, end<span class="hljs-literal">Off</span>set=<span class="hljs-number">2</span>)
SegToken(<span class="hljs-attr">word</span>=服装, start<span class="hljs-literal">Off</span>set=<span class="hljs-number">2</span>, end<span class="hljs-literal">Off</span>set=<span class="hljs-number">4</span>)
SegToken(<span class="hljs-attr">word</span>=饰品, start<span class="hljs-literal">Off</span>set=<span class="hljs-number">4</span>, end<span class="hljs-literal">Off</span>set=<span class="hljs-number">6</span>)
SegToken(<span class="hljs-attr">word</span>=有限, start<span class="hljs-literal">Off</span>set=<span class="hljs-number">6</span>, end<span class="hljs-literal">Off</span>set=<span class="hljs-number">8</span>)
SegToken(<span class="hljs-attr">word</span>=公司, start<span class="hljs-literal">Off</span>set=<span class="hljs-number">8</span>, end<span class="hljs-literal">Off</span>set=<span class="hljs-number">10</span>)
SegToken(<span class="hljs-attr">word</span>=有限公司, start<span class="hljs-literal">Off</span>set=<span class="hljs-number">6</span>, end<span class="hljs-literal">Off</span>set=<span class="hljs-number">10</span>)
tokenize(10):856.959us
</code></pre>
<h3 data-id="heading-11">调整词典</h3>
<p>使用 <code>addWord(word, freq=None, tag=None)</code> 和 <code>del_word(word)</code> 可在程序中动态修改词典。
使用 <code>suggestFreq(segment)</code> 可调节单个词语的词频，使其能（或不能）被分出来。</p>
<p>注意：自动计算的词频在使用 HMM 新词发现功能时可能无效。</p>
<h3 data-id="heading-12">载入词典</h3>
<ul>
<li>开发者可以指定自己自定义的词典，以便包含 jieba 词库里没有的词。虽然 jieba 有新词识别能力，但是自行添加新词可以保证更高的正确率</li>
<li>用法： <code>Jieba.init(diskHelper)</code></li>
<li>词典格式和 dict.txt 一样，一个词占一行；每一行分三部分：词语、词频（可省略）、词性（可省略），用空格隔开，顺序不可颠倒，则文件必须为
UTF-8 编码。</li>
<li>词频省略时使用自动计算的能保证分出该词的词频。</li>
</ul>
<h3 data-id="heading-13">重新载入</h3>
<p>当在使用过程中，修改了自定义词典，那么可以通过<code>Jieba.reload()</code>方法重新载入。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android学习笔记-2-Activity生命周期&数据存储]]></title>    <link>https://juejin.cn/post/7599237603976577067</link>    <guid>https://juejin.cn/post/7599237603976577067</guid>    <pubDate>2026-01-26T09:49:12.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599237603976577067" data-draft-id="7599459943918747686" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android学习笔记-2-Activity生命周期&amp;数据存储"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2026-01-26T09:49:12.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="漫庭_"/> <meta itemprop="url" content="https://juejin.cn/user/1126346204126856"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android学习笔记-2-Activity生命周期&amp;数据存储
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1126346204126856/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    漫庭_
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T09:49:12.000Z" title="Mon Jan 26 2026 09:49:12 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Android学习笔记：Activity生命周期&amp;数据存储</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ec9098e4651647eabdd2e8669d5b4272~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ryr5bqtXw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770025751&amp;x-signature=2JQvz7xPfiklDXLkpgfapzhuodU%3D" alt="Activity生命周期&amp;数据存储.png" loading="lazy"/></p>
<h4 data-id="heading-1">1. Activity生命周期核心概念</h4>
<blockquote>
<p><strong>为什么生命周期如此重要？</strong><br/>
它决定了应用在不同状态下的行为，是处理内存管理、数据保存、UI更新的关键。理解它，你就能写出<strong>不崩溃、不丢失数据</strong>的Android应用。</p>
</blockquote>
<pre><code class="hljs language-mermaid" lang="mermaid">stateDiagram-v2
    [*] --&gt; Created
    Created --&gt; Started
    Started --&gt; Resumed
    Resumed --&gt; Paused
    Paused --&gt; Stopped
    Stopped --&gt; Destroyed
    Paused --&gt; Resumed
    Stopped --&gt; Started
    Resumed --&gt; Stopped
    Stopped --&gt; Destroyed
    Paused --&gt; Destroyed
</code></pre>
<p><strong>关键状态说明</strong>：</p>















































<table><thead><tr><th>状态</th><th>说明</th><th>用户可见</th><th>为什么重要</th></tr></thead><tbody><tr><td><code>Created</code></td><td>Activity创建完成</td><td>❌</td><td>初始化UI、数据</td></tr><tr><td><code>Started</code></td><td>Activity可见但未获得焦点</td><td>✅</td><td>准备显示内容</td></tr><tr><td><code>Resumed</code></td><td>Activity获得焦点，用户可交互</td><td>✅</td><td><strong>核心交互状态</strong></td></tr><tr><td><code>Paused</code></td><td>Activity失去焦点但可见（如弹出对话框）</td><td>✅</td><td>保存关键数据</td></tr><tr><td><code>Stopped</code></td><td>Activity完全不可见（如进入后台）</td><td>❌</td><td>释放非关键资源</td></tr><tr><td><code>Destroyed</code></td><td>Activity被销毁</td><td>❌</td><td>释放所有资源</td></tr></tbody></table>
<blockquote>
<p>💡 <strong>关键洞察</strong>：<br/>
<strong>用户不会等待应用完成生命周期</strong>，必须在<code>onPause()</code>保存关键数据，否则会丢失！</p>
</blockquote>
<hr/>
<h4 data-id="heading-2">2. 生命周期方法详解</h4>
<blockquote>
<p><strong>每个方法都是一个"关键时刻"</strong>，必须正确处理</p>
</blockquote>















































<table><thead><tr><th>方法</th><th>调用时机</th><th>做什么</th><th>为什么</th></tr></thead><tbody><tr><td><code>onCreate()</code></td><td>Activity首次创建</td><td>初始化UI、数据</td><td><strong>必须</strong></td></tr><tr><td><code>onStart()</code></td><td>Activity可见但未获得焦点</td><td>无需操作（通常）</td><td>通常无需处理</td></tr><tr><td><code>onResume()</code></td><td>Activity获得焦点，用户可交互</td><td>重启动画、恢复数据</td><td><strong>关键交互点</strong></td></tr><tr><td><code>onPause()</code></td><td>失去焦点（如弹出对话框）</td><td><strong>保存关键数据</strong>、暂停动画</td><td><strong>防止数据丢失</strong></td></tr><tr><td><code>onStop()</code></td><td>完全不可见（进入后台）</td><td>释放非关键资源</td><td>优化内存</td></tr><tr><td><code>onDestroy()</code></td><td>Activity被销毁</td><td>释放所有资源</td><td><strong>必须</strong></td></tr></tbody></table>
<blockquote>
<p>⚠️ <strong>新手常见错误</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 错误：在onPause()中保存数据，但未在onResume()恢复</span>
<span class="hljs-meta">@Override</span>
<span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onPause</span><span class="hljs-params">()</span> {
 <span class="hljs-comment">// 保存数据</span>
 SharedPreferences.<span class="hljs-type">Editor</span> <span class="hljs-variable">editor</span> <span class="hljs-operator">=</span> prefs.edit();
 editor.putString(<span class="hljs-string">"text"</span>, textView.getText().toString());
 editor.apply();
}

<span class="hljs-comment">// 未在onResume()恢复数据！</span>
</code></pre>
</blockquote>
<hr/>
<h4 data-id="heading-3">3. 实战：生命周期日志监控</h4>
<h5 data-id="heading-4">步骤1：修改MainActivity</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatActivity</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">TAG</span> <span class="hljs-operator">=</span> <span class="hljs-string">"ActivityLifecycle"</span>;
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(Bundle savedInstanceState)</span> {
        <span class="hljs-built_in">super</span>.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);
        Log.d(TAG, <span class="hljs-string">"onCreate()"</span>);
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onStart</span><span class="hljs-params">()</span> {
        <span class="hljs-built_in">super</span>.onStart();
        Log.d(TAG, <span class="hljs-string">"onStart()"</span>);
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onResume</span><span class="hljs-params">()</span> {
        <span class="hljs-built_in">super</span>.onResume();
        Log.d(TAG, <span class="hljs-string">"onResume()"</span>);
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onPause</span><span class="hljs-params">()</span> {
        <span class="hljs-built_in">super</span>.onPause();
        Log.d(TAG, <span class="hljs-string">"onPause()"</span>);
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onStop</span><span class="hljs-params">()</span> {
        <span class="hljs-built_in">super</span>.onStop();
        Log.d(TAG, <span class="hljs-string">"onStop()"</span>);
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onDestroy</span><span class="hljs-params">()</span> {
        <span class="hljs-built_in">super</span>.onDestroy();
        Log.d(TAG, <span class="hljs-string">"onDestroy()"</span>);
    }
}
</code></pre>
<h5 data-id="heading-5">步骤2：运行并观察Logcat</h5>
<ol>
<li>运行应用</li>
<li>点击Home键（进入后台）</li>
<li>从最近任务列表重新打开应用</li>
<li>观察Logcat输出</li>
</ol>
<p><strong>典型输出</strong>：</p>
<pre><code class="hljs language-css" lang="css">D/ActivityLifecycle: <span class="hljs-built_in">onCreate</span>()
D/ActivityLifecycle: <span class="hljs-built_in">onStart</span>()
D/ActivityLifecycle: <span class="hljs-built_in">onResume</span>()
// 点击Home键
D/ActivityLifecycle: <span class="hljs-built_in">onPause</span>()
D/ActivityLifecycle: <span class="hljs-built_in">onStop</span>()
// 重新打开应用
D/ActivityLifecycle: <span class="hljs-built_in">onStart</span>()
D/ActivityLifecycle: <span class="hljs-built_in">onResume</span>()
</code></pre>
<blockquote>
<p>💡 <strong>关键发现</strong>：<br/>
<strong>每次从后台回来，都会触发<code>onStart()</code>和<code>onResume()</code>，但不会重新调用<code>onCreate()</code></strong>。这就是为什么数据保存在<code>onPause()</code>而非<code>onCreate()</code>。</p>
</blockquote>
<hr/>
<h4 data-id="heading-6">4. 生命周期实战场景</h4>
<h5 data-id="heading-7">场景1：保存用户输入</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 在onPause()中保存数据</span>
<span class="hljs-meta">@Override</span>
<span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onPause</span><span class="hljs-params">()</span> {
    <span class="hljs-built_in">super</span>.onPause();
    
    <span class="hljs-comment">// 保存输入框内容</span>
    <span class="hljs-type">SharedPreferences</span> <span class="hljs-variable">prefs</span> <span class="hljs-operator">=</span> getSharedPreferences(<span class="hljs-string">"app_prefs"</span>, MODE_PRIVATE);
    SharedPreferences.<span class="hljs-type">Editor</span> <span class="hljs-variable">editor</span> <span class="hljs-operator">=</span> prefs.edit();
    editor.putString(<span class="hljs-string">"user_input"</span>, editText.getText().toString());
    editor.apply();
}
</code></pre>
<h5 data-id="heading-8">场景2：恢复用户输入</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 在onCreate()中恢复数据</span>
<span class="hljs-meta">@Override</span>
<span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(Bundle savedInstanceState)</span> {
    <span class="hljs-built_in">super</span>.onCreate(savedInstanceState);
    setContentView(R.layout.activity_main);
    
    <span class="hljs-comment">// 恢复输入</span>
    <span class="hljs-type">SharedPreferences</span> <span class="hljs-variable">prefs</span> <span class="hljs-operator">=</span> getSharedPreferences(<span class="hljs-string">"app_prefs"</span>, MODE_PRIVATE);
    <span class="hljs-type">String</span> <span class="hljs-variable">savedInput</span> <span class="hljs-operator">=</span> prefs.getString(<span class="hljs-string">"user_input"</span>, <span class="hljs-string">""</span>);
    editText.setText(savedInput);
}
</code></pre>
<h5 data-id="heading-9">场景3：暂停/恢复媒体播放</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> MediaPlayer mediaPlayer;

<span class="hljs-meta">@Override</span>
<span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onResume</span><span class="hljs-params">()</span> {
    <span class="hljs-built_in">super</span>.onResume();
    <span class="hljs-keyword">if</span> (mediaPlayer != <span class="hljs-literal">null</span> &amp;&amp; !mediaPlayer.isPlaying()) {
        mediaPlayer.start(); <span class="hljs-comment">// 恢复播放</span>
    }
}

<span class="hljs-meta">@Override</span>
<span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onPause</span><span class="hljs-params">()</span> {
    <span class="hljs-built_in">super</span>.onPause();
    <span class="hljs-keyword">if</span> (mediaPlayer != <span class="hljs-literal">null</span> &amp;&amp; mediaPlayer.isPlaying()) {
        mediaPlayer.pause(); <span class="hljs-comment">// 暂停播放</span>
    }
}
</code></pre>
<p>✅ <strong>避坑指南</strong>：</p>
<blockquote>
<p>🚫 <strong>不要</strong>在<code>onCreate()</code>中保存关键数据（会被重复调用）<br/>
✅ <strong>应该</strong>在<code>onPause()</code>中保存关键数据<br/>
🚫 <strong>不要</strong>在<code>onResume()</code>中初始化UI（会重复）<br/>
✅ <strong>应该</strong>在<code>onCreate()</code>中初始化UI</p>
<p>不是所有变量都需要声明为成员变量，但 UI 控件（如 EditText、Button）必须是成员变量。</p>
</blockquote>
<hr/>
<blockquote>
<p>📌 <strong>关键代码</strong>（数据保存恢复）：</p>
</blockquote>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 保存数据</span>
<span class="hljs-meta">@Override</span>
<span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onPause</span><span class="hljs-params">()</span> {
    <span class="hljs-built_in">super</span>.onPause();
    <span class="hljs-type">SharedPreferences</span> <span class="hljs-variable">prefs</span> <span class="hljs-operator">=</span> getSharedPreferences(<span class="hljs-string">"app_prefs"</span>, MODE_PRIVATE);
    SharedPreferences.<span class="hljs-type">Editor</span> <span class="hljs-variable">editor</span> <span class="hljs-operator">=</span> prefs.edit();
    editor.putString(<span class="hljs-string">"input"</span>, editText.getText().toString());
    editor.apply();
}

<span class="hljs-comment">// 恢复数据</span>
<span class="hljs-meta">@Override</span>
<span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(Bundle savedInstanceState)</span> {
    <span class="hljs-built_in">super</span>.onCreate(savedInstanceState);
    setContentView(R.layout.activity_main);
    
    <span class="hljs-type">SharedPreferences</span> <span class="hljs-variable">prefs</span> <span class="hljs-operator">=</span> getSharedPreferences(<span class="hljs-string">"app_prefs"</span>, MODE_PRIVATE);
    <span class="hljs-type">String</span> <span class="hljs-variable">savedInput</span> <span class="hljs-operator">=</span> prefs.getString(<span class="hljs-string">"input"</span>, <span class="hljs-string">""</span>);
    editText.setText(savedInput);
}
</code></pre>
<h2 data-id="heading-10">SharedPreferences 深度解析：Android 持久化存储的基石</h2>
<p>SharedPreferences 是 Android 中<strong>最常用、最轻量级的本地存储方案</strong>，用于保存<strong>简单的键值对数据</strong>（如用户偏好、登录状态、应用设置等）。</p>
<hr/>
<h3 data-id="heading-11">🔑 一、SharedPreferences 的本质</h3>





























<table><thead><tr><th>特性</th><th>说明</th></tr></thead><tbody><tr><td><strong>本质</strong></td><td>一个 <strong>XML 文件</strong>（存储在 <code>/data/data/&lt;package_name&gt;/shared_prefs/</code>）</td></tr><tr><td><strong>数据格式</strong></td><td>键值对（<code>String</code> 键 + <code>String</code>/<code>int</code>/<code>boolean</code>/<code>float</code>/<code>long</code> 值）</td></tr><tr><td><strong>存储位置</strong></td><td><strong>应用私有目录</strong>（其他应用无法访问）</td></tr><tr><td><strong>数据持久性</strong></td><td><strong>永久存储</strong>（应用卸载后才删除）</td></tr><tr><td><strong>适用场景</strong></td><td>小型数据（&lt;100KB）、非敏感数据（如用户设置）</td></tr></tbody></table>
<blockquote>
<p>💡 <strong>类比</strong>：SharedPreferences 就像一个<strong>加密的用户手册</strong>，你把关键设置写在上面，应用每次启动都能读取。</p>
</blockquote>
<hr/>
<h3 data-id="heading-12">📦 二、SharedPreferences 的核心使用场景</h3>
<h4 data-id="heading-13">场景 1：保存用户输入</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 保存输入内容（在 onPause 中）</span>
<span class="hljs-type">SharedPreferences</span> <span class="hljs-variable">prefs</span> <span class="hljs-operator">=</span> getSharedPreferences(<span class="hljs-string">"app_prefs"</span>, MODE_PRIVATE);
prefs.edit().putString(<span class="hljs-string">"user_input"</span>, editText.getText().toString()).apply();
</code></pre>
<h4 data-id="heading-14">场景 2：保存用户偏好设置</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 保存主题设置</span>
<span class="hljs-type">SharedPreferences</span> <span class="hljs-variable">prefs</span> <span class="hljs-operator">=</span> getSharedPreferences(<span class="hljs-string">"settings"</span>, MODE_PRIVATE);
prefs.edit().putBoolean(<span class="hljs-string">"dark_mode"</span>, <span class="hljs-literal">true</span>).apply();
</code></pre>
<h4 data-id="heading-15">场景 3：记录用户登录状态</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 保存登录状态</span>
<span class="hljs-type">SharedPreferences</span> <span class="hljs-variable">prefs</span> <span class="hljs-operator">=</span> getSharedPreferences(<span class="hljs-string">"auth"</span>, MODE_PRIVATE);
prefs.edit().putBoolean(<span class="hljs-string">"is_logged_in"</span>, <span class="hljs-literal">true</span>).apply();
</code></pre>
<hr/>
<h3 data-id="heading-16">⚙️ 三、SharedPreferences 的核心 API</h3>
<h4 data-id="heading-17">✅ 1. 获取 SharedPreferences 对象</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 方式 1：默认名称（推荐）</span>
<span class="hljs-type">SharedPreferences</span> <span class="hljs-variable">prefs</span> <span class="hljs-operator">=</span> getSharedPreferences(<span class="hljs-string">"app_prefs"</span>, MODE_PRIVATE);

<span class="hljs-comment">// 方式 2：自定义名称</span>
<span class="hljs-type">SharedPreferences</span> <span class="hljs-variable">prefs</span> <span class="hljs-operator">=</span> getSharedPreferences(<span class="hljs-string">"user_settings"</span>, Context.MODE_PRIVATE);
</code></pre>
<blockquote>
<p>💡 <strong>关键点</strong>：</p>
<ul>
<li><code>MODE_PRIVATE</code>：<strong>唯一安全模式</strong>（其他应用无法访问）</li>
<li>建议用常量定义名称（避免拼写错误）：
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">PREFS_NAME</span> <span class="hljs-operator">=</span> <span class="hljs-string">"app_prefs"</span>;
</code></pre>
</li>
</ul>
</blockquote>
<h4 data-id="heading-18">✅ 2. 保存数据（安全写入）</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 获取编辑器（不推荐直接用 edit()）</span>
SharedPreferences.<span class="hljs-type">Editor</span> <span class="hljs-variable">editor</span> <span class="hljs-operator">=</span> prefs.edit();

<span class="hljs-comment">// 写入数据（推荐使用 apply() 而不是 commit()）</span>
editor.putString(<span class="hljs-string">"username"</span>, <span class="hljs-string">"张三"</span>);
editor.putInt(<span class="hljs-string">"age"</span>, <span class="hljs-number">25</span>);
editor.putBoolean(<span class="hljs-string">"is_active"</span>, <span class="hljs-literal">true</span>);
editor.apply(); <span class="hljs-comment">// ✅ 异步写入，不阻塞主线程</span>
</code></pre>
<blockquote>
<p>💡 <strong>为什么用 <code>apply()</code> 而不是 <code>commit()</code>？</strong></p>




















<table><thead><tr><th>方法</th><th>特点</th><th>适用场景</th></tr></thead><tbody><tr><td><code>apply()</code></td><td><strong>异步</strong>（后台线程）</td><td><strong>99% 场景</strong>（推荐）</td></tr><tr><td><code>commit()</code></td><td><strong>同步</strong>（主线程阻塞）</td><td>仅当需要立即确认写入时</td></tr></tbody></table>
</blockquote>
<h4 data-id="heading-19">✅ 3. 读取数据</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 读取字符串（提供默认值）</span>
<span class="hljs-type">String</span> <span class="hljs-variable">username</span> <span class="hljs-operator">=</span> prefs.getString(<span class="hljs-string">"username"</span>, <span class="hljs-string">"游客"</span>);

<span class="hljs-comment">// 读取整数（提供默认值）</span>
<span class="hljs-type">int</span> <span class="hljs-variable">age</span> <span class="hljs-operator">=</span> prefs.getInt(<span class="hljs-string">"age"</span>, <span class="hljs-number">0</span>);

<span class="hljs-comment">// 读取布尔值（提供默认值）</span>
<span class="hljs-type">boolean</span> <span class="hljs-variable">isActive</span> <span class="hljs-operator">=</span> prefs.getBoolean(<span class="hljs-string">"is_active"</span>, <span class="hljs-literal">false</span>);
</code></pre>
<hr/>
<h3 data-id="heading-20">⚠️ 四、常见错误及解决方案</h3>
<h4 data-id="heading-21">❌ 错误 1：忘记检查默认值</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 错误：未提供默认值</span>
<span class="hljs-type">String</span> <span class="hljs-variable">username</span> <span class="hljs-operator">=</span> prefs.getString(<span class="hljs-string">"username"</span>, <span class="hljs-literal">null</span>); <span class="hljs-comment">// 可能返回 null</span>
editText.setText(username); <span class="hljs-comment">// NullPointerException!</span>

<span class="hljs-comment">// 正确：提供默认值</span>
<span class="hljs-type">String</span> <span class="hljs-variable">username</span> <span class="hljs-operator">=</span> prefs.getString(<span class="hljs-string">"username"</span>, <span class="hljs-string">"游客"</span>);
editText.setText(username);
</code></pre>
<h4 data-id="heading-22">❌ 错误 2：使用 <code>commit()</code> 阻塞主线程</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 错误：同步写入，可能卡顿</span>
prefs.edit().putString(<span class="hljs-string">"user_input"</span>, text).commit();

<span class="hljs-comment">// 正确：使用 apply() 异步写入</span>
prefs.edit().putString(<span class="hljs-string">"user_input"</span>, text).apply();
</code></pre>
<h4 data-id="heading-23">❌ 错误 3：键名拼写错误</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 错误：键名不一致</span>
prefs.edit().putString(<span class="hljs-string">"user_input"</span>, text).apply();

<span class="hljs-comment">// 获取时拼错</span>
<span class="hljs-type">String</span> <span class="hljs-variable">saved</span> <span class="hljs-operator">=</span> prefs.getString(<span class="hljs-string">"user_input2"</span>, <span class="hljs-string">""</span>); <span class="hljs-comment">// 会返回默认值</span>
</code></pre>
<p>✅ <strong>解决方案</strong>：使用常量定义键名</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">KEY_USER_INPUT</span> <span class="hljs-operator">=</span> <span class="hljs-string">"user_input"</span>;

<span class="hljs-comment">// 保存</span>
prefs.edit().putString(KEY_USER_INPUT, text).apply();

<span class="hljs-comment">// 读取</span>
<span class="hljs-type">String</span> <span class="hljs-variable">saved</span> <span class="hljs-operator">=</span> prefs.getString(KEY_USER_INPUT, <span class="hljs-string">""</span>);
</code></pre>
<hr/>
<h3 data-id="heading-24">📊 五、SharedPreferences vs Bundle：关键区别</h3>



































<table><thead><tr><th>特性</th><th>SharedPreferences</th><th>Bundle</th></tr></thead><tbody><tr><td><strong>生命周期</strong></td><td><strong>永久存储</strong>（应用关闭后仍保留）</td><td><strong>临时存储</strong>（仅在 Activity 生命周期内有效）</td></tr><tr><td><strong>数据范围</strong></td><td><strong>应用级全局</strong>（所有 Activity 可访问）</td><td><strong>组件级</strong>（仅在当前 Activity/Fragment 内有效）</td></tr><tr><td><strong>使用场景</strong></td><td>保存用户偏好、登录状态等</td><td>屏幕旋转时临时保存数据</td></tr><tr><td><strong>数据大小</strong></td><td>无严格限制（但建议 &lt;100KB）</td><td>限制 ~1MB</td></tr><tr><td><strong>恢复时机</strong></td><td>应用启动时自动恢复</td><td>Activity 重建时（如 <code>onCreate</code>/<code>onSaveInstanceState</code>）</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-25">🌟 六、最佳实践</h3>
<h4 data-id="heading-26">✅ 1. 使用常量定义键名（避免拼写错误）</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatActivity</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">PREFS_NAME</span> <span class="hljs-operator">=</span> <span class="hljs-string">"app_prefs"</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">KEY_USER_INPUT</span> <span class="hljs-operator">=</span> <span class="hljs-string">"user_input"</span>;
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(Bundle savedInstanceState)</span> {
        <span class="hljs-comment">// 从 SharedPreferences 读取</span>
        <span class="hljs-type">SharedPreferences</span> <span class="hljs-variable">prefs</span> <span class="hljs-operator">=</span> getSharedPreferences(PREFS_NAME, MODE_PRIVATE);
        <span class="hljs-type">String</span> <span class="hljs-variable">savedInput</span> <span class="hljs-operator">=</span> prefs.getString(KEY_USER_INPUT, <span class="hljs-string">""</span>);
        editText.setText(savedInput);
    }
}
</code></pre>
<h4 data-id="heading-27">✅ 2. 优先使用 <code>apply()</code>（避免主线程阻塞）</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ✅ 正确：异步写入</span>
<span class="hljs-type">SharedPreferences</span> <span class="hljs-variable">prefs</span> <span class="hljs-operator">=</span> getSharedPreferences(PREFS_NAME, MODE_PRIVATE);
prefs.edit().putString(KEY_USER_INPUT, editText.getText().toString()).apply();
</code></pre>
<h4 data-id="heading-28">✅ 3. 保存前检查数据</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ✅ 安全写入</span>
<span class="hljs-keyword">if</span> (editText != <span class="hljs-literal">null</span>) {
    <span class="hljs-type">String</span> <span class="hljs-variable">text</span> <span class="hljs-operator">=</span> editText.getText().toString();
    prefs.edit().putString(KEY_USER_INPUT, text).apply();
}
</code></pre>
<h4 data-id="heading-29">✅ 4. 读取时提供默认值</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ✅ 安全读取</span>
<span class="hljs-type">String</span> <span class="hljs-variable">savedInput</span> <span class="hljs-operator">=</span> prefs.getString(KEY_USER_INPUT, <span class="hljs-string">""</span>);
</code></pre>
<hr/>
<h3 data-id="heading-30">🔥 八、高级技巧：原子操作与线程安全</h3>
<h4 data-id="heading-31">1. 为什么需要原子操作？</h4>
<ul>
<li>多个线程同时修改 SharedPreferences 会导致数据覆盖</li>
<li><strong>Android 4.0+</strong> 的 <code>apply()</code> 是<strong>线程安全的</strong>（但不是原子操作）</li>
</ul>
<h4 data-id="heading-32">2. 保证原子性的方案</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 方案 1：使用 SharedPreferences.Editor 的 apply()（Android 4.0+ 推荐）</span>
prefs.edit().putString(<span class="hljs-string">"key"</span>, <span class="hljs-string">"value"</span>).apply();

<span class="hljs-comment">// 方案 2：使用锁（仅当需要严格原子性时）</span>
<span class="hljs-keyword">synchronized</span> (prefs) {
    prefs.edit().putString(<span class="hljs-string">"key"</span>, <span class="hljs-string">"value"</span>).apply();
}
</code></pre>
<blockquote>
<p>💡 <strong>重要提示</strong>：对于大多数应用，<code>apply()</code> 已足够安全，无需额外加锁。</p>
</blockquote>
<hr/>
<h3 data-id="heading-33">📌 九、常见问题解答</h3>
<h4 data-id="heading-34">❓ 问题 1：SharedPreferences 适合存储敏感数据吗？</h4>
<p><strong>❌ 不适合</strong>！它<strong>不加密</strong>，敏感数据应使用：</p>
<ul>
<li><code>EncryptedSharedPreferences</code>（Android Jetpack）</li>
<li>数据库加密（Room）</li>
</ul>
<h4 data-id="heading-35">❓ 问题 2：SharedPreferences 可以存储对象吗？</h4>
<p><strong>❌ 不能直接存储对象</strong>，但可以通过以下方式：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 方式 1：序列化（不推荐，效率低）</span>
<span class="hljs-type">String</span> <span class="hljs-variable">json</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Gson</span>().toJson(user);
prefs.edit().putString(<span class="hljs-string">"user"</span>, json).apply();

<span class="hljs-comment">// 方式 2：使用 Parcelable（推荐，但需自己实现）</span>
</code></pre>
<h4 data-id="heading-36">❓ 问题 3：如何删除 SharedPreferences？</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 删除整个 SharedPreferences</span>
getSharedPreferences(PREFS_NAME, MODE_PRIVATE).edit().clear().apply();

<span class="hljs-comment">// 删除单个键</span>
getSharedPreferences(PREFS_NAME, MODE_PRIVATE).edit().remove(<span class="hljs-string">"key"</span>).apply();
</code></pre>
<hr/>
<h3 data-id="heading-37">✅ 十、总结：SharedPreferences 的关键点</h3>





























<table><thead><tr><th>问题</th><th>答案</th></tr></thead><tbody><tr><td><strong>为什么用 SharedPreferences？</strong></td><td>保存小量、持久化的键值对数据（如用户偏好）</td></tr><tr><td><strong>如何避免崩溃？</strong></td><td>1. 检查 <code>editText</code> 是否为 null2. 提供默认值3. 使用常量键名</td></tr><tr><td><strong><code>apply()</code> vs <code>commit()</code></strong></td><td><strong>始终用 <code>apply()</code></strong>（异步，不阻塞主线程）</td></tr><tr><td><strong>与 Bundle 的关系</strong></td><td>Bundle 临时保存，SharedPreferences 永久保存</td></tr><tr><td><strong>安全使用</strong></td><td>1. 用常量定义键名2. 提供默认值3. 使用 <code>apply()</code></td></tr></tbody></table>
<hr/>
<h3 data-id="heading-38">📚 官方文档支持</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Ftraining%2Fdata-storage%2Fshared-preferences" target="_blank" title="https://developer.android.com/training/data-storage/shared-preferences" ref="nofollow noopener noreferrer">Android Developers - SharedPreferences</a></p>
<blockquote>
<p>"SharedPreferences is a simple way to store key-value pairs of primitive data types. It's ideal for storing small amounts of data, such as user preferences."</p>
</blockquote>
<hr/>
<h3 data-id="heading-39">✅ 结论</h3>
<p><strong>SharedPreferences 是 Android 中最基础、最安全的持久化存储方案</strong>。<br/>
<strong>无需再担心 <code>NullPointerException</code> 或数据丢失问题</strong>！</p>
<blockquote>
<p>💡 <strong>记住</strong>：<br/>
<code>apply()</code> + 常量键名 + 默认值 = <strong>安全可靠的 SharedPreferences 使用</strong></p>
</blockquote>
<h3 data-id="heading-40">最终代码</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.singlenews;

<span class="hljs-keyword">import</span> androidx.appcompat.app.AppCompatActivity;

<span class="hljs-keyword">import</span> android.content.SharedPreferences;
<span class="hljs-keyword">import</span> android.media.MediaPlayer;
<span class="hljs-keyword">import</span> android.os.Bundle;
<span class="hljs-keyword">import</span> android.util.Log;
<span class="hljs-keyword">import</span> android.widget.EditText;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatActivity</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">TAG</span> <span class="hljs-operator">=</span> <span class="hljs-string">"ActivityLifecycle"</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">PREFS_NAME</span> <span class="hljs-operator">=</span> <span class="hljs-string">"app_prefs"</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">USER_INPUT</span> <span class="hljs-operator">=</span> <span class="hljs-string">"user_input"</span>;

    <span class="hljs-keyword">private</span> EditText editText;
    <span class="hljs-keyword">private</span> MediaPlayer mediaPlayer;

    <span class="hljs-comment">// Activity类的onCreate方法重写。这是Activity生命周期的第一个被调用的核心方法</span>
    <span class="hljs-meta">@Override</span> <span class="hljs-comment">// 当前方法覆盖父类（Activity）中定义的同名方法。重写生命周期方法，以实现自定义逻辑</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(Bundle savedInstanceState)</span> { <span class="hljs-comment">// onCreate当Activity首次创建，系统自动调用此方法。</span>
        <span class="hljs-comment">/**
         * Bundle savedInstanceState：
         * 参数，用于恢复之前保存的状态（如屏幕旋转、内存不足时Activity被销毁重建）
         * 如果Activity是首次启动，savedInstanceState 为 null
         * 如果Activity是重建，系统会传入之前通过onSaveInstanceState()保存的数据
         *
         * Bundle 是 Android 开发中最基础、最常用的数据传递的键值对容器，用于在组件之间（Activity、Fragment、Service 等）通过 Intent安全地传递数据。
         */</span>
        <span class="hljs-built_in">super</span>.onCreate(savedInstanceState); <span class="hljs-comment">// 调用父类(Activity)的onCreate()方法。通过父类完成Activity的核心初始化。必须放在自定义之前。</span>
        setContentView(R.layout.activity_main); <span class="hljs-comment">// 加载并设置Activity的UI布局</span>
        <span class="hljs-comment">/**
         * R：Android自动生成的资源引用类
         * layout：资源类型（布局文件）
         * activity_main：布局文件名（存在于res/layout目录下activity_main.xml文件）
         */</span>
        <span class="hljs-comment">// Activity显示界面的唯一入口。系统将activity_main中的UI元素渲染到屏幕上。</span>
        <span class="hljs-comment">// 后续操作（如初始化控件、设置事件监听）通常在此方法中继续编写。</span>

        <span class="hljs-comment">// 所有Activity都必须重写onCreate!</span>

        Log.d(TAG, <span class="hljs-string">"onCreate()"</span>);

        editText = findViewById(R.id.edit_text);
        <span class="hljs-comment">// 恢复数据</span>
<span class="hljs-comment">//        SharedPreferences prefs = getSharedPreferences("app_prefs", MODE_PRIVATE);</span>
        <span class="hljs-type">SharedPreferences</span> <span class="hljs-variable">prefs</span> <span class="hljs-operator">=</span> getSharedPreferences(PREFS_NAME, MODE_PRIVATE);
<span class="hljs-comment">//        String savedInput = prefs.getString("user_input", "");</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">savedInput</span> <span class="hljs-operator">=</span> prefs.getString(USER_INPUT, <span class="hljs-string">""</span>);
        editText.setText(savedInput);
        <span class="hljs-comment">/**
         * SharedPreferences
         * SharedPreferences 是 Android 中最常用、最轻量级的本地存储方案，用于保存简单的键值对数据（如用户偏好、登录状态、应用设置等）。
         */</span>
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onStart</span><span class="hljs-params">()</span> {
        <span class="hljs-built_in">super</span>.onStart();
        Log.d(TAG, <span class="hljs-string">"onStart()"</span>);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onResume</span><span class="hljs-params">()</span> {
        <span class="hljs-built_in">super</span>.onResume();
        Log.d(TAG, <span class="hljs-string">"onResume()"</span>);

        <span class="hljs-comment">// 恢复播放</span>
        <span class="hljs-keyword">if</span>(mediaPlayer != <span class="hljs-literal">null</span> &amp;&amp; !mediaPlayer.isPlaying()){
            mediaPlayer.start();
        }
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onPause</span><span class="hljs-params">()</span> {
        <span class="hljs-built_in">super</span>.onPause();
        Log.d(TAG, <span class="hljs-string">"onPause()"</span>);

        <span class="hljs-comment">// 保存输入框内容</span>
<span class="hljs-comment">//        SharedPreferences prefs = getSharedPreferences("app_prefs", MODE_PRIVATE);</span>
        <span class="hljs-type">SharedPreferences</span> <span class="hljs-variable">prefs</span> <span class="hljs-operator">=</span> getSharedPreferences(PREFS_NAME, MODE_PRIVATE);
        SharedPreferences.<span class="hljs-type">Editor</span> <span class="hljs-variable">editor</span> <span class="hljs-operator">=</span> prefs.edit();
<span class="hljs-comment">//        editor.putString("user_input", editText.getText().toString());</span>
        editor.putString(USER_INPUT, editText.getText().toString());
        editor.apply(); <span class="hljs-comment">// apply() 是异步安全的，不会阻塞主线程</span>

        <span class="hljs-comment">// 暂停播放</span>
        <span class="hljs-keyword">if</span>(mediaPlayer != <span class="hljs-literal">null</span> &amp;&amp; mediaPlayer.isPlaying()){
            mediaPlayer.pause();
        }
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onStop</span><span class="hljs-params">()</span> {
        <span class="hljs-built_in">super</span>.onStop();
        Log.d(TAG, <span class="hljs-string">"onStop()"</span>);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onDestroy</span><span class="hljs-params">()</span> {
        <span class="hljs-built_in">super</span>.onDestroy();
        Log.d(TAG, <span class="hljs-string">"onDestroy()"</span>);
    }
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[学习OpenGL——第九天]]></title>    <link>https://juejin.cn/post/7599469598883233807</link>    <guid>https://juejin.cn/post/7599469598883233807</guid>    <pubDate>2026-01-26T08:54:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599469598883233807" data-draft-id="7599474528238551080" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="学习OpenGL——第九天"/> <meta itemprop="keywords" content="OpenGL"/> <meta itemprop="datePublished" content="2026-01-26T08:54:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Kimoro"/> <meta itemprop="url" content="https://juejin.cn/user/3889451248137260"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            学习OpenGL——第九天
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3889451248137260/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Kimoro
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T08:54:10.000Z" title="Mon Jan 26 2026 08:54:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">基础光照</h2>
<p>现实世界的光照极其复杂，受多种因素影响，难以用有限的计算资源完整模拟。因此，OpenGL 采用简化模型近似真实光照，既易于实现，视觉效果也较为真实。这些光照模型基于对光的物理特性理解，其中最常用的是 Phong 光照模型。该模型包含三个主要分量：</p>
<ul>
<li>环境光（Ambient）</li>
<li>漫反射（Diffuse）</li>
<li>镜面光（Specular）</li>
</ul>
<p>下图展示了这些光照分量的视觉效果：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/69b9ce1417fb4ee588223e56844f7130~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgS2ltb3Jv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770022450&amp;x-signature=KF3SBXSAEPxjO7lZQvYD7r17LM8%3D" alt="image.png" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-1">Phong 光照模型三大分量</h3>
<ul>
<li>环境光照（Ambient Lighting）即使在黑暗环境中，世界上也总有一些微弱光线，因此物体几乎不会完全黑暗。通过设置环境光照常量，为物体提供基础色彩。</li>
<li>漫反射光照（Diffuse Lighting）模拟光源对物体的方向性影响，是视觉上最显著的部分。物体表面越正对光源，亮度越高。</li>
<li>镜面光照（Specular Lighting）模拟有光泽物体表面出现的高光点。镜面光的颜色通常更接近光源色，而非物体本身颜色。</li>
</ul>
<hr/>
<h2 data-id="heading-2">环境光</h2>
<p>在现实中，光线通常来自四面八方，经由多次反射间接影响物体。这种现象称为全局照明（Global Illumination），但其计算复杂且资源消耗大。</p>
<p>为简化处理，常用环境光照近似全局照明。只需将一个较小的常量光照颜色添加到物体片段的最终颜色中，即使无直接光源，场景也不会全黑。</p>
<p>实现方式：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> { 
    <span class="hljs-type">float</span> ambientStrength = <span class="hljs-number">0.1</span>; 
    vec3 ambient = ambientStrength * lightColor; 
    vec3 result = ambient * objectColor; 
    FragColor = vec4(result, <span class="hljs-number">1.0</span>); 
}
</code></pre>
<hr/>
<h2 data-id="heading-3">漫反射</h2>
<p>环境光不足以展现真实感，漫反射光照可以让物体根据光源方向产生明暗变化。与光线方向越接近的片段，亮度越高。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b1d101cc95bc4d068946207c6b0a6dc9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgS2ltb3Jv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770022450&amp;x-signature=Kr9zlapsE96gVEDsLNBrDVrQXJg%3D" alt="image.png" loading="lazy"/></p>
<p>计算方法：</p>
<ol>
<li>法向量（Normal Vector）：垂直于片段表面的单位向量。</li>
<li>光照方向向量：光源位置与片段位置的差向量。</li>
</ol>
<blockquote>
<p>注意：向量需标准化为单位向量，才能正确反映夹角余弦。</p>
</blockquote>
<p>代码示例：</p>
<pre><code class="hljs language-c" lang="c">vec3 norm = normalize(Normal); 
vec3 lightDir = normalize(lightPos - FragPos); 
<span class="hljs-type">float</span> diff = max(dot(norm, lightDir), <span class="hljs-number">0.0</span>); 
vec3 diffuse = diff * lightColor;
</code></pre>
<ul>
<li>点乘值越大，漫反射分量越强。</li>
<li>使用 max 保证分量不为负数，避免无定义的负光照。</li>
</ul>
<p>最终颜色合成：</p>
<pre><code class="hljs language-c" lang="c">vec3 result = (ambient + diffuse) * objectColor;
FragColor = vec4(result, <span class="hljs-number">1.0</span>);
</code></pre>
<hr/>
<h3 data-id="heading-4">关于法向量变换</h3>
<ul>
<li>法向量仅表示方向，无空间位置，也无齐次坐标（w 分量）。</li>
<li>位移不应影响法向量，变换时应仅保留模型矩阵的左上角 3×3 部分（旋转和缩放）。</li>
<li>不等比缩放会破坏法向量的垂直性，需使用法线矩阵（Normal Matrix）进行修正：</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/465f1d2035324467a187fe2b4b4b5afe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgS2ltb3Jv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770022450&amp;x-signature=r4iNgyBfWuFQP%2BxoYV%2BzviZH8W0%3D" alt="image.png" loading="lazy"/></p>
<p>法线矩阵定义： 模型矩阵左上角 3×3 的逆矩阵的转置。</p>
<p>代码实现：</p>
<p><code>Normal = mat3(transpose(inverse(model))) * aNormal;</code></p>
<blockquote>
<p>矩阵求逆开销较大，建议在 CPU 端计算后通过 uniform 传递给着色器。</p>
</blockquote>
<hr/>
<h2 data-id="heading-5">镜面光</h2>
<p>镜面光照不仅依赖光照方向与法向量，还与观察方向相关，决定于表面的反射特性。如下图所示：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/587b3755c4e44c85b80fb0e9d01f5b2a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgS2ltb3Jv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770022450&amp;x-signature=MJzdtjJrWC7l77QRCUqDZjjv3xI%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li>通过法向量翻折入射光方向，得到反射向量。</li>
<li>反射向量与观察方向越接近，镜面高光越明显。</li>
</ul>
<p>计算步骤：</p>
<ol>
<li>定义镜面强度：</li>
</ol>
<p><code>float specularStrength = 0.5;</code></p>
<ol start="2">
<li>计算视线方向和反射方向：</li>
</ol>
<pre><code class="hljs language-c" lang="c">vec3 viewDir = normalize(viewPos - FragPos); 
vec3 reflectDir = reflect(-lightDir, norm);
</code></pre>
<ol start="3">
<li>计算镜面分量：</li>
</ol>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">float</span> spec = <span class="hljs-built_in">pow</span>(max(dot(viewDir, reflectDir), <span class="hljs-number">0.0</span>), <span class="hljs-number">32</span>); 
vec3 specular = specularStrength * spec * lightColor;
</code></pre>
<ul>
<li>
<ul>
<li>32 为反光度（Shininess），值越大高光越集中。</li>
</ul>
</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/33fcd068754e494caeb27872149f387f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgS2ltb3Jv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770022450&amp;x-signature=ZPTTRsvVO2kf4%2Bd0gmET7N54EWs%3D" alt="image.png" loading="lazy"/></p>
<blockquote>
<p>早期光照多在顶点着色器实现，效率高但不够真实。</p>
<p>顶点插值光照称为 Gouraud 着色，片段级光照称为 Phong 着色，后者效果更平滑自然。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f2a18957f9564dbf893c55f4e01ab876~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgS2ltb3Jv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770022450&amp;x-signature=Kr0k1OKMZQuaPQ3Evq9DRD3Nms8%3D" alt="image.png" loading="lazy"/></p>
</blockquote>
<hr/>
<h2 data-id="heading-6">观察空间 VS 世界空间 —— 计算 Phong 光照</h2>
<h3 data-id="heading-7">世界空间</h3>
<ul>
<li>全局坐标系：所有物体的统一参考系</li>
<li>特点：</li>
<li>
<ul>
<li>原点固定在世界某一点</li>
<li>物体通过模型变换（平移、旋转、缩放）放置其中</li>
<li>光源位置通常在世界空间定义</li>
</ul>
</li>
</ul>
<h3 data-id="heading-8">观察空间</h3>
<ul>
<li>相机坐标系：以摄像机为中心的坐标系</li>
<li>特点：</li>
<li>
<ul>
<li>原点在摄像机位置</li>
<li>Z 轴通常指向观察方向（OpenGL 为 -Z，DirectX 为 +Z）</li>
<li>通过视图矩阵从世界空间转换而来</li>
</ul>
</li>
</ul>
<hr/>













































<table><thead><tr><th/><th/><th/></tr></thead><tbody><tr><td>特性</td><td>观察空间</td><td>世界空间</td></tr><tr><td>视线计算</td><td>简单（相机在原点）</td><td>需要相机位置</td></tr><tr><td>光源处理</td><td>需转换到观察空间</td><td>直接使用</td></tr><tr><td>调试便利性</td><td>较差</td><td>较好</td></tr><tr><td>与投影结合</td><td>直接</td><td>需额外步骤</td></tr><tr><td>性能</td><td>通常更优</td><td>略差</td></tr><tr><td>现代应用</td><td>更常见</td><td>特定场景</td></tr></tbody></table></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[详细教程测试VPS的CPU性能，简单实用的全方位指南]]></title>    <link>https://juejin.cn/post/7599294170000670771</link>    <guid>https://juejin.cn/post/7599294170000670771</guid>    <pubDate>2026-01-26T09:33:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599294170000670771" data-draft-id="7599485473707524134" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="详细教程测试VPS的CPU性能，简单实用的全方位指南"/> <meta itemprop="keywords" content="架构"/> <meta itemprop="datePublished" content="2026-01-26T09:33:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="junction"/> <meta itemprop="url" content="https://juejin.cn/user/3511177855119472"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            详细教程测试VPS的CPU性能，简单实用的全方位指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3511177855119472/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    junction
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T09:33:19.000Z" title="Mon Jan 26 2026 09:33:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>1.摘要</strong></h2>
<p>如果你刚刚购买了一台VPS，看到商家的配置标明有“4核CPU”和“高性能处理器”，你可能会想，这台机器的性能应该不错。然而，实际使用过程中，你可能会遇到一些问题：网站加载缓慢，应用响应迟缓，甚至SSH连接也变得卡顿。这种情况可能会让你怀疑，商家提供的配置是否真实，或者说是否有“超售”的问题。</p>
<p>VPS（虚拟私人服务器）与我们家里的物理电脑有很大区别。我们无法直接打开机器检查硬件，也不能随便拆解一台VPS。相较于物理机，VPS的性能评估要复杂一些。幸运的是，我们可以通过一些简单的方法和工具来<strong>测试VPS的CPU性能</strong>，甚至是对Linux小白也十分友好。</p>
<h3 data-id="heading-1"><strong>2.为什么VPS的CPU性能判断麻烦？</strong></h3>
<p>在我们探讨具体的测试方法之前，首先需要理解为何测试VPS的CPU性能比在自己电脑上测试要麻烦得多。关键在于VPS的独特性质。</p>
<h3 data-id="heading-2"><strong>2.1VPS与物理机的区别</strong></h3>
<p>在你家里的电脑，CPU是属于你个人使用的，性能几乎完全由你控制。但VPS就不同了，它是在一台大服务器上通过虚拟化技术分割出来的多个小部分。这意味着你的VPS可能与其他用户共享同一颗物理CPU。</p>
<p>如果同一台物理服务器上的其他VPS也在高负载运行，导致整体性能下降，你的VPS性能也会受到影响。这就是所谓的共享CPU与独享CPU的区别。</p>
<h3 data-id="heading-3"><strong>2.2超售现象</strong></h3>
<p>更麻烦的是，不少商家为了提高利润，可能会采用超售策略。举个例子，一台物理服务器有32个CPU核心，商家可能会开设40、50台，甚至更多的VPS，每台VPS标明为1核心。理论上每台VPS确实有1核，但实际情况是，这1核心需要与其他很多VPS共享。这就导致了性能下降，尤其在高峰期，VPS可能完全无法满足使用需求。</p>
<h3 data-id="heading-4"><strong>2.3CPU资源被“偷走”</strong></h3>
<p>在VPS的世界里，还存在一个常见的现象叫做<strong>CPU Steal Time</strong>。简单来说，CPU Steal Time就是你需要使用CPU时，发现物理服务器正在处理其他VPS的请求，导致你的VPS要等很长时间才能获得CPU资源。</p>
<p>如果CPU Steal Time过高，即使商家标明你的VPS有4核CPU，实际可用的性能可能连1核都不到。</p>
<h2 data-id="heading-5">3.如何查看VPS的CPU基础信息？</h2>
<p>在开始跑分之前，我们首先得了解VPS的<strong>基本CPU信息</strong>。这个过程非常简单，只需要几个命令就能搞定。</p>
<h3 data-id="heading-6"><strong>3.1查看VPS的CPU信息</strong></h3>
<p>连接到你的VPS，然后输入以下命令查看<strong>CPU的详细信息</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cat</span> /proc/cpuinfo
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/afcd1a07c81a47c695eacbc205aa05fe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAganVuY3Rpb24=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770024804&amp;x-signature=exAGJIOpftPPPWXauCD8CogIrqI%3D" alt="picture" loading="lazy"/>也可以使用下面的<strong>命令简化输出</strong>：</p>
<pre><code class="hljs">lscpu
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/053dcdc236a14011b4465905f7f88f81~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAganVuY3Rpb24=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770024804&amp;x-signature=Z%2BqAlnlnNEPYfdTvq4VP7ONL14M%3D" alt="picture" loading="lazy"/></p>
<p><strong>关注以下几个参数</strong>：</p>
<ul>
<li><strong>CPU型号（Model name）</strong> ：这个字段最重要，直接关系到你使用的是哪种CPU。比如Intel Xeon或AMD EPYC系列都是比较常见的服务器CPU。如果你看到的是“Intel Core i3”或者“Intel Celeron”，那就得注意了，消费级的CPU性能一般不如服务器级别的处理器。</li>
<li><strong>CPU核心数（CPUs）</strong> ：这里显示的是你的VPS分配的虚拟核心数，注意，这并不等于物理CPU的核心数，因为一个物理核心可以被虚拟成多个vCPU。</li>
<li><strong>CPU主频（CPU MHz）</strong> ：主频越高，CPU的计算能力就越强，但在VPS中，这个数值可能会因为负载不同而有所波动。</li>
<li><strong>CPU缓存（Cache）</strong> ：缓存越大，CPU处理数据的效率越高。如果缓存较小，说明可能是比较老的CPU或者低端型号。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/59631b28ed1141d9b3f2de872f4567fd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAganVuY3Rpb24=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770024804&amp;x-signature=%2BaFXFRLuTwFJRPaPbrRahZG8QZM%3D" alt="picture" loading="lazy"/></p>
<h2 data-id="heading-7"><strong>4.使用Sysbench工具测试VPS的CPU性能</strong></h2>
<p>了解了基本信息后，我们就可以通过一些实际的测试工具来测试VPS的CPU性能了。这里，我推荐使用<strong>sysbench</strong>工具，因为它简单、直观，并且能够反映出CPU的真实性能。</p>
<h3 data-id="heading-8"><strong>4.1安装Sysbench</strong></h3>
<p>大部分Linux系统都可以通过包管理器直接安装sysbench：</p>
<ul>
<li>
<p>对于<strong>Ubuntu/Debian系统</strong>：</p>
<pre><code class="hljs language-sql" lang="sql">sudo apt <span class="hljs-keyword">update</span>
sudo apt install sysbench <span class="hljs-operator">-</span>y
</code></pre>
</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0b9de1778c854f908160559dad8f63cb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAganVuY3Rpb24=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770024804&amp;x-signature=sYXenLyivir1MWe%2Bvk1jRiO%2FezY%3D" alt="picture" loading="lazy"/></p>
<ul>
<li>对于<strong>CentOS系统</strong>：</li>
</ul>

<pre><code class="hljs">sudo yum install sysbench -y
</code></pre>
<p>安装完成后，执行以下命令来确认安装成功：</p>
<pre><code class="hljs language-css" lang="css">sysbench <span class="hljs-attr">--version</span>
</code></pre>
<h3 data-id="heading-9"><strong>4.2运行Sysbench CPU性能测试</strong></h3>
<p>一旦sysbench安装完成，接下来我们就可以进行CPU性能的测试了。输入以下命令进行单核性能测试：</p>
<pre><code class="hljs language-ini" lang="ini">sysbench cpu <span class="hljs-attr">--threads</span>=<span class="hljs-number">1</span> run
</code></pre>
<p>这条命令会让CPU进行<strong>质数计算</strong>，默认情况下计算到10000以内的质数，测试时间为10秒。运行结果会提供“events per second”的数据，它代表每秒CPU完成的计算任务数。数字越大，说明CPU性能越好。</p>
<p><strong>说明：Events per second</strong>，这个数字表示<strong>每秒钟CPU能够完成多少次计算任务</strong>。<strong>数字越大，说明CPU性能越强</strong>。例如，1000次事件每秒的CPU性能相对来说是中等水平，适合处理小型应用；而超过2000次的CPU则表现非常优秀，能够处理大负载任务。</p>
<h3 data-id="heading-10"><strong>4.3测试多核性能</strong></h3>
<p>如果你的VPS是多核的，你也可以测试其多核性能：</p>
<pre><code class="hljs language-ini" lang="ini">sysbench cpu <span class="hljs-attr">--threads</span>=$(nproc) run
</code></pre>
<p>这里的<code>$(nproc)</code><strong>会自动获取VPS的核心数</strong>。理想情况下，多核的测试结果应该是单核性能的几倍。例如，4核VPS应该是单核性能的4倍左右。如果性能倍增不明显，那么就说明VPS的多核性能受到了限制，可能是因为商家超售或物理机的资源分配不合理。</p>
<h3 data-id="heading-11"><strong>4.4不同参数的测试差异</strong></h3>
<p>需要注意的是，<strong>sysbench工具</strong>可以调整测试的难度。例如，默认情况下计算的是10000以内的质数，但你也可以增加难度，计算更大的质数，如20000。这样做会使CPU的负载增加，测试结果会大幅下降。我个人建议使用sysbench工具默认参数进行测试，因为大多数人都使用这个标准，这样更方便比较不同VPS的性能。因为<strong>CPU性能会受到物理机负载的影响</strong>，我建议用户你至少<strong>测试3-4次</strong>，每次在不同的时间段测试。如果结果始终稳定，那就说明VPS性能较为稳定。如果测试结果波动很大，那么你很可能遇到了超售或资源争用的情况。</p>
<h2 data-id="heading-12"><strong>5.如何判断VPS性能是否合格？</strong></h2>
<p>VPS的性能合格与否，要根据你的使用需求来判断。一般来说，个人博客、小型网站的单核性能在500到1000之间就足够了。如果你的需求比较复杂，比如运行API服务或者中型网站，那么单核性能至少要1200以上。最重要的一点是：<strong>稳定性</strong>。宁愿选择一个稳定的VPS，哪怕它的性能稍低，也比那种性能时好时坏的VPS更值得选择。</p>
<h2 data-id="heading-13"><strong>6.进一步检测：CPU Steal Time</strong></h2>
<p>除了测试CPU性能，我们还需要关注<strong>CPU Steal Time</strong>。如果你的VPS经常出现高Steal Time，说明它经常在等待CPU资源，可能是因为超售太严重。你可以通过<code>top</code>命令查看Steal Time：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-attribute">top</span>
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cd1a4958287f474f906f56b3241dd2a2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAganVuY3Rpb24=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770024804&amp;x-signature=dA%2FupeHIKMR5c7qp%2Fz1zxkk5KX0%3D" alt="picture" loading="lazy"/></p>
<p>如果在第三行看到<code>st</code>字段值较高，那么你的VPS可能受到了超售影响。Steal Time超过10%说明你的VPS性能已经受到了较大影响。</p>
<h2 data-id="heading-14"><strong>7.总结</strong></h2>
<p>测试VPS的CPU性能其实很简单，只需要几步就可以全面了解你的VPS性能：</p>
<ol>
<li>用<code>lscpu</code>查看<strong>基础信息</strong>；</li>
<li>使用<code>sysbench</code>工具测试<strong>单核和多核性能</strong>；</li>
<li>使用<code>top</code>查看<strong>CPU Steal Time</strong>，检查<strong>超售情况</strong>。</li>
</ol>
<p>通过这些硬指标测试，你可以有效过滤掉那些性能不达标的劣质机器。与其在不稳定的服务器上浪费时间调试，不如把目光投向更成熟的方案。市面上入门级价位段中，<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.vmrack.net%2F%3Faffid%3Djuejin" target="_blank" title="https://www.vmrack.net/?affid=juejin" ref="nofollow noopener noreferrer">VMRack</a>和<a href="https://link.juejin.cn?target=https%3A%2F%2Fvpszhijia.com%2Fracknerd-zenmeyang" target="_blank" title="https://vpszhijia.com/racknerd-zenmeyang" ref="nofollow noopener noreferrer">RackNerd</a> 都是由于在同等选择区间内下表现相对稳定，从而被很多开发者列入备选清单。当然，任何服务商都建议先月付实测，满意再续。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[使用 C# 创建 Word 文档的简易教程（快速上手）]]></title>    <link>https://juejin.cn/post/7599294170000703539</link>    <guid>https://juejin.cn/post/7599294170000703539</guid>    <pubDate>2026-01-26T09:41:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599294170000703539" data-draft-id="7599459943918845990" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="使用 C# 创建 Word 文档的简易教程（快速上手）"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-26T09:41:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="LSTM97"/> <meta itemprop="url" content="https://juejin.cn/user/2253353867033484"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            使用 C# 创建 Word 文档的简易教程（快速上手）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2253353867033484/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    LSTM97
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T09:41:58.000Z" title="Mon Jan 26 2026 09:41:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在现代软件开发中，生成文档自动化变得越来越重要。借助像 Spire.Doc for .NET 这样的库，我们可以轻松地在 C# 中创建和操作 Word 文档。本文将介绍如何使用 Spire.Doc 创建一个简单的 Word 文档，涉及到标题、段落等文本元素的添加。</p>
<h2 data-id="heading-0">Spire.Doc for .NET 简介</h2>
<p>Spire.Doc 是一款功能强大的 .NET 文档处理组件，它允许开发者在 C# 和 VB.NET 中创建、读取、编辑和保存 Word 文档。该库支持多种格式，包括 DOC、DOCX、HTML 和 PDF。用户可以简单地通过代码来控制文档的内容和样式，进而生成满足需求的文档。</p>
<h2 data-id="heading-1">NuGet 安装</h2>
<p>要在项目中使用 Spire.Doc，你可以通过 NuGet 包管理器轻松安装。只需在命令行中输入以下命令：</p>
<pre><code class="hljs">Install-Package Spire.Doc
</code></pre>
<p>安装完成后，你就可以开始使用 Spire.Doc 创建 Word 文档了。</p>
<h2 data-id="heading-2">示例代码</h2>
<p>下面的代码示例展示了如何使用 C# 和 Spire.Doc 创建一个包含标题和段落的简单 Word 文档。</p>
<pre><code class="hljs language-ini" lang="ini">using Spire.Doc<span class="hljs-comment">;</span>
using Spire.Doc.Documents<span class="hljs-comment">;</span>
using Spire.Doc.Fields<span class="hljs-comment">;</span>
using System.Drawing<span class="hljs-comment">;</span>

namespace CreateSimpleWordDocument
{
    class Program
    {
        static void Main(string<span class="hljs-section">[]</span> args)
        {
            // 创建Document对象
            Document <span class="hljs-attr">document</span> = new Document()<span class="hljs-comment">;</span>

            // 添加节
            Section <span class="hljs-attr">section</span> = document.AddSection()<span class="hljs-comment">;</span>

            // 设置页边距
            <span class="hljs-attr">section.PageSetup.Margins.All</span> = <span class="hljs-number">60</span>f<span class="hljs-comment">;</span>

            // 添加一个标题段落
            Paragraph <span class="hljs-attr">title_para</span> = section.AddParagraph()<span class="hljs-comment">;</span>
            TextRange <span class="hljs-attr">textRange</span> = title_para.AppendText(<span class="hljs-string">"这是标题"</span>)<span class="hljs-comment">;</span>
            title_para.ApplyStyle(BuiltinStyle.Title)<span class="hljs-comment">;</span>
            <span class="hljs-attr">textRange.CharacterFormat.FontName</span> = <span class="hljs-string">"宋体"</span><span class="hljs-comment">;</span>

            // 添加几个小标题段落
            string<span class="hljs-section">[]</span> <span class="hljs-attr">headings</span> = { <span class="hljs-string">"这是标题1"</span>, <span class="hljs-string">"这是标题2"</span>, <span class="hljs-string">"这是标题3"</span>, <span class="hljs-string">"这是标题4"</span> }<span class="hljs-comment">;</span>
            for (int <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; headings.Length; i++)</span>
            {
                Paragraph <span class="hljs-attr">heading</span> = section.AddParagraph()<span class="hljs-comment">;</span>
                <span class="hljs-attr">textRange</span> = heading.AppendText(headings[i])<span class="hljs-comment">;</span>
                heading.ApplyStyle((BuiltinStyle)((int)BuiltinStyle.Heading1 + i))<span class="hljs-comment">;</span>
                <span class="hljs-attr">textRange.CharacterFormat.FontName</span> = <span class="hljs-string">"宋体"</span><span class="hljs-comment">;</span>
            }

            // 添加一个段落
            Paragraph <span class="hljs-attr">normal_para</span> = section.AddParagraph()<span class="hljs-comment">;</span>
            normal_para.AppendText("这是一个段落。")<span class="hljs-comment">;</span>

            // 创建段落样式
            ParagraphStyle <span class="hljs-attr">style</span> = new ParagraphStyle(document)<span class="hljs-comment">;</span>
            <span class="hljs-attr">style.Name</span> = <span class="hljs-string">"paraStyle"</span><span class="hljs-comment">;</span>
            <span class="hljs-attr">style.CharacterFormat.FontName</span> = <span class="hljs-string">"宋体"</span><span class="hljs-comment">;</span>
            <span class="hljs-attr">style.CharacterFormat.FontSize</span> = <span class="hljs-number">13</span>f<span class="hljs-comment">;</span>
            <span class="hljs-attr">style.CharacterFormat.TextColor</span> = Color.Brown<span class="hljs-comment">;</span>
            document.Styles.Add(style)<span class="hljs-comment">;</span>

            // 将自定义样式应用到指定段落
            normal_para.ApplyStyle("paraStyle")<span class="hljs-comment">;</span>

            // 保存文档
            document.SaveToFile("AddText.docx", FileFormat.Docx)<span class="hljs-comment">;</span>

            // 释放资源
            document.Dispose()<span class="hljs-comment">;</span>
        }
    }
}
</code></pre>
<h3 data-id="heading-3">代码详解</h3>
<ol>
<li>
<p><strong>创建 Document 对象</strong> ：首先，我们实例化一个 <code>Document</code> 对象，这是文档的核心。</p>
</li>
<li>
<p><strong>添加节</strong> ：使用 <code>AddSection()</code> 方法，我们可以向文档添加新的节。</p>
</li>
<li>
<p><strong>设置页面边距</strong> ：使用 <code>PageSetup.Margins</code> 属性可以轻松设置页边距。</p>
</li>
<li>
<p><strong>添加标题和段落</strong> ：</p>
</li>
</ol>
<ul>
<li>我们可以通过 <code>AddParagraph()</code> 方法添加段落，并利用 <code>AppendText()</code> 方法添加文本。</li>
<li>Spire.Doc 允许使用内置样式，通过 <code>ApplyStyle()</code> 方法为段落应用不同的样式。</li>
</ul>
<ol start="5">
<li>
<p><strong>自定义段落样式</strong> ：使用 <code>ParagraphStyle</code> 类，我们可以定义自己的段落样式并应用到段落上。</p>
</li>
<li>
<p><strong>保存文档</strong> ：最后，我们使用 <code>SaveToFile()</code> 方法将文档保存为 <code>.docx</code> 格式。</p>
</li>
</ol>
<h3 data-id="heading-4">更多功能</h3>
<p>如果想要了解如何在 Word 文档中添加图片、列表等更复杂的元素，可以参考 Spire.Doc 的在线教程。这些教程涵盖了库的更多先进功能，帮助你更好地掌握文档生成的技术。</p>
<h2 data-id="heading-5">结论</h2>
<p>通过本文的介绍，你应该能够使用 C# 和 Spire.Doc 创建一个包含基本元素的 Word 文档。无论是生成报告、合同或其他任何文档，Spire.Doc 都提供了丰富的功能，满足各种需求。继续探索更多特性，你将能创建出更加复杂和专业的文档。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[# Flutter Dio 网络请求库使用教程]]></title>    <link>https://juejin.cn/post/7599469598883643407</link>    <guid>https://juejin.cn/post/7599469598883643407</guid>    <pubDate>2026-01-26T09:58:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599469598883643407" data-draft-id="7599220371666501672" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="# Flutter Dio 网络请求库使用教程"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-26T09:58:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="卖火箭的小男孩"/> <meta itemprop="url" content="https://juejin.cn/user/4457847613830523"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            # Flutter Dio 网络请求库使用教程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4457847613830523/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    卖火箭的小男孩
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T09:58:42.000Z" title="Mon Jan 26 2026 09:58:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Dio 是 Flutter 中最强大、最流行的 Dart HTTP 客户端库，提供了拦截器、全局配置、FormData、文件上传/下载、请求取消、超时等高级功能。</p>
<h2 data-id="heading-0">1. 安装与初始化</h2>
<h3 data-id="heading-1">1.1 添加依赖</h3>
<p>在 <code>pubspec.yaml</code> 文件中添加 dio 依赖：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">dependencies:</span>
  <span class="hljs-attr">dio:</span> <span class="hljs-string">^5.4.1</span> <span class="hljs-comment"># 请使用最新版本</span>
</code></pre>
<p>运行 <code>flutter pub get</code> 安装依赖。</p>
<h3 data-id="heading-2">1.2 创建 Dio 实例</h3>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">import</span> <span class="hljs-string">'package:dio/dio.dart'</span>;

<span class="hljs-comment">// 方法一：创建实例时配置</span>
Dio dio = Dio(
  BaseOptions(
    baseUrl: <span class="hljs-string">"https://api.example.com"</span>,
    connectTimeout: <span class="hljs-built_in">Duration</span>(seconds: <span class="hljs-number">5</span>),
    receiveTimeout: <span class="hljs-built_in">Duration</span>(seconds: <span class="hljs-number">3</span>),
    headers: {
      <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'application/json'</span>,
    },
  ),
);

<span class="hljs-comment">// 方法二：创建后配置</span>
Dio dio = Dio();
<span class="hljs-keyword">void</span> configureDio() {
  dio.options.baseUrl = <span class="hljs-string">'https://api.example.com'</span>;
  dio.options.connectTimeout = <span class="hljs-built_in">Duration</span>(seconds: <span class="hljs-number">5</span>);
  dio.options.receiveTimeout = <span class="hljs-built_in">Duration</span>(seconds: <span class="hljs-number">3</span>);
}
</code></pre>
<p><strong>建议</strong>：在项目中通常使用单例模式管理 Dio 实例。</p>
<h2 data-id="heading-3">2. 发起 HTTP 请求</h2>
<h3 data-id="heading-4">2.1 GET 请求</h3>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">try</span> {
  <span class="hljs-comment">// 方式一：查询参数拼接在URL中</span>
  Response response = <span class="hljs-keyword">await</span> dio.<span class="hljs-keyword">get</span>(<span class="hljs-string">"/user?id=123"</span>);
  <span class="hljs-built_in">print</span>(response.data);
  
  <span class="hljs-comment">// 方式二：使用 queryParameters 参数（推荐）</span>
  Response response2 = <span class="hljs-keyword">await</span> dio.<span class="hljs-keyword">get</span>(
    <span class="hljs-string">"/test"</span>,
    queryParameters: {<span class="hljs-string">'id'</span>: <span class="hljs-number">12</span>, <span class="hljs-string">'name'</span>: <span class="hljs-string">'dio'</span>},
  );
  <span class="hljs-built_in">print</span>(response2.data.toString());
} <span class="hljs-keyword">on</span> DioException <span class="hljs-keyword">catch</span> (e) {
  <span class="hljs-built_in">print</span>(e.message);
}
</code></pre>
<h3 data-id="heading-5">2.2 POST 请求</h3>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">try</span> {
  <span class="hljs-comment">// 发送 JSON 数据</span>
  Response response = <span class="hljs-keyword">await</span> dio.post(
    <span class="hljs-string">"/user"</span>,
    data: {<span class="hljs-string">'name'</span>: <span class="hljs-string">'John'</span>, <span class="hljs-string">'age'</span>: <span class="hljs-number">25</span>},
  );
  
  <span class="hljs-comment">// 发送 FormData</span>
  FormData formData = FormData.fromMap({
    <span class="hljs-string">'name'</span>: <span class="hljs-string">'dio'</span>,
    <span class="hljs-string">'date'</span>: <span class="hljs-built_in">DateTime</span>.now().toIso8601String(),
  });
  Response formResponse = <span class="hljs-keyword">await</span> dio.post(<span class="hljs-string">'/info'</span>, data: formData);
  
  <span class="hljs-built_in">print</span>(response.data);
} <span class="hljs-keyword">on</span> DioException <span class="hljs-keyword">catch</span> (e) {
  <span class="hljs-built_in">print</span>(e.message);
}
</code></pre>
<h3 data-id="heading-6">2.3 其他请求方法</h3>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// PUT 请求 - 更新资源</span>
<span class="hljs-keyword">await</span> dio.put(<span class="hljs-string">"/user/123"</span>, data: {<span class="hljs-string">"name"</span>: <span class="hljs-string">"john doe"</span>});

<span class="hljs-comment">// DELETE 请求 - 删除资源</span>
<span class="hljs-keyword">await</span> dio.delete(<span class="hljs-string">"/user/123"</span>);

<span class="hljs-comment">// PATCH 请求 - 部分更新资源</span>
<span class="hljs-keyword">await</span> dio.patch(<span class="hljs-string">"/user/123"</span>, data: {<span class="hljs-string">"name"</span>: <span class="hljs-string">"johnny"</span>});

<span class="hljs-comment">// HEAD 请求 - 获取头部信息</span>
Response headResponse = <span class="hljs-keyword">await</span> dio.head(<span class="hljs-string">"/user/123"</span>);
<span class="hljs-built_in">print</span>(headResponse.headers);

<span class="hljs-comment">// OPTIONS 请求 - 获取通信选项</span>
Response optionsResponse = <span class="hljs-keyword">await</span> dio.options(<span class="hljs-string">"/user/123"</span>);
</code></pre>
<h2 data-id="heading-7">3. 响应处理</h2>
<h3 data-id="heading-8">3.1 响应数据结构</h3>
<pre><code class="hljs language-dart" lang="dart">Response response = <span class="hljs-keyword">await</span> dio.<span class="hljs-keyword">get</span>(<span class="hljs-string">'https://api.example.com/user'</span>);

<span class="hljs-built_in">print</span>(response.data);       <span class="hljs-comment">// 响应体（可能已被转换）</span>
<span class="hljs-built_in">print</span>(response.statusCode); <span class="hljs-comment">// 状态码</span>
<span class="hljs-built_in">print</span>(response.headers);    <span class="hljs-comment">// 响应头</span>
<span class="hljs-built_in">print</span>(response.requestOptions); <span class="hljs-comment">// 请求信息</span>
<span class="hljs-built_in">print</span>(response.statusMessage); <span class="hljs-comment">// 状态消息</span>

<span class="hljs-comment">// 获取流式响应</span>
<span class="hljs-keyword">final</span> streamResponse = <span class="hljs-keyword">await</span> dio.<span class="hljs-keyword">get</span>(
  url,
  options: Options(responseType: ResponseType.stream),
);
<span class="hljs-built_in">print</span>(streamResponse.data.stream);

<span class="hljs-comment">// 获取字节响应</span>
<span class="hljs-keyword">final</span> bytesResponse = <span class="hljs-keyword">await</span> dio.<span class="hljs-keyword">get</span>&lt;<span class="hljs-built_in">List</span>&lt;<span class="hljs-built_in">int</span>&gt;&gt;(
  url,
  options: Options(responseType: ResponseType.bytes),
);
<span class="hljs-built_in">print</span>(bytesResponse.data); <span class="hljs-comment">// List&lt;int&gt;</span>
</code></pre>
<h3 data-id="heading-9">3.2 与 Flutter UI 集成</h3>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">import</span> <span class="hljs-string">'package:flutter/material.dart'</span>;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserList</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span> </span>{
  Future&lt;<span class="hljs-built_in">List</span>&lt;User&gt;&gt; fetchUsers() <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">final</span> response = <span class="hljs-keyword">await</span> dio.<span class="hljs-keyword">get</span>(<span class="hljs-string">'/users'</span>);
    <span class="hljs-built_in">List</span>&lt;<span class="hljs-built_in">dynamic</span>&gt; jsonList = response.data;
    <span class="hljs-keyword">return</span> jsonList.map((json) =&gt; User.fromJson(json)).toList();
  }

  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> FutureBuilder&lt;<span class="hljs-built_in">List</span>&lt;User&gt;&gt;(
      future: fetchUsers(),
      builder: (context, snapshot) {
        <span class="hljs-keyword">if</span> (snapshot.connectionState == ConnectionState.waiting) {
          <span class="hljs-keyword">return</span> CircularProgressIndicator();
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (snapshot.hasError) {
          <span class="hljs-keyword">return</span> Text(<span class="hljs-string">'Error: <span class="hljs-subst">${snapshot.error}</span>'</span>);
        } <span class="hljs-keyword">else</span> {
          <span class="hljs-keyword">return</span> ListView.builder(
            itemCount: snapshot.data!.length,
            itemBuilder: (context, index) {
              User user = snapshot.data![index];
              <span class="hljs-keyword">return</span> ListTile(
                title: Text(user.name),
                subtitle: Text(user.email),
              );
            },
          );
        }
      },
    );
  }
}
</code></pre>
<h2 data-id="heading-10">4. 错误处理</h2>
<h3 data-id="heading-11">4.1 DioException 类型（新版本）</h3>
<p>Dio 5.x 使用 <code>DioException</code> 替代旧的 <code>DioError</code>：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">try</span> {
  Response response = <span class="hljs-keyword">await</span> dio.<span class="hljs-keyword">get</span>(<span class="hljs-string">"/user?id=123"</span>);
} <span class="hljs-keyword">on</span> DioException <span class="hljs-keyword">catch</span> (e) {
  <span class="hljs-keyword">switch</span> (e.type) {
    <span class="hljs-keyword">case</span> DioExceptionType.connectionTimeout:
      <span class="hljs-built_in">print</span>(<span class="hljs-string">'连接超时'</span>);
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> DioExceptionType.sendTimeout:
      <span class="hljs-built_in">print</span>(<span class="hljs-string">'发送超时'</span>);
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> DioExceptionType.receiveTimeout:
      <span class="hljs-built_in">print</span>(<span class="hljs-string">'接收超时'</span>);
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> DioExceptionType.badResponse:
      <span class="hljs-built_in">print</span>(<span class="hljs-string">'服务器错误，状态码：<span class="hljs-subst">${e.response?.statusCode}</span>'</span>);
      <span class="hljs-built_in">print</span>(<span class="hljs-string">'响应数据：<span class="hljs-subst">${e.response?.data}</span>'</span>);
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> DioExceptionType.cancel:
      <span class="hljs-built_in">print</span>(<span class="hljs-string">'请求被取消'</span>);
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> DioExceptionType.connectionError:
      <span class="hljs-built_in">print</span>(<span class="hljs-string">'连接错误，请检查网络'</span>);
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> DioExceptionType.badCertificate:
      <span class="hljs-built_in">print</span>(<span class="hljs-string">'证书验证失败'</span>);
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> DioExceptionType.unknown:
    <span class="hljs-keyword">default</span>:
      <span class="hljs-built_in">print</span>(<span class="hljs-string">'未知错误: <span class="hljs-subst">${e.message}</span>'</span>);
      <span class="hljs-keyword">break</span>;
  }
}
</code></pre>
<h3 data-id="heading-12">4.2 错误类型说明</h3>
<ul>
<li><strong>connectionTimeout</strong>：连接服务器超时</li>
<li><strong>sendTimeout</strong>：数据发送超时</li>
<li><strong>receiveTimeout</strong>：接收响应超时</li>
<li><strong>badResponse</strong>：服务器返回错误状态码（4xx、5xx）</li>
<li><strong>cancel</strong>：请求被取消</li>
<li><strong>connectionError</strong>：网络连接问题</li>
<li><strong>badCertificate</strong>：HTTPS 证书验证失败</li>
<li><strong>unknown</strong>：其他未知错误</li>
</ul>
<h2 data-id="heading-13">5. 拦截器（Interceptors）</h2>
<p>拦截器是 Dio 最强大的功能之一，允许在请求/响应流程中插入处理逻辑。</p>
<h3 data-id="heading-14">5.1 基础拦截器</h3>
<pre><code class="hljs language-dart" lang="dart">dio.interceptors.add(
  InterceptorsWrapper(
    onRequest: (RequestOptions options, RequestInterceptorHandler handler) {
      <span class="hljs-comment">// 请求前处理</span>
      <span class="hljs-built_in">print</span>(<span class="hljs-string">'发送请求: <span class="hljs-subst">${options.uri}</span>'</span>);
      
      <span class="hljs-comment">// 添加认证token</span>
      options.headers[<span class="hljs-string">'Authorization'</span>] = <span class="hljs-string">'Bearer your_token_here'</span>;
      
      <span class="hljs-keyword">return</span> handler.next(options); <span class="hljs-comment">// 继续请求</span>
    },
    
    onResponse: (Response response, ResponseInterceptorHandler handler) {
      <span class="hljs-comment">// 响应后处理</span>
      <span class="hljs-built_in">print</span>(<span class="hljs-string">'收到响应: <span class="hljs-subst">${response.statusCode}</span>'</span>);
      <span class="hljs-keyword">return</span> handler.next(response);
    },
    
    onError: (DioException error, ErrorInterceptorHandler handler) {
      <span class="hljs-comment">// 错误处理</span>
      <span class="hljs-built_in">print</span>(<span class="hljs-string">'请求错误: <span class="hljs-subst">${error.type}</span>'</span>);
      <span class="hljs-keyword">return</span> handler.next(error);
    },
  ),
);
</code></pre>
<h3 data-id="heading-15">5.2 实用拦截器示例</h3>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 1. 日志拦截器</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LoggingInterceptor</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Interceptor</span> </span>{
  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> onRequest(RequestOptions options, RequestInterceptorHandler handler) {
    <span class="hljs-built_in">print</span>(<span class="hljs-string">'REQUEST[<span class="hljs-subst">${options.method}</span>] =&gt; PATH: <span class="hljs-subst">${options.path}</span>'</span>);
    <span class="hljs-built_in">print</span>(<span class="hljs-string">'Headers: <span class="hljs-subst">${options.headers}</span>'</span>);
    <span class="hljs-keyword">if</span> (options.data != <span class="hljs-keyword">null</span>) {
      <span class="hljs-built_in">print</span>(<span class="hljs-string">'Body: <span class="hljs-subst">${options.data}</span>'</span>);
    }
    <span class="hljs-keyword">super</span>.onRequest(options, handler);
  }
  
  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> onResponse(Response response, ResponseInterceptorHandler handler) {
    <span class="hljs-built_in">print</span>(<span class="hljs-string">'RESPONSE[<span class="hljs-subst">${response.statusCode}</span>] =&gt; PATH: <span class="hljs-subst">${response.requestOptions.path}</span>'</span>);
    <span class="hljs-built_in">print</span>(<span class="hljs-string">'Data: <span class="hljs-subst">${response.data}</span>'</span>);
    <span class="hljs-keyword">super</span>.onResponse(response, handler);
  }
}

<span class="hljs-comment">// 2. Token 刷新拦截器</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TokenRefreshInterceptor</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Interceptor</span> </span>{
  <span class="hljs-keyword">final</span> Dio _tokenDio = Dio();
  <span class="hljs-built_in">bool</span> _isRefreshing = <span class="hljs-keyword">false</span>;
  
  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> onError(DioException err, ErrorInterceptorHandler handler) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">if</span> (err.response?.statusCode == <span class="hljs-number">401</span> &amp;&amp; !_isRefreshing) {
      _isRefreshing = <span class="hljs-keyword">true</span>;
      <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// 刷新token</span>
        <span class="hljs-keyword">await</span> refreshToken();
        
        <span class="hljs-comment">// 重试原始请求</span>
        <span class="hljs-keyword">final</span> response = <span class="hljs-keyword">await</span> dio.request(
          err.requestOptions.path,
          data: err.requestOptions.data,
          queryParameters: err.requestOptions.queryParameters,
          options: Options(
            method: err.requestOptions.method,
            headers: err.requestOptions.headers,
          ),
        );
        handler.resolve(response);
      } <span class="hljs-keyword">catch</span> (e) {
        handler.reject(err);
      } <span class="hljs-keyword">finally</span> {
        _isRefreshing = <span class="hljs-keyword">false</span>;
      }
    } <span class="hljs-keyword">else</span> {
      handler.next(err);
    }
  }
}
</code></pre>
<h2 data-id="heading-16">6. 文件上传与下载</h2>
<h3 data-id="heading-17">6.1 单文件上传</h3>
<pre><code class="hljs language-dart" lang="dart">FormData formData = FormData.fromMap({
  <span class="hljs-string">'name'</span>: <span class="hljs-string">'文件名'</span>,
  <span class="hljs-string">'file'</span>: <span class="hljs-keyword">await</span> MultipartFile.fromFile(
    <span class="hljs-string">'./text.txt'</span>, 
    filename: <span class="hljs-string">'upload.txt'</span>,
  ),
});

Response response = <span class="hljs-keyword">await</span> dio.post(
  <span class="hljs-string">'/upload'</span>,
  data: formData,
  onSendProgress: (<span class="hljs-built_in">int</span> sent, <span class="hljs-built_in">int</span> total) {
    <span class="hljs-built_in">print</span>(<span class="hljs-string">'上传进度: <span class="hljs-subst">$sent</span> / <span class="hljs-subst">$total</span>'</span>);
  },
);
</code></pre>
<h3 data-id="heading-18">6.2 多文件上传</h3>
<pre><code class="hljs language-dart" lang="dart">FormData formData = FormData.fromMap({
  <span class="hljs-string">'name'</span>: <span class="hljs-string">'dio'</span>,
  <span class="hljs-string">'files'</span>: [
    <span class="hljs-keyword">await</span> MultipartFile.fromFile(<span class="hljs-string">'./text1.txt'</span>, filename: <span class="hljs-string">'text1.txt'</span>),
    <span class="hljs-keyword">await</span> MultipartFile.fromFile(<span class="hljs-string">'./text2.txt'</span>, filename: <span class="hljs-string">'text2.txt'</span>),
    <span class="hljs-keyword">await</span> MultipartFile.fromFile(<span class="hljs-string">'./text3.txt'</span>, filename: <span class="hljs-string">'text3.txt'</span>),
  ]
});

Response response = <span class="hljs-keyword">await</span> dio.post(<span class="hljs-string">'/upload-multiple'</span>, data: formData);
</code></pre>
<h3 data-id="heading-19">6.3 文件下载</h3>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 获取应用临时目录</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'package:path_provider/path_provider.dart'</span>;

<span class="hljs-keyword">void</span> downloadFile() <span class="hljs-keyword">async</span> {
  <span class="hljs-comment">// 获取存储路径</span>
  Directory tempDir = <span class="hljs-keyword">await</span> getTemporaryDirectory();
  <span class="hljs-built_in">String</span> savePath = <span class="hljs-string">'<span class="hljs-subst">${tempDir.path}</span>/filename.pdf'</span>;
  
  CancelToken cancelToken = CancelToken();
  
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">await</span> dio.download(
      <span class="hljs-string">'https://example.com/file.pdf'</span>,
      savePath,
      onReceiveProgress: (received, total) {
        <span class="hljs-keyword">if</span> (total != <span class="hljs-number">-1</span>) {
          <span class="hljs-built_in">double</span> progress = (received / total) * <span class="hljs-number">100</span>;
          <span class="hljs-built_in">print</span>(<span class="hljs-string">'下载进度: <span class="hljs-subst">${progress.toStringAsFixed(<span class="hljs-number">2</span>)}</span>%'</span>);
        }
      },
      cancelToken: cancelToken,
      deleteOnError: <span class="hljs-keyword">true</span>, <span class="hljs-comment">// 下载出错时删除部分文件</span>
    );
    <span class="hljs-built_in">print</span>(<span class="hljs-string">'下载完成: <span class="hljs-subst">$savePath</span>'</span>);
  } <span class="hljs-keyword">on</span> DioException <span class="hljs-keyword">catch</span> (e) {
    <span class="hljs-keyword">if</span> (CancelToken.isCancel(e)) {
      <span class="hljs-built_in">print</span>(<span class="hljs-string">'下载已取消'</span>);
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-built_in">print</span>(<span class="hljs-string">'下载失败: <span class="hljs-subst">${e.message}</span>'</span>);
    }
  }
}

<span class="hljs-comment">// 取消下载</span>
<span class="hljs-keyword">void</span> cancelDownload() {
  cancelToken.cancel(<span class="hljs-string">'用户取消下载'</span>);
}
</code></pre>
<h2 data-id="heading-20">7. 高级配置</h2>
<h3 data-id="heading-21">7.1 请求选项（Options）</h3>
<pre><code class="hljs language-dart" lang="dart">Response response = <span class="hljs-keyword">await</span> dio.<span class="hljs-keyword">get</span>(
  <span class="hljs-string">'/data'</span>,
  options: Options(
    headers: {<span class="hljs-string">'custom-header'</span>: <span class="hljs-string">'value'</span>},
    responseType: ResponseType.json,
    contentType: <span class="hljs-string">'application/json'</span>,
    sendTimeout: <span class="hljs-built_in">Duration</span>(seconds: <span class="hljs-number">10</span>),
    receiveTimeout: <span class="hljs-built_in">Duration</span>(seconds: <span class="hljs-number">10</span>),
    extra: {<span class="hljs-string">'custom_info'</span>: <span class="hljs-string">'可以后续在拦截器中获取'</span>}, <span class="hljs-comment">// 自定义字段</span>
    validateStatus: (status) {
      <span class="hljs-comment">// 自定义状态码验证逻辑</span>
      <span class="hljs-keyword">return</span> status! &lt; <span class="hljs-number">500</span>; <span class="hljs-comment">// 只认为500以下的状态码是成功的</span>
    },
  ),
);
</code></pre>
<h3 data-id="heading-22">7.2 请求取消</h3>
<pre><code class="hljs language-dart" lang="dart">CancelToken cancelToken = CancelToken();

<span class="hljs-comment">// 发起可取消的请求</span>
Future&lt;<span class="hljs-keyword">void</span>&gt; fetchData() <span class="hljs-keyword">async</span> {
  <span class="hljs-keyword">try</span> {
    Response response = <span class="hljs-keyword">await</span> dio.<span class="hljs-keyword">get</span>(
      <span class="hljs-string">'/large-data'</span>,
      cancelToken: cancelToken,
    );
    <span class="hljs-built_in">print</span>(response.data);
  } <span class="hljs-keyword">on</span> DioException <span class="hljs-keyword">catch</span> (e) {
    <span class="hljs-keyword">if</span> (CancelToken.isCancel(e)) {
      <span class="hljs-built_in">print</span>(<span class="hljs-string">'请求被取消'</span>);
    }
  }
}

<span class="hljs-comment">// 取消请求</span>
<span class="hljs-keyword">void</span> cancelRequest() {
  cancelToken.cancel(<span class="hljs-string">'用户取消操作'</span>);
}

<span class="hljs-comment">// 在组件销毁时取消请求（防止内存泄漏）</span>
<span class="hljs-meta">@override</span>
<span class="hljs-keyword">void</span> dispose() {
  cancelToken.cancel(<span class="hljs-string">'组件销毁'</span>);
  <span class="hljs-keyword">super</span>.dispose();
}
</code></pre>
<h3 data-id="heading-23">7.3 并发请求</h3>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 同时发起多个请求</span>
Future&lt;<span class="hljs-keyword">void</span>&gt; fetchMultipleData() <span class="hljs-keyword">async</span> {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-built_in">List</span>&lt;Response&gt; responses = <span class="hljs-keyword">await</span> Future.wait([
      dio.<span class="hljs-keyword">get</span>(<span class="hljs-string">'/user/1'</span>),
      dio.<span class="hljs-keyword">get</span>(<span class="hljs-string">'/user/2'</span>),
      dio.<span class="hljs-keyword">get</span>(<span class="hljs-string">'/user/3'</span>),
    ]);
    
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> response <span class="hljs-keyword">in</span> responses) {
      <span class="hljs-built_in">print</span>(<span class="hljs-string">'用户数据: <span class="hljs-subst">${response.data}</span>'</span>);
    }
  } <span class="hljs-keyword">on</span> DioException <span class="hljs-keyword">catch</span> (e) {
    <span class="hljs-built_in">print</span>(<span class="hljs-string">'请求失败: <span class="hljs-subst">${e.message}</span>'</span>);
  }
}
</code></pre>
<h2 data-id="heading-24">8. 项目实战：封装 Dio 服务</h2>
<h3 data-id="heading-25">8.1 基础封装示例</h3>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">import</span> <span class="hljs-string">'package:dio/dio.dart'</span>;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HttpService</span> </span>{
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> HttpService _instance = HttpService._internal();
  <span class="hljs-keyword">late</span> Dio _dio;
  
  <span class="hljs-keyword">factory</span> HttpService() =&gt; _instance;
  
  HttpService._internal() {
    _dio = Dio(BaseOptions(
      baseUrl: <span class="hljs-string">'https://api.example.com'</span>,
      connectTimeout: <span class="hljs-built_in">Duration</span>(seconds: <span class="hljs-number">10</span>),
      receiveTimeout: <span class="hljs-built_in">Duration</span>(seconds: <span class="hljs-number">10</span>),
      headers: {<span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'application/json'</span>},
    ));
    
    <span class="hljs-comment">// 添加拦截器</span>
    _dio.interceptors.add(LoggingInterceptor());
    _dio.interceptors.add(TokenInterceptor());
  }
  
  <span class="hljs-comment">// GET 请求</span>
  Future&lt;Response&gt; <span class="hljs-keyword">get</span>(<span class="hljs-built_in">String</span> path, {<span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt;? queryParams}) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> _dio.<span class="hljs-keyword">get</span>(
        path,
        queryParameters: queryParams,
      );
    } <span class="hljs-keyword">on</span> DioException <span class="hljs-keyword">catch</span> (e) {
      _handleError(e);
      <span class="hljs-keyword">rethrow</span>;
    }
  }
  
  <span class="hljs-comment">// POST 请求</span>
  Future&lt;Response&gt; post(<span class="hljs-built_in">String</span> path, {<span class="hljs-built_in">dynamic</span> data}) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> _dio.post(path, data: data);
    } <span class="hljs-keyword">on</span> DioException <span class="hljs-keyword">catch</span> (e) {
      _handleError(e);
      <span class="hljs-keyword">rethrow</span>;
    }
  }
  
  <span class="hljs-comment">// 错误处理</span>
  <span class="hljs-keyword">void</span> _handleError(DioException e) {
    <span class="hljs-keyword">switch</span> (e.type) {
      <span class="hljs-keyword">case</span> DioExceptionType.connectionTimeout:
        <span class="hljs-keyword">throw</span> Exception(<span class="hljs-string">'连接超时，请检查网络'</span>);
      <span class="hljs-keyword">case</span> DioExceptionType.badResponse:
        <span class="hljs-keyword">if</span> (e.response?.statusCode == <span class="hljs-number">401</span>) {
          <span class="hljs-keyword">throw</span> Exception(<span class="hljs-string">'身份验证失败，请重新登录'</span>);
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (e.response?.statusCode == <span class="hljs-number">404</span>) {
          <span class="hljs-keyword">throw</span> Exception(<span class="hljs-string">'请求的资源不存在'</span>);
        } <span class="hljs-keyword">else</span> {
          <span class="hljs-keyword">throw</span> Exception(<span class="hljs-string">'服务器错误: <span class="hljs-subst">${e.response?.statusCode}</span>'</span>);
        }
      <span class="hljs-keyword">case</span> DioExceptionType.connectionError:
        <span class="hljs-keyword">throw</span> Exception(<span class="hljs-string">'网络连接失败，请检查网络设置'</span>);
      <span class="hljs-keyword">default</span>:
        <span class="hljs-keyword">throw</span> Exception(<span class="hljs-string">'网络请求失败: <span class="hljs-subst">${e.message}</span>'</span>);
    }
  }
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-keyword">final</span> http = HttpService();
User user = <span class="hljs-keyword">await</span> http.<span class="hljs-keyword">get</span>(<span class="hljs-string">'/user/1'</span>);
</code></pre>
<h3 data-id="heading-26">8.2 结合状态管理的完整示例</h3>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// api_service.dart</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ApiService</span> </span>{
  <span class="hljs-keyword">final</span> Dio _dio;
  
  ApiService({<span class="hljs-keyword">required</span> <span class="hljs-built_in">String</span> baseUrl}) 
    : _dio = Dio(BaseOptions(baseUrl: baseUrl)) {
    _setupInterceptors();
  }
  
  <span class="hljs-keyword">void</span> _setupInterceptors() {
    _dio.interceptors.add(InterceptorsWrapper(
      onRequest: (options, handler) {
        <span class="hljs-comment">// 从本地存储获取token</span>
        <span class="hljs-keyword">final</span> token = StorageService().getToken();
        <span class="hljs-keyword">if</span> (token != <span class="hljs-keyword">null</span>) {
          options.headers[<span class="hljs-string">'Authorization'</span>] = <span class="hljs-string">'Bearer <span class="hljs-subst">$token</span>'</span>;
        }
        <span class="hljs-keyword">return</span> handler.next(options);
      },
    ));
  }
  
  Future&lt;T&gt; request&lt;T&gt;(
    <span class="hljs-built_in">String</span> path, {
    <span class="hljs-built_in">String</span> method = <span class="hljs-string">'GET'</span>,
    <span class="hljs-built_in">dynamic</span> data,
    <span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt;? queryParameters,
    CancelToken? cancelToken,
  }) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">final</span> response = <span class="hljs-keyword">await</span> _dio.request(
        path,
        data: data,
        queryParameters: queryParameters,
        options: Options(method: method),
        cancelToken: cancelToken,
      );
      
      <span class="hljs-comment">// 使用 json_serializable 解析数据</span>
      <span class="hljs-keyword">return</span> _parseResponse&lt;T&gt;(response.data);
    } <span class="hljs-keyword">on</span> DioException <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-keyword">throw</span> ApiException.fromDioException(e);
    }
  }
}

<span class="hljs-comment">// 使用 GetX 控制器调用</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserController</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">GetxController</span> </span>{
  <span class="hljs-keyword">final</span> ApiService apiService;
  <span class="hljs-keyword">var</span> users = &lt;User&gt;[].obs;
  <span class="hljs-keyword">var</span> isLoading = <span class="hljs-keyword">false</span>.obs;
  
  UserController(<span class="hljs-keyword">this</span>.apiService);
  
  Future&lt;<span class="hljs-keyword">void</span>&gt; fetchUsers() <span class="hljs-keyword">async</span> {
    isLoading.value = <span class="hljs-keyword">true</span>;
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">final</span> userList = <span class="hljs-keyword">await</span> apiService.request&lt;<span class="hljs-built_in">List</span>&lt;User&gt;&gt;(<span class="hljs-string">'/users'</span>);
      users.assignAll(userList);
    } <span class="hljs-keyword">on</span> ApiException <span class="hljs-keyword">catch</span> (e) {
      Get.snackbar(<span class="hljs-string">'错误'</span>, e.message);
    } <span class="hljs-keyword">finally</span> {
      isLoading.value = <span class="hljs-keyword">false</span>;
    }
  }
}
</code></pre>
<h2 data-id="heading-27">9. 最佳实践与注意事项</h2>
<ol>
<li><strong>单例模式</strong>：在整个应用中使用单个 Dio 实例，确保配置一致</li>
<li><strong>环境区分</strong>：为开发、测试、生产环境配置不同的 baseURL</li>
<li><strong>安全存储</strong>：敏感信息（如 API Keys）不要硬编码在代码中</li>
<li><strong>证书验证</strong>：生产环境不要忽略 SSL 证书验证</li>
<li><strong>内存管理</strong>：及时取消不再需要的请求，特别是在页面销毁时</li>
<li><strong>错误重试</strong>：对特定错误（如网络波动）实现重试机制</li>
<li><strong>响应缓存</strong>：对不常变的数据实现缓存策略，减少网络请求</li>
<li><strong>进度反馈</strong>：长时间操作（上传/下载）提供进度提示</li>
</ol>
<h2 data-id="heading-28">10. 扩展资源</h2>
<ul>
<li><strong>官方文档</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fpub.dev%2Fpackages%2Fdio" target="_blank" title="https://pub.dev/packages/dio" ref="nofollow noopener noreferrer">pub.dev/packages/di…</a></li>
<li><strong>GitHub仓库</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fcfug%2Fdio" target="_blank" title="https://github.com/cfug/dio" ref="nofollow noopener noreferrer">github.com/cfug/dio</a></li>
<li><strong>Awesome Dio</strong>：官方维护的插件和工具列表</li>
<li><strong>JSON序列化</strong>：配合 <code>json_serializable</code> 处理复杂数据结构</li>
<li><strong>状态管理</strong>：与 GetX、Provider、Riverpod 等状态管理库结合使用</li>
</ul>
<hr/>
<p>这份教程涵盖了 Dio 的核心功能和实际应用场景。建议从基础请求开始，逐步掌握拦截器、错误处理等高级特性，最后根据项目需求进行适当的封装。在实际开发中，合理的封装可以显著提高代码的可维护性和开发效率。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[浅谈 OpenAI Agents SDK]]></title>    <link>https://juejin.cn/post/7599330434426519603</link>    <guid>https://juejin.cn/post/7599330434426519603</guid>    <pubDate>2026-01-26T09:58:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599330434426519603" data-draft-id="7599101854644256778" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="浅谈 OpenAI Agents SDK"/> <meta itemprop="keywords" content="AI编程,Agent,LLM"/> <meta itemprop="datePublished" content="2026-01-26T09:58:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="去哪儿技术沙龙"/> <meta itemprop="url" content="https://juejin.cn/user/2251436075786791"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            浅谈 OpenAI Agents SDK
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2251436075786791/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    去哪儿技术沙龙
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T09:58:02.000Z" title="Mon Jan 26 2026 09:58:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>一、OpenAI Agents SDK是什么？</strong></h2>
<p>OpenAI Agents SDK是一个轻量级且易于使用的工具包，用于构建基于代理的AI应用程序。 提供了一些基本构建块，包括具备指令和工具的代理（Agents）、用于代理间任务委托的交接（Handoffs）以及用于输入验证的护栏（Guardrails）。</p>
<p>在官网上OpenAI给出了两个理由使用它，而且也介绍了 Agent Loop、Python-first、Handoffs、Guardrails 、Function tools 和 Tracing 6个特性，对于现阶段的我们对Python-first 和 Function tools 就不做过多的阐述了，但是其他的四个特性还需要进一步详细阐述。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c23ab7ab7f0a49178ca8db0e140532a9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y675ZOq5YS_5oqA5pyv5rKZ6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770026283&amp;x-signature=XyE5BRqKAP5pntxVIz0e4KYyh58%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-1"><strong>二、核心特性</strong></h2>
<h3 data-id="heading-2"><strong>（一）Agent Loop（循环）</strong></h3>
<p>支持在没有完成任务时自动的循环agent的执行，直到完成任务结束，可以调用functioncall，MCP等工具来更好的完成任务。对于许多业务流程涉及一系列需要外部信息或操作的步骤（例如，查询数据库、调用 API、根据查询结果生成报告）。Agent Loop 自动化了这个迭代过程，能够自主完成这些复杂、多步任务的智能体成为可能。</p>
<h3 data-id="heading-3">（二）Handoffs（交接）</h3>
<p>交接的出现允许一个智能体（Agent）将特定任务委托给另一个智能体来完成，是用于在多个智能体之间进行协调和委托。实现了复杂工作流和多智能体协作的关键机制。在大型业务场景中，单一智能体可能难以处理所有类型的任务。通过 Handoffs，可以设计由多个专业智能体组成的系统，每个智能体负责其擅长的领域；将复杂业务流程分解到不同的智能体中，提高了系统的模块化，使得每个智能体更容易开发、测试和维护。</p>
<p>例如在酒店业务中，有些问题需要多个业务方合作才能完成，那么不同业务域可以维护自己的agent，从入口确定是业务范围，涉及到多个智能体交互时，就可以使用Handoff完成交接，更加准确的给出问题的解决思路和方案，甚至是解决问题。</p>
<h3 data-id="heading-4"><strong>（三）Guardrails（护栏）</strong></h3>
<p>这个可以在一定程度上解决不确定性。Guardrails 用于验证智能体输入的能力，它们可以在智能体运行之前并行执行输入验证和检查。如果检查失败，Guardrails 可以让应用快速中止（breaking early）。这有助于确保应用的可靠性，防止因不当输入导致的错误行为。</p>
<p>对于现在大模型的产生，我们都受益于大模型带来的生产力提高，但是还是会出现一些不确定性，与我们的期望有所偏差，随着guardrails的出现，就像是一个家教在辅导学生作业一样，每完成一个任务，老师都会给出一个反馈。</p>
<p>在我们的业务系统中Guardrails可以提升我们应用的可靠性和鲁棒性。对于不合法或恶意输入可能导致错误、安全漏洞或意外行为，Guardrails 通过强制执行输入验证，确保智能体只处理符合预期的输入；还可以节省计算资源和减少成本，如果不符合预期在智能体运行初期就会判别和拒绝；确保了系统的业务逻辑和合规问题。</p>
<h3 data-id="heading-5"><strong><strong>（四）Tracing（可视化追踪）</strong></strong></h3>
<p>在OpenAI的SDK中内置了Tracing能力，可以很直观地解读Agent之间的交互过程，可以看到请求体，响应事件等的，除此之外还支持评估（evaluate）工作流程，甚至可以用来微调（fine-tune）模型以优化应用的性能。</p>
<p>在Agent初期，对于几乎“黑盒”系统来说，我们的掌控感和信任感会特别的弱，而Tracing这个能力就给我们带来一束“曙光”。我们可以在开发阶段，测试阶段甚至是部分线上场景对Agent进行监控和可视化的追踪。可以帮助我们快速定位和解决问题；除此之外OpenAI 的SDK中还支持基于追踪数据，可以进一步微调或蒸馏模型，持续优化智能体在实际业务场景中的效率和效果，例如提高回复的准确性、减少错误操作。</p>
<h2 data-id="heading-6"><strong>三</strong>**、代码示例**</h2>
<p>这些特性激起了我的好奇心，本着对知识的渴望，咱们还是回归到代码实现上！为了快速实现：我们使用OpenAI的GPT-4o模型（默认）。</p>
<p>前期准备：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 安装依赖</span>
pip install openai-agents
<span class="hljs-comment"># or `uv add openai-agents`, etc</span>
<span class="hljs-comment"># 设置自己的OpenAIKey</span>
export <span class="hljs-attr">OPENAI_API_KEY</span>=sk-...
</code></pre>
<h3 data-id="heading-7"><strong>（一）最初天气查询</strong></h3>
<p>首先我们先写一个简单的示例，然后再开始一点点的把我们想要了解的特性走一遍。 我们先用python写一个简单的agent，可以查询天气：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/583fc91a1f2f4703a4f8adea7e6e0ba2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y675ZOq5YS_5oqA5pyv5rKZ6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770026283&amp;x-signature=nsEejttvG%2FCJzaHtsE1YlUxtypk%3D" alt="" loading="lazy"/></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> TypedDict
<span class="hljs-keyword">from</span> agents <span class="hljs-keyword">import</span> Agent, Runner, function_tool
<span class="hljs-keyword">import</span> asyncio

<span class="hljs-meta">@function_tool</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">fetch_weather</span>(<span class="hljs-params">city: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-string">"""Fetch the weather for a given location.
     Args:
        city: The city to fetch the weather for.
    """</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">"sunny"</span>

<span class="hljs-comment"># 天气查询Agent</span>
weather_agent = Agent(
                    name=<span class="hljs-string">"天气查询专家"</span>,
                     instructions=<span class="hljs-string">"你是天气查询专家，用户输入城市名，你返回该城市的天气信息。请用简洁中文回复。"</span>,
                    tools=[fetch_weather]
                    )

<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():
    result = <span class="hljs-keyword">await</span> Runner.run(weather_agent, <span class="hljs-built_in">input</span>=<span class="hljs-string">"北京"</span>)
    <span class="hljs-built_in">print</span>(result.final_output)

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    asyncio.run(main())
</code></pre>
<p><strong>1、Agent属性说明</strong></p>
<p>我们可以参考源码中的结构，发现有哪些属性我们可以调整或者修改，理论上默认属性值只能够提供简单的使用，如果涉及到自定义的功能那就需要调整更多的参数。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dc9dd122200645c4896dbe95b65ccd81~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y675ZOq5YS_5oqA5pyv5rKZ6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770026283&amp;x-signature=pIQ8w1vBkbeNmU3Jyc1ZTfNOQqI%3D" alt="" loading="lazy"/></p>
<ul>
<li>
<p><strong>instructions：<strong>使用</strong>instructions</strong>属性指定当前agent的系统提示词。可以是字符串，也可以是Agent生成的动态指令，如果是一个函数，将通过上下文和代理实例调用，但是必须返回字符串。</p>
</li>
<li>
<p><strong>name</strong>：智能体的名字</p>
</li>
<li>
<p>**tools：**智能体可以使用工具列表</p>
</li>
<li>
<p>**handoff_description：**智能体的交接说明，主要用于多个智能体进行交接时，让大模型了解这个智能体能做什么，以及什么时候调用他</p>
</li>
<li>
<p>**handoffs：**agent可以委派任务的子agent。你可以提供一个 handoffs 的列表，代理在适当的情况下可以选择将任务委派给它们。这样可以实现职责分离和模块化设计。</p>
</li>
<li>
<p>**model：**可以配置model，默认是gpt4o</p>
</li>
<li>
<p>**hooks：**接收此代理的各种生命周期事件的回调的类。</p>
</li>
<li>
<p>**mcp_servers:**agent可以使用的模型上下文协议 (MCP)服务器列表。每次代理运行时，它都会将这些服务器中的工具添加到可用工具列表中。</p>
</li>
<li>
<p><strong>output_guardrails</strong>: 生成响应后，对代理的最终输出运行的检查列表。仅当代理生成最终输出时运行。</p>
</li>
<li>
<p><strong>input_guardrails</strong>: 在生成响应之前，与代理执行并行运行的检查列表。仅当代理是链中的第一个代理时运行。</p>
</li>
</ul>
<h3 data-id="heading-8">**（二）**<strong>多个Agent</strong></h3>
<p>现在开始构建多个Agent用来观察后面的新特性，例如本段代码示例为一个“天气专家”再加上一个“穿衣专家”两个Agent，回答用户的关于穿衣服的一些回答。 两个agent之间“穿衣专家” 使用 “天气专家”给出的天气信息进行总结天气因素，也就是需要两个专家的“交接”，最终给出对应穿衣风格搭配建议。（后面的tracing模块会对交互细节进行阐述）</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/66e09e13caa9434dbe7aebc04e71c848~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y675ZOq5YS_5oqA5pyv5rKZ6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770026283&amp;x-signature=1YytP6CvLUaj4TYGXOKRSjUvUwc%3D" alt="" loading="lazy"/></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> TypedDict
<span class="hljs-keyword">from</span> agents <span class="hljs-keyword">import</span> Agent, Runner, function_tool
<span class="hljs-keyword">import</span> asyncio

<span class="hljs-meta">@function_tool</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">fetch_weather</span>(<span class="hljs-params">city: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-string">"""Fetch the weather for a given location.

    Args:
        location: The location to fetch the weather for.
    """</span>
    <span class="hljs-comment"># In real life, we'd fetch the weather from a weather API</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">"sunny"</span>
<span class="hljs-comment"># 天气查询Agent</span>
weather_agent = Agent(
                    name=<span class="hljs-string">"天气查询专家"</span>,
                    instructions=<span class="hljs-string">"你是天气查询专家，用户输入城市名，你返回该城市的天气信息。请用简洁中文回复。"</span>,
                    tools=[fetch_weather]
                    )
……
（完整代码点击文末下方“阅读原文”查看）
</code></pre>
<h3 data-id="heading-9">（三）添加护栏（input_guardrails）</h3>
<p>现在已经有了两个“专家”，并且“专家”之间的依赖关系也已经声明了，开始搭建一些边界情况，保障整个项目的“确定性”，就是引入“护栏”（guardrails），为了演示这里使用的是输入“护栏”，保障整个功能只聚焦在穿衣相关的问题上。重点看“<strong>guardrail_agent</strong>”。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> TypedDict
<span class="hljs-keyword">from</span> agents <span class="hljs-keyword">import</span> Agent, GuardrailFunctionOutput, InputGuardrail, Runner, function_tool
<span class="hljs-keyword">import</span> asyncio

<span class="hljs-keyword">from</span> pydantic <span class="hljs-keyword">import</span> BaseModel

<span class="hljs-keyword">class</span> <span class="hljs-title class_">DressOutput</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    is_dressing: <span class="hljs-built_in">bool</span>
    reasoning: <span class="hljs-built_in">str</span>

<span class="hljs-comment"># Guardrail聚焦穿衣建议</span>
guardrail_agent = Agent(
    name=<span class="hljs-string">"Guardrail check"</span>,
    instructions=(<span class="hljs-string">"请判断用户的问题是否围绕用户穿衣建议相关内容,如果问题属于上述内容，请返回 is_dressing=True，并简要说明理由。"</span>),
    output_type=DressOutput,
)


……
（完整代码点击文末下方“阅读原文”查看）
</code></pre>
<p>符合护栏输入的要求：</p>
<pre><code class="hljs language-scss" lang="scss">----

Guardrail result: RunResult:
- Last agent: <span class="hljs-built_in">Agent</span>(name=<span class="hljs-string">"Guardrail check"</span>, ...)
- Final output (DressOutput):
    {
      "is_dressing": true,
      <span class="hljs-string">"reasoning"</span>: <span class="hljs-string">"用户询问关于在北京穿着异域风格衣服的搭配建议，涉及穿衣搭配问题。"</span>
    }
- <span class="hljs-number">1</span> new <span class="hljs-built_in">item</span>(s)
- <span class="hljs-number">1</span> raw <span class="hljs-built_in">response</span>(s)
- <span class="hljs-number">0</span> <span class="hljs-selector-tag">input</span> guardrail <span class="hljs-built_in">result</span>(s)
- <span class="hljs-number">0</span> output guardrail <span class="hljs-built_in">result</span>(s)
(See `RunResult` for more details)
在北京今天的天气是晴天，温度约<span class="hljs-number">20</span>度，比较舒适，可以尝试以下异域风格的搭配：

<span class="hljs-number">1</span>. **波西米亚风**:
   - 上衣：流苏或印花衬衫
   - 下装：长裙或阔腿裤
   - 配饰：大项链、耳环和宽檐帽


……
（完整代码点击文末下方“阅读原文”查看）
</code></pre>
<p>在护栏中也可以设置"<strong>tripwire_triggered</strong>"参数来控制流程要不要终端，可以看具体的返回结果：</p>
<p>不终止任务，回答：</p>
<pre><code class="hljs language-scss" lang="scss">async def <span class="hljs-selector-tag">main</span>():
    result = await Runner.<span class="hljs-built_in">run</span>(dressing_agent, input=<span class="hljs-string">"上海天气如何"</span>)
    <span class="hljs-built_in">print</span>(result.final_output)

-----

Guardrail result: RunResult:
- Last agent: <span class="hljs-built_in">Agent</span>(name=<span class="hljs-string">"Guardrail check"</span>, ...)
- Final output (DressOutput):
    {
      "is_dressing": false,
      <span class="hljs-string">"reasoning"</span>: <span class="hljs-string">"用户询问的是上海的天气状况，与穿衣建议无直接关联。"</span>
    }
- <span class="hljs-number">1</span> new <span class="hljs-built_in">item</span>(s)
- <span class="hljs-number">1</span> raw <span class="hljs-built_in">response</span>(s)
- <span class="hljs-number">0</span> <span class="hljs-selector-tag">input</span> guardrail <span class="hljs-built_in">result</span>(s)
- <span class="hljs-number">0</span> output guardrail <span class="hljs-built_in">result</span>(s)
(See `RunResult` for more details)
上海今天天气晴朗，温度为<span class="hljs-number">20</span>度，湿度<span class="hljs-number">50%</span>，东南风<span class="hljs-number">2</span>级。
<span class="hljs-selector-attr">[non-fatal]</span> Tracing: request failed: _ssl.c:<span class="hljs-number">989</span>: The handshake operation timed o
</code></pre>
<p>终止任务：</p>
<pre><code class="hljs language-ini" lang="ini">async def dress_guardrail(ctx, agent, input_data):
    <span class="hljs-attr">result</span> = await Runner.run(guardrail_agent, input_data, context=ctx.context)
    <span class="hljs-attr">final_output</span> = result.final_output_as(DressOutput)
    print("Guardrail result:", result)
    <span class="hljs-comment"># 不再抛异常，直接返回判断结果</span>
    return GuardrailFunctionOutput(
        <span class="hljs-attr">output_info</span>=final_output,
        <span class="hljs-comment"># tripwire_triggered=False,  # 不触发终止</span>
        <span class="hljs-attr">tripwire_triggered</span>=<span class="hljs-literal">True</span>,  <span class="hljs-comment"># 触发终止</span>
    )

----

Guardrail result: RunResult:
- Last agent: Agent(<span class="hljs-attr">name</span>=<span class="hljs-string">"Guardrail check"</span>, ...)
- Final output (DressOutput):
    {
      "is_dressing": false,
      "reasoning": "用户的问题与当前天气情况有关，而不是关于穿衣建议的请求。"
    }


……
（完整代码点击文末下方“阅读原文”查看）
</code></pre>
<h3 data-id="heading-10"><strong>（四）Tracing</strong></h3>
<p>OpenAI的SDK默认开启了Tracing功能，可以支持手动关闭，以满足特定场景下的隐私或资源需求。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> agents <span class="hljs-keyword">import</span> 
set_tracing_disabledset_tracing_disabled(<span class="hljs-literal">True</span>)
</code></pre>
<p><strong>1、官方展示</strong></p>
<p>访问：<a href="https://link.juejin.cn?target=https%3A%2F%2Fplatform.openai.com%2Ftraces" target="_blank" title="https://platform.openai.com/traces" ref="nofollow noopener noreferrer">platform.openai.com/traces</a></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0e991336cbf94e779059675a8dfbde52~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y675ZOq5YS_5oqA5pyv5rKZ6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770026283&amp;x-signature=yGUR2OHeom%2FFxe0kiN5uvhBN2cQ%3D" alt="" loading="lazy"/></p>
<p>（1）多agent+交接</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/78c6f62927ac452fb2ca5fb5444ed51e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y675ZOq5YS_5oqA5pyv5rKZ6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770026283&amp;x-signature=bfJoZHiExWUDTTeqT2MOCnlMZn8%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ddc15fb5a4344ead86fd3b7b13532942~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y675ZOq5YS_5oqA5pyv5rKZ6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770026283&amp;x-signature=1%2FU3wD9RB3zVlxxvsN38Q%2B%2Ftt9Y%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/da6768b8f055493da69856e5a440cbd4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y675ZOq5YS_5oqA5pyv5rKZ6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770026283&amp;x-signature=Afl1A66Ywnnyl75QfuxtEPz3Uzk%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f6d974059df2443ba2c30a79fd88633a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y675ZOq5YS_5oqA5pyv5rKZ6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770026283&amp;x-signature=nxaqcOMt711VH9olIQfdi1GEcKo%3D" alt="" loading="lazy"/></p>
<p>交互可以很好的看清楚对应token消耗，入参和系统提示词以及对应functioncall，两个agent交接展示也是functioncall，时速度很快，但是存在2点展示不太好：</p>
<p>①交接时 上下文展示</p>
<p>②交接时 token有没有消耗</p>
<p>（2）添加护栏对应的Tracing</p>
<p>可以看出使用护栏输入拦截后token可以节省，流程可以提前终止。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7c084a18bc53432e87788d01b91fa447~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y675ZOq5YS_5oqA5pyv5rKZ6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770026283&amp;x-signature=qvSzDArC%2B741nhMEuZ1Oi7Pughg%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/127d58533bf748918dc5c7d11c453d65~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y675ZOq5YS_5oqA5pyv5rKZ6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770026283&amp;x-signature=5mC651HJ%2BYPXO5qHUAN6cqqnL0I%3D" alt="" loading="lazy"/></p>
<p><strong>2、自己本地</strong></p>
<p>有一些信息属于敏感信息贸然上传到服务器，会对数据安全和流程规范造成挑战。因此OpenAI的SDK支持多种解决方案：</p>
<p>①关闭Tracing功能</p>
<p>②自己搭建Tracing平台。这里演示本地运行</p>
<p>mlflow用来记录</p>
<p>③对敏感数据或者节点关闭tracing。 RunConfig.trace_include_sensitive_data</p>
<p>（1）安装mlflow依赖</p>
<pre><code class="hljs language-python" lang="python">pip install mlflow
<span class="hljs-comment"># 启动服务 并且在本地使用sqllite存储</span>
mlflow server --host <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span> --port <span class="hljs-number">8080</span> --backend-store-uri sqlite:///mlruns.db

<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> TypedDict
<span class="hljs-keyword">from</span> agents <span class="hljs-keyword">import</span> Agent, GuardrailFunctionOutput, InputGuardrail, Runner, function_tool
<span class="hljs-keyword">import</span> asyncio

<span class="hljs-keyword">import</span> mlflow
<span class="hljs-keyword">from</span> pydantic <span class="hljs-keyword">import</span> BaseModel

mlflow.openai.autolog()
mlflow.set_tracking_uri(<span class="hljs-string">"http://localhost:8080"</span>)
mlflow.set_experiment(<span class="hljs-string">"weather"</span>)

<span class="hljs-keyword">class</span> <span class="hljs-title class_">DressOutput</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    is_dressing: <span class="hljs-built_in">bool</span>
    reasoning: <span class="hljs-built_in">str</span>
<span class="hljs-comment"># Guardrail聚焦穿衣建议</span>
guardrail_agent = Agent(
    name=<span class="hljs-string">"Guardrail check"</span>,
    instructions=(<span class="hljs-string">"请判断用户的问题是否围绕用户穿衣建议相关内容,如果问题属于上述内容，请返回 is_dressing=True，并简要说明理由。"</span>),
    output_type=DressOutput,
)


……
（完整代码点击文末下方“阅读原文”查看）
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/07a7b630eff942d1bb80b49f14b12239~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y675ZOq5YS_5oqA5pyv5rKZ6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770026283&amp;x-signature=xiB8FWiObdUOPR1Obg2nB0KguMM%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0077b1306fb346c9a7c5a3e6b07afe35~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y675ZOq5YS_5oqA5pyv5rKZ6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770026283&amp;x-signature=SaxdOzrVD4vTPdMx%2F%2BWoIlWD%2BPg%3D" alt="" loading="lazy"/></p>
<p><strong>3、对比</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3b779908c4634a6092de10a9034ee1b6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y675ZOq5YS_5oqA5pyv5rKZ6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770026283&amp;x-signature=HIq9K%2F%2B3s1IpBbNMSid6PUGoh1k%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-11"><strong>（五）MCP使用</strong></h3>
<p>介绍完一些基础的用法后，我们看下最近比较火的MCP的接入实现。需要再在项目中插入MCP的定义，我们这里使用高德的MCP进行演示：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/438964b0ce93457fb8d11418177e93ad~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y675ZOq5YS_5oqA5pyv5rKZ6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770026283&amp;x-signature=m3wEIYe3mlL3ia4Gz%2FOLqIelrpc%3D" alt="" loading="lazy"/></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> TypedDict
<span class="hljs-keyword">from</span> agents <span class="hljs-keyword">import</span> Agent, GuardrailFunctionOutput, InputGuardrail, Runner, function_tool
<span class="hljs-keyword">import</span> asyncio
<span class="hljs-keyword">from</span> agents.mcp.server <span class="hljs-keyword">import</span> MCPServerStdio

<span class="hljs-keyword">import</span> mlflow
<span class="hljs-keyword">from</span> pydantic <span class="hljs-keyword">import</span> BaseModel

<span class="hljs-comment"># mlflow.openai.autolog()</span>
<span class="hljs-comment"># mlflow.set_tracking_uri("http://localhost:8080")</span>
<span class="hljs-comment"># mlflow.set_experiment("weather")</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">DressOutput</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    is_dressing: <span class="hljs-built_in">bool</span>
    reasoning: <span class="hljs-built_in">str</span>

<span class="hljs-comment"># Guardrail聚焦穿衣建议</span>
guardrail_agent = Agent(
    name=<span class="hljs-string">"Guardrail check"</span>,
    instructions=(<span class="hljs-string">"请判断用户的问题是否围绕用户穿衣建议相关内容,如果问题属于上述内容，请返回 is_dressing=True，并简要说明理由。"</span>),


……
（完整代码点击文末下方“阅读原文”查看）
</code></pre>
<p>OpenAI Agents SD代码示例到这里就告一段落了，大家可以自己尝试使用Deepseek替换一下模型看看效果（ps：deepseek还不支持 openai协议的Json 模版输出，所以需要做些改造）。</p>
<h2 data-id="heading-12"><strong>四、框架对比</strong></h2>
<p>目前市面上对于Agent智能体的搭建有很多方案，我这里只是对OpenAI SDK进行简短的介绍和使用。比如市面上比较火的有 工作流搭建框架 我司的Qmoss平台、开源的Dify、n8n、扣子、飞书 以及可以定制化开发Langchain、langchain4J、 langchain Graph、LlamaIndex等。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/54e7c2f7a467479fbf396a6b64cf2a59~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y675ZOq5YS_5oqA5pyv5rKZ6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770026283&amp;x-signature=OlsUhcqFI8bKqb9oaoL5PM5V9Js%3D" alt="" loading="lazy"/></p>
<p>LangGraph 传送门：<a href="https://link.juejin.cn?target=https%3A%2F%2Flangchain-ai.github.io%2Flanggraph%2Fconcepts%2Fwhy-langgraph%2F" target="_blank" title="https://langchain-ai.github.io/langgraph/concepts/why-langgraph/" ref="nofollow noopener noreferrer">langchain-ai.github.io/langgraph/c…</a></p>
<p>AutoGen传送门：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmicrosoft.github.io%2Fautogen%2Fstable%2F%2Fuser-guide%2Fagentchat-user-guide%2Fquickstart.html" target="_blank" title="https://microsoft.github.io/autogen/stable//user-guide/agentchat-user-guide/quickstart.html" ref="nofollow noopener noreferrer">microsoft.github.io/autogen/sta…</a></p>
<p>langchain4j传送门：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.langchain4j.dev%2F" target="_blank" title="https://docs.langchain4j.dev/" ref="nofollow noopener noreferrer">docs.langchain4j.dev/</a></p>
<p>对于多个Agent的交互和实现，我们再来看下LangGraph的简单示例,LangGraph 有两种多agnet的模型，多模型之间也是使用“交接”的方式。对于langgraph来说多个agent有两种架构设计：</p>
<p>一是监管架构（Supervisor）：各个代理由中央 Supervisor 代理协调。主管控制所有通信流和任务委派，根据当前上下文和任务要求决定调用哪个代理。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d50a3c359bf04fb790eefe2dd0f44320~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y675ZOq5YS_5oqA5pyv5rKZ6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770026283&amp;x-signature=HLjhlAf%2FH5EhakBsBqMamL%2BkT0w%3D" alt="" loading="lazy"/></p>
<p>另外一个是集群架构（Swarm）：各个Agent根据其专长动态地将控制权移交给彼此。系统会记住最后一个处于活动状态的座席，确保在后续交互中，与该座席的对话恢复。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cb801a5f147b4a51931a49d409c773b9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y675ZOq5YS_5oqA5pyv5rKZ6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770026283&amp;x-signature=bnQbtAPVXaFVdj%2Fn1WYPKTugGZM%3D" alt="" loading="lazy"/></p>
<p>我们现在使用LangGraph的Supervisor架构来实现我们上面的“衣服搭配”demo(ps：专家的名字中文会报错)：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/39203def36ec4a8e8542c3ef26fd0401~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y675ZOq5YS_5oqA5pyv5rKZ6b6Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770026283&amp;x-signature=CGLUEdt3syNDCxVYkrOx%2Fv4WOJA%3D" alt="" loading="lazy"/></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 首先安装依赖</span>
pip install -U langgraph <span class="hljs-string">"langchain[anthropic]"</span>
pip install langgraph-supervisor
</code></pre>
<p>使用本地的mlflow记录AI交互信息</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> asyncio
<span class="hljs-keyword">from</span> langchain_openai <span class="hljs-keyword">import</span> ChatOpenAI
<span class="hljs-keyword">from</span> langgraph.prebuilt <span class="hljs-keyword">import</span> create_react_agent
<span class="hljs-keyword">from</span> langgraph_supervisor <span class="hljs-keyword">import</span> create_supervisor
<span class="hljs-keyword">from</span> langchain_mcp_adapters.client <span class="hljs-keyword">import</span> MultiServerMCPClient
<span class="hljs-keyword">from</span> langchain.tools <span class="hljs-keyword">import</span> tool
<span class="hljs-keyword">from</span> PIL <span class="hljs-keyword">import</span> Image
<span class="hljs-keyword">from</span> IPython.display <span class="hljs-keyword">import</span> display

<span class="hljs-keyword">import</span> mlflow

<span class="hljs-keyword">import</span> pretty_util

<span class="hljs-comment"># Enabling tracing for LangGraph (LangChain)</span>
mlflow.langchain.autolog()

<span class="hljs-comment"># Optional: Set a tracking URI and an experiment</span>
mlflow.set_tracking_uri(<span class="hljs-string">"http://localhost:8080"</span>)
mlflow.set_experiment(<span class="hljs-string">"LangGraph"</span>)


……
（完整代码点击文末下方“阅读原文”查看）

<span class="hljs-keyword">from</span> langchain_core.messages <span class="hljs-keyword">import</span> convert_to_messages

<span class="hljs-keyword">def</span> <span class="hljs-title function_">pretty_print_message</span>(<span class="hljs-params">message, indent=<span class="hljs-literal">False</span></span>):
    pretty_message = message.pretty_repr(html=<span class="hljs-literal">True</span>)
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> indent:
        <span class="hljs-built_in">print</span>(pretty_message)
        <span class="hljs-keyword">return</span>

    indented = <span class="hljs-string">"\n"</span>.join(<span class="hljs-string">"\t"</span> + c <span class="hljs-keyword">for</span> c <span class="hljs-keyword">in</span> pretty_message.split(<span class="hljs-string">"\n"</span>))
    <span class="hljs-built_in">print</span>(indented)

<span class="hljs-keyword">def</span> <span class="hljs-title function_">pretty_print_messages</span>(<span class="hljs-params">update, last_message=<span class="hljs-literal">False</span></span>):
    is_subgraph = <span class="hljs-literal">False</span>
    <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(update, <span class="hljs-built_in">tuple</span>):
        ns, update = update
        <span class="hljs-comment"># skip parent graph updates in the printouts</span>
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(ns) == <span class="hljs-number">0</span>:
            <span class="hljs-keyword">return</span>

        graph_id = ns[-<span class="hljs-number">1</span>].split(<span class="hljs-string">":"</span>)[<span class="hljs-number">0</span>]             


……
（完整代码点击文末下方“阅读原文”查看）
</code></pre>
<p>返回结果展示：</p>
<pre><code class="hljs language-ini" lang="ini">================================ Human <span class="hljs-attr">Message</span> =================================

我在北京要去上海旅行3天，想去景点，拍点照片。
================================== Ai <span class="hljs-attr">Message</span> ==================================
Name: supervisor

为了帮助您规划这次北京到上海的3天旅行，我将协调以下几个专家的建议：

1. **天气专家（weather_agent）** - 提供上海未来几天的天气情况，以便您选择合适的衣物。
2. **地图专家（map_agent）** - 推荐上海的景点，以便您可以拍摄美丽的照片。
3. **穿衣专家（dressing_agent）** - 根据天气情况为您推荐合适的装扮。

稍等一下，我会先调用天气专家获取上海的天气情况。
Tool Calls:
  transfer_to_weather_agent (call_07EqbGkxmHZekxs9RCNdn90x) 
Call ID: call_07EqbGkxmHZekxs9RCNdn90x
  Args:
================================= Tool <span class="hljs-attr">Message</span> =================================
Name: transfer_to_weather_agent


……
（完整代码点击文末下方“阅读原文”查看）
</code></pre>
<p>从代码可以看出langgraph的可视化追踪能力还有点薄弱，如果需要达到OpenAI Agent SDK的效果需要可以尝试添加trace、graphstudio或者langsmith进行设计以实现可视化追踪。</p>
<h2 data-id="heading-13"><strong><strong>五、总结</strong></strong></h2>
<p>使用完OpenAI Agent SDK 和市面上的几个成熟框架的对比，个人认为未来AI应用肯定是工作流+多Agent的方向。对于工作流而言，就是让我们快速搭建出来一个MVP版本，感受下AI带来的效果到底如何，是否能达到预期，但是工作流随着业务迭代 如何有效的运维也是需要解决的问题。但是对于工程类项目，则需要定制化的开发，而且现在的AI需要应用到线上，部分业务场景需要保障确定性，这个使用OpenAI Agent SDK、LangGrap等开发框架是一个不错的选择。</p>
<h2 data-id="heading-14"><strong>六、参考</strong></h2>
<ol>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fopenai.github.io%2Fopenai-agents-python%2F" target="_blank" title="https://openai.github.io/openai-agents-python/" ref="nofollow noopener noreferrer">openai.github.io/openai-agen…</a></p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.dify.ai%2Fen%2Fintroduction" target="_blank" title="https://docs.dify.ai/en/introduction" ref="nofollow noopener noreferrer">docs.dify.ai/en/introduc…</a></p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.llamaindex.ai%2Fen%2Fstable%2F" target="_blank" title="https://docs.llamaindex.ai/en/stable/" ref="nofollow noopener noreferrer">docs.llamaindex.ai/en/stable/</a></p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Flangchain-ai.github.io%2Flanggraph%2Fconcepts%2Fwhy-langgraph%2F" target="_blank" title="https://langchain-ai.github.io/langgraph/concepts/why-langgraph/" ref="nofollow noopener noreferrer">langchain-ai.github.io/langgraph/c…</a></p>
</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[性能告警惊四座 神器出手伏恶龙]]></title>    <link>https://juejin.cn/post/7599237603976134699</link>    <guid>https://juejin.cn/post/7599237603976134699</guid>    <pubDate>2026-01-26T08:19:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599237603976134699" data-draft-id="7595167566144045075" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="性能告警惊四座 神器出手伏恶龙"/> <meta itemprop="keywords" content="后端,cpu"/> <meta itemprop="datePublished" content="2026-01-26T08:19:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Hello_world_"/> <meta itemprop="url" content="https://juejin.cn/user/2586510420095944"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            性能告警惊四座 神器出手伏恶龙
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2586510420095944/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Hello_world_
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T08:19:49.000Z" title="Mon Jan 26 2026 08:19:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>依旧题目顺口溜，准备考研</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/72cf5f97e9124ce18f9be41c59d433b5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGVsbG9fd29ybGRf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770020389&amp;x-signature=gQD2ORdPtvv%2FOx9UskHHbDkGgG4%3D" alt="cbfd292f99be38eec1bd3750c3b5ac656ea468cc.jpg" loading="lazy"/></p>
<h2 data-id="heading-0">前言</h2>
<p>问题年年有，今年特别多。作为一个刚工作一年多的人，我到底做了什么孽。除了搞定产品提的各种奇怪的需求，还要解决前人留下来的各种问题，我上早八。</p>
<blockquote>
<p>该问题实际发生并解决在2025年，年末赶KPI进度没来得及写总结</p>
</blockquote>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b18f3bf61edc4c77baf3088298da0180~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGVsbG9fd29ybGRf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770020389&amp;x-signature=Bnoh68mBr0ixIbSIosQWDYaNeGM%3D" alt="006BgMUjgy1i6b376m69qj306o06ojre.jpg" loading="lazy"/></p>
<h2 data-id="heading-1">事故场景</h2>
<p>让我们把时间拉回到问题发生的时间。这个问题发生在2025年12月29日下午3点。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9754fe03d2414bf8971f49b742f5dcb1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGVsbG9fd29ybGRf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770020389&amp;x-signature=GS5O84NtYTeuUTtHY6vz04Igjbc%3D" alt="image.png" loading="lazy"/>
收到告警后的第一时间，虽然还未排查出是什么原因导致的问题。第一时间对服务进行了扩容操作，避免问题进一步扩散。在完成扩容后，告警随即恢复。在恢复之后本想着可能就是正常的流量波动造成的。在后续时间里，该服务还是会偶尔报出CPU阈值告警。尤其在周末，关于CPU阈值告警更加频繁。CPU使用率最高可达90%以上</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b7bd39849a024905b8fa9ddc86ec003e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGVsbG9fd29ybGRf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770020389&amp;x-signature=qjduD9wdFMBO8G80Qtufz49hbRA%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-2">多维度排查</h2>
<p>在发生告警后，虽然第一时间采取了处理措施，但是并不知道是什么具体原因导致的CPU突然增高。随即我对该服务进行了多维度的排查。</p>
<h3 data-id="heading-3">代码维度</h3>
<p>首先，从代码维度分析CPU告警是否是有代码中存在不合理的代码逻辑造成程序出现大量计算逻辑（如：死循环、锁竞争等）。</p>
<p>首先分析代码是否存在死循环。根据告警前发布的代码以及CPU变化曲线分析，如果代码中存在死循环，那么当死循环触发后，CPU利用率将维持在一个较高水平或不断升高，并不会出现CPU利用率降低的情况出现。所以可排查是因代码死循环问题导致的CPU利用率升高。</p>
<p>使用<strong>jstack</strong>、<strong>jstat</strong>工具查看对应线程中锁竞争情况</p>
<p>jstack线程分析</p>
<pre><code class="hljs language-sh" lang="sh"><span class="hljs-comment"># 1. 获取目标Java进程ID </span>
jps -l 
<span class="hljs-comment"># 2. 导出线程栈（每隔5秒导出一次，共3次，对比锁状态） </span>
jstack 线程<span class="hljs-built_in">id</span> &gt; thread-1.log 
<span class="hljs-built_in">sleep</span> 5 
jstack 线程<span class="hljs-built_in">id</span> &gt; thread-2.log 
<span class="hljs-built_in">sleep</span> 5 
jstack 线程<span class="hljs-built_in">id</span> &gt; thread-3.log
</code></pre>
<p>jstat锁分析</p>
<pre><code class="hljs language-sh" lang="sh"><span class="hljs-comment"># 查看锁竞争相关统计（每1秒输出一次，共10次） </span>
jstat -s 线程<span class="hljs-built_in">id</span> 1000 10
</code></pre>
<p>根据<strong>jstack</strong>、<strong>jstat</strong>工具的执行结果分析，锁竞争的情况一直存在，而且在持续的正常流量中锁竞争情况相当保持稳定，不会有明显的升高或降低。所以可以排除因为锁竞争导致CPU升高的原因。</p>
<h3 data-id="heading-4">流量维度</h3>
<p>在排除因为代码维度导致CPU升高的之后，问题排查暂时陷入了停滞。我又重新回顾了该服务最近的变更，发现了可能是导致CPU升高的一个重要原因——<strong>流量升高</strong>。在发生CPU告警前，该服务接入了一个新的业务，使得核心接口的流量存在明显增大。日均调用量将会增加50W以上。</p>
<p>进一步对流量进行分析发现，该服务调用量增幅已达到40%。此时，似乎已经找到了造成CPU升高的元凶。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dba34cee97404888850b6744fbaa217d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGVsbG9fd29ybGRf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770020389&amp;x-signature=kRgfYMpX%2BWJK%2BTr%2FV241Bw9FPyk%3D" alt="s_a4e3b2bc9c4f4da68697fd0071dcbf15.jpg" loading="lazy"/></p>
<p>本该皆大欢喜，但在后续进一步排查时，发现万里长征还远没结束。</p>
<p>在查看接入新业务前，该服务CPU利用率的情况。发现在接入前，该服务CPU利用率虽然没有达到告警阈值，但其CPU利用率也处于较高的水平（最高可达50%）。该CPU利用率结合流量调用以及业务处理并不存在大量计算情况。该调用量不应该存在如此高的CPU利用率。</p>
<p>综合以上信息，我们可以确定流量的增加并不是导致CPU利用率升高的根本原因，但流量增加一定程度导致了CPU利用率的升高。</p>
<blockquote>
<p>在进一步分析时，发现2个集群的机器负载均衡相等的情况下CPU利用率有显著差异。联系相关运维人员后，得知集群A的机器性能本就不及集群B，在流量升高的情况下更加显著。</p>
</blockquote>
<h3 data-id="heading-5">JVM维度</h3>
<p>问题排查进度再次陷入了停滞。从代码层面、调用情况都无法排查出导致CPU升高的原因。只能再进一步深挖深层内容。Java程序什么是最深层的技术———<strong>JVM</strong>。</p>
<p>一想到要从JVM层面排查问题，啊？我吗？</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9ad1614adca3424d9d981b839ae33036~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGVsbG9fd29ybGRf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770020389&amp;x-signature=CC8js%2FVFZkpDPupeENXLALYuZLo%3D" alt="9e2cdc6569bf49239d1ebdf15ff0ed26.webp" loading="lazy"/></p>
<p>虽然内心十分抗拒，但是也不得不干啊。</p>
<p>在JVM层面若存在大量Yong GC、高频JIT编译、锁升级、类加载/卸载发生都会使得CPU利用率升高。在实际生产中更多是由于大量Yong GC导致的。</p>
<p>在查看CPU利用率处于高峰时的JVM运行情况，发现CPU处于某个峰值时，机器对应的JVM同时进行了较高次数的Yong GC。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c5900abc201243e0ba2f0354d450a62f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGVsbG9fd29ybGRf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770020389&amp;x-signature=PzVgn3IC8aK3XJ7g8JJk5wTRT9o%3D" alt="image.png" loading="lazy"/></p>
<p>从这里可以看出大量的GC操作是会导致CPU升高的。但是本次问题中Young GC和CPU升高的因果关系还需进一步确认。虽然CPU处于峰值时GC次数也处于高峰，但是GC次数处于平稳次数时，CPU利用率虽然没有达到峰值但是也处于较高水平。因此，可以判断出Yong GC次数是进一步导致CPU利用率升高的原因之一，并非导致CPU升高的主要原因。</p>
<h2 data-id="heading-6">神器出手</h2>
<p>在通过以上维度排查后，虽然找到了一些导致CPU升高的影响原因，但是还是没有排查出CPU升高的根本原因。在此之后，意识到可能是排查工具并不全面。在询问大佬后，了解到一个神器——<strong>Arthas</strong>。可以更加全面的分析程序运行情况。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/268fc1761ee44dee854d81bb4efafd0d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGVsbG9fd29ybGRf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770020389&amp;x-signature=i7xuFXKqV3GiIcEITLil2y9AKn8%3D" alt="0884e955562b16803cfb2aba68bef431432d4570.jpg" loading="lazy"/></p>
<p>在<a href="https://link.juejin.cn?target=https%3A%2F%2Farthas.aliyun.com%2F" target="_blank" title="https://arthas.aliyun.com/" ref="nofollow noopener noreferrer">Arthas官网</a>初步了解了其基本用法后，重新开始了CPU问题的排查。</p>
<p>首先，查看了服务运行期间CPU利用率最高的线程。</p>
<pre><code class="hljs language-sh" lang="sh">dashboard        <span class="hljs-comment"># 实时查看系统运行情况</span>
thread -n 5      <span class="hljs-comment"># 查看CPU利用率最高的5个线程</span>
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3f40ca3834234a9296833e5276bbc968~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGVsbG9fd29ybGRf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770020389&amp;x-signature=kl6ml8RrCN8GfqYRvb3es%2BD8Rrg%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7cd69f7894c14c38b142a33a459b0bee~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGVsbG9fd29ybGRf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770020389&amp;x-signature=8gNd96aTToqMvozeUco3CtpmtXI%3D" alt="image.png" loading="lazy"/></p>
<p>根据以上情况，基本可以判断是程序中业务代码导致的CPU利用率升高的。</p>
<p>进一步对业务线程进行分析</p>
<pre><code class="hljs language-sh" lang="sh"><span class="hljs-comment"># 如果发现某个线程CPU过高，查看其堆栈</span>
thread &lt;高CPU线程ID&gt;

<span class="hljs-comment"># 监控该线程一段时间</span>
thread -i 2000 &lt;线程ID&gt;

<span class="hljs-comment"># 生成性能报告进一步分析</span>
profiler start
<span class="hljs-comment"># 等待10秒</span>
profiler stop --format html
</code></pre>
<p>在得到业务线程火焰图后，不知好歹的我居然直接对火焰图进行分析，为什么说我不知好歹，请看VCR</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/62fb5593658f4465998bb3a07059dfe1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGVsbG9fd29ybGRf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770020389&amp;x-signature=P1i8GayJ1udbVFH35SENA7YbYOU%3D" alt="image.png" loading="lazy"/>
这个是人能分析的吗？果断扔给AI帮我分析，给出一个初步结论。然后我在针对性分析。AI得到的初步结论。</p>
<ul>
<li>存在大量数据转换操作</li>
<li>高频调用Jackson JSON序列化/反序列化操作</li>
</ul>
<p>以上2个操作是主要核心影响。在了解到这2个核心原因后，对于火焰图的分析便少了很多繁琐的操作。进一步分析得到，在业务代码中以下这个方法的调用占据CPU时长较高</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7737d97d12d0404eb3f906abc1690c96~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGVsbG9fd29ybGRf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770020389&amp;x-signature=X%2FvU7y%2Ft3aUs%2FiuoSIYnqRtePBY%3D" alt="image.png" loading="lazy"/></p>
<p>在对该方法业务代码分析过程中发现，该方法的业务功能是调用另一个服务的接口获取数据。照常来说这个接口调用属于IO操作，并不会是CPU升高。但是深挖代码后发现，该接口虽然是网络IO操作，但是在得到调用结果（Map）后，会反序列化为特定对象，该操作会使得CPU升高。</p>
<p>此外，在分析火焰图过程中，还发现了一个问题，存在一个工具类的大量调用</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5875dd7d13ae446a9dba7e456e3e82d9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGVsbG9fd29ybGRf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770020389&amp;x-signature=%2FHoyC2hSwpvpgr7qmMSma0N4J4g%3D" alt="image.png" loading="lazy"/></p>
<p>在分析出以上2个代码问题后，开始着手解决这2个代码问题造成的影响。首先想到的就是加缓存，避免重复数据多次运算。但是团队中使用的缓存组件是团队内自建的。而且代码中代码问题1的调用存在部分代码使用了缓存，然而其CPU利用率并没有得到降低。</p>
<p>在进一步对团队中缓存组件代码分析时发现，在缓存组件中存在大量代码问题2的工具类方法调用。该工具类代码大致如下</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; T <span class="hljs-title function_">parseObject</span><span class="hljs-params">(String json, TypeReference&lt;T&gt; type)</span> {
    <span class="hljs-keyword">try</span> {
        <span class="hljs-type">ObjectMapper</span> <span class="hljs-variable">objectMapper</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectMapper</span>();
        configObjectMapper(objectMapper);
        <span class="hljs-keyword">return</span> objectMapper.readValue(json, type);
    } <span class="hljs-keyword">catch</span> (IOException e) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FmsFastjsonIOException</span>(e);
    }
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; T <span class="hljs-title function_">parseObject</span><span class="hljs-params">(String json, Class&lt;T&gt; clazz)</span> {
    <span class="hljs-keyword">try</span> {
        <span class="hljs-type">ObjectMapper</span> <span class="hljs-variable">objectMapper</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectMapper</span>();
        configObjectMapper(objectMapper);
        <span class="hljs-keyword">return</span> objectMapper.readValue(json, clazz);
    } <span class="hljs-keyword">catch</span> (IOException e) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FmsFastjsonIOException</span>(e);
    }
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">toJSONString</span><span class="hljs-params">(Object object)</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">ObjectMapper</span> <span class="hljs-variable">objectMapper</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectMapper</span>();
            configObjectMapper(objectMapper);
            <span class="hljs-keyword">return</span> objectMapper.writeValueAsString(object);
        } <span class="hljs-keyword">catch</span> (JsonProcessingException e) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FmsFastjsonIOException</span>(e);
        }
    }
</code></pre>
<p>以上仅列举了几个方法，该工具类的本质是包装了Jackson序列化/反序列化的代码进行统一调用。以上代码看似符合业务需求。但是存在一个问题，每次方法调用都创建了一个新的ObjectMapper对象。这就使得其底层进行序列化/反序列化的时候，要重新生成对应的序列化器反/序列化器。在流量高峰期间该操作会反复执行就会导致CPU利用率升高。分析到这里，问题就明晰了。上述分析到代码问题1使用了缓存组件，但是缓存组件使用了不合适的序列化/反序列化代码，使得即便使用了缓存组件还是会使CPU利用率升高；代码问题2工具类的使用至今使用了不合适的序列化/反序列化代码，同样也导致了CPU利用率的升高。</p>
<p>分析到这里问题已经明确了，团队中对序列化/反序列化代码的不正确使用导致了服务CPU利用率的升高。</p>
<blockquote>
<p>在Jackson底层代码中，序列化/反序列化是采取了缓存策略的。该缓存并非缓存整个对象，而是对象类型及其对应的序列化器/反序列化器。无需再次生成进而降低了CPU利用率</p>
</blockquote>
<h2 data-id="heading-7">问题解决</h2>
<p>在分析出CPU利用率升高的根本问题后，剩下的工作就是解决序列化/反序列化的代码问题。该问题解决起来也十分简单，只需要调用序列化/反序列化操作是，使用同一个ObjectMapper对象即可。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">volatile</span> ObjectMapper MAPPER;


<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ObjectMapper <span class="hljs-title function_">getStaticMapper</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">if</span> (MAPPER == <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">synchronized</span> (JacksonUtil.class) {
            <span class="hljs-keyword">if</span> (MAPPER == <span class="hljs-literal">null</span>) {
                <span class="hljs-type">ObjectMapper</span> <span class="hljs-variable">tempMapper</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectMapper</span>();
                <span class="hljs-comment">// 禁用空Bean序列化时的失败</span>
                tempMapper.configure(SerializationFeature.FAIL_ON_EMPTY_BEANS, <span class="hljs-literal">false</span>);
                <span class="hljs-comment">// 忽略null值，只序列化非null字段（可选，根据需求调整）</span>
                tempMapper.setSerializationInclusion(JsonInclude.Include.NON_NULL);
                <span class="hljs-comment">// 如果需要处理未知属性，可以添加以下配置</span>
                tempMapper.configure(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES, <span class="hljs-literal">false</span>);
                MAPPER = tempMapper;
            }
        }
    }
    <span class="hljs-keyword">return</span> MAPPER;
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; Map&lt;String, T&gt; <span class="hljs-title function_">objectToMap</span><span class="hljs-params">(Object object)</span> {
    <span class="hljs-keyword">try</span> {
        <span class="hljs-type">ObjectMapper</span> <span class="hljs-variable">staticMapper</span> <span class="hljs-operator">=</span> getStaticMapper();
        <span class="hljs-type">String</span> <span class="hljs-variable">json</span> <span class="hljs-operator">=</span> staticMapper.writeValueAsString(object);
        <span class="hljs-keyword">return</span> staticMapper.readValue(json, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeReference</span>&lt;HashMap&lt;String, T&gt;&gt;() {});
    } <span class="hljs-keyword">catch</span> (IOException e) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FmsFastjsonIOException</span>(e);
    }
}
</code></pre>
<p>修改完代码后，查看代码运行情况。在相同时间段，该服务CPU利用率得到了大幅降低，降幅达50%以上。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f4d8ef5904ba441fbcb68034ca5a1959~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGVsbG9fd29ybGRf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770020389&amp;x-signature=hajCOjSap7k%2BxNUbngZQcRlmCYI%3D" alt="image.png" loading="lazy"/>
从结果来看，这次代码优化是成功的</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[8.BTC-挖矿-北大肖臻老师客堂笔记]]></title>    <link>https://juejin.cn/post/7599268297223897098</link>    <guid>https://juejin.cn/post/7599268297223897098</guid>    <pubDate>2026-01-26T08:32:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599268297223897098" data-draft-id="7599166436684415022" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="8.BTC-挖矿-北大肖臻老师客堂笔记"/> <meta itemprop="keywords" content="前端,区块链"/> <meta itemprop="datePublished" content="2026-01-26T08:32:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="前端涂涂"/> <meta itemprop="url" content="https://juejin.cn/user/3740972207312249"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            8.BTC-挖矿-北大肖臻老师客堂笔记
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3740972207312249/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    前端涂涂
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T08:32:45.000Z" title="Mon Jan 26 2026 08:32:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>这段视频是《区块链技术与应用》第 08 讲“BTC 挖矿”的内容，重点讲清楚：什么是全节点、矿工具体做什么、挖矿流程和策略，以及和前面“难度、工作量证明”的关系。</p>
<hr/>
<h2 data-id="heading-0">一、全节点的职责</h2>
<p>视频先从“全节点”说起，说明什么样的节点才算比特币系统中的全节点。</p>
<ul>
<li>一直在线：长时间运行程序、参与网络协议、持续收发区块和交易。</li>
<li>本地维护完整区块链：磁盘里保存从创世区块到当前高度的全部区块数据。</li>
<li>维护 UTXO 集合：在内存中维护当前“未花费输出集合”（UTXO set），用来快速验证转账是否真的有钱可花。UTXO 是检测双花（double spending）的关键数据结构。</li>
<li>监听并验证交易：从 P2P 网络中接收交易，对签名、余额、格式等做合法性检查，丢弃非法交易。</li>
<li>决定打包哪些交易：把合法交易放入本地的交易池（mempool），再从中挑选交易准备打包进新区块，一般优先手续费高的交易。</li>
<li>监听并验证区块：收到其他矿工挖出的新区块后，检查区块头、工作量证明（难度目标）、区块内所有交易是否合法，决定是否接受这个区块并接到当前最长合法链上。
全节点是“规则的执行者和裁判”，哪怕不挖矿，只要运行全节点就能帮助网络一起维护协议的正确性。</li>
</ul>
<hr/>
<h2 data-id="heading-1">二、矿工在全节点基础上的额外工作</h2>
<p>矿工本质上是“带挖矿功能的全节点”，在普通全节点的基础上，多做了几件事。</p>
<ul>
<li>选择要延长哪条链：
<ul>
<li>当存在多条合法链分支时，矿工按照“最长合法链”原则选择一个分支作为当前主链的末尾，在该链尾部继续挖新区块。</li>
</ul>
</li>
<li>构造候选区块：
<ul>
<li>从本地 UTXO 和 mempool 中挑出一批交易，组合成一个完整区块（区块头 + 区块体），并在区块体中加入一笔“铸币交易”（coinbase），把区块奖励和手续费打给自己控制的地址。</li>
</ul>
</li>
<li>做工作量证明（PoW）：
<ul>
<li>不断修改区块头中的随机数（nonce）或其他可调字段，反复计算区块头哈希，直到找到一个小于当前难度目标的哈希值，即完成挖矿。</li>
</ul>
</li>
</ul>
<p>因此，矿工的核心任务可以概括为两步：<br/>
1）选链；2）在所选链上构造合法区块并做 PoW 计算。</p>
<hr/>
<h2 data-id="heading-2">三、挖矿的具体流程</h2>
<p>视频对“矿工从接收交易到挖出区块”的过程做了较完整的串联。</p>
<ol>
<li>
<p>接收交易并存入 mempool</p>
<ul>
<li>矿工节点从网络接收交易，对每笔交易做完整验证（签名、余额、格式等），合法的放入本地交易池，非法的直接丢弃，不再转发。</li>
</ul>
</li>
<li>
<p>决定区块内容</p>
<ul>
<li>按一定策略（一般是优先手续费更高的交易）从 mempool 中选出一批交易，注意总大小不能超过区块大小上限。 <a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fweixin_43259286%2Farticle%2Fdetails%2F132406477" target="_blank" title="https://blog.csdn.net/weixin_43259286/article/details/132406477" ref="nofollow noopener noreferrer">blog.csdn</a></li>
<li>在这些交易前加入一笔 coinbase 交易，指定奖励的接收地址（矿工自己的地址）。</li>
</ul>
</li>
<li>
<p>构造区块头</p>
<ul>
<li>设置前一个区块的哈希（指向父区块）、Merkle 根、时间戳、难度目标等字段，形成一个待挖的区块头。</li>
</ul>
</li>
<li>
<p>执行 PoW</p>
<ul>
<li>不断修改 nonce 或额外字段，重复计算哈希，直到满足难度要求为止。</li>
<li>这是一个完全概率性的过程，算力越大，找到符合条件哈希的概率越高。</li>
</ul>
</li>
<li>
<p>广播新区块</p>
<ul>
<li>找到合法哈希后，矿工将新区块广播给网络中其他节点，对方验证通过后，将该区块接到各自的最长合法链上，并继续在这个新区块上向前挖矿。</li>
</ul>
</li>
</ol>
<hr/>
<h2 data-id="heading-3">四、分支与“沿哪条链挖下去”的策略</h2>
<p>视频强调了一点：由于网络延迟与挖矿的随机性，比特币系统中临时出现“多分支”的情况是正常现象。</p>
<ul>
<li>同时挖出两个区块：
<ul>
<li>不同矿工几乎同时在同一个高度挖出两个区块，部分节点先收到 A 区块，部分节点先收到 B 区块，于是形成两个长度相同的合法分支。</li>
</ul>
</li>
<li>矿工的策略：
<ul>
<li>每个矿工总是对“当前看到的最长合法链”的末尾进行挖矿，即只在自己认为的主链上继续延长。</li>
</ul>
</li>
<li>分支的消解：
<ul>
<li>之后某个分支先挖出下一个区块，就变成更长的链，网络中大多数节点会随之切换到更长的分支，另一条短分支变成“孤块链”，其区块奖励作废、对应交易需要重新被打包。</li>
</ul>
</li>
</ul>
<p>这一策略保证了长远来看全网会逐渐收敛到一个主链，但短期内允许存在暂时的不一致。</p>
<hr/>
<h2 data-id="heading-4">五、难度、收益与矿工行为（与前一讲的衔接）</h2>
<p>虽然“难度、出块时间”等细节主要在上一讲“挖矿难度”里展开，但本视频在讲挖矿行为时有若干关键承接点。</p>
<ul>
<li>出块时间和难度调节：
<ul>
<li>比特币系统以 10 分钟左右的平均出块时间为目标，通过全网算力与难度调整机制，使整体出块速度在长期统计上保持稳定。</li>
</ul>
</li>
<li>矿工收益构成：
<ul>
<li>每个新区块带有固定区块奖励 + 区块中所有交易的手续费，合计收益通过 coinbase 交易发给挖出区块的矿工。</li>
</ul>
</li>
<li>矿工的激励与安全性：
<ul>
<li>因为要投入大量算力与电费，矿工有动机遵守协议（否则挖出的非法区块会被全节点拒绝，无法获得奖励）。</li>
<li>大部分算力诚实执行规则时，比特币的安全性才能得到保障，这是 PoW 机制设计的根本出发点之一。</li>
</ul>
</li>
</ul>
<hr/>
<h2 data-id="heading-5">六、视频的整体逻辑结构总结</h2>
<p>可以把整个第 08 讲“BTC 挖矿”总结为下面的结构：</p>
<ol>
<li>先界定“全节点”的概念和职责：维护区块链、UTXO、验证交易与区块。</li>
<li>再在此基础上定义“矿工”：全节点 + 决定打包交易 + 执行 PoW 的节点。</li>
<li>详细讲挖矿流程：从接收交易、构造区块、PoW 计算，到广播新区块。</li>
<li>解释有分支时矿工如何选链、为什么会出现分叉，以及系统如何自然消解大多数临时分叉。</li>
<li>与上一讲的难度调整、收益机制衔接，强调挖矿行为背后的激励与安全性含义。</li>
</ol>
<p><img alt="在这里插入图片描述转存失败，建议直接上传图片文件" src="" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[@types 包的工作原理与最佳实践]]></title>    <link>https://juejin.cn/post/7599166436684202030</link>    <guid>https://juejin.cn/post/7599166436684202030</guid>    <pubDate>2026-01-26T07:45:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599166436684202030" data-draft-id="7599459943917764646" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="@types 包的工作原理与最佳实践"/> <meta itemprop="keywords" content="前端,JavaScript,TypeScript"/> <meta itemprop="datePublished" content="2026-01-26T07:45:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="wuhen_n"/> <meta itemprop="url" content="https://juejin.cn/user/4149996261738233"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            @types 包的工作原理与最佳实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4149996261738233/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    wuhen_n
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T07:45:58.000Z" title="Mon Jan 26 2026 07:45:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>当我们在使用 TypeScript 开发时，经常需要安装 <code>@types/xxx</code> 来获得第三方库的类型支持。这些神秘的 <code>@types</code> 包是如何工作的？<code>DefinitelyTyped</code> 又是什么？本篇文章将揭开这些类型包的神秘面纱。</p>
</blockquote>
<h2 data-id="heading-0">DefinitelyTyped：TypeScript的"类型宝库"</h2>
<h3 data-id="heading-1">什么是DefinitelyTyped？</h3>
<p><strong>DefinitelyTyped</strong>（简称DT），是 GitHub 上的一个开源项目，专门为 JavaScript 库提供高质量的 TypeScript 类型定义。它是 TypeScript 生态系统中最重要的基础设施之一。</p>
<p>举个例子，比如我们正在使用一个纯 JavaScript 库，例如 <code>lodash.js</code> ，这里面是没有类型信息的。在 JavaScript 中是可以工作的：<code>_.map([1,2,3], x =&gt; x * 2);</code>  。
但在 TypeScript 中：<code>import _ from 'lodash';</code>，就会报错：<code>找不到模块'lodash'的声明文件</code> 。这时我们就需要安装类型定义：<code>npm install --save-dev @types/lodash</code> ，然后 TypeScript 就能理解 <code>lodash</code> 了。</p>
<h3 data-id="heading-2">类型包是如何创建的？</h3>
<p>假设我们有一个原始的 JavaScript 库：<code>tiny-validator.js</code>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">validateEmail</span>(<span class="hljs-params">email</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-regexp">/^[^\s@]+@[^\s@]+\.[^\s@]+$/</span>.<span class="hljs-title function_">test</span>(email);
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">validatePhone</span>(<span class="hljs-params">phone</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-regexp">/^\d{10,11}$/</span>.<span class="hljs-title function_">test</span>(phone);
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">validateURL</span>(<span class="hljs-params">url</span>) {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">new</span> <span class="hljs-title function_">URL</span>(url);
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  } <span class="hljs-keyword">catch</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  }
}

<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  validateEmail,
  validatePhone,
  validateURL,
  <span class="hljs-attr">version</span>: <span class="hljs-string">'1.0.0'</span>
};
</code></pre>
<p>现在我们要为它创建类型：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 导出类型</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ValidationResult</span> {
  <span class="hljs-attr">isValid</span>: <span class="hljs-built_in">boolean</span>;
  message?: <span class="hljs-built_in">string</span>;
}

<span class="hljs-comment">// 导出函数</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">validateEmail</span>(<span class="hljs-params">email: <span class="hljs-built_in">string</span></span>): <span class="hljs-built_in">boolean</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">validateEmail</span>(<span class="hljs-params">email: <span class="hljs-built_in">string</span>, strict: <span class="hljs-literal">true</span></span>): <span class="hljs-title class_">ValidationResult</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">validatePhone</span>(<span class="hljs-params">phone: <span class="hljs-built_in">string</span></span>): <span class="hljs-built_in">boolean</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">validatePhone</span>(<span class="hljs-params">phone: <span class="hljs-built_in">string</span>, countryCode: <span class="hljs-built_in">string</span></span>): <span class="hljs-built_in">boolean</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">validateURL</span>(<span class="hljs-params">url: <span class="hljs-built_in">string</span></span>): <span class="hljs-built_in">boolean</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">validateURL</span>(<span class="hljs-params">url: <span class="hljs-built_in">string</span>, options: { requireProtocol: <span class="hljs-built_in">boolean</span> }</span>): <span class="hljs-built_in">boolean</span>;

<span class="hljs-comment">// 导出常量</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">version</span>: <span class="hljs-built_in">string</span>;

<span class="hljs-comment">// 默认导出</span>
<span class="hljs-keyword">declare</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">validator</span>: {
  <span class="hljs-attr">validateEmail</span>: <span class="hljs-keyword">typeof</span> validateEmail;
  <span class="hljs-attr">validatePhone</span>: <span class="hljs-keyword">typeof</span> validatePhone;
  <span class="hljs-attr">validateURL</span>: <span class="hljs-keyword">typeof</span> validateURL;
  <span class="hljs-attr">version</span>: <span class="hljs-keyword">typeof</span> version;
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> validator;
</code></pre>
<h2 data-id="heading-3">@types包的工作原理</h2>
<h3 data-id="heading-4">类型包的发布流程</h3>
<p>假设我们要发布一个 <code>@types/react</code> 包：</p>
<ol>
<li>在DefinitelyTyped提交PR，提交更改到 <code>types/react/</code>；</li>
<li>CI运行测试：
<ul>
<li>编译类型检查</li>
<li>运行类型测试</li>
<li>验证格式</li>
</ul>
</li>
<li>维护者审查</li>
<li>合并PR</li>
<li>自动发布到 npm 为 @types/react</li>
</ol>
<h3 data-id="heading-5">类型包如何被TypeScript识别</h3>
<p>TypeScript 会按以下顺序查找类型（以 <code>lodash</code> 为例）：</p>
<ol>
<li>当前文件的 .d.ts 声明</li>
<li>项目中的 .d.ts 文件</li>
<li>node_modules/@types/lodash/index.d.ts：DefinitelyTyped提供的</li>
<li>node_modules/lodash/package.json 中的 "types" 字段</li>
<li>node_modules/lodash/index.d.ts：库自带的类型</li>
</ol>
<p>当然，我们也可以通过配置 <code>tsconfig.json</code>，影响相关的顺序：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"compilerOptions"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"typeRoots"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-string">"./node_modules/@types"</span><span class="hljs-punctuation">,</span>  <span class="hljs-comment">// 默认包含</span>
      <span class="hljs-string">"./custom-types"</span>          <span class="hljs-comment">// 自定义类型目录</span>
    <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"types"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>                  <span class="hljs-comment">// 指定要包含的类型包</span>
      <span class="hljs-string">"node"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"lodash"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"react"</span>
    <span class="hljs-punctuation">]</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-6">版本管理：@types包的命名规则</h3>
<p>@types包的版本与对应库的版本关联，命名规则为：<code>@types/&lt;库名&gt;</code> ，可以看下面的示例：</p>

























<table><thead><tr><th>原始库</th><th>类型包</th><th>说明</th></tr></thead><tbody><tr><td>lodash</td><td>@types/lodash</td><td>与lodash主版本对应</td></tr><tr><td>react</td><td>@types/react</td><td>与react版本对应</td></tr><tr><td>node</td><td>@types/node</td><td>与Node.js版本对应</td></tr></tbody></table>
<blockquote>
<p>当然，也存在特殊情况：如带作用域的包：<code>@angular/core → @types/angular__core</code> 。</p>
</blockquote>
<h2 data-id="heading-7">类型包的版本管理</h2>
<h3 data-id="heading-8">@types/node的版本管理</h3>
<p><code>@types/node</code> 是所有 <code>@types</code> 包中最特殊的一个，因为它与Node.js运行时版本紧密绑定。</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-comment">// package.json 中的依赖</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"devDependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-comment">// @types/node的版本应该与你的Node.js版本匹配</span>
    <span class="hljs-attr">"@types/node"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^18.0.0"</span><span class="hljs-punctuation">,</span>  <span class="hljs-comment">// 对应Node.js 18.x</span>
    
    <span class="hljs-comment">// 其他类型包</span>
    <span class="hljs-attr">"@types/express"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^4.17.0"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"@types/lodash"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^4.14.0"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// @types/node的版本演进示例</span>
<span class="hljs-comment">// Node.js 16.x 的类型</span>
<span class="hljs-keyword">declare</span> <span class="hljs-variable language_">module</span> <span class="hljs-string">"fs/promises"</span> {
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">readFile</span>(<span class="hljs-params">path: <span class="hljs-built_in">string</span></span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">Buffer</span>&gt;;
  <span class="hljs-comment">// Node 16的API</span>
}

<span class="hljs-comment">// Node.js 18.x 新增了fetch API</span>
<span class="hljs-keyword">declare</span> <span class="hljs-variable language_">global</span> {
  <span class="hljs-comment">// Node 18新增了全局fetch</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-params">input: RequestInfo, init?: RequestInit</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">Response</span>&gt;;
  
  <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Request</span> {}
  <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Response</span> {}
}
</code></pre>
<p>这就是为什么我们在开发时需要：</p>
<ul>
<li>Node.js 16 → @types/node@16.x</li>
<li>Node.js 18 → @types/node@18.x</li>
<li>Node.js 20 → @types/node@20.x</li>
</ul>
<h3 data-id="heading-9">类型包的版本兼容性</h3>
<p>类型包版本不匹配/不兼容的问题，应该是我们在使用类型包时遇到的最常见也是最麻烦的问题。为什么会出现这样的问题呢？例如我们的项目中使用 <code>lodash@4.17.21</code> ，但实际上 <code>@types/lodash</code> 已经更新到了新版本，这样就出现了版本兼容性问题。</p>
<h4 data-id="heading-10">解决方案</h4>
<h5 data-id="heading-11">指定精确版本</h5>
<pre><code class="hljs language-bash" lang="bash">npm install @types/lodash@4.14.0  <span class="hljs-comment"># 安装特定版本</span>
</code></pre>
<h5 data-id="heading-12">查看库的package.json</h5>
<pre><code class="hljs language-typescript" lang="typescript">{
  <span class="hljs-string">"name"</span>: <span class="hljs-string">"my-library"</span>,
  <span class="hljs-string">"version"</span>: <span class="hljs-string">"2.0.0"</span>,
  <span class="hljs-string">"devDependencies"</span>: {
    <span class="hljs-string">"@types/lodash"</span>: <span class="hljs-string">"^4.14.0"</span>  # 推荐的类型版本
  }
}
</code></pre>
<h5 data-id="heading-13">使用peerDependencies</h5>
<pre><code class="hljs language-typescript" lang="typescript">{
  <span class="hljs-string">"name"</span>: <span class="hljs-string">"@types/my-library"</span>,
  <span class="hljs-string">"peerDependencies"</span>: {
    <span class="hljs-string">"my-library"</span>: <span class="hljs-string">"&gt;=2.0.0 &lt;3.0.0"</span>  # 要求原库版本
  }
}
</code></pre>
<h3 data-id="heading-14">如何选择合适的@types版本</h3>
<h4 data-id="heading-15">1. 检查你安装的库版本</h4>
<pre><code class="hljs language-json" lang="json"><span class="hljs-comment">// package.json</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"dependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"react"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"17.0.2"</span><span class="hljs-punctuation">,</span>      <span class="hljs-comment">// React 17.0.2</span>
    <span class="hljs-attr">"lodash"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"4.17.21"</span>     <span class="hljs-comment">// Lodash 4.17.21</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h4 data-id="heading-16">2. 查找对应的@types版本</h4>
<p>例如：
对于React 18，应该使用 @types/react@18.x.x
对于Lodash 4，应该使用 @types/lodash@4.x.x</p>
<h4 data-id="heading-17">3. 查看版本历史</h4>
<p>可以通过npm查看版本信息：</p>
<pre><code class="hljs language-bash" lang="bash">npm view @types/react versions  <span class="hljs-comment"># 查看所有版本</span>
npm view @types/react@18.0.0    <span class="hljs-comment"># 查看特定版本信息</span>
</code></pre>
<h4 data-id="heading-18">4. 在package.json中指定</h4>
<pre><code class="hljs language-typescript" lang="typescript">{
  <span class="hljs-string">"devDependencies"</span>: {
    <span class="hljs-string">"@types/react"</span>: <span class="hljs-string">"17.0.0"</span>,    <span class="hljs-comment">// 匹配React 17.0.x</span>
    <span class="hljs-string">"@types/lodash"</span>: <span class="hljs-string">"4.14.0"</span>    <span class="hljs-comment">// Lodash 4的类型</span>
  }
}
</code></pre>
<h4 data-id="heading-19">5. 处理冲突</h4>
<p>如果库A依赖 <code>@types/lodash@4.14.0</code>，而库B依赖 <code>@types/lodash@4.17.0</code> ，TypeScript会自动选择较高的版本（<code>4.17.0</code>）。这在大多数情况下是安全的，因为类型定义是向后兼容的。</p>
<h2 data-id="heading-20">常见问题</h2>
<h3 data-id="heading-21">多个类型包冲突</h3>
<p>场景：两个库都提供了相同的类型定义，例如：
在 <code>@types/jquery</code> 和 <code>@types/some-other-plugin</code> 两个包中都声明了全局的 <code>$</code>，导致冲突！</p>
<h4 data-id="heading-22">解决方案</h4>
<h5 data-id="heading-23">1. 使用模块声明而不是全局声明</h5>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">declare</span> <span class="hljs-variable language_">module</span> <span class="hljs-string">"jquery-plugin"</span> {
  <span class="hljs-keyword">import</span> $ <span class="hljs-keyword">from</span> <span class="hljs-string">"jquery"</span>;
  
  <span class="hljs-comment">// 使用导入的$，而不是声明全局的$</span>
  <span class="hljs-keyword">interface</span> <span class="hljs-title class_">JQuery</span> {
    <span class="hljs-title function_">myPlugin</span>(): <span class="hljs-title class_">JQuery</span>;
  }
}
</code></pre>
<h5 data-id="heading-24">2. 合并声明</h5>
<p>如果两个声明不冲突，可以共存：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">JQuery</span> {
  <span class="hljs-comment">// 来自jquery</span>
  <span class="hljs-title function_">hide</span>(): <span class="hljs-title class_">JQuery</span>;
  <span class="hljs-title function_">show</span>(): <span class="hljs-title class_">JQuery</span>;
  
  <span class="hljs-comment">// 来自plugin1</span>
  <span class="hljs-title function_">plugin1Method</span>(): <span class="hljs-title class_">JQuery</span>;
  
  <span class="hljs-comment">// 来自plugin2  </span>
  <span class="hljs-title function_">plugin2Method</span>(): <span class="hljs-title class_">JQuery</span>;
}
</code></pre>
<h5 data-id="heading-25">3. 在tsconfig中排除有问题的类型</h5>
<pre><code class="hljs language-typescript" lang="typescript">{
  <span class="hljs-string">"compilerOptions"</span>: {
    <span class="hljs-string">"types"</span>: [
      <span class="hljs-string">"jquery"</span>,           <span class="hljs-comment">// 包含jquery</span>
      <span class="hljs-comment">// "jquery-plugin"   // 排除冲突的插件类型</span>
    ]
  }
}
</code></pre>
<h3 data-id="heading-26">类型包版本不匹配</h3>
<p>场景：类型包版本与库版本不匹配，例如库版本为 <code>lodash@4.17.21</code> ，而类型包版本为 <code>@types/lodash@4.14.0</code> 。由于类型包版本较旧，导致缺失某个API，直接使用新版API会报错。</p>
<h4 data-id="heading-27">解决方案</h4>
<h5 data-id="heading-28">1. 升级类型包</h5>
<pre><code class="hljs language-bash" lang="bash">npm update @types/lodash@latest
</code></pre>
<h5 data-id="heading-29">2. 临时补充类型定义</h5>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// custom-types/lodash-extensions.d.ts</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'lodash'</span>;

<span class="hljs-keyword">declare</span> <span class="hljs-variable language_">module</span> <span class="hljs-string">'lodash'</span> {
  <span class="hljs-keyword">interface</span> <span class="hljs-title class_">LoDashStatic</span> {
    <span class="hljs-comment">// 补充缺失的方法</span>
    flattenDepth&lt;T&gt;(<span class="hljs-attr">array</span>: <span class="hljs-title class_">ListOfRecursiveArraysOrValues</span>&lt;T&gt;, depth?: <span class="hljs-built_in">number</span>): T[];
  }
}
</code></pre>
<h5 data-id="heading-30">3. 降级库版本（不推荐）</h5>
<pre><code class="hljs language-bash" lang="bash">npm install lodash@4.14.0  <span class="hljs-comment"># 与类型包匹配</span>
</code></pre>
<h3 data-id="heading-31">全局类型污染</h3>
<p>场景：类型包声明了全局类型，影响了我们的代码。例如：我们在使用 <code>@types/jest</code>，它声明了全局的 <code>describe</code>、<code>it</code>、<code>expect</code> 。但在我们的非测试代码中，这些是不应该存在的。</p>
<h4 data-id="heading-32">解决方案</h4>
<h5 data-id="heading-33">1. 隔离测试类型</h5>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 在 tsconfig.json 中</span>
{
  <span class="hljs-string">"extends"</span>: <span class="hljs-string">"./tsconfig.base.json"</span>,
  <span class="hljs-comment">// 主配置：排除测试类型</span>
  <span class="hljs-string">"compilerOptions"</span>: {
    <span class="hljs-string">"types"</span>: []  <span class="hljs-comment">// 不包含任何全局类型</span>
  },
  
  <span class="hljs-comment">// 测试配置</span>
  <span class="hljs-string">"tsconfig.test.json"</span>: {
    <span class="hljs-string">"extends"</span>: <span class="hljs-string">"./tsconfig.json"</span>,
    <span class="hljs-string">"compilerOptions"</span>: {
      <span class="hljs-string">"types"</span>: [<span class="hljs-string">"jest"</span>, <span class="hljs-string">"node"</span>]  <span class="hljs-comment">// 只在测试中包含</span>
    }
  }
}
</code></pre>
<h5 data-id="heading-34">2. 使用import代替全局</h5>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { describe, it, expect } <span class="hljs-keyword">from</span> <span class="hljs-string">'@jest/globals'</span>;

<span class="hljs-title function_">describe</span>(<span class="hljs-string">'test'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should work'</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">expect</span>(<span class="hljs-number">1</span> + <span class="hljs-number">1</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-number">2</span>);
  });
});
</code></pre>
<h3 data-id="heading-35">循环依赖的类型包</h3>
<p>现象：类型包相互依赖导致循环。例如：<code>@types/react</code> 依赖于 <code>@types/prop-types</code>；而 <code>@types/prop-types</code> 反过来又可能间接引用 <code>@types/react</code> 。结果就导致：导入循环或最大深度超出。</p>
<h4 data-id="heading-36">解决方案</h4>
<h5 data-id="heading-37">1. 使用 import type</h5>
<p>即：在类型包中，只导入类型，不导入值：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">ReactNode</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
</code></pre>
<h5 data-id="heading-38">2. 使用三斜线引用</h5>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">/// &lt;reference types="react" /&gt; // 这告诉TypeScript类型存在，但不导入</span>
</code></pre>
<blockquote>
<p>在 ES6 以前，JavaScript 并没有一个官方的模块系统，而是在不同的环境中，以不同的方式加上了这个缺失的特性。如 node.js 使用 <code>require</code> 和 <code>module.exports</code>；AMD 使用一个带回调的 <code>define</code> 函数。后来，TypeScript 通过 <strong>module</strong> 关键字和“<strong>三斜线</strong>”导入来填补了这个空白。</p>
</blockquote>
<blockquote>
<p><strong>module</strong> 关键字和“<strong>三斜线</strong>”导入只是一个历史遗迹，在 ES6+ 中，还是推荐 <code>import</code> 和 <code>export</code> 。</p>
</blockquote>
<h5 data-id="heading-39">3. 重新设计类型结构</h5>
<p>即：将共享类型提取到单独的文件：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// types/shared/index.d.ts</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">CommonProps</span> {
  className?: <span class="hljs-built_in">string</span>;
  style?: <span class="hljs-title class_">React</span>.<span class="hljs-property">CSSProperties</span>;
}

<span class="hljs-comment">// types/react/index.d.ts  </span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">CommonProps</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../shared'</span>;

<span class="hljs-comment">// types/vue/index.d.ts</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">CommonProps</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../shared'</span>;
</code></pre>
<h2 data-id="heading-40">最佳实践指南</h2>
<h3 data-id="heading-41">作为类型包使用者</h3>
<h4 data-id="heading-42">package.json 最佳配置</h4>
<pre><code class="hljs language-json" lang="json"><span class="hljs-comment">// package.json 最佳配置</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"my-app"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1.0.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"devDependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-comment">// 1. 匹配运行时版本</span>
    <span class="hljs-attr">"@types/node"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^18.0.0"</span><span class="hljs-punctuation">,</span>  <span class="hljs-comment">// 与Node.js版本匹配</span>
    
    <span class="hljs-comment">// 2. 使用^允许次要版本更新</span>
    <span class="hljs-attr">"@types/react"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^18.0.0"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"@types/react-dom"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^18.0.0"</span><span class="hljs-punctuation">,</span>
    
    <span class="hljs-comment">// 3. 按需安装，不要一次性安装所有@types</span>
    <span class="hljs-comment">// 错误做法：@types/* （安装所有）</span>
    <span class="hljs-comment">// 正确做法：只安装需要的</span>
    
    <span class="hljs-comment">// 4. 定期更新</span>
    <span class="hljs-comment">// npm update @types/*</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-comment">// 5. 添加类型检查脚本</span>
    <span class="hljs-attr">"type-check"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"tsc --noEmit"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"type-check:watch"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"tsc --noEmit --watch"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h4 data-id="heading-43">tsconfig.json 最佳配置</h4>
<pre><code class="hljs language-json" lang="json"><span class="hljs-comment">// tsconfig.json 最佳实践</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"compilerOptions"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-comment">// 1. 明确指定类型包</span>
    <span class="hljs-attr">"types"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-string">"node"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"react"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"react-dom"</span>
      <span class="hljs-comment">// 明确列出，避免意外包含</span>
    <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
    
    <span class="hljs-comment">// 2. 控制类型查找路径</span>
    <span class="hljs-attr">"typeRoots"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-string">"./node_modules/@types"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"./src/types"</span>  <span class="hljs-comment">// 自定义类型目录</span>
    <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
    
    <span class="hljs-comment">// 3. 启用严格检查</span>
    <span class="hljs-attr">"strict"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
    
    <span class="hljs-comment">// 4. 处理模块解析</span>
    <span class="hljs-attr">"moduleResolution"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"node"</span><span class="hljs-punctuation">,</span>
    
    <span class="hljs-comment">// 5. 确保兼容性</span>
    <span class="hljs-attr">"skipLibCheck"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>  <span class="hljs-comment">// 跳过库的类型检查，提高编译速度</span>
    <span class="hljs-attr">"forceConsistentCasingInFileNames"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  
  <span class="hljs-comment">// 6. 包含和排除文件</span>
  <span class="hljs-attr">"include"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-string">"src/**/*"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-string">"tests/**/*"</span>
  <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"exclude"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-string">"node_modules"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-string">"dist"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-string">"**/*.test.ts"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-string">"**/*.spec.ts"</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-44">作为类型包贡献者</h3>
<h4 data-id="heading-45">1. 使用函数重载而不是联合类型</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// ❌ 不好</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">parse</span>(<span class="hljs-params">input: <span class="hljs-built_in">string</span> | <span class="hljs-built_in">number</span></span>): <span class="hljs-title class_">Date</span>;

<span class="hljs-comment">// ✅ 更好</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">parse</span>(<span class="hljs-params">input: <span class="hljs-built_in">string</span></span>): <span class="hljs-title class_">Date</span>;
<span class="hljs-keyword">function</span> <span class="hljs-title function_">parse</span>(<span class="hljs-params">input: <span class="hljs-built_in">number</span></span>): <span class="hljs-title class_">Date</span>;
</code></pre>
<h4 data-id="heading-46">2. 使用泛型提高灵活性</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// ❌ 不灵活、不安全</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">getValue</span>(<span class="hljs-params">obj: <span class="hljs-built_in">any</span>, key: <span class="hljs-built_in">string</span></span>): <span class="hljs-built_in">any</span>;

<span class="hljs-comment">// ✅ 类型安全</span>
<span class="hljs-keyword">function</span> getValue&lt;T, K <span class="hljs-keyword">extends</span> keyof T&gt;(<span class="hljs-attr">obj</span>: T, <span class="hljs-attr">key</span>: K): T[K];
</code></pre>
<h4 data-id="heading-47">3. 提供完整的JSDoc注释</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">/**
 * 验证电子邮件地址
 * <span class="hljs-doctag">@param</span> <span class="hljs-variable">email</span> - 要验证的电子邮件地址
 * <span class="hljs-doctag">@param</span> <span class="hljs-variable">strict</span> - 是否进行严格验证
 * <span class="hljs-doctag">@returns</span> 验证结果
 * <span class="hljs-doctag">@example</span>
 * validateEmail('test<span class="hljs-doctag">@example</span>.com') // true
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">validateEmail</span>(<span class="hljs-params">email: <span class="hljs-built_in">string</span>, strict?: <span class="hljs-built_in">boolean</span></span>): <span class="hljs-built_in">boolean</span>;
</code></pre>
<h4 data-id="heading-48">4. 包含类型测试</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> _ = <span class="hljs-built_in">require</span>(<span class="hljs-string">'lodash'</span>);

<span class="hljs-comment">// 测试类型推断</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">numbers</span>: <span class="hljs-built_in">number</span>[] = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>];
<span class="hljs-keyword">const</span> doubled = _.<span class="hljs-title function_">map</span>(numbers, <span class="hljs-function"><span class="hljs-params">x</span> =&gt;</span> x * <span class="hljs-number">2</span>);  <span class="hljs-comment">// 应该推断为 number[]</span>

<span class="hljs-comment">// 测试边界情况</span>
_.<span class="hljs-title function_">chunk</span>([], <span class="hljs-number">2</span>);  <span class="hljs-comment">// 应该返回 [] 而不是 never[]</span>
</code></pre>
<h4 data-id="heading-49">5. 遵循命名约定</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 使用帕斯卡命名法（PascalCase）表示类型和接口</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserConfig</span> { <span class="hljs-comment">/* ... */</span> }
<span class="hljs-keyword">type</span> <span class="hljs-title class_">ValidationResult</span> = { <span class="hljs-comment">/* ... */</span> };

<span class="hljs-comment">// 使用驼峰命名法（camelCase）表示函数和变量</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">validateInput</span>(<span class="hljs-params">input: <span class="hljs-built_in">string</span></span>): <span class="hljs-built_in">boolean</span>;
<span class="hljs-keyword">const</span> <span class="hljs-attr">defaultConfig</span>: <span class="hljs-title class_">UserConfig</span> = { <span class="hljs-comment">/* ... */</span> };
</code></pre>
<h2 data-id="heading-50">TypeScript的演进</h2>
<p>TypeScript正在减少对@types的依赖</p>
<ol>
<li>声明文件自动生成：使用 <code>tsc --declaration</code> 自动生成 .d.ts 文件</li>
<li>更好的模块解析：TypeScript 4.7+ 改进了对 <code>package.json</code> 中 <code>exports</code> 的支持</li>
<li>类型导入优化：<code>import type</code> 语法，减少运行时依赖</li>
<li>部分类型检查：可以对 JavaScript 文件进行渐进式类型检查</li>
</ol>
<h2 data-id="heading-51">开发者建议</h2>
<h3 data-id="heading-52">库开发者：</h3>
<ol>
<li>用TypeScript编写你的库</li>
<li>发布时包含类型定义</li>
<li>使用严格类型检查</li>
<li>提供完整的API文档</li>
</ol>
<h3 data-id="heading-53">应用开发者：</h3>
<ol>
<li>优先选择有自带类型的库</li>
<li>定期更新@types包</li>
<li>学会阅读和理解类型定义</li>
<li>为缺失类型的库贡献类型定义</li>
</ol>
<h3 data-id="heading-54">类型维护者：</h3>
<ol>
<li>保持与上游库的同步</li>
<li>编写全面的类型测试</li>
<li>及时响应社区问题</li>
<li>遵循DefinitelyTyped的贡献指南</li>
</ol>
<h2 data-id="heading-55">结语</h2>
<p><code>@types</code> 生态系统是 TypeScript 成功的关键因素之一。通过 <code>DefinitelyTyped</code> 项目，社区为成千上万的 JavaScript 库提供了高质量的类型定义。对于文章中错误的地方或者有任何问题，欢迎在评论区留言讨论！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[3. 避坑+实战｜Vue3 hoistStatic静态提升，让渲染速度翻倍的秘密]]></title>    <link>https://juejin.cn/post/7599469598882709519</link>    <guid>https://juejin.cn/post/7599469598882709519</guid>    <pubDate>2026-01-26T07:52:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599469598882709519" data-draft-id="7599220371664977960" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="3. 避坑+实战｜Vue3 hoistStatic静态提升，让渲染速度翻倍的秘密"/> <meta itemprop="keywords" content="JavaScript,面试,Vue.js"/> <meta itemprop="datePublished" content="2026-01-26T07:52:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="boooooooom"/> <meta itemprop="url" content="https://juejin.cn/user/3078273283917399"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            3. 避坑+实战｜Vue3 hoistStatic静态提升，让渲染速度翻倍的秘密
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3078273283917399/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    boooooooom
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T07:52:09.000Z" title="Mon Jan 26 2026 07:52:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 Vue3 的编译优化体系中，<strong>静态提升（hoistStatic）</strong> 是核心性能优化手段之一。它通过在编译阶段识别并提取模板中的静态内容，避免每次组件渲染时重复创建、比对这些不变的节点，大幅减少运行时开销。本文将从“做了什么”“怎么做”“优化效果”三个维度，彻底讲清 hoistStatic 的底层逻辑与实际价值。</p>
<h2 data-id="heading-0">一、先搞懂：什么是“静态内容”？</h2>
<p>在分析静态提升前，需明确 Vue3 对“静态内容”的定义：</p>
<ul>
<li><strong>静态节点</strong>：内容完全固定、不会随响应式数据变化的节点（如 <code>&lt;div&gt;Hello Vue3&lt;/div&gt;</code>）；</li>
<li><strong>静态属性</strong>：值固定的属性（如 <code>class="title"</code>、<code>id="box"</code>）；</li>
<li><strong>静态树</strong>：由多个静态节点组成的完整子树（如纯静态的导航栏、页脚）。</li>
</ul>
<p>这些内容的特征是：<strong>组件生命周期内永远不会变化</strong>，若不做优化，每次组件重新渲染（如响应式数据更新）时，Vue 会重复创建这些节点的 VNode，并参与虚拟 DOM 比对，造成无意义的性能消耗。</p>
<h2 data-id="heading-1">二、hoistStatic 核心动作：3类静态内容的提升逻辑</h2>
<p>Vue3 的编译器在开启 <code>hoistStatic</code>（默认开启）后，会对不同类型的静态内容执行针对性提升，核心目标是“将静态内容移出渲染函数，仅创建一次，复用多次”。</p>
<h3 data-id="heading-2">1. 基础动作：静态节点提升至渲染函数外部</h3>
<p><strong>核心逻辑</strong>：将单个静态节点的 VNode 创建逻辑，从组件的渲染函数（<code>_render</code>）中提取到外部，仅在组件初始化时创建一次，后续渲染直接复用该 VNode。</p>
<h4 data-id="heading-3">优化前（未开启静态提升）</h4>
<p>每次渲染都会重新创建静态节点的 VNode：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 编译后的渲染函数（简化版）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">render</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">createVNode</span>(<span class="hljs-string">'div'</span>, <span class="hljs-literal">null</span>, [
    <span class="hljs-comment">// 静态节点：每次渲染都重新创建</span>
    <span class="hljs-title function_">createVNode</span>(<span class="hljs-string">'p'</span>, { <span class="hljs-attr">class</span>: <span class="hljs-string">'static'</span> }, <span class="hljs-string">'静态文本'</span>),
    <span class="hljs-comment">// 动态节点：随数据变化</span>
    <span class="hljs-title function_">createVNode</span>(<span class="hljs-string">'p'</span>, <span class="hljs-literal">null</span>, ctx.<span class="hljs-property">msg</span>)
  ])
}
</code></pre>
<h4 data-id="heading-4">优化后（开启静态提升）</h4>
<p>静态节点被提升到渲染函数外部，仅初始化一次：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 静态节点被提升到外部，仅创建一次</span>
<span class="hljs-keyword">const</span> _hoisted_1 = <span class="hljs-title function_">createVNode</span>(<span class="hljs-string">'p'</span>, { <span class="hljs-attr">class</span>: <span class="hljs-string">'static'</span> }, <span class="hljs-string">'静态文本'</span>)

<span class="hljs-comment">// 渲染函数中直接复用</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">render</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">createVNode</span>(<span class="hljs-string">'div'</span>, <span class="hljs-literal">null</span>, [
    _hoisted_1, <span class="hljs-comment">// 复用已创建的静态 VNode</span>
    <span class="hljs-title function_">createVNode</span>(<span class="hljs-string">'p'</span>, <span class="hljs-literal">null</span>, ctx.<span class="hljs-property">msg</span>)
  ])
}
</code></pre>
<h3 data-id="heading-5">2. 进阶动作：静态属性提升</h3>
<p>对于静态属性（如固定的 <code>class</code>、<code>id</code>、<code>style</code>），Vue3 会将其提取为常量，避免每次创建 VNode 时重复创建属性对象。</p>
<h4 data-id="heading-6">优化示例</h4>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 优化前：每次渲染创建新的属性对象</span>
<span class="hljs-title function_">createVNode</span>(<span class="hljs-string">'div'</span>, { <span class="hljs-attr">class</span>: <span class="hljs-string">'header'</span>, <span class="hljs-attr">id</span>: <span class="hljs-string">'nav'</span> }, <span class="hljs-string">'导航栏'</span>)

<span class="hljs-comment">// 优化后：静态属性提升为常量</span>
<span class="hljs-keyword">const</span> _hoisted_2 = { <span class="hljs-attr">class</span>: <span class="hljs-string">'header'</span>, <span class="hljs-attr">id</span>: <span class="hljs-string">'nav'</span> }
<span class="hljs-comment">// 渲染时复用属性对象</span>
<span class="hljs-title function_">createVNode</span>(<span class="hljs-string">'div'</span>, _hoisted_2, <span class="hljs-string">'导航栏'</span>)
</code></pre>
<h3 data-id="heading-7">3. 深度动作：静态树整体提升</h3>
<p>若模板中存在连续的静态节点组成的“静态树”（如整个页脚、纯静态的侧边栏），hoistStatic 会将整个静态树作为一个整体提升，而非单个节点拆分，进一步减少内存占用和创建开销。</p>
<h4 data-id="heading-8">优化示例（静态树）</h4>
<pre><code class="hljs language-ts" lang="ts">&lt;!-- 模板中的静态树 --&gt;
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">footer</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"footer-logo"</span>&gt;</span>Vue3<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"footer-text"</span>&gt;</span>版权所有 © 2026<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">footer</span>&gt;</span></span>

&lt;!-- 编译后：整个静态树被提升为单个 <span class="hljs-title class_">VNode</span> 常量 --&gt;
<span class="hljs-keyword">const</span> _hoisted_3 = <span class="hljs-title function_">createVNode</span>(<span class="hljs-string">'footer'</span>, <span class="hljs-literal">null</span>, [
  <span class="hljs-title function_">createVNode</span>(<span class="hljs-string">'div'</span>, { <span class="hljs-attr">class</span>: <span class="hljs-string">'footer-logo'</span> }, <span class="hljs-string">'Vue3'</span>),
  <span class="hljs-title function_">createVNode</span>(<span class="hljs-string">'div'</span>, { <span class="hljs-attr">class</span>: <span class="hljs-string">'footer-text'</span> }, <span class="hljs-string">'版权所有 © 2026'</span>)
])

<span class="hljs-comment">// 渲染函数中直接复用整棵树</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">render</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">createVNode</span>(<span class="hljs-string">'div'</span>, <span class="hljs-literal">null</span>, [
    <span class="hljs-comment">// 其他动态内容</span>
    _hoisted_3 <span class="hljs-comment">// 复用静态树</span>
  ])
}
</code></pre>
<h2 data-id="heading-9">三、静态提升的额外优化：跳过虚拟 DOM 比对</h2>
<p>Vue3 的虚拟 DOM 比对（patch）过程中，若识别到节点是“静态提升节点”，会直接跳过比对逻辑——因为已知这些节点不会变化，无需消耗性能检查属性、子节点是否更新。</p>
<p>核心逻辑伪代码：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">function</span> <span class="hljs-title function_">patch</span>(<span class="hljs-params">n1, n2</span>) {
  <span class="hljs-comment">// 静态节点：直接跳过比对，复用即可</span>
  <span class="hljs-keyword">if</span> (n2.<span class="hljs-property">shapeFlag</span> &amp; <span class="hljs-title class_">ShapeFlags</span>.<span class="hljs-property">STATIC</span>) {
    <span class="hljs-keyword">return</span>
  }
  <span class="hljs-comment">// 动态节点：执行常规比对逻辑</span>
  <span class="hljs-comment">// ...</span>
}
</code></pre>
<h2 data-id="heading-10">四、hoistStatic 的生效规则与避坑点</h2>
<h3 data-id="heading-11">1. 生效条件</h3>
<ul>
<li>仅对<strong>编译时能确定的静态内容</strong>生效（如固定文本、固定属性），含动态插值（<code>{{ msg }}</code>）、动态指令（<code>v-if</code>/<code>v-for</code>）的节点不参与提升；</li>
<li>Vue3 默认为生产环境开启 <code>hoistStatic</code>，开发环境可通过 <code>compilerOptions</code> 手动配置；</li>
<li>单个静态节点需满足“非根节点且无动态绑定”，才会被提升（根节点提升无意义）。</li>
</ul>
<h3 data-id="heading-12">2. 常见坑点</h3>
<ul>
<li><strong>误区1</strong>：认为“所有静态内容都会被提升”——Vue3 对极短的静态节点（如单个 <code>&lt;span&gt;123&lt;/span&gt;</code>）可能不提升，因为提升的内存开销大于收益；</li>
<li><strong>误区2</strong>：静态内容中混入动态指令（如 <code>v-on:click</code>）——含动态指令的节点会被判定为动态节点，无法提升；</li>
<li><strong>误区3</strong>：手动关闭 <code>hoistStatic</code>——除非有特殊编译需求，否则不要关闭，会显著降低渲染性能。</li>
</ul>
<h2 data-id="heading-13">五、实战验证：静态提升的性能收益</h2>
<p>以一个包含 100 个静态节点 + 1 个动态节点的组件为例：</p>
<ul>
<li>未开启静态提升：每次渲染需创建 101 个 VNode，执行 101 次虚拟 DOM 比对；</li>
<li>开启静态提升：每次渲染仅创建 1 个动态 VNode，100 个静态 VNode 复用，且跳过 100 次比对。</li>
</ul>
<p>实测数据（Vue3 官方基准测试）：</p>
<ul>
<li>渲染耗时降低约 30%~50%；</li>
<li>内存占用减少约 20%（避免重复创建 VNode 和属性对象）。</li>
</ul>
<h2 data-id="heading-14">总结</h2>
<h3 data-id="heading-15">关键点回顾</h3>
<ol>
<li>hoistStatic 核心是<strong>编译阶段提取静态内容</strong>，将其移出渲染函数，仅初始化一次、渲染时复用；</li>
<li>优化维度包括：静态节点、静态属性、静态树的提升，以及跳过静态节点的虚拟 DOM 比对；</li>
<li>仅对编译时确定的静态内容生效，含动态逻辑的节点无法提升，且需避免过度依赖静态提升优化动态场景。</li>
</ol>
<p>Vue3 的静态提升看似是“细节优化”，实则是从编译层面减少运行时无意义的计算，这也是 Vue3 相比 Vue2 渲染性能大幅提升的核心原因之一。理解其底层逻辑，能帮助你在开发中更合理地编写模板（如拆分静态/动态内容），最大化利用该优化特性。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从“一句话描述”到“专业级画作”：文生图、图生图、局部重绘、智能扩图一站式搞定]]></title>    <link>https://juejin.cn/post/7599485473706524710</link>    <guid>https://juejin.cn/post/7599485473706524710</guid>    <pubDate>2026-01-26T07:51:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599485473706524710" data-draft-id="7599268297223569418" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从“一句话描述”到“专业级画作”：文生图、图生图、局部重绘、智能扩图一站式搞定"/> <meta itemprop="keywords" content="开源"/> <meta itemprop="datePublished" content="2026-01-26T07:51:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="大厂技术总监下海"/> <meta itemprop="url" content="https://juejin.cn/user/4091714106833577"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从“一句话描述”到“专业级画作”：文生图、图生图、局部重绘、智能扩图一站式搞定
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4091714106833577/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    大厂技术总监下海
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T07:51:11.000Z" title="Mon Jan 26 2026 07:51:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    9
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">AUTOMATIC1111/stable-diffusion-webui 深度技术解读</h2>
<h3 data-id="heading-1">1. 整体介绍</h3>
<h4 data-id="heading-2">1.1 项目概况</h4>
<p><strong>AUTOMATIC1111/stable-diffusion-webui</strong> 是基于 Gradio 框架构建的 Stable Diffusion 模型 Web 图形界面，是目前 GitHub 上最受欢迎的 Stable Diffusion 前端实现之一（截至当前，GitHub stars 超过 100k，forks 超过 20k）。项目通过将复杂的命令行操作封装为直观的 Web 界面，大幅降低了使用先进生成式 AI 模型的技术门槛。</p>
<h4 data-id="heading-3">1.2 核心功能定位</h4>
<ul>
<li><strong>核心价值</strong>：提供本地化、一体化、可扩展的 Stable Diffusion 操作环境</li>
<li><strong>技术定位</strong>：介于原始 Stable Diffusion 代码库与云端服务之间的中间层</li>
<li><strong>用户界面</strong>：基于 Gradio 构建的响应式 Web 界面，支持实时交互</li>
</ul>
<h4 data-id="heading-4">1.3 解决的核心问题</h4>
<p><strong>传统方案痛点</strong>：</p>
<ol>
<li><strong>配置复杂</strong>：原始 Stable Diffusion 需要手动安装 PyTorch、配置 CUDA、管理依赖版本</li>
<li><strong>操作门槛高</strong>：依赖命令行参数和 Python 脚本，非技术用户难以使用</li>
<li><strong>功能分散</strong>：图像生成、模型管理、后处理等工具分散在不同项目中</li>
<li><strong>扩展困难</strong>：社区贡献难以集成，用户需要手动合并代码</li>
</ol>
<p><strong>本项目解决方案</strong>：</p>
<ol>
<li><strong>一体化安装</strong>：通过 <code>launch.py</code> 自动处理环境依赖和模型下载</li>
<li><strong>可视化操作</strong>：将命令行参数转化为 Web 表单控件</li>
<li><strong>模块化架构</strong>：通过插件系统支持功能扩展</li>
<li><strong>标准化接口</strong>：提供统一的 API 和配置管理</li>
</ol>
<h4 data-id="heading-5">1.4 商业价值分析</h4>
<p><strong>开发成本估算</strong>：</p>
<ul>
<li>核心框架开发：约 6-8 人月</li>
<li>Gradio 深度集成：约 2-3 人月</li>
<li>扩展系统设计：约 3-4 人月</li>
<li>测试与优化：约 2-3 人月</li>
<li><strong>总计估算</strong>：约 13-18 人月的高级开发投入</li>
</ul>
<p><strong>效益分析逻辑</strong>：</p>
<ol>
<li><strong>用户时间节省</strong>：相比手动配置，每个用户平均节省 4-8 小时初始化时间</li>
<li><strong>技术门槛降低</strong>：使非专业开发者能够使用先进 AI 模型</li>
<li><strong>社区生态价值</strong>：通过扩展系统形成正反馈循环，吸引开发者贡献</li>
<li><strong>模型普及推动</strong>：加速 Stable Diffusion 生态发展，间接促进硬件和云服务需求</li>
</ol>
<h3 data-id="heading-6">2. 详细功能拆解</h3>
<h4 data-id="heading-7">2.1 技术架构分层</h4>
<pre><code class="hljs language-scss" lang="scss">┌─────────────────────────────────────┐
│            Web 界面层               │
│  (Gradio Blocks + 自定义组件)       │
├─────────────────────────────────────┤
│          应用逻辑层                  │
│  (脚本回调 + 状态管理 + 队列控制)    │
├─────────────────────────────────────┤
│          核心服务层                  │
│  (模型加载 + 图像处理 + 扩展管理)    │
├─────────────────────────────────────┤
│          基础设施层                  │
│  (环境管理 + 依赖安装 + 配置持久化)  │
└─────────────────────────────────────┘
</code></pre>
<h4 data-id="heading-8">2.2 核心功能模块</h4>
<p><strong>1. 启动与环境管理 (<code>launch_utils.py</code>)</strong></p>
<ul>
<li>自动检测 Python 版本和 CUDA 环境</li>
<li>智能安装 PyTorch 和依赖包</li>
<li>Git 子模块管理和版本控制</li>
<li>扩展插件自动安装</li>
</ul>
<p><strong>2. Web 服务器与路由 (<code>webui.py</code>)</strong></p>
<ul>
<li>Gradio 应用生命周期管理</li>
<li>API 服务器模式支持</li>
<li>中间件配置（CORS、GZip）</li>
<li>会话状态持久化</li>
</ul>
<p><strong>3. 全局状态管理 (<code>shared.py</code>)</strong></p>
<ul>
<li>单例模式管理模型实例</li>
<li>配置选项的集中存储</li>
<li>线程安全的进度状态跟踪</li>
<li>主题和界面偏好管理</li>
</ul>
<p><strong>4. 模块初始化系统 (<code>initialize.py</code>)</strong></p>
<ul>
<li>延迟加载优化启动时间</li>
<li>动态模块导入和错误处理</li>
<li>配置恢复和状态回滚</li>
<li>钩子系统用于扩展点</li>
</ul>
<h3 data-id="heading-9">3. 技术难点与解决方案</h3>
<h4 data-id="heading-10">3.1 环境依赖复杂性管理</h4>
<p><strong>难点</strong>：Stable Diffusion 依赖特定版本的 PyTorch、xformers、CUDA 工具链，版本冲突常见。</p>
<p><strong>解决方案</strong>：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># launch_utils.py 中的版本适配逻辑</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">prepare_environment</span>():
    <span class="hljs-comment"># 根据平台和硬件自动选择 torch 安装命令</span>
    <span class="hljs-keyword">if</span> args.use_ipex:
        <span class="hljs-keyword">if</span> platform.system() == <span class="hljs-string">"Windows"</span>:
            <span class="hljs-comment"># Windows + Intel Arc GPU 的特殊处理</span>
            torch_command = <span class="hljs-string">"pip install 定制化IPEX包..."</span>
        <span class="hljs-keyword">else</span>:
            <span class="hljs-comment"># Linux 的官方 IPEX 包</span>
            torch_command = <span class="hljs-string">"pip install torch==2.0.0a0 intel-extension-for-pytorch..."</span>
    <span class="hljs-keyword">else</span>:
        <span class="hljs-comment"># 标准 NVIDIA CUDA 安装</span>
        torch_index_url = <span class="hljs-string">"https://download.pytorch.org/whl/cu121"</span>
        torch_command = <span class="hljs-string">f"pip install torch==2.1.2 torchvision==0.16.2 --extra-index-url <span class="hljs-subst">{torch_index_url}</span>"</span>
    
    <span class="hljs-comment"># 执行安装并验证</span>
    run(torch_command, <span class="hljs-string">"Installing torch and torchvision"</span>, <span class="hljs-string">"Couldn't install torch"</span>, live=<span class="hljs-literal">True</span>)
</code></pre>
<h4 data-id="heading-11">3.2 模型热加载与内存管理</h4>
<p><strong>难点</strong>：大模型（通常 2-7GB）加载耗时，多个模型切换时内存容易溢出。</p>
<p><strong>解决方案</strong>：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># shared.py 中的模型状态管理</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">SharedState</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
        self.sd_model = <span class="hljs-literal">None</span>  <span class="hljs-comment"># 当前加载的模型</span>
        self.models_cache = {}  <span class="hljs-comment"># 模型缓存（可选）</span>
        self.current_model_hash = <span class="hljs-literal">None</span>
        
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">load_model</span>(<span class="hljs-params">self, checkpoint_path</span>):
        <span class="hljs-comment"># 卸载当前模型释放显存</span>
        <span class="hljs-keyword">if</span> self.sd_model <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:
            self.unload_model()
        
        <span class="hljs-comment"># 加载新模型</span>
        model = load_model_from_checkpoint(checkpoint_path)
        
        <span class="hljs-comment"># 应用优化（xformers、注意力优化等）</span>
        <span class="hljs-keyword">if</span> args.xformers:
            apply_xformers_optimizations(model)
        
        self.sd_model = model
        self.current_model_hash = calculate_hash(checkpoint_path)
</code></pre>
<h4 data-id="heading-12">3.3 扩展系统设计与安全性</h4>
<p><strong>难点</strong>：支持第三方扩展的同时保证系统稳定性和安全性。</p>
<p><strong>解决方案</strong>：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># launch_utils.py 中的扩展安装器</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">run_extension_installer</span>(<span class="hljs-params">extension_dir</span>):
    path_installer = os.path.join(extension_dir, <span class="hljs-string">"install.py"</span>)
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> os.path.isfile(path_installer):
        <span class="hljs-keyword">return</span>
    
    <span class="hljs-keyword">try</span>:
        <span class="hljs-comment"># 隔离环境运行安装脚本</span>
        env = os.environ.copy()
        env[<span class="hljs-string">'PYTHONPATH'</span>] = <span class="hljs-string">f"<span class="hljs-subst">{script_path}</span><span class="hljs-subst">{os.pathsep}</span><span class="hljs-subst">{env.get(<span class="hljs-string">'PYTHONPATH'</span>, <span class="hljs-string">''</span>)}</span>"</span>
        
        <span class="hljs-comment"># 执行安装并捕获输出</span>
        stdout = run(<span class="hljs-string">f'"<span class="hljs-subst">{python}</span>" "<span class="hljs-subst">{path_installer}</span>"'</span>,
                    errdesc=<span class="hljs-string">f"Error running install.py for extension <span class="hljs-subst">{extension_dir}</span>"</span>,
                    custom_env=env).strip()
        <span class="hljs-keyword">if</span> stdout:
            <span class="hljs-built_in">print</span>(stdout)  <span class="hljs-comment"># 日志记录安装过程</span>
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-comment"># 优雅的错误处理，不破坏主程序</span>
        errors.report(<span class="hljs-built_in">str</span>(e))
</code></pre>
<h4 data-id="heading-13">3.4 实时进度反馈与队列管理</h4>
<p><strong>难点</strong>：长时间图像生成任务需要实时进度更新，同时支持并发请求。</p>
<p><strong>解决方案</strong>：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># webui.py 中的队列和进度管理</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">webui</span>():
    <span class="hljs-keyword">from</span> modules.call_queue <span class="hljs-keyword">import</span> queue_lock
    
    <span class="hljs-comment"># 创建 Gradio 界面</span>
    shared.demo = ui.create_ui()
    
    <span class="hljs-comment"># 配置任务队列</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> cmd_opts.no_gradio_queue:
        shared.demo.queue(<span class="hljs-number">64</span>)  <span class="hljs-comment"># 允许最多64个并发请求</span>
    
    <span class="hljs-comment"># 进度API设置</span>
    progress.setup_progress_api(app)
    
    <span class="hljs-comment"># 实时状态更新循环</span>
    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:
        server_command = shared.state.wait_for_server_command(timeout=<span class="hljs-number">5</span>)
        <span class="hljs-keyword">if</span> server_command == <span class="hljs-string">"stop"</span>:
            <span class="hljs-keyword">break</span>
        <span class="hljs-keyword">elif</span> server_command == <span class="hljs-string">"restart"</span>:
            <span class="hljs-comment"># 优雅重启逻辑</span>
            handle_restart()
</code></pre>
<h3 data-id="heading-14">4. 详细设计图</h3>
<h4 data-id="heading-15">4.1 系统架构图</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    A[用户浏览器] --&gt; B[Gradio HTTP Server]
    B --&gt; C{路由分发}
    
    C --&gt;|API请求| D[FastAPI Endpoints]
    C --&gt;|UI请求| E[Gradio Blocks UI]
    
    D --&gt; F[API Handler]
    E --&gt; G[UI Event Handler]
    
    F --&gt; H[Task Queue]
    G --&gt; H
    
    H --&gt; I[Model Executor]
    I --&gt; J[Stable Diffusion Model]
    I --&gt; K[Extension System]
    
    J --&gt; L[Image Processor]
    K --&gt; L
    
    L --&gt; M[Result Cache]
    M --&gt; N[Response Formatter]
    
    N --&gt;|JSON| O[API Client]
    N --&gt;|Image/HTML| P[Web UI]
    
    subgraph "核心服务"
        H
        I
        J
        L
    end
    
    subgraph "扩展系统"
        K
        Q[Custom Scripts]
        R[Extra Networks]
        S[UI Extensions]
    end
    
    subgraph "基础设施"
        T[Config Manager]
        U[Model Loader]
        V[Environment Manager]
    end
</code></pre>
<h4 data-id="heading-16">4.2 启动序列图</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant U as User
    participant L as launch.py
    participant LU as launch_utils
    participant W as webui.py
    participant I as initialize.py
    participant S as shared.py
    
    U-&gt;&gt;L: 执行 python launch.py
    L-&gt;&gt;LU: main()
    LU-&gt;&gt;LU: prepare_environment()
    
    alt 环境检查
        LU-&gt;&gt;LU: check_python_version()
        LU-&gt;&gt;LU: 安装依赖包
        LU-&gt;&gt;LU: 克隆模型仓库
    end
    
    LU-&gt;&gt;W: start()
    
    alt API模式
        W-&gt;&gt;W: api_only()
        W-&gt;&gt;I: initialize()
        I-&gt;&gt;S: 初始化全局状态
        W-&gt;&gt;W: 创建FastAPI应用
        W-&gt;&gt;W: 启动API服务器
    else WebUI模式
        W-&gt;&gt;W: webui()
        W-&gt;&gt;I: initialize()
        I-&gt;&gt;S: 初始化全局状态
        W-&gt;&gt;W: create_ui()
        W-&gt;&gt;W: demo.launch()
        W-&gt;&gt;W: 进入主事件循环
    end
    
    W--&gt;&gt;U: 服务就绪
</code></pre>
<h4 data-id="heading-17">4.3 核心类图</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">classDiagram
    class LaunchUtils {
        -python: str
        -git: str
        -index_url: str
        +prepare_environment()
        +run_pip()
        +git_clone()
        +is_installed()
        +run()
    }
    
    class WebUI {
        -startup_timer
        +api_only()
        +webui()
        -create_api()
    }
    
    class SharedState {
        -sd_model
        -opts
        -state
        +load_model()
        +unload_model()
        +get_progress()
    }
    
    class Options {
        -data: dict
        +onchange()
        +save()
        +load()
    }
    
    class ScriptCallbacks {
        +before_ui_callback()
        +app_started_callback()
        +script_unloaded_callback()
    }
    
    class ExtensionManager {
        -extensions_dir
        +list_extensions()
        +run_installers()
        +load_extension()
    }
    
    LaunchUtils --&gt; WebUI : 启动
    WebUI --&gt; SharedState : 使用
    SharedState --&gt; Options : 包含
    WebUI --&gt; ScriptCallbacks : 回调
    ScriptCallbacks --&gt; ExtensionManager : 管理
</code></pre>
<h3 data-id="heading-18">5. 核心函数解析</h3>
<h4 data-id="heading-19">5.1 环境准备函数 (<code>prepare_environment</code>)</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">prepare_environment</span>():
    <span class="hljs-string">"""核心环境初始化函数，处理所有前置依赖"""</span>
    <span class="hljs-comment"># 1. 配置 Torch 安装源和版本</span>
    torch_index_url = os.environ.get(<span class="hljs-string">'TORCH_INDEX_URL'</span>, <span class="hljs-string">"https://download.pytorch.org/whl/cu121"</span>)
    torch_command = os.environ.get(<span class="hljs-string">'TORCH_COMMAND'</span>, 
        <span class="hljs-string">f"pip install torch==2.1.2 torchvision==0.16.2 --extra-index-url <span class="hljs-subst">{torch_index_url}</span>"</span>)
    
    <span class="hljs-comment"># 2. 硬件特定优化（Intel IPEX）</span>
    <span class="hljs-keyword">if</span> args.use_ipex:
        <span class="hljs-keyword">if</span> platform.system() == <span class="hljs-string">"Windows"</span>:
            <span class="hljs-comment"># Windows + Intel Arc 的特殊构建</span>
            url_prefix = <span class="hljs-string">"https://github.com/Nuullll/intel-extension-for-pytorch/releases/download/..."</span>
            torch_command = <span class="hljs-string">f"pip install <span class="hljs-subst">{url_prefix}</span>/torch-2.0.0a0...whl"</span>
    
    <span class="hljs-comment"># 3. 基础依赖检查与安装</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> args.skip_torch_cuda_test <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> check_run_python(<span class="hljs-string">"import torch; assert torch.cuda.is_available()"</span>):
        <span class="hljs-keyword">raise</span> RuntimeError(<span class="hljs-string">'Torch is not able to use GPU'</span>)
    
    <span class="hljs-comment"># 4. 克隆必要的模型仓库</span>
    git_clone(assets_repo, repo_dir(<span class="hljs-string">'stable-diffusion-webui-assets'</span>), <span class="hljs-string">"assets"</span>, assets_commit_hash)
    git_clone(stable_diffusion_repo, repo_dir(<span class="hljs-string">'stable-diffusion-stability-ai'</span>), 
              <span class="hljs-string">"Stable Diffusion"</span>, stable_diffusion_commit_hash)
    
    <span class="hljs-comment"># 5. 安装 Python 依赖包</span>
    requirements_file = os.environ.get(<span class="hljs-string">'REQS_FILE'</span>, <span class="hljs-string">"requirements_versions.txt"</span>)
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> requirements_met(requirements_file):
        run_pip(<span class="hljs-string">f"install -r \"<span class="hljs-subst">{requirements_file}</span>\""</span>, <span class="hljs-string">"requirements"</span>)
    
    <span class="hljs-comment"># 6. 扩展插件安装</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> args.skip_install:
        run_extensions_installers(settings_file=args.ui_settings_file)
</code></pre>
<h4 data-id="heading-20">5.2 模块初始化函数 (<code>initialize</code>)</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">initialize</span>():
    <span class="hljs-string">"""核心模块初始化，实现按需加载"""</span>
    <span class="hljs-keyword">from</span> modules <span class="hljs-keyword">import</span> initialize_util
    
    <span class="hljs-comment"># 1. 系统级修复和配置</span>
    initialize_util.fix_torch_version()        <span class="hljs-comment"># 修复 torch 版本字符串</span>
    initialize_util.fix_asyncio_event_loop_policy()  <span class="hljs-comment"># 修复异步事件循环</span>
    initialize_util.configure_sigint_handler() <span class="hljs-comment"># 配置信号处理</span>
    
    <span class="hljs-comment"># 2. 模型系统初始化</span>
    <span class="hljs-keyword">from</span> modules <span class="hljs-keyword">import</span> sd_models
    sd_models.setup_model()  <span class="hljs-comment"># 设置模型加载路径和缓存</span>
    
    <span class="hljs-comment"># 3. 后处理模型加载（按需）</span>
    <span class="hljs-keyword">from</span> modules <span class="hljs-keyword">import</span> codeformer_model, gfpgan_model
    codeformer_model.setup_model(cmd_opts.codeformer_models_path)
    gfpgan_model.setup_model(cmd_opts.gfpgan_models_path)
    
    <span class="hljs-comment"># 4. 扩展系统初始化</span>
    initialize_rest(reload_script_modules=<span class="hljs-literal">False</span>)

<span class="hljs-keyword">def</span> <span class="hljs-title function_">initialize_rest</span>(<span class="hljs-params">*, reload_script_modules=<span class="hljs-literal">False</span></span>):
    <span class="hljs-string">"""辅助初始化函数，支持重载"""</span>
    <span class="hljs-keyword">from</span> modules <span class="hljs-keyword">import</span> scripts, extensions, sd_models
    
    <span class="hljs-comment"># 1. 加载采样器配置</span>
    <span class="hljs-keyword">from</span> modules <span class="hljs-keyword">import</span> sd_samplers
    sd_samplers.set_samplers()
    
    <span class="hljs-comment"># 2. 扩展脚本动态加载</span>
    <span class="hljs-keyword">with</span> startup_timer.subcategory(<span class="hljs-string">"load scripts"</span>):
        scripts.load_scripts()  <span class="hljs-comment"># 从 extensions_dir 加载用户脚本</span>
    
    <span class="hljs-comment"># 3. 模型列表刷新</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> shared.cmd_opts.ui_debug_mode:
        sd_models.list_models()  <span class="hljs-comment"># 扫描 models 目录</span>
    
    <span class="hljs-comment"># 4. 后台线程加载主模型（优化启动体验）</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> shared.cmd_opts.skip_load_model_at_start:
        Thread(target=load_model).start()  <span class="hljs-comment"># 异步加载避免界面卡顿</span>
</code></pre>
<h4 data-id="heading-21">5.3 Gradio 应用启动函数 (<code>webui</code>)</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">webui</span>():
    <span class="hljs-string">"""主 Web UI 启动函数，管理完整的应用生命周期"""</span>
    <span class="hljs-keyword">from</span> modules.shared_cmd_options <span class="hljs-keyword">import</span> cmd_opts
    launch_api = cmd_opts.api
    
    <span class="hljs-comment"># 1. 系统初始化</span>
    initialize.initialize()
    
    <span class="hljs-comment"># 2. 创建 Gradio 界面组件</span>
    <span class="hljs-keyword">from</span> modules <span class="hljs-keyword">import</span> shared, ui, script_callbacks
    shared.demo = ui.create_ui()  <span class="hljs-comment"># 构建所有UI标签页和控件</span>
    
    <span class="hljs-comment"># 3. 配置任务队列（支持并发）</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> cmd_opts.no_gradio_queue:
        shared.demo.queue(<span class="hljs-number">64</span>)  <span class="hljs-comment"># 设置队列大小</span>
    
    <span class="hljs-comment"># 4. 启动 Gradio 服务器</span>
    app, local_url, share_url = shared.demo.launch(
        share=cmd_opts.share,                    <span class="hljs-comment"># 是否生成公网链接</span>
        server_name=initialize_util.gradio_server_name(),  <span class="hljs-comment"># 绑定地址</span>
        server_port=cmd_opts.port,               <span class="hljs-comment"># 端口号</span>
        auth=gradio_auth_creds,                  <span class="hljs-comment"># 身份验证</span>
        inbrowser=auto_launch_browser,           <span class="hljs-comment"># 自动打开浏览器</span>
        prevent_thread_lock=<span class="hljs-literal">True</span>,                <span class="hljs-comment"># 不阻塞主线程</span>
        root_path=<span class="hljs-string">f"/<span class="hljs-subst">{cmd_opts.subpath}</span>"</span> <span class="hljs-keyword">if</span> cmd_opts.subpath <span class="hljs-keyword">else</span> <span class="hljs-string">""</span>
    )
    
    <span class="hljs-comment"># 5. 安全加固：移除过于宽松的 CORS 设置</span>
    app.user_middleware = [x <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> app.user_middleware 
                          <span class="hljs-keyword">if</span> x.cls.__name__ != <span class="hljs-string">'CORSMiddleware'</span>]
    initialize_util.setup_middleware(app)  <span class="hljs-comment"># 应用自定义中间件</span>
    
    <span class="hljs-comment"># 6. 注册 API 端点</span>
    <span class="hljs-keyword">if</span> launch_api:
        create_api(app)  <span class="hljs-comment"># 创建 RESTful API</span>
    
    <span class="hljs-comment"># 7. 扩展回调系统</span>
    script_callbacks.app_started_callback(shared.demo, app)
    
    <span class="hljs-comment"># 8. 主事件循环（支持重启）</span>
    <span class="hljs-keyword">try</span>:
        <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:
            server_command = shared.state.wait_for_server_command(timeout=<span class="hljs-number">5</span>)
            <span class="hljs-keyword">if</span> server_command == <span class="hljs-string">"stop"</span>:
                <span class="hljs-keyword">break</span>
            <span class="hljs-keyword">elif</span> server_command == <span class="hljs-string">"restart"</span>:
                handle_restart()  <span class="hljs-comment"># 优雅重启逻辑</span>
    <span class="hljs-keyword">except</span> KeyboardInterrupt:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">'Caught KeyboardInterrupt, stopping...'</span>)
    
    <span class="hljs-comment"># 9. 清理资源</span>
    shared.demo.close()
</code></pre>
<h3 data-id="heading-22">6. 同类技术对比</h3>
<h4 data-id="heading-23">6.1 与 ComfyUI 对比</h4>



































<table><thead><tr><th>特性</th><th>AUTOMATIC1111 WebUI</th><th>ComfyUI</th></tr></thead><tbody><tr><td><strong>学习曲线</strong></td><td>较低，传统表单界面</td><td>较高，节点式工作流</td></tr><tr><td><strong>扩展性</strong></td><td>插件系统，Python脚本</td><td>节点系统，可视化编程</td></tr><tr><td><strong>性能</strong></td><td>优化良好，支持低显存</td><td>需要更多显存，但流程更灵活</td></tr><tr><td><strong>社区生态</strong></td><td>极活跃，扩展丰富</td><td>增长迅速，工作流分享多</td></tr><tr><td><strong>适用场景</strong></td><td>常规图像生成、快速迭代</td><td>复杂流程、批量处理、研究</td></tr></tbody></table>
<h4 data-id="heading-24">6.2 与 DiffusionBee (macOS) 对比</h4>



































<table><thead><tr><th>维度</th><th>WebUI</th><th>DiffusionBee</th></tr></thead><tbody><tr><td><strong>安装复杂度</strong></td><td>中等，需要Python环境</td><td>简单，直接安装</td></tr><tr><td><strong>功能完整性</strong></td><td>完整，支持所有高级功能</td><td>基础，核心生成功能</td></tr><tr><td><strong>可定制性</strong></td><td>极高，完全开源可修改</td><td>有限，闭源软件</td></tr><tr><td><strong>跨平台</strong></td><td>Windows/Linux/macOS</td><td>macOS 专属</td></tr><tr><td><strong>更新频率</strong></td><td>每日更新，快速迭代</td><td>较慢，稳定发布</td></tr></tbody></table>
<h3 data-id="heading-25">7. 技术演进建议</h3>
<h4 data-id="heading-26">7.1 架构优化方向</h4>
<ol>
<li><strong>模块解耦</strong>：进一步分离界面逻辑与生成逻辑</li>
<li><strong>微服务化</strong>：考虑将模型服务、UI服务、扩展服务分离部署</li>
<li><strong>配置即代码</strong>：支持声明式配置，便于版本控制和团队协作</li>
</ol>
<h4 data-id="heading-27">7.2 性能提升建议</h4>
<ol>
<li><strong>模型预热</strong>：后台预加载常用模型减少等待时间</li>
<li><strong>结果缓存</strong>：实现生成结果的智能缓存和复用</li>
<li><strong>渐进式加载</strong>：超大界面按需加载组件，提升初次打开速度</li>
</ol>
<h4 data-id="heading-28">7.3 安全增强</h4>
<ol>
<li><strong>扩展沙箱</strong>：对第三方脚本运行环境隔离</li>
<li><strong>输入验证</strong>：加强提示词和参数的安全检查</li>
<li><strong>访问控制</strong>：更细粒度的权限管理系统</li>
</ol>
<h3 data-id="heading-29">总结</h3>
<p>AUTOMATIC1111/stable-diffusion-webui 通过精心设计的模块化架构和稳健的工程实现，成功地将复杂的 Stable Diffusion 模型封装为易用的 Web 应用。其核心价值不仅在于功能丰富性，更在于：</p>
<ol>
<li><strong>工程完备性</strong>：从环境管理到错误处理都体现了生产级软件的考量</li>
<li><strong>扩展友好性</strong>：设计良好的回调系统和配置管理支持生态发展</li>
<li><strong>渐进式复杂度</strong>：界面设计既满足初学者也能服务高级用户</li>
<li><strong>社区驱动</strong>：开源协作模式确保了快速迭代和问题修复</li>
</ol>
<p>项目在技术实现上平衡了易用性与灵活性，通过合理的抽象层设计，使得底层模型升级和界面功能扩展能够相对独立地进行，这是其能够长期保持活跃和领先的关键架构优势。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[用 Three.js + D3.js 实现可交互 3D 中国地图（省份聚焦 / 飞线 / 光柱）]]></title>    <link>https://juejin.cn/post/7599299048302493739</link>    <guid>https://juejin.cn/post/7599299048302493739</guid>    <pubDate>2026-01-26T07:51:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599299048302493739" data-draft-id="7598938568432205839" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="用 Three.js + D3.js 实现可交互 3D 中国地图（省份聚焦 / 飞线 / 光柱）"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-26T07:51:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="scorpioop"/> <meta itemprop="url" content="https://juejin.cn/user/2683248842638445"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            用 Three.js + D3.js 实现可交互 3D 中国地图（省份聚焦 / 飞线 / 光柱）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2683248842638445/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    scorpioop
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T07:51:49.000Z" title="Mon Jan 26 2026 07:51:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">用 Three.js + D3.js 实现可交互 3D 中国地图（省份聚焦 / 飞线 / 光柱）</h2>
<blockquote>
<p>本文将完整拆解一个 <strong>Three.js + D3.js</strong> 实现的 3D 中国地图项目，包含：</p>
<ul>
<li>GeoJSON 转 3D 地图</li>
<li>省份点击高亮 + 相机平滑聚焦</li>
<li>光柱数据可视化</li>
<li>城市飞线动画</li>
<li>CSS2D 标签系统</li>
</ul>
</blockquote>
<hr/>
<h3 data-id="heading-1">一、整体效果预览</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/00f10373f1c045afbb064ad4556e3ea1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc2NvcnBpb29w:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770018708&amp;x-signature=kYedP%2FMI%2BVRQWAesN20SLTzUOR4%3D" alt="ScreenShot_2026-01-26_150821_367.png" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-2">二、技术栈说明</h3>
<pre><code class="hljs language-arduino" lang="arduino">Three.js        <span class="hljs-comment">// 3D 渲染</span>
D3-geo          <span class="hljs-comment">// 经纬度 → 平面坐标</span>
CSS2DRenderer   <span class="hljs-comment">// DOM 标签</span>
GeoJSON         <span class="hljs-comment">// 中国地图数据</span>
React Hooks     <span class="hljs-comment">// 生命周期管理</span>
</code></pre>
<hr/>
<h3 data-id="heading-3">三、GeoJSON → Three.js 3D 地图</h3>
<p>通过geoJson数据创建地图形状，geoJson数据可以从<a href="https://link.juejin.cn?target=https%3A%2F%2Fdatav.aliyun.com%2Fportal%2Fschool%2Fatlas%2Farea_selector%3Fspm%3Da2crr.23498931.0.0.6f7315dd7Ek5fd" target="_blank" title="https://datav.aliyun.com/portal/school/atlas/area_selector?spm=a2crr.23498931.0.0.6f7315dd7Ek5fd" ref="nofollow noopener noreferrer">这里获取</a></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 声明一个函数用于创建地图形状</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">createSichuanShape</span>(<span class="hljs-params">scene: THREE.Scene</span>) {
    <span class="hljs-comment">// 解析json数据</span>
    <span class="hljs-keyword">const</span> jsonData = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(chinaJson);
    
    <span class="hljs-comment">// 创建一个分组，把地图中的多个图形放在一个组中，便于管理</span>
    <span class="hljs-keyword">const</span> map = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Group</span>();
    <span class="hljs-comment">// 使用d3把经纬度转换成平面坐标，中心点为成都</span>
    <span class="hljs-keyword">const</span> projection = d3.<span class="hljs-title function_">geoMercator</span>().<span class="hljs-title function_">center</span>([<span class="hljs-number">104.065735</span>, <span class="hljs-number">30.659462</span>]);
    <span class="hljs-comment">// 遍历json数据中的features</span>
    jsonData.<span class="hljs-property">features</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">feature: any, i: any</span>) =&gt;</span> {
      <span class="hljs-comment">// 获取feature中的geometry数据，方便引用</span>

      <span class="hljs-keyword">const</span> geometry = feature.<span class="hljs-property">geometry</span>;
      <span class="hljs-keyword">const</span> type = geometry.<span class="hljs-property">type</span>;
      <span class="hljs-comment">// 创建分组，把同一个市的形状放在一个分组，便于管理</span>
      <span class="hljs-keyword">const</span> city = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Group</span>();
      <span class="hljs-keyword">if</span> (type === <span class="hljs-string">"MultiPolygon"</span> || type === <span class="hljs-string">"Polygon"</span>) {
        
        <span class="hljs-comment">// 遍历geometry中的数据</span>
        geometry.<span class="hljs-property">coordinates</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">multipolygon: any</span>) =&gt;</span> {
          <span class="hljs-comment">// 创建形状，用于展示地理形状</span>
          <span class="hljs-keyword">const</span> shape = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Shape</span>();
          <span class="hljs-comment">// 存储每个坐标，用于绘制边界线</span>
          <span class="hljs-keyword">const</span> <span class="hljs-attr">arr</span>: any = [];
          <span class="hljs-keyword">if</span> (type === <span class="hljs-string">"Polygon"</span>) {
            multipolygon.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">item: any, index: any</span>) =&gt;</span> {
              <span class="hljs-comment">// 使用d3转换坐标</span>
              <span class="hljs-keyword">const</span> [x, y] = projection.<span class="hljs-title function_">translate</span>([<span class="hljs-number">0</span>, <span class="hljs-number">0</span>])(item) <span class="hljs-keyword">as</span> any;
              <span class="hljs-comment">// 根据转换后的坐标绘制形状</span>
              <span class="hljs-keyword">if</span> (index === <span class="hljs-number">0</span>) {
                shape.<span class="hljs-title function_">moveTo</span>(x, y);
              } <span class="hljs-keyword">else</span> {
                shape.<span class="hljs-title function_">lineTo</span>(x, y);
              }
              arr.<span class="hljs-title function_">push</span>(x, y, <span class="hljs-number">3.3</span>);
            });
            <span class="hljs-comment">// 画边界线</span>
            <span class="hljs-title function_">createLine</span>(arr, city);
          } <span class="hljs-keyword">else</span> {
            multipolygon.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">polygon: any</span>) =&gt;</span> {
              polygon.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">item: any, index: any</span>) =&gt;</span> {
                <span class="hljs-comment">// 使用d3转换坐标</span>
                <span class="hljs-keyword">const</span> [x, y] = projection.<span class="hljs-title function_">translate</span>([<span class="hljs-number">0</span>, <span class="hljs-number">0</span>])(item) <span class="hljs-keyword">as</span> any;
                <span class="hljs-comment">// 根据转换后的坐标绘制形状</span>
                <span class="hljs-keyword">if</span> (index === <span class="hljs-number">0</span>) {
                  shape.<span class="hljs-title function_">moveTo</span>(x, y);
                } <span class="hljs-keyword">else</span> {
                  shape.<span class="hljs-title function_">lineTo</span>(x, y);
                }
                arr.<span class="hljs-title function_">push</span>(x, y, <span class="hljs-number">3.3</span>);
              });
            });
            <span class="hljs-comment">// 绘制边界线</span>
            <span class="hljs-title function_">createLine</span>(arr, city);
          }

          <span class="hljs-comment">// 创建 ExtrudeGeometry用于显示3d效果</span>
          <span class="hljs-keyword">const</span> extrudGeometry = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">ExtrudeGeometry</span>(shape, {
            <span class="hljs-attr">depth</span>: <span class="hljs-number">3</span>, <span class="hljs-comment">// 地图的厚度</span>
          });
          
          <span class="hljs-keyword">const</span> material = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">ShaderMaterial</span>({
            <span class="hljs-attr">uniforms</span>: {
              <span class="hljs-attr">uTopColor</span>: { <span class="hljs-attr">value</span>: <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Color</span>(<span class="hljs-string">"#8bcee6"</span>) },
              <span class="hljs-attr">uBottomColor</span>: { <span class="hljs-attr">value</span>: <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Color</span>(<span class="hljs-string">"#12357d"</span>) },
              <span class="hljs-attr">uSelected</span>: { <span class="hljs-attr">value</span>: <span class="hljs-number">0.0</span> },
              <span class="hljs-attr">minY</span>: { <span class="hljs-attr">value</span>: -<span class="hljs-number">90</span> },
              <span class="hljs-attr">maxY</span>: { <span class="hljs-attr">value</span>: <span class="hljs-number">10</span> },
            },
            <span class="hljs-attr">vertexShader</span>: <span class="hljs-string">`
   varying float vY;
    void main() {
      vY = position.y;
      gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
    }
  `</span>,
            <span class="hljs-attr">fragmentShader</span>: <span class="hljs-string">`
    uniform vec3 uTopColor;
    uniform vec3 uBottomColor;
    uniform float uSelected;
    uniform float minY;
    uniform float maxY;
    varying float vY;

    void main() {
      float t = clamp((vY - minY) / (maxY - minY), 0.0, 1.0);
      vec3 color = mix(uBottomColor, uTopColor, t);

      // 被选中时提亮
      if (uSelected &gt; 0.5) {
        color = mix(color, vec3(1.0, 0.9, 0.8), 0.3);
      }

      gl_FragColor = vec4(color, 1.0);
    }
  `</span>,
          });

          <span class="hljs-comment">// 创建物体，用于显示地图</span>
          <span class="hljs-keyword">const</span> mesh = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Mesh</span>(extrudGeometry, material);
          mesh.<span class="hljs-property">position</span>.<span class="hljs-title function_">set</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
          mesh.<span class="hljs-property">userData</span> = {
            <span class="hljs-attr">name</span>: feature.<span class="hljs-property">properties</span>.<span class="hljs-property">name</span>,
            feature,
          };
          <span class="hljs-comment">// 添加到分组</span>
          city.<span class="hljs-title function_">add</span>(mesh);
        });
      }

      <span class="hljs-keyword">if</span> (feature.<span class="hljs-property">properties</span>.<span class="hljs-property">name</span>) {
        <span class="hljs-title function_">createProvinceLabel</span>(
          feature.<span class="hljs-property">properties</span>.<span class="hljs-property">name</span>,
          feature.<span class="hljs-property">properties</span>.<span class="hljs-property">centroid</span>
            ? feature.<span class="hljs-property">properties</span>.<span class="hljs-property">centroid</span>
            : feature.<span class="hljs-property">properties</span>.<span class="hljs-property">center</span>,
          projection,
          city
        );
      }

      <span class="hljs-comment">// 添加到分组</span>
      map.<span class="hljs-title function_">add</span>(city);
    });
    <span class="hljs-comment">// 添加到场景</span>
    scene.<span class="hljs-title function_">add</span>(map);
    map.<span class="hljs-property">scale</span>.<span class="hljs-property">y</span> = -<span class="hljs-number">1</span>;
    barsGroup.<span class="hljs-property">current</span> = <span class="hljs-title function_">createLightBars</span>(lightBarData, projection, scene);
    <span class="hljs-keyword">return</span> map;
  }
</code></pre>
<hr/>
<h3 data-id="heading-4">四、省份点击高亮和视角移动</h3>
<p>省份点击时会有颜色变化，以及相机视角会变换到省份中心</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> <span class="hljs-title function_">onClick</span> = (<span class="hljs-params">event: MouseEvent</span>) =&gt; {
        <span class="hljs-comment">// 获取渲染区域的边界，用于正确获取鼠标点击位置</span>
        <span class="hljs-keyword">const</span> rect = renderer.<span class="hljs-property">domElement</span>.<span class="hljs-title function_">getBoundingClientRect</span>();

        <span class="hljs-comment">// 这段代码的作用是将鼠标点击在canvas画布上的像素坐标转换为标准化设备坐标（Normalized Device Coordinates, NDC），范围是[-1, 1]</span>
        mouse.<span class="hljs-property">x</span> = ((event.<span class="hljs-property">clientX</span> - rect.<span class="hljs-property">left</span>) / rect.<span class="hljs-property">width</span>) * <span class="hljs-number">2</span> - <span class="hljs-number">1</span>;
        mouse.<span class="hljs-property">y</span> = -((event.<span class="hljs-property">clientY</span> - rect.<span class="hljs-property">top</span>) / rect.<span class="hljs-property">height</span>) * <span class="hljs-number">2</span> + <span class="hljs-number">1</span>;

        raycaster.<span class="hljs-title function_">setFromCamera</span>(mouse, camera);
        <span class="hljs-comment">// 只点击到mesh有反应，点击到线和label没用</span>

        <span class="hljs-keyword">const</span> <span class="hljs-attr">meshes</span>: <span class="hljs-variable constant_">THREE</span>.<span class="hljs-property">Mesh</span>[] = [];
        map.<span class="hljs-title function_">traverse</span>(<span class="hljs-function">(<span class="hljs-params">obj</span>) =&gt;</span> {
          <span class="hljs-keyword">if</span> ((obj <span class="hljs-keyword">as</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-property">Mesh</span>).<span class="hljs-property">isMesh</span>) {
            meshes.<span class="hljs-title function_">push</span>(obj <span class="hljs-keyword">as</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-property">Mesh</span>);
          }
        });

        <span class="hljs-keyword">const</span> intersects = raycaster.<span class="hljs-title function_">intersectObjects</span>(meshes, <span class="hljs-literal">true</span>);

        <span class="hljs-keyword">if</span> (intersects.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
          <span class="hljs-keyword">const</span> mesh = intersects[<span class="hljs-number">0</span>].<span class="hljs-property">object</span> <span class="hljs-keyword">as</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-property">Mesh</span>;
          <span class="hljs-title function_">onSelectProvince</span>(mesh);
          <span class="hljs-title function_">focusProvince</span>(mesh, camera, controls);
        }
      };
      <span class="hljs-comment">// 省份变色</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">onSelectProvince</span>(<span class="hljs-params">mesh: THREE.Mesh</span>) {
   
    <span class="hljs-keyword">if</span> (activeMesh.<span class="hljs-property">current</span>) {
      (
        activeMesh.<span class="hljs-property">current</span>.<span class="hljs-property">material</span> <span class="hljs-keyword">as</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-property">ShaderMaterial</span>
      ).<span class="hljs-property">uniforms</span>.<span class="hljs-property">uSelected</span>.<span class="hljs-property">value</span> = <span class="hljs-number">0</span>;
    }
    
    <span class="hljs-comment">// 这样设置后，根据material中的设置，省份颜色就会发生改变</span>
    (mesh.<span class="hljs-property">material</span> <span class="hljs-keyword">as</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-property">ShaderMaterial</span>).<span class="hljs-property">uniforms</span>.<span class="hljs-property">uSelected</span>.<span class="hljs-property">value</span> = <span class="hljs-number">1</span>;

    activeMesh.<span class="hljs-property">current</span> = mesh;

    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"选中省份："</span>, mesh.<span class="hljs-property">userData</span>.<span class="hljs-property">name</span>);
  }
  <span class="hljs-comment">// 聚焦省份</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">focusProvince</span>(<span class="hljs-params">
    mesh: THREE.Object3D,
    camera: THREE.PerspectiveCamera,
    controls: OrbitControls
  </span>) {
    <span class="hljs-keyword">const</span> center = <span class="hljs-title function_">getMeshCenter</span>(mesh);
    <span class="hljs-keyword">const</span> camPos = <span class="hljs-title function_">calcCameraPosition</span>(center, <span class="hljs-number">50</span>);

    <span class="hljs-title function_">moveCameraTo</span>(camera, controls, camPos, center);
  }
  <span class="hljs-comment">// 获取mesh的中心点</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">getMeshCenter</span>(<span class="hljs-params">mesh: THREE.Object3D</span>) {
    <span class="hljs-keyword">const</span> box = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Box3</span>().<span class="hljs-title function_">setFromObject</span>(mesh);
    <span class="hljs-keyword">const</span> center = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Vector3</span>();
    box.<span class="hljs-title function_">getCenter</span>(center);
    <span class="hljs-keyword">return</span> center;
  }
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">calcCameraPosition</span>(<span class="hljs-params">target: THREE.Vector3, offset = <span class="hljs-number">40</span></span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Vector3</span>(target.<span class="hljs-property">x</span>, target.<span class="hljs-property">y</span> - offset, target.<span class="hljs-property">z</span> + offset);
  }

  <span class="hljs-keyword">function</span> <span class="hljs-title function_">moveCameraTo</span>(<span class="hljs-params">
    camera: THREE.Camera,
    controls: OrbitControls,
    newCamPos: THREE.Vector3,
    newTarget: THREE.Vector3
  </span>) {
    camFrom.<span class="hljs-title function_">copy</span>(camera.<span class="hljs-property">position</span>);
    camTo.<span class="hljs-title function_">copy</span>(newCamPos);

    targetFrom.<span class="hljs-title function_">copy</span>(controls.<span class="hljs-property">target</span>);
    targetTo.<span class="hljs-title function_">copy</span>(newTarget);

    t = <span class="hljs-number">0</span>;
    moving = <span class="hljs-literal">true</span>;
  }
   <span class="hljs-keyword">const</span> <span class="hljs-title function_">animate</span> = (<span class="hljs-params"/>) =&gt; {
        ...前面已省略
        <span class="hljs-keyword">if</span> (moving) {
          t += <span class="hljs-number">0.03</span>;
          <span class="hljs-keyword">if</span> (t &gt;= <span class="hljs-number">1</span>) {
            t = <span class="hljs-number">1</span>;
            moving = <span class="hljs-literal">false</span>;
          }
          <span class="hljs-comment">// 让相机位置在 `camFrom` 和 `camFrom` 之间，按 `t` 的比例“线性插值”移动</span>
          camera.<span class="hljs-property">position</span>.<span class="hljs-title function_">lerpVectors</span>(camFrom, camTo, t);
          controls.<span class="hljs-property">target</span>.<span class="hljs-title function_">lerpVectors</span>(targetFrom, targetTo, t);
          controls.<span class="hljs-title function_">update</span>();
        }
        
        rafIdRef.<span class="hljs-property">current</span> = <span class="hljs-title function_">requestAnimationFrame</span>(animate);
      };

</code></pre>
<p>只对 <code>Mesh</code> 做拾取，避免误点到线或 label。</p>
<hr/>
<h3 data-id="heading-5">五、光柱数据可视化</h3>
<h4 data-id="heading-6">光柱本体</h4>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-type">const</span> geometry = <span class="hljs-keyword">new</span> THREE.<span class="hljs-built_in">CylinderGeometry</span>(<span class="hljs-number">0.6</span>, <span class="hljs-number">0.6</span>, height);
</code></pre>
<h4 data-id="heading-7">顶部发光 Sprite</h4>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-type">const</span> glow = <span class="hljs-keyword">new</span> THREE.<span class="hljs-built_in">Sprite</span>(
  <span class="hljs-keyword">new</span> THREE.<span class="hljs-built_in">SpriteMaterial</span>({ map: glowTexture })
);
</code></pre>
<h4 data-id="heading-8">数值标签</h4>
<p>使用 <code>CSS2DObject</code>，比 Canvas 字体清晰得多。</p>
<hr/>
<h3 data-id="heading-9">六、飞线动画实现</h3>
<pre><code class="hljs language-js" lang="js"> <span class="hljs-comment">// 创建飞线</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">createFlyLine</span>(<span class="hljs-params">position1: any, position2: any, scene: THREE.Scene</span>) {
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">createFlyCurve</span>(<span class="hljs-params">
      start: THREE.Vector3,
      end: THREE.Vector3,
      height = <span class="hljs-number">20</span>
    </span>) {
      <span class="hljs-keyword">const</span> mid = start.<span class="hljs-title function_">clone</span>().<span class="hljs-title function_">lerp</span>(end, <span class="hljs-number">0.5</span>);
      mid.<span class="hljs-property">z</span> += height; <span class="hljs-comment">// 抬高形成弧线</span>
      <span class="hljs-comment">// 创建弧线</span>
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">QuadraticBezierCurve3</span>(start, mid, end);
    }

    <span class="hljs-keyword">const</span> start = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Vector3</span>(...position1);
    <span class="hljs-keyword">const</span> end = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Vector3</span>(...position2);

    <span class="hljs-keyword">const</span> curve = <span class="hljs-title function_">createFlyCurve</span>(start, end, <span class="hljs-number">30</span>);

    <span class="hljs-keyword">const</span> geometry = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">TubeGeometry</span>(curve, <span class="hljs-number">100</span>, <span class="hljs-number">0.15</span>, <span class="hljs-number">8</span>, <span class="hljs-literal">false</span>);

    <span class="hljs-keyword">const</span> texture = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">TextureLoader</span>().<span class="hljs-title function_">load</span>(flyLineImg);
    texture.<span class="hljs-property">wrapS</span> = <span class="hljs-variable constant_">THREE</span>.<span class="hljs-property">RepeatWrapping</span>;
    texture.<span class="hljs-property">repeat</span>.<span class="hljs-title function_">set</span>(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>);

    <span class="hljs-keyword">const</span> material = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">MeshBasicMaterial</span>({
      <span class="hljs-attr">map</span>: texture,
      <span class="hljs-attr">transparent</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">depthWrite</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">blending</span>: <span class="hljs-variable constant_">THREE</span>.<span class="hljs-property">AdditiveBlending</span>,
    });

    <span class="hljs-keyword">const</span> flyLine = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Mesh</span>(geometry, material);
    flyLineTexture.<span class="hljs-property">current</span>.<span class="hljs-title function_">push</span>(texture);
    scene.<span class="hljs-title function_">add</span>(flyLine);
  }
</code></pre>
<hr/>
<h3 data-id="heading-10">七、地图省份名称标签</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 创建省份标签</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">createProvinceLabel</span>(<span class="hljs-params">
    name: string,
    center: [number, number],
    projection: any,
    map: THREE.Group
  </span>) {
    <span class="hljs-keyword">const</span> parent = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">"div"</span>);
    <span class="hljs-keyword">const</span> div = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">"div"</span>);
    div.<span class="hljs-property">className</span> = <span class="hljs-string">"province-label"</span>;
    div.<span class="hljs-property">textContent</span> = name;
    parent.<span class="hljs-title function_">appendChild</span>(div);

    <span class="hljs-keyword">const</span> label = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CSS2DObject</span>(parent);

    <span class="hljs-keyword">const</span> [x, y] = <span class="hljs-title function_">projection</span>(center);
    label.<span class="hljs-property">position</span>.<span class="hljs-title function_">set</span>(x, y, <span class="hljs-number">3</span>); <span class="hljs-comment">// z 稍微抬起，Y轴翻转以匹配地图</span>

    map.<span class="hljs-title function_">add</span>(label);
  }
</code></pre>
<p>特点：</p>
<ul>
<li>不参与 WebGL</li>
<li>不会被遮挡</li>
<li>适合文字、数值、UI</li>
</ul>
<hr/>
<h3 data-id="heading-11">十、资源与生命周期清理（非常重要）</h3>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">cancelAnimationFrame</span>(rafId);
geometry<span class="hljs-selector-class">.dispose</span>();
material<span class="hljs-selector-class">.dispose</span>();
renderer<span class="hljs-selector-class">.forceContextLoss</span>();
</code></pre>
<p><strong>Three.js 不会帮你自动回收显存，React 项目必须手动清理。</strong></p>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[前端图片自动化压缩：一个支持 CLI 与 Vite 构建集成的无损优化工具]]></title>    <link>https://juejin.cn/post/7599166436684234798</link>    <guid>https://juejin.cn/post/7599166436684234798</guid>    <pubDate>2026-01-26T07:53:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599166436684234798" data-draft-id="7599330434425733171" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="前端图片自动化压缩：一个支持 CLI 与 Vite 构建集成的无损优化工具"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2026-01-26T07:53:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="日落以后潜入深海"/> <meta itemprop="url" content="https://juejin.cn/user/2045559991451175"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            前端图片自动化压缩：一个支持 CLI 与 Vite 构建集成的无损优化工具
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2045559991451175/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    日落以后潜入深海
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T07:53:46.000Z" title="Mon Jan 26 2026 07:53:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    10
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在日常前端开发中，图片资源往往是网页体积的“大头”。之前开发的太阳系仿真系统（代码已开源：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fzach2019%2Fsolar-system-simulation-system.git%25EF%25BC%258C%25E6%25AC%25A2%25E8%25BF%258Estar%25EF%25BC%2589%25EF%25BC%258C%25E5%2590%2584%25E4%25B8%25AA%25E5%25A4%25A9%25E4%25BD%2593%25E9%2583%25BD%25E6%2598%25AF%25E9%2587%2587%25E7%2594%25A8%25E7%259A%2584%25E8%25B4%25B4%25E5%259B%25BE%25E6%259D%2590%25E8%25B4%25A8%25EF%25BC%258C14%25E5%25BC%25A0%25E5%259B%25BE%25E7%2589%2587%25E5%25B0%25B1%25E6%259C%258910.1MB%25EF%25BC%258C%25E5%25B0%25BD%25E7%25AE%25A1%25E5%259B%25BE%25E7%2589%2587%25E6%2595%25B0%25E9%2587%258F%25E4%25B8%258D%25E5%25A4%259A%25EF%25BC%258C%25E8%2580%258C%25E4%25B8%2594%25E5%25B8%2582%25E9%259D%25A2%25E4%25B8%258A%25E4%25B9%259F%25E4%25B8%258D%25E4%25B9%258F%25E4%25BC%2598%25E7%25A7%2580%25E7%259A%2584%25E5%259C%25A8%25E7%25BA%25BF%25E5%258E%258B%25E7%25BC%25A9%25E5%25B7%25A5%25E5%2585%25B7%25EF%25BC%2588%25E5%25A6%2582" target="_blank" title="https://gitee.com/zach2019/solar-system-simulation-system.git%EF%BC%8C%E6%AC%A2%E8%BF%8Estar%EF%BC%89%EF%BC%8C%E5%90%84%E4%B8%AA%E5%A4%A9%E4%BD%93%E9%83%BD%E6%98%AF%E9%87%87%E7%94%A8%E7%9A%84%E8%B4%B4%E5%9B%BE%E6%9D%90%E8%B4%A8%EF%BC%8C14%E5%BC%A0%E5%9B%BE%E7%89%87%E5%B0%B1%E6%9C%8910.1MB%EF%BC%8C%E5%B0%BD%E7%AE%A1%E5%9B%BE%E7%89%87%E6%95%B0%E9%87%8F%E4%B8%8D%E5%A4%9A%EF%BC%8C%E8%80%8C%E4%B8%94%E5%B8%82%E9%9D%A2%E4%B8%8A%E4%B9%9F%E4%B8%8D%E4%B9%8F%E4%BC%98%E7%A7%80%E7%9A%84%E5%9C%A8%E7%BA%BF%E5%8E%8B%E7%BC%A9%E5%B7%A5%E5%85%B7%EF%BC%88%E5%A6%82" ref="nofollow noopener noreferrer">gitee.com/zach2019/so…</a> TinyPNG、Squoosh），但它们通常依赖手动上传 → 下载 → 替换的操作流程——不仅重复枯燥，还难以融入现代前端工程化的自动化流水线。 作为开发者，我自然是希望能自动绝不手动，代码能解决的问题绝不麻烦别人。无论是处理存量静态资源，还是在构建时自动压缩被引用的图片，都应无需人工干预。正因如此，我开发了开源工具 @zhaoshijun/compress —— 一套集 CLI 批量处理与 Vite 构建集成于一体的图片自动化压缩方案，真正做到解放前端开发的双手。</p>
<p>npm包地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.npmjs.com%2Fpackage%2F%40zhaoshijun%2Fcompress%3FactiveTab%3Dreadme" target="_blank" title="https://www.npmjs.com/package/@zhaoshijun/compress?activeTab=readme" ref="nofollow noopener noreferrer">www.npmjs.com/package/@zh…</a></p>
<p>源码地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fzach2019%2Fimage-compression.git" target="_blank" title="https://gitee.com/zach2019/image-compression.git" ref="nofollow noopener noreferrer">gitee.com/zach2019/im…</a></p>
<h2 data-id="heading-0">✨ 核心亮点</h2>
<ul>
<li>
<p><strong>「🛠 双模驱动」</strong>：</p>
<ul>
<li><strong>「CLI 模式」</strong>：一键扫描并批量压缩本地存量图片。</li>
<li><strong>「Vite 插件模式」</strong>：在 <code>vite build</code> 构建时自动拦截并压缩引用的图片，开发环境零感知。</li>
</ul>
</li>
<li>
<p><strong>「⚡️ 极速性能」</strong>：底层基于 Node.js 高性能图片处理库 <strong>「Sharp」</strong>，速度飞快，质量无损。</p>
</li>
<li>
<p><strong>「📦 智能缓存」</strong>：Vite 插件内置 Content Hash 缓存机制，<strong>「未修改的图片跳过压缩」</strong>，拒绝拖慢构建速度。</p>
</li>
<li>
<p><strong>「🛡 安全可靠」</strong>：CLI 模式默认不覆盖原图，支持备份；Vite 模式仅处理引用资源。</p>
</li>
</ul>
<hr/>
<h2 data-id="heading-1">💡 设计思路解密</h2>
<p>这个工具的设计初衷是**“一套逻辑，多端复用”**。将核心压缩能力封装，分别通过 CLI 和 Vite 插件暴露给用户。</p>
<h3 data-id="heading-2">1. 核心逻辑：Sharp 封装</h3>
<p>为了保证压缩质量和速度，我选择了 <code>sharp</code>。核心函数抹平了不同格式的参数差异。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// src/core/compressor.js</span>
<span class="hljs-keyword">import</span> sharp <span class="hljs-keyword">from</span> <span class="hljs-string">'sharp'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">compressImage</span>(<span class="hljs-params">input, options</span>) {
  <span class="hljs-keyword">let</span> instance = <span class="hljs-title function_">sharp</span>(input);
  
  <span class="hljs-comment">// 统一处理格式参数</span>
  <span class="hljs-keyword">if</span> (format === <span class="hljs-string">'png'</span>) {
    <span class="hljs-comment">// 开启调色板量化，显著减小体积</span>
    instance = instance.<span class="hljs-title function_">png</span>({ <span class="hljs-attr">palette</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">compressionLevel</span>: <span class="hljs-number">9</span> });
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// JPEG/WebP 默认高质量压缩</span>
    instance = instance.<span class="hljs-title function_">jpeg</span>({ <span class="hljs-attr">quality</span>: options.<span class="hljs-property">quality</span> || <span class="hljs-number">88</span> });
  }

  <span class="hljs-keyword">return</span> instance.<span class="hljs-title function_">toBuffer</span>();
}
</code></pre>
<h3 data-id="heading-3">2. Vite 插件：构建流拦截</h3>
<p>Vite 插件的核心在于利用 Rollup 的 <code>generateBundle</code> 钩子。在这个阶段，我们能获取到所有即将输出的资源文件，直接替换其内容。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// vite/index.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">compressVitePlugin</span>(<span class="hljs-params">options</span>) {
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">name</span>: <span class="hljs-string">'@zhaoshijun/compress'</span>,
    <span class="hljs-attr">apply</span>: <span class="hljs-string">'build'</span>, <span class="hljs-comment">// 仅在构建时生效</span>
    <span class="hljs-keyword">async</span> <span class="hljs-title function_">generateBundle</span>(<span class="hljs-params">_, bundle</span>) {
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> fileName <span class="hljs-keyword">in</span> bundle) {
        <span class="hljs-comment">// 筛选图片资源</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isSupportedImage</span>(fileName)) {
          <span class="hljs-keyword">const</span> originalBuffer = bundle[fileName].<span class="hljs-property">source</span>;
          
          <span class="hljs-comment">// ⚡️ 核心：压缩并替换资源内容</span>
          <span class="hljs-keyword">const</span> compressed = <span class="hljs-keyword">await</span> <span class="hljs-title function_">compressImage</span>(originalBuffer, config);
          bundle[fileName].<span class="hljs-property">source</span> = compressed;
          
          <span class="hljs-comment">// 同时更新文件名（如 logo.png -&gt; logo.min.png）</span>
          <span class="hljs-comment">// 并自动替换 JS/CSS 中的引用路径</span>
        }
      }
    }
  };
}
</code></pre>
<h3 data-id="heading-4">3. 性能优化：基于内容的哈希缓存</h3>
<p>为了避免每次构建都重新压缩所有图片，我们实现了一个简单的文件系统缓存。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// src/utils/cache.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getCache</span>(<span class="hljs-params">content</span>) {
  <span class="hljs-comment">// 计算文件内容 Hash</span>
  <span class="hljs-keyword">const</span> hash = crypto.<span class="hljs-title function_">createHash</span>(<span class="hljs-string">'sha256'</span>).<span class="hljs-title function_">update</span>(content).<span class="hljs-title function_">digest</span>(<span class="hljs-string">'hex'</span>);
  <span class="hljs-keyword">const</span> cachePath = path.<span class="hljs-title function_">join</span>(<span class="hljs-variable constant_">CACHE_DIR</span>, hash);
  
  <span class="hljs-comment">// 如果 Hash 命中，直接返回缓存文件，跳过压缩</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">await</span> fs.<span class="hljs-title function_">pathExists</span>(cachePath)) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> fs.<span class="hljs-title function_">readFile</span>(cachePath);
  }
  <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
}
</code></pre>
<hr/>
<h2 data-id="heading-5">🛠 快速上手指南</h2>
<h3 data-id="heading-6">第一步：安装</h3>
<pre><code class="hljs language-bash" lang="bash">npm install @zhaoshijun/compress -D
</code></pre>
<h3 data-id="heading-7">场景一：使用 CLI 批量压缩存量图片</h3>
<p>如果你有一堆静态图片需要处理，直接运行 CLI 命令：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 扫描当前目录，压缩图片并输出到 ./compressed 目录</span>
npx @zhaoshijun/compress

<span class="hljs-comment"># 常用参数</span>
<span class="hljs-comment"># --dry-run : 仅预览，不实际写入</span>
<span class="hljs-comment"># --backup  : 备份原文件</span>
</code></pre>
<p>CLI 会在终端显示进度条和压缩前后的体积对比：</p>
<pre><code class="hljs language-bash" lang="bash">✔ assets/banner.jpg: 1.2 MB → 450 KB (Saved 62.5%)
</code></pre>
<h3 data-id="heading-8">场景二：集成到 Vite 项目</h3>
<p>在 <code>vite.config.js</code> 中配置插件，即可在打包时自动瘦身：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { defineConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">'vite'</span>;
<span class="hljs-keyword">import</span> { compressVitePlugin } <span class="hljs-keyword">from</span> <span class="hljs-string">'@zhaoshijun/compress'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({
  <span class="hljs-attr">plugins</span>: [
    <span class="hljs-title function_">compressVitePlugin</span>({
      <span class="hljs-attr">quality</span>: <span class="hljs-number">80</span>, <span class="hljs-comment">// 压缩质量</span>
      <span class="hljs-attr">cache</span>: <span class="hljs-literal">true</span>  <span class="hljs-comment">// 开启缓存</span>
    })
  ]
});
</code></pre>
<p>以后每次运行 <code>npm run build</code>，你的产物图片就已经是最优体积了！</p>
<hr/>
<h2 data-id="heading-9">🔗 总结</h2>
<p>工具化、自动化是提升前端工程效率的关键。<code>@zhaoshijun/compress</code> 通过简单的配置，解决了图片压缩这一高频痛点。</p>
<p>欢迎大家下载体验，如果有问题或建议，欢迎在评论区留言！</p>
<p>本文使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fmarkdown.com.cn" target="_blank" title="https://markdown.com.cn" ref="nofollow noopener noreferrer">markdown.com.cn</a> 排版</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React Scheduler 最小堆实现]]></title>    <link>https://juejin.cn/post/7599220371665551400</link>    <guid>https://juejin.cn/post/7599220371665551400</guid>    <pubDate>2026-01-26T07:57:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599220371665551400" data-draft-id="7599474528238026792" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React Scheduler 最小堆实现"/> <meta itemprop="keywords" content="前端,React.js"/> <meta itemprop="datePublished" content="2026-01-26T07:57:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="_DoubleL"/> <meta itemprop="url" content="https://juejin.cn/user/989992708217032"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React Scheduler 最小堆实现
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/989992708217032/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    _DoubleL
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T07:57:02.000Z" title="Mon Jan 26 2026 07:57:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1. 什么是最小堆</h2>
<p>最小堆（<strong>Min Heap</strong>）是一种<strong>完全二叉树</strong>结构，同时满足一个很关键的性质：<strong>任意一个节点的值，都 ≤ 它的左右子节点的值</strong>，也就是说： 👉 <strong>堆顶（根节点）一定是整个结构中最小的元素</strong></p>
<p>完全二叉树的特点是：</p>
<ul>
<li>从上到下</li>
<li>从左到右依次填满</li>
<li>只允许<strong>最后一层不满</strong>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c805bf84e998488199d68e82befebd9e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX0RvdWJsZUw=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770019026&amp;x-signature=%2F2ceuVl4%2FK1pvHF%2B2oAPFJkkp5U%3D" alt="image.png" loading="lazy"/></li>
</ul>
<h2 data-id="heading-1">2. 用数组表示最小堆🔥</h2>
<p>最小堆通常用数组实现，而不是链表。</p>
<pre><code class="hljs language-ts" lang="ts">索引:  <span class="hljs-number">0</span>  <span class="hljs-number">1</span>  <span class="hljs-number">2</span>  <span class="hljs-number">3</span>  <span class="hljs-number">4</span>  <span class="hljs-number">5</span>
数组: [<span class="hljs-number">1</span>, <span class="hljs-number">3</span>, <span class="hljs-number">5</span>, <span class="hljs-number">4</span>, <span class="hljs-number">6</span>, <span class="hljs-number">8</span>]
</code></pre>
<p>如果数组下标从 <code>0</code> 开始：</p>
<ul>
<li>父节点：<code>(i - 1) &gt;&gt;&gt; 1</code>;</li>
<li>左子节点：<code>2 * i + 1</code></li>
<li>右子节点：<code>2 * i + 2</code></li>
</ul>
<h2 data-id="heading-2">3. React Scheduler 最小堆实现</h2>
<p>React 的 Scheduler 内部，正是通过 <strong>最小堆 + sortIndex</strong> 来维护任务执行顺序</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">export</span> <span class="hljs-keyword">type</span> <span class="hljs-title class_">Node</span> = {
  <span class="hljs-attr">id</span>: <span class="hljs-built_in">number</span>;        <span class="hljs-comment">// 每个任务的唯一标识</span>
  <span class="hljs-attr">sortIndex</span>: <span class="hljs-built_in">number</span>; <span class="hljs-comment">// 决定任务顺序</span>
};
</code></pre>
<p>堆的本质：数组</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">export</span> <span class="hljs-keyword">type</span> <span class="hljs-title class_">Heap</span>&lt;T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Node</span>&gt; = <span class="hljs-title class_">Array</span>&lt;T&gt;;
</code></pre>
<h3 data-id="heading-3">3.1 取出堆顶元素</h3>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> peek = &lt;T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Node</span>&gt;(<span class="hljs-attr">heap</span>: <span class="hljs-title class_">Heap</span>&lt;T&gt;): T | <span class="hljs-function"><span class="hljs-params">null</span> =&gt;</span> {
  <span class="hljs-keyword">return</span> heap.<span class="hljs-property">length</span> === <span class="hljs-number">0</span> ? <span class="hljs-literal">null</span> : heap[<span class="hljs-number">0</span>];
};
</code></pre>
<h3 data-id="heading-4">3.2 插入元素</h3>
<p>插入流程：</p>
<ol>
<li>新元素放到数组末尾</li>
<li><strong>从下往上进行 堆化（siftUp），不断与父节点比较，若比父节点小就交换，一直向上，直到满足堆性质</strong></li>
<li>恢复最小堆性质</li>
</ol>
<p>如下图，在最后的节点插入1， 1和父节点（10）交换位置， 接着 1和父节点（2） 交换位置，就变成了恢复了最小堆</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1e65648afff44437accf9fd42de7be23~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX0RvdWJsZUw=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770019026&amp;x-signature=pu47jOahL3lvWrVTmv6%2FaqbASlc%3D" alt="image.png" loading="lazy"/></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 插入元素</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> push = &lt;T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Node</span>&gt;(<span class="hljs-attr">heap</span>: <span class="hljs-title class_">Heap</span>&lt;T&gt;, <span class="hljs-attr">node</span>: T): <span class="hljs-function"><span class="hljs-params">void</span> =&gt;</span> {
  <span class="hljs-comment">// 1. 把node放到堆的最后</span>
  <span class="hljs-keyword">const</span> index = heap.<span class="hljs-property">length</span>;
  heap.<span class="hljs-title function_">push</span>(node);
  <span class="hljs-comment">// 2. 调整最小堆，从下往上堆化</span>
  <span class="hljs-title function_">siftUp</span>(heap, node, index);
};
​
<span class="hljs-comment">// 从下往上堆化</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> siftUp = &lt;T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Node</span>&gt;(
  <span class="hljs-attr">heap</span>: <span class="hljs-title class_">Heap</span>&lt;T&gt;,
  <span class="hljs-attr">node</span>: T,
  <span class="hljs-attr">i</span>: <span class="hljs-built_in">number</span>,
): <span class="hljs-function"><span class="hljs-params">void</span> =&gt;</span> {
  <span class="hljs-keyword">let</span> index = i;
​
  <span class="hljs-keyword">while</span> (index &gt; <span class="hljs-number">0</span>) {
    <span class="hljs-comment">// 无符号右移，相当于 /2 并且向下取整</span>
    <span class="hljs-keyword">const</span> parentIndex = (index - <span class="hljs-number">1</span>) &gt;&gt;&gt; <span class="hljs-number">1</span>;
    <span class="hljs-keyword">const</span> parent = heap[parentIndex];
    <span class="hljs-comment">// 如果父节点大于node，需要交换</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-title function_">compare</span>(parent, node) &gt; <span class="hljs-number">0</span>) {
      <span class="hljs-comment">// node子节点更小，和根节点交换</span>
      heap[parentIndex] = node;
      heap[index] = parent;
      index = parentIndex;
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">return</span>;
    }
  }
};
​
<span class="hljs-comment">// 比较函数，返回值大于0 表示 a大于b</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">compare</span>(<span class="hljs-params">a: Node, b: Node</span>) {
  <span class="hljs-keyword">const</span> diff = a.<span class="hljs-property">sortIndex</span> - b.<span class="hljs-property">sortIndex</span>;
  <span class="hljs-keyword">return</span> diff !== <span class="hljs-number">0</span> ? diff : a.<span class="hljs-property">id</span> - b.<span class="hljs-property">id</span>;
}
</code></pre>
<h3 data-id="heading-5">3.3 删除堆顶元素</h3>
<p>删除流程</p>
<ol>
<li><strong>保存堆顶元素（最小值）</strong></li>
<li><strong>取出最后一个元素</strong></li>
<li><strong>放到堆顶</strong></li>
<li><strong>从上往下堆化（siftDown），比较 <code>node</code> 与左右子节点，选择 更小的那个子节点，若子节点更小，则交换，一路向下，直到恢复堆序</strong></li>
</ol>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 删除堆顶元素  先取出堆顶元素，然后取出最后一个元素放到堆顶，然后从上往下堆化</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> pop = &lt;T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Node</span>&gt;(<span class="hljs-attr">heap</span>: <span class="hljs-title class_">Heap</span>&lt;T&gt;): T | <span class="hljs-function"><span class="hljs-params">null</span> =&gt;</span> {
  <span class="hljs-keyword">if</span> (!heap.<span class="hljs-property">length</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
  <span class="hljs-keyword">const</span> first = heap[<span class="hljs-number">0</span>];
  <span class="hljs-keyword">const</span> last = heap.<span class="hljs-title function_">pop</span>()!;
  <span class="hljs-keyword">if</span> (first !== last) {
    <span class="hljs-comment">// 证明heap中有2个或者更多个元素</span>
    heap[<span class="hljs-number">0</span>] = last;
    <span class="hljs-title function_">siftDown</span>(heap, last, <span class="hljs-number">0</span>);
  }
  <span class="hljs-keyword">return</span> first;
};

<span class="hljs-comment">// 从上往下堆化</span>
<span class="hljs-keyword">function</span> siftDown&lt;T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Node</span>&gt;(<span class="hljs-attr">heap</span>: <span class="hljs-title class_">Heap</span>&lt;T&gt;, <span class="hljs-attr">node</span>: T, <span class="hljs-attr">i</span>: <span class="hljs-built_in">number</span>): <span class="hljs-built_in">void</span> {
  <span class="hljs-keyword">let</span> index = i;
  <span class="hljs-keyword">const</span> length = heap.<span class="hljs-property">length</span>;
  <span class="hljs-comment">// 只需要取一半的节点，因为每次都是跟左半边 或者 右半边的节点对比</span>
  <span class="hljs-keyword">const</span> halfLength = length &gt;&gt;&gt; <span class="hljs-number">1</span>;
  <span class="hljs-keyword">while</span> (index &lt; halfLength) {
    <span class="hljs-keyword">const</span> leftIndex = (index + <span class="hljs-number">1</span>) * <span class="hljs-number">2</span> - <span class="hljs-number">1</span>;
    <span class="hljs-keyword">const</span> left = heap[leftIndex];
    <span class="hljs-keyword">const</span> rightIndex = leftIndex + <span class="hljs-number">1</span>;
    <span class="hljs-keyword">const</span> right = heap[rightIndex]; <span class="hljs-comment">// right不一定存在，等下还要判断是否存在</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-title function_">compare</span>(left, node) &lt; <span class="hljs-number">0</span>) {
      <span class="hljs-comment">// left&lt;node</span>
      <span class="hljs-keyword">if</span> (rightIndex &lt; length &amp;&amp; <span class="hljs-title function_">compare</span>(right, left) &lt; <span class="hljs-number">0</span>) {
        <span class="hljs-comment">// right存在，且right&lt;left</span>
        heap[index] = right;
        heap[rightIndex] = node;
        index = rightIndex;
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// left更小或者right不存在</span>
        heap[index] = left;
        heap[leftIndex] = node;
        index = leftIndex;
      }
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (rightIndex &lt; length &amp;&amp; <span class="hljs-title function_">compare</span>(right, node) &lt; <span class="hljs-number">0</span>) {
      <span class="hljs-comment">// left&gt;=node &amp;&amp; right&lt;node</span>
      heap[index] = right;
      heap[rightIndex] = node;
      index = rightIndex;
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">// 根节点最小，不需要调整</span>
      <span class="hljs-keyword">return</span>;
    }
  }
}

<span class="hljs-comment">// 比较函数，返回值大于0 表示 a大于b</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">compare</span>(<span class="hljs-params">a: Node, b: Node</span>) {
  <span class="hljs-keyword">const</span> diff = a.<span class="hljs-property">sortIndex</span> - b.<span class="hljs-property">sortIndex</span>;
  <span class="hljs-keyword">return</span> diff !== <span class="hljs-number">0</span> ? diff : a.<span class="hljs-property">id</span> - b.<span class="hljs-property">id</span>;
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[除了MySQL，这 9 种数据库你竟然都不认识？]]></title>    <link>https://juejin.cn/post/7599268297223946250</link>    <guid>https://juejin.cn/post/7599268297223946250</guid>    <pubDate>2026-01-26T08:34:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599268297223946250" data-draft-id="7599166436684185646" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="除了MySQL，这 9 种数据库你竟然都不认识？"/> <meta itemprop="keywords" content="数据库,MySQL,程序员"/> <meta itemprop="datePublished" content="2026-01-26T08:34:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员鱼皮"/> <meta itemprop="url" content="https://juejin.cn/user/2444938365386621"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            除了MySQL，这 9 种数据库你竟然都不认识？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2444938365386621/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员鱼皮
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T08:34:05.000Z" title="Mon Jan 26 2026 08:34:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读16分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>你是小阿巴，正在公司敲代码。</p>
<p>老板走过来说：小阿巴，给咱们网站加个商品搜索功能吧。</p>
<p>你拍拍胸脯：没问题，我直接用 MySQL 数据库的 LIKE 模糊查询实现搜索，1 小时上线~</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e136bef2c102490283b7c37aa179ac9c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770021245&amp;x-signature=vUGJFzXn0G8pwdvp42wzBjTrmrY%3D" alt="" loading="lazy"/></p>
<p>结果上线后，用户点击搜索，卡了半天没反应，老板气得脸都绿了。</p>
<p>你急的汗流浃背，只能找到号称『后端之狗』的鱼皮求助：阿巴阿巴，俺用 MySQL 搞不定，咋办啊……</p>
<p>鱼皮：不是哥们，又不是只有 MySQL 这一个数据库。</p>
<p>下面我来带你认识 10 种不同类型的数据库，让你知道什么场景该用什么数据库。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/de9ca86e06eb42038c00d47bc65dc099~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770021245&amp;x-signature=DT0eiQyQHWKu9ChXTDnMmcyxOfI%3D" alt="" loading="lazy"/></p>
<p>点个收藏，我们开始~</p>
<p>⭐️ 推荐观看视频版，有动画更好理解：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1ChkjBsEzq" target="_blank" title="https://www.bilibili.com/video/BV1ChkjBsEzq" ref="nofollow noopener noreferrer">www.bilibili.com/video/BV1Ch…</a></p>
<h2 data-id="heading-0">关系型数据库</h2>
<p>首先是我们接触最多的、也是后端入门必学的 <strong>关系型数据库</strong>。</p>
<p>在关系型数据库中，数据以 <strong>表</strong> 的形式进行组织和存储，每个表就像一个 Excel 表格，包含多个 <strong>行</strong> 和多个 <strong>列</strong>。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/580ec3a66b4b48039bbaf8b5feb3e710~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770021245&amp;x-signature=VwpDKb4XABgwfo2sx3F4tCKvLW8%3D" alt="" loading="lazy"/></p>
<p>比如你要做个学生管理系统，把学生信息存储到关系型数据库中，结构大概是这样的：</p>

























<table><thead><tr><th>学号</th><th>学生姓名</th><th>所属班级号</th></tr></thead><tbody><tr><td>1</td><td>小李</td><td>1</td></tr><tr><td>2</td><td>小鱼</td><td>2</td></tr><tr><td>3</td><td>小皮</td><td>3</td></tr></tbody></table>
<p>上述学生表格中，每一行代表一个学生的信息，每一列代表学生的一个属性。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/114c271ab18541e183589322676c386e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770021245&amp;x-signature=nR53uL%2FTwaW3yfNLRoK8w1jF8ak%3D" alt="" loading="lazy"/></p>
<p>我们可以使用结构化查询语言 SQL 来对关系型数据库表的数据进行灵活地查询、选择、过滤等。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8c3190fd7d564456827e9b0c9137b3d2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770021245&amp;x-signature=d9dfD7vXwzohhFlScuCQmBMNnpI%3D" alt="" loading="lazy"/></p>
<p>而关系型数据库最大的特点，就是表和表之间可以 <strong>存在关系</strong>。比如学生管理系统中还可以有班级表，结构如下：</p>





















<table><thead><tr><th>班号</th><th>班级名称</th></tr></thead><tbody><tr><td>1</td><td>快乐班</td></tr><tr><td>2</td><td>泰酷班</td></tr><tr><td>3</td><td>躺平班</td></tr></tbody></table>
<p>如果我想知道某个学生所属的班级信息，只需要在查询时将学生表的 <strong>所属班级号</strong> 和班级表的 <strong>班号</strong> 进行关联，而不用把所有表格的列存储在一起，非常灵活。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cef8968353284cb283b3be07d1f54214~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770021245&amp;x-signature=op4C6jbonxuK5VQYwYsTdg3BfRs%3D" alt="" loading="lazy"/></p>
<p>通过 SQL 可以连接查询多张表：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eebaf217c4d84e7ba3e551b8a3871ec4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770021245&amp;x-signature=eiPMHSodA1GbAKLwuQAH4LQTd1s%3D" alt="" loading="lazy"/></p>
<p>得到下面的查询结果：</p>





























<table><thead><tr><th>学号</th><th>学生姓名</th><th>所属班级号</th><th>班级名称</th></tr></thead><tbody><tr><td>1</td><td>小李</td><td>1</td><td>快乐班</td></tr><tr><td>2</td><td>小鱼</td><td>2</td><td>泰酷班</td></tr><tr><td>3</td><td>小皮</td><td>3</td><td>躺平班</td></tr></tbody></table>
<p>此外，关系型数据库遵循 ACID 原则（原子性、一致性、隔离性和持久性），通过 <strong>事务</strong> 机制可以保证多个操作同时进行时，数据的状态保持一致。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a4cca45fffd744088684f962f13f9a9c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770021245&amp;x-signature=GAaQuuqPz7bd0Ejrwptm7tWlfaA%3D" alt="" loading="lazy"/></p>
<p>举个例子，A 给 B 转账，A 扣钱的同时 B 也会加钱，不会出现 A 扣了钱 B 却没收到钱的情况。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e2cc5bd48da64691998213af37f2d2ae~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770021245&amp;x-signature=yq2AvkfdaBgrtdIkPThys78YNhI%3D" alt="" loading="lazy"/></p>
<p>正因为关系型数据库既能灵活查询、又能准确写入，所以它几乎可以被应用在任何项目中。比如各类管理系统、数据分析系统、金融银行系统等。</p>
<p>比较主流的关系型数据库产品有：</p>
<ul>
<li>MySQL：开源易学，后端开发必学的数据库</li>
<li>Oracle：人称 “甲方的数据库”，主要是大型企业和政府机构在用，功能强大但授权费用昂贵</li>
<li>PostgreSQL：开源界的天花板，功能最全面</li>
<li>SQL Server：微软出品，和 Windows 系统、.NET 生态集成度高</li>
<li>SQLite：整个数据库就是一个文件，不需要服务器，非常轻量。被广泛应用在手机 APP、浏览器中，你的手机里可能有几十个 SQLite。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5df4f0053e00473a9cd9b9b13ddc2c1b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770021245&amp;x-signature=ecdEG0IhPuGsnfY8d20yV2LZ%2B%2B0%3D" alt="" loading="lazy"/></p>
<p>对于大多数项目，用 MySQL 等关系型数据库来存储数据就足够了。但如果要存储的数据间没有复杂关系、或者需要极致的性能时，它并不是最佳选择。</p>
<p>你点点头：俺知道，就好比俺要写一篇文章，没必要非得把内容塞进 Excel 表格里，直接放到 Word 文档里会更方便编辑和阅读。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e370026331e64e2aa9bf6a43aa925737~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770021245&amp;x-signature=jIKsvfizoiAUIgvCoVInGpBy%2FRg%3D" alt="" loading="lazy"/></p>
<p>鱼皮：没错，这时就需要与关系型数据库互补的 <strong>非关系型数据库</strong>。</p>
<h2 data-id="heading-1">非关系型数据库</h2>
<p>非关系型数据库又叫 NoSQL（Not Only SQL），适合存储关系不强的、结构灵活的、需要快速访问的数据。</p>
<p>打个比方，关系型数据库像图书馆，书籍分类明确、摆放有序、借阅有规矩；非关系型数据库像你的书桌，怎么顺手怎么放，拿取方便最重要。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/47c5cbadf5c7421c90dd6e77e0f9a424~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770021245&amp;x-signature=5xISe5Lqm5WeCx24qTnifQZW2bU%3D" alt="" loading="lazy"/></p>
<p>在实际项目开发中，最常用的非关系型数据库是 KV 数据库和文档数据库。</p>
<h3 data-id="heading-2">KV 键值数据库</h3>
<p>KV 即 Key-Value，数据是以 <strong>键值对</strong> 的方式存储在数据库中的，可以理解为一个超大的 HashMap，数据库中存储的每个键都 <strong>唯一对应</strong> 一个值。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4f0389f063b44da9a158474737949ce6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770021245&amp;x-signature=U9o24MLB9DBDVxF6f3CA9LLOI2E%3D" alt="" loading="lazy"/></p>
<p>比如存储用户信息和热门商品信息，结构是这样的：</p>

















<table><thead><tr><th>Key 键</th><th>Value 值</th></tr></thead><tbody><tr><td>user:1001</td><td>{"name":"鱼皮", "age":25}</td></tr><tr><td>product:hot</td><td>["商品1", "商品2", "商品3"]</td></tr></tbody></table>
<p>键和值都可以是任意类型的数据，包括字符串、数字、数组、JSON 对象等，非常灵活。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b98d17893bbc4fdfa23d3f1001bc70d1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770021245&amp;x-signature=xY2lBY6wBFmefzwLWBhdHFToZdg%3D" alt="" loading="lazy"/></p>
<p>由于 KV 存储的结构简单清晰，我们能够很轻松地根据某个键查找出对应的值，就像查字典一样，读写数据的性能都非常高。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/396f84d351204cee9a16d662be84dfed~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770021245&amp;x-signature=6fPrMf97wX0egu%2FmvvVADlIEghU%3D" alt="" loading="lazy"/></p>
<p>此外，KV 数据库的可扩展性很强。因为数据间不存在直接关联，我们可以把键值对分散到多台机器上存储，通过数据分片、负载均衡等策略来支持海量数据的高并发访问。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/18a588b8a8f143ab8db6b8696a3b7810~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770021245&amp;x-signature=KjC%2B2bPEBVQgQcyVMVEi6DZgRJg%3D" alt="" loading="lazy"/></p>
<p>由于高性能和高可扩展性，KV 数据库被广泛应用于缓存、分布式会话、分布式锁、实时统计等场景。</p>
<p>最经典的 KV 数据库肯定是 Redis，它是开源的、基于内存的数据库，不仅支持丰富的数据类型和功能，还有持久化等重要特性，也是后端必学的技术。其他的常用 KV 数据库有 Memcached、Etcd、LevelDB、RocksDB 等。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c236126cefd9445f97085aca4b6be2ba~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770021245&amp;x-signature=7lS8nn9xVJoWFwU0JHVepm3CZiE%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-3">文档数据库</h3>
<p>文档数据库也属于非关系型数据库。顾名思义，它适用于存储和管理 <strong>半结构化的</strong> 文档数据，数据一般以 JSON（BSON）格式存储。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/70eea8b820ff451e950514705c96da76~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770021245&amp;x-signature=4vwWr8vtUU1WI9EYh%2BNaQUBN8do%3D" alt="" loading="lazy"/></p>
<p>相比于关系型数据库中严格定义的表格行列，文档数据库的数据结构更像是一份份独立的文档，每个文档都可以包含不同类型和格式的数据，结构非常灵活。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7e7fac95fc7b4b00ba4d15aa9628a81c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770021245&amp;x-signature=GzTlxFHJOifbDdX%2B4j0Gu06wpY0%3D" alt="" loading="lazy"/></p>
<p>比如存储博客文章，结构是这样的：</p>

















<table><thead><tr><th>文档 ID</th><th>文档数据</th></tr></thead><tbody><tr><td>1</td><td>{"_id": 1, "title": "文章标题1", "content": "这是文章1的内容"}</td></tr><tr><td>2</td><td>{"_id": 2, "title": "文章标题2", "author": "程序员鱼皮"}</td></tr></tbody></table>
<p>你挠挠头：诶，文档 1 和文档 2 的字段都不一样啊，这也行？</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/65e6b4ce0d7e4e07a5d1ffd353f81d0b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770021245&amp;x-signature=%2Bj9bMmPLRUsyKFhnM7O3rIh%2FRXc%3D" alt="" loading="lazy"/></p>
<p>鱼皮：没错，这就是文档数据库的灵活性。当我们要给某个文档新增一个字段时，不需要像关系型数据库那样先改表结构，直接加就完事了。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/725f65a5f934442c9a6db7d4d6fbf76b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770021245&amp;x-signature=%2FZ3OD4SDleuy9urwJpktnmuhM8A%3D" alt="" loading="lazy"/></p>
<p>而且支持水平扩展，可以分散到多台服务器上存储，适用于内容管理系统、博客平台、电商商品详情页等场景。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eed34c7e36c4494f957273d527392361~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770021245&amp;x-signature=maNBc%2B0DBzIZr9SYIqWlUWbIekE%3D" alt="" loading="lazy"/></p>
<p>推荐学习的文档数据库是 MongoDB，因为它存储的就是 JSON（BSON）格式数据，对前端同学很友好，入门难度也很低。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a28b5f289c2a425494720c3e138aebe9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770021245&amp;x-signature=V3TFuE9Bn6EPv9E65%2BjuqHoEr20%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-4">特定场景的数据库</h2>
<p>虽然关系型和非关系型数据库已经能够满足大部分场景，但在一些特殊场景下，使用专门设计的数据库会更高效。就像你可以用菜刀砍树，但用斧子会更快更省力。</p>
<h3 data-id="heading-5">搜索引擎数据库</h3>
<p>专门为搜索功能设计的数据库。它能存储和管理大量文本数据，提供快速、准确、灵活的全文检索功能。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/24b82fa923a04be7b4953a2d06281788~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770021245&amp;x-signature=FfjMjBVrRzFKJA1UJpd1xEk42Dg%3D" alt="" loading="lazy"/></p>
<p>你挠挠头：凭什么它能做到这些呢？</p>
<p>鱼皮：秘密在于它使用了 <strong>倒排索引</strong> 的方式存储数据。</p>
<p>以存储博客文档为例，关系型数据库的存储结构是：</p>





















<table><thead><tr><th>文档 id</th><th>文档内容</th></tr></thead><tbody><tr><td>1</td><td>感谢关注鱼皮</td></tr><tr><td>2</td><td>鱼皮是一名程序员</td></tr><tr><td>3</td><td>感谢关注编程导航</td></tr></tbody></table>
<p>我们能够根据 id 来查找到对应的单篇文档，也可以通过搜索精确的关键词，来查找到多篇文档。</p>
<p>比如搜索 "鱼皮"，能搜出文档 1、2。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3174d20411384259bdd269edc340a607~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770021245&amp;x-signature=gKTUh%2BLT2OLxnujpCpzJNcg0E%2BQ%3D" alt="" loading="lazy"/></p>
<p>但是，如果你搜索 "鱼皮程序员"，是无法得到搜索结果的，因为没有任何一个文档的内容完全包含 "鱼皮程序员" 这个词。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b0d709b8c6f0440b9a09a0a4e4257d64~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770021245&amp;x-signature=RqBD9SO3G9z6JZGODMIm7KdTvaQ%3D" alt="" loading="lazy"/></p>
<p>而在搜索引擎数据库中，首先会将文档内容按照单词进行分割，也就是 <strong>分词</strong>。然后 <strong>建立倒排索引</strong>，也就是构建 <strong>单词到文档 id 的映射</strong>。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4affeacb96154fd189d65fcd30cc4f68~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770021245&amp;x-signature=Ytku3sHiny93JwHD4K8P5dzDFuM%3D" alt="" loading="lazy"/></p>
<p>有了上述的倒排索引，当用户搜索 "鱼皮程序员" 时，搜索引擎数据库会先对搜索词进行分词，得到 "鱼皮" 和 "程序员"，然后根据这两个词汇就能找到文档 id 1 和 2 了。不用再一行一行遍历表内所有的数据，实现了更灵活、快速的搜索。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/982cd4ac669a488a8489b53f94116977~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770021245&amp;x-signature=HVt59hEt%2FJ6CbSPui3j0hGyrOc8%3D" alt="" loading="lazy"/></p>
<p>此外，搜索引擎数据库还支持 <strong>相关性排序</strong>，能够根据用户的搜索词对所有搜索结果进行打分，把最相关的文档排到最上面，就像谷哥度娘那样。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2572c8fe3e154cb29cdcb1705cf0f788~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770021245&amp;x-signature=XEYrqsbqvId02ZIM7YP%2BgL1Vi5M%3D" alt="" loading="lazy"/></p>
<p>主流的搜索引擎数据库技术有 Elasticsearch、Apache Solr 等，建议只学习 Elasticsearch 就够了，它的社区最活跃、学习资料最丰富。</p>
<h3 data-id="heading-6">向量数据库</h3>
<p>向量数据库是专门用于存储和处理 <strong>高维向量数据</strong> 的数据库，也是 AI 时代最火的数据库。</p>
<p>你好奇道：啥是向量？</p>
<p>鱼皮：简单来说，向量是一个数字数组，每个数字代表一个 <strong>特征</strong> 维度。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c04d008685de4a318315104e23381a26~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770021245&amp;x-signature=qOSZUr7MnBxNaRP7EvniYZi7sUs%3D" alt="" loading="lazy"/></p>
<p>举个例子，在人脸识别系统中，我们需要通过人脸的特征来判断是否为同一个人。每张人脸图像都可以通过 AI 模型转换成一个向量，这个向量可能包含成百上千个数字，每个数字代表图像的一个 <strong>抽象</strong> 特征维度。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fa9fa00afa6b41b0972af45df312adaa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770021245&amp;x-signature=EzupOvM5HZRfp8yHTdhg4YokHqM%3D" alt="" loading="lazy"/></p>
<p>实际上，很难说清楚每个数字代表什么，但便于理解，你可以 <strong>想象</strong> 下标 0 代表鼻子大小，下标 1 代表眼睛距离等等，以此类推。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9cd32f3ef9c94f1ba676ff58e893f7a0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770021245&amp;x-signature=7EuYBR9AsQVmwIIkxhImZ33SFDc%3D" alt="" loading="lazy"/></p>
<p>之后通过余弦相似度等算法来计算两个向量的相似度，就能判断出两张人脸是不是同一个人。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a83b8a05c19144d19c4ba8c20acfe8b1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770021245&amp;x-signature=Q9EAFBZ81B0lFfo1Swxg442QakE%3D" alt="" loading="lazy"/></p>
<p>向量数据库能够高效存储这些多维向量数据、快速计算向量的相似度、并实现各种不同算法的相似性搜索。适用于人脸识别、推荐系统、语义搜索等场景。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0bc23a0832b34717bbb4f416959232ff~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770021245&amp;x-signature=aCFf%2BEJHZcRKi60G31ePyNkAqMc%3D" alt="" loading="lazy"/></p>
<p>在 AI 时代，可以用向量数据库给 AI 提供特定领域的知识库，大大提升回答的准确性。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bb2777332cc14dfb8004ce3afe5c3898~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770021245&amp;x-signature=QNR4f6DE8DzHip37ioaAOh%2FwQx0%3D" alt="" loading="lazy"/></p>
<p>主流的向量数据库技术有 Milvus、Pinecone 等，像 PostgreSQL 关系型数据库也通过插件支持存储向量类型的数据。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/010abc87fd0849eaa106ab9e914d0b31~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770021245&amp;x-signature=V%2Bs7RGh%2B0I98OWyST45lRrEjRF4%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-7">图数据库</h3>
<p>图数据库是专门用于存储和处理 <strong>图结构数据</strong> 的数据库。</p>
<p>注意，这里的 “图” 可不是照片或图表，而是数学中的图论概念，由节点（Node）和边（Edge）构成的图形结构。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9e5d8429200f43bf97760588899b6a1c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770021245&amp;x-signature=Mzij3GMnupW9E4agIfWmA7UGLF8%3D" alt="" loading="lazy"/></p>
<p>比如我们要存储一个社交网络的朋友关系，对应的图可能是由多个用户节点和好友关系边组成的。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c88bd7df939c40e49489a94f632c7e97~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770021245&amp;x-signature=R%2FWB%2FTA6P%2FCCoku4Lo9MnhedOp8%3D" alt="" loading="lazy"/></p>
<p>在图数据库中，需要 2 个表格来存储。</p>
<p>1）节点信息表：</p>





















<table><thead><tr><th>节点 id</th><th>节点名</th></tr></thead><tbody><tr><td>1</td><td>鱼皮</td></tr><tr><td>2</td><td>阿巴</td></tr><tr><td>3</td><td>编程导航</td></tr></tbody></table>
<p>2）边信息表：</p>























<table><thead><tr><th>边 id</th><th>边类型</th><th>起始节点</th><th>结束节点</th></tr></thead><tbody><tr><td>1</td><td>好友</td><td>1</td><td>2</td></tr><tr><td>2</td><td>好友</td><td>2</td><td>3</td></tr></tbody></table>
<p>通过存储这些节点和边的信息，图数据库就能快速查询和分析复杂的关系网络。比如查找 “朋友的朋友”、计算两个用户之间的最短路径、发现社交圈子等等。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/640cfa8af51e435b9302031aa48d801b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770021245&amp;x-signature=LskbgfYboFEPXqOctM%2FLEXXKvVY%3D" alt="" loading="lazy"/></p>
<p>因此，图数据库非常适合构建社交网络、推荐系统、知识图谱等。</p>
<p>比较主流的图数据库有 Neo4j、TigerGraph 等，都支持复杂的图算法和分布式扩展，能够通过并行计算加速图形处理。</p>
<h3 data-id="heading-8">时序数据库</h3>
<p>时序数据库是专门用于高效存储和处理 <strong>时间序列</strong> 的数据库。</p>
<p>时间序列是指以时间作为主要维度的数据序列，也就是每个数据单元都带着 <strong>时间戳</strong>，按时间顺序排列。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6b0abab6908e49aeacbbaf47e71e772d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770021245&amp;x-signature=XbHRHqLtPZyZ6thpsN6txLj83lY%3D" alt="" loading="lazy"/></p>
<p>举个例子，在服务器监控系统中，我们需要每分钟记录服务器的 CPU 使用率、内存使用率等指标，数据结构如下：</p>





























<table><thead><tr><th>时间戳</th><th>设备ID</th><th>CPU使用率</th><th>内存使用率</th></tr></thead><tbody><tr><td>2026-01-08 10:00</td><td>Server001</td><td>45%</td><td>60%</td></tr><tr><td>2026-01-08 10:01</td><td>Server001</td><td>48%</td><td>62%</td></tr><tr><td>2026-01-08 10:02</td><td>Server001</td><td>52%</td><td>65%</td></tr></tbody></table>
<p>有了这些数据，我们就能够按照时间范围进行高效查询、做聚合分析（比如计算过去 1 小时的平均 CPU 使用率）、进行数据可视化展示。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2a3500250b5c4076a96ce303d1188c17~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770021245&amp;x-signature=oqEx%2B5uNfOUUK%2FGt6jP%2Fd65YSCk%3D" alt="" loading="lazy"/></p>
<p>因此，时序数据库非常适用于物联网设备监控、服务器性能监控、金融交易数据分析等场景。</p>
<p>主流的时序数据库技术有 InfluxDB、TimescaleDB 等，一般会配合 Grafana 监控看板一起使用，实现数据存储 + 快速可视化。你在运维团队看到的那些酷炫的实时监控大屏，背后就是时序数据库在支撑。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ed1d6a09e19241f5a7fdf121fc760cc3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770021245&amp;x-signature=r%2BBC6ACZZ1LufZPgPNSXNj67ZpE%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-9">列存数据库</h3>
<p>区别于传统的行式数据库，列存数据库 <strong>以列作为基本的存储单位</strong>，把每一列的数据存储在一起。</p>
<p>拿公司每天的收入来举个例子，传统的行式数据库是这么存储的：</p>





























<table><thead><tr><th>日期</th><th>销售额</th><th>成本</th><th>利润</th></tr></thead><tbody><tr><td>2026-01-01</td><td>500</td><td>600</td><td>-100</td></tr><tr><td>2026-01-02</td><td>280</td><td>450</td><td>-170</td></tr><tr><td>2026-01-03</td><td>290</td><td>480</td><td>-190</td></tr></tbody></table>
<p>而在列存数据库中，底层大概是这么存储的，看起来像是对矩阵做了一次转置：</p>





























<table><thead><tr><th>日期</th><th>2026-01-01</th><th>2026-01-02</th><th>2026-01-03</th></tr></thead><tbody><tr><td>销售额</td><td>500</td><td>280</td><td>290</td></tr><tr><td>成本</td><td>600</td><td>450</td><td>480</td></tr><tr><td>利润</td><td>-100</td><td>-170</td><td>-190</td></tr></tbody></table>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d566c99ed8704ba3975d091e41b0bd7c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770021245&amp;x-signature=2pTG0DVBOQvkF5UCPcDCySpncXM%3D" alt="" loading="lazy"/></p>
<p>如果我们要统计这 3 天公司的总利润，传统的行式数据库需要依次读取每一行的数据，然后再提取出利润这一列进行计算；而列存数据库直接读取利润这一列就行了，不用管其他列，大大提高了数据分析和聚合操作的效率。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f85fc5eafb014db1ba416c0431091586~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770021245&amp;x-signature=OD8S7dYfKAGiCVSqzEdB%2FQ2eU5Q%3D" alt="" loading="lazy"/></p>
<p>而且从计算机底层来分析，把相同类型的数据在同一列中连续存储，可以实现更好的数据压缩效果、节约存储空间。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7500719925a5478e972fb3978fae8d53~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770021245&amp;x-signature=Qxg6XYNowgSnyjgCFWzxbgz1q%2Bs%3D" alt="" loading="lazy"/></p>
<p>因此，列存数据库适用于报表生成、数据仓库、商业智能分析等场景。</p>
<p>主流的列存数据库技术有 ClickHouse、Apache HBase、Druid 等，都是大数据开发的必修课。</p>
<h2 data-id="heading-10">融合型数据库</h2>
<p>前面我们讲了关系型和非关系型数据库，要么强调灵活查询、要么强调性能和扩展，各有侧重。</p>
<p>但有些数据库偏偏 “既要又要”，要把两者的优点融合到一起，这就是接下来要讲的融合型数据库。</p>
<h3 data-id="heading-11">NewSQL 数据库</h3>
<p>NewSQL 是一类新兴的数据库，它融合了传统关系型和非关系型数据库的优点。既有传统 SQL 数据库的 ACID 特性和事务支持，又有 NoSQL 的水平扩展能力和高性能。支持标准 SQL 查询、分布式架构、自动容错和故障恢复，可以替代传统的分库分表方案，特别适用于大厂的高并发系统。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6b01183741414b089be79100a9b89c9f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770021245&amp;x-signature=6Yde93Kl6zvHeH%2Fz0mOHL7mWCMU%3D" alt="" loading="lazy"/></p>
<p>主流的 NewSQL 数据库有 TiDB、CockroachDB、Google Spanner 等。其中 TiDB 是国产之光，支持 HTAP（混合事务分析处理），而且完全兼容 MySQL 协议，迁移成本低；CockroachDB 人称 “蟑螂数据库”，因为它像蟑螂一样顽强，集群中一个节点挂了，其他节点依然能正常服务，打不死。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dc21d3d772b94cb59dc8e2ca490ecaee~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770021245&amp;x-signature=nz97%2BSd5zgtGimATcDdPGkg6BRI%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-12">多模数据库</h3>
<p>区别于前面所有存储单一数据模型的数据库，多模数据库能够直接在一个数据库里同时存储和处理 <strong>多种不同类型</strong> 的数据。比如关系型数据、文档数据、图形数据、键值对数据等等，非常灵活、省去了维护多个数据库的麻烦。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/da4020cd2a37461ebc9d814db5fade4f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770021245&amp;x-signature=NMHMRgdXYMr5k4BYuVKXUi7y%2FQ0%3D" alt="" loading="lazy"/></p>
<p>而且多模数据库还支持跨模型事务，能够更轻松地实现数据的一致性和完整性，不需要手动实现跨库事务、跨库数据同步这些复杂操作。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3bf9164dadab43bfaabe7eee5470b2d0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770021245&amp;x-signature=4%2BE5NlCjKbfnGdJ1shuwjX23tIY%3D" alt="" loading="lazy"/></p>
<p>虽然听起来很厉害，但实际开发中很少用，因为样样通样样松，多模数据库的性能往往不如专注单一场景的数据库。</p>
<p>原生的多模数据库技术有 ArangoDB、OrientDB 等，它们从设计之初就是为多模式设计的。前面也提到，虽然 PostgreSQL 这样的老牌关系型数据库可以通过丰富的插件支持多种数据类型（比如 JSON 文档、向量、地理空间数据等），但它的核心始终是关系模型，多模支持算是锦上添花，不过这也体现了 PostgreSQL 的强大。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e2953b5f5e24413c8cc71841651738e8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770021245&amp;x-signature=B6QlHXeEzm5QtXCOUondZT7jYlg%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-13">怎么选择数据库？</h2>
<p>你一脸懵逼：阿巴阿巴，你讲了这么多数据库，俺头都大了，到底该选哪个？</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4600de1399f845d084ed9d68637c2be9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770021245&amp;x-signature=FicllqSlNNfUpkv2W8Hl8vsA4Es%3D" alt="" loading="lazy"/></p>
<p>鱼皮笑了笑：别慌，数据库选型其实没那么复杂。</p>
<p>优先选用 MySQL / PostgreSQL + Redis，能覆盖 90% 的项目需求。</p>
<p>有特定功能或优化需求时，再选择专业数据库。比如需要搜索功能了，再加 Elasticsearch；要做 AI 知识库了，再加向量数据库。</p>
<p>毕竟每多一个数据库，就多一份运维工作和故障风险。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/80b47d5e83564af395f6c3ca5be4aee6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770021245&amp;x-signature=nMPIBytYs9mvEtKQcqLgeUV7udE%3D" alt="" loading="lazy"/></p>
<p>你：学会了学废了！对了鱼皮，我还听说过数据湖、数据仓库，这些是啥啊？</p>
<p>鱼皮：简单来说，数据仓库是用来存储和分析大量结构化数据的；数据湖更像个大水池，什么数据都能往里扔，包括日志、图片、视频这些非结构化数据。它们更多是大数据架构层面的概念。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9a193d06720f48ac95375f13ce32e8ad~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770021245&amp;x-signature=M0%2FgEahLwA4QsHRiCPFVH9RrwZ0%3D" alt="" loading="lazy"/></p>
<p>感兴趣的话，点个关注，后面专门出一期讲讲~</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0c50da41431d4900afdc02ba3d845a3b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770021245&amp;x-signature=5Z7jQACzMLbezgSuEdGutLGCs7Q%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-14">更多</h2>
<p>💻 编程学习交流：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fliyupi%2Fcode-nav" target="_blank" title="https://github.com/liyupi/code-nav" ref="nofollow noopener noreferrer">编程导航</a> 📃 简历快速制作：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fliyupi%2Flaoyujianli" target="_blank" title="https://github.com/liyupi/laoyujianli" ref="nofollow noopener noreferrer">老鱼简历</a> ✏️ 面试刷题神器：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fliyupi%2Fmianshiya" target="_blank" title="https://github.com/liyupi/mianshiya" ref="nofollow noopener noreferrer">面试鸭</a> 📖 AI 学习指南：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fliyupi%2Fai-guide" target="_blank" title="https://github.com/liyupi/ai-guide" ref="nofollow noopener noreferrer">鱼皮 AI 导航</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Windows 开机自启动的 8 种姿势：写给开发者的深度对比指南]]></title>    <link>https://juejin.cn/post/7599220371665715240</link>    <guid>https://juejin.cn/post/7599220371665715240</guid>    <pubDate>2026-01-26T08:02:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599220371665715240" data-draft-id="7599474528238092328" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Windows 开机自启动的 8 种姿势：写给开发者的深度对比指南"/> <meta itemprop="keywords" content="Windows,Electron"/> <meta itemprop="datePublished" content="2026-01-26T08:02:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="BanShan_Alec"/> <meta itemprop="url" content="https://juejin.cn/user/3887501804058861"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Windows 开机自启动的 8 种姿势：写给开发者的深度对比指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3887501804058861/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    BanShan_Alec
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T08:02:41.000Z" title="Mon Jan 26 2026 08:02:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    10
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Windows 开机自启动的 8 种姿势：写给开发者的深度对比指南</h2>
<blockquote>
<p>最近在做桌面应用的开机自启动功能，踩了不少坑。今天就来聊聊 Windows 系统下那些五花八门的自启动方式，帮你找到最适合你项目的那一款。</p>
</blockquote>
<p>📦 <strong>本文所有测试数据均来自开源项目</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FBanShan-Alec%2Fwindows-startup-run-demo" target="_blank" title="https://github.com/BanShan-Alec/windows-startup-run-demo" ref="nofollow noopener noreferrer">windows-startup-run-demo</a>，包含完整的测试代码、配置脚本和原始日志，欢迎 Star ⭐ 和复现验证！</p>
<h3 data-id="heading-1">🎭 先说结论</h3>
<p>如果你赶时间，直接看这个表格：</p>






















































































<table><thead><tr><th>方式</th><th>启动时机</th><th>实测延迟</th><th>接入成本</th><th>杀软友好</th><th>多用户</th><th>推荐场景</th></tr></thead><tbody><tr><td>Windows 服务</td><td>系统启动</td><td>~13s</td><td>⭐⭐⭐</td><td>✅</td><td>✅</td><td>后台服务、VPN、代理</td></tr><tr><td>任务计划(系统启动)</td><td>系统启动后</td><td>~14s</td><td>⭐⭐⭐</td><td>✅</td><td>✅</td><td>需要早启动的用户程序</td></tr><tr><td>Userinit 追加</td><td>用户登录时</td><td>~13s</td><td>⭐⭐</td><td>⚠️</td><td>❌</td><td><strong>不推荐</strong></td></tr><tr><td>任务计划(用户登录)</td><td>用户登录</td><td>~19s</td><td>⭐⭐⭐</td><td>✅</td><td>✅</td><td>最佳平衡方案</td></tr><tr><td>注册表 HKLM\Run</td><td>用户登录</td><td>~52s</td><td>⭐⭐</td><td>✅</td><td>✅</td><td>多用户共享的轻量程序</td></tr><tr><td>注册表 HKCU\Run</td><td>用户登录</td><td>~79s</td><td>⭐</td><td>✅</td><td>❌</td><td>最简单的用户级自启</td></tr><tr><td>启动文件夹</td><td>用户登录后</td><td>~81s</td><td>⭐</td><td>✅</td><td>❌</td><td>小白用户自定义</td></tr><tr><td>Shell 替换</td><td>用户登录时</td><td>-</td><td>⭐⭐⭐⭐</td><td>❌</td><td>❌</td><td><strong>千万别用</strong></td></tr></tbody></table>
<blockquote>
<p>💡 延迟数据来自实际测试（SSD 机器，从开机到程序执行的时间）—— 测试代码开源在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FBanShan-Alec%2Fwindows-startup-run-demo" target="_blank" title="https://github.com/BanShan-Alec/windows-startup-run-demo" ref="nofollow noopener noreferrer">GitHub</a></p>
</blockquote>
<hr/>
<h3 data-id="heading-2">🚀 详细拆解每种方式</h3>
<h4 data-id="heading-3">1. Windows 服务 (Service) —— 最早起床的那个</h4>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">启动延迟: ~13秒 | 权限: 管理员 | 复杂度: 中等</span>
</code></pre>
<p>Windows 服务是系统级的进程，在用户登录之前就已经跑起来了。</p>
<p><strong>优点：</strong></p>
<ul>
<li>🏃 启动最早，系统刚起来就开始工作</li>
<li>🛡️ 杀软完全不会拦截（正规服务）</li>
<li>👥 天然支持多用户，跟用户会话无关</li>
<li>🔄 可配置自动重启、依赖关系等</li>
</ul>
<p><strong>缺点：</strong></p>
<ul>
<li>🖥️ 没有 GUI 能力（Session 0 隔离问题）</li>
<li>📦 需要额外工具来包装（如 WinSW、NSSM）</li>
<li>⚙️ 安装需要管理员权限</li>
</ul>
<p><strong>适合场景：</strong> VPN 客户端、系统代理（Clash）、后台同步服务</p>
<p><strong>代码示例（使用 schtasks 创建）：</strong></p>
<pre><code class="hljs language-powershell" lang="powershell"># 或者用 sc.exe 创建原生服务
sc.exe create "MyService" binPath= "C:\path\to\service.exe" start= auto
</code></pre>
<p><strong>实战经验：</strong> 如果你是 Node.js/Electron 开发者，强烈推荐 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fwinsw%2Fwinsw" target="_blank" title="https://github.com/winsw/winsw" ref="nofollow noopener noreferrer">WinSW</a>，只需要一个 XML 配置文件就能把普通 exe 包装成服务。</p>
<hr/>
<h4 data-id="heading-4">2. 任务计划 - 系统启动触发 (Task Scheduler - At Startup)</h4>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">启动延迟: ~14秒 | 权限: 管理员 | 复杂度: 中等</span>
</code></pre>
<p>这是通过 Windows 任务计划程序，设置"计算机启动时"触发的任务。</p>
<p><strong>优点：</strong></p>
<ul>
<li>⚡ 启动很早，仅次于服务</li>
<li>🎛️ 可以精细控制（延迟启动、条件触发、优先级等）</li>
<li>🖥️ 可以有 GUI（跟服务最大的区别！）</li>
<li>📋 系统原生支持，杀软友好</li>
</ul>
<p><strong>缺点：</strong></p>
<ul>
<li>📝 配置相对复杂（XML 或 COM API）</li>
<li>🔑 需要管理员权限创建</li>
</ul>
<p><strong>适合场景：</strong> 需要早启动 + 有界面的应用</p>
<p><strong>代码示例（schtasks 命令）：</strong></p>
<pre><code class="hljs language-powershell" lang="powershell">schtasks /create /tn "MyApp-Startup" /tr "C:\path\to\app.exe" /sc onstart /ru SYSTEM
</code></pre>
<p><strong>Pro Tip：</strong> 你可以设置任务的 <code>Priority</code> 为 <code>0</code>（实时）到 <code>10</code>（空闲），默认是 <code>7</code>。想启动更快？调低这个值！</p>
<hr/>
<h4 data-id="heading-5">3. Userinit 追加 —— 危险的捷径 ⚠️</h4>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">启动延迟: ~13秒 | 权限: 管理员 | 复杂度: 低 | 风险: 高</span>
</code></pre>
<p>Userinit 是 Windows 登录过程的一部分，通过修改注册表：</p>
<pre><code class="hljs">HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon\Userinit
</code></pre>
<p>默认值是 <code>C:\Windows\system32\userinit.exe,</code>，你可以在后面追加自己的程序。</p>
<p><strong>优点：</strong></p>
<ul>
<li>⚡ 启动非常早，几乎和服务同时</li>
</ul>
<p><strong>缺点：</strong></p>
<ul>
<li>🚨 <strong>极易被杀软报毒！</strong> 这是恶意软件常用的驻留方式</li>
<li>💥 配置错误会导致无法登录系统</li>
<li>❌ 不支持多用户（只能全局配置）</li>
<li>🔧 只能用于单个程序的追加</li>
</ul>
<p><strong>我的建议：</strong> 除非你在做安全研究，否则 <strong>千万别用</strong>。就算用，也要做好被 360、火绒拦截的心理准备。</p>
<hr/>
<h4 data-id="heading-6">4. 任务计划 - 用户登录触发 (Task Scheduler - At Logon) ⭐ 推荐</h4>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">启动延迟: ~19秒 | 权限: 普通/管理员 | 复杂度: 中等</span>
</code></pre>
<p>这是我个人最推荐的方式，平衡了启动速度、安全性和灵活性。</p>
<p><strong>优点：</strong></p>
<ul>
<li>📈 启动较早（比注册表 Run 快得多！）</li>
<li>🔐 可以不需要管理员权限（只为当前用户创建）</li>
<li>🛡️ 杀软完全不会拦截</li>
<li>👥 天然支持多用户（每个用户独立任务）</li>
<li>🎛️ 可精细控制（延迟、条件、重试策略等）</li>
<li>🖥️ 支持 GUI 程序</li>
</ul>
<p><strong>缺点：</strong></p>
<ul>
<li>📝 需要处理 XML 或 schtasks 命令</li>
<li>🔍 调试稍微麻烦一点</li>
</ul>
<p><strong>代码示例：</strong></p>
<pre><code class="hljs language-powershell" lang="powershell"># 为当前用户创建登录触发的任务
schtasks /create /tn "MyApp-Logon" /tr "C:\path\to\app.exe" /sc onlogon
</code></pre>
<p><strong>用 XML 定义（更灵活）：</strong></p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"UTF-16"</span>?&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">Task</span> <span class="hljs-attr">version</span>=<span class="hljs-string">"1.2"</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://schemas.microsoft.com/windows/2004/02/mit/task"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">Triggers</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">LogonTrigger</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Enabled</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">Enabled</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">LogonTrigger</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">Triggers</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">Principals</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">Principal</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">LogonType</span>&gt;</span>InteractiveToken<span class="hljs-tag">&lt;/<span class="hljs-name">LogonType</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">RunLevel</span>&gt;</span>LeastPrivilege<span class="hljs-tag">&lt;/<span class="hljs-name">RunLevel</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">Principal</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">Principals</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">Settings</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">Priority</span>&gt;</span>4<span class="hljs-tag">&lt;/<span class="hljs-name">Priority</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">ExecutionTimeLimit</span>&gt;</span>PT0S<span class="hljs-tag">&lt;/<span class="hljs-name">ExecutionTimeLimit</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">Settings</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">Actions</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">Exec</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Command</span>&gt;</span>C:\path\to\app.exe<span class="hljs-tag">&lt;/<span class="hljs-name">Command</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">Exec</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">Actions</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">Task</span>&gt;</span>
</code></pre>
<hr/>
<h4 data-id="heading-7">5. 注册表 HKLM\Run —— 老牌稳定选手</h4>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">启动延迟: ~52秒 | 权限: 管理员 | 复杂度: 低</span>
</code></pre>
<p>位置：<code>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Run</code></p>
<p>这是最经典的自启动方式之一，所有用户登录时都会执行。</p>
<p><strong>优点：</strong></p>
<ul>
<li>📖 实现简单，一行注册表搞定</li>
<li>👥 支持多用户（所有用户共享）</li>
<li>🛡️ 杀软友好（正规做法）</li>
</ul>
<p><strong>缺点：</strong></p>
<ul>
<li>🐢 启动较晚（等用户登录流程走完）</li>
<li>🔑 需要管理员权限</li>
</ul>
<p><strong>代码示例：</strong></p>
<pre><code class="hljs language-powershell" lang="powershell"># PowerShell
Set-ItemProperty -Path "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Run" -Name "MyApp" -Value "C:\path\to\app.exe"
</code></pre>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Node.js (使用 regedit 包)</span>
<span class="hljs-keyword">const</span> regedit = <span class="hljs-built_in">require</span>(<span class="hljs-string">'regedit'</span>);
regedit.<span class="hljs-title function_">putValue</span>({
  <span class="hljs-string">'HKLM\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run'</span>: {
    <span class="hljs-string">'MyApp'</span>: { <span class="hljs-attr">value</span>: <span class="hljs-string">'C:\\path\\to\\app.exe'</span>, <span class="hljs-attr">type</span>: <span class="hljs-string">'REG_SZ'</span> }
  }
});
</code></pre>
<hr/>
<h4 data-id="heading-8">6. 注册表 HKCU\Run —— 最简单的用户级方案</h4>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">启动延迟: ~79秒 | 权限: 普通 | 复杂度: 最低</span>
</code></pre>
<p>位置：<code>HKEY_CURRENT_USER\SOFTWARE\Microsoft\Windows\CurrentVersion\Run</code></p>
<p><strong>优点：</strong></p>
<ul>
<li>✨ <strong>不需要管理员权限！</strong></li>
<li>📖 实现最简单</li>
<li>🛡️ 杀软友好</li>
</ul>
<p><strong>缺点：</strong></p>
<ul>
<li>🐢 启动很晚</li>
<li>❌ 不支持多用户（只对当前用户生效）</li>
</ul>
<p><strong>适合场景：</strong> 不需要快速启动的普通用户应用（如 微信）</p>
<p><strong>代码示例：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Electron 内置支持！</span>
<span class="hljs-keyword">const</span> { app } = <span class="hljs-built_in">require</span>(<span class="hljs-string">'electron'</span>);

<span class="hljs-comment">// 开启自启动</span>
app.<span class="hljs-title function_">setLoginItemSettings</span>({
  <span class="hljs-attr">openAtLogin</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">path</span>: app.<span class="hljs-title function_">getPath</span>(<span class="hljs-string">'exe'</span>)
});
</code></pre>
<blockquote>
<p>🎯 Electron 的 <code>setLoginItemSettings</code> 默认就是写 HKCU\Run，简单粗暴。</p>
</blockquote>
<hr/>
<h4 data-id="heading-9">7. 启动文件夹 (Startup Folder) —— 小白最爱</h4>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">启动延迟: ~81秒 | 权限: 普通 | 复杂度: 最低</span>
</code></pre>
<p>位置：</p>
<ul>
<li>当前用户：<code>%APPDATA%\Microsoft\Windows\Start Menu\Programs\Startup</code></li>
<li>所有用户：<code>C:\ProgramData\Microsoft\Windows\Start Menu\Programs\Startup</code></li>
</ul>
<p><strong>优点：</strong></p>
<ul>
<li>👀 用户可见，透明可控</li>
<li>🔧 用户可以自己管理（拖拽快捷方式即可）</li>
<li>🛡️ 杀软绝对不会拦截</li>
</ul>
<p><strong>缺点：</strong></p>
<ul>
<li>🐢 启动最晚（所有方式中最慢）</li>
<li>🗂️ 容易被用户误删</li>
</ul>
<p><strong>适合场景：</strong> 让用户自己决定是否开机启动的情况</p>
<p><strong>代码示例：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>);
<span class="hljs-keyword">const</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">'path'</span>);
<span class="hljs-keyword">const</span> { shell } = <span class="hljs-built_in">require</span>(<span class="hljs-string">'electron'</span>);

<span class="hljs-comment">// 获取启动文件夹路径</span>
<span class="hljs-keyword">const</span> startupFolder = path.<span class="hljs-title function_">join</span>(
  process.<span class="hljs-property">env</span>.<span class="hljs-property">APPDATA</span>,
  <span class="hljs-string">'Microsoft/Windows/Start Menu/Programs/Startup'</span>
);

<span class="hljs-comment">// 创建快捷方式</span>
shell.<span class="hljs-title function_">writeShortcutLink</span>(
  path.<span class="hljs-title function_">join</span>(startupFolder, <span class="hljs-string">'MyApp.lnk'</span>),
  { <span class="hljs-attr">target</span>: process.<span class="hljs-property">execPath</span> }
);
</code></pre>
<hr/>
<h4 data-id="heading-10">8. Shell 替换 —— 别碰它 ☠️</h4>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">权限: 管理员 | 风险: 极高</span>
</code></pre>
<p>位置：<code>HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon\Shell</code></p>
<p>这个注册表键决定了用户登录后启动什么程序（默认是 <code>explorer.exe</code>）。</p>
<p><strong>理论上你可以：</strong></p>
<pre><code class="hljs language-lua" lang="lua">explorer.exe, C:\<span class="hljs-built_in">path</span>\to\your\app.exe
</code></pre>
<p><strong>但是：</strong></p>
<ul>
<li>🚨 <strong>大概率被杀软直接干掉</strong></li>
<li>💀 配置错误 = 系统无法进入桌面</li>
<li>🦠 这是恶意软件最爱用的手法</li>
</ul>
<p><strong>我的态度：</strong> 如果有人让你用这个方法，拉黑他。</p>
<hr/>
<h3 data-id="heading-11">📊 启动时间真实日志</h3>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">开机时间线</span> <span class="hljs-string">(SSD</span> <span class="hljs-string">机器实测)</span>
<span class="hljs-string">─────────────────────────────────────────────────────────────────────────</span>
<span class="hljs-number">2026-01-26 14:59:33.67</span> <span class="hljs-string">|</span> <span class="hljs-string">SERVICE</span>         <span class="hljs-string">|</span> <span class="hljs-attr">Boot:</span> <span class="hljs-number">2026-01-26 14:59:20.50</span> <span class="hljs-string">|</span> <span class="hljs-string">+13.18s</span>
<span class="hljs-number">2026-01-26 14:59:33.71</span> <span class="hljs-string">|</span> <span class="hljs-string">USERINIT</span>        <span class="hljs-string">|</span> <span class="hljs-attr">Boot:</span> <span class="hljs-number">2026-01-26 14:59:20.50</span> <span class="hljs-string">|</span> <span class="hljs-string">+13.21s</span>
<span class="hljs-number">2026-01-26 14:59:34.14</span> <span class="hljs-string">|</span> <span class="hljs-string">TASK_STARTUP</span>    <span class="hljs-string">|</span> <span class="hljs-attr">Boot:</span> <span class="hljs-number">2026-01-26 14:59:20.50</span> <span class="hljs-string">|</span> <span class="hljs-string">+13.65s</span>
<span class="hljs-number">2026-01-26 14:59:39.01</span> <span class="hljs-string">|</span> <span class="hljs-string">TASK_LOGON</span>      <span class="hljs-string">|</span> <span class="hljs-attr">Boot:</span> <span class="hljs-number">2026-01-26 14:59:20.50</span> <span class="hljs-string">|</span> <span class="hljs-string">+18.52s</span>
<span class="hljs-number">2026-01-26 15:00:12.94</span> <span class="hljs-string">|</span> <span class="hljs-string">HKLM_RUN</span>        <span class="hljs-string">|</span> <span class="hljs-attr">Boot:</span> <span class="hljs-number">2026-01-26 14:59:20.50</span> <span class="hljs-string">|</span> <span class="hljs-string">+52.44s</span>
<span class="hljs-number">2026-01-26 15:00:39.34</span> <span class="hljs-string">|</span> <span class="hljs-string">HKCU_RUN</span>        <span class="hljs-string">|</span> <span class="hljs-attr">Boot:</span> <span class="hljs-number">2026-01-26 14:59:20.50</span> <span class="hljs-string">|</span> <span class="hljs-string">+78.84s</span>
<span class="hljs-number">2026-01-26 15:00:41.96</span> <span class="hljs-string">|</span> <span class="hljs-string">STARTUP_FOLDER</span>  <span class="hljs-string">|</span> <span class="hljs-attr">Boot:</span> <span class="hljs-number">2026-01-26 14:59:20.50</span> <span class="hljs-string">|</span> <span class="hljs-string">+81.47s</span>
</code></pre>
<hr/>
<h3 data-id="heading-12">🔒 安全性对比：杀软怎么看？</h3>





























































<table><thead><tr><th>方式</th><th>360</th><th>火绒</th><th>Windows Defender</th><th>说明</th></tr></thead><tbody><tr><td>Windows 服务</td><td>⚠️</td><td>⚠️</td><td>✅</td><td>可能被标记为可疑</td></tr><tr><td>任务计划</td><td>✅</td><td>✅</td><td>✅</td><td>系统原生功能</td></tr><tr><td>HKLM\Run</td><td>⚠️</td><td>⚠️</td><td>✅</td><td>标准做法</td></tr><tr><td>HKCU\Run</td><td>⚠️</td><td>⚠️</td><td>✅</td><td>标准做法</td></tr><tr><td>启动文件夹</td><td>✅</td><td>✅</td><td>✅</td><td>用户可见，最安全</td></tr><tr><td>Userinit</td><td>⚠️</td><td>⚠️</td><td>⚠️</td><td>高概率被标记为可疑</td></tr><tr><td>Shell 替换</td><td>❌</td><td>❌</td><td>⚠️</td><td>高概率被拦截</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-13">🎯 不同场景的选择建议</h3>
<h4 data-id="heading-14">场景1：普通桌面应用（QQ/微信类）</h4>
<p><strong>推荐：</strong> HKCU\Run 或 Electron 的 <code>setLoginItemSettings</code></p>
<ul>
<li>不需要管理员权限</li>
<li>接入成本最低</li>
<li>启动晚点无所谓</li>
</ul>
<h4 data-id="heading-15">场景2：需要尽早启动的应用（VPN/代理类）</h4>
<p><strong>推荐：</strong> 任务计划（用户登录触发）+ 低优先级</p>
<ul>
<li>比注册表快 60 秒</li>
<li>不需要管理员权限也能配置</li>
<li>杀软友好</li>
</ul>
<h4 data-id="heading-16">场景3：纯后台服务（同步/监控类）</h4>
<p><strong>推荐：</strong> Windows 服务</p>
<ul>
<li>最早启动</li>
<li>自动重启能力</li>
<li>但需要 WinSW 等工具包装</li>
</ul>
<h4 data-id="heading-17">场景4：多用户环境</h4>
<p><strong>推荐：</strong> 任务计划 或 HKLM\Run</p>
<ul>
<li>需要管理员权限</li>
<li>所有用户共享配置</li>
</ul>
<hr/>
<h3 data-id="heading-18">📝 总结</h3>
<ol>
<li><strong>追求速度</strong> → 任务计划（系统启动触发）或 Windows 服务</li>
<li><strong>追求简单</strong> → HKCU\Run（Electron 原生支持）</li>
<li><strong>追求稳妥</strong> → 任务计划（用户登录触发）⭐ <strong>推荐</strong></li>
<li><strong>追求透明</strong> → 启动文件夹</li>
<li><strong>追求刺激</strong> → Userinit / Shell 替换（开玩笑的，别用）</li>
</ol>
<p>希望这篇文章能帮你在做开机自启动功能时少踩坑。如果你有其他问题或者发现了更好的方案，欢迎交流！</p>
<hr/>
<h3 data-id="heading-19">🔗 相关资源</h3>
<p><strong>测试项目开源地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FBanShan-Alec%2Fwindows-startup-run-demo" target="_blank" title="https://github.com/BanShan-Alec/windows-startup-run-demo" ref="nofollow noopener noreferrer">windows-startup-run-demo</a></p>
<p>项目包含：</p>
<ul>
<li>✅ 完整的 8 种自启动方式配置脚本</li>
<li>✅ 可复现的启动时间测试程序</li>
<li>✅ 原始测试日志数据</li>
<li>✅ 一键配置 / 清理脚本</li>
</ul>
<p>欢迎 Clone 下来在自己机器上跑一遍，看看你的环境下各种方式的启动时间差异！</p>
<hr/>
<h3 data-id="heading-20">参考文档</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Flearn.microsoft.com%2Fzh-cn%2Fwindows%2Fwin32%2Ftaskschd%2Ftaskschedulerschema-priority-settingstype-element" target="_blank" title="https://learn.microsoft.com/zh-cn/windows/win32/taskschd/taskschedulerschema-priority-settingstype-element" ref="nofollow noopener noreferrer">优先级 (设置类型) 元素 - Win32 apps | Microsoft Learn</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fclash-verge-rev%2Fclash-verge-rev%2Fissues%2F5623%23issuecomment-3615585962" target="_blank" title="https://github.com/clash-verge-rev/clash-verge-rev/issues/5623#issuecomment-3615585962" ref="nofollow noopener noreferrer">[BUG] 开机自启时机太晚 · Issue #5623 · clash-verge-rev/clash-verge-rev</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fwinsw%2Fwinsw" target="_blank" title="https://github.com/winsw/winsw" ref="nofollow noopener noreferrer">winsw/winsw: A wrapper executable that can run any executable as a Windows service, in a permissive license.</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fsteamcommunity.com%2Fapp%2F431960%2Fdiscussions%2F2%2F1354868867716403366%2F" target="_blank" title="https://steamcommunity.com/app/431960/discussions/2/1354868867716403366/" ref="nofollow noopener noreferrer">Questions &amp; Problems with autostarting Wallpaper Engine when Windows starts :: Wallpaper Engine：壁纸引擎 General Discussions</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[vue3+ts+eslint+prettier 实现代码风格统一]]></title>    <link>https://juejin.cn/post/7599475458719285248</link>    <guid>https://juejin.cn/post/7599475458719285248</guid>    <pubDate>2026-01-26T08:03:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599475458719285248" data-draft-id="7599232628185153571" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="vue3+ts+eslint+prettier 实现代码风格统一"/> <meta itemprop="keywords" content="ESLint"/> <meta itemprop="datePublished" content="2026-01-26T08:03:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="奔跑路上的Me"/> <meta itemprop="url" content="https://juejin.cn/user/1680516363335208"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            vue3+ts+eslint+prettier 实现代码风格统一
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1680516363335208/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    奔跑路上的Me
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T08:03:54.000Z" title="Mon Jan 26 2026 08:03:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">vue3+ts+eslint+prettier 实现代码风格统一</h2>
<h4 data-id="heading-1">一.安装eslint</h4>
<p><code>npm i eslint -D</code></p>
<h6 data-id="heading-2">1.初始化eslint</h6>
<p>当前文章是基于 <code>eslint9.39.2</code> 版本创作</p>
<p>创建eslint配置文件，eslint8.21.0之后可以使用eslint.config.js文件名。</p>
<p>或使用命令初始化eslint配置文件</p>
<p><code>npx eslint --init</code></p>
<p>1）安装@eslint/config@lates
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8e6f7a14b9be4d5982e3349b521e9ac4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aWU6LeR6Lev5LiK55qETWU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770019438&amp;x-signature=XlhGoavpUgytzDFvM5sFx9QeADA%3D" alt="image.png" loading="lazy"/>
2）选择要检测的文件
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dcd6cfd1c4b845528f83141df471655e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aWU6LeR6Lev5LiK55qETWU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770019438&amp;x-signature=gnljG8vMKT17buZwBfhQpbjtx0g%3D" alt="image.png" loading="lazy"/>
3）选择如何使用eslint
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b3f6531436c04f888340c7ed61c3d5da~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aWU6LeR6Lev5LiK55qETWU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770019438&amp;x-signature=KfRjH0yD2Bj58qAR%2BNbjeY%2BQmiM%3D" alt="image.png" loading="lazy"/>
4）选择使用哪种模块类型
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e416c870094845269061afefab2e9b1b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aWU6LeR6Lev5LiK55qETWU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770019438&amp;x-signature=6kPI%2FdSzn8mPG2SJGA81vZZVq8g%3D" alt="image.png" loading="lazy"/>
5）框架选择
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b9b38c56f2ef4c60acbbaa3bbe0d0051~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aWU6LeR6Lev5LiK55qETWU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770019438&amp;x-signature=1gM6WbD5PlSJBRNW4bq%2FdSLHoh4%3D" alt="image.png" loading="lazy"/>
6）是否使用ts
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/13b1b1e0bbac4a398afc7538796f3323~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aWU6LeR6Lev5LiK55qETWU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770019438&amp;x-signature=dXJEcNpAH%2BCXaU7N2h8HFnmuc%2Fg%3D" alt="image.png" loading="lazy"/>
7）选择运行环境
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/57136d59483749278086fff78d4bf1c0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aWU6LeR6Lev5LiK55qETWU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770019438&amp;x-signature=BWCBKmgW2JgC2Xljp%2B1bw4cXh9k%3D" alt="image.png" loading="lazy"/>
8）希望配置文件用什么语法
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c0b3387f61444977bc698dd834d5ab61~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aWU6LeR6Lev5LiK55qETWU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770019438&amp;x-signature=dN7xHzPfhoZneKqJkdDL%2FBr%2FAxw%3D" alt="image.png" loading="lazy"/>
9）选择要安装解析相关依赖包
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f8c8d5db564b4b08b706113f950a14e0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aWU6LeR6Lev5LiK55qETWU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770019438&amp;x-signature=YMOB%2BiCmyBOJob3VTaajsEIkASk%3D" alt="image.png" loading="lazy"/>
10）选择希望使用的安装包工具
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/43d1064f7a6943dbbeeeefade8ce9390~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aWU6LeR6Lev5LiK55qETWU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770019438&amp;x-signature=Mm%2Fc0w%2B1NE7Q5vVPwbjZEEOolgU%3D" alt="image.png" loading="lazy"/></p>
<h6 data-id="heading-3">2.修改eslint.config.js中的相关配置</h6>
<pre><code class="hljs language-import" lang="import">import pluginJs from '@eslint/js';
import tseslint from 'typescript-eslint';
import pluginVue from 'eslint-plugin-vue';
import prettier from 'eslint-plugin-prettier';
import prettierConfig from 'eslint-config-prettier';
import eslintparser from 'vue-eslint-parser';
export default [
  {
    files: ['**/*.{js,mjs,cjs,vue}'],
    ignores: [
        'node_modules/**', 
        'dist/**', 
        'public/**', 
        'coverage/**', 
        'src/assets/**'
    ],
    languageOptions: {
      globals: globals.browser,
      parser: eslintparser,
      parserOptions: {
        ecmaVersion: 2020,
        sourceType: 'module',
        parser: '@typescript-eslint/parser',
        ecmaFeatures: {
          jsx: true,
        },
      },
    },
  },

  pluginJs.configs.recommended,
  ...tseslint.configs.recommended,
  ...pluginVue.configs['flat/essential'],
  ...pluginVue.configs['flat/recommended'],
  prettierConfig, // 解决prettier和eslint的冲突
  {
    plugins: {
      prettier: prettier, // 使用prettier格式化
    },
    rules: {
      // 开启这条规则后，会将prettier的校验规则传递给eslint，这样eslint就可以按照prettier的方式来进行代码格式的校验
      'prettier/prettier': 'error',
      'no-var': 'error', // 要求使用 let 或 const 而不是 var
      'no-console': 'off',
      'no-restricted-globals': 'off',
      'no-restricted-syntax': 'off',
      'vue/multi-word-component-names': 'off', // 禁用vue文件强制多个单词命名
      'no-multiple-empty-lines': ['warn', { max: 1 }],
      'vue/valid-template-root': 'off',
      'no-unused-vars': 'off',
      'no-undef': 'off', // 自动引入vue和UI组件库报错问题
      '@typescript-eslint/no-unused-vars': 'off', // 关闭未使用变量规则
      '@typescript-eslint/no-explicit-any': 'off', // 关闭ts中any校验
      semi: ['error', 'always'],
      'no-debugger': 'warn', //提交时不允许有debugger
      'no-console': [
        //提交时不允许有console.log
        'warn',
        {
          allow: ['warn', 'error'],
        },
      ],
    },
  },
];

</code></pre>
<h6 data-id="heading-4">3.修改vite.config.ts</h6>
<pre><code class="hljs language-php" lang="php"><span class="hljs-comment">// 引入vite-plugin-eslint </span>
import eslintPlugin <span class="hljs-keyword">from</span> <span class="hljs-string">'vite-plugin-eslint'</span> 
<span class="hljs-comment">// 配置plugins </span>
<span class="hljs-title function_ invoke__">eslintPlugin</span>({ 
    <span class="hljs-attr">include</span>: [<span class="hljs-string">'src/**/*.js'</span>, <span class="hljs-string">'src/**/*.vue'</span>], 
    <span class="hljs-attr">cache</span>: <span class="hljs-literal">true</span>, 
}),

</code></pre>
<h6 data-id="heading-5">4.命令行式运行：修改 package.json</h6>
<pre><code class="hljs language-swift" lang="swift">{ 
<span class="hljs-operator">...</span> 
<span class="hljs-string">"scripts"</span>: { 
    <span class="hljs-operator">...</span> 
    <span class="hljs-string">"eslint:comment"</span>: <span class="hljs-string">"使用 ESLint 检查并自动修复 src 目录下所有扩展名为 .js 和 .vue 的文件"</span>, 
    <span class="hljs-string">"eslint"</span>: <span class="hljs-string">"eslint --ext .js,.vue --ignore-path .gitignore --fix src"</span>,<span class="hljs-comment">//旧版 </span>
    <span class="hljs-string">"eslint"</span>: <span class="hljs-string">"eslint <span class="hljs-subst">\"</span>src/**/*.{js,ts,vue}<span class="hljs-subst">\"</span> --fix"</span>,<span class="hljs-comment">//新版 } </span>
<span class="hljs-operator">...</span> 
}
</code></pre>
<h6 data-id="heading-6">5.注意</h6>
<p>eslintignore文件已经废除，新版本的gnore写在eslint.config.js中</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d69b47eba3b64d4c942dcb1bfe082d60~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aWU6LeR6Lev5LiK55qETWU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770019438&amp;x-signature=OWJt7QbDDifBxUSzus1X8XCIPuw%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-7">二.安装prettier</h4>
<h6 data-id="heading-8">1.安装</h6>
<p><code>npm i prettier -D</code></p>
<p><code>npm i eslint-config-prettier -D</code></p>
<p><code>cnpm i eslint-plugin-prettier -D</code></p>
<h6 data-id="heading-9">2.创建配置文件： .prettierrc.js</h6>
<pre><code class="hljs language-module.exports" lang="module.exports">// 一行最多 120 字符 
printWidth: 120, 
// 使用 2 个空格缩进
tabWidth: 2, 
// 不使用 tab 缩进，而使用空格 
useTabs: false, 
// 行尾需要有分号 
semi: true, 
// 使用单引号代替双引号 
singleQuote: true,
// 对象的 key 仅在必要时用引号 
quoteProps: 'as-needed', 
// jsx 不使用单引号，而使用双引号 
jsxSingleQuote: false, 
// 末尾使用逗号 
trailingComma: 'all', 
// 大括号内的首尾需要空格{ foo: bar }
bracketSpacing: true, 
// jsx 标签的反尖括号需要换行 
jsxBracketSameLine: false, 
// 箭头函数，只有一个参数的时候，也需要括号 
arrowParens: 'always', 
// 每个文件格式化的范围是文件的全部内容 
rangeStart: 0, 
rangeEnd: Infinity, 
// 不需要写文件开头的 
@prettier requirePragma: false, 
// 不需要自动在文件开头插入 
@prettier insertPragma: false, 
// 使用默认的折行标准 
proseWrap: 'preserve', 
// 根据显示样式决定 html 要不要折行 
htmlWhitespaceSensitivity: 'css', 
// 换行符使用 lf endOfLine: 'auto' 
}
</code></pre>
<h6 data-id="heading-10">3.修改 eslint.config.js 配置，添加prettier</h6>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> prettier <span class="hljs-keyword">from</span> <span class="hljs-string">'eslint-plugin-prettier'</span> 
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> [ 
        ...
        { 
        <span class="hljs-attr">plugins</span>: {
            <span class="hljs-attr">prettier</span>: prettier,
        }, 
        <span class="hljs-attr">rules</span>: { 
            <span class="hljs-string">'prettier/prettier'</span>: <span class="hljs-string">'error'</span>, 
        ... 
        }, 
    }, 
]
</code></pre>
<h6 data-id="heading-11">4.命令行式运行：修改 package.json</h6>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span> 
    ... 
    <span class="hljs-attr">"scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> 
        ... 
        <span class="hljs-attr">"prettier:comment"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"自动格式化当前目录下的所有文件"</span><span class="hljs-punctuation">,</span> 
        <span class="hljs-attr">"prettier"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"prettier --write"</span> 
        <span class="hljs-punctuation">}</span> 
    ... 
<span class="hljs-punctuation">}</span>
</code></pre>
<h6 data-id="heading-12">5.解决eslint和pretter中的冲突</h6>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// eslint.config.js </span>
<span class="hljs-keyword">import</span> prettier <span class="hljs-keyword">from</span> <span class="hljs-string">'eslint-plugin-prettier'</span> 
<span class="hljs-keyword">import</span> prettierConfig <span class="hljs-keyword">from</span><span class="hljs-string">'eslint-config-prettier'</span>; 
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> [ 
    .... 
    <span class="hljs-comment">// 插件的默认推荐配置需要直接包含在配置数组中 </span>
    prettierConfig, 
    { 
        <span class="hljs-attr">plugins</span>: { 
            <span class="hljs-attr">prettier</span>: prettier, <span class="hljs-comment">//解决prettier和eslint的冲突 </span>
        }, 
        <span class="hljs-attr">rules</span>: { 
            <span class="hljs-string">'prettier/prettier'</span>: <span class="hljs-string">'error'</span>, 
            ... 
        }, 
    }, 
]
</code></pre>
<h4 data-id="heading-13">三.创建.vscode文件夹</h4>
<p>在项目的根目录创建文件夹.vscode，再在目录中创建settings.json文件。将如下代码拷其中</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span> 
<span class="hljs-attr">"editor.formatOnSave"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 核心：保存时自动格式化 </span>
<span class="hljs-attr">"editor.quickSuggestions"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span><span class="hljs-comment">// 启用代码提示</span>
<span class="hljs-attr">"eslint.enable"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span> <span class="hljs-comment">//启用 ESLint 插件 </span>
<span class="hljs-comment">//ESLint 应该验证哪些文件类型 </span>
<span class="hljs-attr">"eslint.validate"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-string">"javascript"</span><span class="hljs-punctuation">,</span> 
    <span class="hljs-string">"javascriptreact"</span><span class="hljs-punctuation">,</span> 
    <span class="hljs-string">"vue-html"</span><span class="hljs-punctuation">,</span> 
    <span class="hljs-string">"typescript"</span><span class="hljs-punctuation">,</span> 
    <span class="hljs-string">"html"</span><span class="hljs-punctuation">,</span> 
    <span class="hljs-string">"vue"</span>
 <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span> 
<span class="hljs-attr">"eslint.options"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> 
    <span class="hljs-comment">// 检查这些文件类型</span>
    <span class="hljs-attr">"extensions"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">".js"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">".jsx"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">".ts"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">".tsx"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">".vue"</span><span class="hljs-punctuation">]</span> 
 <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
<span class="hljs-comment">// 可选：保存时先修复代码问题（如ESLint报错）再格式化（前端常用） </span>
<span class="hljs-attr">"editor.codeActionsOnSave"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> 
    <span class="hljs-attr">"source.fixAll"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span>
<span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span> 
<span class="hljs-comment">// 可选：指定默认格式化工具（比如前端优先用Prettier） </span>
<span class="hljs-attr">"editor.defaultFormatter"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"esbenp.prettier-vscode"</span> <span class="hljs-punctuation">,</span>
<span class="hljs-attr">"[vue]"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> 
    <span class="hljs-attr">"editor.defaultFormatter"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"esbenp.prettier-vscode"</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span> 
<span class="hljs-attr">"[typescript]"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> 
    <span class="hljs-attr">"editor.defaultFormatter"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"esbenp.prettier-vscode"</span> 
    <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>

</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[vue3开发容易忽略的地方]]></title>    <link>https://juejin.cn/post/7599474528238174248</link>    <guid>https://juejin.cn/post/7599474528238174248</guid>    <pubDate>2026-01-26T08:06:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599474528238174248" data-draft-id="7596768867231612947" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="vue3开发容易忽略的地方"/> <meta itemprop="keywords" content="Vue.js"/> <meta itemprop="datePublished" content="2026-01-26T08:06:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="努力向上的每一天"/> <meta itemprop="url" content="https://juejin.cn/user/3650034335496478"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            vue3开发容易忽略的地方
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3650034335496478/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    努力向上的每一天
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T08:06:07.000Z" title="Mon Jan 26 2026 08:06:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>工作了很多年，使用vue3也有3年了，但是一直像一个螺丝钉一样复制粘贴，没有学习什么东西，能熟练梳理业务逻辑，但是思路和方法跟用vue2没有什么区别。决定重新刷一遍文档，把没用过的，不太熟悉的地方罗列出来，希望能在开发中多多使用。</p>
<h2 data-id="heading-0">ref在模板中解包</h2>
<ul>
<li>在模板渲染上下文中，只有顶级ref才会被解包.</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> count = <span class="hljs-title function_">ref</span>(<span class="hljs-number">1</span>);
<span class="hljs-keyword">const</span> obj = <span class="hljs-title function_">ref</span>({<span class="hljs-attr">id</span>: <span class="hljs-title function_">ref</span>(<span class="hljs-number">1</span>)}) <span class="hljs-comment">// obj.id 在模板中不能被解包</span>

{{obj.<span class="hljs-property">id</span> + <span class="hljs-number">1</span>}} <span class="hljs-comment">// 输出错误：[object object]1</span>
{{obj.<span class="hljs-property">id</span>}}     <span class="hljs-comment">// 输出正确：1</span>
</code></pre>
<ul>
<li>{{ obj.id }} 与 {{ obj.id.value }}等价，前者是文本插值的便利特性。</li>
</ul>
<h2 data-id="heading-1">reactive</h2>
<p>-不推荐使用 <code>reactive()</code> 的泛型参数，因为处理了深层次 ref 解包的返回值与泛型参数的类型不同。
-对解构操作不友好，我们解构reative时，解构后的变量与原变量失去连接。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 不使用reative泛型参数</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">book</span>:<span class="hljs-title class_">Book</span> = <span class="hljs-title function_">reative</span>({<span class="hljs-attr">name</span>: <span class="hljs-string">'xxx'</span>})

<span class="hljs-keyword">let</span> {count} = reativeDemo;
count++;  <span class="hljs-comment">// 此时，reativeDemo.count不会发生变化。</span>
</code></pre>
<h2 data-id="heading-2">computed</h2>
<ul>
<li>computed属性会基于响应式依赖缓存：一个computed属性只会在他的响应式依赖更新时重新计算。</li>
<li>computed可以获取上一次的值computed((pre) =&gt; {return count.value &gt; 0 ? count.value : pre})</li>
<li>可以重写computed的get和set方法,但是不建议。</li>
</ul>
<h2 data-id="heading-3">v-show/v-if</h2>
<ul>
<li>v-show不支持在template上使用（v-if可以）</li>
<li>v-if有惰性，一开始为false则不会渲染，直到为true才第一次渲染</li>
</ul>
<h2 data-id="heading-4">v-for</h2>
<ul>
<li>循环使用item in item或者item of items一样</li>
<li>(value, key, index) in obj</li>
<li>v-for与v-if不建议同时使用，v-if优先级更高，所以v-if中不能使用item的值</li>
</ul>
<h2 data-id="heading-5">函数ts类型</h2>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-keyword">function</span> handleChange(<span class="hljs-keyword">event</span>: <span class="hljs-keyword">Event</span>) { 
    console.log((<span class="hljs-keyword">event</span>.target <span class="hljs-keyword">as</span> HTMLInputElement).value) 
}
</code></pre>
<h2 data-id="heading-6">watch/watchEffect</h2>
<ul>
<li>deep属性可以为数字，表示监听的深度。</li>
<li>once属性，只监听一次。</li>
<li>watchEffect: 用法类似computed，不需要指定监听对象。在同步执行期间，自动追踪所有能访问到的响应式数据，在异步执行期间，只有在第一个await正常工作之前的响应式数据能被追踪。</li>
<li><code>onWatcherCleanup</code>: 注册一个清理函数，当监听器失效并准备重新运行时调用（eg：在watch中id变化调用接口，接口未返回数据时，id又发生了变化，则需要取消正在进行的接口调用，根据新的id重新发起接口）(3.5+)</li>
<li>watch方法会在dom更新之前调用，如果想在dom更新之后调用则需要增加属性<code>{flush: 'post'}</code>,watch方法在任何更新之前调用，则使用<code>{flush: 'sync}</code>(3.5+)</li>
</ul>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">watch</span>(source, callback, {flush: 'post'})
<span class="hljs-built_in">watchEffect</span>(callback, {flush: 'post'})
<span class="hljs-built_in">watchPostEffect</span>(callback)

<span class="hljs-comment">// 在响应数据变化时同步执行</span>
<span class="hljs-built_in">watch</span>(source, callback, {flush: 'sync'})
<span class="hljs-built_in">watchEffect</span>(callback, {flush: 'sync'})
<span class="hljs-built_in">watchSyncEffect</span>(callback)
</code></pre>
<ul>
<li>中止监听器,定义一个变量接受watch或者watchEffect的返回值</li>
</ul>
<pre><code class="hljs language-scss" lang="scss">const unwatch = <span class="hljs-built_in">watch</span>(source, callback)
<span class="hljs-built_in">unwatch</span>() <span class="hljs-comment">// 中止监听</span>
</code></pre>
<h2 data-id="heading-7">模板引用<code>useTemplateRef</code>(3.5+)</h2>
<ul>
<li>会自动推断ref的数据类型</li>
<li>如果自动推断失败可以自定义类型，使用InstanceType(typeof MyComponent) / HTMLInputElement</li>
</ul>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">inputRef</span> = useTemplateRef(<span class="hljs-string">'my-input'</span>)<span class="hljs-comment">;</span>
inputRef.focus()<span class="hljs-comment">;</span>
</code></pre>
<ul>
<li>v-for上使用ref，则useTemplateRef生成的是一个数组，数组的顺序不一定与源数组顺序相同。</li>
</ul>
<pre><code class="hljs language-ini" lang="ini">&lt;div <span class="hljs-attr">ref</span>=<span class="hljs-string">"itemsRef"</span> v-for=<span class="hljs-string">"item in items"</span> &gt;{{ item }}&lt;/div&gt;

const <span class="hljs-attr">itemsRef</span> = useTemplateRef(<span class="hljs-string">'itemsRef'</span>)
</code></pre>
<h2 data-id="heading-8">props</h2>
<ul>
<li>解构props时，对象数组等不需要在函数中返回。(3.5+)</li>
<li>给props赋值的时候使用definedProps&lt;&gt;()</li>
<li>定义props分编译时和运行时，运行时可以验证一些复杂数据类型以及定义动态数据。编译时可以使用泛型等复杂数据结构，ts中更推荐使用编译时。</li>
<li>给组件传递一个对象的所有属性可以使用v-bind写法</li>
<li>子组件不能修改父组件传递的props，可以重新定义一个变量。</li>
<li>boolean类型的props，为了更贴近原生html，有简介写法。</li>
</ul>
<pre><code class="hljs language-php" lang="php"><span class="hljs-comment">// 解构props时，对象数组等不需要在函数中返回。(3.5+)</span>
<span class="hljs-keyword">const</span> {name: <span class="hljs-string">''</span>, age: <span class="hljs-number">0</span>, hobby: []} = defineProps&lt;{name: <span class="hljs-keyword">string</span>, age: number, hobby: <span class="hljs-keyword">string</span>[]}&gt;();

<span class="hljs-comment">// 3.5以下版本 </span>
<span class="hljs-comment">// withDefaults中设置默认值时，对象数组等需要在函数中返回，确保多个实例时，每个实例都有自己的副本。</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">props</span> = <span class="hljs-title function_ invoke__">widthDefaults</span>(defineProps&lt;{<span class="hljs-attr">name</span>: <span class="hljs-keyword">string</span>, <span class="hljs-attr">age</span>: number, <span class="hljs-attr">hobby</span>: <span class="hljs-keyword">string</span>[]}&gt;(), {
name: <span class="hljs-string">''</span>,
age: <span class="hljs-number">0</span>,
hobby: () =&gt; []
})

<span class="hljs-comment">// 运行时</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">props</span> = <span class="hljs-title function_ invoke__">defineProps</span>({
<span class="hljs-attr">name</span>: {
    <span class="hljs-attr">type</span>: String,
    <span class="hljs-attr">default</span>: <span class="hljs-string">''</span>,
    <span class="hljs-attr">validate</span>: (val) =&gt; {...}
}
})

<span class="hljs-comment">// 编译时</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">defineProps</span>&lt;{name: <span class="hljs-keyword">string</span>, age: number, hobby: <span class="hljs-keyword">string</span>[]}&gt;

<span class="hljs-comment">// boolean类型的props</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">props</span> = <span class="hljs-title function_ invoke__">defineProps</span>({<span class="hljs-attr">disabled</span>: Boolean})
&lt;myComponent disabled /&gt; <span class="hljs-comment">// 相当于 :disabled="true",不写默认为false</span>
</code></pre>
<h2 data-id="heading-9">emit</h2>
<ul>
<li>可以带校验，校验通过再emit，否则不emit</li>
<li>更简洁的定义语法(3.3+)</li>
</ul>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 校验</span>
<span class="hljs-keyword">const</span> emits = <span class="hljs-title function_">defineEmits</span>({
    <span class="hljs-attr">submit</span>: <span class="hljs-function">(<span class="hljs-params">name: <span class="hljs-built_in">string</span>, id: <span class="hljs-built_in">number</span></span>) =&gt;</span> {
        <span class="hljs-keyword">if</span> (name &amp;&amp; id) { <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span> }
        <span class="hljs-keyword">else</span> { <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;}
    }
})


<span class="hljs-keyword">const</span> emits = defineEmits&lt;{
    <span class="hljs-attr">update</span>: [<span class="hljs-attr">id</span>: <span class="hljs-built_in">number</span>],
    <span class="hljs-attr">success</span>: [],
}&gt;()

<span class="hljs-comment">// v-bind</span>
<span class="hljs-keyword">const</span> post = {<span class="hljs-attr">name</span>: <span class="hljs-string">''</span>, <span class="hljs-attr">id</span>: <span class="hljs-number">0</span>}
&lt;myComponent v-bind=<span class="hljs-string">"post"</span> /&gt;
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">myComponent</span> <span class="hljs-attr">:id</span>=<span class="hljs-string">"post.id"</span> <span class="hljs-attr">:name</span>=<span class="hljs-string">"post.name"</span> /&gt;</span></span>
</code></pre>
<h2 data-id="heading-10">defineModel</h2>
<ul>
<li>定义了一个名为modelValue的prop，本地的ref与其同步</li>
<li>定义了一个update:modelValue方法，本地ref变化时触发(.set方法中实现)</li>
</ul>
<pre><code class="hljs language-php" lang="php"><span class="hljs-comment">// 第一个参数不写默认与ref名相同</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">modelValue</span> = <span class="hljs-title function_ invoke__">defineModel</span>(<span class="hljs-string">'value'</span>, {<span class="hljs-attr">require</span>: <span class="hljs-literal">true</span>， <span class="hljs-keyword">default</span>：<span class="hljs-number">0</span>})
</code></pre>
<h2 data-id="heading-11">attribute透传</h2>
<ul>
<li>组件接收的所有未在props中声明的属性会透传</li>
<li><code>多根节点</code>默认不会透传，除非显示透传,使用$attrs</li>
<li>可以通过vue提供的方法获取所有透传的attrs，attrs<code>不是响应式</code>的，需要响应式的需要props定义。</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { useAttrs } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">const</span> attrs = <span class="hljs-title function_">useAttrs</span>();
</code></pre>
<ul>
<li>想要父组件的属性透传给自己的子组件可以使用$attrs, <code>attrs</code>对象包含了除组件所声明的 <code>props</code> 和 <code>emits</code> 之外的所有其他 attribute，例如 <code>class</code>，<code>style</code>，<code>v-on</code> 监听器等等。</li>
<li>想要不透传，或者不接受透传可以设置</li>
</ul>
<pre><code class="hljs language-php" lang="php">&lt;childComponent v-bind=<span class="hljs-string">"<span class="hljs-subst">$attrs</span>"</span>&gt;

<span class="hljs-comment">// 不透传设置</span>
&lt;scripte setup&gt;
<span class="hljs-title function_ invoke__">defineOptions</span>({
    <span class="hljs-attr">inheritAttrs</span>: <span class="hljs-literal">false</span>
})
&lt;/script&gt;
</code></pre>
<h2 data-id="heading-12">slot</h2>
<ul>
<li>组件插槽可以传递参数，参数名不能为name，name为插槽名。</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Child</span>
&lt;div <span class="hljs-keyword">class</span>=<span class="hljs-string">"card"</span>&gt;
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">slot</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"cardContent"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"cardInfo"</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
<span class="hljs-comment">// Parent</span>
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span> #<span class="hljs-attr">cardContent</span>=<span class="hljs-string">"cardInfo"</span>&gt;</span>
    {{cardInfo}}
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span></span>
</code></pre>
<h2 data-id="heading-13">依赖注入</h2>
<ul>
<li>可以inject一个ref的响应式数据，数据变化会同步。在子孙组件修改会同步父组件，在父组件修改会同步到子组件。但是建议所有的更改都在父组件中执行，可以通过传递一个update方法给子孙组件更新。</li>
</ul>
<pre><code class="hljs language-csharp" lang="csharp">import { <span class="hljs-keyword">readonly</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-comment">// 父组件</span>
<span class="hljs-keyword">const</span> location = <span class="hljs-keyword">ref</span>(<span class="hljs-string">''</span>);
<span class="hljs-function">function <span class="hljs-title">updateLocation</span>()</span> {
    location.<span class="hljs-keyword">value</span> = <span class="hljs-string">"ww"</span>
}
privide(<span class="hljs-string">'location'</span>, {
    location,
    updateLocation,
})

<span class="hljs-comment">// 子孙组件</span>
<span class="hljs-keyword">const</span> {location, updateLocation} = inject(<span class="hljs-string">'location'</span>)
</code></pre>
<ul>
<li>不想被子孙组件更改的数据使用readonly方法包裹</li>
</ul>
<pre><code class="hljs language-bash" lang="bash">privide(<span class="hljs-string">'readonlyLocation'</span>, <span class="hljs-built_in">readonly</span>(location))
</code></pre>
<ul>
<li>vue推荐当依赖注入较多时或写公用组件，使用Symbol防止重名，将所有Symbol定义的key放到一个文件中</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// key.js</span>
<span class="hljs-keyword">const</span> locationkey  = <span class="hljs-title class_">Symbol</span>();
<span class="hljs-comment">// parent</span>
<span class="hljs-keyword">import</span> { locationkey } <span class="hljs-keyword">from</span> <span class="hljs-string">'./key.js'</span>
<span class="hljs-title function_">privide</span>(locationKey, {...})
<span class="hljs-comment">// child</span>
<span class="hljs-keyword">import</span> { locationkey } <span class="hljs-keyword">from</span> <span class="hljs-string">'./key.js'</span>
<span class="hljs-keyword">const</span> location = <span class="hljs-title function_">inject</span>(locationkey);
</code></pre>
<h2 data-id="heading-14">组合式函数</h2>
<ul>
<li>方法中使用了vue的组合式API（如ref，watch等）来封装和复用的<code>有状态</code>逻辑的函数。</li>
<li>约定
<ul>
<li>通常使用useXxx命名</li>
<li>返回的数据一般都为ref,这样在组件中被解构后仍为响应式数据。</li>
</ul>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">x</span> = ref(<span class="hljs-number">1</span>)<span class="hljs-comment">;</span>
const <span class="hljs-attr">y</span> = ref(<span class="hljs-number">2</span>)<span class="hljs-comment">;</span>
return {
    x, y
}
</code></pre>
</li>
<li>在不同组件中使用useXxx都会重新创建新的数据，各个数据互不影响。</li>
</ul>
<h2 data-id="heading-15">自定义指令</h2>
<ul>
<li>由一个包含类似组件生命周期钩子的对象来定义。在ts setup中，v开头的方法都可以直接作为指令使用</li>
<li>指令不建议在组件上使用，组件可能有多个子组件，指令不会通过$attrs透传。</li>
</ul>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">const</span> vHighlight = {
    <span class="hljs-attr">mounted</span>: <span class="hljs-function">(<span class="hljs-params">el</span>) =&gt;</span> {
        el.<span class="hljs-property">classList</span>.<span class="hljs-title function_">add</span>(<span class="hljs-string">'high-light'</span>)
    }
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-highlight</span>&gt;</span>aaaaaaaa<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
</code></pre>
<h2 data-id="heading-16">vue官方推荐</h2>
<ul>
<li>使用<code>vscode</code>编辑器</li>
<li><code>vue official</code>：vscode插件，提供实时语言服务</li>
<li>浏览器开发者插件：<code>Vue DevTools</code></li>
<li><code>vue-tsc</code>: 在编译阶段进行类型检查。</li>
<li>代码规范：在项目中安装<code>eslint-plugin-vue</code>; 在IDE中装ESlint插件；在项目中装lint-staged代码提交规范</li>
<li>格式化：<code>prettier</code>，IDE中安装插件，项目中安装prettier，写代码格式化时IDE中的prettier会优先找项目中的prettier配置进行格式化，如果项目中没有则会使用IDE自己的配置。</li>
<li><code>@vitejs/plugin-vue</code>：为 Vite 提供 Vue 单文件组件支持的官方插件。</li>
</ul>
<h2 data-id="heading-17">状态管理</h2>
<ul>
<li>用响应式API（ref，reative, watch等）做状态管理。</li>
<li>定义一个store文件，将多个组件需要公用的数据放进去，在组件中引用</li>
<li>复杂的使用<code>pinia</code></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>