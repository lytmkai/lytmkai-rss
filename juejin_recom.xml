<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[大宗供应链企业舆情指标系统设计（一）舆情指标设计]]></title>    <link>https://juejin.cn/post/7577958825342320659</link>    <guid>https://juejin.cn/post/7577958825342320659</guid>    <pubDate>2025-11-30T10:03:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577958825342320659" data-draft-id="7577905525997764649" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="大宗供应链企业舆情指标系统设计（一）舆情指标设计"/> <meta itemprop="keywords" content="数据分析"/> <meta itemprop="datePublished" content="2025-11-30T10:03:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="语落心生"/> <meta itemprop="url" content="https://juejin.cn/user/2875978147955741"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            大宗供应链企业舆情指标系统设计（一）舆情指标设计
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2875978147955741/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    语落心生
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T10:03:34.000Z" title="Sun Nov 30 2025 10:03:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    16
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>最近自己个人业务有个客户一个大宗供应量销量预测与智能预测的需求。但是大宗供应链的场景，多半就是跟地缘政治因素强关联的，调研几个月，记录一下自己的思考</p>
<hr/>
<h2 data-id="heading-0">目录</h2>
<ol>
<li><a href="#%E9%A1%B9%E7%9B%AE%E6%A6%82%E8%BF%B0" title="#%E9%A1%B9%E7%9B%AE%E6%A6%82%E8%BF%B0">项目概述</a></li>
<li><a href="#%E8%88%86%E6%83%85%E6%8C%87%E6%A0%87%E4%BD%93%E7%B3%BB" title="#%E8%88%86%E6%83%85%E6%8C%87%E6%A0%87%E4%BD%93%E7%B3%BB">舆情指标体系</a></li>
<li><a href="#%E6%8A%80%E6%9C%AF%E6%9E%B6%E6%9E%84" title="#%E6%8A%80%E6%9C%AF%E6%9E%B6%E6%9E%84">技术架构</a></li>
<li><a href="#%E6%95%B0%E6%8D%AE%E6%A8%A1%E5%9E%8B" title="#%E6%95%B0%E6%8D%AE%E6%A8%A1%E5%9E%8B">数据模型</a></li>
<li><a href="#%E5%AE%9E%E6%97%B6%E7%AE%A1%E9%81%93" title="#%E5%AE%9E%E6%97%B6%E7%AE%A1%E9%81%93">实时管道</a></li>
<li><a href="#%E6%8C%87%E6%A0%87%E8%AE%A1%E7%AE%97" title="#%E6%8C%87%E6%A0%87%E8%AE%A1%E7%AE%97">指标计算</a></li>
</ol>
<hr/>
<h2 data-id="heading-1">项目概述</h2>
<h3 data-id="heading-2">1.1 大宗商品企业的舆情风险</h3>
<p>大宗商品供应链企业（钢铁、石油、粮食、矿产）面临四类核心风险：</p>



































<table><thead><tr><th>风险维度</th><th>具体表现</th><th>影响度量</th><th>舆情指标</th></tr></thead><tbody><tr><td><strong>A.物理物流中断</strong></td><td>港口罢工、海峡阻塞、基础设施损坏</td><td>延迟天数</td><td>物流延迟指数(LDI)</td></tr><tr><td><strong>B.监管贸易限制</strong></td><td>出口禁令、制裁、关税变化</td><td>合规成本</td><td>合规风险指数(CRI)</td></tr><tr><td><strong>C.政治安全不稳定</strong></td><td>内战冲突、恐怖活动、政权更迭</td><td>保险费上升</td><td>地缘政治指数(GRI)</td></tr><tr><td><strong>D.经济金融冲击</strong></td><td>货币崩溃、主权违约、支付中断</td><td>交易对手风险</td><td>金融风险指数(FRI)</td></tr></tbody></table>
<p><strong>舆情指标系统的核心价值</strong>：</p>
<ul>
<li>非结构化新闻→定量决策指标 (&lt;5分钟延迟)</li>
<li>按地理位置+商品种类的采购商特定风险评估</li>
<li>交易、物流、金融对冲的量化决策支持</li>
</ul>
<h3 data-id="heading-3">1.2 系统设计目标</h3>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">实时性: 事件→摄取→NLP→指标 &lt;5分钟</span>
<span class="hljs-section">准确性: NLP分类&gt;95%, 指标相关性&gt;0.8</span>
<span class="hljs-section">覆盖: 150+采购商, 200+新闻源, 4类商品</span>
<span class="hljs-section">可操作: 直接输入贸易/物流/金融系统</span>
</code></pre>
<hr/>
<h2 data-id="heading-4">舆情指标体系</h2>
<h3 data-id="heading-5">2.1 四层舆情指标框架</h3>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">第1层: 基础采样指标</span>
├─ 事件频率 (events/day)
├─ 新闻热度 (7day_volume)
├─ 网络舆论倾向 (sentiment)
└─ NLP置信度 (confidence)

<span class="hljs-section">第2层: 维度风险指标 (A/B/C/D四维)</span>
├─ LDI: 物流延迟风险 (0-10)
├─ CRI: 合规监管风险 (0-10)
├─ GRI: 地缘政治风险 (0-10)
└─ FRI: 金融支付风险 (0-10)

<span class="hljs-section">第3层: 综合舆情指标</span>
├─ 综合风险指数 (0-100)
├─ 采购商特定风险 (考虑货运量+商品敏感性)
└─ 舆情vs实际风险相关度 (-1~1)

<span class="hljs-section">第4层: 战略决策支持</span>
├─ 预警等级 (Green/Yellow/Orange/Red)
├─ 建议应急措施
├─ 对冲对象
└─ 物流替代方案评分
</code></pre>
<h3 data-id="heading-6">2.2 维度指标具体定义</h3>
<h4 data-id="heading-7">LDI: 物流延迟风险指数</h4>
<pre><code class="hljs language-erlang" lang="erlang">公式: LDI = Σ(severity × location_proximity × commodity_multiplier)

<span class="hljs-function"><span class="hljs-title">severity_score</span> <span class="hljs-params">(港口罢工:<span class="hljs-number">6</span>-<span class="hljs-number">8</span>, 海峡阻塞:<span class="hljs-number">8</span>-<span class="hljs-number">9</span>, 铁路破坏:<span class="hljs-number">4</span>-<span class="hljs-number">6</span>, 空域关闭:<span class="hljs-number">3</span>-<span class="hljs-number">5</span>)</span>
<span class="hljs-title">location_proximity</span> <span class="hljs-params">(距离衰减: &lt;<span class="hljs-number">500</span>km→<span class="hljs-number">1.0</span>, <span class="hljs-number">500</span>-<span class="hljs-number">2000</span>km→<span class="hljs-number">0.8</span>, &gt;<span class="hljs-number">5000</span>km→<span class="hljs-number">0.2</span>)</span>
<span class="hljs-title">commodity_multiplier</span> <span class="hljs-params">(易腐农产品:<span class="hljs-number">1.5</span>, 冷链:<span class="hljs-number">2.0</span>, 金属矿产:<span class="hljs-number">0.5</span>)</span>

示例: 上海采购商采购大豆, 巴拿马运河关闭
  LDI = <span class="hljs-params">(<span class="hljs-number">8</span>严重度 × <span class="hljs-number">0.8</span>距离系数 × <span class="hljs-number">1.5</span>易腐性)</span> = 9.6/10 <span class="hljs-params">(红色告警)</span>
</span></code></pre>
<h4 data-id="heading-8">CRI: 合规监管风险指数</h4>
<pre><code class="hljs language-ini" lang="ini">公式: <span class="hljs-attr">CRI</span> = Σ(impact_severity × enforcement_probability × exposure_ratio)

impact_severity (新增制裁:9-10, 出口禁令:7-8, 关税&gt;15%:5-6, 关税5-15%:2-3)
enforcement_probability (立即:1.0, 30天:0.8, 90天:0.5, 讨论:0.2)
exposure_ratio (该地区采购额 / 总采购额)

示例: 俄罗斯铁矿石禁令, 采购商A占15%
  CRI增量 = 8 × 0.8 × <span class="hljs-attr">0.15</span> = <span class="hljs-number">0.96</span>分
</code></pre>
<h4 data-id="heading-9">GRI: 地缘政治风险指数</h4>
<pre><code class="hljs language-erlang" lang="erlang">公式: GRI = (severity × conflict_intensity × duration_decay) / redundancy × 操作乘数

<span class="hljs-function"><span class="hljs-title">event_severity</span> <span class="hljs-params">(全面战争:<span class="hljs-number">9</span>-<span class="hljs-number">10</span>, 区域冲突:<span class="hljs-number">7</span>-<span class="hljs-number">8</span>, 大规模抗议:<span class="hljs-number">5</span>-<span class="hljs-number">6</span>)</span>
<span class="hljs-title">conflict_intensity</span> <span class="hljs-params">(ACLED数据: 死亡人数/事件频率)</span>
<span class="hljs-title">duration_decay</span> <span class="hljs-params">(刚发生:<span class="hljs-number">1.0</span>, <span class="hljs-number">1</span>-<span class="hljs-number">7</span>天:<span class="hljs-number">0.9</span>, <span class="hljs-number">1</span>-<span class="hljs-number">4</span>周:<span class="hljs-number">0.7</span>, <span class="hljs-number">1</span>-<span class="hljs-number">3</span>月:<span class="hljs-number">0.5</span>, &gt;<span class="hljs-number">3</span>月:<span class="hljs-number">0.3</span>)</span>
<span class="hljs-title">infrastructure_redundancy</span> <span class="hljs-params">(无替代:<span class="hljs-number">1.0</span>, <span class="hljs-number">1</span>条:<span class="hljs-number">0.7</span>, <span class="hljs-number">2</span>+条:<span class="hljs-number">0.4</span>)</span>
操作乘数 <span class="hljs-params">(劳动力撤出:<span class="hljs-number">1.5</span>, 保险费上升:<span class="hljs-number">1.3</span>, 工人安全:<span class="hljs-number">1.2</span>)</span>
</span></code></pre>
<h4 data-id="heading-10">FRI: 金融支付风险指数</h4>
<pre><code class="hljs language-ini" lang="ini">公式: <span class="hljs-attr">FRI</span> = Σ(financial_severity × counterparty_exposure × forward_duration)

financial_severity (SWIFT除名:9-10, 主权违约:8-9, 货币贬值&gt;30%:7-8)
counterparty_exposure (该国交易额占比)
forward_duration (待结算&lt;7天:1.0, 预期交易7-30天:0.8, 期货30-90天:0.6)

示例: 阿根廷比索危机, 采购商敞口12%, 待结算30天
  FRI增量 = 8 × 0.12 × <span class="hljs-attr">0.8</span> = <span class="hljs-number">0.77</span>分
</code></pre>
<h3 data-id="heading-11">2.3 综合舆情指标</h3>
<pre><code class="hljs language-ini" lang="ini">综合风险指数 (CRI_Composite):
  = 40% × (LDI + CRI)/2 + 60% × (GRI + FRI)/<span class="hljs-attr">2</span>
  = 40% × 物流合规风险 + 60% × 地缘金融风险
  范围: 0-100

采购商特定风险 (Buyer_Specific):
  = 综合风险指数 × 货运量权重 × 商品敏感性乘数
  
  商品敏感性:
  ├─ 农产品(谷物): 1.5 (高敏感)
  ├─ 石油: 1.3 (中高敏感)
  ├─ 金属矿产: 0.7 (低敏感)
  └─ 煤炭: 0.9 (中敏感)

预警等级:
  Green (0-25):   无实质风险, 常规监测
  Yellow (25-50): 中等风险, 激活预案
  Orange (50-75): 高风险, 立即采取措施
  Red (75-100):   极危状态, 启动危机管理
</code></pre>
<hr/>
<h2 data-id="heading-12">技术架构</h2>
<h3 data-id="heading-13">3.1 整体数据流</h3>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">多源数据</span> <span class="hljs-string">→</span> <span class="hljs-string">Kafka</span> <span class="hljs-string">→</span> <span class="hljs-string">Flink</span> <span class="hljs-string">ETL</span> <span class="hljs-string">→</span> <span class="hljs-string">Paimon</span> <span class="hljs-string">(湖)</span> <span class="hljs-string">→</span> <span class="hljs-string">Doris</span> <span class="hljs-string">(分析)</span> <span class="hljs-string">→</span> <span class="hljs-string">应用</span>
  <span class="hljs-string">├─</span> <span class="hljs-string">新闻源</span>
  <span class="hljs-string">├─</span> <span class="hljs-string">地缘政治数据</span>
  <span class="hljs-string">├─</span> <span class="hljs-string">制裁名单</span>
  <span class="hljs-string">├─</span> <span class="hljs-string">商品期货</span>
  <span class="hljs-string">├─</span> <span class="hljs-string">港口状态</span>
  <span class="hljs-string">└─</span> <span class="hljs-string">金融数据</span>

<span class="hljs-string">关键特点:</span>
<span class="hljs-string">├─</span> <span class="hljs-attr">Paimon:</span> <span class="hljs-string">原始数据+标准化数据存储,</span> <span class="hljs-string">支持版本控制、时间旅行</span>
<span class="hljs-string">├─</span> <span class="hljs-attr">Doris:</span> <span class="hljs-string">实时OLAP分析,</span> <span class="hljs-string">秒级查询,</span> <span class="hljs-string">支持高并发</span>
<span class="hljs-string">└─</span> <span class="hljs-attr">Flink:</span> <span class="hljs-string">实时流处理,</span> <span class="hljs-string">NLP分类,</span> <span class="hljs-string">指标计算</span>
</code></pre>
<h3 data-id="heading-14">3.2 为何选择Paimon</h3>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> 湖表一体:
   ├─ 原始数据保留在数据湖 (HDFS/S3)
   ├─ 实时指标在表结构中维护
   └─ 降低数据重复存储成本

<span class="hljs-bullet">2.</span> 时间旅行与版本控制:
   ├─ 查询历史快照 ("昨天下午2点的指标?")
   ├─ 完整审计日志 (舆情变化追溯)
   └─ 风险回溯分析不可或缺

<span class="hljs-bullet">3.</span> 高效增量更新:
   ├─ Flink直接流式写入
   ├─ Merge操作 (重复事件去重)
   └─ 避免全量重新计算

<span class="hljs-bullet">4.</span> ACID事务:
   ├─ 舆情指标一致性保证
   ├─ 多维度并发更新无脏数据
   └─ 金融级别的准确性要求

Paimon表设计:
├─ mgir<span class="hljs-emphasis">_events_</span>raw: 原始事件 (90天保留)
├─ mgir<span class="hljs-emphasis">_events_</span>standardized: NLP后标准化事件
└─ mgir<span class="hljs-emphasis">_dimension_</span>scores: 维度指标增量表
</code></pre>
<h3 data-id="heading-15">3.3 为何选择Doris</h3>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> 实时分析性能:
   ├─ 向量化执行+Pipeline模型
   ├─ 查询P95 &lt;1秒 (百亿行数据)
   ├─ 支持1000+并发查询
   └─ BI仪表板实时刷新

<span class="hljs-bullet">2.</span> 多维聚合能力:
   ├─ Rollup和物化视图预计算
   ├─ 按(采购商, 商品, 小时)粒度聚合
   ├─ BI直接读取预聚合结果
   └─ 特别适合舆情指标多维钻取

<span class="hljs-bullet">3.</span> 数据新鲜度:
   ├─ Paimon数据实时导入 (5分钟)
   ├─ 准实时分析能力
   └─ 舆情指标时效性保证

<span class="hljs-bullet">4.</span> 低成本存储:
   ├─ 列式压缩率高 (8-10倍)
   ├─ 相比关系数据库成本 1/10
   └─ 承载2年+历史数据

Doris表设计:
├─ mgir<span class="hljs-emphasis">_indices_</span>fact: 实时指标事实表
├─ mgir<span class="hljs-emphasis">_indices_</span>hourly<span class="hljs-emphasis">_agg: 小时聚合表 (Rollup)
├─ buyer_</span>dimension: 采购商维度表
└─ commodity<span class="hljs-emphasis">_dimension: 商品维度表
</span></code></pre>
<hr/>
<h2 data-id="heading-16">数据模型</h2>
<h3 data-id="heading-17">4.1 Paimon原始事件表</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- mgir_events_raw_paimon</span>
<span class="hljs-comment">-- 存储所有摄取的原始新闻/事件 (未处理)</span>
<span class="hljs-comment">-- 分片: (risk_date, buyer_geo_key) hash</span>
<span class="hljs-comment">-- TTL: 90天 (用于模型再训练)</span>

字段:
├─ event_id (UUID, PK)
├─ ingest_timestamp (<span class="hljs-type">TIMESTAMP</span>)
├─ risk_date (<span class="hljs-type">DATE</span>)
├─ source_type (STRING: news<span class="hljs-operator">/</span>api<span class="hljs-operator">/</span>...)
├─ source_name (STRING)
├─ source_url (STRING)
├─ raw_text (TEXT)
├─ <span class="hljs-keyword">language</span> (STRING)
├─ detected_geo_keys (<span class="hljs-keyword">ARRAY</span><span class="hljs-operator">&lt;</span>STRING<span class="hljs-operator">&gt;</span>)
├─ keywords (<span class="hljs-keyword">ARRAY</span><span class="hljs-operator">&lt;</span>STRING<span class="hljs-operator">&gt;</span>)
├─ nlp_processing_flag (<span class="hljs-type">BOOLEAN</span>)
├─ processing_version (<span class="hljs-type">INT</span>)
└─ confidence_raw (<span class="hljs-type">FLOAT</span>)

特性:
├─ 版本控制: 支持时间旅行查询
├─ ACID: 数据一致性保证
└─ 保留期: <span class="hljs-number">90</span>天
</code></pre>
<h3 data-id="heading-18">4.2 Paimon标准化事件表</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- mgir_events_standardized_paimon</span>
<span class="hljs-comment">-- 存储NLP处理后的标准化事件</span>
<span class="hljs-comment">-- 支持Merge操作 (去重)</span>

关键字段:
├─ event_id (UUID, PK)
├─ raw_event_id (UUID)
├─ risk_date (<span class="hljs-type">DATE</span>)
├─ delivery_impact_dim (ENUM: A<span class="hljs-operator">/</span>B<span class="hljs-operator">/</span>C<span class="hljs-operator">/</span>D)
├─ severity_subcategory (STRING)
├─ impact_severity_score (<span class="hljs-type">FLOAT</span>: <span class="hljs-number">0</span><span class="hljs-number">-10</span>)
├─ sentiment_score_nlp (<span class="hljs-type">FLOAT</span>: <span class="hljs-number">-1</span><span class="hljs-operator">~</span><span class="hljs-number">1</span>)
├─ confidence_score_nlp (<span class="hljs-type">FLOAT</span>: <span class="hljs-number">0</span><span class="hljs-number">-1</span>)
├─ primary_buyer_geo_key (STRING)
├─ affected_buyer_geo_keys (<span class="hljs-keyword">ARRAY</span><span class="hljs-operator">&lt;</span>STRING<span class="hljs-operator">&gt;</span>)
├─ commodity_type (STRING)
├─ geographic_locations (<span class="hljs-keyword">ARRAY</span><span class="hljs-operator">&lt;</span>STRUCT<span class="hljs-operator">&gt;</span>)
│  ├─ location_name, latitude, longitude
│  ├─ gis_type, relevance_score
├─ extracted_entities (<span class="hljs-keyword">ARRAY</span><span class="hljs-operator">&lt;</span>STRUCT<span class="hljs-operator">&gt;</span>)
│  ├─ entity_name, entity_type, confidence
├─ nlp_model_version (STRING)
├─ processing_timestamp (<span class="hljs-type">TIMESTAMP</span>)
└─ update_version (<span class="hljs-type">INT</span>)

特性:
├─ 去重: <span class="hljs-keyword">Merge</span>按event_id, 保留最新版本
├─ ACID事务: 保证一致性
└─ 主键约束: event_id
</code></pre>
<h3 data-id="heading-19">4.3 Doris实时指标事实表</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- mgir_indices_fact_doris</span>
<span class="hljs-comment">-- 存储计算后的实时舆情指标</span>
<span class="hljs-comment">-- 分区: risk_date | Bucket: 32 (按buyer_geo_key hash)</span>

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> mgir_indices_fact_doris (
  event_id UUID <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  ingest_timestamp DATETIME <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  risk_date <span class="hljs-type">DATE</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  buyer_geo_key <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  commodity_type <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  delivery_impact_dim <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">10</span>),
  impact_severity_score <span class="hljs-type">FLOAT</span>,
  sentiment_score_nlp <span class="hljs-type">FLOAT</span>,
  confidence_score_nlp <span class="hljs-type">FLOAT</span>,
  ldi_score <span class="hljs-type">FLOAT</span>,          <span class="hljs-comment">-- 物流延迟指标</span>
  cri_score <span class="hljs-type">FLOAT</span>,          <span class="hljs-comment">-- 合规风险指标</span>
  gri_score <span class="hljs-type">FLOAT</span>,          <span class="hljs-comment">-- 地缘政治指标</span>
  fri_score <span class="hljs-type">FLOAT</span>,          <span class="hljs-comment">-- 金融风险指标</span>
  composite_risk_index <span class="hljs-type">FLOAT</span>,       <span class="hljs-comment">-- 综合风险 (0-100)</span>
  buyer_specific_risk_score <span class="hljs-type">FLOAT</span>,  <span class="hljs-comment">-- 采购商特定风险</span>
  sentiment_vs_risk_corr <span class="hljs-type">FLOAT</span>,     <span class="hljs-comment">-- 舆情vs风险相关度</span>
  risk_alert_level <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">10</span>),     <span class="hljs-comment">-- Green/Yellow/Orange/Red</span>
  source_url <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">500</span>),
  location_latitude <span class="hljs-keyword">DOUBLE</span>,
  location_longitude <span class="hljs-keyword">DOUBLE</span>,
  location_distance_to_buyer <span class="hljs-type">FLOAT</span>,
  forecast_impact_duration <span class="hljs-type">INT</span>
)
ENGINE <span class="hljs-operator">=</span> OLAP
DUPLICATE KEY (event_id)
<span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">RANGE</span> (risk_date) ()
DISTRIBUTED <span class="hljs-keyword">BY</span> HASH(buyer_geo_key) BUCKETS <span class="hljs-number">32</span>
PROPERTIES ("replication_num" <span class="hljs-operator">=</span> "3");

索引:
├─ <span class="hljs-keyword">PRIMARY</span> KEY: event_id
├─ INDEX: (buyer_geo_key, risk_date)
├─ INDEX: (composite_risk_index)
└─ BLOOM <span class="hljs-keyword">FILTER</span>: (buyer_geo_key, commodity_type)
</code></pre>
<h3 data-id="heading-20">4.4 Doris维度表</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- buyer_dimension_doris (采购商维度)</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> buyer_dimension_doris (
  buyer_geo_key <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">PRIMARY</span> KEY,
  buyer_name <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">200</span>),
  country_code <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">10</span>),
  region_code <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">50</span>),
  latitude <span class="hljs-keyword">DOUBLE</span>,
  longitude <span class="hljs-keyword">DOUBLE</span>,
  annual_volume_usd <span class="hljs-type">BIGINT</span>,
  main_commodities <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">500</span>),
  supply_chain_complexity <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">50</span>),
  alternative_suppliers_cnt <span class="hljs-type">INT</span>,
  risk_appetite <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">50</span>),
  contact_email <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">100</span>),
  risk_manager_name <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">100</span>),
  last_updated DATETIME
)
ENGINE <span class="hljs-operator">=</span> OLAP
DISTRIBUTED <span class="hljs-keyword">BY</span> HASH(buyer_geo_key);

<span class="hljs-comment">-- commodity_dimension_doris (商品维度)</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> commodity_dimension_doris (
  commodity_code <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">PRIMARY</span> KEY,
  commodity_name <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">200</span>),
  commodity_category <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">50</span>),
  perishability_multiplier <span class="hljs-type">FLOAT</span>,    <span class="hljs-comment">-- 0.5-2.0</span>
  storage_cost_per_day_usd <span class="hljs-type">FLOAT</span>,
  typical_transport_duration <span class="hljs-type">INT</span>,
  price_volatility_yearly <span class="hljs-type">FLOAT</span>,
  ldi_base_weight <span class="hljs-type">FLOAT</span>,
  cri_base_weight <span class="hljs-type">FLOAT</span>,
  gri_base_weight <span class="hljs-type">FLOAT</span>,
  fri_base_weight <span class="hljs-type">FLOAT</span>,
  last_updated DATETIME
)
ENGINE <span class="hljs-operator">=</span> OLAP
DISTRIBUTED <span class="hljs-keyword">BY</span> HASH(commodity_code);
</code></pre>
<hr/>
<h2 data-id="heading-21">实时管道</h2>
<h3 data-id="heading-22">5.1 数据源摄取</h3>
<pre><code class="hljs language-markdown" lang="markdown">数据源分类:

<span class="hljs-bullet">1.</span> 新闻与舆情源 (文本)
   ├─ 路透社、彭博社、CNBC、WSJ
   ├─ 区域主流新闻网站
   ├─ Twitter/X舆论情感
   └─ 频率: 实时/5分钟

<span class="hljs-bullet">2.</span> 地缘政治数据 (结构化)
   ├─ ACLED (冲突事件)
   ├─ ICG (危机分析报告)
   ├─ 官方声明 (国务院/外交部)
   └─ 频率: 每天/每周

<span class="hljs-bullet">3.</span> 制裁与监管 (结构化)
   ├─ OFAC制裁名单 (美国财政部)
   ├─ EU制裁名单 (欧盟理事会)
   ├─ 进出口禁令
   └─ 频率: 实时/每天更新

<span class="hljs-bullet">4.</span> 商品市场 (高频结构化)
   ├─ CME期货、LME金属、现货价格
   ├─ 交易所API
   └─ 频率: 秒级更新

<span class="hljs-bullet">5.</span> 港口与物流 (实时)
   ├─ 港口状态、船舶AIS、海峡通过
   └─ 频率: 实时/10分钟

<span class="hljs-bullet">6.</span> 金融与汇率 (高频)
   ├─ 外汇、国债收益率、CDS价差
   └─ 频率: 秒-分钟级

Kafka主题设计:
├─ raw<span class="hljs-emphasis">_news_</span>events: 原始新闻 (32分区, 7天保留)
├─ geopolitical<span class="hljs-emphasis">_conflict_</span>events: 冲突数据 (8分区, 30天)
├─ sanctions<span class="hljs-emphasis">_and_</span>regulations: 制裁更新 (4分区, 90天)
├─ commodity<span class="hljs-emphasis">_prices_</span>stream: 商品价格 (16分区, 3天)
├─ port<span class="hljs-emphasis">_logistics_</span>status: 港口状态 (8分区, 7天)
└─ financial<span class="hljs-emphasis">_indicators: 金融指标 (16分区, 1天)
</span></code></pre>
<h3 data-id="heading-23">5.2 Flink流处理任务</h3>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">Flink任务拓扑:</span>

<span class="hljs-attr">Source:</span> <span class="hljs-string">Kafka</span> <span class="hljs-number">6</span><span class="hljs-string">个Topic消费</span>
  <span class="hljs-string">↓</span>
[<span class="hljs-string">数据清洗与标准化</span>]
  <span class="hljs-string">├─</span> <span class="hljs-string">格式转换</span> <span class="hljs-string">(JSON/XML</span> <span class="hljs-string">→</span> <span class="hljs-string">Struct)</span>
  <span class="hljs-string">├─</span> <span class="hljs-string">去重</span> <span class="hljs-string">(按source_url或content</span> <span class="hljs-string">hash)</span>
  <span class="hljs-string">├─</span> <span class="hljs-string">时间同步</span> <span class="hljs-string">(UTC时区)</span>
  <span class="hljs-string">├─</span> <span class="hljs-string">质量检查</span> <span class="hljs-string">(null处理)</span>
  <span class="hljs-string">└─</span> <span class="hljs-string">异常值处理</span>
  <span class="hljs-string">↓</span>
[<span class="hljs-string">NLP处理</span>] <span class="hljs-string">(Stateless)</span>
  <span class="hljs-string">├─</span> <span class="hljs-string">语言检测与翻译</span>
  <span class="hljs-string">├─</span> <span class="hljs-string">命名实体识别</span> <span class="hljs-string">(NER)</span>
  <span class="hljs-string">│</span>  <span class="hljs-string">├─</span> <span class="hljs-string">地点识别</span> <span class="hljs-string">(港口、国家、海峡)</span>
  <span class="hljs-string">│</span>  <span class="hljs-string">├─</span> <span class="hljs-string">采购商识别</span>
  <span class="hljs-string">│</span>  <span class="hljs-string">└─</span> <span class="hljs-string">商品识别</span>
  <span class="hljs-string">├─</span> <span class="hljs-string">事件分类</span> <span class="hljs-string">(A/B/C/D四维)</span>
  <span class="hljs-string">│</span>  <span class="hljs-string">└─</span> <span class="hljs-string">微调BERT/RoBERTa模型</span>
  <span class="hljs-string">├─</span> <span class="hljs-string">情感分析</span> <span class="hljs-string">(sentiment_score)</span>
  <span class="hljs-string">├─</span> <span class="hljs-string">严重度评分</span> <span class="hljs-string">(impact_severity)</span>
  <span class="hljs-string">└─</span> <span class="hljs-string">置信度评估</span> <span class="hljs-string">(confidence)</span>
  <span class="hljs-string">↓</span>
[<span class="hljs-string">维度指标计算</span>] <span class="hljs-string">(Stateful时间窗口)</span>
  <span class="hljs-string">├─</span> <span class="hljs-string">窗口:</span> <span class="hljs-number">60</span><span class="hljs-string">分钟滑动,</span> <span class="hljs-number">30</span><span class="hljs-string">分钟步长</span>
  <span class="hljs-string">├─</span> <span class="hljs-string">计算LDI:</span> <span class="hljs-string">GroupBy</span> <span class="hljs-string">(buyer_geo_key,</span> <span class="hljs-string">commodity)</span>
  <span class="hljs-string">├─</span> <span class="hljs-string">计算CRI:</span> <span class="hljs-string">GroupBy</span> <span class="hljs-string">(buyer_geo_key,</span> <span class="hljs-string">region)</span>
  <span class="hljs-string">├─</span> <span class="hljs-string">计算GRI:</span> <span class="hljs-string">GroupBy</span> <span class="hljs-string">(buyer_geo_key,</span> <span class="hljs-string">conflict_zone)</span>
  <span class="hljs-string">├─</span> <span class="hljs-string">计算FRI:</span> <span class="hljs-string">GroupBy</span> <span class="hljs-string">(buyer_geo_key,</span> <span class="hljs-string">country)</span>
  <span class="hljs-string">└─</span> <span class="hljs-string">应用衰减函数:</span> <span class="hljs-string">历史事件权重递减</span>
  <span class="hljs-string">↓</span>
[<span class="hljs-string">综合指标合成</span>] <span class="hljs-string">(Stateless)</span>
  <span class="hljs-string">├─</span> <span class="hljs-string">综合风险指数</span> <span class="hljs-string">=</span> <span class="hljs-number">40</span><span class="hljs-string">%(LDI+CRI)/2</span> <span class="hljs-string">+</span> <span class="hljs-number">60</span><span class="hljs-string">%(GRI+FRI)/2</span>
  <span class="hljs-string">├─</span> <span class="hljs-string">采购商特定风险</span> <span class="hljs-string">=</span> <span class="hljs-string">综合指数</span> <span class="hljs-string">×</span> <span class="hljs-string">货运量</span> <span class="hljs-string">×</span> <span class="hljs-string">商品敏感性</span>
  <span class="hljs-string">├─</span> <span class="hljs-string">舆情vs风险相关度</span> <span class="hljs-string">(相关性分析)</span>
  <span class="hljs-string">└─</span> <span class="hljs-string">预警等级转换</span> <span class="hljs-string">(Green/Yellow/Orange/Red)</span>
  <span class="hljs-string">↓</span>
<span class="hljs-attr">Sink:</span> <span class="hljs-string">并行输出</span>
  <span class="hljs-string">├─</span> <span class="hljs-string">Paimon表</span> <span class="hljs-attr">1:</span> <span class="hljs-string">mgir_events_raw</span>
  <span class="hljs-string">├─</span> <span class="hljs-string">Paimon表</span> <span class="hljs-attr">2:</span> <span class="hljs-string">mgir_events_standardized</span>
  <span class="hljs-string">├─</span> <span class="hljs-string">Paimon表</span> <span class="hljs-attr">3:</span> <span class="hljs-string">mgir_dimension_scores</span>
  <span class="hljs-string">├─</span> <span class="hljs-string">Doris表:</span> <span class="hljs-string">mgir_indices_fact</span>
  <span class="hljs-string">├─</span> <span class="hljs-string">告警系统</span> <span class="hljs-string">(即时处理Red级)</span>
  <span class="hljs-string">└─</span> <span class="hljs-string">监控日志</span>

<span class="hljs-string">并行度配置:</span>
<span class="hljs-string">├─</span> <span class="hljs-string">数据清洗:</span> <span class="hljs-number">32</span>
<span class="hljs-string">├─</span> <span class="hljs-string">NLP处理:</span> <span class="hljs-number">16</span> <span class="hljs-string">(GPU场景)</span>
<span class="hljs-string">├─</span> <span class="hljs-string">指标计算:</span> <span class="hljs-number">32</span> <span class="hljs-string">(高计算密集)</span>
<span class="hljs-string">├─</span> <span class="hljs-string">数据输出:</span> <span class="hljs-number">16</span>
<span class="hljs-string">└─</span> <span class="hljs-attr">Checkpoint:</span> <span class="hljs-number">60</span><span class="hljs-string">秒间隔,</span> <span class="hljs-string">RocksDB后端</span>
</code></pre>
<hr/>
<h2 data-id="heading-24">指标计算</h2>
<h3 data-id="heading-25">6.1 LDI计算示例</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># Flink代码示例</span>

<span class="hljs-keyword">from</span> pyflink.datastream <span class="hljs-keyword">import</span> StreamExecutionEnvironment
<span class="hljs-keyword">from</span> pyflink.datastream.functions <span class="hljs-keyword">import</span> MapFunction, WindowFunction
<span class="hljs-keyword">from</span> pyflink.datastream.window <span class="hljs-keyword">import</span> TumblingEventTimeWindow

<span class="hljs-keyword">class</span> <span class="hljs-title class_">LDICalculator</span>(<span class="hljs-title class_ inherited__">WindowFunction</span>):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">apply</span>(<span class="hljs-params">self, key, window, elements</span>):
        buyer_geo, commodity = key
        
        ldi_score = <span class="hljs-number">0.0</span>
        <span class="hljs-keyword">for</span> event <span class="hljs-keyword">in</span> elements:
            <span class="hljs-comment"># 基础严重度</span>
            severity = self.get_severity_score(event[<span class="hljs-string">'delivery_impact_dim'</span>])
            
            <span class="hljs-comment"># 距离衰减系数</span>
            distance = self.get_distance_to_buyer(
                event[<span class="hljs-string">'location_lat'</span>], 
                event[<span class="hljs-string">'location_lon'</span>],
                buyer_geo
            )
            proximity_factor = self.distance_decay(distance)
            
            <span class="hljs-comment"># 商品易腐性乘数</span>
            commodity_multiplier = self.get_commodity_multiplier(commodity)
            
            <span class="hljs-comment"># LDI累加</span>
            event_ldi = severity * proximity_factor * commodity_multiplier
            
            <span class="hljs-comment"># 衰减函数: 事件发生越早权重越小</span>
            days_old = (now - event[<span class="hljs-string">'risk_date'</span>]).days
            decay_factor = math.exp(-<span class="hljs-number">0.1</span> * days_old)  <span class="hljs-comment"># 半衰期10天</span>
            
            ldi_score += event_ldi * decay_factor
        
        <span class="hljs-comment"># 归一化到0-10</span>
        ldi_normalized = <span class="hljs-built_in">min</span>(<span class="hljs-number">10.0</span>, ldi_score)
        
        <span class="hljs-keyword">yield</span> (buyer_geo, commodity, ldi_normalized)
</code></pre>
<h3 data-id="heading-26">6.2 综合风险指数计算</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">CompositeRiskCalculator</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">calculate</span>(<span class="hljs-params">self, ldi, cri, gri, fri, 
                  volume_weight, commodity_sensitivity</span>):
        <span class="hljs-string">"""
        综合风险指数 = 40% × (LDI+CRI)/2 + 60% × (GRI+FRI)/2
        采购商特定风险 = 综合指数 × 货运量权重 × 商品敏感性
        """</span>
        
        <span class="hljs-comment"># 第2层: 维度指标平均</span>
        logistics_compliance_avg = (ldi + cri) / <span class="hljs-number">2.0</span>
        geopolitical_financial_avg = (gri + fri) / <span class="hljs-number">2.0</span>
        
        <span class="hljs-comment"># 综合舆情指数 (0-100)</span>
        composite_index = (
            <span class="hljs-number">0.4</span> * logistics_compliance_avg +
            <span class="hljs-number">0.6</span> * geopolitical_financial_avg
        ) * <span class="hljs-number">10</span>  <span class="hljs-comment"># 缩放到0-100</span>
        
        <span class="hljs-comment"># 采购商特定风险 (考虑货运量和商品敏感性)</span>
        buyer_specific_risk = (
            composite_index * 
            volume_weight * 
            commodity_sensitivity
        )
        buyer_specific_risk = <span class="hljs-built_in">min</span>(<span class="hljs-number">100.0</span>, buyer_specific_risk)
        
        <span class="hljs-comment"># 预警等级</span>
        alert_level = self.get_alert_level(buyer_specific_risk)
        
        <span class="hljs-keyword">return</span> {
            <span class="hljs-string">'composite_risk_index'</span>: composite_index,
            <span class="hljs-string">'buyer_specific_risk_score'</span>: buyer_specific_risk,
            <span class="hljs-string">'risk_alert_level'</span>: alert_level
        }
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_alert_level</span>(<span class="hljs-params">self, risk_score</span>):
        <span class="hljs-keyword">if</span> risk_score &lt; <span class="hljs-number">25</span>:
            <span class="hljs-keyword">return</span> <span class="hljs-string">'Green'</span>
        <span class="hljs-keyword">elif</span> risk_score &lt; <span class="hljs-number">50</span>:
            <span class="hljs-keyword">return</span> <span class="hljs-string">'Yellow'</span>
        <span class="hljs-keyword">elif</span> risk_score &lt; <span class="hljs-number">75</span>:
            <span class="hljs-keyword">return</span> <span class="hljs-string">'Orange'</span>
        <span class="hljs-keyword">else</span>:
            <span class="hljs-keyword">return</span> <span class="hljs-string">'Red'</span>
</code></pre>
<h3 data-id="heading-27">6.3 舆情相关度计算</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">calculate_sentiment_risk_correlation</span>(<span class="hljs-params">
    sentiment_scores: <span class="hljs-type">List</span>[<span class="hljs-built_in">float</span>],
    risk_scores: <span class="hljs-type">List</span>[<span class="hljs-built_in">float</span>]
</span>) -&gt; <span class="hljs-built_in">float</span>:
    <span class="hljs-string">"""
    计算舆情热度与实际风险的相关度
    
    &gt;0.7: 舆情热度与实际风险高度相关
    0.3-0.7: 中等相关
    &lt;0.3: 低相关 (舆情为"噪音")
    """</span>
    
    <span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np
    
    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(sentiment_scores) &lt; <span class="hljs-number">2</span> <span class="hljs-keyword">or</span> <span class="hljs-built_in">len</span>(risk_scores) &lt; <span class="hljs-number">2</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-number">0.0</span>
    
    s = np.array(sentiment_scores)
    r = np.array(risk_scores)
    
    <span class="hljs-comment"># Pearson相关系数</span>
    correlation = np.corrcoef(s, r)[<span class="hljs-number">0</span>, <span class="hljs-number">1</span>]
    
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">float</span>(correlation) <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> np.isnan(correlation) <span class="hljs-keyword">else</span> <span class="hljs-number">0.0</span>
</code></pre>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android Studio的技巧]]></title>    <link>https://juejin.cn/post/7577737385955246090</link>    <guid>https://juejin.cn/post/7577737385955246090</guid>    <pubDate>2025-11-30T10:04:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577737385955246090" data-draft-id="7577971299743154214" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android Studio的技巧"/> <meta itemprop="keywords" content="Android Studio,Android"/> <meta itemprop="datePublished" content="2025-11-30T10:04:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="城堡修炼者"/> <meta itemprop="url" content="https://juejin.cn/user/2379804202775341"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android Studio的技巧
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2379804202775341/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    城堡修炼者
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T10:04:38.000Z" title="Sun Nov 30 2025 10:04:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1. 历史剪贴板</h2>
<p>ctrl（Mac: Cmd） + shift + v ： 可以查看你复制过的内容</p>
<h2 data-id="heading-1">2. 批量导入资源文件</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eef3a8ef8ca041bba353e05fb49cd257~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Z-O5aCh5L-u54K86ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765101877&amp;x-signature=8IFn8bEWPh5J34V83qXF%2BU%2BnAVw%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-2">3. 同时选中多个地方</h2>
<p>ctrl（Mac: Cmd） + shift + alt ： 同时选中多个地方，可以编辑修改</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/15230f2f6c534de1ba57eada76f08777~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Z-O5aCh5L-u54K86ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765101877&amp;x-signature=RPbJWxSmqN6JRRhRMdHdOv%2BTpjc%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-3">4. 快捷编辑</h2>
<p>postfix</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/62a5cfcd8d65451d8f947137b8a03cad~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Z-O5aCh5L-u54K86ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765101877&amp;x-signature=YxqcueSJRyhNsfvmaKHjCc5alCc%3D" alt="image.png" loading="lazy"/></p>
<p>可以自定义自己的快捷语也可以用默认的</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[ID生成器第一讲：原理和常见几种生成器]]></title>    <link>https://juejin.cn/post/7577991167200444426</link>    <guid>https://juejin.cn/post/7577991167200444426</guid>    <pubDate>2025-11-30T09:53:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577991167200444426" data-draft-id="7577968429590085658" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="ID生成器第一讲：原理和常见几种生成器"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-30T09:53:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员Easy哥"/> <meta itemprop="url" content="https://juejin.cn/user/221424286966538"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            ID生成器第一讲：原理和常见几种生成器
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/221424286966538/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员Easy哥
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T09:53:48.000Z" title="Sun Nov 30 2025 09:53:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a2055d9173844762a14aaa1715b6177c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGYRWFzeeWTpQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765101228&amp;x-signature=3Fa87KMtQVzEmUt%2B1vewtEa%2BCc0%3D" alt="画板" loading="lazy"/></p>
<h2 data-id="heading-0">一、介绍</h2>
<p>ID 是标识符（identifier）的前缀，它代表一个可以唯一识别一个对象或者物体的名称。在软件系统中，ID 用于对一组信息进行标识，它是信息系统里最底层、最基础的概念，从系统诞生到消亡，都与 ID 息息相关。</p>
<p>在分布式系统中，ID生成器是至关重要的，因为分布式系统中，一个数据表可能存储在多个物理机上，这样主键Id如何生成，怎么保证其有序性，生成可靠性，生成稳定性等都是一个问题。</p>
<p>作为一个Java后端架构师，我们需要知道 ID生成器的原理和常见的ID生成器都有哪些，以及如何自己实现一个简易的Id生成器，加深对分布式系统的理解。</p>
<p/>
<h2 data-id="heading-1">二、属性</h2>
<p>用5 个属性来分析</p>
<ul>
<li>自身属性:  类型、长度</li>
<li>领域属性:  唯一性、稀疏度、递增性</li>
</ul>
<h2 data-id="heading-2">三、各种Id生成</h2>
<h3 data-id="heading-3">1、db自增ID表</h3>
<hr/>
<p><strong>介绍</strong>: 自增ID表其实就是给db中写一张id表，利用数据库主键id自增思想来生成id.</p>
<pre><code class="hljs language-java" lang="java">create table `id_gen` 
(
    `id` bigint(<span class="hljs-number">20</span>) not <span class="hljs-literal">null</span> auto_increment,
    primary <span class="hljs-title function_">key</span><span class="hljs-params">(`id`)</span>
) engine=InnoDB <span class="hljs-type">DEFAULT</span> <span class="hljs-variable">CHATSET</span> <span class="hljs-operator">=</span> utf8mb4;
</code></pre>
<p><strong>优点</strong>:     实现简单，成本不高，自增连续性好，Id严格从1增长<br/>
<strong>缺点</strong>:</p>
<pre><code class="hljs language-css" lang="css">- 单表&lt;<span class="hljs-attribute">font</span> style="<span class="hljs-attribute">color</span>:<span class="hljs-number">#DF2A3F</span>;"&gt;过热&lt;/<span class="hljs-attribute">font</span>&gt;，&lt;<span class="hljs-attribute">font</span> style="<span class="hljs-attribute">color</span>:<span class="hljs-number">#DF2A3F</span>;"&gt;qps存在瓶颈&lt;/<span class="hljs-attribute">font</span>&gt;。
- &lt;<span class="hljs-attribute">font</span> style="<span class="hljs-attribute">color</span>:<span class="hljs-number">#DF2A3F</span>;"&gt;安全问题&lt;/<span class="hljs-attribute">font</span>&gt;(根据订单ID递增规则推送出每天的数据量等等)
- 每获取一次Id都需要访问一次数据库，单个db的&lt;<span class="hljs-attribute">font</span> style="<span class="hljs-attribute">color</span>:<span class="hljs-number">#DF2A3F</span>;"&gt;连接数&lt;/<span class="hljs-attribute">font</span>&gt;是瓶颈.
</code></pre>
<h3 data-id="heading-4">2、db多主模式</h3>
<hr/>
<p><strong>介绍</strong>:  多个表同时提供ID服务，一个表从1开始步长为2，一个表从2开始步长2。</p>
<p>生产id: 1,  3, 5.    2, 4, 6.<br/>
如果需要新增一个db实例，就需要重新调整.</p>
<p>比较繁琐.</p>
<p>set @@auto_increment_offset = 2;       --- 起始值</p>
<p>set @@auto_increment_increment= 2;    --- 步长</p>
<p><strong>优点</strong>:  分散db压力<br/>
<strong>缺点</strong>:  扩展性和复杂度提高,  其实并没有实现分布式</p>
<h3 data-id="heading-5">3、号段模式</h3>
<p><strong>介绍</strong>:</p>
<p>数据库每次递增一条肯定是不行的，所以能否一次请求，生成一段Id， 放在内存中，下次直接访问内存即可,  这样减轻db请求次数.   这就是我们所说的<strong>基于数据库号段生成分布式Id。</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/edff0532e3774e6388902376434d9890~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGYRWFzeeWTpQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765101228&amp;x-signature=AZWpn21rwDplGbgYNXEV5bz05jg%3D" alt="画板" loading="lazy"/></p>
<p><strong>具体实现</strong>:</p>
<ul>
<li><strong>Idserver 多个rpc生成:</strong>    瓶颈在于id server 数量</li>
<li><strong>客户端批量生成:</strong>         瓶颈在于DB，多个实例同时请求同一个业务的更新权限时，其实就是会抢行锁.</li>
<li>如果是认为单表过热的话，也就是多个业务，其实可以横向扩充shard即可. biz_id % shard 去操作.</li>
</ul>
<p>idserver我们就不用多说了，其实就是单个单个server组成集群，每个server提供id生成服务.<br/>
我们下面来看一下客户端批量生成单表.</p>
<pre><code class="hljs language-java" lang="java">create table `id_generator` (
    `id` bigint(<span class="hljs-number">20</span>) not <span class="hljs-literal">null</span>,
    `max_id` bigint(<span class="hljs-number">20</span>) not <span class="hljs-literal">null</span> comment <span class="hljs-string">'最大id'</span>,
    `step` <span class="hljs-type">int</span>(<span class="hljs-number">10</span>) not <span class="hljs-literal">null</span> comment <span class="hljs-string">'号段长度'</span>,
    `version` <span class="hljs-type">int</span>(<span class="hljs-number">20</span>) not <span class="hljs-literal">null</span> comment <span class="hljs-string">'版本'</span>,
    `biz_type` <span class="hljs-type">int</span>(<span class="hljs-number">20</span>) not <span class="hljs-literal">null</span> comment <span class="hljs-string">'业务类型'</span>,
    primary <span class="hljs-title function_">key</span><span class="hljs-params">(`id`)</span>
) engine = InnoDB <span class="hljs-keyword">default</span> charset=utf8mb4;
</code></pre>
<p>select + update 重试</p>
<pre><code class="hljs language-java" lang="java">update ml_id_gen set version=version + <span class="hljs-number">1</span>, max_id =newMaxId where biz_id=:bizId <span class="hljs-type">and</span> <span class="hljs-variable">version</span> <span class="hljs-operator">=</span> version 
如果updateCount == <span class="hljs-number">0</span>, 重复select, update直到修改成功


注意: newMaxId = oldMaxId + step 

<span class="hljs-comment">// 那就得先获取版本, 再更新.</span>
select version from ml_id_gen <span class="hljs-type">where</span> <span class="hljs-variable">biz_id</span> <span class="hljs-operator">=</span> :bizId


在获取层client, 内部就可以封装一个loadingCache&lt;bizId, Tuple&lt;Long, Long&gt;&gt;   
        Tuple中是 curId, curRegionMaxId

<span class="hljs-keyword">case</span>: 
<span class="hljs-number">1.</span> bizId 无, 去找db 生成
<span class="hljs-number">2.</span> bizId 有  
        <span class="hljs-number">2.1</span> curId = curRegionMaxId
        找server分配,  更新cache
        重新拿到curId, curId++更新cache.
        <span class="hljs-keyword">return</span> 重新拿到curId;
        <span class="hljs-number">2.2</span> curId &lt; curRegionMaxId
        <span class="hljs-type">long</span> <span class="hljs-variable">oldId</span> <span class="hljs-operator">=</span> curId++;
        更新cache(curId, curRegionMaxId)
        <span class="hljs-keyword">return</span> oldId;
</code></pre>
<p><strong>优点</strong>:  ID 趋势增长、存储消耗空间少</p>
<p><strong>缺点</strong>:  <strong>单表存在热点问题</strong>，Id 没有意义，安全问题(步长很容易被猜出来)</p>
<h3 data-id="heading-6">4、NoSQL自增</h3>
<p><strong>介绍</strong>:</p>
<p>采用incr自增获取.</p>
<p>**优点:   **性能非常好，并且Id有序增长。</p>
<p><strong>缺点</strong>:</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">-</span> <span class="hljs-strong">**存在单点.  当然有集群.**</span>
<span class="hljs-bullet">-</span> <span class="hljs-strong">**RDB**</span>:   每隔一段时间快照，但是如果连续incr，redis挂了，会造成id重复.
<span class="hljs-bullet">-</span> <span class="hljs-strong">**AOF**</span>:   不会重复，但是incr命令过多，导致重启恢复数据时间过长.
</code></pre>
<h3 data-id="heading-7">5、雪花算法及其多个实现</h3>
<p>**介绍: **</p>
<p>雪花算法:  snowflow是twitter开源的分布式Id生成算法.</p>
<p>long 我们都知道8个字节==64bit.</p>
<pre><code class="hljs language-diff" lang="diff"><span class="hljs-deletion">- 第一位标识:  0: 正数  1: 负数</span>
<span class="hljs-deletion">- 41位:  时间戳部分ms,  一般是当前时间 - 固定的开始时间，这样产生的ID可以从更小值开始.   而且41位可以用 (1L &lt;&lt; 41 / (1000 * 3600 * 24 * 365)) = 69年.</span>
<span class="hljs-deletion">- 10位: 工作机器id，5位为机房信息，5位为机房中的机器号 workerId, 这样可以部署1024个节点.</span>
<span class="hljs-deletion">- 12位: 序列号部分, 支持统一ms内同一个节点可以生成4096个ID.</span>
</code></pre>
<p><strong>优点:  生成速度快、生成的ID有序递增、比较灵活(可以改造)</strong></p>
<p><strong>缺点:  需要解决重复ID问题 (比较依赖服务器时间，在机器时间不对的情况下, 可能会造成重复ID)</strong></p>
<p>后面百度uid-generator,  美团leaf，滴滴Tinyid等都是修改 这个几个的位数和 具体workerId怎样生成的。</p>
<h4 data-id="heading-8">Uid-Generator(百度):</h4>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fbaidu%2Fuid-generator" target="_blank" title="https://github.com/baidu/uid-generator" ref="nofollow noopener noreferrer">uid-generator</a> 基于Java、snawflake实现的唯一Id生成器。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/df0d7b29197d4e6489614fe7c2e78021~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGYRWFzeeWTpQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765101228&amp;x-signature=shVlT%2B%2BbEAxdCO627EG%2Ffagh6aM%3D" alt="" loading="lazy"/></p>
<p>看起来已经不在维护了.</p>
<h4 data-id="heading-9">Leaf(美团):</h4>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FMeituan-Dianping%2FLeaf" target="_blank" title="https://github.com/Meituan-Dianping/Leaf" ref="nofollow noopener noreferrer">Leaf</a> 最早期需求是各个业务线的订单ID生成需求。\ 看起来以前他们是db自增，redis自增来生成ID，后面他们统一了。\ 这其实得深入了解美团的技术组成，如果内部有两个相同的业务，就会整合成一个，这一点非常好.</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/29acd93badbf4047a9f79917f6efd688~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGYRWFzeeWTpQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765101228&amp;x-signature=1GjnWueC4FhjgNfPS0BGExquwTU%3D" alt="" loading="lazy"/></p>
<p>世界上没有两片完全相同的树叶，人也是一样.</p>
<p>Leaf 提供了 号段模式 和 snowflow(雪花算法) 这两种模式来生成分布式ID。</p>
<p>支持双号段，解决了雪花ID 系统时钟回拨问题。但是时钟问题的解决依赖于Zk。</p>
<p>雪花的号段位分布. <a href="https://link.juejin.cn?target=https%3A%2F%2Ftech.meituan.com%2F2017%2F04%2F21%2Fmt-leaf.html" target="_blank" title="https://tech.meituan.com/2017/04/21/mt-leaf.html" ref="nofollow noopener noreferrer">Leaf——美团点评分布式ID生成系统</a></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7f36a9c9618c430c82621517a0892d53~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGYRWFzeeWTpQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765101228&amp;x-signature=fGANxKPMLly7rSWcVk5C8Nf5%2FRQ%3D" alt="" loading="lazy"/></p>
<p>主要是workerId生成不同，leaf中workId 是基于zk的顺序id来生成的，每个应用在使用Leaf-snowFlake时，在启动时都会在zk中生成一个顺序id，相当于一个机器对应一个顺序节点，也就是一个workId。</p>
<h4 data-id="heading-10">Tinyid(滴滴):</h4>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fdidi%2Ftinyid" target="_blank" title="https://github.com/didi/tinyid" ref="nofollow noopener noreferrer">Tinyid(opens new window)</a>是滴滴开源的一款基于数据库号段模式的唯一 ID 生成器。</p>
<p>相关文档： <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fdidi%2Ftinyid%2Fwiki%2Ftinyid%25E5%258E%259F%25E7%2590%2586%25E4%25BB%258B%25E7%25BB%258D" target="_blank" title="https://github.com/didi/tinyid/wiki/tinyid%E5%8E%9F%E7%90%86%E4%BB%8B%E7%BB%8D" ref="nofollow noopener noreferrer">Tinyid原理介绍</a></p>
<h3 data-id="heading-11"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5d4e5bca56a341b498da2ddf65a8f712~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGYRWFzeeWTpQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765101228&amp;x-signature=bUYebn8Z2ojydhRzZdQg%2Ft%2Fe%2Fh8%3D" alt="" loading="lazy"/></h3>
<p>到此一个简单的id生成系统就完成了，那么是否还存在问题呢？回想一下我们最开始的id生成系统要求，高性能、高可用、简单易用，在上面这套架构里，至少还存在以下问题:</p>
<ul>
<li>当id用完时需要访问db加载新的号段，db更新也可能存在version冲突，此时id生成耗时明显增加</li>
<li>db是一个单点，虽然db可以建设主从等高可用架构，但始终是一个单点</li>
<li>使用http方式获取一个id，存在网络开销，性能和可用性都不太好</li>
</ul>
<p/>
<p>所以后面加了下面这几个来优化. </p>
<ul>
<li>双号段缓存:  
<ul>
<li>为了避免在获取新号段的情况下，获取唯一ID的速度比较慢。Tinyid中的号段在加载到一定的程度(比如一半)，就去异步加载下一个号段，保证内存中永远始终有可用的号段。</li>
</ul>
</li>
<li>增加多db支持 其实就是生成奇数，偶数这种.	
<ul>
<li>支持多个DB，并且，每个DB都能生成唯一ID，提高可用性。</li>
</ul>
</li>
<li>增加tinyid-client。
<ul>
<li>纯纯本地操作，无http请求损耗。</li>
</ul>
</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/85f826a4804249e8b2c7817d79d708a1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGYRWFzeeWTpQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765101228&amp;x-signature=GjKUDqzHMMOye3temSXapzfzVAc%3D" alt="" loading="lazy"/></p>
<p>优缺点: 上面也说了很多，但是要注意数据库号段的缺点。</p>
<h3 data-id="heading-12">6、UUID</h3>
<p><strong>介绍</strong>:</p>
<p>UUID 是 Universally unique identifier (通用唯一标识符) 的 缩写。UUID 包含32个16进入数字 (8-4-4-4-12) 。</p>
<p>JDK 中就用现成的。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">final</span> <span class="hljs-type">UUID</span> <span class="hljs-variable">uuid</span> <span class="hljs-operator">=</span> UUID.randomUUID();
System.out.println(uuid);
System.out.println(uuid.version());


4c994944-<span class="hljs-number">82e1</span>-4be4-a543-ab182d87b11d
<span class="hljs-number">4</span>
</code></pre>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.ietf.org%2Fhtml%2Frfc4122" target="_blank" title="https://tools.ietf.org/html/rfc4122" ref="nofollow noopener noreferrer">RFC 4122(opens new window)</a>中关于 UUID 的示例是这样的：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f8af34e9bcef4e6b89cb8914c93d4bda~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGYRWFzeeWTpQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765101228&amp;x-signature=%2BYT2GUshx6FiR0NdnLQ%2BST2I5RY%3D" alt="" loading="lazy"/></p>
<p>其实需要关注版本即可，不同的版本对应的UUID 的生成规则是不同的。</p>
<p>5 种不同的 Version(版本)值分别对应的含义（参考<a href="https://link.juejin.cn?target=https%3A%2F%2Fzh.wikipedia.org%2Fwiki%2F%25E9%2580%259A%25E7%2594%25A8%25E5%2594%25AF%25E4%25B8%2580%25E8%25AF%2586%25E5%2588%25AB%25E7%25A0%2581" target="_blank" title="https://zh.wikipedia.org/wiki/%E9%80%9A%E7%94%A8%E5%94%AF%E4%B8%80%E8%AF%86%E5%88%AB%E7%A0%81" ref="nofollow noopener noreferrer">维基百科对于 UUID 的介绍(opens new window)</a>）：</p>
<ul>
<li><strong>版本 1</strong> : UUID 是根据时间和节点 ID（通常是 MAC 地址）生成；</li>
<li><strong>版本 2</strong> : UUID 是根据标识符（通常是组或用户 ID）、时间和节点 ID 生成；</li>
<li><strong>版本 3、版本 5</strong> : 版本 5 - 确定性 UUID 通过散列（hashing）名字空间（namespace）标识符和名称生成；</li>
<li><strong>版本 4</strong> : UUID 使用<a href="https://link.juejin.cn?target=https%3A%2F%2Fzh.wikipedia.org%2Fwiki%2F%25E9%259A%258F%25E6%259C%25BA%25E6%2580%25A7" target="_blank" title="https://zh.wikipedia.org/wiki/%E9%9A%8F%E6%9C%BA%E6%80%A7" ref="nofollow noopener noreferrer">随机性(opens new window)</a>或<a href="https://link.juejin.cn?target=https%3A%2F%2Fzh.wikipedia.org%2Fwiki%2F%25E4%25BC%25AA%25E9%259A%258F%25E6%259C%25BA%25E6%2580%25A7" target="_blank" title="https://zh.wikipedia.org/wiki/%E4%BC%AA%E9%9A%8F%E6%9C%BA%E6%80%A7" ref="nofollow noopener noreferrer">伪随机性(opens new window)</a>生成。</li>
</ul>
<p>下面是 Version 1 版本下生成的 UUID 的示例：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/43ae4df06c0f4e8ca6cb41c9984bd892~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGYRWFzeeWTpQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765101228&amp;x-signature=ixhVZzLGolSyqGJ6unN86hlwmK0%3D" alt="" loading="lazy"/></p>
<p>JDK 中通过 UUID 的 randomUUID() 方法生成的 UUID 的版本默认为 4。</p>
<p>我们看UUID的生成包含： MAC地址、时间戳、命名空间、随机或伪随机数、时序等元素，当然极少概率会出现重复.</p>
<p><strong>优点</strong>:  生成速度比较快、简单</p>
<p><strong>缺点</strong>:  存储消耗空间大(36字符，128位)、 不安全（基于MAC地址生成会造成MAC地址泄漏）、无序、没有具体的业务含义、需要解决重复ID问题 (当机器时间不对的时候,  linux 的ntp时间会有问题,  可能会导致重复Id)</p>
<h3 data-id="heading-13">说明:</h3>
<ul>
<li>其中1.2.3.4 数据自增思想.</li>
<li>5属于snowFlake思想，各个bit位数不一样，workerId生成不一样.</li>
</ul>
<h2 data-id="heading-14">四、使用</h2>
<p>其实在大厂里都有自己的id生成器，一般都是雪花算法的变种，当然也提供类似号段模式，id-server严格递增等等。</p>
<p>还是需要根据业务诉求、背景去找到符合自己背景的id生成器</p>
<h2 data-id="heading-15">附录:</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.infoq.cn%2Farticle%2Fiuvjqc1ws7h8mqsogquy" target="_blank" title="https://www.infoq.cn/article/iuvjqc1ws7h8mqsogquy" ref="nofollow noopener noreferrer">www.infoq.cn/article/iuv…</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fjavaguide.cn%2Fdistributed-system%2Fdistributed-id%2F%23%25E5%25BC%2580%25E6%25BA%2590%25E6%25A1%2586%25E6%259E%25B6" target="_blank" title="https://javaguide.cn/distributed-system/distributed-id/#%E5%BC%80%E6%BA%90%E6%A1%86%E6%9E%B6" ref="nofollow noopener noreferrer">javaguide.cn/distributed…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Elasticsearch 跳表（Skip List）：有序结果合并的 “性能电梯”]]></title>    <link>https://juejin.cn/post/7577737385955213322</link>    <guid>https://juejin.cn/post/7577737385955213322</guid>    <pubDate>2025-11-30T09:55:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577737385955213322" data-draft-id="7577737385955196938" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Elasticsearch 跳表（Skip List）：有序结果合并的 “性能电梯”"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-30T09:55:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Penge666"/> <meta itemprop="url" content="https://juejin.cn/user/1549628692501449"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Elasticsearch 跳表（Skip List）：有序结果合并的 “性能电梯”
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1549628692501449/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Penge666
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T09:55:10.000Z" title="Sun Nov 30 2025 09:55:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    10
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 Elasticsearch（ES）的多条件查询中，结果合并是决定性能的关键步骤。当你执行 “标题包含 A 且包含 B” 这类查询时，ES 需要合并两个倒排列表（Posting List）的结果。此时，<strong>跳表（Skip List）</strong>  就像 “性能电梯” 一样，跳过大量无关元素，让合并速度飙升 —— 而这一点，用普通链表合并根本无法实现。</p>
<p>本文将通过一个更直观的例子，拆解跳表的工作原理、优势，以及它在 ES 中的实际应用，让你彻底明白 “为什么有序列表合并必须用跳表”。</p>
<h2 data-id="heading-0">一、先澄清：跳表的核心优势是什么？</h2>
<p>跳表的核心价值只有一个：<strong>在有序列表中，以 “跳跃式遍历” 替代 “逐元素遍历”，将合并时间复杂度从 O (n) 降至 O (log n)</strong> 。</p>
<p>举个极端对比：</p>
<ul>
<li>普通链表合并：100 万条数据的两个列表，需逐元素比较，最多要 200 万次操作；</li>
<li>跳表合并：同样 100 万条数据，仅需约 20 次比较（log₂(100 万)≈17），速度提升 10 万倍。</li>
</ul>
<p>之所以之前的例子没凸显优势，是因为数据量太小。这次我们用 “10 万条 docID” 的场景，让跳表的 “电梯效应” 一目了然。</p>
<h2 data-id="heading-1">二、场景重构：10 万条数据的多条件查询</h2>
<h3 data-id="heading-2">场景假设</h3>
<p>我们有一个新闻索引 <code>news</code>，包含 <strong>10 万篇文档</strong>（docID 从 1 到 100000），字段 <code>title</code>（text 类型，分词后建立倒排索引）。现在执行查询：<strong>「金龙鱼 AND 18 亿 AND 罚单」</strong>（标题同时包含这三个关键词的新闻）。</p>
<p>对应的 DSL：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"query"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"bool"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"must"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-punctuation">{</span> <span class="hljs-attr">"match"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"title"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"金龙鱼"</span> <span class="hljs-punctuation">}</span> <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
        <span class="hljs-punctuation">{</span> <span class="hljs-attr">"match"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"title"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"18亿"</span> <span class="hljs-punctuation">}</span> <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
        <span class="hljs-punctuation">{</span> <span class="hljs-attr">"match"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"title"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"罚单"</span> <span class="hljs-punctuation">}</span> <span class="hljs-punctuation">}</span>
      <span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-3">关键前提：倒排列表是有序的</h3>
<p>ES 的倒排索引在构建时，会将每个关键词对应的 docID 按 <strong>递增顺序</strong> 存储（因为 docID 是文档写入时分配的连续整数，匹配同一关键词的文档会按写入顺序排序）。</p>
<p>查询后，我们得到三个按 docID 有序的 Posting List：</p>
<ul>
<li>列表 A（金龙鱼）：<code>[123, 456, 789, 1112, 1456, 1789, 2112, ..., 99789]</code>（共 5000 条）</li>
<li>列表 B（18 亿）：<code>[456, 1456, 2456, 3456, ..., 98456]</code>（共 3000 条）</li>
<li>列表 C（罚单）：<code>[1456, 3456, 5456, ..., 97456]</code>（共 2000 条）</li>
</ul>
<p>现在需要合并这三个列表，找到它们的 <strong>交集</strong>（同时包含三个关键词的 docID）。</p>
<h2 data-id="heading-4">三、普通链表合并 vs 跳表合并：差距一目了然</h2>
<h3 data-id="heading-5">1. 普通链表合并：低效的 “逐元素爬行”</h3>
<p>普通链表合并三个有序列表，需要三个指针分别遍历三个列表，逐元素比较是否相等：</p>
<ul>
<li>指针 A 初始指向 123，指针 B 指向 456，指针 C 指向 1456 → 123 &lt; 456 &lt; 1456，指针 A 移至 456；</li>
<li>指针 A=456，指针 B=456，指针 C=1456 → 456 &lt; 1456，指针 A 移至 789，指针 B 移至 1456；</li>
<li>指针 A=789，指针 B=1456，指针 C=1456 → 789 &lt; 1456，指针 A 移至 1112；</li>
<li>指针 A=1112，指针 B=1456，指针 C=1456 → 1112 &lt; 1456，指针 A 移至 1456；</li>
<li>指针 A=1456，指针 B=1456，指针 C=1456 → 相等，加入结果集；</li>
<li>后续重复此逻辑，直到遍历完某个列表。</li>
</ul>
<p><strong>问题</strong>：三个列表共 10000 条数据，普通合并需要遍历大部分元素（可能上万次比较），数据量越大，耗时越长。</p>
<h3 data-id="heading-6">2. 跳表合并：高效的 “电梯跳跃”</h3>
<p>跳表在普通有序链表之上，建立了 <strong>多层索引层</strong>（类似电梯），可以跳过大量无关元素。我们以列表 A 为例，看看跳表结构：</p>
<pre><code class="hljs language-plaintext" lang="plaintext">第3层（顶层）：123 → 1456 → 2112 → ... → 99789 （间隔大，快速跨段）
第2层（中层）：123 → 789 → 1456 → 1789 → ... → 99789 （间隔中等）
第1层（下层）：123 → 456 → 789 → 1112 → 1456 → ... → 99789 （间隔小）
第0层（底层）：123 → 456 → 789 → 1112 → 1456 → 1789 → 2112 → ... → 99789 （原始列表）
</code></pre>
<h4 data-id="heading-7">跳表合并三个列表的流程（求交集）：</h4>
<ol>
<li>
<p><strong>初始化指针</strong>：三个列表的跳表指针均指向各自头部（A=123，B=456，C=1456）。</p>
</li>
<li>
<p><strong>第一次跳跃：快速对齐最小值</strong></p>
<ul>
<li>三个指针的当前值：123（A）、456（B）、1456（C），最小值是 123（A）；</li>
<li>用 A 的跳表快速跳到 “不小于 1456” 的元素（因为 C 的当前值是 1456，这是三个值中的最大值，交集必须大于等于 1456）；</li>
<li>A 的跳表从 123 直接跳到 1456（跳过 456、789、1112 三个元素），此时 A=1456。</li>
</ul>
</li>
<li>
<p><strong>第二次跳跃：验证是否相等</strong></p>
<ul>
<li>现在三个指针的值：1456（A）、456（B）、1456（C），最小值是 456（B）；</li>
<li>用 B 的跳表快速跳到 “不小于 1456” 的元素，B 从 456 直接跳到 1456（跳过 2456 之前的所有元素），此时 B=1456。</li>
</ul>
</li>
<li>
<p><strong>找到交集，继续跳跃</strong></p>
<ul>
<li>三个指针的值均为 1456，加入结果集；</li>
<li>三个指针同时跳到下一个元素（A=1789，B=2456，C=3456）；</li>
<li>最小值是 1789（A），用 A 的跳表快速跳到 “不小于 3456” 的元素（C 的当前值），A 从 1789 跳到 3456（跳过多个元素）；</li>
<li>重复上述逻辑，直到某个指针无下一个元素。</li>
</ul>
</li>
</ol>
<h4 data-id="heading-8">跳表的优势体现：</h4>
<ul>
<li>合并三个列表仅需 <strong>几十次比较</strong>（而非上万次），因为大部分无关元素都被跳表 “跳过” 了；</li>
<li>数据量越大，优势越明显：100 万条数据的列表合并，跳表可将耗时从秒级降至毫秒级。</li>
</ul>
<h2 data-id="heading-9">四、跳表在 ES 中的应用场景：仅用于有序列表合并</h2>
<p>跳表不是万能的，它的应用场景有严格限制 ——<strong>必须是有序的 Posting List 合并</strong>，这在 ES 中对应以下场景：</p>
<h3 data-id="heading-10">1. 多条件文本查询（must/should 子句）</h3>
<ul>
<li>例：<code>title:金龙鱼 AND title:18亿</code>（must 子句，求交集）；</li>
<li>例：<code>title:金龙鱼 OR title:18亿</code>（should 子句，求并集）；</li>
<li>核心：文本类型（text/keyword）的倒排索引 Posting List 是有序的，适合跳表合并。</li>
</ul>
<h3 data-id="heading-11">2. 带过滤的文本查询（filter + must）</h3>
<ul>
<li>例：<code>filter: {term: {biz_id:1001}} AND must: {match: {title:金龙鱼}}</code>；</li>
<li>核心：filter 子句的 Bitset 先筛选出小范围有序 docID，再与 must 子句的有序 Posting List 用跳表合并。</li>
</ul>
<h3 data-id="heading-12">3. 不适用的场景</h3>
<ul>
<li>数值 / 日期类型的范围查询（BKD 树返回的 docID 是无序的，用 Bitset 合并）；</li>
<li>稀疏结果集的合并（如匹配文档数少于 100 条，直接逐元素比较更高效）。</li>
</ul>
<h2 data-id="heading-13">五、跳表的底层设计：为什么能 “跳” 得快？</h2>
<ol>
<li><strong>分层索引</strong>：跳表的索引层是随机生成的（每层索引的元素间隔随机），但整体遵循 “上层间隔大，下层间隔小” 的规则，确保快速定位；</li>
<li><strong>平衡结构</strong>：ES 中的跳表会动态调整索引层，避免出现 “某一层索引间隔过小” 的情况，保证查询效率稳定；</li>
<li><strong>内存友好</strong>：跳表的索引层仅存储少量关键元素的指针，内存占用远低于 Bitset（无需初始化全量位图）。</li>
</ol>
<h2 data-id="heading-14">六、总结：跳表是有序合并的 “性能天花板”</h2>
<p>跳表的核心逻辑的是 “<strong>用空间换时间</strong>”—— 通过增加少量索引层，换来了有序列表合并的指数级速度提升。在 ES 中，它是文本类型多条件查询的 “性能基石”，也是为什么文本查询的多条件合并比数值查询更快的关键原因之一。</p>
<p>简单记：<strong>有序用跳表，无序用 Bitset</strong>—— 这是 ES 结果合并的黄金法则。理解了这一点，你就能明白为什么有些查询需要优化字段类型（如将数值类型转为 keyword 类型，利用跳表合并提升性能），也能更精准地定位多条件查询的性能瓶颈。</p>
<p>编辑分享</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[搞懂作用域链与闭包：JS底层逻辑变简单]]></title>    <link>https://juejin.cn/post/7577905525997748265</link>    <guid>https://juejin.cn/post/7577905525997748265</guid>    <pubDate>2025-11-30T09:39:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577905525997748265" data-draft-id="7577970969395249193" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="搞懂作用域链与闭包：JS底层逻辑变简单"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2025-11-30T09:39:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="闲云ing"/> <meta itemprop="url" content="https://juejin.cn/user/2974655942502250"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            搞懂作用域链与闭包：JS底层逻辑变简单
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2974655942502250/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    闲云ing
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T09:39:03.000Z" title="Sun Nov 30 2025 09:39:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">JS底层小揭秘：作用域链与闭包，代码+图解一看就懂</h2>
<p>在 JavaScript 的学习过程中，理解其底层运行机制是进阶的关键，而作用域链和闭包更是其中的核心概念。，很多人只停留在“会用”，没搞懂底层逻辑。本文结合<strong>代码+调用栈图解</strong>，从V8引擎的运行机制出发，拆解这两个概念的本质，帮你从底层视角搞懂 JS 的执行规则。</p>
<h3 data-id="heading-1">一、先搭好JS底层的基础框架</h3>
<p>JS代码能运行，依赖V8引擎的三个核心模块：</p>
<ol>
<li><strong>调用栈</strong>：分<strong>编译阶段</strong>（处理变量/函数提升）和<strong>执行阶段</strong>（创建执行上下文并压入栈，执行完弹出）；</li>
<li><strong>执行上下文</strong>：全局执行上下文（始终在栈底）+ 函数执行上下文（函数调用时创建）；</li>
<li><strong>作用域</strong>：定义变量的查找范围和生命周期，包含<code>let/const</code>的<strong>块级作用域</strong>（依托栈结构的词法环境），以及<code>var</code>的<strong>变量提升</strong>特性。</li>
</ol>
<h3 data-id="heading-2">二、作用域链：静态的变量查找路径</h3>
<p>作用域链（词法作用域链）的核心是：<strong>它由函数声明的位置决定，编译阶段就固定了，和调用顺序无关</strong>。</p>
<h4 data-id="heading-3">案例1：为什么<code>bar</code>里的<code>myName</code>取全局值？</h4>
<p>对应代码与图示：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">bar</span>(<span class="hljs-params"/>){
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(myName); <span class="hljs-comment">// 输出“极客时间”</span>
}
<span class="hljs-keyword">function</span> <span class="hljs-title function_">foo</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">var</span> myName = <span class="hljs-string">'极客邦'</span>
  <span class="hljs-title function_">bar</span>() <span class="hljs-comment">// 在foo内部调用bar</span>
}
<span class="hljs-keyword">var</span> myName = <span class="hljs-string">'极客时间'</span>
<span class="hljs-title function_">foo</span>();
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/35b0eb64c6eb497fb55469050d74c6ce~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zey5LqRaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765100597&amp;x-signature=Ue%2Boyi90WYwLlQ8bBQdNwy0j1uc%3D" alt="1.jpg" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d9f7ed7d57e446c39ade479e05107da2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zey5LqRaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765100597&amp;x-signature=DSj6EvkEUnvp4YnzcYF9nNUkSWY%3D" alt="2.jpg" loading="lazy"/></p>
<h5 data-id="heading-4">运行逻辑拆解：</h5>
<ol>
<li>
<p>编译阶段：<code>bar</code>和<code>foo</code>被声明在<strong>全局作用域</strong>，因此它们的作用域链默认“自身→全局”；</p>
</li>
<li>
<p>执行阶段：</p>
<ol>
<li><code>foo</code>调用时，创建<code>foo</code>执行上下文（变量环境包含<code>myName="极客邦"</code>）并压入栈；</li>
<li><code>foo</code>内部调用<code>bar</code>，创建<code>bar</code>执行上下文并压入栈；</li>
<li><code>bar</code>中查找<code>myName</code>：自身变量环境无→通过<code>outer</code>指向的全局执行上下文查找→取全局的<code>"极客时间"</code>。</li>
</ol>
</li>
</ol>
<h4 data-id="heading-5">案例2：块级作用域下的变量查找</h4>
<p>对应代码与图示：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">bar</span> () {
  <span class="hljs-keyword">var</span> myName = <span class="hljs-string">'极客世界'</span>;
  <span class="hljs-keyword">let</span> test1 = <span class="hljs-number">100</span>;
  <span class="hljs-keyword">if</span> (<span class="hljs-number">1</span>) {
    <span class="hljs-keyword">let</span> myName = <span class="hljs-string">"Chrome 浏览器"</span>;
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(test); 
  }
}
<span class="hljs-keyword">function</span> <span class="hljs-title function_">foo</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">var</span> myName = <span class="hljs-string">'极客邦'</span>;
  <span class="hljs-keyword">let</span> test = <span class="hljs-number">2</span>;
  {
    <span class="hljs-keyword">let</span> test = <span class="hljs-number">3</span>;
    <span class="hljs-title function_">bar</span>();
  }
}
<span class="hljs-keyword">var</span> myName = <span class="hljs-string">'极客时间'</span>;
<span class="hljs-keyword">let</span> myAge = <span class="hljs-number">10</span>;
<span class="hljs-keyword">let</span> test = <span class="hljs-number">1</span>;
<span class="hljs-title function_">foo</span>();
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9abe999baaa24e31916d4ae23ab8e905~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zey5LqRaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765100597&amp;x-signature=aB2ea4FhcUOMLVf%2Fsi9WJQIMBCM%3D" alt="3.jpg" loading="lazy"/></p>
<h5 data-id="heading-6">查找过程：</h5>
<ol>
<li><code>bar</code>内部<code>if</code>块的<code>console.log(test)</code>，先查<strong>自身块级词法环境</strong>（只有<code>myName="Chrome 浏览器"</code>）→ 没找到；</li>
<li>查<code>bar</code>函数的词法环境（有<code>test1=100</code>）→ 没找到；</li>
<li>查<code>bar</code>的变量环境（有<code>myName="极客世界"</code>）→ 没找到；</li>
<li>查全局执行上下文的词法环境（有<code>test=1</code>）→ 但由于<code>bar</code>的作用域链是“自身块级→bar函数→全局”，运行中会输出<code>1</code>。</li>
</ol>
<h3 data-id="heading-7">三、闭包：函数“背着”变量的专属背包</h3>
<p>闭包是词法作用域的延伸——<strong>外部函数执行后，其内部变量被嵌套函数引用，因此不会被垃圾回收，形成一个“变量背包”供嵌套函数使用</strong>。</p>
<h4 data-id="heading-8">案例：闭包的形成与运行</h4>
<p>对应代码与图示：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">foo</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">var</span> myName = <span class="hljs-string">'极客时间'</span>
  <span class="hljs-keyword">let</span> test1 = <span class="hljs-number">1</span>
  <span class="hljs-keyword">const</span> test2 = <span class="hljs-number">2</span>
  <span class="hljs-keyword">var</span> innerBar = {
    <span class="hljs-attr">getName</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(test1) <span class="hljs-comment">// 输出1</span>
      <span class="hljs-keyword">return</span> myName
    },
    <span class="hljs-attr">setName</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params">newName</span>) {
      myName = newName <span class="hljs-comment">// 修改foo内部的myName</span>
    }
  }
  <span class="hljs-keyword">return</span> innerBar
}

<span class="hljs-keyword">var</span> bar = <span class="hljs-title function_">foo</span>() <span class="hljs-comment">// foo执行上下文出栈</span>
bar.<span class="hljs-title function_">setName</span>(<span class="hljs-string">"极客邦"</span>)
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(bar.<span class="hljs-title function_">getName</span>()); <span class="hljs-comment">// 输出1 + “极客邦”</span>
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5d6dfb65b1d14d27a779d672f5d06bb3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zey5LqRaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765100597&amp;x-signature=Z68WgOIQXKpJuaIranCHAbnuZ5o%3D" alt="5.jpg" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/de108b98d9564c8e8c0aaf7ff191081a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zey5LqRaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765100597&amp;x-signature=u84cCuLwtZWuleFVc2p7y9XCKaQ%3D" alt="6.jpg" loading="lazy"/></p>
<h5 data-id="heading-9">闭包运行流程：</h5>
<ol>
<li>
<p><strong>foo执行时</strong>：创建执行上下文，变量环境存储<code>myName="极客时间"</code>，词法环境存储<code>test1=1</code>、<code>test2=2</code>，并压入栈；</p>
</li>
<li>
<p><strong>foo返回innerBar后</strong>：foo执行上下文出栈，但<code>getName</code>/<code>setName</code>引用了<code>myName</code>和<code>test1</code>，这两个变量被保留在内存中（形成闭包，即“专属背包”）；</p>
</li>
<li>
<p><strong>调用bar.setName/getName时</strong>：</p>
<ol>
<li><code>setName</code>执行时，通过闭包找到<code>myName</code>并修改为<code>"极客邦"</code>；</li>
<li><code>getName</code>执行时，通过闭包找到<code>test1</code>并输出<code>1</code>，同时返回修改后的<code>myName</code>。</li>
</ol>
</li>
</ol>
<h3 data-id="heading-10">四、核心总结</h3>
<ol>
<li><strong>作用域链是静态的</strong>：由函数声明位置决定，编译阶段固定，和调用顺序无关；</li>
<li><strong>闭包是词法作用域的延伸</strong>：嵌套函数引用外部函数变量，导致外部函数变量不被回收，形成“变量背包”；</li>
<li><strong>底层逻辑的关键</strong>：理解调用栈、执行上下文、作用域的关系，是搞懂JS变量查找和内存管理的基础。</li>
</ol>
<p>JavaScript 的底层运行机制中，词法作用域是基础，它决定了作用域链的静态查找规则，而闭包则是词法作用域的延伸，通过保留自由变量实现了函数对外部作用域的持久访问。理解这些概念，不仅能帮助我们写出更符合 JS 运行逻辑的代码，还能解决实际开发中变量作用域、内存泄漏等常见问题。掌握作用域链与闭包，是深入理解 JavaScript 语言特性的重要一步。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[el-button源码解读3——:class="buttonKls"与颜色系统的关系]]></title>    <link>https://juejin.cn/post/7577971299743055910</link>    <guid>https://juejin.cn/post/7577971299743055910</guid>    <pubDate>2025-11-30T09:44:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577971299743055910" data-draft-id="7577718777482280998" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="el-button源码解读3——:class=&quot;buttonKls&quot;与颜色系统的关系"/> <meta itemprop="keywords" content="SCSS,Element"/> <meta itemprop="datePublished" content="2025-11-30T09:44:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Joie"/> <meta itemprop="url" content="https://juejin.cn/user/3265984436383947"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            el-button源码解读3——:class="buttonKls"与颜色系统的关系
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3265984436383947/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Joie
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T09:44:10.000Z" title="Sun Nov 30 2025 09:44:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>说明 <code>:class="buttonKls"</code> 与颜色系统的关系：</p>
<h3 data-id="heading-0">1. <code>buttonKls</code> 的作用</h3>
<p><code>buttonKls</code> 是一个计算属性，生成按钮需要的所有 CSS 类名：</p>
<pre><code class="hljs language-68:81:packages/components/button/src/button.vue" lang="68:81:packages/components/button/src/button.vue">const buttonKls = computed(() =&gt; [
  // el-button
  ns.b(),
  ns.m(_type.value),
  ns.m(_size.value),
  ns.is('disabled', _disabled.value),
  ns.is('loading', props.loading),
  ns.is('plain', _plain.value),
  ns.is('round', _round.value),
  ns.is('circle', props.circle),
  ns.is('text', _text.value),
  ns.is('link', props.link),
  ns.is('has-bg', props.bg),
])
</code></pre>
<p>假设 <code>type="primary"</code>，<code>buttonKls</code> 可能包含：</p>
<pre><code class="hljs language-js" lang="js">[<span class="hljs-string">'el-button'</span>, <span class="hljs-string">'el-button--primary'</span>, <span class="hljs-string">'el-button--small'</span>, <span class="hljs-string">'is-loading'</span>, ...]
</code></pre>
<h3 data-id="heading-1">2. 颜色系统的触发机制</h3>
<p>颜色系统通过 CSS 类选择器触发。当 <code>buttonKls</code> 包含 <code>'el-button--primary'</code> 时，会匹配到对应的 CSS 规则。</p>
<h3 data-id="heading-2">3. 完整的关系链</h3>
<pre><code class="hljs language-ini" lang="ini">用户使用: &lt;el-button <span class="hljs-attr">type</span>=<span class="hljs-string">"primary"</span>&gt;
    ↓
<span class="hljs-attr">props.type</span> = <span class="hljs-string">'primary'</span>
    ↓
<span class="hljs-attr">_type.value</span> = <span class="hljs-string">'primary'</span>
    ↓
<span class="hljs-attr">buttonKls</span> = [<span class="hljs-string">'el-button'</span>, <span class="hljs-string">'el-button--primary'</span>, ...]
    ↓
:<span class="hljs-attr">class</span>=<span class="hljs-string">"buttonKls"</span>  →  class=<span class="hljs-string">"el-button el-button--primary"</span>
    ↓
CSS 匹配: .el-button--primary { ... }
    ↓
button-variant('primary') 生成 CSS 变量
    ↓
应用颜色样式
</code></pre>
<h3 data-id="heading-3">4. 在 CSS 中的对应关系</h3>
<p>看 <code>button.scss</code> 中的定义：</p>
<pre><code class="hljs language-271:275:packages/theme-chalk/src/button.scss" lang="271:275:packages/theme-chalk/src/button.scss">  @each $type in (primary, success, warning, danger, info) {
    @include m($type) {
      @include button-variant($type);
    }
  }
</code></pre>
<p>当 <code>$type = 'primary'</code> 时：</p>
<ul>
<li><code>@include m('primary')</code> → 生成 <code>.el-button--primary</code> 选择器</li>
<li><code>@include button-variant('primary')</code> → 生成颜色相关的 CSS 变量</li>
</ul>
<h3 data-id="heading-4">5. 实际渲染过程</h3>
<h4 data-id="heading-5">步骤 1：Vue 组件生成类名</h4>
<pre><code class="hljs language-vue" lang="vue">&lt;el-button type="primary"&gt;按钮&lt;/el-button&gt;
</code></pre>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// buttonKls 计算后</span>
[<span class="hljs-string">'el-button'</span>, <span class="hljs-string">'el-button--primary'</span>]
</code></pre>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- 最终渲染 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"el-button el-button--primary"</span>&gt;</span>
  按钮
<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
</code></pre>
<h4 data-id="heading-6">步骤 2：CSS 匹配类名</h4>
<p>浏览器看到 <code>class="el-button--primary"</code>，匹配到：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// button.scss 中生成的</span>
<span class="hljs-selector-class">.el-button--primary</span> {
  <span class="hljs-comment">// button-variant('primary') 生成的 CSS 变量</span>
  <span class="hljs-attr">--el-button-bg-color</span>: <span class="hljs-built_in">var</span>(--el-color-primary);
  <span class="hljs-attr">--el-button-border-color</span>: <span class="hljs-built_in">var</span>(--el-color-primary);
  <span class="hljs-attr">--el-button-text-color</span>: <span class="hljs-built_in">var</span>(--el-color-white);
  <span class="hljs-attr">--el-button-hover-bg-color</span>: <span class="hljs-built_in">var</span>(--el-color-primary-light-<span class="hljs-number">3</span>);
  <span class="hljs-attr">--el-button-active-bg-color</span>: <span class="hljs-built_in">var</span>(--el-color-primary-dark-<span class="hljs-number">2</span>);
}
</code></pre>
<h4 data-id="heading-7">步骤 3：应用颜色</h4>
<p>基础样式使用这些 CSS 变量：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-selector-class">.el-button</span> {
  <span class="hljs-attribute">background-color</span>: <span class="hljs-built_in">var</span>(--el-button-bg-color);
  <span class="hljs-attribute">border-color</span>: <span class="hljs-built_in">var</span>(--el-button-border-color);
  <span class="hljs-attribute">color</span>: <span class="hljs-built_in">var</span>(--el-button-text-color);
}
</code></pre>
<p>因为 <code>.el-button--primary</code> 定义了这些变量，所以按钮会显示 primary 的颜色。</p>
<h3 data-id="heading-8">6. 关键理解</h3>
<p><code>:class="buttonKls"</code> 是连接 Vue 组件和 CSS 颜色系统的桥梁：</p>
<pre><code class="hljs language-css" lang="css">Vue 组件层面          CSS 样式层面
─────────────────────────────────
buttonKls            <span class="hljs-selector-class">.el-button--primary</span>
  ↓                       ↓
'el-<span class="hljs-selector-tag">button</span><span class="hljs-attr">--primary</span>'  →  匹配 CSS 选择器
  ↓                       ↓
应用类名              应用颜色样式
</code></pre>
<h3 data-id="heading-9">7. 不同类型的关系</h3>



































<table><thead><tr><th>用户传入</th><th>buttonKls 包含</th><th>CSS 匹配</th><th>颜色应用</th></tr></thead><tbody><tr><td><code>type="primary"</code></td><td><code>'el-button--primary'</code></td><td><code>.el-button--primary</code></td><td>蓝色 (#409eff)</td></tr><tr><td><code>type="success"</code></td><td><code>'el-button--success'</code></td><td><code>.el-button--success</code></td><td>绿色 (#67c23a)</td></tr><tr><td><code>type="warning"</code></td><td><code>'el-button--warning'</code></td><td><code>.el-button--warning</code></td><td>橙色 (#e6a23c)</td></tr><tr><td><code>type="danger"</code></td><td><code>'el-button--danger'</code></td><td><code>.el-button--danger</code></td><td>红色 (#f56c6c)</td></tr></tbody></table>
<h3 data-id="heading-10">8. 完整示例</h3>
<pre><code class="hljs language-vue" lang="vue">&lt;el-button type="primary" size="small" :loading="true"&gt;
  提交
&lt;/el-button&gt;
</code></pre>
<p>生成的类名：</p>
<pre><code class="hljs language-js" lang="js">buttonKls = [
  <span class="hljs-string">'el-button'</span>,           <span class="hljs-comment">// 基础类</span>
  <span class="hljs-string">'el-button--primary'</span>,  <span class="hljs-comment">// 类型类（触发颜色系统）</span>
  <span class="hljs-string">'el-button--small'</span>,    <span class="hljs-comment">// 尺寸类</span>
  <span class="hljs-string">'is-loading'</span>           <span class="hljs-comment">// 状态类</span>
]
</code></pre>
<p>最终 HTML：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"el-button el-button--primary el-button--small is-loading"</span>&gt;</span>
  提交
<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
</code></pre>
<p>CSS 匹配：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-selector-class">.el-button--primary</span> {  <span class="hljs-comment">// ← 这个类触发了颜色系统</span>
  <span class="hljs-attr">--el-button-bg-color</span>: <span class="hljs-built_in">var</span>(--el-color-primary);
  <span class="hljs-comment">// ...</span>
}
</code></pre>
<h3 data-id="heading-11">9. 总结</h3>
<ul>
<li><code>:class="buttonKls"</code> 生成类名（如 <code>el-button--primary</code>）</li>
<li>CSS 通过类选择器匹配这些类名</li>
<li>匹配到的规则通过 <code>button-variant</code> 生成颜色变量</li>
<li>基础样式使用这些变量，最终显示对应颜色</li>
</ul>
<p><strong>核心关系</strong>：<code>buttonKls</code> 中的类型类名（如 <code>el-button--primary</code>）是触发颜色系统的开关，CSS 通过这个类名应用对应的颜色样式。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[swift的inout的用法]]></title>    <link>https://juejin.cn/post/7577971299743137830</link>    <guid>https://juejin.cn/post/7577971299743137830</guid>    <pubDate>2025-11-30T10:01:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577971299743137830" data-draft-id="7577971299743105062" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="swift的inout的用法"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-30T10:01:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户01026927186"/> <meta itemprop="url" content="https://juejin.cn/user/4469936047271547"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            swift的inout的用法
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4469936047271547/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户01026927186
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T10:01:49.000Z" title="Sun Nov 30 2025 10:01:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    9
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>基础用法</strong>、<strong>底层原理</strong>、<strong>高级特性</strong>和<strong>注意事项</strong>四个方面详细讲解。</p>
<h3 data-id="heading-0">1. 基础概念：为什么要用 inout？</h3>
<p>在 Swift 中，函数的参数默认是<strong>常量（Constant/let）</strong> 。这意味着你不能在函数内部修改参数的值。</p>
<p><strong>错误示例：</strong></p>
<pre><code class="hljs language-Swift" lang="Swift"><span class="hljs-keyword">func</span> <span class="hljs-title function_">doubleValue</span>(<span class="hljs-params">value</span>: <span class="hljs-type">Int</span>) {
    value <span class="hljs-operator">*=</span> <span class="hljs-number">2</span> <span class="hljs-comment">// ❌ 报错：Left side of mutating operator isn't mutable: 'value' is a 'let' constant</span>
}
</code></pre>
<p>如果你希望函数能修改外部传进来的变量，就需要使用 <code>inout</code>。</p>
<p><strong>正确示例：</strong></p>
<pre><code class="hljs language-Swift" lang="Swift"><span class="hljs-keyword">func</span> <span class="hljs-title function_">doubleValue</span>(<span class="hljs-params">value</span>: <span class="hljs-keyword">inout</span> <span class="hljs-type">Int</span>) {
    value <span class="hljs-operator">*=</span> <span class="hljs-number">2</span>
}

<span class="hljs-keyword">var</span> myNumber <span class="hljs-operator">=</span> <span class="hljs-number">10</span>
<span class="hljs-comment">// 调用时必须在变量前加 '&amp;' 符号，显式表明这个值会被修改</span>
doubleValue(value: <span class="hljs-operator">&amp;</span>myNumber) 

<span class="hljs-built_in">print</span>(myNumber) <span class="hljs-comment">// 输出：20</span>
</code></pre>
<hr/>
<h3 data-id="heading-1">2. 核心原理：输入输出模型 (Copy-In Copy-Out)</h3>
<p>这是面试或深入理解时最重要的部分。虽然 <code>inout</code> 看起来像“引用传递”，但 Swift 官方将其描述为 <strong>Copy-In Copy-Out（输入复制，输出复制）</strong> ，也就是“值结果模式（Call by Value Result）”。</p>
<p><strong>完整过程如下：</strong></p>
<ol>
<li><strong>Copy In（输入复制）：</strong> 当函数被调用时，参数的值被<strong>复制</strong>一份传入函数内部。</li>
<li><strong>Modification（修改）：</strong> 函数内部修改的是这个<strong>副本</strong>。</li>
<li><strong>Copy Out（输出复制）：</strong> 当函数返回时，修改后的副本值被**赋值（写回）**给原本的变量。</li>
</ol>
<p><strong>底层优化：</strong></p>
<ul>
<li><strong>对于物理内存中的变量</strong>：编译器通常会进行优化，直接传递内存地址（也就是真正的引用传递），避免不必要的复制开销。</li>
<li><strong>对于计算属性（Computed Properties）</strong> ：必须严格执行 Copy-In Copy-Out 流程（因为计算属性没有物理内存地址，只有 getter 和 setter）。</li>
</ul>
<p><strong>代码证明（计算属性也能用 inout）：</strong></p>
<pre><code class="hljs language-Swift" lang="Swift"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Rect</span> {
    <span class="hljs-keyword">var</span> width <span class="hljs-operator">=</span> <span class="hljs-number">0</span>
    <span class="hljs-keyword">var</span> height <span class="hljs-operator">=</span> <span class="hljs-number">0</span>
    
    <span class="hljs-comment">// 计算属性：面积</span>
    <span class="hljs-keyword">var</span> area: <span class="hljs-type">Int</span> {
        <span class="hljs-keyword">get</span> { width <span class="hljs-operator">*</span> height }
        <span class="hljs-keyword">set</span> { 
            <span class="hljs-comment">// 简单逻辑：假设保持 width 不变，调整 height</span>
            height <span class="hljs-operator">=</span> newValue <span class="hljs-operator">/</span> width 
        }
    }
}

<span class="hljs-keyword">func</span> <span class="hljs-title function_">triple</span>(<span class="hljs-params">number</span>: <span class="hljs-keyword">inout</span> <span class="hljs-type">Int</span>) {
    number <span class="hljs-operator">*=</span> <span class="hljs-number">3</span>
}

<span class="hljs-keyword">var</span> square <span class="hljs-operator">=</span> <span class="hljs-type">Rect</span>(width: <span class="hljs-number">10</span>, height: <span class="hljs-number">10</span>) <span class="hljs-comment">// area = 100</span>

<span class="hljs-comment">// 这里传入的是计算属性 area</span>
<span class="hljs-comment">// 流程：</span>
<span class="hljs-comment">// 1. 调用 area 的 get，得到 100，Copy In 给 triple</span>
<span class="hljs-comment">// 2. triple 将 100 * 3 = 300</span>
<span class="hljs-comment">// 3. 函数结束，将 300 Copy Out，调用 area 的 set(300)</span>
triple(number: <span class="hljs-operator">&amp;</span>square.area)

<span class="hljs-built_in">print</span>(square.height) <span class="hljs-comment">// 输出：30 (因为 300 / 10 = 30)</span>
</code></pre>
<hr/>
<h3 data-id="heading-2">3. <code>inout</code> 的常见应用场景</h3>
<h4 data-id="heading-3">A. 交换值 (Standard Swap)</h4>
<p>Swift 标准库的 <code>swap</code> 就是用 <code>inout</code> 实现的。</p>
<pre><code class="hljs language-Swift" lang="Swift"><span class="hljs-keyword">func</span> <span class="hljs-title function_">mySwap</span>&lt;<span class="hljs-type">T</span>&gt;(<span class="hljs-keyword">_</span> <span class="hljs-params">a</span>: <span class="hljs-keyword">inout</span> <span class="hljs-type">T</span>, <span class="hljs-keyword">_</span> <span class="hljs-params">b</span>: <span class="hljs-keyword">inout</span> <span class="hljs-type">T</span>) {
    <span class="hljs-keyword">let</span> temp <span class="hljs-operator">=</span> a
    a <span class="hljs-operator">=</span> b
    b <span class="hljs-operator">=</span> temp
}

<span class="hljs-keyword">var</span> x <span class="hljs-operator">=</span> <span class="hljs-number">1</span>
<span class="hljs-keyword">var</span> y <span class="hljs-operator">=</span> <span class="hljs-number">2</span>
mySwap(<span class="hljs-operator">&amp;</span>x, <span class="hljs-operator">&amp;</span>y)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"x: (x), y: (y)"</span>) <span class="hljs-comment">// x: 2, y: 1</span>
</code></pre>
<h4 data-id="heading-4">B. 修改复杂的结构体 (Mutating Structs)</h4>
<p>当结构体嵌套很深时，使用 <code>inout</code> 可以避免冗长的赋值代码。</p>
<pre><code class="hljs language-Swift" lang="Swift"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Color</span> {
    <span class="hljs-keyword">var</span> r: <span class="hljs-type">Int</span>, g: <span class="hljs-type">Int</span>, b: <span class="hljs-type">Int</span>
}

<span class="hljs-keyword">struct</span> <span class="hljs-title class_">Settings</span> {
    <span class="hljs-keyword">var</span> themeColor: <span class="hljs-type">Color</span>
}

<span class="hljs-keyword">var</span> appSettings <span class="hljs-operator">=</span> <span class="hljs-type">Settings</span>(themeColor: <span class="hljs-type">Color</span>(r: <span class="hljs-number">0</span>, g: <span class="hljs-number">0</span>, b: <span class="hljs-number">0</span>))

<span class="hljs-comment">// 能够直接修改嵌套深处的属性</span>
<span class="hljs-keyword">func</span> <span class="hljs-title function_">updateBlueComponent</span>(<span class="hljs-params">color</span>: <span class="hljs-keyword">inout</span> <span class="hljs-type">Color</span>) {
    color.b <span class="hljs-operator">=</span> <span class="hljs-number">255</span>
}

<span class="hljs-comment">// 传入路径</span>
updateBlueComponent(color: <span class="hljs-operator">&amp;</span>appSettings.themeColor)

<span class="hljs-built_in">print</span>(appSettings.themeColor.b) <span class="hljs-comment">// 255</span>
</code></pre>
<hr/>
<h3 data-id="heading-5">4. 关键规则与内存安全 (Memory Safety)</h3>
<p>这是 Swift 相比 C++ 指针更先进的地方。Swift 编译器会强制执行<strong>独占访问权限（Law of Exclusivity）</strong> ，防止内存冲突。</p>
<h4 data-id="heading-6">规则 1：同一个变量不能同时作为两个 <code>inout</code> 参数传递</h4>
<p>如果两个 <code>inout</code> 参数指向同一个变量，会发生“别名（Aliasing）”问题，导致行为不可预测。</p>
<pre><code class="hljs language-Swift" lang="Swift"><span class="hljs-keyword">var</span> step <span class="hljs-operator">=</span> <span class="hljs-number">1</span>

<span class="hljs-keyword">func</span> <span class="hljs-title function_">increment</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">number</span>: <span class="hljs-keyword">inout</span> <span class="hljs-type">Int</span>, <span class="hljs-params">by</span> <span class="hljs-params">amount</span>: <span class="hljs-keyword">inout</span> <span class="hljs-type">Int</span>) {
    number <span class="hljs-operator">+=</span> amount
}

<span class="hljs-comment">// ❌ 运行时崩溃或编译错误：Simultaneous accesses to 0x...</span>
<span class="hljs-comment">// increment(&amp;step, by: &amp;step) </span>
</code></pre>
<h4 data-id="heading-7">规则 2：不能将 <code>let</code> 常量或字面量作为 <code>inout</code> 参数</h4>
<p>因为它们本质上不可写。</p>
<p>Swift</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">func</span> <span class="hljs-title function_">change</span>(<span class="hljs-params">val</span>: <span class="hljs-keyword">inout</span> <span class="hljs-type">Int</span>) {}

<span class="hljs-comment">// change(val: &amp;5) // ❌ 错误：字面量不可变</span>
<span class="hljs-keyword">let</span> num <span class="hljs-operator">=</span> <span class="hljs-number">10</span>
<span class="hljs-comment">// change(val: &amp;num) // ❌ 错误：常量不可变</span>
</code></pre>
<h4 data-id="heading-8">规则 3：inout 参数在闭包中的捕获（Capture）</h4>
<p><code>inout</code> 参数在逃逸闭包（Escaping Closure）中是不能被捕获的，因为逃逸闭包可能在函数返回后才执行，而那时 <code>inout</code> 的生命周期（Copy-In Copy-Out 过程）已经结束了。</p>
<pre><code class="hljs language-Swift" lang="Swift"><span class="hljs-keyword">func</span> <span class="hljs-title function_">performAsync</span>(<span class="hljs-params">action</span>: <span class="hljs-keyword">@escaping</span> () -&gt; <span class="hljs-type">Void</span>) {
    <span class="hljs-comment">// 异步执行...</span>
}

<span class="hljs-keyword">func</span> <span class="hljs-title function_">badFunction</span>(<span class="hljs-params">x</span>: <span class="hljs-keyword">inout</span> <span class="hljs-type">Int</span>) {
    <span class="hljs-comment">// ❌ 错误：Escaping closure captures 'inout' parameter 'x'</span>
    <span class="hljs-comment">/*
    performAsync {
        x += 1 
    }
    */</span>
}
</code></pre>
<p><em>解决办法：</em> 使用非逃逸闭包，或者显式地捕获变量的副本（如果逻辑允许）。</p>
<hr/>
<h3 data-id="heading-9">5. <code>inout</code> vs 类 (Reference Types)</h3>
<p>这是一个常见的误区： <strong>“类本来就是引用类型，还需要 <code>inout</code> 吗？”</strong></p>
<ul>
<li><strong>不需要 <code>inout</code>：</strong> 如果你只想修改类实例内部的属性。</li>
<li><strong>需要 <code>inout</code>：</strong> 如果你想<strong>替换</strong>掉整个类实例本身（即改变指针的指向）。</li>
</ul>
<p><strong>代码对比：</strong></p>
<pre><code class="hljs language-Swift" lang="Swift"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Hero</span> {
    <span class="hljs-keyword">var</span> name: <span class="hljs-type">String</span>
    <span class="hljs-keyword">init</span>(<span class="hljs-params">name</span>: <span class="hljs-type">String</span>) { <span class="hljs-keyword">self</span>.name <span class="hljs-operator">=</span> name }
}

<span class="hljs-comment">// 情况 1：修改内部属性（不需要 inout）</span>
<span class="hljs-keyword">func</span> <span class="hljs-title function_">renameHero</span>(<span class="hljs-params">hero</span>: <span class="hljs-type">Hero</span>) {
    hero.name <span class="hljs-operator">=</span> <span class="hljs-string">"Batman"</span> <span class="hljs-comment">// 合法，因为 hero 引用本身没变，变的是堆内存里的数据</span>
}

<span class="hljs-keyword">var</span> h1 <span class="hljs-operator">=</span> <span class="hljs-type">Hero</span>(name: <span class="hljs-string">"Superman"</span>)
renameHero(hero: h1)
<span class="hljs-built_in">print</span>(h1.name) <span class="hljs-comment">// Batman</span>

<span class="hljs-comment">// 情况 2：替换整个实例（需要 inout）</span>
<span class="hljs-keyword">func</span> <span class="hljs-title function_">switchHero</span>(<span class="hljs-params">hero</span>: <span class="hljs-keyword">inout</span> <span class="hljs-type">Hero</span>) {
    hero <span class="hljs-operator">=</span> <span class="hljs-type">Hero</span>(name: <span class="hljs-string">"Iron Man"</span>) <span class="hljs-comment">// 将外部变量指向全新的内存地址</span>
}

<span class="hljs-keyword">var</span> h2 <span class="hljs-operator">=</span> <span class="hljs-type">Hero</span>(name: <span class="hljs-string">"Spiderman"</span>)
switchHero(hero: <span class="hljs-operator">&amp;</span>h2)
<span class="hljs-built_in">print</span>(h2.name) <span class="hljs-comment">// Iron Man</span>
</code></pre>
<h3 data-id="heading-10">总结</h3>
<ol>
<li><strong>语法：</strong> 定义用 <code>inout</code>，调用用 <code>&amp;</code>。</li>
<li><strong>本质：</strong> Copy-In Copy-Out（值结果模式），但在物理内存操作上通常优化为引用传递。</li>
<li><strong>使用场景：</strong> 需要在函数内部修改外部值类型（Struct/Enum）状态，或交换数据。</li>
<li><strong>限制：</strong> 遵守独占访问原则（Exclusivity），不可在逃逸闭包中捕获。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JavaScript新手必看系列之预编译]]></title>    <link>https://juejin.cn/post/7577737385955262474</link>    <guid>https://juejin.cn/post/7577737385955262474</guid>    <pubDate>2025-11-30T10:14:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577737385955262474" data-draft-id="7577718777482117158" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JavaScript新手必看系列之预编译"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2025-11-30T10:14:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="甜味弥漫"/> <meta itemprop="url" content="https://juejin.cn/user/3335233742615115"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JavaScript新手必看系列之预编译
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3335233742615115/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    甜味弥漫
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T10:14:54.000Z" title="Sun Nov 30 2025 10:14:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h5 data-id="heading-0">前言</h5>
<p>预编译是JavaScript的核心概念，也是新手向中级进阶的必经之路。理解它，意味着你能：</p>
<ul>
<li>彻底搞懂变量提升</li>
<li>理解函数声明的“特权”</li>
<li>避免常见的作用域陷阱</li>
</ul>
<p>本文用最简单的语言和示例，带你快速掌握全局预编译与函数预编译的完整过程。</p>
<h5 data-id="heading-1">What's that?</h5>
<p>简单说，JS在执行代码前会进行“准备工作” ——
预编译。在这个阶段JS的V8引擎会进行<em>变量声明，函数声明</em>的提升</p>
<h2 data-id="heading-2">预编译的两种场景</h2>
<h3 data-id="heading-3">1. 全局作用域下的预编译</h3>
<p>分三步：</p>
<p>1.创建
GO（Global Object）</p>
<ul>
<li>
<p>在浏览器中就是
window
对象</p>
</li>
<li>
<p>在
Node.js
中就是
global
对象</p>
</li>
</ul>
<p>2.找到变量声明，作为作为GO属性名，值为undefined</p>
<ol start="3">
<li>
<p>找到函数声明，作为GO属性名，值为函数体</p>
</li>
</ol>
<p>举个简单的例子：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(a) <span class="hljs-comment">// undefined</span>
<span class="hljs-keyword">var</span> a = <span class="hljs-number">1</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(a) <span class="hljs-comment">// 1</span>

</code></pre>
<p>发什么了什么？</p>
<ol>
<li>创建 GO ={}</li>
<li>找到变量声明 var  a  ,GO = { a : undefined }</li>
<li>找函数声明，没有函数声明就不找</li>
</ol>
<p>执行过程如下：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">//预编译后就相当于：</span>
<span class="hljs-keyword">var</span> a = <span class="hljs-literal">undefined</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(a) <span class="hljs-comment">//输出 undefined</span>
  a = <span class="hljs-number">1</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(a) <span class="hljs-comment">//输出 1</span>
</code></pre>
<h3 data-id="heading-4">2.函数作用域下的预编译</h3>
<p>函数较为复杂，四步：</p>
<ol>
<li>
<p>创建AO（Activation Object）</p>
</li>
<li>
<p>找形参和变量声明，作为AO属性名，值为 undefined</p>
</li>
<li>
<p>将实参赋给形参</p>
</li>
<li>
<p>找函数声明，作为AO 属性名，值为函数体</p>
</li>
</ol>
<p>举例：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">fn</span>(<span class="hljs-params">a</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(a);
  <span class="hljs-keyword">var</span> a = <span class="hljs-number">123</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(a);
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">a</span>(<span class="hljs-params"/>) {}
  <span class="hljs-keyword">var</span> b = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {}
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(b);
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">c</span>(<span class="hljs-params"/>) {}
  <span class="hljs-keyword">var</span> c = a
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(c);
}
<span class="hljs-title function_">fn</span>(<span class="hljs-number">1</span>)
</code></pre>
<p>干了什么？</p>
<ol>
<li>创建AO = {</li>
</ol>
<p>2.找形参和变量声明，作为AO属性名，值为 undefined</p>
<p>AO = { a : undefined<br/>
b : undefined<br/>
c : undefined }</p>
<p>3.将实参赋给形参</p>
<p>AO = { a : 1
b : undefined<br/>
c : undefined
}</p>
<p>4.找函数声明，作为AO 属性名，值为函数体</p>
<p>AO = { a : function a() {}</p>
<p>b : undefined<br/>
c : function c() {}
}</p>
<p>函数体内执行过程：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 预编译后的状态：</span>
<span class="hljs-keyword">var</span> c
<span class="hljs-keyword">var</span> b
<span class="hljs-keyword">var</span> a
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(a); <span class="hljs-comment">// function a() {}</span>
 a = <span class="hljs-number">123</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(a); <span class="hljs-comment">// 123</span>
b = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {}
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(b);  <span class="hljs-comment">//function b() {}</span>
c = a
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(c); <span class="hljs-comment">//123</span>

</code></pre>
<p>掌握了预编译，你就真正理解了 JavaScript 的执行机制，这对后续学习闭包、作用域链等概念至关重要！</p>
<p>希望这篇文章能帮助你彻底理解 JavaScript 预编译，如果有任何疑问，欢迎在评论区讨论！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【Weapp-2 /Lesson19(2025-11-04)】微信小程序“博客园”项目深度解析：从架构到细节的完整剖析📱]]></title>    <link>https://juejin.cn/post/7577681092137992227</link>    <guid>https://juejin.cn/post/7577681092137992227</guid>    <pubDate>2025-11-29T16:37:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577681092137992227" data-draft-id="7577625663257706496" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【Weapp-2 /Lesson19(2025-11-04)】微信小程序“博客园”项目深度解析：从架构到细节的完整剖析📱"/> <meta itemprop="keywords" content="微信小程序,微信,程序员"/> <meta itemprop="datePublished" content="2025-11-29T16:37:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Jing_Rainbow"/> <meta itemprop="url" content="https://juejin.cn/user/1285809519198256"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【Weapp-2 /Lesson19(2025-11-04)】微信小程序“博客园”项目深度解析：从架构到细节的完整剖析📱
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1285809519198256/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Jing_Rainbow
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-29T16:37:20.000Z" title="Sat Nov 29 2025 16:37:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    12
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>📱在当今移动互联网时代，微信小程序凭借其轻量、即用即走、无需安装等优势，成为众多开发者构建内容型应用的首选平台。本文将深入剖析一个名为 <strong>“博客园”</strong> 的微信小程序项目，全面解读其 <strong>项目结构、核心逻辑、页面设计、数据驱动机制、UI 组件使用、配置体系</strong> 以及 <strong>开发最佳实践</strong>，并结合项目中涉及的图片资源（如 <code>tb11.png</code>、<code>tb12.png</code> 等）进行系统性阐述。无论你是初学者还是有经验的开发者，都能从中获得宝贵的知识。</p>
<hr/>
<h2 data-id="heading-0">🧱 一、项目整体架构与配置体系</h2>
<h3 data-id="heading-1">1.1 全局配置文件：<code>app.json</code></h3>
<p>项目的灵魂始于 <code>app.json</code>。该文件定义了整个小程序的 <strong>页面路由、窗口样式、组件引用、sitemap 配置</strong> 等全局行为：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"pages"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-string">"pages/index/index"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-string">"pages/logs/logs"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-string">"pages/theme/theme"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-string">"pages/search/search"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-string">"pages/articles/articles"</span>
  <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"window"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"backgroundColor"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"#49b849"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"navigationBarTextStyle"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"white"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"navigationBarTitleText"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"博客园"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"navigationBarBackgroundColor"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"#49b849"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"style"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"v2"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"componentFramework"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"glass-easel"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"sitemapLocation"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"sitemap.json"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"lazyCodeLoading"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"requiredComponents"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"usingComponents"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"van-button"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"@vant/weapp/button"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"van-search"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"@vant/weapp/search"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<ul>
<li><strong><code>pages</code></strong>：声明了所有页面路径，<strong>首页必须放在第一位</strong>。</li>
<li><strong><code>window</code></strong>：统一设置导航栏背景色为绿色（<code>#49b849</code>），文字白色，标题为“博客园”，形成品牌识别。</li>
<li><strong><code>style: "v2"</code></strong>：启用新版组件样式，提升视觉一致性。</li>
<li><strong><code>componentFramework: "glass-easel"</code></strong>：使用微信新一代自研组件框架，性能更优。</li>
<li><strong><code>usingComponents</code></strong>：全局注册了 <a href="https://link.juejin.cn?target=https%3A%2F%2Fvant-contrib.gitee.io%2Fvant-weapp%2F" target="_blank" title="https://vant-contrib.gitee.io/vant-weapp/" ref="nofollow noopener noreferrer">Vant WeUI</a> 的 <code>van-button</code> 和 <code>van-search</code>，这是官方推荐的 UI 库，提供高质量、可定制的移动端组件。</li>
</ul>
<blockquote>
<p>💡 <strong>小知识</strong>：Vant WeUI 是有赞团队维护的开源组件库，专为微信小程序优化，支持按需引入，极大提升开发效率。</p>
</blockquote>
<p>此外，根据 <code>readme.md</code> 补充说明：</p>
<ul>
<li><strong>appName navigation</strong>：<code>app.json</code> 中通过 <code>window.navigationBarTitleText</code> 设置应用名称“博客园”，实现顶部导航栏标题展示。</li>
<li><strong>tabBar</strong>：虽然当前 <code>app.json</code> 中未显式配置 <code>tabBar</code>，但项目中存在 <code>images/tb11.png</code>、<code>tb12.png</code>、<code>tb21.png</code>、<code>tb22.png</code> 等图标资源，极可能为未来底部 TabBar 图标预留。标准 <code>tabBar</code> 配置应包含 <code>list</code> 数组，每个项指定 <code>pagePath</code>、<code>text</code> 和 <code>iconPath</code>/<code>selectedIconPath</code>。</li>
</ul>
<hr/>
<h3 data-id="heading-2">1.2 全局逻辑入口：<code>app.js</code></h3>
<p><code>app.js</code> 是小程序的 <strong>App 实例</strong>，负责全局生命周期管理与数据共享：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-title class_">App</span>({
  <span class="hljs-title function_">onLaunch</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 记录启动日志</span>
    <span class="hljs-keyword">const</span> logs = wx.<span class="hljs-title function_">getStorageSync</span>(<span class="hljs-string">'logs'</span>) || [];
    logs.<span class="hljs-title function_">unshift</span>(<span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>());
    wx.<span class="hljs-title function_">setStorageSync</span>(<span class="hljs-string">'logs'</span>, logs);

    <span class="hljs-comment">// 触发微信登录</span>
    wx.<span class="hljs-title function_">login</span>({
      <span class="hljs-attr">success</span>: <span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> {
        <span class="hljs-comment">// 可将 res.code 发送至后端换取 openId 等</span>
      }
    });
  },
  <span class="hljs-attr">globalData</span>: {
    <span class="hljs-attr">userInfo</span>: <span class="hljs-literal">null</span>
  }
})
</code></pre>
<ul>
<li><strong><code>onLaunch</code></strong>：小程序初始化时执行一次，用于：
<ul>
<li>将当前时间戳存入本地缓存 <code>logs</code>，供 <code>logs</code> 页面展示。</li>
<li>调用 <code>wx.login()</code> 获取临时登录凭证 <code>code</code>，这是实现用户身份认证的第一步。</li>
</ul>
</li>
<li><strong><code>globalData</code></strong>：全局数据对象，可在任意页面通过 <code>getApp().globalData</code> 访问，常用于存储用户信息、配置等。</li>
</ul>
<p>根据 <code>readme.md</code> 补充：</p>
<ul>
<li><strong>app 应用的概念</strong>：小程序以 <code>App({})</code> 作为全局唯一实例，贯穿整个应用生命周期。</li>
<li><strong>app.json 全局都会使用的组件</strong>：通过 <code>usingComponents</code> 注册的组件（如 <code>van-button</code>、<code>van-search</code>）可在所有页面直接使用，无需重复引入。</li>
<li><strong>app.wxss</strong>：全局样式文件，定义的样式将作用于所有页面（除非被局部样式覆盖）。</li>
<li><strong>app.js</strong>：除生命周期外，还可定义全局方法、网络请求封装等。</li>
</ul>
<hr/>
<h3 data-id="heading-3">1.3 Sitemap 与隐私配置</h3>
<ul>
<li><strong><code>sitemap.json</code></strong>：控制页面是否允许被微信索引。本项目配置为 <code>"action": "allow", "page": "*"</code>，即所有页面均可被搜索。</li>
<li><strong><code>project.config.json</code> 与 <code>project.private.config.json</code></strong>：前者是团队共享配置（如基础库版本 <code>libVersion: "3.11.1"</code>），后者是开发者私有配置（如项目名 <code>blog</code>、热重载开启等），避免污染 Git 提交。</li>
</ul>
<hr/>
<h2 data-id="heading-4">🖼️ 二、首页设计：<code>index.js</code> 与数据驱动 UI</h2>
<p>首页 (<code>pages/index/index</code>) 是用户进入后的第一印象，其核心在于 <strong>菜单导航 + 广告轮播</strong>。</p>
<h3 data-id="heading-5">2.1 数据结构</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-attr">data</span>: {
  <span class="hljs-attr">menus</span>: [
    { <span class="hljs-attr">typeName</span>: <span class="hljs-string">'有声读物'</span>, <span class="hljs-attr">typePic</span>: <span class="hljs-string">'https://m.360buyimg.com/...png'</span> },
    { <span class="hljs-attr">typeName</span>: <span class="hljs-string">'名文赏析'</span>, <span class="hljs-attr">typePic</span>: <span class="hljs-string">'https://p3-passport.byteacctimg.com/...awebp'</span> },
    <span class="hljs-comment">// ... 共8个分类</span>
  ],
  <span class="hljs-attr">advertPics</span>: [
    <span class="hljs-string">'https://img.huxiucdn.com/article/cover/202403/08/...webp'</span>,
    <span class="hljs-string">'https://img.huxiucdn.com/article/cover/202511/03/...webp'</span>
  ]
}
</code></pre>
<ul>
<li><strong><code>menus</code></strong>：8 个内容分类，每个包含名称和图标 URL。注意：除“有声读物”外，其余图标均使用同一张头像图（可能是占位图）。</li>
<li><strong><code>advertPics</code></strong>：2 张广告横幅图，来自虎嗅网 CDN，采用 WebP 格式以优化加载速度。</li>
</ul>
<blockquote>
<p>📌 <strong>图片资源补充</strong>：项目中还包含本地图片 <code>images/tb11.png</code>、<code>tb12.png</code>、<code>tb21.png</code>、<code>tb22.png</code>。这些很可能是 <strong>TabBar 图标</strong>（尽管当前 <code>app.json</code> 未配置 TabBar），或用于其他页面装饰。若未来扩展底部导航，可在此处引用。</p>
</blockquote>
<p>根据 <code>readme.md</code> 补充：</p>
<ul>
<li><strong>advertPics</strong>：明确指出这是“赚钱来源 广告”，即通过展示第三方广告位实现商业化变现，是内容类小程序的重要收入渠道。</li>
</ul>
<h3 data-id="heading-6">2.2 事件处理：跳转搜索页</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-title function_">toSearch</span>(<span class="hljs-params"/>) {
  wx.<span class="hljs-title function_">navigateTo</span>({ <span class="hljs-attr">url</span>: <span class="hljs-string">'pages/search/search'</span> })
}
</code></pre>
<ul>
<li>使用 <code>wx.navigateTo</code> 实现页面跳转，符合小程序路由规范。</li>
<li>注意：路径应为相对路径，但更推荐使用 <code>/pages/search/search</code>（绝对路径）避免嵌套问题。</li>
</ul>
<p>根据 <code>readme.md</code> 补充：</p>
<ul>
<li><strong>weapp 事件</strong>：小程序不使用 HTML 的 <code>onclick</code>，而是采用 <code>bindtap</code> 绑定点击事件。</li>
<li><strong>js 文件就是一个 Page 实例</strong>：每个页面的 <code>.js</code> 文件通过 <code>Page({})</code> 定义，其中：
<ul>
<li><code>data</code> 存放页面数据；</li>
<li>事件处理函数（如 <code>toSearch</code>）直接作为 <code>Page</code> 配置项传入即可。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-7">2.3 WXML 模板逻辑（基于 <code>readme.md</code>）</h3>
<p>根据 <code>readme.md</code> 描述：</p>
<ul>
<li>使用 <code>wx:for="{{menus}}"</code> 循环渲染菜单项。</li>
<li>每项通过 <code>{{item.typeName}}</code> 显示文字（曾因遗漏此绑定导致“只有图片没有字”的 bug）。</li>
<li><code>&lt;image src="{{item.typePic}}" /&gt;</code> 显示图标。</li>
<li>使用 <code>rpx</code> 单位实现响应式布局（设计稿以 iPhone 6/7/8 的 750rpx 为基准）。</li>
<li>广告图可能使用 <code>&lt;swiper&gt;</code> 组件实现自动轮播。</li>
<li><strong>block 是一个可以接收指令的标签，不会在DOM中出现</strong>：例如 <code>&lt;block wx:for="{{menus}}" wx:key="*this"&gt;</code> 用于包裹循环内容，自身不生成节点。</li>
<li><strong>wx:key</strong>：为列表项提供唯一标识，提升渲染性能，可设为 <code>wx:key="*this"</code>（当 item 为字符串或数字）或指定字段如 <code>wx:key="id"</code>。</li>
</ul>
<blockquote>
<p>🔍 <strong>Debug 过程记录</strong>（来自 <code>readme.md</code>）：</p>
<ul>
<li>确保 <code>van-search</code> 正确注册：<code>"van-search": "@vant/weapp/search"</code></li>
<li>修复“只有图片没有字”问题：补全 <code>{{item.typeName}}</code> 数据绑定</li>
</ul>
</blockquote>
<hr/>
<h2 data-id="heading-8">📝 三、日志页面：<code>logs.js</code> 与工具函数复用</h2>
<p><code>logs</code> 页面用于展示小程序的启动历史，体现了 <strong>本地存储 + 工具函数</strong> 的典型用法。</p>
<h3 data-id="heading-9">3.1 工具函数：<code>util.js</code></h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> <span class="hljs-title function_">formatTime</span> = date =&gt; {
  <span class="hljs-keyword">const</span> year = date.<span class="hljs-title function_">getFullYear</span>()
  <span class="hljs-keyword">const</span> month = date.<span class="hljs-title function_">getMonth</span>() + <span class="hljs-number">1</span>
  <span class="hljs-keyword">const</span> day = date.<span class="hljs-title function_">getDate</span>()
  <span class="hljs-comment">// ...格式化为 "YYYY/MM/DD HH:mm:ss"</span>
  <span class="hljs-keyword">return</span> <span class="hljs-string">`<span class="hljs-subst">${[year, month, day].map(formatNumber).join(<span class="hljs-string">'/'</span>)}</span> <span class="hljs-subst">${[hour, minute, second].map(formatNumber).join(<span class="hljs-string">':'</span>)}</span>`</span>
}

<span class="hljs-keyword">const</span> <span class="hljs-title function_">formatNumber</span> = n =&gt; {
  n = n.<span class="hljs-title function_">toString</span>()
  <span class="hljs-keyword">return</span> n[<span class="hljs-number">1</span>] ? n : <span class="hljs-string">`0<span class="hljs-subst">${n}</span>`</span> <span class="hljs-comment">// 补零</span>
}

<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = { formatTime }
</code></pre>
<ul>
<li>该模块导出 <code>formatTime</code> 函数，用于将时间戳转换为可读字符串。</li>
<li><code>formatNumber</code> 确保月份、日期等小于10时补前导零（如 <code>5</code> → <code>05</code>）。</li>
</ul>
<h3 data-id="heading-10">3.2 日志页面逻辑</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// logs.js</span>
<span class="hljs-keyword">const</span> util = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../../utils/util.js'</span>)
<span class="hljs-title class_">Page</span>({
  <span class="hljs-attr">data</span>: { <span class="hljs-attr">logs</span>: [] },
  <span class="hljs-title function_">onLoad</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setData</span>({
      <span class="hljs-attr">logs</span>: (wx.<span class="hljs-title function_">getStorageSync</span>(<span class="hljs-string">'logs'</span>) || []).<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">log</span> =&gt;</span> ({
        <span class="hljs-attr">date</span>: util.<span class="hljs-title function_">formatTime</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(log)),
        <span class="hljs-attr">timeStamp</span>: log
      }))
    })
  }
})
</code></pre>
<ul>
<li>从本地缓存读取 <code>logs</code> 数组（由 <code>app.js</code> 写入）。</li>
<li>使用 <code>map</code> 将每个时间戳转换为 <code>{ date, timeStamp }</code> 对象，便于 WXML 渲染。</li>
</ul>
<hr/>
<h2 data-id="heading-11">🔍 四、功能页面：Search、Theme、Articles</h2>
<p>其余页面（<code>search</code>、<code>theme</code>、<code>articles</code>）目前均为 <strong>骨架页面</strong>，仅包含标准生命周期函数：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-title class_">Page</span>({
  <span class="hljs-attr">data</span>: { },
  <span class="hljs-title function_">onLoad</span>(<span class="hljs-params">options</span>) { },
  <span class="hljs-title function_">onReady</span>(<span class="hljs-params"/>) { },
  <span class="hljs-title function_">onShow</span>(<span class="hljs-params"/>) { },
  <span class="hljs-comment">// ... 其他生命周期</span>
})
</code></pre>
<p>这表明项目处于 <strong>早期开发阶段</strong>，核心功能尚未实现。但结构已预留：</p>
<ul>
<li><strong><code>search</code></strong>：将集成 <code>van-search</code> 组件（已在 <code>app.json</code> 注册），用于内容检索。</li>
<li><strong><code>theme</code></strong>：可能用于主题分类浏览（对应首页 <code>menus</code> 中的“名文赏析”等）。</li>
<li><strong><code>articles</code></strong>：文章详情页，展示具体内容。</li>
</ul>
<blockquote>
<p>⚙️ <strong>未来扩展建议</strong>：</p>
<ul>
<li>在 <code>search.js</code> 中监听 <code>bind:search</code> 事件，调用 API 获取结果。</li>
<li>在 <code>articles.js</code> 中通过 <code>options.id</code> 获取文章 ID，拉取详情。</li>
</ul>
</blockquote>
<hr/>
<h2 data-id="heading-12">🎨 五、UI 与交互细节</h2>
<h3 data-id="heading-13">5.1 响应式单位：rpx</h3>
<ul>
<li>小程序独创单位 <code>rpx</code>（responsive pixel），<strong>以屏幕宽度 750rpx 为基准</strong>。</li>
<li>无论设备分辨率如何，<code>750rpx = 100% 屏幕宽度</code>，自动适配 iPhone、安卓等机型。</li>
<li>开发者应 <strong>避免使用 px</strong>，全部使用 rpx 或百分比。</li>
<li>设计师的移动端设计稿通常基于 iPhone 6/7/8（750px 宽），因此 1px = 1rpx，换算直观。</li>
</ul>
<p>根据 <code>readme.md</code> 强调：</p>
<blockquote>
<p>“不要用px，用rpx”<br/>
“宽度是 750rpx iphone 标准设备的单位（iphone678）”<br/>
“如何等比例，由小程序自己去做”</p>
</blockquote>
<h3 data-id="heading-14">5.2 数据驱动视图</h3>
<ul>
<li>所有页面数据定义在 <code>Page({ data: {} })</code> 中。</li>
<li>WXML 通过 <code>{{ }}</code> 绑定数据，如 <code>{{menus}}</code>、<code>{{advertPics}}</code>。</li>
<li>修改数据必须调用 <code>this.setData({ key: value })</code>，触发视图更新。</li>
</ul>
<p>根据 <code>readme.md</code> 补充：</p>
<ul>
<li><strong>数据驱动界面</strong>：<code>js</code> 中 <code>Page({ data: {...} })</code> 定义数据，WXML 用 <code>{{}}</code> 绑定。</li>
<li><strong>block wx:for</strong>：循环输出时，默认每一项变量名为 <code>item</code>，可通过 <code>wx:for-item="customName"</code> 修改。</li>
</ul>
<h3 data-id="heading-15">5.3 导航与标签</h3>
<ul>
<li>使用 <code>&lt;navigator url="/pages/search/search"&gt;</code> 实现页面跳转。</li>
<li><strong><code>&lt;/navigator&gt;</code></strong>：标签闭合，支持高亮状态（若配合 tabBar）。</li>
<li><strong><code>&lt;/block&gt;</code></strong>：如前所述，<code>&lt;block&gt;</code> 仅为逻辑容器，最终 <strong>不会在页面显示</strong>，是“牺牲了”的辅助标签。</li>
</ul>
<hr/>
<h2 data-id="heading-16">📦 六、依赖管理与构建</h2>
<h3 data-id="heading-17">6.1 包管理：<code>package.json</code></h3>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"dependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"@vant/weapp"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^1.11.7"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<ul>
<li>通过 npm 安装 Vant WeUI，版本锁定在 <code>1.11.7</code>。</li>
<li>构建时需在微信开发者工具中点击 <strong>“构建 npm”</strong>，将依赖复制到 <code>miniprogram_npm</code> 目录。</li>
</ul>
<h3 data-id="heading-18">6.2 构建配置</h3>
<ul>
<li><code>project.config.json</code> 启用 <code>es6</code>、<code>postcss</code>、<code>minified</code> 等，确保代码压缩与兼容性。</li>
<li><code>disableSWC: true</code> 表示不使用 SWC 编译器，可能因兼容性考虑。</li>
</ul>
<hr/>
<h2 data-id="heading-19">🧩 七、总结与展望</h2>
<p>“博客园”小程序虽功能尚简，但已具备 <strong>完整的项目骨架、清晰的架构分层、规范的编码风格</strong>。其亮点包括：</p>
<p>✅ 使用 Vant WeUI 提升 UI 质量<br/>
✅ 严格遵循数据驱动开发模式<br/>
✅ 合理利用本地存储记录日志<br/>
✅ 响应式布局适配多端<br/>
✅ 模块化工具函数复用</p>
<p><strong>未来可扩展方向</strong>：</p>
<ul>
<li>实现搜索功能，对接后端 API。</li>
<li>丰富 <code>articles</code> 页面，支持富文本、音频播放（配合“有声读物”）。</li>
<li>添加用户收藏、评论等互动功能。</li>
<li>引入云开发（CloudBase）简化后端逻辑。</li>
</ul>
<hr/>
<h2 data-id="heading-20">🌟 结语</h2>
<p>微信小程序开发不仅是技术实现，更是对 <strong>用户体验、性能优化、工程规范</strong> 的综合考验。“博客园”项目为我们提供了一个绝佳的学习范本——从一行 <code>app.json</code> 配置，到一个 <code>formatTime</code> 工具函数，再到首页的菜单与广告，无不体现着小程序开发的精髓。希望本文能助你在小程序开发之路上，走得更稳、更远！🚀</p>
<blockquote>
<p>📎 <strong>附：项目资源清单</strong></p>
<ul>
<li>图片：<code>tb11.png</code>, <code>tb12.png</code>, <code>tb21.png</code>, <code>tb22.png</code>（位于 <code>images/</code>）</li>
<li>核心页面：<code>index</code>, <code>logs</code>, <code>search</code>, <code>theme</code>, <code>articles</code></li>
<li>全局依赖：<code>@vant/weapp</code>, <code>util.js</code></li>
<li>配置文件：<code>app.json</code>, <code>project.config.json</code>, <code>sitemap.json</code></li>
</ul>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🌸 入职写了一个月全栈next.js 感想]]></title>    <link>https://juejin.cn/post/7577713754562838580</link>    <guid>https://juejin.cn/post/7577713754562838580</guid>    <pubDate>2025-11-29T18:54:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577713754562838580" data-draft-id="7577681092138024995" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🌸 入职写了一个月全栈next.js 感想"/> <meta itemprop="keywords" content="前端,后端,AI编程"/> <meta itemprop="datePublished" content="2025-11-29T18:54:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小佘ovo"/> <meta itemprop="url" content="https://juejin.cn/user/4248168663101239"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🌸 入职写了一个月全栈next.js 感想
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4248168663101239/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小佘ovo
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-29T18:54:34.000Z" title="Sat Nov 29 2025 18:54:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">背景介绍</h2>
<ul>
<li>
<p>最近组内要做0-1的新ai产品, 招我进来就是负责这个ai产品,启动的时候这个季度就剩下两个月了,天天开会对齐进度,一个月就已经把基础版本给做完了,想要接入到现有的业务上面,时间方面就特别紧张,技术选型怎么说呢, leader用ai写了一个版本 我们在现有的代码进行二次开发这样, 全栈next.js 要学习的东西太多了 又没有前端基础,没有ai coding很难完成任务(十几分钟干完我一天的工作 claude4.5效果还不错 进度推的特别快), 自从trae下架了claude,后面就一直cursor claude 4.5了。</p>
<ul>
<li>nextjs+ts+tailwindcss+shadcn ui现在是mvp套餐，startup在梭哈，时间就是生产力哪需要那么多差异化样式直接一把，有的💰才开始做细节，你会发现慢慢也💩化了。</li>
<li>Nextjs 是全栈框架 可以很快把一个MVP从零到一完整跑起来。 你要是抬杠说什么高并发负载均衡啥的，你的用户数量真多到需要考虑性能的时候，你已经不需要自己考虑了(小红书看到的一段话 挺符合场景的)</li>
<li>next.js 写后端 确实比较轻量 只能做一些curd的操作 socket之类的不太合适 其他api 还是随便开发 给我的感受就是前端能够直接操作db，前后端仓库可以不分离，业务逻辑还是一定要分离的 看看开源的next.js 项目的架构设计结构是怎么样的 学习/模仿/改造。</li>
<li>语言只是工具，适合最重要，技术没有银弹</li>
</ul>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fnextjs.org%2F" target="_blank" title="https://nextjs.org/" ref="nofollow noopener noreferrer">nextjs.org/</a> <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fvercel%2Fnext.js" target="_blank" title="https://github.com/vercel/next.js" ref="nofollow noopener noreferrer">github.com/vercel/next…</a>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1dde542c9ddf42a693b2bd0500de3bd3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5L2Yb3Zv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765047726&amp;x-signature=7Cgg7lmdzgbPgkwSo5dK9xSO%2FUI%3D" alt="image.png" loading="lazy"/></p>
</li>
</ul>
<h2 data-id="heading-1">项目的时间线</h2>
<blockquote>
<p>项目从启动到这周 大概是5周的时间</p>
</blockquote>
<ul>
<li>10/28-10/31 Week 1
<ul>
<li>项目初始化/需求讨论/设计文档/</li>
<li>后端next.js, typescript技术熟悉 项目运行/调试</li>
<li>基础框架搭建 设计表结构ddl, 集成mysql, 编写crud接口阶段</li>
</ul>
</li>
<li>11/03-11/07 Week 2
<ul>
<li>产品PRD 提供</li>
<li>xxxx等表设计</li>
</ul>
</li>
<li>11/10-11/14 Week 3
<ul>
<li>xxxxx 基本功能完结</li>
<li>@xxxx 讲解项目结构/规范</li>
</ul>
</li>
<li>11/17-11/21 Week 4
<ul>
<li>首页样式/逻辑 优化</li>
<li>集成统一登录调研</li>
<li>部署完成</li>
</ul>
</li>
<li>11/24-11/28 Week 5
<ul>
<li>服务推理使用Authorization鉴权 对内接口使用Cookies (access_token) 鉴权 开发</li>
<li>xxxx 表设计表设计 逻辑开发</li>
<li>xxx设计 设计开发</li>
<li>联调xxxx</li>
</ul>
</li>
</ul>
<blockquote>
<p>5周时间 功能基本完成了 剩下的就是部署到线上 进行场景实践了</p>
</blockquote>
<h2 data-id="heading-2">前端技术栈</h2>
<ul>
<li><strong>Next.js 14</strong>：选择 App Router 架构，支持服务端渲染和 API Routes</li>
<li><strong>TypeScript 5.4</strong>：强类型语言提升代码质量和可维护性</li>
<li><strong>React 18</strong>：利用并发特性和 Suspense 提升用户体验</li>
<li><strong>Zustand</strong>：轻量级状态管理，替代 Redux 降低复杂度</li>
<li><strong>Ant Design + Radix UI</strong>：组件库组合，平衡美观性和可访问性</li>
</ul>
<h3 data-id="heading-3">React + TypeScript  <a href="https://link.juejin.cn?target=https%3A%2F%2Freact.dev%2F" target="_blank" title="https://react.dev/" ref="nofollow noopener noreferrer">react.dev/</a></h3>
<ul>
<li>优势：类型安全：TypeScript 提供编译时类型检查，减少运行时错误 ✅ <strong>组件化开发</strong>：高度可复用的组件设计  ✅ <strong>生态成熟</strong>：丰富的第三方库和工具链 ✅ <strong>开发体验</strong>：优秀的 IDE 支持和调试工具</li>
<li><strong>劣势：</strong> ❌ <strong>学习曲线</strong>：TypeScript 对新手有一定门槛 ❌ <strong>编译时间</strong>：大型项目编译可能较慢 ❌ <strong>配置复杂</strong>：类型定义需要额外维护</li>
</ul>
<h3 data-id="heading-4">UI 组件方案 Ant Design + Radix UI 混合方案</h3>
<ul>
<li>
<p><strong>优势：</strong>  ✅ <strong>快速开发</strong>：Ant Design 提供完整的企业级组件  ✅ <strong>无障碍性</strong>：Radix UI 提供符合 WAI-ARIA 标准的组件 ✅ <strong>定制灵活</strong>：Radix UI 无样式组件便于自定义 ✅ <strong>中文支持</strong>：Ant Design 对中文界面友好</p>
</li>
<li>
<p><strong>劣势：</strong> ❌ <strong>包体积大</strong>：两个 UI 库增加了打包体积 ❌ <strong>样式冲突</strong>：需要注意两个库的样式隔离❌ <strong>维护成本</strong>：需要同时维护两套组件系统</p>
</li>
</ul>
<h3 data-id="heading-5">Tailwind CSS</h3>
<ul>
<li><strong>优势：</strong> ✅ <strong>开发效率高</strong>：原子化类名，快速构建 UI ✅ <strong>体积优化</strong>：生产环境自动清除未使用的样式 ✅ <strong>一致性</strong>：设计系统内置，确保视觉一致 ✅ <strong>响应式</strong>：便捷的响应式设计工具</li>
<li><strong>劣势：</strong> ❌ <strong>类名冗长</strong>：HTML 可能变得难以阅读 ❌ <strong>学习成本</strong>：需要记忆大量类名 ❌ <strong>非语义化</strong>：类名不直观反映元素意义</li>
</ul>
<h3 data-id="heading-6">ant design x</h3>
<h3 data-id="heading-7">ahooks</h3>
<h2 data-id="heading-8">后端技术栈</h2>
<ul>
<li><strong>Prisma 6.18</strong>：现代化 ORM，类型安全且支持 Migration</li>
<li><strong>MySQL</strong>：成熟的关系型数据库，满足复杂查询需求</li>
<li><strong>Redis (ioredis)</strong> ：高性能缓存，支持多种数据结构</li>
<li><strong>Winston</strong>：企业级日志系统，支持日志轮转和结构化输出</li>
<li><strong>Zod</strong>：运行时类型验证，保障 API 数据安全</li>
</ul>
<h3 data-id="heading-9">Next.js API Routes</h3>
<ul>
<li>
<p><strong>优势：</strong> ✅ <strong>统一代码库</strong>：前后端在同一项目中 ✅ <strong>类型共享</strong>：TypeScript 类型可在前后端复用 ✅ <strong>开发效率</strong>：无需配置跨域、代理等 ✅ <strong>部署简单</strong>：单一应用部署</p>
</li>
<li>
<p><strong>劣势：</strong> ❌ <strong>扩展性限制</strong>：无法独立扩展后端服务 ❌ <strong>性能瓶颈</strong>：Node.js 单线程可能成为瓶颈 ❌ <strong>微服务困难</strong>：不适合复杂的微服务架构</p>
</li>
</ul>
<h3 data-id="heading-10">Prisma ORM</h3>
<ul>
<li>
<p><strong>优势：</strong> ✅ <strong>类型安全</strong>：自动生成 TypeScript 类型 ✅ <strong>迁移管理</strong>：声明式 schema，易于版本控制 ✅ <strong>查询性能</strong>：生成优化的 SQL 查询 ✅ <strong>关系处理</strong>：直观的关系查询 API ✅ <strong>多数据库支持</strong>：支持 MySQL、PostgreSQL、SQLite 等</p>
</li>
<li>
<p><strong>劣势：</strong> ❌ <strong>复杂查询</strong>：某些复杂 SQL 可能需要原始查询 ❌ <strong>生成代码体积</strong>：生成的 client 文件较大 ❌ <strong>版本升级</strong>：大版本升级可能需要迁移</p>
</li>
</ul>
<h2 data-id="heading-11">踩坑记录</h2>
<blockquote>
<p>主要是记录一些开发过程中踩坑 和设计问题</p>
</blockquote>
<ul>
<li>node js 项目 jean部署</li>
<li>自定义配置/dockerfile配置 没有类似项目参考 健康检查问题 加上环境变量配置多环境 一步一步</li>
<li>next.js 中 用middleware进行接口拦截鉴权 里面有prisma path import 直接出现了Edge Runtime 异常 自定义auth 解决</li>
<li>npm build 项目 踩坑</li>
<li>静态渲染流程 动态api 警告 强制动态渲染</li>
<li>其他组件 document 不支持build问题</li>
<li>保存多场景模式+构建版本管理第一版考虑的太少了，发现有问题 后面又重构了一版本</li>
<li>xxx日志目前还没有接入 要不就是日志文件 要不就是console.log 目前看日志的方式是去容器化运行日志看了 后续集群部署就比较麻烦了</li>
<li>ant design 版本降低到6.0以下 ant-design x 用不了2.0.0 的一些对话组件</li>
</ul>
<h2 data-id="heading-12">Next.js实践的项目记录</h2>
<h3 data-id="heading-13">苏州 trae friends线下黑客松 📒</h3>
<ul>
<li>去Trae pro-Solo模式 苏州线下hackathon一趟, 基本都是一些独立开发者，一人一公司，三个小时做出一个产品用Trae-solo coder模式，不得不说trae内部集成的vercel部署很丝滑 react项目一键deploy访问 完全不用关系域名服务器, solo模式其实就是混合多种model使用进行输出 想要的效果还是得不断的调试 thiking太长，对于前后端分离项目 也能够同时关联进行思考规划。</li>
<li>1点多到4点 coding时间 从0-1生成项目 使用trae pro solo模式 就3个小时 做不了什么大的东西 那就做个日语50音的网站呗 现场酒店的网基本用不了 我数据也很卡 用的旁边干中学老师的热点 用next.js tailwindcss ant design deepseek搭建的网页 够用了 最后vercel部署 trae自带集成 挺方便的 solo模式还是太慢了 接受不了 网站地址是 <a href="https://link.juejin.cn?target=https%3A%2F%2Ftraekanastudio1ssw.vercel.app%2F" target="_blank" title="https://traekanastudio1ssw.vercel.app/" ref="nofollow noopener noreferrer">traekanastudio1ssw.vercel.app/</a> 功能就是假名+ai生成例句和单词 我都没有路演 最后拿优秀奖可能是我部署了吧 大部分人没部署 优秀奖就是卫衣了 蹭了一天的饭加零食 爽吃</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.xiaohongshu.com%2Fexplore%2F692140b0000000001e02aac9%3Fxsec_token%3DABIsSxCtiWqecBNz1tI65rHCL4Hb0gSD5uSDb3r--JEYE%3D%26xsec_source%3Dpc_user" target="_blank" title="https://www.xiaohongshu.com/explore/692140b0000000001e02aac9?xsec_token=ABIsSxCtiWqecBNz1tI65rHCL4Hb0gSD5uSDb3r--JEYE=&amp;xsec_source=pc_user" ref="nofollow noopener noreferrer">www.xiaohongshu.com/explore/692…</a> 小红书当时发的帖子 可以领奖品</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ae7da702365441b6b261931832baa2c5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5L2Yb3Zv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765047726&amp;x-signature=h3Xl35fLbnBriZ3Rf2h6y5NWw1Y%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-14">Typescript的AI方向 langchain/langgraph支持ts</h3>
<ul>
<li>最近在看的ts的ai框架 发现langchain 是支持ts的, langchain-chat 主要是使用langchain+langgraph 对ts进行实践 <a href="https://link.juejin.cn?target=https%3A%2F%2Ftraechat-apps4y6.vercel.app%2F" target="_blank" title="https://traechat-apps4y6.vercel.app/" ref="nofollow noopener noreferrer">traechat-apps4y6.vercel.app/</a></li>
<li>部署还踩坑了 MCP 在 Vercel 上不生效是因为 Vercel 是 serverless 环境，不支持运行持久的子进程。让我帮你解决这个问题：</li>
<li>主要是对最近项目组内要用的到mcp/function call 进行实践操作 使用modelscope  上面开源的mcp进行尝试 使用vercel进行部署。</li>
<li>最近看到小红书上面的3d 粒子 圣诞树有点火呀，自己也尝试下 效果很差 自己弄的提示词 可以去看看帖子上的提示词去试试 他们都是gemini pro 3玩的 我也去弄个gemini pro 3 账号去玩玩。</li>
<li>还有一个3d粒子 跟着音乐动的的效果 下面的提示词可以试试</li>
</ul>

<pre><code class="hljs">帮我构建一个极简科幻风格的 3D 音乐可视化网页。
视觉上参考 SpaceX 的冷峻美学，全黑背景，去装饰化。核心是一个由数千个悬浮粒子组成的‘生命体’，它必须能与声音建立物理连接：低音要像心脏搏动一样冲击屏幕，高音要像电流一样瞬间穿过点阵。
重点实现一种‘ACID 流体’视觉引擎：让粒子表面的颜色不再是静态的，而是像两种粘稠的荧光液体一样，在失重环境下互相吞噬、搅拌、流动，且流速由音乐能量驱动。
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e839115371d0452597429c65e265264a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5L2Yb3Zv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765047726&amp;x-signature=jxul0TLPQk5AmtuhNm59Y7p43Rc%3D" alt="c88886c4c8c3a180a2dba52f17125dc1.jpg" loading="lazy"/></p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.langchain.com%2Foss%2Fjavascript%2Flangchain%2Foverview" target="_blank" title="https://docs.langchain.com/oss/javascript/langchain/overview" ref="nofollow noopener noreferrer">docs.langchain.com/oss/javascr…</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.modelscope.ai%2Fhome" target="_blank" title="https://www.modelscope.ai/home" ref="nofollow noopener noreferrer">www.modelscope.ai/home</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fvercel.com" target="_blank" title="https://vercel.com" ref="nofollow noopener noreferrer">vercel.com</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.modelscope.ai%2Fmcp" target="_blank" title="https://www.modelscope.ai/mcp" ref="nofollow noopener noreferrer">www.modelscope.ai/mcp</a></li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a8ed2abc86db450a9d07c65e70ac59d2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5L2Yb3Zv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765047726&amp;x-signature=1Lsp%2BkwdR%2FBGUjVx99JvnxDnxDQ%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7dbb7162415d450d929b2bb37d2d88c6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5L2Yb3Zv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765047726&amp;x-signature=8AO3OnEtfs9pIc7y2aawjr0%2BIJ0%3D" alt="image.png" loading="lazy"/></p>
<blockquote>
<p>ai方向 总结</p>
</blockquote>
<ul>
<li>a2a解决的是agent之间如何配合工作的问题 agent card定义名片 名称 版本 能力 语言 格式 task委托书 通信方式http 用户 客户端是主控 接受用户需求 制定具体任务 向服务器发出需求 任务分发 接受响应 服务器是各类部署好的agent 遵循一套结构化模式</li>
<li>mcp 解决的llm自主调用功能和工具问题</li>
<li>mcp 是解决 function call 协议的碎片化问题，多 agent 主要是为了做上下文隔离</li>
<li>比如说手机有一个system agent 然后各个app有一个agent，用户语音输入买咖啡，然后system agent调用瑞幸agent 这样就是非侵入式 让app暴露系统a2a接口，感觉比mcp要更合理一点，不是单纯让app暴露tools，系统agent只需要做路由</li>
<li>而且有一点我觉得挺有意思的，就是自己的agent花的token是自己的钱，如果自己的agent找别人的agent，让它执行任务啥的，花的不就是别人的钱……</li>
<li>Dify：更像宜家的模块化家具，提供可视化工作流、预置模板，甚至支持“拖拽式”编排AI能力。比如，你想做一
个智能客服，只需在界面里连接对话模型、知识库和反馈按钮，无需写一行代码</li>
</ul>
<blockquote>
<p>python 和ts 在ai上面的比较</p>
</blockquote>
<ul>
<li>Python 依然是 AI 训练和科研的王者，PyTorch、TensorFlow、scikit-learn 这些生态太厚实了，训练大模型你离不开它。</li>
<li>TS 在底层 AI 能力上还没那么能打，GPU 加速、模型优化这些，暂时还得靠 Python 打底。</li>
<li>Python 搞理论和模型，TypeScript卷体验和交付</li>
</ul>
<h2 data-id="heading-15">个人学习记录</h2>
<blockquote>
<p>主要还是前端和ai方面的知识点学习的比较多吧</p>
</blockquote>
<ul>
<li>Typescript 语法基础+进阶 / Next.js 开发指南/React 开发指南</li>
<li>ahooks 组件 使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fahooks.js.org%2Fzh-CN%2Fhooks%2Fuse-request%2Fpolling" target="_blank" title="https://ahooks.js.org/zh-CN/hooks/use-request/polling" ref="nofollow noopener noreferrer">ahooks.js.org/zh-CN/hooks…</a></li>
<li>ant design x 使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fant-design-x.antgroup.com%2Fcomponents%2Fbubble-cn" target="_blank" title="https://ant-design-x.antgroup.com/components/bubble-cn" ref="nofollow noopener noreferrer">ant-design-x.antgroup.com/components/…</a></li>
<li>prisma orm框架 +mysql <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fprisma%2Fprisma" target="_blank" title="https://github.com/prisma/prisma" ref="nofollow noopener noreferrer">github.com/prisma/pris…</a></li>
<li>dotenv 读取配置文件 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fdotenvx%2Fdotenvx" target="_blank" title="https://github.com/dotenvx/dotenvx" ref="nofollow noopener noreferrer">github.com/dotenvx/dot…</a></li>
<li>fastmcp 项目构建使用 原理</li>
<li>Agent2Agent google协议内部详情
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FMarkTechStation%2FVideoCode" target="_blank" title="https://github.com/MarkTechStation/VideoCode" ref="nofollow noopener noreferrer">github.com/MarkTechSta…</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fa2aproject%2Fa2a-samples" target="_blank" title="https://github.com/a2aproject/a2a-samples" ref="nofollow noopener noreferrer">github.com/a2aproject/…</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fa2a-protocol.org%2Flatest%2Ftopics%2Fwhat-is-a2a%2F" target="_blank" title="https://a2a-protocol.org/latest/topics/what-is-a2a/" ref="nofollow noopener noreferrer">a2a-protocol.org/latest/topi…</a></li>
</ul>
</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fswagger.io%2Fspecification%2F" target="_blank" title="https://swagger.io/specification/" ref="nofollow noopener noreferrer">swagger.io/specificati…</a> OpenAPI 规范 一个 OpenAPI 描述（OAD）可以由一个 JSON 或 YAML 文档组成</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fyossi-lee%2Fswagger2mcp" target="_blank" title="https://github.com/yossi-lee/swagger2mcp" ref="nofollow noopener noreferrer">github.com/yossi-lee/s…</a> 根据Swagger3规范，一键将Web服务转换为MCP</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.jsonrpc.org%2Fspecification" target="_blank" title="https://www.jsonrpc.org/specification" ref="nofollow noopener noreferrer">www.jsonrpc.org/specificati…</a> JSON-RPC 是一种无状态、轻量级的远程过程调用（RPC）协议</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fagno-agi%2Fagno" target="_blank" title="https://github.com/agno-agi/agno" ref="nofollow noopener noreferrer">github.com/agno-agi/ag…</a> 多智能体框架</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Froadmap.sh%2Fai-engineer" target="_blank" title="https://roadmap.sh/ai-engineer" ref="nofollow noopener noreferrer">roadmap.sh/ai-engineer</a> ai工程师的roadmap 很全</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FChromeDevTools%2Fchrome-devtools-mcp" target="_blank" title="https://github.com/ChromeDevTools/chrome-devtools-mcp" ref="nofollow noopener noreferrer">github.com/ChromeDevTo…</a> *可以集成到cursorz中 *AI 能够直接控制和调试真实的 Chrome 浏览器</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.nano-banana.ai%2F" target="_blank" title="https://www.nano-banana.ai/" ref="nofollow noopener noreferrer">www.nano-banana.ai/</a> Nano Banana Pro (V2) 文生图 图生图</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Faistudio.google.com%2Fprompts%2Fnew_chat" target="_blank" title="https://aistudio.google.com/prompts/new_chat" ref="nofollow noopener noreferrer">aistudio.google.com/prompts/new…</a> gemini ai studio</li>
</ul>
<h2 data-id="heading-16">Vibe Coding</h2>
<ul>
<li>先叠甲, 我没有前端的开发经验，第一次写前端项目，项目里面90%的前端代码都是ai 生成的，能够让你一个不会前端的同学也快速完成mvp版本/需求任务。我虽然很推ai coding 很喜欢用, 即时反馈带来的成就感, 但是对于生成的代码是不是屎山 大概率可能是了, 因为前期 AI速度快，制造屎山的速度更快。无论架构设计多优秀，也难避免屎山代码的宿命: 需求一直在变，你的架构设计是针对老的需求，随着新的需求增加，老的架构慢慢的就无法满足了，需要重构。</li>
<li>一起开发的前端同事都说ai生成那些样式互相影响了,样式有tailwindcss 有自定义的css 每个模块又有不同 大概率出问题 有冲突，就是💩山。</li>
<li>最大的开发障碍就是内心的偏见 不愿意放弃现在所擅长的东西 带着这份偏见不愿意去学习</li>
</ul>
<blockquote>
<p>对于ai coding 的话 用过trae-pro/cursor/qoder/copilot/codex等等 最终还是cursor claude 4.5用的最舒服</p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/71c30fea330043c4a291547f8ff9dfc0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5L2Yb3Zv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765047726&amp;x-signature=UoyJIjQBm9ZywGR%2B6GdULHJqMYE%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li>基本一周一个cursor pro账号 买号都花了快1k了。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4d68721de0bb48fbb926c083f7dedffa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5L2Yb3Zv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765047726&amp;x-signature=i82I4V73%2FzcY%2F9fUVDWkROkkoUQ%3D" alt="image.png" loading="lazy"/></p>
<blockquote>
<p>You have used up your included usage and are on pay-as-you-go which is charged based on model API rates. You have spent $0.00 in on-demand usage this month.</p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b561345afbb542ddbcde7f9ae8ece668~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5L2Yb3Zv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765047726&amp;x-signature=SMvJOhy7zUjk1C4h579qk5SFGRc%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9aad3de8a17c4669aa231c381f68ed6e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5L2Yb3Zv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765047726&amp;x-signature=8YLEjui%2B3KsoS%2FvCx%2FaSq9MSK5k%3D" alt="9e0f1cde2dbc3314e44150d1e544c77a.png" loading="lazy"/></p>
<ul>
<li>
<p>最后就是需要学好英语 前端的技术文档都是英文的 虽然有中文的翻译版本, 但没有自己直接去看官方的强 难免有差异， 我现在都是用插件进行web翻译去看的 很累。</p>
</li>
<li>
<p>现在时间是凌晨 11/30/02:36 喝了两瓶酒。这个周末我要重温甜甜的恋爱 给我也来一颗药丸 给时间是时间 让过去过去, 年底想去日本跨年了</p>
</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dd8f264133fb4ab09665ffb9a709498d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5L2Yb3Zv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765047726&amp;x-signature=IJb04IeU3l8VZBT61xrT8yj8pYo%3D" alt="image.png" loading="lazy"/>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1a61964a922e4b74844195da04af80ba~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5L2Yb3Zv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765047726&amp;x-signature=bQaS5qW6TYvCSgLAK%2F8YnjJospY%3D" alt="image.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Visual Studio 开发环境配置指南]]></title>    <link>https://juejin.cn/post/7577683422878564386</link>    <guid>https://juejin.cn/post/7577683422878564386</guid>    <pubDate>2025-11-30T04:57:28.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577683422878564386" data-draft-id="7577713754563280948" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Visual Studio 开发环境配置指南"/> <meta itemprop="keywords" content="C++,OpenGL"/> <meta itemprop="datePublished" content="2025-11-30T04:57:28.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小陈要努力"/> <meta itemprop="url" content="https://juejin.cn/user/3540880374375006"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Visual Studio 开发环境配置指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3540880374375006/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小陈要努力
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T04:57:28.000Z" title="Sun Nov 30 2025 04:57:28 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">🎯 Visual Studio 开发环境配置指南</h2>
<p>本文档将介绍如何在 Visual Studio 中配置 <strong>GLEW / GLFW / GLAD / OpenGL</strong> 等开发环境，包括：</p>
<ul>
<li>配置包含目录（Include Directories）</li>
<li>配置库目录（Library Directories）</li>
<li>配置源文件目录（用于 GLAD）</li>
<li>添加链接器附加依赖项</li>
<li>复制运行所需的 DLL 文件</li>
</ul>
<hr/>
<h3 data-id="heading-1">🖥 环境需求</h3>
<ul>
<li><strong>Visual Studio 2022</strong></li>
<li><strong>Windows 11（或 Windows 10）</strong></li>
</ul>
<hr/>
<h3 data-id="heading-2">📂 依赖库目录结构示例</h3>
<blockquote>
<p>下图为项目中 dependence 文件夹的结构示例。</p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b3ba55c50eed484c99f0ba35a28f75b3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP6ZmI6KaB5Yqq5Yqb:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765083842&amp;x-signature=Bk0O8bDdbQmrU4P9A9lH1TPvFc4%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-3">1️⃣ 配置包含目录（Include Directories）</h3>
<p>打开 Visual Studio：</p>
<blockquote>
<p>右键项目 → <strong>属性</strong> → <strong>VC++ 目录</strong> → <strong>包含目录</strong>
（快捷方式：选中项目后按 <strong>Alt + Enter</strong>）</p>
</blockquote>
<p>添加以下路径：</p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-variable">$(SolutionDir)</span>dependence\GLEW\<span class="hljs-keyword">include</span>
<span class="hljs-variable">$(SolutionDir)</span>dependence\GLFW\<span class="hljs-keyword">include</span>
<span class="hljs-variable">$(SolutionDir)</span>dependence\GLAD\<span class="hljs-keyword">include</span>
</code></pre>
<h3 data-id="heading-4"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fd3d84bdd7e64f7682c6a3d785958149~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP6ZmI6KaB5Yqq5Yqb:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765083842&amp;x-signature=I0c2abzBg5EXPt1EeAOYbBOWNPE%3D" alt="在这里插入图片描述" loading="lazy"/></h3>
<h3 data-id="heading-5">2️⃣ 配置库目录（Library Directories）</h3>
<p>路径：</p>
<blockquote>
<p>右键项目 → <strong>属性</strong> → <strong>VC++ 目录</strong> → <strong>库目录</strong></p>
</blockquote>
<p>添加：</p>
<pre><code class="hljs language-javascript" lang="javascript">$(<span class="hljs-title class_">SolutionDir</span>)dependence\<span class="hljs-variable constant_">GLEW</span>\lib\<span class="hljs-title class_">Release</span>\x64
$(<span class="hljs-title class_">SolutionDir</span>)dependence\<span class="hljs-variable constant_">GLFW</span>\lib-vc2022
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0b3e9952e5d748a693d97e629326b781~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP6ZmI6KaB5Yqq5Yqb:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765083842&amp;x-signature=2xS5un%2F2RV1S0M3oe6P%2FlFuufK8%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>⚠ <strong>注意：GLEW 的 lib 文件需要与你 VS 项目的平台匹配</strong></p>
<ul>
<li>
<p>如果 VS 设置为 <strong>x64</strong>，需要使用：</p>
<pre><code class="hljs language-sql" lang="sql">GLEW\lib\<span class="hljs-keyword">Release</span>\x64\
</code></pre>
</li>
<li>
<p>如果 VS 设置为 <strong>Win32（x86）</strong>，需要使用：</p>
<pre><code class="hljs language-sql" lang="sql">GLEW\lib\<span class="hljs-keyword">Release</span>\Win32\
</code></pre>
</li>
</ul>
<p>查看方式：
VS 顶部 → <code>Debug | x64</code>（这里即为 x64）</p>
<hr/>
<h3 data-id="heading-6">3️⃣ 配置源文件目录（GLAD 专用）</h3>
<p>GLAD 的实现代码在 <code>src/</code> 目录中，因此需要加入源目录，否则 GLAD 无法编译。</p>
<p>路径：</p>
<blockquote>
<p>右键项目 → <strong>属性</strong> → <strong>VC++ 目录</strong> → <strong>源文件目录</strong></p>
</blockquote>
<p>添加：</p>
<pre><code class="hljs language-scss" lang="scss">$(SolutionDir)dependence\GLAD\<span class="hljs-attribute">src</span>
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ec53a4a68669434ab9cdcc9fde1fd082~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP6ZmI6KaB5Yqq5Yqb:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765083842&amp;x-signature=96A6ujjTVlph0giDVheYm17l8Jc%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-7">4️⃣ 添加附加依赖项（Linker → Input）</h3>
<p>路径：</p>
<blockquote>
<p>项目 → <strong>属性</strong> → <strong>链接器</strong> → <strong>输入</strong></p>
</blockquote>
<p>在“附加依赖项”添加：</p>
<pre><code class="hljs language-vbnet" lang="vbnet">glfw3.<span class="hljs-keyword">lib</span>
opengl32.<span class="hljs-keyword">lib</span>
glew32.<span class="hljs-keyword">lib</span>
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d0475bf371db4cb6b49da835de5d1b74~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP6ZmI6KaB5Yqq5Yqb:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765083842&amp;x-signature=bSdY6yNrj8k28kqXe8kmuJVV6kg%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-8">5️⃣ 复制运行所需 DLL 文件（非常重要）</h3>
<p>在运行时，必须将以下 DLL 复制到：</p>
<pre><code class="hljs language-javascript" lang="javascript">$(<span class="hljs-title class_">ProjectDir</span>)x64\<span class="hljs-title class_">Debug</span>\
或
$(<span class="hljs-title class_">ProjectDir</span>)x64\<span class="hljs-title class_">Release</span>\
</code></pre>
<p>具体复制文件如下：</p>
<pre><code class="hljs language-javascript" lang="javascript">$(<span class="hljs-title class_">SolutionDir</span>)dependence\<span class="hljs-variable constant_">GLEW</span>\bin\<span class="hljs-title class_">Release</span>\x64\glew32.<span class="hljs-property">dll</span>
$(<span class="hljs-title class_">SolutionDir</span>)dependence\<span class="hljs-variable constant_">GLFW</span>\lib-vc2022\glfw3.<span class="hljs-property">dll</span>（如果 <span class="hljs-variable constant_">GLFW</span> 使用动态版本）
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0e02e793ad7740548692add0de1cb99a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP6ZmI6KaB5Yqq5Yqb:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765083842&amp;x-signature=6s9jkRkrVuM%2B31ZnU11LSzcz8ak%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>📌 <strong>注意：放到 Debug / Release 哪一个文件夹，取决于你要运行哪种模式。</strong></p>
<hr/>
<h2 data-id="heading-9">🎉 配置完成！</h2>
<p>现在你已经成功在 Visual Studio 中配置好 GLEW + GLFW + GLAD + OpenGL 环境，可以开始编写 OpenGL 程序了。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Java方法详解：提升代码复用性与可读性的利器]]></title>    <link>https://juejin.cn/post/7577969462860120127</link>    <guid>https://juejin.cn/post/7577969462860120127</guid>    <pubDate>2025-11-30T07:15:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577969462860120127" data-draft-id="7577970969395052585" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Java方法详解：提升代码复用性与可读性的利器"/> <meta itemprop="keywords" content="Java"/> <meta itemprop="datePublished" content="2025-11-30T07:15:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="BBB努力学习程序设计"/> <meta itemprop="url" content="https://juejin.cn/user/3097787706900985"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Java方法详解：提升代码复用性与可读性的利器
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3097787706900985/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    BBB努力学习程序设计
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T07:15:17.000Z" title="Sun Nov 30 2025 07:15:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>方法（Method）是一段用来完成特定功能的代码块，类似于数学中的函数。它可以把复杂的代码组织成独立的单元，让程序更加模块化、易于维护</p>
<h2 data-id="heading-0">方法的语法</h2>
<pre><code class="hljs language-Java" lang="Java">[访问修饰符] [<span class="hljs-keyword">static</span>] 返回值类型 方法名(参数列表) {
    <span class="hljs-comment">// 方法体</span>
    <span class="hljs-keyword">return</span> 返回值; <span class="hljs-comment">// 如果返回值类型不是void</span>
}
</code></pre>
<p><strong>各部分解释：</strong></p>
<ul>
<li><strong>访问修饰符</strong>：控制方法的访问权限（如public、private）</li>
<li><strong>static</strong>：表示方法是静态的（可选）</li>
<li><strong>返回值类型</strong>：方法执行后返回的数据类型</li>
<li><strong>方法名</strong>：方法的名称，要符合命名规范</li>
<li><strong>参数列表</strong>：方法接收的输入参数</li>
<li><strong>方法体</strong>：方法的具体实现代码</li>
</ul>
<h2 data-id="heading-1">代码示例</h2>
<h3 data-id="heading-2">示例1：无返回值的方法</h3>
<pre><code class="hljs language-Java" lang="Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MethodDemo1</span> {
    
    <span class="hljs-comment">// 定义一个无返回值的方法：打印欢迎信息</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">printWelcome</span><span class="hljs-params">(String name)</span> {
        System.out.println(<span class="hljs-string">"=== 欢迎使用学生管理系统 ==="</span>);
        System.out.println(<span class="hljs-string">"欢迎，"</span> + name + <span class="hljs-string">"！"</span>);
        System.out.println(<span class="hljs-string">"========================="</span>);
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 调用方法</span>
        printWelcome(<span class="hljs-string">"张三"</span>);
        printWelcome(<span class="hljs-string">"李四"</span>);
    }
}
</code></pre>
<h4 data-id="heading-3">运行结果：</h4>
<pre><code class="hljs language-Java" lang="Java">=== 欢迎使用学生管理系统 ===
欢迎，张三！
=========================
=== 欢迎使用学生管理系统 ===
欢迎，李四！
=========================
</code></pre>
<h3 data-id="heading-4">示例2：有返回值的方法</h3>
<pre><code class="hljs language-Java" lang="Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MethodDemo2</span> {
    
    <span class="hljs-comment">// 计算两个数的最大值</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getMax</span><span class="hljs-params">(<span class="hljs-type">int</span> a, <span class="hljs-type">int</span> b)</span> {
        <span class="hljs-keyword">if</span> (a &gt; b) {
            <span class="hljs-keyword">return</span> a;
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">return</span> b;
        }
    }
    
    <span class="hljs-comment">// 计算学生平均分</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">double</span> <span class="hljs-title function_">calculateAverage</span><span class="hljs-params">(<span class="hljs-type">int</span> score1, <span class="hljs-type">int</span> score2, <span class="hljs-type">int</span> score3)</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">sum</span> <span class="hljs-operator">=</span> score1 + score2 + score3;
        <span class="hljs-type">double</span> <span class="hljs-variable">average</span> <span class="hljs-operator">=</span> sum / <span class="hljs-number">3.0</span>;
        <span class="hljs-keyword">return</span> average;
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 调用getMax方法</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">max</span> <span class="hljs-operator">=</span> getMax(<span class="hljs-number">10</span>, <span class="hljs-number">20</span>);
        System.out.println(<span class="hljs-string">"最大值："</span> + max);
        
        <span class="hljs-comment">// 调用calculateAverage方法</span>
        <span class="hljs-type">double</span> <span class="hljs-variable">avg</span> <span class="hljs-operator">=</span> calculateAverage(<span class="hljs-number">85</span>, <span class="hljs-number">90</span>, <span class="hljs-number">78</span>);
        System.out.println(<span class="hljs-string">"平均分："</span> + avg);
        
        <span class="hljs-comment">// 可以重复使用</span>
        <span class="hljs-type">double</span> <span class="hljs-variable">avg2</span> <span class="hljs-operator">=</span> calculateAverage(<span class="hljs-number">92</span>, <span class="hljs-number">88</span>, <span class="hljs-number">95</span>);
        System.out.println(<span class="hljs-string">"第二个学生平均分："</span> + avg2);
    }
}
</code></pre>
<h4 data-id="heading-5">运行结果：</h4>
<pre><code class="hljs language-Java" lang="Java">最大值：<span class="hljs-number">20</span>
平均分：<span class="hljs-number">84.33333333333333</span>
第二个学生平均分：<span class="hljs-number">91.66666666666667</span>
</code></pre>
<h3 data-id="heading-6">示例3：完整的学生成绩管理示例</h3>
<pre><code class="hljs language-Java" lang="Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StudentManager</span> {
    
    <span class="hljs-comment">// 计算平均分</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">double</span> <span class="hljs-title function_">calculateAverage</span><span class="hljs-params">(<span class="hljs-type">int</span>[] scores)</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">sum</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> score : scores) {
            sum += score;
        }
        <span class="hljs-keyword">return</span> (<span class="hljs-type">double</span>) sum / scores.length;
    }
    
    <span class="hljs-comment">// 判断成绩等级</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getGradeLevel</span><span class="hljs-params">(<span class="hljs-type">double</span> average)</span> {
        <span class="hljs-keyword">if</span> (average &gt;= <span class="hljs-number">90</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-string">"优秀"</span>;
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (average &gt;= <span class="hljs-number">80</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-string">"良好"</span>;
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (average &gt;= <span class="hljs-number">70</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-string">"中等"</span>;
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (average &gt;= <span class="hljs-number">60</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-string">"及格"</span>;
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-string">"不及格"</span>;
        }
    }
    
    <span class="hljs-comment">// 显示学生信息</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">displayStudentInfo</span><span class="hljs-params">(String name, <span class="hljs-type">int</span>[] scores, 
                                         <span class="hljs-type">double</span> average, String level)</span> {
        System.out.println(<span class="hljs-string">"\n=== 学生成绩报告 ==="</span>);
        System.out.println(<span class="hljs-string">"姓名："</span> + name);
        System.out.print(<span class="hljs-string">"各科成绩："</span>);
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> score : scores) {
            System.out.print(score + <span class="hljs-string">" "</span>);
        }
        System.out.println(<span class="hljs-string">"\n平均分："</span> + String.format(<span class="hljs-string">"%.2f"</span>, average));
        System.out.println(<span class="hljs-string">"等级："</span> + level);
        System.out.println(<span class="hljs-string">"==================="</span>);
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 学生1的信息</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">student1</span> <span class="hljs-operator">=</span> <span class="hljs-string">"张三"</span>;
        <span class="hljs-type">int</span>[] scores1 = {<span class="hljs-number">85</span>, <span class="hljs-number">90</span>, <span class="hljs-number">78</span>, <span class="hljs-number">92</span>, <span class="hljs-number">88</span>};
        
        <span class="hljs-comment">// 学生2的信息</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">student2</span> <span class="hljs-operator">=</span> <span class="hljs-string">"李四"</span>;
        <span class="hljs-type">int</span>[] scores2 = {<span class="hljs-number">95</span>, <span class="hljs-number">98</span>, <span class="hljs-number">92</span>, <span class="hljs-number">96</span>, <span class="hljs-number">90</span>};
        
        <span class="hljs-comment">// 处理第一个学生</span>
        <span class="hljs-type">double</span> <span class="hljs-variable">avg1</span> <span class="hljs-operator">=</span> calculateAverage(scores1);
        <span class="hljs-type">String</span> <span class="hljs-variable">level1</span> <span class="hljs-operator">=</span> getGradeLevel(avg1);
        displayStudentInfo(student1, scores1, avg1, level1);
        
        <span class="hljs-comment">// 处理第二个学生</span>
        <span class="hljs-type">double</span> <span class="hljs-variable">avg2</span> <span class="hljs-operator">=</span> calculateAverage(scores2);
        <span class="hljs-type">String</span> <span class="hljs-variable">level2</span> <span class="hljs-operator">=</span> getGradeLevel(avg2);
        displayStudentInfo(student2, scores2, avg2, level2);
    }
}
</code></pre>
<h4 data-id="heading-7">运行结果：</h4>
<pre><code class="hljs language-Java" lang="Java">=== 学生成绩报告 ===
姓名：张三
各科成绩：<span class="hljs-number">85</span> <span class="hljs-number">90</span> <span class="hljs-number">78</span> <span class="hljs-number">92</span> <span class="hljs-number">88</span> 
平均分：<span class="hljs-number">86.60</span>
等级：良好
===================

=== 学生成绩报告 ===
姓名：李四
各科成绩：<span class="hljs-number">95</span> <span class="hljs-number">98</span> <span class="hljs-number">92</span> <span class="hljs-number">96</span> <span class="hljs-number">90</span> 
平均分：<span class="hljs-number">94.20</span>
等级：优秀
===================
</code></pre>
<h2 data-id="heading-8">总结</h2>
<p><strong>最重要的知识点：方法的核心价值在于代码复用和逻辑封装</strong></p>
<ul>
<li><strong>代码复用</strong>：一次编写，多次调用，避免重复代码</li>
<li><strong>逻辑封装</strong>：将复杂功能拆分成小方法，提高可读性和可维护性</li>
<li><strong>模块化设计</strong>：每个方法专注完成一个特定任务</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Java运算符完全指南：让代码学会“计算”和“判断”]]></title>    <link>https://juejin.cn/post/7577969462860218431</link>    <guid>https://juejin.cn/post/7577969462860218431</guid>    <pubDate>2025-11-30T07:26:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577969462860218431" data-draft-id="7577797563853864996" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Java运算符完全指南：让代码学会“计算”和“判断”"/> <meta itemprop="keywords" content="Java"/> <meta itemprop="datePublished" content="2025-11-30T07:26:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="BBB努力学习程序设计"/> <meta itemprop="url" content="https://juejin.cn/user/3097787706900985"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Java运算符完全指南：让代码学会“计算”和“判断”
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3097787706900985/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    BBB努力学习程序设计
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T07:26:00.000Z" title="Sun Nov 30 2025 07:26:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.7;font-weight:400;font-size:16px;overflow-x:hidden;color:#212122}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-bottom:8px;padding-bottom:8px}.markdown-body h1{color:#a0a0a0;font-size:38px;margin-top:32px;padding-top:32px}.markdown-body h2{color:#fff;background-color:#212122;width:fit-content;border-bottom-right-radius:100px;margin-top:47px;margin-bottom:16px;padding:4px 48px 4px 8px;line-height:1.7;font-size:30px;transition:all .3s ease-out}.markdown-body h2:hover{border-bottom-right-radius:50px;transition:all .3s ease-out}.markdown-body h3{font-size:24px;padding-left:8px;margin-top:32px;border-bottom:2px solid #c6c4c4;line-height:1.7}.markdown-body h4{font-size:20px;padding-left:8px;margin-top:32px;border-bottom:1px solid #ddd}.markdown-body h5{font-size:16px;margin-top:24px}.markdown-body h6{margin-top:16px;line-height:1.1}.markdown-body p{font-size:16px;text-align:start;white-space:normal;text-size-adjust:auto;line-height:2;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%;margin:auto;padding-left:8px;padding-right:8px}.markdown-body hr{border:none;border-top:4px double #212122;margin-top:32px;margin-bottom:32px;text-align:center}.markdown-body hr:after{content:"♥";display:inline-block;position:relative;top:-15px;padding:0 10px;color:#212122;font-size:18px}.markdown-body code{word-break:break-word;overflow-x:auto;background-color:#f1f1f1;color:#ef7060;font-size:14px;padding:.065em 6px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;border-radius:2px}.markdown-body pre{overflow:auto;position:relative;line-height:1.7;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);margin:32px 16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-color:#212122;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);background-size:40px}.markdown-body pre&gt;code{font-size:14px;padding:16px 8px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#fff;background:#272822}.markdown-body pre&gt;code::-webkit-scrollbar{height:10px;background-color:#f5f5f5}.markdown-body pre&gt;code::-webkit-scrollbar-track{box-shadow:inset 0 0 6px rgba(0,0,0,.3);border-radius:3px;background-color:#f5f5f5}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{border-radius:3px;box-shadow:inset 0 0 6px rgba(0,0,0,.3);background-color:#555}.markdown-body a{color:#ef7060;padding:2px;text-decoration:none;border-bottom:.125em solid #ef7060;border-radius:2px;box-shadow:inset 0 -.025em 0 #ef7060;transition:box-shadow .27s cubic-bezier(.77,0,.175,1),color .27s cubic-bezier(.77,0,.175,1)}.markdown-body a:focus,.markdown-body a:hover{outline:none;box-shadow:inset 0 -1.5em 0 #ef7060;color:#fff}.markdown-body a:before{content:"⇲ ";vertical-align:top;margin-left:2px;font-family:dart!important;font-size:12px;color:inherit;opacity:.7}.markdown-body table{background:#fbfbfb;border-radius:4px;border-collapse:collapse;margin:auto;padding:5px;width:95%;box-shadow:0 5px 10px rgba(0,0,0,.1);animation:float 5s infinite}.markdown-body table th{color:#fff;background:#212122;border-bottom:1px solid #9ea7af;border-right:1px solid #343a45;font-size:18px;padding:16px;text-align:left;vertical-align:middle}.markdown-body table th:first-child{border-top-left-radius:4px}.markdown-body table th:last-child{border-top-right-radius:4px;border-right:none}.markdown-body table tr{border-top:1px solid #c1c3d1;border-bottom:1px solid #c1c3d1;color:#666b85}.markdown-body table tr:hover td{background:#212122;color:#fff;border-top:1px solid #22262e}.markdown-body table tr:first-child{border-top:none}.markdown-body table tr:last-child{border-bottom:none}.markdown-body table tr:nth-child(odd) td{background:#f1f1f1}.markdown-body table tr:nth-child(odd):hover td{background:#212122}.markdown-body table tr:last-child td:first-child{border-bottom-left-radius:4px}.markdown-body table tr:last-child td:last-child{border-bottom-right-radius:4px}.markdown-body table td{background:#fbfbfb;padding:16px;text-align:left;vertical-align:middle;font-size:16px;border-right:1px solid #c1c3d1}.markdown-body table td:last-child{border-right:0}.markdown-body blockquote{color:#777;padding:1px 16px;margin:24px 0;border-left:4px solid #c6c4c4;background-color:#f1f1f1;transition:all .3s ease-out;border-radius:4px}.markdown-body blockquote:hover{border-left-color:#212122;background-color:#212122;color:#fff}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:24px}.markdown-body ol li,.markdown-body ul li{margin-bottom:6px;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body span.math{margin-left:32px;font-size:18px;font-weight:700}@media (max-width:720px){.markdown-body h1{font-size:30.4px}.markdown-body h2{font-size:24px}.markdown-body h3{font-size:19.2px}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:12.8px}}</style><style data-highlight="" data-highlight-key="a11y-light">.hljs-comment,.hljs-quote{color:#696969}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#d91e18}.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#aa5d00}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:green}.hljs-section,.hljs-title{color:#007faa}.hljs-keyword,.hljs-selector-tag{color:#7928a1}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fefefe;color:#545454}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><p>运算符是用来对变量和值进行各种操作的符号。比如我们熟悉的加减乘除（+、-、*、/）就是运算符</p>
<h2 data-id="heading-0">运算符分类及代码示例</h2>
<h3 data-id="heading-1">1. 算术运算符：进行数学计算</h3>
<pre><code class="hljs language-Java" lang="Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ArithmeticOperators</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> <span class="hljs-number">15</span>;
        <span class="hljs-type">int</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> <span class="hljs-number">4</span>;
        
        System.out.println(<span class="hljs-string">"=== 算术运算符示例 ==="</span>);
        System.out.println(<span class="hljs-string">"a = "</span> + a + <span class="hljs-string">", b = "</span> + b);
        System.out.println(<span class="hljs-string">"加法 a + b = "</span> + (a + b));      <span class="hljs-comment">// 19</span>
        System.out.println(<span class="hljs-string">"减法 a - b = "</span> + (a - b));      <span class="hljs-comment">// 11</span>
        System.out.println(<span class="hljs-string">"乘法 a * b = "</span> + (a * b));      <span class="hljs-comment">// 60</span>
        System.out.println(<span class="hljs-string">"除法 a / b = "</span> + (a / b));      <span class="hljs-comment">// 3（整数除法）</span>
        System.out.println(<span class="hljs-string">"取余 a % b = "</span> + (a % b));      <span class="hljs-comment">// 3（15÷4=3余3）</span>
        
        <span class="hljs-comment">// 浮点数除法</span>
        <span class="hljs-type">double</span> <span class="hljs-variable">x</span> <span class="hljs-operator">=</span> <span class="hljs-number">15.0</span>;
        <span class="hljs-type">double</span> <span class="hljs-variable">y</span> <span class="hljs-operator">=</span> <span class="hljs-number">4.0</span>;
        System.out.println(<span class="hljs-string">"浮点除法 x / y = "</span> + (x / y));  <span class="hljs-comment">// 3.75</span>
        
        <span class="hljs-comment">// 自增自减</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> <span class="hljs-number">5</span>;
        System.out.println(<span class="hljs-string">"初始count = "</span> + count);
        count++;  <span class="hljs-comment">// 相当于 count = count + 1</span>
        System.out.println(<span class="hljs-string">"count++后 = "</span> + count);  <span class="hljs-comment">// 6</span>
        count--;  <span class="hljs-comment">// 相当于 count = count - 1</span>
        System.out.println(<span class="hljs-string">"count--后 = "</span> + count);  <span class="hljs-comment">// 5</span>
    }
}
</code></pre>
<h4 data-id="heading-2">运行结果：</h4>
<pre><code class="hljs language-Java" lang="Java">=== 算术运算符示例 ===
a = <span class="hljs-number">15</span>, b = <span class="hljs-number">4</span>
加法 a + b = <span class="hljs-number">19</span>
减法 a - b = <span class="hljs-number">11</span>
乘法 a * b = <span class="hljs-number">60</span>
除法 a / b = <span class="hljs-number">3</span>
取余 a % b = <span class="hljs-number">3</span>
浮点除法 x / y = <span class="hljs-number">3.75</span>
初始count = <span class="hljs-number">5</span>
count++后 = <span class="hljs-number">6</span>
count--后 = <span class="hljs-number">5</span>
</code></pre>
<h3 data-id="heading-3">2. 关系运算符：进行比较判断</h3>
<pre><code class="hljs language-Java" lang="Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RelationalOperators</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">score1</span> <span class="hljs-operator">=</span> <span class="hljs-number">85</span>;
        <span class="hljs-type">int</span> <span class="hljs-variable">score2</span> <span class="hljs-operator">=</span> <span class="hljs-number">90</span>;
        <span class="hljs-type">int</span> <span class="hljs-variable">passingScore</span> <span class="hljs-operator">=</span> <span class="hljs-number">60</span>;
        
        System.out.println(<span class="hljs-string">"=== 关系运算符示例 ==="</span>);
        System.out.println(<span class="hljs-string">"score1 = "</span> + score1 + <span class="hljs-string">", score2 = "</span> + score2);
        System.out.println(<span class="hljs-string">"score1 &gt; score2: "</span> + (score1 &gt; score2));      <span class="hljs-comment">// false</span>
        System.out.println(<span class="hljs-string">"score1 &lt; score2: "</span> + (score1 &lt; score2));      <span class="hljs-comment">// true</span>
        System.out.println(<span class="hljs-string">"score1 &gt;= passingScore: "</span> + (score1 &gt;= passingScore)); <span class="hljs-comment">// true</span>
        System.out.println(<span class="hljs-string">"score2 &lt;= 100: "</span> + (score2 &lt;= <span class="hljs-number">100</span>));          <span class="hljs-comment">// true</span>
        System.out.println(<span class="hljs-string">"score1 == 85: "</span> + (score1 == <span class="hljs-number">85</span>));            <span class="hljs-comment">// true</span>
        System.out.println(<span class="hljs-string">"score1 != score2: "</span> + (score1 != score2));    <span class="hljs-comment">// true</span>
        
        <span class="hljs-comment">// 实际应用：判断成绩是否及格</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">myScore</span> <span class="hljs-operator">=</span> <span class="hljs-number">75</span>;
        <span class="hljs-type">boolean</span> <span class="hljs-variable">isPass</span> <span class="hljs-operator">=</span> myScore &gt;= passingScore;
        System.out.println(<span class="hljs-string">"成绩"</span> + myScore + <span class="hljs-string">"分是否及格: "</span> + isPass);
    }
}
</code></pre>
<h4 data-id="heading-4">运行结果：</h4>
<pre><code class="hljs language-Java" lang="Java">=== 关系运算符示例 ===
score1 = <span class="hljs-number">85</span>, score2 = <span class="hljs-number">90</span>
score1 &gt; score2: <span class="hljs-literal">false</span>
score1 &lt; score2: <span class="hljs-literal">true</span>
score1 &gt;= passingScore: <span class="hljs-literal">true</span>
score2 &lt;= <span class="hljs-number">100</span>: <span class="hljs-literal">true</span>
score1 == <span class="hljs-number">85</span>: <span class="hljs-literal">true</span>
score1 != score2: <span class="hljs-literal">true</span>
成绩<span class="hljs-number">75</span>分是否及格: <span class="hljs-literal">true</span>
</code></pre>
<h3 data-id="heading-5">3. 逻辑运算符：组合多个条件</h3>
<pre><code class="hljs language-Java" lang="Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LogicalOperators</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">boolean</span> <span class="hljs-variable">isStudent</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;
        <span class="hljs-type">boolean</span> <span class="hljs-variable">hasIDCard</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;
        <span class="hljs-type">int</span> <span class="hljs-variable">age</span> <span class="hljs-operator">=</span> <span class="hljs-number">20</span>;
        <span class="hljs-type">double</span> <span class="hljs-variable">balance</span> <span class="hljs-operator">=</span> <span class="hljs-number">150.0</span>;
        
        System.out.println(<span class="hljs-string">"=== 逻辑运算符示例 ==="</span>);
        
        <span class="hljs-comment">// &amp;&amp;（与）：两个条件都满足</span>
        <span class="hljs-type">boolean</span> <span class="hljs-variable">canBorrowBook</span> <span class="hljs-operator">=</span> isStudent &amp;&amp; hasIDCard;
        System.out.println(<span class="hljs-string">"可以借书（是学生且有证件）: "</span> + canBorrowBook);
        
        <span class="hljs-comment">// ||（或）：至少满足一个条件</span>
        <span class="hljs-type">boolean</span> <span class="hljs-variable">canWatchMovie</span> <span class="hljs-operator">=</span> (age &gt;= <span class="hljs-number">18</span>) || (age &lt; <span class="hljs-number">18</span> &amp;&amp; balance &gt; <span class="hljs-number">100</span>);
        System.out.println(<span class="hljs-string">"可以看电影（年满18岁或有钱的未成年人）: "</span> + canWatchMovie);
        
        <span class="hljs-comment">// !（非）：取反</span>
        <span class="hljs-type">boolean</span> <span class="hljs-variable">isNotStudent</span> <span class="hljs-operator">=</span> !isStudent;
        System.out.println(<span class="hljs-string">"不是学生: "</span> + isNotStudent);
        
        <span class="hljs-comment">// 复杂条件：学生优惠条件</span>
        <span class="hljs-type">boolean</span> <span class="hljs-variable">studentDiscount</span> <span class="hljs-operator">=</span> isStudent &amp;&amp; (age &lt; <span class="hljs-number">22</span>) &amp;&amp; (balance &gt; <span class="hljs-number">50</span>);
        System.out.println(<span class="hljs-string">"享受学生优惠: "</span> + studentDiscount);
        
        <span class="hljs-comment">// 实际场景：登录验证</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">username</span> <span class="hljs-operator">=</span> <span class="hljs-string">"admin"</span>;
        <span class="hljs-type">String</span> <span class="hljs-variable">password</span> <span class="hljs-operator">=</span> <span class="hljs-string">"123456"</span>;
        <span class="hljs-type">boolean</span> <span class="hljs-variable">isValidUser</span> <span class="hljs-operator">=</span> username.equals(<span class="hljs-string">"admin"</span>) &amp;&amp; password.equals(<span class="hljs-string">"123456"</span>);
        System.out.println(<span class="hljs-string">"用户登录成功: "</span> + isValidUser);
    }
}
</code></pre>
<h4 data-id="heading-6">运行结果：</h4>
<pre><code class="hljs language-Java" lang="Java">=== 逻辑运算符示例 ===
可以借书（是学生且有证件）: <span class="hljs-literal">true</span>
可以看电影（年满<span class="hljs-number">18</span>岁或有钱的未成年人）: <span class="hljs-literal">true</span>
不是学生: <span class="hljs-literal">false</span>
享受学生优惠: <span class="hljs-literal">true</span>
用户登录成功: <span class="hljs-literal">true</span>
</code></pre>
<h3 data-id="heading-7">4. 赋值运算符：给变量赋值</h3>
<pre><code class="hljs language-Java" lang="Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AssignmentOperators</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        System.out.println(<span class="hljs-string">"=== 赋值运算符示例 ==="</span>);
        
        <span class="hljs-comment">// 基本赋值</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">total</span> <span class="hljs-operator">=</span> <span class="hljs-number">100</span>;
        System.out.println(<span class="hljs-string">"初始total = "</span> + total);
        
        <span class="hljs-comment">// 复合赋值</span>
        total += <span class="hljs-number">50</span>;  <span class="hljs-comment">// 相当于 total = total + 50</span>
        System.out.println(<span class="hljs-string">"total += 50 后: "</span> + total);
        
        total -= <span class="hljs-number">30</span>;  <span class="hljs-comment">// 相当于 total = total - 30</span>
        System.out.println(<span class="hljs-string">"total -= 30 后: "</span> + total);
        
        total *= <span class="hljs-number">2</span>;   <span class="hljs-comment">// 相当于 total = total * 2</span>
        System.out.println(<span class="hljs-string">"total *= 2 后: "</span> + total);
        
        total /= <span class="hljs-number">4</span>;   <span class="hljs-comment">// 相当于 total = total / 4</span>
        System.out.println(<span class="hljs-string">"total /= 4 后: "</span> + total);
        
        total %= <span class="hljs-number">3</span>;   <span class="hljs-comment">// 相当于 total = total % 3</span>
        System.out.println(<span class="hljs-string">"total %= 3 后: "</span> + total);
        
        <span class="hljs-comment">// 字符串拼接</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> <span class="hljs-string">"Hello"</span>;
        message += <span class="hljs-string">" World"</span>;  <span class="hljs-comment">// 相当于 message = message + " World"</span>
        message += <span class="hljs-string">"!"</span>;
        System.out.println(<span class="hljs-string">"拼接后的消息: "</span> + message);
    }
}
</code></pre>
<h4 data-id="heading-8">运行结果：</h4>
<pre><code class="hljs language-Java" lang="Java">=== 赋值运算符示例 ===
初始total = <span class="hljs-number">100</span>
total += <span class="hljs-number">50</span> 后: <span class="hljs-number">150</span>
total -= <span class="hljs-number">30</span> 后: <span class="hljs-number">120</span>
total *= <span class="hljs-number">2</span> 后: <span class="hljs-number">240</span>
total /= <span class="hljs-number">4</span> 后: <span class="hljs-number">60</span>
total %= <span class="hljs-number">3</span> 后: <span class="hljs-number">0</span>
拼接后的消息: Hello World!
</code></pre>
<h3 data-id="heading-9">5. 条件运算符（三元运算符）：简洁的条件判断</h3>
<pre><code class="hljs language-Java" lang="Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConditionalOperator</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">score1</span> <span class="hljs-operator">=</span> <span class="hljs-number">85</span>;
        <span class="hljs-type">int</span> <span class="hljs-variable">score2</span> <span class="hljs-operator">=</span> <span class="hljs-number">92</span>;
        
        System.out.println(<span class="hljs-string">"=== 条件运算符示例 ==="</span>);
        
        <span class="hljs-comment">// 语法：条件 ? 值1 : 值2</span>
        <span class="hljs-comment">// 如果条件为true，返回值1；否则返回值2</span>
        
        <span class="hljs-comment">// 找出较大的分数</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">maxScore</span> <span class="hljs-operator">=</span> (score1 &gt; score2) ? score1 : score2;
        System.out.println(<span class="hljs-string">"较大分数: "</span> + maxScore);
        
        <span class="hljs-comment">// 判断成绩等级</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">testScore</span> <span class="hljs-operator">=</span> <span class="hljs-number">78</span>;
        <span class="hljs-type">String</span> <span class="hljs-variable">grade</span> <span class="hljs-operator">=</span> (testScore &gt;= <span class="hljs-number">90</span>) ? <span class="hljs-string">"优秀"</span> : 
                      (testScore &gt;= <span class="hljs-number">80</span>) ? <span class="hljs-string">"良好"</span> : 
                      (testScore &gt;= <span class="hljs-number">70</span>) ? <span class="hljs-string">"中等"</span> : 
                      (testScore &gt;= <span class="hljs-number">60</span>) ? <span class="hljs-string">"及格"</span> : <span class="hljs-string">"不及格"</span>;
        System.out.println(<span class="hljs-string">"成绩"</span> + testScore + <span class="hljs-string">"分的等级: "</span> + grade);
        
        <span class="hljs-comment">// 判断奇偶数</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">number</span> <span class="hljs-operator">=</span> <span class="hljs-number">15</span>;
        <span class="hljs-type">String</span> <span class="hljs-variable">parity</span> <span class="hljs-operator">=</span> (number % <span class="hljs-number">2</span> == <span class="hljs-number">0</span>) ? <span class="hljs-string">"偶数"</span> : <span class="hljs-string">"奇数"</span>;
        System.out.println(number + <span class="hljs-string">"是"</span> + parity);
    }
}
</code></pre>
<h4 data-id="heading-10">运行结果：</h4>
<pre><code class="hljs language-Java" lang="Java">=== 条件运算符示例 ===
较大分数: <span class="hljs-number">92</span>
成绩<span class="hljs-number">78</span>分的等级: 中等
<span class="hljs-number">15</span>是奇数
</code></pre>
<h3 data-id="heading-11">6. 综合示例：学生成绩评定系统</h3>
<pre><code class="hljs language-Java" lang="Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StudentGradeSystem</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 学生信息</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">studentName</span> <span class="hljs-operator">=</span> <span class="hljs-string">"张三"</span>;
        <span class="hljs-type">int</span> <span class="hljs-variable">mathScore</span> <span class="hljs-operator">=</span> <span class="hljs-number">85</span>;
        <span class="hljs-type">int</span> <span class="hljs-variable">englishScore</span> <span class="hljs-operator">=</span> <span class="hljs-number">92</span>;
        <span class="hljs-type">int</span> <span class="hljs-variable">programmingScore</span> <span class="hljs-operator">=</span> <span class="hljs-number">78</span>;
        <span class="hljs-type">boolean</span> <span class="hljs-variable">hasGoodAttendance</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;
        
        System.out.println(<span class="hljs-string">"=== 学生成绩评定系统 ==="</span>);
        System.out.println(<span class="hljs-string">"学生姓名: "</span> + studentName);
        System.out.println(<span class="hljs-string">"数学成绩: "</span> + mathScore);
        System.out.println(<span class="hljs-string">"英语成绩: "</span> + englishScore);
        System.out.println(<span class="hljs-string">"编程成绩: "</span> + programmingScore);
        
        <span class="hljs-comment">// 计算平均分</span>
        <span class="hljs-type">double</span> <span class="hljs-variable">averageScore</span> <span class="hljs-operator">=</span> (mathScore + englishScore + programmingScore) / <span class="hljs-number">3.0</span>;
        System.out.println(<span class="hljs-string">"平均成绩: "</span> + String.format(<span class="hljs-string">"%.2f"</span>, averageScore));
        
        <span class="hljs-comment">// 判断是否所有科目都及格</span>
        <span class="hljs-type">boolean</span> <span class="hljs-variable">allPass</span> <span class="hljs-operator">=</span> (mathScore &gt;= <span class="hljs-number">60</span>) &amp;&amp; (englishScore &gt;= <span class="hljs-number">60</span>) &amp;&amp; (programmingScore &gt;= <span class="hljs-number">60</span>);
        System.out.println(<span class="hljs-string">"所有科目都及格: "</span> + allPass);
        
        <span class="hljs-comment">// 判断是否有科目优秀（≥90分）</span>
        <span class="hljs-type">boolean</span> <span class="hljs-variable">hasExcellent</span> <span class="hljs-operator">=</span> (mathScore &gt;= <span class="hljs-number">90</span>) || (englishScore &gt;= <span class="hljs-number">90</span>) || (programmingScore &gt;= <span class="hljs-number">90</span>);
        System.out.println(<span class="hljs-string">"有优秀科目: "</span> + hasExcellent);
        
        <span class="hljs-comment">// 综合评定</span>
        <span class="hljs-type">boolean</span> <span class="hljs-variable">goodStudent</span> <span class="hljs-operator">=</span> (averageScore &gt;= <span class="hljs-number">80</span>) &amp;&amp; hasGoodAttendance &amp;&amp; allPass;
        System.out.println(<span class="hljs-string">"优秀学生评定: "</span> + goodStudent);
        
        <span class="hljs-comment">// 使用三元运算符给出建议</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">advice</span> <span class="hljs-operator">=</span> (averageScore &gt;= <span class="hljs-number">85</span>) ? <span class="hljs-string">"继续保持优秀表现！"</span> :
                       (averageScore &gt;= <span class="hljs-number">70</span>) ? <span class="hljs-string">"表现良好，继续努力！"</span> :
                       <span class="hljs-string">"需要加倍努力，加油！"</span>;
        System.out.println(<span class="hljs-string">"学习建议: "</span> + advice);
    }
}
</code></pre>
<h4 data-id="heading-12">运行结果：</h4>
<pre><code class="hljs language-Java" lang="Java">=== 学生成绩评定系统 ===
学生姓名: 张三
数学成绩: <span class="hljs-number">85</span>
英语成绩: <span class="hljs-number">92</span>
编程成绩: <span class="hljs-number">78</span>
平均成绩: <span class="hljs-number">85.00</span>
所有科目都及格: <span class="hljs-literal">true</span>
有优秀科目: <span class="hljs-literal">true</span>
优秀学生评定: <span class="hljs-literal">true</span>
学习建议: 继续保持优秀表现！
</code></pre>
<h2 data-id="heading-13">注意事项</h2>
<ol>
<li><strong>运算符优先级</strong>：乘除优先于加减，逻辑非&gt;算术&gt;关系&gt;逻辑与&gt;逻辑或&gt;赋值</li>
<li><strong>整数除法陷阱</strong>：<code>5 / 2</code> 结果是2而不是2.5，要得到小数需用<code>5.0 / 2</code></li>
<li><strong>短路求值</strong>：<code>&amp;&amp;</code>和<code>||</code>会出现短路现象，第一个条件能确定结果时不再计算第二个条件</li>
<li><strong>比较浮点数</strong>：不要直接用<code>==</code>比较浮点数，因为精度问题可能导致错误</li>
<li><strong>=和==区别</strong>：<code>=</code>是赋值，<code>==</code>是比较，初学者容易混淆</li>
<li><strong>复合赋值</strong>：<code>a += b</code> 等价于 <code>a = a + b</code>，但更简洁高效</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[5. 实现]]></title>    <link>https://juejin.cn/post/7577737385954951178</link>    <guid>https://juejin.cn/post/7577737385954951178</guid>    <pubDate>2025-11-30T08:11:18.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577737385954951178" data-draft-id="7577668116525908014" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="5. 实现"/> <meta itemprop="keywords" content="C++"/> <meta itemprop="datePublished" content="2025-11-30T08:11:18.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序猿本员"/> <meta itemprop="url" content="https://juejin.cn/user/3868510676597259"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            5. 实现
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3868510676597259/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序猿本员
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T08:11:18.000Z" title="Sun Nov 30 2025 08:11:18 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">小结</h2>
<ol>
<li>本章讨论的是实现（即函数体、类的编写）的效率、封装性以及安全性入手</li>
<li>效率方面需要注意的是<strong>延后变量定义时间、尽可能少做转型、inline的使用</strong>，以及<strong>降低多文件之间的依存性</strong>，这样可以提高编译效率</li>
<li>封装性方面注意<strong>不要返回class的handles</strong></li>
<li>安全性则是注意异常安全函数的定义：不会内存泄露以及不允许数据破坏</li>
</ol>
<h2 data-id="heading-1">26. 尽可能延后变量定义式的出现时间</h2>
<ol>
<li>如果一次性定义完，可能会因为异常等改变代码逻辑，进而部分变量都没有被使用过</li>
<li>最好是延迟定义到能给出该变量初始值的时候</li>
<li>循环，定义外部：则会<strong>一次构造、析构，n次赋值</strong>；定义内部：则会<strong>n次构造、析构</strong>。定义外部会导致作用域扩大，<strong>优先推荐定义内部</strong>，但是如果明确知道赋值成本比构造析构成本低且效率高度敏感，则定义外部</li>
</ol>
<h2 data-id="heading-2">27. 尽量少做转型动作</h2>
<ol>
<li>尽可能使用新式转型，唯一使用旧式转型<code>T()</code>是调用explicit构造函数将一个对象传递给一个函数：<code>do(Widget(15));==do(static_cast&lt;Widget&gt;(15);==do({15}))</code></li>
<li>对于const、reinterpret转型不会有其他操作，但是对于<strong>static、dynamic、部分隐式转换</strong>自定义类型，在无优化情况下，都是会先构造临时变量，再有后续操作；</li>
</ol>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/686c02f560bf47f4ab62fc59118574ad~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP54y_5pys5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765095078&amp;x-signature=fa9h45nV0QD%2BqHoVT9YznRRGLTA%3D" alt="无标题.png" loading="lazy"/></p>
<p>甚至对于指针部分，也可能会因为隐式转换而导致值不一样；</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Base</span>{...};
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Derived</span>:<span class="hljs-keyword">public</span> Base{...};
Derived d;
Base* pb = &amp;d;<span class="hljs-comment">// 这里隐喻就是Derived* 转换成 Base*，两者地址值可能不同，与对象内存布局有关</span>
</code></pre>
<blockquote>
<p>对象内存布局和地址计算方式与编译器有关，所以不要试图去了解对象内存布局</p>
</blockquote>
<ol start="3">
<li>dynamic性能不高，因为至少需要比较名称字符串，有多少层继承就需要比较多少次，避免使用dynamic方式：<strong>1. 直接使用derived对象的指针；2. 借助虚函数，在base中申明所有接口，就不需要去向下转换了</strong></li>
</ol>
<h2 data-id="heading-3">28. 避免返回handles指向对象内部成分</h2>
<ol>
<li>handles：referenc、指针和迭代器</li>
<li>返回了指向内部成员的handle，有降低对象封装性的风险，如果需要返回，也必须加上<code>const</code></li>
<li>但是尽管加上const，依然是将handle暴露在比其所指对象更长寿的环境中，可能handle指向的对象已经被释放，但是外部代码依然保留着该handle</li>
<li><code>operator[]</code>就需要返回reference指向内部成员，但是这种情况很少</li>
</ol>
<h2 data-id="heading-4">29. 为异常安全而努力是值得的</h2>
<blockquote>
<p>异常安全函数：<strong>1. 不泄露任何资源；2. 不允许数据破坏</strong></p>
</blockquote>
<ol>
<li>不泄露资源：RAII</li>
<li>不允许数据破坏：
<ul>
<li>基本承诺：异常抛出所有对象处于合理的状态，真实状态是未知的，比如换背景图报错，那背景图要么是之前的要么是默认的</li>
<li>强烈保证：异常抛出程序状态不会被改变，即背景图还是之前的，即要么成功要么失败，并不是对所有函数都可实现或具备现实意义</li>
<li>不抛掷保证：承诺不抛出异常，总能完成他们原先承诺的功能，比如作用于内置类型身上所有的操作</li>
</ul>
<blockquote>
<p>noexcept，声明和定义都需要写出，承诺不抛出异常，如果直接、间接抛出（如调取的函数抛出异常）都会导致程序直接结束，单数<strong>标记这个的函数并不一定是异常安全函数，比如还存在内存泄露风险</strong></p>
</blockquote>
</li>
<li>copy-and-swap能提供基本承诺，为原本要修改的对象创建副本，然后在那副本身上做一切必要修改</li>
<li>pimpl(implementation)：将所有隶属对象的数据从原对象放进另一个对象内，然后赋予原对象一个指针指向那个所谓的实现对象，互斥锁依然处于原对象，用于保护对pimpl的访问</li>
<li>做到上面两种方式，并不是强烈保证，见下面解释</li>
<li>因为cpp中并入了很多并非异常安全代码，所以cpp并不具备异常安全，如果函数中调用了传统代码且没有try-catch手段，则函数“无任何保证”</li>
</ol>
<h2 data-id="heading-5">30. 绝大多数inlining的里里外外</h2>
<blockquote>
<p>inline只是对编译器的一个申请，而不是强制命令，可明确提出，也可隐喻提出（将函数定义于class内，甚至包括友元函数）</p>
</blockquote>
<ol>
<li><strong>inline函数一定是位于头文件的，因为在编译器阶段就需要进行替换，同理还有template</strong></li>
<li>inline与virtual其实是相反的，后者运行时才确定代码</li>
<li>inline声明的函数可能还是会有<strong>函数本体</strong>，如果存在程序需要取某个inline函数地址，比如编译器会要求构造、析构函数的函数指正，即生成其outline副本</li>
<li>构造、析构其实很复杂，并不是我们所编写那么简单，比如有异常抛出，需要释放掉之前已构造好的一部分，这些是编译器加入的代码</li>
<li>实践：<strong>将大多数 inlining 限制在小型、被频繁调用的函数身上。这可使日后的调试过程和二进制升级(binary upgradability)更容易，也可使潜在的代码膨胀问题最小化，使程序的速度提升机会最大化。</strong></li>
</ol>
<h2 data-id="heading-6">31. 将文件间的编译依存关系降至最低</h2>
<blockquote>
<p>依存关系是指头文件之间的#include，标准库一般性能较高故不在这些条例之内，且标准库不允许前置声明</p>
</blockquote>
<ol>
<li>当一个类处于定义时，必须知道其定义进而确定大小</li>
<li>如果使用reference或pointers能完成任务，就不要使用objects，尽量以class声明式替换class定义式，<strong>如果不需要访问class成员，则都可以只提供声明</strong></li>
<li>为声明式和定义式提供不同的头文件（仅针对大型项目）</li>
<li>pimpl：原本对象中只有一个指针指向具体实现类，所以也只需要前置声明该实现类即可，该实现类一般定义在cpp之中，这样就能很好隐藏</li>
<li>Handle class：内部还有实现类pipml，则外部类就变成了代理类</li>
<li>Interface class：Base为抽象类，并声明所有接口，实现由Derived完成</li>
<li>上面两种class解除了接口和实现之间的耦合关系，从而降低了文件间的编译依存关系</li>
</ol>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span> { <span class="hljs-comment">// Handle Class</span>
<span class="hljs-keyword">public</span>:
    <span class="hljs-function">std::string <span class="hljs-title">name</span><span class="hljs-params">()</span> <span class="hljs-type">const</span></span>; 
    <span class="hljs-function">std::string <span class="hljs-title">birthDate</span><span class="hljs-params">()</span> <span class="hljs-type">const</span></span>;
<span class="hljs-keyword">private</span>:
    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">Impl</span>; <span class="hljs-comment">// 实现类的前向声明（完全隐藏）</span>
    std::unique_ptr&lt;Impl&gt; pImpl; <span class="hljs-comment">// 指向实现的指针（句柄）</span>
};

<span class="hljs-comment">// 实现类（内部实现）：包含数据和逻辑，不对外暴露</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">Person</span>::Impl {
    std::string name; 
    Date birthday; <span class="hljs-comment">// 实现细节（依赖 Date）</span>
    <span class="hljs-function">std::string <span class="hljs-title">birthDate</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>{ <span class="hljs-keyword">return</span> birthday.<span class="hljs-built_in">toString</span>(); }
};

<span class="hljs-comment">// Handle Class 的成员函数通过 pImpl 委托给 Impl</span>
<span class="hljs-function">std::string <span class="hljs-title">Person::name</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>{ <span class="hljs-keyword">return</span> pImpl-&gt;name; }
<span class="hljs-function">std::string <span class="hljs-title">Person::birthDate</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>{ <span class="hljs-keyword">return</span> pImpl-&gt;<span class="hljs-built_in">birthDate</span>(); }
</code></pre>
<blockquote>
<p>如果Impl内部成员改变，如Date改为newDate，并不会影响依赖Person的文件，这就降低了依存关系</p>
</blockquote>
<ol start="8">
<li>实践： 头文件应该以“完全且仅有”声明式的形式存在，模板类则提供两个h文件，一个声明一个具体实现，而普通类则是将实现写入cpp文件</li>
</ol>
<blockquote>
<ul>
<li><strong>仅有声明</strong>：头文件中只包含 <strong>类/函数/模板的声明</strong>，不包含任何实现代码（如函数体、成员变量初始化等）。</li>
<li><strong>完全声明</strong>：所有需要对外暴露的接口（类、函数、模板）必须完整声明，确保用户能正确使用（如类的成员函数声明、模板的参数列表等）。</li>
</ul>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[大模型开发实战篇2：调用DeepSeek的对话接口-最佳实践]]></title>    <link>https://juejin.cn/post/7577971299743186982</link>    <guid>https://juejin.cn/post/7577971299743186982</guid>    <pubDate>2025-11-30T10:18:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577971299743186982" data-draft-id="7577971299743121446" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="大模型开发实战篇2：调用DeepSeek的对话接口-最佳实践"/> <meta itemprop="keywords" content="DeepSeek,Agent,程序员"/> <meta itemprop="datePublished" content="2025-11-30T10:18:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="AI大模型"/> <meta itemprop="url" content="https://juejin.cn/user/3817967696221534"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            大模型开发实战篇2：调用DeepSeek的对话接口-最佳实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3817967696221534/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    AI大模型
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T10:18:15.000Z" title="Sun Nov 30 2025 10:18:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>本文较长，建议点赞收藏。更多AI大模型应用开发学习视频及资料，在<a href="https://link.juejin.cn?target=https%3A%2F%2Fhy.zhipoai.cn%2F" target="_blank" title="https://hy.zhipoai.cn/" ref="nofollow noopener noreferrer">智泊AI</a>。</p>
</blockquote>
<h2 data-id="heading-0">一、发现问题</h2>
<p>本文 使用大模型对话的技巧和原则，提升对话回复的效率和质量。</p>
<p>我们来回顾下，先看下demo代码</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/461030e08b7141dba36811b45533690b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765102695&amp;x-signature=N3rbHgRo69sxKtZHWYQ%2FzO88QJg%3D" alt="" loading="lazy"/></p>
<p>这是我们调用WebApi接口的返回值，我们在使用chatgpt网页版问相同的问题，得到的结果差异很多。比如下图。大家可以测试下各种提问。而且不管是openai的大模型，还是DeepSeek都会出现这个情况。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/420bd704abef42c4ad5531b025c5b7fd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765102695&amp;x-signature=9UAt%2FXb3LMth%2BPP6UoEk20JLEH0%3D" alt="" loading="lazy"/></p>
<p>原因很好解释，chatgpt网页版调用的是基于gpt大模型进行各种微调优化后的回答，而我们直接调用gpt大模型，所以得到的结果也是不一样的。那就有很多问题了，比如：</p>
<ul>
<li>1、我们调用WebApi回答的问题是永远没有网页版本的好吗？</li>
<li>2、如何缩小这个差距，或者能否超越网页版本？</li>
<li>3、如何使用接口给的那些参数来优化对话？</li>
</ul>
<p> 今天我们就带着这些问题来聊一下对话WebAPI的最佳实践。有如下几种方式：</p>
<ol>
<li>角色设定：擅于使用 System 给GPT设定角色和任务，如“哲学大师”；</li>
<li>指令注入：在 System 中注入常驻任务指令，如“主题创作”；</li>
<li>问题拆解：将复杂问题拆解成的子问题，分步骤执行，如：Debug 和多任务；</li>
<li>分层设计：创作长篇内容，分层提问，先概览再章节，最后补充细节，如：小说生成；</li>
<li>编程思维：将prompt当做编程语言，主动设计变量、模板和正文，如：评估模型输出质量；</li>
<li>Few-Shot：基于样例的prompt设计，规范推理路径和输出样式，如：构造训练数据；</li>
</ol>
<p>接下来我们就根据这几点一一介绍。</p>
<h4 data-id="heading-1">一、大模型对话接口WebAPI调用模拟器playground</h4>
<p>OpenAI官方提供一个playground，是调用对话WebAPI的一个网页模拟器，地址如下：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fplatform.openai.com%2Fplayground%2Fchat%3Fmodels%3Dgpt-4o-mini" target="_blank" title="https://platform.openai.com/playground/chat?models=gpt-4o-mini" ref="nofollow noopener noreferrer">platform.openai.com/playground/…</a>  </p>
<p>不过需要充值，有些麻烦，我们可以使用国内的硅基流动的playground来体验一下。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fcloud.siliconflow.cn%2Fplayground%2Fchat%2F17885302723" target="_blank" title="https://cloud.siliconflow.cn/playground/chat/17885302723" ref="nofollow noopener noreferrer">cloud.siliconflow.cn/playground/…</a></p>
<p>本文都是针对system角色的内容进行优化！</p>
<h4 data-id="heading-2">二、角色设定</h4>
<p>请求参数messages里，有一个非常重要的角色system,system就是大模型在本次对话中扮演什么身份，比如大模型本次扮演的是“体育专家”，一般使用第3人称“你是xxx专家/教授等”，所以接口调用时，role=system的content内容需要重点思考。</p>
<p>1、角色设定的差异对比</p>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-symbol">system:</span><span class="hljs-string">"你是一位小学数学老师"</span>。
<span class="hljs-symbol">syetem:</span><span class="hljs-string">"你是一位博学多才的哲学家"</span>
提问：<span class="hljs-number">1</span>+<span class="hljs-number">1</span>=<span class="hljs-number">2</span>
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/737ffecd075b4f4b88ba5b44a53a3432~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765102695&amp;x-signature=LP6ixrmRKKmMLkHS4wD43OK48M8%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/149edc72569b4eb78d9179a8008b9a27~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765102695&amp;x-signature=AoFTmNiyUGB6LDl72TsxpKiY9hs%3D" alt="" loading="lazy"/></p>
<p>结果差异很大。说明system的设定非常重要。我们可以根据具体的场景，针对不同的客户群里，设置不同的system的content值，就能让大模型的回答更贴近各种客户群体的不同所想。</p>
<p>还有一些system的content常用用法，</p>
<p>模版：你是一位xxx（身份），对于我的所有问题，你都用xxx(身份)的思维解答。</p>
<p>比如：（1）你是一位小学数学老师，对于我的所有问题，你都用小学生的思维解答。</p>
<p>（2）对于我的所有问题，你都用佛学或中国哲学来回答，不要啰嗦，要有大师风范。</p>
<h4 data-id="heading-3">三、指令注入</h4>
<p>同样是对角色system的content设置，比如“主题创作”。</p>
<p> 比如1：</p>
<pre><code class="hljs language-css" lang="css">对于陈列出的每个<span class="hljs-selector-attr">[话题]</span>,创作<span class="hljs-number">100</span>字的内容，体现话题的论点，语言风趣幽默。
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b9d6c41951d244d88b61a4f6657a3c14~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765102695&amp;x-signature=%2BJs3amojA4KBD2DCIIjAZ9OZV2U%3D" alt="" loading="lazy"/></p>
<p>比如2：</p>
<pre><code class="hljs language-lua" lang="lua">您将获得一对关于同主题的文章（用<span class="hljs-comment">-------标签分隔）。首先总结每篇文章的论点，然后指出那篇文章提出了更好的论点，并解释原因。</span>
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/555391bde8e24d34b57fbad2ea45687d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765102695&amp;x-signature=Uhhu3F49l0DW5Km%2Bp%2FXVHLsWWzc%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-4">四、分步骤设定</h4>
<p>同样是对角色system的content设置。比如：</p>
<pre><code class="hljs">您将受到DEBUG问题，将每个问题分类为报错日志分析、根因可能性推断、解决方案、参考资料，分点陈列输出，格式如下所示：
报错日志分析：
根因可能性推断：
解决方案：
参考资料：
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1fcf485fa60b478393203d5cbd624532~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765102695&amp;x-signature=R%2F4dSC4aHJWR0zwUO2t8cf38m8Q%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-5">五、编程思维</h4>
<p>事例1</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/be884bc0bf094249ba41bdc60a0e7733~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765102695&amp;x-signature=6V1evbmeOiVanphjQjzb9gVojAQ%3D" alt="" loading="lazy"/></p>
<p>根据以上的事例，可以看到，system里的内容，很像我们编程的思维，第一步执行什么，第二步执行什么，最后还有统计count数。并且还有“每个”，跟我们代码里的for循环一样。</p>
<p>回答的内容可以看到整个for循环输出，计算出了count数量。</p>
<p>事例2-翻译</p>
<p>system:我输入英文，你翻译成中文，我输入中文，你翻译成英文。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0f7481a8b9d642b4b57c059e01db9d27~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765102695&amp;x-signature=Tas12VA55VdxXcNMuwQ9CrFgIVA%3D" alt="" loading="lazy"/></p>
<p>事例3-按照你的格式输出</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e7a5e4af8f9e48edbb8b0ac8e8a131a6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765102695&amp;x-signature=MK97qj2mUQz%2Bporn5QtdM%2F5V3XM%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-6">总结</h2>
<p>我们针对system角色设置内容，也是一种提示词设置方法，只有不断地测试不同的方式，才能更大程度的挖掘大模型的能力,才能更好的贴合实际的需求。</p>
<h3 data-id="heading-7">学习资源推荐</h3>
<p>如果你想更深入地学习大模型，以下是一些非常有价值的学习资源，这些资源将帮助你从不同角度学习大模型，提升你的实践能力。</p>
<blockquote>
<p>本文较长，建议点赞收藏。更多AI大模型应用开发学习视频及资料，在<a href="https://link.juejin.cn?target=https%3A%2F%2Fhy.zhipoai.cn%2F" target="_blank" title="https://hy.zhipoai.cn/" ref="nofollow noopener noreferrer">智泊AI</a>。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【LeetCode Hot100 刷题日记（19/100）】54. 螺旋矩阵 —— 数组、矩阵、模拟、双指针、层序遍历🌀]]></title>    <link>https://juejin.cn/post/7577914902430875694</link>    <guid>https://juejin.cn/post/7577914902430875694</guid>    <pubDate>2025-11-30T10:19:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577914902430875694" data-draft-id="7577914902430859310" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【LeetCode Hot100 刷题日记（19/100）】54. 螺旋矩阵 —— 数组、矩阵、模拟、双指针、层序遍历🌀 "/> <meta itemprop="keywords" content="算法,面试,程序员"/> <meta itemprop="datePublished" content="2025-11-30T10:19:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Jing_Rainbow"/> <meta itemprop="url" content="https://juejin.cn/user/1285809519198256"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【LeetCode Hot100 刷题日记（19/100）】54. 螺旋矩阵 —— 数组、矩阵、模拟、双指针、层序遍历🌀 
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1285809519198256/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Jing_Rainbow
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T10:19:29.000Z" title="Sun Nov 30 2025 10:19:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>🌀  题目链接：leetcode.cn/problems/spiral-matrix/</p>
<p>🔍 难度：中等 | 🏷️ 标签：数组、矩阵、模拟、双指针、层序遍历</p>
<p>⏱️ 目标时间复杂度：O(m×n)</p>
<p>💾 空间复杂度：O(1)（最优解） / O(m×n)（辅助空间）</p>
</blockquote>
<hr/>
<h3 data-id="heading-0">🎯 题目分析</h3>
<p>给定一个 <code>m × n</code> 的二维矩阵，要求按照 <strong>顺时针螺旋顺序</strong> 输出所有元素。<br/>
例如：</p>
<pre><code class="hljs language-text" lang="text">输入：
[
 [1, 2, 3],
 [4, 5, 6],
 [7, 8, 9]
]

输出：[1,2,3,6,9,8,7,4,5]
</code></pre>
<p>观察发现，路径是从左上角开始，按“右→下→左→上”的方向循环前进，遇到边界或已访问位置时转向。</p>
<p>这道题是典型的 <strong>“路径模拟”问题</strong>，核心在于如何控制移动方向与边界判断。<br/>
它在面试中常作为考察 <strong>逻辑思维能力、边界处理能力</strong> 的经典题目，尤其适合评估候选人对“状态转移”和“循环控制”的掌握程度。</p>
<hr/>
<h2 data-id="heading-1">✅ 核心算法及代码讲解</h2>
<h3 data-id="heading-2">🧠 方法一：模拟法（使用 visited 数组）</h3>
<p>这是最直观的解法，通过维护一个 <code>visited</code> 布尔矩阵来记录每个格子是否已被访问，并用方向数组控制移动方向。</p>
<h4 data-id="heading-3">🛠️ 关键点：</h4>
<ul>
<li>使用四个方向向量 <code>{ {0,1}, {1,0}, {0,-1}, {-1,0} }</code> 表示：右 → 下 → 左 → 上。</li>
<li>当下一步越界或已访问，则顺时针旋转方向（即 <code>(directionIndex + 1) % 4</code>）。</li>
<li>每次走一步，更新当前位置并标记为已访问。</li>
</ul>
<h4 data-id="heading-4">💡 优点：</h4>
<ul>
<li>思路清晰，容易理解。</li>
<li>适用于任意形状的网格路径模拟。</li>
</ul>
<h4 data-id="heading-5">⚠️ 缺点：</h4>
<ul>
<li>需要额外 <code>O(mn)</code> 空间存储 <code>visited</code>，不够高效。</li>
</ul>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> {
<span class="hljs-keyword">private</span>:
    <span class="hljs-type">static</span> <span class="hljs-keyword">constexpr</span> <span class="hljs-type">int</span> directions[<span class="hljs-number">4</span>][<span class="hljs-number">2</span>] = {{<span class="hljs-number">0</span>, <span class="hljs-number">1</span>}, {<span class="hljs-number">1</span>, <span class="hljs-number">0</span>}, {<span class="hljs-number">0</span>, <span class="hljs-number">-1</span>}, {<span class="hljs-number">-1</span>, <span class="hljs-number">0</span>}}; <span class="hljs-comment">// 右、下、左、上</span>
<span class="hljs-keyword">public</span>:
    <span class="hljs-function">vector&lt;<span class="hljs-type">int</span>&gt; <span class="hljs-title">spiralOrder</span><span class="hljs-params">(vector&lt;vector&lt;<span class="hljs-type">int</span>&gt;&gt;&amp; matrix)</span> </span>{
        <span class="hljs-keyword">if</span> (matrix.<span class="hljs-built_in">size</span>() == <span class="hljs-number">0</span> || matrix[<span class="hljs-number">0</span>].<span class="hljs-built_in">size</span>() == <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">return</span> {};
        }
        
        <span class="hljs-type">int</span> rows = matrix.<span class="hljs-built_in">size</span>(), columns = matrix[<span class="hljs-number">0</span>].<span class="hljs-built_in">size</span>();
        vector&lt;vector&lt;<span class="hljs-type">bool</span>&gt;&gt; <span class="hljs-built_in">visited</span>(rows, <span class="hljs-built_in">vector</span>&lt;<span class="hljs-type">bool</span>&gt;(columns)); <span class="hljs-comment">// 访问标记</span>
        <span class="hljs-type">int</span> total = rows * columns;
        <span class="hljs-function">vector&lt;<span class="hljs-type">int</span>&gt; <span class="hljs-title">order</span><span class="hljs-params">(total)</span></span>;

        <span class="hljs-type">int</span> row = <span class="hljs-number">0</span>, column = <span class="hljs-number">0</span>;
        <span class="hljs-type">int</span> directionIndex = <span class="hljs-number">0</span>; <span class="hljs-comment">// 当前方向索引</span>

        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; total; i++) {
            order[i] = matrix[row][column]; <span class="hljs-comment">// 收集当前值</span>
            visited[row][column] = <span class="hljs-literal">true</span>;    <span class="hljs-comment">// 标记已访问</span>

            <span class="hljs-comment">// 计算下一个位置</span>
            <span class="hljs-type">int</span> nextRow = row + directions[directionIndex][<span class="hljs-number">0</span>];
            <span class="hljs-type">int</span> nextColumn = column + directions[directionIndex][<span class="hljs-number">1</span>];

            <span class="hljs-comment">// 判断是否需要转向：越界 或 已访问</span>
            <span class="hljs-keyword">if</span> (nextRow &lt; <span class="hljs-number">0</span> || nextRow &gt;= rows || nextColumn &lt; <span class="hljs-number">0</span> || nextColumn &gt;= columns || visited[nextRow][nextColumn]) {
                directionIndex = (directionIndex + <span class="hljs-number">1</span>) % <span class="hljs-number">4</span>; <span class="hljs-comment">// 顺时针转</span>
            }

            <span class="hljs-comment">// 更新位置</span>
            row += directions[directionIndex][<span class="hljs-number">0</span>];
            column += directions[directionIndex][<span class="hljs-number">1</span>];
        }
        <span class="hljs-keyword">return</span> order;
    }
};
</code></pre>
<blockquote>
<p>✅ 时间复杂度：O(mn)<br/>
❌ 空间复杂度：O(mn) —— 因为用了 <code>visited</code> 数组</p>
</blockquote>
<hr/>
<h3 data-id="heading-6">🧠 方法二：按层模拟（推荐！面试首选）✅</h3>
<p>将整个矩阵看作若干“层”，每层从外到内依次遍历。</p>
<h4 data-id="heading-7">🧩 分层思想：</h4>
<ul>
<li>第一层：外圈，从 <code>[top][left]</code> 到 <code>[bottom][right]</code></li>
<li>第二层：内圈，缩小边界后继续</li>
<li>直至 <code>left &gt; right</code> 或 <code>top &gt; bottom</code> 结束</li>
</ul>
<h4 data-id="heading-8">🔄 遍历顺序：</h4>
<ol>
<li><strong>上行</strong>：从左到右 → <code>(top, left)</code> 到 <code>(top, right)</code></li>
<li><strong>右列</strong>：从上到下 → <code>(top+1, right)</code> 到 <code>(bottom, right)</code></li>
<li><strong>下行</strong>：从右到左 → <code>(bottom, right-1)</code> 到 <code>(bottom, left+1)</code>（仅当 <code>left &lt; right</code>）</li>
<li><strong>左列</strong>：从下到上 → <code>(bottom-1, left)</code> 到 <code>(top+1, left)</code>（仅当 <code>top &lt; bottom</code>）</li>
</ol>
<h4 data-id="heading-9">✅ 优势：</h4>
<ul>
<li>不需要额外空间，空间复杂度为 <strong>O(1)</strong>（不计输出数组）</li>
<li>边界条件明确，代码简洁易读</li>
<li>是面试官最爱的“优雅解法”</li>
</ul>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> {
<span class="hljs-keyword">public</span>:
    <span class="hljs-function">vector&lt;<span class="hljs-type">int</span>&gt; <span class="hljs-title">spiralOrder</span><span class="hljs-params">(vector&lt;vector&lt;<span class="hljs-type">int</span>&gt;&gt;&amp; matrix)</span> </span>{
        <span class="hljs-keyword">if</span> (matrix.<span class="hljs-built_in">size</span>() == <span class="hljs-number">0</span> || matrix[<span class="hljs-number">0</span>].<span class="hljs-built_in">size</span>() == <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">return</span> {};
        }

        <span class="hljs-type">int</span> rows = matrix.<span class="hljs-built_in">size</span>(), columns = matrix[<span class="hljs-number">0</span>].<span class="hljs-built_in">size</span>();
        vector&lt;<span class="hljs-type">int</span>&gt; order;
        <span class="hljs-type">int</span> left = <span class="hljs-number">0</span>, right = columns - <span class="hljs-number">1</span>, top = <span class="hljs-number">0</span>, bottom = rows - <span class="hljs-number">1</span>;

        <span class="hljs-keyword">while</span> (left &lt;= right &amp;&amp; top &lt;= bottom) {
            <span class="hljs-comment">// 1. 上行：从左到右</span>
            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> column = left; column &lt;= right; column++) {
                order.<span class="hljs-built_in">push_back</span>(matrix[top][column]);
            }
            top++; <span class="hljs-comment">// 上边界下移</span>

            <span class="hljs-comment">// 2. 右列：从上到下</span>
            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> row = top; row &lt;= bottom; row++) {
                order.<span class="hljs-built_in">push_back</span>(matrix[row][right]);
            }
            right--; <span class="hljs-comment">// 右边界左移</span>

            <span class="hljs-comment">// 3. 下行：从右到左（需确保有下一行且不是单行）</span>
            <span class="hljs-keyword">if</span> (left &lt; right) {
                <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> column = right; column &gt; left; column--) {
                    order.<span class="hljs-built_in">push_back</span>(matrix[bottom][column]);
                }
            }
            bottom--; <span class="hljs-comment">// 下边界上移</span>

            <span class="hljs-comment">// 4. 左列：从下到上（需确保有左列且不是单列）</span>
            <span class="hljs-keyword">if</span> (top &lt; bottom) {
                <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> row = bottom; row &gt;= top; row--) {
                    order.<span class="hljs-built_in">push_back</span>(matrix[row][left]);
                }
            }
            left++; <span class="hljs-comment">// 左边界右移</span>
        }
        <span class="hljs-keyword">return</span> order;
    }
};
</code></pre>
<blockquote>
<p>✅ 时间复杂度：O(mn)<br/>
✅ 空间复杂度：O(1) —— 仅用常数变量</p>
</blockquote>
<hr/>
<h2 data-id="heading-10">🧭 解题思路（分步详解）</h2>
<h3 data-id="heading-11">📌 步骤 1：初始化边界</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-type">int</span> left = <span class="hljs-number">0</span>, right = cols - <span class="hljs-number">1</span>, top = <span class="hljs-number">0</span>, bottom = rows - <span class="hljs-number">1</span>;
</code></pre>
<p>定义四个指针分别指向当前层的四条边。</p>
<h3 data-id="heading-12">📌 步骤 2：循环遍历每一层</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">while</span> (left &lt;= right &amp;&amp; top &lt;= bottom)
</code></pre>
<p>只要还有未遍历的区域就继续。</p>
<h3 data-id="heading-13">📌 步骤 3：逐层遍历</h3>
<ol>
<li><strong>上行</strong>：<code>top</code> 行从 <code>left</code> 到 <code>right</code></li>
<li><strong>右列</strong>：<code>right</code> 列从 <code>top+1</code> 到 <code>bottom</code></li>
<li><strong>下行</strong>：<code>bottom</code> 行从 <code>right-1</code> 到 <code>left+1</code>（避免重复）</li>
<li><strong>左列</strong>：<code>left</code> 列从 <code>bottom-1</code> 到 <code>top+1</code>（避免重复）</li>
</ol>
<blockquote>
<p>🚫 注意：第3、4步必须加条件判断，防止在 1xN 或 Nx1 的情况下重复添加元素！</p>
</blockquote>
<h3 data-id="heading-14">📌 步骤 4：收缩边界</h3>
<p>每次遍历完一层后：</p>
<pre><code class="hljs language-cpp" lang="cpp">left++, right--, top++, bottom--;
</code></pre>
<p>直到无法再进入新层为止。</p>
<hr/>
<h2 data-id="heading-15">📊 算法分析</h2>























<table><thead><tr><th>方法</th><th>时间复杂度</th><th>空间复杂度</th><th>是否推荐</th></tr></thead><tbody><tr><td>模拟法（带 visited）</td><td>O(mn)</td><td>O(mn)</td><td>❌ 一般情况不推荐</td></tr><tr><td>按层模拟</td><td>O(mn)</td><td>O(1)</td><td>✅ 推荐，面试首选</td></tr></tbody></table>
<blockquote>
<p>🔍 <strong>为什么按层更优？</strong></p>
</blockquote>
<ul>
<li>面试中追求 <strong>空间效率</strong> 和 <strong>代码优雅性</strong></li>
<li>能体现你对“结构化思维”的理解</li>
<li>更容易扩展到其他类似问题（如“蛇形填充”、“Z 字形打印”等）</li>
</ul>
<hr/>
<h2 data-id="heading-16">💻 完整代码（模板格式）</h2>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;bits/stdc++.h&gt;</span></span>
<span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;
<span class="hljs-keyword">using</span> ll = <span class="hljs-type">long</span> <span class="hljs-type">long</span>;

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> {
<span class="hljs-keyword">public</span>:
    <span class="hljs-function">vector&lt;<span class="hljs-type">int</span>&gt; <span class="hljs-title">spiralOrder</span><span class="hljs-params">(vector&lt;vector&lt;<span class="hljs-type">int</span>&gt;&gt;&amp; matrix)</span> </span>{
        <span class="hljs-keyword">if</span> (matrix.<span class="hljs-built_in">size</span>() == <span class="hljs-number">0</span> || matrix[<span class="hljs-number">0</span>].<span class="hljs-built_in">size</span>() == <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">return</span> {};
        }

        <span class="hljs-type">int</span> rows = matrix.<span class="hljs-built_in">size</span>(), columns = matrix[<span class="hljs-number">0</span>].<span class="hljs-built_in">size</span>();
        vector&lt;<span class="hljs-type">int</span>&gt; order;
        <span class="hljs-type">int</span> left = <span class="hljs-number">0</span>, right = columns - <span class="hljs-number">1</span>, top = <span class="hljs-number">0</span>, bottom = rows - <span class="hljs-number">1</span>;

        <span class="hljs-keyword">while</span> (left &lt;= right &amp;&amp; top &lt;= bottom) {
            <span class="hljs-comment">// 1. 上行：从左到右</span>
            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> column = left; column &lt;= right; column++) {
                order.<span class="hljs-built_in">push_back</span>(matrix[top][column]);
            }
            top++;

            <span class="hljs-comment">// 2. 右列：从上到下</span>
            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> row = top; row &lt;= bottom; row++) {
                order.<span class="hljs-built_in">push_back</span>(matrix[row][right]);
            }
            right--;

            <span class="hljs-comment">// 3. 下行：从右到左（仅当不是单行）</span>
            <span class="hljs-keyword">if</span> (left &lt; right) {
                <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> column = right; column &gt; left; column--) {
                    order.<span class="hljs-built_in">push_back</span>(matrix[bottom][column]);
                }
            }
            bottom--;

            <span class="hljs-comment">// 4. 左列：从下到上（仅当不是单列）</span>
            <span class="hljs-keyword">if</span> (top &lt; bottom) {
                <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> row = bottom; row &gt;= top; row--) {
                    order.<span class="hljs-built_in">push_back</span>(matrix[row][left]);
                }
            }
            left++;
        }
        <span class="hljs-keyword">return</span> order;
    }
};

<span class="hljs-comment">// 测试</span>
<span class="hljs-function"><span class="hljs-type">signed</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span>{
    ios::<span class="hljs-built_in">sync_with_stdio</span>(<span class="hljs-literal">false</span>);
    cin.<span class="hljs-built_in">tie</span>(<span class="hljs-literal">nullptr</span>);
    cout.<span class="hljs-built_in">tie</span>(<span class="hljs-literal">nullptr</span>);

    <span class="hljs-comment">// 示例测试用例</span>
    vector&lt;vector&lt;<span class="hljs-type">int</span>&gt;&gt; matrix1 = {{<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>},{<span class="hljs-number">4</span>,<span class="hljs-number">5</span>,<span class="hljs-number">6</span>},{<span class="hljs-number">7</span>,<span class="hljs-number">8</span>,<span class="hljs-number">9</span>}};
    vector&lt;vector&lt;<span class="hljs-type">int</span>&gt;&gt; matrix2 = {{<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>},{<span class="hljs-number">5</span>,<span class="hljs-number">6</span>,<span class="hljs-number">7</span>,<span class="hljs-number">8</span>},{<span class="hljs-number">9</span>,<span class="hljs-number">10</span>,<span class="hljs-number">11</span>,<span class="hljs-number">12</span>}};

    Solution sol;
    <span class="hljs-keyword">auto</span> result1 = sol.<span class="hljs-built_in">spiralOrder</span>(matrix1);
    <span class="hljs-keyword">auto</span> result2 = sol.<span class="hljs-built_in">spiralOrder</span>(matrix2);

    cout &lt;&lt; <span class="hljs-string">"Test 1: "</span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span> x : result1) cout &lt;&lt; x &lt;&lt; <span class="hljs-string">" "</span>;
    cout &lt;&lt; endl;

    cout &lt;&lt; <span class="hljs-string">"Test 2: "</span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span> x : result2) cout &lt;&lt; x &lt;&lt; <span class="hljs-string">" "</span>;
    cout &lt;&lt; endl;

    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<blockquote>
<p>✅ 输出结果：</p>
</blockquote>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">Test 1:</span> <span class="hljs-number">1</span> <span class="hljs-number">2</span> <span class="hljs-number">3</span> <span class="hljs-number">6</span> <span class="hljs-number">9</span> <span class="hljs-number">8</span> <span class="hljs-number">7</span> <span class="hljs-number">4</span> <span class="hljs-number">5</span> 
<span class="hljs-attr">Test 2:</span> <span class="hljs-number">1</span> <span class="hljs-number">2</span> <span class="hljs-number">3</span> <span class="hljs-number">4</span> <span class="hljs-number">8</span> <span class="hljs-number">12</span> <span class="hljs-number">11</span> <span class="hljs-number">10</span> <span class="hljs-number">9</span> <span class="hljs-number">5</span> <span class="hljs-number">6</span> <span class="hljs-number">7</span> 
</code></pre>
<hr/>
<hr/>
<blockquote>
<p>🌟 本期完结，下期见！🔥</p>
<p>👉 点赞收藏加关注，新文更新不迷路。关注专栏【算法】LeetCode Hot100刷题日记，持续为你拆解每一道热题的底层逻辑与面试技巧！</p>
<p>💬 <strong>欢迎留言交流你的解法或疑问！一起进步，冲向 Offer！💪</strong></p>
</blockquote>
<hr/>
<h2 data-id="heading-17">📣 下一期预告：LeetCode 热题 100 第48题 —— <strong>旋转图像（中等）</strong></h2>
<blockquote>
<p>🔹 <strong>题目</strong>：给你一个 <code>n×n</code> 的二维矩阵，将其顺时针旋转 90 度。要求 <strong>原地修改</strong>，不能使用额外的矩阵。</p>
<p>🔹 <strong>核心思路</strong>：利用“对角线翻转 + 水平翻转”或“分圈旋转”策略，实现 O(1) 空间原地旋转。</p>
<p>🔹 <strong>考点</strong>：矩阵操作、原地算法、数学变换、边界处理。</p>
<p>🔹 <strong>难度</strong>：中等，但非常典型，常出现在大厂面试中（如字节、腾讯、阿里）。</p>
<p>🔹 <strong>提示</strong>：</p>
<ul>
<li>不能直接复制再赋值！</li>
<li>尝试找规律：<code>(i,j)</code> → <code>(j,n-1-i)</code>，可推导出旋转公式。</li>
<li>推荐方法：先沿主对角线转置，再水平翻转。</li>
</ul>
</blockquote>
<blockquote>
<p>💡 提示：记住这个口诀：“<strong>转置 + 翻转 = 旋转</strong>”！</p>
</blockquote>
<hr/>
<p>📌 <strong>记住</strong>：当你在刷题时，不要只看答案，要像写这篇文章一样，深入思考每一步背后的原理、优化空间和面试价值。这才是真正提升算法能力的方式！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[pixelcut：22 年起步的黑马，又是一个千万 ARR 的产品！]]></title>    <link>https://juejin.cn/post/7577797563854143524</link>    <guid>https://juejin.cn/post/7577797563854143524</guid>    <pubDate>2025-11-30T10:18:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577797563854143524" data-draft-id="7577958825342353427" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="pixelcut：22 年起步的黑马，又是一个千万 ARR 的产品！"/> <meta itemprop="keywords" content="产品,AI编程"/> <meta itemprop="datePublished" content="2025-11-30T10:18:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="孟健AI编程"/> <meta itemprop="url" content="https://juejin.cn/user/4212984287073895"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            pixelcut：22 年起步的黑马，又是一个千万 ARR 的产品！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4212984287073895/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    孟健AI编程
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T10:18:56.000Z" title="Sun Nov 30 2025 10:18:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是孟健。</p>
<p>今天跟大家分享我们商业洞察系列的第二篇。</p>
<p>记得上次留了个作业，让大家自行分析一下 pixelcut、photoroom，看看有没有商业机会。</p>
<p>不知道大家有没有分析呢。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2f7327f619e44a249cfad9045d36486a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765102736&amp;x-signature=qjouyAp8JGVM4W%2FKV7k3l%2BoCtFE%3D" alt="" loading="lazy"/></p>
<p>其实 pixelcut 位于榜单 16 名，photoroom 位于榜单 27 名，picwish 位于榜单 68 名。</p>
<p>都是非常值得分析的站点，今天我带大家一起来看看 pixelcut。</p>
<h2 data-id="heading-0"><strong>01 市场盘子</strong></h2>
<p>这个站点 22 年才建立的，也算是比较新的站点。</p>
<p>它和 remove.bg 不一样，你看他的 TDH，实际上主打的是 photo editor：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3d3fa01d6bd0408b969dd6f0fbd72174~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765102736&amp;x-signature=tBlEkUfNOh1LQYd9LzS5LZbGfDU%3D" alt="" loading="lazy"/></p>
<p>它的流量也很高，大概在 2000 万左右，主要来自于搜索：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5036a185b7de42a288ceb4269ca3d1cf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765102736&amp;x-signature=0hSHcVwTxudH%2FsqQOyEau1gCHz4%3D" alt="" loading="lazy"/></p>
<p>我们看它的搜索词，上次我们说，background remover、remove background，它也吃到了不少流量：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b6c10294f4094e72a35f43f8c18e1559~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765102736&amp;x-signature=fbeRyicNZpsbaOpahWy4kqrOU%2BI%3D" alt="" loading="lazy"/></p>
<p>足以说明这个市场实在太大了，这两个词加起来都有七百万的搜索量，remove.bg 不可能把所有词的流量全部吃完，那就给了 pixelcut 的机会。</p>
<h2 data-id="heading-1"><strong>02 定位与 TDH：背后的意图</strong></h2>
<p>我们去看 pixelcut 首页的关键词密度，会发现它主打的是 background remover，这就很明显了，虽然它标榜是 photo editor，但是 SEO 意图很明显，它想吃掉部分这个词的流量：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ac158922cd744e919d26fc6a6c06f711~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765102736&amp;x-signature=Lvu9Q5g3Ye7LggyaBUynxxnJBx4%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-2"><strong>03 多语言的精准词</strong></h2>
<p>然后我们可以看到，占掉它流量第二大头的搜索词是一个西班牙语，这个词在我的 serp 里，pixelcut 是排第一的：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dc28b4af240043858593a98a17c3bb3d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765102736&amp;x-signature=V701aLfisDEZU6%2F9kwmL2qenRkw%3D" alt="" loading="lazy"/></p>
<p>它用来承接的是一个专门为多语言做的内页：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.pixelcut.ai%2Fes%2Fmejorar-calidad-de-imagen" target="_blank" title="https://www.pixelcut.ai/es/mejorar-calidad-de-imagen" ref="nofollow noopener noreferrer">www.pixelcut.ai/es/mejorar-…</a></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/576b116ae3ff4f5a81d89ee5e031dfea~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765102736&amp;x-signature=hju6YLpvkJE1jl9BWIDDDOvLfKY%3D" alt="" loading="lazy"/></p>
<p>实际上这个词，和第 5 个词 image upscaler 是等价的，图片增强，这个对应的是人们想要获得高清图的需求。</p>
<p>这个市场也很大，葡萄牙语和英语各自的搜索量都达到了 60 万。在葡萄牙语这里，pixelcut 吃掉了市场 1/3 的流量。</p>
<p>这给我们一个很好的启示，就是多语言的内页，一定要根据流量关键词去做，不是随随便便翻译的，我们做 SEO 一定要有目的，这个西班牙语的关键词，直接撑起了第二流量。</p>
<h2 data-id="heading-3"><strong>04 需求词域名的启示：这就是市场机会</strong></h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a5a27ea636b04ef08c425a26dc9f258e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765102736&amp;x-signature=tf4T2S7Lt7gKWYYqPi%2FYhHNEZRM%3D" alt="" loading="lazy"/></p>
<p>这里我想特别说明一下 image upscaler 这个词，它太有代表性了。在我的 serp 里，排前三的都是关键词域名：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c3521d0084da408d9340ef6a12a93aeb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765102736&amp;x-signature=yhqmhxQxP90h1r8NFdpxguoNR0M%3D" alt="" loading="lazy"/></p>
<p>而且，imgupscaler.ai 这个是 2024 年底注册的域名，它目前的访问量已经 400 万了！</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3decce38106e40c7a83a4b15a1e4daaf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765102736&amp;x-signature=0koZsn2ewnGMQ4j14oYwkvk1LpM%3D" alt="" loading="lazy"/></p>
<p>这里面透露出两个信息，第一个是这个注册的是 ai 后缀的域名，我们知道 ai 后缀的域名非常贵，说明作者看到了这里面的商业机会，愿意投入这么多钱去买这个域名。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bfd90af611974a0698442a419b742bce~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765102736&amp;x-signature=gMloIJjSR5LcFhIuonZM%2FJGp2So%3D" alt="" loading="lazy"/></p>
<p>在 queryDomain 上可以看到，这个关键词域名基本上都是被抢光了的，img upsacler 也是一样：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f7eaba684e4a415182d0766af4bd1807~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765102736&amp;x-signature=17AvVDCSG5G5FXIxZGw2jjr1rKc%3D" alt="" loading="lazy"/></p>
<p>大家可以看到，虽然这么多人注册，但跑出来的基本上只有三个，而 2024 年注册的这个非常值得我们学习。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/806d5108bc2049c2be2d6f85b098afa8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765102736&amp;x-signature=uGa8BzWK8zjLbD%2BsFk6E%2B99IvDs%3D" alt="" loading="lazy"/></p>
<p>其实这个站点蛮 AI 风格的，基本上就是 AI 做的站，400 万的流量，保守估计，仅广告就能月入万刀。更不用说这个站点还有订阅。大家可以自行去分析，我在这里就不展开了。</p>
<p>这里给我们最大的启示是，市场需求不可能被一家通吃，不要害怕那些老站，24 年的网站同样可以占有市场。</p>
<p>这就是市场机会，也是 AI 时代的红利！很多人说不知道怎么找需求，你去分析一下，其实海外遍地都是机会。</p>
<h2 data-id="heading-4"><strong>05 品牌词 20 万搜量，公关+内容营销</strong></h2>
<p>回到正题，第三才是它自己的品牌词 pixelcut，大概 20 万的搜索量。pixelcut 并不算一个需求词，这完全是它自己的品牌，能够有 20 万的搜索量，足以说明它自己做了很多品牌影响力的建设。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3e4eaad9a6bf45e795996c6d7dfd97ea~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765102736&amp;x-signature=jxQxHuVUGHNZsQmgKUjGx8RebDY%3D" alt="" loading="lazy"/></p>
<p>我们去搜 pixelcut 就会发现有很多 Youtube 的宣传，以及公关文章，这是它自己建立的影响力。</p>
<h2 data-id="heading-5"><strong>06 信息架构：首页弱、内页强，工具页才是流量入口</strong></h2>
<p>接下来我们看一下它的产品设计：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/36539ca65d3e4ef4b3ef777a0a410f21~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765102736&amp;x-signature=1Dd36VAQZaO9Uk158zwNZ4K47gU%3D" alt="" loading="lazy"/></p>
<p>其实 pixelcut 在设计层面并不是很专业，至少从 web 角度来看，而且它的底部 footer 表现的很明显：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0aea1a3dc8f24461853df49aef177f39~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765102736&amp;x-signature=XPmqlfVM1wqVoN1I86%2BDe5Mt0Jg%3D" alt="" loading="lazy"/></p>
<p>甚至我怀疑他们团队并没有专业设计师，这也侧面说明了，对于工具类型的产品来说，视觉并不是非常重要的因素。</p>
<p>在首页的首屏是一个文生图的 toolbox，要登录后才能使用，首页有很明显拉注册率的提示：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ee3e8e00fdd947aaaee0a4b233f3ea85~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765102736&amp;x-signature=lJk7t%2BIggLs6mAU8l%2BBin1bE%2F%2BA%3D" alt="" loading="lazy"/></p>
<p>我预估以首页的这个体验和视觉效果，流量和使用者应该不高，让我们看一下它的内页流量情况：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/795ab7da44d84806b9e14e1dc22dec8b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765102736&amp;x-signature=a7671ofJEPzgDEKieKYt82VMvIc%3D" alt="" loading="lazy"/></p>
<p>果不其然，首页在第八名，排在前面的都是内页，其中 background-remover 和 image-scaler 两个内页给他基本上贡献了一半以上的流量。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e652fc2f5e794bb98c5e01d4c70df6cd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765102736&amp;x-signature=hla2BKVmkZPRKdlSk6ET%2F7YArxo%3D" alt="" loading="lazy"/></p>
<p>以 background remover 为例，它的内页是一个非常典型的工具页布局，这个非常值得我们学习：</p>
<p>首先首屏是工具的主体区域，大面积且简洁，第一时间引导用户体验。</p>
<p>下面是 How-to、feature 的介绍，通过这块来拉高 SEO 关键词密度。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/83e46a3a9f5e4147aa58c0c10900871b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765102736&amp;x-signature=1NuPPC5q1j5k73jBBWItM1c4uTg%3D" alt="" loading="lazy"/></p>
<p>这个页面有 1000 多个词，主词密度区分得很明显。既满足了用户，又满足了 SEO，这是非常明智的做法。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8e801516454742ab9126e6387a2cdfce~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765102736&amp;x-signature=gk0CKJciLSKuGmMR4t7s45ZlXsQ%3D" alt="" loading="lazy"/></p>
<p>再往下是 FAQ+用户证言+内链，也是常用的 SEO 手段。在这里要提醒一下，千万不要让 AI 生成虚假的用户证言，否则你的审核一定是不可能通过的。</p>
<h2 data-id="heading-6"><strong>07 体验细节：免费闭环做得比 remove.bg 还顺滑</strong></h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d94f6d5626f041a28f696fe70c515d34~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765102736&amp;x-signature=vRKz%2Bw5Xl6IMgws%2F2E15RuvvuS4%3D" alt="" loading="lazy"/></p>
<p>我们上传一张图片，这次它没有引导登录，而是直接跳转一个编辑器页面，并且把图已经抠好了。</p>
<p>这个体验的感觉和专业度，我认为甚至超过了 remove.bg，这也说明了它为什么在这个市场上还能分到一杯羹。</p>
<p>所以说，我们分析竞争对手，一定不要看它的缺点，而要看它为什么能够成功。它的首页虽然不完美，但是核心功能的体验是极致的。</p>
<p>在这个编辑器页面，你就会发现，Download 下载 Free 版本也是可以直接用的，也就是去除背景+下载这条链路完全免费，其他的任何按钮点击，它又会引导你去登录了。</p>
<p>这是我觉得非常好的设计，这个团队一定深入调研了 background.bg 的功能体验，如果一个功能对方是免费的，而你设置了层层门槛，哪怕是一个登录门槛，就会变成你的劣势，那你是不可能竞争过对方的。</p>
<p>通过这两个案例的分析，我们已经可以得出结论，对于 background remove 这个场景来说，免费+下载的体验已经是用户心智了，如果你要做类似的产品，这条链路也必须给免费体验，否则根本没资格参与竞争。</p>
<h2 data-id="heading-7"><strong>08 变现：免费做广度，订阅/广告做厚度</strong></h2>
<p>免费了怎么赚钱呢？首先这个市场蛋糕足够大，而且这个场景足够高频，所以只要你产品好用，高频用户肯定是愿意花钱去使用的，用广告+订阅购买的方式，来打平免费的成本，赚取利润。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/468654ecb0f94bb890ebb13f04708f57~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765102736&amp;x-signature=7XCs8LSBufAcUc3BisNaKCEMTkU%3D" alt="" loading="lazy"/></p>
<p>pixelcut 没有屏蔽订单索引，我们从出站流量就可以看到，stripe 的流量占比大概是 1.17%，也就是说，有 1%以上的用户愿意为这个产品付费。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ae6aba8469e046c1b40b4d42ea09ff7c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765102736&amp;x-signature=1bAcDhAuB1j98%2FAw1K4azJ4THCY%3D" alt="" loading="lazy"/></p>
<p>pixelcut 的 Pricing 主引导大家购买$30 的 pro+订阅，不过它的默认竟然引导的是月订阅，而不是年订阅，不知道他们团队是如何考虑的。</p>
<p>先不管这个，我们取个折中，假设每个用户的付费是$20，那么每个月两千万的流量，有二十万的付费用户，等于它的 MRR 大概在 400 万左右。</p>
<p>所以，这也是一个妥妥的千万 ARR 的产品。虽然市场份额没有 remove.bg 高，但这收入也十分恐怖了，还没有算它的广告收入。</p>
<p>在我们上次估算 remove.bg 的收入，其实是低估了的，作为这个行业的大哥，肯定只多不少。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/df207beb6e1141789221b1cb3db7a3ae~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765102736&amp;x-signature=xSvUn6QPlnd0xDfeG5yk5YhzyWQ%3D" alt="" loading="lazy"/></p>
<p>说回这个 Pricing 页面，我觉得值得我们学习的是它用表格的方式列出了不同分级的权益，这也是 Pricing 页面的常用手段，对比会非常清晰。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dd07c5bc37a9458e9b4d56d0706a4b8f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765102736&amp;x-signature=jSyvf82GIBgV9lUFzGsmXiBzOs8%3D" alt="" loading="lazy"/></p>
<p>另外，它还列出了不同模型的使用次数限制，这也是让人感觉非常清晰的一种表达，降低用户理解心智。</p>
<h2 data-id="heading-8"><strong>09 技术</strong> <strong>SEO</strong>**：三件套做满，多语言靠子路径**</h2>
<p>最后，我还想说一下，这个站点的 SEO 绝对是专业级别的，非常值得学习。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3cc4c066e3314f67955be691577eb907~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765102736&amp;x-signature=br8cX93nCI1R7vDMrG%2FYg%2FcTI44%3D" alt="" loading="lazy"/></p>
<p>它的 hreflang 是很标准的，所有主流国家都有，以子路径作为区分，这是拉高站点流量权重非常重要的方式。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/268e2dca0c134a869c93b8d302dcb6fb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765102736&amp;x-signature=7AtvEAQ3JbhA1OvyKm901MyjSsg%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/49b40c1456d5404cb2e02ac8d685d52c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765102736&amp;x-signature=de88Xv5MykOCP%2FozB%2B7f3EhUx1c%3D" alt="" loading="lazy"/></p>
<p>其次，它是有结构化数据的，以及 opengraph，也是到位的，我觉得从技术 SEO 的角度来说，这三件套是值得我们学习的，也是容易被我们忽略的。</p>
<p>当然，它的 SEO 绝不仅仅是在技术层面的，内容层面可以看看它做了多少个内页的 tools：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4d77e67143274ea08422c7bdf4ed6942~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765102736&amp;x-signature=%2BBdN%2B5MCi2279hkoJ5TuInwAPUo%3D" alt="" loading="lazy"/></p>
<p>以及，为每个 usecase 都做了配套的工具内页：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d04f81f90f794898b70cb365110fc346~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765102736&amp;x-signature=Lh5EEiHJLhZyTs0LsjZ6DGcvF2Y%3D" alt="" loading="lazy"/></p>
<p>还有它的博客，每一篇也是精心设计，承接长尾词：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bde94d3c91c74952a197e2fc38fd385e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765102736&amp;x-signature=sc8GB6KFsD5DmfhwlhQL52hwW0A%3D" alt="" loading="lazy"/></p>
<p>我觉得 SEO 其实说白了也很简单，但需要用心做，持续做，把内容做好，这是不容易的。</p>
<h2 data-id="heading-9">10 GEO 的时代已经来了！</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c9e0ef82d988458186d457ee696d9766~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765102736&amp;x-signature=93qENk3ssJvuGz656%2B6H0nULbEc%3D" alt="" loading="lazy"/></p>
<p>另外，我发现了这个站最大的彩蛋，就是它支持 llm.txt，这就是它的专业和前瞻性，在布局一个未来。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c71720e6d7214db784d69b27e5f761a0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f5YGlQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765102736&amp;x-signature=wj5SFDrllLF2KWhAoou%2B6ZKrk10%3D" alt="" loading="lazy"/></p>
<p>果不其然，看看它的入站流量，chatGPT 直接带来了 20 万的量，朋友们，GEO 的时代到了啊！</p>
<h2 data-id="heading-10"><strong>11 可直接落地的 8 个要点</strong></h2>
<ol>
<li>
<p>需求词=域名，哪怕是新站也能快速起量。</p>
</li>
<li>
<p>TDH 与关键词密度围绕主需求词，品牌定位可放在文案，不影响 SEO。</p>
</li>
<li>
<p>多语言别盲翻，优先做高搜索量的目标词，逐词建内页。</p>
</li>
<li>
<p>工具页三段式：可用工具 → How-to/Feature 解释 → FAQ/证言/内链。</p>
</li>
<li>
<p>核心闭环免费，扩展功能再设门槛，别把登录放在第一步。</p>
</li>
<li>
<p>定价用对比表 + 调用次数限制，既清晰又方便 A/B。</p>
</li>
<li>
<p>技术 SEO 三件套（hreflang/结构化/OG）必做，能立刻抬权重。</p>
</li>
<li>
<p>提前布局 llm.txt，蹭生成式 AI 入口红利，别等流量被别人拿走。</p>
</li>
</ol>
<p>市场需求不可能被一家通吃。remove.bg 吃不完的上亿的需求词量，pixelcut 拿了一杯羹；2024 年才注册的 imgupscaler.ai 也跑到 400 万访问。</p>
<p>AI 时代的机会点就在这里：盯住真实的用户需求，快速做出可用产品，剩下的交给时间和流量。</p>
<p>好了，今天的分享就到这里了，我收获满满，大家有没有学到东西呢？咱们下期再见！</p>
<hr/>
<p>🚀 想要与更多AI爱好者交流，共同成长吗？</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FZ4k_5_waWJbRRo5lZBZmog" target="_blank" title="https://mp.weixin.qq.com/s/Z4k_5_waWJbRRo5lZBZmog" ref="nofollow noopener noreferrer">和一群志同道合的人，持续精进 AI 的每一天</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[SwiftUI和UIKit区别]]></title>    <link>https://juejin.cn/post/7577958825341812755</link>    <guid>https://juejin.cn/post/7577958825341812755</guid>    <pubDate>2025-11-30T03:21:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577958825341812755" data-draft-id="7577797563853455396" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="SwiftUI和UIKit区别"/> <meta itemprop="keywords" content="iOS"/> <meta itemprop="datePublished" content="2025-11-30T03:21:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="卓尔山上刷力扣"/> <meta itemprop="url" content="https://juejin.cn/user/263471893337357"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            SwiftUI和UIKit区别
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/263471893337357/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    卓尔山上刷力扣
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T03:21:43.000Z" title="Sun Nov 30 2025 03:21:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>SwiftUI 和 UIKit 是苹果提供的两个 UI 框架，它们在设计理念、开发方式和能力上有显著区别：</p>
<ol>
<li>设计理念</li>
</ol>
<p>SwiftUI - 声明式</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">ContentView</span>: <span class="hljs-title class_">View</span> {
    <span class="hljs-meta">@State</span> <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> isOn <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>
    
    <span class="hljs-keyword">var</span> body: <span class="hljs-keyword">some</span> <span class="hljs-type">View</span> {
        <span class="hljs-type">VStack</span> {
            <span class="hljs-type">Toggle</span>(<span class="hljs-string">"开关"</span>, isOn: <span class="hljs-variable">$isOn</span>)
            <span class="hljs-keyword">if</span> isOn {
                <span class="hljs-type">Text</span>(<span class="hljs-string">"开关已打开"</span>)
                    .foregroundColor(.green)
            }
        }
        .padding()
    }
}
</code></pre>
<p>UIKit - 命令式</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ViewController</span>: <span class="hljs-title class_">UIViewController</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">let</span> toggle <span class="hljs-operator">=</span> <span class="hljs-type">UISwitch</span>()
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">let</span> label <span class="hljs-operator">=</span> <span class="hljs-type">UILabel</span>()
    
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">viewDidLoad</span>() {
        <span class="hljs-keyword">super</span>.viewDidLoad()
        setupUI()
        toggle.addTarget(<span class="hljs-keyword">self</span>, action: <span class="hljs-keyword">#selector</span>(toggleChanged), for: .valueChanged)
    }
    
    <span class="hljs-keyword">@objc</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">toggleChanged</span>() {
        label.isHidden <span class="hljs-operator">=</span> <span class="hljs-operator">!</span>toggle.isOn
        label.text <span class="hljs-operator">=</span> <span class="hljs-string">"开关已打开"</span>
        label.textColor <span class="hljs-operator">=</span> .green
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">setupUI</span>() {
        <span class="hljs-comment">// 手动创建和配置所有视图</span>
    }
}
</code></pre>
<ol start="2">
<li>数据绑定和状态管理</li>
</ol>
<p>SwiftUI - 自动响应</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">UserProfile</span>: <span class="hljs-title class_">View</span> {
    <span class="hljs-meta">@State</span> <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> username <span class="hljs-operator">=</span> <span class="hljs-string">""</span>
    <span class="hljs-meta">@StateObject</span> <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> viewModel <span class="hljs-operator">=</span> <span class="hljs-type">ProfileViewModel</span>()
    
    <span class="hljs-keyword">var</span> body: <span class="hljs-keyword">some</span> <span class="hljs-type">View</span> {
        <span class="hljs-type">VStack</span> {
            <span class="hljs-type">TextField</span>(<span class="hljs-string">"用户名"</span>, text: <span class="hljs-variable">$username</span>)
            <span class="hljs-type">Text</span>(<span class="hljs-string">"你好, <span class="hljs-subst">\(username)</span>"</span>)
                .opacity(username.isEmpty <span class="hljs-operator">?</span> <span class="hljs-number">0</span> : <span class="hljs-number">1</span>)
            
            <span class="hljs-type">Button</span>(<span class="hljs-string">"保存"</span>) {
                viewModel.saveUser(name: username)
            }
        }
    }
}
</code></pre>
<p>UIKit - 手动更新</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">class</span> <span class="hljs-title class_">UserProfileViewController</span>: <span class="hljs-title class_">UIViewController</span> {
    <span class="hljs-keyword">@IBOutlet</span> <span class="hljs-keyword">weak</span> <span class="hljs-keyword">var</span> usernameField: <span class="hljs-type">UITextField</span>!
    <span class="hljs-keyword">@IBOutlet</span> <span class="hljs-keyword">weak</span> <span class="hljs-keyword">var</span> greetingLabel: <span class="hljs-type">UILabel</span>!
    <span class="hljs-keyword">@IBOutlet</span> <span class="hljs-keyword">weak</span> <span class="hljs-keyword">var</span> saveButton: <span class="hljs-type">UIButton</span>!
    
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">viewDidLoad</span>() {
        <span class="hljs-keyword">super</span>.viewDidLoad()
        usernameField.addTarget(<span class="hljs-keyword">self</span>, action: <span class="hljs-keyword">#selector</span>(textFieldChanged), for: .editingChanged)
    }
    
    <span class="hljs-keyword">@objc</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">textFieldChanged</span>() {
        <span class="hljs-keyword">let</span> username <span class="hljs-operator">=</span> usernameField.text <span class="hljs-operator">??</span> <span class="hljs-string">""</span>
        greetingLabel.text <span class="hljs-operator">=</span> <span class="hljs-string">"你好, <span class="hljs-subst">\(username)</span>"</span>
        greetingLabel.isHidden <span class="hljs-operator">=</span> username.isEmpty
        saveButton.isEnabled <span class="hljs-operator">=</span> <span class="hljs-operator">!</span>username.isEmpty
    }
}
</code></pre>
<ol start="3">
<li>布局系统</li>
</ol>
<p>SwiftUI - 修饰符布局</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-type">VStack</span>(spacing: <span class="hljs-number">20</span>) {
    <span class="hljs-type">Text</span>(<span class="hljs-string">"标题"</span>)
        .font(.title)
        .padding()
    
    <span class="hljs-type">HStack</span> {
        <span class="hljs-type">Image</span>(systemName: <span class="hljs-string">"star"</span>)
        <span class="hljs-type">Text</span>(<span class="hljs-string">"评分: 4.8"</span>)
    }
    
    <span class="hljs-type">Spacer</span>()
    
    <span class="hljs-type">Button</span>(<span class="hljs-string">"确认"</span>) { }
        .frame(maxWidth: .infinity)
        .padding()
}
.background(<span class="hljs-type">Color</span>.gray.opacity(<span class="hljs-number">0.1</span>))
</code></pre>
<p>UIKit - 自动布局约束</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">private</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">setupConstraints</span>() {
    <span class="hljs-type">NSLayoutConstraint</span>.activate([
        titleLabel.topAnchor.constraint(equalTo: view.safeAreaLayoutGuide.topAnchor, constant: <span class="hljs-number">20</span>),
        titleLabel.centerXAnchor.constraint(equalTo: view.centerXAnchor),
        
        stackView.topAnchor.constraint(equalTo: titleLabel.bottomAnchor, constant: <span class="hljs-number">20</span>),
        stackView.leadingAnchor.constraint(equalTo: view.leadingAnchor, constant: <span class="hljs-number">16</span>),
        stackView.trailingAnchor.constraint(equalTo: view.trailingAnchor, constant: <span class="hljs-operator">-</span><span class="hljs-number">16</span>),
        
        confirmButton.bottomAnchor.constraint(equalTo: view.safeAreaLayoutGuide.bottomAnchor, constant: <span class="hljs-operator">-</span><span class="hljs-number">20</span>),
        confirmButton.leadingAnchor.constraint(equalTo: view.leadingAnchor, constant: <span class="hljs-number">16</span>),
        confirmButton.trailingAnchor.constraint(equalTo: view.trailingAnchor, constant: <span class="hljs-operator">-</span><span class="hljs-number">16</span>),
        confirmButton.heightAnchor.constraint(equalToConstant: <span class="hljs-number">50</span>)
    ])
}
</code></pre>
<ol start="4">
<li>视图生命周期</li>
</ol>
<p>SwiftUI - 基于视图结构</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">LifecycleView</span>: <span class="hljs-title class_">View</span> {
    <span class="hljs-keyword">var</span> body: <span class="hljs-keyword">some</span> <span class="hljs-type">View</span> {
        <span class="hljs-type">Text</span>(<span class="hljs-string">"示例"</span>)
    }
    
    <span class="hljs-comment">// 生命周期事件</span>
    .onAppear {
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"视图出现"</span>)
    }
    .onDisappear {
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"视图消失"</span>)
    }
    .task {
        <span class="hljs-comment">// 异步任务，自动取消</span>
        <span class="hljs-keyword">await</span> loadData()
    }
}
</code></pre>
<p>UIKit - 基于视图控制器</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">class</span> <span class="hljs-title class_">LifecycleViewController</span>: <span class="hljs-title class_">UIViewController</span> {
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">viewDidLoad</span>() {
        <span class="hljs-keyword">super</span>.viewDidLoad()
        <span class="hljs-comment">// 视图加载完成</span>
    }
    
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">viewWillAppear</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">animated</span>: <span class="hljs-type">Bool</span>) {
        <span class="hljs-keyword">super</span>.viewWillAppear(animated)
        <span class="hljs-comment">// 视图将要出现</span>
    }
    
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">viewDidAppear</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">animated</span>: <span class="hljs-type">Bool</span>) {
        <span class="hljs-keyword">super</span>.viewDidAppear(animated)
        <span class="hljs-comment">// 视图已经出现</span>
    }
    
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">viewWillDisappear</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">animated</span>: <span class="hljs-type">Bool</span>) {
        <span class="hljs-keyword">super</span>.viewWillDisappear(animated)
        <span class="hljs-comment">// 视图将要消失</span>
    }
    
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">viewDidDisappear</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">animated</span>: <span class="hljs-type">Bool</span>) {
        <span class="hljs-keyword">super</span>.viewDidDisappear(animated)
        <span class="hljs-comment">// 视图已经消失</span>
    }
}
</code></pre>
<ol start="5">
<li>列表和集合视图</li>
</ol>
<p>SwiftUI - List 和 ForEach</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">UserListView</span>: <span class="hljs-title class_">View</span> {
    <span class="hljs-keyword">let</span> users: [<span class="hljs-type">User</span>]
    
    <span class="hljs-keyword">var</span> body: <span class="hljs-keyword">some</span> <span class="hljs-type">View</span> {
        <span class="hljs-type">List</span>(users) { user <span class="hljs-keyword">in</span>
            <span class="hljs-type">HStack</span> {
                <span class="hljs-type">AsyncImage</span>(url: user.avatarURL) { image <span class="hljs-keyword">in</span>
                    image.resizable()
                } placeholder: {
                    <span class="hljs-type">ProgressView</span>()
                }
                .frame(width: <span class="hljs-number">50</span>, height: <span class="hljs-number">50</span>)
                .clipShape(<span class="hljs-type">Circle</span>())
                
                <span class="hljs-type">VStack</span>(alignment: .leading) {
                    <span class="hljs-type">Text</span>(user.name)
                        .font(.headline)
                    <span class="hljs-type">Text</span>(user.email)
                        .font(.subheadline)
                        .foregroundColor(.gray)
                }
            }
            .swipeActions {
                <span class="hljs-type">Button</span>(<span class="hljs-string">"删除"</span>, role: .destructive) {
                    deleteUser(user)
                }
            }
        }
        .refreshable {
            <span class="hljs-keyword">await</span> refreshUsers()
        }
    }
}
</code></pre>
<p>UIKit - UITableView</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">class</span> <span class="hljs-title class_">UserListViewController</span>: <span class="hljs-title class_">UITableViewController</span> {
    <span class="hljs-keyword">var</span> users: [<span class="hljs-type">User</span>] <span class="hljs-operator">=</span> []
    
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">tableView</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">tableView</span>: <span class="hljs-type">UITableView</span>, <span class="hljs-params">numberOfRowsInSection</span> <span class="hljs-params">section</span>: <span class="hljs-type">Int</span>) -&gt; <span class="hljs-type">Int</span> {
        <span class="hljs-keyword">return</span> users.count
    }
    
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">tableView</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">tableView</span>: <span class="hljs-type">UITableView</span>, <span class="hljs-params">cellForRowAt</span> <span class="hljs-params">indexPath</span>: <span class="hljs-type">IndexPath</span>) -&gt; <span class="hljs-type">UITableViewCell</span> {
        <span class="hljs-keyword">let</span> cell <span class="hljs-operator">=</span> tableView.dequeueReusableCell(withIdentifier: <span class="hljs-string">"UserCell"</span>, for: indexPath) <span class="hljs-keyword">as!</span> <span class="hljs-type">UserCell</span>
        <span class="hljs-keyword">let</span> user <span class="hljs-operator">=</span> users[indexPath.row]
        cell.configure(with: user)
        <span class="hljs-keyword">return</span> cell
    }
    
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">tableView</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">tableView</span>: <span class="hljs-type">UITableView</span>, <span class="hljs-params">commit</span> <span class="hljs-params">editingStyle</span>: <span class="hljs-type">UITableViewCell</span>.<span class="hljs-type">EditingStyle</span>, <span class="hljs-params">forRowAt</span> <span class="hljs-params">indexPath</span>: <span class="hljs-type">IndexPath</span>) {
        <span class="hljs-keyword">if</span> editingStyle <span class="hljs-operator">==</span> .delete {
            deleteUser(at: indexPath)
        }
    }
}
</code></pre>
<ol start="6">
<li>动画和过渡</li>
</ol>
<p>SwiftUI - 隐式动画</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">AnimatedView</span>: <span class="hljs-title class_">View</span> {
    <span class="hljs-meta">@State</span> <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> isExpanded <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>
    
    <span class="hljs-keyword">var</span> body: <span class="hljs-keyword">some</span> <span class="hljs-type">View</span> {
        <span class="hljs-type">VStack</span> {
            <span class="hljs-type">Button</span>(<span class="hljs-string">"切换"</span>) {
                withAnimation(.spring()) {
                    isExpanded.toggle()
                }
            }
            
            <span class="hljs-type">Rectangle</span>()
                .fill(<span class="hljs-type">Color</span>.blue)
                .frame(
                    width: isExpanded <span class="hljs-operator">?</span> <span class="hljs-number">200</span> : <span class="hljs-number">100</span>,
                    height: isExpanded <span class="hljs-operator">?</span> <span class="hljs-number">200</span> : <span class="hljs-number">100</span>
                )
                .rotationEffect(.degrees(isExpanded <span class="hljs-operator">?</span> <span class="hljs-number">180</span> : <span class="hljs-number">0</span>))
        }
    }
}
</code></pre>
<p>UIKit - 显式动画</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">class</span> <span class="hljs-title class_">AnimatedViewController</span>: <span class="hljs-title class_">UIViewController</span> {
    <span class="hljs-keyword">@IBOutlet</span> <span class="hljs-keyword">weak</span> <span class="hljs-keyword">var</span> boxView: <span class="hljs-type">UIView</span>!
    <span class="hljs-keyword">var</span> isExpanded <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>
    
    <span class="hljs-keyword">@IBAction</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">toggleTapped</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">sender</span>: <span class="hljs-type">UIButton</span>) {
        <span class="hljs-type">UIView</span>.animate(withDuration: <span class="hljs-number">0.5</span>, 
                      delay: <span class="hljs-number">0</span>,
                      usingSpringWithDamping: <span class="hljs-number">0.6</span>,
                      initialSpringVelocity: <span class="hljs-number">0</span>,
                      options: []) {
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">self</span>.isExpanded {
                <span class="hljs-keyword">self</span>.boxView.transform <span class="hljs-operator">=</span> <span class="hljs-type">CGAffineTransform</span>.identity
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">self</span>.boxView.transform <span class="hljs-operator">=</span> <span class="hljs-type">CGAffineTransform</span>(rotationAngle: .pi)
                    .scaledBy(x: <span class="hljs-number">2</span>, y: <span class="hljs-number">2</span>)
            }
        } completion: { <span class="hljs-keyword">_</span> <span class="hljs-keyword">in</span>
            <span class="hljs-keyword">self</span>.isExpanded.toggle()
        }
    }
}
</code></pre>
<ol start="7">
<li>导航和路由</li>
</ol>
<p>SwiftUI - NavigationStack</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">MainApp</span>: <span class="hljs-title class_">View</span> {
    <span class="hljs-keyword">var</span> body: <span class="hljs-keyword">some</span> <span class="hljs-type">View</span> {
        <span class="hljs-type">NavigationStack</span> {
            <span class="hljs-type">List</span> {
                <span class="hljs-type">NavigationLink</span>(<span class="hljs-string">"用户详情"</span>, value: <span class="hljs-string">"user_detail"</span>)
                <span class="hljs-type">NavigationLink</span>(<span class="hljs-string">"设置"</span>, value: <span class="hljs-string">"settings"</span>)
            }
            .navigationDestination(for: <span class="hljs-type">String</span>.<span class="hljs-keyword">self</span>) { route <span class="hljs-keyword">in</span>
                <span class="hljs-keyword">switch</span> route {
                <span class="hljs-keyword">case</span> <span class="hljs-string">"user_detail"</span>:
                    <span class="hljs-type">UserDetailView</span>()
                <span class="hljs-keyword">case</span> <span class="hljs-string">"settings"</span>:
                    <span class="hljs-type">SettingsView</span>()
                <span class="hljs-keyword">default</span>:
                    <span class="hljs-type">Text</span>(<span class="hljs-string">"未知页面"</span>)
                }
            }
        }
    }
}
</code></pre>
<p>UIKit - UINavigationController</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MainViewController</span>: <span class="hljs-title class_">UITableViewController</span> {
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">tableView</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">tableView</span>: <span class="hljs-type">UITableView</span>, <span class="hljs-params">didSelectRowAt</span> <span class="hljs-params">indexPath</span>: <span class="hljs-type">IndexPath</span>) {
        <span class="hljs-keyword">switch</span> indexPath.row {
        <span class="hljs-keyword">case</span> <span class="hljs-number">0</span>:
            <span class="hljs-keyword">let</span> userDetailVC <span class="hljs-operator">=</span> <span class="hljs-type">UserDetailViewController</span>()
            navigationController<span class="hljs-operator">?</span>.pushViewController(userDetailVC, animated: <span class="hljs-literal">true</span>)
        <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:
            <span class="hljs-keyword">let</span> settingsVC <span class="hljs-operator">=</span> <span class="hljs-type">SettingsViewController</span>()
            navigationController<span class="hljs-operator">?</span>.pushViewController(settingsVC, animated: <span class="hljs-literal">true</span>)
        <span class="hljs-keyword">default</span>:
            <span class="hljs-keyword">break</span>
        }
    }
}
</code></pre>
<ol start="8">
<li>主要区别总结</li>
</ol>
<p>特性 SwiftUI UIKit
编程范式 声明式 命令式
数据流 响应式数据绑定 手动更新
布局 基于栈的布局系统 Auto Layout 约束
状态管理 @State, @Binding, @ObservedObject 手动管理状态
预览 实时预览 Interface Builder
跨平台 iOS, macOS, watchOS, tvOS 主要 iOS/tvOS
学习曲线 相对平缓 相对陡峭
代码量 通常更少 通常更多
版本要求 iOS 13+ iOS 2+
性能 优化良好，持续改进 成熟稳定</p>
<ol start="9">
<li>混合使用</li>
</ol>
<p>在实际项目中，可以混合使用两者：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 在 SwiftUI 中使用 UIKit 组件</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">MapView</span>: <span class="hljs-title class_">UIViewRepresentable</span> {
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">makeUIView</span>(<span class="hljs-params">context</span>: <span class="hljs-type">Context</span>) -&gt; <span class="hljs-type">MKMapView</span> {
        <span class="hljs-type">MKMapView</span>()
    }
    
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">updateUIView</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">uiView</span>: <span class="hljs-type">MKMapView</span>, <span class="hljs-params">context</span>: <span class="hljs-type">Context</span>) {
        <span class="hljs-comment">// 更新地图</span>
    }
}

<span class="hljs-comment">// 在 UIKit 中使用 SwiftUI</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">HostingViewController</span>: <span class="hljs-title class_">UIViewController</span> {
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">viewDidLoad</span>() {
        <span class="hljs-keyword">super</span>.viewDidLoad()
        
        <span class="hljs-keyword">let</span> swiftUIView <span class="hljs-operator">=</span> <span class="hljs-type">ContentView</span>()
        <span class="hljs-keyword">let</span> hostingController <span class="hljs-operator">=</span> <span class="hljs-type">UIHostingController</span>(rootView: swiftUIView)
        
        addChild(hostingController)
        view.addSubview(hostingController.view)
        hostingController.didMove(toParent: <span class="hljs-keyword">self</span>)
    }
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Python数据分析实战：从超市销售到教学评估]]></title>    <link>https://juejin.cn/post/7577914902430400558</link>    <guid>https://juejin.cn/post/7577914902430400558</guid>    <pubDate>2025-11-30T06:42:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577914902430400558" data-draft-id="7576853741758087202" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Python数据分析实战：从超市销售到教学评估"/> <meta itemprop="keywords" content="Python,PyCharm,编程语言"/> <meta itemprop="datePublished" content="2025-11-30T06:42:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="今天没有盐"/> <meta itemprop="url" content="https://juejin.cn/user/1408937846645355"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Python数据分析实战：从超市销售到教学评估
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1408937846645355/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    今天没有盐
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T06:42:50.000Z" title="Sun Nov 30 2025 06:42:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">导入</h2>
<p>在当今数据驱动的时代，数据分析能力已成为程序员和数据分析师的必备技能。Python凭借其强大的生态系统（pandas、numpy、matplotlib等）在数据处理和可视化领域占据重要地位。本文将通过四个真实场景的数据分析案例，全面展示Python在数据处理、统计分析和可视化方面的强大能力。</p>
<h2 data-id="heading-1">题目一：超市商品销售数据分析</h2>
<p>"超市销售数据.csv" 包含字段："日期""商品类别""商品名称""销售数量""单价 (元)""会员等级 (普通 / 银卡 / 金卡)"。</p>
<h4 data-id="heading-2">代码</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd
<span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt
<span class="hljs-keyword">import</span> datetime

<span class="hljs-comment"># 1. 读取 CSV 文件数据，将 "日期" 转换为 datetime 格式。</span>
df = pd.read_csv(
    <span class="hljs-string">"超市销售数据.csv"</span>,
    encoding=<span class="hljs-string">"utf-8"</span>
)
<span class="hljs-built_in">print</span>(df)
df[<span class="hljs-string">'日期'</span>] = pd.to_datetime(df[<span class="hljs-string">'日期'</span>])
<span class="hljs-built_in">print</span>(df[<span class="hljs-string">'日期'</span>].dtype)

<span class="hljs-comment"># 2. 计算每类商品的总销售额（销售数量 × 单价）和平均销售单价。</span>
df[<span class="hljs-string">'销售额'</span>] = df[<span class="hljs-string">'销售数量'</span>] * df[<span class="hljs-string">'单价 (元)'</span>]
total_sales = df.groupby(<span class="hljs-string">'商品类别'</span>)[<span class="hljs-string">'销售额'</span>].<span class="hljs-built_in">sum</span>()
mean_sales = df.groupby(<span class="hljs-string">'商品类别'</span>)[<span class="hljs-string">'单价 (元)'</span>].mean()
<span class="hljs-built_in">print</span>(<span class="hljs-string">"每类商品的总销售额为：\n"</span>, total_sales)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"每类商品的平均销售单价为：\n"</span>, mean_sales)

<span class="hljs-comment"># 3. 按 "会员等级" 分组，统计不同等级会员的总消费金额和平均单次消费金额。</span>
total_sales = df.groupby(<span class="hljs-string">'会员等级 (普通/银卡/金卡)'</span>)[<span class="hljs-string">'销售额'</span>].<span class="hljs-built_in">sum</span>()
counts_sales = df.groupby(<span class="hljs-string">'会员等级 (普通/银卡/金卡)'</span>)[<span class="hljs-string">'销售数量'</span>].<span class="hljs-built_in">sum</span>()
mean_sales = total_sales / counts_sales
<span class="hljs-built_in">print</span>(<span class="hljs-string">"不同等级会员的总销售额为：\n"</span>, total_sales)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"不同等级会员的平均单次消费金额为：\n"</span>, mean_sales)

<span class="hljs-comment"># 4. 提取 "日期" 中的月份，绘制每月总销售额的柱状图。</span>
df[<span class="hljs-string">'月份'</span>] = df[<span class="hljs-string">'日期'</span>].dt.month
total_sales = df.groupby(<span class="hljs-string">'月份'</span>)[<span class="hljs-string">'销售额'</span>].<span class="hljs-built_in">sum</span>()
plt.bar(total_sales.index, total_sales)
plt.show()

<span class="hljs-comment"># 5. 找出总销售额最高的 5 种商品，用饼图展示它们的销售额占比。</span>
plt.rcParams[<span class="hljs-string">'font.sans-serif'</span>] = [<span class="hljs-string">'SimHei'</span>]
product_sales = df.groupby(<span class="hljs-string">'商品名称'</span>)[<span class="hljs-string">'销售额'</span>].<span class="hljs-built_in">sum</span>().sort_values(ascending=<span class="hljs-literal">False</span>)
<span class="hljs-built_in">print</span>(product_sales)
top5 = product_sales.head(<span class="hljs-number">5</span>) <span class="hljs-comment"># 前5个</span>
top5_sum = top5.<span class="hljs-built_in">sum</span>()
top5_pie = top5 / top5_sum
<span class="hljs-built_in">print</span>(top5_pie)
plt.pie(top5_pie, labels=top5_pie.index,autopct=<span class="hljs-string">"%1.1f%%"</span>)
plt.show()
</code></pre>
<h4 data-id="heading-3">代码结果</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e70e6d85d3df4fd58000c9cb968b810b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LuK5aSp5rKh5pyJ55uQ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765089770&amp;x-signature=Bg%2Bmp0HKITXP6thEIheV9IOvwl8%3D" alt="101.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b49911c94ca14733b9b036ee76456dcb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LuK5aSp5rKh5pyJ55uQ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765089770&amp;x-signature=fl5P2gVTKaz7DGaK%2BVvlTuBZN4o%3D" alt="101-2.png" loading="lazy"/></p>
<h2 data-id="heading-4">题目二：线上书店订单数据分析</h2>
<p>"书店订单数据.csv" 包含字段："订单 ID""用户 ID""图书类别""购买数量""图书定价 (元)""折扣率 (0.7-1.0)""支付时间"。</p>
<h4 data-id="heading-5">代码</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd
<span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt

<span class="hljs-comment"># 1. 读取 CSV 文件数据，计算实际支付金额（图书定价 × 折扣率 × 购买数量），添加为新列。</span>
data = pd.read_csv(
    <span class="hljs-string">"书店订单数据.csv"</span>,
    encoding=<span class="hljs-string">"utf-8"</span>,
    index_col=<span class="hljs-string">"订单ID"</span>
)
<span class="hljs-built_in">print</span>(data)
data[<span class="hljs-string">'实际支付金额'</span>] = data[<span class="hljs-string">'图书定价 (元)'</span>] * data[<span class="hljs-string">'折扣率 (0.7-1.0)'</span>] * data[<span class="hljs-string">'购买数量'</span>]
<span class="hljs-built_in">print</span>(data)

<span class="hljs-comment"># 2. 按 "图书类别" 分组，统计各类别的总销量和总实际支付金额。</span>
states = data.groupby(<span class="hljs-string">'图书类别'</span>).agg({<span class="hljs-string">"购买数量"</span>:<span class="hljs-string">"sum"</span>, <span class="hljs-string">"实际支付金额"</span>:<span class="hljs-string">"sum"</span>})
<span class="hljs-built_in">print</span>(states)

<span class="hljs-comment"># 3. 计算所有订单的实际支付金额的均值、中位数和标准差。</span>
new_states = data[<span class="hljs-string">'实际支付金额'</span>].agg([<span class="hljs-string">'mean'</span>, <span class="hljs-string">'median'</span>, <span class="hljs-string">'std'</span>])
<span class="hljs-built_in">print</span>(new_states)

<span class="hljs-comment"># 4. 筛选出购买数量 ≥3 本的订单，保存为新 CSV 文件 "大额订单.csv"（不含索引）。</span>
tmp = data[data[<span class="hljs-string">'购买数量'</span>] &gt;= <span class="hljs-number">3</span>]
<span class="hljs-built_in">print</span>(tmp)
tmp.to_csv(
    <span class="hljs-string">'大额订单.csv'</span>
)
</code></pre>
<h4 data-id="heading-6">代码结果</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c08dbe89d9d64bcba8397fc34ac902ee~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LuK5aSp5rKh5pyJ55uQ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765089770&amp;x-signature=txn0I424%2BThsynStvImefVCWSJc%3D" alt="102.png" loading="lazy"/></p>
<h2 data-id="heading-7">题目三：学生考试成绩数据分析</h2>
<p>"考试成绩数据.csv" 包含字段："班级""学号""姓名""语文""数学""英语""理综 / 文综""考试时间"。</p>
<h4 data-id="heading-8">代码</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd
<span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np
<span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt

<span class="hljs-comment"># 1. 读取 CSV 文件数据，计算每位学生的总分（四门科目之和）和平均分，添加为新列。</span>
df = pd.read_csv(
    <span class="hljs-string">"考试成绩数据.csv"</span>
)
<span class="hljs-built_in">print</span>(df)
subjects = [<span class="hljs-string">'语文'</span>,<span class="hljs-string">'数学'</span>,<span class="hljs-string">'英语'</span>,<span class="hljs-string">'理综/文综'</span>]
df[<span class="hljs-string">'总分'</span>] = df[subjects].<span class="hljs-built_in">sum</span>(axis=<span class="hljs-number">1</span>)
df[<span class="hljs-string">'平均分'</span>] = df[subjects].mean(axis=<span class="hljs-number">1</span>)
<span class="hljs-built_in">print</span>(df)

<span class="hljs-comment"># 2. 按 "班级" 分组，统计各科目的平均分、最高分和最低分（使用 agg 函数批量统计）。</span>
states = df.groupby(<span class="hljs-string">'班级'</span>)[subjects].agg([<span class="hljs-string">'mean'</span>,<span class="hljs-string">'max'</span>,<span class="hljs-string">'min'</span>])
<span class="hljs-built_in">print</span>(states)

<span class="hljs-comment"># 3. 筛选出总分 ≥600 分的学生，统计每个班级的高分人数，绘制柱状图。</span>
plt.rcParams[<span class="hljs-string">'font.sans-serif'</span>] = [<span class="hljs-string">'SimHei'</span>]
high_student = df[df[<span class="hljs-string">'总分'</span>] &gt;= <span class="hljs-number">600</span>]
high_counts = high_student[<span class="hljs-string">'班级'</span>].value_counts().sort_index()
plt.bar(high_counts.index, high_counts)
plt.show()

<span class="hljs-comment"># 4. 计算数学成绩与理综/文综成绩的相关系数。</span>
corr = df[<span class="hljs-string">'数学'</span>].corr(df[<span class="hljs-string">'理综/文综'</span>])
<span class="hljs-built_in">print</span>(corr)

<span class="hljs-comment"># 5. 提取 "考试时间" 中的月份，统计不同月份的平均总分变化，绘制折线图。</span>
df[<span class="hljs-string">'考试时间'</span>] = pd.to_datetime(df[<span class="hljs-string">'考试时间'</span>])
df[<span class="hljs-string">'月份'</span>] = df[<span class="hljs-string">'考试时间'</span>].dt.month
month_score = df.groupby(<span class="hljs-string">'月份'</span>)[<span class="hljs-string">'总分'</span>].mean()
plt.plot(month_score.index, month_score)
plt.show()
</code></pre>
<h4 data-id="heading-9">代码结果</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d630fccdfbbf49a68e2b27d856ea3b5d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LuK5aSp5rKh5pyJ55uQ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765089770&amp;x-signature=QjRL7HKTRjEaPllI9l5IqZYXjUk%3D" alt="103.png" loading="lazy"/></p>
<h2 data-id="heading-10">题目四：教师教学评价数据分析</h2>
<p>"教学评价数据.csv" 包含字段："教师 ID""学科""授课班级""学生评分 (1-5 分)""评价人数""评价日期"。</p>
<h4 data-id="heading-11">代码</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd
<span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt

<span class="hljs-comment"># 1. 读取 CSV 文件数据，将 "评价日期" 转换为 datetime 格式。</span>
data = pd.read_csv(
    <span class="hljs-string">"教学评价数据.csv"</span>
)
<span class="hljs-built_in">print</span>(data)
data[<span class="hljs-string">'评价日期'</span>] = pd.to_datetime(data[<span class="hljs-string">'评价日期'</span>])
<span class="hljs-built_in">print</span>(data)

<span class="hljs-comment"># 2. 计算每位教师的总评分（学生评分 × 评价人数）和平均评分，添加为新列。</span>
data[<span class="hljs-string">'总评分'</span>] = data[<span class="hljs-string">'学生评分 (1-5分)'</span>] * data[<span class="hljs-string">'评价人数'</span>]
mean_score = data.groupby(<span class="hljs-string">'教师ID'</span>)[<span class="hljs-string">'学生评分 (1-5分)'</span>].mean()
<span class="hljs-built_in">print</span>(data)
<span class="hljs-built_in">print</span>(mean_score)

<span class="hljs-comment"># 3. 按 "学科" 分组，统计各学科的平均评分和总评价人数。</span>
states = data.groupby(<span class="hljs-string">'学科'</span>).agg({
    <span class="hljs-string">'总评分'</span>:<span class="hljs-string">'mean'</span>,
    <span class="hljs-string">'评价人数'</span>:<span class="hljs-string">'sum'</span>
})
states = states.rename(columns={<span class="hljs-string">'总评分'</span>:<span class="hljs-string">'平均评分'</span>})
<span class="hljs-built_in">print</span>(states)

<span class="hljs-comment"># 4. 提取 "评价日期" 中的星期信息，统计每周各天的评价数量，绘制柱状图。</span>
data[<span class="hljs-string">'评价日期'</span>] = pd.to_datetime(data[<span class="hljs-string">'评价日期'</span>])
data[<span class="hljs-string">'星期'</span>] = data[<span class="hljs-string">'评价日期'</span>].dt.weekday + <span class="hljs-number">1</span>
counts = data.groupby(<span class="hljs-string">'星期'</span>)[<span class="hljs-string">'评价人数'</span>].<span class="hljs-built_in">sum</span>()
<span class="hljs-built_in">print</span>(counts)
plt.bar(counts.index, counts)
plt.show()

<span class="hljs-comment"># 5. 找出平均评分最高的 3 位教师，用饼图展示他们的总评分占比。</span>
mean_score = mean_score.sort_values(ascending=<span class="hljs-literal">False</span>) <span class="hljs-comment"># 降序排序</span>
<span class="hljs-built_in">print</span>(mean_score)
top3 = mean_score[:<span class="hljs-number">3</span>]
total = mean_score.<span class="hljs-built_in">sum</span>() <span class="hljs-comment"># 总评分</span>
top3_rate = top3 / total
plt.pie(top3_rate, labels=top3_rate.index,autopct=<span class="hljs-string">"%1.1f%%"</span>)
plt.show()
</code></pre>
<h4 data-id="heading-12">代码结果</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/77f48614bfa2461e9f70879197c8412e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LuK5aSp5rKh5pyJ55uQ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765089770&amp;x-signature=JOjHytGqjqEekgA755mkD9KiO5s%3D" alt="104.png" loading="lazy"/></p>
<h2 data-id="heading-13">总结</h2>
<ol>
<li>
<p><strong>数据读取与预处理</strong></p>
<ul>
<li>多种数据格式的读取（CSV）</li>
<li>数据类型转换（日期时间处理）</li>
<li>数据清洗和列操作</li>
</ul>
</li>
<li>
<p><strong>数据计算与转换</strong></p>
<ul>
<li>派生列的计算创建</li>
<li>分组聚合统计</li>
<li>多维度数据透视</li>
</ul>
</li>
<li>
<p><strong>统计分析技术</strong></p>
<ul>
<li>描述性统计（均值、中位数、标准差）</li>
<li>相关性分析</li>
<li>排名和筛选</li>
</ul>
</li>
<li>
<p><strong>数据可视化</strong></p>
<ul>
<li>多种图表类型应用（柱状图、饼图、折线图）</li>
<li>中文显示处理</li>
<li>图表美化和标签设置</li>
</ul>
</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[D2L(1) — 线性回归]]></title>    <link>https://juejin.cn/post/7577718777482412070</link>    <guid>https://juejin.cn/post/7577718777482412070</guid>    <pubDate>2025-11-30T10:38:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577718777482412070" data-draft-id="7574817463448125491" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="D2L(1) — 线性回归"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-30T10:38:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="IguoChan"/> <meta itemprop="url" content="https://juejin.cn/user/655780651999720"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            D2L(1) — 线性回归
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/655780651999720/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    IguoChan
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T10:38:41.000Z" title="Sun Nov 30 2025 10:38:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">0. 背景</h2>
<p>虽然一直从事的是工程开发，但是目前从事的工作和算法、特别是大模型相关，因此想了解一下算法的相关基础，而d2l就是入门的教程，可参考<a href="https://link.juejin.cn?target=https%3A%2F%2Fzh.d2l.ai%2Findex.html" target="_blank" title="https://zh.d2l.ai/index.html" ref="nofollow noopener noreferrer">dl2</a>。</p>
<blockquote>
<p><em>回归</em>（regression）是能为一个或多个自变量与因变量之间关系建模的一类方法。 在自然科学和社会科学领域，回归经常用来表示输入和输出之间的关系。</p>
</blockquote>
<p>比如书中中的线性回归就是一个特别简单的例子，即<code>根据房屋的面积（平方英尺）和房龄（年）来估算房屋价格（美元）</code>。从简单的直观感受来说，房子的价格应该和面积成一定的正比，和房龄成反比。</p>
<p>其实在书中，已经将基本的原理介绍得很清楚了，但是有些地方对于年逾三十，离开大学很久的我来说理解起来不是那么直观，所以我这边会详细描述我所困在的点。</p>
<h2 data-id="heading-1">1. 基本推导</h2>
<h3 data-id="heading-2">1.1 线性模型</h3>
<p>这里的算法其实很简单，根据过往历史值求出根据某房屋面积和房龄的预测值，即可得以下公式：</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>p</mi><mi>r</mi><mi>i</mi><mi>c</mi><mi>e</mi><mo>=</mo><msub><mi>w</mi><mrow><mi>a</mi><mi>r</mi><mi>e</mi><mi>a</mi></mrow></msub><mo>×</mo><mi>a</mi><mi>r</mi><mi>e</mi><mi>a</mi><mo>+</mo><msub><mi>w</mi><mrow><mi>a</mi><mi>g</mi><mi>e</mi></mrow></msub><mo>×</mo><mi>a</mi><mi>g</mi><mi>e</mi><mo>+</mo><mi>b</mi></mrow><annotation encoding="application/x-tex">price = w_{area} \times area + w_{age} \times age + b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.854em;vertical-align:-0.1944em;"/><span class="mord mathnormal">p</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">i</span><span class="mord mathnormal">ce</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.7333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight">re</span><span class="mord mathnormal mtight">a</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"/><span class="mord mathnormal">a</span><span class="mord mathnormal">re</span><span class="mord mathnormal">a</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.8694em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight" style="margin-right:0.03588em;">g</span><span class="mord mathnormal mtight">e</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.1944em;"/><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mord mathnormal">e</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal">b</span></span></span></span></span></div>
<p>这里<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">{</mo><mi>a</mi><mi>r</mi><mi>e</mi><mi>a</mi><mo separator="true">,</mo><mi>a</mi><mi>g</mi><mi>e</mi><mo stretchy="false">}</mo></mrow><annotation encoding="application/x-tex">\{area, age\}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">{</span><span class="mord mathnormal">a</span><span class="mord mathnormal">re</span><span class="mord mathnormal">a</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mord mathnormal">e</span><span class="mclose">}</span></span></span></span></span>被称为特征，而<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">{</mo><msub><mi>w</mi><mrow><mi>a</mi><mi>r</mi><mi>e</mi><mi>a</mi></mrow></msub><mo separator="true">,</mo><msub><mi>w</mi><mrow><mi>a</mi><mi>g</mi><mi>e</mi></mrow></msub><mo stretchy="false">}</mo></mrow><annotation encoding="application/x-tex">\{w_{area}, w_{age}\}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"/><span class="mopen">{</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight">re</span><span class="mord mathnormal mtight">a</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight" style="margin-right:0.03588em;">g</span><span class="mord mathnormal mtight">e</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mclose">}</span></span></span></span></span>被称为权重，使用向量<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">x</mi><mo>=</mo><mo stretchy="false">{</mo><msub><mi>x</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>x</mi><mn>2</mn></msub><mo stretchy="false">}</mo></mrow><annotation encoding="application/x-tex">\mathbf{x} = \{ x_1, x_2 \}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4444em;"/><span class="mord mathbf">x</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">{</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">}</span></span></span></span></span>表征特征，向量<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">w</mi><mo>=</mo><mo stretchy="false">{</mo><msub><mi>w</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>w</mi><mn>2</mn></msub><mo stretchy="false">}</mo></mrow><annotation encoding="application/x-tex">\mathbf{w} = \{ w_1, w_2 \}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4444em;"/><span class="mord mathbf" style="margin-right:0.01597em;">w</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">{</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">}</span></span></span></span></span>表征权重，则针对于输入为 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">{</mo><msub><mi>x</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>x</mi><mn>2</mn></msub><mo stretchy="false">}</mo></mrow><annotation encoding="application/x-tex">\{ x_1, x_2\}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">{</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">}</span></span></span></span></span>的预测值 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover accent="true"><mi>y</mi><mo>^</mo></mover></mrow><annotation encoding="application/x-tex">\hat{y}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6944em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">y</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="accent-body" style="left:-0.1944em;"><span class="mord">^</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1944em;"><span/></span></span></span></span></span></span></span></span> 的计算公式如下：</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mover accent="true"><mi>y</mi><mo>^</mo></mover><mo>=</mo><msup><mi mathvariant="bold">w</mi><mi mathvariant="normal">T</mi></msup><mi mathvariant="bold">x</mi><mo>+</mo><mi>b</mi></mrow><annotation encoding="application/x-tex">\hat{y} = \mathbf{w}^\mathrm T\mathbf{x} + b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6944em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">y</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="accent-body" style="left:-0.1944em;"><span class="mord">^</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1944em;"><span/></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.9747em;vertical-align:-0.0833em;"/><span class="mord"><span class="mord mathbf" style="margin-right:0.01597em;">w</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathrm mtight">T</span></span></span></span></span></span></span></span><span class="mord mathbf">x</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal">b</span></span></span></span></span></div>
<p>那对于一系列的特征集合<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">X</mi><mo>=</mo><mrow><mo fence="true">(</mo><mtable rowspacing="0.16em" columnalign="center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>a</mi><mi>r</mi><mi>e</mi><msub><mi>a</mi><mn>1</mn></msub></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>a</mi><mi>g</mi><msub><mi>e</mi><mn>1</mn></msub></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>a</mi><mi>r</mi><mi>e</mi><msub><mi>a</mi><mn>2</mn></msub></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>a</mi><mi>g</mi><msub><mi>e</mi><mn>2</mn></msub></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>a</mi><mi>r</mi><mi>e</mi><msub><mi>a</mi><mi>n</mi></msub></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>a</mi><mi>g</mi><msub><mi>e</mi><mi>n</mi></msub></mrow></mstyle></mtd></mtr></mtable><mo fence="true">)</mo></mrow></mrow><annotation encoding="application/x-tex">\mathbf{X} = 
\begin{pmatrix}
    area_1 &amp; age_1 \\
    area_2 &amp; age_2 \\
    ... \\
    area_n &amp; age_n
    \end{pmatrix}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6861em;"/><span class="mord mathbf">X</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:4.8em;vertical-align:-2.15em;"/><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.65em;"><span style="top:-4.65em;"><span class="pstrut" style="height:6.8em;"/><span style="width:0.875em;height:4.800em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.875em" height="4.800em" viewbox="0 0 875 4800"><path d="M863,9c0,-2,-2,-5,-6,-9c0,0,-17,0,-17,0c-12.7,0,-19.3,0.3,-20,1&#10;c-5.3,5.3,-10.3,11,-15,17c-242.7,294.7,-395.3,682,-458,1162c-21.3,163.3,-33.3,349,&#10;-36,557 l0,1284c0.2,6,0,26,0,60c2,159.3,10,310.7,24,454c53.3,528,210,&#10;949.7,470,1265c4.7,6,9.7,11.7,15,17c0.7,0.7,7,1,19,1c0,0,18,0,18,0c4,-4,6,-7,6,-9&#10;c0,-2.7,-3.3,-8.7,-10,-18c-135.3,-192.7,-235.5,-414.3,-300.5,-665c-65,-250.7,-102.5,&#10;-544.7,-112.5,-882c-2,-104,-3,-167,-3,-189&#10;l0,-1292c0,-162.7,5.7,-314,17,-454c20.7,-272,63.7,-513,129,-723c65.3,&#10;-210,155.3,-396.3,270,-559c6.7,-9.3,10,-15.3,10,-18z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.15em;"><span/></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.65em;"><span style="top:-4.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord mathnormal">a</span><span class="mord mathnormal">re</span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord mathnormal">a</span><span class="mord mathnormal">re</span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">...</span></span></span><span style="top:-1.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord mathnormal">a</span><span class="mord mathnormal">re</span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.15em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.65em;"><span style="top:-4.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span><span style="top:-1.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.15em;"><span/></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.65em;"><span style="top:-4.65em;"><span class="pstrut" style="height:6.8em;"/><span style="width:0.875em;height:4.800em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.875em" height="4.800em" viewbox="0 0 875 4800"><path d="M76,0c-16.7,0,-25,3,-25,9c0,2,2,6.3,6,13c21.3,28.7,42.3,60.3,&#10;63,95c96.7,156.7,172.8,332.5,228.5,527.5c55.7,195,92.8,416.5,111.5,664.5&#10;c11.3,139.3,17,290.7,17,454c0,28,1.7,43,3.3,45l0,1209&#10;c-3,4,-3.3,16.7,-3.3,38c0,162,-5.7,313.7,-17,455c-18.7,248,-55.8,469.3,-111.5,664&#10;c-55.7,194.7,-131.8,370.3,-228.5,527c-20.7,34.7,-41.7,66.3,-63,95c-2,3.3,-4,7,-6,11&#10;c0,7.3,5.7,11,17,11c0,0,11,0,11,0c9.3,0,14.3,-0.3,15,-1c5.3,-5.3,10.3,-11,15,-17&#10;c242.7,-294.7,395.3,-681.7,458,-1161c21.3,-164.7,33.3,-350.7,36,-558&#10;l0,-1344c-2,-159.3,-10,-310.7,-24,-454c-53.3,-528,-210,-949.7,&#10;-470,-1265c-4.7,-6,-9.7,-11.7,-15,-17c-0.7,-0.7,-6.7,-1,-18,-1z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.15em;"><span/></span></span></span></span></span></span></span></span></span></span>，则整个预测值的预测曲线可以表征为：</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mover accent="true"><mi mathvariant="bold">y</mi><mo>^</mo></mover><mo>=</mo><mi mathvariant="bold">X</mi><mi mathvariant="bold">w</mi><mo>+</mo><mi mathvariant="bold">b</mi></mrow><annotation encoding="application/x-tex">\mathbf{\hat{y}} = \mathbf{X}\mathbf{w}+\mathbf{b}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9023em;vertical-align:-0.1944em;"/><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7079em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="mord mathbf" style="margin-right:0.01597em;">y</span></span><span style="top:-3.0134em;"><span class="pstrut" style="height:3em;"/><span class="accent-body" style="left:-0.2875em;"><span class="mord mathbf">^</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1944em;"><span/></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.7694em;vertical-align:-0.0833em;"/><span class="mord mathbf" style="margin-right:0.01597em;">Xw</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathbf">b</span></span></span></span></span></div>
<p>其中<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">b</mi><mo>=</mo><mo stretchy="false">{</mo><mi>b</mi><mo separator="true">,</mo><mi>b</mi><mo separator="true">,</mo><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mo separator="true">,</mo><mi>b</mi><mo stretchy="false">}</mo></mrow><annotation encoding="application/x-tex">\mathbf{b} = \{b,b,...,b\}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathbf">b</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">{</span><span class="mord mathnormal">b</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">b</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">...</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">b</span><span class="mclose">}</span></span></span></span></span>。</p>
<p>那其实线性回归本质上就是求取一组 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">w</mi></mrow><annotation encoding="application/x-tex">\mathbf{w}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4444em;"/><span class="mord mathbf" style="margin-right:0.01597em;">w</span></span></span></span></span> 和 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi></mrow><annotation encoding="application/x-tex">b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal">b</span></span></span></span></span> ，使得预测值和样本值之间的误差尽可能的小。</p>
<p>所以本质问题变成了：</p>
<ul>
<li><strong>怎么计算误差？</strong></li>
<li><strong>怎么使得误差减小？</strong></li>
</ul>
<h3 data-id="heading-3">1.2 怎么计算误差（损失函数）</h3>
<p>对于线性模型，我们可以很容易的使用平方差作为其损失函数：</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>L</mi><mo stretchy="false">(</mo><mi mathvariant="bold">w</mi><mo separator="true">,</mo><mi>b</mi><mo stretchy="false">)</mo><mo>=</mo><mfrac><mn>1</mn><mi>n</mi></mfrac><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>n</mi></munderover><mfrac><mn>1</mn><mn>2</mn></mfrac><mo stretchy="false">(</mo><msup><mover accent="true"><mi>y</mi><mo>^</mo></mover><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup><mo>−</mo><msup><mi>y</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup><msup><mo stretchy="false">)</mo><mn>2</mn></msup><mo>=</mo><mfrac><mn>1</mn><mi>n</mi></mfrac><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>n</mi></munderover><mfrac><mn>1</mn><mn>2</mn></mfrac><mo stretchy="false">(</mo><msup><mi mathvariant="bold">w</mi><mi mathvariant="normal">T</mi></msup><msup><mi mathvariant="bold">x</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup><mo>+</mo><mi>b</mi><mo>−</mo><msup><mi>y</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup><msup><mo stretchy="false">)</mo><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">L(\mathbf{w}, b) = \frac{1}{n} \sum_{i=1}^{n} \frac{1}{2}(\hat{y}^{(i)} - y^{(i)})^2 = \frac{1}{n} \sum_{i=1}^{n} \frac{1}{2}(\mathbf{w}^\mathrm T\mathbf{x}^{(i)} + b - y^{(i)})^2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">L</span><span class="mopen">(</span><span class="mord mathbf" style="margin-right:0.01597em;">w</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">b</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:2.9291em;vertical-align:-1.2777em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3214em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord mathnormal">n</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.6514em;"><span style="top:-1.8723em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"/><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2777em;"><span/></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3214em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">2</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mopen">(</span><span class="mord"><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6944em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">y</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="accent-body" style="left:-0.1944em;"><span class="mord">^</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1944em;"><span/></span></span></span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.938em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.188em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.938em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:2.9291em;vertical-align:-1.2777em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3214em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord mathnormal">n</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.6514em;"><span style="top:-1.8723em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"/><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2777em;"><span/></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3214em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">2</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mopen">(</span><span class="mord"><span class="mord mathbf" style="margin-right:0.01597em;">w</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathrm mtight">T</span></span></span></span></span></span></span></span><span class="mord"><span class="mord mathbf">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.938em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em;"/><span class="mord mathnormal">b</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.188em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.938em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span></div>
<h3 data-id="heading-4">1.3 怎么使得误差减小（随机梯度下降）</h3>
<p>其实这里也是我最开始不太理解的地方：</p>
<ul>
<li>书中这个最终的公式是怎么推导的？</li>
<li>怎么理解这个梯度下降的过程？</li>
</ul>
<p>首先我们计算单个样本的损失：</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msup><mi>l</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup><mo stretchy="false">(</mo><mi mathvariant="bold">w</mi><mo separator="true">,</mo><mi>b</mi><mo stretchy="false">)</mo><mo>=</mo><mfrac><mn>1</mn><mn>2</mn></mfrac><mo stretchy="false">(</mo><msup><mover accent="true"><mi>y</mi><mo>^</mo></mover><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup><mo>−</mo><msup><mi>y</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup><msup><mo stretchy="false">)</mo><mn>2</mn></msup><mo>=</mo><mfrac><mn>1</mn><mn>2</mn></mfrac><mo stretchy="false">(</mo><msup><mi mathvariant="bold">w</mi><mi mathvariant="normal">T</mi></msup><msup><mi mathvariant="bold">x</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup><mo>+</mo><mi>b</mi><mo>−</mo><msup><mi>y</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup><msup><mo stretchy="false">)</mo><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">l^{(i)}(\mathbf{w}, b) = \frac{1}{2}(\hat{y}^{(i)} - y^{(i)})^2 = \frac{1}{2}(\mathbf{w}^\mathrm T\mathbf{x}^{(i)} + b - y^{(i)})^2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.188em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.938em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathbf" style="margin-right:0.01597em;">w</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">b</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:2.0074em;vertical-align:-0.686em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3214em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">2</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mopen">(</span><span class="mord"><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6944em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">y</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="accent-body" style="left:-0.1944em;"><span class="mord">^</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1944em;"><span/></span></span></span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.938em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.188em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.938em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:2.0074em;vertical-align:-0.686em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3214em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">2</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mopen">(</span><span class="mord"><span class="mord mathbf" style="margin-right:0.01597em;">w</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathrm mtight">T</span></span></span></span></span></span></span></span><span class="mord"><span class="mord mathbf">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.938em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em;"/><span class="mord mathnormal">b</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.188em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.938em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span></div>
<p>对于 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">w</mi></mrow><annotation encoding="application/x-tex">\mathbf{w}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4444em;"/><span class="mord mathbf" style="margin-right:0.01597em;">w</span></span></span></span></span> 中某个权重 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>w</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">w_j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7167em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span> 梯度：</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mfrac><mrow><mi mathvariant="normal">∂</mi><msup><mi>l</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup></mrow><mrow><mi mathvariant="normal">∂</mi><msub><mi>w</mi><mi>j</mi></msub></mrow></mfrac><mo>=</mo><mfrac><mrow><mi mathvariant="normal">∂</mi><msup><mi>l</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup></mrow><mrow><mi mathvariant="normal">∂</mi><msup><mover accent="true"><mi>y</mi><mo>^</mo></mover><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup></mrow></mfrac><mo>⋅</mo><mfrac><mrow><mi mathvariant="normal">∂</mi><msup><mover accent="true"><mi>y</mi><mo>^</mo></mover><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup></mrow><mrow><mi mathvariant="normal">∂</mi><msub><mi>w</mi><mi>j</mi></msub></mrow></mfrac></mrow><annotation encoding="application/x-tex">\frac{\partial l^{(i)}}{\partial w_j} = \frac{\partial l^{(i)}}{\partial \hat{y}^{(i)}} \cdot \frac{\partial \hat{y}^{(i)}}{\partial w_j}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:2.5371em;vertical-align:-0.9721em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.565em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.9721em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:2.4634em;vertical-align:-0.8984em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.565em;"><span style="top:-2.296em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord"><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6944em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">y</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="accent-body" style="left:-0.1944em;"><span class="mord">^</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1944em;"><span/></span></span></span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.814em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.8984em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:2.5371em;vertical-align:-0.9721em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.565em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord"><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6944em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">y</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="accent-body" style="left:-0.1944em;"><span class="mord">^</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1944em;"><span/></span></span></span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.9721em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span></span></span></span></span></div>
<p>而：</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mfrac><mrow><mi mathvariant="normal">∂</mi><msup><mi>l</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup></mrow><mrow><mi mathvariant="normal">∂</mi><msup><mover accent="true"><mi>y</mi><mo>^</mo></mover><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup></mrow></mfrac><mo>=</mo><msup><mover accent="true"><mi>y</mi><mo>^</mo></mover><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup><mo>−</mo><msup><mi>y</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup></mrow><annotation encoding="application/x-tex">\frac{\partial l^{(i)}}{\partial \hat{y}^{(i)}} = \hat{y}^{(i)} - y^{(i)}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:2.4634em;vertical-align:-0.8984em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.565em;"><span style="top:-2.296em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord"><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6944em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">y</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="accent-body" style="left:-0.1944em;"><span class="mord">^</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1944em;"><span/></span></span></span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.814em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.8984em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.1324em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6944em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">y</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="accent-body" style="left:-0.1944em;"><span class="mord">^</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1944em;"><span/></span></span></span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.938em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.1324em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.938em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span></span></span></span></span></div>
<p>又因为 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover accent="true"><mi>y</mi><mo>^</mo></mover><mo>=</mo><msub><mi>w</mi><mn>1</mn></msub><msub><mi>x</mi><mn>1</mn></msub><mo>+</mo><msub><mi>w</mi><mn>2</mn></msub><msub><mi>x</mi><mn>2</mn></msub><mo>+</mo><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mo>+</mo><msub><mi>w</mi><mi>n</mi></msub><msub><mi>x</mi><mi>n</mi></msub><mo>+</mo><mi>b</mi></mrow><annotation encoding="application/x-tex">\hat{y} = w_1x_1 + w_2x_2+ ... +w_nx_n + b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6944em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">y</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="accent-body" style="left:-0.1944em;"><span class="mord">^</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1944em;"><span/></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.7333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"/><span class="mord">...</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal">b</span></span></span></span></span>，所以：</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mfrac><mrow><mi mathvariant="normal">∂</mi><msup><mover accent="true"><mi>y</mi><mo>^</mo></mover><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup></mrow><mrow><mi mathvariant="normal">∂</mi><msub><mi>w</mi><mi>j</mi></msub></mrow></mfrac><mo>=</mo><msubsup><mi>x</mi><mi>j</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msubsup></mrow><annotation encoding="application/x-tex">\frac{\partial \hat{y}^{(i)}}{\partial w_j} = x_j^{(i)}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:2.5371em;vertical-align:-0.9721em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.565em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord"><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6944em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">y</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="accent-body" style="left:-0.1944em;"><span class="mord">^</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1944em;"><span/></span></span></span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.9721em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.4578em;vertical-align:-0.413em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.0448em;"><span style="top:-2.4231em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span><span style="top:-3.2198em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.413em;"><span/></span></span></span></span></span></span></span></span></span></div>
<p>所以单个样本的损失：</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mfrac><mrow><mi mathvariant="normal">∂</mi><msup><mi>l</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup></mrow><mrow><mi mathvariant="normal">∂</mi><msub><mi>w</mi><mi>j</mi></msub></mrow></mfrac><mo>=</mo><mo stretchy="false">(</mo><msup><mover accent="true"><mi>y</mi><mo>^</mo></mover><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup><mo>−</mo><msup><mi>y</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup><mo stretchy="false">)</mo><mo>⋅</mo><msubsup><mi>x</mi><mi>j</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msubsup><mo>=</mo><mo stretchy="false">(</mo><msup><mi mathvariant="bold">w</mi><mi mathvariant="normal">T</mi></msup><msup><mi mathvariant="bold">x</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup><mo>+</mo><mi>b</mi><mo>−</mo><msup><mi>y</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup><mo stretchy="false">)</mo><mo>⋅</mo><msubsup><mi>x</mi><mi>j</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msubsup></mrow><annotation encoding="application/x-tex">\frac{\partial l^{(i)}}{\partial w_j} = (\hat{y}^{(i)} - y^{(i)}) \cdot x_j^{(i)} = (\mathbf{w}^\mathrm T\mathbf{x}^{(i)} + b - y^{(i)}) \cdot x_j^{(i)}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:2.5371em;vertical-align:-0.9721em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.565em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.9721em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.188em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord"><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6944em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">y</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="accent-body" style="left:-0.1944em;"><span class="mord">^</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1944em;"><span/></span></span></span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.938em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.188em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.938em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.4578em;vertical-align:-0.413em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.0448em;"><span style="top:-2.4231em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span><span style="top:-3.2198em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.413em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.188em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord"><span class="mord mathbf" style="margin-right:0.01597em;">w</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathrm mtight">T</span></span></span></span></span></span></span></span><span class="mord"><span class="mord mathbf">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.938em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em;"/><span class="mord mathnormal">b</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.188em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.938em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.4578em;vertical-align:-0.413em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.0448em;"><span style="top:-2.4231em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span><span style="top:-3.2198em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.413em;"><span/></span></span></span></span></span></span></span></span></span></div>
<p>所以对于所有样本的损失：</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mfrac><mrow><mi mathvariant="normal">∂</mi><mi>L</mi></mrow><mrow><mi mathvariant="normal">∂</mi><msub><mi>w</mi><mi>j</mi></msub></mrow></mfrac><mo>=</mo><mfrac><mn>1</mn><mi>n</mi></mfrac><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>n</mi></munderover><mo stretchy="false">(</mo><msup><mover accent="true"><mi>y</mi><mo>^</mo></mover><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup><mo>−</mo><msup><mi>y</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup><mo stretchy="false">)</mo><mo>⋅</mo><msubsup><mi>x</mi><mi>j</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msubsup><mo>=</mo><mfrac><mn>1</mn><mi>n</mi></mfrac><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>n</mi></munderover><mo stretchy="false">(</mo><msup><mi mathvariant="bold">w</mi><mi mathvariant="normal">T</mi></msup><msup><mi mathvariant="bold">x</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup><mo>+</mo><mi>b</mi><mo>−</mo><msup><mi>y</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup><mo stretchy="false">)</mo><mo>⋅</mo><msubsup><mi>x</mi><mi>j</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msubsup></mrow><annotation encoding="application/x-tex">\frac{\partial L}{\partial w_j} = \frac{1}{n} \sum_{i=1}^{n}(\hat{y}^{(i)} - y^{(i)}) \cdot x_j^{(i)} = \frac{1}{n} \sum_{i=1}^{n}(\mathbf{w}^\mathrm T\mathbf{x}^{(i)} + b - y^{(i)}) \cdot x_j^{(i)}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:2.3435em;vertical-align:-0.9721em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3714em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord mathnormal">L</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.9721em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:2.9291em;vertical-align:-1.2777em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3214em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord mathnormal">n</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.6514em;"><span style="top:-1.8723em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"/><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2777em;"><span/></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6944em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">y</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="accent-body" style="left:-0.1944em;"><span class="mord">^</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1944em;"><span/></span></span></span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.938em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.188em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.938em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.4578em;vertical-align:-0.413em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.0448em;"><span style="top:-2.4231em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span><span style="top:-3.2198em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.413em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:2.9291em;vertical-align:-1.2777em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3214em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord mathnormal">n</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.6514em;"><span style="top:-1.8723em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"/><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2777em;"><span/></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathbf" style="margin-right:0.01597em;">w</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathrm mtight">T</span></span></span></span></span></span></span></span><span class="mord"><span class="mord mathbf">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.938em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em;"/><span class="mord mathnormal">b</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.188em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.938em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.4578em;vertical-align:-0.413em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.0448em;"><span style="top:-2.4231em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span><span style="top:-3.2198em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.413em;"><span/></span></span></span></span></span></span></span></span></span></div>
<p>那么针对所有的权重，其梯度向量为：</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi mathvariant="normal">∇</mi><mi>w</mi></msub><mi>L</mi><mo>=</mo><mo stretchy="false">{</mo><mfrac><mrow><mi mathvariant="normal">∂</mi><mi>L</mi></mrow><mrow><mi mathvariant="normal">∂</mi><msub><mi>w</mi><mn>1</mn></msub></mrow></mfrac><mo separator="true">,</mo><mfrac><mrow><mi mathvariant="normal">∂</mi><mi>L</mi></mrow><mrow><mi mathvariant="normal">∂</mi><msub><mi>w</mi><mn>2</mn></msub></mrow></mfrac><mo separator="true">,</mo><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mo separator="true">,</mo><mfrac><mrow><mi mathvariant="normal">∂</mi><mi>L</mi></mrow><mrow><mi mathvariant="normal">∂</mi><msub><mi>w</mi><mi>n</mi></msub></mrow></mfrac><mo stretchy="false">}</mo><mo>=</mo><mfrac><mn>1</mn><mi>n</mi></mfrac><msup><mi mathvariant="bold">X</mi><mi mathvariant="normal">T</mi></msup><mo stretchy="false">(</mo><mover accent="true"><mi>y</mi><mo>^</mo></mover><mo>−</mo><mi>y</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\nabla_wL = \{\frac{\partial L}{\partial w_1}, \frac{\partial L}{\partial w_2},...,\frac{\partial L}{\partial w_n}\} = \frac{1}{n}\mathbf{X}^\mathrm T(\hat{y} - y)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord">∇</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord mathnormal">L</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:2.2074em;vertical-align:-0.836em;"/><span class="mopen">{</span><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3714em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord mathnormal">L</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.836em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3714em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord mathnormal">L</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.836em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">...</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3714em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord" style="margin-right:0.05556em;">∂</span><span class="mord mathnormal">L</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.836em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mclose">}</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:2.0074em;vertical-align:-0.686em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3214em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord mathnormal">n</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mord"><span class="mord mathbf">X</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathrm mtight">T</span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6944em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">y</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="accent-body" style="left:-0.1944em;"><span class="mord">^</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1944em;"><span/></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mclose">)</span></span></span></span></span></div>
<p>我们来简单理解一下上面冰冷的公式：<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mrow><mi mathvariant="normal">∂</mi><mi>L</mi></mrow><mrow><mi mathvariant="normal">∂</mi><msub><mi>w</mi><mi>j</mi></msub></mrow></mfrac></mrow><annotation encoding="application/x-tex">\frac{\partial L}{\partial w_j}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.4224em;vertical-align:-0.5423em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8801em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight" style="margin-right:0.05556em;">∂</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3281em;"><span style="top:-2.357em;margin-left:-0.0269em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2819em;"><span/></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight" style="margin-right:0.05556em;">∂</span><span class="mord mathnormal mtight">L</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.5423em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span></span></span></span></span> 梯度表示在<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>w</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">w_j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7167em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span>这个方向上，在<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>w</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">w_j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7167em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span>这个位置上的斜率，那么我们要找到使得函数更小的点，就应该朝着反方向挪动一步，使其向极小值收敛。</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi mathvariant="bold">w</mi><mo>←</mo><mi mathvariant="bold">w</mi><mo>−</mo><mfrac><mi>η</mi><mi>m</mi></mfrac><mo>⋅</mo><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>m</mi></munderover><msup><mi mathvariant="bold">x</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup><mo stretchy="false">(</mo><msup><mi mathvariant="bold">w</mi><mi mathvariant="normal">T</mi></msup><msup><mi mathvariant="bold">x</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup><mo>+</mo><mi>b</mi><mo>−</mo><msup><mi>y</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathbf{w} \leftarrow  \mathbf{w} - \frac{\eta}{m} \cdot \sum_{i=1}^{m} \mathbf{x}^{(i)} (\mathbf{w}^\mathrm T\mathbf{x}^{(i)} + b - y^{(i)})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4444em;"/><span class="mord mathbf" style="margin-right:0.01597em;">w</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">←</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"/><span class="mord mathbf" style="margin-right:0.01597em;">w</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.7936em;vertical-align:-0.686em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.1076em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord mathnormal">m</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">η</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:2.9291em;vertical-align:-1.2777em;"/><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.6514em;"><span style="top:-1.8723em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"/><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2777em;"><span/></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathbf">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.938em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathbf" style="margin-right:0.01597em;">w</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathrm mtight">T</span></span></span></span></span></span></span></span><span class="mord"><span class="mord mathbf">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.938em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em;"/><span class="mord mathnormal">b</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.188em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.938em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></div>
<p>其中，<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>η</mi></mrow><annotation encoding="application/x-tex">\eta</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">η</span></span></span></span></span> 表示挪动的一小步，即学习率；<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>m</mi></mrow><annotation encoding="application/x-tex">m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">m</span></span></span></span></span> 表示取样的小批量。同理：</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>b</mi><mo>←</mo><mi>b</mi><mo>−</mo><mfrac><mi>η</mi><mi>m</mi></mfrac><mo>⋅</mo><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>m</mi></munderover><mo stretchy="false">(</mo><msup><mi mathvariant="bold">w</mi><mi mathvariant="normal">T</mi></msup><msup><mi mathvariant="bold">x</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup><mo>+</mo><mi>b</mi><mo>−</mo><msup><mi>y</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">b \leftarrow  b - \frac{\eta}{m} \cdot \sum_{i=1}^{m}  (\mathbf{w}^\mathrm T\mathbf{x}^{(i)} + b - y^{(i)})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal">b</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">←</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em;"/><span class="mord mathnormal">b</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.7936em;vertical-align:-0.686em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.1076em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord mathnormal">m</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">η</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:2.9291em;vertical-align:-1.2777em;"/><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.6514em;"><span style="top:-1.8723em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"/><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2777em;"><span/></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathbf" style="margin-right:0.01597em;">w</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathrm mtight">T</span></span></span></span></span></span></span></span><span class="mord"><span class="mord mathbf">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.938em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em;"/><span class="mord mathnormal">b</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.188em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.938em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></div>
<h2 data-id="heading-5">2. 实际验证</h2>
<p>书上的<a href="https://link.juejin.cn?target=https%3A%2F%2Fzh.d2l.ai%2Fchapter_linear-networks%2Flinear-regression-scratch.html" target="_blank" title="https://zh.d2l.ai/chapter_linear-networks/linear-regression-scratch.html" ref="nofollow noopener noreferrer">3.2. 线性回归的从零开始实现</a> 写的十分的详细，这里我就不复述相关操作了，然后我们画一张图更加形象地表征一下我们梯度逐步减小的过程。</p>
<p>为了方便验证，我在sgd中做如下改动：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">sgd</span>(<span class="hljs-params">params, lr, batch_size</span>):  <span class="hljs-comment">#@save</span>
    <span class="hljs-string">"""小批量随机梯度下降"""</span>
    <span class="hljs-keyword">with</span> torch.no_grad():
        <span class="hljs-keyword">for</span> param <span class="hljs-keyword">in</span> params:
            <span class="hljs-keyword">if</span> param.shape[<span class="hljs-number">0</span>] == <span class="hljs-number">2</span>:
                <span class="hljs-built_in">print</span>(<span class="hljs-string">"w: "</span>, param)
                <span class="hljs-built_in">print</span>(<span class="hljs-string">"w.grad: "</span>, param.grad)
            param -= lr * param.grad / batch_size
            param.grad.zero_()
</code></pre>
<p>然后我们在jupyter的最后加上如下的代码，再将以上打印的数据复制到下面：（或者优雅一点将打印输出到文件，这里再从文件读出）</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> torch
<span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np
<span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt
<span class="hljs-keyword">from</span> mpl_toolkits.mplot3d <span class="hljs-keyword">import</span> Axes3D
<span class="hljs-keyword">import</span> re

<span class="hljs-comment"># 1. 解析打印日志，提取w的更新路径</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">parse_w_trajectory</span>(<span class="hljs-params">log_text</span>):
    <span class="hljs-string">"""从打印日志中解析w的更新轨迹"""</span>
    pattern = <span class="hljs-string">r"w:\s*tensor\(\[\[(.*?)\],\s*\[(.*?)\]\]"</span>
    matches = re.findall(pattern, log_text)
    
    w_trajectory = []
    <span class="hljs-keyword">for</span> <span class="hljs-keyword">match</span> <span class="hljs-keyword">in</span> matches:
        w1 = <span class="hljs-built_in">float</span>(<span class="hljs-keyword">match</span>[<span class="hljs-number">0</span>].strip())
        w2 = <span class="hljs-built_in">float</span>(<span class="hljs-keyword">match</span>[<span class="hljs-number">1</span>].strip())
        w_trajectory.append([w1, w2])
    
    <span class="hljs-keyword">return</span> np.array(w_trajectory)

<span class="hljs-comment"># 2. 生成模拟数据 (与之前相同)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">synthetic_data</span>(<span class="hljs-params">w_true, b_true, num_examples</span>):
    X = torch.normal(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, (num_examples, <span class="hljs-built_in">len</span>(w_true)))
    y = torch.matmul(X, w_true) + b_true
    y += torch.normal(<span class="hljs-number">0</span>, <span class="hljs-number">0.01</span>, y.shape)
    <span class="hljs-keyword">return</span> X, y.reshape((-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>))

true_w = torch.tensor([<span class="hljs-number">2.0</span>, -<span class="hljs-number">3.4</span>])
true_b = <span class="hljs-number">4.2</span>
features, labels = synthetic_data(true_w, true_b, <span class="hljs-number">1000</span>)

<span class="hljs-keyword">def</span> <span class="hljs-title function_">compute_mse</span>(<span class="hljs-params">X, y, w, b</span>):
    y_hat = linear_regression(X, w, b)
    <span class="hljs-keyword">return</span> squared_loss(y_hat, y).mean()

<span class="hljs-comment"># 4. 创建网格计算损失曲面 (与之前相同)</span>
b_fixed = true_b
w1_range = torch.linspace(<span class="hljs-number">0.0</span>, <span class="hljs-number">5.0</span>, <span class="hljs-number">50</span>)
w2_range = torch.linspace(-<span class="hljs-number">5.0</span>, <span class="hljs-number">0.0</span>, <span class="hljs-number">50</span>)
W1, W2 = torch.meshgrid(w1_range, w2_range, indexing=<span class="hljs-string">'ij'</span>)
Z = torch.zeros_like(W1)

<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(w1_range)):
    <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(w2_range)):
        w_current = torch.tensor([W1[i, j], W2[i, j]], dtype=torch.float32)
        Z[i, j] = compute_mse(features, labels, w_current, b_fixed)

<span class="hljs-comment"># 5. 解析打印日志中的w轨迹</span>
<span class="hljs-comment"># 这里需要将您的打印日志内容粘贴到log_text中</span>
log_text = <span class="hljs-string">"""
您提供的完整打印日志内容在这里
"""</span>

w_trajectory = parse_w_trajectory(log_text)

<span class="hljs-comment"># 6. 计算轨迹上每个点的损失值</span>
trajectory_losses = []
<span class="hljs-keyword">for</span> w_point <span class="hljs-keyword">in</span> w_trajectory:
    w_tensor = torch.tensor(w_point, dtype=torch.float32)
    loss_val = compute_mse(features, labels, w_tensor, b_fixed)
    trajectory_losses.append(loss_val.item())

trajectory_losses = np.array(trajectory_losses)

<span class="hljs-comment"># 7. 创建可视化图形</span>
fig = plt.figure(figsize=(<span class="hljs-number">12</span>, <span class="hljs-number">5</span>))

<span class="hljs-comment"># 7a. 三维曲面图</span>
ax1 = fig.add_subplot(<span class="hljs-number">121</span>, projection=<span class="hljs-string">'3d'</span>)
surf = ax1.plot_surface(W1.numpy(), W2.numpy(), Z.numpy(), 
                       cmap=<span class="hljs-string">'coolwarm'</span>, alpha=<span class="hljs-number">0.6</span>, linewidth=<span class="hljs-number">0</span>, 
                       antialiased=<span class="hljs-literal">True</span>)

<span class="hljs-comment"># 绘制优化路径</span>
ax1.plot(w_trajectory[:, <span class="hljs-number">0</span>], w_trajectory[:, <span class="hljs-number">1</span>], trajectory_losses, 
         <span class="hljs-string">'r-'</span>, linewidth=<span class="hljs-number">2</span>, label=<span class="hljs-string">'Optimization Path'</span>)
ax1.scatter(w_trajectory[:, <span class="hljs-number">0</span>], w_trajectory[:, <span class="hljs-number">1</span>], trajectory_losses, 
            c=<span class="hljs-string">'r'</span>, s=<span class="hljs-number">20</span>, alpha=<span class="hljs-number">0.6</span>)

<span class="hljs-comment"># 标记起点和终点</span>
ax1.scatter([w_trajectory[<span class="hljs-number">0</span>, <span class="hljs-number">0</span>]], [w_trajectory[<span class="hljs-number">0</span>, <span class="hljs-number">1</span>]], [trajectory_losses[<span class="hljs-number">0</span>]], 
            c=<span class="hljs-string">'g'</span>, s=<span class="hljs-number">100</span>, marker=<span class="hljs-string">'o'</span>, label=<span class="hljs-string">'Start'</span>)
ax1.scatter([w_trajectory[-<span class="hljs-number">1</span>, <span class="hljs-number">0</span>]], [w_trajectory[-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>]], [trajectory_losses[-<span class="hljs-number">1</span>]], 
            c=<span class="hljs-string">'b'</span>, s=<span class="hljs-number">100</span>, marker=<span class="hljs-string">'*'</span>, label=<span class="hljs-string">'End'</span>)

ax1.set_xlabel(<span class="hljs-string">'Weight w1'</span>)
ax1.set_ylabel(<span class="hljs-string">'Weight w2'</span>)
ax1.set_zlabel(<span class="hljs-string">'Loss'</span>)
ax1.set_title(<span class="hljs-string">'3D Loss Surface with Optimization Path'</span>)
ax1.legend()
fig.colorbar(surf, ax=ax1, shrink=<span class="hljs-number">0.5</span>, aspect=<span class="hljs-number">20</span>)

<span class="hljs-comment"># 7b. 等高线图</span>
ax2 = fig.add_subplot(<span class="hljs-number">122</span>)
contour = ax2.contourf(W1.numpy(), W2.numpy(), Z.numpy(), levels=<span class="hljs-number">20</span>, cmap=<span class="hljs-string">'coolwarm'</span>)

<span class="hljs-comment"># 绘制优化路径</span>
ax2.plot(w_trajectory[:, <span class="hljs-number">0</span>], w_trajectory[:, <span class="hljs-number">1</span>], <span class="hljs-string">'r-'</span>, linewidth=<span class="hljs-number">2</span>, label=<span class="hljs-string">'Optimization Path'</span>)
ax2.scatter(w_trajectory[:, <span class="hljs-number">0</span>], w_trajectory[:, <span class="hljs-number">1</span>], c=<span class="hljs-string">'r'</span>, s=<span class="hljs-number">20</span>, alpha=<span class="hljs-number">0.6</span>)

<span class="hljs-comment"># 标记起点和终点</span>
ax2.scatter(w_trajectory[<span class="hljs-number">0</span>, <span class="hljs-number">0</span>], w_trajectory[<span class="hljs-number">0</span>, <span class="hljs-number">1</span>], c=<span class="hljs-string">'g'</span>, s=<span class="hljs-number">100</span>, marker=<span class="hljs-string">'o'</span>, label=<span class="hljs-string">'Start'</span>)
ax2.scatter(w_trajectory[-<span class="hljs-number">1</span>, <span class="hljs-number">0</span>], w_trajectory[-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>], c=<span class="hljs-string">'b'</span>, s=<span class="hljs-number">100</span>, marker=<span class="hljs-string">'*'</span>, label=<span class="hljs-string">'End'</span>)

<span class="hljs-comment"># 添加箭头显示方向</span>
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, <span class="hljs-built_in">len</span>(w_trajectory)-<span class="hljs-number">1</span>, <span class="hljs-built_in">max</span>(<span class="hljs-number">1</span>, <span class="hljs-built_in">len</span>(w_trajectory)//<span class="hljs-number">20</span>)):
    dx = w_trajectory[i+<span class="hljs-number">1</span>, <span class="hljs-number">0</span>] - w_trajectory[i, <span class="hljs-number">0</span>]
    dy = w_trajectory[i+<span class="hljs-number">1</span>, <span class="hljs-number">1</span>] - w_trajectory[i, <span class="hljs-number">1</span>]
    ax2.arrow(w_trajectory[i, <span class="hljs-number">0</span>], w_trajectory[i, <span class="hljs-number">1</span>], dx, dy, 
              shape=<span class="hljs-string">'full'</span>, lw=<span class="hljs-number">0</span>, length_includes_head=<span class="hljs-literal">True</span>, 
              head_width=<span class="hljs-number">0.05</span>, head_length=<span class="hljs-number">0.05</span>, color=<span class="hljs-string">'red'</span>)

ax2.set_xlabel(<span class="hljs-string">'Weight w1'</span>)
ax2.set_ylabel(<span class="hljs-string">'Weight w2'</span>)
ax2.set_title(<span class="hljs-string">'Loss Contour with Optimization Path'</span>)
ax2.legend()
fig.colorbar(contour, ax=ax2, shrink=<span class="hljs-number">0.5</span>, aspect=<span class="hljs-number">20</span>)

plt.tight_layout()
plt.show()

<span class="hljs-comment"># 8. 打印优化过程摘要</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"优化过程摘要:"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"  初始权重: w1=<span class="hljs-subst">{w_trajectory[<span class="hljs-number">0</span>, <span class="hljs-number">0</span>]:<span class="hljs-number">.4</span>f}</span>, w2=<span class="hljs-subst">{w_trajectory[<span class="hljs-number">0</span>, <span class="hljs-number">1</span>]:<span class="hljs-number">.4</span>f}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"  最终权重: w1=<span class="hljs-subst">{w_trajectory[-<span class="hljs-number">1</span>, <span class="hljs-number">0</span>]:<span class="hljs-number">.4</span>f}</span>, w2=<span class="hljs-subst">{w_trajectory[-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>]:<span class="hljs-number">.4</span>f}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"  真实权重: w1=<span class="hljs-subst">{true_w[<span class="hljs-number">0</span>]:<span class="hljs-number">.1</span>f}</span>, w2=<span class="hljs-subst">{true_w[<span class="hljs-number">1</span>]:<span class="hljs-number">.1</span>f}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"  初始损失: <span class="hljs-subst">{trajectory_losses[<span class="hljs-number">0</span>]:<span class="hljs-number">.4</span>f}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"  最终损失: <span class="hljs-subst">{trajectory_losses[-<span class="hljs-number">1</span>]:<span class="hljs-number">.4</span>f}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"  迭代步数: <span class="hljs-subst">{<span class="hljs-built_in">len</span>(w_trajectory)}</span>"</span>)
</code></pre>
<p>可以发现，当我们不考虑 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi></mrow><annotation encoding="application/x-tex">b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal">b</span></span></span></span></span> 的情形下，从任意起点开始，梯度下降会逐渐收缩到整个曲面的最低点附近，这也就使得梯度下降更易于理解了。</p>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1cd4cb2a39cb4cfd9ba066331ad6c6c8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSWd1b0NoYW4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765103981&amp;x-signature=HzbAGp7gGFdSB9%2BjCQplHwqN49Y%3D" alt="" width="100%" loading="lazy"/>
<h2 data-id="heading-6">4. 参考文献</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fzh.d2l.ai%2Fchapter_linear-networks%2Findex.html" target="_blank" title="https://zh.d2l.ai/chapter_linear-networks/index.html" ref="nofollow noopener noreferrer">3. 线性神经网络</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[手势操控 Three.js！效果炸裂！]]></title>    <link>https://juejin.cn/post/7577690150092750888</link>    <guid>https://juejin.cn/post/7577690150092750888</guid>    <pubDate>2025-11-29T15:12:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577690150092750888" data-draft-id="7577647745110654976" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="手势操控 Three.js！效果炸裂！"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-29T15:12:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="看晴天了"/> <meta itemprop="url" content="https://juejin.cn/user/121387835735579"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            手势操控 Three.js！效果炸裂！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/121387835735579/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    看晴天了
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-29T15:12:58.000Z" title="Sat Nov 29 2025 15:12:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">太牛了！手势操控 Three.js！效果炸裂！</h2>
<p>部署运行你感兴趣的模型镜像一键部署</p>
<p>作为一名前端开发者，我一直热衷于界面效果展示，尤其喜欢那些<strong>炫酷</strong>的 <strong>3D</strong> 效果。</p>
<p>最近发现了一个很赞的开源项目 <code>“stark-shapes”</code>，它将<strong>手势识别</strong>与 <strong>3D 动画</strong>完美结合，借助 <code>Three.js</code> 和 <code>MediaPipe</code> 手势跟踪技术，实现了通过手势操控 3D 粒子动画的效果，视觉体验非常出色。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a774206e44ea448a9ab968bdbf5c9ebe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55yL5pm05aSp5LqG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765033978&amp;x-signature=FiYuOa%2FpHqD1skyu%2B%2FdD%2FT6cllY%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-1"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>stark-shapes 亮点</h4>
<h5 data-id="heading-2"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>多样的手势操控</h5>
<p>项目支持丰富<strong>手势操作</strong>。</p>
<p><strong>右手捏合能放大或缩小场景，左手旋转能让摄像机环绕场景，拍手可切换动画模式</strong>，交互方式简单又有趣。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0956b4fd3ae34b4eb75d67fa43ea9d76~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55yL5pm05aSp5LqG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765033978&amp;x-signature=X2LDc83v%2FQJsSeMpBpDeG%2BQQKpU%3D" alt="" loading="lazy"/></p>
<h5 data-id="heading-3"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>精美的 3D 几何图案</h5>
<p>项目包含多种 <strong>3D 几何图案</strong>，如<code>立方体</code>、<code>球体</code>、<code>螺旋</code>、<code>星系</code>等，这些图案由粒子系统生成，具有动态、流动的效果。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4a9f028b703f44f48bf3df4391a2bb44~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55yL5pm05aSp5LqG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765033978&amp;x-signature=HwtrUFEeexnGRlya6Inc1rFKe3I%3D" alt="" loading="lazy"/></p>
<p>螺旋图案粒子沿轨迹旋转延伸，星系图案模拟宇宙星系旋转运行，视觉效果极佳。</p>
<h5 data-id="heading-4"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>强大的后处理效果</h5>
<p>项目引入后处理效果，如 <strong>Bloom</strong> 效果。它能让场景中明亮部分添加光晕，使画面更柔和梦幻，增强视觉层次感和氛围感。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2ee8da3309674f22aa4ec660ef4a0838~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55yL5pm05aSp5LqG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765033978&amp;x-signature=%2FMVC0xoiVhn3uR1QFW%2B1UtOx4%2F0%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-5"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>技术实现</h4>
<h6 data-id="heading-6">Three.js 的关键作用</h6>
<p><strong>Three.js</strong> 是基于 <strong>WebGL</strong> 的 3D 绘图库，负责创建、渲染 3D 几何体及动画处理。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d183bf38ca5f478dba7655686b7ddff9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55yL5pm05aSp5LqG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765033978&amp;x-signature=C8Fl5Zkh31L7q9IL6pE5fmMZ7zc%3D" alt="" loading="lazy"/></p>
<p><strong>“stark-shapes”</strong> 项目中，它管理场景的摄像机位置、光照设置及动画循环等，呈现流畅且视觉效果出色的 3D 世界。</p>
<h6 data-id="heading-7">MediaPipe Hands 的手势识别功能</h6>
<p><strong>MediaPipe Hands</strong> 是强大的手势识别库，能实时跟踪手部关键点位置和动作。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/695f1c1d792846628e642c117ea54182~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55yL5pm05aSp5LqG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765033978&amp;x-signature=3we%2FvDh6vIeJWG2E62cYG1WvTSQ%3D" alt="" loading="lazy"/></p>
<p>在项目中，它与 <strong>Three.js</strong> 紧密结合，实现手势与 3D 场景的无缝交互。</p>
<h4 data-id="heading-8"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>快速本地运行</h4>
<p>项目体验起来很有趣，手势操作简单，并且这个项目是开源的，对前端开发者来说是个很好的学习资源。</p>
<p>特别是想在 <strong>3D</strong> 领域深入学习的开发者，可以通过阅读和研究该项目的代码，了解如何结合 <strong>Three.js</strong> 和 <strong>MediaPipe</strong> 实现复杂的交互效果。</p>
<p>如果你也对这个项目感兴趣，不妨动手下载源码试试。以下是下载和运行项目的教程：</p>
<p>克隆项目仓库：</p>
<pre><code class="hljs language-bash" lang="bash">git <span class="hljs-built_in">clone</span> git@github.com:collidingScopes/stark-shapes.git
智能体编程go
运行
</code></pre>
<p>安装项目依赖：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cd</span> stark-shapes
npm install
智能体编程go
运行
</code></pre>
<p>启动项目：</p>
<pre><code class="hljs language-go" lang="go">npm start
智能体编程<span class="hljs-keyword">go</span>
运行
</code></pre>
<p>在浏览器中打开 <code>http://localhost:8080</code> 即可查看项目效果。</p>
<p>总之， <strong>“stark-shapes”</strong> 项目实现手势操控 <strong>3D 粒子动画</strong>，带来新交互体验，是优质学习平台，拓展应用前景广阔。</p>
<p>感兴趣的朋友可体验在线预览或克隆源码深入研究。</p>
<ul>
<li><strong>stark-shapes Github 地址</strong>：<code>https://github.com/collidingScopes/stark-shapes/tree/main</code></li>
<li><strong>stark-shapes 在线体验地址</strong>：<code>https://collidingscopes.github.io/stark-shapes/</code></li>
</ul>
<p>（首次访问体验地址较慢，耐心等待资源加载。当摄像头里的手势出现识别圆点连线后，就可以体验了。）</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[3天，1人，从0到付费产品：AI时代个人开发者的生存指南]]></title>    <link>https://juejin.cn/post/7577653509862654002</link>    <guid>https://juejin.cn/post/7577653509862654002</guid>    <pubDate>2025-11-29T08:49:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577653509862654002" data-draft-id="7577663384423645235" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="3天，1人，从0到付费产品：AI时代个人开发者的生存指南"/> <meta itemprop="keywords" content="前端,后端,人工智能"/> <meta itemprop="datePublished" content="2025-11-29T08:49:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="HiStewie"/> <meta itemprop="url" content="https://juejin.cn/user/1591748568038823"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            3天，1人，从0到付费产品：AI时代个人开发者的生存指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1591748568038823/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    HiStewie
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-29T08:49:51.000Z" title="Sat Nov 29 2025 08:49:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    10
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读22分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><blockquote>
<p>这不是一篇教你用AI写代码的文章。这是一篇关于如何用AI重新定义你的能力边界的实战复盘。</p>
</blockquote>
<hr/>
<h2 data-id="heading-0">一、别焦虑了，先把东西做出来</h2>
<p>最近一周，我的朋友圈和流媒体被两种内容刷屏：</p>
<ul>
<li>一种是 <strong>Gemini 3 Pro要把程序员干死了</strong> ，配文是个悲观预测，写了一大堆分析。</li>
<li>另一种是"<strong>前端凉了</strong>"，配图是某个很牛逼但没什么 x 用的 CSS3 动画Demo；</li>
</ul>
<p>焦虑是真实的。但我想说一句可能会得罪人的话：</p>
<p><strong>大部分人的焦虑，都是"看别人做"带来的，而不是"自己做"带来的。</strong></p>
<p>当你真正动手用AI做一个完整产品的时候，你会发现：AI确实很强，但它还远没有强到能独立完成任何事情。
它需要你告诉它做什么，需要你判断它做得对不对，需要你把零散的能力串成一个可运行的系统。</p>
<p>所以我做了一个实验：<strong>用3天时间，一个人，从0开始，做一个能收钱的AI产品。</strong></p>
<p>不是Demo，不是概念验证，是一个真正上线、真正打通付费流程，完整的商业产品。</p>
<p>具体时间分配：</p>
<ul>
<li><strong>Day 1</strong>：网站架子 + 后端数据库设计</li>
<li><strong>Day 2</strong>：MVP核心功能 + 上线部署</li>
<li><strong>Day 3</strong>：样式打磨 + 用户体验优化 + 国际化 + 人工测试</li>
</ul>
<p>这篇文章是完整的复盘。</p>
<hr/>
<h2 data-id="heading-1">二、不做通用，做内容 - "Content is King",</h2>
<p>先说产品是什么：<strong>「第N个我」—— Prompt 文生图工具。</strong></p>
<p>官网地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.nthme.org%2F" target="_blank" title="https://www.nthme.org/" ref="nofollow noopener noreferrer">www.nthme.org/</a></p>
<p>用户上传一张照片，选择一个"世界线"，AI生成一张那个平行宇宙里的你。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cbbd65b2b8a343a39af18cf3b7de1baa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGlTdGV3aWU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765011334&amp;x-signature=RxuMpSOYcO8XcNxlQ2vE%2F8m6hHU%3D" alt="截屏2025-11-29 15.21.31.png" loading="lazy"/></p>
<p>市面上的AI头像产品，大多走两条路：</p>
<ul>
<li><strong>通用型</strong>：你输入任意Prompt，AI随便生。自由度高，但门槛也高，普通用户根本不知道写什么。</li>
<li><strong>大厂型</strong>：自然语言输入，比如豆包或者元宝，传一张图片然后告诉 AI 怎么改。</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/95d74147c978463a8cacf72a766129e3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGlTdGV3aWU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765011334&amp;x-signature=%2BrdSJZj3pHIRiNDnSRDyEcfWNI4%3D" alt="截屏2025-11-29 15.28.16.png" loading="lazy"/></p>
<ul>
<li>这些是竞品，想抢他们的流量，卷价格对个人开发者来说永远是下策；</li>
<li>卷功能吗？都是套壳AI文生图，谁也别笑话谁</li>
<li>就只能卷新意了，网站有没有让人眼前一亮，或者自成一套体系的文化(但这也很玄学，我还在摸索中)</li>
</ul>
<hr/>
<h2 data-id="heading-2">三、商业逻辑：为什么这件事能赚钱？</h2>
<p>说完产品出发思路，现在来谈谈钱。</p>
<p>这个产品的商业模式，本质上是一个非常经典的 “<strong>信息差 + 技术降维"（Arbitrage + Wrapper）模型</strong>。”</p>
<p>在中国市场，这被叫做"套壳站"——但我更愿意称之为"<strong>场景化AI工具</strong>"。</p>
<h3 data-id="heading-3">区别在哪？</h3>
<p>套壳站是简单的 API 转发，没有产品设计，没有用户体验，就是把别人的能力包一层皮卖出去。</p>
<p>场景化AI工具是<strong>在套壳的基础上，解决一个具体问题</strong>。</p>
<p>你想想，对于绝大多数中国用户来说：</p>
<ul>
<li><strong>Prompt是玄学</strong>：不知道写什么，写了也不对</li>
<li><strong>翻墙是红线</strong>：不会翻，不敢翻，嫌麻烦</li>
</ul>
<p>这两者加起来，构成了巨大的付费意愿。</p>
<p>我做的事情，就是<strong>吃掉这两层成本</strong>：</p>
<ul>
<li>用户不用学 Prompt → 我帮你精挑细选好 N 套 Prompt（很多Prompt都是垃圾，需要自己不停调试）</li>
<li>用户不用翻墙 → Nanobanana 你国内用不了，我服务器代理帮你调用</li>
</ul>
<p><strong>本质上，我们是中间商（Reseller），不只这个产品，任何AI工具只要你不是研究模型的开发者，你都是中间商</strong></p>
<p>但中间商不是贬义词。</p>
<p>淘宝卖家是中间商，滴滴司机是中间商，你公司的销售也是中间商。中间商的底层价值是『<strong>降低交易摩擦</strong>』。</p>
<p>我的价值就是：<strong>技术降维 + 场景化封装</strong>。</p>
<p>把一个"需要懂技术才能用"的能力，变成"打开网页就能用"的产品。</p>
<p>这件事能赚多少钱？不知道。但我知道，愿意为"发一张不一样的朋友圈"付费的人，远比愿意学Prompt的人多得多。</p>
<hr/>
<h2 data-id="heading-4">四、MVP：砍功能是最难的技术活</h2>
<p>我见过太多独立开发者的项目死在"功能太多"上。</p>
<p>不是没做完，是做了太多。每个功能都是60分，合在一起就是一坨不可用的东西。有代码洁癖、有完美主义情节没错，但是如果你要想做一个商业产品，很显然你需要全面的考量</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/92b4a8a0ecf04c15bfcb8538344ed5fb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGlTdGV3aWU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765011334&amp;x-signature=OgyKabGXkBuuHDpphm90IhtSjAs%3D" alt="截屏2025-11-29 15.38.09.png" loading="lazy"/>
所以我给自己定了一个规则：<strong>MVP只保留能完成"付费闭环"的功能。</strong></p>
<p>什么是付费闭环？用户进来 → 产生价值 → 愿意付钱 → 支付成功。</p>
<p>任何不在这条链路上的功能，全部砍掉。</p>
<p><strong>砍掉的：</strong></p>
<ul>
<li>❌ 用户自定义Prompt（增加理解成本）</li>
<li>❌ 社区分享功能（分散注意力）</li>
<li>❌ 批量生成（复杂化定价）</li>
<li>❌ 生成历史管理（非核心痛点，还涉及用户隐私风险）</li>
</ul>
<p><strong>保留的：</strong></p>
<ul>
<li>✅ N 个精选世界线（核心产品力）</li>
<li>✅ 即时生成预览（价值感知）</li>
<li>✅ 简单的积分系统（付费机制）</li>
<li>✅ 一键下载（价值交付）</li>
</ul>
<p>你可能会说：生成历史不重要吗？用户可能想回看啊。</p>
<p>重要，但不是Day 1重要。</p>
<p><strong>如果用户连第一次生成都不愿意付费，那生成历史有什么意义？</strong></p>
<p>MVP的核心是验证一件事：有没有人愿意为这个产品付钱。其他都是验证之后的事。</p>
<hr/>
<h2 data-id="heading-5">五、技术选型：偷懒是一种能力</h2>
<p>独立开发者最稀缺的资源是时间。所以技术选型的核心标准只有一个：<strong>用最少的时间，搭建一个可运行的系统。</strong></p>
<p>这是我的选择：</p>








































<table><thead><tr><th>需求</th><th>选择</th><th>为什么</th></tr></thead><tbody><tr><td>框架</td><td>Next.js 14</td><td>App Router + API Routes，前后端一把梭</td></tr><tr><td>样式</td><td>Tailwind CSS</td><td>不用写CSS文件，不用起类名</td></tr><tr><td>数据库</td><td>PostgreSQL + Prisma</td><td>类型安全，迁移方便，Vercel Postgres免费</td></tr><tr><td>认证</td><td>NextAuth.js</td><td>10分钟搞定登录注册</td></tr><tr><td>部署</td><td>Vercel</td><td>Git push即部署，零运维</td></tr><tr><td>AI</td><td>Nano Banana API</td><td>稳定，便宜，按量付费</td></tr></tbody></table>
<p>你可能注意到，这套技术栈几乎全是"开箱即用"型的。</p>
<p>没有自己写鉴权逻辑，没有自己配CI/CD，没有自己管服务器。</p>
<p><strong>这不是偷懒，这是杠杆。</strong></p>
<p>5202年了，这些轮子已经有人造好了，而且造得比你自己造的好 10 倍。你的时间应该花在"只有你能做"的事情上——产品设计、用户体验、商业逻辑。</p>
<p>基础设施？让别人来。</p>
<hr/>
<h2 data-id="heading-6">六、登录注册：10分钟，真的</h2>
<p>NextAuth.js 是我用过最省心的认证库。</p>
<p>整个登录系统，包括：</p>
<ul>
<li>邮箱密码注册/登录</li>
<li>Google OAuth</li>
<li>Session管理</li>
<li>数据库同步</li>
</ul>
<p>代码量：1个配置文件 + 1个Prisma Schema。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// auth.ts 核心配置</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">authOptions</span>: <span class="hljs-title class_">NextAuthOptions</span> = {
  <span class="hljs-attr">providers</span>: [
    <span class="hljs-title class_">CredentialsProvider</span>({
      <span class="hljs-attr">name</span>: <span class="hljs-string">'credentials'</span>,
      <span class="hljs-attr">credentials</span>: {
        <span class="hljs-attr">email</span>: { <span class="hljs-attr">label</span>: <span class="hljs-string">'Email'</span>, <span class="hljs-attr">type</span>: <span class="hljs-string">'email'</span> },
        <span class="hljs-attr">password</span>: { <span class="hljs-attr">label</span>: <span class="hljs-string">'Password'</span>, <span class="hljs-attr">type</span>: <span class="hljs-string">'password'</span> },
      },
      <span class="hljs-keyword">async</span> <span class="hljs-title function_">authorize</span>(<span class="hljs-params">credentials</span>) {
        <span class="hljs-comment">// 验证逻辑</span>
      },
    }),
    <span class="hljs-title class_">GoogleProvider</span>({
      <span class="hljs-attr">clientId</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">GOOGLE_CLIENT_ID</span>!,
      <span class="hljs-attr">clientSecret</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">GOOGLE_CLIENT_SECRET</span>!,
    }),
  ],
  <span class="hljs-comment">// ... 其他配置</span>
};
</code></pre>
<p>一个踩坑点：Credentials Provider 的 session 处理。</p>
<p>NextAuth默认的session只包含很少的用户信息。如果你用数据库存用户，需要在callbacks里手动把userId塞进去：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-attr">callbacks</span>: {
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">jwt</span>(<span class="hljs-params">{ token, user }</span>) {
    <span class="hljs-keyword">if</span> (user) token.<span class="hljs-property">id</span> = user.<span class="hljs-property">id</span>;
    <span class="hljs-keyword">return</span> token;
  },
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">session</span>(<span class="hljs-params">{ session, token }</span>) {
    <span class="hljs-keyword">if</span> (session.<span class="hljs-property">user</span>) session.<span class="hljs-property">user</span>.<span class="hljs-property">id</span> = token.<span class="hljs-property">id</span> <span class="hljs-keyword">as</span> <span class="hljs-built_in">string</span>;
    <span class="hljs-keyword">return</span> session;
  },
},
</code></pre>
<p>就这么多。10分钟，登录系统搞定。一个Google邮箱登录，一个基础的账号密码登录 + 一个注册；</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ea8523f5147c436ca4bdac8c5d42e11c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGlTdGV3aWU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765011334&amp;x-signature=7jlEHJ0es8SgfDLuVs5iheOCrSU%3D" alt="截屏2025-11-29 16.41.27.png" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-7">七、后端逻辑：积分系统的信任架构</h2>
<p>积分系统听起来简单：用户充钱 → 加积分 → 生成图片 → 扣积分。</p>
<p>但魔鬼在细节里。</p>
<p><strong>问题1：扣积分和生成图片，谁先谁后？</strong></p>
<p>错误做法：先生成图片，成功后再扣积分。</p>
<ul>
<li>风险：生成成功但扣积分失败，用户白嫖。</li>
</ul>
<p>正确做法：先扣积分，失败后再退回。</p>
<ul>
<li>逻辑：先"冻结"积分，生成成功则确认扣除，失败则退回。</li>
</ul>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 伪代码</span>
<span class="hljs-keyword">await</span> <span class="hljs-title function_">deductCredits</span>(userId, cost);  <span class="hljs-comment">// 先扣</span>
<span class="hljs-keyword">try</span> {
  <span class="hljs-keyword">const</span> image = <span class="hljs-keyword">await</span> <span class="hljs-title function_">generateImage</span>(prompt);
  <span class="hljs-keyword">return</span> image;  <span class="hljs-comment">// 成功，积分已扣</span>
} <span class="hljs-keyword">catch</span> (error) {
  <span class="hljs-keyword">await</span> <span class="hljs-title function_">refundCredits</span>(userId, cost);  <span class="hljs-comment">// 失败，退回</span>
  <span class="hljs-keyword">throw</span> error;
}
</code></pre>
<p><strong>问题2：如何防止订单重复处理？</strong></p>
<p>爱发电的Webhook可能会重复发送。如果不做幂等处理，用户可能被多次加积分。</p>
<p>解决方案：用 <code>afdianOrderId</code> 做唯一键。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 检查订单是否已处理</span>
<span class="hljs-keyword">const</span> existing = <span class="hljs-keyword">await</span> prisma.<span class="hljs-property">transaction</span>.<span class="hljs-title function_">findFirst</span>({
  <span class="hljs-attr">where</span>: { <span class="hljs-attr">afdianOrderId</span>: orderId },
});
<span class="hljs-keyword">if</span> (existing) {
  <span class="hljs-keyword">return</span> { <span class="hljs-attr">ec</span>: <span class="hljs-number">200</span>, <span class="hljs-attr">em</span>: <span class="hljs-string">'Already processed'</span> };
}
</code></pre>
<p><strong>问题3：免费额度怎么设计？</strong></p>
<p>新用户应该能免费试用，否则付费转化无从谈起。</p>
<p>我的设计：注册即送 10 积分（够生成2次），每日签到送 2 积分（不够生成1次，但积累2天可以）。</p>
<blockquote>
<p>PS：签到功能还没实现哈，后续加上，很快</p>
</blockquote>
<p>这个数字是刻意的：</p>
<ul>
<li>10 积分让用户体验核心功能</li>
<li>每日 2 积分制造"再来一次"的动机</li>
<li>但不够随便用，必须付费才能畅玩</li>
</ul>
<p><strong>积分系统的本质是信任系统：用户相信付了钱就能用，你相信用户不会薅走你的服务。</strong></p>
<hr/>
<h2 data-id="heading-8">八、收款：个人开发者的变现困境</h2>
<p>技术问题都好解决，最难的是收钱。</p>
<p>作为个人开发者，你会撞上这些墙：</p>
<ul>
<li>微信/支付宝官方支付：需要企业资质,你要开公司，办营业执照，申请各种东西</li>
<li>Stripe：需要海外公司</li>
<li>国内第三方支付：大多数也要企业资质，或者费率高得离谱</li>
</ul>
<p>我的解决方案：<strong>爱发电</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/47a243f7d9b444e48ba9426be8211f5a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGlTdGV3aWU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765011334&amp;x-signature=iK0aUyBfhYa2jCEF6eJgexS1cA8%3D" alt="截屏2025-11-29 16.50.44.png" loading="lazy"/></p>
<p>爱发电是一个创作者赞助平台，个人可以直接使用，费率合理（约6%），支持 Webhook 回调（很重要，充值成功的回调就靠它）。</p>
<p>集成流程：</p>
<ol>
<li>用户在产品内点击"充值"</li>
<li>跳转到爱发电对应档位页面</li>
<li>用户付款，爱发电回调你的 <strong>Webhook</strong></li>
<li>你的服务器处理回调，给用户加积分</li>
</ol>
<p>关键技巧：<strong>用户的邮箱从哪来？</strong></p>
<p>爱发电的订单信息不包含用户邮箱，只有赞助者的爱发电昵称。怎么和你数据库里的用户对应上？</p>
<p>我的做法：让用户在爱发电的"留言"字段填写自己的注册邮箱。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 从留言中提取邮箱</span>
<span class="hljs-keyword">const</span> emailMatch = order.<span class="hljs-property">remark</span>?.<span class="hljs-title function_">match</span>(
  <span class="hljs-regexp">/[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/</span>
);
<span class="hljs-keyword">const</span> email = emailMatch?.[<span class="hljs-number">0</span>]?.<span class="hljs-title function_">toLowerCase</span>();
</code></pre>
<p>不够优雅？确实。但 MVP 阶段，能跑通比优雅更重要。</p>
<p>未来可以升级为：</p>
<ul>
<li>用户在产品内绑定爱发电账号</li>
<li>生成唯一的充值链接/兑换码</li>
<li>或者用户量真的起来了，你再去申请公司，办营业执照，接支付宝/微信</li>
</ul>
<p><strong>MVP的哲学：先有再好。</strong> 爱发电只是一个你用来测试用户付费意愿 + 前期市场验证的低成本工具</p>
<p>PS：问题发现，爱发电支付宝链路不同，目前只能用微信</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/78fb0bf333f94ca98684851d74313965~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGlTdGV3aWU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765011334&amp;x-signature=OIalV7WYFM4B2PMRuodYwIY3xwU%3D" alt="截屏2025-11-29 16.12.37.png" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-9">九、审美：UI/UX 的作用是"显得值钱"</h2>
<ul>
<li>UI（User Interface，用户界面）是「产品的外观与交互载体」
<ul>
<li><strong>看得见、摸得着</strong>：比如界面的色彩搭配、按钮样式、字体大小、图标设计、页面布局，核心是让产品“美观、易用、符合视觉逻辑”。</li>
</ul>
</li>
<li>UX（User Experience，用户体验）是「用户使用产品的完整感受与效率」。
<ul>
<li><strong>用得爽、没阻碍</strong>：比如用户从打开APP到完成目标（如购物、打车）的步骤是否简洁、操作是否流畅、遇到问题能否快速解决，甚至包括品牌印象、售后体验，核心是让产品“满足需求、降低成本、带来愉悦感”。</li>
</ul>
</li>
</ul>
<p>首先，我们需要纠正一个工程师常见的误区。</p>
<p>很多开发者觉得“设计”是玄学，或者是设计师的事，与代码无关。</p>
<p><strong>大谬！设计是产品的一部分，而且是用户最先感知到的部分。</strong></p>
<p>你的架构再优雅，用户不关心；你的算法再先进，用户看不见。用户第一眼看到的就是 UI，而第一印象决定了他们是掏钱还是关闭网页。 在这里，我要抛出一个更露骨的观点：<strong>对于独立产品而言，UI 的作用不是“好看”，而是“显得值钱”。</strong></p>
<p>我们的目标用户是谁？是那些为了发朋友圈、发小红书愿意付费的人。这群人不懂技术，也不关心你用了什么模型。他们只看一件事：<strong>这个产品看起来牛不牛逼？</strong></p>
<p>如果你的 UI 看起来像个 Bootstrap 拼凑的学生作业，用户潜意识会觉得：“这玩意儿生成的图能好吗？5 块钱我都嫌多。” 如果你的 UI 看起来像个<strong>黑科技实验室</strong>，用户会觉得：“哇，这个系统好高级，生成的图肯定不一样。50 块钱？值！”</p>
<h3 data-id="heading-10">UI/UX 是定价权的一部分</h3>
<h4 data-id="heading-11">1. 色彩系统</h4>
<p>所以我给「第 N 个我」定的视觉基调是：<strong>Steins;Gate（命运石之门） × Cyberpunk 2077 × Neo-Brutalist。</strong></p>
<p>有人问：<em>“为什么不选永远不会出错的 Apple Style（极简白/磨砂玻璃）？”</em></p>
<p>这涉及到底层逻辑的选择：<strong>Content is King（内容为王）</strong>。</p>
<ul>
<li><strong>Apple Style</strong> 是中性的、克制的。它像一杯白开水，不承载任何情绪，适合通用工具（如备忘录、日历）。</li>
<li><strong>Cyberpunk Style</strong> 是激进的、有侵略性的。它是一个<strong>情绪容器</strong>。</li>
</ul>
<p>我的产品不是一个“修图工具”，而是一个“科幻引擎”。苹果的设计语言太冷静了，无法承载“穿越平行宇宙”的疯狂感。我需要的是<strong>躁动、电流和不确定性</strong>。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4a7c3ad03ee44acc99490f39f5b86723~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGlTdGV3aWU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765011334&amp;x-signature=03lHvKJv43WWV6XyKluD8DTC8rk%3D" alt="截屏2025-11-29 15.53.46.png" loading="lazy"/></p>
<p>一开始我试过 Vibe Coding 的蓝紫配色（渐变紫、霓虹蓝那一套）。但做出来发现一个问题：<strong>太像廉价的诈骗页了。</strong> 那种配色现在已经烂大街，用户一看就觉得："又是什么割韭菜的东西。"</p>
<p>于是我换了方向：<strong>电光绿（Acid Green）+ 终端风格</strong>。效果立刻不一样了：</p>
<ul>
<li>黑色背景 + 荧光绿文字 = 终端命令行</li>
<li>等宽字体 + 方块按钮 = 工程师专用工具</li>
<li>二进制雨 + 扫描线效果 = 黑客帝国既视感</li>
</ul>
<p><strong>这种"硬核感"营造出一种"实验室出品"的稀缺感。</strong></p>
<h4 data-id="heading-12">2. 视觉元素</h4>
<p>二进制雨（BinaryRain组件）：</p>
<ul>
<li>首页背景不断下落的 0 和 1，致敬《黑客帝国》。这在暗示用户：你正在接触世界的底层代码。</li>
</ul>
<p>单间距字体（monospace）：</p>
<ul>
<li>全站强制使用等宽字体（代码字体）。</li>
<li>营造出“终端”、“命令行”、“未经修饰”的粗砺感。</li>
</ul>
<p>微动效 (Micro-interaction)：</p>
<ul>
<li>按钮 Hover 时的故障 (Glitch) 效果；</li>
<li>卡片的悬浮阴影；</li>
<li>加载时的脉冲动画。</li>
</ul>
<blockquote>
<p>还有很多小巧思就不赘述了，可以自己点击看看</p>
</blockquote>
<h4 data-id="heading-13">3. 文案调性</h4>
<p>在设计文案时，我制定了一条铁律：严禁出现‘用户’、‘购买’、‘生成’这三个词。</p>
<p><strong>我构建了一套「观测者叙事」体系。</strong></p>
<ul>
<li>身份重构：屏幕前的不是“客户”，而是手握终端的 <strong>“观测员” (Observer)</strong>。</li>
<li>行为重构：他们支付的不是钱💰，而是维持量子态稳定的 <strong>“算力能源” (Energy)</strong>。</li>
</ul>
<p>这不仅仅是为了酷，这是基础的商业心理学。</p>
<p>当“花 39 块钱买个会员”变成了“为超弦引擎注入能量以解锁高维权限”时，用户的心理账户 (Mental Accounting) 就发生了转移：</p>
<ul>
<li>从斤斤计较的 <strong>“实用工具/日常开销”</strong> 账户（对标买菜、买文具）；</li>
<li>转移到了 <strong>“娱乐/游戏体验”</strong> 账户（对标买皮肤、抽卡）。</li>
</ul>
<p>在这个新账户里，用户的付费意愿是极高的，价格敏感度是极低的。</p>
<p>结论：产品即叙事。每一个按钮、每一行文案，都在构建那个平行宇宙。这就是审美的商业价值——它让用户觉得“这个东西值这个价”。</p>
<hr/>
<h2 data-id="heading-14">十、i18n国际化与地理套利：代码世界的“降维打击</h2>
<p><strong>国际化很重要，国际化很重要，国际化很重要，重要的事情说 3 遍</strong></p>
<p>在开发初期，我就坚定地把 <strong>i18n（国际化）</strong> 列为 P0 级需求，而不是“有空再做”的锦上添花。这背后不是为了显得高大上，而是基于一个赤裸裸的商业逻辑：<strong>地理套利 (Geo-Arbitrage)</strong>。</p>
<p>作为独立开发者，我们的肉身或许被禁锢在某个具体的时空坐标，但我们的代码和产品可以在光纤中自由穿梭。</p>
<h3 data-id="heading-15">1. 购买力平价的“汇率魔法”</h3>
<p>这是一个简单的数学题，也是一个残酷的现实：</p>
<p>在国内，让用户掏出 <strong>¥19.9</strong> 可能需要你写 500 字的文案、做 3 张精美的海报，还得应对“能不能便宜点”的客服咨询，甚至面临被举报的风险。</p>
<p>而在北美或欧洲市场，<strong>$9.99 (约 ¥72)</strong> 对用户来说仅仅是“一杯星巴克 + 小费”的价格。</p>
<ul>
<li><strong>心理账户差异</strong>：欧美用户的 SaaS 订阅习惯极其成熟。对于 $10 以下的数字产品，他们的决策成本几乎为零（No-brainer decision）。</li>
<li><strong>杠杆效应</strong>：同样的 GPU 算力消耗，同样的开发时间成本，仅仅因为语言不同，<strong>你的单位时间产出（ROI）直接放大了 7 倍</strong>。这就是代码世界的“汇率魔法”。</li>
</ul>
<h3 data-id="heading-16">2. 逃离“内卷”引力圈</h3>
<p>国内的 C 端工具类产品市场早已是一片红海，同质化竞争导致价格战频发（Race to the bottom）。</p>
<p>而通过 i18n，我们将战场转移到了全球（市场扩大）。虽然全球竞争也激烈，但你的创意总会带你杀出重围！</p>
<h3 data-id="heading-17">3. 收入结构的抗脆弱性 (Antifragility)</h3>
<p>当你的收入来源不仅限于人民币，而是包含了美元、欧元、日元时，你的个人财务系统就具备了极强的<strong>抗脆弱性</strong>。</p>
<p>你不再依赖单一市场的经济周期。哪怕某个区域的支付渠道暂时波动，全球各地的“观测员”依然在源源不断地为你的终端注入能源。</p>
<h3 data-id="heading-18">📊 市场维度对比表</h3>

























<table><thead><tr><th align="left">维度</th><th align="left">国内市场 (CNY)</th><th align="left">全球市场 (USD/EUR)</th></tr></thead><tbody><tr><td align="left"><strong>决策阻力</strong></td><td align="left">高 (习惯免费/破解)</td><td align="left">低 (习惯订阅/付费)</td></tr><tr><td align="left"><strong>收入倍率</strong></td><td align="left">1x (基准)</td><td align="left"><strong>7x ~ 8x (地理套利)</strong></td></tr><tr><td align="left"><strong>竞争态势</strong></td><td align="left">极度内卷 (红海)</td><td align="left">审美差异化 (蓝海)</td></tr></tbody></table>
<p><strong>一句话总结：</strong>
<strong>i18n 不是简单的翻译，它是独立开发者实现“赚美元，花人民币”这一终极梦想的入场券，也是将个人影响力辐射至全球的必经之路。</strong></p>
<p>注意，i18n不只是翻译。它强迫你思考：</p>
<ul>
<li>这段文案的核心意思是什么？</li>
<li>换一种语言，怎么表达同样的意思？</li>
<li>有些概念在另一种文化里存在吗？</li>
</ul>
<p>比如"建立纠缠"这个按钮，直译是"Create Entanglement"。但英文用户会觉得莫名其妙。</p>
<p>最终我用的是"Establish Link"——保留了"建立连接"的意思，丢掉了"量子纠缠"的梗。</p>
<p><strong>翻译不是对照词典，是重新创作。</strong> 技术实现上，我用的是最朴素的方案：文件级i18n。</p>
<pre><code class="hljs language-js" lang="js">lib/i18n/
├── locales/
│   ├── zh-<span class="hljs-variable constant_">CN</span>.<span class="hljs-property">ts</span>  <span class="hljs-comment">// 中文</span>
│   └── en-<span class="hljs-variable constant_">US</span>.<span class="hljs-property">ts</span>  <span class="hljs-comment">// 英文</span>
├── context.<span class="hljs-property">tsx</span>   <span class="hljs-comment">// React Context</span>
└── types.<span class="hljs-property">ts</span>      <span class="hljs-comment">// 类型定义</span>
</code></pre>
<p>没有用 next-intl 或 i18next 这些库，因为项目规模不需要。简单的 Context + TypeScript 类型约束就够了。</p>
<p>未来做SEO的时候，可能需要多语言URL（<code>/en/showcase</code> vs <code>/zh/showcase</code>）。但MVP阶段，浏览器语言检测 + 手动切换就够用了。</p>
<hr/>
<h2 data-id="heading-19">十一、部署：Vercel，在“墙”与“云”之间寻找缝隙</h2>
<h3 data-id="heading-20">理想状态：Git Push 即部署</h3>
<p>以前部署一个网站，通过是：买服务器 -&gt; 装 Nginx -&gt; 配域名 -&gt; 申请 SSL 证书 -&gt; 写 CI/CD 脚本……
现在？</p>
<ol>
<li>代码推到 GitHub</li>
<li>Vercel 里 Import 项目</li>
<li>配置环境变量</li>
<li>点击 Deploy</li>
</ol>
<p><strong>完了。</strong>
自动 CI/CD、自动 HTTPS、自动 CDN、自动预览部署。这就是现代独立开发的“基建红利”。</p>
<p>你的时间和精力，应该100%放在产品本身。</p>
<h3 data-id="heading-21">现实引力：国内访问的“坑”</h3>
<p>然而，当我兴奋地把生成的 <code>xxx.vercel.app</code> 链接发给国内的朋友时，得到的反馈却是：“打不开”、“连接重置”。</p>
<p><strong>原因很简单</strong>：<code>*.vercel.app</code> 这个后缀在国内因为众所周知的原因，DNS 污染严重，基本处于不可用状态。</p>
<h3 data-id="heading-22">🛠️ 避坑指南：Cloudflare + Vercel 组合拳</h3>
<p>要解决这个问题，不能依赖 Vercel 分配的免费域名，必须绑定<strong>自定义域名</strong>。以下是我的实战配置（踩坑）总结：</p>
<ol>
<li><strong>域名购买</strong>：随便哪里买（Namecheap/阿里云/腾讯云），但建议把 DNS 解析托管到 <strong>Cloudflare</strong>。</li>
<li><strong>CNAME 配置</strong>：
<ul>
<li>在 Vercel 后台 -&gt; Settings -&gt; Domains，添加你的域名（如 <code>app.yourdomain.com</code>）。</li>
<li>Vercel 会提示你添加一条 CNAME 记录指向 <code>cname.vercel-dns.com</code>。</li>
</ul>
</li>
<li><strong>Cloudflare 的“小黄云”陷阱</strong>：
<ul>
<li>在 Cloudflare 添加 CNAME 时，<strong>建议先关闭 Proxy（点灰那个小黄云图标，仅使用 DNS only）</strong>。</li>
<li><strong>为什么？</strong> 如果开启 Proxy（小黄云），Cloudflare 会再次代理流量，虽然能提供防护，但有时会和 Vercel 的 SSL 签发冲突，导致“重定向次数过多”或证书错误。</li>
<li><em>进阶方案</em>：如果你一定要开小黄云（为了抗攻击），请务必在 Cloudflare 的 SSL/TLS 设置中选择 <strong>"Full (Strict)"</strong> 模式。</li>
</ul>
</li>
</ol>
<p><strong>结论</strong>：只要配置了自定义域名 + 正确的 CNAME，国内用户就能通过优选线路流畅访问你的“量子观测站”，无需梯子。</p>
<hr/>
<h2 data-id="heading-23">十二、增量思维：上线只是“第一次接触”</h2>
<p>MVP (Minimum Viable Product) 上线了，然后呢？</p>
<p>很多独立开发者容易在这里迷失，陷入两个极端：</p>
<ol>
<li><strong>过度开发的陷阱</strong>：用户还没来，后台管理系统已经写得比淘宝还复杂。这是在制造“代码垃圾”。</li>
<li><strong>射后不理的傲慢</strong>：上线即巅峰，等着流量自然降临。这是在赌博。</li>
</ol>
<p>在我的逻辑里，<strong>上线不是结束，而是“观测”的开始。</strong>
正确的姿势是：<strong>根据真实反馈，对抗熵增，增量迭代。</strong></p>
<h3 data-id="heading-24">🗺️ 时间线演化路线图 (Timeline Roadmap)</h3>
<p>我给自己制定了一个严格的“三步走”战略，<strong>严禁跨阶段开发</strong>：</p>
<p><strong>Phase 1: 奇点点火 (V1.0 Current)</strong></p>
<ul>
<li><strong>目标</strong>：验证核心商业闭环 (PMF)。</li>
<li><strong>状态</strong>：✅ 已上线</li>
<li><strong>内容</strong>：
<ul>
<li>6 个核心平行世界线 (风格模型)</li>
<li>基于积分的能源消耗系统</li>
<li>爱发电 (Aifadian) 支付链路打通</li>
</ul>
</li>
<li><em>潜台词：只要能跑通“生成-&gt;满意-&gt;付费”这一个循环，其他的都不重要。</em></li>
</ul>
<p><strong>Phase 2: 体验补完 (V1.1 Planning)</strong></p>
<ul>
<li><strong>目标</strong>：提升留存率 (Retention)，减少操作摩擦。</li>
<li><strong>内容</strong>：
<ul>
<li><strong>观测日志 (History)</strong>：用户不想每次都重新生成，他们需要找回之前的“感动”。</li>
<li><strong>批量下载 (Batch Export)</strong>：从“玩票”到“生产力”的转变。</li>
<li><strong>多维支付</strong>：接入 Stripe/USDT，为全球化做准备。</li>
</ul>
</li>
</ul>
<p><strong>Phase 3: 维度扩张 (V2.0 Vision)</strong></p>
<ul>
<li><strong>目标</strong>：构建生态 (Ecosystem) 与网络效应。</li>
<li><strong>状态</strong>：🔒 待解锁</li>
<li><strong>内容</strong>：
<ul>
<li><strong>自定义协议 (UGC)</strong>：允许用户上传图片训练自己的 LoRA，并上架到“商店”。</li>
<li><strong>社区共振</strong>：分享你的观测结果，获得积分奖励。</li>
<li><strong>API 开放</strong>：让其他开发者接入我的“量子算力”。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-25">🛑 核心原则：先有付费，再有功能</h3>
<p>请注意这个顺序：<strong>先有付费用户，再加功能。</strong></p>
<p>因为没有用户反馈的功能开发，本质上是一种**“自嗨” (Self-High)**。你坐在屏幕前以为用户需要“暗黑模式”或“社交分享”，但数据可能会告诉你，他们只想要一个“一键高清放大”按钮。</p>
<p><strong>最好的产品经理不是你，是你的用户。</strong>
不要去猜宇宙的形状，去听观测员发回的信号。听他们的，改代码，然后再次发布。</p>
<hr/>
<h2 data-id="heading-26">十三、结语：AI时代，拿回你的生产资料</h2>
<p>写到这里，回头看那个最初萦绕在每个人心头的问题：<strong>AI 时代，开发者会被取代吗？</strong></p>
<p>我的答案是：<strong>不会，但会被重新定义。</strong></p>
<h3 data-id="heading-27">代码的贬值与人的升值</h3>
<p>在过去，开发者的价值锚点是 <strong>"How"</strong> —— 你会不会写代码？你会不会优化算法？</p>
<p>而在今天，开发者的价值锚点转移到了 <strong>"What" &amp; "Why"</strong> —— 你知不知道要做什么？你知不知道为什么而做？</p>
<p>代码只是工具，是连接现实与数字世界的铲子。AI 让这把铲子变成了挖掘机，但挖掘机本身不会决定去哪里挖掘宝藏。</p>
<p><strong>决定做什么、为谁做、赋予产品什么样的灵魂——这是人的特权，也是人的责任。</strong></p>
<h3 data-id="heading-28">一个人，就是一支队伍</h3>
<p>这个项目，我用了 3 天做完。如果没有 AI 辅助编码，可能需要 2 周甚至更久。AI 帮我节省了 80% 的时间。</p>
<p>但那省下的时间，我没有用来刷短视频。
我用它来思考产品定位，去推敲每一个文案的语气，去打磨视觉风格，去构建那个关于“观测者”的世界。</p>
<p><strong>AI 不是来取代你的，它是来放大你的。</strong></p>
<p>它是一面镜子，也是一个放大器：</p>
<ul>
<li>如果你只会写代码，AI 会让你以十倍的速度写出<strong>没人用的代码</strong>。</li>
<li>如果你懂产品、懂用户、懂商业，AI 会让你<strong>一个人变成一支建制完整的特种小队</strong>。</li>
</ul>
<h3 data-id="heading-29">别焦虑，去创造</h3>
<p>所以，别焦虑了。焦虑不会写出代码，也不会带来用户。</p>
<p>在这个算力爆炸的时代，<strong>想象力</strong>才是唯一的稀缺资源。</p>
<p>打开你的编辑器，不要去想“我要练什么技术栈”，去想一个你真正想解决的问题，去想一个你真正想创造的世界。</p>
<p>然后，开始写下第一行代码。</p>
<blockquote>
<p>AI 会帮你的</p>
<p>世界会看到的</p>
</blockquote>
<hr/>
<p><strong>附：项目信息</strong></p>
<ul>
<li>项目地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTrade-Offf%2FThe-Nth-Me" target="_blank" title="https://github.com/Trade-Offf/The-Nth-Me" ref="nofollow noopener noreferrer">The Nth Me</a></li>
<li>在线体验：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.nthme.org%2F" target="_blank" title="https://www.nthme.org/" ref="nofollow noopener noreferrer">www.nthme.org/</a></li>
<li>开源协议：CC BY-NC-SA 4.0（非商业使用）</li>
</ul>
<p>如果这篇文章对你有启发，欢迎分享给同样在焦虑的朋友。</p>
<p>欢迎试用项目，欢迎捉虫和开发建议，如被采纳，将会获赠微型奇点（初级用户卡）</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[征程 6 | linear 高精度输出配置方式]]></title>    <link>https://juejin.cn/post/7577970969395298345</link>    <guid>https://juejin.cn/post/7577970969395298345</guid>    <pubDate>2025-11-30T09:19:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577970969395298345" data-draft-id="7577797563854061604" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="征程 6 | linear 高精度输出配置方式"/> <meta itemprop="keywords" content="自动驾驶,算法"/> <meta itemprop="datePublished" content="2025-11-30T09:19:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="地平线开发者"/> <meta itemprop="url" content="https://juejin.cn/user/1257497032132567"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            征程 6 | linear 高精度输出配置方式
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1257497032132567/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    地平线开发者
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T09:19:43.000Z" title="Sun Nov 30 2025 09:19:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1. 常规情况</h2>
<p>基础知识：</p>
<ol>
<li>考虑到模型输出位置量化损失对模型精度的影响较大，工具链推荐模型以 linear/conv 结尾，此时支持高精度 int32 输出（在 quantized.onnx 中，转定点为 int32，在前面 calib+qat 阶段都是 float32），这几乎可以做到无损。</li>
<li>征程 6 工具链量化 setter 模板支持自动设置高精度输出，前提是 conv 输出直接 接 dequant，不作为其他 node 的输入。</li>
</ol>
<p>输出位置结构示意图：</p>
<p><img src="https://mcnsakkce4vm.feishu.cn/space/api/box/stream/download/asynccode/?code=NDA4MjU5ZTU2ZWU3NzA4YWRiMDFiNzkzY2JjMzgwMjlfaGg5c2RBSGxhRHo2eWpkeUhURElzY0IyRXpJZzRxZ1ZfVG9rZW46UTA1ZmJQZ2l5b1Zhem94N1pubWNjaUpGblB4XzE3NjQ0OTM2ODE6MTc2NDQ5NzI4MV9WNA" alt="" loading="lazy"/></p>
<p>全流程代码如下：</p>
<pre><code class="hljs language-Plain" lang="Plain">import torch
from horizon_plugin_pytorch import set_march, March
set_march(March.NASH_M)
from horizon_plugin_pytorch.quantization import prepare, set_fake_quantize, FakeQuantState
from horizon_plugin_pytorch.quantization import QuantStub
from horizon_plugin_pytorch.quantization.hbdk4 import export
from horizon_plugin_pytorch.quantization.qconfig_template import (
    calibration_8bit_weight_16bit_act_qconfig_setter,
    qat_8bit_weight_16bit_fixed_act_qconfig_setter, 
    default_calibration_qconfig_setter,
    ModuleNameQconfigSetter
) 

from horizon_plugin_pytorch.quantization.qconfig import get_qconfig, MSEObserver, MinMaxObserver
from horizon_plugin_pytorch.dtype import qint8, qint16
from torch.quantization import DeQuantStub
import torch.nn as nn
from horizon_plugin_pytorch.quantization import hbdk4 as hb4
from hbdk4.compiler import convert, save, hbm_perf, visualize, compile

import torch
import torch.nn as nn

# 定义网络结构
class SmallModel(nn.Module):
    def __init__(self):
        super(SmallModel, self).__init__()
        # 第一个 Linear: 输入 [2, 100, 256] -&gt; 输出 [2, 100, 256]
        self.linear1 = nn.Linear(256, 256)
        self.layernorm = nn.LayerNorm(256)  # 对最后一维进行归一化
        self.relu = nn.ReLU()
        # 第二个 Linear: 输入 [2, 100, 256] -&gt; 输出 [2, 100, 60]
        self.linear2 = nn.Linear(256, 60)
        # 第三个 Linear: 输入 [2, 100, 60] -&gt; 输出 [2, 100, 60]
        self.linear3 = nn.Linear(60, 60)
        self.quant = QuantStub()
        self.dequant = DeQuantStub()

    def forward(self, x):
        x = self.quant(x)
        # 第一个 Linear
        x = self.linear1(x)  # [2, 100, 256]
        x = self.layernorm(x)  # [2, 100, 256]
        x = self.relu(x)  # [2, 100, 256]
        # 第二个 Linear
        y = self.linear2(x)  # [2, 100, 60]
        # 第三个 Linear
        z = self.linear3(y)
        z = self.dequant(z)
        return z

# 设置随机种子，保证每次生成的数据相同
torch.manual_seed(42)
example_input = torch.randn(2, 100, 256)
model = SmallModel()

# 前向传播
output_x = model(example_input)
print("输入形状:", example_input.shape)
print("输出形状:", output_x.shape)

# A global march indicating the target hardware version must be setted before prepare qat.
set_march(March.NASH_M)

calib_model = prepare(model.eval(), example_input, 
                      qconfig_setter=(
                          default_calibration_qconfig_setter,
                          ),
                      )

calib_model.eval()
set_fake_quantize(calib_model, FakeQuantState.CALIBRATION)
calib_model(example_input)

calib_model.eval()                            
set_fake_quantize(calib_model, FakeQuantState.VALIDATION)
calib_out_x = calib_model(example_input)
print("calib输出shape:", calib_out_x.shape)

qat_bc = export(calib_model, example_input)
# save(qat_bc, "qat.bc")
# visualize(qat_bc, "qat.onnx")
hb_quantized_model = convert(qat_bc, March.NASH_M)
# save(hb_quantized_model,"quantized.bc")
visualize(hb_quantized_model, "quantized_single.onnx")
</code></pre>
<p>查看 quantized.onnx，可以看到最后一个 conv 确实是 int32 高精度输出</p>
<p><img src="https://mcnsakkce4vm.feishu.cn/space/api/box/stream/download/asynccode/?code=ZmM4N2NhYmJkMzJhODEyNDM1OWZmMTE4OGVhMjI4ZDRfS2hWdjJvTkN6VlhGbEVXU1FEODd3Wm9qNHVnT3ZvMmhfVG9rZW46WDFOTWJ1OHFub2picjd4eFBwaWNISFY2bkkyXzE3NjQ0OTM2ODE6MTc2NDQ5NzI4MV9WNA" alt="" loading="lazy"/></p>
<h2 data-id="heading-1">2. 输出又输入</h2>
<p>如果 conv1，既作为模型输出，又作为后续 conv2 的输入，此时应该怎么办？</p>
<p><img src="https://mcnsakkce4vm.feishu.cn/space/api/box/stream/download/asynccode/?code=YjY4YjFhMWRlOTFhM2EzMTlhZWU5NzdmOTk1YTkzMjZfazhEZGM4RUM5UVVFa3VmckpVcnVJczNjTGNwaEhTMFBfVG9rZW46QXpUcmI0ek45b1dRb3h4UUFQNmNJczJrbjRjXzE3NjQ0OTM2ODE6MTc2NDQ5NzI4MV9WNA" alt="" loading="lazy"/></p>
<p>关键代码如下：</p>
<pre><code class="hljs language-Plain" lang="Plain">def forward(self, x):
        x = self.quant(x)
        # 第一个 Linear
        x = self.linear1(x)  # [2, 100, 256]
        x = self.layernorm(x)  # [2, 100, 256]
        x = self.relu(x)  # [2, 100, 256]
        # 第二个 Linear
        y = self.linear2(x)  # [2, 100, 60]
        y_out = self.dequant(y)
        y = self.quant_out(y_out)
        # y = self.quant_out(y)

        # 第三个 Linear
        z = self.linear3(y)
        z = self.dequant(z)
        return x, y_out
</code></pre>
<p>注意，y_out = self.dequant（y）是必须要添加的，否则无法实现该效果。</p>
<p>全流程代码如下：</p>
<pre><code class="hljs language-Plain" lang="Plain">import torch
from horizon_plugin_pytorch import set_march, March
set_march(March.NASH_M)
from horizon_plugin_pytorch.quantization import prepare, set_fake_quantize, FakeQuantState
from horizon_plugin_pytorch.quantization import QuantStub
from horizon_plugin_pytorch.quantization.hbdk4 import export
from horizon_plugin_pytorch.quantization.qconfig_template import (
    calibration_8bit_weight_16bit_act_qconfig_setter,
    qat_8bit_weight_16bit_fixed_act_qconfig_setter, 
    default_calibration_qconfig_setter,
    ModuleNameQconfigSetter
) 

from horizon_plugin_pytorch.quantization.qconfig import get_qconfig, MSEObserver, MinMaxObserver
from horizon_plugin_pytorch.dtype import qint8, qint16
from torch.quantization import DeQuantStub
import torch.nn as nn
from horizon_plugin_pytorch.quantization import hbdk4 as hb4
from hbdk4.compiler import convert, save, hbm_perf, visualize, compile

import torch
import torch.nn as nn

# 定义网络结构
class SmallModel(nn.Module):
    def __init__(self):
        super(SmallModel, self).__init__()
        # 第一个 Linear: 输入 [2, 100, 256] -&gt; 输出 [2, 100, 256]
        self.linear1 = nn.Linear(256, 256)
        self.layernorm = nn.LayerNorm(256)  # 对最后一维进行归一化
        self.relu = nn.ReLU()
        # 第二个 Linear: 输入 [2, 100, 256] -&gt; 输出 [2, 100, 60]
        self.linear2 = nn.Linear(256, 60)
        # 第三个 Linear: 输入 [2, 100, 60] -&gt; 输出 [2, 100, 60]
        self.linear3 = nn.Linear(60, 60)
        self.quant = QuantStub()
        self.quant_out = QuantStub()
        self.dequant = DeQuantStub()

    def forward(self, x):
        x = self.quant(x)
        # 第一个 Linear
        x = self.linear1(x)  # [2, 100, 256]
        x = self.layernorm(x)  # [2, 100, 256]
        x = self.relu(x)  # [2, 100, 256]
        # 第二个 Linear
        y = self.linear2(x)  # [2, 100, 60]
        y_out = self.dequant(y)
        y = self.quant_out(y_out)

        # 第三个 Linear
        z = self.linear3(y)
        z = self.dequant(z)
        return z, y_out

# 设置随机种子，保证每次生成的数据相同
torch.manual_seed(42)
example_input = torch.randn(2, 100, 256)
model = SmallModel()

# 前向传播
output_x, output_y = model(example_input)
print("输入形状:", example_input.shape)
print("输出形状:", output_x.shape, output_y.shape)

# A global march indicating the target hardware version must be setted before prepare qat.
set_march(March.NASH_M)

calib_model = prepare(model.eval(), example_input, 
                      qconfig_setter=(
                          default_calibration_qconfig_setter,
                          ),
                      )

calib_model.eval()
set_fake_quantize(calib_model, FakeQuantState.CALIBRATION)
calib_model(example_input)

calib_model.eval()                            
set_fake_quantize(calib_model, FakeQuantState.VALIDATION)
calib_out_x, calib_out_y= calib_model(example_input)
print("calib输出shape:", calib_out_x.shape)

qat_bc = export(calib_model, example_input)
# save(qat_bc, "qat.bc")
# visualize(qat_bc, "qat.onnx")
hb_quantized_model = convert(qat_bc, March.NASH_M)
# save(hb_quantized_model,"quantized.bc")
visualize(hb_quantized_model, "quantized.onnx")
</code></pre>
<p>查看 quantized.onnx，linear2 符合预期，确实是 int32 高精度输出。</p>
<p><img src="https://mcnsakkce4vm.feishu.cn/space/api/box/stream/download/asynccode/?code=OTBlYTRjMDY3ZmE0NDM2MjU4OGQ4ODkyNzIzNjM2Y2NfUTdVaThLYk9abXp4ZWFlakxYcmZPMXUzQ1JDNE5UdzZfVG9rZW46WEdYa2J0S3pib0dsaW54N2JFcmNHWXVsbnlkXzE3NjQ0OTM2ODE6MTc2NDQ5NzI4MV9WNA" alt="" loading="lazy"/></p>
<p>新加入的 dequant 与 quant 会变成 rescale</p>
<p><img src="https://mcnsakkce4vm.feishu.cn/space/api/box/stream/download/asynccode/?code=YTQ3YmJiMDVkMjhjNDBkNTc4OTdkOTk4M2VmNjE4YWNfRHZDd3BnTUVUTUpJMGxYY2xqSFV6aEVWbGVFTEhHRm1fVG9rZW46QVd6RGJKNmZxb3NRb0d4TVdlMWNZTVVUbk1mXzE3NjQ0OTM2ODE6MTc2NDQ5NzI4MV9WNA" alt="" loading="lazy"/></p>
<p>以上是征程 6EM 的默认做法，如果使用的是征程 6PH，conv like 算子输出直接就是 float32，在既作为输出，又作为下一阶段输入时，会存在 vpu 的 quantize（float32-&gt;int16/int8），如下图所示</p>
<p><img src="https://mcnsakkce4vm.feishu.cn/space/api/box/stream/download/asynccode/?code=ODlmMjc1NWY5ZWQzMDJlY2M4ODk0ZjRkNWU2ODYyY2NfTk5GR25iSGdxamV5bDBZZWRIdDR0RHNCOU5JUzV3TWxfVG9rZW46WkFiRGJjYVk3bzBCM2V4cGljSWN0NUV6bmVmXzE3NjQ0OTM2ODE6MTc2NDQ5NzI4MV9WNA" alt="" loading="lazy"/></p>
<p>如果想依旧沿用征程 6EM 的方式，可进行如下配置：</p>
<pre><code class="hljs language-Plain" lang="Plain">qat_bc._integer_conv = True
hb_quantized_model = convert(qat_bc, "nash-h")
</code></pre>
<p>具体选择哪种方式可实测 latency（建议考虑将模型 conv like 算子 c++ 反量化的耗时减少也加进去对比）</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android实战：构建高可维护的日志系统]]></title>    <link>https://juejin.cn/post/7577647745109983232</link>    <guid>https://juejin.cn/post/7577647745109983232</guid>    <pubDate>2025-11-29T08:57:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577647745109983232" data-draft-id="7577599015425933347" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android实战：构建高可维护的日志系统"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2025-11-29T08:57:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="雨白"/> <meta itemprop="url" content="https://juejin.cn/user/2549135752044601"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android实战：构建高可维护的日志系统
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2549135752044601/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    雨白
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-29T08:57:47.000Z" title="Sat Nov 29 2025 08:57:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    11
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><p>一个优秀的日志系统必须满足以下三点：</p>
<ol>
<li><strong>零侵入性和零开销</strong>：开发时，可以随便打日志；发布时，日志能够自动消失，不影响运行时的性能。</li>
<li><strong>高定位能力</strong>：我们通过日志可以快速找出所在的类和线程。</li>
<li><strong>强关联上下文</strong>：能将异常堆栈和<strong>业务数据</strong>完美结合起来。</li>
</ol>
<p>我们将基于 <strong>Timber</strong> 库构建这套系统。</p>
<h2 data-id="heading-0">基础设施搭建</h2>
<h3 data-id="heading-1">开启 BuildConfig</h3>
<p>从 AGP 8.0+ 开始，许多旧的默认配置被关闭了，我们需要手动开启。</p>
<p>例如，<code>BuildConfig</code> 类默认不生成。但我们需要它来判断当前是否为 DEBUG 模式，从而控制是否启用日志开关。</p>
<p>只需在模块级别的 <code>build.gradle.kts</code> 中开启即可：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">android {
    buildFeatures {
        <span class="hljs-comment">// 开启 buildConfig 支持</span>
        buildConfig = <span class="hljs-literal">true</span>
    }
}
</code></pre>
<h3 data-id="heading-2">引入 Timber 依赖</h3>
<p><code>Timber</code> 是一个日志门面，我们只管调用它提供的接口，无需关心具体实现。我们可以种植不同的树，每棵树就是日志的具体处理逻辑。<code>Timber</code> 会遍历所有种下的树，来将日志分发给每一棵树。</p>
<pre><code class="hljs language-kotlin" lang="kotlin">dependencies {
    implementation(<span class="hljs-string">"com.jakewharton.timber:timber:5.0.1"</span>)
}
</code></pre>
<h2 data-id="heading-3">初始化与分层策略</h2>
<h3 data-id="heading-4">Application 初始化</h3>
<p>我们在应用启动时，根据是否为 DEBUG 环境，使用不同的日志实现。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyApplication</span> : <span class="hljs-type">Application</span>() {

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreate</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">super</span>.onCreate()
        initLogger()
    }

    <span class="hljs-comment">/**
     * 初始化 Logger
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">initLogger</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">if</span> (BuildConfig.DEBUG) {
            <span class="hljs-comment">// 如果是开发环境，显示所有日志</span>
            Timber.plant(<span class="hljs-keyword">object</span> : Timber.DebugTree() {
                <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">createStackElementTag</span><span class="hljs-params">(element: <span class="hljs-type">StackTraceElement</span>)</span></span>: String? {
                    <span class="hljs-keyword">return</span> <span class="hljs-string">"DevLog-<span class="hljs-subst">${super.createStackElementTag(element)}</span>"</span>
                }
            })
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// 如果是生产环境，只上报警告和错误</span>
            Timber.plant(CrashReportingTree())
        }
    }
}
</code></pre>
<blockquote>
<p>别忘了在 <code>AndroidManifest.xml</code> 文件中注册此 <code>Application</code>。</p>
</blockquote>
<p>我们在标签前加上了 “DevLog-”，这样在 Logcat 中过滤日志时，能够通过 <code>tag:DevLog</code> 快速过滤。</p>
<h3 data-id="heading-5">自定义 Release 树</h3>
<p>我们来定义刚刚的 <code>CrashReportingTree</code> 树。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">/**
 * 生产环境日志树
 */</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">CrashReportingTree</span> : <span class="hljs-type">Timber.Tree</span>() {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">log</span><span class="hljs-params">(priority: <span class="hljs-type">Int</span>, tag: <span class="hljs-type">String</span>?, message: <span class="hljs-type">String</span>, t: <span class="hljs-type">Throwable</span>?)</span></span> {
        <span class="hljs-comment">// 过滤 Verbose 和 Debug 日志</span>
        <span class="hljs-keyword">if</span> (priority == Log.VERBOSE || priority == Log.DEBUG) {
            <span class="hljs-keyword">return</span>
        }

        <span class="hljs-comment">// 记录面包屑 (Breadcrumbs)</span>
        <span class="hljs-comment">// 将 INFO 和 WARN 级别的日志存入 Crashlytics 内存缓冲</span>
        <span class="hljs-comment">// 当后续发生崩溃时，这些日志会作为崩溃线索一起上报。</span>
        <span class="hljs-keyword">val</span> logMessage = <span class="hljs-string">"[<span class="hljs-variable">$tag</span>] <span class="hljs-variable">$message</span>"</span>
        FirebaseCrashlytics.getInstance().log(logMessage)

        <span class="hljs-comment">// 触发上报机制</span>
        <span class="hljs-keyword">if</span> (t != <span class="hljs-literal">null</span>) {
            <span class="hljs-comment">// 有明确的异常堆栈 -&gt; 上报</span>
            FirebaseCrashlytics.getInstance().recordException(t)
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (priority == Log.ERROR) {
            <span class="hljs-comment">// 没有异常堆栈，但业务判定为 Error -&gt; 构造异常强制上报</span>
            FirebaseCrashlytics.getInstance().recordException(Throwable(message))
        }
    }
}
</code></pre>
<h2 data-id="heading-6">惰性求值</h2>
<h3 data-id="heading-7">性能隐患</h3>
<pre><code class="hljs language-kotlin" lang="kotlin">Timber.d(<span class="hljs-string">"User Data: <span class="hljs-subst">${gson.toJson(hugeObject)}</span>"</span>)
Timber.d(<span class="hljs-string">"User Data: %s"</span>, gson.toJson(hugeObject))
</code></pre>
<p>这两行代码即使是在 Release 模式下，<code>gson.toJson(hugeObject)</code> 也会得到执行。这是因为 Kotlin/Java 的及早求值导致的，参数会在函数调用前计算完成。</p>
<h3 data-id="heading-8">解决方法：LogExt.kt</h3>
<p>我们需要解决两个核心性能隐患：</p>
<ol>
<li>字符串拼接的开销：避免在日志关闭时执行耗时操作。</li>
<li>反射开销：Timber 默认会通过反射获取类名作为 Tag。</li>
</ol>
<p>我们可以使用 Kotlin 的 <code>inline</code> 高阶函数和可选的 Tag 参数，来解决这两个问题。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// LogExt.kt</span>

<span class="hljs-comment">/**
 * 日志扩展：惰性求值 (Lazy Evaluation) + 显式 Tag 支持
 * - inline: 消除 Lambda 对象创建开销
 * - crossinline: 防止非局部返回
 */</span>
<span class="hljs-keyword">inline</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">logD</span><span class="hljs-params">(tag: <span class="hljs-type">String</span>? = <span class="hljs-literal">null</span>, t: <span class="hljs-type">Throwable</span>? = <span class="hljs-literal">null</span>, <span class="hljs-keyword">crossinline</span> message: () -&gt; <span class="hljs-type">String</span>)</span></span> {
    <span class="hljs-comment">// 只有 DEBUG 模式下，Lambda 表达式才会执行</span>
    <span class="hljs-keyword">if</span> (BuildConfig.DEBUG) {
        tag?.let {
            <span class="hljs-comment">// 只有在 DEBUG 模式下，并且 tag 不为空时，才覆盖默认 Tag</span>
            Timber.tag(it)
        }
        Timber.d(t, message())
    }
}

<span class="hljs-keyword">inline</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">logI</span><span class="hljs-params">(tag: <span class="hljs-type">String</span>? = <span class="hljs-literal">null</span>, t: <span class="hljs-type">Throwable</span>? = <span class="hljs-literal">null</span>, <span class="hljs-keyword">crossinline</span> message: () -&gt; <span class="hljs-type">String</span>)</span></span> {
    <span class="hljs-keyword">if</span> (BuildConfig.DEBUG) {
        tag?.let {
            Timber.tag(it)
        }
        Timber.i(t, message())
    }
}

<span class="hljs-keyword">inline</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">logV</span><span class="hljs-params">(tag: <span class="hljs-type">String</span>? = <span class="hljs-literal">null</span>, t: <span class="hljs-type">Throwable</span>? = <span class="hljs-literal">null</span>, <span class="hljs-keyword">crossinline</span> message: () -&gt; <span class="hljs-type">String</span>)</span></span> {
    <span class="hljs-keyword">if</span> (BuildConfig.DEBUG) {
        tag?.let {
            Timber.tag(it)
        }
        Timber.v(t, message())
    }
}

<span class="hljs-keyword">inline</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">logW</span><span class="hljs-params">(tag: <span class="hljs-type">String</span>? = <span class="hljs-literal">null</span>, t: <span class="hljs-type">Throwable</span>? = <span class="hljs-literal">null</span>, <span class="hljs-keyword">crossinline</span> message: () -&gt; <span class="hljs-type">String</span>)</span></span> {
    <span class="hljs-comment">// Warn 也透传给 Release Tree 进行上报</span>
    tag?.let {
        Timber.tag(it)
    }
    Timber.w(t, message())
}

<span class="hljs-keyword">inline</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">logE</span><span class="hljs-params">(tag: <span class="hljs-type">String</span>? = <span class="hljs-literal">null</span>, t: <span class="hljs-type">Throwable</span>? = <span class="hljs-literal">null</span>, <span class="hljs-keyword">crossinline</span> message: () -&gt; <span class="hljs-type">String</span>)</span></span> {
    <span class="hljs-comment">// ERROR 必须透传给 Release Tree 进行上报</span>
    tag?.let {
        Timber.tag(it)
    }
    Timber.e(t, message())
}
</code></pre>
<p>使用示例：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 常规用法</span>
logD { <span class="hljs-string">"User profile: <span class="hljs-subst">${gson.toJson(user)}</span>"</span> }

<span class="hljs-comment">// 高性能场景</span>
logV(tag = <span class="hljs-string">"TouchSystem"</span>) { <span class="hljs-string">"x=<span class="hljs-variable">$x</span>, y=<span class="hljs-variable">$y</span>"</span> }

<span class="hljs-comment">// 异常处理</span>
logE(t = exception) { <span class="hljs-string">"Database transaction failed."</span> }
</code></pre>
<h2 data-id="heading-9">日志分级</h2>
<p>我们常常是遇到问题就使用 <code>Log.d</code>，出了异常就调用 <code>printStackTrace</code>。</p>
<p>但这样并不好，清晰的日志层级能够让我们快速从大量的日志打印中查找出有用的信息。</p>
<h3 data-id="heading-10">VERBOSE (啰嗦/原子级)</h3>
<p>定义：噪音。</p>
<p>场景：高频、琐碎的数据流。
比如，在 <code>onTouchEvent</code> 中跟踪每一次手指坐标的变化。又比如在算法循环中，在循环内部打印每一次迭代的变量。</p>
<p>生命周期：很短。通常在功能完成后、提交代码前就会删除。</p>
<p>错误示范：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 在 Release 包中打印，可能会导致 Logcat 缓冲区溢出</span>
Timber.v(<span class="hljs-string">"Touch: x=<span class="hljs-variable">$x</span>, y=<span class="hljs-variable">$y</span>"</span>) 
</code></pre>
<p>正确示范：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 线上会被剥离，零开销</span>
logV { <span class="hljs-string">"Touch: x=<span class="hljs-variable">$x</span>, y=<span class="hljs-variable">$y</span>"</span> }
</code></pre>
<h3 data-id="heading-11">DEBUG (调试/痕迹)</h3>
<p>定义：过程细节。</p>
<p>场景：用于验证逻辑是否符合预期，用于流程控制、参数确认。比如流程的进入和退出，变量的检查。</p>
<p>错误示范：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">Timber.d(<span class="hljs-string">"Check 1"</span>) <span class="hljs-comment">// 无意义</span>
Timber.d(<span class="hljs-string">"User: <span class="hljs-subst">${user.toJson()}</span>"</span>) <span class="hljs-comment">// 性能较低</span>
</code></pre>
<p>正确示范：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">logD { <span class="hljs-string">"Login success, token saved. uid=<span class="hljs-subst">${user.id}</span>"</span> } 
</code></pre>
<h3 data-id="heading-12">INFO (信息/里程碑)</h3>
<p>定义：业务流转。</p>
<p>场景：业务的关键节点。</p>
<p>比如，生命周期的变化、业务的开始和结束（如支付成功）、关键的配置信息。</p>
<p>错误示范：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">logI { <span class="hljs-string">"View clicked"</span> } 
</code></pre>
<p>正确示范：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">logI { <span class="hljs-string">"Payment finished. orderId=<span class="hljs-variable">$orderId</span>, duration=<span class="hljs-variable">$time</span> ms"</span> }
</code></pre>
<h3 data-id="heading-13">WARN (警告/亚健康)</h3>
<p>定义：亚健康状态。</p>
<p>场景：预期内的错误，通过兜底逻辑（Fallback），使得应用正常运行。</p>
<p>比如，加载图片失败显示默认占位图，解析配置文件失败使用了默认配置。</p>
<p>错误示范：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">try</span> { ... } <span class="hljs-keyword">catch</span> (e: Exception) {
   <span class="hljs-comment">// 吞掉异常，无法排查根本原因</span>
   logW { <span class="hljs-string">"Image load failed"</span> } 
}
</code></pre>
<p>正确示范：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 带上异常堆栈，且说明了使用了兜底方案</span>
logW(e) { <span class="hljs-string">"Image load failed, using placeholder."</span> }
</code></pre>
<h3 data-id="heading-14">ERROR (错误/事故现场)</h3>
<p>定义：事故现场</p>
<p>场景：崩溃，或是不可修复的数据损坏。</p>
<p>比如，所有不打算抛出的 <code>catch</code> 块中，不可到达的 <code>else</code> 分支，丢失关键数据时。</p>
<p>错误示范：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 只有信息没有堆栈</span>
logE { <span class="hljs-string">"JSON parse error: <span class="hljs-subst">${e.message}</span>"</span> } 
</code></pre>
<p>正确示范：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 堆栈 + 业务数据</span>
logE(e) { <span class="hljs-string">"JSON parse error. rawData=<span class="hljs-variable">$jsonString</span>"</span> }
</code></pre>
<blockquote>
<p>异常处理：永远不要吞掉异常堆栈，这会导致不知道出错的原因。同时，必须要关联业务上下文。</p>
</blockquote>
<h3 data-id="heading-15">实战：一个典型的业务流程</h3>
<p>最好的日志使用策略是“三明治法”：使用 INFO 记录开始与结束，使用 DEBUG 记录过程细节，使用 WARN 记录局部的失败。</p>
<p>以“导入书籍”为例：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">importBooks</span><span class="hljs-params">(bookList: <span class="hljs-type">List</span>&lt;<span class="hljs-type">Book</span>&gt;)</span></span> {
    <span class="hljs-comment">// 业务开始 -&gt; INFO</span>
    <span class="hljs-comment">// 确认动作已触发，记录宏观数据量</span>
    logI { <span class="hljs-string">"Start importing books. totalCount=<span class="hljs-subst">${bookList.size}</span>"</span> }

    <span class="hljs-keyword">var</span> successCount = <span class="hljs-number">0</span>

    bookList.forEach { book -&gt;
        <span class="hljs-comment">// 循环细节 -&gt; DEBUG</span>
        <span class="hljs-comment">// 开发时追踪进度，线上自动屏蔽</span>
        logD { <span class="hljs-string">"Processing book: id=<span class="hljs-subst">${book.id}</span>, title=<span class="hljs-subst">${book.title}</span>"</span> }

        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 执行具体的导入逻辑...</span>
            saveToDatabase(book)
            successCount++
        } <span class="hljs-keyword">catch</span> (e: Exception) {
            <span class="hljs-comment">// 局部失败 -&gt; WARN</span>
            <span class="hljs-comment">// 单本书失败不影响整体流程，但需要记录原因以便排查</span>
            logW(e) { <span class="hljs-string">"Failed to import book: <span class="hljs-subst">${book.title}</span>"</span> }
        }
    }

    <span class="hljs-comment">// 业务闭环 -&gt; INFO</span>
    <span class="hljs-comment">// 确认任务结束，统计最终结果</span>
    logI { <span class="hljs-string">"Import finished. success=<span class="hljs-variable">$successCount</span>, failed=<span class="hljs-subst">${bookList.size - successCount}</span>"</span> }
}
</code></pre>
<p>这样记录日志，我们能够清晰地看到每本书的处理过程，并且能一眼看出导入的运行状态（导入是否开始，导入成功和失败的个数）。</p>
<h2 data-id="heading-16">隐私合规</h2>
<p>Google Play 对隐私保护很严格，我们不能打印用户密码、身份证号等信息。</p>
<p>这时，我们可以进行脱敏：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// LogExt.kt</span>

<span class="hljs-comment">/**
 * 隐私脱敏处理
 */</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> String?.<span class="hljs-title">mask</span><span class="hljs-params">(prefixLen: <span class="hljs-type">Int</span> = <span class="hljs-number">3</span>, suffixLen: <span class="hljs-type">Int</span> = <span class="hljs-number">4</span>)</span></span>: String {
    <span class="hljs-comment">// 空字符串</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.isNullOrBlank()) {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"***"</span>
    }

    <span class="hljs-comment">// 长度不足时，全码掩盖</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.length &lt;= prefixLen + suffixLen) {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"*"</span>.repeat(<span class="hljs-keyword">this</span>.length)
    }

    <span class="hljs-comment">// 保留前 prefix 位和后 suffix 位</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.substring(<span class="hljs-number">0</span>, prefixLen) +
            <span class="hljs-string">"*"</span>.repeat(<span class="hljs-keyword">this</span>.length - prefixLen - suffixLen) +
            <span class="hljs-keyword">this</span>.substring(<span class="hljs-keyword">this</span>.length - suffixLen)
}
</code></pre>
<p>使用示例：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> phoneNumber = <span class="hljs-string">"12345678910"</span>
logD { <span class="hljs-string">"SMS sent to <span class="hljs-subst">${phoneNumber.mask()}</span>"</span> } <span class="hljs-comment">// SMS sent to 123****8910</span>
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[餐饮供应链的数仓设计思考 （五） 系统稳定性与SLA保障体系]]></title>    <link>https://juejin.cn/post/7577969462860480575</link>    <guid>https://juejin.cn/post/7577969462860480575</guid>    <pubDate>2025-11-30T09:27:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577969462860480575" data-draft-id="7577958825342255123" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="餐饮供应链的数仓设计思考 （五） 系统稳定性与SLA保障体系"/> <meta itemprop="keywords" content="数据分析"/> <meta itemprop="datePublished" content="2025-11-30T09:27:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="语落心生"/> <meta itemprop="url" content="https://juejin.cn/user/2875978147955741"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            餐饮供应链的数仓设计思考 （五） 系统稳定性与SLA保障体系
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2875978147955741/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    语落心生
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T09:27:47.000Z" title="Sun Nov 30 2025 09:27:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读20分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">目录</h2>
<ol>
<li><a href="#sla%E5%AE%9A%E4%B9%89%E4%B8%8E%E6%89%BF%E8%AF%BA" title="#sla%E5%AE%9A%E4%B9%89%E4%B8%8E%E6%89%BF%E8%AF%BA">SLA定义与承诺</a></li>
<li><a href="#%E7%9B%91%E6%8E%A7%E4%B8%8E%E5%91%8A%E8%AD%A6%E4%BD%93%E7%B3%BB" title="#%E7%9B%91%E6%8E%A7%E4%B8%8E%E5%91%8A%E8%AD%A6%E4%BD%93%E7%B3%BB">监控与告警体系</a></li>
<li><a href="#%E5%BA%94%E6%80%A5%E5%93%8D%E5%BA%94%E6%B5%81%E7%A8%8B" title="#%E5%BA%94%E6%80%A5%E5%93%8D%E5%BA%94%E6%B5%81%E7%A8%8B">应急响应流程</a></li>
<li><a href="#%E6%95%85%E9%9A%9C%E6%81%A2%E5%A4%8D%E4%B8%8E%E5%AE%B9%E7%81%BE" title="#%E6%95%85%E9%9A%9C%E6%81%A2%E5%A4%8D%E4%B8%8E%E5%AE%B9%E7%81%BE">故障恢复与容灾</a></li>
<li><a href="#%E6%8C%81%E7%BB%AD%E6%94%B9%E8%BF%9B%E6%9C%BA%E5%88%B6" title="#%E6%8C%81%E7%BB%AD%E6%94%B9%E8%BF%9B%E6%9C%BA%E5%88%B6">持续改进机制</a></li>
</ol>
<hr/>
<h2 data-id="heading-1">核心价值</h2>
<h3 data-id="heading-2">目标</h3>
<p>通过完整的SLA保障体系，确保数据平台的高稳定性和高可靠性，让业务部门放心使用数据进行决策。</p>
<ol>
<li><strong>SLA承诺</strong> - 明确的可用性、延迟、恢复目标</li>
<li><strong>监控体系</strong> - 三层监控指标 (业务/系统/资源)</li>
<li><strong>告警规则</strong> - 具体的告警规则与响应标准</li>
<li><strong>应急流程</strong> - P0级别的完整应急响应流程</li>
<li><strong>故障恢复</strong> - RTO/RPO设计与多层容灾方案</li>
<li><strong>持续改进</strong> - 事后总结与SLA评分卡</li>
</ol>
<h3 data-id="heading-3">关键指标:</h3>
<ul>
<li>系统可用性: ≥99.5% (月故障&lt;3小时)</li>
<li>数据延迟: &lt;5分钟</li>
<li>P0故障RTO: &lt;2小时</li>
<li>P1故障RTO: &lt;1小时</li>
<li>故障恢复点: &lt;1小时数据丢失</li>
</ul>
<h2 data-id="heading-4">SLA定义与承诺</h2>
<h3 data-id="heading-5">1.1 核心系统的SLA承诺</h3>
<pre><code class="hljs language-scss" lang="scss">┌────────────────────────────────────────────────────────────┐
│           核心系统 SLA 承诺表                              │
├────────────────────────────────────────────────────────────┤
│                                                             │
│ 系统              可用性    数据延迟    故障恢复  优先级  │
│                  (Available)  (Latency)  (RTO)           │
│─────────────────────────────────────────────────────────  │
│ Doris集群        <span class="hljs-number">99.5%</span>      &lt;<span class="hljs-number">5</span>分钟     &lt;<span class="hljs-number">2</span>小时    P0      │
│ (数据仓库)       ≥<span class="hljs-number">2.88</span>h/月  (<span class="hljs-number">99%</span>时间)  (RTO)            │
│                   故障允许    (P95&lt;<span class="hljs-number">3</span>m)                    │
│                              (P99&lt;<span class="hljs-number">10</span>m)                    │
│                                                             │
│ Flink ETL        <span class="hljs-number">99.0%</span>      &lt;<span class="hljs-number">5</span>分钟     &lt;<span class="hljs-number">1</span>小时    P0      │
│ (流式处理)       ≥<span class="hljs-number">4.32</span>h/月  实时告警   (自动恢复)       │
│                  故障                                      │
│                                                             │
│ Kafka消息队列    <span class="hljs-number">99.5%</span>      <span class="hljs-number">0</span>延迟      &lt;<span class="hljs-number">30</span>分钟   P0      │
│                  ≥<span class="hljs-number">2.88</span>h/月  (消息持久化)                │
│                  故障                                      │
│                                                             │
│ POS API接口      <span class="hljs-number">99.0%</span>      &lt;<span class="hljs-number">30</span>秒      &lt;<span class="hljs-number">1</span>小时    P0      │
│ (业务系统)       ≥<span class="hljs-number">4.32</span>h/月  (超时告警)  (与POS方协调)   │
│                  故障                                      │
│                                                             │
│ MySQL元数据库    <span class="hljs-number">99.5%</span>      &lt;<span class="hljs-number">1</span>秒       &lt;<span class="hljs-number">30</span>分钟   P1      │
│ (配置库)         ≥<span class="hljs-number">2.88</span>h/月  (本地缓存)  (主从切换)      │
│                  故障                                      │
│                                                             │
│ Prometheus监控   <span class="hljs-number">99.0%</span>      &lt;<span class="hljs-number">1</span>分钟     &lt;<span class="hljs-number">1</span>小时    P1      │
│ (告警系统)       ≥<span class="hljs-number">4.32</span>h/月  (数据保留)  (历史恢复)      │
│                  故障                                      │
│                                                             │
│ Grafana看板      <span class="hljs-number">99.0%</span>      &lt;<span class="hljs-number">5</span>秒       &lt;<span class="hljs-number">1</span>小时    P2      │
│ (可视化)         ≥<span class="hljs-number">4.32</span>h/月  (缓存)      (UI切换)        │
│                  故障                                      │
│                                                             │
└────────────────────────────────────────────────────────────┘

注解:

可用性计算:
├─ <span class="hljs-number">99.5%</span> = 月可用时间 <span class="hljs-number">720</span>小时 × <span class="hljs-number">0.995</span> = <span class="hljs-number">716.4</span>小时
├─ 故障允许时间 = <span class="hljs-number">720</span> - <span class="hljs-number">716.4</span> = <span class="hljs-number">3.6</span>小时 ≈ <span class="hljs-number">2.88</span>小时
└─ 即: 每月允许故障不超过<span class="hljs-number">2</span>小时<span class="hljs-number">58</span>分钟

优先级定义:
├─ P0: 极严重，影响多个门店或财务数据，需立即处理
├─ P1: 严重，影响单个门店或部分功能，<span class="hljs-number">1</span>小时内处理
├─ P2: 中等，影响用户体验但不影响业务，<span class="hljs-number">4</span>小时内处理
└─ P3: 轻微，不影响主业务，无紧急处理要求
</code></pre>
<h3 data-id="heading-6">1.2 服务等级界定</h3>
<pre><code class="hljs language-makefile" lang="makefile">P0 - 紧急事件 (Severity: Critical)

<span class="hljs-section">定义:</span>
├─ Doris无法查询 (整个集群宕机)
├─ POS数据无法采集 (24小时+)
├─ 财务数据错误 (与财务对不上)
├─ 用户数据泄露 (严重安全事件)
└─ 数据一致性破坏 (不可修复)

<span class="hljs-section">响应时间:</span>
├─ 感知时间: 0秒 (自动告警)
├─ 响应时间: 5分钟内 (CDO、Tech Lead到场)
└─ 初步诊断: 15分钟内

<span class="hljs-section">恢复目标:</span>
├─ RTO (Recovery Time Objective): &lt;2小时
├─ RPO (Recovery Point Objective): &lt;1小时
└─ 通知范围: CEO/CFO/CTO + 全体研发 + 业务方

─────────────────────────────────────────────────

P1 - 高优先级 (Severity: High)

<span class="hljs-section">定义:</span>
├─ 单个查询性能下降 (&gt;30秒)
├─ 数据延迟超过5分钟
├─ 部分BI报表不可用
├─ Flink任务故障 (1小时内修复)
└─ 告警不能正常推送

<span class="hljs-section">响应时间:</span>
├─ 感知时间: 5分钟内 (自动告警)
├─ 响应时间: 30分钟内 (主要责任人+支持)
└─ 初步诊断: 1小时内

<span class="hljs-section">恢复目标:</span>
├─ RTO: &lt;1小时
├─ RPO: &lt;30分钟
└─ 通知范围: CDO + 技术团队 + 相关业务方

─────────────────────────────────────────────────

P2 - 中等优先级 (Severity: Medium)

<span class="hljs-section">定义:</span>
├─ 某个BI看板响应慢 (但能访问)
├─ 某个报表有小bug (数据基本正确)
├─ 告警延迟1-2小时
├─ 文档更新有误
└─ 用户体验问题 (但不影响功能)

<span class="hljs-section">响应时间:</span>
├─ 响应时间: 4小时内
├─ 优先安排修复
└─ 可在工作时间内处理

<span class="hljs-section">恢复目标:</span>
├─ RTO: &lt;4小时
└─ 通知范围: 相关技术人员 + 提出者

─────────────────────────────────────────────────

P3 - 低优先级 (Severity: Low)

<span class="hljs-section">定义:</span>
├─ UI布局小问题
├─ 文档笔误
├─ 功能优化建议
├─ 性能微小改进
└─ 用户界面美化

<span class="hljs-section">响应时间:</span>
├─ 响应时间: 1周内
├─ 可统一收集后批量处理
└─ 列入下一个迭代计划

<span class="hljs-section">恢复目标:</span>
├─ 无严格时间要求
└─ 通知范围: 产品/技术团队
</code></pre>
<hr/>
<h2 data-id="heading-7">监控与告警体系</h2>
<h3 data-id="heading-8">2.1 监控指标体系</h3>
<pre><code class="hljs language-erlang" lang="erlang">┌────────────────────────────────────────────────────────────┐
│         监控指标的<span class="hljs-string">"三层金字塔"</span>                             │
├────────────────────────────────────────────────────────────┤
│                                                             │
│ 第一层: 业务指标 (Business Metrics)                        │
│ └─ 最终用户关心的 KPI                                      │
│                                                             │
│    ┌─ 数据新鲜度 (Data Freshness)                          │
│    │  ├─ 最后更新时间 (Last Update Time)                   │
│    │  ├─ 数据延迟 (Data Latency)                           │
│    │  │  └─ 告警: &gt;<span class="hljs-number">5</span>分钟 (P1)                              │
│    │  └─ 实时数据覆盖率                                     │
│    │                                                        │
│    ├─ 数据准确性 (Data Accuracy)                           │
│    │  ├─ DQ规则通过率 (<span class="hljs-comment">%)                                  │</span>
│    │  │  └─ 告警: &lt;<span class="hljs-number">95</span><span class="hljs-comment">% (P1)                                │</span>
│    │  ├─ 与源系统对账差异 (<span class="hljs-comment">%)                              │</span>
│    │  │  └─ 告警: &gt;<span class="hljs-number">0.1</span><span class="hljs-comment">% (P1)                               │</span>
│    │  └─ 缺失数据率 (<span class="hljs-comment">%)                                    │</span>
│    │     └─ 告警: &gt;<span class="hljs-number">1</span><span class="hljs-comment">% (P2)                                 │</span>
│    │                                                        │
│    └─ 查询服务可用性 (Query Availability)                  │
│       ├─ 查询成功率 (<span class="hljs-comment">%)                                    │</span>
│       │  └─ 告警: &lt;<span class="hljs-number">99.5</span><span class="hljs-comment">% (P1)                              │</span>
│       └─ 平均响应时间 (ms)                                 │
│          ├─ P95: 告警 &gt;<span class="hljs-number">5000</span>ms (P2)                         │
│          ├─ P99: 告警 &gt;<span class="hljs-number">10000</span>ms (P2)                        │
│          └─ Max: 告警 &gt;<span class="hljs-number">30000</span>ms (P1)                        │
│                                                             │
│ ─────────────────────────────────────────────────────────  │
│                                                             │
│ 第二层: 系统指标 (System Metrics)                          │
│ └─ 系统层面的性能与健康指标                                │
│                                                             │
│    ┌─ Doris集群健康                                        │
│    │  ├─ FE节点状态: Online/Offline                        │
│    │  │  └─ 告警: FE故障 (P0)                              │
│    │  ├─ BE节点状态: Healthy/Unhealthy                     │
│    │  │  └─ 告警: BE数 &lt;副本数 (P0)                        │
│    │  ├─ 副本不健全表数量                                   │
│    │  │  └─ 告警: &gt;<span class="hljs-number">0</span> (P1)                                  │
│    │  └─ 存储容量使用率                                     │
│    │     ├─ 黄色: &gt;<span class="hljs-number">80</span><span class="hljs-comment">%                                     │</span>
│    │     ├─ 红色: &gt;<span class="hljs-number">90</span><span class="hljs-comment">% (P1)                                │</span>
│    │     └─ 预留: 至少<span class="hljs-number">100</span>GB可用空间                        │
│    │                                                        │
│    ├─ Flink任务健康                                        │
│    │  ├─ 任务状态: RUNNING/FAILED                          │
│    │  │  └─ 告警: FAILED (P0)                              │
│    │  ├─ Checkpoint成功率: (<span class="hljs-comment">%)                             │</span>
│    │  │  └─ 告警: &lt;<span class="hljs-number">95</span><span class="hljs-comment">% (P1)                                │</span>
│    │  ├─ 背压指标 (BackPressure)                           │
│    │  │  └─ 告警: &gt;<span class="hljs-number">0.5</span> 持续<span class="hljs-number">1</span>分钟 (P2)                      │
│    │  └─ 处理延迟 (Processing Latency)                     │
│    │     └─ 告警: &gt;<span class="hljs-number">60</span>秒 (P1)                               │
│    │                                                        │
│    └─ Kafka集群健康                                        │
│       ├─ Broker状态: Leader/Follower                       │
│       │  └─ 告警: Broker故障 (P0)                          │
│       ├─ 副本数不足的分区                                   │
│       │  └─ 告警: &gt;<span class="hljs-number">0</span> (P1)                                  │
│       ├─ 消费延迟 (Consumer Lag)                           │
│       │  └─ 告警: &gt;<span class="hljs-number">1000</span>条消息 (P1)                         │
│       └─ 磁盘容量                                           │
│          └─ 告警: &gt;<span class="hljs-number">85</span><span class="hljs-comment">% (P2)                                │</span>
│                                                             │
│ ─────────────────────────────────────────────────────────  │
│                                                             │
│ 第三层: 资源指标 (Resource Metrics)                        │
│ └─ 基础设施层面的资源使用                                  │
│                                                             │
│    ┌─ CPU (处理器)                                         │
│    │  ├─ 使用率 (<span class="hljs-comment">%)                                        │</span>
│    │  │  ├─ 黄色: &gt;<span class="hljs-number">70</span><span class="hljs-comment">%                                     │</span>
│    │  │  └─ 红色: &gt;<span class="hljs-number">90</span><span class="hljs-comment">% (P2)                                │</span>
│    │  └─ 上下文切换次数 (context switches)                 │
│    │     └─ 告警: 异常高 (P2)                              │
│    │                                                        │
│    ├─ 内存 (RAM)                                           │
│    │  ├─ 使用率 (<span class="hljs-comment">%)                                        │</span>
│    │  │  ├─ 黄色: &gt;<span class="hljs-number">80</span><span class="hljs-comment">%                                     │</span>
│    │  │  └─ 红色: &gt;<span class="hljs-number">95</span><span class="hljs-comment">% (P1)                                │</span>
│    │  ├─ GC频率                                            │
│    │  │  └─ 告警: Full GC &gt;<span class="hljs-number">3</span>次/分钟 (P1)                   │
│    │  └─ GC暂停时间                                        │
│    │     └─ 告警: &gt;<span class="hljs-number">2</span>秒 (P1)                                │
│    │                                                        │
│    ├─ 磁盘 (Disk)                                          │
│    │  ├─ 使用率 (<span class="hljs-comment">%)                                        │</span>
│    │  │  ├─ 黄色: &gt;<span class="hljs-number">80</span><span class="hljs-comment">%                                     │</span>
│    │  │  └─ 红色: &gt;<span class="hljs-number">95</span><span class="hljs-comment">% (P1)                                │</span>
│    │  ├─ I/O延迟                                           │
│    │  │  └─ 告警: 读/写 &gt;<span class="hljs-number">50</span>ms (P2)                         │
│    │  └─ 剩余可用空间                                       │
│    │     └─ 告警: &lt;<span class="hljs-number">10</span>GB (P1)                               │
│    │                                                        │
│    └─ 网络 (Network)                                       │
│       ├─ 带宽使用率 (<span class="hljs-comment">%)                                    │</span>
│       │  └─ 告警: &gt;<span class="hljs-number">80</span><span class="hljs-comment">% (P2)                                │</span>
│       ├─ 网络延迟 (Latency)                                │
│       │  └─ 告警: &gt;<span class="hljs-number">50</span>ms (P2)                               │
│       ├─ 数据包丢失率 (<span class="hljs-comment">%)                                  │</span>
│       │  └─ 告警: &gt;<span class="hljs-number">0.1</span><span class="hljs-comment">% (P2)                               │</span>
│       └─ 连接数                                             │
│          └─ 告警: 接近限制 (P2)                            │
│                                                             │
└────────────────────────────────────────────────────────────┘
</code></pre>
<h3 data-id="heading-9">2.2 告警规则示例</h3>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">告警规则1: 数据延迟超标</span>

<span class="hljs-section">告警名: data_latency_exceeded</span>
<span class="hljs-section">严重级: P1</span>
<span class="hljs-section">条件:  (now() - max(last_update_time)) &gt; 300秒</span>
<span class="hljs-section">评估周期: 1分钟</span>
<span class="hljs-section">继续期: 持续5分钟后触发</span>

<span class="hljs-section">通知方式:</span>
├─ 钉钉: @数据团队 <span class="hljs-string">"数据延迟超过5分钟"</span>
├─ 短信: 发给Tech Lead
├─ 邮件: 数据团队和CDO
└─ 工单: 自动生成P1级别工单

────────────────────────────────────────────

<span class="hljs-section">告警规则2: 查询响应时间高</span>

<span class="hljs-section">告警名: query_response_time_high</span>
<span class="hljs-section">严重级: P2</span>
<span class="hljs-section">条件:  histogram_quantile(0.95, query_duration) &gt; 5s</span>
<span class="hljs-section">评估周期: 5分钟</span>
<span class="hljs-section">继续期: 持续10分钟后触发</span>

<span class="hljs-section">通知方式:</span>
├─ 钉钉: @数据团队 <span class="hljs-string">"查询响应缓慢"</span>
├─ 邮件: 数据团队和CDO
└─ 工单: 自动生成P2级别工单

<span class="hljs-section">可能原因:</span>
├─ 大查询并发 → 检查: 当前查询队列数
├─ Doris节点故障 → 检查: BE节点状态
├─ 存储压力 → 检查: 磁盘I/O延迟
└─ 网络问题 → 检查: 网络延迟、带宽

────────────────────────────────────────────

<span class="hljs-section">告警规则3: 数据质量检查失败</span>

<span class="hljs-section">告警名: data_quality_check_failed</span>
<span class="hljs-section">严重级: P1</span>
<span class="hljs-section">条件:  dq_rule_pass_rate &lt; 0.95</span>
<span class="hljs-section">评估周期: 1小时</span>
<span class="hljs-section">继续期: 持续2小时后触发</span>

<span class="hljs-section">通知方式:</span>
├─ 钉钉: @数据质量负责人 <span class="hljs-string">"数据质量告警"</span>
├─ 邮件: 数据团队、业务方
└─ 工单: 自动生成P1级别工单，包含:
   ├─ 失败的DQ规则
   ├─ 失败数据量
   ├─ 失败的表
   └─ 建议的处理方案

────────────────────────────────────────────

<span class="hljs-section">告警规则4: 业务异常</span>

<span class="hljs-section">告警名: sales_anomaly_detected</span>
<span class="hljs-section">严重级: P2</span>
<span class="hljs-section">条件:  (current_sales - 7day_avg) / 7day_avg &gt; 50%</span>
       或 (current_sales - 7day_avg) / 7day_avg &lt; -30%
<span class="hljs-section">评估周期: 1小时</span>

<span class="hljs-section">通知方式:</span>
├─ 钉钉: @运营团队 <span class="hljs-string">"销售异常预警"</span>
├─ 邮件: 运营总监、CDO
└─ 自动分析: 提供可能原因
   ├─ 客流变化?
   ├─ 客单价变化?
   ├─ 新活动影响?
   └─ 系统故障?
</code></pre>
<hr/>
<h2 data-id="heading-10">应急响应流程</h2>
<h3 data-id="heading-11">3.1 P0级别应急响应 (极严重故障)</h3>
<pre><code class="hljs language-r" lang="r">┌────────────────────────────────────────────────────────────┐
│  P0 应急响应流程 <span class="hljs-punctuation">(</span>极严重故障处理<span class="hljs-punctuation">)</span>                          │
│  目标<span class="hljs-operator">:</span> <span class="hljs-number">0</span><span class="hljs-operator">-</span><span class="hljs-number">2</span>小时恢复                                         │
├────────────────────────────────────────────────────────────┤
│                                                             │
│ <span class="hljs-built_in">T</span><span class="hljs-operator">+</span><span class="hljs-number">0</span><span class="hljs-built_in">min</span> ⏰ 触发告警                                          │
│       │                                                    │
│       ├─ 自动触发<span class="hljs-operator">:</span> 告警规则判定                            │
│       ├─ 手动触发<span class="hljs-operator">:</span> 人工发现问题                            │
│       │                                                    │
│       └─ 立即启动<span class="hljs-operator">:</span>                                         │
│          ├─ 钉钉群大消息 <span class="hljs-operator">@</span>所有人 <span class="hljs-operator">+</span> 电话通知               │
│          ├─ 创建应急工单 <span class="hljs-punctuation">(</span>自动<span class="hljs-punctuation">)</span>                            │
│          ├─ 启动应急会议 <span class="hljs-punctuation">(</span>立即开启视频会<span class="hljs-punctuation">)</span>                  │
│          └─ 通知<span class="hljs-operator">:</span> CEO<span class="hljs-operator">/</span>CFO<span class="hljs-operator">/</span>CTO<span class="hljs-operator">/</span>CDO<span class="hljs-operator">/</span>Tech Lead              │
│                                                             │
│ ─────────────────────────────────────────────────────────  │
│                                                             │
│ <span class="hljs-built_in">T</span><span class="hljs-operator">+</span><span class="hljs-number">5</span><span class="hljs-built_in">min</span> ⏱️  故障定位                                        │
│       │                                                    │
│       ├─ 组织<span class="hljs-operator">:</span> 现场指挥 <span class="hljs-punctuation">(</span>CDO<span class="hljs-punctuation">)</span> <span class="hljs-operator">+</span> 技术调查员<span class="hljs-number">3</span><span class="hljs-operator">-</span><span class="hljs-number">4</span>人             │
│       │                                                    │
│       ├─ 快速诊断<span class="hljs-operator">:</span>                                         │
│       │  ├─ 收集基础信息                                   │
│       │  │  ├─ 故障开始时间<span class="hljs-operator">?</span>                              │
│       │  │  ├─ 影响范围<span class="hljs-operator">?</span> <span class="hljs-punctuation">(</span>所有店<span class="hljs-operator">/</span>部分店<span class="hljs-operator">/</span>某个模块<span class="hljs-punctuation">)</span>         │
│       │  │  ├─ 现象是什么<span class="hljs-operator">?</span>                                │
│       │  │  └─ 最近有什么变更<span class="hljs-operator">?</span>                            │
│       │  │                                                 │
│       │  ├─ 收集日志数据                                   │
│       │  │  ├─ Doris<span class="hljs-operator">:</span> 查看FE<span class="hljs-operator">/</span>BE日志                       │
│       │  │  ├─ Flink<span class="hljs-operator">:</span> 查看任务日志                        │
│       │  │  ├─ 应用<span class="hljs-operator">:</span> 查看应用日志                         │
│       │  │  └─ 系统<span class="hljs-operator">:</span> 查看系统日志 <span class="hljs-punctuation">(</span>CPU<span class="hljs-operator">/</span>内存<span class="hljs-operator">/</span>磁盘<span class="hljs-punctuation">)</span>         │
│       │  │                                                 │
│       │  └─ 快速假设与验证                                 │
│       │     ├─ 假设<span class="hljs-number">1</span><span class="hljs-operator">:</span> Doris崩溃<span class="hljs-operator">?</span> → 检查集群状态           │
│       │     ├─ 假设<span class="hljs-number">2</span><span class="hljs-operator">:</span> 网络问题<span class="hljs-operator">?</span> → 检查网络连接            │
│       │     ├─ 假设<span class="hljs-number">3</span><span class="hljs-operator">:</span> 磁盘满<span class="hljs-operator">?</span> → 检查磁盘空间              │
│       │     └─ 假设<span class="hljs-number">4</span><span class="hljs-operator">:</span> 内存溢出<span class="hljs-operator">?</span> → 检查内存使用            │
│       │                                                    │
│       └─ 报告<span class="hljs-operator">:</span> <span class="hljs-built_in">T</span><span class="hljs-operator">+</span><span class="hljs-number">5</span><span class="hljs-built_in">min</span>时给出初步诊断                       │
│          <span class="hljs-string">"故障原因: XXX, 正在采取措施"</span>                     │
│                                                             │
│ ─────────────────────────────────────────────────────────  │
│                                                             │
│ <span class="hljs-built_in">T</span><span class="hljs-operator">+</span><span class="hljs-number">15</span><span class="hljs-built_in">min</span> 🔧 应急修复                                        │
│       │                                                    │
│       ├─ 故障类型<span class="hljs-number">1</span><span class="hljs-operator">:</span> 硬件故障                              │
│       │  ├─ 立即<span class="hljs-operator">:</span> 启动故障转移 <span class="hljs-punctuation">(</span>failover<span class="hljs-punctuation">)</span>                │
│       │  ├─ 监控<span class="hljs-operator">:</span> Doris从<span class="hljs-number">3</span>副本→<span class="hljs-number">1</span>副本降级运行             │
│       │  ├─ 修复<span class="hljs-operator">:</span> 更换故障硬件 <span class="hljs-punctuation">(</span>IT部门<span class="hljs-punctuation">)</span>                   │
│       │  └─ 恢复<span class="hljs-operator">:</span> 副本恢复后恢复正常                       │
│       │                                                    │
│       ├─ 故障类型<span class="hljs-number">2</span><span class="hljs-operator">:</span> 软件故障 <span class="hljs-punctuation">(</span>Doris<span class="hljs-operator">/</span>Flink<span class="hljs-punctuation">)</span>                │
│       │  ├─ 立即<span class="hljs-operator">:</span> 尝试重启故障服务                        │
│       │  ├─ 监控<span class="hljs-operator">:</span> 重启后的健康状态                        │
│       │  ├─ 如果还是故障<span class="hljs-operator">:</span> 回滚上次更新                     │
│       │  └─ 检查<span class="hljs-operator">:</span> 更新中引入的bug                         │
│       │                                                    │
│       ├─ 故障类型<span class="hljs-number">3</span><span class="hljs-operator">:</span> 数据问题                              │
│       │  ├─ 立即<span class="hljs-operator">:</span> 隔离坏数据                              │
│       │  ├─ 恢复<span class="hljs-operator">:</span> 从备份点恢复 <span class="hljs-punctuation">(</span>RTO <span class="hljs-operator">&lt;</span><span class="hljs-number">2</span>小时<span class="hljs-punctuation">)</span>              │
│       │  └─ 验证<span class="hljs-operator">:</span> 恢复后数据一致性                        │
│       │                                                    │
│       └─ 故障类型<span class="hljs-number">4</span><span class="hljs-operator">:</span> 应用问题                              │
│          ├─ 立即<span class="hljs-operator">:</span> 发布hotfix或回滚上次发布                │
│          ├─ 验证<span class="hljs-operator">:</span> 测试修复                                │
│          └─ 上线<span class="hljs-operator">:</span> 灰度上线或直接全量                       │
│                                                             │
│ ─────────────────────────────────────────────────────────  │
│                                                             │
│ <span class="hljs-built_in">T</span><span class="hljs-operator">+</span><span class="hljs-number">30</span><span class="hljs-built_in">min</span> ✅ 恢复验证                                        │
│       │                                                    │
│       ├─ 功能验证<span class="hljs-operator">:</span>                                         │
│       │  ├─ 数据查询<span class="hljs-operator">:</span> 随机选几个查询验证                   │
│       │  ├─ 实时采集<span class="hljs-operator">:</span> 检查数据延迟                        │
│       │  ├─ BI看板<span class="hljs-operator">:</span> 检查报表刷新                          │
│       │  └─ 告警<span class="hljs-operator">:</span> 测试告警通知                            │
│       │                                                    │
│       ├─ 性能验证<span class="hljs-operator">:</span>                                         │
│       │  ├─ 查询性能<span class="hljs-operator">:</span> P95<span class="hljs-operator">&lt;</span><span class="hljs-number">5</span>s                              │
│       │  ├─ 系统负载<span class="hljs-operator">:</span> CPU<span class="hljs-operator">&lt;</span><span class="hljs-number">70</span><span class="hljs-operator">%, 内存&lt;80%</span>                   │
│       │  └─ 网络延迟<span class="hljs-operator">:</span> <span class="hljs-operator">&lt;</span><span class="hljs-number">50</span>ms                               │
│       │                                                    │
│       ├─ 数据验证<span class="hljs-operator">:</span>                                         │
│       │  ├─ 数据完整<span class="hljs-operator">:</span> 对账无差异                          │
│       │  ├─ 数据准确<span class="hljs-operator">:</span> DQ规则全部通过                      │
│       │  └─ 时间性<span class="hljs-operator">:</span> 数据延迟<span class="hljs-operator">&lt;</span><span class="hljs-number">5</span>分钟                        │
│       │                                                    │
│       └─ 报告<span class="hljs-operator">:</span> <span class="hljs-built_in">T</span><span class="hljs-operator">+</span><span class="hljs-number">30</span><span class="hljs-built_in">min</span>给出恢复确认                        │
│          <span class="hljs-string">"系统已恢复正常，各项指标已验证"</span>                 │
│                                                             │
│ ─────────────────────────────────────────────────────────  │
│                                                             │
│ <span class="hljs-built_in">T</span><span class="hljs-operator">+</span><span class="hljs-number">1</span>h 📊 故障总结                                           │
│       │                                                    │
│       ├─ 立即通知<span class="hljs-operator">:</span>                                         │
│       │  ├─ 钉钉<span class="hljs-operator">:</span> 故障已解决，影响时间¥xxx分钟            │
│       │  └─ 邮件<span class="hljs-operator">:</span> 详细事后报告将在<span class="hljs-number">24</span>小时内发送             │
│       │                                                    │
│       ├─ 后续工作<span class="hljs-operator">:</span>                                         │
│       │  ├─ 持续监控<span class="hljs-operator">:</span> 接下来<span class="hljs-number">8</span>小时加密监控                 │
│       │  ├─ 应急日志<span class="hljs-operator">:</span> 记录所有操作和时间点                │
│       │  └─ 初步总结<span class="hljs-operator">:</span> 根本原因是什么<span class="hljs-operator">?</span>                     │
│       │                                                    │
│       └─ 安排<span class="hljs-operator">:</span> <span class="hljs-number">24</span>小时内组织事后总结会 <span class="hljs-punctuation">(</span>postmortem<span class="hljs-punctuation">)</span>       │
│          ├─ 参加人<span class="hljs-operator">:</span> 所有参与者 <span class="hljs-operator">+</span> 相关方                   │
│          ├─ 内容<span class="hljs-operator">:</span> Timeline <span class="hljs-operator">+</span> Root Cause <span class="hljs-operator">+</span> Actions         │
│          └─ 输出<span class="hljs-operator">:</span> 改进计划 <span class="hljs-punctuation">(</span>预防同类故障<span class="hljs-punctuation">)</span>                 │
│                                                             │
│ ─────────────────────────────────────────────────────────  │
│                                                             │
│ <span class="hljs-built_in">T</span><span class="hljs-operator">+</span><span class="hljs-number">24</span>h 📋 详细事后报告                                      │
│                                                             │
│       报告内容<span class="hljs-operator">:</span>                                            │
│       ├─ 故障时间<span class="hljs-operator">:</span> 起始时间 <span class="hljs-operator">&amp;</span> 持续时间                     │
│       ├─ 影响范围<span class="hljs-operator">:</span> 几家店<span class="hljs-operator">?</span> 哪些功能<span class="hljs-operator">?</span>                       │
│       ├─ Root Cause<span class="hljs-operator">:</span> 根本原因分析 <span class="hljs-punctuation">(</span><span class="hljs-number">5</span>个Why<span class="hljs-punctuation">)</span>               │
│       ├─ Timeline<span class="hljs-operator">:</span> 关键时间点 <span class="hljs-operator">&amp;</span> 行动                       │
│       ├─ Actions<span class="hljs-operator">:</span> 短期<span class="hljs-operator">/</span>中期<span class="hljs-operator">/</span>长期改进方案                   │
│       ├─ 责任人<span class="hljs-operator">:</span> 每个action的owner和deadline             │
│       ├─ 学到的经验<span class="hljs-operator">:</span> Lessons Learned                      │
│       └─ 附件<span class="hljs-operator">:</span> 日志、监控图表、诊断数据                    │
│                                                             │
│       分发<span class="hljs-operator">:</span> CEO<span class="hljs-operator">/</span>CFO<span class="hljs-operator">/</span>CTO<span class="hljs-operator">/</span>CDO<span class="hljs-operator">/</span>相关业务方                    │
│       归档<span class="hljs-operator">:</span> Wiki知识库，便于查阅                           │
│                                                             │
└────────────────────────────────────────────────────────────┘
</code></pre>
<h3 data-id="heading-12">3.2 应急响应的角色与职责</h3>
<pre><code class="hljs language-vbnet" lang="vbnet">┌────────────────────────────────────────────────────────────┐
│         应急响应中的关键角色                                │
├────────────────────────────────────────────────────────────┤
│                                                             │
│ 现场指挥 (Incident Commander, IC)                          │
│ └─ 由CDO担任 (或CDO授权的Tech Lead)                        │
│    ├─ 职责:                                                │
│    │  ├─ 宣布应急状态开始/结束                             │
│    │  ├─ 组织人员和资源分配                                │
│    │  ├─ 每<span class="hljs-number">15</span>分钟汇报进展                                  │
│    │  ├─ 做出关键决策 (恢复方案选择)                       │
│    │  └─ 与高管和业务方沟通                                │
│    │                                                        │
│    └─ 权力:                                                 │
│       ├─ 可以打断任何人做其他事                             │
│       ├─ 可以要求任何资源                                   │
│       ├─ 可以做<span class="hljs-string">"最高速度修复"</span>的决定                        │
│       └─ 所有人都必须听命令 (军事化管理)                   │
│                                                             │
│ ─────────────────────────────────────────────────────────  │
│                                                             │
│ 技术调查员 (Technical Lead)                                │
│ └─ <span class="hljs-number">3</span>-<span class="hljs-number">4</span>名来自不同岗位的工程师                                │
│    ├─ Doris/Kafka工程师 (集群与存储)                       │
│    ├─ Flink工程师 (流式处理)                               │
│    ├─ 应用工程师 (业务逻辑)                                │
│    ├─ 系统工程师 (基础设施)                                │
│    │                                                        │
│    └─ 职责:                                                 │
│       ├─ 按分工收集诊断信息                                 │
│       ├─ 提出可能的原因和验证方法                           │
│       ├─ 尝试修复方案                                       │
│       └─ 定期向IC汇报进展                                  │
│                                                             │
│ ─────────────────────────────────────────────────────────  │
│                                                             │
│ 沟通官 (Communications Lead)                               │
│ └─ 由PM或CDO的助理担任                                     │
│    ├─ 职责:                                                │
│    │  ├─ 定期更新所有利益相关方                             │
│    │  ├─ 维护应急通讯 (钉钉群、视频会议)                   │
│    │  ├─ 记录所有关键时间点                                │
│    │  ├─ 向高管定时汇报                                    │
│    │  └─ 恢复后对外沟通 (道歉+说明+承诺)                  │
│    │                                                        │
│    └─ 通讯模板:                                             │
│       ├─ 故障确认: <span class="hljs-string">"我们发现了XXX问题，正在处理"</span>           │
│       ├─ 中期更新: <span class="hljs-string">"进展: 已找到原因，正在修复"</span>            │
│       ├─ 恢复通知: <span class="hljs-string">"系统已恢复，持续监控中"</span>                │
│       └─ 事后总结: <span class="hljs-string">"根本原因是XXX，已采取措施防止"</span>         │
│                                                             │
│ ─────────────────────────────────────────────────────────  │
│                                                             │
│ 备选角色 (<span class="hljs-keyword">On</span>-<span class="hljs-keyword">Call</span>)                                         │
│ └─ 关键故障时的值班人员                                     │
│    ├─ 工程师<span class="hljs-keyword">On</span>-<span class="hljs-keyword">Call</span>: 周一值班表                             │
│    │  └─ <span class="hljs-number">24</span>/<span class="hljs-number">7</span>待命，可远程响应                              │
│    │                                                        │
│    ├─ CDO <span class="hljs-keyword">On</span>-<span class="hljs-keyword">Call</span>: 周一值班表                              │
│    │  └─ 可以做关键决策                                    │
│    │                                                        │
│    └─ 激励机制:                                             │
│       ├─ <span class="hljs-keyword">On</span>-<span class="hljs-keyword">Call</span>补贴: ¥<span class="hljs-number">2000</span>/周                             │
│       ├─ 需要出动时额外奖金: ¥<span class="hljs-number">500</span>/次                       │
│       └─ 故障结束可申请compensatory time <span class="hljs-keyword">off</span> (补休)        │
│                                                             │
└────────────────────────────────────────────────────────────┘
</code></pre>
<hr/>
<h2 data-id="heading-13">故障恢复与容灾</h2>
<h3 data-id="heading-14">4.1 RTO/RPO的设计</h3>
<pre><code class="hljs language-makefile" lang="makefile">RTO (Recovery Time Objective) - 恢复时间目标

<span class="hljs-section">定义: 在发生故障时，系统从故障点到恢复到正常可用状态需要的最长时间</span>

<span class="hljs-section">Doris数据仓库:</span>
├─ 目标: RTO &lt; 2小时
├─ 设计: 
│  ├─ 快速故障转移 (3副本 → 2副本 → 可继续运行)
│  ├─ 自动告警 &amp; 人工干预 (30分钟内)
│  ├─ 恢复脚本 &amp; 自动化 (30分钟内完成)
│  └─ 验证 &amp; 回滚 (30分钟内)
└─ 验证: 每月演练一次 (故障转移测试)

<span class="hljs-section">Flink流处理:</span>
├─ 目标: RTO &lt; 1小时
├─ 设计:
│  ├─ Checkpoint持久化 (状态恢复)
│  ├─ 任务自动重启 (YARN/K8s)
│  ├─ 告警通知 + 人工确认 (10分钟)
│  └─ 从checkpoint恢复 (20分钟)
└─ 验证: 每周人工触发任务故障，测试恢复

<span class="hljs-section">POS数据采集:</span>
├─ 目标: RTO &lt; 1小时
├─ 设计:
│  ├─ 本地缓存 (POS服务器本地数据缓冲)
│  ├─ Kafka持久化 (消息队列保留7天)
│  ├─ 快速切换备用采集源 (10分钟)
│  └─ 数据重传 &amp; 对账 (30分钟)
└─ 验证: 模拟POS宕机，测试缓存和重传

───────────────────────────────────────────

RPO (Recovery Point Objective) - 恢复点目标

<span class="hljs-section">定义: 在发生故障时，可以接受的最大数据丢失量</span>

<span class="hljs-section">Doris数据仓库:</span>
├─ 目标: RPO &lt; 1小时
├─ 设计:
│  ├─ 实时副本 (3份副本，任何时刻任意2份一致)
│  ├─ 定期备份 (每天凌晨2点完整备份)
│  ├─ 增量备份 (每小时增量备份)
│  └─ 备份位置: HDFS/NAS (异地存储)
└─ 验证: 每周验证备份可恢复

<span class="hljs-section">Flink流处理:</span>
├─ 目标: RPO &lt; 30分钟
├─ 设计:
│  ├─ Checkpoint间隔: 60秒
│  ├─ 保留最近3个checkpoint
│  ├─ Checkpoint存储: HDFS (高可用)
│  └─ 恢复: 从最新checkpoint恢复 (丢失&lt;1小时数据)
└─ 验证: 定期测试checkpoint恢复

<span class="hljs-section">POS数据采集:</span>
├─ 目标: RPO &lt; 1小时
├─ 设计:
│  ├─ Kafka消息保留: 7天
│  ├─ 采集失败本地缓存: 24小时
│  ├─ 定期对账: 小时级
│  └─ 遗漏数据修复: T+1日
└─ 验证: 模拟消息丢失，测试恢复

───────────────────────────────────────────

<span class="hljs-section">多层容灾设计:</span>

<span class="hljs-section">第1层: 应用层容灾</span>
├─ 多副本存储 (3份副本)
├─ 自动转移 (检测故障自动切换)
└─ 故障隔离 (故障部分不影响整体)

<span class="hljs-section">第2层: 数据层容灾</span>
├─ 每小时全量备份
├─ 增量日志保留 (支持1小时内任意恢复点)
└─ 异地备份 (与主集群不同机房)

<span class="hljs-section">第3层: 网络层容灾</span>
├─ 多条网络链路 (主用+备用)
├─ 自动转移 (主链路故障自动切换备用)
└─ 故障检测 (心跳检测)

<span class="hljs-section">第4层: 基础设施层容灾</span>
├─ 多数据中心部署 (可选, 后期)
├─ 硬件冗余
└─ 电力 &amp; 网络冗余 (UPS, 双网络接入)
</code></pre>
<h3 data-id="heading-15">4.2 备份与恢复流程</h3>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">备份流程:</span>

天级备份 (Daily Full Backup)
├─ 时间: 每天凌晨2:00-4:00
├─ 对象: Doris全量数据 + 元数据
├─ 目的地: /backup/doris_full/yyyymmdd/
├─ 保留策略: 保留最近7天全量备份 + 最近4个月月度备份
├─ 验证: 备份完成后自动校验 (checksum验证)
└─ 通知: 成功/失败通知运维团队

小时级增量 (Hourly Incremental)
├─ 时间: 每小时执行一次
├─ 对象: 上个小时新增/修改的数据
├─ 目的地: /backup/doris_incremental/hhmm/
├─ 保留策略: 保留最近7天的增量
└─ 用途: 支持任意时间点恢复

Checkpoint备份 (Flink &amp; Kafka)
├─ Flink: 每分钟自动checkpoint
│  ├─ 存储: HDFS /flink/checkpoints/
│  ├─ 保留: 最近10个checkpoint
│  └─ 恢复: 任务故障后从最新checkpoint自动恢复
│
└─ Kafka: 消息持久化
   ├─ 保留: 7天消息历史
   ├─ 副本: 3份副本
   └─ 恢复: 消费者可重置offset重新消费

───────────────────────────────────────────

<span class="hljs-section">恢复流程:</span>

<span class="hljs-section">场景1: 单个表数据损坏</span>

<span class="hljs-section">步骤1: 故障诊断 (5分钟)</span>
├─ 识别受影响的表
├─ 确定损坏的时间范围
└─ 确定恢复点 (最近的好数据时刻)

<span class="hljs-section">步骤2: 备份选择 (10分钟)</span>
├─ 如果&lt;1小时: 从增量备份恢复
├─ 如果&lt;1天: 从天备份恢复
└─ 如果&gt;1周: 恢复困难，可能需要重新导入

<span class="hljs-section">步骤3: 恢复执行 (30分钟)</span>
├─ 创建临时表存放恢复数据
├─ 从备份恢复数据到临时表
├─ 验证临时表数据
└─ 与原表切换 (原子操作)

<span class="hljs-section">步骤4: 验证与通知 (15分钟)</span>
├─ 数据对账验证
├─ 查询测试
├─ 通知业务方恢复完成

<span class="hljs-section">总耗时: &lt;1小时</span>

───────────────────────────────────────────

<span class="hljs-section">场景2: Doris整个集群故障</span>

<span class="hljs-section">步骤1: 故障诊断 (15分钟)</span>
├─ 检查所有FE/BE节点状态
├─ 检查网络连接
├─ 查看错误日志
└─ 判断故障类型

<span class="hljs-section">步骤2: 应急恢复 (60分钟)</span>
├─ 选项A: 重启故障节点
│  ├─ 如果节点重启后恢复 → 完成
│  └─ 如果仍然故障 → 选项B
│
├─ 选项B: 降级运行
│  ├─ 停用故障节点
│  ├─ 集群在2副本模式下运行 (降级但可用)
│  ├─ 派遣运维人员现场排查
│  └─ 同时购买或更换硬件
│
└─ 选项C: 从备份完全恢复
   ├─ 准备新的BE节点
   ├─ 从备份导入数据 (可能需要2-4小时)
   ├─ 副本构建 (1-2小时)
   └─ 验证通过后上线

<span class="hljs-section">总耗时: 1-4小时 (取决于选择的方案)</span>

───────────────────────────────────────────

<span class="hljs-section">场景3: 数据中心故障 (机房断网/断电)</span>

<span class="hljs-section">现象: 整个Doris集群无法访问</span>

应急措施 (此情况下RTO可能&gt;2小时):
├─ 立即通知所有用户数据暂时不可用
├─ 启动容灾方案 (如有其他IDC的备份集群)
├─ 从异地备份恢复 (需要4-8小时)
├─ 恢复后的数据会丢失&lt;1小时 (根据备份策略)
└─ 对用户进行赔偿 &amp; 说明

<span class="hljs-section">预防措施:</span>
├─ 多IDC部署 (后期规划, 初期可用NAS备份)
├─ 数据同城多份备份
└─ 异地备份 (至少一份)
</code></pre>
<hr/>
<h2 data-id="heading-16">持续改进机制</h2>
<h3 data-id="heading-17">5.1 事后总结会 (Postmortem)</h3>
<pre><code class="hljs language-makefile" lang="makefile">每次P1及以上故障后，必须在24-48小时内召开事后总结会

<span class="hljs-section">会议组织:</span>

<span class="hljs-section">组织方: CDO (负责组织与主持)</span>
<span class="hljs-section">参加人:</span>
├─ 故障处理的所有参与者 (技术/运维)
├─ 相关业务方负责人
├─ CDO/Tech Lead/PM
└─ 轮流邀请团队其他成员学习 (知识分享)

<span class="hljs-section">时间: 1.5-2小时</span>
<span class="hljs-section">地点: 线上视频会议 (便于录制)</span>

────────────────────────────────────────

<span class="hljs-section">会议议程:</span>

1. Timeline回顾 (15分钟)
   └─ 展示故障发生的完整时间线:
      ├─ 14:30 告警触发
      ├─ 14:35 人员集合
      ├─ 14:50 原因确认
      ├─ 15:20 修复执行
      └─ 15:45 完全恢复

2. 事实陈述 (20分钟)
   └─ 故障发生的客观事实:
      ├─ <span class="hljs-string">"发生了什么"</span> (不是<span class="hljs-string">"为什么"</span>)
      ├─ 影响范围与影响时间
      ├─ 采取的应急措施
      └─ 最终如何解决

3. Root Cause分析 (30分钟)
   └─ 用<span class="hljs-string">"5个Why"</span>分析根本原因:
      ├─ Why1: <span class="hljs-string">"系统故障了"</span> 为什么?
      │      答: <span class="hljs-string">"内存溢出"</span>
      │
      ├─ Why2: <span class="hljs-string">"为什么内存溢出"</span>
      │      答: <span class="hljs-string">"某个查询没有优化"</span>
      │
      ├─ Why3: <span class="hljs-string">"为什么没有优化"</span>
      │      答: <span class="hljs-string">"在code review中没被发现"</span>
      │
      ├─ Why4: <span class="hljs-string">"为什么code review没发现"</span>
      │      答: <span class="hljs-string">"reviewer不了解这个模块的性能影响"</span>
      │
      └─ Why5: <span class="hljs-string">"为什么reviewer不了解"</span>
             答: <span class="hljs-string">"缺少性能测试和文档"</span> ← ROOT CAUSE
      
   └─ 最终认定: 根本原因是<span class="hljs-string">"缺少性能测试"</span>

4. 行动项 (20分钟)
   └─ 制定改进措施:
      ├─ 短期 (立即): 
      │  ├─ 优化该查询
      │  ├─ 清理过期数据
      │  └─ 增加内存
      │
      ├─ 中期 (1周内):
      │  ├─ 建立性能测试流程
      │  ├─ 增加code review checklist
      │  └─ 培训团队性能优化
      │
      └─ 长期 (1个月内):
         ├─ 建立自动化性能测试
         ├─ 建立性能基准
         └─ 定期性能评审
   
   └─ 每个Action必须有:
      ├─ 具体描述 (清晰、可测量)
      ├─ Owner (谁负责)
      ├─ Deadline (什么时间完成)
      └─ Success Criteria (完成标准是什么)

5. 学到的经验 (15分钟)
   └─ 讨论积极的方面:
      ├─ <span class="hljs-string">"响应速度很快，5分钟内集合了所有人"</span> 好!
      ├─ <span class="hljs-string">"自动告警工作很好，及时发现了问题"</span> 好!
      ├─ <span class="hljs-string">"团队协作很紧密，很快找到了原因"</span> 好!
      └─ <span class="hljs-string">"恢复流程清晰，不到1小时恢复"</span> 好!
   
   └─ 目的: 强化好的做法，提升团队信心

────────────────────────────────────────

<span class="hljs-section">输出物:</span>

1. 事后报告 (Postmortem Report)
   ├─ 发给: 所有stakeholders + 归档Wiki
   ├─ 包含:
   │  ├─ Executive Summary (1页概述)
   │  ├─ Timeline &amp; Facts (完整时间线)
   │  ├─ Root Cause Analysis (5个Why + RCA)
   │  ├─ Action Items (改进计划)
   │  ├─ Lessons Learned (学到的经验)
   │  └─ 附件 (日志、监控图表、代码diff等)
   │
   └─ 发送: 邮件通知所有人
      <span class="hljs-string">"本周一14:30故障的事后报告已发送，请查收"</span>

2. Action Items跟踪
   ├─ 记录在项目管理系统 (Jira/Trello)
   ├─ 每周进度跟踪 (在周会上报告)
   ├─ Deadline到期后验证完成情况
   └─ 归档并标记为<span class="hljs-string">"Completed"</span>

────────────────────────────────────────

<span class="hljs-section">注意事项:</span>

✅ 正确的Postmortem:
├─ 不指责任何人 (<span class="hljs-string">"为什么这样做"</span>而不是<span class="hljs-string">"你干了什么蠢事"</span>)
├─ 事实为基础 (而不是猜测和假设)
├─ 有具体的改进行动
├─ 有owner和deadline
├─ 后续会追踪完成情况
└─ 基调是学习而不是惩罚

❌ 错误的Postmortem:
├─ <span class="hljs-string">"是XX工程师的错"</span> (指责个人)
├─ <span class="hljs-string">"应该防止这种故障"</span> (没有具体方案)
├─ 没有行动项 (开会讨论完就没了)
├─ 没有owner (责任不清)
├─ <span class="hljs-string">"这种故障以后不会发生"</span> (不现实)
└─ 只有惩罚，没有改进
</code></pre>
<h3 data-id="heading-18">5.2 SLA监控与评分</h3>
<pre><code class="hljs language-erlang" lang="erlang">月度SLA评分卡 (Monthly SLA Scorecard)

每月<span class="hljs-number">15</span>日发布上个月的SLA评分:

┌──────────────────────────────────────────────────────┐
│ <span class="hljs-number">2025</span>年<span class="hljs-number">11</span>月 数据平台SLA评分                           │
│                                                       │
│ 数据可用性      <span class="hljs-number">99.7</span><span class="hljs-comment">% ✓ 目标: ≥99.5%               │</span>
│ 数据延迟         &lt;<span class="hljs-number">5</span>m  ✓ 目标: &lt;<span class="hljs-number">5</span>分钟                │
│ 查询响应时间    P95&lt;<span class="hljs-number">4</span>s ✓ 目标: P95&lt;<span class="hljs-number">5</span>s              │
│ 数据准确率      <span class="hljs-number">99.95</span><span class="hljs-comment">% ✓ 目标: ≥99%                │</span>
│ 告警准确率       <span class="hljs-number">94</span><span class="hljs-comment">%   ⚠️  目标: ≥95% (需改进)     │</span>
│                                                       │
│ 总体评分: <span class="hljs-number">95.2</span>/<span class="hljs-number">100</span> (A级)                            │
│                                                       │
│ 故障统计:                                            │
│ • P0故障: <span class="hljs-number">0</span>次 (目标: <span class="hljs-number">0</span>次) ✓                         │
│ • P1故障: <span class="hljs-number">2</span>次 (目标: &lt;<span class="hljs-number">3</span>次) ✓                        │
│  └─ <span class="hljs-number">11</span>月<span class="hljs-number">5</span>日 Kafka延迟 (<span class="hljs-number">30</span>分钟内恢复)              │
│  └─ <span class="hljs-number">11</span>月<span class="hljs-number">18</span>日 查询卡顿 (<span class="hljs-number">1</span>小时内恢复)                │
│ • P2故障: <span class="hljs-number">5</span>次 (目标: &lt;<span class="hljs-number">5</span>次) ✓                        │
│ • 平均MTTR: <span class="hljs-number">42</span>分钟 (目标: &lt;<span class="hljs-number">1</span>小时) ✓                │
│ • 平均MTTF: <span class="hljs-number">3.2</span>天 (目标: &gt;<span class="hljs-number">3</span>天) ✓                   │
│                                                       │
│ 改进方向:                                            │
│ <span class="hljs-number">1</span>. 告警准确率需提升 (<span class="hljs-number">1</span>pp差距)                       │
│    - 原因: 某个告警规则参数设置不合理                │
│    - 改进: 本周微调告警规则                          │
│                                                       │
│ <span class="hljs-number">2</span>. 查询性能仍有优化空间                             │
│    - 某些复杂查询还是较慢                            │
│    - 计划: 下月优化<span class="hljs-number">5</span>个关键查询                      │
│                                                       │
│ 目标: <span class="hljs-number">12</span>月冲刺<span class="hljs-number">99</span>分,争取S级评分                      │
│                                                       │
└──────────────────────────────────────────────────────┘

评分等级:

│ 等级 │ 分数   │ 定义          │ 对应奖励                │
├──────┼────────┼──────────────┼─────────────────────────┤
│ S    │ <span class="hljs-number">99</span>-<span class="hljs-number">100</span> │ 优秀          │ 全队¥<span class="hljs-number">5000</span>奖金           │
│ A    │ <span class="hljs-number">95</span>-<span class="hljs-number">98</span>  │ 良好          │ 全队¥<span class="hljs-number">3000</span>奖金           │
│ B    │ <span class="hljs-number">90</span>-<span class="hljs-number">94</span>  │ 及格          │ 无奖金，但无扣分        │
│ C    │ <span class="hljs-number">80</span>-<span class="hljs-number">89</span>  │ 需改进        │ 每人扣¥<span class="hljs-number">500</span>（激励改进）│
│ D    │ &lt;<span class="hljs-number">80</span>    │ 严重不达标    │ 进行部门调查            │
└──────┴────────┴──────────────┴─────────────────────────┘
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[ThreadLocal 源码深度解析：JDK 设计者的“妥协”与“智慧”]]></title>    <link>https://juejin.cn/post/7577690150093815848</link>    <guid>https://juejin.cn/post/7577690150093815848</guid>    <pubDate>2025-11-30T09:04:53.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577690150093815848" data-draft-id="7577795545440206882" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="ThreadLocal 源码深度解析：JDK 设计者的“妥协”与“智慧”"/> <meta itemprop="keywords" content="Java,后端"/> <meta itemprop="datePublished" content="2025-11-30T09:04:53.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户8491371754716"/> <meta itemprop="url" content="https://juejin.cn/user/2744800640504071"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            ThreadLocal 源码深度解析：JDK 设计者的“妥协”与“智慧”
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2744800640504071/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户8491371754716
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T09:04:53.000Z" title="Sun Nov 30 2025 09:04:53 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 Java 并发编程中，<code>ThreadLocal</code> 是一个高频使用的“神器”，它能够轻松实现线程间的数据隔离。然而，关于它“内存泄漏”的警告也从未停止，甚至成为了面试中的一道必考题。</p>
<p>很多人会背诵“弱引用导致泄漏”，但往往知其然不知其所以然。<strong>为什么 JDK 必须要用弱引用？这背后究竟隐藏着怎样的设计博弈？</strong></p>
<p>本文将从 JDK 源码深处入手，揭示 <code>ThreadLocal</code> 的底层引用结构，剖析 JDK 设计者在<strong>性能、易用性与内存管理</strong>之间所做的精妙“妥协”与“智慧”。</p>
<h2 data-id="heading-0">一、破题：ThreadLocal 到底把数据存到哪里了？</h2>
<p>一个普遍的误解是：ThreadLocal 内部维护了一个全局的 Map 来存储数据。</p>
<p>事实恰恰相反。</p>
<p>从源码视角看，<code>ThreadLocal</code> 的设计目标并不是充当存储容器，而是一把<strong>访问数据的“钥匙”（Key）</strong>。真正的数据（Value）实际上存储在 <strong>当前线程对象 (<code>Thread.currentThread()</code>)</strong> 内部。</p>
<h3 data-id="heading-1">1.1 内存引用关系</h3>
<p>内存中的引用链如下所示：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[ThreadLocal - Key] --&gt; B[Current Thread]
    B --&gt; C[ThreadLocalMap - 存储 Value]
</code></pre>
<h3 data-id="heading-2">1.2 源码实证</h3>
<p>只要翻看 <code>Thread</code> 类的源码，真相一目了然：每个 <code>Thread</code> 对象都维护着一个私有的 <code>ThreadLocalMap</code> 成员变量。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Thread 类的部分核心源码 (JDK 8)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Thread</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Runnable</span> {
 
    ThreadLocal.<span class="hljs-type">ThreadLocalMap</span> <span class="hljs-variable">threadLocals</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
    
    <span class="hljs-comment">// ...</span>
}
</code></pre>
<p>当我们调用 <code>threadLocalInstance.set(value)</code> 时，本质上执行了以下操作：</p>
<ol>
<li>获取当前线程对象 <code>Thread.currentThread()</code>。</li>
<li>获取线程内部的 <code>threadLocals</code> (即 <code>ThreadLocalMap</code>)。</li>
<li>以<strong>当前的 ThreadLocal 实例</strong>作为 Key，将 <code>value</code> 作为 Value 存入 Map。</li>
</ol>
<h2 data-id="heading-3">二、核心矛盾：为什么要设计成“弱引用”？</h2>
<p>为了透视内存泄漏的根源，我们必须解剖 <code>ThreadLocalMap</code> 的内部结构。它的核心数据结构 <code>Entry</code> 继承了 <code>WeakReference</code>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ThreadLocalMap 内部存储的 Entry</span>
<span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Entry</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WeakReference</span>&lt;ThreadLocal&lt;?&gt;&gt; {
    <span class="hljs-comment">/** The value associated with this ThreadLocal. */</span>
    Object value;

    Entry(ThreadLocal&lt;?&gt; k, Object v) {
        <span class="hljs-built_in">super</span>(k); <span class="hljs-comment">// 重点：Key (ThreadLocal实例) 被包装成了弱引用</span>
        value = v;
    }
}
</code></pre>
<p>关键点：Key 是<strong>弱引用</strong>，而 Value 是<strong>强引用</strong>。</p>
<p>为什么 JDK 设计者不直接使用强引用？这是一次为了解决“Key 泄漏”的防御性设计。</p>
<h3 data-id="heading-4">2.1 假设：如果 Key 是强引用</h3>
<p>试想，如果 Entry 对 <code>ThreadLocal</code> 实例持有的是强引用：</p>
<ol>
<li><strong>外部引用消失</strong>：我们在业务代码中将 <code>ThreadLocal</code> 变量置为 null（<code>tl = null</code>）。</li>
<li><strong>内部引用犹存</strong>：由于当前线程（Thread）依然存活，<code>ThreadLocalMap</code> 依然持有 <code>Entry</code>，而 <code>Entry</code> 强引用着 <code>ThreadLocal</code> 实例。</li>
<li><strong>结果</strong>：虽然外部已经无法访问该对象，但 GC 无法回收它。只要线程不结束（如线程池场景），这个 <code>ThreadLocal</code> 对象就会一直驻留在堆内存中。</li>
</ol>
<p><strong>这就是“Key 泄漏”</strong>。</p>
<h3 data-id="heading-5">2.2 妥协：引入弱引用</h3>
<p>为了解决上述问题，JDK 采用了<strong>弱引用 (WeakReference)</strong> 机制：</p>
<blockquote>
<p><strong>弱引用的特性</strong>：只具有弱引用的对象，在垃圾回收器（GC）线程扫描它所管辖的内存区域过程中，一旦发现了只具有弱引用的对象，不管当前内存空间足够与否，都会回收它的内存。</p>
</blockquote>
<p>这个设计保证了：<strong>一旦外部代码不再引用 ThreadLocal 实例，它就能被 GC 及时回收，避免了 Key 层的内存泄漏。</strong></p>
<h2 data-id="heading-6">三、代价：著名的 Value 泄漏陷阱</h2>
<p>软件工程中没有完美的方案，只有权衡（Trade-off）。JDK 解决了 Key 的泄漏，却不得不面临另一个代价——<strong>Value 的泄漏</strong>。</p>
<h3 data-id="heading-7">3.1 泄漏是如何发生的？</h3>
<p>我们可以通过 Mermaid 图来直观地看清这个过程：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    ThreadRef[Stack: Thread Ref] --&gt; ThreadObj[Heap: Current Thread]
    ThreadObj --&gt; Map[ThreadLocalMap]
    Map --&gt; Entry
    
    TLRef[Stack: ThreadLocal Ref] -.-&gt;|引用断开| TLObj[Heap: ThreadLocal Key]
    
    Entry -.-&gt;|Weak Ref| TLObj
    Entry --&gt;|Strong Ref| ValueObj[Heap: Value Object]
    
    style TLObj fill:#ffcccc,stroke:#333,stroke-width:2px,stroke-dasharray: 5 5
    style ValueObj fill:#ff6666,stroke:#333,stroke-width:4px
</code></pre>
<ol>
<li><strong>Key 被回收</strong>：当外部引用断开，GC 发生后，Entry 中的 Key 变成了 <code>null</code>。</li>
<li><strong>Value 悬空</strong>：此时 Map 中存在一个 <code>Key=null, Value=Object</code> 的 Entry。</li>
<li><strong>引用链未断</strong>：<code>Current Thread -&gt; ThreadLocalMap -&gt; Entry -&gt; Value</code>。这条强引用链依然存在。</li>
<li><strong>后果</strong>：如果你使用的是<strong>线程池</strong>，线程会被复用而不会销毁。这意味着这个 <code>Value</code> 对象将永远驻留在内存中，无法被访问也无法被回收。</li>
</ol>
<p><strong>这就是所谓的 ThreadLocal 内存泄漏，本质上是 Value 的泄漏。</strong></p>
<h2 data-id="heading-8">四、JDK 的补救与最佳实践</h2>
<p>JDK 意识到了这个问题，并在 <code>ThreadLocalMap</code> 的 <code>get()</code>、<code>set()</code>、<code>remove()</code> 方法中埋下了“探测式清理”逻辑（<code>expungeStaleEntries</code> 方法）。当我们在操作 Map 时，它会顺带检查并清理 Key 为 <code>null</code> 的 Entry。</p>
<p>但这是一种<strong>被动</strong>的机制。如果线程在归还给线程池后，没有后续的 <code>ThreadLocal</code> 操作，这块内存依然无法释放。</p>
<h3 data-id="heading-9">4.1 终极解决方案：防御性编程</h3>
<p>要彻底解决内存泄漏，不能依赖 JDK 的被动清理，而必须依靠<strong>编码规范</strong>。</p>
<p><strong>请牢记以下标准范式：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 1. 定义 ThreadLocal</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> ThreadLocal&lt;UserInfo&gt; USER_INFO_HOLDER = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadLocal</span>&lt;&gt;();

<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doBusiness</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// 2. 设置值</span>
        USER_INFO_HOLDER.set(<span class="hljs-keyword">new</span> <span class="hljs-title class_">UserInfo</span>(<span class="hljs-string">"JuejinUser"</span>));
        
        <span class="hljs-comment">// 3. 执行业务逻辑</span>
        process();
    } <span class="hljs-keyword">finally</span> {
        <span class="hljs-comment">// 4. 核心：必须在 finally 中手动 remove</span>
        <span class="hljs-comment">// 这能切断 Map 中的 Entry 引用，彻底防止泄漏</span>
        USER_INFO_HOLDER.remove();
    }
}
</code></pre>
<h2 data-id="heading-10">五、总结</h2>
<p><code>ThreadLocal</code> 的源码设计是一场关于<strong>生命周期管理</strong>的精彩博弈：</p>
<ol>
<li><strong>如果不作为</strong>（全强引用）：会导致 <code>ThreadLocal</code> 对象本身的泄漏（Key 泄漏）。</li>
<li><strong>引入弱引用</strong>：解决了 Key 泄漏，但导致了 Value 的游离。</li>
<li><strong>最终的智慧</strong>：JDK 选择牺牲 Value 的安全性（可能泄漏）来换取 Key 的自动管理。因为它认为 <strong>Value 的生命周期理应由开发者在业务逻辑中显式控制</strong>。</li>
</ol>
<p>作为开发者，理解了这一层“妥协”，我们才能更安全地驾驭这个并发利器。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Elasticsearch Filter 缓存：Bitset 如何让查询速度飙升]]></title>    <link>https://juejin.cn/post/7577737385955065866</link>    <guid>https://juejin.cn/post/7577737385955065866</guid>    <pubDate>2025-11-30T09:06:31.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577737385955065866" data-draft-id="7577971299742875686" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Elasticsearch Filter 缓存：Bitset 如何让查询速度飙升"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-30T09:06:31.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Penge666"/> <meta itemprop="url" content="https://juejin.cn/user/1549628692501449"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Elasticsearch Filter 缓存：Bitset 如何让查询速度飙升
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1549628692501449/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Penge666
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T09:06:31.000Z" title="Sun Nov 30 2025 09:06:31 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>用过 Elasticsearch 的同学大概率都听过 “把过滤条件放 filter 里更快”，但很少有人说清背后到底快在哪。今天我们就用一个电商订单索引的真实场景，一步步拆解 Filter 的 Bitset 缓存工作原理，让你彻底搞懂这个性能优化的关键！</p>
<h2 data-id="heading-0">一、先搭个场景：电商订单索引</h2>
<p>假设我们有一个<code>orders</code>索引，存了 10 条订单数据（文档 ID 1~10），字段结构很简单：</p>
<ul>
<li><code>user_id</code>：用户 ID（keyword 类型，精准匹配）</li>
<li><code>order_time</code>：下单时间（date 类型，时间戳存储）</li>
<li><code>status</code>：订单状态（keyword 类型：paid/unpaid/refunded）</li>
</ul>
<p>现在要查 “用户 1001 在 2025 年 6 月之后下的订单”，对应的 DSL 是：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"query"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"bool"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"filter"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-punctuation">{</span> <span class="hljs-attr">"term"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"user_id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1001"</span> <span class="hljs-punctuation">}</span> <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
        <span class="hljs-punctuation">{</span> <span class="hljs-attr">"range"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"order_time"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"gte"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1748419000</span> <span class="hljs-punctuation">}</span> <span class="hljs-punctuation">}</span> <span class="hljs-punctuation">}</span>
      <span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>接下来，我们就跟着这个查询，看看 Bitset 缓存是怎么工作的。</p>
<h2 data-id="heading-1">二、第一次查询：从零生成 Bitset</h2>
<p>当这个查询第一次执行时，ES 还没有任何缓存，需要走完整的 “扫描 - 生成 - 缓存” 流程。</p>
<h3 data-id="heading-2">1. 第一步：为<code>user_id=1001</code>生成 Bitset</h3>
<p>Bitset（位图）是个超轻量的二进制结构 ——<strong>每一位对应一个文档 ID，匹配标 1，不匹配标 0</strong>。</p>
<ul>
<li>ES 先扫<code>user_id</code>的倒排索引，发现文档 2、5、7、9 属于用户 1001；</li>
<li>生成 Bitset：<code>0 1 0 0 1 0 1 0 1 0</code>（第 2、5、7、9 位是 1）；</li>
<li>把这个 Bitset 存进内存缓存，贴上标签：<code>user_id:1001</code>。</li>
</ul>
<h3 data-id="heading-3">2. 第二步：为<code>order_time&gt;=1748419000</code>生成 Bitset</h3>
<p>同样的逻辑，处理时间范围条件：</p>
<ul>
<li>扫<code>order_time</code>的倒排索引，找到文档 3、5、7、8、10 符合时间要求；</li>
<li>生成 Bitset：<code>0 0 1 0 1 0 1 1 0 1</code>（第 3、5、7、8、10 位是 1）；</li>
<li>缓存这个 Bitset，标签：<code>order_time:&gt;=1748419000</code>。</li>
</ul>
<h3 data-id="heading-4">3. 第三步：位运算组合出最终结果</h3>
<p>两个 Bitset 都有了，ES 会做<strong>AND 位运算</strong>（只有两位都为 1 才保留）：</p>
<pre><code class="hljs language-plaintext" lang="plaintext">user_id=1001的Bitset：0 1 0 0 1 0 1 0 1 0
order_time&gt;=...的Bitset：0 0 1 0 1 0 1 1 0 1
AND运算结果：0 0 0 0 1 0 1 0 0 0
</code></pre>
<p>一眼就能看出，只有文档 5、7 同时满足两个条件 —— 这比逐行检查文档快了不止一个量级！</p>
<h2 data-id="heading-5">三、第二次查询：直接复用缓存，速度起飞</h2>
<p>如果几分钟后，你又执行了<strong>一模一样的过滤条件</strong>，事情就简单了：</p>
<ol>
<li>ES 直接从内存里拽出之前缓存的两个 Bitset，<strong>不用再扫倒排索引</strong>；</li>
<li>重复 AND 位运算，瞬间得到结果；</li>
<li>返回文档 5、7。</li>
</ol>
<p>整个过程跳过了最耗时的 “扫描索引” 步骤，响应时间可能从几十毫秒降到几毫秒 —— 这就是缓存的威力！</p>
<h2 data-id="heading-6">四、数据变了怎么办？Bitset 的智能更新</h2>
<p>如果这时候新增了一条文档 11（user_id=1001，order_time=1748500000），Bitset 会怎么处理？</p>
<ul>
<li>ES 不会删掉旧缓存，而是<strong>增量更新</strong>：把<code>user_id:1001</code>的 Bitset 第 11 位设为 1，<code>order_time:&gt;=...</code>的 Bitset 第 11 位也设为 1；</li>
<li>下次查询时，结果里就会自动包含文档 11，既保证了准确性，又没浪费缓存。</li>
</ul>
<h2 data-id="heading-7">五、Bitset 为啥这么牛？核心优势拆解</h2>
<ol>
<li><strong>极致轻量化</strong>：1000 万个文档的 Bitset 只占约 1.2MB 内存（10^7 位 = 10^7/8/1024 ≈ 1220KB），亿级文档也才几十 MB；</li>
<li><strong>运算超快</strong>：位运算是 CPU 原生支持的操作，比遍历文档快几个数量级；</li>
<li><strong>缓存复用率高</strong>：缓存的是 “条件规则” 而非 “查询结果”，只要过滤条件相同，不管查什么字段都能复用。</li>
</ol>
<h2 data-id="heading-8">六、缓存的生命周期：何时过期？占用多少内存？</h2>
<h3 data-id="heading-9">1. 缓存的内存占用规则</h3>
<p>Bitset 缓存并非独立存在，而是属于 ES 的<strong>Node Query Cache</strong>（节点级查询缓存），其内存上限由参数<code>indices.queries.cache.size</code>控制：</p>
<ul>
<li>默认值为 JVM 堆内存的 10%（比如 JVM 堆是 31GB，缓存上限约 3.1GB）；</li>
<li>也可手动设置固定值（如<code>512mb</code>），避免占用过多堆内存。</li>
</ul>
<p>以 1000 万文档的 Bitset 为例，单个条件的 Bitset 仅占 1.2MB 左右，3.1GB 的缓存空间足以存储数百万个过滤条件的 Bitset，完全满足常规业务需求。</p>
<h3 data-id="heading-10">2. 缓存何时 “过期”？</h3>
<p>Bitset 缓存<strong>没有固定过期时间</strong>，而是遵循<strong>LRU（最近最少使用）淘汰策略</strong>：</p>
<ul>
<li>高频使用的过滤条件（如<code>user_id=1001</code>）会长期驻留内存，反复复用；</li>
<li>低频使用的条件，当缓存空间不足时，会被优先淘汰；</li>
<li>若索引数据发生变更（新增 / 删除 / 更新文档），ES 会<strong>增量更新</strong>受影响的 Bitset，而非直接淘汰 —— 比如修改了文档 5 的<code>user_id</code>，仅把<code>user_id:1001</code>的 Bitset 第 5 位从 1 改为 0，其余位保持不变。</li>
</ul>
<p>只有当缓存达到内存上限，且该 Bitset 长期未被访问时，才会被 LRU 机制清理。</p>
<h2 data-id="heading-11">七、和 must 比，filter 到底快在哪？</h2>
<p>很多人问 “为啥 must 里的条件不能用 Bitset？”—— 因为<code>must</code>要算相关性评分（<code>_score</code>），必须逐文档计算；而<code>filter</code>只需要 “是 / 否” 的判断，刚好适配 Bitset 的二进制特性。</p>
<p>简单说：</p>
<ul>
<li><code>must</code>：既要匹配，又要评分 → 慢；</li>
<li><code>filter</code>：只匹配，不评分 → 能用 Bitset 缓存 → 快！</li>
</ul>
<h2 data-id="heading-12">八、最后划重点：Filter 缓存的实用建议</h2>
<ol>
<li><strong>过滤条件必放 filter</strong>：尤其是<code>term</code>/<code>range</code>/<code>terms</code>这类不影响评分的条件；</li>
<li><strong>缓存不用手动管</strong>：ES 会用 LRU 策略自动管理内存，默认占 JVM 堆的 10%，无需手动清理；</li>
<li><strong>高频条件收益最大</strong>：比如按用户 ID、时间范围的过滤，缓存命中率极高；低频条件则可能被淘汰，无需纠结；</li>
<li><strong>手动调整缓存大小</strong>：若业务有大量高频过滤条件，可适当调高<code>indices.queries.cache.size</code>（如设为 20%），提升缓存命中率。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[# 【Maven避坑】源码去哪了？一文看懂 Maven 工程与打包后的目录映射关系]]></title>    <link>https://juejin.cn/post/7577737385955147786</link>    <guid>https://juejin.cn/post/7577737385955147786</guid>    <pubDate>2025-11-30T09:25:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577737385955147786" data-draft-id="7577971299742990374" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="# 【Maven避坑】源码去哪了？一文看懂 Maven 工程与打包后的目录映射关系"/> <meta itemprop="keywords" content="后端,Java"/> <meta itemprop="datePublished" content="2025-11-30T09:25:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户030480591263"/> <meta itemprop="url" content="https://juejin.cn/user/3793762867478852"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            # 【Maven避坑】源码去哪了？一文看懂 Maven 工程与打包后的目录映射关系
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3793762867478852/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户030480591263
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T09:25:15.000Z" title="Sun Nov 30 2025 09:25:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>【Maven避坑】源码去哪了？一文看懂 Maven 工程与打包后的目录映射关系</p>
<blockquote>
<p><strong>摘要</strong>：你是否遇到过 <code>FileNotFoundException</code>？是否遇到过 MyBatis 报错 <code>Invalid bound statement</code>？很多时候，这并非代码写错了，而是你没搞懂 Maven 打包时把你的文件“搬”到了哪里。本文将通过图解，带你揭开 Maven 打包的“乾坤大挪移”之谜。本文由Gemini 3.0 生成</p>
</blockquote>
<h2 data-id="heading-0">前言</h2>
<p>作为一个 Java 后端新人，在开发过程中，我常会有这样的困惑：</p>
<ul>
<li>我在 <code>src/main/resources</code> 下写的 <code>application.yml</code>，程序运行起来后到底去哪找它？</li>
<li>为什么我的 Mapper XML 文件明明在工程里，打包后却不见了？</li>
<li>经常听到的 <strong>Classpath（类路径）</strong>，到底指的是哪里？</li>
</ul>
<p>Maven 遵循“约定优于配置”的原则，但如果我们不了解这个“约定”，开发时就会踩坑。今天我们就来拆解一下 Maven 项目从<strong>源码</strong>到<strong>JAR包</strong>的映射关系。</p>
<h2 data-id="heading-1">一、 一张图看懂核心映射</h2>
<p>Maven 在执行 <code>mvn package</code> 打包时，主要做了一件事：把 <code>src/main</code> 下的<strong>Java 代码</strong>和<strong>资源文件</strong>，经过编译和整理，合并到了 JAR 包的<strong>根目录</strong>下。</p>
<p>请看下面的对比图（这是最核心的知识点）：</p>
<pre><code class="hljs language-text" lang="text">【工程源码目录 (Source)】                    【打包后的 JAR 内部目录 (Runtime)】
MyProject
├── src
│   ├── main
│   │   ├── java (Java代码)
│   │   │   └── com
│   │   │       └── demo
│   │   │           └── User.java  ---&gt;  com/demo/User.class (变成了字节码)
│   │   │
│   │   └── resources (资源文件)
│   │       ├── application.yml  -----&gt;  application.yml (直接在根目录下！)
│   │       ├── mybatis-config.xml ---&gt;  mybatis-config.xml
│   │       └── mapper
│   │           └── UserMapper.xml ---&gt;  mapper/UserMapper.xml
│   │
│   └── test (测试代码)
│       └── ...                    ---&gt;  (直接丢弃，不进入最终JAR包)
</code></pre>
<h2 data-id="heading-2">二、 三大映射规则</h2>
<p>理解了上面的图，我们可以总结出 Maven 的三条打包铁律：</p>
<h3 data-id="heading-3">1. Java 目录：编译并保持结构</h3>
<p>Maven 会调用 <code>javac</code> 将 <code>src/main/java</code> 下的 <code>.java</code> 文件编译成 <code>.class</code> 文件。
<strong>重点</strong>：包路径（package）会直接转化为文件夹路径。</p>
<ul>
<li>源码：<code>src/main/java/com/demo/User.java</code></li>
<li>打包后：<code>JAR根/com/demo/User.class</code></li>
</ul>
<h3 data-id="heading-4">2. Resources 目录：复制并“平铺”</h3>
<p><code>src/main/resources</code> 是资源的<strong>根目录</strong>。Maven 会把这个文件夹<strong>内部</strong>的所有东西，直接复制到 JAR 包的<strong>根目录</strong>下。
<strong>重点</strong>：它会和编译后的 class 文件混在一起！</p>
<ul>
<li>这就是为什么我们在代码里读取配置文件时（例如 <code>classpath:application.yml</code>），不需要写 <code>resources/</code> 前缀，因为它就在根目录下。</li>
</ul>
<h3 data-id="heading-5">3. Test 目录：用完即弃</h3>
<p><code>src/test</code> 下的所有代码和资源，仅在 <code>mvn test</code> 阶段生效。它们<strong>绝对不会</strong>出现在最终生成的 JAR 包里。</p>
<ul>
<li><strong>避坑</strong>：千万不要在生产代码里依赖 <code>src/test</code> 下写的工具类。</li>
</ul>
<h2 data-id="heading-6">三、 经典踩坑场景：MyBatis 的 XML 去哪了？</h2>
<p>这是初学者最容易遇到的坑。</p>
<h3 data-id="heading-7">场景 A：XML 放在 resources 下（推荐 ✅）</h3>
<p>如果你把 <code>UserMapper.xml</code> 放在 <code>src/main/resources/mapper/</code> 下。
根据规则 2，打包后它位于 <code>JAR根/mapper/UserMapper.xml</code>。
一切正常，程序能找到。</p>
<h3 data-id="heading-8">场景 B：XML 放在 java 目录下（报错 ❌）</h3>
<p>为了方便管理，很多人喜欢把 <code>UserMapper.xml</code> 和 <code>UserMapper.java</code> 接口放在同一个包下，例如 <code>src/main/java/com/demo/mapper/</code>。</p>
<p><strong>后果</strong>：
Maven 的默认机制是：<strong>在 <code>src/main/java</code> 目录下，只编译 <code>.java</code> 文件，忽略其他所有文件（包括 XML）。</strong>
所以，你的 JAR 包里根本没有那个 XML 文件！MyBatis 启动时自然报错。</p>
<p><strong>解决方案</strong>：
如果你非要这么放，必须在 <code>pom.xml</code> 中配置资源过滤，告诉 Maven：“别忽略我的 XML！”</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">build</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">resources</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">resource</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">directory</span>&gt;</span>src/main/java<span class="hljs-tag">&lt;/<span class="hljs-name">directory</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">includes</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">include</span>&gt;</span>**/*.xml<span class="hljs-tag">&lt;/<span class="hljs-name">include</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">includes</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">resource</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">resource</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">directory</span>&gt;</span>src/main/resources<span class="hljs-tag">&lt;/<span class="hljs-name">directory</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">resource</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">resources</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">build</span>&gt;</span>
</code></pre>
<h2 data-id="heading-9">四、 所谓的 Classpath 到底是什么？</h2>
<p>理解了目录映射，Classpath 的概念就迎刃而解了。</p>
<p>在 Spring 或 Java 中，当我们说 <code>classpath:</code> 时，指的就是 <strong>打包后的 JAR 包根目录</strong>（或者在 IDE 开发时，指的是 <code>target/classes</code> 目录）。</p>
<ul>
<li><code>classpath:application.yml</code> -&gt; 去 JAR 包根目录找。</li>
<li><code>classpath:com/demo/User.class</code> -&gt; 去 JAR 包根目录下的 com/demo 找。</li>
</ul>
<h2 data-id="heading-10">五、 动手验证（Show me the code）</h2>
<p>不要只听我说，建议你自己动手验证一下，印象会更深：</p>
<ol>
<li>找一个 Maven 项目，执行命令 <code>mvn package</code>。</li>
<li>进入项目的 <code>target</code> 目录。</li>
<li>找到生成的 <code>.jar</code> 文件。</li>
<li><strong>把后缀名从 <code>.jar</code> 改成 <code>.zip</code>，然后解压它！</strong></li>
</ol>
<p>打开解压后的文件夹，你会发现，所谓的“神秘”目录结构，其实就是你 <code>src/main/java</code> 和 <code>src/main/resources</code> 里的东西合并在一起了而已。</p>
<hr/>
<blockquote>
<p><strong>结语</strong>：
技术没有黑魔法，一切看似复杂的问题，背后往往都是简单的文件操作和路径映射。希望这篇文章能帮你彻底搞懂 Maven 的目录结构，以后的开发之路上少踩几个坑！</p>
</blockquote>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Java Stream.filter 全面解析：定义、原理与最常见使用场景]]></title>    <link>https://juejin.cn/post/7577690150093865000</link>    <guid>https://juejin.cn/post/7577690150093865000</guid>    <pubDate>2025-11-30T09:25:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577690150093865000" data-draft-id="7577795545440239650" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Java Stream.filter 全面解析：定义、原理与最常见使用场景"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-30T09:25:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="木木一直在哭泣"/> <meta itemprop="url" content="https://juejin.cn/user/3896324937225085"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Java Stream.filter 全面解析：定义、原理与最常见使用场景
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3896324937225085/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    木木一直在哭泣
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T09:25:13.000Z" title="Sun Nov 30 2025 09:25:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Java Stream.filter 全面解析：定义、原理与最常见使用场景</h2>
<p><code>filter</code> 是 Java Stream 最常用、也最容易理解错的操作之一。它看似简单——“过滤元素”——但底层机制、函数式定义、实际使用场景都值得深入理解。</p>
<p>本篇文章将从 <strong>函数定义 → 底层原理 → 使用场景 → 注意事项</strong>，系统地讲透 <code>filter</code>。</p>
<hr/>
<h2 data-id="heading-1">一、filter 的函数定义是什么？</h2>
<p>Java Stream 中的 <code>filter</code> 定义如下：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-type">Stream</span>&lt;<span class="hljs-type">T</span>&gt; filter(<span class="hljs-type">Predicate</span>&lt;? <span class="hljs-keyword">super</span> <span class="hljs-type">T</span>&gt; predicate)
</code></pre>
<p>把它拆开解释：</p>





















<table><thead><tr><th>部分</th><th>含义</th></tr></thead><tbody><tr><td><code>Stream&lt;T&gt;</code></td><td>输入是 T 类型流，输出仍然是 T 类型流</td></tr><tr><td><code>filter(...)</code></td><td>执行过滤操作</td></tr><tr><td><code>Predicate&lt;? super T&gt;</code></td><td>一个返回 boolean 的判断函数</td></tr></tbody></table>
<h4 data-id="heading-2">✔ filter 的本质：<strong>保留满足条件的元素，丢掉不满足的。</strong></h4>
<p><code>Predicate</code> 是一个函数接口：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-function"><span class="hljs-type">boolean</span> <span class="hljs-title">test</span><span class="hljs-params">(T t)</span></span>;
</code></pre>
<p>你只需要告诉 <code>filter</code>：</p>
<p>✔ <strong>这个元素要不要留下？</strong></p>
<ul>
<li>返回 <code>true</code>：保留</li>
<li>返回 <code>false</code>：丢弃</li>
</ul>
<hr/>
<h2 data-id="heading-3">二、filter 的底层执行原理</h2>
<p>要真正理解 filter 的行为，需要理解 <strong>Stream 的流水线（Pipeline）模型</strong> 和 <strong>惰性求值（Lazy Evaluation）</strong> 。</p>
<p>下面我把整个底层机制按“从源码角度也能看懂”的方式讲清楚。</p>
<hr/>
<h3 data-id="heading-4">1. Stream 是一条流水线（pipeline）</h3>
<p>当你写：</p>
<pre><code class="hljs language-python" lang="python">stream.<span class="hljs-built_in">filter</span>(x -&gt; x &gt; <span class="hljs-number">10</span>).<span class="hljs-built_in">map</span>(x -&gt; x * <span class="hljs-number">2</span>).<span class="hljs-built_in">sorted</span>()
</code></pre>
<p>其实底层不是立刻执行，而是构建出一条“操作链”：</p>
<pre><code class="hljs language-css" lang="css">StreamSource → <span class="hljs-attribute">Filter</span> → Map → Sorted → TerminalOp
</code></pre>
<p>每个操作都只是往链上“挂一个步骤”，<strong>没有真正处理任何数据</strong>。</p>
<hr/>
<h3 data-id="heading-5">2. filter 不会“过滤掉元素”，它只是包装一个 Predicate</h3>
<p>底层并不创建新集合，也不删除原集合元素。</p>
<p>它做的是：</p>
<blockquote>
<p><strong>把你的 Predicate 包装成一个用于判断的处理器（Sink）放入流水线中。</strong></p>
</blockquote>
<p>底层结构可以简化理解为：</p>
<pre><code class="hljs language-scss" lang="scss">if (predicate.test(element))
    <span class="hljs-built_in">pushToNextStep</span>(element)
else
    drop element
</code></pre>
<p>每个元素会沿着流水线向下传递，直到某个步骤决定丢弃它。</p>
<p>filter 就是这样的“拦截器（Interceptor）”。</p>
<hr/>
<h3 data-id="heading-6">3. 真正的执行是在终止操作（Terminal Operation）触发的</h3>
<p>例如：</p>
<pre><code class="hljs language-scss" lang="scss">stream<span class="hljs-selector-class">.filter</span>(...)<span class="hljs-selector-class">.map</span>(...)<span class="hljs-selector-class">.toList</span>();
</code></pre>
<p>当 <code>toList()</code> 被调用时，Stream 才开始：</p>
<ol>
<li>从数据源（List、数组……）逐个取元素</li>
<li>把元素交给 filter 判断</li>
<li>满足条件则传递到 map</li>
<li>再传递给最终的收集操作（collector）</li>
</ol>
<hr/>
<h3 data-id="heading-7">4. 底层执行顺序是“逐个元素完整走链路”，而不是“一个操作处理完再下一个”</h3>
<p>例如：</p>
<pre><code class="hljs language-scss" lang="scss">List<span class="hljs-selector-class">.of</span>(<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>)
    <span class="hljs-selector-class">.stream</span>()
    <span class="hljs-selector-class">.filter</span>(x -&gt; x % <span class="hljs-number">2</span> == <span class="hljs-number">0</span>)
    <span class="hljs-selector-class">.map</span>(x -&gt; x * <span class="hljs-number">10</span>)
    <span class="hljs-selector-class">.toList</span>();
</code></pre>
<p>执行流程不是：</p>
<pre><code class="hljs language-arduino" lang="arduino">先过滤所有 → 再 map 所有
</code></pre>
<p>而是：</p>
<h4 data-id="heading-8">✔ 实际执行方式（逐个流动）：</h4>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-number">1</span> → <span class="hljs-attribute">filter</span>(丢弃)
<span class="hljs-number">2</span> → <span class="hljs-attribute">filter</span>(通过) → map → 收集
<span class="hljs-number">3</span> → <span class="hljs-attribute">filter</span>(丢弃)
<span class="hljs-number">4</span> → <span class="hljs-attribute">filter</span>(通过) → map → 收集
</code></pre>
<p><strong>每个元素都是从头到尾完整走一遍流水线</strong>。</p>
<p>这就是为什么 Stream 只需要“一次遍历”，效率高的原因。</p>
<hr/>
<h3 data-id="heading-9">5. filter 在多步骤流水线中的位置非常关键</h3>
<p>它越靠前，性能越高。</p>
<p>例如：</p>
<pre><code class="hljs language-scss" lang="scss">stream<span class="hljs-selector-class">.filter</span>(...)   <span class="hljs-comment">// 过滤掉大量不需要的数据</span>
      <span class="hljs-selector-class">.map</span>(...)      <span class="hljs-comment">// 只对少量数据做 map</span>
      <span class="hljs-selector-class">.sorted</span>();     <span class="hljs-comment">// 排序的数据更少</span>
</code></pre>
<p>如果你把 filter 放在后面：</p>
<pre><code class="hljs language-scss" lang="scss">stream<span class="hljs-selector-class">.map</span>(...)
      <span class="hljs-selector-class">.sorted</span>(...)   <span class="hljs-comment">// 排序所有数据（成本高）</span>
      <span class="hljs-selector-class">.filter</span>(...);
</code></pre>
<p>性能会显著下降，因为 map、sorted 都处理了大量本该被过滤掉的元素。</p>
<hr/>
<h3 data-id="heading-10">6. 底层真正调用的是一个叫 Sink 的组件</h3>
<p>Java 会为每个中间操作创建一个 Sink，比如：</p>
<ul>
<li>FilterSink</li>
<li>MapSink</li>
<li>SortedSink</li>
</ul>
<p>FilterSink 的核心代码类似：</p>
<pre><code class="hljs language-scss" lang="scss">public void <span class="hljs-built_in">accept</span>(T element) {
    if (predicate.test(element)) {
        downstream<span class="hljs-selector-class">.accept</span>(element);
    }
}
</code></pre>
<p>解释：</p>
<ul>
<li>predicate = 你的过滤函数</li>
<li>downstream = 下一个操作（map、sorted、collect…）</li>
</ul>
<p>只要 predicate 为 true，就把元素推给下一个 Sink。否则丢弃。</p>
<hr/>
<p><strong>简单一句话总结底层执行原理：</strong></p>
<blockquote>
<p>filter 并不会修改数据，它是把 predicate 包装成一个“判断关卡”，元素在流水线经过这个关卡时被决定“留下还是丢弃”。真正执行在终止操作触发时逐元素进行。</p>
</blockquote>
<hr/>
<h2 data-id="heading-11">三、filter 的典型使用方式</h2>
<p>下面是实际开发中最常见、最有代表性的场景。</p>
<h3 data-id="heading-12">1. 过滤年龄大于 18 岁用户</h3>
<pre><code class="hljs language-ini" lang="ini">List&lt;User&gt; <span class="hljs-attr">adults</span> = users.stream()
        .filter(u -&gt; u.getAge() &gt; 18)
        .toList()<span class="hljs-comment">;</span>
</code></pre>
<hr/>
<h3 data-id="heading-13">2. 过滤非空字符串</h3>
<pre><code class="hljs language-ini" lang="ini">List&lt;String&gt; <span class="hljs-attr">list</span> = strs.stream()
        .filter(s -&gt; s != null &amp;&amp; !s.isEmpty())
        .toList()<span class="hljs-comment">;</span>
</code></pre>
<p>常见写法：</p>
<pre><code class="hljs language-vbscript" lang="vbscript">.<span class="hljs-built_in">filter</span>(Objects::nonNull)
.<span class="hljs-built_in">filter</span>(s -&gt; !s.<span class="hljs-built_in">isEmpty</span>())
</code></pre>
<hr/>
<h3 data-id="heading-14">3. 过滤偶数</h3>
<pre><code class="hljs language-ini" lang="ini">List&lt;Integer&gt; <span class="hljs-attr">evens</span> = nums.stream()
        .filter(n -&gt; n % <span class="hljs-attr">2</span> == <span class="hljs-number">0</span>)
        .toList()<span class="hljs-comment">;</span>
</code></pre>
<hr/>
<h3 data-id="heading-15">4. 多条件过滤（业务常见）</h3>
<pre><code class="hljs language-scss" lang="scss">List&lt;<span class="hljs-attribute">Order</span>&gt; validOrders = orders<span class="hljs-selector-class">.stream</span>()
        <span class="hljs-selector-class">.filter</span>(o -&gt; o.getStatus()<span class="hljs-selector-class">.equals</span>("PAID"))
        <span class="hljs-selector-class">.filter</span>(o -&gt; o.getAmount()<span class="hljs-selector-class">.compareTo</span>(BigDecimal.ZERO) &gt; <span class="hljs-number">0</span>)
        <span class="hljs-selector-class">.filter</span>(o -&gt; o.getCustomerName() != null)
        <span class="hljs-selector-class">.toList</span>();
</code></pre>
<p>多条件拆成多行，可读性更强。</p>
<hr/>
<h3 data-id="heading-16">5. 过滤 null 字段（实体属性过滤）</h3>
<pre><code class="hljs language-ini" lang="ini">List&lt;User&gt; <span class="hljs-attr">withPhone</span> = users.stream()
        .filter(u -&gt; u.getPhone() != null)
        .toList()<span class="hljs-comment">;</span>
</code></pre>
<hr/>
<h3 data-id="heading-17">6. 按关键字过滤字符串</h3>
<pre><code class="hljs language-ini" lang="ini">List&lt;String&gt; <span class="hljs-attr">result</span> = list.stream()
        .filter(s -&gt; s.contains("Java"))
        .toList()<span class="hljs-comment">;</span>
</code></pre>
<hr/>
<h3 data-id="heading-18">7. 去空、去重后的过滤</h3>
<pre><code class="hljs language-css" lang="css">List&lt;String&gt; cleaned = list<span class="hljs-selector-class">.stream</span>()
        <span class="hljs-selector-class">.filter</span>(Objects::nonNull)
        .<span class="hljs-built_in">filter</span>(s -&gt; !s.<span class="hljs-built_in">isBlank</span>())
        .<span class="hljs-built_in">distinct</span>()
        .<span class="hljs-built_in">toList</span>();
</code></pre>
<hr/>
<h3 data-id="heading-19">8. 过滤以大写字母开头的字符串</h3>
<pre><code class="hljs language-ini" lang="ini">List&lt;String&gt; <span class="hljs-attr">upper</span> = list.stream()
        .filter(s -&gt; Character.isUpperCase(s.charAt(0)))
        .toList()<span class="hljs-comment">;</span>
</code></pre>
<hr/>
<h3 data-id="heading-20">9. 查询参数合法性过滤</h3>
<p>常用于后端搜索条件校验：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.filter</span>(<span class="hljs-selector-tag">p</span> -&gt; <span class="hljs-selector-tag">p</span><span class="hljs-selector-class">.getQuery</span>() != null)
<span class="hljs-selector-class">.filter</span>(<span class="hljs-selector-tag">p</span> -&gt; !<span class="hljs-selector-tag">p</span><span class="hljs-selector-class">.getQuery</span>()<span class="hljs-selector-class">.isBlank</span>())
<span class="hljs-selector-class">.filter</span>(<span class="hljs-selector-tag">p</span> -&gt; <span class="hljs-selector-tag">p</span><span class="hljs-selector-class">.getPageSize</span>() &gt; <span class="hljs-number">0</span>)
</code></pre>
<hr/>
<h2 data-id="heading-21">四、filter 的注意事项（容易踩的坑）</h2>
<h3 data-id="heading-22">❌ 1. filter 内不要写副作用（修改外部状态）</h3>
<pre><code class="hljs language-csharp" lang="csharp">.filter(u -&gt; {
    list.<span class="hljs-keyword">add</span>(u); <span class="hljs-comment">// 副作用，不推荐</span>
    <span class="hljs-keyword">return</span> u.getAge() &gt; <span class="hljs-number">18</span>;
})
</code></pre>
<p>在并行流下会产生线程安全问题，且违背函数式思想。</p>
<hr/>
<h3 data-id="heading-23">❌ 2. filter 的 predicate 不能抛 checked exception</h3>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-class">.filter</span>(u -&gt; <span class="hljs-built_in">doSomething</span>(u)) <span class="hljs-comment">// 如果 doSomething 抛异常，无法编译</span>
</code></pre>
<p>需要自己封装异常处理。</p>
<hr/>
<h3 data-id="heading-24">❌ 3. filter 是惰性的，不会立即过滤</h3>
<p>必须搭配终止操作：</p>
<pre><code class="hljs language-scss" lang="scss">users<span class="hljs-selector-class">.stream</span>()<span class="hljs-selector-class">.filter</span>(...); <span class="hljs-comment">// 什么都不会执行</span>
</code></pre>
<pre><code class="hljs language-scss" lang="scss">users<span class="hljs-selector-class">.stream</span>()<span class="hljs-selector-class">.filter</span>(...)<span class="hljs-selector-class">.toList</span>(); <span class="hljs-comment">// 真正执行过滤</span>
</code></pre>
<hr/>
<h2 data-id="heading-25">五、三句话总结</h2>
<p>✔ <strong>filter = 用 Predicate 判断哪些元素保留。</strong><br/>
✔ <strong>返回 true → 保留；返回 false → 过滤。</strong><br/>
✔ <strong>底层是遍历 + 判断，执行是惰性的。</strong></p>
<p>掌握了这三点，就彻底吃透了 <code>filter</code>。</p>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[简单了解 with]]></title>    <link>https://juejin.cn/post/7577705544876032038</link>    <guid>https://juejin.cn/post/7577705544876032038</guid>    <pubDate>2025-11-30T09:10:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577705544876032038" data-draft-id="7577971299742842918" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="简单了解 with"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2025-11-30T09:10:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="没落英雄"/> <meta itemprop="url" content="https://juejin.cn/user/44420757196632"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            简单了解 with
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/44420757196632/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    没落英雄
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T09:10:56.000Z" title="Sun Nov 30 2025 09:10:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><h2 data-id="heading-0">with 语句详解：使用方法和 this 指向问题</h2>
<h3 data-id="heading-1">目录</h3>
<ol>
<li><a href="#with-%E8%AF%AD%E5%8F%A5%E5%9F%BA%E7%A1%80" title="#with-%E8%AF%AD%E5%8F%A5%E5%9F%BA%E7%A1%80">with 语句基础</a></li>
<li><a href="#%E4%BD%9C%E7%94%A8%E5%9F%9F%E9%93%BE%E6%9F%A5%E6%89%BE%E6%9C%BA%E5%88%B6" title="#%E4%BD%9C%E7%94%A8%E5%9F%9F%E9%93%BE%E6%9F%A5%E6%89%BE%E6%9C%BA%E5%88%B6">作用域链查找机制</a></li>
<li><a href="#this-%E6%8C%87%E5%90%91%E9%97%AE%E9%A2%98%E6%A0%B8%E5%BF%83" title="#this-%E6%8C%87%E5%90%91%E9%97%AE%E9%A2%98%E6%A0%B8%E5%BF%83">this 指向问题（核心）</a></li>
<li><a href="#window-%E5%AF%B9%E8%B1%A1%E7%9A%84%E6%8C%87%E5%90%91" title="#window-%E5%AF%B9%E8%B1%A1%E7%9A%84%E6%8C%87%E5%90%91">window 对象的指向</a></li>
<li><a href="#%E5%9C%A8%E5%BE%AE%E5%89%8D%E7%AB%AF%E6%B2%99%E7%AE%B1%E4%B8%AD%E7%9A%84%E5%BA%94%E7%94%A8" title="#%E5%9C%A8%E5%BE%AE%E5%89%8D%E7%AB%AF%E6%B2%99%E7%AE%B1%E4%B8%AD%E7%9A%84%E5%BA%94%E7%94%A8">在微前端沙箱中的应用</a></li>
<li><a href="#%E5%AE%9E%E9%99%85%E4%BB%A3%E7%A0%81%E7%A4%BA%E4%BE%8B" title="#%E5%AE%9E%E9%99%85%E4%BB%A3%E7%A0%81%E7%A4%BA%E4%BE%8B">实际代码示例</a></li>
<li><a href="#%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98%E5%92%8C%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9" title="#%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98%E5%92%8C%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9">常见问题和注意事项</a></li>
<li><a href="#%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5" title="#%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5">最佳实践</a></li>
</ol>
<hr/>
<h3 data-id="heading-2">with 语句基础</h3>
<h4 data-id="heading-3">什么是 with 语句？</h4>
<p><code>with</code> 语句是 JavaScript 的一个特性，它可以将一个对象添加到作用域链的最前端，使得在 <code>with</code> 块内可以直接访问该对象的属性，而不需要使用对象名作为前缀。</p>
<h4 data-id="heading-4">基本语法</h4>
<pre><code class="hljs language-javascript" lang="javascript">
<span class="hljs-keyword">with</span> (object) {
  <span class="hljs-comment">// 在这个块内，可以直接访问 object 的属性</span>
  <span class="hljs-comment">// 不需要写 object.property，直接写 property 即可</span>
}
</code></pre>
<h4 data-id="heading-5">基本示例</h4>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> obj = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">"Alice"</span>,
  <span class="hljs-attr">age</span>: <span class="hljs-number">25</span>,
  <span class="hljs-attr">city</span>: <span class="hljs-string">"Beijing"</span>,
};

<span class="hljs-comment">// 使用 with 语句</span>
<span class="hljs-keyword">with</span> (obj) {
  <span class="hljs-comment">// 可以直接访问 obj 的属性，不需要 obj. 前缀</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(name); <span class="hljs-comment">// 输出: Alice</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(age); <span class="hljs-comment">// 输出: 25</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(city); <span class="hljs-comment">// 输出: Beijing</span>

  <span class="hljs-comment">// 也可以修改属性</span>
  age = <span class="hljs-number">26</span>;
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(age); <span class="hljs-comment">// 输出: 26</span>
}

<span class="hljs-comment">// with 块外，需要正常访问</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(obj.<span class="hljs-property">age</span>); <span class="hljs-comment">// 输出: 26</span>
</code></pre>
<hr/>
<h3 data-id="heading-6">作用域链查找机制</h3>
<h4 data-id="heading-7">查找顺序</h4>
<p>在 <code>with</code> 块内，当访问一个变量时，JavaScript 引擎会按照以下顺序查找：</p>
<ol>
<li><strong>局部变量</strong>（<code>let</code>/<code>const</code>/<code>var</code> 声明的）</li>
<li><strong>with 指定的对象</strong>（<code>with(obj)</code> 中的 <code>obj</code>）</li>
<li><strong>外层作用域</strong></li>
<li><strong>全局作用域</strong></li>
</ol>
<h4 data-id="heading-8">示例：作用域链查找</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> globalVar = <span class="hljs-string">"全局变量"</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">testScope</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> localVar = <span class="hljs-string">"局部变量"</span>;

  <span class="hljs-keyword">const</span> obj = {
    <span class="hljs-attr">objVar</span>: <span class="hljs-string">"对象变量"</span>,
    <span class="hljs-attr">localVar</span>: <span class="hljs-string">"对象中的 localVar"</span>,
  };

  <span class="hljs-keyword">with</span> (obj) {
    <span class="hljs-comment">// 1. 查找局部变量 localVar（在函数作用域中）</span>
    <span class="hljs-comment">// 2. 如果没找到，查找 obj 中的属性</span>
    <span class="hljs-comment">// 3. 如果还没找到，查找外层作用域</span>
    <span class="hljs-comment">// 4. 最后查找全局作用域</span>

    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(localVar); <span class="hljs-comment">// 输出: "局部变量"（优先使用函数作用域的）</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(objVar); <span class="hljs-comment">// 输出: "对象变量"（在 obj 中找到）</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(globalVar); <span class="hljs-comment">// 输出: "全局变量"（在外层作用域找到）</span>
  }
}

<span class="hljs-title function_">testScope</span>();
</code></pre>
<hr/>
<h3 data-id="heading-9">this 指向问题（核心）</h3>
<h4 data-id="heading-10">关键点：this 不受 with 语句影响</h4>
<p><strong>这是最重要的知识点！</strong> <code>this</code> 的指向完全不受 <code>with</code> 语句的影响。</p>
<h4 data-id="heading-11">this 的指向规则</h4>
<p><code>this</code> 的指向遵循 JavaScript 的标准规则：</p>
<ul>
<li><code>this</code> 指向函数调用时的上下文（caller）</li>
<li>在全局作用域中，<code>this</code> 指向全局对象（浏览器中是 <code>window</code>）</li>
<li>在对象方法中，<code>this</code> 指向调用该方法的对象</li>
<li><code>with</code> 语句<strong>不会改变</strong> <code>this</code> 的指向</li>
</ul>
<h4 data-id="heading-12">示例 1：this 在 with 块内的行为</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> obj = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">"Context Object"</span>,
  <span class="hljs-attr">test</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"this.name:"</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>;
  },
};

<span class="hljs-keyword">const</span> sandboxContext = {
  <span class="hljs-attr">window</span>: { <span class="hljs-attr">name</span>: <span class="hljs-string">"Sandbox Window"</span> },
  <span class="hljs-attr">obj</span>: obj,
};

<span class="hljs-comment">// 使用 Function 构造器创建函数（避免严格模式限制）</span>
<span class="hljs-keyword">const</span> func = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Function</span>(
  <span class="hljs-string">"sandboxContext"</span>,
  <span class="hljs-string">`
  with(sandboxContext) {
    // window 指向 sandboxContext.window
    console.log("window.name:", window.name); // 输出: Sandbox Window
    
    // 但是 this 仍然指向全局对象，不受 with 影响
    // 注意：这里的 window 是 sandboxContext.window（代理对象），不是全局 window
    console.log("this === window:", this === window); // 输出: false（this 是全局 window，window 是代理对象）
    console.log("this === sandboxContext.window:", this === sandboxContext.window); // 输出: false
    
    // 调用 obj.test()，this 指向 obj，不是 sandboxContext
    const result = obj.test(); // 输出: this.name: Context Object
    console.log("obj.test() 返回的 this === obj:", result === obj); // 输出: true
  }
  `</span>
);

<span class="hljs-title function_">func</span>(sandboxContext);
</code></pre>
<h4 data-id="heading-13">示例 2：对比 window 和 this</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> proxyWindow = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Proxy</span>(<span class="hljs-variable language_">window</span>, {
  <span class="hljs-title function_">get</span>(<span class="hljs-params">target, prop</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`[Proxy] 读取属性: <span class="hljs-subst">${<span class="hljs-built_in">String</span>(prop)}</span>`</span>);
    <span class="hljs-keyword">return</span> target[prop];
  },
  <span class="hljs-title function_">set</span>(<span class="hljs-params">target, prop, value</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`[Proxy] 设置属性: <span class="hljs-subst">${<span class="hljs-built_in">String</span>(prop)}</span> = <span class="hljs-subst">${value}</span>`</span>);
    target[prop] = value;
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  },
});

<span class="hljs-keyword">const</span> sandboxContext = {
  <span class="hljs-attr">window</span>: proxyWindow,
  <span class="hljs-attr">document</span>: proxyWindow.<span class="hljs-property">document</span>,
  <span class="hljs-attr">console</span>: proxyWindow.<span class="hljs-property">console</span>,
};

<span class="hljs-keyword">const</span> code = <span class="hljs-string">`
  // 在 with 块内，window 指向 sandboxContext.window（即 proxyWindow）
  window.myVar = "hello from sandbox";
  console.log("window.myVar:", window.myVar);
  
  // this 仍然指向全局 window（不受 with 影响）
  // 注意：这里的 window 是 sandboxContext.window（代理对象），不是全局 window
  console.log("this === window:", this === window); // 输出: false（this 是全局 window，window 是代理对象）
  console.log("this === sandboxContext.window:", this === sandboxContext.window); // 输出: false
  
  // 但是代码中的 window 指向 proxyWindow
  console.log("代码中的 window === proxyWindow:", window === sandboxContext.window); // 输出: true
`</span>;

<span class="hljs-keyword">const</span> func = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Function</span>(
  <span class="hljs-string">"sandboxContext"</span>,
  <span class="hljs-string">`
  with(sandboxContext) {
    <span class="hljs-subst">${code}</span>
  }
  `</span>
);

<span class="hljs-title function_">func</span>(sandboxContext);
</code></pre>
<h4 data-id="heading-14">为什么 this 不受影响？</h4>
<p><code>this</code> 是 JavaScript 的一个特殊关键字，它的值在函数调用时确定，与作用域链无关。<code>with</code> 语句只影响作用域链的查找，不会影响 <code>this</code> 的绑定。</p>
<h4 data-id="heading-15">重要区别：window 和 this 在 with 块内</h4>
<p>在 <code>with(sandboxContext)</code> 块内，需要理解以下关键区别：</p>
<ol>
<li>
<p><strong><code>window</code> 的指向</strong>：</p>
<ul>
<li><code>window</code> 会指向 <code>sandboxContext.window</code>（代理对象）</li>
<li>这是通过作用域链查找实现的</li>
</ul>
</li>
<li>
<p><strong><code>this</code> 的指向</strong>：</p>
<ul>
<li><code>this</code> 仍然指向全局对象（不受 <code>with</code> 影响）</li>
<li>这是 JavaScript 的 <code>this</code> 绑定机制决定的</li>
</ul>
</li>
<li>
<p><strong>因此</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">with</span> (sandboxContext) {
  <span class="hljs-comment">// window 是 sandboxContext.window（代理对象）</span>
  <span class="hljs-comment">// this 是全局 window</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span> === <span class="hljs-variable language_">window</span>); <span class="hljs-comment">// false（它们不相等！）</span>
}
</code></pre>
</li>
</ol>
<p><strong>关键理解</strong>：</p>
<ul>
<li><code>window</code> 标识符通过作用域链查找，在 <code>sandboxContext</code> 中找到，所以指向代理对象</li>
<li><code>this</code> 关键字不受作用域链影响，仍然指向全局对象</li>
<li>这就是为什么在微前端沙箱中，代码里的 <code>window</code> 可以指向代理对象，但 <code>this</code> 仍然指向全局对象</li>
</ul>
<hr/>
<h3 data-id="heading-16">window 对象的指向</h3>
<h4 data-id="heading-17">关键机制</h4>
<p>在微前端沙箱实现中，<code>with</code> 语句的核心作用是<strong>替换 <code>window</code> 对象的引用</strong>。</p>
<h4 data-id="heading-18">为什么不能直接用 <code>with(proxyWindow)</code>？</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ❌ 错误的方式</span>
<span class="hljs-keyword">const</span> proxyWindow = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Proxy</span>(<span class="hljs-variable language_">window</span>, {
  <span class="hljs-comment">/* ... */</span>
});
<span class="hljs-keyword">with</span> (proxyWindow) {
  <span class="hljs-variable language_">window</span>.<span class="hljs-property">myVar</span> = <span class="hljs-string">"hello"</span>; <span class="hljs-comment">// window 会去外层作用域查找，找到全局 window</span>
}
</code></pre>
<p><strong>问题</strong>：如果直接使用 <code>with(proxyWindow)</code>，代码中的 <code>window</code> 标识符会去外层作用域查找，找到全局的 <code>window</code> 对象，而不是 <code>proxyWindow</code>。</p>
<h4 data-id="heading-19">正确的做法</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ✅ 正确的方式</span>
<span class="hljs-keyword">const</span> proxyWindow = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Proxy</span>(<span class="hljs-variable language_">window</span>, {
  <span class="hljs-comment">/* ... */</span>
});

<span class="hljs-comment">// 创建一个包含 window 属性的上下文对象</span>
<span class="hljs-keyword">const</span> sandboxContext = {
  <span class="hljs-attr">window</span>: proxyWindow, <span class="hljs-comment">// 关键：将 proxyWindow 作为 window 属性</span>
  <span class="hljs-attr">document</span>: proxyWindow.<span class="hljs-property">document</span>,
  <span class="hljs-attr">console</span>: proxyWindow.<span class="hljs-property">console</span>,
};

<span class="hljs-keyword">with</span> (sandboxContext) {
  <span class="hljs-comment">// 现在 window 会在 sandboxContext 中查找</span>
  <span class="hljs-comment">// 找到 sandboxContext.window（即 proxyWindow）</span>
  <span class="hljs-variable language_">window</span>.<span class="hljs-property">myVar</span> = <span class="hljs-string">"hello"</span>; <span class="hljs-comment">// 实际访问的是 proxyWindow.myVar</span>
}
</code></pre>
<h4 data-id="heading-20">执行流程</h4>
<pre><code class="hljs language-ts" lang="ts">子应用代码: <span class="hljs-variable language_">window</span>.<span class="hljs-property">myVar</span> = <span class="hljs-string">'hello'</span>
       ↓
sandboxContext = { <span class="hljs-attr">window</span>: proxyWindow }
<span class="hljs-title function_">with</span>(<span class="hljs-params">sandboxContext</span>) { <span class="hljs-variable language_">window</span>.<span class="hljs-property">myVar</span> = <span class="hljs-string">'hello'</span> }
       ↓
代码中的 <span class="hljs-variable language_">window</span> 在 sandboxContext 中查找
找到 sandboxContext.<span class="hljs-property">window</span>（即代理对象 proxyWindow）
       ↓
访问 proxyWindow.<span class="hljs-property">myVar</span>，触发 <span class="hljs-title class_">Proxy</span> 的 set 拦截器
       ↓
值被写入 fakeWindow.<span class="hljs-property">myVar</span>，而不是真实的 <span class="hljs-variable language_">window</span>
</code></pre>
<hr/>
<h3 data-id="heading-21">在微前端沙箱中的应用</h3>
<h4 data-id="heading-22">完整的沙箱实现</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">WindowProxySandbox</span> {
  private <span class="hljs-attr">proxy</span>: <span class="hljs-title class_">Window</span>;
  private <span class="hljs-attr">fakeWindow</span>: <span class="hljs-title class_">Record</span>&lt;string, any&gt; = {};
  private updatedValueSet = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>&lt;string&gt;();

  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">fakeWindow</span> = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">create</span>(<span class="hljs-literal">null</span>);

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">proxy</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Proxy</span>(<span class="hljs-variable language_">window</span>, {
      <span class="hljs-attr">get</span>: <span class="hljs-function">(<span class="hljs-params">_target: Window, prop: string</span>) =&gt;</span> {
        <span class="hljs-comment">// 如果属性在 fakeWindow 中存在，优先返回 fakeWindow 的值</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">updatedValueSet</span>.<span class="hljs-title function_">has</span>(prop)) {
          <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">fakeWindow</span>[prop];
        }
        <span class="hljs-comment">// 否则返回原始 window 的值</span>
        <span class="hljs-keyword">return</span> (<span class="hljs-variable language_">window</span> <span class="hljs-keyword">as</span> any)[prop];
      },

      <span class="hljs-attr">set</span>: <span class="hljs-function">(<span class="hljs-params">_target: Window, prop: string, value: any</span>) =&gt;</span> {
        <span class="hljs-comment">// 所有修改都记录到 fakeWindow 中</span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">fakeWindow</span>[prop] = value;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">updatedValueSet</span>.<span class="hljs-title function_">add</span>(prop);
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
      },

      <span class="hljs-attr">has</span>: <span class="hljs-function">(<span class="hljs-params">_target: Window, prop: string</span>) =&gt;</span> {
        <span class="hljs-keyword">return</span> prop <span class="hljs-keyword">in</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">fakeWindow</span> || prop <span class="hljs-keyword">in</span> <span class="hljs-variable language_">window</span>;
      },

      <span class="hljs-attr">deleteProperty</span>: <span class="hljs-function">(<span class="hljs-params">_target: Window, prop: string</span>) =&gt;</span> {
        <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">updatedValueSet</span>.<span class="hljs-title function_">has</span>(prop)) {
          <span class="hljs-keyword">delete</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">fakeWindow</span>[prop];
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">updatedValueSet</span>.<span class="hljs-title function_">delete</span>(prop);
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
      },

      <span class="hljs-attr">ownKeys</span>: <span class="hljs-function">(<span class="hljs-params">_target: Window</span>) =&gt;</span> {
        <span class="hljs-keyword">const</span> originalKeys = <span class="hljs-title class_">Reflect</span>.<span class="hljs-title function_">ownKeys</span>(<span class="hljs-variable language_">window</span>);
        <span class="hljs-keyword">const</span> fakeKeys = <span class="hljs-title class_">Reflect</span>.<span class="hljs-title function_">ownKeys</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">fakeWindow</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>([...originalKeys, ...fakeKeys]));
      },
    });
  }

  <span class="hljs-comment">/**
   * 执行子应用代码（推荐方式）
   */</span>
  <span class="hljs-title function_">execScriptWith</span>(<span class="hljs-attr">script</span>: string): any {
    <span class="hljs-comment">// 创建沙箱上下文，将代理 window 作为属性</span>
    <span class="hljs-keyword">const</span> sandboxContext = {
      <span class="hljs-attr">window</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">proxy</span>,
      <span class="hljs-attr">document</span>: (<span class="hljs-variable language_">this</span>.<span class="hljs-property">proxy</span> <span class="hljs-keyword">as</span> any).<span class="hljs-property">document</span>,
      <span class="hljs-attr">location</span>: (<span class="hljs-variable language_">this</span>.<span class="hljs-property">proxy</span> <span class="hljs-keyword">as</span> any).<span class="hljs-property">location</span>,
      <span class="hljs-attr">console</span>: (<span class="hljs-variable language_">this</span>.<span class="hljs-property">proxy</span> <span class="hljs-keyword">as</span> any).<span class="hljs-property">console</span>,
    };

    <span class="hljs-comment">// 使用 Function 构造器创建函数</span>
    <span class="hljs-keyword">const</span> func = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Function</span>(
      <span class="hljs-string">"sandboxContext"</span>,
      <span class="hljs-string">`
      with(sandboxContext) {
        <span class="hljs-subst">${script}</span>
      }
    `</span>
    );

    <span class="hljs-comment">// 执行函数，传入 sandboxContext</span>
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">func</span>(sandboxContext);
  }

  <span class="hljs-title function_">getProxy</span>(): <span class="hljs-title class_">Window</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">proxy</span>;
  }
}
</code></pre>
<h4 data-id="heading-23">使用示例</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> sandbox = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WindowProxySandbox</span>();

<span class="hljs-comment">// 子应用的代码（模拟从远程加载的代码）</span>
<span class="hljs-keyword">const</span> appCode = <span class="hljs-string">`
  // 子应用代码中直接使用 window，不需要任何修改
  window.myApp = 'sub-app-proxy';
  window.myConfig = { version: '1.0.0', env: 'production' };
  
  // 访问 window 的其他属性也会被代理
  console.log('window.location:', window.location);
  
  // 设置全局变量
  window.globalVar = 'hello from sub app';
`</span>;

<span class="hljs-comment">// 执行子应用代码</span>
sandbox.<span class="hljs-title function_">execScriptWith</span>(appCode);

<span class="hljs-comment">// 验证隔离性</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"代理 window.myApp:"</span>, sandbox.<span class="hljs-title function_">getProxy</span>().<span class="hljs-property">myApp</span>); <span class="hljs-comment">// 输出: sub-app-proxy</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"真实 window.myApp:"</span>, <span class="hljs-variable language_">window</span>.<span class="hljs-property">myApp</span>); <span class="hljs-comment">// 输出: undefined（未被污染）</span>
</code></pre>
<hr/>
<h3 data-id="heading-24">实际代码示例</h3>
<h4 data-id="heading-25">示例 1：基本 with 使用</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">example1_BasicWith</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> obj = {
    <span class="hljs-attr">name</span>: <span class="hljs-string">"Alice"</span>,
    <span class="hljs-attr">age</span>: <span class="hljs-number">25</span>,
    <span class="hljs-attr">city</span>: <span class="hljs-string">"Beijing"</span>,
  };

  <span class="hljs-comment">// 使用 Function 构造器（避免严格模式限制）</span>
  <span class="hljs-keyword">const</span> func = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Function</span>(
    <span class="hljs-string">"obj"</span>,
    <span class="hljs-string">`
    with(obj) {
      // 在 with 块内，可以直接访问 obj 的属性
      console.log("name:", name);        // 输出: Alice
      console.log("age:", age);          // 输出: 25
      console.log("city:", city);        // 输出: Beijing
      
      // 也可以修改属性
      age = 26;
      console.log("修改后的 age:", age); // 输出: 26
    }
    
    // with 块外，需要正常访问
    console.log("with 块外访问:", obj.age); // 输出: 26
  `</span>
  );

  <span class="hljs-title function_">func</span>(obj);
}
</code></pre>
<h4 data-id="heading-26">示例 2：this 指向演示</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">example2_ThisBinding</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> obj = {
    <span class="hljs-attr">name</span>: <span class="hljs-string">"Context Object"</span>,
    <span class="hljs-attr">test</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"this.name:"</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span>);
      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>;
    },
  };

  <span class="hljs-keyword">const</span> sandboxContext = {
    <span class="hljs-attr">window</span>: { <span class="hljs-attr">name</span>: <span class="hljs-string">"Sandbox Window"</span> },
    <span class="hljs-attr">obj</span>: obj,
  };

  <span class="hljs-keyword">const</span> func = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Function</span>(
    <span class="hljs-string">"sandboxContext"</span>,
    <span class="hljs-string">`
    with(sandboxContext) {
      // window 指向 sandboxContext.window
      console.log("window.name:", window.name); // 输出: Sandbox Window
      
      // 但是 this 仍然指向全局对象，不受 with 影响
      // 注意：这里的 window 是 sandboxContext.window（代理对象），不是全局 window
      console.log("this === window:", this === window); // 输出: false（this 是全局 window，window 是代理对象）
      console.log("this === sandboxContext.window:", this === sandboxContext.window); // 输出: false
      
      // 调用 obj.test()，this 指向 obj，不是 sandboxContext
      const result = obj.test(); // 输出: this.name: Context Object
      console.log("obj.test() 返回的 this === obj:", result === obj); // 输出: true
    }
  `</span>
  );

  <span class="hljs-title function_">func</span>(sandboxContext);
}
</code></pre>
<h4 data-id="heading-27">示例 3：微前端沙箱应用</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">example3_MicroFrontendSandbox</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 创建代理 window</span>
  <span class="hljs-keyword">const</span> proxyWindow = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Proxy</span>(<span class="hljs-variable language_">window</span>, {
    <span class="hljs-title function_">get</span>(<span class="hljs-params">target, prop</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`[Proxy] 读取属性: <span class="hljs-subst">${<span class="hljs-built_in">String</span>(prop)}</span>`</span>);
      <span class="hljs-keyword">return</span> target[prop];
    },
    <span class="hljs-title function_">set</span>(<span class="hljs-params">target, prop, value</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`[Proxy] 设置属性: <span class="hljs-subst">${<span class="hljs-built_in">String</span>(prop)}</span> = <span class="hljs-subst">${value}</span>`</span>);
      target[prop] = value;
      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    },
  });

  <span class="hljs-keyword">const</span> sandboxContext = {
    <span class="hljs-attr">window</span>: proxyWindow,
    <span class="hljs-attr">document</span>: proxyWindow.<span class="hljs-property">document</span>,
    <span class="hljs-attr">console</span>: proxyWindow.<span class="hljs-property">console</span>,
  };

  <span class="hljs-keyword">const</span> code = <span class="hljs-string">`
    // 在 with 块内，window 指向 sandboxContext.window（即 proxyWindow）
    window.myVar = "hello from sandbox";
    console.log("window.myVar:", window.myVar);
    
    // this 仍然指向全局 window（不受 with 影响）
    // 注意：这里的 window 是 sandboxContext.window（代理对象），不是全局 window
    console.log("this === window:", this === window); // 输出: false（this 是全局 window，window 是代理对象）
    console.log("this === sandboxContext.window:", this === sandboxContext.window); // 输出: false
    
    // 但是代码中的 window 指向 proxyWindow
    console.log("代码中的 window === proxyWindow:", window === sandboxContext.window); // 输出: true
  `</span>;

  <span class="hljs-keyword">const</span> func = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Function</span>(
    <span class="hljs-string">"sandboxContext"</span>,
    <span class="hljs-string">`
    with(sandboxContext) {
      <span class="hljs-subst">${code}</span>
    }
  `</span>
  );

  <span class="hljs-title function_">func</span>(sandboxContext);

  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"\n验证结果:"</span>);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"proxyWindow.myVar:"</span>, proxyWindow.<span class="hljs-property">myVar</span>);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"真实 window.myVar:"</span>, <span class="hljs-variable language_">window</span>.<span class="hljs-property">myVar</span>);
}
</code></pre>
<h4 data-id="heading-28">示例 4：with 内外对比</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">example4_CompareInsideAndOutside</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> sandboxContext = {
    <span class="hljs-attr">window</span>: { <span class="hljs-attr">name</span>: <span class="hljs-string">"Proxy Window"</span>, <span class="hljs-attr">myVar</span>: <span class="hljs-string">"sandbox value"</span> },
    <span class="hljs-attr">globalVar</span>: <span class="hljs-string">"I'm in sandbox"</span>,
  };

  <span class="hljs-keyword">const</span> func = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Function</span>(
    <span class="hljs-string">"sandboxContext"</span>,
    <span class="hljs-string">`
    // with 块外
    console.log("=== with 块外 ===");
    console.log("window:", typeof window); // 输出: object（全局 window）
    console.log("globalVar:", typeof globalVar); // 输出: undefined（未定义）
    
    // with 块内
    with(sandboxContext) {
      console.log("=== with 块内 ===");
      // window 现在指向 sandboxContext.window
      console.log("window.name:", window.name); // 输出: Proxy Window
      console.log("window.myVar:", window.myVar); // 输出: sandbox value
      
      // globalVar 现在指向 sandboxContext.globalVar
      console.log("globalVar:", globalVar); // 输出: I'm in sandbox
      
      // this 仍然指向全局对象（不受 with 影响）
      // 注意：这里的 window 是 sandboxContext.window（代理对象），不是全局 window
      console.log("this === window:", this === window); // 输出: false（this 是全局 window，window 是代理对象）
      console.log("this === sandboxContext.window:", this === sandboxContext.window); // 输出: false
    }
    
    // with 块外，恢复原状
    console.log("=== with 块外（恢复）===");
    console.log("window:", typeof window); // 输出: object（全局 window）
    console.log("globalVar:", typeof globalVar); // 输出: undefined
  `</span>
  );

  <span class="hljs-title function_">func</span>(sandboxContext);
}
</code></pre>
<hr/>
<h3 data-id="heading-29">常见问题和注意事项</h3>
<h4 data-id="heading-30">1. 严格模式限制</h4>
<p><strong>问题</strong>：<code>with</code> 语句在严格模式下不能直接使用。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-meta">"use strict"</span>;
<span class="hljs-keyword">with</span> (obj) {
  <span class="hljs-comment">// ❌ SyntaxError: Strict mode code may not include a with statement</span>
  <span class="hljs-comment">// ...</span>
}
</code></pre>
<p><strong>解决方案</strong>：使用 <code>Function</code> 构造器动态创建函数（不在严格模式下执行）。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ✅ 正确的方式</span>
<span class="hljs-keyword">const</span> func = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Function</span>(
  <span class="hljs-string">"sandboxContext"</span>,
  <span class="hljs-string">`
  with(sandboxContext) {
    // 代码在这里执行
  }
  `</span>
);
</code></pre>
<h4 data-id="heading-31">2. 性能考虑</h4>
<p><code>with</code> 语句会影响 JavaScript 引擎的优化，因为引擎无法在编译时确定变量的作用域。但在微前端沙箱场景中，这是必要的权衡。</p>
<h4 data-id="heading-32">3. 调试困难</h4>
<p>使用 <code>with</code> 语句会让代码调试变得困难，因为变量的实际来源不明确。建议：</p>
<ul>
<li>添加详细的日志</li>
<li>使用清晰的变量命名</li>
<li>在开发环境中禁用 <code>with</code>，使用其他方式</li>
</ul>
<h4 data-id="heading-33">4. 作用域污染</h4>
<p><code>with</code> 语句会将对象的所有属性添加到作用域链中，可能导致意外的变量覆盖。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> obj = {
  <span class="hljs-attr">console</span>: <span class="hljs-string">"这不是 console 对象"</span>,
  <span class="hljs-attr">log</span>: <span class="hljs-string">"这也不是 log 方法"</span>,
};

<span class="hljs-keyword">with</span> (obj) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"这可能会出错！"</span>); <span class="hljs-comment">// ❌ 因为 console 被覆盖了</span>
}
</code></pre>
<p><strong>解决方案</strong>：只将必要的属性添加到 <code>sandboxContext</code> 中。</p>
<hr/>
<h3 data-id="heading-34">最佳实践</h3>
<h4 data-id="heading-35">1. 始终使用 sandboxContext 对象</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ❌ 错误：不要直接用 with(proxyWindow)</span>
<span class="hljs-keyword">with</span> (proxyWindow) {
  <span class="hljs-variable language_">window</span>.<span class="hljs-property">myVar</span> = <span class="hljs-string">"hello"</span>; <span class="hljs-comment">// window 会去外层作用域查找</span>
}

<span class="hljs-comment">// ✅ 正确：使用 sandboxContext 对象</span>
<span class="hljs-keyword">const</span> sandboxContext = {
  <span class="hljs-attr">window</span>: proxyWindow,
  <span class="hljs-attr">document</span>: proxyWindow.<span class="hljs-property">document</span>,
  <span class="hljs-attr">console</span>: proxyWindow.<span class="hljs-property">console</span>,
};

<span class="hljs-keyword">with</span> (sandboxContext) {
  <span class="hljs-variable language_">window</span>.<span class="hljs-property">myVar</span> = <span class="hljs-string">"hello"</span>; <span class="hljs-comment">// window 指向 sandboxContext.window</span>
}
</code></pre>
<h4 data-id="heading-36">2. 处理全局对象</h4>
<p>除了 <code>window</code>，还要处理其他全局对象：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> sandboxContext = {
  <span class="hljs-attr">window</span>: proxyWindow,
  <span class="hljs-attr">document</span>: proxyWindow.<span class="hljs-property">document</span>,
  <span class="hljs-attr">location</span>: proxyWindow.<span class="hljs-property">location</span>,
  <span class="hljs-attr">console</span>: proxyWindow.<span class="hljs-property">console</span>,
  <span class="hljs-comment">// 根据需要添加其他全局对象</span>
};
</code></pre>
<h4 data-id="heading-37">3. 错误处理</h4>
<p>子应用代码执行可能出错，需要添加错误处理：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">try</span> {
  sandbox.<span class="hljs-title function_">execScriptWith</span>(appCode);
} <span class="hljs-keyword">catch</span> (error) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"执行子应用代码时出错:"</span>, error);
  <span class="hljs-comment">// 记录错误日志，便于调试</span>
}
</code></pre>
<h4 data-id="heading-38">4. 性能优化</h4>
<ul>
<li>避免频繁创建和销毁沙箱</li>
<li>缓存常用的全局对象引用</li>
<li>只在必要时使用 <code>with</code> 语句</li>
</ul>
<h4 data-id="heading-39">5. 兼容性考虑</h4>
<ul>
<li>检查浏览器是否支持 <code>Proxy</code>（现代浏览器都支持）</li>
<li>不支持时降级到快照沙箱（SnapshotSandbox）</li>
</ul>
<h4 data-id="heading-40">6. 安全性</h4>
<ul>
<li>只加载可信的子应用代码</li>
<li>限制子应用访问某些敏感 API</li>
<li>使用 CSP（Content Security Policy）限制代码执行</li>
</ul>
<hr/>
<h3 data-id="heading-41">总结</h3>
<h4 data-id="heading-42">核心要点</h4>
<ol>
<li>
<p><strong>with 语句的作用</strong>：</p>
<ul>
<li>将对象添加到作用域链的最前端</li>
<li>在 <code>with</code> 块内可以直接访问对象的属性</li>
</ul>
</li>
<li>
<p><strong>this 的指向（最重要）</strong>：</p>
<ul>
<li><code>this</code> <strong>不受</strong> <code>with</code> 语句影响</li>
<li><code>this</code> 始终指向函数调用时的上下文</li>
<li>在 <code>with</code> 块内，<code>this</code> 仍然指向原来的对象（通常是全局对象）</li>
</ul>
</li>
<li>
<p><strong>window 的指向</strong>：</p>
<ul>
<li>不能直接用 <code>with(proxyWindow)</code></li>
<li>应该用 <code>sandboxContext = { window: proxyWindow }</code> 然后 <code>with(sandboxContext)</code></li>
<li>这样代码中的 <code>window</code> 会指向 <code>sandboxContext.window</code>（即代理对象）</li>
</ul>
</li>
<li>
<p><strong>作用域链查找顺序</strong>：</p>
<ul>
<li>局部变量 → <code>with</code> 指定的对象 → 外层作用域 → 全局作用域</li>
</ul>
</li>
<li>
<p><strong>实际应用</strong>：</p>
<ul>
<li>微前端沙箱实现的核心机制</li>
<li>通过 <code>with</code> 语句替换 <code>window</code> 引用</li>
<li>结合 <code>Proxy</code> 实现完全隔离</li>
</ul>
</li>
</ol>
<h4 data-id="heading-43">关键代码模式</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 1. 创建代理 window</span>
<span class="hljs-keyword">const</span> proxyWindow = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Proxy</span>(<span class="hljs-variable language_">window</span>, {
  <span class="hljs-comment">/* ... */</span>
});

<span class="hljs-comment">// 2. 创建沙箱上下文</span>
<span class="hljs-keyword">const</span> sandboxContext = {
  <span class="hljs-attr">window</span>: proxyWindow,
  <span class="hljs-attr">document</span>: proxyWindow.<span class="hljs-property">document</span>,
  <span class="hljs-comment">// ... 其他全局对象</span>
};

<span class="hljs-comment">// 3. 使用 with 语句执行代码</span>
<span class="hljs-keyword">const</span> func = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Function</span>(
  <span class="hljs-string">"sandboxContext"</span>,
  <span class="hljs-string">`
  with(sandboxContext) {
    <span class="hljs-subst">${appCode}</span>
  }
  `</span>
);

<span class="hljs-title function_">func</span>(sandboxContext);
</code></pre>
<hr/>
<h3 data-id="heading-44">参考资料</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FJavaScript%2FReference%2FStatements%2Fwith" target="_blank" title="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Statements/with" ref="nofollow noopener noreferrer">MDN: with 语句</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FJavaScript%2FReference%2FOperators%2Fthis" target="_blank" title="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Operators/this" ref="nofollow noopener noreferrer">MDN: this 关键字</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FJavaScript%2FReference%2FGlobal_Objects%2FProxy" target="_blank" title="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Proxy" ref="nofollow noopener noreferrer">MDN: Proxy</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fumijs%2Fqiankun" target="_blank" title="https://github.com/umijs/qiankun" ref="nofollow noopener noreferrer">qiankun 源码</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【收藏级】Java Stream.reduce 全面解析：从零到通透（原理图 + 实战 + 最佳实践）]]></title>    <link>https://juejin.cn/post/7577683422879088674</link>    <guid>https://juejin.cn/post/7577683422879088674</guid>    <pubDate>2025-11-30T09:33:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577683422879088674" data-draft-id="7577713754564116532" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【收藏级】Java Stream.reduce 全面解析：从零到通透（原理图 + 实战 + 最佳实践）"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-30T09:33:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="木木一直在哭泣"/> <meta itemprop="url" content="https://juejin.cn/user/3896324937225085"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【收藏级】Java Stream.reduce 全面解析：从零到通透（原理图 + 实战 + 最佳实践）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3896324937225085/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    木木一直在哭泣
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T09:33:39.000Z" title="Sun Nov 30 2025 09:33:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>想真正学懂 Java Stream，绕不过 <code>reduce</code>。</p>
<p>但现实情况是——绝大多数文章只告诉你：</p>
<blockquote>
<p>reduce 就是“求和、求最大最小”的。</p>
</blockquote>
<p>其实它远远不止这些。</p>
<p><code>reduce</code> 是整个 Stream 体系里<strong>最接近函数式编程灵魂的 API</strong>，也是写优雅聚合逻辑的关键。</p>
<p>这篇文章我会带你：</p>
<ul>
<li>从函数定义弄懂为什么 reduce 要三个参数</li>
<li>通过图解理解 reduce 的折叠原理</li>
<li>串行流 &amp; 并行流真实执行路径</li>
<li>各种实战场景（比 "求和" 有用得多）</li>
<li>常见错误写法（你一定踩过）</li>
<li>最佳实践总结（实际开发最推荐的写法）</li>
</ul>
<p>保证你看完以后，彻底掌握 reduce。</p>
<hr/>
<h2 data-id="heading-0">一、reduce 是什么？一句话理解</h2>
<blockquote>
<p><strong>reduce = 把一堆元素，通过某种规则，折叠成一个值。</strong></p>
</blockquote>
<p>这个“值”可以是：</p>
<ul>
<li>数字</li>
<li>字符串</li>
<li>对象</li>
<li>Map</li>
<li>统计结构</li>
<li>甚至你自定义的任意类型</li>
</ul>
<p>它的本质是数学中的 Fold（折叠）。</p>
<hr/>
<h2 data-id="heading-1">二、reduce 的三个函数定义（最关键的一节）</h2>
<p>Java 提供了 3 种 reduce：</p>
<h3 data-id="heading-2"><strong>① <code>T reduce(T identity, BinaryOperator&lt;T&gt; accumulator)</code></strong></h3>
<p>最常见的版本，带初始值：</p>
<pre><code class="hljs language-css" lang="css">int sum = list<span class="hljs-selector-class">.stream</span>()<span class="hljs-selector-class">.reduce</span>(<span class="hljs-number">0</span>, (<span class="hljs-selector-tag">a</span>, <span class="hljs-selector-tag">b</span>) -&gt; <span class="hljs-selector-tag">a</span> + <span class="hljs-selector-tag">b</span>);
</code></pre>
<p>参数含义：</p>
<ul>
<li><code>identity</code>：初始值（种子）</li>
<li><code>accumulator</code>：折叠规则，将“之前的结果 + 当前元素”合并</li>
</ul>
<p>流程类似：</p>
<pre><code class="hljs language-scss" lang="scss">(((identity ⊕ e1) ⊕ e2) ⊕ e3 ...) ⊕ en
</code></pre>
<hr/>
<h3 data-id="heading-3"><strong>② <code>Optional&lt;T&gt; reduce(BinaryOperator&lt;T&gt; accumulator)</code></strong></h3>
<p>没有 identity，因此 Stream 可能为空 → 返回 Optional。</p>
<p>第一次参与折叠的是前两个元素。</p>
<pre><code class="hljs language-ini" lang="ini">Optional&lt;Integer&gt; <span class="hljs-attr">max</span> = list.stream().reduce(Integer::max)<span class="hljs-comment">;</span>
</code></pre>
<hr/>
<h3 data-id="heading-4"><strong>③ <code>U reduce(U identity, BiFunction&lt;U, T, U&gt; accumulator, BinaryOperator&lt;U&gt; combiner)</code></strong></h3>
<p>最完整的 reduce，专为 <strong>并行流（parallelStream）</strong> 设计。</p>
<p>参数含义：</p>
<ul>
<li>identity：每个线程分片的初始值</li>
<li>accumulator：分片内部如何折叠</li>
<li>combiner：多个分片结果如何合并</li>
</ul>
<pre><code class="hljs language-python" lang="python"><span class="hljs-built_in">int</span> totalLen = <span class="hljs-built_in">list</span>.parallelStream().reduce(
    <span class="hljs-number">0</span>,
    (<span class="hljs-built_in">len</span>, s) -&gt; <span class="hljs-built_in">len</span> + s.length(),
    Integer::<span class="hljs-built_in">sum</span>
);
</code></pre>
<p>这是理解 reduce 真正的关键点。</p>
<hr/>
<h2 data-id="heading-5">三、reduce 的底层原理（图解版）</h2>
<p><code>reduce</code> 的底层思想就是 <strong>折叠（Fold）</strong> 。</p>
<hr/>
<h3 data-id="heading-6">1. 串行 reduce 的完整执行图</h3>
<p>假设 Stream：</p>
<pre><code class="hljs language-csharp" lang="csharp">[<span class="hljs-meta">3, 5, 2</span>]
</code></pre>
<p>identity：<code>0</code><br/>
accumulator：<code>(a, b) -&gt; a + b</code></p>
<h4 data-id="heading-7">执行流程图：</h4>
<pre><code class="hljs language-scss" lang="scss">   identity
       │
       ▼
   <span class="hljs-built_in">acc</span>(<span class="hljs-number">0</span>, <span class="hljs-number">3</span>) = <span class="hljs-number">3</span>
       │
       ▼
   <span class="hljs-built_in">acc</span>(<span class="hljs-number">3</span>, <span class="hljs-number">5</span>) = <span class="hljs-number">8</span>
       │
       ▼
   <span class="hljs-built_in">acc</span>(<span class="hljs-number">8</span>, <span class="hljs-number">2</span>) = <span class="hljs-number">10</span>
       │
       ▼
     最终结果：<span class="hljs-number">10</span>
</code></pre>
<p>你可以理解为：</p>
<blockquote>
<p>结果不是突然产生的，而是一路“折叠、折叠、再折叠”。</p>
</blockquote>
<p>这也是 reduce 名字的含义：<strong>归约 / 折叠</strong>。</p>
<hr/>
<h3 data-id="heading-8">2. 串行流的“单条流水线”结构</h3>
<p>Stream 底层会为 reduce 构建出一个处理链：</p>
<pre><code class="hljs language-python" lang="python">数据源 → <span class="hljs-built_in">map</span>/<span class="hljs-built_in">filter</span>/... → reduce
</code></pre>
<p>每个元素会沿着流水线依次通过所有中间操作，最后进入 reduce 折叠。</p>
<p>图示：</p>
<pre><code class="hljs language-python" lang="python">元素<span class="hljs-number">1</span> → <span class="hljs-built_in">filter</span> → <span class="hljs-built_in">map</span> → reduce
元素<span class="hljs-number">2</span> → <span class="hljs-built_in">filter</span> → <span class="hljs-built_in">map</span> → reduce
元素<span class="hljs-number">3</span> → <span class="hljs-built_in">filter</span> → <span class="hljs-built_in">map</span> → reduce
...
</code></pre>
<p>reduce 是<strong>整个流水线的最后一步</strong>，负责把所有处理过的元素折叠成一个值。</p>
<hr/>
<h3 data-id="heading-9">3. 并行 reduce 的执行图</h3>
<p>假设输入流：</p>
<pre><code class="hljs language-csharp" lang="csharp">[<span class="hljs-meta">1,2,3,4,5,6</span>]
</code></pre>
<p>parallelStream 会把它拆成多个分片（线程并行处理）：</p>
<pre><code class="hljs">分片1：1, 2
分片2：3, 4
分片3：5, 6
</code></pre>
<p>每个分片独立执行 accumulator：</p>
<pre><code class="hljs language-scss" lang="scss">分片<span class="hljs-number">1</span>：<span class="hljs-built_in">acc</span>(acc(identity,<span class="hljs-number">1</span>),<span class="hljs-number">2</span>) → r1
分片<span class="hljs-number">2</span>：<span class="hljs-built_in">acc</span>(acc(identity,<span class="hljs-number">3</span>),<span class="hljs-number">4</span>) → r2
分片<span class="hljs-number">3</span>：<span class="hljs-built_in">acc</span>(acc(identity,<span class="hljs-number">5</span>),<span class="hljs-number">6</span>) → r3
</code></pre>
<p>得到三个局部结果后，使用 combiner 进行最终归并：</p>
<pre><code class="hljs language-scss" lang="scss">         r1
          │
          ▼
 <span class="hljs-built_in">combiner</span>(r1, r2) → r12
          │
          ▼
 <span class="hljs-built_in">combiner</span>(r12, r3) → finalResult
</code></pre>
<p>完整 ASCII 图如下：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-code">          ┌────────────┐
元素 1,2  →│  分片1线程  │→ r1
          └────────────┘
          ┌────────────┐
元素 3,4  →│  分片2线程  │→ r2
          └────────────┘
          ┌────────────┐
元素 5,6  →│  分片3线程  │→ r3
          └────────────┘
</span>
<span class="hljs-code">      ┌────────── combiner ───────────┐
      ▼                                ▼
    r1,r2 → combiner(r1,r2) → r12  +   r3
      ▼                                ▼
      └──────────→ final ─────────────┘
</span></code></pre>
<p>并行 reduce 的关键是：</p>
<h4 data-id="heading-10">⚠ identity 在每个线程都会用到一次！</h4>
<p>这是很多人踩坑的地方，例如：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">parallelStream</span>()<span class="hljs-selector-class">.reduce</span>(<span class="hljs-number">10</span>, Integer::sum);
</code></pre>
<p>10 会被加 <strong>多次</strong>，导致结果错误。</p>
<hr/>
<h3 data-id="heading-11">4. reduce 的执行本质图（核心记忆版）</h3>
<p>把 reduce 的过程浓缩成一个图：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">identity</span> ──► acc ──► acc ──► acc ──► ... ──► <span class="hljs-keyword">final</span>
                ▲        ▲        ▲
              元素<span class="hljs-number">1</span>    元素<span class="hljs-number">2</span>    元素<span class="hljs-number">3</span>
</code></pre>
<p>只需要记住：</p>
<blockquote>
<p>reduce 从 identity 开始，每遇到一个元素，就调用一次 accumulator，把它“折叠”进去。</p>
</blockquote>
<hr/>
<h2 data-id="heading-12">四、为什么 reduce 可以完成复杂聚合（原理图解释）</h2>
<p>reduce 并不限制返回类型。只要 accumulator 返回同一个类型，你就能折叠：</p>
<ul>
<li>数字</li>
<li>字符串</li>
<li>List</li>
<li>Map</li>
<li>自定义对象（统计对象）</li>
</ul>
<p>构建统计对象的执行图：</p>
<p>假设有：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">users</span> = [u1, u2, u3]
<span class="hljs-attr">identity</span> = 空统计对象
</code></pre>
<p>进行聚合：</p>
<pre><code class="hljs language-scss" lang="scss">stat0  <span class="hljs-attr">--acc</span>(u1)--&gt; stat1
stat1  <span class="hljs-attr">--acc</span>(u2)--&gt; stat2
stat2  <span class="hljs-attr">--acc</span>(u3)--&gt; stat3
</code></pre>
<p>图示：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">stat</span>(identity)
   │
   ▼
<span class="hljs-built_in">acc</span>(stat,u1)
   │
   ▼
<span class="hljs-built_in">acc</span>(stat,u2)
   │
   ▼
<span class="hljs-built_in">acc</span>(stat,u3)
   │
   ▼
最终统计结构
</code></pre>
<p>这就是为什么 reduce 是聚合类操作的核心。</p>
<hr/>
<h2 data-id="heading-13">四、并行流（parallelStream）时 reduce 的真实运行方式</h2>
<p>假设流是：</p>
<pre><code class="hljs language-csharp" lang="csharp">[<span class="hljs-meta">1,2,3,4,5,6</span>]
</code></pre>
<p>parallelStream 会切成多个分片（线程 A/B/C…）：</p>
<pre><code class="hljs language-css" lang="css">线程<span class="hljs-selector-tag">A</span>：<span class="hljs-number">1</span>,<span class="hljs-number">2</span>
线程<span class="hljs-selector-tag">B</span>：<span class="hljs-number">3</span>,<span class="hljs-number">4</span>
线程C：<span class="hljs-number">5</span>,<span class="hljs-number">6</span>
</code></pre>
<p>每个线程独立执行 accumulator：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-selector-tag">A</span> → <span class="hljs-built_in">acc</span>(acc(identity,<span class="hljs-number">1</span>),<span class="hljs-number">2</span>)
<span class="hljs-selector-tag">B</span> → <span class="hljs-built_in">acc</span>(acc(identity,<span class="hljs-number">3</span>),<span class="hljs-number">4</span>)
C → <span class="hljs-built_in">acc</span>(acc(identity,<span class="hljs-number">5</span>),<span class="hljs-number">6</span>)
</code></pre>
<p>得到局部结果：</p>
<pre><code class="hljs">ra, rb, rc
</code></pre>
<p>然后 combiner 负责把它们合并：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">final</span> = combiner( combiner(ra, rb), rc )
</code></pre>
<p>因此：</p>
<p>⚠ <strong>identity 会被每个线程使用一次，而不是只用一次！</strong></p>
<p>例如：</p>
<pre><code class="hljs language-css" lang="css">parallelStream()<span class="hljs-selector-class">.reduce</span>(<span class="hljs-number">10</span>, (<span class="hljs-selector-tag">a</span>,<span class="hljs-selector-tag">b</span>)-&gt;<span class="hljs-selector-tag">a</span>+<span class="hljs-selector-tag">b</span>)
</code></pre>
<p>10 会被多次加进去 → 结果错误。</p>
<p>这是 reduce 最常见的坑。</p>
<hr/>
<h2 data-id="heading-14">五、reduce 的最强 8 大实战场景</h2>
<p>下面这些才是实际项目中真正有用的 reduce 用法，不是教科书级别的求和实例。</p>
<h3 data-id="heading-15">1. 求和（教科书但最常用）</h3>
<pre><code class="hljs language-ini" lang="ini">int <span class="hljs-attr">sum</span> = list.stream().reduce(<span class="hljs-number">0</span>, Integer::sum)<span class="hljs-comment">;</span>
</code></pre>
<hr/>
<h3 data-id="heading-16">2. 求最大值 / 最小值</h3>
<pre><code class="hljs language-ini" lang="ini">Optional&lt;Integer&gt; <span class="hljs-attr">max</span> = list.stream().reduce(Integer::max)<span class="hljs-comment">;</span>
Optional&lt;Integer&gt; <span class="hljs-attr">min</span> = list.stream().reduce(Integer::min)<span class="hljs-comment">;</span>
</code></pre>
<hr/>
<h3 data-id="heading-17">3. 统计字符串总长度</h3>
<pre><code class="hljs language-ini" lang="ini">int <span class="hljs-attr">len</span> = list.stream().reduce(
    0,
    (acc, s) -&gt; acc + s.length(),
    Integer::sum
)<span class="hljs-comment">;</span>
</code></pre>
<hr/>
<h3 data-id="heading-18">4. 构建统计对象（超常用）</h3>
<p>比如统计用户年龄总和与数量：</p>
<pre><code class="hljs language-ini" lang="ini">class Stat {
    int totalAge<span class="hljs-comment">;</span>
    int count<span class="hljs-comment">;</span>
}

Stat <span class="hljs-attr">stat</span> = users.stream().reduce(
    new Stat(),
    (s, u) -&gt; {
        s.totalAge += u.getAge()<span class="hljs-comment">;</span>
        s.count++<span class="hljs-comment">;</span>
        return s<span class="hljs-comment">;</span>
    },
    (s1, s2) -&gt; {
        s1.totalAge += s2.totalAge<span class="hljs-comment">;</span>
        s1.count += s2.count<span class="hljs-comment">;</span>
        return s1<span class="hljs-comment">;</span>
    }
)<span class="hljs-comment">;</span>
</code></pre>
<p>这是企业项目里非常常见的写法。</p>
<hr/>
<h3 data-id="heading-19">5. 用 reduce 把 List 扁平化（不推荐但可做）</h3>
<pre><code class="hljs language-scss" lang="scss">List&lt;Integer&gt; merged = lists<span class="hljs-selector-class">.stream</span>()<span class="hljs-selector-class">.reduce</span>(
    new ArrayList&lt;&gt;(),
    (acc, list) -&gt; { acc<span class="hljs-selector-class">.addAll</span>(list); return acc; },
    (acc1, acc2) -&gt; { acc1<span class="hljs-selector-class">.addAll</span>(acc2); return acc1; }
);
</code></pre>
<p>虽然可行，但实际推荐：</p>
<pre><code class="hljs language-scss" lang="scss">lists<span class="hljs-selector-class">.stream</span>()<span class="hljs-selector-class">.flatMap</span>(Collection::stream)<span class="hljs-selector-class">.toList</span>();
</code></pre>
<hr/>
<h3 data-id="heading-20">6. 统计出现次数（某字段频率）</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-built_in">int</span> count = <span class="hljs-built_in">list</span>.stream()
    .<span class="hljs-built_in">filter</span>(s -&gt; s.equals(<span class="hljs-string">"apple"</span>))
    .reduce(<span class="hljs-number">0</span>, (acc, s) -&gt; acc + <span class="hljs-number">1</span>, Integer::<span class="hljs-built_in">sum</span>);
</code></pre>
<p>不过更推荐 groupingBy。</p>
<hr/>
<h3 data-id="heading-21">7. 字符串拼接（可以但不优）</h3>
<pre><code class="hljs language-css" lang="css">String str = list<span class="hljs-selector-class">.stream</span>()<span class="hljs-selector-class">.reduce</span>("", (<span class="hljs-selector-tag">a</span>, <span class="hljs-selector-tag">b</span>) -&gt; <span class="hljs-selector-tag">a</span> + <span class="hljs-selector-tag">b</span>);
</code></pre>
<p>更推荐：</p>
<pre><code class="hljs language-scss" lang="scss">Collectors<span class="hljs-selector-class">.joining</span>()
</code></pre>
<hr/>
<h3 data-id="heading-22">8. 多字段组合运算（如金额 × 汇率）</h3>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">BigDecimal</span> <span class="hljs-selector-tag">total</span> = <span class="hljs-selector-tag">list</span><span class="hljs-selector-class">.stream</span>()<span class="hljs-selector-class">.reduce</span>(
    BigDecimal.ZERO,
    (acc, o) -&gt; acc.<span class="hljs-built_in">add</span>(o.<span class="hljs-built_in">getAmount</span>().<span class="hljs-built_in">multiply</span>(o.<span class="hljs-built_in">getRate</span>())),
    <span class="hljs-attribute">BigDecimal</span>::add
);
</code></pre>
<p>企业业务非常常见。</p>
<hr/>
<h2 data-id="heading-23">六、reduce 的 4 大误区（你可能全踩过）</h2>
<h3 data-id="heading-24">❌ 1. 把 reduce 用成“万能循环”</h3>
<pre><code class="hljs language-kotlin" lang="kotlin">.reduce(<span class="hljs-number">0</span>, (acc, e) -&gt; {
    System.<span class="hljs-keyword">out</span>.println(e); <span class="hljs-comment">// 副作用，不可取</span>
    <span class="hljs-keyword">return</span> acc + e;
})
</code></pre>
<p>reduce 应该是“纯函数式”，不应做输出、写全局变量等副作用。</p>
<hr/>
<h3 data-id="heading-25">❌ 2. 并行流中 identity 使用不当导致结果错误</h3>
<p>并行流会让 identity <strong>每个分片都执行一次</strong>。</p>
<p>错误示例：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">parallelStream</span>()<span class="hljs-selector-class">.reduce</span>(<span class="hljs-number">10</span>, Integer::sum);
</code></pre>
<hr/>
<h3 data-id="heading-26">❌ 3. 用 reduce 构建 List / Map（低效 + 不安全）</h3>
<p>正确方式是：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-class">.collect</span>(Collectors.<span class="hljs-built_in">toList</span>())
</code></pre>
<hr/>
<h3 data-id="heading-27">❌ 4. 忽略 Optional 版本 reduce 的意义</h3>
<pre><code class="hljs language-arduino" lang="arduino">stream.<span class="hljs-built_in">reduce</span>(Integer::max) <span class="hljs-comment">// 可能为空</span>
</code></pre>
<p>如果你非常确定 stream 非空，可以用有 identity 的重载。</p>
<hr/>
<h2 data-id="heading-28">七、什么时候应该果断用 reduce？（最佳实践）</h2>








































<table><thead><tr><th>场景</th><th>是否适合 reduce</th><th>推荐程度</th></tr></thead><tbody><tr><td>求和/最大/最小</td><td>✔️ 非常适合</td><td>⭐⭐⭐⭐⭐</td></tr><tr><td>累加数值</td><td>✔️ 适合</td><td>⭐⭐⭐⭐⭐</td></tr><tr><td>聚合多个字段成对象</td><td>✔️ 很适合</td><td>⭐⭐⭐⭐⭐</td></tr><tr><td>多字段复杂计算</td><td>✔️ 适合</td><td>⭐⭐⭐⭐</td></tr><tr><td>拼接字符串</td><td>❌ 不推荐</td><td>⭐</td></tr><tr><td>构建 List/Map</td><td>❌ 不推荐</td><td>⭐</td></tr></tbody></table>
<p>结论：</p>
<blockquote>
<p><strong>reduce 最适合 “复杂数值聚合” 与 “构建统计对象”</strong> 。</p>
</blockquote>
<p>这是它的真正价值。</p>
<hr/>
<h2 data-id="heading-29">八、总结：reduce 是 Stream 的灵魂</h2>
<p>reduce 不是简单的“求和函数”，它是：</p>
<p>✔ Stream 中唯一用于“把多个元素归约为一个结果”的 API<br/>
✔ 实现自定义聚合逻辑的最强工具<br/>
✔ 函数式编程在 Java 里的核心体现<br/>
✔ 写优雅、高可读、高抽象代码的关键</p>
<p>如果说 map/filter 是“数据加工工具”，那么：</p>
<blockquote>
<p><strong>reduce 就是“最终组装器”。</strong></p>
</blockquote>
<p>掌握了 reduce，你对 Stream 的理解就上了一个台阶。</p>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[CSS 视口单位进化论：从 100vh 的「骗局」到 dvh 的救赎]]></title>    <link>https://juejin.cn/post/7577797563854110756</link>    <guid>https://juejin.cn/post/7577797563854110756</guid>    <pubDate>2025-11-30T09:22:01.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577797563854110756" data-draft-id="7577797563854094372" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="CSS 视口单位进化论：从 100vh 的「骗局」到 dvh 的救赎"/> <meta itemprop="keywords" content="前端,CSS"/> <meta itemprop="datePublished" content="2025-11-30T09:22:01.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="兔子零1024"/> <meta itemprop="url" content="https://juejin.cn/user/3743194047592062"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            CSS 视口单位进化论：从 100vh 的「骗局」到 dvh 的救赎
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3743194047592062/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    兔子零1024
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T09:22:01.000Z" title="Sun Nov 30 2025 09:22:01 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{line-height:1.75;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;letter-spacing:2px;background-image:linear-gradient(90deg,rgba(50,0,0,.05) 3%,transparent 0),linear-gradient(1turn,rgba(50,0,0,.05) 3%,transparent 0);background-size:20px 20px;background-position:50%;word-break:break-word;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body h1{font-size:23px;margin-bottom:5px;font-weight:700;padding-left:10px;border-left:5px solid #773098}.markdown-body h2{font-size:19px;font-weight:700;padding-left:10px;border-left:5px solid #916dd5}.markdown-body h3{font-size:17px;font-weight:700;padding-left:10px;border-left:5px solid #d89cf6}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{font-size:14px;margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{display:block;max-width:100%;margin:1em 0;border-radius:6px;box-shadow:2px 4px 7px #999;user-select:none}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{padding:.2em .5em;font-weight:700;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;font-size:1em;color:#916dd5;word-break:break-word;overflow-x:auto;background-color:none;border-radius:2px}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;font-weight:400;font-size:.9em;padding:16px 12px;margin:0;color:#333;word-break:normal;overflow-x:auto;background:#f8f8f8;scroll-behavior:smooth}.markdown-body a{text-decoration:none;color:#916dd5;font-weight:700;border-bottom:1px solid #916dd5}.markdown-body a:active,.markdown-body a:hover{color:#773098}.markdown-body table{display:inline-block!important;font-size:14px;width:auto;max-width:100%;overflow:auto;border:1px solid #916dd5;border-collapse:collapse}.markdown-body thead{background-color:#916dd5;color:#fff;text-align:left}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px;border:1px solid #916dd5}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #d89cf6;background-color:#f4eeff}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0;line-height:26px}.markdown-body ol,.markdown-body ul{padding-left:28px;list-style-type:circle}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body b,.markdown-body strong{color:#916dd5;font-weight:700}.markdown-body b:before,.markdown-body strong:before{content:"「"}.markdown-body b:after,.markdown-body strong:after{content:"」"}.markdown-body em,.markdown-body i{color:#916dd5}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="github-gist">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fff;color:#333}.hljs-comment,.hljs-meta{color:#969896}.hljs-emphasis,.hljs-quote,.hljs-strong,.hljs-template-variable,.hljs-variable{color:#df5000}.hljs-keyword,.hljs-selector-tag,.hljs-type{color:#d73a49}.hljs-attribute,.hljs-bullet,.hljs-literal,.hljs-symbol{color:#0086b3}.hljs-name,.hljs-section{color:#63a35c}.hljs-tag{color:#333}.hljs-attr,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-id,.hljs-selector-pseudo,.hljs-title{color:#6f42c1}.hljs-addition{color:#55a532;background-color:#eaffea}.hljs-deletion{color:#bd2c00;background-color:#ffecec}.hljs-link{text-decoration:underline}.hljs-number{color:#005cc5}.hljs-string{color:#032f62}</style><p>关键词：CSS / 视口单位 / 移动端适配 / 响应式设计 / dvh / svh / lvh / 100vh bug / 前端工程化 / 用户体验</p>
<hr/>
<h2 data-id="heading-0">引言：一个持续了十年的移动端「谎言」</h2>
<p>如果你做过移动端 H5 开发，或者写过全屏落地的营销页，你一定遇到过那个著名的「100vh 骗局」。</p>
<p>设计师给了你一张完美的设计稿：<strong>首屏全屏，底部按钮固定，不允许有滚动条</strong>。<br/>
你自信满满地写下：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.hero-section</span> {
  <span class="hljs-attribute">height</span>: <span class="hljs-number">100vh</span>;
}
</code></pre>
<p>然后你在 iPhone 的 Safari 里打开，灾难发生了：<strong>底部的按钮被浏览器底部的工具栏遮住了一半，或者页面莫名其妙出现了一截滚动条</strong>。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d4e588457c8542b1bf827b137d40cc44~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YWU5a2Q6Zu2MTAyNA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765099321&amp;x-signature=KcjcvhleZ2DBmEugdYAqCB3Pjjs%3D" alt="1.jpg" loading="lazy"/></p>
<p><em>(图解：左侧是理想设计，按钮在最底部；右侧是 Safari 现状，浏览器工具栏无情地盖住了你的按钮)</em></p>
<p>为了解决这个问题，前端社区发明了无数「歪门邪道」：</p>
<ul>
<li>用 <code>window.innerHeight</code> 动态计算高度赋给 CSS 变量 <code>--vh</code>。</li>
<li>监听 <code>resize</code> 事件疯狂重绘。</li>
<li>使用 <code>position: fixed; top: 0; bottom: 0;</code> 这种古老的 hack。</li>
</ul>
<p><strong>为什么一个简单的「全屏」需求，在移动端会如此艰难？</strong><br/>
这背后其实是 Web 标准与移动端原生 UI（动态地址栏、底部工具栏）长达十年的博弈。</p>
<p>好消息是，CSS 终于迎来了<strong>真正解决问题</strong>的新一代视口单位：<code>svh</code>、<code>lvh</code>、<code>dvh</code> 以及它们在宽度和逻辑方向上的兄弟们。</p>
<blockquote>
<p><strong>这不是简单的语法升级，这是 Web 终于承认：移动端的屏幕，从来就不是一个静态的矩形。</strong></p>
</blockquote>
<hr/>
<h2 data-id="heading-1">一、旧时代的妥协：为什么 100vh 不是真的 100% 高度？</h2>
<h3 data-id="heading-2">1.1 完美的初衷与残酷的现实</h3>
<p>在 PC 时代，<code>vh</code> (Viewport Height) 的定义非常完美：<strong>视口高度的 1%</strong>。浏览器窗口多高，100vh 就多高。</p>
<p>但在移动端，情况变了。iOS Safari 和 Chrome Android 为了给用户更多阅读空间，设计了<strong>动态工具栏</strong>：</p>
<ul>
<li><strong>初始状态</strong>：地址栏、底部工具栏展开，可视区域变小。</li>
<li><strong>上滑状态</strong>：地址栏缩小/隐藏，工具栏消失，可视区域变大。</li>
</ul>
<p>这时候，<code>100vh</code> 该等于「展开时的高度」还是「隐藏时的高度」？</p>
<h3 data-id="heading-3">1.2 浏览器的「摆烂」选择</h3>
<p>早期的 Safari 做了一个影响深远的决定：<strong>为了避免滚动时页面元素跳动（Reflow），<code>100vh</code> 永远等于「地址栏隐藏时的最大高度」</strong>。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d5b6f15fccdb4651a0f420367c3a943e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YWU5a2Q6Zu2MTAyNA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765099321&amp;x-signature=KqgCJiTJONAmSyLUgASd0gJZUJk%3D" alt="2.jpg" loading="lazy"/></p>
<p><em>(图解：无论你的工具栏是否展开，Safari 始终认为 100vh 是那个「最大值」。这就导致当工具栏展开（实际只有 80% 高度）时，你的 100vh 内容溢出了 20%。)</em></p>
<p>这就解释了为什么你的按钮被遮住了：</p>
<ul>
<li>浏览器告诉你 100vh 是 800px（假设全屏高度）。</li>
<li>但实际上底部的工具栏占了 80px，可视区域只有 720px。</li>
<li>你的按钮画在了第 750px 的位置，正好被工具栏盖得严严实实。</li>
</ul>
<p>这个「特性」被无数开发者吐槽为 Bug，但浏览器厂商坚持这是「Feature」。</p>
<blockquote>
<p>「他们为了滚动的丝滑，牺牲了布局的精确。<br/>
在很长一段时间里，我们只能用 JS 来修补 CSS 的谎言。」</p>
</blockquote>
<hr/>
<h2 data-id="heading-4">二、新秩序的建立：svh、lvh、dvh 的三态哲学</h2>
<p>W3C 终于意识到，移动端的视口不是一个固定的值，而是一个<strong>在「大」与「小」之间薛定谔的波动状态</strong>。</p>
<p>于是，CSS Viewport Units Level 3 引入了一套全新的单位体系，把视口高度拆分为三种状态。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5a6b8f1891314d098b05bdeeee9e9bec~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YWU5a2Q6Zu2MTAyNA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765099321&amp;x-signature=1BBWPffprm5Y9U58g%2BPzdOchGhY%3D" alt="3.jpg" loading="lazy"/></p>
<h3 data-id="heading-5">2.1 svh (Small Viewport Height)：永远不再被遮挡</h3>
<p><strong>定义</strong>：视口高度的<strong>最小值</strong>（即地址栏、工具栏<strong>全部展开</strong>时的可视高度）。</p>
<ul>
<li><strong>应用场景</strong>：<strong>首屏全屏页、底部固定按钮、Modal 弹窗</strong>。</li>
<li><strong>价值</strong>：如果你写 <code>height: 100svh</code>，你的页面底部绝对不会被工具栏遮挡。它是最安全的「一屏」。</li>
</ul>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 以前的 JS Hack */</span>
<span class="hljs-selector-class">.modal</span> {
  <span class="hljs-attribute">height</span>: <span class="hljs-built_in">calc</span>(<span class="hljs-built_in">var</span>(--vh, <span class="hljs-number">1vh</span>) * <span class="hljs-number">100</span>);
}

<span class="hljs-comment">/* 现在的原生写法 */</span>
<span class="hljs-selector-class">.modal</span> {
  <span class="hljs-attribute">height</span>: <span class="hljs-number">100s</span>vh;
}
</code></pre>
<h3 data-id="heading-6">2.2 lvh (Large Viewport Height)：沉浸式的极致</h3>
<p><strong>定义</strong>：视口高度的<strong>最大值</strong>（即地址栏、工具栏<strong>全部收起</strong>时的可视高度）。</p>
<ul>
<li><strong>应用场景</strong>：<strong>背景图、视差滚动容器</strong>。</li>
<li><strong>价值</strong>：当你希望背景铺满整个「潜在」屏幕，不在乎一部分被遮挡时，用 <code>lvh</code>。它等同于旧时代的 <code>100vh</code>。</li>
</ul>
<h3 data-id="heading-7">2.3 dvh (Dynamic Viewport Height)：动态的完美与代价</h3>
<p><strong>定义</strong>：<strong>动态</strong>视口高度。它会随着地址栏的伸缩，实时在 <code>svh</code> 和 <code>lvh</code> 之间变化。</p>
<ul>
<li><strong>应用场景</strong>：<strong>追求极致体验的流式布局</strong>。</li>
<li><strong>代价</strong>：当用户滚动页面时，<code>100dvh</code> 的值会不断变化。这意味着浏览器可能需要不断重绘（Repaint）甚至重排（Reflow）。</li>
<li><strong>现状</strong>：现代浏览器对 <code>dvh</code> 做了很多优化，性能损耗在大多数场景下已可忽略不计。</li>
</ul>
<blockquote>
<p><strong>三态哲学总结：</strong></p>
<ul>
<li><strong>svh</strong> 是保底的<strong>安全</strong>（Safe）。</li>
<li><strong>lvh</strong> 是理想的<strong>宏大</strong>（Large）。</li>
<li><strong>dvh</strong> 是真实的<strong>动态</strong>（Dynamic）。</li>
</ul>
</blockquote>
<hr/>
<h2 data-id="heading-8">三、维度的扩张：宽度、逻辑方向与极值</h2>
<p>这套逻辑不仅修复了高度问题，还顺带重构了整个视口单位体系。</p>
<h3 data-id="heading-9">3.1 宽度的进化：svw / lvw / dvw</h3>
<p>虽然移动端宽度的变化（主要是滚动条出现/消失）不如高度那么剧烈，但逻辑是一致的。</p>
<ul>
<li><strong>vw</strong>：依然是默认视口宽度（通常包含滚动条）。</li>
<li><strong>svw / lvw / dvw</strong>：处理滚动条存在与否时的细微差异（在桌面端更明显）。</li>
</ul>
<h3 data-id="heading-10">3.2 逻辑方向：vi / vb —— 国际化的必修课</h3>
<p>随着 CSS 逻辑属性（Logical Properties）的普及，我们不再总是谈论 <code>width</code> 和 <code>height</code>，而是谈论 <code>inline</code>（文本流方向）和 <code>block</code>（块堆叠方向）。</p>
<ul>
<li>
<p><strong>vi (Viewport Inline)</strong>：视口在行内方向的大小。</p>
<ul>
<li>横屏/竖屏书写模式下：等于 <code>vw</code>。</li>
<li>竖排书写模式（如古诗词页面）：等于 <code>vh</code>。</li>
<li><strong>svi / lvi / dvi</strong>：对应的三态变体。</li>
</ul>
</li>
<li>
<p><strong>vb (Viewport Block)</strong>：视口在块级方向的大小。</p>
<ul>
<li>横屏/竖屏书写模式下：等于 <code>vh</code>。</li>
<li><strong>svb / lvb / dvb</strong>：对应的三态变体。</li>
</ul>
</li>
</ul>
<p><strong>实战案例：一个适配横竖屏书写的古诗卡片</strong></p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.poem-card</span> {
  <span class="hljs-comment">/* 无论横排还是竖排，永远占满视口在「块」方向上的 80% */</span>
  <span class="hljs-attribute">block-size</span>: <span class="hljs-number">80</span>vb; 
  
  <span class="hljs-comment">/* 无论横排还是竖排，永远占满视口在「行」方向上的 90% */</span>
  <span class="hljs-attribute">inline-size</span>: <span class="hljs-number">90</span>vi;
  
  <span class="hljs-comment">/* 自动适配书写模式 */</span>
  <span class="hljs-attribute">writing-mode</span>: vertical-rl; <span class="hljs-comment">/* 切换这个属性，布局依然完美 */</span>
}
</code></pre>
<h3 data-id="heading-11">3.3 极值单位：vmin / vmax 的三态</h3>
<p>老朋友 <code>vmin</code>（vw/vh 中较小者）和 <code>vmax</code>（较大者）也全员升级：</p>
<ul>
<li><strong>svmin / svmax</strong></li>
<li><strong>lvmin / lvmax</strong></li>
<li><strong>dvmin / dvmax</strong></li>
</ul>
<p><strong>场景</strong>：做横竖屏适配的 H5 游戏或画报时，<code>svmin</code> 是保证内容在任何旋转状态下都<strong>完整可见</strong>的神器。</p>
<hr/>
<h2 data-id="heading-12">四、工程实战：如何在 2025 年写好一个全屏页面？</h2>
<h3 data-id="heading-13">4.1 放弃 100vh，拥抱 dvh（但要做降级）</h3>
<p>在 2025 年，如果你的目标浏览器支持率允许（iOS 15.4+, Chrome 108+），<strong><code>dvh</code> 是全屏容器的最佳选择</strong>。</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.full-screen-hero</span> {
  <span class="hljs-comment">/* 降级方案：给旧浏览器一个固定的值 */</span>
  <span class="hljs-attribute">height</span>: <span class="hljs-number">100vh</span>;
  
  <span class="hljs-comment">/* 现代方案：使用动态高度，完美贴合 */</span>
  <span class="hljs-attribute">height</span>: <span class="hljs-number">100</span>dvh;
}
</code></pre>
<h3 data-id="heading-14">4.2 关键交互区域用 svh</h3>
<p>对于底部的操作栏（Action Bar），不要用 <code>dvh</code>，因为你不想让按钮在用户手指滑动时「跳来跳去」。<strong>用 <code>svh</code> 锁定位置</strong>。</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.bottom-bar</span> {
  <span class="hljs-attribute">position</span>: fixed;
  <span class="hljs-attribute">bottom</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
  <span class="hljs-comment">/* 确保它永远在可视区底部，哪怕地址栏展开 */</span>
  <span class="hljs-attribute">bottom</span>: <span class="hljs-built_in">calc</span>(<span class="hljs-number">100vh</span> - <span class="hljs-number">100s</span>vh); <span class="hljs-comment">/* 高级技巧：计算工具栏高度偏移 */</span>
}

<span class="hljs-comment">/* 或者更简单的布局思维： */</span>
<span class="hljs-selector-class">.app-container</span> {
  <span class="hljs-attribute">min-height</span>: <span class="hljs-number">100s</span>vh;
  <span class="hljs-attribute">display</span>: grid;
  <span class="hljs-attribute">grid-template-rows</span>: <span class="hljs-number">1</span>fr auto;
}
</code></pre>
<h3 data-id="heading-15">4.3 慎用 lvh，除非你在做特效</h3>
<p><code>lvh</code> 在实际 UI 布局中用得很少。它更多用于<strong>视觉背景</strong>，或者那种「滑一下就全屏」的沉浸式阅读体验。如果你用 <code>lvh</code> 做布局容器，用户大概率会因为点不到底部的按钮而骂娘。</p>
<blockquote>
<p>「成熟的工程师懂得：<br/>
UI 的稳定性（svh）优先于 UI 的充满感（lvh），<br/>
而 dvh 是两者之间的优雅平衡。」</p>
</blockquote>
<hr/>
<h2 data-id="heading-16">五、总结：从「对抗」到「接纳」</h2>
<p>回顾 CSS 视口单位的进化史，其实是一部 Web 与移动端原生特性的磨合史。</p>
<ul>
<li><strong>vh 时代</strong>：Web 试图假装自己还在 PC 上，无视了移动端复杂的 UI 变化，结果撞得头破血流（100vh bug）。</li>
<li><strong>JS Hack 时代</strong>：开发者用脚本强行修正高度，对抗浏览器的默认行为，性能差且代码丑陋。</li>
<li><strong>svh/dvh 时代</strong>：标准终于接纳了移动端的复杂性。<strong>我们不再强求一个「唯一的 100%」，而是承认「屏幕是会变的」</strong>。</li>
</ul>
<p>这给了我们两个重要的启示：</p>
<ol>
<li><strong>不存在完美的静态适配</strong>。移动端设备极其碎片化，折叠屏、刘海屏、动态栏……<strong>拥抱动态（Dynamic）才是终极解法</strong>。</li>
<li><strong>工具的粒度决定了体验的细腻度</strong>。从粗糙的 <code>vh</code> 到精细的 <code>svh/lvh/dvh</code>，前端工程化的本质，就是不断提升对像素级体验的掌控力。</li>
</ol>
<blockquote>
<p>下一次，当设计师问你「能不能把这个页面铺满全屏，不要滚动条，也不要被遮挡」时，<br/>
你可以自信地合上电脑（或者打开 VS Code），告诉他：<br/>
<strong>「当然可以，因为现在的 CSS，终于懂手机了。」</strong></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[element-plus源码解读3——【scss】颜色系统完整流程]]></title>    <link>https://juejin.cn/post/7577969462860496959</link>    <guid>https://juejin.cn/post/7577969462860496959</guid>    <pubDate>2025-11-30T09:30:32.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577969462860496959" data-draft-id="7577797563853832228" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="element-plus源码解读3——【scss】颜色系统完整流程"/> <meta itemprop="keywords" content="SCSS,Element"/> <meta itemprop="datePublished" content="2025-11-30T09:30:32.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Joie"/> <meta itemprop="url" content="https://juejin.cn/user/3265984436383947"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            element-plus源码解读3——【scss】颜色系统完整流程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3265984436383947/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Joie
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T09:30:32.000Z" title="Sun Nov 30 2025 09:30:32 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、基础颜色定义（源头）</h2>
<p><em>位置：packages/theme-chalk/src/common/var.scss</em></p>
<p>scss知识点：$ 表示变量</p>
<ul>
<li>定义所有颜色的基础值</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// types</span>
<span class="hljs-attr">$types</span>: primary, success, warning, danger, error, info;

<span class="hljs-comment">// Color</span>
<span class="hljs-attr">$colors</span>: () !<span class="hljs-keyword">default</span>;
<span class="hljs-attr">$colors</span>: map.<span class="hljs-property">deep</span>-<span class="hljs-title function_">merge</span>(
  (
    <span class="hljs-string">'white'</span>: #ffffff,
    <span class="hljs-string">'black'</span>: #<span class="hljs-number">000000</span>,
    <span class="hljs-string">'primary'</span>: (
      <span class="hljs-string">'base'</span>: #409eff,
    ),
    <span class="hljs-string">'success'</span>: (
      <span class="hljs-string">'base'</span>: #67c23a,
    ),
    <span class="hljs-string">'warning'</span>: (
      <span class="hljs-string">'base'</span>: #e6a23c,
    ),
    <span class="hljs-string">'danger'</span>: (
      <span class="hljs-string">'base'</span>: #f56c6c,
    ),
    <span class="hljs-string">'error'</span>: (
      <span class="hljs-string">'base'</span>: #f56c6c,
    ),
    <span class="hljs-string">'info'</span>: (
      <span class="hljs-string">'base'</span>: #<span class="hljs-number">909399</span>,
    ),
  ),
  $colors
);
</code></pre>
<h2 data-id="heading-1">二、自动生成颜色变体（light/dark）</h2>
<p><em>位置：packages/theme-chalk/src/common/var.scss</em></p>
<p>定义一个mixin: <strong>set-color-mix-level</strong>:</p>
<p>将基础颜色与白色或黑色混合</p>
<p>生成指定级别的浅色或深色变体</p>
<p>将生成的颜色添加到$colors map中</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// mix colors with white/black to generate light/dark level</span>
@mixin set-color-mix-<span class="hljs-title function_">level</span>(<span class="hljs-params">
  $type,
  $number,
  $mode: <span class="hljs-string">'light'</span>,
  $mix-color: $color-white
</span>) {
  <span class="hljs-attr">$colors</span>: map.<span class="hljs-property">deep</span>-<span class="hljs-title function_">merge</span>(
    (
      <span class="hljs-attr">$type</span>: (
        <span class="hljs-comment">/**
        * roundColor：将颜色的 RGB 通道值四舍五入为整数，并返回 rgba() 格式的颜色。
        * color.mix：混合颜色 第一个参数和第二个参数按照第三个参数的百分比混合颜色
        * map.get($colors, $type, 'base')：获取颜色
        * math.percentage(math.div($number, 10))：将数字转换为百分比
        */</span>
          <span class="hljs-string">'#{$mode}-#{$number}'</span>: <span class="hljs-title function_">roundColor</span>(
            color.<span class="hljs-title function_">mix</span>(
              $mix-color,
              map.<span class="hljs-title function_">get</span>($colors, $type, <span class="hljs-string">'base'</span>),
              math.<span class="hljs-title function_">percentage</span>(math.<span class="hljs-title function_">div</span>($number, <span class="hljs-number">10</span>))
            )
          ),
      ),
    ),
    $colors
  ) !<span class="hljs-variable language_">global</span>;
}

</code></pre>
<p>使用</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// $colors.primary.light-i</span>
<span class="hljs-comment">// --el-color-primary-light-i</span>
<span class="hljs-comment">// 10% 53a8ff</span>
<span class="hljs-comment">// 20% 66b1ff</span>
<span class="hljs-comment">// 30% 79bbff</span>
<span class="hljs-comment">// 40% 8cc5ff</span>
<span class="hljs-comment">// 50% a0cfff</span>
<span class="hljs-comment">// 60% b3d8ff</span>
<span class="hljs-comment">// 70% c6e2ff</span>
<span class="hljs-comment">// 80% d9ecff</span>
<span class="hljs-comment">// 90% ecf5ff</span>

<span class="hljs-comment">// 外层循环：遍历颜色类型</span>
@each $type <span class="hljs-keyword">in</span> $types {
  <span class="hljs-comment">// 内层循环：生成 1-9 的变体</span>
  @<span class="hljs-keyword">for</span> $i <span class="hljs-keyword">from</span> <span class="hljs-number">1</span> through <span class="hljs-number">9</span> {
    <span class="hljs-comment">// 调用 mixin 生成不同亮度的颜色</span>
    @include set-color-mix-<span class="hljs-title function_">level</span>($type, $i, <span class="hljs-string">'light'</span>, $color-white);
  }
}


<span class="hljs-comment">// 第 1 轮：$type = primary</span>
@include set-color-mix-<span class="hljs-title function_">level</span>(primary, <span class="hljs-number">1</span>, <span class="hljs-string">'light'</span>, $color-white);  <span class="hljs-comment">// 生成 primary-light-1</span>
@include set-color-mix-<span class="hljs-title function_">level</span>(primary, <span class="hljs-number">2</span>, <span class="hljs-string">'light'</span>, $color-white);  <span class="hljs-comment">// 生成 primary-light-2</span>
@include set-color-mix-<span class="hljs-title function_">level</span>(primary, <span class="hljs-number">3</span>, <span class="hljs-string">'light'</span>, $color-white);  <span class="hljs-comment">// 生成 primary-light-3</span>
<span class="hljs-comment">// ... 继续到 9</span>

<span class="hljs-comment">// 第 2 轮：$type = success</span>
@include set-color-mix-<span class="hljs-title function_">level</span>(success, <span class="hljs-number">1</span>, <span class="hljs-string">'light'</span>, $color-white);   <span class="hljs-comment">// 生成 success-light-1</span>
@include set-color-mix-<span class="hljs-title function_">level</span>(success, <span class="hljs-number">2</span>, <span class="hljs-string">'light'</span>, $color-white);   <span class="hljs-comment">// 生成 success-light-2</span>
<span class="hljs-comment">// ... 继续到 9</span>

<span class="hljs-comment">// 依此类推，直到遍历完所有 6 种类型</span>
</code></pre>
<h2 data-id="heading-2">三、生成 CSS 变量（全局）</h2>
<p><em>位置：packages/theme-chalk/src/var.scss</em></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// join var name</span>
<span class="hljs-comment">// joinVarName(('button', 'text-color')) =&gt; '--el-button-text-color'</span>
<span class="hljs-comment">// 将$list遍历中间用-拼接每一个$item</span>
@<span class="hljs-keyword">function</span> <span class="hljs-title function_">joinVarName</span>(<span class="hljs-params">$list</span>) {
  <span class="hljs-attr">$name</span>: <span class="hljs-string">'--'</span> + config.<span class="hljs-property">$namespace</span>;
  @each $item <span class="hljs-keyword">in</span> $list {
    @<span class="hljs-keyword">if</span> $item != <span class="hljs-string">''</span> {
      <span class="hljs-attr">$name</span>: $name + <span class="hljs-string">'-'</span> + $item;
    }
  }
  @<span class="hljs-keyword">return</span> $name;
}

===============================================================

<span class="hljs-comment">// set css var value, because we need translate value to string</span>
<span class="hljs-comment">// for example:</span>
<span class="hljs-comment">// @include set-css-var-value(('color', 'primary'), red);</span>
<span class="hljs-comment">// --el-color-primary: red;</span>
<span class="hljs-comment">// 返回 变量名：颜色值 的形式</span>
@mixin set-css-<span class="hljs-keyword">var</span>-<span class="hljs-title function_">value</span>(<span class="hljs-params">$name, $value</span>) {
  #{<span class="hljs-title function_">joinVarName</span>($name)}: #{$value};
}

================================================================

@mixin set-css-color-<span class="hljs-title function_">type</span>(<span class="hljs-params">$colors, $type</span>) {
  <span class="hljs-comment">// 生成基础颜色变量</span>
  @include set-css-<span class="hljs-keyword">var</span>-<span class="hljs-title function_">value</span>((<span class="hljs-string">'color'</span>, $type), map.<span class="hljs-title function_">get</span>($colors, $type, <span class="hljs-string">'base'</span>));
  <span class="hljs-comment">// 结果：--el-color-primary: #409eff;</span>

  <span class="hljs-comment">// 生成浅色变量（3, 5, 7, 8, 9）</span>
  @each $i <span class="hljs-keyword">in</span> (<span class="hljs-number">3</span>, <span class="hljs-number">5</span>, <span class="hljs-number">7</span>, <span class="hljs-number">8</span>, <span class="hljs-number">9</span>) {
    @include set-css-<span class="hljs-keyword">var</span>-<span class="hljs-title function_">value</span>(
      (<span class="hljs-string">'color'</span>, $type, <span class="hljs-string">'light'</span>, $i),
      map.<span class="hljs-title function_">get</span>($colors, $type, <span class="hljs-string">'light-#{$i}'</span>)
    );
  }
  <span class="hljs-comment">// 结果：</span>
  <span class="hljs-comment">// --el-color-primary-light-3: #79bbff;</span>
  <span class="hljs-comment">// --el-color-primary-light-5: #a0cfff;</span>
  <span class="hljs-comment">// --el-color-primary-light-7: #c6e2ff;</span>
  <span class="hljs-comment">// --el-color-primary-light-8: #d9ecff;</span>
  <span class="hljs-comment">// --el-color-primary-light-9: #ecf5ff;</span>

  <span class="hljs-comment">// 生成深色变量</span>
  @include set-css-<span class="hljs-keyword">var</span>-<span class="hljs-title function_">value</span>(
    (<span class="hljs-string">'color'</span>, $type, <span class="hljs-string">'dark-2'</span>),
    map.<span class="hljs-title function_">get</span>($colors, $type, <span class="hljs-string">'dark-2'</span>)
  );
  <span class="hljs-comment">// 结果：--el-color-primary-dark-2: ...;</span>
}

=================================================================

:root {
  color-<span class="hljs-attr">scheme</span>: light;

  <span class="hljs-comment">// --el-color-#{$type}</span>
  <span class="hljs-comment">// --el-color-#{$type}-light-{$i}</span>
  @each $type <span class="hljs-keyword">in</span> (primary, success, warning, danger, error, info) {
    @include set-css-color-<span class="hljs-title function_">type</span>($colors, $type);
  }
  
生成的css变量，以primary为例子
:root {
  --el-color-<span class="hljs-attr">primary</span>: #409eff;
  --el-color-primary-light-<span class="hljs-number">3</span>: #79bbff;
  --el-color-primary-light-<span class="hljs-number">5</span>: #a0cfff;
  --el-color-primary-light-<span class="hljs-number">7</span>: #c6e2ff;
  --el-color-primary-light-<span class="hljs-number">8</span>: #d9ecff;
  --el-color-primary-light-<span class="hljs-number">9</span>: #ecf5ff;
  --el-color-primary-dark-<span class="hljs-number">2</span>: #337ecc;
}
</code></pre>
<h2 data-id="heading-3">四、组件级使用——以el-button为例子</h2>
<p><em>位置：packages/theme-chalk/src/button.scss</em></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// generate css var from existing css var</span>
<span class="hljs-comment">// for example:</span>
<span class="hljs-comment">// @include css-var-from-global(('button', 'text-color'), ('color', $type))</span>
<span class="hljs-comment">// --el-button-text-color: var(--el-color-#{$type});</span>
@mixin css-<span class="hljs-keyword">var</span>-<span class="hljs-keyword">from</span>-<span class="hljs-title function_">global</span>(<span class="hljs-params">$var, $gVar</span>) {
  <span class="hljs-attr">$varName</span>: <span class="hljs-title function_">joinVarName</span>($var);
  <span class="hljs-attr">$gVarName</span>: <span class="hljs-title function_">joinVarName</span>($gVar);
  #{$varName}: <span class="hljs-title function_">var</span>(#{$gVarName});
}

==========================================================

$button-color-types 是一个 <span class="hljs-variable constant_">SCSS</span> 变量（map），定义在 button-variant mixin 内部。它是一个嵌套的 map，用于定义按钮在不同状态下的颜色映射关系。

$button-color-<span class="hljs-attr">types</span>: (
    <span class="hljs-string">''</span>: (
      <span class="hljs-string">'text-color'</span>: (
        <span class="hljs-string">'color'</span>,
        <span class="hljs-string">'white'</span>,
      ),
      <span class="hljs-string">'bg-color'</span>: (
        <span class="hljs-string">'color'</span>,
        $type,
      ),
      <span class="hljs-string">'border-color'</span>: (
        <span class="hljs-string">'color'</span>,
        $type,
      ),
      <span class="hljs-string">'outline-color'</span>: (
        <span class="hljs-string">'color'</span>,
        $type,
        <span class="hljs-string">'light-5'</span>,
      ),
      <span class="hljs-string">'active-color'</span>: (
        <span class="hljs-string">'color'</span>,
        $type,
        <span class="hljs-string">'dark-2'</span>,
      ),
    ),
    <span class="hljs-string">'hover'</span>: (
      <span class="hljs-string">'text-color'</span>: (
        <span class="hljs-string">'color'</span>,
        <span class="hljs-string">'white'</span>,
      ),
      <span class="hljs-string">'link-text-color'</span>: (
        <span class="hljs-string">'color'</span>,
        $type,
        <span class="hljs-string">'light-5'</span>,
      ),
      <span class="hljs-string">'bg-color'</span>: (
        <span class="hljs-string">'color'</span>,
        $type,
        <span class="hljs-string">'light-3'</span>,
      ),
      <span class="hljs-string">'border-color'</span>: (
        <span class="hljs-string">'color'</span>,
        $type,
        <span class="hljs-string">'light-3'</span>,
      ),
    ),
    <span class="hljs-string">'active'</span>: (
      <span class="hljs-string">'bg-color'</span>: (
        <span class="hljs-string">'color'</span>,
        $type,
        <span class="hljs-string">'dark-2'</span>,
      ),
      <span class="hljs-string">'border-color'</span>: (
        <span class="hljs-string">'color'</span>,
        $type,
        <span class="hljs-string">'dark-2'</span>,
      ),
    ),
    <span class="hljs-string">'disabled'</span>: (
      <span class="hljs-string">'text-color'</span>: (
        <span class="hljs-string">'color'</span>,
        <span class="hljs-string">'white'</span>,
      ),
      <span class="hljs-string">'bg-color'</span>: (
        <span class="hljs-string">'color'</span>,
        $type,
        <span class="hljs-string">'light-5'</span>,
      ),
      <span class="hljs-string">'border-color'</span>: (
        <span class="hljs-string">'color'</span>,
        $type,
        <span class="hljs-string">'light-5'</span>,
      ),
    ),
  );
  
  <span class="hljs-comment">// 结构层次</span>
  $button-color-types (第一层：状态)
  ├─ <span class="hljs-string">''</span> (默认状态)
  │   ├─ <span class="hljs-string">'text-color'</span> → (<span class="hljs-string">'color'</span>, <span class="hljs-string">'white'</span>)
  │   ├─ <span class="hljs-string">'bg-color'</span> → (<span class="hljs-string">'color'</span>, $type)
  │   ├─ <span class="hljs-string">'border-color'</span> → (<span class="hljs-string">'color'</span>, $type)
  │   ├─ <span class="hljs-string">'outline-color'</span> → (<span class="hljs-string">'color'</span>, $type, <span class="hljs-string">'light-5'</span>)
  │   └─ <span class="hljs-string">'active-color'</span> → (<span class="hljs-string">'color'</span>, $type, <span class="hljs-string">'dark-2'</span>)
  │
  ├─ <span class="hljs-string">'hover'</span> (悬停状态)
  │   ├─ <span class="hljs-string">'text-color'</span> → (<span class="hljs-string">'color'</span>, <span class="hljs-string">'white'</span>)
  │   ├─ <span class="hljs-string">'link-text-color'</span> → (<span class="hljs-string">'color'</span>, $type, <span class="hljs-string">'light-5'</span>)
  │   ├─ <span class="hljs-string">'bg-color'</span> → (<span class="hljs-string">'color'</span>, $type, <span class="hljs-string">'light-3'</span>)
  │   └─ <span class="hljs-string">'border-color'</span> → (<span class="hljs-string">'color'</span>, $type, <span class="hljs-string">'light-3'</span>)
  │
  ├─ <span class="hljs-string">'active'</span> (激活状态)
  │   ├─ <span class="hljs-string">'bg-color'</span> → (<span class="hljs-string">'color'</span>, $type, <span class="hljs-string">'dark-2'</span>)
  │   └─ <span class="hljs-string">'border-color'</span> → (<span class="hljs-string">'color'</span>, $type, <span class="hljs-string">'dark-2'</span>)
  │
  └─ <span class="hljs-string">'disabled'</span> (禁用状态)
      ├─ <span class="hljs-string">'text-color'</span> → (<span class="hljs-string">'color'</span>, <span class="hljs-string">'white'</span>)
      ├─ <span class="hljs-string">'bg-color'</span> → (<span class="hljs-string">'color'</span>, $type, <span class="hljs-string">'light-5'</span>)
      └─ <span class="hljs-string">'border-color'</span> → (<span class="hljs-string">'color'</span>, $type, <span class="hljs-string">'light-5'</span>)

================================================================

  @each $type, $typeMap <span class="hljs-keyword">in</span> $button-color-types {
    <span class="hljs-comment">// 内层循环，遍历第二层(属性)：text-color, bg-color, border-color, outline-color, active-color</span>
    <span class="hljs-comment">// $typeColor:属性名，例如：'text-color'</span>
    <span class="hljs-comment">// $list:属性值，例如：('color', 'white')</span>
    @each $typeColor, $list <span class="hljs-keyword">in</span> $typeMap {
      <span class="hljs-comment">// 调用 css-var-from-global 生成 CSS 变量</span>
      <span class="hljs-comment">// 例如：@include css-var-from-global(('button', 'hover', 'text-color'), ('color', 'white'));</span>
      @include css-<span class="hljs-keyword">var</span>-<span class="hljs-keyword">from</span>-<span class="hljs-title function_">global</span>((<span class="hljs-string">'button'</span>, $type, $typeColor), $list);
    }
  }
  
 <span class="hljs-comment">// 当 $type = 'primary' 时，会生成：</span>
 <span class="hljs-comment">/* 默认状态 */</span>
--el-button-text-<span class="hljs-attr">color</span>: <span class="hljs-title function_">var</span>(--el-color-white);
--el-button-bg-<span class="hljs-attr">color</span>: <span class="hljs-title function_">var</span>(--el-color-primary);
--el-button-border-<span class="hljs-attr">color</span>: <span class="hljs-title function_">var</span>(--el-color-primary);
--el-button-outline-<span class="hljs-attr">color</span>: <span class="hljs-title function_">var</span>(--el-color-primary-light-<span class="hljs-number">5</span>);
--el-button-active-<span class="hljs-attr">color</span>: <span class="hljs-title function_">var</span>(--el-color-primary-dark-<span class="hljs-number">2</span>);

<span class="hljs-comment">/* 悬停状态 */</span>
--el-button-hover-text-<span class="hljs-attr">color</span>: <span class="hljs-title function_">var</span>(--el-color-white);
--el-button-hover-link-text-<span class="hljs-attr">color</span>: <span class="hljs-title function_">var</span>(--el-color-primary-light-<span class="hljs-number">5</span>);
--el-button-hover-bg-<span class="hljs-attr">color</span>: <span class="hljs-title function_">var</span>(--el-color-primary-light-<span class="hljs-number">3</span>);
--el-button-hover-border-<span class="hljs-attr">color</span>: <span class="hljs-title function_">var</span>(--el-color-primary-light-<span class="hljs-number">3</span>);

<span class="hljs-comment">/* 激活状态 */</span>
--el-button-active-bg-<span class="hljs-attr">color</span>: <span class="hljs-title function_">var</span>(--el-color-primary-dark-<span class="hljs-number">2</span>);
--el-button-active-border-<span class="hljs-attr">color</span>: <span class="hljs-title function_">var</span>(--el-color-primary-dark-<span class="hljs-number">2</span>);

<span class="hljs-comment">/* 禁用状态 */</span>
--el-button-disabled-text-<span class="hljs-attr">color</span>: <span class="hljs-title function_">var</span>(--el-color-white);
--el-button-disabled-bg-<span class="hljs-attr">color</span>: <span class="hljs-title function_">var</span>(--el-color-primary-light-<span class="hljs-number">5</span>);
--el-button-disabled-border-<span class="hljs-attr">color</span>: <span class="hljs-title function_">var</span>(--el-color-primary-light-<span class="hljs-number">5</span>);

=====================================================================

完整源码：
@mixin button-<span class="hljs-title function_">variant</span>(<span class="hljs-params">$type</span>) {
  $button-color-<span class="hljs-attr">types</span>: (
    <span class="hljs-string">''</span>: (
      <span class="hljs-string">'text-color'</span>: (
        <span class="hljs-string">'color'</span>,
        <span class="hljs-string">'white'</span>,
      ),
      <span class="hljs-string">'bg-color'</span>: (
        <span class="hljs-string">'color'</span>,
        $type,
      ),
      <span class="hljs-string">'border-color'</span>: (
        <span class="hljs-string">'color'</span>,
        $type,
      ),
      <span class="hljs-string">'outline-color'</span>: (
        <span class="hljs-string">'color'</span>,
        $type,
        <span class="hljs-string">'light-5'</span>,
      ),
      <span class="hljs-string">'active-color'</span>: (
        <span class="hljs-string">'color'</span>,
        $type,
        <span class="hljs-string">'dark-2'</span>,
      ),
    ),
    <span class="hljs-string">'hover'</span>: (
      <span class="hljs-string">'text-color'</span>: (
        <span class="hljs-string">'color'</span>,
        <span class="hljs-string">'white'</span>,
      ),
      <span class="hljs-string">'link-text-color'</span>: (
        <span class="hljs-string">'color'</span>,
        $type,
        <span class="hljs-string">'light-5'</span>,
      ),
      <span class="hljs-string">'bg-color'</span>: (
        <span class="hljs-string">'color'</span>,
        $type,
        <span class="hljs-string">'light-3'</span>,
      ),
      <span class="hljs-string">'border-color'</span>: (
        <span class="hljs-string">'color'</span>,
        $type,
        <span class="hljs-string">'light-3'</span>,
      ),
    ),
    <span class="hljs-string">'active'</span>: (
      <span class="hljs-string">'bg-color'</span>: (
        <span class="hljs-string">'color'</span>,
        $type,
        <span class="hljs-string">'dark-2'</span>,
      ),
      <span class="hljs-string">'border-color'</span>: (
        <span class="hljs-string">'color'</span>,
        $type,
        <span class="hljs-string">'dark-2'</span>,
      ),
    ),
    <span class="hljs-string">'disabled'</span>: (
      <span class="hljs-string">'text-color'</span>: (
        <span class="hljs-string">'color'</span>,
        <span class="hljs-string">'white'</span>,
      ),
      <span class="hljs-string">'bg-color'</span>: (
        <span class="hljs-string">'color'</span>,
        $type,
        <span class="hljs-string">'light-5'</span>,
      ),
      <span class="hljs-string">'border-color'</span>: (
        <span class="hljs-string">'color'</span>,
        $type,
        <span class="hljs-string">'light-5'</span>,
      ),
    ),
  );

  <span class="hljs-comment">// 外层循环，遍历第一层(状态)：'', 'hover', 'active', 'disabled'</span>
  <span class="hljs-comment">// $type状态名例如'hover'；</span>
  <span class="hljs-comment">// $typeMap:状态对应的属性值，例如：('text-color': (</span>
  <span class="hljs-comment">//   'color',</span>
  <span class="hljs-comment">//   'white',</span>
  <span class="hljs-comment">// ),)</span>
  @each $type, $typeMap <span class="hljs-keyword">in</span> $button-color-types {
    <span class="hljs-comment">// 内层循环，遍历第二层(属性)：text-color, bg-color, border-color, outline-color, active-color</span>
    <span class="hljs-comment">// $typeColor:属性名，例如：'text-color'</span>
    <span class="hljs-comment">// $list:属性值，例如：('color', 'white')</span>
    @each $typeColor, $list <span class="hljs-keyword">in</span> $typeMap {
      <span class="hljs-comment">// 调用 css-var-from-global 生成 CSS 变量</span>
      <span class="hljs-comment">// 例如：@include css-var-from-global(('button', 'hover', 'text-color'), ('color', 'white'));</span>
      @include css-<span class="hljs-keyword">var</span>-<span class="hljs-keyword">from</span>-<span class="hljs-title function_">global</span>((<span class="hljs-string">'button'</span>, $type, $typeColor), $list);
    }
  }

  &amp;.<span class="hljs-property">is</span>-plain,
  &amp;.<span class="hljs-property">is</span>-text,
  &amp;.<span class="hljs-property">is</span>-link {
    @include button-<span class="hljs-title function_">plain</span>($type);
  }
}

</code></pre>
<h2 data-id="heading-4">五、应用样式（最终渲染）</h2>
<p><em>位置：packages/theme-chalk/src/button.scss</em></p>
<pre><code class="hljs language-js" lang="js">@include <span class="hljs-title function_">b</span>(<span class="hljs-params">button</span>) {
  <span class="hljs-attr">display</span>: inline-flex;
  justify-<span class="hljs-attr">content</span>: center;
  align-<span class="hljs-attr">items</span>: center;

  line-<span class="hljs-attr">height</span>: <span class="hljs-number">1</span>;
  <span class="hljs-comment">// min-height will expand when in flex</span>
  <span class="hljs-attr">height</span>: map.<span class="hljs-title function_">get</span>($input-height, <span class="hljs-string">'default'</span>);
  white-<span class="hljs-attr">space</span>: nowrap;
  <span class="hljs-attr">cursor</span>: pointer;
  <span class="hljs-attr">color</span>: <span class="hljs-title function_">getCssVar</span>(<span class="hljs-string">'button'</span>, <span class="hljs-string">'text-color'</span>);
  text-<span class="hljs-attr">align</span>: center;
  box-<span class="hljs-attr">sizing</span>: border-box;
  <span class="hljs-attr">outline</span>: none;
  <span class="hljs-attr">transition</span>: <span class="hljs-number">0.</span>1s;
  font-<span class="hljs-attr">weight</span>: <span class="hljs-title function_">getCssVar</span>(<span class="hljs-string">'button'</span>, <span class="hljs-string">'font-weight'</span>);
  user-<span class="hljs-attr">select</span>: none;
  vertical-<span class="hljs-attr">align</span>: middle;
  -webkit-<span class="hljs-attr">appearance</span>: none;
  background-<span class="hljs-attr">color</span>: <span class="hljs-title function_">getCssVar</span>(<span class="hljs-string">'button'</span>, <span class="hljs-string">'bg-color'</span>);
  <span class="hljs-attr">border</span>: <span class="hljs-title function_">getCssVar</span>(<span class="hljs-string">'border'</span>);
  border-<span class="hljs-attr">color</span>: <span class="hljs-title function_">getCssVar</span>(<span class="hljs-string">'button'</span>, <span class="hljs-string">'border-color'</span>);

  &amp;:hover {
    <span class="hljs-attr">color</span>: <span class="hljs-title function_">getCssVar</span>(<span class="hljs-string">'button'</span>, <span class="hljs-string">'hover'</span>, <span class="hljs-string">'text-color'</span>);
    border-<span class="hljs-attr">color</span>: <span class="hljs-title function_">getCssVar</span>(<span class="hljs-string">'button'</span>, <span class="hljs-string">'hover'</span>, <span class="hljs-string">'border-color'</span>);
    background-<span class="hljs-attr">color</span>: <span class="hljs-title function_">getCssVar</span>(<span class="hljs-string">'button'</span>, <span class="hljs-string">'hover'</span>, <span class="hljs-string">'bg-color'</span>);
    <span class="hljs-attr">outline</span>: none;
  }
 
 <span class="hljs-comment">// 这些生成el-button的基础变量</span>
  ======================================================
 
   @each $type <span class="hljs-keyword">in</span> (primary, success, warning, danger, info) {
    @include <span class="hljs-title function_">m</span>(<span class="hljs-params">$type</span>) {
      @include button-<span class="hljs-title function_">variant</span>($type);
    }
  }

  
  <span class="hljs-comment">// $type = 'primary' 时，最终编译后的 CSS（.el-button--primary）：</span>
  .<span class="hljs-property">el</span>-button--primary {
  <span class="hljs-comment">/* 基础样式 */</span>
  <span class="hljs-attr">display</span>: inline-flex;
  justify-<span class="hljs-attr">content</span>: center;
  align-<span class="hljs-attr">items</span>: center;
  
  <span class="hljs-comment">/* 颜色（使用 CSS 变量） */</span>
  <span class="hljs-attr">color</span>: <span class="hljs-title function_">var</span>(--el-button-text-color);
  <span class="hljs-comment">/* ↓ 展开为 */</span>
  <span class="hljs-attr">color</span>: <span class="hljs-title function_">var</span>(--el-color-white);  <span class="hljs-comment">/* #ffffff */</span>
  
  background-<span class="hljs-attr">color</span>: <span class="hljs-title function_">var</span>(--el-button-bg-color);
  <span class="hljs-comment">/* ↓ 展开为 */</span>
  background-<span class="hljs-attr">color</span>: <span class="hljs-title function_">var</span>(--el-color-primary);  <span class="hljs-comment">/* #409eff */</span>
  
  border-<span class="hljs-attr">color</span>: <span class="hljs-title function_">var</span>(--el-button-border-color);
  <span class="hljs-comment">/* ↓ 展开为 */</span>
  border-<span class="hljs-attr">color</span>: <span class="hljs-title function_">var</span>(--el-color-primary);  <span class="hljs-comment">/* #409eff */</span>
}

.<span class="hljs-property">el</span>-button--<span class="hljs-attr">primary</span>:hover {
  background-<span class="hljs-attr">color</span>: <span class="hljs-title function_">var</span>(--el-button-hover-bg-color);
  <span class="hljs-comment">/* ↓ 展开为 */</span>
  background-<span class="hljs-attr">color</span>: <span class="hljs-title function_">var</span>(--el-color-primary-light-<span class="hljs-number">3</span>);  <span class="hljs-comment">/* #79bbff */</span>
  
  border-<span class="hljs-attr">color</span>: <span class="hljs-title function_">var</span>(--el-button-hover-border-color);
  <span class="hljs-comment">/* ↓ 展开为 */</span>
  border-<span class="hljs-attr">color</span>: <span class="hljs-title function_">var</span>(--el-color-primary-light-<span class="hljs-number">3</span>);  <span class="hljs-comment">/* #79bbff */</span>
}

.<span class="hljs-property">el</span>-button--<span class="hljs-attr">primary</span>:active {
  background-<span class="hljs-attr">color</span>: <span class="hljs-title function_">var</span>(--el-button-active-bg-color);
  <span class="hljs-comment">/* ↓ 展开为 */</span>
  background-<span class="hljs-attr">color</span>: <span class="hljs-title function_">var</span>(--el-color-primary-dark-<span class="hljs-number">2</span>);  <span class="hljs-comment">/* #337ecc */</span>
  
  border-<span class="hljs-attr">color</span>: <span class="hljs-title function_">var</span>(--el-button-active-border-color);
  <span class="hljs-comment">/* ↓ 展开为 */</span>
  border-<span class="hljs-attr">color</span>: <span class="hljs-title function_">var</span>(--el-color-primary-dark-<span class="hljs-number">2</span>);  <span class="hljs-comment">/* #337ecc */</span>
}
</code></pre>
<h2 data-id="heading-5">六、完整流程图</h2>
<pre><code class="hljs language-js" lang="js">┌─────────────────────────────────────────────────────────┐
│ 阶段 <span class="hljs-number">1</span>: 基础颜色定义                                     │
│ <span class="hljs-keyword">var</span>.<span class="hljs-property">scss</span>: primary.<span class="hljs-property">base</span> = #409eff                       │
└─────────────────┬───────────────────────────────────────┘
                  ↓
┌─────────────────────────────────────────────────────────┐
│ 阶段 <span class="hljs-number">2</span>: 自动生成颜色变体                                 │
│ set-color-mix-<span class="hljs-title function_">level</span>()                                   │
│ - primary.<span class="hljs-property">light</span>-<span class="hljs-number">3</span> = #79bbff (<span class="hljs-number">30</span>% 白色混合)             │
│ - primary.<span class="hljs-property">dark</span>-<span class="hljs-number">2</span> = #337ecc (<span class="hljs-number">20</span>% 黑色混合)              │
└─────────────────┬───────────────────────────────────────┘
                  ↓
┌─────────────────────────────────────────────────────────┐
│ 阶段 <span class="hljs-number">3</span>: 生成全局 <span class="hljs-variable constant_">CSS</span> 变量                                │
│ <span class="hljs-keyword">var</span>.<span class="hljs-property">scss</span>: :root {                                       │
│   --el-color-<span class="hljs-attr">primary</span>: #409eff                          │
│   --el-color-primary-light-<span class="hljs-number">3</span>: #79bbff                  │
│   --el-color-primary-dark-<span class="hljs-number">2</span>: #337ecc                    │
│ }                                                       │
└─────────────────┬───────────────────────────────────────┘
                  ↓
┌─────────────────────────────────────────────────────────┐
│ 阶段 <span class="hljs-number">4</span>: 按钮组件使用颜色                                  │
│ button-<span class="hljs-title function_">variant</span>(<span class="hljs-string">'primary'</span>)                                │
│ 生成组件级 <span class="hljs-variable constant_">CSS</span> 变量：                                     │
│ --el-button-bg-<span class="hljs-attr">color</span>: <span class="hljs-title function_">var</span>(--el-color-primary)           │
│ --el-button-hover-bg-<span class="hljs-attr">color</span>: <span class="hljs-title function_">var</span>(--el-color-primary-light-<span class="hljs-number">3</span>)│
│ --el-button-active-bg-<span class="hljs-attr">color</span>: <span class="hljs-title function_">var</span>(--el-color-primary-dark-<span class="hljs-number">2</span>)│
└─────────────────┬───────────────────────────────────────┘
                  ↓
┌─────────────────────────────────────────────────────────┐
│ 阶段 <span class="hljs-number">5</span>: 最终渲染                                         │
│ .<span class="hljs-property">el</span>-button--primary {                                   │
│   background-<span class="hljs-attr">color</span>: <span class="hljs-title function_">var</span>(--el-button-bg-color);          │
│   <span class="hljs-comment">/* 浏览器解析为 #409eff */</span>                            │
│ }                                                       │
└─────────────────────────────────────────────────────────┘
</code></pre>
<h2 data-id="heading-6">七、优势</h2>
<ul>
<li>统一管理：所有颜色在一个地方定义。</li>
</ul>

<ul>
<li>自动计算：light/dark 变体自动生成。</li>
</ul>

<ul>
<li>易于定制：修改基础色即可影响所有变体和组件。</li>
</ul>

<ul>
<li>性能：使用 CSS 变量，支持运行时动态切换主题。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[深度解析：基于 Prompt 演进策略的企业级自动化 Agent 架构设计]]></title>    <link>https://juejin.cn/post/7577905525997158441</link>    <guid>https://juejin.cn/post/7577905525997158441</guid>    <pubDate>2025-11-30T03:20:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577905525997158441" data-draft-id="7577704980855980086" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="深度解析：基于 Prompt 演进策略的企业级自动化 Agent 架构设计"/> <meta itemprop="keywords" content="LLM"/> <meta itemprop="datePublished" content="2025-11-30T03:20:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="念心之所向"/> <meta itemprop="url" content="https://juejin.cn/user/2681042882018763"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            深度解析：基于 Prompt 演进策略的企业级自动化 Agent 架构设计
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2681042882018763/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    念心之所向
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T03:20:05.000Z" title="Sun Nov 30 2025 03:20:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    9
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读17分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1. 引言：从简单问答到复杂工作流的演进</h2>
<p>在人工智能技术快速发展的今天，我们正经历着从简单的问答交互向复杂工作流自动化的重大转变。想象一下，如果 AI 不仅能回答问题，还能像一位经验丰富的工程师那样，自动分析日志、诊断问题、修复配置并生成总结报告——这正是本文要探讨的自主工作流 Agent 所能实现的。</p>
<h3 data-id="heading-1">1.1 为什么需要自主工作流 Agent？</h3>
<p>在日常的运维和开发工作中，我们经常遇到这样的场景：系统出现异常时，工程师需要查看多个日志文件、分析错误模式、修改配置文件，最后记录修复过程。这个过程涉及多个步骤、多种工具，以及基于上下文的持续推理。传统的 AI 系统往往只能完成其中的单个步骤，而缺乏整体工作流的协调能力。</p>
<p><strong>核心挑战在于</strong>：如何让 AI 系统在长时间、多步骤的任务中保持目标的一致性？如何在复杂的工具调用序列中做出正确的决策？更重要的是，如何通过有效的 Prompt 设计来引导 AI 完成整个工作流？</p>
<h2 data-id="heading-2">2. 系统架构设计：MCP 协议的力量</h2>
<p>为了深入理解 Prompt 演进策略的设计原理，我们首先需要了解背后的系统架构。MCP（Model Context Protocol）协议为我们提供了一套标准化的交互框架，让 AI 系统能够有效地使用工具并保持上下文。</p>
<h3 data-id="heading-3">2.1 抽象交互流程：理解系统如何运作</h3>
<p>让我们通过一个生动的比喻来理解这个流程：把 AI Agent 想象成一位在图书馆中研究问题的学者，而 MCP 协议就是图书管理员的工作规范。</p>
<p>text</p>
<pre><code class="hljs language-arduino" lang="arduino">读者（用户）提出研究问题 → 学者（LLM <span class="hljs-built_in">Client</span>）
学者 → 向图书管理员（MCP <span class="hljs-built_in">Server</span>）咨询可用资源
图书管理员 → 提供图书馆目录和检索工具（Prompt 模板）
学者 → 制定研究计划 → 开始研究（调用 LLM）

学者需要某本书 → 向图书管理员请求（tool call）
图书管理员 → 找到书籍并交付（执行工具）
学者 → 阅读书籍内容 → 继续研究（继续推理）

学者遇到疑难 → 请求更多资料（sampling）
图书管理员 → 提供相关文献清单（采样请求）
学者 → 分析新资料 → 调整研究方向
</code></pre>
<p>这个比喻帮助我们理解：学者（AI）在整个过程中保持研究目标，而图书管理员（MCP Server）提供必要的资源支持，两者通过标准化的协议协同工作。</p>
<h3 data-id="heading-4">2.2 具体示例场景：为什么选择这个案例？</h3>
<p>为了具象化地讲解 Prompt 演进策略，我们设计了一个典型的运维场景。这个场景不是随意选择的，而是因为它包含了自主工作流 Agent 需要面对的几个关键挑战：</p>
<ol>
<li><strong>多步骤性</strong>：需要依次执行文件列表、内容搜索、配置读取和修改</li>
<li><strong>上下文依赖性</strong>：后续决策依赖于前序步骤的结果</li>
<li><strong>推理需求</strong>：需要从分散的证据中识别模式并做出诊断</li>
<li><strong>动作执行</strong>：最终要执行具体的修改操作</li>
</ol>
<p><strong>用户需求</strong>："分析 /project/logs 下最近 24 小时的错误，修复 /project/config.yaml 中相关配置，并生成修复总结。"</p>
<blockquote>
<p><strong>技术说明</strong>：为了简化示例和聚焦于核心的 Prompt 演进策略，我们在本文中暂不实现精确的 24 小时时间过滤。在实际生产环境中，可以通过以下方式实现：</p>
<ol>
<li>在 <code>grep</code> 工具中增加时间范围参数</li>
<li>添加专门的 <code>filter_logs_by_time</code> 工具</li>
<li>或者在日志文件名中体现日期信息供 Agent 识别</li>
</ol>
</blockquote>
<p>这个需求看似简单，但深入分析会发现，它隐含着复杂的工作流：首先要了解有哪些日志文件，然后搜索错误信息，接着分析错误模式，读取当前配置，基于证据做出修改决策，最后验证结果并生成报告。</p>
<h3 data-id="heading-5">2.3 工具设计：为任务量身定制</h3>
<p>基于对任务需求的分析，我们设计了专门的工具集。这些工具不是预先存在的，而是为了满足特定任务需求而精心设计的：</p>
<ul>
<li><strong><code>list_files(path)</code></strong> ：为什么需要这个工具？因为 Agent 首先需要了解可用的日志文件，而不是假设文件结构</li>
<li><strong><code>grep(path, keyword)</code></strong> ：为什么不是简单的文件读取？因为日志文件可能很大，需要针对性搜索错误信息</li>
<li><strong><code>read_file(path)</code></strong> ：用于读取配置文件，了解当前设置</li>
<li><strong><code>write_file(path, content)</code></strong> ：执行具体的修复操作</li>
</ul>
<p>每个工具的设计都考虑了任务的特性和 Agent 的决策需求。比如 <code>grep</code> 工具返回结构化的结果（包含时间戳和具体内容），而不是原始文本，这是为了便于后续的模式分析。</p>
<h2 data-id="heading-6">3. Prompt 工程的艺术：从静态到动态演进</h2>
<p>现在，让我们进入本文的核心：Prompt 的演进策略。传统的 Prompt 工程往往关注单次的交互优化，而自主工作流需要的是动态的、基于上下文的 Prompt 演进。</p>
<h3 data-id="heading-7">3.1 恒定基础：System Prompt 的设计哲学</h3>
<p>System Prompt 是 Agent 行为的"宪法"，它在整个工作流中保持不变，确保行为的一致性。让我们深入分析其设计考量：</p>
<p>json</p>
<pre><code class="hljs language-swift" lang="swift">{
  <span class="hljs-string">"role"</span>: <span class="hljs-string">"system"</span>, 
  <span class="hljs-string">"content"</span>: <span class="hljs-string">"你是一个自主工作流智能体（Agent），能够规划并执行多步任务，并使用授权工具完成操作。<span class="hljs-subst">\n</span><span class="hljs-subst">\n</span>【输出格式】<span class="hljs-subst">\n</span>1) 必须严格输出 JSON，顶层对象必须包含以下字段：<span class="hljs-subst">\n</span>{<span class="hljs-subst">\n</span>  "</span>action<span class="hljs-string">": "</span><span class="hljs-operator">&lt;</span>tool<span class="hljs-operator">|</span>finish<span class="hljs-operator">|</span>ask<span class="hljs-operator">&gt;</span><span class="hljs-string">",<span class="hljs-subst">\n</span>  "</span>next_step<span class="hljs-string">": null | { "</span>tool<span class="hljs-string">": "</span><span class="hljs-operator">&lt;</span>tool_name<span class="hljs-operator">&gt;</span><span class="hljs-string">", "</span>arguments<span class="hljs-string">": { ... } },<span class="hljs-subst">\n</span>  "</span>notes<span class="hljs-string">": "</span><span class="hljs-operator">&lt;</span>给人类的简短说明<span class="hljs-operator">&gt;</span><span class="hljs-string">"<span class="hljs-subst">\n</span>}<span class="hljs-subst">\n</span>- action=tool → 表示下一步要调用工具<span class="hljs-subst">\n</span>- action=finish → 表示任务完成，最终结果写入 notes<span class="hljs-subst">\n</span>- action=ask → 需要用户澄清，notes 写问题说明<span class="hljs-subst">\n</span>- next_step=null → 表示本轮不调用工具<span class="hljs-subst">\n</span><span class="hljs-subst">\n</span>【可用工具】<span class="hljs-subst">\n</span>你只能使用已注册的工具，每个工具执行单一操作：<span class="hljs-subst">\n</span>- list_files(path)：列出目录中的文件<span class="hljs-subst">\n</span>- read_file(path)：读取文件内容<span class="hljs-subst">\n</span>- grep(path, keyword)：搜索文件关键字<span class="hljs-subst">\n</span>- write_file(path, content)：写入文件内容，返回 {ok:true}<span class="hljs-subst">\n</span>（注意：运行时将提供工具完整 schema，确保调用时使用正确的工具名和参数）<span class="hljs-subst">\n</span><span class="hljs-subst">\n</span>【上下文与规则】<span class="hljs-subst">\n</span>- 始终参考完整历史上下文（系统 Prompt + 用户输入 + 之前的 agent 动作 + 工具结果）<span class="hljs-subst">\n</span>- 工具结果为权威信息<span class="hljs-subst">\n</span>- 保留 session_id，不要修改<span class="hljs-subst">\n</span>- 不得调用未注册工具<span class="hljs-subst">\n</span>- 不输出敏感或私密信息，可摘要或脱敏<span class="hljs-subst">\n</span>- 如果无法生成有效 JSON 或不确定，返回：<span class="hljs-subst">\n</span>  {"</span>action<span class="hljs-string">":"</span>ask<span class="hljs-string">","</span>next_step<span class="hljs-string">":null,"</span>notes<span class="hljs-string">":"</span>需要澄清: <span class="hljs-operator">...</span><span class="hljs-string">"} <span class="hljs-subst">\n</span><span class="hljs-subst">\n</span>【示例】<span class="hljs-subst">\n</span>示例1：<span class="hljs-subst">\n</span>{"</span>action<span class="hljs-string">":"</span>tool<span class="hljs-string">","</span>next_step<span class="hljs-string">":{"</span>tool<span class="hljs-string">":"</span>list_files<span class="hljs-string">","</span>arguments<span class="hljs-string">":{"</span>path<span class="hljs-string">":"</span><span class="hljs-operator">/</span>project<span class="hljs-operator">/</span>logs<span class="hljs-string">"}},"</span>notes<span class="hljs-string">":"</span>列出日志目录文件<span class="hljs-string">"}<span class="hljs-subst">\n</span>示例2：<span class="hljs-subst">\n</span>{"</span>action<span class="hljs-string">":"</span>finish<span class="hljs-string">","</span>next_step<span class="hljs-string">":null,"</span>notes<span class="hljs-string">":"</span>已发现 <span class="hljs-number">3</span> 个错误，修改了配置文件 max_connections 和 timeout_ms<span class="hljs-string">"}"</span>
}
</code></pre>
<p>这个 System Prompt 的每个部分都经过精心设计：</p>
<ul>
<li><strong>中文界面友好</strong>：面向中文用户，提供清晰易懂的指导</li>
<li><strong>严格的 JSON 输出格式</strong>：确保机器可解析性，使系统能够可靠地提取动作指令</li>
<li><strong>明确的动作类型</strong>：<code>tool|finish|ask</code> 覆盖了所有可能的状态转换</li>
<li><strong>错误处理机制</strong>：特别强调当不确定时使用 <code>ask</code> 动作，这是健壮性的关键</li>
</ul>
<h2 data-id="heading-8">3.2 动态演进：Prompt 如何随着证据积累而成长</h2>
<p>Prompt 演进的核心思想是：<strong>每一步的决策都基于前序步骤积累的证据</strong>。让我们通过完整的交互序列来理解这个演进过程。</p>
<h3 data-id="heading-9">阶段一：探索与发现（初始规划 → 工具调用）</h3>
<p><strong>初始 Prompt</strong>：</p>
<p>json</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-attr">[  {<span class="hljs-string">"role"</span>: <span class="hljs-string">"system"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"&lt;恒定 system prompt&gt;"</span>},  {<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"用户目标：分析 /project/logs 最近 24 小时的错误，修复 /project/config.yaml 中相关配置，并生成修复总结。"</span>},  {<span class="hljs-string">"role"</span>: <span class="hljs-string">"system"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"可用资源：/project/logs (目录), /project/config.yaml (文件)。工具：list_files, read_file, grep, write_file。"</span>}]</span>
</code></pre>
<p><strong>LLM 响应</strong>：</p>
<p>json</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"action"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"tool"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"next_step"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"tool"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"list_files"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"arguments"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-attr">"path"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"/project/logs"</span><span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"notes"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"首先探索日志目录，了解可用的日志文件"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>工具执行结果</strong>：</p>
<p>json</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"files"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"/project/logs/app.log"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"/project/logs/db.log"</span><span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-10">阶段二：深度调查（逐步分析多个日志文件）</h3>
<p><strong>重要说明</strong>：LLM 不会一次性返回多个工具调用。它会基于前一个工具的结果，逐步决定下一步行动。这就是"grep × 2"的含义——需要两次独立的决策和执行循环。</p>
<h4 data-id="heading-11">第一次 grep 决策循环</h4>
<p><strong>演进后的 Prompt</strong>：</p>
<p>json</p>
<pre><code class="hljs language-bash" lang="bash">[
  {<span class="hljs-string">"role"</span>: <span class="hljs-string">"system"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"&lt;恒定 system prompt&gt;"</span>},
  {<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"用户目标：分析 /project/logs 最近 24 小时的错误..."</span>},
  {<span class="hljs-string">"role"</span>: <span class="hljs-string">"system"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"可用资源：/project/logs (目录), /project/config.yaml (文件)。工具：list_files, read_file, grep, write_file。"</span>},
  
  {<span class="hljs-string">"role"</span>: <span class="hljs-string">"assistant"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"{"</span>action<span class="hljs-string">":"</span>tool<span class="hljs-string">","</span>next_step<span class="hljs-string">":{"</span>tool<span class="hljs-string">":"</span>list_files<span class="hljs-string">","</span>arguments<span class="hljs-string">":{"</span>path<span class="hljs-string">":"</span>/project/logs<span class="hljs-string">"}},"</span>notes<span class="hljs-string">":"</span>首先探索日志目录，了解可用的日志文件<span class="hljs-string">"}"</span>},
  {<span class="hljs-string">"role"</span>: <span class="hljs-string">"tool"</span>, <span class="hljs-string">"name"</span>: <span class="hljs-string">"list_files"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"{"</span>files<span class="hljs-string">": ["</span>/project/logs/app.log<span class="hljs-string">", "</span>/project/logs/db.log<span class="hljs-string">"]}"</span>},
  {<span class="hljs-string">"role"</span>: <span class="hljs-string">"tool-observation"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"发现两个日志文件：app.log 和 db.log。请决定下一步操作。"</span>}
]
</code></pre>
<p><strong>LLM 响应</strong>：</p>
<p>json</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"action"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"tool"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"next_step"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"tool"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"grep"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"arguments"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-attr">"path"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"/project/logs/app.log"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"keyword"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"ERROR"</span><span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"notes"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"先检查 app.log 中的错误信息"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>工具执行结果</strong>：</p>
<p>json</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"path"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"/project/logs/app.log"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"matches"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span><span class="hljs-attr">"ts"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2025-11-28T10:34:22"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"line"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"ERROR Failed to connect to DB"</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span><span class="hljs-attr">"ts"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2025-11-28T11:02:10"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"line"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"ERROR Timeout occurred in module X"</span><span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h4 data-id="heading-12">第二次 grep 决策循环</h4>
<p><strong>再次演进的 Prompt</strong>：</p>
<p>json</p>
<pre><code class="hljs language-lua" lang="lua">[
  {<span class="hljs-string">"role"</span>: <span class="hljs-string">"system"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"&lt;恒定 system prompt&gt;"</span>},
  {<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"用户目标：分析 /project/logs 最近 24 小时的错误..."</span>},
  {<span class="hljs-string">"role"</span>: <span class="hljs-string">"system"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"可用资源：/project/logs (目录), /project/config.yaml (文件)。工具：list_files, read_file, grep, write_file。"</span>},
  
  {<span class="hljs-string">"role"</span>: <span class="hljs-string">"assistant"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"{"</span>action<span class="hljs-string">":"</span>tool<span class="hljs-string">","</span>next_step<span class="hljs-string">":{"</span>tool<span class="hljs-string">":"</span>list_files<span class="hljs-string">","</span>arguments<span class="hljs-string">":{"</span><span class="hljs-built_in">path</span><span class="hljs-string">":"</span>/project/logs<span class="hljs-string">"}},"</span>notes<span class="hljs-string">":"</span>首先探索日志目录，了解可用的日志文件<span class="hljs-string">"}"</span>},
  {<span class="hljs-string">"role"</span>: <span class="hljs-string">"tool"</span>, <span class="hljs-string">"name"</span>: <span class="hljs-string">"list_files"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"{"</span>files<span class="hljs-string">": ["</span>/project/logs/app.<span class="hljs-built_in">log</span><span class="hljs-string">", "</span>/project/logs/db.<span class="hljs-built_in">log</span><span class="hljs-string">"]}"</span>},
  
  {<span class="hljs-string">"role"</span>: <span class="hljs-string">"assistant"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"{"</span>action<span class="hljs-string">":"</span>tool<span class="hljs-string">","</span>next_step<span class="hljs-string">":{"</span>tool<span class="hljs-string">":"</span>grep<span class="hljs-string">","</span>arguments<span class="hljs-string">":{"</span><span class="hljs-built_in">path</span><span class="hljs-string">":"</span>/project/logs/app.<span class="hljs-built_in">log</span><span class="hljs-string">","</span>keyword<span class="hljs-string">":"</span>ERROR<span class="hljs-string">"}},"</span>notes<span class="hljs-string">":"</span>先检查 app.<span class="hljs-built_in">log</span> 中的错误信息<span class="hljs-string">"}"</span>},
  {<span class="hljs-string">"role"</span>: <span class="hljs-string">"tool"</span>, <span class="hljs-string">"name"</span>: <span class="hljs-string">"grep"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"{"</span><span class="hljs-built_in">path</span><span class="hljs-string">": "</span>/project/logs/app.<span class="hljs-built_in">log</span><span class="hljs-string">", "</span>matches<span class="hljs-string">": [{"</span>ts<span class="hljs-string">": "</span><span class="hljs-number">2025</span><span class="hljs-number">-11</span><span class="hljs-number">-28</span>T10:<span class="hljs-number">34</span>:<span class="hljs-number">22</span><span class="hljs-string">", "</span>line<span class="hljs-string">": "</span>ERROR Failed to connect to DB<span class="hljs-string">"}, {"</span>ts<span class="hljs-string">": "</span><span class="hljs-number">2025</span><span class="hljs-number">-11</span><span class="hljs-number">-28</span>T11:<span class="hljs-number">02</span>:<span class="hljs-number">10</span><span class="hljs-string">", "</span>line<span class="hljs-string">": "</span>ERROR Timeout occurred <span class="hljs-keyword">in</span> <span class="hljs-built_in">module</span> X<span class="hljs-string">"}]}"</span>},
  
  {<span class="hljs-string">"role"</span>: <span class="hljs-string">"tool-observation"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"在 app.log 中发现 2 个错误，包括数据库连接失败和超时错误。请决定是否检查 db.log 以获得完整情况。"</span>}
]
</code></pre>
<p><strong>LLM 响应</strong>：</p>
<p>json</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"action"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"tool"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"next_step"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"tool"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"grep"</span><span class="hljs-punctuation">,</span> 
    <span class="hljs-attr">"arguments"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-attr">"path"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"/project/logs/db.log"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"keyword"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"ERROR"</span><span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"notes"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"继续检查 db.log 以获取完整的错误画面"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>工具执行结果</strong>：</p>
<p>json</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"path"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"/project/logs/db.log"</span><span class="hljs-punctuation">,</span> 
  <span class="hljs-attr">"matches"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span><span class="hljs-attr">"ts"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2025-11-28T09:28:01"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"line"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"ERROR Connection pool exhausted"</span><span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-13">阶段三：诊断与决策（分析根本原因）</h3>
<p><strong>完整演进的 Prompt</strong>：</p>
<p>json</p>
<pre><code class="hljs language-python" lang="python">[
  {<span class="hljs-string">"role"</span>: <span class="hljs-string">"system"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"&lt;恒定 system prompt&gt;"</span>},
  {<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"用户目标：分析 /project/logs 最近 24 小时的错误..."</span>},
  {<span class="hljs-string">"role"</span>: <span class="hljs-string">"system"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"可用资源：/project/logs (目录), /project/config.yaml (文件)。工具：list_files, read_file, grep, write_file。"</span>},
  
  // 历史交互记录
  {<span class="hljs-string">"role"</span>: <span class="hljs-string">"assistant"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"{"</span>action<span class="hljs-string">":"</span>tool<span class="hljs-string">","</span>next_step<span class="hljs-string">":{"</span>tool<span class="hljs-string">":"</span>list_files<span class="hljs-string">","</span>arguments<span class="hljs-string">":{"</span>path<span class="hljs-string">":"</span>/project/logs<span class="hljs-string">"}},"</span>notes<span class="hljs-string">":"</span>首先探索日志目录，了解可用的日志文件<span class="hljs-string">"}"</span>},
  {<span class="hljs-string">"role"</span>: <span class="hljs-string">"tool"</span>, <span class="hljs-string">"name"</span>: <span class="hljs-string">"list_files"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"{"</span>files<span class="hljs-string">": ["</span>/project/logs/app.log<span class="hljs-string">", "</span>/project/logs/db.log<span class="hljs-string">"]}"</span>},
  
  {<span class="hljs-string">"role"</span>: <span class="hljs-string">"assistant"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"{"</span>action<span class="hljs-string">":"</span>tool<span class="hljs-string">","</span>next_step<span class="hljs-string">":{"</span>tool<span class="hljs-string">":"</span>grep<span class="hljs-string">","</span>arguments<span class="hljs-string">":{"</span>path<span class="hljs-string">":"</span>/project/logs/app.log<span class="hljs-string">","</span>keyword<span class="hljs-string">":"</span>ERRO<span class="hljs-string">R"}},"</span>notes<span class="hljs-string">":"</span>先检查 app.log 中的错误信息<span class="hljs-string">"}"</span>},
  {<span class="hljs-string">"role"</span>: <span class="hljs-string">"tool"</span>, <span class="hljs-string">"name"</span>: <span class="hljs-string">"grep"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"{"</span>path<span class="hljs-string">": "</span>/project/logs/app.log<span class="hljs-string">", "</span>matches<span class="hljs-string">": [{"</span>ts<span class="hljs-string">": "</span><span class="hljs-number">2025</span>-<span class="hljs-number">11</span>-28T10:<span class="hljs-number">34</span>:<span class="hljs-number">22</span><span class="hljs-string">", "</span>line<span class="hljs-string">": "</span>ERROR Failed to connect to D<span class="hljs-string">B"}, {"</span>ts<span class="hljs-string">": "</span><span class="hljs-number">2025</span>-<span class="hljs-number">11</span>-28T11:02:<span class="hljs-number">10</span><span class="hljs-string">", "</span>line<span class="hljs-string">": "</span>ERROR Timeout occurred <span class="hljs-keyword">in</span> module X<span class="hljs-string">"}]}"</span>},
  
  {<span class="hljs-string">"role"</span>: <span class="hljs-string">"assistant"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"{"</span>action<span class="hljs-string">":"</span>tool<span class="hljs-string">","</span>next_step<span class="hljs-string">":{"</span>tool<span class="hljs-string">":"</span>grep<span class="hljs-string">","</span>arguments<span class="hljs-string">":{"</span>path<span class="hljs-string">":"</span>/project/logs/db.log<span class="hljs-string">","</span>keyword<span class="hljs-string">":"</span>ERRO<span class="hljs-string">R"}},"</span>notes<span class="hljs-string">":"</span>继续检查 db.log 以获取完整的错误画面<span class="hljs-string">"}"</span>},
  {<span class="hljs-string">"role"</span>: <span class="hljs-string">"tool"</span>, <span class="hljs-string">"name"</span>: <span class="hljs-string">"grep"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"{"</span>path<span class="hljs-string">": "</span>/project/logs/db.log<span class="hljs-string">", "</span>matches<span class="hljs-string">": [{"</span>ts<span class="hljs-string">": "</span><span class="hljs-number">2025</span>-<span class="hljs-number">11</span>-28T09:<span class="hljs-number">28</span>:01<span class="hljs-string">", "</span>line<span class="hljs-string">": "</span>ERROR Connection pool exhausted<span class="hljs-string">"}]}"</span>},
  
  {<span class="hljs-string">"role"</span>: <span class="hljs-string">"tool-observation"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"在多个日志中发现数据库相关错误：app.log 中有数据库连接失败和超时错误，db.log 中有连接池耗尽错误。请分析根本原因。"</span>}
]
</code></pre>
<p><strong>LLM 响应</strong>：</p>
<p>json</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"action"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"tool"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"next_step"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"tool"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"read_file"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"arguments"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-attr">"path"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"/project/config.yaml"</span><span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"notes"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"多个日志都指向数据库连接问题，需要检查当前数据库配置以确定根本原因"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>工具执行结果</strong>：</p>
<p>json</p>
<pre><code class="hljs language-swift" lang="swift">{
  <span class="hljs-string">"path"</span>: <span class="hljs-string">"/project/config.yaml"</span>,
  <span class="hljs-string">"content"</span>: <span class="hljs-string">"port: 8080<span class="hljs-subst">\n</span>log: info<span class="hljs-subst">\n</span>max_connections: 50<span class="hljs-subst">\n</span>timeout_ms: 1000"</span>
}
</code></pre>
<h3 data-id="heading-14">阶段四：修复执行（基于证据的配置修改）</h3>
<p><strong>进一步演进的 Prompt</strong>：</p>
<p>json</p>
<pre><code class="hljs language-lua" lang="lua">[
  {<span class="hljs-string">"role"</span>: <span class="hljs-string">"system"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"&lt;恒定 system prompt&gt;"</span>},
  {<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"用户目标：分析 /project/logs 最近 24 小时的错误..."</span>},
  
  // 简化的历史记录（实际可能进行摘要处理）
  {<span class="hljs-string">"role"</span>: <span class="hljs-string">"tool"</span>, <span class="hljs-string">"name"</span>: <span class="hljs-string">"grep"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"{"</span><span class="hljs-built_in">path</span><span class="hljs-string">": "</span>/project/logs/app.<span class="hljs-built_in">log</span><span class="hljs-string">", "</span>matches<span class="hljs-string">": [{"</span>ts<span class="hljs-string">": "</span><span class="hljs-number">2025</span><span class="hljs-number">-11</span><span class="hljs-number">-28</span>T10:<span class="hljs-number">34</span>:<span class="hljs-number">22</span><span class="hljs-string">", "</span>line<span class="hljs-string">": "</span>ERROR Failed to connect to DB<span class="hljs-string">"}, ...]}"</span>},
  {<span class="hljs-string">"role"</span>: <span class="hljs-string">"tool"</span>, <span class="hljs-string">"name"</span>: <span class="hljs-string">"grep"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"{"</span><span class="hljs-built_in">path</span><span class="hljs-string">": "</span>/project/logs/db.<span class="hljs-built_in">log</span><span class="hljs-string">", "</span>matches<span class="hljs-string">": [{"</span>ts<span class="hljs-string">": "</span><span class="hljs-number">2025</span><span class="hljs-number">-11</span><span class="hljs-number">-28</span>T09:<span class="hljs-number">28</span>:<span class="hljs-number">01</span><span class="hljs-string">", "</span>line<span class="hljs-string">": "</span>ERROR Connection pool exhausted<span class="hljs-string">"}]}"</span>},
  {<span class="hljs-string">"role"</span>: <span class="hljs-string">"tool"</span>, <span class="hljs-string">"name"</span>: <span class="hljs-string">"read_file"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"{"</span><span class="hljs-built_in">path</span><span class="hljs-string">": "</span>/project/<span class="hljs-built_in">config</span>.yaml<span class="hljs-string">", "</span>content<span class="hljs-string">": "</span>port: <span class="hljs-number">8080</span>\nlog: info\nmax_connections: <span class="hljs-number">50</span>\ntimeout_ms: <span class="hljs-number">1000</span><span class="hljs-string">"}"</span>},
  
  {<span class="hljs-string">"role"</span>: <span class="hljs-string">"tool-observation"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"获得完整证据链：日志显示数据库连接问题和连接池耗尽，当前配置为 max_connections: 50, timeout_ms: 1000。请提出修复方案。"</span>}
]
</code></pre>
<p><strong>LLM 响应</strong>：</p>
<p>json</p>
<pre><code class="hljs language-swift" lang="swift">{
  <span class="hljs-string">"action"</span>: <span class="hljs-string">"tool"</span>,
  <span class="hljs-string">"next_step"</span>: {
    <span class="hljs-string">"tool"</span>: <span class="hljs-string">"write_file"</span>,
    <span class="hljs-string">"arguments"</span>: {
      <span class="hljs-string">"path"</span>: <span class="hljs-string">"/project/config.yaml"</span>,
      <span class="hljs-string">"content"</span>: <span class="hljs-string">"port: 8080<span class="hljs-subst">\n</span>log: info<span class="hljs-subst">\n</span>max_connections: 100<span class="hljs-subst">\n</span>timeout_ms: 5000"</span>
    }
  },
  <span class="hljs-string">"notes"</span>: <span class="hljs-string">"基于错误证据，将最大连接数从 50 增加到 100，超时时间从 1000ms 增加到 5000ms 以解决连接池耗尽和超时问题"</span>
}
</code></pre>
<p><strong>工具执行结果</strong>：</p>
<p>json</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"result"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"success"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"path"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"/project/config.yaml"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-15">阶段五：总结验证（任务完成）</h3>
<p><strong>最终 Prompt</strong>：</p>
<p>json</p>
<pre><code class="hljs language-arduino" lang="arduino">[
  {<span class="hljs-string">"role"</span>: <span class="hljs-string">"system"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"&lt;恒定 system prompt&gt;"</span>},
  {<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"用户目标：分析 /project/logs 最近 24 小时的错误..."</span>},
  
  <span class="hljs-comment">// 关键历史记录</span>
  {<span class="hljs-string">"role"</span>: <span class="hljs-string">"tool"</span>, <span class="hljs-string">"name"</span>: <span class="hljs-string">"write_file"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"{"</span>result<span class="hljs-string">": "</span>success<span class="hljs-string">", "</span>path<span class="hljs-string">": "</span>/project/config.yaml<span class="hljs-string">"}"</span>},
  
  {<span class="hljs-string">"role"</span>: <span class="hljs-string">"tool-observation"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"配置文件更新成功。请生成任务总结。"</span>}
]
</code></pre>
<p><strong>LLM 最终响应</strong>：</p>
<p>json</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"action"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"finish"</span><span class="hljs-punctuation">,</span> 
  <span class="hljs-attr">"next_step"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"notes"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"任务完成。分析结果：在 app.log 中发现 2 个错误（数据库连接失败、超时），在 db.log 中发现 1 个错误（连接池耗尽）。修复措施：将 max_connections 从 50 增加到 100，timeout_ms 从 1000 增加到 5000。建议：监控系统 24 小时，如问题持续需进一步调查数据库服务器状态。"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h2 data-id="heading-16">4. 关键技术细节：让系统更加健壮</h2>
<h3 data-id="heading-17">4.1 错误处理：当事情不如预期时</h3>
<p>在真实环境中，工具执行可能会失败，AI 的响应可能不符合预期。我们的 Prompt 演进策略需要包含健壮的错误处理机制。</p>
<p><strong>正确的错误处理流程</strong>：</p>
<p>假设 <code>grep</code> 工具执行时遇到文件不存在的错误，系统会返回：</p>
<p>json</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"error"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"File not found: /project/logs/app.log"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"suggestion"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Check if the file path is correct"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>这时，Prompt 会演进为：</p>
<p>json</p>
<pre><code class="hljs language-python" lang="python">[
  // ... 历史上下文
  {<span class="hljs-string">"role"</span>: <span class="hljs-string">"tool"</span>, <span class="hljs-string">"name"</span>: <span class="hljs-string">"grep"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"{"</span>erro<span class="hljs-string">r": "</span>File <span class="hljs-keyword">not</span> found: /project/logs/app.log<span class="hljs-string">"}"</span>},
  {<span class="hljs-string">"role"</span>: <span class="hljs-string">"tool-observation"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"grep 执行失败：文件不存在。请基于此错误调整策略"</span>}
]
</code></pre>
<p><strong>正确的 Agent 响应应该是</strong>：</p>
<p>json</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"action"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"ask"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"next_step"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"notes"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"尝试读取 /project/logs/app.log 时发现文件不存在。请确认：1) 文件路径是否正确？2) 是否有其他日志文件需要检查？"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>这种设计体现了 System Prompt 中强调的原则：当遇到不确定或无法自动解决的问题时，明智地使用 <code>ask</code> 动作寻求用户指导，而不是盲目重试或做出可能错误的假设。</p>
<p><strong>基于错误调整策略</strong>：在某些可自动恢复的错误情况下，Agent 可能会决定先检查文件是否存在，或者尝试其他日志文件。</p>
<p><strong>提供备选方案</strong>：如果多个工具都失败，Agent 应该能够生成备选方案，比如建议手动检查文件权限。</p>
<h3 data-id="heading-18">4.2 上下文管理：在深度与效率间平衡</h3>
<p>随着工作流的进行，Prompt 会变得越来越长。我们需要智能的上下文管理策略：</p>
<ul>
<li><strong>完整历史模式</strong>：在开发阶段保留所有交互，便于理解和调试 Agent 的推理过程</li>
<li><strong>摘要模式</strong>：在生产环境中，对早期步骤生成智能摘要，保留关键决策点和证据，同时控制 token 数量</li>
</ul>
<h2 data-id="heading-19">5. 完整工作流演示：看着思维如何展开</h2>
<h3 data-id="heading-20">5.1 阶段映射：理解每个步骤的意义</h3>
<p>让我们通过一个详细的表格来可视化整个工作流中 Prompt 的演进过程：</p>















































<table><thead><tr><th>阶段</th><th>主要动作</th><th>决策关键点</th><th>Prompt 演进策略</th><th>具体示例说明</th></tr></thead><tbody><tr><td><strong>探索发现</strong></td><td>list_files</td><td>了解任务环境</td><td>提供目标上下文，引导系统探索</td><td>Agent 发现 <code>/project/logs</code> 下有 app.log 和 db.log 两个文件</td></tr><tr><td><strong>深度调查</strong></td><td>grep × 2</td><td>错误模式识别</td><td>注入多源证据，促进关联分析</td><td>先查 app.log 发现 DB 连接错误，再查 db.log 发现连接池耗尽，关联识别数据库问题</td></tr><tr><td><strong>根本原因分析</strong></td><td>read_file</td><td>配置与问题的因果关系</td><td>提供完整证据链，支持诊断决策</td><td>读取 config.yaml 发现 max_connections: 50 和 timeout_ms: 1000 的配置不足</td></tr><tr><td><strong>修复执行</strong></td><td>write_file</td><td>具体修改方案生成</td><td>基于证据生成精确的操作参数</td><td>将配置修改为 max_connections: 100 和 timeout_ms: 5000</td></tr><tr><td><strong>总结验证</strong></td><td>finish</td><td>工作流完成确认</td><td>引导系统性总结和经验提炼</td><td>生成包含错误统计、修改内容和监控建议的完整报告</td></tr></tbody></table>
<h3 data-id="heading-21">5.2 决策节点分析：Prompt 如何引导推理</h3>
<p>在每个决策节点，Prompt 的设计都旨在引导特定的推理模式：</p>
<p><strong>在获得部分证据时</strong>：</p>
<ul>
<li>Prompt 提示："已从 app.log 中发现 X 个错误，是否检查 db.log 以获得完整情况？"</li>
<li>设计意图：引导系统考虑证据的完备性，而不是过早下结论</li>
</ul>
<p><strong>在获得完整证据时</strong>：</p>
<ul>
<li>Prompt 提示："基于所有日志中的错误模式，请分析根本原因"</li>
<li>设计意图：促进系统进行综合分析和模式识别</li>
</ul>
<h2 data-id="heading-22">6. 关键理解点总结</h2>
<ol>
<li><strong>逐步决策</strong>：LLM 每次只决定下一步动作，不会一次性规划所有步骤</li>
<li><strong>证据驱动</strong>：每个决策都基于前一个工具的实际返回结果</li>
<li><strong>上下文累积</strong>：Prompt 随着每个工具调用和返回而不断演进</li>
<li><strong>模式识别</strong>：通过多个 grep 结果的对比，LLM 能够识别跨文件的共同问题模式</li>
<li><strong>错误恢复</strong>：通过恰当的 <code>ask</code> 动作设计，确保系统在遇到困难时能够优雅地寻求帮助</li>
</ol>
<p>这种逐步演进的方式确保了决策的准确性和基于实际证据的可靠性，而不是基于假设或预设路径。</p>
<h2 data-id="heading-23">7. 总结：Prompt 演进的艺术与科学</h2>
<p>通过本文的详细分析，我们可以看到，优秀的自主工作流 Agent 不是通过复杂的算法实现的，而是通过精心设计的 Prompt 演进策略。</p>
<h3 data-id="heading-24">7.1 核心洞察</h3>
<ol>
<li><strong>起步于清晰</strong>：初始 Prompt 提供明确的任务边界和工具集，为整个工作流奠定基础</li>
<li><strong>演进于证据</strong>：每一步都基于前序结果，形成累积的知识建构</li>
<li><strong>决策于模式</strong>：通过多源证据的注入，引导系统识别模式而非处理孤立信息</li>
<li><strong>透明于过程</strong>：每个决策都有明确的理由记录，便于理解和审计</li>
<li><strong>健壮于错误</strong>：通过恰当的 <code>ask</code> 动作设计，确保系统在遇到困难时能够优雅地寻求帮助</li>
</ol>
<h3 data-id="heading-25">7.2 实践指导</h3>
<p>当您设计自己的自主工作流系统时，请考虑：</p>
<ul>
<li><strong>工具设计的针对性</strong>：工具应该为任务而生，而不是让任务适应工具</li>
<li><strong>证据的结构化</strong>：工具输出应该便于机器解析和模式识别</li>
<li><strong>上下文的渐进性</strong>：Prompt 应该像好老师一样，基于学生当前的理解水平提供适当的指导</li>
<li><strong>错误的建设性</strong>：错误处理不是简单的重试，而是基于新信息的策略调整，必要时寻求用户指导</li>
</ul>
<p>自主工作流 Agent 的技术正在快速发展，而良好的 Prompt 演进策略是实现其真正实用化的关键。通过本文阐述的方法，您应该能够设计出更加智能、可靠的 AI 系统，让它们真正成为工作中的得力助手。</p>
<p>记住，最好的 Prompt 设计不是控制 AI 的每一步动作，而是为它提供一个良好的思维环境，让它在正确的约束下展现出令人惊喜的智能行为。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Elasticsearch BKD 树与 PointRangeQuery：为何数值查询会有性能瓶颈]]></title>    <link>https://juejin.cn/post/7577705544876064806</link>    <guid>https://juejin.cn/post/7577705544876064806</guid>    <pubDate>2025-11-30T09:38:12.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577705544876064806" data-draft-id="7577971299743023142" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Elasticsearch BKD 树与 PointRangeQuery：为何数值查询会有性能瓶颈"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-30T09:38:12.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Penge666"/> <meta itemprop="url" content="https://juejin.cn/user/1549628692501449"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Elasticsearch BKD 树与 PointRangeQuery：为何数值查询会有性能瓶颈
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1549628692501449/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Penge666
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T09:38:12.000Z" title="Sun Nov 30 2025 09:38:12 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 Elasticsearch（ES）中，字符串类型（keyword）和数值 / 日期类型的索引结构截然不同 —— 前者用倒排索引，后者则依赖 BKD 树。这种差异源于查询场景的不同：数值 / 日期查询多为范围匹配，而 BKD 树天生适配这类需求。但鲜为人知的是，BKD 树在高效定位数据的同时，也暗藏着 Bitset 构造的性能瓶颈。本文将结合具体场景，拆解 BKD 树、PointRangeQuery 的执行逻辑，以及性能瓶颈的根源。</p>
<h2 data-id="heading-0">一、BKD 树：数值类型的 “专属索引”</h2>
<h3 data-id="heading-1">1. 为何不用倒排索引？</h3>
<p>对于<code>publish_time</code>这类日期字段的范围查询（如<code>&gt;=1748419000</code>），倒排索引会显得力不从心：它需要遍历所有时间戳词条，逐一匹配范围，效率极低。而 BKD 树（Block K-D tree）是一种<strong>空间划分树</strong>，能快速定位数值范围内的数据，成为数值 / 日期类型的最优选择。</p>
<h3 data-id="heading-2">2. BKD 树的核心结构</h3>
<p>BKD 树将数值 / 日期值按范围切分为多个<strong>Block（块）</strong> ，每个 Block 包含：</p>
<ul>
<li>有序的数值（如时间戳递增排列）；</li>
<li>对应数值的文档 ID（docid）列表。</li>
</ul>
<p>树的上层节点记录每个 Block 的数值范围，查询时先通过上层节点定位目标 Block，再扫描 Block 内数据，避免全量遍历。</p>
<h2 data-id="heading-3">二、场景还原：100 万文档的日期范围查询</h2>
<p>假设我们有一个<code>news</code>索引，包含 100 万篇文档，<code>publish_time</code>为 date 类型（存储时间戳），采用 ES 默认的 BKD 树结构。现在执行查询：<code>publish_time &gt;= 1748419000 AND publish_time &lt;= 1748505400</code>（2025 年 6 月 1 日～6 月 2 日）。</p>
<h3 data-id="heading-4">1. BKD 树的 Block 拆分</h3>
<p>ES 会将<code>publish_time</code>的时间戳按范围拆分为多个 Block，示例如下：</p>
<ul>
<li><strong>Block A</strong>：1748400000 ~ 1748450000 → docid 列表：<code>[5, 2, 9, 13, 7, ...]</code>（1.2 万篇）；</li>
<li><strong>Block B</strong>：1748450001 ~ 1748500000 → docid 列表：<code>[31, 18, 45, 22, ...]</code>（1.5 万篇）；</li>
<li><strong>Block C</strong>：1748500001 ~ 1748550000 → docid 列表：<code>[56, 72, 39, 88, ...]</code>（0.8 万篇）。</li>
</ul>
<p>每个 Block 内的<strong>时间戳有序</strong>（如 Block A 从 1748400000 递增到 1748450000），但<strong>docid 无序</strong>（文档写入顺序与时间戳无关）。</p>
<h2 data-id="heading-5">三、PointRangeQuery 的执行流程：高效定位与低效合并</h2>
<p>当执行范围查询时，ES 会将其转为<code>PointRangeQuery</code>，执行过程分为三步：</p>
<h3 data-id="heading-6">1. 定位目标 Block</h3>
<p><code>PointRangeQuery</code>先遍历 BKD 树的上层节点，快速匹配出与查询范围重叠的 Block—— 本例中为 A、B、C 三个 Block。</p>
<h3 data-id="heading-7">2. 提取匹配的 docid</h3>
<p>遍历每个 Block，筛选出时间戳符合条件的 docid：</p>
<ul>
<li>Block A：1748419000 ~ 1748450000 → docid 列表：<code>[5, 9, 13, 7, ...]</code>（0.8 万篇）；</li>
<li>Block B：1748450001 ~ 1748500000 → docid 列表：<code>[31, 45, 22, ...]</code>（1.5 万篇）；</li>
<li>Block C：1748500001 ~ 1748505400 → docid 列表：<code>[56, 39, ...]</code>（0.3 万篇）。</li>
</ul>
<p>这些 docid 列表是<strong>无序的</strong>（如 Block A 的<code>[5,9,13,7...]</code>）。</p>
<h3 data-id="heading-8">3. Bitset 构造：性能瓶颈的根源</h3>
<p>由于 docid 无序，无法用高效的 “跳表合并”（依赖有序性），ES 只能退而求其次 —— 为每个 Block 构造<strong>Bitset（位图）</strong> ，再通过位运算合并结果：</p>
<ul>
<li><strong>Block A 的 Bitset</strong>：初始化长度为 100 万的位图（对应所有文档 ID），将<code>5、9、13、7...</code>位置设为 1 → 占用约 122KB 内存；</li>
<li><strong>Block B/C 的 Bitset</strong>：同理，各占用 122KB 内存；</li>
<li><strong>位运算合并</strong>：对三个 Bitset 执行 OR 运算（范围查询是 “或” 逻辑），得到最终匹配的 docid 集合。</li>
</ul>
<h2 data-id="heading-9">四、性能瓶颈的具体体现</h2>
<h3 data-id="heading-10">1. Bitset 构造的开销</h3>
<ul>
<li><strong>内存分配</strong>：每个 Bitset 需分配与索引最大 docid 匹配的内存空间（本例 100 万 docid 对应 122KB），若查询命中 10 个 Block，内存开销会增至 1.2MB；</li>
<li><strong>docid 置位耗时</strong>：Block A 需循环 0.8 万次置位，三个 Block 总计 2.6 万次操作 —— 百万级文档场景下，这个过程会显著耗时。</li>
</ul>
<h3 data-id="heading-11">2. 无序 docid 的致命影响</h3>
<p>若 Block 内的 docid 是有序的（如<code>[2,5,7,9,13...]</code>），ES 可通过 “跳表合并”（双指针遍历）直接合并多个列表，无需构造 Bitset，速度能提升 3-5 倍。但 BKD 树按数值有序组织 Block，而非 docid 有序，导致这一优化无法实现。</p>
<h3 data-id="heading-12">3. 磁盘 IO 的叠加效应</h3>
<p>若 Block 未被缓存到内存，ES 需先从磁盘加载 Block 数据，再提取 docid 构造 Bitset—— 磁盘 IO 延迟会进一步放大性能瓶颈，使查询耗时翻倍。</p>
<h2 data-id="heading-13">五、如何突破性能瓶颈？</h2>
<ul>
<li>
<ol>
<li>预过滤缩小 docid 范围</li>
</ol>
</li>
<li>
<ol start="2">
<li>减少 Block 命中数量</li>
</ol>
<ul>
<li><strong>调整 BKD 树 Block 大小</strong>：增大 Block 可减少 Block 数量（如将默认 Block 大小从 4KB 调至 16KB）；</li>
<li><strong>时间分片索引</strong>：按月份拆分索引（如<code>news-2025-06</code>），查询时仅访问目标索引，避免全量扫描。</li>
</ul>
</li>
<li>
<ol start="3">
<li>利用缓存优化 IO</li>
</ol>
</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[ARouter 入门指南：从基本跳转到对象传递]]></title>    <link>https://juejin.cn/post/7577970969395331113</link>    <guid>https://juejin.cn/post/7577970969395331113</guid>    <pubDate>2025-11-30T09:40:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577970969395331113" data-draft-id="7577625663257624576" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="ARouter 入门指南：从基本跳转到对象传递"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2025-11-30T09:40:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="雨白"/> <meta itemprop="url" content="https://juejin.cn/user/2549135752044601"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            ARouter 入门指南：从基本跳转到对象传递
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2549135752044601/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    雨白
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T09:40:52.000Z" title="Sun Nov 30 2025 09:40:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">配置</h2>
<p>在模块级的 <code>build.gradle.kts</code> 文件中进行配置：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">plugins {
    id(<span class="hljs-string">"kotlin-kapt"</span>)
}

android {
    buildFeatures {
        buildConfig = <span class="hljs-literal">true</span>
    }
}

dependencies {
    implementation(<span class="hljs-string">"com.alibaba:arouter-api:1.5.2"</span>)
    kapt(<span class="hljs-string">"com.alibaba:arouter-compiler:1.5.2"</span>)
}

kapt {
    arguments {
        <span class="hljs-comment">// 每个模块必须配置模块名，用于编译期生成 Group 映射文件</span>
        arg(<span class="hljs-string">"AROUTER_MODULE_NAME"</span>, project.name)
    }
}
</code></pre>
<p>如果出现了依赖性冲突，可以在 <code>gradle.properties</code> 文件中添加这两行：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">android.useAndroidX=<span class="hljs-literal">true</span>
android.enableJetifier=<span class="hljs-literal">true</span> <span class="hljs-comment">// 让第三方库迁移到 AndroidX</span>
</code></pre>
<h3 data-id="heading-1">初始化</h3>
<p>配置完成后，在 <code>Application</code> 中初始化 <code>ARouter</code>。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">BaseApplication</span> : <span class="hljs-type">Application</span>() {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreate</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">super</span>.onCreate()
        initARouter()
    }

    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">initARouter</span><span class="hljs-params">()</span></span> {
        <span class="hljs-comment">// 必须在 init 之前配置</span>
        <span class="hljs-keyword">if</span> (BuildConfig.DEBUG) {
            ARouter.openLog()     <span class="hljs-comment">// 打印日志</span>
            ARouter.openDebug()   <span class="hljs-comment">// 开启调试模式</span>
        }
        ARouter.<span class="hljs-keyword">init</span>(<span class="hljs-keyword">this</span>)
    }
}
</code></pre>
<p>开启<strong>调试模式</strong>是为了让每次代码修改都能立即生效。因为 ARouter 在应用版本号不变时，会使用本地缓存，这就可能导致了路由路径修改后，运行时出现“找不到路径”的问题。</p>
<p>因此，我们强制它每次启动时都重新加载路由表，不使用缓存，这样每次拿到的都是最新构建的路由表。</p>
<h2 data-id="heading-2">路由与注入</h2>
<h3 data-id="heading-3">页面定义与跳转</h3>
<p>定义页面 (Destination) 的规范为：<code>/组名/页面名</code>。</p>
<blockquote>
<p>ARouter 会根据组名进行内存懒加载。</p>
</blockquote>
<p>创建一个 <code>UserProfileActivity</code>，并定义它的路由。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Route(path = <span class="hljs-string">"/user/profile"</span>)</span> <span class="hljs-comment">// 注意路径不能少于两级</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">UserProfileActivity</span> : <span class="hljs-type">AppCompatActivity</span>() {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreate</span><span class="hljs-params">(savedInstanceState: <span class="hljs-type">Bundle</span>?)</span></span> {
        <span class="hljs-keyword">super</span>.onCreate(savedInstanceState)
        setContentView(R.layout.activity_user_profile)
    }
}
</code></pre>
<p>接着在 <code>MainActivity</code> 中实现最简单的跳转：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> : <span class="hljs-type">AppCompatActivity</span>() {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreate</span><span class="hljs-params">(savedInstanceState: <span class="hljs-type">Bundle</span>?)</span></span> {
        <span class="hljs-keyword">super</span>.onCreate(savedInstanceState)
        setContentView(R.layout.activity_main)

        findViewById&lt;Button&gt;(R.id.go_btn).setOnClickListener {
            ARouter.getInstance().build(<span class="hljs-string">"/user/profile"</span>).navigation(<span class="hljs-keyword">this</span>)
        }
    }
}
</code></pre>
<p>运行结果：</p>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0c2293aeee4b4d8499c940f6c31e3589~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo55m9:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765100452&amp;x-signature=lMOLfwUAfinOlCCA2CAYX153TeQ%3D" alt="Screen_recording_20251130_144451.gif" width="50%" loading="lazy"/>
<h3 data-id="heading-4">参数传递与自动注入</h3>
<p>需要传递参数的话，只需调用 <code>withXxx</code> 方法即可。</p>
<p>例如：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// MainActivity 的 onCreate 方法中</span>
findViewById&lt;Button&gt;(R.id.go_btn).setOnClickListener {
    ARouter.getInstance().build(<span class="hljs-string">"/user/profile"</span>)
        .withString(<span class="hljs-string">"name"</span>, <span class="hljs-string">"Steven"</span>)
        .withLong(<span class="hljs-string">"id"</span>, <span class="hljs-number">10086L</span>)
        .navigation(<span class="hljs-keyword">this</span>)
}
</code></pre>
<p>接收方代码：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Route(path = <span class="hljs-string">"/user/profile"</span>)</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">UserProfileActivity</span> : <span class="hljs-type">AppCompatActivity</span>() {

    <span class="hljs-meta">@JvmField</span>
    <span class="hljs-meta">@Autowired(name = <span class="hljs-string">"id"</span>)</span>
    <span class="hljs-keyword">var</span> userId: <span class="hljs-built_in">Long</span> = <span class="hljs-number">0L</span>

    <span class="hljs-meta">@JvmField</span>
    <span class="hljs-meta">@Autowired(name = <span class="hljs-string">"name"</span>)</span>
    <span class="hljs-keyword">var</span> userName: String? = <span class="hljs-literal">null</span>

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreate</span><span class="hljs-params">(savedInstanceState: <span class="hljs-type">Bundle</span>?)</span></span> {
        <span class="hljs-keyword">super</span>.onCreate(savedInstanceState)
        setContentView(R.layout.activity_user_profile)

        <span class="hljs-comment">// 必须进行注入，否则所有字段都是默认值</span>
        ARouter.getInstance().inject(<span class="hljs-keyword">this</span>)
        
        Toast
            .makeText(
                <span class="hljs-keyword">this</span>,
                <span class="hljs-string">"id: <span class="hljs-variable">$userId</span>, name: <span class="hljs-variable">$userName</span>"</span>,
                Toast.LENGTH_SHORT
            )
            .show()
    }
}
</code></pre>
<p>运行结果：</p>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9bb948fcf0284ba8acd77ecd5a4cedbb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo55m9:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765100452&amp;x-signature=jgyLNF4C0MZvMEbXo3%2FhdZW%2F0n8%3D" alt="Screen_recording_20251130_150317.gif" width="50%" loading="lazy"/>
<h3 data-id="heading-5">跳转并获取返回结果</h3>
<p>如果要进行带结果的跳转，只需在跳转时，传入 <code>requestCode</code> 参数即可。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// MainActivity</span>
<span class="hljs-keyword">companion</span> <span class="hljs-keyword">object</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">val</span> REQUEST_CODE_PROFILE = <span class="hljs-number">100</span>
}

<span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreate</span><span class="hljs-params">(savedInstanceState: <span class="hljs-type">Bundle</span>?)</span></span> {
    <span class="hljs-keyword">super</span>.onCreate(savedInstanceState)
    setContentView(R.layout.activity_main)

    findViewById&lt;Button&gt;(R.id.go_btn).setOnClickListener {
        ARouter.getInstance().build(<span class="hljs-string">"/user/profile"</span>)
            .withString(<span class="hljs-string">"name"</span>, <span class="hljs-string">"Steven"</span>)
            .withLong(<span class="hljs-string">"id"</span>, <span class="hljs-number">10086L</span>)
            .navigation(<span class="hljs-keyword">this</span>, REQUEST_CODE_PROFILE)
    }
}
</code></pre>
<p>在目标页面使用原生的 <code>setResult</code> 方法返回结果：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// UserProfileActivity</span>
lifecycleScope.launch {
    delay(<span class="hljs-number">2000</span>)
    <span class="hljs-keyword">val</span> intent = Intent().apply {
        putExtra(<span class="hljs-string">"updated_name"</span>, <span class="hljs-string">"Steven_666"</span>)
    }
    setResult(RESULT_OK, intent)
    finish()
}
</code></pre>
<p>在最初的页面重写 <code>onActivityResult</code> 方法来接收返回的数据：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onActivityResult</span><span class="hljs-params">(
    requestCode: <span class="hljs-type">Int</span>,
    resultCode: <span class="hljs-type">Int</span>,
    <span class="hljs-keyword">data</span>: <span class="hljs-type">Intent</span>?
)</span></span> {
    <span class="hljs-keyword">super</span>.onActivityResult(requestCode, resultCode, <span class="hljs-keyword">data</span>)

    <span class="hljs-keyword">if</span> (requestCode == REQUEST_CODE_PROFILE &amp;&amp; resultCode == RESULT_OK) {
        <span class="hljs-keyword">val</span> updatedName = <span class="hljs-keyword">data</span>?.getStringExtra(<span class="hljs-string">"updated_name"</span>)
        Toast.makeText(<span class="hljs-keyword">this</span>, <span class="hljs-string">"用户名已更新为：<span class="hljs-variable">$updatedName</span>"</span>, Toast.LENGTH_SHORT).show()
    }
}
</code></pre>
<h2 data-id="heading-6">拦截器</h2>
<p>我们可以在跳转前进行拦截、修改和重定向。</p>
<p>比如在进到用户个人中心前进行拦截，我们要检查该用户的信息完整性，如果缺少，就拦截该跳转，引导到完善信息页面；如果完整，就放行。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Interceptor(priority = 10, name = <span class="hljs-string">"用户资料完整性检查"</span>)</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">UserProfileInterceptor</span> : <span class="hljs-type">IInterceptor</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> mContext: Context? = <span class="hljs-literal">null</span>

    <span class="hljs-comment">/**
     * 注意：该方法运行在子线程
     */</span>
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">process</span><span class="hljs-params">(postcard: <span class="hljs-type">Postcard</span>, callback: <span class="hljs-type">InterceptorCallback</span>)</span></span> {
        <span class="hljs-keyword">if</span> (postcard.path == <span class="hljs-string">"/user/profile"</span>) {
            Log.i(<span class="hljs-string">"ARouter"</span>, <span class="hljs-string">"正在检查进入个人中心的权限..."</span>)

            <span class="hljs-comment">//检查本地是否有昵称</span>
            <span class="hljs-keyword">val</span> hasNickname = fakeCheckUserNicknameFromDb()

            <span class="hljs-keyword">if</span> (hasNickname) {
                <span class="hljs-comment">// 通过，继续跳转</span>
                callback.onContinue(postcard)
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-comment">// 失败，进行拦截</span>
                callback.onInterrupt(RuntimeException(<span class="hljs-string">"用户信息不完整"</span>))

                <span class="hljs-comment">//切换到主线程来显示 Toast 或跳转</span>
                MainLooper.runOnUiThread {
                    Toast.makeText(mContext, <span class="hljs-string">"请先完善用户信息"</span>, Toast.LENGTH_SHORT).show()
                    <span class="hljs-comment">// 重定向到完善信息页</span>
                    ARouter.getInstance().build(<span class="hljs-string">"/user/complete_info"</span>).navigation()
                }

                <span class="hljs-comment">// 流程结束</span>
                callback.onInterrupt(<span class="hljs-literal">null</span>)
            }
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// 如果不是我们要拦截的路径，直接放行</span>
            callback.onContinue(postcard)
        }
    }

    <span class="hljs-comment">/**
     * 模拟从数据库查询用户昵称
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">fakeCheckUserNicknameFromDb</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Boolean</span> {
        <span class="hljs-keyword">val</span> context = mContext ?: <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>

        <span class="hljs-keyword">try</span> {
            Log.d(<span class="hljs-string">"ARouter"</span>, <span class="hljs-string">"正在查询数据库..."</span>)
            Thread.sleep(<span class="hljs-number">300</span>)
        } <span class="hljs-keyword">catch</span> (e: InterruptedException) {
            e.printStackTrace()
        }

        <span class="hljs-keyword">val</span> sp = context.getSharedPreferences(<span class="hljs-string">"user_data"</span>, Context.MODE_PRIVATE)
        <span class="hljs-keyword">val</span> nickname = sp.getString(<span class="hljs-string">"nickname"</span>, <span class="hljs-string">""</span>)

        <span class="hljs-comment">// 如果昵称不为空，则视为信息完整</span>
        <span class="hljs-keyword">return</span> !nickname.isNullOrEmpty()
    }

    <span class="hljs-comment">/**
     * 初始化方法
     * 在 ARouter 初始化时被调用，运行在主线程
     */</span>
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">init</span><span class="hljs-params">(context: <span class="hljs-type">Context</span>)</span></span> {
        <span class="hljs-comment">// 这里可以做一些静态资源的加载，或者注册广播等（非耗时操作）</span>
        <span class="hljs-keyword">this</span>.mContext = context.applicationContext
        Log.i(<span class="hljs-string">"ARouter"</span>, <span class="hljs-string">"UserProfileInterceptor 已加载"</span>)
    }
}

<span class="hljs-comment">// 切换主线程的简单封装</span>
<span class="hljs-keyword">object</span> MainLooper {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> handler = Handler(Looper.getMainLooper())
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">runOnUiThread</span><span class="hljs-params">(action: () -&gt; <span class="hljs-type">Unit</span>)</span></span> {
        <span class="hljs-keyword">if</span> (Looper.myLooper() == Looper.getMainLooper()) {
            action()
        } <span class="hljs-keyword">else</span> {
            handler.post(action)
        }
    }
}
</code></pre>
<h2 data-id="heading-7">实战结构参考</h2>
<p>在大型项目中，我们不会硬编码路由字符串，也不允许让跳转逻辑分散。</p>
<p>我们会创建路由常量：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">object</span> RoutePath {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">val</span> GROUP = <span class="hljs-string">"/user"</span>
    <span class="hljs-keyword">const</span> <span class="hljs-keyword">val</span> USER_PROFILE = <span class="hljs-string">"<span class="hljs-variable">$GROUP</span>/profile"</span>
    <span class="hljs-keyword">const</span> <span class="hljs-keyword">val</span> COMPLETE_USER_INFO = <span class="hljs-string">"<span class="hljs-variable">$GROUP</span>/complete_info"</span>
}
</code></pre>
<p>然后封装一个导航中心 <code>NavigationHelper</code>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">object</span> NavigationHelper {

    <span class="hljs-comment">/**
     * 通用跳转
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">startActivity</span><span class="hljs-params">(path: <span class="hljs-type">String</span>, bundle: <span class="hljs-type">Bundle</span>? = <span class="hljs-literal">null</span>)</span></span> {
        ARouter.getInstance().build(path)
            .with(bundle)
            .navigation()
    }

    <span class="hljs-comment">/**
     * 带结果的跳转
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">startForResult</span><span class="hljs-params">(activity: <span class="hljs-type">Activity</span>, path: <span class="hljs-type">String</span>, requestCode: <span class="hljs-type">Int</span>)</span></span> {
        ARouter.getInstance().build(path)
            .navigation(activity, requestCode)
    }
    
    <span class="hljs-comment">/**
     * 导航用户详情页
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">toUserProfile</span><span class="hljs-params">(userId: <span class="hljs-type">Long</span>, userName: <span class="hljs-type">String</span>?)</span></span> {
        ARouter.getInstance().build(RoutePath.USER_PROFILE)
            .withLong(UserProfileActivity.USER_ID, userId)
            .withString(UserProfileActivity.USER_NAME, userName ?: <span class="hljs-string">""</span>)
            .navigation()
    }
}
</code></pre>
<p>现在我们无需知道参数 Key 的值，甚至无需知道用户详情页的路由路径。</p>
<p>现在的 <code>MainActivity</code>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> : <span class="hljs-type">AppCompatActivity</span>() {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreate</span><span class="hljs-params">(savedInstanceState: <span class="hljs-type">Bundle</span>?)</span></span> {
        <span class="hljs-keyword">super</span>.onCreate(savedInstanceState)
        setContentView(R.layout.activity_main)

        findViewById&lt;Button&gt;(R.id.go_btn).setOnClickListener {
            NavigationHelper.toUserProfile(<span class="hljs-number">10086L</span>, <span class="hljs-string">"Steven"</span>)
        }
    }
}
</code></pre>
<p>现在的 <code>UserProfileActivity</code>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Route(path = RoutePath.USER_PROFILE)</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">UserProfileActivity</span> : <span class="hljs-type">AppCompatActivity</span>() {

    <span class="hljs-meta">@JvmField</span>
    <span class="hljs-meta">@Autowired(name = USER_ID)</span>
    <span class="hljs-keyword">var</span> userId: <span class="hljs-built_in">Long</span> = <span class="hljs-number">0L</span>

    <span class="hljs-meta">@JvmField</span>
    <span class="hljs-meta">@Autowired(name = USER_NAME)</span>
    <span class="hljs-keyword">var</span> userName: String? = <span class="hljs-literal">null</span>

    <span class="hljs-keyword">companion</span> <span class="hljs-keyword">object</span> {
        <span class="hljs-keyword">const</span> <span class="hljs-keyword">val</span> USER_ID = <span class="hljs-string">"id"</span>
        <span class="hljs-keyword">const</span> <span class="hljs-keyword">val</span> USER_NAME = <span class="hljs-string">"name"</span>
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreate</span><span class="hljs-params">(savedInstanceState: <span class="hljs-type">Bundle</span>?)</span></span> {
        <span class="hljs-keyword">super</span>.onCreate(savedInstanceState)
        setContentView(R.layout.activity_user_profile)

        ARouter.getInstance().inject(<span class="hljs-keyword">this</span>)
        Toast
            .makeText(
                <span class="hljs-keyword">this</span>,
                <span class="hljs-string">"id: <span class="hljs-variable">$userId</span>, name: <span class="hljs-variable">$userName</span>"</span>,
                Toast.LENGTH_SHORT
            )
            .show()
    }
}
</code></pre>
<h2 data-id="heading-8">Fragment 与对象传递</h2>
<h3 data-id="heading-9">获取 Fragment 实例</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Route(path = <span class="hljs-string">"/home/fragment"</span>)</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">HomeFragment</span> : <span class="hljs-type">Fragment</span>() {

}
</code></pre>
<p>加载 Fragment，也可以通过 <code>ARouter</code> 获取其实例。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// MainActivity</span>
<span class="hljs-keyword">val</span> fragment = ARouter.getInstance().build(<span class="hljs-string">"/home/fragment"</span>).navigation() <span class="hljs-keyword">as</span>? Fragment
<span class="hljs-keyword">if</span> (fragment != <span class="hljs-literal">null</span>) {
    <span class="hljs-comment">// 添加到 FragmentManager</span>
    supportFragmentManager.beginTransaction()
        .add(R.id.xxx, fragment)
        .commit()
}
</code></pre>
<h3 data-id="heading-10">JSON 服务具体实现</h3>
<p>现在，我们使用 <code>.withObject</code> 传递自定义对象时，会报错：<em>java.lang.NullPointerException</em></p>
<p>因为没有进行序列化，接收端拿到的数据是 null。我们可以配置序列化服务来解决。</p>
<blockquote>
<p>添加依赖：<code>implementation("com.google.code.gson:gson:2.13.2")</code> // Gson</p>
</blockquote>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Route(path = <span class="hljs-string">"/service/json"</span>)</span> <span class="hljs-comment">// Path 可以自定义</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">JsonServiceImpl</span> : <span class="hljs-type">SerializationService</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> gson: Gson? = <span class="hljs-literal">null</span>

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">init</span><span class="hljs-params">(context: <span class="hljs-type">Context</span>?)</span></span> {
        gson = Gson()
    }

    <span class="hljs-meta">@Deprecated(<span class="hljs-string">"Deprecated in Java"</span>)</span>
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T : Any?&gt;</span> <span class="hljs-title">json2Object</span><span class="hljs-params">(
        input: <span class="hljs-type">String</span>?,
        clazz: <span class="hljs-type">Class</span>&lt;<span class="hljs-type">T</span>?&gt;?
    )</span></span>: T? {
        <span class="hljs-keyword">return</span> input?.let { gson?.fromJson(it, clazz) }
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">object2Json</span><span class="hljs-params">(instance: <span class="hljs-type">Any</span>?)</span></span>: String {
        <span class="hljs-keyword">return</span> gson?.toJson(instance) ?: <span class="hljs-string">""</span>
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T : Any?&gt;</span> <span class="hljs-title">parseObject</span><span class="hljs-params">(
        input: <span class="hljs-type">String</span>?,
        clazz: <span class="hljs-type">Type</span>?
    )</span></span>: T? {
        <span class="hljs-keyword">return</span> input?.let { gson?.fromJson(it, clazz) }
    }

}
</code></pre>
<p>之后，ARouter 会自动调用 <code>JsonServiceImpl</code> 来处理所有的 <code>withObject</code> 请求。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[前端跨页面通讯终极指南②：BroadcastChannel 用法全解析]]></title>    <link>https://juejin.cn/post/7577971299743072294</link>    <guid>https://juejin.cn/post/7577971299743072294</guid>    <pubDate>2025-11-30T09:50:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577971299743072294" data-draft-id="7576378563576004623" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="前端跨页面通讯终极指南②：BroadcastChannel 用法全解析"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-30T09:50:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="一诺滚雪球"/> <meta itemprop="url" content="https://juejin.cn/user/2824015112318094"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            前端跨页面通讯终极指南②：BroadcastChannel 用法全解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2824015112318094/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    一诺滚雪球
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T09:50:50.000Z" title="Sun Nov 30 2025 09:50:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>上一篇介绍了<strong>PostMessage</strong>跨页面通讯的方式。有没有一种更简洁的方式，兄弟页面也能像父子页面一样通讯。今天就介绍一个更高效、更简洁的方案——<strong>BroadcastChannel API</strong>，它能轻松搞定父子、子父、兄弟页面间的通讯。</p>
<h2 data-id="heading-1">1. BroadcastChannel是什么？</h2>
<p><strong><code>BroadcastChannel</code></strong> 接口表示给定<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FGlossary%2FOrigin" target="_blank" title="https://developer.mozilla.org/zh-CN/docs/Glossary/Origin" ref="nofollow noopener noreferrer">源</a>的任何<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FGlossary%2FBrowsing_context" target="_blank" title="https://developer.mozilla.org/zh-CN/docs/Glossary/Browsing_context" ref="nofollow noopener noreferrer">浏览上下文</a>都可以订阅的命名频道。它允许<strong>同源</strong>的不同浏览器窗口、标签页、frame 或者 iframe 下的不同文档之间相互通信。消息通过 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FAPI%2FBroadcastChannel%2Fmessage_event" title="https://developer.mozilla.org/zh-CN/docs/Web/API/BroadcastChannel/message_event" target="_blank" ref="nofollow noopener noreferrer"><code>message</code></a> 事件进行广播，该事件在侦听该频道的所有 <code>BroadcastChannel</code> 对象上触发，发送消息的对象除外。</p>
<p>简单来说，它就像一个“无线电台”，多个页面只要订阅了同一个“频道”（指定相同的频道名称），就能接收该频道发送的所有消息，实现数据的双向流转。</p>
<p>需要注意，BroadcastChannel仅支持同源页面，兼容性略低，需要搭配其他方案作为降级处理。</p>
<h2 data-id="heading-2">2. 如何使用</h2>
<p><strong>BroadcastChannel</strong>的使用流程如下：</p>
<ol>
<li>创建频道</li>
<li>订阅消息</li>
<li>发送消息</li>
<li>关闭订阅</li>
</ol>
<h3 data-id="heading-3">2.1 创建频道（主题）</h3>
<p>通过 <code>new BroadcastChannel('channel-name')</code>创建一个“频道”（相当于发布-订阅中的“主题”）。所有加入同一频道的上下文，共享同一个通信通道。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 1. 创建/订阅指定名称的频道（关键：多页面频道名必须一致）</span>
<span class="hljs-keyword">const</span> channel = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BroadcastChannel</span>(<span class="hljs-string">'my-channel'</span>);
</code></pre>
<h3 data-id="heading-4">2.2 订阅消息（监听）</h3>
<p>通过监听 <code>message</code>事件订阅该频道的消息（相当于订阅者注册回调）：</p>
<pre><code class="hljs language-js" lang="js">channel.<span class="hljs-property">onmessage</span> = <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'收到消息：'</span>, e.<span class="hljs-property">data</span>); <span class="hljs-comment">// e.data 就是发送的消息内容</span>
  <span class="hljs-comment">// 根据消息类型执行对应逻辑</span>
  <span class="hljs-keyword">if</span> (e.<span class="hljs-property">data</span>.<span class="hljs-property">type</span> === <span class="hljs-string">'refresh'</span>) {
    <span class="hljs-comment">// 执行刷新操作</span>
  }
};

</code></pre>
<h3 data-id="heading-5">2.3 发布消息（发送）</h3>
<p>通过 <code>postMessage()</code>向频道发送消息（相当于发布者触发发布）：</p>
<pre><code class="hljs language-js" lang="js">channel.<span class="hljs-title function_">postMessage</span>({
  <span class="hljs-attr">type</span>: <span class="hljs-string">'refresh'</span>,
  <span class="hljs-attr">data</span>: { <span class="hljs-attr">id</span>: <span class="hljs-number">123</span> }
});
</code></pre>
<h3 data-id="heading-6">2.4 退订（关闭）</h3>
<p>通过 <code>close()</code>方法离开频道（可选，浏览器通常会在上下文销毁时自动清理）：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'beforeunload'</span>, <span class="hljs-function">() =&gt;</span> {
  channel.<span class="hljs-title function_">close</span>();
});
</code></pre>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 1. 创建/订阅指定名称的频道（关键：多页面频道名必须一致）</span>
<span class="hljs-keyword">const</span> channel = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BroadcastChannel</span>(<span class="hljs-string">'my-channel'</span>);

<span class="hljs-comment">// 2. 接收消息</span>
channel.<span class="hljs-property">onmessage</span> = <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'收到消息：'</span>, e.<span class="hljs-property">data</span>); <span class="hljs-comment">// e.data 就是发送的消息内容</span>
  <span class="hljs-comment">// 根据消息类型执行对应逻辑</span>
  <span class="hljs-keyword">if</span> (e.<span class="hljs-property">data</span>.<span class="hljs-property">type</span> === <span class="hljs-string">'refresh'</span>) {
    <span class="hljs-comment">// 执行刷新操作</span>
  }
};

<span class="hljs-comment">// 3. 发送消息（支持字符串、对象等多种数据类型）</span>
channel.<span class="hljs-title function_">postMessage</span>({
  <span class="hljs-attr">type</span>: <span class="hljs-string">'refresh'</span>,
  <span class="hljs-attr">data</span>: { <span class="hljs-attr">id</span>: <span class="hljs-number">123</span> }
});

<span class="hljs-comment">// 4. 关闭频道（页面卸载时调用，避免内存泄漏）</span>
<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'beforeunload'</span>, <span class="hljs-function">() =&gt;</span> {
  channel.<span class="hljs-title function_">close</span>();
});
</code></pre>
<h2 data-id="heading-7">3、实践场景</h2>
<p>下面我们针对前端最常见的<strong>父子页面</strong>（父窗口打开子窗口）、<strong>子父页面</strong>（子窗口向父窗口反馈）、<strong>兄弟页面</strong>（同一父页面打开的多个子窗口）三种场景，分别给出具体的实现代码。</p>
<h3 data-id="heading-8">3.1 父子通讯</h3>
<p>父页面点击“刷新子页面”按钮，子页面接收到指令后刷新数据。</p>
<p><strong>父页面代码</strong>（打开子窗口并发送消息）：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 1. 创建频道</span>
<span class="hljs-keyword">const</span> parentChannel = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BroadcastChannel</span>(<span class="hljs-string">'parent-child-channel'</span>);

<span class="hljs-comment">// 2. 点击按钮向子窗口发送消息</span>
<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'refreshChildBtn'</span>).<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-function">() =&gt;</span> {
  parentChannel.<span class="hljs-title function_">postMessage</span>({
    <span class="hljs-attr">type</span>: <span class="hljs-string">'refresh-data'</span>,
    <span class="hljs-attr">message</span>: <span class="hljs-string">'父页面指令：请刷新数据'</span>
  });
});

<span class="hljs-comment">// 3. 页面卸载时关闭频道</span>
<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'beforeunload'</span>, <span class="hljs-function">() =&gt;</span> {
  parentChannel.<span class="hljs-title function_">close</span>();
});
</code></pre>
<p><strong>子页面代码</strong>（接收父页面消息并执行操作）：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 1. 订阅同一个频道（频道名必须和父页面一致）</span>
<span class="hljs-keyword">const</span> childChannel = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BroadcastChannel</span>(<span class="hljs-string">'parent-child-channel'</span>);

<span class="hljs-comment">// 2. 接收父页面消息</span>
childChannel.<span class="hljs-property">onmessage</span> = <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> { <span class="hljs-keyword">type</span>, message } = e.<span class="hljs-property">data</span>;
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">type</span> === <span class="hljs-string">'refresh-data'</span>) {
    <span class="hljs-comment">// 显示接收的消息</span>
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'message'</span>).<span class="hljs-property">textContent</span> = message;
    <span class="hljs-comment">// 执行刷新数据的逻辑</span>
    <span class="hljs-title function_">refreshData</span>();
  }
};

<span class="hljs-comment">// 刷新数据的核心函数</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">refreshData</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 模拟请求接口刷新数据</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'子页面正在刷新数据...'</span>);
  <span class="hljs-comment">// 这里写具体的刷新逻辑</span>
}

<span class="hljs-comment">// 3. 页面卸载时关闭频道</span>
<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'beforeunload'</span>, <span class="hljs-function">() =&gt;</span> {
  childChannel.<span class="hljs-title function_">close</span>();
});
</code></pre>
<h3 data-id="heading-9">3.2 子父通讯（子窗口向父窗口反馈结果）</h3>
<p>需求：子页面完成表单提交后，向父页面发送“提交成功”的消息，父页面接收到后关闭子窗口并刷新自身数据。</p>
<p><strong>子页面代码</strong>（提交表单后发送消息）：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 1. 订阅频道（和父页面保持一致）</span>
<span class="hljs-keyword">const</span> childChannel = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BroadcastChannel</span>(<span class="hljs-string">'child-parent-channel'</span>);

<span class="hljs-comment">// 2. 表单提交逻辑</span>
<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'submitForm'</span>).<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'submit'</span>, <span class="hljs-keyword">async</span> (e) =&gt; {
  e.<span class="hljs-title function_">preventDefault</span>();
  <span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// 模拟表单提交接口请求</span>
    <span class="hljs-keyword">await</span> <span class="hljs-title function_">submitFormData</span>();
    <span class="hljs-comment">// 提交成功后向父页面发送消息</span>
    childChannel.<span class="hljs-title function_">postMessage</span>({
      <span class="hljs-attr">type</span>: <span class="hljs-string">'submit-success'</span>,
      <span class="hljs-attr">data</span>: { <span class="hljs-attr">formId</span>: <span class="hljs-number">456</span>, <span class="hljs-attr">status</span>: <span class="hljs-string">'success'</span> }
    });
    <span class="hljs-comment">// 延迟关闭子窗口，确保消息发送完成</span>
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">close</span>();
    }, <span class="hljs-number">300</span>);
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'提交失败：'</span>, error);
  }
});

<span class="hljs-comment">// 3. 页面卸载时关闭频道</span>
<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'beforeunload'</span>, <span class="hljs-function">() =&gt;</span> {
  childChannel.<span class="hljs-title function_">close</span>();
});
</code></pre>
<p><strong>父页面代码</strong>（接收子页面消息并执行操作）：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 1. 创建频道</span>
<span class="hljs-keyword">const</span> parentChannel = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BroadcastChannel</span>(<span class="hljs-string">'child-parent-channel'</span>);

<span class="hljs-comment">// 2. 接收子页面消息</span>
parentChannel.<span class="hljs-property">onmessage</span> = <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> { <span class="hljs-keyword">type</span>, data } = e.<span class="hljs-property">data</span>;
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">type</span> === <span class="hljs-string">'submit-success'</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'子页面表单提交成功：'</span>, data);
    <span class="hljs-comment">// 执行父页面刷新逻辑</span>
    <span class="hljs-title function_">parentRefreshData</span>();
    <span class="hljs-comment">// （可选）关闭子窗口（如果子窗口未自行关闭）</span>
    <span class="hljs-comment">// childWindow.close();</span>
  }
};

<span class="hljs-comment">// 父页面刷新数据函数</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">parentRefreshData</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'父页面正在刷新数据...'</span>);
  <span class="hljs-comment">// 具体刷新逻辑</span>
}

<span class="hljs-comment">// 3. 页面卸载时关闭频道</span>
<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'beforeunload'</span>, <span class="hljs-function">() =&gt;</span> {
  parentChannel.<span class="hljs-title function_">close</span>();
});
</code></pre>
<h3 data-id="heading-10">3.3 兄弟通讯（多个子窗口间同步状态）</h3>
<p>需求：父页面打开两个子窗口A和B，当子窗口A修改数据后，子窗口B实时同步更新数据。</p>
<p><strong>子窗口A代码</strong>（修改数据后发送消息）：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 1. 订阅兄弟通讯频道</span>
<span class="hljs-keyword">const</span> brotherChannel = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BroadcastChannel</span>(<span class="hljs-string">'brother-channel'</span>);

<span class="hljs-comment">// 2. 模拟修改数据操作</span>
<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'updateDataBtn'</span>).<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> newData = {
    <span class="hljs-attr">id</span>: <span class="hljs-number">789</span>,
    <span class="hljs-attr">content</span>: <span class="hljs-string">'子窗口A修改后的新内容'</span>,
    <span class="hljs-attr">updateTime</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">toLocaleString</span>()
  };
  <span class="hljs-comment">// 保存修改后的数据</span>
  <span class="hljs-title function_">saveData</span>(newData);
  <span class="hljs-comment">// 向频道发送消息，通知其他兄弟窗口</span>
  brotherChannel.<span class="hljs-title function_">postMessage</span>({
    <span class="hljs-attr">type</span>: <span class="hljs-string">'data-updated'</span>,
    <span class="hljs-attr">newData</span>: newData
  });
});

<span class="hljs-comment">// 3. 页面卸载时关闭频道</span>
<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'beforeunload'</span>, <span class="hljs-function">() =&gt;</span> {
  brotherChannel.<span class="hljs-title function_">close</span>();
});
</code></pre>
<p><strong>子窗口B代码</strong>（接收消息并同步数据）：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 1. 订阅同一个兄弟通讯频道</span>
<span class="hljs-keyword">const</span> brotherChannel = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BroadcastChannel</span>(<span class="hljs-string">'brother-channel'</span>);

<span class="hljs-comment">// 2. 接收子窗口A发送的消息</span>
brotherChannel.<span class="hljs-property">onmessage</span> = <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> { <span class="hljs-keyword">type</span>, newData } = e.<span class="hljs-property">data</span>;
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">type</span> === <span class="hljs-string">'data-updated'</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'收到子窗口A的更新消息：'</span>, newData);
    <span class="hljs-comment">// 同步更新页面数据展示</span>
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'dataContent'</span>).<span class="hljs-property">textContent</span> = newData.<span class="hljs-property">content</span>;
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'updateTime'</span>).<span class="hljs-property">textContent</span> = newData.<span class="hljs-property">updateTime</span>;
  }
};

<span class="hljs-comment">// 3. 页面卸载时关闭频道</span>
<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'beforeunload'</span>, <span class="hljs-function">() =&gt;</span> {
  brotherChannel.<span class="hljs-title function_">close</span>();
});
</code></pre>
<p>接收输入如下：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d1aa2e1e705144c8a7bf2c14bdc1392b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA6K-65rua6Zuq55CD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765101050&amp;x-signature=20mMZB0QSh5cO4wGBhkzM2GivrE%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-11">4. 总结</h2>
<p>最后总结一下：对比传统的<code>postMessage</code>跨页面通讯方案，<strong>BroadcastChannel</strong>兄弟页面无需转发，几行代码就能轻松实现通讯。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【卫星图像识别系统】Python+TensorFlow+Vue3+Django+人工智能+深度学习+卷积网络+resnet50算法]]></title>    <link>https://juejin.cn/post/7577718777482297382</link>    <guid>https://juejin.cn/post/7577718777482297382</guid>    <pubDate>2025-11-30T09:51:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577718777482297382" data-draft-id="7577991167200428042" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【卫星图像识别系统】Python+TensorFlow+Vue3+Django+人工智能+深度学习+卷积网络+resnet50算法"/> <meta itemprop="keywords" content="TensorFlow,图像识别,人工智能"/> <meta itemprop="datePublished" content="2025-11-30T09:51:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ziwu"/> <meta itemprop="url" content="https://juejin.cn/user/607373397353726"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【卫星图像识别系统】Python+TensorFlow+Vue3+Django+人工智能+深度学习+卷积网络+resnet50算法
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/607373397353726/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ziwu
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T09:51:27.000Z" title="Sun Nov 30 2025 09:51:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、介绍</h2>
<p>卫星影像识别系统，基于TensorFlow搭建卷积神经网络算法，通过对7种常见的卫星遥感影像图片数据集（'草地（Grass）', '农田（Field）', '工业区（Industry）', '河流湖泊（RiverLake）', '森林（Forest）', '居民区（Resident）', '停车场（Parking）'）进行训练，最后得到一个识别精度较高的模型，然后搭建Web可视化操作平台。</p>
<p><strong>前端</strong>: Vue3、Element Plus</p>
<p><strong>后端</strong>：Django</p>
<p><strong>算法</strong>：TensorFlow、卷积神经网络算法</p>
<p><strong>具体功能</strong>：</p>
<ol>
<li>系统分为管理员和用户两个角色，登录后根据角色显示其可访问的页面模块。</li>
<li>登录系统后可发布、查看、编辑文章，创建文章功能中集成了markdown编辑器，可对文章进行编辑。</li>
<li>在图像识别功能中，用户上传图片后，点击识别，可输出其识别结果和置信度</li>
<li>基于Echart以柱状图形式输出所有种类对应的置信度分布图。</li>
<li>在智能问答功能模块中：用户输入问题，后台通过对接Deepseek接口实现智能问答功能。</li>
<li>管理员可在用户管理模块中，对用户账户进行管理和编辑。</li>
</ol>
<p><strong>选题背景与意义</strong>：
随着遥感技术的快速发展，卫星影像数据呈现爆发式增长，如何高效、精准地识别与利用这些数据，已成为资源监测、环境评估和城乡规划等领域的重要课题。传统人工判读方式效率低、主观性强，难以满足大规模应用需求。为此，本项目基于TensorFlow构建卷积神经网络模型，针对草地、农田、工业区、河流湖泊、森林、居民区及停车场等七类典型地物进行识别训练，旨在开发一个具备较高识别精度的自动化分类系统。为进一步提升系统的实用性与交互体验，项目结合Django与Vue3等主流技术，搭建了集用户管理、图像识别、结果可视化及智能问答于一体的Web操作平台。该系统不仅实现了地物类型的智能识别与置信度分析，还通过集成Markdown编辑与DeepSeek问答接口，拓展了知识管理与交互支持功能，为遥感数据的智能化应用提供了便捷、高效的解决方案。</p>
<h2 data-id="heading-1">二、系统效果图片展示</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/97af6426029a4299a39e62b4ed7ed3d7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeml3dQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765101087&amp;x-signature=0pcJIyIlY%2BSovwHkzF%2Fx6PUd4SE%3D" alt="图片" loading="lazy"/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2f1ef67ef291412084dd4e21138e6e81~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeml3dQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765101087&amp;x-signature=G8er3EQcZRZHV3k%2FMFyQFiV18AQ%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-2">三、演示视频 and 完整代码 and 安装</h2>
<p>地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fziwupy.cn%2Fp%2F6eby8p" target="_blank" title="https://ziwupy.cn/p/6eby8p" ref="nofollow noopener noreferrer">ziwupy.cn/p/6eby8p</a></p>
<h2 data-id="heading-3">四、卷积神经网络算法介绍</h2>
<p>ResNet50是由微软研究院提出的深度残差网络（Residual Network）的一个经典模型，其核心创新是“残差学习”思想。在传统的深度卷积神经网络中，简单地堆叠层数会遇到“梯度消失/爆炸”问题，导致网络难以训练，性能甚至下降，这被称为“退化问题”。</p>
<p>ResNet通过引入“快捷连接”或“跳跃连接”巧妙地解决了这一问题。它不再让多个堆叠的层直接学习一个目标映射H(x)，而是让这些层学习其与输入x之间的残差F(x) = H(x) - x。这样，原始的目标映射就变成了 H(x) = F(x) + x。</p>
<p>这种“捷径”将输入x直接传递到更深层的输出，实现了恒等映射。这样做有两个主要好处：</p>
<ol>
<li><strong>缓解梯度消失</strong>：梯度可以直接通过快捷连接反向传播，使得深层网络的训练变得可行。</li>
<li><strong>简化学习目标</strong>：让网络学习残差F(x)通常比学习完整的映射H(x)更容易，尤其是在F(x)趋近于0时，该层就近似做了恒等变换，避免了性能退化。</li>
</ol>
<p>ResNet50因其包含50个权重层而得名，它通过大量使用这种带有快捷连接的“瓶颈结构”模块，在保持高性能的同时，显著减少了参数量，成为图像识别领域一个里程碑式的模型。</p>
<p>以下是一个使用TensorFlow Keras中预训练的ResNet50模型进行图像识别的简单示例。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> tensorflow <span class="hljs-keyword">as</span> tf
<span class="hljs-keyword">from</span> tensorflow.keras.applications.resnet50 <span class="hljs-keyword">import</span> ResNet50, decode_predictions, preprocess_input
<span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np
<span class="hljs-keyword">from</span> PIL <span class="hljs-keyword">import</span> Image

<span class="hljs-comment"># 1. 加载预训练的ResNet50模型（包含在ImageNet上训练得到的权重）</span>
model = ResNet50(weights=<span class="hljs-string">'imagenet'</span>)

<span class="hljs-comment"># 2. 加载并预处理图像</span>
img_path = <span class="hljs-string">'your_image.jpg'</span> <span class="hljs-comment"># 替换为你的图片路径</span>
image = Image.<span class="hljs-built_in">open</span>(img_path).convert(<span class="hljs-string">'RGB'</span>) <span class="hljs-comment"># 确保为RGB格式</span>
image = image.resize((<span class="hljs-number">224</span>, <span class="hljs-number">224</span>)) <span class="hljs-comment"># ResNet50要求输入尺寸为224x224</span>

<span class="hljs-comment"># 将图像转换为数组并扩展维度以匹配模型输入要求 (batch_size, height, width, channels)</span>
image_array = np.array(image)
image_array = np.expand_dims(image_array, axis=<span class="hljs-number">0</span>)

<span class="hljs-comment"># 对图像进行与训练时相同的预处理</span>
image_array = preprocess_input(image_array)

<span class="hljs-comment"># 3. 使用模型进行预测</span>
predictions = model.predict(image_array)

<span class="hljs-comment"># 4. 解码预测结果，得到人类可读的标签和置信度</span>
decoded_predictions = decode_predictions(predictions, top=<span class="hljs-number">3</span>)[<span class="hljs-number">0</span>] <span class="hljs-comment"># 显示最可能的3个结果</span>

<span class="hljs-comment"># 5. 打印结果</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"识别结果："</span>)
<span class="hljs-keyword">for</span> i, (imagenet_id, label, score) <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(decoded_predictions):
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"<span class="hljs-subst">{i+<span class="hljs-number">1</span>}</span>: <span class="hljs-subst">{label}</span> (<span class="hljs-subst">{score * <span class="hljs-number">100</span>:<span class="hljs-number">.2</span>f}</span>%)"</span>)
</code></pre>
<p>这段代码演示了利用预训练ResNet50模型进行图像识别的标准流程。首先，我们直接加载了在ImageNet数据集上预训练好的模型，无需从头训练。然后，将输入图像调整为224x224像素，并进行归一化等预处理。接着，模型对图像进行前向传播推理，输出一个包含1000个ImageNet类别概率的向量。最后，通过<code>decode_predictions</code>函数将概率向量解码为易于理解的对象标签和置信度，并打印出最可能的三个预测结果。这种方法让我们能够快速、高效地将强大的ResNet50模型应用于实际的图像识别任务中。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【民族服饰识别系统】Python+TensorFlow+Vue3+Django+人工智能+深度学习+卷积网络+resnet50算法]]></title>    <link>https://juejin.cn/post/7577718777482379302</link>    <guid>https://juejin.cn/post/7577718777482379302</guid>    <pubDate>2025-11-30T09:59:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577718777482379302" data-draft-id="7577968429590151194" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【民族服饰识别系统】Python+TensorFlow+Vue3+Django+人工智能+深度学习+卷积网络+resnet50算法"/> <meta itemprop="keywords" content="后端,图像识别,人工智能"/> <meta itemprop="datePublished" content="2025-11-30T09:59:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ziwu"/> <meta itemprop="url" content="https://juejin.cn/user/607373397353726"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【民族服饰识别系统】Python+TensorFlow+Vue3+Django+人工智能+深度学习+卷积网络+resnet50算法
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/607373397353726/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ziwu
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T09:59:10.000Z" title="Sun Nov 30 2025 09:59:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、介绍</h2>
<p>民族服饰识别，民族服饰智能识别与分析系统基于TensorFlow框架，采用卷积神经网络（CNN）算法构建而成。系统在收集了回族、汉族、满族、苗族四类典型民族服饰图像数据集的基础上，通过多轮迭代训练，最终生成高精度识别模型，并配合Web可视化平台实现便捷交互。</p>
<p><strong>前端</strong>: Vue3、Element Plus</p>
<p><strong>后端</strong>：Django</p>
<p><strong>算法</strong>：TensorFlow、卷积神经网络算法</p>
<p><strong>具体功能</strong>：</p>
<ol>
<li>系统分为管理员和用户两个角色，登录后根据角色显示其可访问的页面模块。</li>
<li>登录系统后可发布、查看、编辑文章，创建文章功能中集成了markdown编辑器，可对文章进行编辑。</li>
<li>在图像识别功能中，用户上传图片后，点击识别，可输出其识别结果和置信度</li>
<li>基于Echart以柱状图形式输出所有种类对应的置信度分布图。</li>
<li>在智能问答功能模块中：用户输入问题，后台通过对接Deepseek接口实现智能问答功能。</li>
<li>管理员可在用户管理模块中，对用户账户进行管理和编辑。</li>
</ol>
<p><strong>选题背景与意义</strong>：
随着人工智能技术的快速发展，计算机视觉在文化传承与保护领域的应用日益广泛。民族服饰作为民族文化的重要载体，其识别与分类对于文化研究与数字化保护具有积极意义。传统人工识别方式效率有限，难以适应大规模图像处理需求。基于此背景，本研究旨在开发一套基于深度学习的民族服饰智能识别与分析系统。系统采用TensorFlow框架，基于卷积神经网络（CNN）构建高精度识别模型，实现对回族、汉族、满族、苗族四类典型民族服饰的自动化识别。通过集成Web可视化平台，系统不仅提供图像识别、置信度分析和可视化图表展示等核心功能，还结合内容管理与智能问答模块，构建了集文化识别、知识传播与交互体验于一体的综合平台，为民族文化的数字化保护与推广提供了有效的技术支撑。</p>
<h2 data-id="heading-1">二、系统效果图片展示</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0e6321eef3a0410287cc9c9eb65419c6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeml3dQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765101549&amp;x-signature=ZrFTkjuH6D%2F1L5M8N6IFkt7NUFA%3D" alt="图片" loading="lazy"/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a8d9ecae01ec4a22beb6f99c7ce2567d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeml3dQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765101549&amp;x-signature=hgUkA0TvHVCp8eWOZtIgNxmxxQE%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-2">三、演示视频 and 完整代码 and 安装</h2>
<p>地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fziwupy.cn%2Fp%2FekFQTD" target="_blank" title="https://ziwupy.cn/p/ekFQTD" ref="nofollow noopener noreferrer">ziwupy.cn/p/ekFQTD</a></p>
<h2 data-id="heading-3">四、卷积神经网络算法介绍</h2>
<p>卷积神经网络是一种专为处理网格状数据（如图像）而设计的深度学习算法。其核心思想是通过“卷积”操作，自动地从图像中提取由浅到深的特征。</p>
<p><strong>主要构成层：</strong></p>
<ol>
<li><strong>卷积层：</strong> 是CNN的核心。它使用多个可学习的“滤波器”（或称“卷积核”）在输入图像上滑动，通过计算局部区域的点积来提取特征（如边缘、角点、纹理等）。通过堆叠多个卷积层，网络可以学习到从简单到复杂（如物体部件、整体轮廓）的层次化特征。</li>
<li><strong>池化层：</strong> 通常跟在卷积层之后，用于对特征图进行下采样。它通过取局部区域的最大值或平均值，来减小数据尺寸，降低计算量，同时增强模型对目标位置微小变化的鲁棒性（即“平移不变性”）。</li>
<li><strong>全连接层：</strong> 在网络的末端，将经过多轮卷积和池化后提取出的高级特征图展平，然后进行综合判断，最终输出每个类别的概率。</li>
</ol>
<p>CNN通过这种“局部连接”和“权值共享”（同一个滤波器扫描整张图片）的机制，极大地减少了参数数量，使其能够高效地处理图像，并成为图像识别领域最主流的算法。</p>
<p>以下是一个使用TensorFlow和Keras API构建一个简单的CNN模型，用于对MNIST手写数字数据集进行分类的示例。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> tensorflow <span class="hljs-keyword">as</span> tf
<span class="hljs-keyword">from</span> tensorflow.keras <span class="hljs-keyword">import</span> datasets, layers, models

<span class="hljs-comment"># 1. 加载并预处理数据</span>
(train_images, train_labels), (test_images, test_labels) = datasets.mnist.load_data()
<span class="hljs-comment"># 将图像数据重塑为 (28, 28, 1) 的形状，并归一化到 [0, 1] 区间</span>
train_images = train_images.reshape((<span class="hljs-number">60000</span>, <span class="hljs-number">28</span>, <span class="hljs-number">28</span>, <span class="hljs-number">1</span>)).astype(<span class="hljs-string">'float32'</span>) / <span class="hljs-number">255</span>
test_images = test_images.reshape((<span class="hljs-number">10000</span>, <span class="hljs-number">28</span>, <span class="hljs-number">28</span>, <span class="hljs-number">1</span>)).astype(<span class="hljs-string">'float32'</span>) / <span class="hljs-number">255</span>

<span class="hljs-comment"># 2. 构建CNN模型</span>
model = models.Sequential([
    <span class="hljs-comment"># 第一个卷积块：卷积 + 池化</span>
    layers.Conv2D(<span class="hljs-number">32</span>, (<span class="hljs-number">3</span>, <span class="hljs-number">3</span>), activation=<span class="hljs-string">'relu'</span>, input_shape=(<span class="hljs-number">28</span>, <span class="hljs-number">28</span>, <span class="hljs-number">1</span>)),
    layers.MaxPooling2D((<span class="hljs-number">2</span>, <span class="hljs-number">2</span>)),
    
    <span class="hljs-comment"># 第二个卷积块：卷积 + 池化</span>
    layers.Conv2D(<span class="hljs-number">64</span>, (<span class="hljs-number">3</span>, <span class="hljs-number">3</span>), activation=<span class="hljs-string">'relu'</span>),
    layers.MaxPooling2D((<span class="hljs-number">2</span>, <span class="hljs-number">2</span>)),
    
    <span class="hljs-comment"># 将特征图展平，输入到全连接层</span>
    layers.Flatten(),
    layers.Dense(<span class="hljs-number">64</span>, activation=<span class="hljs-string">'relu'</span>),
    <span class="hljs-comment"># 输出层，10个神经元对应10个数字类别，使用softmax激活函数输出概率</span>
    layers.Dense(<span class="hljs-number">10</span>, activation=<span class="hljs-string">'softmax'</span>)
])

<span class="hljs-comment"># 3. 编译模型</span>
model.<span class="hljs-built_in">compile</span>(optimizer=<span class="hljs-string">'adam'</span>,
              loss=<span class="hljs-string">'sparse_categorical_crossentropy'</span>,
              metrics=[<span class="hljs-string">'accuracy'</span>])

<span class="hljs-comment"># 4. 训练模型</span>
model.fit(train_images, train_labels, epochs=<span class="hljs-number">5</span>, 
          validation_data=(test_images, test_labels))

<span class="hljs-comment"># 5. 评估模型</span>
test_loss, test_acc = model.evaluate(test_images, test_labels, verbose=<span class="hljs-number">2</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f'\n测试准确率：<span class="hljs-subst">{test_acc}</span>'</span>)
</code></pre>
<p>以上代码完整展示了使用CNN进行图像识别的流程。首先，数据被加载并预处理成适合网络的格式。接着，我们构建了一个顺序模型，它包含两个卷积-池化层组合，用于特征提取，之后是展平操作和全连接层进行分类。模型使用<code>adam</code>优化器和交叉熵损失函数进行编译。最后，通过<code>fit</code>方法在训练数据上进行5轮训练，并在测试集上评估最终性能。这个简单的模型能很快地在MNIST数据集上达到很高的准确率，清晰地演示了CNN在图像识别任务中的强大能力和基本工作流程。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[大模型开发实战篇1：调用DeepSeek的对话接口,即聊天机器人接口]]></title>    <link>https://juejin.cn/post/7577737385955229706</link>    <guid>https://juejin.cn/post/7577737385955229706</guid>    <pubDate>2025-11-30T10:00:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577737385955229706" data-draft-id="7577971299743039526" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="大模型开发实战篇1：调用DeepSeek的对话接口,即聊天机器人接口"/> <meta itemprop="keywords" content="LLM,Agent,程序员"/> <meta itemprop="datePublished" content="2025-11-30T10:00:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="AI大模型"/> <meta itemprop="url" content="https://juejin.cn/user/3817967696221534"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            大模型开发实战篇1：调用DeepSeek的对话接口,即聊天机器人接口
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3817967696221534/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    AI大模型
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T10:00:17.000Z" title="Sun Nov 30 2025 10:00:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>本文较长，建议点赞收藏。更多AI大模型应用开发学习视频及资料，在<a href="https://link.juejin.cn?target=https%3A%2F%2Fhy.zhipoai.cn%2F" target="_blank" title="https://hy.zhipoai.cn/" ref="nofollow noopener noreferrer">智泊AI</a>。</p>
</blockquote>
<p>很多AI产品对外的接口都复用了OpenAI公司的接口WebAPI，DeepSeek、智谱等也是如此。因此，只要学会OpenAI的接口，其他AI产品也就学调用了。我们就从OpenAI的接口来作为切入点学习。</p>
<p>对话接口也是聊天机器人， 在网页上与chatgpt类似的效果。</p>
<h2 data-id="heading-0">一、开发环境准备</h2>
<p>OpenAI的接口是WebAPI形式的Rest API接口，并且还提供了各种常用语言的SDK，比如Python,Java,.Net,Javascript。这些SDK也同样完全适用于DeepSeek和智谱。大家可以根据自己熟悉的开发语言选择，sdk下载地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fplatform.openai.com%2Fdocs%2Flibraries" target="_blank" title="https://platform.openai.com/docs/libraries" ref="nofollow noopener noreferrer">platform.openai.com/docs/librar…</a></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a187dfe8078d4f3a817b2b236abe1c27~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765101617&amp;x-signature=GDlTwfKApt%2Fq0b59gcOd8HvMFrk%3D" alt="" loading="lazy"/></p>
<p>本教程以Python作为开发语言。</p>
<p><strong>1、安装Python解释器</strong></p>
<p>官方下载安装包：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.python.org%2Fdownloads%2F" target="_blank" title="https://www.python.org/downloads/" ref="nofollow noopener noreferrer">www.python.org/downloads/</a></p>
<p>安装好后看下版本</p>
<pre><code class="hljs language-css" lang="css">命令：python <span class="hljs-attr">--version</span>
</code></pre>
<p>Python 3.13.1</p>
<p><strong>2、安装Jupyter Lab</strong></p>
<p>JupyterLab是人工智能领域常用的web版本的开发工具，非常好用，优点很多就不一一介绍了。也可以在VSCode,Pycharm  这些IDE开发。</p>
<pre><code class="hljs">pip install jupyterlab
</code></pre>
<p>启动Jupyter Lab,可以打开指定的目录，使用以下命令。</p>
<pre><code class="hljs">jupyter lab
</code></pre>
<h2 data-id="heading-1">二、注册账号</h2>
<p>OpenAI的开放平台注册账号有点复杂，需要科学上网。我们可以使用国内的代理平台进行调用。比如我使用的是：aiyi 的，注册地址如下：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.apiyi.com%2Fregister%2F%3Faff" target="_blank" title="https://www.apiyi.com/register/?aff" ref="nofollow noopener noreferrer">www.apiyi.com/register/?a…</a>_code=LxAQ</p>
<p>注册号后设置令牌key，就可以使用了。DeepSeek的官方的公众平台停止充值，无法调用，也可以使用第3方提供的平台调用，甚至是本地搭建的DeepSeek也同样可以调用，这个后期讲。</p>
<h2 data-id="heading-2">三、开发单轮对话接口</h2>
<p><strong>1、Python导入常用的包</strong></p>
<pre><code class="hljs language-diff" lang="diff"><span class="hljs-addition">!pip install tiktoken openai pandas matplotlib plotly scikit-learn numpy</span>
</code></pre>
<p>我们本次会使用openai包， 若已安装了旧版本，需要更新到最新版本。</p>
<pre><code class="hljs language-css" lang="css">pip install <span class="hljs-attr">--upgrade</span> openai
</code></pre>
<p><strong>2、对话接口的代码Demo</strong></p>
<pre><code class="hljs language-ini" lang="ini">from openai import OpenAI
<span class="hljs-attr">client</span> = OpenAI(api_key=<span class="hljs-string">"填写自己的令牌apikey"</span>, base_url=<span class="hljs-string">"https://vip.apiyi.com/v1"</span>)
<span class="hljs-attr">messages</span>=[
{<span class="hljs-string">"role"</span>: <span class="hljs-string">"system"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"你是一个乐于助人的体育界专家。"</span>},
{<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"2008年奥运会是在哪里举行的？"</span>},
]
<span class="hljs-attr">data</span> = client.chat.completions.create(
<span class="hljs-attr">model</span>=<span class="hljs-string">"gpt-4o-mini"</span>,
<span class="hljs-attr">stream</span>=<span class="hljs-literal">False</span>,
<span class="hljs-attr">messages</span>=messages
)
print(data.choices<span class="hljs-section">[0]</span>.message)
</code></pre>
<p> （1）我们使用的是aiyi代码，则使用aiyi的令牌key,base_url填写aiyi的接口地址。</p>
<p>（2）调用的接口是 chat.completions对话补齐接口。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a9cae10d570a4d60acc6823344a30799~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765101617&amp;x-signature=hBSPvYsRRISEHQAuNjBPtaDp93M%3D" alt="" loading="lazy"/></p>
<p>执行会print的结果如上。单轮对话的代码就非常简单。.Net,Java，Javascript语言的开发也是类似的。</p>
<p>也可以print整个返回值data，这里的返回值的格式，在deepseek里稍稍有些不一样，开发的时候注意下。 </p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">print</span>(data)
</code></pre>

<pre><code class="hljs language-python" lang="python">ChatCompletion(<span class="hljs-built_in">id</span>=<span class="hljs-string">'chatcmpl-89CkHs99ByfRhSd7oB3bz8Cfj5f79'</span>, choices=[Choice(finish_reason=<span class="hljs-string">'stop'</span>, index=<span class="hljs-number">0</span>, logprobs=<span class="hljs-literal">None</span>, message=ChatCompletionMessage(content=<span class="hljs-string">'2008年奥运会在中国北京举行。这是中国第一次主办夏季奥林匹克运动会。'</span>, refusal=<span class="hljs-literal">None</span>, role=<span class="hljs-string">'assistant'</span>, audio=<span class="hljs-literal">None</span>, function_call=<span class="hljs-literal">None</span>, tool_calls=<span class="hljs-literal">None</span>))], created=<span class="hljs-number">1739239104</span>, model=<span class="hljs-string">'gpt-4o-mini'</span>, <span class="hljs-built_in">object</span>=<span class="hljs-string">'chat.completion'</span>, service_tier=<span class="hljs-literal">None</span>, system_fingerprint=<span class="hljs-string">'fp_5154047bf2'</span>, usage=CompletionUsage(completion_tokens=<span class="hljs-number">25</span>, prompt_tokens=<span class="hljs-number">33</span>, total_tokens=<span class="hljs-number">58</span>, completion_tokens_details=CompletionTokensDetails(accepted_prediction_tokens=<span class="hljs-literal">None</span>, audio_tokens=<span class="hljs-literal">None</span>, reasoning_tokens=<span class="hljs-literal">None</span>, rejected_prediction_tokens=<span class="hljs-literal">None</span>), prompt_tokens_details=PromptTokensDetails(audio_tokens=<span class="hljs-literal">None</span>, cached_tokens=<span class="hljs-literal">None</span>)))
</code></pre>
<p><strong>3、请求的接口说明</strong></p>
<p>使用 Chat Completions API 实现对话任务</p>
<p>聊天补全(Chat Completions API)以消息列表作为输入，并返回模型生成的消息作为输出。尽管聊天格式旨在使多轮对话变得简单，但它同样适用于没有任何对话的单轮任务。</p>
<p>主要请求参数说明：</p>
<p>model （string，必填）</p>
<p>要使用的模型ID。有关哪些模型适用于Chat API的详细信息</p>
<p>messages （array，必填）</p>
<p>迄今为止描述对话的消息列表</p>
<p>role （string，必填）</p>
<p>发送此消息的角色。system 、user 或 assistant 之一（一般用 user 发送用户问题，system 发送给模型提示信息）。system就是大模型在本次对话中扮演什么角色，比如代码里写的，大模型本次扮演的是“体育专家”，一般使用第3人称“你是xxx专家/教授。。”。</p>
<p>content （string，必填）</p>
<p>消息的内容</p>
<p>name （string，选填）</p>
<p>此消息的发送者姓名。可以包含 a-z、A-Z、0-9 和下划线，最大长度为 64 个字符</p>
<p>stream （boolean，选填，是否按流的方式发送内容）</p>
<p>当它设置为 true 时，API 会以 流式SSE（ Server Side Event ）方式返回内容。SSE 本质上是一个长链接，会持续不断地输出内容直到完成响应。如果不是做实时聊天，默认false即可。</p>
<p>max_tokens （integer，选填）</p>
<p>在聊天补全中生成的最大 tokens 数。</p>
<p>输入token和生成的token的总长度受模型上下文长度的限制。</p>
<p>temperature （number，选填，默认是 1）</p>
<p>采样温度，在 0和 2 之间。</p>
<p>较高的值，如0.8会使输出更随机，而较低的值，如0.2会使其更加集中和确定性。</p>
<p>通常建议修改这个（temperature ）或者 top_p ，但两者不能同时存在，二选一。</p>
<h2 data-id="heading-3">四、开发多轮对话接口</h2>
<p>单轮对话与多轮对话是完全一样的，只是在messages里将历史对话信息追加上。因为API 是一个“无状态” API，即服务端不记录用户请求的上下文，用户在每次请求时，需将之前所有对话历史拼接好后，传递给对话 API。</p>
<p>沿用上面的单轮对话，进行第2轮对话。</p>
<p><strong>1、将消息追加到 messages 列表中</strong></p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">new_message</span> = data.choices[<span class="hljs-number">0</span>].message
<span class="hljs-attr">new_message_dict</span> = {<span class="hljs-string">"role"</span>: new_message.role, <span class="hljs-string">"content"</span>: new_message.content}
<span class="hljs-comment"># 将消息追加到 messages 列表中</span>
messages.append(new_message_dict)
</code></pre>
<p>可以看到大模型返回的结果中,role是assistant 小助手，我们直接沿用。</p>
<p><strong>2、第2轮对话</strong></p>
<pre><code class="hljs language-go" lang="go">new_chat = {
<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>,
<span class="hljs-string">"content"</span>: <span class="hljs-string">"1.讲一个程序员才听得懂的冷笑话；2.今天是几号？3.明天星期几？"</span>
}
messages.<span class="hljs-built_in">append</span>(new_chat)
from pprint <span class="hljs-keyword">import</span> pprint
pprint(messages)
打印结果
</code></pre>
<p>[{'content': '你是一个乐于助人的体育界专家。', 'role': 'system'},</p>
<p> {'content': '2008年奥运会是在哪里举行的？', 'role': 'user'},</p>
<p> {'content': '2008年夏季奥运会在中国的北京举行。', 'role': 'assistant'},</p>
<p> {'content': '1.讲一个程序员才听得懂的冷笑话；2.今天是几号？3.明天星期几？', 'role': 'user'}]</p>
<p>调用对话接口</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">data</span> = client.chat.completions.create(
<span class="hljs-attr">model</span>=<span class="hljs-string">"gpt-4o-mini"</span>,
<span class="hljs-attr">stream</span>=<span class="hljs-literal">False</span>,
<span class="hljs-attr">messages</span>=messages
)
</code></pre>

<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">new_message</span> = data.choices[<span class="hljs-number">0</span>].message
<span class="hljs-comment"># 打印 new_messages</span>
print(new_message)
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3aa9aafea4584df7bcd253b00aff6fe7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765101617&amp;x-signature=n7qrs8cXDW1vrD3OoXNTV6sLu1w%3D" alt="" loading="lazy"/></p>
<p>若还有第3轮以及更多轮对话，都要将历史对话带上。</p>
<h2 data-id="heading-4">五、调用本地安装的DeepSeek-R1</h2>
<p><strong>1、使用ollama在本地安装deepseek</strong></p>
<p>教程如下</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMjM5MzQ5NTU0Mw%3D%3D%26mid%3D2455052009%26idx%3D1%26sn%3D474108502c072da49587a5ee6ee4f76a%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MjM5MzQ5NTU0Mw==&amp;mid=2455052009&amp;idx=1&amp;sn=474108502c072da49587a5ee6ee4f76a&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">DeepSeek本地安装太简单了，人人都会操作</a></p>
<p>本地安装了deepsek-r1:7b，模型名也是这个。</p>
<p>run跑起来</p>
<pre><code class="hljs language-arduino" lang="arduino">ollama run deepseek-r1:<span class="hljs-number">7b</span>
</code></pre>
<p><strong>2、调用对话接口</strong></p>
<pre><code class="hljs language-ini" lang="ini">from openai import OpenAI
<span class="hljs-attr">client</span> = OpenAI(api_key=<span class="hljs-string">"sk-33333"</span>, base_url=<span class="hljs-string">"http://localhost:11434/v1/"</span>)
<span class="hljs-attr">messages</span>=[
{<span class="hljs-string">"role"</span>: <span class="hljs-string">"system"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"你是一个乐于助人的体育界专家。"</span>},
{<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"2008年奥运会是在哪里举行的？"</span>},
]
<span class="hljs-attr">data</span> = client.chat.completions.create(
<span class="hljs-attr">model</span>=<span class="hljs-string">"deepseek-r1:7b"</span>,
<span class="hljs-attr">stream</span>=<span class="hljs-literal">False</span>,
<span class="hljs-attr">messages</span>=messages
)
print(data.choices<span class="hljs-section">[0]</span>.message)
</code></pre>
<p>（1）api_key随便填写，但必须是英文和数字，不要有中文。</p>
<p>（2）模型model填写deepseek-r1:7b，若你本地安装的参数是别的，就把7b改掉。</p>
<p>（3）base_url是你本地localhost地址。</p>
<p><strong>3、看回答结果</strong></p>
<pre><code class="hljs language-css" lang="css">ChatCompletionMessage(<span class="hljs-attribute">content</span>='&lt;think&gt;\n好，用户问的是<span class="hljs-number">2008</span>年北京奥运会的举办地。\n\n首先，我确定奥运会每四年举办一次，所以从<span class="hljs-number">2000</span>年开始推算，应该是<span class="hljs-number">2008</span>年在北京举行。接着，我会想到北京有丰富的文化遗产和举办过其他国际盛会的经验，比如第<span class="hljs-number">24</span>届冬奥会，这对奥运会的成功很有帮助。\n\n然后，考虑举办地点的选择，北京不仅地理位置优越，基础设施也很齐全，能够支持一个成功的大型活动。我还应该提到这一点，让回答更有说服力。\n\n另外，<span class="hljs-number">2008</span>年对于中国人来说是特殊的一年，奥运会上会有许多来自中国各地的运动员参加，这将展现他们的精神和团结。这也是用户的可能兴趣点吧？\n\n最后，按照用户的提示，避免使用Markdown格式，并且提供一个自然流畅的回答。\n&lt;/think&gt;\n\n2008年北京奥运会在北京成功举办了，这是中国继上海世博会后第二个国际盛会，展现了中国的文化和魅力。', refusal=<span class="hljs-attribute">None</span>, role='assistant', <span class="hljs-selector-tag">audio</span>=<span class="hljs-attribute">None</span>, function_call=<span class="hljs-attribute">None</span>, tool_calls=<span class="hljs-attribute">None</span>)
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d7f7519301324c408d60bc49ed05b354~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765101617&amp;x-signature=CKz8JadvMEtu7m9LD5rjAKgZj7U%3D" alt="" loading="lazy"/></p>
<p><strong>3、调用第3方的deepseek接口</strong></p>
<p>因为deepseek的api接口有很多限制，所以可以使用第3方提供的deepseek接口，比如华为云，腾讯云、硅基流动等，调用方式都一样，仅仅模型名称不一样，接口地址不一样。</p>
<p>我们选择硅基流动： <a href="https://link.juejin.cn?target=https%3A%2F%2Fcloud.siliconflow.cn%2Fi%2FM6a0xrcX" target="_blank" title="https://cloud.siliconflow.cn/i/M6a0xrcX" ref="nofollow noopener noreferrer">cloud.siliconflow.cn/i/M6a0xrcX</a></p>
<pre><code class="hljs language-ini" lang="ini">from openai import OpenAI
<span class="hljs-attr">client</span> = OpenAI(api_key=<span class="hljs-string">"YOUR_API_KEY"</span>, base_url=<span class="hljs-string">"https://api.siliconflow.cn/v1"</span>)
<span class="hljs-attr">response</span> = client.chat.completions.create(
<span class="hljs-attr">model</span>=<span class="hljs-string">'deepseek-ai/DeepSeek-V2.5'</span>,
<span class="hljs-attr">messages</span>=[
{<span class="hljs-string">'role'</span>: <span class="hljs-string">'user'</span>,
<span class="hljs-string">'content'</span>: <span class="hljs-string">"中国大模型行业2025年将会迎来哪些机遇和挑战"</span>}
],
<span class="hljs-attr">stream</span>=<span class="hljs-literal">True</span>
)
for chunk in response:
print(chunk.choices<span class="hljs-section">[0]</span>.delta.content, <span class="hljs-attr">end</span>=<span class="hljs-string">''</span>)
</code></pre>
<p>简单的机器人对话接口就讲完了，下一期讲解对话接口的最佳实践。</p>
<h3 data-id="heading-5">学习资源推荐</h3>
<p>如果你想更深入地学习大模型，以下是一些非常有价值的学习资源，这些资源将帮助你从不同角度学习大模型，提升你的实践能力。</p>
<blockquote>
<p>本文较长，建议点赞收藏。更多AI大模型应用开发学习视频及资料，在<a href="https://link.juejin.cn?target=https%3A%2F%2Fhy.zhipoai.cn%2F" target="_blank" title="https://hy.zhipoai.cn/" ref="nofollow noopener noreferrer">智泊AI</a>。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[跨域难题终结者：Vue项目中优雅解决跨域问题的完整指南]]></title>    <link>https://juejin.cn/post/7577691061033795630</link>    <guid>https://juejin.cn/post/7577691061033795630</guid>    <pubDate>2025-11-30T02:37:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577691061033795630" data-draft-id="7577691061033762862" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="跨域难题终结者：Vue项目中优雅解决跨域问题的完整指南"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-30T02:37:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="北辰alk"/> <meta itemprop="url" content="https://juejin.cn/user/1772855673241352"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            跨域难题终结者：Vue项目中优雅解决跨域问题的完整指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1772855673241352/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    北辰alk
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T02:37:49.000Z" title="Sun Nov 30 2025 02:37:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">跨域难题终结者：Vue项目中优雅解决跨域问题的完整指南</h2>
<blockquote>
<p>作为前端开发者，跨域问题就像一道绕不过去的坎。今天，就让我们彻底攻克这个难题！</p>
</blockquote>
<h3 data-id="heading-1">什么是跨域？为什么会出现跨域问题？</h3>
<h4 data-id="heading-2">同源策略：安全的守护者</h4>
<p>在深入解决方案之前，我们首先要明白<strong>同源策略</strong>这个概念。浏览器出于安全考虑，实施了同源策略，它限制了不同源之间的资源交互。</p>
<p><strong>什么是"同源"？</strong><br/>
简单来说，当两个URL的<strong>协议、域名、端口</strong>完全相同时，我们称它们为同源。</p>
<p>举个例子：</p>



































<table><thead><tr><th>当前页面URL</th><th>请求URL</th><th>是否同源</th><th>原因</th></tr></thead><tbody><tr><td><code>https://www.example.com/index.html</code></td><td><code>https://www.example.com/api/user</code></td><td>✅ 是</td><td>协议、域名、端口完全相同</td></tr><tr><td><code>https://www.example.com/index.html</code></td><td><code>http://www.example.com/api/user</code></td><td>❌ 否</td><td>协议不同(https vs http)</td></tr><tr><td><code>https://www.example.com/index.html</code></td><td><code>https://api.example.com/user</code></td><td>❌ 否</td><td>域名不同(www vs api)</td></tr><tr><td><code>https://www.example.com:8080/index.html</code></td><td><code>https://www.example.com:3000/api/user</code></td><td>❌ 否</td><td>端口不同(8080 vs 3000)</td></tr></tbody></table>
<h4 data-id="heading-3">跨域的限制范围</h4>
<p>当发生跨域时，以下行为会受到限制：</p>
<ul>
<li>• <strong>AJAX请求</strong>被阻止（核心问题）</li>
<li>• <strong>LocalStorage</strong>、<strong>IndexedDB</strong>等存储无法访问</li>
<li>• <strong>DOM</strong>无法通过JavaScript操作</li>
<li>• <strong>Cookie</strong>读写受限</li>
</ul>
<p>但有些资源是允许跨域加载的：</p>
<ul>
<li>• 图片<code>&lt;img&gt;</code></li>
<li>• 样式表<code>&lt;link&gt;</code></li>
<li>• 脚本<code>&lt;script&gt;</code></li>
<li>• 嵌入框架<code>&lt;iframe&gt;</code>（但内容访问受限）</li>
</ul>
<h3 data-id="heading-4">Vue项目中的跨域解决方案</h3>
<p>在实际的Vue项目中，我们主要有以下几种解决方案：</p>
<h4 data-id="heading-5">方案一：开发环境下的代理配置（最常用）</h4>
<p>这是开发阶段最常用的解决方案，通过Vue CLI或Vite的代理功能实现。</p>
<h5 data-id="heading-6">Vue CLI项目配置</h5>
<p><strong>1. 创建vue.config.js文件</strong></p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-comment">// vue.config.js</span>
<span class="hljs-keyword">const</span> { defineConfig } = <span class="hljs-keyword">require</span>(<span class="hljs-string">'@vue/cli-service'</span>)

module.exports = <span class="hljs-title function_ invoke__">defineConfig</span>({
<span class="hljs-attr">  transpileDependencies</span>: <span class="hljs-literal">true</span>,
<span class="hljs-attr">  devServer</span>: {
<span class="hljs-attr">    port</span>: <span class="hljs-number">8080</span>,
<span class="hljs-attr">    proxy</span>: {
      // 简单配置：匹配以/api开头的请求
      <span class="hljs-string">'/api'</span>: {
<span class="hljs-attr">        target</span>: <span class="hljs-string">'http://localhost:3000'</span>, // 后端服务器地址
<span class="hljs-attr">        changeOrigin</span>: <span class="hljs-literal">true</span>, // 改变请求源
<span class="hljs-attr">        pathRewrite</span>: {
          <span class="hljs-string">'^/api'</span>: <span class="hljs-string">''</span> // 重写路径，去掉/api前缀
        }
      }
    }
  }
})
</code></pre>
<p><strong>2. 复杂场景的多代理配置</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// vue.config.js</span>
<span class="hljs-keyword">module</span>.<span class="hljs-keyword">exports</span> = {
  devServer: {
    proxy: {
      <span class="hljs-comment">// 用户服务代理</span>
      <span class="hljs-string">'/user-api'</span>: {
        target: <span class="hljs-string">'http://user-service:3001'</span>,
        changeOrigin: <span class="hljs-literal">true</span>,
        pathRewrite: {
          <span class="hljs-string">'^/user-api'</span>: <span class="hljs-string">'/api'</span>
        },
        logLevel: <span class="hljs-string">'debug'</span> <span class="hljs-comment">// 开启调试日志</span>
      },
      <span class="hljs-comment">// 商品服务代理</span>
      <span class="hljs-string">'/product-api'</span>: {
        target: <span class="hljs-string">'http://product-service:3002'</span>,
        changeOrigin: <span class="hljs-literal">true</span>,
        pathRewrite: {
          <span class="hljs-string">'^/product-api'</span>: <span class="hljs-string">'/api'</span>
        }
      },
      <span class="hljs-comment">// WebSocket代理</span>
      <span class="hljs-string">'/ws-api'</span>: {
        target: <span class="hljs-string">'ws://websocket-service:3003'</span>,
        changeOrigin: <span class="hljs-literal">true</span>,
        ws: <span class="hljs-literal">true</span>
      }
    }
  }
}
</code></pre>
<p><strong>3. 在Vue组件中使用</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// src/services/api.js</span>
<span class="hljs-keyword">import</span> axios <span class="hljs-keyword">from</span> <span class="hljs-string">'axios'</span>

<span class="hljs-comment">// 创建axios实例</span>
<span class="hljs-keyword">const</span> api = axios.<span class="hljs-title function_">create</span>({
  <span class="hljs-attr">baseURL</span>: <span class="hljs-string">'/api'</span>, <span class="hljs-comment">// 使用代理的前缀</span>
  <span class="hljs-attr">timeout</span>: <span class="hljs-number">10000</span>
})

<span class="hljs-comment">// 请求拦截器</span>
api.<span class="hljs-property">interceptors</span>.<span class="hljs-property">request</span>.<span class="hljs-title function_">use</span>(
  <span class="hljs-function"><span class="hljs-params">config</span> =&gt;</span> {
    <span class="hljs-comment">// 在发送请求之前做些什么</span>
    <span class="hljs-keyword">const</span> token = <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(<span class="hljs-string">'token'</span>)
    <span class="hljs-keyword">if</span> (token) {
      config.<span class="hljs-property">headers</span>.<span class="hljs-property">Authorization</span> = <span class="hljs-string">`Bearer <span class="hljs-subst">${token}</span>`</span>
    }
    <span class="hljs-keyword">return</span> config
  },
  <span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(error)
  }
)

<span class="hljs-comment">// 响应拦截器</span>
api.<span class="hljs-property">interceptors</span>.<span class="hljs-property">response</span>.<span class="hljs-title function_">use</span>(
  <span class="hljs-function"><span class="hljs-params">response</span> =&gt;</span> {
    <span class="hljs-keyword">return</span> response.<span class="hljs-property">data</span>
  },
  <span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> {
    <span class="hljs-comment">// 处理响应错误</span>
    <span class="hljs-keyword">if</span> (error.<span class="hljs-property">response</span>?.<span class="hljs-property">status</span> === <span class="hljs-number">401</span>) {
      <span class="hljs-comment">// 未授权，跳转到登录页</span>
      <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">href</span> = <span class="hljs-string">'/login'</span>
    }
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(error)
  }
)

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> api

<span class="hljs-comment">// 在Vue组件中使用</span>
<span class="hljs-comment">// src/components/UserList.vue</span>
&lt;script&gt;
<span class="hljs-keyword">import</span> api <span class="hljs-keyword">from</span> <span class="hljs-string">'@/services/api'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">name</span>: <span class="hljs-string">'UserList'</span>,
  <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">users</span>: [],
      <span class="hljs-attr">loading</span>: <span class="hljs-literal">false</span>
    }
  },
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">created</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">fetchUsers</span>()
  },
  <span class="hljs-attr">methods</span>: {
    <span class="hljs-keyword">async</span> <span class="hljs-title function_">fetchUsers</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">loading</span> = <span class="hljs-literal">true</span>
      <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// 实际请求会发送到代理服务器，然后转发到目标服务器</span>
        <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> api.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/users'</span>)
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">users</span> = response.<span class="hljs-property">data</span>
      } <span class="hljs-keyword">catch</span> (error) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'获取用户列表失败:'</span>, error)
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">$message</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'获取用户列表失败'</span>)
      } <span class="hljs-keyword">finally</span> {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">loading</span> = <span class="hljs-literal">false</span>
      }
    },
    
    <span class="hljs-keyword">async</span> <span class="hljs-title function_">createUser</span>(<span class="hljs-params">userData</span>) {
      <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">await</span> api.<span class="hljs-title function_">post</span>(<span class="hljs-string">'/users'</span>, userData)
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">$message</span>.<span class="hljs-title function_">success</span>(<span class="hljs-string">'用户创建成功'</span>)
        <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">fetchUsers</span>() <span class="hljs-comment">// 刷新列表</span>
      } <span class="hljs-keyword">catch</span> (error) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'创建用户失败:'</span>, error)
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">$message</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'创建用户失败'</span>)
      }
    }
  }
}
&lt;/script&gt;
</code></pre>
<h5 data-id="heading-7">Vite项目配置</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// vite.config.js</span>
<span class="hljs-keyword">import</span> { defineConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">'vite'</span>
<span class="hljs-keyword">import</span> vue <span class="hljs-keyword">from</span> <span class="hljs-string">'@vitejs/plugin-vue'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({
  <span class="hljs-attr">plugins</span>: [<span class="hljs-title function_">vue</span>()],
  <span class="hljs-attr">server</span>: {
    <span class="hljs-attr">port</span>: <span class="hljs-number">5173</span>,
    <span class="hljs-attr">proxy</span>: {
      <span class="hljs-string">'/api'</span>: {
        <span class="hljs-attr">target</span>: <span class="hljs-string">'http://localhost:3000'</span>,
        <span class="hljs-attr">changeOrigin</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">rewrite</span>: <span class="hljs-function">(<span class="hljs-params">path</span>) =&gt;</span> path.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/^/</span>api/, <span class="hljs-string">''</span>),
        <span class="hljs-attr">configure</span>: <span class="hljs-function">(<span class="hljs-params">proxy, options</span>) =&gt;</span> {
          <span class="hljs-comment">// 代理配置回调</span>
          proxy.<span class="hljs-title function_">on</span>(<span class="hljs-string">'error'</span>, <span class="hljs-function">(<span class="hljs-params">err, _req, _res</span>) =&gt;</span> {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'proxy error'</span>, err)
          })
          proxy.<span class="hljs-title function_">on</span>(<span class="hljs-string">'proxyReq'</span>, <span class="hljs-function">(<span class="hljs-params">proxyReq, req, _res</span>) =&gt;</span> {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Sending Request:'</span>, req.<span class="hljs-property">method</span>, req.<span class="hljs-property">url</span>)
          })
        }
      }
    }
  }
})
</code></pre>
<h4 data-id="heading-8">代理工作原理流程图</h4>
<pre><code class="hljs language-bash" lang="bash">浏览器发送请求到 Unsupported markdown: linkVue开发服务器代理中间件检测到/api前缀重写请求路径转发到 Unsupported markdown: <span class="hljs-built_in">link</span>后端服务器返回响应数据
</code></pre>
<h4 data-id="heading-9">方案二：生产环境解决方案</h4>
<p>开发环境的代理配置在生产环境是无效的，我们需要其他方案：</p>
<h5 data-id="heading-10">1. Nginx反向代理</h5>
<p><strong>Nginx配置文件示例：</strong></p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># nginx.conf</span>
server {
    listen 80<span class="hljs-comment">;</span>
    server_name your-domain.com<span class="hljs-comment">;</span>
    
    <span class="hljs-comment"># 前端静态文件</span>
    location / {
        root /usr/share/nginx/html<span class="hljs-comment">;</span>
        index index.html<span class="hljs-comment">;</span>
        try_files $uri $uri/ /index.html<span class="hljs-comment">;</span>
    }
    
    <span class="hljs-comment"># API代理配置</span>
    location /api/ {
        proxy_pass http://backend-server:3000/<span class="hljs-comment">;</span>
        proxy_set_header Host $host<span class="hljs-comment">;</span>
        proxy_set_header X-Real-IP $remote_addr<span class="hljs-comment">;</span>
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for<span class="hljs-comment">;</span>
        proxy_set_header X-Forwarded-Proto $scheme<span class="hljs-comment">;</span>
        
        <span class="hljs-comment"># CORS头（如果需要）</span>
        add_header Access-Control-Allow-Origin *<span class="hljs-comment">;</span>
        add_header Access-Control-Allow-Methods 'GET, POST, OPTIONS, PUT, DELETE'<span class="hljs-comment">;</span>
        add_header Access-Control-Allow-Headers '*'<span class="hljs-comment">;</span>
        
        <span class="hljs-comment"># 处理预检请求</span>
        if ($<span class="hljs-attr">request_method</span> = <span class="hljs-string">'OPTIONS'</span>) {
            add_header Access-Control-Allow-Origin *<span class="hljs-comment">;</span>
            add_header Access-Control-Allow-Methods 'GET, POST, OPTIONS, PUT, DELETE'<span class="hljs-comment">;</span>
            add_header Access-Control-Allow-Headers '*'<span class="hljs-comment">;</span>
            add_header Access-Control-Max-Age 86400<span class="hljs-comment">;</span>
            return 204<span class="hljs-comment">;</span>
        }
    }
    
    <span class="hljs-comment"># 静态资源缓存</span>
    location ~* .(js|css|png|jpg|jpeg|gif|ico|svg)$ {
        expires 1y<span class="hljs-comment">;</span>
        add_header Cache-Control "public, immutable"<span class="hljs-comment">;</span>
    }
}
</code></pre>
<h5 data-id="heading-11">2. 后端配置CORS</h5>
<p><strong>Node.js Express示例：</strong></p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-comment">// server.js</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">express </span>= <span class="hljs-keyword">require</span>(<span class="hljs-string">'express'</span>)
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">cors </span>= <span class="hljs-keyword">require</span>(<span class="hljs-string">'cors'</span>)

<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">app </span>= <span class="hljs-title function_ invoke__">express</span>()

<span class="hljs-comment">// 基础CORS配置</span>
app.<span class="hljs-keyword">use</span>(<span class="hljs-title function_ invoke__">cors</span>())

<span class="hljs-comment">// 自定义CORS配置</span>
app.<span class="hljs-keyword">use</span>(<span class="hljs-title function_ invoke__">cors</span>({
<span class="hljs-attr">  origin</span>: [
    <span class="hljs-string">'http://localhost:8080'</span>,
    <span class="hljs-string">'http://localhost:5173'</span>,
    <span class="hljs-string">'https://your-production-domain.com'</span>
  ],
<span class="hljs-attr">  methods</span>: [<span class="hljs-string">'GET'</span>, <span class="hljs-string">'POST'</span>, <span class="hljs-string">'PUT'</span>, <span class="hljs-string">'DELETE'</span>, <span class="hljs-string">'OPTIONS'</span>],
<span class="hljs-attr">  allowedHeaders</span>: [<span class="hljs-string">'Content-Type'</span>, <span class="hljs-string">'Authorization'</span>, <span class="hljs-string">'X-Requested-With'</span>],
<span class="hljs-attr">  credentials</span>: <span class="hljs-literal">true</span>, // 允许携带cookie
<span class="hljs-attr">  maxAge</span>: <span class="hljs-number">86400</span> // 预检请求缓存时间
}))

<span class="hljs-comment">// 或者针对特定路由配置CORS</span>
app.<span class="hljs-title function_ invoke__">get</span>(<span class="hljs-string">'/api/data'</span>, <span class="hljs-title function_ invoke__">cors</span>(), (req, res) =&gt; {
  res.<span class="hljs-title function_ invoke__">json</span>({<span class="hljs-attr"> message</span>: <span class="hljs-string">'This route has CORS enabled'</span> })
})

<span class="hljs-comment">// 手动设置CORS头</span>
app.<span class="hljs-keyword">use</span>((req, res, next) =&gt; {
  res.<span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">'Access-Control-Allow-Origin'</span>, <span class="hljs-string">'https://your-domain.com'</span>)
  res.<span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">'Access-Control-Allow-Methods'</span>, <span class="hljs-string">'GET, POST, PUT, DELETE, OPTIONS'</span>)
  res.<span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">'Access-Control-Allow-Headers'</span>, <span class="hljs-string">'Content-Type, Authorization'</span>)
  res.<span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">'Access-Control-Allow-Credentials'</span>, <span class="hljs-string">'true'</span>)
  
  <span class="hljs-keyword">if</span><span class="hljs-title function_ invoke__"> </span>(req.method === <span class="hljs-string">'OPTIONS'</span>) {
    <span class="hljs-keyword">return</span> res.<span class="hljs-title function_ invoke__">sendStatus</span>(<span class="hljs-number">200</span>)
  }
  
  <span class="hljs-title function_ invoke__">next</span>()
})

app.<span class="hljs-title function_ invoke__">get</span>(<span class="hljs-string">'/api/users'</span>, (req, res) =&gt; {
  res.<span class="hljs-title function_ invoke__">json</span>([{<span class="hljs-attr"> id</span>: <span class="hljs-number">1</span>,<span class="hljs-attr"> name</span>: <span class="hljs-string">'John'</span> }, {<span class="hljs-attr"> id</span>: <span class="hljs-number">2</span>,<span class="hljs-attr"> name</span>: <span class="hljs-string">'Jane'</span> }])
})

app.<span class="hljs-title function_ invoke__">listen</span>(<span class="hljs-number">3000</span>, () =&gt; {
  console.<span class="hljs-title function_ invoke__">log</span>(<span class="hljs-string">'Server running on port 3000'</span>)
})
</code></pre>
<h4 data-id="heading-12">方案三：JSONP（适用于老项目）</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// JSONP工具函数</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">jsonp</span>(<span class="hljs-params">url, callbackName = <span class="hljs-string">'callback'</span></span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
    <span class="hljs-comment">// 创建script标签</span>
    <span class="hljs-keyword">const</span> script = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'script'</span>)
    <span class="hljs-keyword">const</span> callbackFunctionName = <span class="hljs-string">`jsonp_<span class="hljs-subst">${<span class="hljs-built_in">Date</span>.now()}</span>_<span class="hljs-subst">${<span class="hljs-built_in">Math</span>.random().toString(<span class="hljs-number">36</span>).substr(<span class="hljs-number">2</span>)}</span>`</span>
    
    <span class="hljs-comment">// 设置全局回调函数</span>
    <span class="hljs-variable language_">window</span>[callbackFunctionName] = <span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> {
      <span class="hljs-comment">// 清理工作</span>
      <span class="hljs-keyword">delete</span> <span class="hljs-variable language_">window</span>[callbackFunctionName]
      <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">removeChild</span>(script)
      <span class="hljs-title function_">resolve</span>(data)
    }
    
    <span class="hljs-comment">// 处理URL，添加回调参数</span>
    <span class="hljs-keyword">const</span> separator = url.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'?'</span>) ? <span class="hljs-string">'&amp;'</span> : <span class="hljs-string">'?'</span>
    script.<span class="hljs-property">src</span> = <span class="hljs-string">`<span class="hljs-subst">${url}</span><span class="hljs-subst">${separator}</span><span class="hljs-subst">${callbackName}</span>=<span class="hljs-subst">${callbackFunctionName}</span>`</span>
    
    <span class="hljs-comment">// 错误处理</span>
    script.<span class="hljs-property">onerror</span> = <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">delete</span> <span class="hljs-variable language_">window</span>[callbackFunctionName]
      <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">removeChild</span>(script)
      <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'JSONP request failed'</span>))
    }
    
    <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">appendChild</span>(script)
  })
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">fetchData</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> <span class="hljs-title function_">jsonp</span>(<span class="hljs-string">'http://api.example.com/data'</span>)
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Received data:'</span>, data)
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Error:'</span>, error)
  }
}
</code></pre>
<h3 data-id="heading-13">环境区分的最佳实践</h3>
<p>在实际项目中，我们需要根据环境使用不同的配置：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// src/config/index.js</span>
<span class="hljs-type">const</span> config = {
  <span class="hljs-comment">// 开发环境</span>
  development: {
    baseURL: <span class="hljs-string">'/api'</span> <span class="hljs-comment">// 使用代理</span>
  },
  <span class="hljs-comment">// 测试环境</span>
  test: {
    baseURL: <span class="hljs-string">'https://test-api.yourcompany.com'</span>
  },
  <span class="hljs-comment">// 生产环境</span>
  production: {
    baseURL: <span class="hljs-string">'https://api.yourcompany.com'</span>
  }
}

<span class="hljs-type">const</span> environment = process.env.NODE_ENV || <span class="hljs-string">'development'</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> config[environment]
</code></pre>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// src/services/api.js</span>
<span class="hljs-keyword">import</span> config from <span class="hljs-string">'@/config'</span>
<span class="hljs-keyword">import</span> axios from <span class="hljs-string">'axios'</span>

<span class="hljs-type">const</span> api = axios.<span class="hljs-built_in">create</span>({
  baseURL: config.baseURL,
  timeout: <span class="hljs-number">10000</span>
})

<span class="hljs-comment">// 环境判断</span>
<span class="hljs-keyword">if</span> (process.env.NODE_ENV === <span class="hljs-string">'development'</span>) {
  <span class="hljs-comment">// 开发环境特殊处理</span>
  api.interceptors.request.<span class="hljs-built_in">use</span>(request =&gt; {
    console.<span class="hljs-built_in">log</span>(<span class="hljs-string">'开发环境请求:'</span>, request)
    <span class="hljs-keyword">return</span> request
  })
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> api
</code></pre>
<h3 data-id="heading-14">完整的工作流程图</h3>
<pre><code class="hljs">开发环境

生产环境

Vue应用发起请求判断当前环境使用开发服务器代理使用生产环境API地址Vue开发服务器接收请求代理中间件处理转发到目标服务器直接请求生产APINginx反向代理后端API服务器返回响应数据
</code></pre>
<h3 data-id="heading-15">常见问题与解决方案</h3>
<h4 data-id="heading-16">1. 代理不生效怎么办？</h4>
<p><strong>检查步骤：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 1. 检查vue.config.js配置是否正确</span>
<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-attr">devServer</span>: {
    <span class="hljs-attr">proxy</span>: {
      <span class="hljs-string">'/api'</span>: {
        <span class="hljs-attr">target</span>: <span class="hljs-string">'http://localhost:3000'</span>,
        <span class="hljs-attr">changeOrigin</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-comment">// 添加日志查看代理是否工作</span>
        <span class="hljs-attr">onProxyReq</span>: <span class="hljs-function">(<span class="hljs-params">proxyReq, req, res</span>) =&gt;</span> {
          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Proxying request:'</span>, req.<span class="hljs-property">url</span>, <span class="hljs-string">'-&gt;'</span>, proxyReq.<span class="hljs-property">path</span>)
        }
      }
    }
  }
}

<span class="hljs-comment">// 2. 检查网络面板，确认请求是否发送到正确地址</span>
<span class="hljs-comment">// 3. 确认后端服务是否正常运行</span>
</code></pre>
<h4 data-id="heading-17">2. 预检请求(OPTIONS)处理</h4>
<pre><code class="hljs language-lua" lang="lua">// 后端需要正确处理OPTIONS请求
app.use(<span class="hljs-string">'/api/*'</span>, (req, res, <span class="hljs-built_in">next</span>) =&gt; {
  <span class="hljs-keyword">if</span> (req.method === <span class="hljs-string">'OPTIONS'</span>) {
    res.header(<span class="hljs-string">'Access-Control-Allow-Origin'</span>, <span class="hljs-string">'*'</span>)
    res.header(<span class="hljs-string">'Access-Control-Allow-Methods'</span>, <span class="hljs-string">'GET, POST, PUT, DELETE, OPTIONS'</span>)
    res.header(<span class="hljs-string">'Access-Control-Allow-Headers'</span>, <span class="hljs-string">'Content-Type, Authorization'</span>)
    res.<span class="hljs-built_in">status</span>(<span class="hljs-number">200</span>).<span class="hljs-keyword">end</span>()
    <span class="hljs-keyword">return</span>
  }
  <span class="hljs-built_in">next</span>()
})
</code></pre>
<h3 data-id="heading-18">总结</h3>
<p>跨域问题是前端开发中的常见挑战，但通过合适的解决方案可以轻松应对：</p>
<ul>
<li>• <strong>开发环境</strong>：使用Vue CLI或Vite的代理功能</li>
<li>• <strong>生产环境</strong>：使用Nginx反向代理或后端配置CORS</li>
<li>• <strong>特殊情况</strong>：考虑JSONP或WebSocket代理</li>
</ul>
<p>记住，<strong>安全始终是首要考虑因素</strong>。在配置CORS时，不要简单地使用<code>*</code>作为允许的源，而应该明确指定可信的域名。</p>
<p>希望这篇详细的指南能帮助你彻底解决Vue项目中的跨域问题！如果你有任何疑问或补充，欢迎在评论区留言讨论。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[拒绝卡顿！小程序图片本地“极速”旋转与格式转换，离屏 Canvas 性能调优实战]]></title>    <link>https://juejin.cn/post/7577689171223248946</link>    <guid>https://juejin.cn/post/7577689171223248946</guid>    <pubDate>2025-11-30T02:43:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577689171223248946" data-draft-id="7577718777481789478" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="拒绝卡顿！小程序图片本地“极速”旋转与格式转换，离屏 Canvas 性能调优实战"/> <meta itemprop="keywords" content="前端,JavaScript,微信小程序"/> <meta itemprop="datePublished" content="2025-11-30T02:43:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小皮虾"/> <meta itemprop="url" content="https://juejin.cn/user/1468603263091623"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            拒绝卡顿！小程序图片本地“极速”旋转与格式转换，离屏 Canvas 性能调优实战
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1468603263091623/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小皮虾
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T02:43:04.000Z" title="Sun Nov 30 2025 02:43:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1. 背景与痛点：高清大图的“崩溃”瞬间</h2>
<p>在开发小程序图片工具时，我们经常面临“两难”境地：</p>
<ol>
<li><strong>用户上传原图</strong>：现代手机拍摄的照片动辄 4000x3000 分辨率，在 iOS 设备上 DPR（设备像素比）通常为 3。</li>
<li><strong>内存爆炸</strong>：如果直接按原图渲染，画布像素高达 <code>(4000*3) * (3000*3) ≈ 1亿像素</code>！这远超小程序的 Canvas 内存限制，导致<strong>微信客户端直接闪退</strong>。</li>
<li><strong>传统方案弊端</strong>：上传服务器处理费流量且慢；普通 Canvas 渲染又卡顿界面。</li>
</ol>
<p>为了解决这个问题，我们打磨出了一套基于 <code>OffscreenCanvas</code> 的高性能本地处理方案，核心在于“<strong>智能计算，动态降级</strong>”。</p>
<h2 data-id="heading-1">2. 核心思路：离屏渲染 + 智能防爆</h2>
<p>我们的方案包含两个关键技术点：</p>
<ol>
<li>
<p><strong>OffscreenCanvas（2D 离屏画布）</strong>：
相比传统 Canvas，它在内存中渲染，不占用 DOM，没有任何 UI 开销，绘图指令执行极快。</p>
</li>
<li>
<p><strong>智能 DPR 限制（核心黑科技）</strong>：
这是防止闪退的关键。我们在绘制前计算“目标画布尺寸”。</p>
<ul>
<li><strong>判断</strong>：如果 <code>逻辑尺寸 * 系统DPR</code> 超过了安全阈值（如 4096px）。</li>
<li><strong>降级</strong>：强制降低使用的 DPR 值，确保最终纹理尺寸在安全范围内。</li>
<li><strong>结果</strong>：牺牲肉眼难以察觉的极微小清晰度，换取 <strong>100% 不闪退</strong> 的稳定性。</li>
</ul>
</li>
</ol>
<h2 data-id="heading-2">3. 硬核代码实现</h2>
<p>以下是<code>帮小忙工具箱</code>小程序封装好的 <code>imageUtils.js</code> 核心源代码，包含<strong>格式转换</strong>和<strong>带防爆逻辑的旋转</strong>功能。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// utils/imageUtils.js</span>

<span class="hljs-comment">// 1. 获取系统基础信息</span>
<span class="hljs-keyword">const</span> wxt = {
  <span class="hljs-attr">dpr</span>: wx.<span class="hljs-title function_">getSystemInfoSync</span>().<span class="hljs-property">pixelRatio</span> || <span class="hljs-number">2</span>
};

<span class="hljs-comment">// 2. 图片对象缓存池（避免重复加载同一张图）</span>
<span class="hljs-keyword">const</span> cacheCanvasImageMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();

<span class="hljs-comment">/**
 * 内部方法：获取/创建 Canvas Image 对象
 */</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getCanvasImage</span>(<span class="hljs-params">canvas, imageUrl</span>) {
  <span class="hljs-keyword">if</span> (cacheCanvasImageMap.<span class="hljs-title function_">has</span>(imageUrl)) {
    <span class="hljs-keyword">return</span> cacheCanvasImageMap.<span class="hljs-title function_">get</span>(imageUrl);
  }
  
  <span class="hljs-comment">// 兼容 Promise.withResolvers 或使用 new Promise</span>
  <span class="hljs-keyword">const</span> { promise, resolve, reject } = <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">withResolvers</span>();
  <span class="hljs-keyword">const</span> image = canvas.<span class="hljs-title function_">createImage</span>();
  image.<span class="hljs-property">onload</span> = <span class="hljs-function">() =&gt;</span> {
    cacheCanvasImageMap.<span class="hljs-title function_">set</span>(imageUrl, image);
    <span class="hljs-title function_">resolve</span>(image);
  };
  image.<span class="hljs-property">onerror</span> = <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`图片加载失败: <span class="hljs-subst">${e.errMsg}</span>`</span>));
  image.<span class="hljs-property">src</span> = imageUrl;
  <span class="hljs-keyword">await</span> promise;
  <span class="hljs-keyword">return</span> image;
}

<span class="hljs-comment">/**
 * 功能一：离屏 Canvas 转换图片格式 (PNG/HEIC -&gt; JPG)
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">string</span>} imageUrl 图片路径
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">string</span>} destFileType 目标类型 'jpg' | 'png'
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">number</span>} quality 质量 0-1
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">convertImageType</span>(<span class="hljs-params">imageUrl, destFileType = <span class="hljs-string">'jpg'</span>, quality = <span class="hljs-number">1</span></span>) {
  <span class="hljs-keyword">const</span> offscreenCanvas = wx.<span class="hljs-title function_">createOffscreenCanvas</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">'2d'</span> });
  <span class="hljs-keyword">const</span> image = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getCanvasImage</span>(offscreenCanvas, imageUrl);
  <span class="hljs-keyword">const</span> { width, height } = image;

  <span class="hljs-comment">// 基础转换：直接使用系统 DPR 保证高清</span>
  offscreenCanvas.<span class="hljs-property">width</span> = width * wxt.<span class="hljs-property">dpr</span>;
  offscreenCanvas.<span class="hljs-property">height</span> = height * wxt.<span class="hljs-property">dpr</span>;

  <span class="hljs-keyword">const</span> ctx = offscreenCanvas.<span class="hljs-title function_">getContext</span>(<span class="hljs-string">'2d'</span>);
  ctx.<span class="hljs-title function_">scale</span>(wxt.<span class="hljs-property">dpr</span>, wxt.<span class="hljs-property">dpr</span>);
  ctx.<span class="hljs-title function_">drawImage</span>(image, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, width, height);

  <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> wx.<span class="hljs-title function_">canvasToTempFilePath</span>({
    <span class="hljs-attr">canvas</span>: offscreenCanvas,
    <span class="hljs-attr">fileType</span>: destFileType,
    <span class="hljs-attr">quality</span>: quality,
  });
  <span class="hljs-keyword">return</span> res.<span class="hljs-property">tempFilePath</span>;
}

<span class="hljs-comment">/**
 * 功能二：极速旋转图片 (含内存保护)
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">string</span>} imageUrl 图片路径
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">number</span>} degree 旋转角度 (90, 180, 270...)
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">rotateImage</span>(<span class="hljs-params">imageUrl, degree = <span class="hljs-number">90</span>, destFileType = <span class="hljs-string">'jpg'</span>, quality = <span class="hljs-number">1</span></span>) {
  <span class="hljs-keyword">const</span> offscreenCanvas = wx.<span class="hljs-title function_">createOffscreenCanvas</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">'2d'</span> });
  <span class="hljs-keyword">const</span> image = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getCanvasImage</span>(offscreenCanvas, imageUrl);
  <span class="hljs-keyword">const</span> { width, height } = image;

  <span class="hljs-keyword">const</span> radian = (degree * <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span>) / <span class="hljs-number">180</span>;
  
  <span class="hljs-comment">// 1. 计算旋转后的逻辑包围盒宽高</span>
  <span class="hljs-keyword">const</span> newWidth = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">abs</span>(width * <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">cos</span>(radian)) + <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">abs</span>(height * <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sin</span>(radian));
  <span class="hljs-keyword">const</span> newHeight = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">abs</span>(width * <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sin</span>(radian)) + <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">abs</span>(height * <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">cos</span>(radian));

  <span class="hljs-comment">// --- ⚡️ 性能优化核心 Start ---</span>
  
  <span class="hljs-comment">// 2. 智能计算 DPR：避免画布过大炸内存</span>
  <span class="hljs-comment">// 设定安全纹理阈值，4096px 是大多数移动端 GPU 的安全线</span>
  <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">LIMIT_SIZE</span> = <span class="hljs-number">4096</span>; 
  <span class="hljs-keyword">let</span> useDpr = wxt.<span class="hljs-property">dpr</span>;

  <span class="hljs-comment">// 核心判断：如果 (逻辑边长 * dpr) 超过限制，自动计算最大允许的 dpr</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(newWidth, newHeight) * useDpr &gt; <span class="hljs-variable constant_">LIMIT_SIZE</span>) {
    useDpr = <span class="hljs-variable constant_">LIMIT_SIZE</span> / <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(newWidth, newHeight);
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">`[ImageRotate] 图片过大，触发自动降级，DPR调整为: <span class="hljs-subst">${useDpr.toFixed(<span class="hljs-number">2</span>)}</span>`</span>);
  }

  <span class="hljs-comment">// 3. 设置物理画布尺寸 (使用计算后的安全 DPR)</span>
  offscreenCanvas.<span class="hljs-property">width</span> = newWidth * useDpr;
  offscreenCanvas.<span class="hljs-property">height</span> = newHeight * useDpr;

  <span class="hljs-keyword">const</span> ctx = offscreenCanvas.<span class="hljs-title function_">getContext</span>(<span class="hljs-string">'2d'</span>);
  ctx.<span class="hljs-title function_">scale</span>(useDpr, useDpr); 
  
  <span class="hljs-comment">// --- 性能优化核心 End ---</span>

  <span class="hljs-comment">// 4. 绘图逻辑：平移 -&gt; 旋转 -&gt; 绘制</span>
  ctx.<span class="hljs-title function_">translate</span>(newWidth / <span class="hljs-number">2</span>, newHeight / <span class="hljs-number">2</span>);
  ctx.<span class="hljs-title function_">rotate</span>(radian);
  ctx.<span class="hljs-title function_">drawImage</span>(image, -width / <span class="hljs-number">2</span>, -height / <span class="hljs-number">2</span>, width, height);

  <span class="hljs-comment">// 5. 导出文件 </span>
  <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> wx.<span class="hljs-title function_">canvasToTempFilePath</span>({
    <span class="hljs-attr">canvas</span>: offscreenCanvas,
    <span class="hljs-attr">fileType</span>: destFileType,
    <span class="hljs-attr">quality</span>: quality,
  });

  <span class="hljs-keyword">return</span> res.<span class="hljs-property">tempFilePath</span>;
}
</code></pre>
<h2 data-id="heading-3">4. 避坑与实战经验</h2>
<ol>
<li><strong>图片转pdf场景经验</strong>
图片转成pdf，在使用<code>pdf-lib</code>插入图片时，只支持jpg、png在插入前先判断一下是否符合，用户可能上传webp等图片（有些人觉得限制上传类型，但图片后缀有可能被篡改过），就需要先转换；另外如果要保证pdf是纵向的，使用canvas提前确保图片为纵向的，就简单很多，无需在<code>pdf-lib</code>做坐标变换</li>
<li><strong>DPR 的取舍艺术</strong>：
很多开发者喜欢写死 <code>offscreenCanvas.width = width</code>，这样导出的图是模糊的。也有人写死 <code>width * systemDpr</code>，这会导致大图闪退。
<strong>最佳实践</strong>就是代码中的 <code>Math.min</code> 逻辑：<strong>在安全范围内，尽可能高清</strong>。</li>
<li><strong>兼容性提示</strong>：
代码中使用了 <code>Promise.withResolvers()</code>，这是 ES2024 新特性。我全局内置兼容代码。</li>
</ol>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/**
 * 创建withResolvers函数
 */</span>
<span class="hljs-title class_">Promise</span>.<span class="hljs-property">withResolvers</span> =
	<span class="hljs-title class_">Promise</span>.<span class="hljs-property">withResolvers</span> ||
	<span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
		<span class="hljs-keyword">let</span> resolve, reject;
		<span class="hljs-keyword">const</span> promise = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">res, rej</span>) =&gt;</span> {
			resolve = res;
			reject = rej;
		});
		<span class="hljs-keyword">return</span> {
			promise,
			resolve,
			reject,
		};
	};
</code></pre>
<h2 data-id="heading-4">写在最后</h2>
<p>通过这一套组合拳，我们成功在小程序中实现了稳定、高效的本地图片处理。无论用户使用几年前的安卓机还是最新的 iPhone，都能流畅地完成图片旋转与转换，再也不用担心内存溢出带来的闪退噩梦了！</p>
<p>希望这篇实战分享能帮你解决 Canvas 开发中的性能难题！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[vue3 Composable介绍]]></title>    <link>https://juejin.cn/post/7577702891273551907</link>    <guid>https://juejin.cn/post/7577702891273551907</guid>    <pubDate>2025-11-30T03:38:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577702891273551907" data-draft-id="7577702891273535523" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="vue3 Composable介绍"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-30T03:38:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="南雨北斗"/> <meta itemprop="url" content="https://juejin.cn/user/4059818590476286"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            vue3 Composable介绍
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4059818590476286/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    南雨北斗
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T03:38:54.000Z" title="Sun Nov 30 2025 03:38:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>好的，我们来深入探讨一下 <strong>Vue 3 的 Composable</strong>。</p>
<h3 data-id="heading-0">1. 什么是 Composable？</h3>
<p><code>Composable</code> 是 Vue 3 中一个核心的概念和功能，它是<strong>可复用的、有状态的逻辑块</strong>，用于封装和提取组件中的重复逻辑，让代码更清晰、更易于维护。</p>
<p>你可以把它理解为：<strong>专门用来存放 “可以被多个组件复用的业务逻辑” 的函数</strong>。</p>
<h3 data-id="heading-1">2. 为什么需要 Composable？</h3>
<p>在 Vue 2 中，我们通常使用 <strong>Mixins</strong> 来复用逻辑。但 Mixins 存在一些问题：</p>
<ul>
<li><strong>命名冲突</strong>：多个 Mixin 可能会定义相同名称的数据或方法，导致覆盖。</li>
<li><strong>来源不清晰</strong>：当一个组件使用了多个 Mixin 后，很难追踪某个数据或方法到底来自哪个 Mixin。</li>
<li><strong>逻辑耦合度高</strong>：Mixins 和组件之间是隐式依赖关系，不易于单独测试和维护。</li>
</ul>
<p>而 Composable 则完美解决了这些问题：</p>
<ul>
<li><strong>明确的依赖关系</strong>：通过函数调用和返回值来显式地传入和获取数据，来源清晰。</li>
<li><strong>无命名冲突</strong>：返回的内容通过解构赋值的方式被组件接收，组件可以自己决定命名。</li>
<li><strong>更好的类型推断</strong>：对于 TypeScript 非常友好，能提供完整的类型提示。</li>
<li><strong>更易于测试</strong>：Composable 本身就是一个函数，可以独立进行单元测试。</li>
</ul>
<h3 data-id="heading-2">3. 如何创建一个 Composable？</h3>
<p>创建一个 Composable 非常简单，它就是一个<strong>以 <code>use</code> 开头的函数</strong>（这是一个约定，便于识别），在函数内部可以使用 Vue 的响应式 API（如 <code>ref</code>, <code>reactive</code>, <code>computed</code>, <code>watch</code> 等），并返回需要暴露给组件使用的状态和方法。</p>
<p><strong>示例：创建一个处理计数器逻辑的 Composable</strong></p>
<p>运行</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// src/composables/useCounter.js</span>

<span class="hljs-keyword">import</span> { ref, computed, onMounted } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;

<span class="hljs-comment">// 定义一个 Composable 函数，通常以 use 开头</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useCounter</span>(<span class="hljs-params">initialValue = <span class="hljs-number">0</span></span>) {
  <span class="hljs-comment">// 1. 定义响应式状态</span>
  <span class="hljs-keyword">const</span> count = <span class="hljs-title function_">ref</span>(initialValue);

  <span class="hljs-comment">// 2. 定义基于状态的计算属性</span>
  <span class="hljs-keyword">const</span> doubleCount = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> count.<span class="hljs-property">value</span> * <span class="hljs-number">2</span>);

  <span class="hljs-comment">// 3. 定义修改状态的方法</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">increment</span> = (<span class="hljs-params"/>) =&gt; {
    count.<span class="hljs-property">value</span>++;
  };

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">decrement</span> = (<span class="hljs-params"/>) =&gt; {
    count.<span class="hljs-property">value</span>--;
  };

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">reset</span> = (<span class="hljs-params"/>) =&gt; {
    count.<span class="hljs-property">value</span> = initialValue;
  };

  <span class="hljs-comment">// 4. 可以使用生命周期钩子</span>
  <span class="hljs-title function_">onMounted</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`计数器已初始化，初始值为: <span class="hljs-subst">${count.value}</span>`</span>);
  });

  <span class="hljs-comment">// 5. 返回需要暴露给组件的内容</span>
  <span class="hljs-keyword">return</span> {
    count,
    doubleCount,
    increment,
    decrement,
    reset
  };
}
</code></pre>
<h3 data-id="heading-3">4. 如何在组件中使用 Composable？</h3>
<p>在组件中，你只需要 <strong>导入并调用</strong> 这个 Composable 函数，然后通过<strong>解构赋值</strong>的方式获取其返回的状态和方法即可。</p>
<p><strong>示例：在组件中使用 <code>useCounter</code></strong></p>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- src/components/CounterDisplay.vue --&gt;
&lt;template&gt;
  &lt;div&gt;
    &lt;p&gt;当前计数: {{ count }}&lt;/p&gt;
    &lt;p&gt;计数的两倍: {{ doubleCount }}&lt;/p&gt;
    &lt;button @click="increment"&gt;+1&lt;/button&gt;
    &lt;button @click="decrement"&gt;-1&lt;/button&gt;
    &lt;button @click="reset"&gt;重置&lt;/button&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;script setup&gt;
import { useCounter } from '@/composables/useCounter';

// 调用 Composable 函数
// 可以传入初始值，如 useCounter(10)
// 通过解构赋值获取返回的状态和方法
const { count, doubleCount, increment, decrement, reset } = useCounter();
&lt;/script&gt;
</code></pre>
<p><strong>关键点</strong>：</p>
<ul>
<li>每次调用 <code>useCounter()</code>，都会创建一个<strong>全新的、独立的</strong>状态实例。这意味着如果两个组件都使用了 <code>useCounter</code>，它们的状态是完全隔离的，互不影响。</li>
<li>组件可以根据需要，只解构自己需要的部分。</li>
</ul>
<h3 data-id="heading-4">5. Composable 的最佳实践</h3>
<ol>
<li>
<p><strong>命名规范</strong>：</p>
<ul>
<li>Composable 函数名<strong>必须以 <code>use</code> 开头</strong>，例如 <code>useCounter</code>, <code>useUser</code>, <code>useCart</code>。</li>
<li>文件名通常与函数名一致，例如 <code>useCounter.js</code>。</li>
</ul>
</li>
<li>
<p><strong>单一职责原则</strong>：</p>
<ul>
<li>一个 Composable 应该只负责一个特定的功能或逻辑。如果一个 Composable 变得过于庞大和复杂，应该考虑将其拆分成多个更小的、职责更单一的 Composable。</li>
</ul>
</li>
<li>
<p><strong>组合与嵌套</strong>：</p>
<ul>
<li>
<p>Composable 可以<strong>相互调用</strong>。这是一个非常强大的特性，允许你构建复杂的逻辑。</p>
</li>
<li>
<p>例如，一个 <code>useCart</code> Composable 内部可以调用 <code>useUser</code> Composable 来获取当前用户信息，以便计算购物车商品的会员价格。</p>
</li>
</ul>
<p>运行</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// src/composables/useCart.js</span>
<span class="hljs-keyword">import</span> { useUser } <span class="hljs-keyword">from</span> <span class="hljs-string">'./useUser'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useCart</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> { user } = <span class="hljs-title function_">useUser</span>(); <span class="hljs-comment">// 调用另一个 Composable</span>

  <span class="hljs-comment">// ... 购物车相关逻辑，可以使用 user 的信息</span>
  <span class="hljs-keyword">const</span> cartItems = <span class="hljs-title function_">ref</span>([]);
  
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">calculateDiscountPrice</span> = (<span class="hljs-params">item</span>) =&gt; {
    <span class="hljs-keyword">if</span> (user.<span class="hljs-property">value</span>?.<span class="hljs-property">isVIP</span>) {
      <span class="hljs-keyword">return</span> item.<span class="hljs-property">price</span> * <span class="hljs-number">0.9</span>; <span class="hljs-comment">// VIP 9 折</span>
    }
    <span class="hljs-keyword">return</span> item.<span class="hljs-property">price</span>;
  };

  <span class="hljs-comment">// ...</span>
  <span class="hljs-keyword">return</span> { cartItems, calculateDiscountPrice };
}
</code></pre>
</li>
<li>
<p><strong>避免在 Composable 中访问组件实例</strong>：</p>
<ul>
<li>理想情况下，Composable 应该是<strong>纯逻辑</strong>的封装，不应该直接依赖于 Vue 组件实例 (<code>this</code>)。</li>
<li>如果确实需要使用组件实例的属性（如 <code>$route</code>, <code>$store</code>），应该通过参数的形式从组件中传递进来，或者使用 Vue 提供的 <code>getCurrentInstance()</code> 函数（但这会降低 Composable 的通用性，应谨慎使用）。</li>
</ul>
</li>
</ol>
<h3 data-id="heading-5">总结</h3>
<p><code>Composable</code> 是 Vue 3 中替代 <code>Mixins</code> 的<strong>更优、更现代</strong>的逻辑复用方案。</p>
<ul>
<li>它通过<strong>函数</strong>的形式封装逻辑，通过<strong>返回值</strong>暴露状态和方法。</li>
<li>它实现了<strong>逻辑的复用和隔离</strong>，让组件代码更简洁、更清晰。</li>
<li>它遵循<strong>明确的依赖关系</strong>和<strong>单一职责原则</strong>，极大地提升了代码的可维护性和可测试性。</li>
<li>在 Vue 3 项目中，<strong>任何可复用的逻辑都应该被提取为 Composable</strong>。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JavaScript数组去重的多种实现方式]]></title>    <link>https://juejin.cn/post/7577705544875507750</link>    <guid>https://juejin.cn/post/7577705544875507750</guid>    <pubDate>2025-11-30T03:53:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577705544875507750" data-draft-id="7577737385954557962" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JavaScript数组去重的多种实现方式"/> <meta itemprop="keywords" content="JavaScript"/> <meta itemprop="datePublished" content="2025-11-30T03:53:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="瓶子in"/> <meta itemprop="url" content="https://juejin.cn/user/3754212287597066"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JavaScript数组去重的多种实现方式
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3754212287597066/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    瓶子in
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T03:53:17.000Z" title="Sun Nov 30 2025 03:53:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>在前端开发中，数组去重是一个常见的需求。无论是处理用户数据、API响应还是进行数据清洗，我们都需要掌握去重方法。本文将详细介绍JavaScript中数组去重的多种实现方式。</p>
<h3 data-id="heading-1">1. 使用Set数据结构（ES6推荐）</h3>
<p>javascript</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">arr</span> = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-string">'a'</span>, <span class="hljs-string">'a'</span>]<span class="hljs-comment">;</span>
const <span class="hljs-attr">uniqueArr</span> = [...new Set(arr)]<span class="hljs-comment">;</span>
console.log(uniqueArr)<span class="hljs-comment">; // [1, 2, 3, 4, 5, "a"]</span>
</code></pre>
<p><strong>Set</strong> 是 ES6 引入的一种新的数据结构，它类似于数组，但是成员的值都是唯一的，没有重复的值。</p>
<p>javascript</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// Set的基本使用</span>
const arr1 = new <span class="hljs-built_in">Set</span>()
arr1<span class="hljs-selector-class">.add</span>(<span class="hljs-number">1</span>)
arr1<span class="hljs-selector-class">.add</span>(<span class="hljs-number">2</span>)
arr1<span class="hljs-selector-class">.add</span>(<span class="hljs-number">3</span>)
arr1<span class="hljs-selector-class">.add</span>(<span class="hljs-number">1</span>)  <span class="hljs-comment">// 重复添加</span>
console<span class="hljs-selector-class">.log</span>(arr1)  <span class="hljs-comment">// {1, 2, 3} - 重复的自动过滤</span>
</code></pre>
<h3 data-id="heading-2">2. 使用filter + indexOf方法</h3>
<p>javascript</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">arr</span> = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>]<span class="hljs-comment">;</span>
const <span class="hljs-attr">uniqueArr</span> = arr.filter((item, index) =&gt; arr.indexOf(item) === index)<span class="hljs-comment">;</span>
console.log(uniqueArr)<span class="hljs-comment">; // [1, 2, 3, 4, 5]</span>
</code></pre>
<p>这里利用了<code>filter</code>方法和<code>indexOf</code>方法的特性：</p>
<ul>
<li><code>filter</code>会遍历数组，将符合条件的元素组成新数组返回</li>
<li><code>indexOf</code>返回元素在数组中第一次出现的位置索引</li>
<li>只有当元素第一次出现时的索引与当前索引相等时，才保留该元素</li>
</ul>
<h3 data-id="heading-3">3. 使用reduce方法</h3>
<p>javascript</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">arr</span> = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>]<span class="hljs-comment">;</span>
const <span class="hljs-attr">uniqueArr</span> = arr.reduce((acc, current) =&gt; {
  return acc.includes(current) ? acc : <span class="hljs-section">[...acc, current]</span><span class="hljs-comment">;</span>
}, <span class="hljs-section">[]</span>)<span class="hljs-comment">;</span>
console.log(uniqueArr)<span class="hljs-comment">; // [1, 2, 3, 4, 5]</span>
</code></pre>
<p><code>reduce</code>方法通过累积器遍历数组，检查当前元素是否已存在于累积器中，不存在则添加。</p>
<h3 data-id="heading-4">4. 使用forEach + includes方法</h3>
<p>javascript</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">arr</span> = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>]<span class="hljs-comment">;</span>
const <span class="hljs-attr">uniqueArr</span> = []<span class="hljs-comment">;</span>
arr.forEach(<span class="hljs-attr">item</span> =&gt; {
  if (!uniqueArr.includes(item)) {
    uniqueArr.push(item)<span class="hljs-comment">;</span>
  }
})<span class="hljs-comment">;</span>
console.log(uniqueArr)<span class="hljs-comment">; // [1, 2, 3, 4, 5]</span>
</code></pre>
<p>这种方法思路直观：</p>
<ul>
<li>创建空数组存储结果</li>
<li>遍历原数组，检查元素是否已存在</li>
<li>不存在则添加到结果数组</li>
</ul>
<p><strong>方法对比</strong>：</p>
<ul>
<li><code>forEach</code>：遍历数组执行操作，不关心返回值</li>
<li><code>map</code>：将数组转换为新数组（1:1映射）</li>
<li><code>filter</code>：根据条件筛选数组元素</li>
</ul>
<h3 data-id="heading-5">5. 对象数组去重（基于特定属性）</h3>
<p>实际开发中，我们经常需要根据对象属性去重：</p>
<p>javascript</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">users</span> = [
  {id: <span class="hljs-number">1</span>, name: <span class="hljs-string">'Alice'</span>},
  {id: <span class="hljs-number">2</span>, name: <span class="hljs-string">'Bob'</span>},
  {id: <span class="hljs-number">1</span>, name: <span class="hljs-string">'Alice'</span>},  // 重复
  {id: <span class="hljs-number">3</span>, name: <span class="hljs-string">'Charlie'</span>}
]<span class="hljs-comment">;</span>

// 方法1：使用Map（推荐）
const <span class="hljs-attr">uniqueUsers</span> = [...new Map(users.map(item =&gt; [item.id, item])).values()]<span class="hljs-comment">;</span>

// 方法2：使用reduce
const <span class="hljs-attr">uniqueUsers2</span> = users.reduce((acc, current) =&gt; {
  const <span class="hljs-attr">exists</span> = acc.find(item =&gt; item.id === current.id)<span class="hljs-comment">;</span>
  return exists ? acc : <span class="hljs-section">[...acc, current]</span><span class="hljs-comment">;</span>
}, <span class="hljs-section">[]</span>)<span class="hljs-comment">;</span>

console.log(uniqueUsers)<span class="hljs-comment">; // 基于id去重后的数组</span>
</code></pre>
<p>Map方法利用键的唯一性，将对象ID作为键，对象本身作为值，最后通过<code>values()</code>获取去重后的对象。</p>
<h3 data-id="heading-6">6. 复杂数据类型去重</h3>
<p>对于包含对象、数组等复杂数据类型的数组：</p>
<p>javascript</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">complexArr</span> = [{a:<span class="hljs-number">1</span>}, {a:<span class="hljs-number">1</span>}, [<span class="hljs-number">1</span>,<span class="hljs-number">2</span>], [<span class="hljs-number">1</span>,<span class="hljs-number">2</span>], <span class="hljs-string">'hello'</span>, <span class="hljs-string">'hello'</span>]<span class="hljs-comment">;</span>

const <span class="hljs-attr">uniqueComplex</span> = complexArr.reduce((acc, current) =&gt; {
  const <span class="hljs-attr">isDuplicate</span> = acc.some(item =&gt;
    JSON.stringify(item) === JSON.stringify(current)
  )<span class="hljs-comment">;</span>
  return isDuplicate ? acc : <span class="hljs-section">[...acc, current]</span><span class="hljs-comment">;</span>
}, <span class="hljs-section">[]</span>)<span class="hljs-comment">;</span>

console.log(uniqueComplex)<span class="hljs-comment">; // 每个元素都是唯一的</span>
</code></pre>
<p>这种方法通过<code>JSON.stringify</code>将对象转为字符串进行比较，但要注意对象属性顺序必须一致。</p>
<h3 data-id="heading-7">7. 排序后去重（适用于可排序数据）</h3>
<p>javascript</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">arr</span> = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>]<span class="hljs-comment">;</span>
const <span class="hljs-attr">uniqueArr</span> = arr
  .sort((a, b) =&gt; a - b)
  .filter((item, index, array) =&gt;
    <span class="hljs-attr">index</span> === <span class="hljs-number">0</span> || item !== array[index - <span class="hljs-number">1</span>]
  )<span class="hljs-comment">;</span>
console.log(uniqueArr)<span class="hljs-comment">; // [1, 2, 3, 4, 5]</span>
</code></pre>
<p>先排序，然后过滤掉与前一元素相同的元素。注意这会改变原数组的顺序。</p>
<h3 data-id="heading-8">性能对比与使用建议</h3>

























<table><thead><tr><th>方法</th><th>适用场景</th></tr></thead><tbody><tr><td><strong>Set</strong></td><td>简单数据类型，现代浏览器</td></tr><tr><td><strong>filter+indexOf</strong></td><td>兼容性要求高</td></tr><tr><td><strong>reduce</strong></td><td>需要自定义逻辑</td></tr><tr><td><strong>Map对象</strong></td><td>对象数组去重</td></tr></tbody></table>
<p><strong>日常开发建议</strong>：</p>
<ul>
<li>简单数组去重：优先使用 <code>[...new Set(arr)]</code></li>
<li>对象数组去重：使用 <code>Map</code> 方法</li>
<li>兼容性要求：使用 <code>filter + indexOf</code></li>
<li>复杂数据：使用 <code>reduce + JSON.stringify</code></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[关于微前端框架wujie的一次企业级应用实践demo？]]></title>    <link>https://juejin.cn/post/7577713754563346484</link>    <guid>https://juejin.cn/post/7577713754563346484</guid>    <pubDate>2025-11-30T05:33:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577713754563346484" data-draft-id="7350181789530374195" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="关于微前端框架wujie的一次企业级应用实践demo？"/> <meta itemprop="keywords" content="前端,Vue.js,React.js"/> <meta itemprop="datePublished" content="2025-11-30T05:33:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="寻找光_sxy"/> <meta itemprop="url" content="https://juejin.cn/user/1495754537711661"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            关于微前端框架wujie的一次企业级应用实践demo？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1495754537711661/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    寻找光_sxy
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T05:33:25.000Z" title="Sun Nov 30 2025 05:33:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin:30px 0 10px;color:#cca152;position:relative;padding-left:50px;border-bottom:2px solid rgba(209,163,78,.6);padding-bottom:0}.markdown-body h1{font-size:30px}.markdown-body h1:before{content:"";width:50px;height:42px;display:block;position:absolute;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACcAAAAhBAMAAACo1K8bAAAABGdBTUEAALGPC/xhBQAAAAFzUkdCAK7OHOkAAAFZaVRYdFhNTDpjb20uYWRvYmUueG1wAAAAAAA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJYTVAgQ29yZSA1LjQuMCI+CiAgIDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+CiAgICAgIDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiCiAgICAgICAgICAgIHhtbG5zOnRpZmY9Imh0dHA6Ly9ucy5hZG9iZS5jb20vdGlmZi8xLjAvIj4KICAgICAgICAgPHRpZmY6T3JpZW50YXRpb24+MTwvdGlmZjpPcmllbnRhdGlvbj4KICAgICAgPC9yZGY6RGVzY3JpcHRpb24+CiAgIDwvcmRmOlJERj4KPC94OnhtcG1ldGE+CkzCJ1kAAAAJcEhZcwAACxMAAAsTAQCanBgAAAAnUExURUdwTMyhUsqkUMyhUsyiUcyhUsyhUsyhUcyhUsyhUs2hUtytWNWoVX44si8AAAAKdFJOUwD8Bfcge95QncCWSSDAAAABh0lEQVQoz2WSPUvDQBjHjyPSOB7drh2OUOs36NA6pKAFwaEo4tDFIUWxGYLgKw4BEYUuHaQg7XJ0kccsUmrT2qUUQZp8KO/y1hSfIYEf/5eHu0MoGU1+sIbSw5Bypd92S+dWWrd34b15vuOPY4QxuvtYZp0lIVk3Zgjt+5zkh12AvBHnbW85BOjXySPwhc5CYcY0OdDh5dEUqIEj4cN8Dty3a1MqYJS4MaWU5wzVLwMMxqGSNQgA/VFa4gf50yhxSUW+db8ACa2gBxfnABVDFYHCPYrc7TLwCepJM8/ZoVsRwpxdHEozHUXd6idwVzFFM5BFmIhQVQjrNdnCvdd48wblI2VHtsAZioSsTYVwLoXvjMXH1icuNgPhQE+Ot1+xi8HeA3d1Df1f1JPVUOmsYLujBjuSySqSXYt+yTwbJ0pcyIhqTrxkn0BazRLizJosxRBued+z0jPD6VewOXl5utHRGmMNK3k0iTkzxpq2/oIQO6gLprF12kT/R20eyzlcg7iwK0dPsz/ibpdsCHweWwAAAABJRU5ErkJggg==) 0 0 no-repeat;background-size:80%;bottom:-10px;left:-2px}.markdown-body h2{font-size:24px}.markdown-body h2:before{content:"";width:50px;height:42px;display:block;position:absolute;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACcAAAAhBAMAAACo1K8bAAAABGdBTUEAALGPC/xhBQAAAAFzUkdCAK7OHOkAAAFZaVRYdFhNTDpjb20uYWRvYmUueG1wAAAAAAA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJYTVAgQ29yZSA1LjQuMCI+CiAgIDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+CiAgICAgIDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiCiAgICAgICAgICAgIHhtbG5zOnRpZmY9Imh0dHA6Ly9ucy5hZG9iZS5jb20vdGlmZi8xLjAvIj4KICAgICAgICAgPHRpZmY6T3JpZW50YXRpb24+MTwvdGlmZjpPcmllbnRhdGlvbj4KICAgICAgPC9yZGY6RGVzY3JpcHRpb24+CiAgIDwvcmRmOlJERj4KPC94OnhtcG1ldGE+CkzCJ1kAAAAJcEhZcwAACxMAAAsTAQCanBgAAAAnUExURUdwTMyhUsqkUMyhUsyiUcyhUsyhUsyhUcyhUsyhUs2hUtytWNWoVX44si8AAAAKdFJOUwD8Bfcge95QncCWSSDAAAABh0lEQVQoz2WSPUvDQBjHjyPSOB7drh2OUOs36NA6pKAFwaEo4tDFIUWxGYLgKw4BEYUuHaQg7XJ0kccsUmrT2qUUQZp8KO/y1hSfIYEf/5eHu0MoGU1+sIbSw5Bypd92S+dWWrd34b15vuOPY4QxuvtYZp0lIVk3Zgjt+5zkh12AvBHnbW85BOjXySPwhc5CYcY0OdDh5dEUqIEj4cN8Dty3a1MqYJS4MaWU5wzVLwMMxqGSNQgA/VFa4gf50yhxSUW+db8ACa2gBxfnABVDFYHCPYrc7TLwCepJM8/ZoVsRwpxdHEozHUXd6idwVzFFM5BFmIhQVQjrNdnCvdd48wblI2VHtsAZioSsTYVwLoXvjMXH1icuNgPhQE+Ot1+xi8HeA3d1Df1f1JPVUOmsYLujBjuSySqSXYt+yTwbJ0pcyIhqTrxkn0BazRLizJosxRBued+z0jPD6VewOXl5utHRGmMNK3k0iTkzxpq2/oIQO6gLprF12kT/R20eyzlcg7iwK0dPsz/ibpdsCHweWwAAAABJRU5ErkJggg==) 0 0 no-repeat;background-size:70%;bottom:-15px;left:-1px}.markdown-body h3{font-size:18px}.markdown-body h3:before{content:"";width:50px;height:42px;display:block;position:absolute;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACcAAAAhBAMAAACo1K8bAAAABGdBTUEAALGPC/xhBQAAAAFzUkdCAK7OHOkAAAFZaVRYdFhNTDpjb20uYWRvYmUueG1wAAAAAAA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJYTVAgQ29yZSA1LjQuMCI+CiAgIDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+CiAgICAgIDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiCiAgICAgICAgICAgIHhtbG5zOnRpZmY9Imh0dHA6Ly9ucy5hZG9iZS5jb20vdGlmZi8xLjAvIj4KICAgICAgICAgPHRpZmY6T3JpZW50YXRpb24+MTwvdGlmZjpPcmllbnRhdGlvbj4KICAgICAgPC9yZGY6RGVzY3JpcHRpb24+CiAgIDwvcmRmOlJERj4KPC94OnhtcG1ldGE+CkzCJ1kAAAAJcEhZcwAACxMAAAsTAQCanBgAAAAnUExURUdwTMyhUsqkUMyhUsyiUcyhUsyhUsyhUcyhUsyhUs2hUtytWNWoVX44si8AAAAKdFJOUwD8Bfcge95QncCWSSDAAAABh0lEQVQoz2WSPUvDQBjHjyPSOB7drh2OUOs36NA6pKAFwaEo4tDFIUWxGYLgKw4BEYUuHaQg7XJ0kccsUmrT2qUUQZp8KO/y1hSfIYEf/5eHu0MoGU1+sIbSw5Bypd92S+dWWrd34b15vuOPY4QxuvtYZp0lIVk3Zgjt+5zkh12AvBHnbW85BOjXySPwhc5CYcY0OdDh5dEUqIEj4cN8Dty3a1MqYJS4MaWU5wzVLwMMxqGSNQgA/VFa4gf50yhxSUW+db8ACa2gBxfnABVDFYHCPYrc7TLwCepJM8/ZoVsRwpxdHEozHUXd6idwVzFFM5BFmIhQVQjrNdnCvdd48wblI2VHtsAZioSsTYVwLoXvjMXH1icuNgPhQE+Ot1+xi8HeA3d1Df1f1JPVUOmsYLujBjuSySqSXYt+yTwbJ0pcyIhqTrxkn0BazRLizJosxRBued+z0jPD6VewOXl5utHRGmMNK3k0iTkzxpq2/oIQO6gLprF12kT/R20eyzlcg7iwK0dPsz/ibpdsCHweWwAAAABJRU5ErkJggg==) 0 0 no-repeat;background-size:60%;bottom:-19px;left:-2px}.markdown-body h4{font-size:16px;padding-left:0;border-bottom:1px solid rgba(209,163,78,.6)}.markdown-body h5{font-size:15px;padding-left:0}.markdown-body em{color:#cca152}.markdown-body del{text-decoration-color:#cca152;text-decoration-thickness:2px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:80%;margin:6px auto;box-shadow:0 6px 15px #8e8e8e;display:block;margin:20px auto!important;object-fit:contain;border-radius:8px}.markdown-body hr{border:none;border-top:2px solid #e0c9a1;margin-top:32px 0}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background:#f6efde;color:#b69454;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Mono,Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;background:#fef6e1;border-radius:4px;box-shadow:0 0 8px hsla(0,0%,47%,.45)}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADIAAAAOCAMAAABaWb9VAAAABGdBTUEAALGPC/xhBQAAAAFzUkdCAK7OHOkAAAFZaVRYdFhNTDpjb20uYWRvYmUueG1wAAAAAAA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJYTVAgQ29yZSA1LjQuMCI+CiAgIDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+CiAgICAgIDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiCiAgICAgICAgICAgIHhtbG5zOnRpZmY9Imh0dHA6Ly9ucy5hZG9iZS5jb20vdGlmZi8xLjAvIj4KICAgICAgICAgPHRpZmY6T3JpZW50YXRpb24+MTwvdGlmZjpPcmllbnRhdGlvbj4KICAgICAgPC9yZGY6RGVzY3JpcHRpb24+CiAgIDwvcmRmOlJERj4KPC94OnhtcG1ldGE+CkzCJ1kAAAAJcEhZcwAADsQAAA7EAZUrDhsAAACHUExURUdwTMxCKdc8NvdYT/9hVyLJPABBAGubKNiIOv+/K+ytJBakH9aZG+5QR5VZDOBDPhmtJ8+VGuGjH/CwJR26MR6+NBq0LPW1KBmwKetNRfJUTONHP92fHuSmIeFEPhu3LR29M/BTS+mqIuqsI5qdHyLKPP++Kv9gVf9lW//KLSXXQCTQP//FLMVm5KQAAAAldFJOUwAlPPz7+woBBPu8Mzu+FlRRKmvnweeG+Wqg6mVNXmuc1OCbmjZJWF/9AAABKklEQVQoz3WS6XaCMBCFRzAM++KGsqhtDwES3//5OtmA2uP9A9zwzRoAgBC0QgQrdA68OZsDr229YGHoIEj7Pl0ZOgjKa5lYJ4Rd1vijn3nuD4Qurjmv48o6RFyfbGDnS6DeEXZfk5ZfuBhdPb9I87ECNMh1EFJKIU6agWzaa01NbmLkxznSmmObJBkkUxrERf3i+ftRiZi7ShPCYY64UhTx1AR5CDYoMXkOKEY7GmTcTzeD/FiER68DfSLgSRqEIBoB3P8h3x8RZhBXGJGusJdD6rfCBl0YqvZNkrV9zej2cWlfJWG6fRpyM41qYH+GTPPi2yFLQYC0Qybm5o96lW77kMbcrBKtgeWTsthVamNXFF4I6x0DTPuugsVRFyYpyxzWqNvHJwed8ws7QyP1UwjNjwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#fef6e1}.markdown-body a{text-decoration:none;color:#d8ac5a;border-bottom:1px solid #d8ac5a}.markdown-body a:active,.markdown-body a:hover{color:#93753f;border-color:#93753f}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f4e8c7;border-collapse:collapse}.markdown-body thead{background:rgba(255,227,176,.6588235294);text-align:left;display:table-header-group;border-bottom:1px solid rgba(255,227,176,.6588235294)}.markdown-body tbody{background:rgba(255,247,229,.3882352941)}.markdown-body td,.markdown-body th{padding:7px;line-height:24px;min-width:100px}.markdown-body blockquote{color:#bd954f;padding:1px 23px;margin:22px 0;border-left:4px solid #dcb267;background-color:#fff7e5}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol .task-list-item,.markdown-body ul .task-list-item{list-style:none}.markdown-body ol li{padding-left:6px}.markdown-body::marker{color:#dcb267}.markdown-body .contains-task-list{padding-left:0}.markdown-body .contains-task-list .task-list-item{list-style:none;position:relative}.markdown-body .contains-task-list .task-list-item input[type=checkbox]{position:relative;top:2px}.markdown-body .contains-task-list .task-list-item input[type=checkbox]:before{content:"";display:inline-block;height:12px;width:12px;position:absolute;left:-2px;top:-2px;border:2px solid #cda152;border-radius:5px}.markdown-body .contains-task-list .task-list-item input[type=checkbox]:checked{position:relative;top:2px}.markdown-body .contains-task-list .task-list-item input[type=checkbox]:checked:before{border:none;content:"";display:inline-block;height:17px;width:17px;position:absolute;left:-2px;top:-2px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAFo9M/3AAAAAXNSR0IArs4c6QAAAYhJREFUOBFjYACC0/MDGsDEiyvr/zOCeUwMJxn/A8HZRUEMYBFGJsZ6kFoQYALiAyAGCgDpA+sFijKeWRj4H1kWpIWBW1SDQcm+BCzOAiK/vr7BcO/gDbAAI4hE1waWgRBnmWCGIwkyKFjnwow0BhsJk9QLncvw5dV1oPE9MCEGmBWrgCKhcFEowyR+PSNYwemFAZ4M/xjMkRWYJm5oAPFB/joDpI1BHHQANgGPDxj+//vfCA4IdJ3GcevgQnAFhlHLwYIgSVA0wABcwY3tFQzokiBFGIEP0wmigW5wZAK5FFkQib0a6NUDcEmgb7AGFpIGZOZqoMFhIAFQknEAJpn9yLLEssFOBCp2IFaDkl0xg6C8FbJyB3gowUS5RdQYBORQYpVB1iwVHIIMwJh///AYTCmYRklNIBFmNi4GeYt0BhnjeIa3dw8wSBlEgDUhxw2yCRgGfHp2geHiqiSwUwUVrFAiFVkjjA1LrjgTHEwhFvosMCZM4NEIUoAtWWNoBGZ70/gN22HiAD2uhAzsYNBZAAAAAElFTkSuQmCC) 0 0 no-repeat;background-size:100%}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>本文将介绍我一种<code>wujie</code>的一次具体的应用，包括使用的场景、方式等等，完成一个具体的demo；</p>
<h2 data-id="heading-1">为什么要用微前端</h2>
<p>事情是这样的，我们之前的业务有一个<code>vue3+ts+vite</code>的后台项目，后来公司决定新开发一个新的业务线，但是由于人力有限，如果重新搭建一个新的后台时间和人力成本较大都，尤其是其中的<code>权限</code>、<code>登录</code>功能的设计都比较复杂，所以我们综合考虑，有没有一种可以直接用旧后台的权限和登录功能，然后其它功能完全隔离的，且旧后台和新后台可用两个部门的人来开发，可以独立开发、测试、部署，甚至技术栈也可以不受影响呢？这里我们想到了微前端方案；</p>
<h2 data-id="heading-2">微前端方案选择</h2>
<p>我们经过调研，目光逐步瞄向了两种微前端的方案:<a href="https://link.juejin.cn?target=https%3A%2F%2Fwujie-micro.github.io%2Fdoc%2F" target="_blank" title="https://wujie-micro.github.io/doc/" ref="nofollow noopener noreferrer">无界</a> 和 <a href="https://link.juejin.cn?target=https%3A%2F%2Fqiankun.umijs.org%2Fzh" target="_blank" title="https://qiankun.umijs.org/zh" ref="nofollow noopener noreferrer">乾坤</a>；</p>
<p>对比我们的业务，经过调研发现无界相比于乾坤更有优势:</p>
<ul>
<li>1、对旧后台项目影响较小，侵入程度低：只需要在旧有后台的项目上新起page页，以及新增一个路由即可；</li>
<li>2、可单独开发、部署：子应用可以单独开发、部署，也可以使用一个全新的技术栈，即使生产环境无界挂了，出现问题了，也可以直接访问子应用；</li>
</ul>
<p>综上两种原因，我们决定使用无界的方案；</p>
<h2 data-id="heading-3">怎么用无界（demo演示）</h2>
<p>我们的主应用是<code>vue3</code>，这里将子应用通过菜单栏的形式嵌入到父应用中间，点击菜单即可进入到子应用</p>
<p><strong>登录场景</strong>，在子应用请求时，若发现登录失效，通过子组件通信<code>window.$wujie.bus.$emit('notLogin')</code>向父应用传递未登录消息，父应用执行后续逻辑</p>
<p><strong>权限逻辑</strong>，天然就互通，当子应用的<code>菜单权限</code>在某些角色下不可见时，在父应用下直接隐藏掉菜单就行；如果是子应用下<code>按钮权限</code>等功能权限时，可在子应用单独再次调用权限接口，或通过父子应用通信方式获取权限信息
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9c1e77b2059e49ed8bf24cc1f3ebb356~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a-75om-5YWJX3N4eQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765085605&amp;x-signature=1XXEN7ik87e2t3t3jRdIUJ%2FK5vM%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-4">具体步骤</h2>
<h3 data-id="heading-5">父应用改造</h3>
<ul>
<li>下载新依赖</li>
<li>wujie相关文件</li>
<li>路由
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cbe03c9176f246e799289572f8820601~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a-75om-5YWJX3N4eQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765085605&amp;x-signature=YS5cSbUIJmQ0DNrIrSWwPlI8%2FOQ%3D" alt="image.png" loading="lazy"/></li>
</ul>
<h4 data-id="heading-6">下载相关依赖</h4>
<pre><code class="hljs language-js" lang="js">pnpm install wujie-vue3
</code></pre>
<h4 data-id="heading-7">创建wujie文件</h4>
<p>用于补充<code>wujie</code>的相关逻辑：</p>
<ul>
<li><code>wujie</code>的<code>template</code>及<code>相关属性</code>
<ul>
<li><code>name</code>: 子应用唯一标识</li>
<li><code>url</code>: 子应用运行地址</li>
<li><code>props</code>：向子应用传递的参数</li>
</ul>
</li>
<li>父子应用通信
<ul>
<li>通知子应用路由发生改变</li>
<li>通知子应用其他数据</li>
<li>子应用告知父应用未登录</li>
<li>子应用告知父应用其他信息
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bf33bbea958246a6943ccb1638f33669~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a-75om-5YWJX3N4eQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765085605&amp;x-signature=eNUjHxP%2BsNOsC%2BydBtLw4Hha5AE%3D" alt="image.png" loading="lazy"/></li>
</ul>
</li>
</ul>
<pre><code class="hljs language-js" lang="js">&lt;template&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"main-app"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Vue3 主应用<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 嵌入 React 子应用 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">WujieVue</span> <span class="hljs-attr">width</span>=<span class="hljs-string">"100%"</span> <span class="hljs-attr">height</span>=<span class="hljs-string">"600px"</span> <span class="hljs-attr">:url</span>=<span class="hljs-string">"subAppUrl"</span> <span class="hljs-attr">:name</span>=<span class="hljs-string">"subAppName"</span> <span class="hljs-attr">:props</span>=<span class="hljs-string">"subAppProps"</span> /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
&lt;/template&gt;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"ts"</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { ref } <span class="hljs-keyword">from</span> <span class="hljs-string">"vue"</span>;
<span class="hljs-keyword">import</span> { useRouter } <span class="hljs-keyword">from</span> <span class="hljs-string">"vue-router"</span>;
<span class="hljs-keyword">import</span> { watch } <span class="hljs-keyword">from</span> <span class="hljs-string">"vue"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">WujieVue</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"wujie-vue3"</span>;

<span class="hljs-keyword">const</span> { bus } = <span class="hljs-title class_">WujieVue</span>;

<span class="hljs-comment">// 子应用配置（React 子应用的运行地址，后续启动子应用后会用到）</span>
<span class="hljs-keyword">const</span> subAppName = <span class="hljs-title function_">ref</span>(<span class="hljs-string">"react-sub-app"</span>); <span class="hljs-comment">// 子应用唯一标识（必须唯一）</span>
<span class="hljs-keyword">const</span> subAppUrl = <span class="hljs-title function_">ref</span>(<span class="hljs-string">"http://localhost:1074/#/wujieDemo1"</span>); <span class="hljs-comment">// 子应用端口（后续配置 React 子应用为 3001）</span>

<span class="hljs-comment">// 主应用向子应用传递的 props（可选）</span>
<span class="hljs-keyword">const</span> subAppProps = <span class="hljs-title function_">ref</span>({
  <span class="hljs-attr">mainAppName</span>: <span class="hljs-string">"Vue3 主应用"</span>,
  <span class="hljs-attr">token</span>: <span class="hljs-string">"main-app-token-123"</span>,
});

<span class="hljs-keyword">const</span> router = <span class="hljs-title function_">useRouter</span>();
<span class="hljs-comment">/** 监听子应用的数据 */</span>
bus.$on(<span class="hljs-string">"subAppData"</span>, <span class="hljs-function">(<span class="hljs-params">data: { type: string, payload?: any }</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> { type } = data;
  <span class="hljs-keyword">if</span> (type == <span class="hljs-string">"noLogin"</span>) {
    <span class="hljs-title function_">alert</span>(<span class="hljs-string">"未登录"</span>)
  }
});

<span class="hljs-comment">/** 监听子应用的数据 */</span>


<span class="hljs-title function_">watch</span>(
  <span class="hljs-function">() =&gt;</span> router.<span class="hljs-property">currentRoute</span>.<span class="hljs-property">value</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">subAppPath</span>,
  <span class="hljs-function">(<span class="hljs-params">newVal</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (newVal === <span class="hljs-literal">undefined</span>) <span class="hljs-keyword">return</span>;
    bus.$emit(<span class="hljs-string">"routeChange"</span>, newVal);
  },
  {
    <span class="hljs-attr">immediate</span>: <span class="hljs-literal">true</span>,
  }
);
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>
</code></pre>
<h4 data-id="heading-8">创建wujie路由</h4>
<p>这里新建了一个路由的文件<code>wujieRouter.ts</code></p>
<p>通过监听<code>subAppPath</code>去判断跳转到子应用对应路由，且这里的<code>subAppPath</code>其实对应的是子应用的路由<code>path</code></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> routerName = <span class="hljs-string">"wujiePage"</span>;

<span class="hljs-keyword">const</span> wujieRouters = [
  {
    <span class="hljs-attr">path</span>: <span class="hljs-string">`/<span class="hljs-subst">${routerName}</span>`</span>,
    <span class="hljs-attr">name</span>: <span class="hljs-string">`<span class="hljs-subst">${routerName}</span>`</span>,
    <span class="hljs-attr">component</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">"@/pages/wujie/index.vue"</span>),
    <span class="hljs-attr">meta</span>: {
      <span class="hljs-attr">title</span>: <span class="hljs-string">'新项目-react'</span>, <span class="hljs-comment">// 菜单显示文本</span>
      <span class="hljs-attr">icon</span>: <span class="hljs-string">'CreditCard'</span>, <span class="hljs-comment">// 菜单图标</span>
      <span class="hljs-attr">hidden</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">level</span>: <span class="hljs-number">0</span>,
    },
    <span class="hljs-attr">children</span>: [
      {
        <span class="hljs-attr">path</span>: <span class="hljs-string">"wujieDemo1"</span>, <span class="hljs-comment">// 子路由直接使用相对路径，不要包含父路由名称</span>
        <span class="hljs-attr">name</span>: <span class="hljs-string">`<span class="hljs-subst">${routerName}</span>wujieDemo1`</span>, <span class="hljs-comment">// 名称保持唯一，不要使用斜杠</span>
        <span class="hljs-attr">component</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">"@/pages/wujie/wujie.vue"</span>),
        <span class="hljs-attr">meta</span>: {
          <span class="hljs-attr">title</span>: <span class="hljs-string">'wujieDemo1'</span>, <span class="hljs-comment">// 菜单显示文本</span>
          <span class="hljs-attr">icon</span>: <span class="hljs-string">'Present'</span>, <span class="hljs-comment">// 子菜单图标</span>
          <span class="hljs-attr">hidden</span>: <span class="hljs-literal">false</span>,
          <span class="hljs-attr">level</span>: <span class="hljs-number">1</span>,
          <span class="hljs-attr">subAppPath</span>: <span class="hljs-string">"/wujieDemo1"</span>,
        },
      },
      {
        <span class="hljs-attr">path</span>: <span class="hljs-string">"wujieDemo2"</span>, <span class="hljs-comment">// 子路由直接使用相对路径，不要包含父路由名称</span>
        <span class="hljs-attr">name</span>: <span class="hljs-string">`<span class="hljs-subst">${routerName}</span>wujieDemo2`</span>, <span class="hljs-comment">// 名称保持唯一，不要使用斜杠</span>
        <span class="hljs-attr">component</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">"@/pages/wujie/wujie.vue"</span>),
        <span class="hljs-attr">meta</span>: {
          <span class="hljs-attr">title</span>: <span class="hljs-string">'wujieDemo2'</span>, <span class="hljs-comment">// 菜单显示文本</span>
          <span class="hljs-attr">icon</span>: <span class="hljs-string">'Present'</span>, <span class="hljs-comment">// 子菜单图标</span>
          <span class="hljs-attr">hidden</span>: <span class="hljs-literal">false</span>,
          <span class="hljs-attr">level</span>: <span class="hljs-number">1</span>,
          <span class="hljs-attr">subAppPath</span>: <span class="hljs-string">"/wujieDemo2"</span>,
        },
      },
    ]
  },

]

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> wujieRouters;
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/446f3a755514463ab0de858e42137875~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a-75om-5YWJX3N4eQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765085605&amp;x-signature=WLK9LYrIhROK6f5uG998Vq9i1lc%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-9">子应用改造</h3>
<ul>
<li>运行环境判断</li>
<li>路由通信</li>
<li>嵌入子页面</li>
<li>路由</li>
<li>接口响应拦截器</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aec99d36bd70487d837dfe398a774ea2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a-75om-5YWJX3N4eQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765085605&amp;x-signature=X8eaaEjF3qPi5IP5dApZtd7bbL4%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-10">运行环境判断</h4>
<p>这里我们在<code>main.tsx</code>文件通过判断<code>window.$wujie</code>属性是否存在，来判断当前的运行环境是独立运行还是微前端环境</p>
<p><strong>原理</strong>：<code>wujie</code>会自动给子应用的<code>window</code>上挂载一个<code>$wujie</code>对象</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">StrictMode</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>;
<span class="hljs-keyword">import</span> { createRoot } <span class="hljs-keyword">from</span> <span class="hljs-string">"react-dom/client"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">HashRouter</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"react-router-dom"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">"./style/index.css"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">App</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"./App"</span>;

<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Provider</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"react-redux"</span>;
<span class="hljs-keyword">import</span> { store } <span class="hljs-keyword">from</span> <span class="hljs-string">"./model/store"</span>;

<span class="hljs-comment">// Wujie 子应用生命周期：挂载（主应用嵌入时调用）</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">mount</span> = (<span class="hljs-params">container: HTMLElement | ShadowRoot, props: any</span>) =&gt; {
  <span class="hljs-comment">// 将主应用 props 存入 React 上下文（方便子应用内部使用）</span>
  <span class="hljs-title function_">createRoot</span>(container).<span class="hljs-title function_">render</span>(
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">StrictMode</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Provider</span> <span class="hljs-attr">store</span>=<span class="hljs-string">{store}</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">HashRouter</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">App</span> {<span class="hljs-attr">...props</span>} /&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">HashRouter</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">Provider</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">StrictMode</span>&gt;</span></span>
  );
};

<span class="hljs-comment">// 判断是否在 Wujie 微前端环境中</span>
<span class="hljs-keyword">if</span> (<span class="hljs-variable language_">window</span>.<span class="hljs-property">$wujie</span>) {
  <span class="hljs-title function_">mount</span>(<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">"root"</span>)!, <span class="hljs-variable language_">window</span>.<span class="hljs-property">$wujie</span>.<span class="hljs-property">props</span>);
} <span class="hljs-keyword">else</span> {
  <span class="hljs-comment">// 独立运行环境（正常启动）</span>
  <span class="hljs-title function_">mount</span>(<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">"root"</span>)!, {
    <span class="hljs-attr">mainAppName</span>: <span class="hljs-string">"独立运行"</span>,
    <span class="hljs-attr">token</span>: <span class="hljs-string">"local-token"</span>,
  });
}

</code></pre>
<h4 data-id="heading-11">路由通信</h4>
<p>在<code>app.tsx</code>文件中修改</p>
<p>子应用监听到父应用的路由发生了改变，立即进行路由跳转</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { router } <span class="hljs-keyword">from</span> <span class="hljs-string">"./router/createRouteConfig"</span>;
<span class="hljs-keyword">import</span> { useNavigate, useRoutes } <span class="hljs-keyword">from</span> <span class="hljs-string">"react-router-dom"</span>;
<span class="hljs-keyword">import</span> useLocationChange <span class="hljs-keyword">from</span> <span class="hljs-string">"./router/useLocationChange"</span>;
<span class="hljs-keyword">import</span> routerListener <span class="hljs-keyword">from</span> <span class="hljs-string">"./router/routerListener"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">"./style/index.css"</span>;
<span class="hljs-keyword">import</span> { useEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>;

<span class="hljs-keyword">const</span> <span class="hljs-title class_">App</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">props: any</span>) {
  <span class="hljs-keyword">const</span> elements = <span class="hljs-title function_">useRoutes</span>(router);
  <span class="hljs-keyword">const</span> navigate = <span class="hljs-title function_">useNavigate</span>();

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> wujieBus = <span class="hljs-variable language_">window</span>.<span class="hljs-property">$wujie</span>?.<span class="hljs-property">bus</span>;
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">routeChangeHandler</span> = (<span class="hljs-params">path: string</span>) =&gt; {
      <span class="hljs-title function_">navigate</span>(path);
    };
    wujieBus?.$on(<span class="hljs-string">"routeChange"</span>, routeChangeHandler);
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
      wujieBus?.$off(<span class="hljs-string">"routeChange"</span>, routeChangeHandler);
    };                                                                                                                               
  }, [navigate]);

  <span class="hljs-title function_">useLocationChange</span>(<span class="hljs-function">(<span class="hljs-params">to, <span class="hljs-keyword">from</span></span>) =&gt;</span> {
    <span class="hljs-title function_">routerListener</span>(navigate, to, <span class="hljs-keyword">from</span>);
  });
  <span class="hljs-keyword">return</span> elements;
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">App</span>;

</code></pre>
<h4 data-id="heading-12">嵌入的子页面</h4>
<p>新建立一个文件用于放嵌入的子页面，且在该子页面中还可以向父应用通信</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> <span class="hljs-title function_">wujieDemo1</span> = (<span class="hljs-params"/>) =&gt; {

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>我是子应用(react)的wujieDemo1<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span>  window.$wujie?.bus.$emit("subAppData", "我是子应用数据")}&gt;向主应用提交数据<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> wujieDemo1;

</code></pre>
<h4 data-id="heading-13">路由</h4>
<p>新建路由用于对应上面的子页面</p>
<p>其中需要注意的是，路由的<code>path</code>需要对应父应用路由上的<code>subAppPath</code></p>
<pre><code class="hljs language-js" lang="js">......
  {
      <span class="hljs-attr">name</span>: <span class="hljs-string">"wujieDemo1"</span>,
      <span class="hljs-attr">path</span>: <span class="hljs-string">"/wujieDemo1"</span>,
      <span class="hljs-attr">component</span>: <span class="hljs-title function_">lazy</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">"../page/wujiePage/wujieDemo1/index"</span>)),
      <span class="hljs-attr">isMenu</span>: <span class="hljs-literal">false</span>,
    },
......
</code></pre>
<h4 data-id="heading-14">接口响应拦截器</h4>
<p>在响应拦截器中，主要是针对<strong>未登录</strong>的场景，在未登录时，告知父应用</p>
<p>这里也做了运行环境的判断，用于<strong>判断</strong>是进入子应用的登录页面还是父应用的登录页面</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 将方法封装成一个函数</span>
<span class="hljs-keyword">const</span> http = <span class="hljs-keyword">async</span> (<span class="hljs-attr">config</span>: <span class="hljs-title class_">IAxiosParam</span>): <span class="hljs-title class_">Promise</span>&lt;any&gt; =&gt; {
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">request</span>(config)
    .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">res: IResponse</span>) =&gt;</span> {
      <span class="hljs-keyword">switch</span> (res.<span class="hljs-property">code</span>) {
        <span class="hljs-keyword">case</span> <span class="hljs-title class_">ResCode</span>.<span class="hljs-property">notLogin</span>:
          <span class="hljs-comment">// 未登录</span>
          <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">window</span>.<span class="hljs-property">$wujie</span>) {
            <span class="hljs-variable language_">window</span>.<span class="hljs-property">$wujie</span>?.<span class="hljs-property">bus</span>.$emit(<span class="hljs-string">"subAppData"</span>, {
              <span class="hljs-attr">type</span>: <span class="hljs-string">"noLogin"</span>
            })
          } <span class="hljs-keyword">else</span> {
            <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">href</span> = <span class="hljs-string">"/login"</span>;
          }
          <span class="hljs-keyword">break</span>;
      }

      <span class="hljs-keyword">if</span> (res.<span class="hljs-property">code</span> !== <span class="hljs-number">0</span> &amp;&amp; !config.<span class="hljs-property">noAlert</span>) {
        <span class="hljs-comment">// 异常提示</span>
        <span class="hljs-title function_">alert</span>(res.<span class="hljs-property">msg</span> || <span class="hljs-string">"出现问题啦~"</span>);
        <span class="hljs-keyword">return</span>;
      }
      <span class="hljs-keyword">return</span> config.<span class="hljs-property">needRes</span> ? res : res.<span class="hljs-property">data</span>;
    })
    .<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {
      <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(res);
    });
};
</code></pre>
<h2 data-id="heading-15">总结</h2>
<p>这里我完成了一个基础的demo，在时间的应用还有一些需要注意或优化的点：</p>
<ul>
<li>子应用的运行地址可配置化</li>
<li>子应用的预加载与保活</li>
<li>多个子应用的配置</li>
</ul>
<p>后续可根据自己的实际场景来配置</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[类属性公共还是私有]]></title>    <link>https://juejin.cn/post/7577737385954689034</link>    <guid>https://juejin.cn/post/7577737385954689034</guid>    <pubDate>2025-11-30T05:37:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577737385954689034" data-draft-id="7577689171223412786" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="类属性公共还是私有"/> <meta itemprop="keywords" content="TypeScript,JavaScript"/> <meta itemprop="datePublished" content="2025-11-30T05:37:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Robet"/> <meta itemprop="url" content="https://juejin.cn/user/193141028175320"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            类属性公共还是私有
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/193141028175320/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Robet
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T05:37:33.000Z" title="Sun Nov 30 2025 05:37:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>决定一个类的属性（成员变量）是<strong>公共（public）还是私有（private）</strong> ，是面向对象设计中的核心问题之一。这不仅关乎代码封装性，还直接影响系统的<strong>可维护性、可扩展性和健壮性</strong>。</p>
<p>以下是系统化的思考框架和实用原则，帮助你做出合理决策：</p>
<hr/>
<h2 data-id="heading-0">🔑 核心原则：<strong>最小暴露原则（Principle of Least Exposure）</strong></h2>
<blockquote>
<p><strong>“只暴露必须暴露的内容，其余一律隐藏。”</strong></p>
</blockquote>
<p>换句话说：<br/>
✅ <strong>默认私有</strong>，只有当<strong>确实需要外部访问</strong>时，才设为公共。</p>
<hr/>
<h2 data-id="heading-1">一、判断标准：问自己这几个问题</h2>
<h3 data-id="heading-2">1. <strong>外部是否需要直接读取这个值？</strong></h3>
<ul>
<li>✅ 是 → 考虑 <code>public</code> 或提供 <strong>getter</strong></li>
<li>❌ 否 → <code>private</code></li>
</ul>
<blockquote>
<p>📌 示例：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">BankAccount</span> {
  <span class="hljs-keyword">private</span> <span class="hljs-attr">balance</span>: <span class="hljs-built_in">number</span>; <span class="hljs-comment">// 外部不应直接读余额（需鉴权/日志）</span>
  <span class="hljs-title function_">getBalance</span>(): <span class="hljs-built_in">number</span> { <span class="hljs-comment">/* ... */</span> } <span class="hljs-comment">// 通过方法控制访问</span>
}
</code></pre>
</blockquote>
<h3 data-id="heading-3">2. <strong>外部是否需要直接修改这个值？</strong></h3>
<ul>
<li>✅ 是 → 考虑 <code>public</code> 或提供 <strong>setter</strong>（但要谨慎！）</li>
<li>❌ 否 → <code>private</code></li>
</ul>
<blockquote>
<p>⚠️ 直接暴露可变状态容易导致 bug：</p>
<pre><code class="hljs language-ini" lang="ini">// 危险！
<span class="hljs-attr">user.profile.settings.darkMode</span> = <span class="hljs-literal">true</span><span class="hljs-comment">; // 绕过校验/事件通知</span>
</code></pre>
<p>更好的方式：</p>
<pre><code class="hljs language-perl" lang="perl">user.setTheme(<span class="hljs-string">'dark'</span>); <span class="hljs-regexp">//</span> 内部可触发 re-render / save / <span class="hljs-keyword">log</span>
</code></pre>
</blockquote>
<h3 data-id="heading-4">3. <strong>这个属性是否属于“内部实现细节”？</strong></h3>
<ul>
<li>如果未来可能<strong>重构、重命名或删除</strong>它 → <strong>必须私有</strong></li>
<li>如果它是<strong>稳定契约的一部分</strong>（如 API 返回结构）→ 可 public</li>
</ul>
<blockquote>
<p>💡 例子：</p>
<ul>
<li>缓存字段（<code>private cache: Map&lt;...&gt;</code>）→ 私有</li>
<li>用户 ID（<code>public id: string</code>）→ 公共（业务标识）</li>
</ul>
</blockquote>
<h3 data-id="heading-5">4. <strong>是否需要保持对象的“不变性”（Invariants）？</strong></h3>
<p>如果属性参与维持对象的<strong>内部一致性</strong>，则必须私有，并通过方法控制变更。</p>
<blockquote>
<p>📌 示例：矩形的宽高不能为负数</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Rectangle</span> {
  <span class="hljs-keyword">private</span> <span class="hljs-attr">_width</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-keyword">private</span> <span class="hljs-attr">_height</span>: <span class="hljs-built_in">number</span>;

  <span class="hljs-title function_">setWidth</span>(<span class="hljs-params">w: <span class="hljs-built_in">number</span></span>) {
    <span class="hljs-keyword">if</span> (w &lt; <span class="hljs-number">0</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'Width must be positive'</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_width</span> = w;
  }
}
</code></pre>
</blockquote>
<hr/>
<h2 data-id="heading-6">二、优先使用 <strong>方法（Method）而非公共属性</strong></h2>
<p>即使需要“读取”或“设置”，也<strong>优先提供方法</strong>而非直接暴露属性：</p>





















<table><thead><tr><th>场景</th><th>推荐做法</th></tr></thead><tbody><tr><td>读取计算值</td><td><code>getFullName()</code> 而非 <code>fullName</code>（除非是简单数据）</td></tr><tr><td>设置需校验</td><td><code>setEmail(email)</code> 而非 <code>email = ...</code></td></tr><tr><td>触发副作用</td><td><code>activate()</code> 而非 <code>isActive = true</code></td></tr></tbody></table>
<blockquote>
<p>✅ 好处：</p>
<ul>
<li>未来可加日志、权限、缓存、事件通知等逻辑</li>
<li>避免“属性被意外覆盖”导致状态不一致</li>
</ul>
</blockquote>
<hr/>
<h2 data-id="heading-7">三、特殊情况处理</h2>
<h3 data-id="heading-8">✅ 可以公开的属性类型</h3>

























<table><thead><tr><th>类型</th><th>说明</th><th>示例</th></tr></thead><tbody><tr><td><strong>不可变数据</strong></td><td>初始化后永不改变</td><td><code>public readonly id: string</code></td></tr><tr><td><strong>纯数据载体（DTO/POJO）</strong></td><td>仅用于传输，无行为</td><td><code>interface UserDTO { name: string; email: string }</code></td></tr><tr><td><strong>配置对象</strong></td><td>明确设计为可读写的配置</td><td><code>public config: RenderConfig</code>（但建议用 getter/setter 封装）</td></tr></tbody></table>
<h3 data-id="heading-9">❌ 应避免公开的属性</h3>
<ul>
<li>内部状态（如 <code>isLoading</code>, <code>retryCount</code>）</li>
<li>依赖其他属性的派生值（如 <code>fullName = firstName + lastName</code> → 应用 getter）</li>
<li>敏感数据（密码、token、余额）</li>
<li>复杂对象引用（如 <code>private domElement: HTMLElement</code>）</li>
</ul>
<hr/>
<h2 data-id="heading-10">四、TypeScript / JavaScript 中的具体实践</h2>
<h3 data-id="heading-11">方案 1：使用 <strong><code>#</code> 私有字段（推荐，ES2022+）</strong></h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Timer</span> {
  #startTime: number;
  #isRunning = <span class="hljs-literal">false</span>;

  start() {
    <span class="hljs-keyword">this</span>.#startTime = Date.now();
    <span class="hljs-keyword">this</span>.#isRunning = <span class="hljs-literal">true</span>;
  }

  <span class="hljs-keyword">get</span> elapsed() {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.#isRunning ? Date.now() - <span class="hljs-keyword">this</span>.#startTime : <span class="hljs-number">0</span>;
  }
}
</code></pre>
<blockquote>
<p>✅ 真正私有，运行时安全</p>
</blockquote>
<h3 data-id="heading-12">方案 2：TypeScript <code>private</code>（仅开发时保护）</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Logger</span> {
  <span class="hljs-keyword">private</span> <span class="hljs-attr">logs</span>: <span class="hljs-built_in">string</span>[] = [];
  <span class="hljs-title function_">log</span>(<span class="hljs-params">msg: <span class="hljs-built_in">string</span></span>) { <span class="hljs-variable language_">this</span>.<span class="hljs-property">logs</span>.<span class="hljs-title function_">push</span>(msg); }
}
</code></pre>
<blockquote>
<p>⚠️ 注意：编译后仍可被外部访问，仅防“手误”</p>
</blockquote>
<h3 data-id="heading-13">方案 3：<code>readonly</code> + 公共（用于不可变数据）</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Point</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">readonly</span> x: <span class="hljs-built_in">number</span>,
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">readonly</span> y: <span class="hljs-built_in">number</span>
  </span>) {}
}
</code></pre>
<blockquote>
<p>✅ 安全暴露，且不可修改</p>
</blockquote>
<hr/>
<h2 data-id="heading-14">五、团队协作建议</h2>
<ol>
<li><strong>约定优于配置</strong>：团队统一规则，如“所有状态属性默认私有”</li>
<li><strong>代码审查重点</strong>：检查是否有不必要的 <code>public</code> 属性</li>
<li><strong>文档说明</strong>：对 public 属性明确其用途和约束</li>
</ol>
<hr/>
<h2 data-id="heading-15">✅ 快速决策流程图</h2>
<pre><code class="hljs language-csharp" lang="csharp">这个属性需要被外部访问吗？
│
├─ 否 → <span class="hljs-keyword">private</span> / <span class="hljs-meta">#</span>
│
└─ 是 → 
     ├─ 是否需要修改？ 
     │   ├─ 是 → 提供 setter 方法（而非直接 <span class="hljs-keyword">public</span>）
     │   └─ 否 → 
     │        ├─ 是否不可变？ → <span class="hljs-keyword">public</span> <span class="hljs-keyword">readonly</span>
     │        └─ 是否计算值？ → 提供 getter 方法
     │
     └─ 是否属于稳定数据契约？ → 可 <span class="hljs-keyword">public</span>（如 DTO）
</code></pre>
<hr/>
<h2 data-id="heading-16">🎯 总结：黄金法则</h2>
<blockquote>
<p><strong>“属性代表状态，状态应受控。<br/>
暴露行为（方法），而非状态（属性）。”</strong></p>
</blockquote>
<ul>
<li>默认 <strong>私有</strong>（<code>private</code> 或 <code>#</code>）</li>
<li>仅在<strong>必要且安全</strong>时暴露为公共</li>
<li>优先通过 <strong>方法</strong> 控制访问，而非直接暴露字段</li>
<li>对于<strong>纯数据对象</strong>（如 API 响应），可适当放宽</li>
</ul>
<p>这样做，你的类将更健壮、更易测试、更易演进。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[性能优化：从“用户想走”到“愿意留下”的1.8秒]]></title>    <link>https://juejin.cn/post/7577737385954705418</link>    <guid>https://juejin.cn/post/7577737385954705418</guid>    <pubDate>2025-11-30T05:37:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577737385954705418" data-draft-id="7576935292427681834" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="性能优化：从“用户想走”到“愿意留下”的1.8秒"/> <meta itemprop="keywords" content="前端,面试"/> <meta itemprop="datePublished" content="2025-11-30T05:37:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小时前端"/> <meta itemprop="url" content="https://juejin.cn/user/1197805741808339"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            性能优化：从“用户想走”到“愿意留下”的1.8秒
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1197805741808339/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小时前端
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T05:37:44.000Z" title="Sun Nov 30 2025 05:37:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{position:relative;word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:30px;margin-bottom:5px}.markdown-body h2{font-size:24px;display:inline-block;font-weight:700;background:#ef7060;color:#fff;padding:6px 8px 0 0;border-top-right-radius:6px;margin-right:2px;box-shadow:6px 3px 0 0 rgba(239,112,96,.2)}.markdown-body h2:before{content:" ";display:inline-block;width:8px}.markdown-body h2:after{content:" ";position:absolute;display:block;width:calc(100% - 50px);border-bottom:3px solid #ef7060}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #3e3e3e;margin-top:32px;margin-bottom:32px;height:1px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(27,31,35,.05);color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:JetBranins Mono,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px;background-color:#fdfdfd}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#fdfdfd}.markdown-body a{text-decoration:none;font-weight:700;color:#ef7060;border-bottom:1px solid #ef7060}.markdown-body a:active,.markdown-body a:hover{color:#ef2d26}.markdown-body table tr td,.markdown-body table tr th{border:1px solid #ccc;padding:5px 10px}.markdown-body table{display:block!important;width:auto;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{background:#f0f0f0;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#f8f8f8}.markdown-body blockquote{margin-inline-start:0;margin-inline-end:0;border-left:3px solid #ef7060;background:#fff9f9;padding:1px 20px;margin-top:20px}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-light">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#383a42;background:#fafafa}.hljs-comment,.hljs-quote{color:#a0a1a7;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#a626a4}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e45649}.hljs-literal{color:#0184bb}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#50a14f}.hljs-built_in,.hljs-class .hljs-title{color:#c18401}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#986801}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#4078f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><h2 data-id="heading-0">前言</h2>
<p>"今天，我们来聊聊性能优化。在我们团队看来，性能优化不是简单的'减少加载时间'的技术活，而是<strong>数字世界的'流体力学'工程</strong>。我们试图在有限的带宽的约束下，让用户体验如流水般顺滑自然。"</p>
<p>"因此，当我考察一个候选人对性能优化的理解时，我核心关注的不是他知道多少种优化技巧，而是他是否具备一种 <strong>'性能优化'</strong> 的视角。他是否明白，优化某个指标，不仅是应用某个最佳实践，更是要理解整个<strong>渲染流水线、网络协议栈和运行时环境</strong>。"</p>
<p>"这意味着，你需要去理解每个性能指标背后的运行机制——浏览器是如何构建渲染树的？JavaScript引擎是如何执行代码的？网络请求是如何被调度和处理的？如果对细节不太了解，可以阅读这篇文章<a href="https://juejin.cn/post/7573193563044528182" target="_blank" title="https://juejin.cn/post/7573193563044528182">前端面试经典题：从URL到页面展示，这一次让你彻底搞懂</a>"</p>
<p>"所以，今天的问题不仅仅是关于'如何减少LCP'这些具体技巧，我更想听到的是，你如何<strong>系统性</strong>地思考、诊断和解决性能问题。让我们就从这里开始聊起吧。"</p>
<p>当我问起这个问题时，我不仅仅是想听几个优化技巧。我想考察的是：</p>
<ol>
<li><strong>深度</strong>：你对性能优化的理解是否停留在"用个懒加载"的表面？</li>
<li><strong>广度</strong>：你是否了解从网络到渲染的全链路性能影响因素？</li>
<li><strong>实践</strong>：你是否有过真实的性能优化经验，或者至少深入分析过性能瓶颈？</li>
<li><strong>数据驱动</strong>：你是那个凭感觉优化的人，还是能基于数据做出精准决策的人？</li>
</ol>
<h2 data-id="heading-1">一、核心理念：性能 ≠ 快</h2>
<p>首先要明确，性能优化的核心是在<strong>技术理想</strong>与<strong>用户感知</strong>之间寻找最佳平衡点。</p>
<ul>
<li><strong>技术指标</strong>站在天平的最右端：精确的毫秒数，但可能偏离用户感受</li>
<li><strong>用户感知</strong>站在最左端：主观的"快慢"，但难以量化衡量</li>
<li><strong>现代性能优化</strong>分布在中间的广阔光谱上，每个点代表不同的权衡</li>
</ul>
<p>所以，性能优化的本质是<strong>技术指标与用户体验的匹配游戏</strong>。</p>
<h2 data-id="heading-2">二、性能优化的演进：从"减少字节"到"提升感知"</h2>
<p><strong>性能优化的三次进化</strong></p>
<ul>
<li>
<p><strong>第一代：资源优化时代</strong></p>
<ul>
<li><strong>核心思路</strong>："让文件更小，让请求更少"</li>
<li><strong>关键技术</strong>：Gzip压缩、图片优化、CSS Sprites、减少HTTP请求</li>
<li><strong>突破性</strong>：首次系统性地从资源层面解决性能问题</li>
<li><strong>局限性</strong>：过度聚焦于技术指标，忽略用户感知</li>
</ul>
</li>
<li>
<p><strong>第二代：渲染优化时代</strong></p>
<ul>
<li><strong>核心思路</strong>："让关键内容先出来"</li>
<li><strong>关键技术</strong>：关键CSS内联、异步加载、懒加载、服务端渲染</li>
<li><strong>突破性</strong>：开始关注用户看到内容的时机，而非单纯的技术指标</li>
<li><strong>局限性</strong>：缺乏统一的衡量标准，优化方向分散</li>
</ul>
</li>
<li>
<p><strong>第三代：用户体验量化时代</strong></p>
<ul>
<li><strong>核心思路</strong>："用科学指标衡量用户体验"</li>
<li><strong>关键技术</strong>：Core Web Vitals、Performance API、真实用户监控</li>
<li><strong>突破性</strong>：建立了标准化的用户体验衡量体系</li>
<li><strong>局限性</strong>：指标之间存在权衡，需要业务层面的决策</li>
</ul>
</li>
</ul>
<p><strong>如何回答（展现你的历史观）</strong>
"性能优化的演进本质上是不断重新定义'性能'含义的过程。从早期的关注服务器响应时间，到中期的关注首屏渲染，再到现在的关注用户核心任务完成度，每一次演进都在解决前一代的核心局限。"</p>
<h2 data-id="heading-3">三、现代性能优化深度对比：不只是技术技巧</h2>
<p><strong>核心维度对比</strong></p>
<ul>
<li>
<p><strong>加载性能：用户的第一印象</strong></p>
<ul>
<li><strong>LCP</strong>：衡量主要内容加载，直接影响用户对速度的感知</li>
<li><strong>优化策略</strong>：图片优化、字体优化、服务端渲染、资源预加载</li>
<li><strong>权衡考量</strong>：预加载可能浪费带宽，需要基于用户行为数据决策</li>
</ul>
</li>
<li>
<p><strong>交互响应：使用的流畅度</strong></p>
<ul>
<li><strong>FID/INP</strong>：衡量输入响应，决定用户操作的顺滑程度</li>
<li><strong>优化策略</strong>：代码分割、长任务拆分、Web Worker、优化JavaScript执行</li>
<li><strong>权衡考量</strong>：过度拆分可能增加复杂度，需要平衡可维护性</li>
</ul>
</li>
<li>
<p><strong>视觉稳定性：体验的可靠性</strong></p>
<ul>
<li><strong>CLS</strong>：衡量布局偏移，影响用户的阅读和操作精度</li>
<li><strong>优化策略</strong>：设置尺寸属性、预留空间、避免动态插入内容</li>
<li><strong>权衡考量</strong>：预留空间可能造成空白，需要设计系统配合</li>
</ul>
</li>
</ul>
<p><strong>如何回答（展现你的技术判断力）</strong>
"当我们对比现代性能优化指标时，实际上是在对比不同的用户体验维度。LCP关注的是'什么时候能用'，FID关注的是'用起来卡不卡'，CLS关注的是'用起来准不准'。好的性能优化不是单独优化某个指标，而是找到这些指标在具体业务场景下的最佳平衡点。"</p>
<h2 data-id="heading-4">四、<strong>实战：一个LCP从4.2s到1.8s的优化案例</strong></h2>
<p>"理论总是灰色的，而性能优化的实践之树常青。下面我想分享一个真实的产品详情页优化案例，看看我们如何将一个 <strong>4.2秒的LCP</strong> 优化到 <strong>1.8秒</strong>。"</p>
<h4 data-id="heading-5">问题诊断：拨开迷雾，定位七重瓶颈</h4>
<p>我们发现了完整的"性能问题瀑布链"：</p>
<ol>
<li><strong>LCP元素</strong>：首屏的<strong>主商品图</strong></li>
<li><strong>资源加载</strong>：一张450KB的JPEG图片</li>
<li><strong>渲染阻塞</strong>：800KB的Web字体文件</li>
<li><strong>JavaScript竞争</strong>：分析脚本抢占带宽</li>
<li><strong>服务端延迟</strong>：TTFB达到600ms</li>
<li><strong>缓存失效</strong>：CDN配置不当</li>
<li><strong>布局偏移</strong>：CLS高达0.25</li>
</ol>
<p>"诊断性能问题就像破案，你不能只看到表面的'凶器'（那张大图），而是要还原整个'犯罪现场'（从用户点击到屏幕渲染的完整链条）。"</p>
<h4 data-id="heading-6">优化措施：一套组合拳，拳拳到肉</h4>
<p><strong>第一阶段：资源层面的"瘦身"与"调度"</strong></p>
<p><em>技术说明：这个阶段的核心目标是让关键资源变得更小，并让浏览器优先处理它们</em></p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- 图片格式优化：为不同浏览器提供最合适的图片格式 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">picture</span>&gt;</span>
  <span class="hljs-comment">&lt;!-- 现代浏览器优先使用更小的WebP格式 --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">source</span> <span class="hljs-attr">srcset</span>=<span class="hljs-string">"hero-image.webp"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"image/webp"</span>&gt;</span>
  <span class="hljs-comment">&lt;!-- 老版本浏览器使用优化后的JPEG作为备选 --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">source</span> <span class="hljs-attr">srcset</span>=<span class="hljs-string">"hero-image.jpg"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"image/jpeg"</span>&gt;</span>
  <span class="hljs-comment">&lt;!-- 最终回退方案 --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"hero-image.jpg"</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">"产品主图"</span> <span class="hljs-attr">width</span>=<span class="hljs-string">"800"</span> <span class="hljs-attr">height</span>=<span class="hljs-string">"600"</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">picture</span>&gt;</span>

<span class="hljs-comment">&lt;!-- 关键图片预加载：告诉浏览器这个图片最重要，请立即下载 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"preload"</span> <span class="hljs-attr">as</span>=<span class="hljs-string">"image"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"hero-image.webp"</span> <span class="hljs-attr">imagesrcset</span>=<span class="hljs-string">"hero-image.webp 800w, hero-image-mobile.webp 400w"</span>&gt;</span>
</code></pre>
<blockquote>
<p>"这里有个关键洞察：我们发现主图虽然通过<code>&lt;picture&gt;</code>元素做了格式优化，但浏览器仍然需要经过图片发现、请求队列、DNS查找、TCP连接等一系列步骤才能开始下载。通过<code>preload</code>，我们告诉浏览器：'这个资源极其重要，请跳过常规队列，立即开始下载'。"</p>
</blockquote>
<p><strong>Preload的实战细节：</strong></p>
<ul>
<li><strong>时机把握</strong>：将preload链接放在HTML的<code>&lt;head&gt;</code>中，确保浏览器在解析完基本结构后立即处理</li>
<li><strong>格式适配</strong>：预加载WebP格式，因为它是我们为现代浏览器准备的最优解</li>
<li><strong>响应式考虑</strong>：通过<code>imagesrcset</code>告知浏览器不同视口宽度下应该加载的图片版本</li>
</ul>
<p><strong>第二阶段：渲染层面的"清障"与"加速"</strong></p>
<p><em>技术说明：这个阶段的目标是消除阻止页面渲染的障碍，让内容尽快显示</em></p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 字体加载优化：避免文字显示空白期 */</span>
<span class="hljs-keyword">@font-face</span> {
  <span class="hljs-attribute">font-family</span>: <span class="hljs-string">'ProductSans'</span>;
  <span class="hljs-attribute">src</span>: <span class="hljs-built_in">url</span>(<span class="hljs-string">'product-sans-subset.woff2'</span>) <span class="hljs-built_in">format</span>(<span class="hljs-string">'woff2'</span>);
  <span class="hljs-attribute">font-display</span>: swap; <span class="hljs-comment">/* 关键：先显示系统字体，Web字体加载后再替换 */</span>
}
</code></pre>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- 非关键脚本延迟加载：让分析工具等不阻塞页面渲染 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">async</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"analytics.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">defer</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"non-critical.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<blockquote>
<p>"字体优化是另一个战场。原本800KB的字体文件不仅下载慢，还会导致文本内容在字体加载完成前完全不可见（FOIT问题）。通过<code>font-display: swap</code>，我们让浏览器先用系统字体显示文字，等Web字体下载完成后再静默替换——用户能立即看到内容，而不是面对一片空白。"</p>
</blockquote>
<p><strong>第三阶段：服务端与基础设施的"深水区"优化</strong></p>
<p><em>技术说明：这个阶段处理网络层面和服务端响应速度的问题</em></p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- 提前建立CDN连接：减少DNS查询和TCP握手时间 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"preconnect"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"https://cdn.our-platform.com"</span>&gt;</span>
</code></pre>
<blockquote>
<p>"你可能想不到，浏览器在真正开始下载图片前，需要先完成'自我介绍'——DNS查询找到CDN服务器的IP地址，然后TCP三次握手建立连接。通过<code>preconnect</code>，我们在浏览器遇到实际图片URL前就提前完成这些步骤，为后续请求节省了宝贵的几百毫秒。"</p>
</blockquote>
<h4 data-id="heading-7">效果评估：数据是最好的证明</h4>
<p>经过上述优化，我们在下一个发布周期后观察到了显著变化：</p>








































<table><thead><tr><th>指标</th><th>优化前</th><th>优化后</th><th>提升幅度</th><th>用户感知</th></tr></thead><tbody><tr><td><strong>LCP</strong></td><td>4.2s</td><td><strong>1.8s</strong></td><td><strong>57%</strong></td><td>从"等待"到"顺畅"</td></tr><tr><td><strong>TTFB</strong></td><td>600ms</td><td>80ms</td><td>87%</td><td>服务器响应更快</td></tr><tr><td><strong>首屏图片体积</strong></td><td>450KB</td><td>120KB</td><td>73%</td><td>流量节省，加载更快</td></tr><tr><td><strong>跳出率</strong></td><td>45%</td><td>32%</td><td><strong>13个百分点</strong></td><td>更多用户留下</td></tr></tbody></table>
<blockquote>
<p>"最让我们兴奋的不是漂亮的性能图表，而是业务数据的正面反馈：<strong>详情页到购物车的转化率提升了 7%</strong>。这实实在在地证明了，性能优化不是技术团队的自我感动，而是真金白银的商业回报。"</p>
</blockquote>
<h4 data-id="heading-8">经验总结：从一次优化到一种能力</h4>
<p>这个案例给我们的启示远不止于技术点：</p>
<ol>
<li><strong>性能优化是系统工程</strong>：它涉及前端、后端、运维多个环节，需要打破团队壁垒协同作战。</li>
<li><strong>度量是优化的起点和终点</strong>：没有精确的测量，优化就是盲人摸象。我们建立了持续的性能监控仪表盘。</li>
<li><strong>优化需要勇气做减法</strong>：敢于对"历来如此"的设计（如全尺寸大图）和"别人都这么用"的技术（如完整Web字体）提出挑战。</li>
<li><strong>用户体验是最终裁判</strong>：优化的目标不是跑分，而是让用户觉得"快"。即使LCP还有提升空间，但1.8秒的加载速度已经让用户感知从"等待"变成了"顺畅"。</li>
</ol>
<p>"这个案例之后，我们形成了一种肌肉记忆：每当启动一个新项目，<strong>LCP 会作为一项核心验收指标，与功能需求并列进入产品清单</strong>。这或许是一次优化带来的最大价值——将性能意识植入了团队的基因。"</p>
<h3 data-id="heading-9">五、超越技术优化：构建性能工程体系</h3>
<p>一个优秀的候选人，还能聊到性能优化的工程化挑战：</p>
<ol>
<li>
<p><strong>度量和监控体系</strong></p>
<ul>
<li><strong>真实用户监控</strong>：收集真实场景下的性能数据</li>
<li><strong>关键业务路径追踪</strong>：从用户进入到最后转化的全链路分析</li>
</ul>
</li>
<li>
<p><strong>性能文化建设</strong></p>
<ul>
<li><strong>性能预算</strong>：为每个关键指标设置明确的数值目标</li>
<li><strong>代码审核集成</strong>：在代码合并前检查性能影响</li>
</ul>
</li>
<li>
<p><strong>渐进式优化策略</strong></p>
<ul>
<li><strong>基准建立</strong>：首先建立当前的性能基线</li>
<li><strong>快速胜利</strong>：优先实施高影响低成本的优化</li>
<li><strong>长期投资</strong>：规划需要架构层面改变的深度优化</li>
</ul>
</li>
</ol>
<h2 data-id="heading-10">面试官总结：我心目中的理想回答</h2>
<p>一个让我眼前一亮的回答，应该是这样的：</p>
<p>"说实话，性能优化这事儿我踩过不少坑。比如上次我们有个页面LCP一直上不去，我开始也以为是图片太大的问题，后来用Performance面板一分析，发现是字体文件阻塞了渲染。"</p>
<p>"我的思路其实挺简单的——<strong>先测量，再动手</strong>。我不会一上来就说要用什么preload或者WebP，而是先搞清楚瓶颈到底在哪。是网络慢？还是渲染被阻塞？或者是JS执行太耗时？"</p>
<p>"具体到LCP优化，我的经验是分三步走：</p>
<ol>
<li><strong>找到元凶</strong>——用Lighthouse和DevTools确定到底是哪个元素拖慢了LCP</li>
<li><strong>资源优先级</strong>——如果是图片，就用preload提前加载；如果是字体，就用font-display:swap避免阻塞</li>
<li><strong>持续监控</strong>——优化完了不是结束，要盯着真实用户的数据看效果"</li>
</ol>
<p>"而且我现在会特别关注<strong>业务价值</strong>。比如上次我们把LCP从4秒优化到1.8秒后，特意去看了转化率数据，发现确实提升了7%。"</p>
<p>"最重要的是，我觉得性能优化不是一次性的活，而是个持续过程。我们现在会把Core Web Vitals写进需求文档里，就像写功能需求一样自然。"</p>
<p>这样的回答为什么让我印象深刻？因为：</p>
<ul>
<li>有<strong>真实经历</strong>，不是空谈理论</li>
<li>有<strong>具体方法</strong>，不是泛泛而谈</li>
<li>有<strong>业务思维</strong>，不只关注技术指标</li>
<li>有<strong>落地经验</strong>，知道怎么在团队里推动这些事情</li>
</ul>
<p>说白了，我想找的不是一个只会背面试题的人，而是一个真正<strong>解决过问题</strong>的工程师。</p>
<p><strong>思考题：</strong> 当Core Web Vitals要求LCP在2.5秒内时，你是否思考过这在不同网络环境、不同设备配置下的实际意义？当你通过代码分割减少初始包体积时，是否评估过这对后续页面加载的潜在影响？这些，才是性能优化思考的真正深度所在。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[element-plus源码解读2——vue3组件的ref访问与defineExpose暴露机制]]></title>    <link>https://juejin.cn/post/7577958825342025747</link>    <guid>https://juejin.cn/post/7577958825342025747</guid>    <pubDate>2025-11-30T05:54:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577958825342025747" data-draft-id="7577970969394921513" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="element-plus源码解读2——vue3组件的ref访问与defineExpose暴露机制"/> <meta itemprop="keywords" content="Vue.js,JavaScript"/> <meta itemprop="datePublished" content="2025-11-30T05:54:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Joie"/> <meta itemprop="url" content="https://juejin.cn/user/3265984436383947"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            element-plus源码解读2——vue3组件的ref访问与defineExpose暴露机制
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3265984436383947/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Joie
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T05:54:27.000Z" title="Sun Nov 30 2025 05:54:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">vue3组件的ref访问与defineExpose暴露机制</h2>
<p>vue官方文档：</p>
<p><strong>ref</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fcn.vuejs.org%2Fapi%2Freactivity-core.html%23ref" target="_blank" title="https://cn.vuejs.org/api/reactivity-core.html#ref" ref="nofollow noopener noreferrer">cn.vuejs.org/api/reactiv…</a></p>
<p><strong>defineExpose</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fcn.vuejs.org%2Fapi%2Fsfc-script-setup.html%23defineexpose" target="_blank" title="https://cn.vuejs.org/api/sfc-script-setup.html#defineexpose" ref="nofollow noopener noreferrer">cn.vuejs.org/api/sfc-scr…</a></p>
<p>以el-button举例：</p>
<h4 data-id="heading-1">1. 正确的访问方式</h4>
<p>看 Button 组件暴露的内容：</p>
<pre><code class="hljs language-83:94:packages/components/button/src/button.vue" lang="83:94:packages/components/button/src/button.vue">defineExpose({
  /** @description button html element */
  ref: _ref,
  /** @description button size */
  size: _size,
  /** @description button type */
  type: _type,
  /** @description button disabled */
  disabled: _disabled,
  /** @description whether adding space */
  shouldAddSpace,
})
</code></pre>
<h4 data-id="heading-2">2. 实际使用示例</h4>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;el-button ref="buttonRef" type="primary" size="large"&gt;
    按钮
  &lt;/el-button&gt;
&lt;/template&gt;

&lt;script setup&gt;
import { ref, onMounted } from 'vue'
import type { ButtonInstance } from 'element-plus'

const buttonRef = ref&lt;ButtonInstance&gt;()

onMounted(() =&gt; {
  // ✅ 正确：访问所有暴露的属性
  console.log('DOM 元素:', buttonRef.value?.ref)        // HTMLButtonElement
  console.log('按钮尺寸:', buttonRef.value?.size)       // ComputedRef&lt;'large'&gt;
  console.log('按钮类型:', buttonRef.value?.type)      // ComputedRef&lt;'primary'&gt;
  console.log('是否禁用:', buttonRef.value?.disabled)   // ComputedRef&lt;boolean&gt;
  console.log('是否加空格:', buttonRef.value?.shouldAddSpace) // ComputedRef&lt;boolean&gt;
  
  // ✅ 打印整个组件实例，可以看到所有暴露的属性
  console.log('组件实例:', buttonRef.value)
})
&lt;/script&gt;
</code></pre>
<h4 data-id="heading-3">3. 打印结果示例</h4>
<p>当你 <code>console.log(buttonRef.value)</code> 时，会看到类似：</p>
<pre><code class="hljs language-js" lang="js">{
  <span class="hljs-attr">ref</span>: <span class="hljs-title class_">HTMLButtonElement</span>,           <span class="hljs-comment">// DOM 元素</span>
  <span class="hljs-attr">size</span>: <span class="hljs-title class_">ComputedRef</span>&lt;<span class="hljs-string">'large'</span>&gt;,        <span class="hljs-comment">// 尺寸（注意是 ComputedRef）</span>
  <span class="hljs-attr">type</span>: <span class="hljs-title class_">ComputedRef</span>&lt;<span class="hljs-string">'primary'</span>&gt;,      <span class="hljs-comment">// 类型（注意是 ComputedRef）</span>
  <span class="hljs-attr">disabled</span>: <span class="hljs-title class_">ComputedRef</span>&lt;<span class="hljs-literal">false</span>&gt;,      <span class="hljs-comment">// 禁用状态（注意是 ComputedRef）</span>
  <span class="hljs-attr">shouldAddSpace</span>: <span class="hljs-title class_">ComputedRef</span>&lt;<span class="hljs-literal">false</span>&gt; <span class="hljs-comment">// 是否加空格（注意是 ComputedRef）</span>
}
</code></pre>
<h4 data-id="heading-4">4. 重要提示：ComputedRef 的访问</h4>
<p>注意 <code>size</code>、<code>type</code>、<code>disabled</code> 等是 <code>ComputedRef</code>，访问值需要用 <code>.value</code>：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// ❌ 错误：这样得到的是 ComputedRef 对象</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(buttonRef.<span class="hljs-property">value</span>?.<span class="hljs-property">size</span>)  <span class="hljs-comment">// ComputedRef { ... }</span>

<span class="hljs-comment">// ✅ 正确：需要 .value 才能拿到实际值</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(buttonRef.<span class="hljs-property">value</span>?.<span class="hljs-property">size</span>.<span class="hljs-property">value</span>)  <span class="hljs-comment">// 'large'</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(buttonRef.<span class="hljs-property">value</span>?.<span class="hljs-property">type</span>.<span class="hljs-property">value</span>)  <span class="hljs-comment">// 'primary'</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(buttonRef.<span class="hljs-property">value</span>?.<span class="hljs-property">disabled</span>.<span class="hljs-property">value</span>)  <span class="hljs-comment">// false</span>
</code></pre>
<p>说明 Vue 3 的生命周期和 ref 访问时机：</p>
<h4 data-id="heading-5">1. Vue 3 没有 <code>onCreated</code> 钩子</h4>
<p>在 Vue 3 的 Composition API 中：</p>
<ul>
<li>没有 <code>onCreated()</code> 钩子</li>
<li><code>setup()</code> 函数本身就相当于 Vue 2 的 <code>created</code> + <code>beforeCreate</code></li>
<li>如果需要访问 DOM 或组件实例，应该用 <code>onMounted()</code></li>
</ul>
<h4 data-id="heading-6">2. 为什么必须在 <code>onMounted()</code> 中？</h4>
<h5 data-id="heading-7">在 <code>setup()</code> 顶层（组件未挂载）</h5>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup&gt;
import { ref } from 'vue'
import type { ButtonInstance } from 'element-plus'

const buttonRef = ref&lt;ButtonInstance&gt;()

// ❌ 错误：此时 buttonRef.value 是 undefined
// 因为组件还没有挂载，ref 还没有被赋值
console.log(buttonRef.value)  // undefined
&lt;/script&gt;
</code></pre>
<h5 data-id="heading-8">在 <code>onMounted()</code> 中（组件已挂载）</h5>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup&gt;
import { ref, onMounted } from 'vue'
import type { ButtonInstance } from 'element-plus'

const buttonRef = ref&lt;ButtonInstance&gt;()

onMounted(() =&gt; {
  // ✅ 正确：此时组件已经挂载，ref 已经被赋值
  console.log(buttonRef.value)  // ButtonInstance 对象
  console.log(buttonRef.value?.ref)  // HTMLButtonElement
})
&lt;/script&gt;
</code></pre>
<h4 data-id="heading-9">3. Vue 3 生命周期对比</h4>


















































<table><thead><tr><th>Vue 2 Options API</th><th>Vue 3 Composition API</th><th>说明</th></tr></thead><tbody><tr><td><code>beforeCreate</code></td><td><code>setup()</code> 开始执行</td><td>组件创建前</td></tr><tr><td><code>created</code></td><td><code>setup()</code> 执行中</td><td>组件创建后（但未挂载）</td></tr><tr><td><code>beforeMount</code></td><td><code>onBeforeMount()</code></td><td>挂载前</td></tr><tr><td><code>mounted</code></td><td><code>onMounted()</code></td><td>挂载后（DOM 已存在）</td></tr><tr><td><code>beforeUpdate</code></td><td><code>onBeforeUpdate()</code></td><td>更新前</td></tr><tr><td><code>updated</code></td><td><code>onUpdated()</code></td><td>更新后</td></tr><tr><td><code>beforeUnmount</code></td><td><code>onBeforeUnmount()</code></td><td>卸载前</td></tr><tr><td><code>unmounted</code></td><td><code>onUnmounted()</code></td><td>卸载后</td></tr></tbody></table>
<h4 data-id="heading-10">4. 完整示例对比</h4>
<h5 data-id="heading-11">错误示例（在 setup 顶层）</h5>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;el-button ref="buttonRef"&gt;按钮&lt;/el-button&gt;
&lt;/template&gt;

&lt;script setup&gt;
import { ref } from 'vue'
import type { ButtonInstance } from 'element-plus'

const buttonRef = ref&lt;ButtonInstance&gt;()

// ❌ 错误：此时 buttonRef.value 是 undefined
console.log('setup 顶层:', buttonRef.value)  // undefined
&lt;/script&gt;
</code></pre>
<h5 data-id="heading-12">正确示例（在 onMounted 中）</h5>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;el-button ref="buttonRef"&gt;按钮&lt;/el-button&gt;
&lt;/template&gt;

&lt;script setup&gt;
import { ref, onMounted, onBeforeMount } from 'vue'
import type { ButtonInstance } from 'element-plus'

const buttonRef = ref&lt;ButtonInstance&gt;()

// 在 setup 顶层
console.log('setup 顶层:', buttonRef.value)  // undefined

// 在 beforeMount 中
onBeforeMount(() =&gt; {
  console.log('beforeMount:', buttonRef.value)  // 可能还是 undefined
})

// 在 mounted 中
onMounted(() =&gt; {
  // ✅ 正确：此时组件已挂载，ref 已赋值
  console.log('mounted:', buttonRef.value)  // ButtonInstance 对象
  console.log('DOM 元素:', buttonRef.value?.ref)  // HTMLButtonElement
})
&lt;/script&gt;
</code></pre>
<h4 data-id="heading-13">5. 为什么 ref 在 onMounted 中才有值？</h4>
<p>Vue 的 ref 赋值时机：</p>
<ol>
<li>模板编译阶段：Vue 识别 <code>ref="buttonRef"</code></li>
<li>组件挂载阶段：创建组件实例，将实例赋值给 <code>buttonRef.value</code></li>
<li>DOM 渲染完成：<code>onMounted()</code> 执行时，ref 已经有值</li>
</ol>
<h4 data-id="heading-14">6. 如果需要在 setup 中访问怎么办？</h4>
<p>可以使用 <code>watchEffect</code> 或 <code>watch</code>：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup&gt;
import { ref, watchEffect } from 'vue'
import type { ButtonInstance } from 'element-plus'

const buttonRef = ref&lt;ButtonInstance&gt;()

// 使用 watchEffect，会在 ref 有值后自动执行
watchEffect(() =&gt; {
  if (buttonRef.value) {
    console.log('ref 有值了:', buttonRef.value)
  }
})
&lt;/script&gt;
</code></pre>
<h4 data-id="heading-15">7. 总结</h4>
<ul>
<li>Vue 3 没有 <code>onCreated()</code>，<code>setup()</code> 本身就相当于 <code>created</code></li>
<li>访问 <code>ref.value</code> 必须在 <code>onMounted()</code> 中，因为此时组件已挂载</li>
<li>在 <code>setup()</code> 顶层访问 <code>ref.value</code> 会是 <code>undefined</code></li>
<li>如果需要响应式监听 ref 的变化，可以用 <code>watchEffect</code> 或 <code>watch</code></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React 中没有 v-model，如何优雅地处理表单输入]]></title>    <link>https://juejin.cn/post/7577970969395003433</link>    <guid>https://juejin.cn/post/7577970969395003433</guid>    <pubDate>2025-11-30T06:11:28.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577970969395003433" data-draft-id="7577797563853783076" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React 中没有 v-model，如何优雅地处理表单输入"/> <meta itemprop="keywords" content="前端,Vue.js,React.js"/> <meta itemprop="datePublished" content="2025-11-30T06:11:28.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="凯心"/> <meta itemprop="url" content="https://juejin.cn/user/75186527548462"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React 中没有 v-model，如何优雅地处理表单输入
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/75186527548462/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    凯心
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T06:11:28.000Z" title="Sun Nov 30 2025 06:11:28 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">React 中没有 v-model，如何优雅地处理表单输入</h2>
<p>在 Vue 中，我们可以很方便地使用 <code>v-model</code> 实现数据的双向绑定。但在 React 的世界里，并没有这样的语法糖，我们需要通过不同的方式来处理表单数据。</p>
<h3 data-id="heading-1">Vue 的简洁写法</h3>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;input v-model="value" /&gt;
&lt;/template&gt;
</code></pre>
<h3 data-id="heading-2">React 的几种实现方案</h3>
<h4 data-id="heading-3">方案一：基础受控组件</h4>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [value, setValue] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">""</span>);
  
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">input</span> 
      <span class="hljs-attr">value</span>=<span class="hljs-string">{value}</span> 
      <span class="hljs-attr">onChange</span>=<span class="hljs-string">{e</span> =&gt;</span> setValue(e.target.value)} 
    /&gt;</span>
  );
}
</code></pre>
<p>这是 React 初学者最常用的写法。在简单场景下表现良好，但在复杂表单或大型应用中，每次输入都会触发组件重新渲染，可能导致性能问题。</p>
<h4 data-id="heading-4">方案二：非受控组件 + useRef</h4>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> inputRef = <span class="hljs-title function_">useRef</span>(<span class="hljs-string">""</span>);
  
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">input</span> 
      <span class="hljs-attr">onChange</span>=<span class="hljs-string">{e</span> =&gt;</span> (inputRef.current = e.target.value)} 
    /&gt;</span>
  );
}
</code></pre>
<p>这种方案避免了频繁的重新渲染，适合性能敏感的场景。</p>
<h4 data-id="heading-5">方案三：防抖优化</h4>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [value, setValue] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">""</span>);
  
  <span class="hljs-keyword">const</span> handleChange = <span class="hljs-title function_">useCallback</span>(
    <span class="hljs-title function_">debounce</span>(<span class="hljs-function">(<span class="hljs-params">newValue</span>) =&gt;</span> {
      <span class="hljs-title function_">setValue</span>(newValue);
    }, <span class="hljs-number">300</span>),
    []
  );

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">input</span> 
      <span class="hljs-attr">onChange</span>=<span class="hljs-string">{e</span> =&gt;</span> handleChange(e.target.value)} 
    /&gt;</span>
  );
}
</code></pre>
<p>通过防抖函数减少状态更新的频率，在需要实时搜索等场景下特别有用。</p>
<hr/>
<h2 data-id="heading-6">深入理解：受控组件 vs 非受控组件</h2>
<h3 data-id="heading-7">概念解析</h3>
<p>受控组件和非受控组件是<code>数据驱动框架</code>中的重要概念：</p>
<ul>
<li><strong>表面区别</strong>：值是否只能由用户输入改变，还是也可以由程序逻辑<code>直接</code>改变</li>
<li><strong>本质区别</strong>：数据是由 React 状态托管，还是由 DOM 自身管理</li>
</ul>
<h3 data-id="heading-8">受控组件（Controlled Components）</h3>
<p>表单元素的值完全由 React 状态控制，通过 <code>onChange</code> 事件同步更新。</p>
<p><strong>优点：</strong></p>
<ul>
<li>✅ 符合 React 单向数据流理念，状态完全可控</li>
<li>✅ 便于实现实时验证和输入格式化</li>
<li>✅ 可动态控制表单提交状态</li>
<li>✅ 支持多组件间的数据同步</li>
</ul>
<p><strong>缺点：</strong></p>
<ul>
<li>❌ 需要为每个字段编写事件处理逻辑</li>
<li>❌ 表单复杂时可能引发性能问题</li>
</ul>
<p><strong>适用场景：</strong></p>
<ul>
<li>需要实时验证用户输入</li>
<li>需要根据输入动态更新UI</li>
<li>需要强制特定的输入格式</li>
<li>表单数据被多个组件共享</li>
</ul>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">LoginForm</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [formData, setFormData] = <span class="hljs-title function_">useState</span>({
    <span class="hljs-attr">username</span>: <span class="hljs-string">""</span>,
    <span class="hljs-attr">password</span>: <span class="hljs-string">""</span>
  });

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleChange</span> = (<span class="hljs-params">field</span>) =&gt; <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
    <span class="hljs-title function_">setFormData</span>(<span class="hljs-function"><span class="hljs-params">prev</span> =&gt;</span> ({
      ...prev,
      [field]: e.<span class="hljs-property">target</span>.<span class="hljs-property">value</span>
    }));
  };

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">form</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">input</span> 
        <span class="hljs-attr">value</span>=<span class="hljs-string">{formData.username}</span> 
        <span class="hljs-attr">onChange</span>=<span class="hljs-string">{handleChange(</span>"<span class="hljs-attr">username</span>")} 
      /&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">input</span> 
        <span class="hljs-attr">type</span>=<span class="hljs-string">"password"</span>
        <span class="hljs-attr">value</span>=<span class="hljs-string">{formData.password}</span> 
        <span class="hljs-attr">onChange</span>=<span class="hljs-string">{handleChange(</span>"<span class="hljs-attr">password</span>")} 
      /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span></span>
  );
}
</code></pre>
<h3 data-id="heading-9">非受控组件（Uncontrolled Components）</h3>
<p>表单数据由 DOM 自身管理，通过 ref 在需要时获取值。</p>
<p><strong>优点：</strong></p>
<ul>
<li>✅ 代码简洁，减少事件处理逻辑</li>
<li>✅ 性能更优，避免频繁重新渲染</li>
<li>✅ 更接近原生 DOM 操作</li>
</ul>
<p><strong>缺点：</strong></p>
<ul>
<li>❌ 不符合 React 数据流最佳实践</li>
<li>❌ 无法实现实时验证和UI反馈</li>
<li>❌ 状态管理不够直观</li>
</ul>
<p><strong>适用场景：</strong></p>
<ul>
<li>简单表单，无需实时验证</li>
<li>只在提交时需要获取数据</li>
<li>性能敏感的大型表单</li>
<li>集成第三方表单库</li>
</ul>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">UncontrolledForm</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> usernameRef = <span class="hljs-title function_">useRef</span>();
  <span class="hljs-keyword">const</span> passwordRef = <span class="hljs-title function_">useRef</span>();

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleSubmit</span> = (<span class="hljs-params">e</span>) =&gt; {
    e.<span class="hljs-title function_">preventDefault</span>();
    <span class="hljs-keyword">const</span> data = {
      <span class="hljs-attr">username</span>: usernameRef.<span class="hljs-property">current</span>.<span class="hljs-property">value</span>,
      <span class="hljs-attr">password</span>: passwordRef.<span class="hljs-property">current</span>.<span class="hljs-property">value</span>
    };
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"表单数据:"</span>, data);
  };

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">onSubmit</span>=<span class="hljs-string">{handleSubmit}</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">{usernameRef}</span> /&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"password"</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">{passwordRef}</span> /&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"submit"</span>&gt;</span>提交<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span></span>
  );
}
</code></pre>
<h3 data-id="heading-10">实践建议</h3>
<ol>
<li>当需要做性能优化时，可以考虑使用非受控组件</li>
<li>非受控组件和受控组件可以混用</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>