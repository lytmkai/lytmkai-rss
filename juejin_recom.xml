<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[[Docker/K8S] Kubernetes故障克星：19个高频问题速查与秒解指南（2025版）]]></title>    <link>https://juejin.cn/post/7586498198149005363</link>    <guid>https://juejin.cn/post/7586498198149005363</guid>    <pubDate>2025-12-22T12:27:53.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586498198149005363" data-draft-id="7586482860103991323" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="[Docker/K8S] Kubernetes故障克星：19个高频问题速查与秒解指南（2025版）"/> <meta itemprop="keywords" content="JavaScript,面试"/> <meta itemprop="datePublished" content="2025-12-22T12:27:53.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="专业IT"/> <meta itemprop="url" content="https://juejin.cn/user/1118626084823481"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            [Docker/K8S] Kubernetes故障克星：19个高频问题速查与秒解指南（2025版）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1118626084823481/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    专业IT
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T12:27:53.000Z" title="Mon Dec 22 2025 12:27:53 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Kubernetes故障克星：19个高频问题速查与秒解指南（2025版）</h2>
<p>随着云原生技术的普及，Kubernetes已成为现代应用部署的事实标准。然而，其复杂性也带来了独特的故障排查挑战。本文将聚焦19个高频故障场景，提供快速定位和解决方案，助您成为Kubernetes故障排除专家。</p>
<h3 data-id="heading-1">一、集群基础问题排查</h3>
<h4 data-id="heading-2">1. 节点状态异常</h4>
<p>bash</p>
<p>复制下载</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-meta"># 检查节点状态</span>
kubectl <span class="hljs-keyword">get</span> nodes
kubectl describe node &lt;node-name&gt;

<span class="hljs-meta"># 常见故障：节点NotReady</span>
<span class="hljs-meta"># 解决方案：检查kubelet状态</span>
systemctl status kubelet
journalctl -u kubelet -n <span class="hljs-number">50</span> --no-pager

<span class="hljs-meta"># 重启kubelet（谨慎操作）</span>
sudo systemctl restart kubelet
</code></pre>
<h4 data-id="heading-3">2. 网络插件故障</h4>
<p>Calico/Flannel等CNI插件问题常导致Pod间通信失败：</p>
<p>bash</p>
<p>复制下载</p>
<pre><code class="hljs language-perl" lang="perl"><span class="hljs-comment"># 检查网络插件Pod状态</span>
kubectl get pods -n kube-<span class="hljs-keyword">system</span> | <span class="hljs-keyword">grep</span> -E <span class="hljs-string">'calico|flannel|cilium'</span>

<span class="hljs-comment"># 重启网络插件（如果允许）</span>
kubectl <span class="hljs-keyword">delete</span> pods -n kube-<span class="hljs-keyword">system</span> -l k8s-app=calico-node
</code></pre>
<h3 data-id="heading-4">二、Pod与容器层故障</h3>
<h4 data-id="heading-5">3. Pod一直处于Pending状态</h4>
<p>bash</p>
<p>复制下载</p>
<pre><code class="hljs language-perl" lang="perl"><span class="hljs-comment"># 查看具体原因</span>
kubectl describe pod &lt;pod-name&gt;

<span class="hljs-comment"># 常见原因及解决方案：</span>
<span class="hljs-comment"># 1. 资源不足：检查节点资源</span>
kubectl describe nodes | <span class="hljs-keyword">grep</span> -A <span class="hljs-number">5</span> -B <span class="hljs-number">5</span> <span class="hljs-string">"Allocatable"</span>

<span class="hljs-comment"># 2. 不满足节点选择器/污点容忍</span>
<span class="hljs-comment"># 调整节点选择器或添加容忍</span>
</code></pre>
<h4 data-id="heading-6">4. Pod崩溃循环（CrashLoopBackOff）</h4>
<p>bash</p>
<p>复制下载</p>
<pre><code class="hljs language-perl" lang="perl"><span class="hljs-comment"># 查看Pod日志</span>
kubectl logs &lt;pod-name&gt; --previous

<span class="hljs-comment"># 进入Pod调试（如果Pod能短暂运行）</span>
kubectl <span class="hljs-keyword">exec</span> -it &lt;pod-name&gt; -- <span class="hljs-regexp">/bin/s</span>h

<span class="hljs-comment"># 检查应用启动命令和参数</span>
kubectl describe pod &lt;pod-name&gt; | <span class="hljs-keyword">grep</span> -A <span class="hljs-number">10</span> <span class="hljs-string">"Command"</span>
</code></pre>
<h4 data-id="heading-7">5. 镜像拉取失败（ImagePullBackOff）</h4>
<p>yaml</p>
<p>复制下载</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># 检查镜像仓库认证</span>
<span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Secret</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">regcred</span>
<span class="hljs-attr">type:</span> <span class="hljs-string">kubernetes.io/dockerconfigjson</span>
<span class="hljs-attr">data:</span>
  <span class="hljs-string">.dockerconfigjson:</span> <span class="hljs-string">&lt;base64-encoded-docker-config&gt;</span>
</code></pre>
<h3 data-id="heading-8">三、服务与网络问题</h3>
<h4 data-id="heading-9">6. Service无法访问</h4>
<p>bash</p>
<p>复制下载</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-meta"># 检查Service端点</span>
kubectl <span class="hljs-keyword">get</span> endpoints &lt;service-name&gt;

<span class="hljs-meta"># 如果没有端点，检查Selector匹配</span>
kubectl <span class="hljs-keyword">get</span> pods --show-labels | grep &lt;selector-label&gt;

<span class="hljs-meta"># 临时端口转发调试</span>
kubectl port-forward svc/&lt;service-name&gt; <span class="hljs-number">8080</span>:<span class="hljs-number">80</span>
</code></pre>
<h4 data-id="heading-10">7. Ingress控制器问题</h4>
<p>bash</p>
<p>复制下载</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-meta"># 检查Ingress控制器状态</span>
kubectl <span class="hljs-keyword">get</span> pods -n ingress-nginx

<span class="hljs-meta"># 查看Ingress事件</span>
kubectl describe ingress &lt;ingress-name&gt;

<span class="hljs-meta"># 检查IngressClass配置</span>
kubectl <span class="hljs-keyword">get</span> ingressclass
</code></pre>
<h3 data-id="heading-11">四、存储与配置问题</h3>
<h4 data-id="heading-12">8. PVC一直处于Pending状态</h4>
<p>bash</p>
<p>复制下载</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># 检查StorageClass</span>
<span class="hljs-string">kubectl</span> <span class="hljs-string">get</span> <span class="hljs-string">storageclass</span>

<span class="hljs-comment"># 检查PV/PVC详情</span>
<span class="hljs-string">kubectl</span> <span class="hljs-string">describe</span> <span class="hljs-string">pvc</span> <span class="hljs-string">&lt;pvc-name&gt;</span>
<span class="hljs-string">kubectl</span> <span class="hljs-string">describe</span> <span class="hljs-string">pv</span> <span class="hljs-string">&lt;pv-name&gt;</span>

<span class="hljs-comment"># 动态供应失败时，可创建静态PV</span>
<span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">PersistentVolume</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">static-pv</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">capacity:</span>
    <span class="hljs-attr">storage:</span> <span class="hljs-string">10Gi</span>
  <span class="hljs-attr">accessModes:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">ReadWriteOnce</span>
  <span class="hljs-attr">hostPath:</span>
    <span class="hljs-attr">path:</span> <span class="hljs-string">"/mnt/data"</span>
</code></pre>
<h4 data-id="heading-13">9. ConfigMap/Secret更新未生效</h4>
<p>bash</p>
<p>复制下载</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看Pod挂载的配置</span>
kubectl <span class="hljs-built_in">exec</span> &lt;pod-name&gt; -- <span class="hljs-built_in">cat</span> /etc/config/app.properties

<span class="hljs-comment"># 强制重新部署（触发配置更新）</span>
kubectl rollout restart deployment/&lt;deployment-name&gt;
</code></pre>
<h3 data-id="heading-14">五、资源与调度优化</h3>
<h4 data-id="heading-15">10. 内存/CPU限制导致OOMKilled</h4>
<p>yaml</p>
<p>复制下载</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># 合理设置资源限制</span>
<span class="hljs-attr">resources:</span>
  <span class="hljs-attr">requests:</span>
    <span class="hljs-attr">memory:</span> <span class="hljs-string">"256Mi"</span>
    <span class="hljs-attr">cpu:</span> <span class="hljs-string">"250m"</span>
  <span class="hljs-attr">limits:</span>
    <span class="hljs-attr">memory:</span> <span class="hljs-string">"512Mi"</span>
    <span class="hljs-attr">cpu:</span> <span class="hljs-string">"500m"</span>

<span class="hljs-comment"># 监控资源使用</span>
<span class="hljs-string">kubectl</span> <span class="hljs-string">top</span> <span class="hljs-string">pods</span>
<span class="hljs-string">kubectl</span> <span class="hljs-string">describe</span> <span class="hljs-string">pod</span> <span class="hljs-string">&lt;pod-name&gt;</span> <span class="hljs-string">|</span> <span class="hljs-string">grep</span> <span class="hljs-string">-A</span> <span class="hljs-number">5</span> <span class="hljs-string">"Limits"</span>
</code></pre>
<h4 data-id="heading-16">11. 节点资源压力</h4>
<p>bash</p>
<p>复制下载</p>
<pre><code class="hljs language-perl" lang="perl"><span class="hljs-comment"># 检查节点资源分配</span>
kubectl describe nodes | <span class="hljs-keyword">grep</span> -A <span class="hljs-number">10</span> <span class="hljs-string">"Allocated resources"</span>

<span class="hljs-comment"># 驱逐低优先级Pod（如有配置）</span>
kubectl get pods --all-namespaces -o wide | <span class="hljs-keyword">grep</span> Evicted
</code></pre>
<h3 data-id="heading-17">六、高级调试技巧</h3>
<h4 data-id="heading-18">12. 使用临时调试容器</h4>
<p>bash</p>
<p>复制下载</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># Kubernetes 1.18+ 支持临时容器</span>
kubectl debug &lt;pod-name&gt; -it <span class="hljs-attr">--image</span>=busybox --target=&lt;container-name&gt;
</code></pre>
<h4 data-id="heading-19">13. 网络策略调试</h4>
<p>bash</p>
<p>复制下载</p>
<pre><code class="hljs language-css" lang="css"># 检查网络策略影响
kubectl get networkpolicy <span class="hljs-attr">--all-namespaces</span>

# 创建测试Pod验证连通性
kubectl run test-pod <span class="hljs-attr">--image</span>=busybox <span class="hljs-attr">--rm</span> -it <span class="hljs-attr">--restart</span>=Never -- ping &lt;target-pod-ip&gt;
</code></pre>
<h3 data-id="heading-20">七、自动修复与预防</h3>
<h4 data-id="heading-21">14. 配置健康检查</h4>
<p>yaml</p>
<p>复制下载</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># 添加就绪和存活探针</span>
<span class="hljs-attr">livenessProbe:</span>
  <span class="hljs-attr">httpGet:</span>
    <span class="hljs-attr">path:</span> <span class="hljs-string">/healthz</span>
    <span class="hljs-attr">port:</span> <span class="hljs-number">8080</span>
  <span class="hljs-attr">initialDelaySeconds:</span> <span class="hljs-number">30</span>
  <span class="hljs-attr">periodSeconds:</span> <span class="hljs-number">10</span>

<span class="hljs-attr">readinessProbe:</span>
  <span class="hljs-attr">tcpSocket:</span>
    <span class="hljs-attr">port:</span> <span class="hljs-number">8080</span>
  <span class="hljs-attr">initialDelaySeconds:</span> <span class="hljs-number">5</span>
  <span class="hljs-attr">periodSeconds:</span> <span class="hljs-number">10</span>
</code></pre>
<h4 data-id="heading-22">15. 使用PodDisruptionBudget保证可用性</h4>
<p>yaml</p>
<p>复制下载</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">policy/v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">PodDisruptionBudget</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">myapp-pdb</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">minAvailable:</span> <span class="hljs-number">2</span>
  <span class="hljs-attr">selector:</span>
    <span class="hljs-attr">matchLabels:</span>
      <span class="hljs-attr">app:</span> <span class="hljs-string">myapp</span>
</code></pre>
<h3 data-id="heading-23">八、监控与日志聚合</h3>
<h4 data-id="heading-24">16. 集中日志收集</h4>
<p>bash</p>
<p>复制下载</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 快速查看相关Pod日志</span>
kubectl logs -l <span class="hljs-attr">app</span>=myapp --tail=<span class="hljs-number">50</span>

<span class="hljs-comment"># 多容器Pod日志查看</span>
kubectl logs &lt;pod-name&gt; -c &lt;container-name&gt;
</code></pre>
<h4 data-id="heading-25">17. 性能指标监控</h4>
<p>bash</p>
<p>复制下载</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 安装Metrics Server</span>
kubectl apply -f https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/components.yaml

<span class="hljs-comment"># 查看资源使用情况</span>
kubectl top nodes
kubectl top pods -A
</code></pre>
<h3 data-id="heading-26">九、安全与权限问题</h3>
<h4 data-id="heading-27">18. RBAC权限不足</h4>
<p>bash</p>
<p>复制下载</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-meta"># 检查用户/服务账户权限</span>
kubectl auth can-i create pods --<span class="hljs-keyword">as</span> system:serviceaccount:<span class="hljs-literal">default</span>:my-sa

<span class="hljs-meta"># 查看详细的RBAC配置</span>
kubectl <span class="hljs-keyword">get</span> rolebindings,clusterrolebindings --all-namespaces
</code></pre>
<h4 data-id="heading-28">19. Pod安全策略违规</h4>
<p>bash</p>
<p>复制下载</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-meta"># 检查PodSecurityPolicy</span>
kubectl <span class="hljs-keyword">get</span> psp

<span class="hljs-meta"># 查看被拒绝的Pod事件</span>
kubectl <span class="hljs-keyword">get</span> events --field-selector=reason=FailedCreate
</code></pre>
<h3 data-id="heading-29">总结：构建系统化排障流程</h3>
<ol>
<li><strong>快速诊断</strong>：使用<code>kubectl get</code>和<code>describe</code>获取资源状态</li>
<li><strong>日志分析</strong>：深入容器日志查找错误线索</li>
<li><strong>网络验证</strong>：检查服务发现和网络策略</li>
<li><strong>资源配置</strong>：确认请求和限制设置合理</li>
<li><strong>权限检查</strong>：验证RBAC和PSP配置</li>
<li><strong>集群健康</strong>：监控组件状态和资源使用</li>
</ol>
<p>记住这些命令和技巧，结合自动化监控告警，您将能大幅缩短Kubernetes故障恢复时间。随着Kubernetes生态的演进，保持对新版本特性和最佳实践的了解同样重要。2025年的Kubernetes环境更加智能化，但坚实的故障排查基本功仍然是每个云原生工程师的核心竞争力。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[高并发下如何防止重复提交订单？]]></title>    <link>https://juejin.cn/post/7586588823905468425</link>    <guid>https://juejin.cn/post/7586588823905468425</guid>    <pubDate>2025-12-23T02:11:36.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586588823905468425" data-draft-id="7586573133348782126" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="高并发下如何防止重复提交订单？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-23T02:11:36.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="苏三说技术"/> <meta itemprop="url" content="https://juejin.cn/user/465848661970824"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            高并发下如何防止重复提交订单？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/465848661970824/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    苏三说技术
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T02:11:36.000Z" title="Tue Dec 23 2025 02:11:36 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>当你的用户疯狂点击提交按钮时，你的系统准备好迎接这场“连击风暴”了吗？</p>
<p>在电商系统的实战中，我见过太多因重复提交导致的资损事故——用户一次点击，系统却创建了多个订单，导致库存错乱、用户重复支付、客服投诉爆棚。</p>
<p>有些小伙伴在工作中可能遇到过这样的场景：大促期间，用户反馈“明明只点了一次，为什么扣了两次款？”</p>
<p>开发同学查了半天日志，发现同一个用户请求在毫秒级内真的到达了服务器两次。</p>
<p>今天这篇文章就跟大家聊聊高并发下防止重复提交订单，希望对你会有所帮助。</p>
<p><a href="https://link.juejin.cn/?target=http%3A%2F%2Fsusan.net.cn%2Fproject" title="https://link.juejin.cn/?target=http%3A%2F%2Fsusan.net.cn%2Fproject" target="_blank">更多项目实战在我的技术网站：www.susan.net.cn/project</a></p>
<h2 data-id="heading-1">01 为什么会重复提交？</h2>
<p>在深入解决方案前，我们必须搞清楚重复提交是如何发生的。</p>
<p>常见的场景有：</p>
<ol>
<li><strong>用户无意识重复点击</strong>：网络延迟时，用户心急多次点击提交按钮</li>
<li><strong>前端防抖失效</strong>：前端做了防抖处理，但被绕过或配置不当</li>
<li><strong>网络超时重试</strong>：请求超时后，客户端或网关自动重试</li>
<li><strong>恶意攻击</strong>：竞争对手或黑客故意重复提交</li>
<li><strong>后端处理超时</strong>：第一个请求处理慢，客户端以为失败又发一次</li>
</ol>
<p>来看一个典型的用户操作流程，以及其中可能发生重复的各个环节：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/51b6ad873d9e48358c9963bf3e114a07~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuP5LiJ6K-05oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767060695&amp;x-signature=EezGzi0fvGo9YpZfGutG%2Bde0qJQ%3D" alt="" loading="lazy"/></p>
<p>从图中可以看到，从用户点击到订单落库，几乎每个环节都可能成为重复提交的“案发现场”。</p>
<p>下面，我们就针对这些环节，层层布防。</p>
<h2 data-id="heading-2">02 第一道防线：前端防抖与按钮控制</h2>
<p>这是最直观、成本最低的防护措施。</p>
<p>原则是：<strong>在用户交互层面尽量减少无效请求</strong>。</p>
<h3 data-id="heading-3">2.1 按钮状态控制</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 前端防抖实现示例（Vue + Element UI）</span>
&lt;template&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">el-button</span> 
    <span class="hljs-attr">:loading</span>=<span class="hljs-string">"submitting"</span> 
    <span class="hljs-attr">:disabled</span>=<span class="hljs-string">"submitting"</span>
    @<span class="hljs-attr">click</span>=<span class="hljs-string">"handleSubmitOrder"</span>
  &gt;</span>
    {{ submitting ? '提交中...' : '提交订单' }}
  <span class="hljs-tag">&lt;/<span class="hljs-name">el-button</span>&gt;</span></span>
&lt;/template&gt;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">submitting</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">submitToken</span>: <span class="hljs-literal">null</span> <span class="hljs-comment">// 用于标识当前提交的token</span>
    }
  },
  <span class="hljs-attr">methods</span>: {
    <span class="hljs-keyword">async</span> <span class="hljs-title function_">handleSubmitOrder</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">submitting</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">$message</span>.<span class="hljs-title function_">warning</span>(<span class="hljs-string">'正在提交，请勿重复点击'</span>)
        <span class="hljs-keyword">return</span>
      }
      
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">submitting</span> = <span class="hljs-literal">true</span>
      
      <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// 生成唯一token，用于后端幂等性校验</span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">submitToken</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">generateSubmitToken</span>()
        
        <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">$api</span>.<span class="hljs-property">order</span>.<span class="hljs-title function_">submit</span>({
          <span class="hljs-attr">orderData</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">orderData</span>,
          <span class="hljs-attr">submitToken</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">submitToken</span>
        })
        
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">$message</span>.<span class="hljs-title function_">success</span>(<span class="hljs-string">'订单提交成功'</span>)
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">$router</span>.<span class="hljs-title function_">push</span>(<span class="hljs-string">`/order/detail/<span class="hljs-subst">${result.orderId}</span>`</span>)
      } <span class="hljs-keyword">catch</span> (error) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">$message</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`提交失败: <span class="hljs-subst">${error.message}</span>`</span>)
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">submitting</span> = <span class="hljs-literal">false</span> <span class="hljs-comment">// 失败后重置状态</span>
      }
    },
    
    <span class="hljs-title function_">generateSubmitToken</span>(<span class="hljs-params"/>) {
      <span class="hljs-comment">// 生成唯一标识，可以用UUID或时间戳+随机数</span>
      <span class="hljs-keyword">return</span> <span class="hljs-string">`order_submit_<span class="hljs-subst">${<span class="hljs-built_in">Date</span>.now()}</span>_<span class="hljs-subst">${<span class="hljs-built_in">Math</span>.random().toString(<span class="hljs-number">36</span>).substr(<span class="hljs-number">2</span>, <span class="hljs-number">9</span>)}</span>`</span>
    }
  }
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>
</code></pre>
<h3 data-id="heading-4">2.2 请求防抖与拦截</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 使用axios拦截器实现请求防抖</span>
<span class="hljs-keyword">import</span> axios <span class="hljs-keyword">from</span> <span class="hljs-string">'axios'</span>

<span class="hljs-comment">// 存储正在进行的请求</span>
<span class="hljs-keyword">const</span> pendingRequests = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>()

<span class="hljs-comment">// 生成请求key</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">generateReqKey</span> = (<span class="hljs-params">config</span>) =&gt; {
  <span class="hljs-keyword">const</span> { method, url, params, data } = config
  <span class="hljs-keyword">return</span> [method, url, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(params), <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(data)].<span class="hljs-title function_">join</span>(<span class="hljs-string">'&amp;'</span>)
}

<span class="hljs-comment">// 请求拦截器</span>
axios.<span class="hljs-property">interceptors</span>.<span class="hljs-property">request</span>.<span class="hljs-title function_">use</span>(<span class="hljs-function"><span class="hljs-params">config</span> =&gt;</span> {
  <span class="hljs-keyword">const</span> key = <span class="hljs-title function_">generateReqKey</span>(config)
  
  <span class="hljs-keyword">if</span> (pendingRequests.<span class="hljs-title function_">has</span>(key)) {
    <span class="hljs-comment">// 请求已存在，取消当前请求</span>
    config.<span class="hljs-property">cancelToken</span> = <span class="hljs-keyword">new</span> axios.<span class="hljs-title class_">CancelToken</span>(<span class="hljs-function"><span class="hljs-params">cancel</span> =&gt;</span> {
      <span class="hljs-title function_">cancel</span>(<span class="hljs-string">`重复请求已被拦截: <span class="hljs-subst">${key}</span>`</span>)
    })
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// 新请求，添加到pending中</span>
    pendingRequests.<span class="hljs-title function_">set</span>(key, config)
  }
  
  <span class="hljs-keyword">return</span> config
})

<span class="hljs-comment">// 响应拦截器</span>
axios.<span class="hljs-property">interceptors</span>.<span class="hljs-property">response</span>.<span class="hljs-title function_">use</span>(
  <span class="hljs-function"><span class="hljs-params">response</span> =&gt;</span> {
    <span class="hljs-keyword">const</span> key = <span class="hljs-title function_">generateReqKey</span>(response.<span class="hljs-property">config</span>)
    pendingRequests.<span class="hljs-title function_">delete</span>(key)
    <span class="hljs-keyword">return</span> response
  },
  <span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> {
    <span class="hljs-keyword">if</span> (axios.<span class="hljs-title function_">isCancel</span>(error)) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'请求被取消:'</span>, error.<span class="hljs-property">message</span>)
      <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(error)
    }
    
    <span class="hljs-comment">// 错误处理完成后，也要从pending中移除</span>
    <span class="hljs-keyword">if</span> (error.<span class="hljs-property">config</span>) {
      <span class="hljs-keyword">const</span> key = <span class="hljs-title function_">generateReqKey</span>(error.<span class="hljs-property">config</span>)
      pendingRequests.<span class="hljs-title function_">delete</span>(key)
    }
    
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(error)
  }
)
</code></pre>
<p><strong>前端防护小结</strong>：</p>
<ul>
<li><strong>优点</strong>：实现简单，能拦截大部分用户无意识的重复点击</li>
<li><strong>缺点</strong>：可被绕过（如直接调用API、禁用JS、使用Postman等工具）</li>
<li><strong>结论</strong>：前端防护是<strong>必要但不充分</strong>的措施，绝不能作为唯一防线</li>
</ul>
<h2 data-id="heading-5">03 第二道防线：后端接口幂等性设计</h2>
<p>幂等性是解决重复提交的<strong>核心理念</strong>。</p>
<p>所谓幂等，就是<strong>同一个操作执行多次的结果与执行一次的结果相同</strong>。</p>
<h3 data-id="heading-6">3.1 什么是幂等性？</h3>
<p>对于订单提交接口：</p>
<ul>
<li><strong>幂等</strong>：无论调用1次还是N次，都只创建一个订单</li>
<li><strong>非幂等</strong>：调用N次可能创建N个订单</li>
</ul>
<h3 data-id="heading-7">3.2 基于Token的幂等实现</h3>
<p>这是最常用的幂等实现方案，流程如下：</p>
<ol>
<li>客户端在提交前，先向后端申请一个唯一Token</li>
<li>提交订单时携带此Token</li>
<li>服务端检查Token是否已使用过</li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 幂等性Token服务</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">IdempotentTokenService</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RedisTemplate&lt;String, String&gt; redisTemplate;
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">IDEMPOTENT_PREFIX</span> <span class="hljs-operator">=</span> <span class="hljs-string">"idempotent:token:"</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">TOKEN_EXPIRE_SECONDS</span> <span class="hljs-operator">=</span> <span class="hljs-number">300</span>; <span class="hljs-comment">// Token有效期5分钟</span>
    
    <span class="hljs-comment">/**
     * 生成幂等性Token
     */</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">generateToken</span><span class="hljs-params">(String userId)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">token</span> <span class="hljs-operator">=</span> UUID.randomUUID().toString();
        <span class="hljs-type">String</span> <span class="hljs-variable">redisKey</span> <span class="hljs-operator">=</span> IDEMPOTENT_PREFIX + userId + <span class="hljs-string">":"</span> + token;
        
        <span class="hljs-comment">// 存储Token，设置过期时间</span>
        redisTemplate.opsForValue().set(
            redisKey, 
            <span class="hljs-string">"1"</span>, 
            TOKEN_EXPIRE_SECONDS, 
            TimeUnit.SECONDS
        );
        
        <span class="hljs-keyword">return</span> token;
    }
    
    <span class="hljs-comment">/**
     * 检查并消费Token
     * <span class="hljs-doctag">@return</span> true: Token有效且消费成功; false: Token无效或已消费
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">checkAndConsumeToken</span><span class="hljs-params">(String userId, String token)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">redisKey</span> <span class="hljs-operator">=</span> IDEMPOTENT_PREFIX + userId + <span class="hljs-string">":"</span> + token;
        
        <span class="hljs-comment">// 使用Lua脚本保证原子性</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">luaScript</span> <span class="hljs-operator">=</span> <span class="hljs-string">"""
            if redis.call('get', KEYS[1]) == '1' then
                redis.call('del', KEYS[1])
                return 1
            else
                return 0
            end
            """</span>;
        
        DefaultRedisScript&lt;Long&gt; redisScript = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultRedisScript</span>&lt;&gt;();
        redisScript.setScriptText(luaScript);
        redisScript.setResultType(Long.class);
        
        <span class="hljs-type">Long</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> redisTemplate.execute(
            redisScript, 
            Collections.singletonList(redisKey)
        );
        
        <span class="hljs-keyword">return</span> result != <span class="hljs-literal">null</span> &amp;&amp; result == <span class="hljs-number">1L</span>;
    }
}

<span class="hljs-comment">// 使用AOP实现幂等性校验</span>
<span class="hljs-meta">@Target(ElementType.METHOD)</span>
<span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span>
<span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> Idempotent {
    String <span class="hljs-title function_">key</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-string">""</span>; <span class="hljs-comment">// 幂等键，支持SpEL表达式</span>
    <span class="hljs-type">long</span> <span class="hljs-title function_">expireTime</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-number">300</span>; <span class="hljs-comment">// 过期时间，秒</span>
}

<span class="hljs-meta">@Aspect</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">IdempotentAspect</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RedisTemplate&lt;String, String&gt; redisTemplate;
    
    <span class="hljs-meta">@Around("@annotation(idempotent)")</span>
    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">around</span><span class="hljs-params">(ProceedingJoinPoint joinPoint, Idempotent idempotent)</span> <span class="hljs-keyword">throws</span> Throwable {
        <span class="hljs-comment">// 1. 获取方法参数</span>
        Object[] args = joinPoint.getArgs();
        <span class="hljs-type">MethodSignature</span> <span class="hljs-variable">signature</span> <span class="hljs-operator">=</span> (MethodSignature) joinPoint.getSignature();
        <span class="hljs-type">Method</span> <span class="hljs-variable">method</span> <span class="hljs-operator">=</span> signature.getMethod();
        
        <span class="hljs-comment">// 2. 解析幂等键（支持SpEL）</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">keyExpression</span> <span class="hljs-operator">=</span> idempotent.key();
        <span class="hljs-type">String</span> <span class="hljs-variable">redisKey</span> <span class="hljs-operator">=</span> parseKey(keyExpression, method, args);
        
        <span class="hljs-comment">// 3. 尝试获取分布式锁（防止并发请求同时通过检查）</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">lockKey</span> <span class="hljs-operator">=</span> redisKey + <span class="hljs-string">":lock"</span>;
        <span class="hljs-type">boolean</span> <span class="hljs-variable">lockAcquired</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 尝试加锁</span>
            lockAcquired = redisTemplate.opsForValue()
                .setIfAbsent(lockKey, <span class="hljs-string">"1"</span>, <span class="hljs-number">10</span>, TimeUnit.SECONDS);
            
            <span class="hljs-keyword">if</span> (!lockAcquired) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(<span class="hljs-string">"系统繁忙，请稍后重试"</span>);
            }
            
            <span class="hljs-comment">// 4. 检查Token是否已使用</span>
            <span class="hljs-type">Boolean</span> <span class="hljs-variable">exists</span> <span class="hljs-operator">=</span> redisTemplate.hasKey(redisKey);
            <span class="hljs-keyword">if</span> (Boolean.TRUE.equals(exists)) {
                <span class="hljs-comment">// Token已使用，直接返回之前的处理结果（这里需要根据实际业务调整）</span>
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(<span class="hljs-string">"请勿重复提交订单"</span>);
            }
            
            <span class="hljs-comment">// 5. 执行业务逻辑</span>
            <span class="hljs-type">Object</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> joinPoint.proceed();
            
            <span class="hljs-comment">// 6. 标记Token已使用</span>
            redisTemplate.opsForValue().set(
                redisKey, 
                <span class="hljs-string">"processed"</span>, 
                idempotent.expireTime(), 
                TimeUnit.SECONDS
            );
            
            <span class="hljs-keyword">return</span> result;
            
        } <span class="hljs-keyword">finally</span> {
            <span class="hljs-comment">// 释放锁</span>
            <span class="hljs-keyword">if</span> (lockAcquired) {
                redisTemplate.delete(lockKey);
            }
        }
    }
    
    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">parseKey</span><span class="hljs-params">(String expression, Method method, Object[] args)</span> {
        <span class="hljs-comment">// 这里实现SpEL表达式解析，获取实际的幂等键</span>
        <span class="hljs-comment">// 例如可以从参数中提取userId+orderToken</span>
        <span class="hljs-keyword">return</span> <span class="hljs-string">"parsed:key:from:expression"</span>;
    }
}

<span class="hljs-comment">// 在订单提交接口上使用</span>
<span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping("/order")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderController</span> {
    
    <span class="hljs-meta">@PostMapping("/submit")</span>
    <span class="hljs-meta">@Idempotent(key = "#request.userId + ':' + #request.submitToken", expireTime = 300)</span>
    <span class="hljs-keyword">public</span> ApiResponse&lt;OrderSubmitResult&gt; <span class="hljs-title function_">submitOrder</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> OrderSubmitRequest request)</span> {
        <span class="hljs-comment">// 这里是真正的订单创建逻辑</span>
        <span class="hljs-type">OrderSubmitResult</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> orderService.createOrder(request);
        <span class="hljs-keyword">return</span> ApiResponse.success(result);
    }
}
</code></pre>
<p>最近为了帮助大家找工作，专门建了一些工作内推群，各大城市都有，欢迎各位HR和找工作的小伙伴进群交流，群里目前已经收集了20多家大厂的工作内推岗位。加苏三的微信：li_su223，备注：掘金+所在城市，即可进群。</p>
<h3 data-id="heading-8">3.3 基于唯一业务标识的幂等</h3>
<p>除了Token方案，还可以利用业务的自然唯一性实现幂等：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderService</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> OrderMapper orderMapper;
    
    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> OrderSubmitResult <span class="hljs-title function_">createOrder</span><span class="hljs-params">(OrderSubmitRequest request)</span> {
        <span class="hljs-comment">// 方法1：先查询是否存在</span>
        <span class="hljs-type">Order</span> <span class="hljs-variable">existingOrder</span> <span class="hljs-operator">=</span> orderMapper.selectByUniqueKey(
            request.getUserId(), 
            request.getProductId(), 
            request.getSubmitTime()
        );
        
        <span class="hljs-keyword">if</span> (existingOrder != <span class="hljs-literal">null</span>) {
            <span class="hljs-comment">// 订单已存在，直接返回</span>
            <span class="hljs-keyword">return</span> convertToResult(existingOrder);
        }
        
        <span class="hljs-comment">// 方法2：利用数据库唯一约束</span>
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">Order</span> <span class="hljs-variable">newOrder</span> <span class="hljs-operator">=</span> buildOrder(request);
            orderMapper.insert(newOrder);
            <span class="hljs-keyword">return</span> convertToResult(newOrder);
        } <span class="hljs-keyword">catch</span> (DuplicateKeyException e) {
            <span class="hljs-comment">// 捕获唯一键冲突异常</span>
            log.warn(<span class="hljs-string">"订单重复提交，uniqueKey={}"</span>, request.getUniqueKey());
            
            <span class="hljs-comment">// 查询已创建的订单并返回</span>
            <span class="hljs-type">Order</span> <span class="hljs-variable">createdOrder</span> <span class="hljs-operator">=</span> orderMapper.selectByUniqueKey(
                request.getUserId(), 
                request.getProductId(), 
                request.getSubmitTime()
            );
            
            <span class="hljs-keyword">if</span> (createdOrder == <span class="hljs-literal">null</span>) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(<span class="hljs-string">"订单处理异常，请稍后重试"</span>);
            }
            
            <span class="hljs-keyword">return</span> convertToResult(createdOrder);
        }
    }
    
    <span class="hljs-comment">// 订单表可添加唯一索引</span>
    <span class="hljs-comment">// ALTER TABLE t_order ADD UNIQUE KEY uk_user_product_time (user_id, product_id, submit_time);</span>
}
</code></pre>
<p><strong>幂等性设计小结</strong>：</p>
<ul>
<li><strong>Token方案</strong>：通用性强，适合大多数场景</li>
<li><strong>业务标识方案</strong>：更自然，但依赖业务的天然唯一性</li>
<li><strong>关键点</strong>：所有幂等性检查<strong>必须在事务开始前完成</strong>，否则可能失效</li>
</ul>
<h2 data-id="heading-9">04 第三道防线：数据库层防护</h2>
<p>数据库是数据持久化的最后一道关卡，在这里设置防护至关重要。</p>
<h3 data-id="heading-10">4.1 唯一约束与乐观锁</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 订单表设计示例</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `t_order` (
  `id` <span class="hljs-type">bigint</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="hljs-string">'主键'</span>,
  `order_no` <span class="hljs-type">varchar</span>(<span class="hljs-number">32</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'订单号，业务唯一'</span>,
  `user_id` <span class="hljs-type">bigint</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'用户ID'</span>,
  `product_id` <span class="hljs-type">bigint</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'商品ID'</span>,
  `quantity` <span class="hljs-type">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'购买数量'</span>,
  `amount` <span class="hljs-type">decimal</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'订单金额'</span>,
  `status` tinyint(<span class="hljs-number">4</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">'1'</span> COMMENT <span class="hljs-string">'订单状态：1-待支付，2-已支付'</span>,
  `submit_token` <span class="hljs-type">varchar</span>(<span class="hljs-number">64</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'提交Token，用于幂等'</span>,
  `version` <span class="hljs-type">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">'1'</span> COMMENT <span class="hljs-string">'版本号，用于乐观锁'</span>,
  `create_time` datetime <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>,
  `update_time` datetime <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">UPDATE</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>,
  <span class="hljs-keyword">PRIMARY</span> KEY (`id`),
  <span class="hljs-keyword">UNIQUE</span> KEY `uk_order_no` (`order_no`), <span class="hljs-comment">-- 订单号唯一</span>
  <span class="hljs-keyword">UNIQUE</span> KEY `uk_user_submit_token` (`user_id`, `submit_token`), <span class="hljs-comment">-- 提交Token唯一</span>
  <span class="hljs-keyword">UNIQUE</span> KEY `uk_user_product_time` (`user_id`, `product_id`, `create_time`), <span class="hljs-comment">-- 业务维度唯一</span>
  KEY `idx_user_id` (`user_id`),
  KEY `idx_create_time` (`create_time`)
) ENGINE<span class="hljs-operator">=</span>InnoDB <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8mb4 COMMENT<span class="hljs-operator">=</span><span class="hljs-string">'订单表'</span>;
</code></pre>
<h3 data-id="heading-11">4.2 数据库层面的幂等实现</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 使用数据库事务+唯一约束保证最终一致性</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderServiceV2</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> OrderMapper orderMapper;
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> IdempotentTokenService tokenService;
    
    <span class="hljs-meta">@Transactional(rollbackFor = Exception.class)</span>
    <span class="hljs-keyword">public</span> OrderSubmitResult <span class="hljs-title function_">submitOrderWithDBProtection</span><span class="hljs-params">(OrderSubmitRequest request)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> request.getUserId();
        <span class="hljs-type">String</span> <span class="hljs-variable">submitToken</span> <span class="hljs-operator">=</span> request.getSubmitToken();
        
        <span class="hljs-comment">// 1. 检查幂等Token（在事务外先检查一次）</span>
        <span class="hljs-keyword">if</span> (!tokenService.checkAndConsumeToken(userId, submitToken)) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(<span class="hljs-string">"请勿重复提交订单"</span>);
        }
        
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 2. 生成订单号（雪花算法等分布式ID生成器）</span>
            <span class="hljs-type">String</span> <span class="hljs-variable">orderNo</span> <span class="hljs-operator">=</span> generateOrderNo();
            
            <span class="hljs-comment">// 3. 创建订单对象</span>
            <span class="hljs-type">Order</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Order</span>();
            order.setOrderNo(orderNo);
            order.setUserId(userId);
            order.setProductId(request.getProductId());
            order.setQuantity(request.getQuantity());
            order.setAmount(calculateAmount(request));
            order.setSubmitToken(submitToken);
            
            <span class="hljs-comment">// 4. 插入订单（这里依赖数据库唯一约束）</span>
            orderMapper.insert(order);
            
            <span class="hljs-comment">// 5. 更新库存等后续操作...</span>
            updateProductStock(request.getProductId(), request.getQuantity());
            
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderSubmitResult</span>(orderNo, <span class="hljs-string">"订单创建成功"</span>);
            
        } <span class="hljs-keyword">catch</span> (DuplicateKeyException e) {
            <span class="hljs-comment">// 6. 处理唯一约束冲突</span>
            log.warn(<span class="hljs-string">"订单重复提交，userId={}, token={}"</span>, userId, submitToken);
            
            <span class="hljs-comment">// 查询已创建的订单</span>
            <span class="hljs-type">Order</span> <span class="hljs-variable">existingOrder</span> <span class="hljs-operator">=</span> orderMapper.selectBySubmitToken(userId, submitToken);
            <span class="hljs-keyword">if</span> (existingOrder != <span class="hljs-literal">null</span>) {
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderSubmitResult</span>(
                    existingOrder.getOrderNo(), 
                    <span class="hljs-string">"订单已创建成功，请勿重复提交"</span>
                );
            }
            
            <span class="hljs-comment">// 理论上不会走到这里，除非有极端情况</span>
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(<span class="hljs-string">"订单处理异常，请稍后重试"</span>);
        }
    }
}
</code></pre>
<h2 data-id="heading-12">05 第四道防线：分布式锁</h2>
<p>在分布式环境下，多个实例可能同时处理同一个请求，需要分布式锁来保证只有一个实例执行核心逻辑。</p>
<h3 data-id="heading-13">5.1 基于Redis的分布式锁</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DistributedLockService</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RedissonClient redissonClient;
    
    <span class="hljs-comment">/**
     * 尝试获取分布式锁
     * <span class="hljs-doctag">@param</span> lockKey 锁的key
     * <span class="hljs-doctag">@param</span> waitTime 等待时间（毫秒）
     * <span class="hljs-doctag">@param</span> leaseTime 持有时间（毫秒）
     * <span class="hljs-doctag">@return</span> 锁对象，获取失败返回null
     */</span>
    <span class="hljs-keyword">public</span> RLock <span class="hljs-title function_">tryLock</span><span class="hljs-params">(String lockKey, <span class="hljs-type">long</span> waitTime, <span class="hljs-type">long</span> leaseTime)</span> {
        <span class="hljs-type">RLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> redissonClient.getLock(lockKey);
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">boolean</span> <span class="hljs-variable">acquired</span> <span class="hljs-operator">=</span> lock.tryLock(waitTime, leaseTime, TimeUnit.MILLISECONDS);
            <span class="hljs-keyword">return</span> acquired ? lock : <span class="hljs-literal">null</span>;
        } <span class="hljs-keyword">catch</span> (InterruptedException e) {
            Thread.currentThread().interrupt();
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        }
    }
    
    <span class="hljs-comment">/**
     * 订单提交分布式锁
     */</span>
    <span class="hljs-keyword">public</span> RLock <span class="hljs-title function_">lockForOrderSubmit</span><span class="hljs-params">(String userId, String submitToken)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">lockKey</span> <span class="hljs-operator">=</span> String.format(<span class="hljs-string">"order:submit:lock:%s:%s"</span>, userId, submitToken);
        <span class="hljs-keyword">return</span> tryLock(lockKey, <span class="hljs-number">100</span>, <span class="hljs-number">5000</span>); <span class="hljs-comment">// 等待100ms，锁持有5秒</span>
    }
}

<span class="hljs-comment">// 在订单服务中使用分布式锁</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderServiceV3</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> DistributedLockService lockService;
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> OrderMapper orderMapper;
    
    <span class="hljs-keyword">public</span> OrderSubmitResult <span class="hljs-title function_">submitOrderWithDistributedLock</span><span class="hljs-params">(OrderSubmitRequest request)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> request.getUserId();
        <span class="hljs-type">String</span> <span class="hljs-variable">submitToken</span> <span class="hljs-operator">=</span> request.getSubmitToken();
        
        <span class="hljs-comment">// 1. 获取分布式锁</span>
        <span class="hljs-type">RLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> lockService.lockForOrderSubmit(userId, submitToken);
        <span class="hljs-keyword">if</span> (lock == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(<span class="hljs-string">"系统繁忙，请稍后重试"</span>);
        }
        
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 2. 检查是否已处理</span>
            <span class="hljs-type">Order</span> <span class="hljs-variable">existingOrder</span> <span class="hljs-operator">=</span> orderMapper.selectBySubmitToken(userId, submitToken);
            <span class="hljs-keyword">if</span> (existingOrder != <span class="hljs-literal">null</span>) {
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderSubmitResult</span>(
                    existingOrder.getOrderNo(), 
                    <span class="hljs-string">"订单已创建成功，请勿重复提交"</span>
                );
            }
            
            <span class="hljs-comment">// 3. 执行业务逻辑</span>
            <span class="hljs-keyword">return</span> doCreateOrder(request);
            
        } <span class="hljs-keyword">finally</span> {
            <span class="hljs-comment">// 4. 释放锁</span>
            <span class="hljs-keyword">if</span> (lock.isHeldByCurrentThread()) {
                lock.unlock();
            }
        }
    }
    
    <span class="hljs-keyword">private</span> OrderSubmitResult <span class="hljs-title function_">doCreateOrder</span><span class="hljs-params">(OrderSubmitRequest request)</span> {
        <span class="hljs-comment">// 实际的订单创建逻辑</span>
        <span class="hljs-comment">// 这里已经保证了同一时刻只有一个线程在处理同一个提交请求</span>
        <span class="hljs-comment">// ...</span>
    }
}
</code></pre>
<h3 data-id="heading-14">5.2 分布式锁的注意事项</h3>
<p>使用分布式锁时要注意：</p>
<ol>
<li><strong>锁粒度</strong>：不要太粗（影响性能）也不要太细（增加复杂度）</li>
<li><strong>锁超时</strong>：必须设置合理的超时时间，防止死锁</li>
<li><strong>锁续期</strong>：对于长时间操作，需要实现锁续期机制</li>
<li><strong>可重入性</strong>：同一个线程可以重复获取锁</li>
<li><strong>容错性</strong>：Redis集群故障时要有降级方案</li>
</ol>
<h2 data-id="heading-15">06 第五道防线：异步处理与消息队列</h2>
<p>对于高并发场景，可以采用异步处理模式，将同步请求转为异步任务。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/90fb2463affa440aa8d5fb9e84bd73f1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuP5LiJ6K-05oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767060695&amp;x-signature=etKQANGWdTFnRfnHUnFWHdjeWws%3D" alt="" loading="lazy"/></p>
<p>实现代码示例：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 异步订单处理实现</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AsyncOrderService</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RocketMQTemplate rocketMQTemplate;
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RedisTemplate&lt;String, String&gt; redisTemplate;
    
    <span class="hljs-comment">/**
     * 异步提交订单
     */</span>
    <span class="hljs-keyword">public</span> AsyncSubmitResult <span class="hljs-title function_">asyncSubmitOrder</span><span class="hljs-params">(OrderSubmitRequest request)</span> {
        <span class="hljs-comment">// 1. 生成唯一请求ID</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">requestId</span> <span class="hljs-operator">=</span> generateRequestId(request.getUserId());
        
        <span class="hljs-comment">// 2. 快速验证（库存、用户状态等）</span>
        quickValidate(request);
        
        <span class="hljs-comment">// 3. 将请求ID与用户关联（用于查询结果）</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">pendingKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">"order:pending:"</span> + request.getUserId() + <span class="hljs-string">":"</span> + requestId;
        redisTemplate.opsForValue().set(pendingKey, <span class="hljs-string">"processing"</span>, <span class="hljs-number">10</span>, TimeUnit.MINUTES);
        
        <span class="hljs-comment">// 4. 发送到消息队列</span>
        <span class="hljs-type">OrderMessage</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderMessage</span>();
        message.setRequestId(requestId);
        message.setRequest(request);
        message.setTimestamp(System.currentTimeMillis());
        
        rocketMQTemplate.asyncSend(
            <span class="hljs-string">"ORDER_SUBMIT_TOPIC"</span>, 
            message, 
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">SendCallback</span>() {
                <span class="hljs-meta">@Override</span>
                <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onSuccess</span><span class="hljs-params">(SendResult sendResult)</span> {
                    log.info(<span class="hljs-string">"订单消息发送成功: {}"</span>, requestId);
                }
                
                <span class="hljs-meta">@Override</span>
                <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onException</span><span class="hljs-params">(Throwable throwable)</span> {
                    log.error(<span class="hljs-string">"订单消息发送失败: {}"</span>, requestId, throwable);
                    <span class="hljs-comment">// 发送失败，更新状态</span>
                    redisTemplate.opsForValue().set(
                        pendingKey, 
                        <span class="hljs-string">"failed"</span>, 
                        <span class="hljs-number">5</span>, 
                        TimeUnit.MINUTES
                    );
                }
            }
        );
        
        <span class="hljs-comment">// 5. 立即返回，告知用户处理中</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AsyncSubmitResult</span>(requestId, <span class="hljs-string">"订单提交成功，正在处理中"</span>);
    }
}

<span class="hljs-comment">// 消息消费者</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-meta">@RocketMQMessageListener(
    topic = "ORDER_SUBMIT_TOPIC",
    consumerGroup = "order-submit-consumer-group"
)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderSubmitConsumer</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">RocketMQListener</span>&lt;OrderMessage&gt; {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> OrderMapper orderMapper;
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onMessage</span><span class="hljs-params">(OrderMessage message)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">requestId</span> <span class="hljs-operator">=</span> message.getRequestId();
        <span class="hljs-type">OrderSubmitRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> message.getRequest();
        
        <span class="hljs-comment">// 1. 幂等检查（基于requestId）</span>
        <span class="hljs-type">Order</span> <span class="hljs-variable">existing</span> <span class="hljs-operator">=</span> orderMapper.selectByRequestId(requestId);
        <span class="hljs-keyword">if</span> (existing != <span class="hljs-literal">null</span>) {
            log.info(<span class="hljs-string">"订单已处理，跳过: {}"</span>, requestId);
            <span class="hljs-keyword">return</span>;
        }
        
        <span class="hljs-comment">// 2. 创建订单</span>
        <span class="hljs-type">Order</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> createOrder(request, requestId);
        
        <span class="hljs-keyword">try</span> {
            orderMapper.insert(order);
            log.info(<span class="hljs-string">"订单创建成功: {}"</span>, order.getOrderNo());
            
            <span class="hljs-comment">// 3. 更新处理状态</span>
            updateProcessingStatus(request.getUserId(), requestId, <span class="hljs-string">"success"</span>, order.getOrderNo());
            
        } <span class="hljs-keyword">catch</span> (DuplicateKeyException e) {
            log.warn(<span class="hljs-string">"订单重复，requestId={}"</span>, requestId);
            <span class="hljs-comment">// 查询已创建的订单</span>
            <span class="hljs-type">Order</span> <span class="hljs-variable">created</span> <span class="hljs-operator">=</span> orderMapper.selectByRequestId(requestId);
            <span class="hljs-keyword">if</span> (created != <span class="hljs-literal">null</span>) {
                updateProcessingStatus(request.getUserId(), requestId, <span class="hljs-string">"success"</span>, created.getOrderNo());
            }
        }
    }
}
</code></pre>
<h2 data-id="heading-16">07 综合方案：多层次联合防护</h2>
<p>在实际生产环境中，我们通常会采用多层次、立体化的防护策略。</p>
<p>以下是一个完整的综合方案流程图：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e6a5a4471629405bb76af04a642c9279~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuP5LiJ6K-05oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767060695&amp;x-signature=qM7q5jh8zQOC9Fchq4j0HOaKuw4%3D" alt="" loading="lazy"/></p>
<p>这个多层次方案中，每一层都有其特定作用：</p>
<ul>
<li><strong>前端层</strong>：用户体验优化，拦截大部分无意识重复</li>
<li><strong>网关层</strong>：安全防护，防刷、限流</li>
<li><strong>业务层</strong>：核心幂等逻辑，分布式锁保证并发安全</li>
<li><strong>数据层</strong>：最终保障，唯一约束防止数据不一致</li>
<li><strong>异步层</strong>：削峰填谷，提升系统吞吐量</li>
</ul>
<h2 data-id="heading-17">08 实战：不同场景下的方案选择</h2>
<p>不同的业务场景需要不同的防护策略，这里给出一些实践建议：</p>
<h3 data-id="heading-18">8.1 普通电商订单</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 普通电商订单推荐方案</span>
<span class="hljs-meta">@Service</span>  
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StandardOrderService</span> {
    
    <span class="hljs-comment">// 综合使用：前端防抖 + Token幂等 + 数据库唯一约束</span>
    <span class="hljs-keyword">public</span> OrderSubmitResult <span class="hljs-title function_">submitStandardOrder</span><span class="hljs-params">(OrderSubmitRequest request)</span> {
        <span class="hljs-comment">// 1. 参数校验</span>
        validateRequest(request);
        
        <span class="hljs-comment">// 2. 幂等Token检查（Redis）</span>
        <span class="hljs-keyword">if</span> (!idempotentCheck(request.getUserId(), request.getSubmitToken())) {
            <span class="hljs-keyword">return</span> getExistingOrderResult(request.getUserId(), request.getSubmitToken());
        }
        
        <span class="hljs-comment">// 3. 分布式锁（防并发）</span>
        <span class="hljs-type">RLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> acquireOrderLock(request.getUserId(), request.getProductId());
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 4. 库存检查等业务校验</span>
            checkInventory(request.getProductId(), request.getQuantity());
            
            <span class="hljs-comment">// 5. 创建订单（依赖数据库唯一约束）</span>
            <span class="hljs-keyword">return</span> createOrderInTransaction(request);
        } <span class="hljs-keyword">finally</span> {
            lock.unlock();
        }
    }
}
</code></pre>
<h3 data-id="heading-19">8.2 秒杀订单</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 秒杀订单需要更极致的优化</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FlashSaleOrderService</span> {
    
    <span class="hljs-comment">// 秒杀方案：异步处理 + 库存预扣 + 最终一致性</span>
    <span class="hljs-keyword">public</span> FlashSaleSubmitResult <span class="hljs-title function_">submitFlashSaleOrder</span><span class="hljs-params">(FlashSaleRequest request)</span> {
        <span class="hljs-comment">// 1. 验证用户资格和活动状态（缓存中检查）</span>
        <span class="hljs-keyword">if</span> (!checkUserQualification(request.getUserId(), request.getActivityId())) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(<span class="hljs-string">"您不具备参与资格"</span>);
        }
        
        <span class="hljs-comment">// 2. 预扣库存（Redis原子操作）</span>
        <span class="hljs-type">boolean</span> <span class="hljs-variable">stockDeducted</span> <span class="hljs-operator">=</span> preDeductStock(
            request.getActivityId(), 
            request.getProductId(), 
            request.getUserId()
        );
        
        <span class="hljs-keyword">if</span> (!stockDeducted) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(<span class="hljs-string">"库存不足"</span>);
        }
        
        <span class="hljs-comment">// 3. 生成唯一请求ID</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">requestId</span> <span class="hljs-operator">=</span> generateRequestId(request.getUserId(), request.getActivityId());
        
        <span class="hljs-comment">// 4. 发送到消息队列（快速返回）</span>
        sendToMQ(request, requestId);
        
        <span class="hljs-comment">// 5. 立即返回</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FlashSaleSubmitResult</span>(requestId, <span class="hljs-string">"秒杀请求已接受，处理中"</span>);
    }
    
    <span class="hljs-comment">// 消费者异步创建订单</span>
    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processFlashSaleOrder</span><span class="hljs-params">(FlashSaleRequest request, String requestId)</span> {
        <span class="hljs-comment">// 这里只需要处理真正的订单创建</span>
        <span class="hljs-comment">// 因为库存已在Redis中预扣，只需保证最终一致性</span>
        <span class="hljs-keyword">try</span> {
            createOrder(request, requestId);
            <span class="hljs-comment">// 同步库存到数据库</span>
            syncStockToDB(request.getProductId(), request.getActivityId());
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-comment">// 失败时回滚Redis库存</span>
            rollbackStockInRedis(request.getActivityId(), request.getProductId(), request.getUserId());
            <span class="hljs-keyword">throw</span> e;
        }
    }
}
</code></pre>
<h2 data-id="heading-20">10 总结</h2>
<p>防止重复提交订单是一个系统工程，需要从前到后、多层次的防护。</p>
<p>让我们回顾一下关键点：</p>
<ol>
<li><strong>前端防护是体验，不是保障</strong>：按钮防抖、请求拦截能改善用户体验，但不能作为唯一防线。</li>
<li><strong>幂等性是核心理念</strong>：无论是Token方案还是业务唯一标识，都要保证同一操作执行多次的结果一致。</li>
<li><strong>分布式锁解决并发问题</strong>：在分布式环境下，防止多个实例同时处理同一请求。</li>
<li><strong>数据库是最后防线</strong>：唯一约束、乐观锁等机制能在应用层防护失效时保证数据一致性。</li>
<li><strong>异步处理提升吞吐</strong>：对于高并发场景，将同步请求转为异步处理，提高系统整体吞吐量。</li>
<li><strong>监控告警必不可少</strong>：没有监控的系统就像没有仪表的飞机，无法发现问题和优化性能。</li>
</ol>
<p>在实际架构设计中，我通常建议采用 <strong>"前端防抖 + 网关限流 + Token幂等 + 分布式锁 + 数据库唯一约束"</strong> 的综合方案，对于秒杀等极致场景再加入异步处理。</p>
<p>有些小伙伴可能会觉得这些防护措施太复杂，影响开发效率。</p>
<p>但请记住：<strong>预防的成本远低于修复的成本</strong>。</p>
<p>一次重复提交导致的资损事故，可能就需要整个团队加班数周来修复数据和安抚用户。</p>
<p>技术方案没有银弹，只有最适合业务场景的平衡。</p>
<h2 data-id="heading-21">最后说一句(求关注，别白嫖我)</h2>
<p>如果这篇文章对您有所帮助，或者有所启发的话，帮忙关注一下我的同名公众号：苏三说技术，您的支持是我坚持写作最大的动力。</p>
<p>求一键三连：点赞、转发、在看。</p>
<p>关注公众号：【苏三说技术】，在公众号中回复：进大厂，可以免费获取我最近整理的10万字的面试宝典，好多小伙伴靠这个宝典拿到了多家大厂的offer。</p>
<p>更多项目实战在我的技术网站：<a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.susan.net.cn%2Fproject" title="https://link.juejin.cn?target=http%3A%2F%2Fwww.susan.net.cn%2Fproject" target="_blank">www.susan.net.cn/project</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[正则表达式在 Scala 中的应用]]></title>    <link>https://juejin.cn/post/7586559672129011764</link>    <guid>https://juejin.cn/post/7586559672129011764</guid>    <pubDate>2025-12-23T00:44:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586559672129011764" data-draft-id="7586559672128978996" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="正则表达式在 Scala 中的应用"/> <meta itemprop="keywords" content="Scala"/> <meta itemprop="datePublished" content="2025-12-23T00:44:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="代码于老总"/> <meta itemprop="url" content="https://juejin.cn/user/582105100725436"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            正则表达式在 Scala 中的应用
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/582105100725436/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    代码于老总
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T00:44:20.000Z" title="Tue Dec 23 2025 00:44:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好～今天来聊个<strong>通用又实用</strong>的技能：正则表达式在 Scala 中的应用。不管你是处理日志、校验手机号，还是提取字符串里的特定内容，正则都是绕不开的 “效率神器”。</p>
<h2 data-id="heading-0">一、先搞懂：正则到底是个啥？</h2>
<p>很多朋友觉得正则 “难学”，其实核心就一句话：<strong>正则是一套独立于编程语言的 “字符串规则语言”</strong>  —— 不管你用 Scala、Java 还是 Python，只要是写<code>\d</code>就代表匹配数字，写<code>{11}</code>就代表重复 11 次，规则是通用的。</p>
<p>它主要用来干两件事：</p>
<ul>
<li><strong>查找</strong>：从大字符串里揪出符合规则的子串（比如从一段文字里找手机号）</li>
<li><strong>匹配</strong>：验证整个字符串是否符合规则（比如检查输入的是不是合法手机号）</li>
</ul>
<h2 data-id="heading-1">二、实战：用 Scala 找字符串里的 11 位数字</h2>
<p>直接上代码（这是我写的一个 “提取 11 位数字” 的示例），咱们边看边拆：</p>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-comment">/*
* 1、处理字符串
* 2、查找：在大字符串里找符合规则的子串
* 3、匹配：验证字符串是否满足规则
* 划重点：正则是通用技术，和编程语言无关！
*/</span>

<span class="hljs-class"><span class="hljs-keyword">object</span> <span class="hljs-title">reg01</span> </span>{
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span></span>(args: <span class="hljs-type">Array</span>[<span class="hljs-type">String</span>]): <span class="hljs-type">Unit</span> = {
    <span class="hljs-comment">// 1. 定义正则规则：匹配11位连续数字</span>
    <span class="hljs-keyword">val</span> reg = <span class="hljs-string">"\d{11}"</span>.r  
    
    <span class="hljs-comment">// 2. 准备要处理的目标字符串</span>
    <span class="hljs-keyword">val</span> target = <span class="hljs-string">"I like 我喜欢 数13347589473!"</span>
    
    <span class="hljs-comment">// 3. 查找并输出结果</span>
    println(<span class="hljs-string">"找到的11位数字是："</span>)
    reg.findAllIn(target).foreach(println)
  }
}
</code></pre>
<h3 data-id="heading-2">代码拆解：3 步搞定正则匹配</h3>
<h4 data-id="heading-3">1. 定义正则规则：<code>val reg = "\d{11}".r</code></h4>
<p>这里有两个关键点：</p>
<ul>
<li><code>\d{11}</code>：这是<strong>正则语法</strong>——<code>\d</code>代表 “一个数字”（Scala 里要写两个反斜杠<code>\</code>做转义），<code>{11}</code>代表 “连续出现 11 次”，合起来就是 “匹配 11 位连续数字”；</li>
<li><code>.r</code>：这是 Scala 的 “小魔法”—— 把普通字符串转成<code>Regex</code>对象，只有转成这个对象，才能调用正则的专属方法。</li>
</ul>
<h4 data-id="heading-4">2. 准备目标字符串：<code>val target = "I like 我喜欢 数13347589473!"</code></h4>
<p>就是咱们要处理的原始内容，里面混了英文、中文和数字，我们要把 11 位的数字 “揪” 出来。</p>
<h4 data-id="heading-5">3. 执行查找：<code>reg.findAllIn(target).foreach(println)</code></h4>
<ul>
<li><code>findAllIn(target)</code>：<code>Regex</code>对象的核心方法，作用是<strong>把目标字符串里所有符合规则的子串都找出来</strong>，返回一个可迭代的集合；</li>
<li><code>foreach(println)</code>：遍历集合，把找到的结果打印出来。</li>
</ul>
<h3 data-id="heading-6">运行结果</h3>
<p>执行代码后，控制台会直接输出：</p>
<pre><code class="hljs">找到的11位数字是：
13347589473
</code></pre>
<h2 data-id="heading-7">三、进阶：正则在 Scala 里的常用玩法</h2>
<p>光 “查找” 还不够，正则还有很多实用操作，这里补充 3 个高频场景：</p>
<h3 data-id="heading-8">1. 只找第一个匹配的内容</h3>
<p>用<code>findFirstIn</code>方法，适合只需要 “第一个结果” 的场景：</p>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-comment">// 找第一个11位数字</span>
<span class="hljs-keyword">val</span> firstNum = reg.findFirstIn(target)
firstNum.foreach(res =&gt; println(<span class="hljs-string">s"第一个匹配结果：<span class="hljs-subst">$res</span>"</span>))
</code></pre>
<p>输出：<code>第一个匹配结果：13347589473</code></p>
<h3 data-id="heading-9">2. 验证整个字符串是否符合规则</h3>
<p>用<code>matches</code>方法，比如验证 “输入的是不是纯 11 位数字”：</p>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-keyword">val</span> phone1 = <span class="hljs-string">"13347589473"</span>  <span class="hljs-comment">// 合法</span>
<span class="hljs-keyword">val</span> phone2 = <span class="hljs-string">"13347589473abc"</span>  <span class="hljs-comment">// 不合法</span>
println(phone1.matches(<span class="hljs-string">"\d{11}"</span>))  <span class="hljs-comment">// 输出：true</span>
println(phone2.matches(<span class="hljs-string">"\d{11}"</span>))  <span class="hljs-comment">// 输出：false</span>
</code></pre>
<h3 data-id="heading-10">3. 替换匹配的内容</h3>
<p>用<code>replaceAllIn</code>方法，把找到的内容替换成其他字符：</p>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-comment">// 把11位数字替换成****脱敏</span>
<span class="hljs-keyword">val</span> desensitized = reg.replaceAllIn(target, <span class="hljs-string">"****"</span>)
println(desensitized)  <span class="hljs-comment">// 输出：I like 我喜欢 数****!</span>
</code></pre>
<h2 data-id="heading-11">四、最后总结：正则的 “通用 + 高效”</h2>
<ol>
<li><strong>规则通用</strong>：正则语法是跨语言的，学会<code>\d</code>、<code>{n}</code>、<code>\w</code>这些基础语法，换任何语言都能用；</li>
<li><strong>Scala 调用流程固定</strong>：定义规则（字符串 +.r）→ 调用方法（findAllIn/matches 等）→ 处理结果；</li>
<li><strong>场景广泛</strong>：日志解析、表单校验、数据清洗…… 只要涉及字符串处理，正则都是 “偷懒神器”。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[CompletableFuture 异常吞噬：异步任务异常未处理导致结果丢失]]></title>    <link>https://juejin.cn/post/7586505172815888435</link>    <guid>https://juejin.cn/post/7586505172815888435</guid>    <pubDate>2025-12-23T00:55:36.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586505172815888435" data-draft-id="7584266920640528435" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="CompletableFuture 异常吞噬：异步任务异常未处理导致结果丢失"/> <meta itemprop="keywords" content="Java"/> <meta itemprop="datePublished" content="2025-12-23T00:55:36.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="uup"/> <meta itemprop="url" content="https://juejin.cn/user/4378706456356627"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            CompletableFuture 异常吞噬：异步任务异常未处理导致结果丢失
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4378706456356627/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    uup
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T00:55:36.000Z" title="Tue Dec 23 2025 00:55:36 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、Bug 场景</h2>
<p>在一个基于 Java 的微服务应用中，使用 <code>CompletableFuture</code> 来处理异步任务，以提高系统的并发性能。例如，在处理用户注册流程时，会异步调用多个服务进行数据校验、生成账号等操作。然而，在实际运行过程中，发现当某个异步任务出现异常时，没有得到正确的处理，导致整个注册流程看似正常完成，但实际上部分关键数据没有正确生成，影响了业务的正常进行。</p>
<h2 data-id="heading-1">二、代码示例</h2>
<h3 data-id="heading-2">异步任务类（有缺陷）</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.util.concurrent.CompletableFuture;
<span class="hljs-keyword">import</span> java.util.concurrent.ExecutionException;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AsyncTaskExample</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> CompletableFuture&lt;String&gt; <span class="hljs-title function_">performAsyncTask</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> CompletableFuture.supplyAsync(() -&gt; {
            <span class="hljs-comment">// 模拟可能出现异常的操作</span>
            <span class="hljs-keyword">if</span> (Math.random() &gt; <span class="hljs-number">0.5</span>) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"模拟异步任务异常"</span>);
            }
            <span class="hljs-keyword">return</span> <span class="hljs-string">"任务成功完成"</span>;
        });
    }
}
</code></pre>
<h3 data-id="heading-3">测试代码</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CompletableFutureBugExample</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        CompletableFuture&lt;String&gt; future = AsyncTaskExample.performAsyncTask();
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> future.get();
            System.out.println(<span class="hljs-string">"任务结果: "</span> + result);
        } <span class="hljs-keyword">catch</span> (InterruptedException | ExecutionException e) {
            e.printStackTrace();
        }
    }
}
</code></pre>
<h2 data-id="heading-4">三、问题描述</h2>
<ol>
<li><strong>预期行为</strong>：当异步任务出现异常时，能够及时捕获并处理异常，确保业务流程的正确性和完整性。例如，在用户注册场景中，如果某个异步校验或生成操作失败，应该回滚整个注册流程，并向用户返回错误信息。</li>
<li><strong>实际行为</strong>：在上述代码中，虽然 <code>CompletableFuture</code> 中的任务可能抛出异常，但在调用 <code>future.get()</code> 时，异常被 <code>ExecutionException</code> 包装，并且在 <code>main</code> 方法中只是简单地打印了堆栈信息。这使得业务层无法对具体的异常进行针对性处理，导致即使异步任务失败，程序也可能继续执行后续逻辑，就好像任务成功完成一样，从而丢失了正确的结果，影响业务功能。此外，异常被 “吞噬” 在 <code>ExecutionException</code> 中，没有被清晰地传递和处理，增加了调试和维护的难度。</li>
</ol>
<h2 data-id="heading-5">四、解决方案</h2>
<ol>
<li><strong>使用 <code>exceptionally</code> 方法处理异常</strong>：<code>CompletableFuture</code> 提供了 <code>exceptionally</code> 方法，可在异步任务出现异常时，返回一个默认值或执行一些替代操作。</li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.util.concurrent.CompletableFuture;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AsyncTaskExample</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> CompletableFuture&lt;String&gt; <span class="hljs-title function_">performAsyncTask</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> CompletableFuture.supplyAsync(() -&gt; {
            <span class="hljs-keyword">if</span> (Math.random() &gt; <span class="hljs-number">0.5</span>) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"模拟异步任务异常"</span>);
            }
            <span class="hljs-keyword">return</span> <span class="hljs-string">"任务成功完成"</span>;
        }).exceptionally(ex -&gt; {
            System.err.println(<span class="hljs-string">"捕获到异步任务异常: "</span> + ex.getMessage());
            <span class="hljs-keyword">return</span> <span class="hljs-string">"任务失败，返回默认值"</span>;
        });
    }
}
</code></pre>
<h3 data-id="heading-6">修改后的测试代码</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CompletableFutureBugExample</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        CompletableFuture&lt;String&gt; future = AsyncTaskExample.performAsyncTask();
        <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> future.join();
        System.out.println(<span class="hljs-string">"任务结果: "</span> + result);
    }
}
</code></pre>
<ol start="2">
<li><strong>使用 <code>whenComplete</code> 方法</strong>：<code>whenComplete</code> 方法可以在任务完成（无论是正常完成还是异常完成）时执行回调函数，在回调函数中可以根据任务状态进行相应处理。</li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.util.concurrent.CompletableFuture;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AsyncTaskExample</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> CompletableFuture&lt;String&gt; <span class="hljs-title function_">performAsyncTask</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> CompletableFuture.supplyAsync(() -&gt; {
            <span class="hljs-keyword">if</span> (Math.random() &gt; <span class="hljs-number">0.5</span>) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"模拟异步任务异常"</span>);
            }
            <span class="hljs-keyword">return</span> <span class="hljs-string">"任务成功完成"</span>;
        }).whenComplete((result, ex) -&gt; {
            <span class="hljs-keyword">if</span> (ex != <span class="hljs-literal">null</span>) {
                System.err.println(<span class="hljs-string">"捕获到异步任务异常: "</span> + ex.getMessage());
            }
        });
    }
}
</code></pre>
<h3 data-id="heading-7">结合 <code>handle</code> 方法获取结果或处理异常</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.util.concurrent.CompletableFuture;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AsyncTaskExample</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> CompletableFuture&lt;String&gt; <span class="hljs-title function_">performAsyncTask</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> CompletableFuture.supplyAsync(() -&gt; {
            <span class="hljs-keyword">if</span> (Math.random() &gt; <span class="hljs-number">0.5</span>) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"模拟异步任务异常"</span>);
            }
            <span class="hljs-keyword">return</span> <span class="hljs-string">"任务成功完成"</span>;
        }).handle((result, ex) -&gt; {
            <span class="hljs-keyword">if</span> (ex != <span class="hljs-literal">null</span>) {
                System.err.println(<span class="hljs-string">"捕获到异步任务异常: "</span> + ex.getMessage());
                <span class="hljs-keyword">return</span> <span class="hljs-string">"任务失败，返回默认值"</span>;
            }
            <span class="hljs-keyword">return</span> result;
        });
    }
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[WPF中的IValueConverter接口（值转换器）]]></title>    <link>https://juejin.cn/post/7586559672129093684</link>    <guid>https://juejin.cn/post/7586559672129093684</guid>    <pubDate>2025-12-23T01:09:18.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586559672129093684" data-draft-id="7586498198149611571" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="WPF中的IValueConverter接口（值转换器）"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-23T01:09:18.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="seekCat"/> <meta itemprop="url" content="https://juejin.cn/user/925121393197673"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            WPF中的IValueConverter接口（值转换器）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/925121393197673/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    seekCat
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T01:09:18.000Z" title="Tue Dec 23 2025 01:09:18 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">1.IValueConverter 是什么？解决什么问题？</h3>
<h4 data-id="heading-1">1.1 定义</h4>
<p>IValueConverter是WPF中用于数据绑定时进行值转换的接口。</p>
<pre><code class="hljs language-C#" lang="C#"><span class="hljs-keyword">namespace</span> <span class="hljs-title">System.Windows.Data</span>
{
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title">IValueConverter</span>{
        <span class="hljs-function"><span class="hljs-built_in">object</span> <span class="hljs-title">Convert</span>(<span class="hljs-params"><span class="hljs-built_in">object</span> <span class="hljs-keyword">value</span>, Type targetType, <span class="hljs-built_in">object</span> parameter, CultureInfo culture</span>)</span>;
        <span class="hljs-function"><span class="hljs-built_in">object</span> <span class="hljs-title">ConvertBack</span>(<span class="hljs-params"><span class="hljs-built_in">object</span> <span class="hljs-keyword">value</span>, Type targetType, <span class="hljs-built_in">object</span> parameter, CultureInfo culture</span>)</span>;
    }
}
</code></pre>
<p>当需要调用时，实现该接口并重写Convert和ConvertBack，以下分别叙述这两个方法的用途</p>
<h4 data-id="heading-2">1.2 核心作用</h4>
<p>当ViewModle中的数据类型，不能直接用View展示，即ViewModel与View对应的数据类型不一致时，需要使用该接口进行数据类型转换，IValueConverter起到了“翻译官”的角色。</p>
<h3 data-id="heading-3">2.为什么要使用值转换器？</h3>
<p>在 MVVM 模式中：</p>
<ul>
<li>ViewModel 只暴露 <strong>业务含义的数据</strong></li>
<li>View 需要 <strong>UI 能理解的类型</strong></li>
</ul>
<p>典型示例：</p>





















<table><thead><tr><th>ViewModel数据</th><th>View</th></tr></thead><tbody><tr><td>bool</td><td>Visibility</td></tr><tr><td>enum</td><td>Style</td></tr><tr><td>DataTime</td><td>string</td></tr></tbody></table>
<p>为了解决这样的类型不匹配，需要使用值转换器</p>
<h3 data-id="heading-4">3.IValueConverter 的生命周期与执行时机</h3>
<h4 data-id="heading-5">3.1 执行时机</h4>
<p>IValueConverter的实现类对象会在以下情况被调用</p>
<ul>
<li>绑定源属性首次赋值</li>
<li>绑定源属性发生变化（INotifyPropertyChanged）</li>
<li>绑定目标需要重新计算显示值</li>
</ul>
<h4 data-id="heading-6">3.2 执行方向</h4>
<p>ViewModel -&gt; View 调用Convert方法 <br/>
View -&gt; ViewModel 调用ConvertBack方法</p>
<h3 data-id="heading-7">4.Convert 与 ConvertBack 的职责划分</h3>
<h4 data-id="heading-8">4.1 Convert</h4>
<pre><code class="hljs language-C#" lang="C#"><span class="hljs-function"><span class="hljs-built_in">object</span> <span class="hljs-title">Convert</span>(<span class="hljs-params"><span class="hljs-built_in">object</span> <span class="hljs-keyword">value</span>, Type targetType,<span class="hljs-built_in">object</span> parameter, CultureInfo culture</span>)</span>;
</code></pre>

























<table><thead><tr><th>参数</th><th>含义</th></tr></thead><tbody><tr><td>value</td><td>当前传递的值，在Concert中来自ViewModel</td></tr><tr><td>targetType</td><td>目标属性类型</td></tr><tr><td>parameter</td><td>XAML传入的附加参数</td></tr><tr><td>culture</td><td>区域信息</td></tr></tbody></table>
<h4 data-id="heading-9">4.2CovertBack</h4>
<pre><code class="hljs language-C#" lang="C#"><span class="hljs-function"><span class="hljs-built_in">object</span> <span class="hljs-title">ConvertBack</span>(<span class="hljs-params"><span class="hljs-built_in">object</span> <span class="hljs-keyword">value</span>, Type targetType, <span class="hljs-built_in">object</span> parameter, CultureInfo culture</span>)</span>;
</code></pre>

























<table><thead><tr><th>参数</th><th>含义</th></tr></thead><tbody><tr><td>value</td><td>当前传递的值，来自View</td></tr><tr><td>targetType</td><td>目标属性类型</td></tr><tr><td>parameter</td><td>XAML传入的附加参数</td></tr><tr><td>culture</td><td>区域信息</td></tr></tbody></table>
<p>一般不具体实现</p>
<pre><code class="hljs language-C#" lang="C#"><span class="hljs-function"><span class="hljs-built_in">object</span> <span class="hljs-title">ConvertBack</span>(<span class="hljs-params"><span class="hljs-built_in">object</span> <span class="hljs-keyword">value</span>, Type targetType, <span class="hljs-built_in">object</span> parameter, CultureInfo culture</span>)</span>{
    Binding.DoNothing;
}
</code></pre>
<p>在以下两种情况需要具体实现</p>
<ul>
<li>Mode=TwoWay</li>
</ul>
<pre><code class="hljs language-XAML" lang="XAML">{Binding Path=... Mode=TwoWay}
</code></pre>
<ul>
<li>View需要回写到ViewModel中</li>
</ul>
<h3 data-id="heading-10">5.具体实例</h3>
<p>需要实现导航栏按钮被按下后，样式改变以提醒用户界面切换，为了完成该需求，可以在ViewModel中维护一个枚举属性来记录当前的访问界面</p>
<pre><code class="hljs language-C#" lang="C#"><span class="hljs-comment">//枚举</span>
```
<span class="hljs-keyword">public</span> <span class="hljs-built_in">enum</span> MainWindowMenuItem
{
    Menu1,
    Menu2,
    Menu3,
    Menu4,
    Menu5,
    Menu6,
    Menu7,
    Menu8,
    Menu9
}
```

<span class="hljs-keyword">public</span> <span class="hljs-keyword">partial</span> <span class="hljs-keyword">class</span> <span class="hljs-title">MainWindowViewModel</span> : <span class="hljs-title">ObservableObject</span>
{
    ...Other...
    [<span class="hljs-meta">ObservableProperty</span>] <span class="hljs-keyword">private</span> MainWindowMenuItem _selectedMenuItem = MainWindowMenuItem.Menu1;
    ...Other...
}
</code></pre>
<pre><code class="hljs language-XAML" lang="XAML">&lt;Button
    Style="{Binding SelectedMenuItem,Converter={StaticResource MenuConverter},ConverterParameter={x:Static local:MainWindowMenuItem.Menu1}}"
    Command="{Binding SelectMenuCommand}"
    CommandParameter="{x:Static local:MainWindowMenuItem.Menu1}"&gt;
    &lt;Button.Content&gt;
        ...
    &lt;/Button.Content&gt;
&lt;/Button&gt;
</code></pre>
<p>可以看到这个按钮绑定了一个传入枚举的命令，当点击它的时候，他会修改ViewModel中的SelectedMenuItem属性，当该属性被修改时，会把对应的枚举值交给值转换器，然后对比按钮上的parameter，将被点击的按钮的样式修改为SelectedButtonStyle。</p>
<pre><code class="hljs language-C#" lang="C#"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">MenuConverter</span>:<span class="hljs-title">IValueConverter</span>
{
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">object</span>? Convert(<span class="hljs-built_in">object</span>? <span class="hljs-keyword">value</span>, Type targetType, <span class="hljs-built_in">object</span>? parameter, CultureInfo culture)
    {
        <span class="hljs-keyword">var</span> normal = (Style)Application.Current.Resources[<span class="hljs-string">"NormalButtonStyle"</span>];
        <span class="hljs-keyword">var</span> selected = (Style)Application.Current.Resources[<span class="hljs-string">"SelectedButtonStyle"</span>];

        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">value</span> == <span class="hljs-literal">null</span> || parameter == <span class="hljs-literal">null</span>)
            <span class="hljs-keyword">return</span> normal;

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">value</span>.Equals(parameter) ? selected : normal;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-built_in">object</span>? ConvertBack(<span class="hljs-built_in">object</span>? <span class="hljs-keyword">value</span>, Type targetType, <span class="hljs-built_in">object</span>? parameter, CultureInfo culture)
    {
        <span class="hljs-keyword">return</span> Binding.DoNothing;
    }
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Elasticsearch 中的 term的查询]]></title>    <link>https://juejin.cn/post/7586582977707933738</link>    <guid>https://juejin.cn/post/7586582977707933738</guid>    <pubDate>2025-12-23T02:13:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586582977707933738" data-draft-id="7586585688004345897" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Elasticsearch 中的 term的查询"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-23T02:13:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="一个大专生的淘汰之路"/> <meta itemprop="url" content="https://juejin.cn/user/1327865775796807"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Elasticsearch 中的 term的查询
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1327865775796807/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    一个大专生的淘汰之路
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T02:13:02.000Z" title="Tue Dec 23 2025 02:13:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Elasticsearch 中的 term 查询详解（附常见踩坑点）</h2>
<p>在使用 Elasticsearch 进行搜索时，<code>term</code> 查询是一个<strong>非常基础但又非常容易被误用</strong>的查询方式。很多人会疑惑：</p>
<ul>
<li>为什么 <code>term</code> 查不出来数据？</li>
<li><code>term</code> 和 <code>match</code> 到底有什么区别？</li>
<li>什么字段适合用 <code>term</code>？</li>
</ul>
<p>本文将围绕这些问题，系统讲清 <strong><code>term</code> 查询的原理、使用场景和常见坑点</strong>。</p>
<hr/>
<h3 data-id="heading-1">一、什么是 term 查询？</h3>
<p><code>term</code> 查询属于 <strong>精确匹配（Exact Match）查询</strong>。</p>
<blockquote>
<p>它不会对查询条件做分词、分析处理，而是直接拿你给的值，去倒排索引里做精确匹配。</p>
</blockquote>
<p>官方一句话总结：</p>
<blockquote>
<p><strong>term query finds documents that contain the exact term specified in the inverted index</strong></p>
</blockquote>
<hr/>
<h3 data-id="heading-2">二、term 查询的基本用法</h3>
<h4 data-id="heading-3">1️⃣ 基本示例</h4>
<p>假设我们有如下文档：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"userId"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1001</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"status"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"SUCCESS"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>对应的查询：</p>
<pre><code class="hljs language-bash" lang="bash">GET test_index/_search
{
  <span class="hljs-string">"query"</span>: {
    <span class="hljs-string">"term"</span>: {
      <span class="hljs-string">"status"</span>: {
        <span class="hljs-string">"value"</span>: <span class="hljs-string">"SUCCESS"</span>
      }
    }
  }
}
</code></pre>
<p>如果 <code>status</code> 字段在索引中是 <strong>未分词字段（keyword）</strong> ，那么这条查询是可以正常命中的。</p>
<hr/>
<h4 data-id="heading-4">2️⃣ 简写形式</h4>
<pre><code class="hljs language-bash" lang="bash">GET test_index/_search
{
  <span class="hljs-string">"query"</span>: {
    <span class="hljs-string">"term"</span>: {
      <span class="hljs-string">"status"</span>: <span class="hljs-string">"SUCCESS"</span>
    }
  }
}
</code></pre>
<p>效果与上面完全一致。</p>
<hr/>
<h3 data-id="heading-5">三、term 查询的核心特性</h3>
<h4 data-id="heading-6">✅ 1. 不会分词</h4>
<p>这是 <strong>最重要的一点</strong>。</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-attr">"term"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"张三"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<ul>
<li>Elasticsearch <strong>不会</strong>把“张三”拆成“张”“三”</li>
<li>只会匹配索引中 <strong>完全等于“张三”</strong> 的 term</li>
</ul>
<hr/>
<h4 data-id="heading-7">✅ 2. 区分大小写（取决于字段）</h4>
<p>例如：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-attr">"status"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"success"</span>
</code></pre>
<p>如果你用：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-attr">"term"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"status"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"SUCCESS"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>➡ <strong>可能查不到结果</strong></p>
<p>是否区分大小写，<strong>取决于字段是否经过 analyzer 处理</strong>。</p>
<hr/>
<h3 data-id="heading-8">四、term 查询最容易踩的坑 ⚠️</h3>
<h4 data-id="heading-9">❌ 1. 对 text 字段使用 term 查询</h4>
<p>这是新手最常犯的错误。</p>
<h5 data-id="heading-10">示例字段映射：</h5>
<pre><code class="hljs language-json" lang="json"><span class="hljs-attr">"message"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"text"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>索引内容：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-attr">"message"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Elasticsearch is powerful"</span>
</code></pre>
<p>你用：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-attr">"term"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"message"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Elasticsearch"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>➡ <strong>大概率查不到数据</strong></p>
<h5 data-id="heading-11">原因是：</h5>
<ul>
<li><code>text</code> 类型字段在写入时已经被 <strong>分词</strong></li>
<li>倒排索引中存的是 <code>elasticsearch</code>、<code>is</code>、<code>powerful</code></li>
<li>而你用 <code>term</code> 查的是<strong>原始字符串</strong></li>
</ul>
<hr/>
<h4 data-id="heading-12">✅ 正确做法 1：使用 <code>.keyword</code> 字段</h4>
<pre><code class="hljs language-json" lang="json"><span class="hljs-attr">"term"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"message.keyword"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Elasticsearch is powerful"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<hr/>
<h4 data-id="heading-13">✅ 正确做法 2：改用 match 查询</h4>
<pre><code class="hljs language-json" lang="json"><span class="hljs-attr">"match"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"message"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Elasticsearch"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<hr/>
<h4 data-id="heading-14">❌ 2. term 查询不适合“模糊搜索”</h4>
<p>例如你想查：</p>
<ul>
<li>包含某个词</li>
<li>类似 SQL 的 <code>like</code></li>
</ul>
<p>❌ <strong>term 做不了</strong></p>
<p>应该用：</p>
<ul>
<li><code>match</code></li>
<li><code>match_phrase</code></li>
<li><code>wildcard</code></li>
<li><code>regexp</code></li>
</ul>
<hr/>
<h3 data-id="heading-15">五、什么场景适合用 term 查询？</h3>
<h4 data-id="heading-16">✅ 非常适合的场景</h4>

































<table><thead><tr><th>场景</th><th>是否适合</th></tr></thead><tbody><tr><td>状态码（status）</td><td>✅</td></tr><tr><td>枚举值</td><td>✅</td></tr><tr><td>用户ID</td><td>✅</td></tr><tr><td>订单号</td><td>✅</td></tr><tr><td>是否删除（is_deleted）</td><td>✅</td></tr><tr><td>精确标签</td><td>✅</td></tr></tbody></table>
<p>示例：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">"term":</span> {
  <span class="hljs-attr">"userId":</span> <span class="hljs-number">1001</span>
}
</code></pre>
<hr/>
<h4 data-id="heading-17">❌ 不适合的场景</h4>





















<table><thead><tr><th>场景</th><th>原因</th></tr></thead><tbody><tr><td>文章标题</td><td>需要分词</td></tr><tr><td>描述信息</td><td>需要全文搜索</td></tr><tr><td>模糊匹配</td><td>term 不支持</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-18">六、term vs match，对比总结</h3>






























<table><thead><tr><th>对比项</th><th>term</th><th>match</th></tr></thead><tbody><tr><td>是否分词</td><td>❌ 不分词</td><td>✅ 分词</td></tr><tr><td>是否精确匹配</td><td>✅</td><td>❌</td></tr><tr><td>适合字段类型</td><td>keyword / 数值</td><td>text</td></tr><tr><td>使用难度</td><td>易踩坑</td><td>更友好</td></tr></tbody></table>
<p>一句话总结：</p>
<blockquote>
<p><strong>term 用于“确定你知道索引里长什么样”的场景，match 用于“我想搜这段话”的场景。</strong></p>
</blockquote>
<hr/>
<h3 data-id="heading-19">七、生产环境中的最佳实践 ⭐</h3>
<p>1️⃣ <strong>明确字段类型</strong></p>
<ul>
<li>精确查询 → <code>keyword</code></li>
<li>搜索文本 → <code>text</code></li>
</ul>
<p>2️⃣ <strong>term 查询只用在确定值上</strong></p>
<ul>
<li>状态、ID、枚举</li>
</ul>
<p>3️⃣ <strong>查不到结果时，先看 mapping</strong></p>
<pre><code class="hljs language-bash" lang="bash">GET index_name/_mapping
</code></pre>
<hr/>
<h3 data-id="heading-20">八、结语</h3>
<p><code>term</code> 查询本身并不复杂，但<strong>复杂的是它对字段类型和索引结构的要求</strong>。</p>
<p>很多“ES 查不出数据”的问题，根本原因只有一句话：</p>
<blockquote>
<p><strong>你以为你在查值，其实你在查分词后的 term。</strong></p>
</blockquote>
<p>如果你能真正理解这一点，<code>term</code> 查询就再也不会踩坑了。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React哲学：保持组件纯粹 哈气就要哈得纯粹]]></title>    <link>https://juejin.cn/post/7586518130761416744</link>    <guid>https://juejin.cn/post/7586518130761416744</guid>    <pubDate>2025-12-22T16:29:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586518130761416744" data-draft-id="7585850609015963663" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React哲学：保持组件纯粹  哈气就要哈得纯粹"/> <meta itemprop="keywords" content="前端,React.js,设计"/> <meta itemprop="datePublished" content="2025-12-22T16:29:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="若倾"/> <meta itemprop="url" content="https://juejin.cn/user/3270387091383163"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React哲学：保持组件纯粹  哈气就要哈得纯粹
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3270387091383163/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    若倾
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T16:29:59.000Z" title="Mon Dec 22 2025 16:29:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="" data-highlight-key="ascetic">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fff;color:#000}.hljs-addition,.hljs-attribute,.hljs-bullet,.hljs-link,.hljs-section,.hljs-string,.hljs-symbol,.hljs-template-variable,.hljs-variable{color:#888}.hljs-comment,.hljs-deletion,.hljs-meta,.hljs-quote{color:#ccc}.hljs-keyword,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-strong,.hljs-type{font-weight:700}.hljs-emphasis{font-style:italic}</style><h2 data-id="heading-0">纯粹函数的设计理念</h2>
<h3 data-id="heading-1">什么是纯粹函数</h3>
<blockquote>
<p>纯粹函数的两大核心条件</p>
</blockquote>
<p>条件1： 函数不修改被调用前就存在的变量与对象，只做纯粹的运算。</p>
<p>条件2： 保证函数相同的输入，就会有相同输出。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">//定义一个外部变量</span>
<span class="hljs-keyword">let</span>  num=<span class="hljs-number">0</span>;

<span class="hljs-comment">//纯粹函数</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">x</span>)
{<span class="hljs-comment">//满足两大核心条件</span>
 <span class="hljs-comment">//条件1：不修改函数外的任何变量</span>
 <span class="hljs-comment">//条件2： 输入 x 固定，则输出必然是 x+1 </span>
    <span class="hljs-keyword">return</span> x+<span class="hljs-number">1</span>;
}

<span class="hljs-comment">//调用纯粹函数，传入外部的num</span>
<span class="hljs-keyword">let</span> a=<span class="hljs-title function_">add</span>(num);
<span class="hljs-keyword">let</span> b=<span class="hljs-title function_">add</span>(num)

<span class="hljs-comment">// num并未被修改，两次输入相同，得到的结果也相同</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(num,a) <span class="hljs-comment">// 输出0 1</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(num,b) <span class="hljs-comment">// 输出0 1</span>
</code></pre>
<h2 data-id="heading-2">纯粹组件：React哲学</h2>
<h3 data-id="heading-3">什么是纯粹的组件</h3>
<blockquote>
<p>纯粹组件的两大核心条件</p>
</blockquote>
<p>react模仿纯粹函数的设计理念，提出纯粹组件的设计理念同样需要满足两个核心条件：</p>
<p>条件1：不修改组件渲染前存在的对象与变量。</p>
<p>条件2：相同的输出，返回相同的jsx</p>
<blockquote>
<p>反例：什么样的组件不纯粹</p>
</blockquote>
<p>条件1：组件内部对外部依赖值进行更改</p>
<p>条件2：多次渲染组件时输入相同，但是返回到jsx却不同</p>
<p>如果满足上诉两个任意一个条件，那么这个组件将不纯粹</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>
<span class="hljs-comment">//定义一个外部变量</span>
<span class="hljs-keyword">let</span> num=<span class="hljs-number">0</span>

<span class="hljs-keyword">function</span> <span class="hljs-title function_">Child</span>(<span class="hljs-params"/>){
<span class="hljs-comment">// 组件修改外部依赖值</span>
<span class="hljs-comment">// 导致相同的输入下，每次返回的</span>
  num++;
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>{num}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Child</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">Child</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Child</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">Child</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Child</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">Child</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  )
}

</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cc27263d0e144a07809a07bef692c4d5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Iul5YC-:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767025967&amp;x-signature=%2Fe02kHgsWmvUAgjLRKA4ISQcoHA%3D" alt="8aabb038e73721ff973ca11dd32f127e.png" loading="lazy"/></p>
<h3 data-id="heading-4">为什么需要保持组件纯粹</h3>
<ol>
<li>保证组件渲染的独立性</li>
</ol>
<blockquote>
<p>所谓独立性：</p>
</blockquote>
<p>如果组件渲染时修改了外部预先存在的变量会导致：</p>
<ul>
<li>
<p>后续依赖这些变量与对象的组件渲染产生不确定性，这就导致依赖同一变量的组件需要保证渲染的顺序。</p>
</li>
<li>
<p>但是组件在浏览器中的渲染时机是不确定的。如果组件渲染结果，依赖组件间渲染的顺序。就会导致既定逻辑失效，从而产生错误。</p>
</li>
</ul>
<p>所以我们要排除这种不确定性，使得react组件使用更加安全，让组件渲染之间的渲染逻辑更加独立</p>
<ol start="2">
<li>保证组件渲染的确定性</li>
</ol>
<blockquote>
<p>所谓确定性</p>
</blockquote>
<p>确定性建立在独立性之上</p>
<ul>
<li>当组件渲染时独立地不影响外部组件的渲染逻辑，由此保证组件外部组件渲染的确定性，能够预先避免许多错误</li>
</ul>
<ol start="3">
<li>没有保持纯粹性的反面案例</li>
</ol>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// 全局变量（外部状态）</span>
<span class="hljs-keyword">let</span> globalCount = <span class="hljs-number">0</span>;

<span class="hljs-comment">// 组件A：渲染时修改外部变量</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">ComponentA</span>(<span class="hljs-params"/>) {
  globalCount += <span class="hljs-number">1</span>; <span class="hljs-comment">// 修改外部变量</span>
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>组件A：{globalCount}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
}

<span class="hljs-comment">// 组件B：依赖同一个外部变量</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">ComponentB</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>组件B：{globalCount * 2}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
}

<span class="hljs-comment">// 父组件：同时渲染A和B</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">Parent</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">ComponentA</span> /&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">ComponentB</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<ul>
<li>理想顺序（A先渲染，B后渲染）：globalCount 先变成 1，B渲染2 → 结果:A=1,B=2；</li>
<li>实际可能的顺序（React调度导致B先渲染）：B先读取 globalCount=0渲染0，再A把 globalCount 改成 1→结果：A=1，B=0；</li>
</ul>
<h2 data-id="heading-5">保持纯粹  !=   不可修改</h2>
<h3 data-id="heading-6">局部突变</h3>
<ol>
<li>什么是局部突变</li>
</ol>
<blockquote>
<p>在react官方文档中的定义其实是“局部mutation”，即在渲染时修改组件内部“刚刚创建对象或者变量”。</p>
</blockquote>
<ul>
<li>这样的局部突变不会影响外部组件的渲染逻辑，只影响组件内部的逻辑。</li>
</ul>
<ol start="2">
<li>利用局部突变保持组件的纯粹性</li>
</ol>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// 全局变量（外部状态）</span>
<span class="hljs-keyword">let</span> globalCount = <span class="hljs-number">0</span>;

<span class="hljs-comment">// 组件A：渲染时不修改外部变量</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">ComponentA</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">let</span> <span class="hljs-title class_">Count</span>=globalCount+<span class="hljs-number">1</span>
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>组件A：{Count}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
}

<span class="hljs-comment">// 组件B：依赖同一个外部变量，但是不直接修改外部变量</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">ComponentB</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">let</span> <span class="hljs-title class_">Count</span>=(globalCount+<span class="hljs-number">1</span>)*<span class="hljs-number">2</span>
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>组件B：{Count * 2}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
}

<span class="hljs-comment">// 父组件：同时渲染A和B</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">Parent</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">ComponentA</span> /&gt;</span> 
      <span class="hljs-tag">&lt;<span class="hljs-name">ComponentB</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<ul>
<li>无论A，B谁先渲染，都改变不了渲染结果：A=1，B=2</li>
<li>最终使组件重新保持“纯粹”</li>
</ul>
<h3 data-id="heading-7">用“更新” 替换 “修改”</h3>
<blockquote>
<p>使用“状态”管理变量</p>
</blockquote>
<ul>
<li>为了保证组件的纯粹性，并不意味着组件渲染依赖的外部变量完全就不能改变了。可以通过“状态”来管理外部变量。</li>
</ul>
<blockquote>
<p>“状态”管理变量的好处</p>
</blockquote>
<ul>
<li>当变量需要被修改时，不再直接对其进行变更。而是等待组件渲染完成后，更新并将修改值传入组件中。由此保持组件渲染时的独立性与确定性</li>
</ul>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> { useState } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-comment">// 显示购物车数量的组件（纯粹组件：只依赖 props，无任何副作用）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">PureCartCount</span>(<span class="hljs-params">{ count }</span>) {
  <span class="hljs-comment">// 只读取 props，不修改任何外部数据，相同 props 必然渲染相同结果</span>
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>购物车数量：{count}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
}

<span class="hljs-comment">// 控制数量增减的组件（不直接修改数据，只发起更新请求）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">PureCountControls</span>(<span class="hljs-params">{ onAdd, onSubtract }</span>) {
  <span class="hljs-comment">// 不触碰任何变量，只通过父组件传入的函数发起“更新请求”</span>
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{onSubtract}</span>&gt;</span>-<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{onAdd}</span>&gt;</span>+<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}

<span class="hljs-comment">// 父组件：用状态管理变量，统一控制更新逻辑</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 用 useState 管理购物车数量（状态由 React 管控，初始值 1）</span>
  <span class="hljs-keyword">const</span> [cartCount, setCartCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">1</span>);

  <span class="hljs-comment">// 数量“更新”逻辑：生成新值，不修改原状态</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleAdd</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-comment">// 关键：不直接改 cartCount（如 cartCount +=1），而是通过 setCartCount 生成新值</span>
    <span class="hljs-title function_">setCartCount</span>(<span class="hljs-function"><span class="hljs-params">prevCount</span> =&gt;</span> prevCount + <span class="hljs-number">1</span>);
  };

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleSubtract</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-comment">// 生成新值（原 cartCount 保持不变，直到 React 触发重新渲染）</span>
    <span class="hljs-title function_">setCartCount</span>(<span class="hljs-function"><span class="hljs-params">prevCount</span> =&gt;</span> <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-number">1</span>, prevCount - <span class="hljs-number">1</span>)); <span class="hljs-comment">// 避免数量小于 1</span>
  };

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      {/* 新状态通过 props 传入纯粹组件，组件只“读”不“写” */}
      <span class="hljs-tag">&lt;<span class="hljs-name">PureCartCount</span> <span class="hljs-attr">count</span>=<span class="hljs-string">{cartCount}</span> /&gt;</span>
      {/* 传递更新函数，让子组件发起更新请求 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">PureCountControls</span> <span class="hljs-attr">onAdd</span>=<span class="hljs-string">{handleAdd}</span> <span class="hljs-attr">onSubtract</span>=<span class="hljs-string">{handleSubtract}</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">App</span>; 
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从入门到实践：玩转分布式链路追踪利器SkyWalking]]></title>    <link>https://juejin.cn/post/7586569284551393320</link>    <guid>https://juejin.cn/post/7586569284551393320</guid>    <pubDate>2025-12-23T02:26:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586569284551393320" data-draft-id="7586569284551327784" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从入门到实践：玩转分布式链路追踪利器SkyWalking"/> <meta itemprop="keywords" content="后端,Java,架构"/> <meta itemprop="datePublished" content="2025-12-23T02:26:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Shepherd"/> <meta itemprop="url" content="https://juejin.cn/user/3415500769991869"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从入门到实践：玩转分布式链路追踪利器SkyWalking
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3415500769991869/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Shepherd
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T02:26:44.000Z" title="Tue Dec 23 2025 02:26:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1.概述</h2>
<p>在当今微服务架构盛行的时代，一个看似简单的前端请求，背后往往涉及数十个甚至上百个服务的协同调用。当系统出现性能问题或异常时，仅靠传统日志监控往往如同“大海捞针”，难以迅速定位问题根源。</p>
<p>正是在这样的背景下，<strong>SkyWalking</strong> —— 一款优秀的国产开源分布式链路追踪与性能监控系统应运而生。该项目最初由吴晟（华为开发者）个人开源，于2017年进入Apache孵化器，并最终成为Apache顶级项目。截至目前，SkyWalking在GitHub上已收获超过25k的Star，足以证明其强大的影响力和广泛的应用前景</p>
<h3 data-id="heading-1">1.1 SkyWalking 是什么？</h3>
<p>SkyWalking 是一个开源的可观测性平台，用于从服务、云原生基础设施中收集、分析、聚合和可视化数据。它提供了清晰的分布式系统观测能力，并支持跨云、跨集群的统一监控。作为现代化的应用性能监控（APM）系统，SkyWalking 尤其适合云原生和基于容器的微服务架构。</p>
<h4 data-id="heading-2">核心优势：</h4>
<ul>
<li><strong>无侵入探针</strong>：通过Java Agent字节码增强实现监控，无需修改业务代码</li>
<li><strong>高性能通信</strong>：采用gRPC进行数据传输，效率高、延迟低</li>
<li><strong>功能全面</strong>：支持链路追踪、JVM监控、服务依赖分析、告警等</li>
<li><strong>生态友好</strong>：完美支持Spring Cloud、Spring Boot等主流微服务框架</li>
</ul>
<h4 data-id="heading-3">典型应用场景：</h4>
<ol start="0">
<li><strong>性能瓶颈诊断</strong>：快速定位慢查询、高延迟接口</li>
<li><strong>全链路追踪</strong>：可视化展示请求在微服务间的完整调用路径</li>
<li><strong>服务依赖分析</strong>：自动绘制服务拓扑，识别关键依赖与瓶颈点</li>
<li><strong>异常根因定位</strong>：结合链路、指标与日志，迅速定位故障源头</li>
<li><strong>容量规划参考</strong>：基于历史性能数据进行资源预测与扩容决策</li>
</ol>
<h3 data-id="heading-4">1.2 主流链路追踪框架对比</h3>
<p>随着微服务架构的普及，分布式链路追踪技术也日趋成熟，目前主流的开源方案包括：</p>
<ul>
<li><strong>Spring Cloud Sleuth + Zipkin</strong>：需代码埋点，侵入性强</li>
<li><strong>大众点评 Cat</strong>：同样需要侵入式埋点，接入成本较高</li>
<li><strong>Pinpoint</strong>：韩国团队开发，同样基于字节码增强，无侵入</li>
<li><strong>SkyWalking</strong>：国产开源，无侵入、性能好、社区活跃</li>
</ul>
<p>SkyWalking 与 Pinpoint 均通过字节码注入实现监控，对业务代码零侵入，是目前企业级APM系统的优选方案。对于国内开发者而言，SkyWalking 具有中文文档丰富、社区响应快、与国内技术栈整合度高等优势，更值得推荐。</p>
<h2 data-id="heading-5">2.SkyWalking 架构与原理</h2>
<p>SkyWalking 核心架构组件逻辑上分为四部分: 探针(Agent)、 平台后端(OAP)，存储(Storage)和用户界面(UI)</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2ca0b92da986436cab298ce75bf47c87~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2hlcGhlcmQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767061604&amp;x-signature=TrOLedJhFLGcXZ48aQFxWyWsQzM%3D" alt="" loading="lazy"/></p>
<ul>
<li><strong>探针(Agent):</strong> 收集监控数据, 将数据格式化为 SkyWalking 适用的格式，然后传递给中间的OAP服务器。</li>
<li><strong>OAP:</strong> 全称即图上的Observabilitiy Analysis Platform， 完成数据聚合, 数据分析以及驱动数据流从探针到用户界面的流程</li>
<li><strong>存储</strong> 通过开放的插件化的接口存放 SkyWalking 数据. 你可以选择一个既有的存储系统, 如 ElasticSearch, H2 或 MySQL 集群(Sharding-Sphere 管理),也可以选择自己实现一个存储系统. 当然, 我们非常欢迎你贡献新的存储系统实现。</li>
<li><strong>UI</strong> 一个基于接口高度定制化的Web系统，用户可以可视化查看和管理 SkyWalking 数据。</li>
</ul>
<p>SkyWalking 利用Java Agent技术，在类加载阶段动态注入监控逻辑，无需改动源码：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// Skywalking通过javaagent在类加载时动态注入监控代码</span>
<span class="hljs-comment">// 不需要修改业务代码</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SkywalkingAgent</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">premain</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> args, Instrumentation inst</span>) {
        <span class="hljs-comment">// 1. 注册类文件转换器</span>
        inst.<span class="hljs-title function_">addTransformer</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassFileTransformer</span>() {
            <span class="hljs-keyword">public</span> byte[] <span class="hljs-title function_">transform</span>(<span class="hljs-params">...</span>) {
                <span class="hljs-comment">// 2. 使用ByteBuddy/Javassist修改字节码</span>
                <span class="hljs-comment">// 3. 在方法入口/出口插入监控逻辑</span>
            }
        });
    }
}
</code></pre>
<p>这种方式既保证了监控的全面性，又实现了对业务的完全透明。关于javaagent知识点请另外自行查阅资料。</p>
<h2 data-id="heading-6">3.SkyWalking 安装与部署</h2>
<p>基于上面对Skywalking架构原理的介绍，相信大家已经对它已经有了一定的认识了解，接下来我们就来开始搭建一个强大的监控系统。</p>
<h3 data-id="heading-7">3.1 下载安装包</h3>
<p>去官网：<a href="https://link.juejin.cn?target=https%3A%2F%2Fskywalking.incubator.apache.org%2Fdownloads%2F" target="_blank" title="https://skywalking.incubator.apache.org/downloads/" ref="nofollow noopener noreferrer">skywalking.incubator.apache.org/downloads/</a> 下载，我这里选择版本是: <code>v9.7.0</code></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0ca0336b94c04e2ca7ea94a69830ef91~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2hlcGhlcmQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767061604&amp;x-signature=mNSl87FUiKUJCI0PaCMm2xxfhK8%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-8">3.2 解压与调整配置</h3>
<pre><code class="hljs"> tar -zxvf apache-skywalking-apm-9.7.0.tar.gz
</code></pre>
<p>解压之后有一个文件夹，文件信息如下：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/15704295d3664275850d7e66bb27fecd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2hlcGhlcmQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767061604&amp;x-signature=8FLjbp8fm6u40baT5jx%2FBIxAuRo%3D" alt="" loading="lazy"/></p>
<ul>
<li>
<p><strong>bin</strong>：存放一些可执行的脚本，比如说启动Skywalking OAP服务的脚本</p>
</li>
<li>
<p><strong>config：</strong> 存放配置文件，这里是我们需要关注的，有OAP服务的配置文件<code>applicaiton.yml</code>。配置项太多了所以这里我随便列举两项看看</p>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-symbol">cluster:</span>
  <span class="hljs-comment"># 默认单例部署，也可以集群部署，比如说通过注册中心nacos</span>
  <span class="hljs-symbol">selector:</span> <span class="hljs-variable">${</span><span class="hljs-variable constant_">SW_CLUSTER</span><span class="hljs-symbol">:standalone</span>}
  
<span class="hljs-symbol">storage:</span>
  <span class="hljs-comment"># 数据存储默认是内存数据库h2，生产环境一般推荐elasticsearch，官方也强烈建议</span>
  <span class="hljs-symbol">selector:</span> <span class="hljs-variable">${</span><span class="hljs-variable constant_">SW_STORAGE</span><span class="hljs-symbol">:h2</span>}
</code></pre>
<p>由于我是本地搭建演示，就完全按照默认的即可，没有做任何修改</p>
</li>
<li>
<p><strong>webapp：</strong> UI服务，默认端口是<code>8080</code>，但一般这个端口被占用了，所以需要修改一下<code>webapp/application.yml</code>，我这里改成：<code>8181</code></p>
</li>
</ul>

<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-symbol">serverPort:</span> <span class="hljs-variable">${</span><span class="hljs-variable constant_">SW_SERVER_PORT</span><span class="hljs-symbol">:-</span><span class="hljs-number">8181</span>}
​
<span class="hljs-comment"># Comma seperated list of OAP addresses.</span>
<span class="hljs-symbol">oapServices:</span> <span class="hljs-variable">${</span><span class="hljs-variable constant_">SW_OAP_ADDRESS</span><span class="hljs-symbol">:-http</span><span class="hljs-symbol">://localhost</span><span class="hljs-symbol">:</span><span class="hljs-number">12800</span>}
​
<span class="hljs-symbol">zipkinServices:</span> <span class="hljs-variable">${</span><span class="hljs-variable constant_">SW_ZIPKIN_ADDRESS</span><span class="hljs-symbol">:-http</span><span class="hljs-symbol">://localhost</span><span class="hljs-symbol">:</span><span class="hljs-number">9412</span>}
</code></pre>
<h3 data-id="heading-9">3.3 启动服务</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 启动OAP后端</span>
bin/oapService.sh
​
<span class="hljs-comment"># 启动UI前端</span>
bin/webappService.sh
</code></pre>
<p>启动后访问 <code>http://localhost:8181</code> 即可进入SkyWalking监控控制台。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/75d598b437d04cd8b47e0ff28215dcde~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2hlcGhlcmQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767061604&amp;x-signature=frFgzIGIq9KSkYgQ%2BD7RKgEFzgI%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-10">4.Spring Boot接入指南</h2>
<p>在启动命令中添加Java Agent参数</p>
<pre><code class="hljs language-ini" lang="ini">-javaagent:/Users/shepherdmy/skywalking/skywalking-agent/skywalking-agent.jar
<span class="hljs-attr">-Dskywalking.agent.service_name</span>=shepherd-demo01-service
<span class="hljs-attr">-Dskywalking.collector.backend_service</span>=localhost:<span class="hljs-number">11800</span>
</code></pre>
<p>项目启动成功之后，Skywalking会监控到一个名为<code>shepherd-demo01-service</code>的服务，如上图所示。可看到对应的服务名称、实例、接口调用链路等信息</p>
<ul>
<li><strong>服务概览</strong>：展示服务负载量、接口请求平均响应时间、成功率等关键指标</li>
</ul>
<p>点击<code>服务名</code>进入监控指标概览页：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7f52029626f24cb2aefa364389a813e4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2hlcGhlcmQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767061604&amp;x-signature=5IqAJRpysDS%2Barjil%2F3wVwlFM8Q%3D" alt="" loading="lazy"/></p>
<ul>
<li><strong>实例详情</strong>：查看实例下的监控指标信息，如JVM内存、CPU、GC等情况</li>
</ul>
<p>点击 <code>Instance</code>，可以查到该服务的<code>实例列表</code></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e87a39de548a4373be931ff797d5ce48~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2hlcGhlcmQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767061604&amp;x-signature=kWno9h4AN4211ArBTwazfpaoOFc%3D" alt="" loading="lazy"/></p>
<p>点击<code>实例名</code>进入，可以查看这个实例下的监控信息：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7e927f8052274b9d98fb14fa044fd8d2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2hlcGhlcmQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767061604&amp;x-signature=AMWmU0l%2B9NrtGIDJa1DH4SK0YSk%3D" alt="" loading="lazy"/></p>
<p>查看实例的jvm信息：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/45452dfad25746a7a60e3641d6767ea6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2hlcGhlcmQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767061604&amp;x-signature=Ufm52vQ%2FP5uplbUcZALpclkjZes%3D" alt="" loading="lazy"/></p>
<ul>
<li><strong>查看EndPoint端点信息</strong></li>
</ul>
<p>端点可以简单理解为是被监控服务所接收的请求。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/92e42e56720749d58b6dcec52ad77255~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2hlcGhlcmQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767061604&amp;x-signature=bKoYWpE6jt4nqeh8m8QVznjmD1U%3D" alt="" loading="lazy"/></p>
<p>点击<code>GET:/user/page</code>端点进去，可以查看这个请求的监控信息：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/364f1908094a4e8daeac425da38f268a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2hlcGhlcmQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767061604&amp;x-signature=Y3DxeEEtD1%2B%2BcxsHkrtgLnAFPr4%3D" alt="" loading="lazy"/></p>
<p>该请求<code>GET:/user/page</code>逻辑是先查询<code>Redis</code>，有缓存数据就直接返回，没有再根据参数去数据库<code>MySQL</code>查询数据存入<code>Redis</code>之后返回，这里详细展示了请求的整个调用链路，非常清晰直观。</p>
<ul>
<li><strong>拓扑图</strong>：可视化服务间依赖关系</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/35c2b0462aa04478a11a1e6a7bd7bc67~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2hlcGhlcmQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767061604&amp;x-signature=1O8tLje6E2iO1LGq3qs4vPEal%2Bg%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-11">5.总结</h2>
<p>SkyWalking 提供多层级的监控指标，助力全方位系统可观测：</p>

























<table><thead><tr><th>层级</th><th>监控指标示例</th></tr></thead><tbody><tr><td>服务级别</td><td>P99/P95延迟、请求量、错误率</td></tr><tr><td>实例级别</td><td>CPU使用率、JVM堆内存、线程数、GC次数</td></tr><tr><td>接口端点</td><td>慢接口TOP10、错误接口TOP5、调用链详情</td></tr><tr><td>数据库</td><td>慢SQL查询、连接池状态、执行时间分布</td></tr></tbody></table>
<p>SkyWalking 作为一款开源APM系统，凭借其<strong>无侵入的设计</strong>、<strong>卓越的性能表现</strong>以及<strong>活跃的中文社区</strong>，已成为众多企业微服务监控的首选方案。无论是开发调试、性能优化，还是线上故障排查，SkyWalking 都能提供强大的数据支持和可视化能力。</p>
<p>合理部署与使用SkyWalking，不仅能提升系统稳定性，还能显著降低运维复杂度，是现代分布式系统可观测性建设中不可或缺的一环。</p>
<hr/>
<blockquote>
<p>本文初步介绍了SkyWalking的核心概念、部署流程与接入实践，关于微服务链路追踪的更深层原理、Trace与Span的组成、以及与Log4j2/Logback等日志框架的整合，我们将在后续文章中继续探讨。欢迎关注交流，共同进步</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React 学习：父传子的单项数据流——props]]></title>    <link>https://juejin.cn/post/7586569284550934568</link>    <guid>https://juejin.cn/post/7586569284550934568</guid>    <pubDate>2025-12-23T00:58:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586569284550934568" data-draft-id="7586550947703275530" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React 学习：父传子的单项数据流——props"/> <meta itemprop="keywords" content="JavaScript,React.js,前端框架"/> <meta itemprop="datePublished" content="2025-12-23T00:58:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="南山安"/> <meta itemprop="url" content="https://juejin.cn/user/1795929588117962"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React 学习：父传子的单项数据流——props
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1795929588117962/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    南山安
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T00:58:03.000Z" title="Tue Dec 23 2025 00:58:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>最近在学习 React 的 props ，顺手整理了自己的一些学习代码和笔记。props 是 React 组件通信的核心，玩好了它，你写组件就会像搭积木一样顺手。今天这篇文章，就从最基础的用法开始讲起，一步步带你深入，还会结合实际代码例子来说明。顺便聊聊 React 19 前后的小变化、常见的 CSS 写法，以及那个超级好用的 children props。</p>
<p>文章基于我自己的学习项目，代码来自一个简单的 App，包含 Greeting、Card 和 Modal 组件。咱们边看代码边聊，绝对干货满满。</p>
<h2 data-id="heading-1">一、Props 是什么？为什么这么重要？（重点对比 state）</h2>
<p>在 React 里，组件要正常工作，就离不开“数据”。数据主要分两类：<strong>state</strong> 和 <strong>props</strong>。这两兄弟长得有点像，但用途和性格完全不一样，搞清楚它们的关系，你写组件时才会心里有底。</p>
<p>用大白话总结：</p>



































<table><thead><tr><th>对比项</th><th>state（状态）</th><th>props（属性）</th></tr></thead><tbody><tr><td><strong>是谁的？</strong></td><td>组件<strong>自己</strong>的私有数据</td><td>父组件<strong>传给</strong>子组件的数据</td></tr><tr><td><strong>能不能改？</strong></td><td>可以改（用 setState 或 useState）</td><td><strong>只读</strong>！子组件不能直接改</td></tr><tr><td><strong>改了会怎样？</strong></td><td>修改后组件会重新渲染</td><td>只有父组件重新传新值，子组件才会更新</td></tr><tr><td><strong>生命周期</strong></td><td>属于当前组件，组件销毁就没了</td><td>像“快递”一样，从父组件送到子组件</td></tr><tr><td><strong>典型用途</strong></td><td>表单输入值、开关状态、计数器等可变数据</td><td>配置信息、显示内容、回调函数等</td></tr></tbody></table>
<h3 data-id="heading-2">用生活例子比喻最清楚</h3>
<p>想象你家有个儿子（子组件）和老爸（父组件）：</p>
<ul>
<li><strong>state</strong> 就像儿子自己的零花钱：他自己赚的（或爸给的初始值），想怎么花就怎么花（修改），爸管不着。</li>
<li><strong>props</strong> 就像爸给儿子的任务和工具：爸说“今天帮我买瓶酱油，顺便带张电影票回来”，儿子只能按爸给的钱和要求去办，不能自己改任务（“我偏要买可乐”不行）。</li>
</ul>
<p>如果儿子想跟爸说“我买完了”或者“我需要更多钱”，那只能通过爸事先给的“传话方式”（回调函数）来沟通——这就引出了我们上次讲的“子传父”。</p>
<h3 data-id="heading-3">代码对比最直观</h3>
<p>来看同一个需求：显示一个问候语，可以改名字和欢迎词。</p>
<p><strong>用 state 的方式</strong>（数据在组件自己手里）：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> { useState } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">GreetingSelf</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [name, setName] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">'陌生人'</span>);
  <span class="hljs-keyword">const</span> [message, setMessage] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">'欢迎光临'</span>);

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Hello {name}<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>{message}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      
      {/* 自己改自己，超级自由 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">input</span> 
        <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"改名字"</span> 
        <span class="hljs-attr">onChange</span>=<span class="hljs-string">{(e)</span> =&gt;</span> setName(e.target.value)} 
      /&gt;
      <span class="hljs-tag">&lt;<span class="hljs-name">input</span> 
        <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"改欢迎词"</span> 
        <span class="hljs-attr">onChange</span>=<span class="hljs-string">{(e)</span> =&gt;</span> setMessage(e.target.value)} 
      /&gt;
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<p>这个组件完全自给自足，想改啥改啥。</p>
<p><strong>用 props 的方式</strong>（数据从外面传进来）：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Greeting</span>(<span class="hljs-params">{ name, message }</span>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Hello {name}<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>{message}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      
      {/* 这里不能改！想改得让父组件来 */}
      {/* <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">onChange</span>=<span class="hljs-string">...</span> /&gt;</span>  // 没用，props 是只读的 */}
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}

<span class="hljs-comment">// 父组件</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [name, setName] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">'keji'</span>);
  <span class="hljs-keyword">const</span> [message, setMessage] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">'欢迎来到腾讯'</span>);

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Greeting</span> <span class="hljs-attr">name</span>=<span class="hljs-string">{name}</span> <span class="hljs-attr">message</span>=<span class="hljs-string">{message}</span> /&gt;</span>
      
      {/* 只有这里能改，改了会重新传给子组件 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{name}</span> <span class="hljs-attr">onChange</span>=<span class="hljs-string">{(e)</span> =&gt;</span> setName(e.target.value)} /&gt;
      <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{message}</span> <span class="hljs-attr">onChange</span>=<span class="hljs-string">{(e)</span> =&gt;</span> setMessage(e.target.value)} /&gt;
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<p>看到区别了吗？</p>
<ul>
<li>用 state：组件内部自己管数据，适合独立的小部件。</li>
<li>用 props：组件变成“纯展示”工具，数据统一由父组件管理，适合复用（同一个 Greeting 可以给不同人用不同欢迎词）。</li>
</ul>
<h2 data-id="heading-4">二、React 19 之前：Props 的经典玩法</h2>
<p>在 React 18 及更早版本，props 用法已经很成熟了：</p>
<ol>
<li>
<p><strong>解构 props</strong>：直接在参数里解构，用起来最爽。</p>
</li>
<li>
<p><strong>默认值</strong>：两种方式</p>
<ul>
<li>ES6 默认参数：message = "默认值"</li>
<li>defaultProps（静态属性，已被废弃）</li>
</ul>
<p>示例（旧方式）：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-title class_">Greeting</span>.<span class="hljs-property">defaultProps</span> = {
  <span class="hljs-attr">message</span>: <span class="hljs-string">"欢迎来到字节"</span>
};
</code></pre>
</li>
<li>
<p><strong>类型检查</strong>：用 prop-types 包</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">PropTypes</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"prop-types"</span>;

<span class="hljs-title class_">Greeting</span>.<span class="hljs-property">propTypes</span> = {
  <span class="hljs-attr">name</span>: <span class="hljs-title class_">PropTypes</span>.<span class="hljs-property">string</span>.<span class="hljs-property">isRequired</span>,
  <span class="hljs-attr">message</span>: <span class="hljs-title class_">PropTypes</span>.<span class="hljs-property">string</span>,
};
</code></pre>
<p>开发模式下，如果传错类型会警告，很实用。</p>
</li>
<li>
<p><strong>传任意数据</strong>：字符串、数字、对象、函数、甚至 JSX 都可以。</p>
</li>
</ol>
<h2 data-id="heading-5">三、React 19 之后：Props 的小变化（更简洁了）</h2>
<p>React 19（2024 年 12 月稳定发布）对 props 本身的核心机制没大改，但有一些清理和改进，让代码更现代：</p>
<ul>
<li>
<p><strong>移除 propTypes 和 defaultProps</strong>：这些早在 React 15.5 就被标记废弃了，React 19 直接从 React 包里删掉。以后用的话不会报错，但完全没效果。</p>
<ul>
<li>推荐：用 TypeScript 做静态类型检查，或者继续用独立的 prop-types 包（手动检查）。</li>
<li>默认值统一用 ES6 默认参数，更简洁。</li>
</ul>
</li>
<li>
<p><strong>ref 现在可以直接作为 prop 传</strong>（超级实用！） 以前，函数组件想接收 ref 必须裹一层 forwardRef：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// React 18</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">MyInput</span> = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">forwardRef</span>(<span class="hljs-function">(<span class="hljs-params">props, ref</span>) =&gt;</span> (
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">{ref}</span> {<span class="hljs-attr">...props</span>} /&gt;</span></span>
));
</code></pre>
<p>React 19 后，函数组件直接收 ref，像 children 一样自然：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// React 19</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">MyInput</span>(<span class="hljs-params">{ ref, ...props }</span>) {
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">{ref}</span> {<span class="hljs-attr">...props</span>} /&gt;</span></span>;
}
</code></pre>
<p>少了好多样板代码，官方还提供了 codemod 自动迁移。</p>
</li>
</ul>
<p>其他 props 相关的小优化：对 Custom Elements（Web Components）的支持更好，props 会优先作为 property 传，而不是 attribute。</p>
<p>总之，React 19 的 props 更干净、更贴近现代 JS。如果你还在用老项目，建议升级时跑一下官方 codemod。</p>
<h2 data-id="heading-6">四、React Props 的各种“边界情况”详解：不传、传了不用、没给值会发生什么？</h2>
<p>在实际写代码时，props 的这些“边缘情况”经常让人摸不着头脑。今天我们就一个个拆开看，结合真实代码和控制台输出，告诉你到底会发生什么，以及怎么避免坑。</p>
<h4 data-id="heading-7">1. 不传某个 prop（完全没写）</h4>
<p><strong>情况</strong>：父组件使用子组件时，压根没写这个 prop。</p>
<p><strong>结果</strong>：子组件收到这个 prop 的值是 <strong>undefined</strong>。</p>
<p><strong>例子</strong>：</p>
<p>子组件 Greeting.jsx：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Greeting</span>(<span class="hljs-params">{ name, message, showIcon }</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>({ name, message, showIcon });  <span class="hljs-comment">// 关键看这里</span>

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Hello {name}<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>{message}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      {showIcon &amp;&amp; <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>👋<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>}
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<p>父组件这样用：</p>
<pre><code class="hljs language-jsx" lang="jsx">&lt;<span class="hljs-title class_">Greeting</span> /&gt;
</code></pre>
<p>控制台输出：</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript">{ <span class="hljs-attr">name</span>: <span class="hljs-literal">undefined</span>, <span class="hljs-attr">message</span>: <span class="hljs-literal">undefined</span>, <span class="hljs-attr">showIcon</span>: <span class="hljs-literal">undefined</span> }
</code></pre>
<p>页面显示：</p>
<pre><code class="hljs language-text" lang="text">Hello          // 空
               // 空
</code></pre>
<p><strong>结论</strong>：不传 = undefined，不会报错，但显示会很丑。</p>
<h4 data-id="heading-8">2. 传了 prop 但子组件没用（写了但没解构/使用）</h4>
<p><strong>情况</strong>：父组件传了值，但子组件参数里没接收它。</p>
<p><strong>结果</strong>：传的值会丢失，子组件根本拿不到。</p>
<p><strong>例子</strong>：</p>
<p>父组件：</p>
<pre><code class="hljs language-jsx" lang="jsx">&lt;<span class="hljs-title class_">Greeting</span> name=<span class="hljs-string">"小明"</span> message=<span class="hljs-string">"欢迎"</span> /&gt;
</code></pre>
<p>子组件故意不接收 name：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Greeting</span>(<span class="hljs-params">{ message }</span>) {  <span class="hljs-comment">// 只解构了 message，name 被忽略</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>({ message });

  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Hello {message}<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span>;
}
</code></pre>
<p>控制台输出：</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript">{ <span class="hljs-attr">message</span>: <span class="hljs-string">"欢迎"</span> }
</code></pre>
<p>name 的值“小明”直接丢了，子组件完全不知道有这个 prop。</p>
<p><strong>另一种写法</strong>（用 props 对象）：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Greeting</span>(<span class="hljs-params">props</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(props);  <span class="hljs-comment">// { name: "小明", message: "欢迎" }</span>

  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Hello {props.message}<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span>;  <span class="hljs-comment">// 只用了 message</span>
}
</code></pre>
<p>这种情况下 props 对象里是有 name 的，但如果你没用它，就白传了。</p>
<p><strong>结论</strong>：传了但没用 = 白传，浪费性能（轻微），代码易混淆。</p>
<h4 data-id="heading-9">3. 传了 prop 但没给值（）</h4>
<p><strong>情况</strong>：写了 prop 名，但没赋值（布尔类型常见）。</p>
<p><strong>结果</strong>：React 会自动把这个 prop 的值设为 <strong>true</strong>。</p>
<p><strong>例子</strong>：</p>
<p>父组件：</p>
<pre><code class="hljs language-jsx" lang="jsx">&lt;<span class="hljs-title class_">Greeting</span> showIcon /&gt;        <span class="hljs-comment">// 没写 =true</span>
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Greeting</span> <span class="hljs-attr">showIcon</span>=<span class="hljs-string">{true}</span> /&gt;</span></span> <span class="hljs-comment">// 显式写 true</span>
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Greeting</span> <span class="hljs-attr">showIcon</span>=<span class="hljs-string">{false}</span> /&gt;</span></span><span class="hljs-comment">// 显式写 false</span>
</code></pre>
<p>子组件：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Greeting</span>(<span class="hljs-params">{ showIcon }</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>({ showIcon });

  <span class="hljs-keyword">return</span> showIcon &amp;&amp; <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>👋<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span></span>;
}
</code></pre>
<p>三种写法的控制台输出：</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript">{ <span class="hljs-attr">showIcon</span>: <span class="hljs-literal">true</span> }     <span class="hljs-comment">// &lt;Greeting showIcon /&gt;</span>
{ <span class="hljs-attr">showIcon</span>: <span class="hljs-literal">true</span> }     <span class="hljs-comment">// &lt;Greeting showIcon={true} /&gt;</span>
{ <span class="hljs-attr">showIcon</span>: <span class="hljs-literal">false</span> }    <span class="hljs-comment">// &lt;Greeting showIcon={false} /&gt;</span>
</code></pre>
<p><strong>结论</strong>：在 JSX 中， 等价于 。这是 React 的语法糖，超级常见于开关类 prop（如 disabled、checked、selected 等）。</p>
<h4 data-id="heading-10">4. 给了默认值的情况（ES6 默认参数）</h4>
<p><strong>情况</strong>：不传或传 undefined 时，用默认值兜底。</p>
<p><strong>例子</strong>：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Greeting</span>(<span class="hljs-params">{ 
  name = <span class="hljs-string">"陌生人"</span>, 
  message = <span class="hljs-string">"欢迎光临"</span>, 
  showIcon = <span class="hljs-literal">false</span> 
}</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>({ name, message, showIcon });

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Hello {name}<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>{message}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      {showIcon &amp;&amp; <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>👋<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>}
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<p>测试几种调用：</p>
<pre><code class="hljs language-jsx" lang="jsx">&lt;<span class="hljs-title class_">Greeting</span> /&gt;                          <span class="hljs-comment">// 全不传</span>
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Greeting</span> <span class="hljs-attr">name</span>=<span class="hljs-string">{undefined}</span> /&gt;</span></span>         <span class="hljs-comment">// 显式传 undefined</span>
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Greeting</span> <span class="hljs-attr">name</span>=<span class="hljs-string">""</span> /&gt;</span></span>                  <span class="hljs-comment">// 传空字符串（不会用默认）</span>
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Greeting</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"小明"</span> /&gt;</span></span>
</code></pre>
<p>控制台输出：</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript">{ <span class="hljs-attr">name</span>: <span class="hljs-string">"陌生人"</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">"欢迎光临"</span>, <span class="hljs-attr">showIcon</span>: <span class="hljs-literal">false</span> }
{ <span class="hljs-attr">name</span>: <span class="hljs-string">"陌生人"</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">"欢迎光临"</span>, <span class="hljs-attr">showIcon</span>: <span class="hljs-literal">false</span> }  <span class="hljs-comment">// undefined 触发默认</span>
{ <span class="hljs-attr">name</span>: <span class="hljs-string">""</span>,       <span class="hljs-attr">message</span>: <span class="hljs-string">"欢迎光临"</span>, <span class="hljs-attr">showIcon</span>: <span class="hljs-literal">false</span> }  <span class="hljs-comment">// 空字符串不会触发默认</span>
{ <span class="hljs-attr">name</span>: <span class="hljs-string">"小明"</span>,   <span class="hljs-attr">message</span>: <span class="hljs-string">"欢迎光临"</span>, <span class="hljs-attr">showIcon</span>: <span class="hljs-literal">false</span> }
</code></pre>
<p><strong>关键点</strong>：只有 <strong>undefined</strong> 才会触发 ES6 默认值。传 null、""、false、0 都不会触发默认值。</p>
<h4 data-id="heading-11">5. 总结表格（一目了然）</h4>





















































<table><thead><tr><th>父组件写法</th><th>子组件收到值</th><th>是否触发默认值</th><th>说明</th></tr></thead><tbody><tr><td>不写 prop</td><td>undefined</td><td>是</td><td>最常见坑</td></tr><tr><td>&lt; Comp flag /&gt;</td><td>true</td><td>-</td><td>布尔 prop 的语法糖</td></tr><tr><td>&lt; Comp flag={true/false} /&gt;</td><td>true / false</td><td>-</td><td>显式控制</td></tr><tr><td>&lt; Comp name={undefined} /&gt;</td><td>undefined</td><td>是</td><td>显式传 undefined 也会触发默认</td></tr><tr><td>&lt; Comp name="" /&gt;</td><td>""（空字符串）</td><td>否</td><td>传了具体值，就不会用默认</td></tr><tr><td>&lt; Comp name={null} /&gt;</td><td>null</td><td>否</td><td>null 是合法值，不会触发默认</td></tr><tr><td>传了 prop 但子组件没接收</td><td>拿不到（丢失）</td><td>-</td><td>代码 bug，建议用 TS 或 PropTypes 检查</td></tr></tbody></table>
<h2 data-id="heading-12">五、children：最强大的 props</h2>
<p>children 是 React 自动传给你的一个特殊 prop，代表组件标签之间的内容。它让组件超级灵活，能“插槽”任意 JSX。</p>
<p><strong>Card 组件</strong>：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-title class_">App</span>.<span class="hljs-property">jsx</span>
&lt;<span class="hljs-title class_">Card</span> className=<span class="hljs-string">"user-card"</span>&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>张三<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span></span>
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>高级前端工程师<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span>
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span>&gt;</span>查看详情<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>
&lt;/<span class="hljs-title class_">Card</span>&gt;
</code></pre>
<p><strong>Card 实现</strong>：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">//Card.jsx</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">Card</span> = (<span class="hljs-params">{ children, className = <span class="hljs-string">""</span> }</span>) =&gt; {
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{</span>`<span class="hljs-attr">card</span> ${<span class="hljs-attr">className</span>}`}&gt;</span>{children}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
};
</code></pre>
<p>其中,{children}就是</p>
<pre><code class="hljs language-jsx" lang="jsx">  &lt;h2&gt;张三&lt;/h2&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>高级前端工程师<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span>
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span>&gt;</span>查看详情<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>
</code></pre>
<p>直接把父组件传的 JSX 原样渲染出来，完美封装卡片样式。</p>
<p><strong>Modal 组件</strong>（更高级的定制）： 我们想让 Modal 支持自定义 header 和 footer：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">//App.jsx</span>
&lt;<span class="hljs-title class_">Modal</span> <span class="hljs-title class_">HeaderComponent</span>={<span class="hljs-title class_">MyHeader</span>} <span class="hljs-title class_">FooterComponent</span>={<span class="hljs-title class_">MyFooter</span>}&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>这是一个弹窗<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span>
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>你可以在这里显示任何JSX<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span>
&lt;/<span class="hljs-title class_">Modal</span>&gt;
</code></pre>
<p>Modal 实现：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">//Modal.jsx</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">Modal</span>(<span class="hljs-params">{ HeaderComponent, FooterComponent, children }</span>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{styles.overlay}</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{styles.modal}</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">HeaderComponent</span> /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{styles.content}</span>&gt;</span>{children}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">FooterComponent</span> /&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<p>这里 children 就是弹窗正文内容，而 Header/Footer 是通过 props 传组件，实现高度定制。</p>
<p>children 的威力在于：它让你的组件像“容器”一样，能包裹任意内容。Ant Design、Material UI 的很多组件都靠它实现灵活性。</p>
<h2 data-id="heading-13">六、React 中常见的 CSS 样式写法</h2>
<p>React 是“CSS in JS”的鼻祖，样式写法灵活多变。来看几种常见方式，各有优缺点：</p>
<ol>
<li>
<p><strong>内联样式（style 对象）</strong> —— 最简单，直接在 JSX 里写</p>
<pre><code class="hljs language-jsx" lang="jsx">&lt;h2 style={{ <span class="hljs-attr">margin</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">color</span>: <span class="hljs-string">"blue"</span> }}&gt;自定义标题&lt;/h2&gt;
</code></pre>
<p>适合快速原型或动态样式（比如根据 props 变色）。缺点：没法用伪类（如 :hover），写多了很乱。</p>
</li>
<li>
<p><strong>单独 CSS 文件 + className</strong> —— 传统方式，最常见 看 Card.jsx 和 Card.css：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> <span class="hljs-string">"./Card.css"</span>;

<span class="hljs-keyword">const</span> <span class="hljs-title function_">Card</span> = (<span class="hljs-params">{ children, className = <span class="hljs-string">""</span> }</span>) =&gt; {
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{</span>`<span class="hljs-attr">card</span> ${<span class="hljs-attr">className</span>}`}&gt;</span>{children}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
};
</code></pre>
<p>CSS 文件里写：</p>
<pre><code class="hljs language-CSS" lang="CSS"><span class="hljs-selector-class">.card</span> {
  <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#ffffff</span>;
  <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">12px</span>;
  <span class="hljs-attribute">box-shadow</span>: <span class="hljs-number">0</span> <span class="hljs-number">4px</span> <span class="hljs-number">12px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0.1</span>);
  <span class="hljs-comment">/* ... */</span>
}

<span class="hljs-selector-class">.card</span><span class="hljs-selector-pseudo">:hover</span> {
  <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translateY</span>(-<span class="hljs-number">4px</span>);
  <span class="hljs-comment">/* 悬停效果 */</span>
}
</code></pre>
<p>优点：支持所有 CSS 特性（伪类、媒体查询），易维护。缺点：类名冲突风险（可以用 CSS Modules 解决）。</p>
</li>
<li>
<p><strong>CSS in JS（对象样式）</strong></p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">const</span> styles = {
  <span class="hljs-attr">overlay</span>: { <span class="hljs-attr">backgroundColor</span>: <span class="hljs-string">"rgba(0,0,0,0.5)"</span>, <span class="hljs-comment">/* ... */</span> },
  <span class="hljs-attr">modal</span>: { <span class="hljs-attr">backgroundColor</span>: <span class="hljs-string">"white"</span>, <span class="hljs-comment">/* ... */</span> },
};

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{styles.overlay}</span>&gt;</span>...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
</code></pre>
<p>优点：样式作用域天然隔离，动态样式超方便。缺点：运行时开销稍大，伪类支持差（需要额外库如 styled-components）。</p>
</li>
<li>
<p><strong>其他流行方案</strong>：</p>
<ul>
<li><strong>styled-components</strong> 或 <strong>emotion</strong>：写模板字符串，兼顾作用域和伪类。</li>
<li><strong>Tailwind CSS</strong>：utility-first，直接在 className 里堆类。</li>
<li><strong>CSS Modules</strong>：自动生成唯一类名，避免冲突。</li>
</ul>
</li>
</ol>
<p>个人建议：小项目内联或单独 CSS 够用，中大型项目推荐 CSS Modules + Tailwind，或者 styled-components。</p>
<h2 data-id="heading-14">最后总结</h2>
<p>props 是 React 的灵魂，掌握它你就掌握了组件通信。默认值、类型检查、children 这些细节用好了，代码会优雅很多。React 19 把一些老古董清理掉，鼓励我们写更现代的代码（ES6 默认 + TS）。</p>
<p>如果你也在学 React，建议自己动手搭几个组件玩玩 props 和 children，感觉完全不一样。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[终点、光圈与 Lottie 生命周期：复杂关闭动效的「收尾工程」]]></title>    <link>https://juejin.cn/post/7586582977707474986</link>    <guid>https://juejin.cn/post/7586582977707474986</guid>    <pubDate>2025-12-23T00:55:57.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586582977707474986" data-draft-id="7586491717874253843" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="终点、光圈与 Lottie 生命周期：复杂关闭动效的「收尾工程」"/> <meta itemprop="keywords" content="HarmonyOS"/> <meta itemprop="datePublished" content="2025-12-23T00:55:57.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Archilect"/> <meta itemprop="url" content="https://juejin.cn/user/1505660538979515"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            终点、光圈与 Lottie 生命周期：复杂关闭动效的「收尾工程」
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1505660538979515/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Archilect
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T00:55:57.000Z" title="Tue Dec 23 2025 00:55:57 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">终点、光圈与 Lottie 生命周期：复杂关闭动效的「收尾工程」</h2>
<blockquote>
<p>关键词：ArkUI、ETS、Lottie、Canvas、生命周期、健壮性</p>
</blockquote>
<p>在多阶段关闭动效中，「从哪儿飞出去」只是前半程；<br/>
<strong>真正让用户觉得自然的，是「飞到哪儿」以及「怎么在终点收尾」。</strong></p>
<p>这一篇我们聚焦三件事：</p>
<ul>
<li>终点区域如何抽象为一个通用的 <code>TargetRect</code>；</li>
<li>从 <code>TargetRect</code> 推导出 icon 的终点坐标和光圈（halo）的大小与偏移；</li>
<li>Lottie/Canvas 在 ArkUI 场景下的生命周期管理与健壮性设计。
<em>TL;DR：用 TargetRect 描述落点 → 算出 icon/halo 参数 → 把 Lottie 生命周期与事件兜底串起来，就能让关闭动画有一个“扎实的落点”。</em></li>
</ul>
<hr/>
<h3 data-id="heading-1">一、终点抽象：TargetRect 而不是「某业务组件」</h3>
<p>在具体业务中，关闭动效的终点可能是：</p>
<ul>
<li>首页某个「入口图标」；</li>
<li>底部 Tab 上的一个按钮；</li>
<li>页面内的某个卡片收纳位。</li>
</ul>
<p>但在动效引擎里，我们不想知道这些细节，只希望拿到一个<strong>抽象的矩形</strong>：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">TargetRect</span> {
  <span class="hljs-attr">x</span>: <span class="hljs-built_in">number</span>    <span class="hljs-comment">// 左上角 x</span>
  <span class="hljs-attr">y</span>: <span class="hljs-built_in">number</span>    <span class="hljs-comment">// 左上角 y</span>
  <span class="hljs-attr">width</span>: <span class="hljs-built_in">number</span>
  <span class="hljs-attr">height</span>: <span class="hljs-built_in">number</span>
}
</code></pre>
<p>外部世界（原生层/业务组件）通过某种回调把 <code>TargetRect</code> 提供给动效引擎：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">TargetResolver</span> = <span class="hljs-function">() =&gt;</span> <span class="hljs-title class_">TargetRect</span> | <span class="hljs-literal">null</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">CloseAnimationEngine</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"><span class="hljs-keyword">private</span> resolveTarget: TargetResolver</span>) {}

  <span class="hljs-title function_">initTargetArea</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> rect = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">resolveTarget</span>()
    <span class="hljs-keyword">if</span> (!rect || rect.<span class="hljs-property">width</span> &lt;= <span class="hljs-number">0</span> || rect.<span class="hljs-property">height</span> &lt;= <span class="hljs-number">0</span>) {
      <span class="hljs-comment">// 非法参数，后续走兜底关闭</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">markTargetInvalid</span>()
      <span class="hljs-keyword">return</span>
    }
    <span class="hljs-comment">// 后续基于 rect 计算终点和光圈</span>
  }
}
</code></pre>
<blockquote>
<p>设计要点：</p>
<ul>
<li>动效引擎只接收 <code>TargetRect</code>，不直接依赖任何具体组件或业务字段；</li>
<li>参数在入口处就做完校验，后续逻辑只处理「合法的矩形」或「无终点（走兜底）」两种情况。</li>
</ul>
</blockquote>
<hr/>
<h3 data-id="heading-2">二、从 TargetRect 到 icon 终点：中心对齐与缩放后的尺寸</h3>
<p>假设我们最终要让一个缩小后的弹窗内容（或者独立 icon）落在 <code>TargetRect</code> 中央；<br/>
并且这个 icon 本身也会有一个缩放比例 <code>finalScale</code>（例如 0.3），对应某个容器宽高 <code>contentWidth/Height</code>。</p>
<p>我们希望：</p>
<ul>
<li>icon 缩放后的视觉矩形，刚好居中放在 <code>TargetRect</code> 中；</li>
<li>即使 <code>TargetRect</code> 很小，icon 也不会太小看不见（这一点可交给业务配置兜底）。</li>
</ul>
<p>中心对齐的计算可以写成：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">function</span> <span class="hljs-title function_">computeIconEndPosition</span>(<span class="hljs-params">
  rect: TargetRect,
  contentSize: { width: <span class="hljs-built_in">number</span>; height: <span class="hljs-built_in">number</span> },
  finalScale: <span class="hljs-built_in">number</span>,
</span>): { <span class="hljs-attr">x</span>: <span class="hljs-built_in">number</span>; <span class="hljs-attr">y</span>: <span class="hljs-built_in">number</span> } {
  <span class="hljs-keyword">const</span> scaledWidth = contentSize.<span class="hljs-property">width</span> * finalScale
  <span class="hljs-keyword">const</span> scaledHeight = contentSize.<span class="hljs-property">height</span> * finalScale

  <span class="hljs-keyword">const</span> offsetX = (rect.<span class="hljs-property">width</span> - scaledWidth) / <span class="hljs-number">2</span>
  <span class="hljs-keyword">const</span> offsetY = (rect.<span class="hljs-property">height</span> - scaledHeight) / <span class="hljs-number">2</span>

  <span class="hljs-keyword">const</span> endX = rect.<span class="hljs-property">x</span> + offsetX
  <span class="hljs-keyword">const</span> endY = rect.<span class="hljs-property">y</span> + offsetY

  <span class="hljs-keyword">return</span> { <span class="hljs-attr">x</span>: endX, <span class="hljs-attr">y</span>: endY }
}
</code></pre>
<p>这只解决了「缩放后矩形和目标矩形中心对齐」的问题。<br/>
结合上一篇的缩放偏移修正，我们会进一步把这个 <code>endX/endY</code> 输入到 <code>applyScaleOffset</code> 中，得到最终供 <code>motionPath</code> 使用的终点坐标。</p>
<p>逻辑链条可以用 mermaid 简单表示为：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
  A[TargetRect(x,y,w,h)] --&gt; B[icon缩放尺寸&lt;br/&gt;scaledW,scaledH]
  B --&gt; C[中心对齐&lt;br/&gt;endX = x + (w - scaledW)/2]
  C --&gt; D[缩放偏移修正&lt;br/&gt;feed into motionPath endPoint]
</code></pre>
<blockquote>
<p>若平台不支持 mermaid，可复制到 <a href="https://link.juejin.cn?target=https%3A%2F%2Fmermaid.live" target="_blank" title="https://mermaid.live" ref="nofollow noopener noreferrer">mermaid.live</a> 查看示意。</p>
</blockquote>
<hr/>
<h3 data-id="heading-3">三、光圈（Halo）：既要包住目标，又不能小得看不见</h3>
<p>在终点，我们希望有一个「光圈收尾」：</p>
<ul>
<li>光圈以 icon 为中心；</li>
<li>光圈的直径至少要覆盖 <code>TargetRect</code>；</li>
<li>同时不能小于一个视觉兜底值（例如 132vp）。</li>
</ul>
<p>因此可以这样计算：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">function</span> <span class="hljs-title function_">computeHalo</span>(<span class="hljs-params">
  rect: TargetRect,
  contentSize: { width: <span class="hljs-built_in">number</span>; height: <span class="hljs-built_in">number</span> },
  finalScale: <span class="hljs-built_in">number</span>,
  minDiameter: <span class="hljs-built_in">number</span>,
</span>) {
  <span class="hljs-keyword">const</span> scaledWidth = contentSize.<span class="hljs-property">width</span> * finalScale
  <span class="hljs-keyword">const</span> scaledHeight = contentSize.<span class="hljs-property">height</span> * finalScale

  <span class="hljs-keyword">const</span> haloDiameter = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(rect.<span class="hljs-property">width</span>, rect.<span class="hljs-property">height</span>, minDiameter)

  <span class="hljs-comment">// 为了让halo中心对齐icon，需要在渲染时做一个偏移</span>
  <span class="hljs-keyword">const</span> haloOffsetX = -(haloDiameter - scaledWidth) / <span class="hljs-number">2</span>
  <span class="hljs-keyword">const</span> haloOffsetY = -(haloDiameter - scaledHeight) / <span class="hljs-number">2</span>

  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">diameter</span>: haloDiameter,
    <span class="hljs-attr">offsetX</span>: haloOffsetX,
    <span class="hljs-attr">offsetY</span>: haloOffsetY,
  }
}
</code></pre>
<p>在渲染层（比如一个 Canvas 容器）中，我们可以这样使用：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-title class_">Canvas</span>(haloCanvasContext)
  .<span class="hljs-title function_">size</span>({ <span class="hljs-attr">width</span>: halo.<span class="hljs-property">diameter</span>, <span class="hljs-attr">height</span>: halo.<span class="hljs-property">diameter</span> })
  .<span class="hljs-title function_">offset</span>({ <span class="hljs-attr">x</span>: halo.<span class="hljs-property">offsetX</span>, <span class="hljs-attr">y</span>: halo.<span class="hljs-property">offsetY</span> })
</code></pre>
<p>配合上一节的 icon 终点坐标，整体效果就是：</p>
<ul>
<li>icon 落在 <code>TargetRect</code> 中心；</li>
<li>光圈以 icon 为中心扩散，直径至少覆盖目标区域；</li>
<li>在小目标上仍有足够的视觉存在感。</li>
</ul>
<hr/>
<h3 data-id="heading-4">四、形态切换：dialog → icon → lottie</h3>
<p>在关闭动效过程中，我们通常会有三种形态：</p>
<ul>
<li><code>dialog</code>：原始弹窗形态（矩形卡片）；</li>
<li><code>icon</code>：缩小后的图标形态；</li>
<li><code>lottie</code>：终点光圈形态（由 Lottie 播放）。</li>
</ul>
<p>在 ArkUI 这类声明式 UI 框架中，比较推荐的做法是：</p>
<ul>
<li>在 UI 层用一个 <code>form</code> 状态描述当前形态；</li>
<li>用 <code>if/else</code> 或 <code>switch</code> 决定当前需要渲染哪个子树；</li>
<li>在动效引擎中只修改 <code>form</code>，而不直接操控具体 UI 组件。</li>
</ul>
<p>伪代码示例：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 状态</span>
<span class="hljs-meta">@State</span> <span class="hljs-attr">form</span>: <span class="hljs-string">'dialog'</span> | <span class="hljs-string">'icon'</span> | <span class="hljs-string">'lottie'</span> = <span class="hljs-string">'dialog'</span>

<span class="hljs-title function_">build</span>(<span class="hljs-params"/>) {
  <span class="hljs-title class_">Column</span>() {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">form</span> === <span class="hljs-string">'dialog'</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">buildDialogContent</span>()
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">form</span> === <span class="hljs-string">'icon'</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">buildIcon</span>()
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">form</span> === <span class="hljs-string">'lottie'</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">buildHalo</span>()
    }
  }
}
</code></pre>
<p>在动效引擎里，形态切换大致是这样：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 缩小完成后切换到 icon 形态</span>
stepMap.<span class="hljs-property">switchToIcon</span> = {
  <span class="hljs-attr">change</span>: <span class="hljs-function">() =&gt;</span> {
    state.<span class="hljs-property">form</span> = <span class="hljs-string">'icon'</span>
  },
  <span class="hljs-attr">animateParam</span>: { <span class="hljs-attr">duration</span>: <span class="hljs-number">100</span>, <span class="hljs-attr">onFinish</span>: <span class="hljs-function">() =&gt;</span> stepper.<span class="hljs-title function_">start</span>([<span class="hljs-string">'wobbleIcon'</span>]) },
}

<span class="hljs-comment">// 抛掷完成后，如果需要光圈，则切换到 lottie 形态</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">onThrowFinished</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">if</span> (config.<span class="hljs-property">enableHalo</span>) {
    state.<span class="hljs-property">form</span> = <span class="hljs-string">'lottie'</span>
    <span class="hljs-comment">// 更新容器尺寸为halo直径，重置scale等</span>
    state.<span class="hljs-property">containerSize</span> = halo.<span class="hljs-property">diameter</span>
    state.<span class="hljs-property">scale</span> = <span class="hljs-number">1</span>
  } <span class="hljs-keyword">else</span> {
    events.<span class="hljs-title function_">emit</span>(<span class="hljs-string">'closeAnimationFinished'</span>)
  }
}
</code></pre>
<p>这样可以确保：</p>
<ul>
<li>UI 结构对形态高度敏感：哪种形态就渲染哪种子树，不会「残留」；</li>
<li>动效引擎只修改状态，UI 渲染由框架接管，符合声明式范式。</li>
</ul>
<hr/>
<h3 data-id="heading-5">五、Lottie + Canvas：在 ArkUI 中管理动画资源</h3>
<p>光圈本身通常是通过 Lottie 实现的，ArkUI 提供了基于 Canvas 渲染 Lottie 的能力。<br/>
一个通用的做法是：</p>
<ul>
<li>在 UI 层用一个 Canvas 组件作为容器；</li>
<li>在 Canvas <code>onReady</code> 时初始化 Lottie 动画；</li>
<li>在 Canvas <code>onDisappear</code> 时销毁 Lottie 实例。</li>
</ul>
<p>伪代码：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-meta">@Builder</span>
<span class="hljs-title function_">buildHalo</span>(<span class="hljs-params"/>) {
  <span class="hljs-title class_">Canvas</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">haloCanvasContext</span>)
    .<span class="hljs-title function_">size</span>({ <span class="hljs-attr">width</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">halo</span>.<span class="hljs-property">diameter</span>, <span class="hljs-attr">height</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">halo</span>.<span class="hljs-property">diameter</span> })
    .<span class="hljs-title function_">offset</span>({ <span class="hljs-attr">x</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">halo</span>.<span class="hljs-property">offsetX</span>, <span class="hljs-attr">y</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">halo</span>.<span class="hljs-property">offsetY</span> })
    .<span class="hljs-title function_">onReady</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">initHaloLottie</span>())
    .<span class="hljs-title function_">onDisAppear</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">destroyHaloLottie</span>())
}
</code></pre>
<p>对应的 Lottie 生命周期管理：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-title function_">initHaloLottie</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> sourcePath = <span class="hljs-string">'halo.json'</span>
  <span class="hljs-keyword">let</span> <span class="hljs-attr">rawContent</span>: <span class="hljs-title class_">Uint8Array</span> | <span class="hljs-literal">undefined</span>

  <span class="hljs-keyword">try</span> {
    rawContent = uiContext.<span class="hljs-title function_">getHostContext</span>()?.<span class="hljs-property">resourceManager</span>.<span class="hljs-title function_">getRawFileContentSync</span>(sourcePath)
  } <span class="hljs-keyword">catch</span> (error) {
    logger.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Failed to load halo lottie file'</span>, error)
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">emitCloseFinished</span>() <span class="hljs-comment">// 资源异常时直接兜底关闭</span>
    <span class="hljs-keyword">return</span>
  }

  <span class="hljs-keyword">const</span> jsonText = <span class="hljs-title class_">TextDecoder</span>.<span class="hljs-title function_">create</span>(<span class="hljs-string">'utf-8'</span>).<span class="hljs-title function_">decodeToString</span>(rawContent)
  <span class="hljs-keyword">const</span> animationData = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(jsonText)

  <span class="hljs-comment">// 避免重复实例</span>
  lottie.<span class="hljs-title function_">destroy</span>(<span class="hljs-string">'halo'</span>)

  <span class="hljs-variable language_">this</span>.<span class="hljs-property">animationItem</span> = lottie.<span class="hljs-title function_">loadAnimation</span>({
    <span class="hljs-attr">name</span>: <span class="hljs-string">'halo'</span>,
    animationData,
    <span class="hljs-attr">container</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">haloCanvasContext</span>,
    <span class="hljs-attr">renderer</span>: <span class="hljs-string">'canvas'</span>,
    <span class="hljs-attr">autoplay</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">loop</span>: <span class="hljs-literal">false</span>,
    <span class="hljs-attr">frameRate</span>: <span class="hljs-number">60</span>,
  })

  <span class="hljs-variable language_">this</span>.<span class="hljs-property">animationItem</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'complete'</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">emitCloseFinished</span>()
  })
}

<span class="hljs-title function_">destroyHaloLottie</span>(<span class="hljs-params"/>) {
  lottie.<span class="hljs-title function_">destroy</span>(<span class="hljs-string">'halo'</span>)
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">animationItem</span> = <span class="hljs-literal">undefined</span>
}
</code></pre>
<p>关键点：</p>
<ul>
<li>每次加载前先 <code>destroy</code> 同名实例，避免重复占用资源；</li>
<li>Lottie 生命周期与 Canvas 生命周期严格绑定，Canvas 消失时必须销毁动画；</li>
<li>complete 事件触发关闭完成信号，超时兜底（见下一节）则作为 backup。</li>
</ul>
<hr/>
<h3 data-id="heading-6">六、健壮性设计：一次性事件、非法参数、超时兜底</h3>
<p>复杂动效最怕的不是「不够炫」，而是「出问题时把用户卡死在半路」。<br/>
为了让关闭动效可靠可控，我们在设计时刻意做了几件「防御性编程」的事情：</p>
<h4 data-id="heading-7">1. TargetRect 严格校验</h4>
<p>在 <code>resolveTarget</code> 返回值入口处就做完所有合法性校验：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> rect = <span class="hljs-title function_">resolveTarget</span>()
<span class="hljs-keyword">if</span> (!rect || rect.<span class="hljs-property">width</span> &lt;= <span class="hljs-number">0</span> || rect.<span class="hljs-property">height</span> &lt;= <span class="hljs-number">0</span>) {
  logger.<span class="hljs-title function_">warn</span>(<span class="hljs-string">'Invalid target rect, fallback to simple close'</span>)
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">useWhirlwind</span> = <span class="hljs-literal">false</span>   <span class="hljs-comment">// 或者标记为无终点</span>
}
</code></pre>
<p>这样后续所有计算都可以假定 <code>TargetRect</code> 是合法的，不必在各处重复判空。</p>
<h4 data-id="heading-8">2. 动效开始事件一次性消费</h4>
<p>无论是从原生层还是业务层发出的「开始关闭动效」信号，都建议：</p>
<ul>
<li>用一次性订阅（例如 <code>emitter.once</code>），防止一段生命周期内多次触发；</li>
<li>或者在动效引擎里加一个「运行中」状态标记，忽略后续重复触发。</li>
</ul>
<pre><code class="hljs language-ts" lang="ts">emitter.<span class="hljs-title function_">once</span>(<span class="hljs-string">'CLOSE_ANIMATION_START'</span>, <span class="hljs-function">(<span class="hljs-params">payload: CloseAnimPayload</span>) =&gt;</span> {
  <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">canRunWhirlwind</span>(payload)) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">emitCloseFinished</span>()
    <span class="hljs-keyword">return</span>
  }
  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">startWithPayload</span>(payload)
})
</code></pre>
<h4 data-id="heading-9">3. 超时兜底：永远保证弹窗能被关闭</h4>
<p>即使我们做了完整的 complete 监听，也难以避免以下情况：</p>
<ul>
<li>Lottie 内部异常，complete 不触发；</li>
<li>Canvas 提前销毁；</li>
<li>某个阶段被外部打断。</li>
</ul>
<p>因此在开始关闭动效时，可以同时启动一个「安全定时器」：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-title function_">startSafeTimeout</span>(<span class="hljs-params"/>) {
  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">closed</span>) {
      logger.<span class="hljs-title function_">warn</span>(<span class="hljs-string">'Close animation timeout, force close'</span>)
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">emitCloseFinished</span>()
    }
  }, <span class="hljs-number">3000</span>) <span class="hljs-comment">// 3秒兜底</span>
}
</code></pre>
<p>这样可以保证：<br/>
<strong>无论发生什么，用户最多等待一个固定的时间窗口，弹窗一定会被关闭。</strong></p>
<hr/>
<h3 data-id="heading-10">七、小结</h3>
<p>这一篇我们讲的都是「收尾工程」：</p>
<ul>
<li>把终点抽象为一个 <code>TargetRect</code>，与具体业务组件解耦；</li>
<li>从 <code>TargetRect</code> 推导出 icon 终点和光圈（halo）的尺寸与偏移，确保视觉上「打得准」且「包得住」；</li>
<li>在 ArkUI 中通过 Canvas + Lottie 实现光圈动画，并使用严格的生命周期管理保证资源可控；</li>
<li>通过一次性事件订阅、参数校验和超时兜底，让复杂动效在异常情况下仍然安全关闭。</li>
</ul>
<p>到这里，Whirlwind 式关闭动效的技术细节基本完整了：<br/>
时间轴上有 AnimationStepper 编排，空间上有双层容器和几何修正，终点有精确的目标映射和光圈收尾。</p>
<p>在最后一篇《性能 &amp; 工程化篇》中，我们会站到更高一层，从性能、埋点、灰度、配置和资源管理等角度，讨论如何把这种复杂动效做成「可以长期演进」的工程能力，而不是一次性的 Demo。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[nest初体验-用nest实现一个简单的CRUD功能]]></title>    <link>https://juejin.cn/post/7586559672129126452</link>    <guid>https://juejin.cn/post/7586559672129126452</guid>    <pubDate>2025-12-23T01:13:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586559672129126452" data-draft-id="7582863493260427316" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="nest初体验-用nest实现一个简单的CRUD功能"/> <meta itemprop="keywords" content="前端,Node.js,全栈"/> <meta itemprop="datePublished" content="2025-12-23T01:13:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="jun_不见"/> <meta itemprop="url" content="https://juejin.cn/user/3263006244609502"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            nest初体验-用nest实现一个简单的CRUD功能
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3263006244609502/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    jun_不见
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T01:13:37.000Z" title="Tue Dec 23 2025 01:13:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读17分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><h2 data-id="heading-0">nest简介</h2>
<p>Nest是一个用于构建高效、可扩展的Node服务器端应用框架。它默认使用Express作为HTTP服务端框架，但是也可以支持Fastify作为替代，使用TypeScript构建并全面支持 TypeScript，同时仍允许开发者使用纯 JavaScript 编码，融合了 OOP（面向对象编程）、FP（函数式编程）和 FRP（函数响应式编程）等元素。它的核心目标是解决传统 Node.js 框架（如 Express/Koa）缺乏统一架构规范、大型项目代码易混乱的问题。</p>
<p>NestJS 采用了一种清晰的<strong>三层结构</strong>来组织应用逻辑，也就是MVC结构。</p>
<h3 data-id="heading-1">1. 模块 (Modules)</h3>
<ul>
<li>
<p><strong>作用：</strong> 模块是 NestJS 应用的<strong>基本组织单元</strong>。它们是具有 <code>@Module()</code> 装饰器的类，用于将应用的不同功能和特性（如用户管理、订单处理等）逻辑上划分为独立的、可重用的部分。</p>
</li>
<li>
<p><strong>职责：</strong> 模块负责<strong>组合</strong>控制器和服务（提供者），并定义一组功能。每个应用至少有一个<strong>根模块（Root Module）</strong> 。</p>
</li>
<li>
<p><strong>关键属性：</strong></p>
<ul>
<li><code>controllers</code>: 属于本模块的<strong>控制器</strong>。</li>
<li><code>providers</code>: 属于本模块的<strong>服务</strong>、仓库、工厂等（统称为<strong>提供者</strong>）。</li>
<li><code>imports</code>: 导入<strong>其他模块</strong>，以便使用它们导出的提供者。</li>
<li><code>exports</code>: 导出本模块的提供者，供<strong>其他模块</strong>导入使用。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-2">2. 控制器 (Controllers)</h3>
<ul>
<li><strong>作用：</strong> 控制器负责处理<strong>传入的请求</strong>和返回<strong>响应</strong>。它们作为应用的入口点。</li>
<li><strong>职责：</strong> 它们使用 <code>@Controller()</code> 装饰器定义路由路径，并使用 <code>@Get()</code>, <code>@Post()</code>, <code>@Put()</code>, <code>@Delete()</code> 等装饰器来处理特定的 HTTP 方法。控制器通常只包含路由逻辑，并将复杂的业务逻辑<strong>委托</strong>给服务（提供者）。</li>
</ul>
<h3 data-id="heading-3">3. 提供者 (Providers / Services)</h3>
<ul>
<li><strong>作用：</strong> 提供者是 NestJS 中<strong>最核心</strong>的概念之一，用于处理<strong>业务逻辑</strong>和数据持久化。</li>
<li><strong>职责：</strong> 它们是可注入（Injectable）的类，通常包含复杂的逻辑、数据库交互、外部 API 调用等。它们使用 <code>@Injectable()</code> 装饰器，并由 NestJS 的<strong>依赖注入系统</strong>来管理其生命周期和依赖关系。</li>
<li><strong>常见类型：</strong> 服务（Services）、仓库（Repositories）、工厂（Factories）、辅助函数等。</li>
</ul>
<h2 data-id="heading-4">架构支撑模块（通过装饰器实现）</h2>
<p>这些不是传统意义上的“模块类”，而是 NestJS 用来增强功能和控制应用行为的<strong>架构组件</strong>：</p>








































<table><thead><tr><th><strong>模块/概念</strong></th><th><strong>装饰器</strong></th><th><strong>作用</strong></th></tr></thead><tbody><tr><td><strong>依赖注入 (DI)</strong></td><td><code>@Injectable()</code></td><td>管理提供者的生命周期，自动解决组件间的依赖关系，实现<strong>松散耦合</strong>。</td></tr><tr><td><strong>中间件 (Middleware)</strong></td><td>N/A (通过 <code>MiddlewareConsumer</code>)</td><td>在控制器处理请求之前执行的函数，用于身份验证、日志记录等。</td></tr><tr><td><strong>守卫 (Guards)</strong></td><td><code>@Injectable()</code>, <code>@UseGuards()</code></td><td>在请求进入控制器方法<strong>之前</strong>执行，用于授权（判断用户是否有权访问此路由）。</td></tr><tr><td><strong>拦截器 (Interceptors)</strong></td><td><code>@Injectable()</code>, <code>@UseInterceptors()</code></td><td>拦截<strong>请求</strong>和<strong>响应</strong>，用于转换数据、添加缓存、或执行请求/响应日志记录等。</td></tr><tr><td><strong>管道 (Pipes)</strong></td><td><code>@Injectable()</code>, <code>@UsePipes()</code></td><td>在控制器方法被调用<strong>之前</strong>执行，用于数据验证（Validation）和数据转换（Transformation）。</td></tr><tr><td><strong>过滤器 (Exception Filters)</strong></td><td><code>@Catch()</code>, <code>@UseFilters()</code></td><td>捕获并处理应用中未处理的异常，定制化返回给客户端的错误响应格式。</td></tr></tbody></table>
<p>nest从发送请求的响应的流程大致是这样的</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/40a85e08477f4c6cbc37bb13dd0cd235~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAganVuX-S4jeingQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767057217&amp;x-signature=6NBqDwxEzU%2FCHLVSrB1w7CUrAEs%3D" alt="exported_image (1).png" loading="lazy"/></p>
<p>总结来说，<strong>模块</strong>是应用的骨架，<strong>控制器</strong>是入口，<strong>提供者</strong>是核心业务逻辑，而 <strong>守卫、管道、拦截器</strong> 等则是 NestJS 提供的强大工具，用于处理请求生命周期中的<strong>授权、验证和转换</strong>等任务。</p>
<p>以上就是nest的一些简单介绍，想详细了解的可以到nest的官网学习：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.nestjs.cn%2Fintroduction" target="_blank" title="https://docs.nestjs.cn/introduction" ref="nofollow noopener noreferrer"># NestJS 中文文档</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.nestjs.com%2F" target="_blank" title="https://docs.nestjs.com/" ref="nofollow noopener noreferrer"># NestJS 英文文档</a></p>
<h2 data-id="heading-5">使用nest实现一个简单的URUD功能</h2>
<p>首先nest有一个自己的cli可以让我们快速创建一个nest项目，因此我们需要先安装一下nest Cli</p>
<pre><code class="hljs language-js" lang="js">npm i -g @nestjs/cli
</code></pre>
<p>安装完nest Cli后，就可以创建项目了</p>
<pre><code class="hljs language-js" lang="js">nest <span class="hljs-keyword">new</span> [项目名称]

<span class="hljs-comment">// CLI 会询问你使用哪个包管理器（npm、yarn 或 pnpm），选择后会自动创建项目并安装依赖。</span>

</code></pre>
<p>新建完项目后，可以看到我们的项目结构是这样的：</p>
<pre><code class="hljs language-bash" lang="bash">project-name/
├── src/
│   ├── main.ts              <span class="hljs-comment"># 应用入口文件</span>
│   ├── app.module.ts        <span class="hljs-comment"># 根模块</span>
│   ├── app.controller.ts    <span class="hljs-comment"># 根控制器</span>
│   └── app.service.ts       <span class="hljs-comment"># 根服务</span>
├── <span class="hljs-built_in">test</span>/                    <span class="hljs-comment"># 测试文件</span>
├── dist/                    <span class="hljs-comment"># 编译后的文件</span>
├── node_modules/            <span class="hljs-comment"># 依赖包</span>
├── package.json             <span class="hljs-comment"># 项目配置和依赖</span>
├── tsconfig.json            <span class="hljs-comment"># TypeScript 配置</span>
├── nest-cli.json            <span class="hljs-comment"># NestJS CLI 配置</span>
└── README.md                <span class="hljs-comment"># 项目说明</span>
</code></pre>
<p>主要实现一个用户模块，在项目代码中有较为详细的注解说明。</p>
<p>以下是一个简单的User模块的代码，为了方便理解，先用一个示例来简单说它们的大概流程（创建用户）：</p>
<h3 data-id="heading-6">1. 请求入口</h3>
<pre><code class="hljs language-http" lang="http">POST /api/users
Content-Type: application/json

{
  "name": "张三",
  "email": "zhangsan@example.com",
  "age": 25
}
</code></pre>
<p>发送一个POST类型的接口，地址/api/users，下方的请求体是请求体body。</p>
<h3 data-id="heading-7">2. 路由匹配</h3>
<p>文件： <code>user.controller.ts</code></p>
<pre><code class="hljs language-js" lang="js">@<span class="hljs-title class_">Controller</span>(<span class="hljs-string">'api/users'</span>)  <span class="hljs-comment">// 路由前缀</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserController</span> {
  @<span class="hljs-title class_">Post</span>()  <span class="hljs-comment">// 匹配 POST /api/users</span>
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">create</span>(<span class="hljs-params">@Body() createUserDto: CreateUserDto</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">userService</span>.<span class="hljs-title function_">create</span>(createUserDto);
  }
}
</code></pre>
<p><strong>流程说明：</strong></p>
<ol>
<li>NestJS 路由系统匹配 <code>POST /api/users</code></li>
<li>找到 <code>UserController</code> 的 <code>create</code> 方法</li>
<li>准备执行方法</li>
</ol>
<h3 data-id="heading-8">3. 数据验证（ValidationPipe）</h3>
<p>文件：<code>main.ts</code></p>
<pre><code class="hljs language-typescript" lang="typescript">app.<span class="hljs-title function_">useGlobalPipes</span>(
  <span class="hljs-keyword">new</span> <span class="hljs-title class_">ValidationPipe</span>({
    <span class="hljs-attr">whitelist</span>: <span class="hljs-literal">true</span>,              <span class="hljs-comment">// 过滤未定义的属性</span>
    <span class="hljs-attr">forbidNonWhitelisted</span>: <span class="hljs-literal">true</span>,  <span class="hljs-comment">// 禁止未定义的属性</span>
    <span class="hljs-attr">transform</span>: <span class="hljs-literal">true</span>,              <span class="hljs-comment">// 自动转换类型</span>
  }),
);
</code></pre>
<p><strong>验证流程：</strong></p>
<ol>
<li><code>@Body()</code> 装饰器提取请求体 JSON 数据</li>
<li>ValidationPipe 根据 <code>CreateUserDto</code> 的验证规则进行验证：
<ul>
<li><code>name</code>: 必须是字符串（<code>@IsString()</code>）</li>
<li><code>email</code>: 必须是有效邮箱格式（<code>@IsEmail()</code>）</li>
<li><code>age</code>: 可选，如果提供必须是 0-150 的整数（<code>@IsOptional()</code>, <code>@IsInt()</code>, <code>@Min(0)</code>, <code>@Max(150)</code>）</li>
</ul>
</li>
<li>如果验证失败，返回 <code>400 Bad Request</code>，包含错误详情</li>
<li>如果验证通过，将数据转换为 <code>CreateUserDto</code> 实例</li>
</ol>
<p><strong>验证规则（CreateUserDto）：</strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CreateUserDto</span> {
  <span class="hljs-meta">@IsString</span>({ <span class="hljs-attr">message</span>: <span class="hljs-string">'用户名必须是字符串'</span> })
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;

  <span class="hljs-meta">@IsEmail</span>({}, { <span class="hljs-attr">message</span>: <span class="hljs-string">'邮箱格式不正确'</span> })
  <span class="hljs-attr">email</span>: <span class="hljs-built_in">string</span>;

  <span class="hljs-meta">@IsOptional</span>()
  <span class="hljs-meta">@IsInt</span>({ <span class="hljs-attr">message</span>: <span class="hljs-string">'年龄必须是整数'</span> })
  <span class="hljs-meta">@Min</span>(<span class="hljs-number">0</span>, { <span class="hljs-attr">message</span>: <span class="hljs-string">'年龄不能小于0'</span> })
  <span class="hljs-meta">@Max</span>(<span class="hljs-number">150</span>, { <span class="hljs-attr">message</span>: <span class="hljs-string">'年龄不能大于150'</span> })
  age?: <span class="hljs-built_in">number</span>;
}
</code></pre>
<h3 data-id="heading-9">4. 控制器处理</h3>
<p><strong>文件：</strong> <code>user.controller.ts</code></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">async</span> <span class="hljs-title function_">create</span>(<span class="hljs-meta">@Body</span>() <span class="hljs-attr">createUserDto</span>: <span class="hljs-title class_">CreateUserDto</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">UserResponseDto</span>&gt; {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">userService</span>.<span class="hljs-title function_">create</span>(createUserDto);
}
</code></pre>
<p><strong>流程说明：</strong></p>
<ol>
<li>接收验证后的 <code>CreateUserDto</code> 对象</li>
<li>调用 <code>userService.create()</code> 方法</li>
<li>等待服务层返回结果</li>
<li>返回 <code>UserResponseDto</code> 类型的数据</li>
</ol>
<h3 data-id="heading-10">5. 服务层处理</h3>
<p><strong>文件：</strong> <code>user.service.ts</code></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">async</span> <span class="hljs-title function_">create</span>(<span class="hljs-attr">createUserDto</span>: <span class="hljs-title class_">CreateUserDto</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">User</span>&gt; {
  <span class="hljs-comment">// 1. 创建实体实例</span>
  <span class="hljs-keyword">const</span> newUser = <span class="hljs-variable language_">this</span>.<span class="hljs-property">userRepository</span>.<span class="hljs-title function_">create</span>({
    <span class="hljs-attr">name</span>: createUserDto.<span class="hljs-property">name</span>,
    <span class="hljs-attr">email</span>: createUserDto.<span class="hljs-property">email</span>,
    <span class="hljs-attr">age</span>: createUserDto.<span class="hljs-property">age</span>,
  });

  <span class="hljs-comment">// 2. 保存到数据库</span>
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">userRepository</span>.<span class="hljs-title function_">save</span>(newUser);
}
</code></pre>
<p><strong>流程说明：</strong></p>
<ol>
<li>
<p><strong>创建实体实例</strong>：</p>
<ul>
<li><code>repository.create()</code> 创建 <code>User</code> 实体实例</li>
<li>此时实体还未保存到数据库</li>
<li>只设置了基本字段（name, email, age）</li>
</ul>
</li>
<li>
<p><strong>保存到数据库</strong>：</p>
<ul>
<li><code>repository.save()</code> 执行 INSERT 操作</li>
<li>TypeORM 自动处理：
<ul>
<li>生成自增 ID（<code>@PrimaryGeneratedColumn()</code>）</li>
<li>设置 <code>createdAt</code>（<code>@CreateDateColumn()</code>）</li>
<li>设置 <code>updatedAt</code>（<code>@UpdateDateColumn()</code>）</li>
</ul>
</li>
</ul>
</li>
</ol>
<p>主要涉及的文件main.ts，主要入口，用于项目的入口。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">NestFactory</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/core'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">AppModule</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./app.module'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ValidationPipe</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;

<span class="hljs-comment">/**
 * 应用程序启动入口
 * bootstrap 函数是 NestJS 应用的入口点
 */</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">bootstrap</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 使用 NestFactory 创建 NestJS 应用实例</span>
  <span class="hljs-comment">// NestFactory 是创建应用的核心工厂类</span>
  <span class="hljs-comment">// AppModule 是应用的根模块，包含了所有功能模块的配置</span>
  <span class="hljs-keyword">const</span> app = <span class="hljs-keyword">await</span> <span class="hljs-title class_">NestFactory</span>.<span class="hljs-title function_">create</span>(<span class="hljs-title class_">AppModule</span>);
  
  <span class="hljs-comment">/**
   * 启用跨域资源共享 (CORS)
   * 允许前端应用（运行在 localhost:3000）访问后端 API
   * credentials: true 表示允许携带认证信息（如 cookies）
   */</span>
  app.<span class="hljs-title function_">enableCors</span>({
    <span class="hljs-attr">origin</span>: <span class="hljs-string">'http://localhost:3000'</span>, <span class="hljs-comment">// 允许的前端域名</span>
    <span class="hljs-attr">credentials</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 允许携带凭证</span>
  });

  <span class="hljs-comment">/**
   * 全局验证管道
   * 自动验证所有传入的请求数据，根据 DTO 中的装饰器进行验证
   */</span>
  app.<span class="hljs-title function_">useGlobalPipes</span>(
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">ValidationPipe</span>({
      <span class="hljs-attr">whitelist</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 自动过滤掉 DTO 中未定义的属性</span>
      <span class="hljs-attr">forbidNonWhitelisted</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 如果请求包含未定义的属性，抛出错误</span>
      <span class="hljs-attr">transform</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 自动将请求数据转换为 DTO 实例</span>
    }),
  );

  <span class="hljs-comment">/**
   * 启动 HTTP 服务器
   * process.env.PORT 从环境变量读取端口，如果未设置则默认使用 3001
   * ?? 是空值合并运算符，当左侧为 null 或 undefined 时使用右侧的值
   */</span>
  <span class="hljs-keyword">await</span> app.<span class="hljs-title function_">listen</span>(process.<span class="hljs-property">env</span>.<span class="hljs-property">PORT</span> ?? <span class="hljs-number">3001</span>);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Application is running on: http://localhost:<span class="hljs-subst">${process.env.PORT ?? <span class="hljs-number">3001</span>}</span>`</span>);
}

<span class="hljs-comment">// 执行启动函数</span>
<span class="hljs-title function_">bootstrap</span>();
</code></pre>
<p>app.module.ts，模块如果需要在当前模块使用那就需要进行导入。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Module</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ConfigModule</span>, <span class="hljs-title class_">ConfigService</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/config'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">TypeOrmModule</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/typeorm'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">AppController</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./app.controller'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">AppService</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./app.service'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">UserModule</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./user/user.module'</span>;

<span class="hljs-comment">/**
 * AppModule - 应用的根模块
 * 
 * <span class="hljs-doctag">@Module</span> 装饰器用于定义一个模块类
 * 模块是 NestJS 中组织代码的基本单元，类似于 Angular 的模块概念
 * 
 * 模块的三个主要属性：
 * - imports: 导入其他模块，使当前模块可以使用其他模块导出的功能
 * - controllers: 注册控制器，处理 HTTP 请求
 * - providers: 注册提供者（服务），实现业务逻辑，可以在整个模块中注入使用
 */</span>
@<span class="hljs-title class_">Module</span>({
  <span class="hljs-attr">imports</span>: [
    <span class="hljs-comment">/**
     * ConfigModule - 配置模块
     * 
     * 作用：管理应用配置，支持从环境变量、配置文件等读取配置
     * 
     * 参数说明：
     *   - isGlobal: true - 设置为全局模块，所有模块都可以直接使用 ConfigService
     *   - envFilePath: '.env' - 环境变量文件路径
     *   - load: [] - 可以加载额外的配置源
     * 
     * 说明：
     *   - 全局模块意味着不需要在每个模块中导入 ConfigModule
     *   - 可以直接在任何地方注入 ConfigService 使用
     */</span>
    <span class="hljs-title class_">ConfigModule</span>.<span class="hljs-title function_">forRoot</span>({
      <span class="hljs-attr">isGlobal</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 全局配置模块</span>
      <span class="hljs-attr">envFilePath</span>: <span class="hljs-string">'.env'</span>, <span class="hljs-comment">// 环境变量文件路径</span>
    }),

    <span class="hljs-comment">/**
     * TypeOrmModule.forRootAsync() - TypeORM 异步配置
     * 
     * 作用：配置 TypeORM 数据库连接
     * 
     * 为什么使用 forRootAsync：
     *   - 可以异步获取配置（如从 ConfigService）
     *   - 支持依赖注入（如注入 ConfigService）
     *   - 更灵活，可以在运行时读取配置
     * 
     * 参数说明：
     *   - imports: [ConfigModule] - 导入 ConfigModule 以使用 ConfigService
     *   - useFactory: 工厂函数，返回 TypeORM 配置对象
     *   - inject: [ConfigService] - 注入 ConfigService 到工厂函数
     */</span>
    <span class="hljs-title class_">TypeOrmModule</span>.<span class="hljs-title function_">forRootAsync</span>({
      <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">ConfigModule</span>],
      <span class="hljs-attr">useFactory</span>: <span class="hljs-function">(<span class="hljs-params">configService: ConfigService</span>) =&gt;</span> ({
        <span class="hljs-comment">/**
         * type - 数据库类型
         * 支持：mysql, postgres, sqlite, mssql, mongodb 等
         */</span>
        <span class="hljs-attr">type</span>: <span class="hljs-string">'mysql'</span>,

        <span class="hljs-comment">/**
         * host - 数据库主机地址
         * 从环境变量 DB_HOST 读取，默认 localhost
         */</span>
        <span class="hljs-attr">host</span>: configService.<span class="hljs-title function_">get</span>(<span class="hljs-string">'DB_HOST'</span>, <span class="hljs-string">'localhost'</span>),

        <span class="hljs-comment">/**
         * port - 数据库端口
         * 从环境变量 DB_PORT 读取，默认 3306（MySQL 默认端口）
         */</span>
        <span class="hljs-attr">port</span>: configService.<span class="hljs-property">get</span>&lt;number&gt;(<span class="hljs-string">'DB_PORT'</span>, <span class="hljs-number">3306</span>),

        <span class="hljs-comment">/**
         * username - 数据库用户名
         * 从环境变量 DB_USERNAME 读取
         */</span>
        <span class="hljs-attr">username</span>: configService.<span class="hljs-title function_">get</span>(<span class="hljs-string">'DB_USERNAME'</span>, <span class="hljs-string">'root'</span>),

        <span class="hljs-comment">/**
         * password - 数据库密码
         * 从环境变量 DB_PASSWORD 读取
         */</span>
        <span class="hljs-attr">password</span>: configService.<span class="hljs-title function_">get</span>(<span class="hljs-string">'DB_PASSWORD'</span>, <span class="hljs-string">''</span>),

        <span class="hljs-comment">/**
         * database - 数据库名称
         * 从环境变量 DB_DATABASE 读取
         */</span>
        <span class="hljs-attr">database</span>: configService.<span class="hljs-title function_">get</span>(<span class="hljs-string">'DB_DATABASE'</span>, <span class="hljs-string">'nest_db'</span>),

        <span class="hljs-comment">/**
         * entities - 实体类数组
         * 指定 TypeORM 要管理的实体类

         */</span>
        <span class="hljs-attr">entities</span>: [__dirname + <span class="hljs-string">'/**/*.entity{.ts,.js}'</span>],

        <span class="hljs-comment">/**
         * synchronize - 自动同步数据库结构
         * 
         * 作用：根据实体类自动创建或更新数据库表结构
         * 
         * 注意：
         *   - true: 开发环境使用，自动同步表结构（方便开发）
         *   - false: 生产环境必须设为 false，使用迁移（migration）管理数据库结构
         *   - 设为 true 时，修改实体类会自动修改数据库表，可能丢失数据
         */</span>
        <span class="hljs-attr">synchronize</span>: configService.<span class="hljs-title function_">get</span>(<span class="hljs-string">'DB_SYNCHRONIZE'</span>, <span class="hljs-string">'true'</span>) === <span class="hljs-string">'true'</span>,

        <span class="hljs-comment">/**
         * logging - SQL 日志
         * 
         * 作用：是否打印执行的 SQL 语句
         * 
         * 说明：
         *   - true: 开发环境使用，方便调试，可以看到执行的 SQL
         *   - false: 生产环境使用，减少日志输出
         *   - 也可以设置为 ['query', 'error'] 等数组，只记录特定类型的日志
         */</span>
        <span class="hljs-attr">logging</span>: configService.<span class="hljs-title function_">get</span>(<span class="hljs-string">'DB_LOGGING'</span>, <span class="hljs-string">'true'</span>) === <span class="hljs-string">'true'</span>,

        <span class="hljs-comment">/**
         * 其他常用配置选项：
         * 
         * - charset: 'utf8mb4' - 字符集（支持 emoji）
         * - timezone: '+08:00' - 时区
         * - extra: { connectionLimit: 10 } - 连接池配置
         * - migrations: [] - 数据库迁移文件
         * - subscribers: [] - 订阅者（实体监听器）
         */</span>
      }),
      <span class="hljs-attr">inject</span>: [<span class="hljs-title class_">ConfigService</span>],
    }),
    <span class="hljs-title class_">UserModule</span>, <span class="hljs-comment">// 导入用户模块，这样才可以使用user模块中导出的方法</span>
  ],
  <span class="hljs-attr">controllers</span>: [<span class="hljs-title class_">AppController</span>], <span class="hljs-comment">// 注册应用控制器</span>
  <span class="hljs-attr">providers</span>: [<span class="hljs-title class_">AppService</span>], <span class="hljs-comment">// 注册应用服务</span>
})
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AppModule</span> {}
</code></pre>
<p>user.controller.ts，在user模块中的控制器，用于路由的匹配。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> {
  <span class="hljs-title class_">Controller</span>,<span class="hljs-title class_">Get</span>,<span class="hljs-title class_">Post</span>,<span class="hljs-title class_">Body</span>,<span class="hljs-title class_">Patch</span>,<span class="hljs-title class_">Param</span>,<span class="hljs-title class_">Delete</span>,<span class="hljs-title class_">ParseIntPipe</span>,} <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">UserService</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./user.service'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">CreateUserDto</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./dto/create-user.dto'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">UpdateUserDto</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./dto/update-user.dto'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">UserResponseDto</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./dto/user-response.dto'</span>;

<span class="hljs-comment">/**
 * UserController - 用户控制器
 * 
 * 负责处理用户相关的 HTTP 请求
 * 实现完整的 CRUD 操作：Create（创建）、Read（读取）、Update（更新）、Delete（删除）
 */</span>

<span class="hljs-comment">/**
 * <span class="hljs-doctag">@Controller</span>('api/users') - 控制器路由装饰器
 * 
 * 作用：定义控制器的路由前缀，所有该控制器下的路由都会自动加上这个前缀
 * 参数：'api/users' - 路由前缀路径
 * 效果：
 *   - 如果方法装饰器是 <span class="hljs-doctag">@Get</span>()，完整路径为 GET /api/users
 *   - 如果方法装饰器是 <span class="hljs-doctag">@Get</span>(':id')，完整路径为 GET /api/users/:id
 */</span>
 
@<span class="hljs-title class_">Controller</span>(<span class="hljs-string">'api/users'</span>)
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserController</span> {
  <span class="hljs-comment">/**
   * 依赖注入 - 通过构造函数注入 UserService
   * private readonly 表示这是私有只读属性，只能在类内部使用
   */</span>
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">private readonly userService: UserService</span>) {}
  
  <span class="hljs-comment">/**
   * 创建用户
   * POST /api/users
   */</span>
  <span class="hljs-comment">/**
   * <span class="hljs-doctag">@Post</span>() - HTTP POST 方法装饰器
   * 
   * 作用：将方法标记为处理 POST 请求的路由处理器
   * 参数：不传参数时，路由路径为空，完整路径为控制器的前缀 + 空路径 = /api/users
   * 说明：POST 请求通常用于创建新资源
   */</span>
  @<span class="hljs-title class_">Post</span>()
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">create</span>(
    <span class="hljs-comment">/**
     * <span class="hljs-doctag">@Body</span>() - 请求体参数装饰器
     * 
     * 作用：从 HTTP 请求体中提取数据并注入到方法参数中
     * 说明：
     *   - NestJS 会自动将 JSON 请求体解析为 CreateUserDto 对象
     *   - 结合 ValidationPipe，会自动验证数据是否符合 DTO 中定义的规则
     *   - 如果验证失败，会返回 400 错误
     */</span>
    @<span class="hljs-title class_">Body</span>() <span class="hljs-attr">createUserDto</span>: <span class="hljs-title class_">CreateUserDto</span>
  ): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">UserResponseDto</span>&gt; {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">userService</span>.<span class="hljs-title function_">create</span>(createUserDto);
  }

  <span class="hljs-comment">/**
   * 获取所有用户
   * GET /api/users
   */</span>

  <span class="hljs-comment">/**
   * <span class="hljs-doctag">@Get</span>() - HTTP GET 方法装饰器
   * 
   * 作用：将方法标记为处理 GET 请求的路由处理器
   * 参数：不传参数时，路由路径为空，完整路径为 /api/users
   * 说明：GET 请求用于获取资源
   */</span>
  @<span class="hljs-title class_">Get</span>()
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">findAll</span>(): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">UserResponseDto</span>[]&gt; {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">userService</span>.<span class="hljs-title function_">findAll</span>();
  }

  <span class="hljs-comment">/**
   * 根据ID获取单个用户
   * GET /api/users/:id
   */</span>

  <span class="hljs-comment">/**
   * <span class="hljs-doctag">@Get</span>(':id') - HTTP GET 方法装饰器（带路径参数）
   * 
   * 作用：定义带路径参数的 GET 路由
   * 参数：':id' - 路径参数，冒号表示这是一个动态参数
   * 完整路径：GET /api/users/:id
   * 说明：路径参数可以通过 <span class="hljs-doctag">@Param</span>() 装饰器获取
   */</span>
  @<span class="hljs-title class_">Get</span>(<span class="hljs-string">':id'</span>)
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">findOne</span>(
    <span class="hljs-comment">/**
     * <span class="hljs-doctag">@Param</span>('id', ParseIntPipe) - 路径参数装饰器 + 管道转换
     * 
     * 作用：
     *   1. <span class="hljs-doctag">@Param</span>('id') - 从路由路径中提取名为 'id' 的参数
     *   2. ParseIntPipe - 将字符串参数转换为整数类型
     * 
     * 说明：
     *   - HTTP 请求中的路径参数默认是字符串类型
     *   - ParseIntPipe 会自动将字符串转换为数字
     *   - 如果转换失败（如传入非数字），会自动返回 400 错误
     *   - 这是 NestJS 中类型转换和验证的常用方式
     */</span>
    @<span class="hljs-title class_">Param</span>(<span class="hljs-string">'id'</span>, <span class="hljs-title class_">ParseIntPipe</span>) <span class="hljs-attr">id</span>: number
  ): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">UserResponseDto</span>&gt; {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">userService</span>.<span class="hljs-title function_">findOne</span>(id);
  }

  <span class="hljs-comment">/**
   * 更新用户信息
   * PATCH /api/users/:id
   */</span>

  <span class="hljs-comment">/**
   * <span class="hljs-doctag">@Patch</span>(':id') - HTTP PATCH 方法装饰器
   * 
   * 作用：将方法标记为处理 PATCH 请求的路由处理器
   * 参数：':id' - 路径参数，表示要更新的资源ID
   * 说明：
   *   - PATCH 用于部分更新资源（只更新提供的字段）
   *   - 与 PUT 的区别：PUT 通常用于完整替换资源，PATCH 用于部分更新
   *   - RESTful API 中，更新操作通常使用 PATCH
   */</span>
  @<span class="hljs-title class_">Patch</span>(<span class="hljs-string">':id'</span>)
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">update</span>(
    <span class="hljs-comment">/**
     * <span class="hljs-doctag">@Param</span>('id', ParseIntPipe) - 提取并转换路径参数 id
     */</span>
    @<span class="hljs-title class_">Param</span>(<span class="hljs-string">'id'</span>, <span class="hljs-title class_">ParseIntPipe</span>) <span class="hljs-attr">id</span>: number,
    <span class="hljs-comment">/**
     * <span class="hljs-doctag">@Body</span>() - 提取请求体数据
     * 
     * 说明：UpdateUserDto 中的字段都是可选的，可以只更新部分字段
     */</span>
    @<span class="hljs-title class_">Body</span>() <span class="hljs-attr">updateUserDto</span>: <span class="hljs-title class_">UpdateUserDto</span>,
  ): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">UserResponseDto</span>&gt; {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">userService</span>.<span class="hljs-title function_">update</span>(id, updateUserDto);
  }

  <span class="hljs-comment">/**
   * 删除用户
   * DELETE /api/users/:id
   */</span>

  <span class="hljs-comment">/**
   * <span class="hljs-doctag">@Delete</span>(':id') - HTTP DELETE 方法装饰器
   * 
   * 作用：将方法标记为处理 DELETE 请求的路由处理器
   * 参数：':id' - 路径参数，表示要删除的资源ID
   * 说明：DELETE 请求用于删除资源，是 RESTful API 中删除操作的标准方法
   */</span>
  @<span class="hljs-title class_">Delete</span>(<span class="hljs-string">':id'</span>)
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">remove</span>(
    <span class="hljs-comment">/**
     * <span class="hljs-doctag">@Param</span>('id', ParseIntPipe) - 提取并转换路径参数 id
     */</span>
    @<span class="hljs-title class_">Param</span>(<span class="hljs-string">'id'</span>, <span class="hljs-title class_">ParseIntPipe</span>) <span class="hljs-attr">id</span>: number
  ): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-keyword">void</span>&gt; {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">userService</span>.<span class="hljs-title function_">remove</span>(id);
  }
}
</code></pre>
<p>user.service.ts，在user模块中的提供者，用于处理请求的业务逻辑。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Injectable</span>, <span class="hljs-title class_">NotFoundException</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">InjectRepository</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/typeorm'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Repository</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'typeorm'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">User</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./entities/user.entity'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">CreateUserDto</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./dto/create-user.dto'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">UpdateUserDto</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./dto/update-user.dto'</span>;

<span class="hljs-comment">/**
 * UserService - 用户服务类
 * 
 * 负责处理用户相关的业务逻辑
 * 使用 TypeORM Repository 进行数据库操作
 */</span>

<span class="hljs-comment">/**
 * <span class="hljs-doctag">@Injectable</span>() - 可注入装饰器
 * 
 * 作用：标记此类可以被 NestJS 的依赖注入系统管理
 * 
 * 功能说明：
 *   1. 使此类可以被其他类（如控制器）通过构造函数注入使用
 *   2. NestJS 会自动管理其生命周期（默认是单例模式，整个应用只有一个实例）
 *   3. 可以在模块的 providers 数组中注册
 *   4. 支持依赖注入，可以在构造函数中注入其他服务
 * 
 * 生命周期：
 *   - 默认作用域：单例（SINGLETON），应用启动时创建一次，所有地方共享同一个实例
 *   - 可以通过 { scope: Scope.REQUEST } 设置为请求作用域，每个请求创建新实例
 *   - 可以通过 { scope: Scope.TRANSIENT } 设置为瞬态作用域，每次注入都创建新实例
 * 
 * 使用场景：
 *   - 封装业务逻辑
 *   - 数据访问层（如数据库操作）
 *   - 可复用的功能模块
 */</span>
@<span class="hljs-title class_">Injectable</span>()
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {
  <span class="hljs-comment">/**
   * 构造函数 - 依赖注入 Repository
   * 
   * <span class="hljs-doctag">@InjectRepository</span>(User) - Repository 注入装饰器
   * 
   * 作用：注入 TypeORM Repository，用于数据库操作
   * 
   * 参数说明：
   *   - User - 实体类，指定要操作的实体类型
   * 
   * 说明：
   *   - Repository&lt;User&gt; 是 TypeORM 提供的数据库操作接口
   *   - 提供了丰富的数据库操作方法（find, save, delete, update 等）
   *   - 类型安全：TypeScript 会根据 User 实体类提供类型提示
   *   - 需要在 UserModule 中使用 TypeOrmModule.forFeature([User]) 注册
   */</span>
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">
    @InjectRepository(User)
    private userRepository: Repository&lt;User&gt;,
  </span>) {}

  <span class="hljs-comment">/**
   * 创建用户
   * 
   * <span class="hljs-doctag">@param</span> createUserDto 创建用户的数据
   * <span class="hljs-doctag">@returns</span> 创建的用户对象（Promise）
   * 
   * 说明：
   *   - create() 方法创建实体实例，但不保存到数据库
   *   - save() 方法将实体保存到数据库
   *   - TypeORM 会自动处理 createdAt 和 updatedAt 字段
   */</span>
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">create</span>(<span class="hljs-attr">createUserDto</span>: <span class="hljs-title class_">CreateUserDto</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">User</span>&gt; {
    <span class="hljs-comment">// 创建实体实例</span>
    <span class="hljs-keyword">const</span> newUser = <span class="hljs-variable language_">this</span>.<span class="hljs-property">userRepository</span>.<span class="hljs-title function_">create</span>({
      <span class="hljs-attr">name</span>: createUserDto.<span class="hljs-property">name</span>,
      <span class="hljs-attr">email</span>: createUserDto.<span class="hljs-property">email</span>,
      <span class="hljs-attr">age</span>: createUserDto.<span class="hljs-property">age</span>,
    });

    <span class="hljs-comment">// 保存到数据库</span>
    <span class="hljs-comment">// save() 方法会：</span>
    <span class="hljs-comment">// 1. 插入新记录到数据库</span>
    <span class="hljs-comment">// 2. 自动设置 createdAt 和 updatedAt（因为使用了 @CreateDateColumn 和 @UpdateDateColumn）</span>
    <span class="hljs-comment">// 3. 返回保存后的实体（包含自动生成的 id）</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">userRepository</span>.<span class="hljs-title function_">save</span>(newUser);
  }

  <span class="hljs-comment">/**
   * 获取所有用户
   * 
   * <span class="hljs-doctag">@returns</span> 用户数组（Promise）
   * 
   * 说明：
   *   - find() 方法查询所有记录
   *   - 返回数组，如果没有记录则返回空数组 []
   */</span>
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">findAll</span>(): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">User</span>[]&gt; {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">userRepository</span>.<span class="hljs-title function_">find</span>();
  }

  <span class="hljs-comment">/**
   * 根据ID获取单个用户
   * 
   * <span class="hljs-doctag">@param</span> id 用户ID
   * <span class="hljs-doctag">@returns</span> 用户对象（Promise）
   * <span class="hljs-doctag">@throws</span> NotFoundException 如果用户不存在
   * 
   * 说明：
   *   - findOne({ where: { id } }) 根据条件查询单条记录
   *   - 如果找不到记录，返回 null
   *   - 需要手动检查并抛出异常
   */</span>
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">findOne</span>(<span class="hljs-attr">id</span>: number): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">User</span>&gt; {
    <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">userRepository</span>.<span class="hljs-title function_">findOne</span>({ <span class="hljs-attr">where</span>: { id } });

    <span class="hljs-keyword">if</span> (!user) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NotFoundException</span>(<span class="hljs-string">`用户 ID <span class="hljs-subst">${id}</span> 不存在`</span>);
    }

    <span class="hljs-keyword">return</span> user;
  }

  <span class="hljs-comment">/**
   * 更新用户信息
   * 
   * <span class="hljs-doctag">@param</span> id 用户ID
   * <span class="hljs-doctag">@param</span> updateUserDto 更新的数据
   * <span class="hljs-doctag">@returns</span> 更新后的用户对象（Promise）
   * <span class="hljs-doctag">@throws</span> NotFoundException 如果用户不存在
   * 
   * 说明：
   *   - 先查找用户，如果不存在则抛出异常
   *   - 使用 Object.assign() 或展开运算符更新字段
   *   - save() 方法会：
   *     1. 如果实体有 id，执行 UPDATE 操作
   *     2. 自动更新 updatedAt 字段（因为使用了 <span class="hljs-doctag">@UpdateDateColumn</span>）
   *     3. 返回更新后的实体
   */</span>
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">update</span>(<span class="hljs-attr">id</span>: number, <span class="hljs-attr">updateUserDto</span>: <span class="hljs-title class_">UpdateUserDto</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">User</span>&gt; {
    <span class="hljs-comment">// 查找用户，如果不存在会抛出异常</span>
    <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">findOne</span>(id);

    <span class="hljs-comment">// 更新用户信息</span>
    <span class="hljs-comment">// Object.assign() 将 updateUserDto 中的属性复制到 user 对象</span>
    <span class="hljs-comment">// 只更新提供的字段，未提供的字段保持不变</span>
    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>(user, updateUserDto);

    <span class="hljs-comment">// 保存更新</span>
    <span class="hljs-comment">// save() 方法检测到实体有 id，会执行 UPDATE 而不是 INSERT</span>
    <span class="hljs-comment">// @UpdateDateColumn 装饰的字段会自动更新为当前时间</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">userRepository</span>.<span class="hljs-title function_">save</span>(user);
  }

  <span class="hljs-comment">/**
   * 删除用户
   * 
   * <span class="hljs-doctag">@param</span> id 用户ID
   * <span class="hljs-doctag">@throws</span> NotFoundException 如果用户不存在
   * 
   * 说明：
   *   - remove() 方法需要传入实体对象
   *   - delete() 方法可以直接传入 id，更高效
   *   - 两种方式都可以，delete() 更简单直接
   */</span>
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">remove</span>(<span class="hljs-attr">id</span>: number): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-keyword">void</span>&gt; {
    <span class="hljs-comment">// 先检查用户是否存在</span>
    <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">findOne</span>(id); <span class="hljs-comment">// 如果不存在会抛出异常</span>

    <span class="hljs-comment">// 删除用户</span>
    <span class="hljs-comment">// delete() 方法根据 id 删除记录</span>
    <span class="hljs-comment">// 返回 DeleteResult 对象，包含 affected 属性（受影响的行数）</span>
    <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">userRepository</span>.<span class="hljs-title function_">delete</span>(id);
  }
}
</code></pre>
<p>以上涉及的DTO有三个，代码如下：</p>
<p>create-user.dto.ts:</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">IsString</span>, <span class="hljs-title class_">IsEmail</span>, <span class="hljs-title class_">IsOptional</span>, <span class="hljs-title class_">IsInt</span>, <span class="hljs-title class_">Min</span>, <span class="hljs-title class_">Max</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'class-validator'</span>;

<span class="hljs-comment">/**
 * CreateUserDto - 创建用户数据传输对象
 * 用于接收创建用户的请求数据
 * 
 * DTO (Data Transfer Object) 的作用：
 *   1. 定义 API 接口的请求数据结构
 *   2. 提供数据验证规则（通过 class-validator 装饰器）
 *   3. 类型安全：TypeScript 类型检查
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CreateUserDto</span> {
  <span class="hljs-comment">/**
   * <span class="hljs-doctag">@IsString</span>() - 字符串验证装饰器
   * 
   * 作用：验证该字段必须是字符串类型
   * 
   * 参数说明：
   *   - message: 验证失败时返回的错误消息
   * 
   * 验证规则：
   *   - 如果传入的值不是字符串，验证会失败
   *   - 验证失败时，NestJS 会返回 400 错误，错误信息为 "用户名必须是字符串"
   * 
   * 说明：
   *   - class-validator 提供了丰富的验证装饰器
   *   - 需要配合 ValidationPipe 使用（在 main.ts 中已配置）
   *   - 验证在请求到达控制器方法之前自动执行
   */</span>
  @<span class="hljs-title class_">IsString</span>({ <span class="hljs-attr">message</span>: <span class="hljs-string">'用户名必须是字符串'</span> })
  <span class="hljs-attr">name</span>: string;
  
  <span class="hljs-comment">/**
   * <span class="hljs-doctag">@IsEmail</span>() - 邮箱格式验证装饰器
   * 
   * 作用：验证该字段必须是有效的邮箱格式
   * 
   * 参数说明：
   *   - 第一个参数 {}: 邮箱验证选项（使用默认选项）
   *   - 第二个参数 { message: ... }: 验证失败时的错误消息
   * 
   * 验证规则：
   *   - 必须符合邮箱格式（如：user<span class="hljs-doctag">@example</span>.com）
   *   - 验证失败时返回 "邮箱格式不正确"
   * 
   * 说明：
   *   - 这是数据验证的重要环节，防止无效数据进入系统
   *   - 验证在服务层处理之前完成，提高系统安全性
   */</span>
  @<span class="hljs-title class_">IsEmail</span>({}, { <span class="hljs-attr">message</span>: <span class="hljs-string">'邮箱格式不正确'</span> })
  <span class="hljs-attr">email</span>: string;

  <span class="hljs-comment">/**
   * <span class="hljs-doctag">@IsOptional</span>() - 可选字段装饰器
   * 
   * 作用：标记该字段是可选的，如果未提供值，跳过后续验证
   * 
   * 说明：
   *   - 如果字段存在，则执行后续的验证规则
   *   - 如果字段不存在（undefined），则跳过验证
   *   - 必须放在其他验证装饰器之前
   *   - 与 TypeScript 的可选属性（?）配合使用
   */</span>
  @<span class="hljs-title class_">IsOptional</span>()

  <span class="hljs-comment">/**
   * <span class="hljs-doctag">@IsInt</span>() - 整数验证装饰器
   * 
   * 作用：验证该字段必须是整数
   * 
   * 说明：
   *   - 验证值是否为整数类型
   *   - 如果传入小数或非数字，验证会失败
   */</span>
  @<span class="hljs-title class_">IsInt</span>({ <span class="hljs-attr">message</span>: <span class="hljs-string">'年龄必须是整数'</span> })

  <span class="hljs-comment">/**
   * <span class="hljs-doctag">@Min</span>() - 最小值验证装饰器
   * 
   * 作用：验证数值必须大于或等于指定值
   * 
   * 参数：0 - 最小值
   * 说明：年龄不能为负数
   */</span>
  @<span class="hljs-title class_">Min</span>(<span class="hljs-number">0</span>, { <span class="hljs-attr">message</span>: <span class="hljs-string">'年龄不能小于0'</span> })

  <span class="hljs-comment">/**
   * <span class="hljs-doctag">@Max</span>() - 最大值验证装饰器
   * 
   * 作用：验证数值必须小于或等于指定值
   * 
   * 参数：200 - 最大值
   * 说明：年龄不能超过 200
   * 
   * 验证链说明：
   *   1. <span class="hljs-doctag">@IsOptional</span>() - 如果字段不存在，跳过后续验证
   *   2. <span class="hljs-doctag">@IsInt</span>() - 如果字段存在，必须是整数
   *   3. <span class="hljs-doctag">@Min</span>(0) - 如果字段存在且是整数，必须 &gt;= 0
   *   4. <span class="hljs-doctag">@Max</span>(150) - 如果字段存在且是整数，必须 &lt;= 150
   * 
   * 验证顺序：从上到下依次执行，任何一个验证失败都会返回错误
   */</span>
  @<span class="hljs-title class_">Max</span>(<span class="hljs-number">200</span>, { <span class="hljs-attr">message</span>: <span class="hljs-string">'年龄不能大于200'</span> })
  age?: number;
}
</code></pre>
<p>update-user.dto.ts：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">IsString</span>, <span class="hljs-title class_">IsEmail</span>, <span class="hljs-title class_">IsOptional</span>, <span class="hljs-title class_">IsInt</span>, <span class="hljs-title class_">Min</span>, <span class="hljs-title class_">Max</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'class-validator'</span>;

<span class="hljs-comment">/**
 * UpdateUserDto - 更新用户数据传输对象
 * 用于接收更新用户的请求数据
 * 所有字段都是可选的，因为更新时可能只更新部分字段
 * 
 * 与 CreateUserDto 的区别：
 *   - CreateUserDto: 所有必填字段都不能为空（name、email 必填）
 *   - UpdateUserDto: 所有字段都是可选的，符合 PATCH 部分更新的语义
 * 
 * 设计原则：
 *   - 部分更新：用户可以只更新需要修改的字段
 *   - 灵活性：不需要提供所有字段，只提供要更新的字段即可
 *   - 验证：如果提供了字段，则必须符合验证规则
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UpdateUserDto</span> {

  <span class="hljs-comment">/**
   * <span class="hljs-doctag">@IsOptional</span>() - 标记为可选字段
   * 
   * 说明：更新操作中，如果客户端不提供此字段，表示不更新该字段
   */</span>
  @<span class="hljs-title class_">IsOptional</span>()

  <span class="hljs-comment">/**
   * <span class="hljs-doctag">@IsString</span>() - 如果提供了 name 字段，则必须是字符串
   * 
   * 验证逻辑：
   *   - 如果 name 未提供（undefined）：跳过验证（因为 <span class="hljs-doctag">@IsOptional</span>）
   *   - 如果 name 提供了：必须是字符串类型
   */</span>
  @<span class="hljs-title class_">IsString</span>({ <span class="hljs-attr">message</span>: <span class="hljs-string">'用户名必须是字符串'</span> })
  name?: string;

  <span class="hljs-comment">/**
   * <span class="hljs-doctag">@IsOptional</span>() - 标记为可选
   */</span>
  @<span class="hljs-title class_">IsOptional</span>()

  <span class="hljs-comment">/**
   * <span class="hljs-doctag">@IsEmail</span>() - 如果提供了 email 字段，则必须是有效邮箱格式
   * 
   * 说明：更新邮箱时，必须提供有效的邮箱格式
   */</span>
  @<span class="hljs-title class_">IsEmail</span>({}, { <span class="hljs-attr">message</span>: <span class="hljs-string">'邮箱格式不正确'</span> })
  email?: string;

  <span class="hljs-comment">/**
   * <span class="hljs-doctag">@IsOptional</span>() - 标记为可选
   */</span>
  @<span class="hljs-title class_">IsOptional</span>()

  <span class="hljs-comment">/**
   * <span class="hljs-doctag">@IsInt</span>() - 如果提供了 age 字段，则必须是整数
   */</span>
  @<span class="hljs-title class_">IsInt</span>({ <span class="hljs-attr">message</span>: <span class="hljs-string">'年龄必须是整数'</span> })

  <span class="hljs-comment">/**
   * <span class="hljs-doctag">@Min</span>(0) - 如果提供了 age 字段，则必须 &gt;= 0
   */</span>
  @<span class="hljs-title class_">Min</span>(<span class="hljs-number">0</span>, { <span class="hljs-attr">message</span>: <span class="hljs-string">'年龄不能小于0'</span> })

  <span class="hljs-comment">/**
   * <span class="hljs-doctag">@Max</span>(200) - 如果提供了 age 字段，则必须 &lt;= 200
   * 
   * 验证链说明（与 CreateUserDto 相同）：
   *   1. <span class="hljs-doctag">@IsOptional</span>() - 字段可选
   *   2. 如果提供了值，则必须通过后续所有验证
   *   3. 验证顺序：IsInt -&gt; Min -&gt; Max
   */</span>
  @<span class="hljs-title class_">Max</span>(<span class="hljs-number">200</span>, { <span class="hljs-attr">message</span>: <span class="hljs-string">'年龄不能大于200'</span> })
  age?: number;
}
</code></pre>
<p>user-response.dto.ts ：</p>
<pre><code class="hljs language-js" lang="js">
<span class="hljs-comment">/**
 * UserResponseDto - 用户响应数据传输对象
 * 用于 API 响应，包含完整的用户信息
 * 
 * 作用：
 *   1. 定义 API 响应的数据结构
 *   2. 类型安全：确保响应数据的类型正确
 * 
 * 与 User 实体的区别：
 *   - User 实体：内部数据结构，可能包含敏感信息或内部字段
 *   - UserResponseDto：对外暴露的数据结构，只包含需要返回给客户端的字段
 * 
 * 最佳实践：
 *   - 使用 DTO 控制返回给客户端的数据
 *   - 可以隐藏敏感信息（如密码）
 *   - 可以格式化数据（如日期格式）
 *   - 可以添加额外的计算字段
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserResponseDto</span> {
  <span class="hljs-attr">id</span>: number;
  
  <span class="hljs-attr">name</span>: string;

  <span class="hljs-attr">email</span>: string;

  age?: number;

  <span class="hljs-attr">createdAt</span>: <span class="hljs-title class_">Date</span>;

  <span class="hljs-attr">updatedAt</span>: <span class="hljs-title class_">Date</span>;
}
</code></pre>
<p>user.entity.ts是用户实体类（数据库表映射）。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> {
  <span class="hljs-title class_">Entity</span>,
  <span class="hljs-title class_">Column</span>,
  <span class="hljs-title class_">PrimaryGeneratedColumn</span>,
  <span class="hljs-title class_">CreateDateColumn</span>,
  <span class="hljs-title class_">UpdateDateColumn</span>,
} <span class="hljs-keyword">from</span> <span class="hljs-string">'typeorm'</span>;

<span class="hljs-comment">/**
 * User 实体类 - TypeORM 实体
 * 
 * 作用：
 *   1. 定义数据库表结构
 *   2. 映射数据库表到 TypeScript 类
 *   3. 提供类型安全的数据库操作
 * 
 * <span class="hljs-doctag">@Entity</span>('users') - 实体装饰器
 * 
 * 作用：标记这是一个 TypeORM 实体类
 * 参数：'users' - 数据库表名（如果不指定，默认使用类名的小写形式）
 * 
 * 说明：
 *   - TypeORM 会根据这个实体类自动创建或同步数据库表
 *   - 实体类中的属性会映射到数据库表的列
 */</span>
@<span class="hljs-title class_">Entity</span>(<span class="hljs-string">'users'</span>)
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> {
  <span class="hljs-comment">/**
   * <span class="hljs-doctag">@PrimaryGeneratedColumn</span>() - 主键自增列装饰器
   * 
   * 作用：定义主键列，自动生成递增的 ID
   * 
   * 说明：
   *   - 这是数据库表的主键
   *   - 自动递增，每次插入新记录时自动生成
   *   - 类型为 number，对应 MySQL 的 INT 或 BIGINT
   */</span>
  @<span class="hljs-title class_">PrimaryGeneratedColumn</span>()
  <span class="hljs-attr">id</span>: number;

  <span class="hljs-comment">/**
   * <span class="hljs-doctag">@Column</span>() - 普通列装饰器
   * 
   * 作用：定义数据库表的普通列
   * 
   * 参数说明：
   *   - type: 'varchar' - 数据库列类型，varchar 是可变长度字符串
   *   - length: 255 - 最大长度
   *   - nullable: false - 不允许为空（必填字段）
   * 
   * 说明：
   *   - 如果不指定 type，TypeORM 会根据 TypeScript 类型推断
   *   - string 类型默认映射为 varchar(255)
   */</span>
  @<span class="hljs-title class_">Column</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">'varchar'</span>, <span class="hljs-attr">length</span>: <span class="hljs-number">255</span>, <span class="hljs-attr">nullable</span>: <span class="hljs-literal">false</span> })
  <span class="hljs-attr">name</span>: string;

  <span class="hljs-comment">/**
   * <span class="hljs-doctag">@Column</span>() - 邮箱列
   * 
   * 参数说明：
   *   - unique: true - 唯一约束，确保邮箱不重复
   *   - nullable: false - 不允许为空
   * 
   * 说明：
   *   - unique: true 会在数据库层面创建唯一索引
   *   - 如果尝试插入重复邮箱，数据库会抛出错误
   */</span>
  @<span class="hljs-title class_">Column</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">'varchar'</span>, <span class="hljs-attr">length</span>: <span class="hljs-number">255</span>, <span class="hljs-attr">unique</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">nullable</span>: <span class="hljs-literal">false</span> })
  <span class="hljs-attr">email</span>: string;

  <span class="hljs-comment">/**
   * <span class="hljs-doctag">@Column</span>() - 年龄列（可选字段）
   * 
   * 参数说明：
   *   - type: 'int' - 整数类型
   *   - nullable: true - 允许为空（可选字段）
   *   - default: null - 默认值为 null
   * 
   * 说明：
   *   - 可选字段在 TypeScript 中使用 ? 标记
   *   - 数据库列也设置为 nullable: true
   */</span>
  @<span class="hljs-title class_">Column</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">'int'</span>, <span class="hljs-attr">nullable</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">default</span>: <span class="hljs-literal">null</span> })
  age?: number;

  <span class="hljs-comment">/**
   * <span class="hljs-doctag">@CreateDateColumn</span>() - 创建时间列装饰器
   * 
   * 作用：自动管理记录的创建时间
   * 
   * 说明：
   *   - TypeORM 会在插入新记录时自动设置当前时间
   *   - 类型为 Date，对应 MySQL 的 DATETIME 或 TIMESTAMP
   *   - 不需要手动设置，TypeORM 会自动处理
   */</span>
  @<span class="hljs-title class_">CreateDateColumn</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">'timestamp'</span> })
  <span class="hljs-attr">createdAt</span>: <span class="hljs-title class_">Date</span>;

  <span class="hljs-comment">/**
   * <span class="hljs-doctag">@UpdateDateColumn</span>() - 更新时间列装饰器
   * 
   * 作用：自动管理记录的更新时间
   * 
   * 说明：
   *   - TypeORM 会在更新记录时自动更新为当前时间
   *   - 每次执行 UPDATE 操作时，此字段会自动更新
   *   - 不需要手动设置，TypeORM 会自动处理
   */</span>
  @<span class="hljs-title class_">UpdateDateColumn</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">'timestamp'</span> })
  <span class="hljs-attr">updatedAt</span>: <span class="hljs-title class_">Date</span>;
}


</code></pre>
<p>user.module.ts，user的模块，导入其他模块的提供者，或者导出自己的提供者给其他的模块导入。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Module</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">TypeOrmModule</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/typeorm'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">UserService</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./user.service'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">UserController</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./user.controller'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">User</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./entities/user.entity'</span>;

<span class="hljs-comment">/**
 * UserModule - 用户模块
 * 
 * 封装用户相关的所有功能：
 * - UserController: 处理用户相关的 HTTP 请求
 * - UserService: 处理用户相关的业务逻辑
 * - User Entity: 用户实体类（数据库表映射）
 */</span>

<span class="hljs-comment">/**
 * <span class="hljs-doctag">@Module</span>() - 模块装饰器
 * 
 * 作用：定义一个 NestJS 模块，是组织代码的基本单元
 * 
 * 参数说明：
 *   - controllers: 注册该模块中的控制器
 *     * 作用：使控制器可以处理 HTTP 请求
 *     * 说明：只有在此数组中注册的控制器才能被 NestJS 识别和处理
 * 
 *   - providers: 注册该模块中的提供者（服务、工厂等）
 *     * 作用：使服务可以被依赖注入系统管理
 *     * 说明：只有在此数组中注册的服务才能被注入使用
 *     * 注意：服务默认是单例的，整个应用共享一个实例
 * 
 *   - exports: 导出该模块中的提供者
 *     * 作用：使其他模块可以导入并使用这些提供者
 *     * 说明：
 *       - 只有导出的服务才能被其他模块使用
 *       - 如果 UserService 被导出，其他模块导入 UserModule 后就可以使用 UserService
 *       - 这是模块间共享功能的标准方式
 * 
 *   - imports: 导入其他模块
 *     * 作用：使当前模块可以使用其他模块导出的功能
 *     * 说明：例如导入 TypeOrmModule.forFeature() 可以使用数据库 Repository
 * 
 * 模块的作用：
 *   1. 代码组织：将相关功能组织在一起
 *   2. 依赖管理：管理模块内部的依赖关系
 *   3. 封装：隐藏内部实现，只暴露必要的接口
 *   4. 可复用：导出的服务可以在多个模块中复用
 * 
 * 模块的层次结构：
 *   - 根模块（AppModule）：应用的入口模块
 *   - 功能模块（如 UserModule）：封装特定功能的模块
 *   - 共享模块：提供通用功能的模块
 */</span>
@<span class="hljs-title class_">Module</span>({
  <span class="hljs-comment">/**
   * TypeOrmModule.forFeature([User]) - 注册实体到 TypeORM
   * 
   * 作用：在当前模块中注册 TypeORM 实体，使该模块可以使用 Repository
   * 
   * 参数说明：
   *   - [User] - 实体类数组，指定要在该模块中使用的实体
   * 
   * 说明：
   *   - forFeature() 必须在每个需要使用 Repository 的模块中调用
   *   - 注册后，可以在该模块的服务中注入 Repository&lt;User&gt;
   *   - 与 forRoot() 的区别：
   *     * forRoot(): 在根模块中配置数据库连接（全局配置）
   *     * forFeature(): 在功能模块中注册实体（模块级配置）
   * 
   * 使用示例：
   *   // user.service.ts
   *   constructor(
   *     <span class="hljs-doctag">@InjectRepository</span>(User)
   *     private userRepository: Repository&lt;User&gt;,
   *   ) {}
   */</span>
  <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">TypeOrmModule</span>.<span class="hljs-title function_">forFeature</span>([<span class="hljs-title class_">User</span>])],

  <span class="hljs-comment">/**
   * controllers - 控制器数组
   * 
   * 作用：注册该模块中的控制器
   * 说明：UserController 会被注册，可以处理 /api/users 相关的请求
   */</span>
  <span class="hljs-attr">controllers</span>: [<span class="hljs-title class_">UserController</span>],

  <span class="hljs-comment">/**
   * providers - 提供者数组
   * 
   * 作用：注册该模块中的服务
   * 说明：UserService 会被注册，可以在 UserController 中注入使用
   */</span>
  <span class="hljs-attr">providers</span>: [<span class="hljs-title class_">UserService</span>],

  <span class="hljs-comment">/**
   * exports - 导出数组
   * 
   * 作用：导出 UserService，使其他模块可以导入 UserModule 并使用 UserService
   * 使用场景：
   *   - 如果其他模块（如 OrderModule）需要使用 UserService
   *   - 可以在 OrderModule 中导入 UserModule
   *   - 然后在 OrderService 中注入 UserService
   * 
   * 示例：
   *   // order.module.ts
   *   <span class="hljs-doctag">@Module</span>({
   *     imports: [UserModule], // 导入 UserModule
   *     ...
   *   })
   *   
   *   // order.service.ts
   *   constructor(private userService: UserService) {} // 可以注入使用
   */</span>
  <span class="hljs-attr">exports</span>: [<span class="hljs-title class_">UserService</span>],
})
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserModule</span> {}
</code></pre>
<h2 data-id="heading-11">总结</h2>
<p>以上是 Nest.js 的基础介绍及简易 CRUD 实现，这是我入门 Nest.js 的第一步，也是个人学习记录。</p>
<p>想要深入学习，可优先查阅官方文档，也可参考其他博主的文章与视频。</p>
<p>不必纠结 “学 Nest.js 为何不直接学 Java/Go”：作为前端开发者，我学习 Nest.js 的成本更低，且现阶段并非为了工作业务应用，更多是方便自己偶尔编写一些个人小Demo。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[为什么说 String 是 JavaScript 中“最安静却最危险”的类型]]></title>    <link>https://juejin.cn/post/7586587644823191586</link>    <guid>https://juejin.cn/post/7586587644823191586</guid>    <pubDate>2025-12-23T02:25:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586587644823191586" data-draft-id="7586559672129437748" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="为什么说 String 是 JavaScript 中“最安静却最危险”的类型"/> <meta itemprop="keywords" content="前端,JavaScript,程序员"/> <meta itemprop="datePublished" content="2025-12-23T02:25:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="软件求生"/> <meta itemprop="url" content="https://juejin.cn/user/1038379932466263"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            为什么说 String 是 JavaScript 中“最安静却最危险”的类型
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1038379932466263/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    软件求生
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T02:25:34.000Z" title="Tue Dec 23 2025 02:25:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>大家好，我是 31 岁、爱折腾代码、也爱把技术讲成故事的小米。</p>
<p>如果你写 JavaScript 的时间够久，一定会有一种感觉：</p>
<blockquote>
<p>JS 里最熟悉、用得最多、但又最容易被忽略的类型，就是 String。</p>
</blockquote>
<p>我们天天在用它，却很少认真“聊一聊它”。于是有一天，我在敲代码的时候突然脑补了一个画面：</p>
<blockquote>
<p><strong>String 不是字符串，它是一个庞大的“文字王国”。</strong></p>
</blockquote>
<p>今天这篇文章，我就带你跟着我，一起走进 JavaScript 的<strong>文字王国</strong>，看看 String 这个“老朋友”，到底藏了多少你可能没认真想过的秘密。</p>
<h2 data-id="heading-0">字符字面量：文字王国的“入口大门”</h2>
<p>故事要从“进城”说起。在 JavaScript 里，只要你想进入文字王国，就必须从<strong>字符字面量</strong>这几扇大门进去。</p>
<p><strong>1、三种最常见的字符字面量</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/17eaef09612543e1ba37052969ae06ed~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2v5Lu25rGC55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767061533&amp;x-signature=Hlcb3v%2BAXSMmisRwfF6DpCS3%2Bzw%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>在 JS 里，字符串可以用：</p>
<ul>
<li>双引号 "</li>
<li>单引号 '</li>
<li>反引号 `（模板字面量）</li>
</ul>
<p>我第一次学 JS 的时候，特别纠结： <strong>“老师，到底用单引号还是双引号？”</strong></p>
<p>后来工作几年才发现：<strong>JavaScript 本身不在乎，项目规范才在乎。</strong></p>
<p><strong>2、转义字符：城门的“暗号”</strong></p>
<p>如果你想在字符串里放一些“特殊角色”，就得用转义字符。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3e1d4f73f2cc400683029d53d58dbbfa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2v5Lu25rGC55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767061533&amp;x-signature=T64C%2FkBq8%2FqIN30kgPY11z%2FCv4U%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>常见转义字符对照表：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a0c688cd1eec4fa4b35421b872aecde0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2v5Lu25rGC55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767061533&amp;x-signature=kc%2FG0nExT4E8jYt%2BT2BNuJZ4LVM%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>在文字王国里，<strong>反斜杠就像“通行证”，告诉 JS：后面这个字符别按原来的意思理解。</strong></p>
<h2 data-id="heading-1">字符串的特点：文字王国的“基本国法”</h2>
<p>进了城，总要先了解这个国家的基本规则。</p>
<p><strong>1、字符串是“不可变的”</strong></p>
<p>这是 String 最重要、也是最容易被忽略的一点：<strong>字符串一旦创建，就不可被修改。</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/facbe3c7df89484aa42d12c80484ca25~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2v5Lu25rGC55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767061533&amp;x-signature=dt3f1MYy9wOBQWbzwydsiqA6f8U%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>你以为你在改字符串，实际上 JS 在心里冷冷地对你说了一句：“对不起，本国不支持原地修改。”</p>
<p>你真正能做的，只是<strong>创建一个新字符串</strong>。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/42f3646a545644f8b9a6ca85ce9a0371~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2v5Lu25rGC55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767061533&amp;x-signature=3hab4wfjHQCKUPUdHYBr2yTaGjg%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>字符串就像一块已经烤好的蛋糕，你不能从中间挖一块再塞回去，你只能<strong>重新烤一块新的。</strong></p>
<p><strong>2、字符串有 length，但不是数组</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c5472b6befd24af89c0aede528f1bd18~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2v5Lu25rGC55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767061533&amp;x-signature=LhIXUpTxdiNYnSAJT7P4i8QOR5E%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>很多新人一看到 str[0]，就误以为字符串是数组。</p>
<p><strong>错。</strong> 字符串只是 <strong>“像数组一样可读”</strong> ，但本质不是数组。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/db36915bcf544aa8a319e9ce5c27ec75~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2v5Lu25rGC55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767061533&amp;x-signature=K%2F1JKnQ4zLSh75BeDQKATeoBpec%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<h2 data-id="heading-2">转换为字符串：跨国公民的“身份转换”。</h2>
<p>在文字王国里，经常会有“外来人口”，比如：数字、布尔值、对象……他们想进城，就必须<strong>变成字符串</strong>。</p>
<p><strong>1、使用 String()</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/27fd57562330497093f18e1d1d9fdcfe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2v5Lu25rGC55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767061533&amp;x-signature=ZjZIU2Agx%2B4FJjklcEwLgsONq70%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>这是最安全、最通用的方式。</p>
<p><strong>2、使用 toString()</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/12e9a3fee69d486dbd158746cdbac086~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2v5Lu25rGC55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767061533&amp;x-signature=jvL2Acwq6iWnltPifB3GW7Yb4sk%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>但要注意：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d27855b2d48e4e7d85bc8a4bba9b8fab~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2v5Lu25rGC55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767061533&amp;x-signature=lxRnGAuixgxy4C9oVkl%2B00bqh8I%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><strong>3、经验总结</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c0738ad2d30141c0a1952de289d1ee31~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2v5Lu25rGC55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767061533&amp;x-signature=z1vWKstVQztKCPDzTmA5Cgm6qTE%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><strong>4、隐式转换（不推荐但你一定见过）</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1f99955d6d3e4650a94df180c134d4ce~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2v5Lu25rGC55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767061533&amp;x-signature=O96jGD0aMUqVdlsIz15ipVR%2BYIU%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>这是 JS 在背后偷偷做的事情。小米的忠告是：<strong>面试可以说，代码里少用。</strong></p>
<h2 data-id="heading-3">模板字面量：文字王国的“高级语法”</h2>
<p>ES6 之后，文字王国迎来了一次“技术革命”。</p>
<p><strong>1、模板字面量登场</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4f828d53315640d3b07046a7b8274368~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2v5Lu25rGC55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767061533&amp;x-signature=evX%2F%2FjqcZJZ9M7ioXTnR1oKsakk%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>你第一次用模板字面量时，一定会有一种感觉：“以前那堆 + 拼字符串的日子，终于结束了。”</p>
<p><strong>2、支持多行字符串</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/01e45161932149c5bfe5f47293e6712e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2v5Lu25rGC55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767061533&amp;x-signature=hXKePtWfoIviFGgi2BXxkklbHCE%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>不用 \n，不用拼接，<strong>写什么样，就是什么样。</strong></p>
<h2 data-id="heading-4">字符串插值：让字符串“活起来”</h2>
<p>模板字面量真正的灵魂，是<strong>字符串插值</strong>。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fa4d1488a28c4dcca18c9a5139a59e4d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2v5Lu25rGC55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767061533&amp;x-signature=e0k8BQbTyWGKRIpdxaWZ8JUQFcA%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>${} 里：</p>
<ul>
<li>可以写变量</li>
<li>可以写表达式</li>
<li>可以写函数调用</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ffba3da2d53f47ecb362535ff317d432~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2v5Lu25rGC55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767061533&amp;x-signature=C0ymmEFGvrujx1Zh5SiHfzDmB%2FE%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><strong>本质理解</strong></p>
<p>字符串插值不是“拼接字符串”，而是 <strong>“在字符串里执行 JavaScript 表达式”。</strong></p>
<h2 data-id="heading-5">模板字面量标签函数：文字王国的“翻译官”</h2>
<p>接下来这一部分，是很多人<strong>见过，但没用过，也没搞懂的高级玩法</strong>。</p>
<p><strong>1、什么是标签函数？</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d5b9fa9b50554c31b9ffd210dc39c15f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2v5Lu25rGC55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767061533&amp;x-signature=9jZHQ0PufzA%2F6HHew9TBGY0S7QY%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>输出结果：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2eba3129b8904562aa716c98d5feeb21~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2v5Lu25rGC55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767061533&amp;x-signature=vC0KAmfTdTZOQ7g1SqmqkwMVwhM%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><strong>解释一下</strong></p>
<ul>
<li>strings：被 ${} 分割后的字符串数组</li>
<li>values：插值表达式的值</li>
</ul>
<p><strong>2、标签函数能干嘛？</strong></p>
<p>示例：防止 XSS</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3d12c54fa0d54d3fb364a16b639debb1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2v5Lu25rGC55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767061533&amp;x-signature=UMD3BVx5FY6cYDqhYCE5Bqxf7Gk%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><strong>现实意义</strong></p>
<ul>
<li>模板引擎</li>
<li>SQL 构建</li>
<li>XSS 防护</li>
<li>国际化文本处理</li>
</ul>
<p>可以理解为：<strong>标签函数 = 字符串的“预处理器”。</strong></p>
<h2 data-id="heading-6">原始字符串：不被转义的“原貌文本”</h2>
<p>最后一个点，非常细，但非常有用。</p>
<p><strong>1、什么是原始字符串？</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f587fa5811a940ac81981b291bb2000e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2v5Lu25rGC55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767061533&amp;x-signature=CjNH66icLhhOWjYlWPVs8F10Qp4%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>String.raw 会<strong>保留字符串的原始内容</strong>。</p>
<p><strong>2、使用场景</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a35502ba16eb4b518a5e08f0a2bf9861~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2v5Lu25rGC55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767061533&amp;x-signature=Yqzb1NkkZAk7L0cXtwbkw3J6yWE%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>适合：</p>
<ul>
<li>正则表达式</li>
<li>Windows 路径</li>
<li>需要精确字符的场景</li>
</ul>
<p><strong>一句话总结</strong></p>
<p>原始字符串，就是“我写什么，你就给我什么”。</p>
<h2 data-id="heading-7">总结：String 不简单，只是你太熟了</h2>
<p>写到这里，小米想说一句掏心窝子的：</p>
<blockquote>
<p><strong>String 是 JavaScript 里最基础的类型之一，也是最容易被低估的类型之一。</strong></p>
</blockquote>
<p>你天天在用它，但真正理解它的<strong>不可变性、模板能力、标签函数</strong>之后，你会发现：</p>
<ul>
<li>代码更优雅</li>
<li>思路更清晰</li>
<li>面试也更有底气</li>
</ul>
<h2 data-id="heading-8">END</h2>
<p>我是小米，一个喜欢分享技术的31岁程序员。如果你喜欢我的文章，欢迎关注我的微信公众号“<strong>软件求生</strong>”，获取更多技术干货！</p>
<p>好朋友们，我们下篇见。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Glide BitmapPool 实现原理笔记]]></title>    <link>https://juejin.cn/post/7586585688004460585</link>    <guid>https://juejin.cn/post/7586585688004460585</guid>    <pubDate>2025-12-23T02:22:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586585688004460585" data-draft-id="7586579021283541046" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Glide BitmapPool 实现原理笔记"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2025-12-23T02:22:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="心源xinyuan"/> <meta itemprop="url" content="https://juejin.cn/user/4283353029151694"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Glide BitmapPool 实现原理笔记
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4283353029151694/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    心源xinyuan
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T02:22:49.000Z" title="Tue Dec 23 2025 02:22:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Glide 的 BitmapPool 实现原理分析</h2>
<h3 data-id="heading-1">1. 概述</h3>
<p>BitmapPool 是 Glide 内存优化的核心组件之一，主要目的是复用 Bitmap 内存，减少 GC 和内存分配开销，提升应用性能。</p>
<h3 data-id="heading-2">2. 主要作用</h3>
<ul>
<li><strong>减少内存分配</strong>：复用已分配的 Bitmap 内存</li>
<li><strong>降低 GC 频率</strong>：避免频繁创建和回收 Bitmap</li>
<li><strong>提升性能</strong>：减少系统级的内存分配调用</li>
<li><strong>防止 OOM</strong>：通过合理的复用策略管理内存</li>
</ul>
<h3 data-id="heading-3">3. 核心实现类：LruBitmapPool</h3>
<h4 data-id="heading-4">3.1 主要数据结构</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LruBitmapPool</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">BitmapPool</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> LruPoolStrategy strategy;  <span class="hljs-comment">// 存储策略</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Set&lt;Bitmap&gt; allowList;     <span class="hljs-comment">// 白名单（某些Bitmap不放入池）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> initialMaxSize;       <span class="hljs-comment">// 初始最大容量</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">long</span> maxSize;                    <span class="hljs-comment">// 当前最大容量</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">long</span> currentSize;                <span class="hljs-comment">// 当前已使用大小</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> hits, misses;               <span class="hljs-comment">// 命中统计</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> puts;                       <span class="hljs-comment">// 放入统计</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> evictions;                  <span class="hljs-comment">// 驱逐统计</span>
}
</code></pre>
<h4 data-id="heading-5">3.2 存储策略（LruPoolStrategy）</h4>
<p>根据 Android 版本使用不同策略：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Android 4.4+ 使用 SizeConfigStrategy</span>
<span class="hljs-keyword">static</span> LruPoolStrategy <span class="hljs-title function_">getDefaultStrategy</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.KITKAT) {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SizeConfigStrategy</span>();
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AttributeStrategy</span>();
    }
}
</code></pre>
<p><strong>SizeConfigStrategy（Android 4.4+）：</strong></p>
<ul>
<li>按 Bitmap 配置（ARGB_8888, RGB_565等）和大小分组</li>
<li>使用 <code>GroupedLinkedMap</code> 存储相同配置的 Bitmap</li>
<li>支持复用更大尺寸的 Bitmap（需重新配置）</li>
</ul>
<p><strong>AttributeStrategy（Android 4.4以下）：</strong></p>
<ul>
<li>按 width、height、config 精确匹配</li>
<li>使用简单 HashMap 存储</li>
</ul>
<h3 data-id="heading-6">4. 关键方法实现</h3>
<h4 data-id="heading-7">4.1 get() - 获取 Bitmap</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> Bitmap <span class="hljs-title function_">get</span><span class="hljs-params">(<span class="hljs-type">int</span> width, <span class="hljs-type">int</span> height, Bitmap.Config config)</span> {
    <span class="hljs-type">Bitmap</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> getDirtyOrNull(width, height, config);
    <span class="hljs-keyword">if</span> (result != <span class="hljs-literal">null</span>) {
        <span class="hljs-comment">// 清零Bitmap数据</span>
        result.eraseColor(Color.TRANSPARENT);
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// 池中没有合适的，创建新的</span>
        result = createBitmap(width, height, config);
    }
    <span class="hljs-keyword">return</span> result;
}

<span class="hljs-keyword">private</span> Bitmap <span class="hljs-title function_">getDirtyOrNull</span><span class="hljs-params">(<span class="hljs-type">int</span> width, <span class="hljs-type">int</span> height, Bitmap.Config config)</span> {
    <span class="hljs-comment">// 1. 参数校验</span>
    Preconditions.checkArgument(width &gt; <span class="hljs-number">0</span> &amp;&amp; height &gt; <span class="hljs-number">0</span>);
    
    <span class="hljs-comment">// 2. 获取合适的Bitmap</span>
    <span class="hljs-type">Bitmap</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> strategy.get(width, height, config);
    <span class="hljs-keyword">if</span> (result == <span class="hljs-literal">null</span>) {
        misses++;
    } <span class="hljs-keyword">else</span> {
        hits++;
        currentSize -= strategy.getSize(result);
        <span class="hljs-comment">// 从allowList移除</span>
        allowList.remove(result);
        <span class="hljs-comment">// 重新配置Bitmap</span>
        normalize(result);
    }
    <span class="hljs-keyword">return</span> result;
}
</code></pre>
<h4 data-id="heading-8">4.2 put() - 放入 Bitmap</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">put</span><span class="hljs-params">(Bitmap bitmap)</span> {
    <span class="hljs-comment">// 1. 参数校验</span>
    Preconditions.checkNotNull(bitmap);
    Preconditions.checkArgument(bitmap.isMutable());
    Preconditions.checkArgument(bitmap.getWidth() &gt; <span class="hljs-number">0</span> 
        &amp;&amp; bitmap.getHeight() &gt; <span class="hljs-number">0</span>);
    
    <span class="hljs-comment">// 2. 计算大小并尝试放入</span>
    <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">size</span> <span class="hljs-operator">=</span> strategy.getSize(bitmap);
    strategy.put(bitmap);
    puts++;
    currentSize += size;
    
    <span class="hljs-comment">// 3. 执行LRU清理</span>
    evict();
}

<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">evict</span><span class="hljs-params">()</span> {
    trimToSize(maxSize);
}

<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">trimToSize</span><span class="hljs-params">(<span class="hljs-type">long</span> size)</span> {
    <span class="hljs-keyword">while</span> (currentSize &gt; size) {
        <span class="hljs-comment">// 移除最近最少使用的Bitmap</span>
        <span class="hljs-keyword">final</span> <span class="hljs-type">Bitmap</span> <span class="hljs-variable">removed</span> <span class="hljs-operator">=</span> strategy.removeLast();
        <span class="hljs-keyword">if</span> (removed == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">break</span>;
        }
        currentSize -= strategy.getSize(removed);
        removed.recycle();
        evictions++;
    }
}
</code></pre>
<h3 data-id="heading-9">5. 内存管理策略</h3>
<h4 data-id="heading-10">5.1 大小计算</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getBitmapByteSize</span><span class="hljs-params">(<span class="hljs-type">int</span> width, <span class="hljs-type">int</span> height, 
                                     Bitmap.Config config)</span> {
    <span class="hljs-keyword">return</span> width * height * getBytesPerPixel(config);
}

<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getBytesPerPixel</span><span class="hljs-params">(Bitmap.Config config)</span> {
    <span class="hljs-keyword">switch</span> (config) {
        <span class="hljs-keyword">case</span> ARGB_8888:
            <span class="hljs-keyword">return</span> <span class="hljs-number">4</span>;
        <span class="hljs-keyword">case</span> RGB_565:
        <span class="hljs-keyword">case</span> ARGB_4444:
            <span class="hljs-keyword">return</span> <span class="hljs-number">2</span>;
        <span class="hljs-keyword">case</span> ALPHA_8:
            <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
        <span class="hljs-keyword">default</span>:
            <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
    }
}
</code></pre>
<h4 data-id="heading-11">5.2 自适应大小调整</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setSizeMultiplier</span><span class="hljs-params">(<span class="hljs-type">float</span> sizeMultiplier)</span> {
    maxSize = Math.round(initialMaxSize * sizeMultiplier);
    evict();  <span class="hljs-comment">// 调整后立即清理</span>
}
</code></pre>
<h3 data-id="heading-12">6. 与 Glide 其他组件的协作</h3>
<h4 data-id="heading-13">6.1 与 MemoryCache 的关系</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 在Engine中协调使用</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Engine</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">EngineJobListener</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> MemoryCache memoryCache;  <span class="hljs-comment">// 存储解码后的图片</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> BitmapPool bitmapPool;    <span class="hljs-comment">// 存储可复用的Bitmap内存</span>
    
    <span class="hljs-comment">// 当从MemoryCache移除时，放入BitmapPool</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onResourceReleased</span><span class="hljs-params">(Key key, Resource resource)</span> {
        <span class="hljs-keyword">if</span> (resource.isCacheable()) {
            memoryCache.put(key, resource);
        } <span class="hljs-keyword">else</span> {
            bitmapPool.put(resource.get().getBitmap());
        }
    }
}
</code></pre>
<h4 data-id="heading-14">6.2 与 Downsampler 的协作</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Downsampler使用BitmapPool复用内存</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Bitmap <span class="hljs-title function_">decodeStream</span><span class="hljs-params">(InputStream is, BitmapPool pool, 
                                   DecodeFormat decodeFormat)</span> {
    <span class="hljs-comment">// 从pool获取Bitmap</span>
    <span class="hljs-type">Bitmap</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> pool.get(options.outWidth, options.outHeight, 
                            options.inPreferredConfig);
    <span class="hljs-comment">// 解码到复用的Bitmap中</span>
    <span class="hljs-keyword">return</span> BitmapFactory.decodeStream(is, <span class="hljs-literal">null</span>, options);
}
</code></pre>
<h3 data-id="heading-15">7. 性能优化技巧</h3>
<h4 data-id="heading-16">7.1 Bitmap 复用条件</h4>
<ol>
<li><strong>Mutable</strong>：必须是可变的 Bitmap</li>
<li><strong>Size &gt;= Requested</strong>：尺寸必须大于等于请求尺寸</li>
<li><strong>Config Compatible</strong>：配置兼容（可向下兼容）</li>
<li><strong>Reusable</strong>：Android 4.4+ 支持复用任意配置的 Bitmap</li>
</ol>
<h4 data-id="heading-17">7.2 配置建议</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 在GlideModule中配置</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyGlideModule</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">GlideModule</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">applyOptions</span><span class="hljs-params">(Context context, GlideBuilder builder)</span> {
        <span class="hljs-comment">// 根据设备内存动态设置</span>
        <span class="hljs-type">ActivityManager</span> <span class="hljs-variable">am</span> <span class="hljs-operator">=</span> (ActivityManager) 
            context.getSystemService(Context.ACTIVITY_SERVICE);
        <span class="hljs-type">boolean</span> <span class="hljs-variable">isLargeHeap</span> <span class="hljs-operator">=</span> (context.getApplicationInfo().flags 
            &amp; ApplicationInfo.FLAG_LARGE_HEAP) != <span class="hljs-number">0</span>;
        
        <span class="hljs-type">int</span> <span class="hljs-variable">memoryCacheSize</span> <span class="hljs-operator">=</span> isLargeHeap ? <span class="hljs-number">256</span> : <span class="hljs-number">128</span>;
        <span class="hljs-type">int</span> <span class="hljs-variable">bitmapPoolSize</span> <span class="hljs-operator">=</span> isLargeHeap ? <span class="hljs-number">128</span> : <span class="hljs-number">64</span>;
        
        builder.setMemoryCache(
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">LruResourceCache</span>(memoryCacheSize * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>));
        builder.setBitmapPool(
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">LruBitmapPool</span>(bitmapPoolSize * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>));
    }
}
</code></pre>
<h3 data-id="heading-18">8. 注意事项</h3>
<ol>
<li><strong>线程安全</strong>：<code>LruBitmapPool</code> 使用 <code>synchronized</code> 保证线程安全</li>
<li><strong>内存计算</strong>：精确计算 Bitmap 内存占用</li>
<li><strong>配置兼容</strong>：注意不同 Android 版本的差异</li>
<li><strong>白名单机制</strong>：某些特殊 Bitmap 不放入池中</li>
</ol>
<h3 data-id="heading-19">9. 总结</h3>
<p>Glide 的 BitmapPool 通过精妙的 LRU 策略和版本适配，实现了高效的 Bitmap 内存复用：</p>
<ul>
<li><strong>减少 80%+ 的 Bitmap 分配</strong>：显著降低 GC 压力</li>
<li><strong>智能匹配策略</strong>：根据配置和尺寸灵活复用</li>
<li><strong>动态内存管理</strong>：根据应用状态调整池大小</li>
<li><strong>版本兼容</strong>：适配不同 Android 版本的特性</li>
</ul>
<p>这种设计使得 Glide 在加载大量图片时仍能保持流畅的性能和低内存占用。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[三步高效拆解顶刊论文]]></title>    <link>https://juejin.cn/post/7586587644823257122</link>    <guid>https://juejin.cn/post/7586587644823257122</guid>    <pubDate>2025-12-23T02:33:08.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586587644823257122" data-draft-id="7586569284551409704" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="三步高效拆解顶刊论文"/> <meta itemprop="keywords" content="算法"/> <meta itemprop="datePublished" content="2025-12-23T02:33:08.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="MobotStone"/> <meta itemprop="url" content="https://juejin.cn/user/3839909554568840"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            三步高效拆解顶刊论文
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3839909554568840/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    MobotStone
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T02:33:08.000Z" title="Tue Dec 23 2025 02:33:08 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>最近我在社区发起了一个关于“内容偏好”的投票，结果既在意料之外，又在情理之中。我问大家：是更倾向于“三分钟快速听完论文概要”，还是愿意花“一小时深度解析一篇论文”？</p>
<p>结果<strong>77%的同学选择了后者——深度解析</strong>。但更让我惊喜且感动的，是评论区里大量涌现的另一种声音。许多小伙伴留言说：“其实具体的论文内容只是其次，我真正渴望的是掌握那套‘读论文的方法论’。我希望你能说说你是怎么阅读论文的，让我下一次面对陌生论文时不再迷茫。”</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a26ac874e1a84a199fb75671597951c1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTW9ib3RTdG9uZQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767061988&amp;x-signature=KnpQ%2FJe9sZGxw1j%2BSAJUFHu0KDY%3D" alt="" loading="lazy"/></p>
<p>这正是人们常说的“授人以鱼不如授人以渔”。既然大家有这样的觉悟和求知欲，今天我就暂缓具体的算法讲解，专门来聊聊**“如何像审稿人一样高效阅读一篇学术论文”**。掌握这项技能，是你从被动接收知识转向主动探索科研边界的关键一步。</p>
<h3 data-id="heading-0"><strong>一、 解构论文：理解学术界的“八股文”范式</strong></h3>
<p>在深入方法论之前，我们必须先理解对手——论文本身的结构。现在的理工科论文，尤其是计算机（CS）领域的顶会论文，几乎都遵循着一套严格的<strong>IMRaD结构</strong>（Introduction, Methods, Results, and Discussion），也就是我们俗称的“学术八股文”。</p>
<p>这并非死板，而是为了科学交流的效率。一篇标准的论文通常包含以下模块：</p>
<ol>
<li><strong>Title（标题）：</strong> 浓缩的核心贡献。</li>
<li><strong>Abstract（摘要）：</strong> 整个故事的“预告片”。</li>
<li><strong>Introduction（介绍）：</strong> 类似电影的“导演阐述”，交代背景、动机和贡献。</li>
<li><strong>Related Work（相关工作）：</strong> 梳理学术坐标系，明确自己在前人基础上的位置。</li>
<li><strong>Method（方法）：</strong> 核心算法与模型构建，这是论文的心脏。</li>
<li><strong>Experiments（实验）：</strong> 用数据证明“心脏”跳动得很有力，这部分包含大量图表。</li>
<li><strong>Conclusion（结论）：</strong> 总结陈词与未来展望。</li>
</ol>
<p>这种结构化写作意味着我们<strong>完全不需要从头读到尾</strong>。如果你像读小说一样逐字阅读，不仅效率低下，更容易陷入细节的泥潭。</p>
<h3 data-id="heading-1"><strong>二、 为什么你需要“过滤”而非“全读”？</strong></h3>
<p>根据arXiv的数据显示，仅在人工智能领域，每天新上传的论文就数以百计。 <strong>“信息过载”是科研人员面临的最大痛点。</strong> 在海量文献中，真正值得你精读的文章可能只是沧海一粟。</p>
<p>因此，我们需要一种“漏斗式”<strong>的阅读策略：通过层层筛选，快速剔除无关信息，将宝贵的精力集中在高价值目标上。这也就是我今天要分享的核心技术——</strong> “三步阅读法”（The Three-Pass Approach）。</p>
<h3 data-id="heading-2"><strong>三、 实战演练：三步法详解</strong></h3>
<h4 data-id="heading-3"><strong>第一步：海选与鸟瞰（The Scanner）</strong></h4>
<ul>
<li>
<p><strong>目标：</strong> 在10-15分钟内，判断这篇文章是否值得读下去，评估其相关性与质量。</p>
</li>
<li>
<p><strong>执行步骤：</strong></p>
<ol>
<li><strong>审视标题（Title）：</strong> 判断它是否属于你的研究领域。</li>
<li><strong>细读摘要（Abstract）：</strong> 了解作者声称解决了什么问题。</li>
<li><strong>直奔结论（Conclusion）：</strong> 这是一个关键技巧。摘要通常是“画饼”，而结论是“上菜”。结论部分往往会把摘要里提出的问题，用更确凿的实验数据和结果进行呼应。对比首尾，你就能大致判断文章的完成度。</li>
<li><strong>扫描图表（Glance over Figures）：</strong> 快速翻阅实验部分的图表。虽然不需要看懂细节，但通过图表的绘制质量、数据量级，你可以直观感受作者的治学态度和工作量。</li>
</ol>
</li>
<li>
<p>**决策时刻：**读完这几部分，你就要做决定了——<strong>Pass（放弃）还是</strong>Go（继续）？如果不感兴趣或发现质量低劣，直接丢弃，不要浪费时间。如果觉得有点意思，但现在没空，可以先加入文献库。如果觉得很有价值，那就进入第二步。</p>
</li>
</ul>
<h4 data-id="heading-4"><strong>第二步：抓取骨架与逻辑（The Reader）</strong></h4>
<ul>
<li>
<p><strong>目标：</strong> 掌握文章的核心内容和逻辑流，但暂时忽略繁琐的数学证明和技术细节。</p>
</li>
<li>
<p><strong>执行步骤：</strong></p>
<ol>
<li>**通读全文（不求甚解）：**从头到尾阅读，但遇到复杂的公式推导、晦涩的证明细节时，<strong>请大胆跳过</strong>。这一步的重点是“懂逻辑”，而不是“扣细节”。</li>
<li><strong>图表即真理：</strong> 这是第二步的重中之重。文字可能会有修饰，但图表是诚实的。你要仔细看图表的X轴、Y轴分别代表什么？图中的每个数据点意味着什么？作者的方法（通常是红线或蓝线）相比Baseline（基线）提升了多少？差距是否显著？</li>
<li><strong>标注“知识盲区”：在阅读Introduction和Related Work时，作者会引用大量前人的工作（如“基于Smith等人的方法...”）。如果你发现某些被反复引用的</strong>关键文献你没读过，一定要把它们圈出来。</li>
</ol>
</li>
<li>
<p><strong>决策时刻：</strong> 这一步读完，你可能还是有些懵，这很正常。此时你有三个选择：</p>
<ul>
<li><strong>放弃：</strong> 发现内容虽好，但对自己当前的研究帮助不大。</li>
<li><strong>回溯：发现读不懂是因为基础薄弱。这时你应该</strong>暂停阅读本文，去补读刚才圈出来的那些引用的参考文献（Background Papers）。这叫“磨刀不误砍柴工”，读完前置知识再回来，门槛会低很多。</li>
<li><strong>精读：</strong> 觉得文章太棒了，必须彻底搞懂，那就进入第三步。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-5"><strong>第三步：虚拟重现与批判（The Reviewer）</strong></h4>
<ul>
<li>
<p><strong>目标：</strong> 达到“重构级”理解。不仅知道作者做了什么，还要知道他为什么这么做，以及如果是你，你会怎么做。</p>
</li>
<li>
<p><strong>执行步骤：</strong></p>
<ol>
<li>
<p><strong>虚拟复现（Virtual Re-implementation）：这是最高阶的读法。在读每一段、每一个公式时，强迫大脑进行</strong>“脑补模拟”。</p>
<ul>
<li>看到问题定义，掩卷思考：“如果是我，我会用什么方法解决？”</li>
<li>看到作者的方法，对比思考：“我的方案和他的有什么不同？为什么他选了这个？”</li>
<li>看到实验设置，批判思考：“他的实验有没有漏洞？如果我来做，能不能设计得更严谨？甚至能不能得到更好的结果？”</li>
</ul>
</li>
<li>
<p><strong>挖掘隐藏细节：</strong> 关注作者提到的那些“失败的尝试”或“未来的工作”，这些往往是后续研究的突破口。</p>
</li>
</ol>
</li>
<li>
<p><strong>最终成果：</strong> 经过这炼狱般的第三步，你应该能够做到：</p>
<ul>
<li>在脑海中完整复述文章的细节。</li>
<li>清楚其优缺点（Gap）。</li>
<li>甚至可以直接基于此复现代码或开启新的研究。</li>
</ul>
</li>
</ul>
<hr/>
<p>这套“三步法”的核心在于<strong>时间精力的非线性分配</strong>：</p>
<ul>
<li><strong>第一步是“海选”</strong> ，用最少的时间（~10分钟）筛选掉90%的噪音；</li>
<li><strong>第二步是“精选”</strong> ，梳理逻辑，构建知识网络；</li>
<li><strong>第三步是“研读”</strong> ，只有极少数对你最重要的论文才配得上这个待遇。</li>
</ul>
<p>优秀的读者不是被动接受信息，而是与作者进行深度对话。当你能够自然地在"三步阅读法"间灵活切换时，你就掌握了开启学术宝库的钥匙。正如诺贝尔物理学奖得主Richard Feynman所说："如果你不能向大一学生解释清楚一个概念，说明你自己也没有真正理解它。"而这种理解深度，正是通过结构化的深度阅读获得的。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【节点】[Filter-Dither节点]原理解析与实际应用]]></title>    <link>https://juejin.cn/post/7586588823905648649</link>    <guid>https://juejin.cn/post/7586588823905648649</guid>    <pubDate>2025-12-23T02:39:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586588823905648649" data-draft-id="7586575372621905929" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【节点】[Filter-Dither节点]原理解析与实际应用"/> <meta itemprop="keywords" content="游戏开发,图形学,Unity3D"/> <meta itemprop="datePublished" content="2025-12-23T02:39:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="SmalBox"/> <meta itemprop="url" content="https://juejin.cn/user/2218166695237532"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【节点】[Filter-Dither节点]原理解析与实际应用
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2218166695237532/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    SmalBox
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T02:39:51.000Z" title="Tue Dec 23 2025 02:39:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fchenghai37%2Fcategory_13074589.html%3Ffromshare%3Dblogcolumn%26sharetype%3Dblogcolumn%26sharerId%3D13074589%26sharerefer%3DPC%26sharesource%3Dchenghai37%26sharefrom%3Dfrom_link" target="_blank" title="https://blog.csdn.net/chenghai37/category_13074589.html?fromshare=blogcolumn&amp;sharetype=blogcolumn&amp;sharerId=13074589&amp;sharerefer=PC&amp;sharesource=chenghai37&amp;sharefrom=from_link" ref="nofollow noopener noreferrer">【Unity Shader Graph 使用与特效实现】</a><strong>专栏-直达</strong></p>
</blockquote>
<h2 data-id="heading-0">抖动技术基础概念</h2>
<p>抖动技术是一种通过引入伪随机噪声来优化量化误差的数字图像处理方法。当颜色深度不足时，图像中容易产生明显的色带现象，而抖动技术能够将这些色带分解为更细微的图案，从而获得更加平滑自然的视觉效果。在Unity ShaderGraph中，Dither节点专门用于在屏幕空间应用此类技术，通过特定的算法模式确保噪声均匀分布。</p>
<p>在实时渲染领域，抖动技术不仅用于改善颜色过渡，还广泛应用于透明度处理、阴影渲染和后期处理效果。</p>
<h2 data-id="heading-1">Dither节点核心架构</h2>
<p><img src="https://docs.unity.cn/cn/Packages-cn/com.unity.shadergraph@14.0/manual/images/DitherNodeThumb.png" alt="" loading="lazy"/></p>
<h3 data-id="heading-2">端口配置与数据类型</h3>
<p>Dither节点包含三个主要端口，各自承担特定的功能：</p>
<ul>
<li><strong>In端口</strong>：作为动态矢量输入，接收待处理的数值。该端口通常连接Alpha通道值，也可用于处理颜色矢量或其他需要抖动的数据。</li>
<li><strong>Screen Position端口</strong>：输入Vector 4类型的屏幕空间坐标，是抖动模式定位的关键依据。该端口默认绑定至屏幕位置，确保抖动图案能够基于像素位置正确分布。</li>
<li><strong>Out端口</strong>：输出经过抖动处理后的动态矢量结果，其数据类型与输入保持一致。</li>
</ul>
<h3 data-id="heading-3">算法实现原理</h3>
<p>Dither节点采用16阶Floyd-Steinberg抖动算法，这是一种经典的有序抖动技术。该算法通过预定义的阈值矩阵决定像素的量化方式，在有限颜色深度下实现最佳视觉表现。</p>
<p>核心算法流程如下：首先将屏幕坐标转换为纹理坐标，随后根据像素位置在4x4阈值矩阵中选择对应阈值。该矩阵包含16个均匀分布在0到1范围内的数值，确保抖动图案的周期性与均匀性。</p>
<h2 data-id="heading-4">URP渲染管线中的ShaderGraph环境</h2>
<h3 data-id="heading-5">渲染管线基础</h3>
<p>在深入探讨Dither节点之前，需了解Unity的渲染管线架构。目前Unity主要支持以下三种渲染管线：</p>
<ul>
<li><strong>内置渲染管线</strong>：Unity最早的渲染系统，功能基础但稳定可靠。</li>
<li><strong>可编程渲染管线</strong>：通过C#脚本控制渲染流程的高级技术，为URP和HDRP提供底层支持。</li>
<li><strong>通用渲染管线</strong>：专为多平台优化设计的现代化渲染方案，尤其适用于移动设备及中等性能要求的平台。</li>
</ul>
<h3 data-id="heading-6">ShaderGraph配置要求</h3>
<p>使用Dither节点前需确保项目正确配置URP渲染管线。创建新的ShaderGraph时，应选择URP模板以保证所有节点与功能正常可用。URP不仅提供更优的性能表现，还确保着色器在不同设备上的一致性。</p>
<h2 data-id="heading-7">Dither节点详细参数解析</h2>
<h3 data-id="heading-8">输入参数详解</h3>
<p>In输入端接收的动态矢量可为多种数据类型，具体取决于前续节点的输出。实际应用中，最常见的配置是将Float值连接至In端口，用于控制透明度阈值。</p>
<p>Screen Position输入通常保持默认连接，但在特定情况下可能需要自定义屏幕坐标。例如，当需要基于特定UV坐标或对象空间位置应用抖动时，可断开默认连接并接入自定义位置数据。</p>
<h3 data-id="heading-9">阈值控制与参数调节</h3>
<p>Dither节点的效果主要通过阈值参数控制。在实现半透明效果时，通常会创建Float参数作为Dither值，其显示范围一般设置在剪切阈值至1之间。通过动态调整此参数，可实现基于距离的透明度变化或其他动画效果。</p>
<h2 data-id="heading-10">实践应用：半透明效果实现</h2>
<h3 data-id="heading-11">基础设置流程</h3>
<p>创建基于Dither节点的半透明效果需遵循以下步骤：</p>
<ul>
<li>新建Unlit ShaderGraph并创建对应材质</li>
<li>在Graph Setting中启用Alpha Clipping功能</li>
<li>添加Dither节点并将其输出连接至Alpha Clip Threshold</li>
<li>配置阈值参数与Dither参数以实现期望的透明度范围</li>
</ul>
<h3 data-id="heading-12">菲涅尔效应结合</h3>
<p>将Dither节点与Fresnel节点结合可创建更自然的半透明效果。菲涅尔效应模拟物体边缘与中心反射率的差异，结合抖动技术后，能产生基于视角的透明度变化，特别适用于角色渲染与特效制作。</p>
<p>实现方法：创建Fresnel节点并将其输出与颜色参数相乘，随后将结果连接至Base Color，同时将Dither节点输出连接至Alpha Clip Threshold。</p>
<h3 data-id="heading-13">动态效果控制</h3>
<p>通过脚本控制Dither参数可实现动态半透明效果。例如，根据摄像机与角色的距离动态调整Dither值，当摄像机靠近时角色逐渐变为半透明，有效避免摄像机穿帮现象。</p>
<h2 data-id="heading-14">高级应用场景</h2>
<h3 data-id="heading-15">屏幕空间抖动优化</h3>
<p>Dither节点在屏幕空间的应用确保抖动图案均匀分布，这对避免重复性图案与保持视觉一致性至关重要。理解屏幕坐标与抖动阈值的关系，有助于开发者实现更精细的视觉效果。</p>
<h3 data-id="heading-16">延迟渲染兼容性</h3>
<p>在延迟渲染管线中，传统透明度处理常面临诸多限制。使用Dither节点模拟透明度效果具有显著优势，因为经抖动处理的表面仍作为不透明对象渲染，能够正常写入深度缓冲区并参与延迟光照计算。</p>
<h3 data-id="heading-17">性能优化技术</h3>
<p>相比真正的透明度渲染，Dither节点具备更优的性能表现。它有效规避了透明度排序问题，减少overdraw，同时在视觉上提供相近的体验，特别适合大规模使用半透明效果的场景。</p>
<h2 data-id="heading-18">技术实现深度解析</h2>
<h3 data-id="heading-19">算法代码分析</h3>
<p>生成的HLSL代码揭示了Dither节点的内部工作机制。核心算法包含三个主要部分：坐标转换、阈值矩阵定义与索引计算。这种实现方式确保了高效的运行性能与一致的视觉效果。</p>
<p>阈值矩阵的设计基于数学上的最优分布，16个阈值经过精心计算，确保在各种情况下均能产生自然的抖动效果。每个阈值对应4x4像素块中的特定位置，通过模运算确定当前像素应使用的阈值。</p>
<h3 data-id="heading-20">自定义扩展可能性</h3>
<p>尽管Dither节点提供标准化的抖动功能，开发者仍可通过Custom Function节点实现自定义抖动算法。这为特殊需求的应用场景提供了灵活性，允许根据项目要求调整抖动模式或阈值分布。</p>
<h2 data-id="heading-21">常见问题与解决方案</h2>
<h3 data-id="heading-22">性能瓶颈识别</h3>
<p>使用Dither节点时可能遭遇性能问题，尤其在低端设备上。通过合理配置阈值范围与优化节点连接，可在保持视觉效果的同时最小化性能开销。</p>
<h3 data-id="heading-23">视觉瑕疵处理</h3>
<p>不当的抖动参数设置可能导致视觉瑕疵，如过于明显的噪声图案或不自然的边缘。通过细致调整阈值并测试不同场景下的表现，可找到最佳参数组合。</p>
<h2 data-id="heading-24">实际项目集成指南</h2>
<h3 data-id="heading-25">材质参数配置</h3>
<p>在项目中使用Dither节点时，合理的材质参数配置至关重要。Dither参数的默认值通常设为1，而Threshold参数则用于控制Alpha剪切的具体阈值。</p>
<h3 data-id="heading-26">脚本控制接口</h3>
<p>通过C#脚本动态控制Dither参数可实现更具交互性的视觉效果。典型应用包括基于游戏状态的透明度变化、角色特殊状态指示与环境交互反馈。</p>
<hr/>
<blockquote>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fchenghai37%2Fcategory_13074589.html%3Ffromshare%3Dblogcolumn%26sharetype%3Dblogcolumn%26sharerId%3D13074589%26sharerefer%3DPC%26sharesource%3Dchenghai37%26sharefrom%3Dfrom_link" target="_blank" title="https://blog.csdn.net/chenghai37/category_13074589.html?fromshare=blogcolumn&amp;sharetype=blogcolumn&amp;sharerId=13074589&amp;sharerefer=PC&amp;sharesource=chenghai37&amp;sharefrom=from_link" ref="nofollow noopener noreferrer">【Unity Shader Graph 使用与特效实现】</a><strong>专栏-直达</strong>
（欢迎<em>点赞留言</em>探讨，更多人加入进来能更加完善这个探索的过程，🙏）</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI Rules & MCP 抄作业（附samples）]]></title>    <link>https://juejin.cn/post/7586582977708097578</link>    <guid>https://juejin.cn/post/7586582977708097578</guid>    <pubDate>2025-12-23T02:30:57.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586582977708097578" data-draft-id="7584203412197261338" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI Rules &amp; MCP 抄作业（附samples）"/> <meta itemprop="keywords" content="前端,OpenAI"/> <meta itemprop="datePublished" content="2025-12-23T02:30:57.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="一颗奇趣蛋"/> <meta itemprop="url" content="https://juejin.cn/user/998776344173454"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI Rules &amp; MCP 抄作业（附samples）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/998776344173454/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    一颗奇趣蛋
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T02:30:57.000Z" title="Tue Dec 23 2025 02:30:57 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>给“完全零基础”的小伙伴讲清楚两件事：</p>
<ol>
<li>最近很火的 MCP（Model Context Protocol）到底是什么？</li>
<li>经常听说的 “AI Rules” 又是啥？</li>
</ol>
<p>下面用“人话+例子+一步一步可抄的作业”讲明白，最后再来一张对照表，保证看完就能上手。</p>
<hr/>
<p>一、MCP：把 AI 变成“万能瑞士军刀”的插线板</p>
<ol>
<li>
<p>一句话定义<br/>
MCP = 给大模型用的“USB-C 插线板”。只要软件/数据/硬件按这个插线板做一个小接头（MCP Server），任何支持 MCP 的 AI（Claude Desktop、Cursor…）就能即插即用，不用每家单独开发插件 。</p>
</li>
<li>
<p>生活例子<br/>
你男朋友（LLM）会聊天，但不会点外卖。<br/>
过去：你想吃 KFC，得自己写代码教会他下单。<br/>
现在：KFC 官方做了一个“MCP 接头”，男朋友连上后马上知道“哦，原来 get_menu() 可以查菜单，order() 可以下单”，直接帮你点好 。</p>
</li>
<li>
<p>最小可运行 Demo（10 行代码，复制就能跑）<br/>
场景：让 AI 帮你算“打车花了多少钱”。<br/>
① 安装<br/>
npm install -g @modelcontextprotocol/sdk</p>
</li>
</ol>
<p>② 新建 fare.js</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-meta">#!/usr/bin/env node</span>
<span class="hljs-keyword">const</span> { <span class="hljs-title class_">FastMCPServer</span> } = <span class="hljs-built_in">require</span>(<span class="hljs-string">'@modelcontextprotocol/sdk'</span>);
<span class="hljs-keyword">const</span> server = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FastMCPServer</span>(<span class="hljs-string">'fare-server'</span>, <span class="hljs-string">'1.0.0'</span>);
server.<span class="hljs-title function_">addTool</span>(<span class="hljs-string">'calc_fare'</span>, <span class="hljs-string">'计算打车费'</span>,
  { <span class="hljs-attr">km</span>: { <span class="hljs-attr">type</span>: <span class="hljs-string">'number'</span>, <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span> } },
  <span class="hljs-keyword">async</span> (args) =&gt; {
    <span class="hljs-keyword">const</span> fee = args.<span class="hljs-property">km</span> * <span class="hljs-number">2.3</span> + <span class="hljs-number">10</span>;   <span class="hljs-comment">// 2.3元/公里 + 10元起步价</span>
    <span class="hljs-keyword">return</span> { fee };
  });
server.<span class="hljs-title function_">start</span>();
</code></pre>
<p>③ 给 Claude Desktop 加一条配置（settings → MCP → Add）</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"mcpServers"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"fare"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"stdio"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"command"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"node"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"args"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"/path/fare.js"</span><span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>④ 重启 Claude，聊天框直接说：<br/>
“帮我算 12 公里打车费”<br/>
→ Claude 自动调用 calc_fare，返回答案 37.6 元。<br/>
你就拥有了一个“打车计算器” MCP Server ！</p>
<hr/>
<p>二、AI Rules：给 AI 的“员工手册”</p>
<ol>
<li>
<p>一句话定义<br/>
AI Rules = 存在 GitHub（或本地）的一份“行为守则”，AI 每次开工前先读一遍，保证代码风格、变量命名、安全规范全部统一 。</p>
</li>
<li>
<p>生活例子<br/>
公司新来的实习生（AI）代码风格千奇百怪。<br/>
你把“React 项目规范”写成 rules.md 放到 GitHub，<br/>
AI 每次写组件前自动拉取这份手册，从此 tab 宽度、命名、目录结构全部一致，再也不用手动 code review 低级问题 。</p>
</li>
<li>
<p>最小可运行 Demo（5 分钟搭好）<br/>
① 在 GitHub 建个空仓库，放一条规则文件<br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fyourname%2Fai-rules%2Fblob%2Fmain%2Freact.md" target="_blank" title="https://github.com/yourname/ai-rules/blob/main/react.md" ref="nofollow noopener noreferrer">github.com/yourname/ai…</a><br/>
内容示例：</p>
</li>
</ol>
<pre><code class="hljs language-diff" lang="diff"><span class="hljs-deletion">- 组件名必须 PascalCase  </span>
<span class="hljs-deletion">- 统一使用 TypeScript 严格模式  </span>
<span class="hljs-deletion">- 禁止 any 类型</span>
</code></pre>
<p>② 本地安装 Agent-Rules MCP Server<br/>
npm install -g agent-rules-mcp</p>
<p>③ 启动（把仓库地址告诉它）<br/>
export RULES_REPO=yourname/ai-rules<br/>
agent-rules-mcp</p>
<p>④ 在 Cursor 的 .cursorrules 里加一句</p>
<pre><code class="hljs language-ini" lang="ini">mcp://agent-rules/get_rules?<span class="hljs-attr">project</span>=react
</code></pre>
<p>⑤ 以后在 Cursor 写代码时输入<br/>
“写一个按钮组件”<br/>
→ AI 会先拉取 react.md，生成的代码自动符合 PascalCase、TypeScript、无 any 类型 。</p>
<hr/>
<p>三、横向对比一张表</p>


















































<table><thead><tr><th>维度</th><th>MCP</th><th>AI Rules</th></tr></thead><tbody><tr><td>本质</td><td>让 AI“能干什么”的插线板协议</td><td>告诉 AI“怎么干”的员工手册</td></tr><tr><td>解决痛点</td><td>不同工具/数据接口碎片化；重复开发插件</td><td>项目间规范不统一；AI 输出风格混乱</td></tr><tr><td>谁提供内容</td><td>第三方服务商/你自己写的 MCP Server</td><td>你自己写的 markdown/txt 规则文件</td></tr><tr><td>存放位置</td><td>本地或远程 MCP Server</td><td>GitHub 仓库、本地文件、Gist 均可</td></tr><tr><td>更新方式</td><td>Server 升级即可，AI 端零改动</td><td>改规则文件，AI 下次自动拉取最新版</td></tr><tr><td>典型操作</td><td>“查天气”“下单”“读数据库”</td><td>“组件命名用 PascalCase”“变量前缀用 $”</td></tr><tr><td>见效速度</td><td>配置好立即多出 N 个新能力</td><td>配置好立即输出符合规范代码</td></tr><tr><td>学习成本</td><td>需写 10~30 行 JS/Python 做 Server</td><td>只需写 markdown，0 代码</td></tr></tbody></table>
<hr/>
<p>四、10 分钟速通清单（直接照做）</p>
<ol>
<li>装 Claude Desktop 或 Cursor（已有可跳过）。</li>
<li>跑一遍“打车费” MCP Server，体会“AI 瞬间多出新技能”。</li>
<li>把公司/项目现有规范 copy 到 GitHub，搭一个 AI Rules 仓库。</li>
<li>在编辑器里引用规则，让 AI 写一段代码，肉眼可见风格统一。</li>
<li>邀请同事：以后谁再手动改 tab 宽度，就请他去写 MCP Server 冷静一下 😉</li>
</ol>
<hr/>
<p>一句话总结<br/>
MCP 负责“让 AI 多长手脚”，AI Rules 负责“让 AI 别乱来”。<br/>
两个都不难，10 分钟就能各跑通一个最小例子；合起来用，AI 既厉害又听话。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AgentScope Java 核心架构深度解析]]></title>    <link>https://juejin.cn/post/7586504691846119433</link>    <guid>https://juejin.cn/post/7586504691846119433</guid>    <pubDate>2025-12-23T00:35:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586504691846119433" data-draft-id="7586482860104679451" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AgentScope Java 核心架构深度解析"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-12-23T00:35:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="不被AI替代的BOT"/> <meta itemprop="url" content="https://juejin.cn/user/151049544663532"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AgentScope Java 核心架构深度解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/151049544663532/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    不被AI替代的BOT
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T00:35:09.000Z" title="Tue Dec 23 2025 00:35:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">AgentScope Java 核心架构深度解析：从零到生产级的智能体框架</h2>
<h3 data-id="heading-1">摘要</h3>
<p>AgentScope Java 是一个面向生产环境的智能体编程框架，它巧妙地将大语言模型的推理能力、工具调用、记忆管理和多智能体协作整合在一起。本文将从架构设计者的视角，深入剖析这个框架的核心机制，看看它是如何让开发者用几行代码就能构建出具备自主决策能力的 AI 智能体的。我们会从 ReAct 推理循环、工具系统、记忆管理、多智能体协作和生产就绪特性这五个维度，逐一拆解其实现原理。
<img src="http://openwrite.cn/uploads/19881/57635/128a28b9-9816-4dc4-bcc4-4970398497a4.png" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-2">1. 入口类与核心架构</h3>
<h4 data-id="heading-3">1.1 入口类：ReActAgent</h4>
<p>AgentScope 的核心入口是 <code>ReActAgent</code>，这是框架中最常用的智能体实现。它采用建造者模式，让配置变得非常直观：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">ReActAgent</span> <span class="hljs-variable">agent</span> <span class="hljs-operator">=</span> ReActAgent.builder()
    .name(<span class="hljs-string">"Assistant"</span>)
    .sysPrompt(<span class="hljs-string">"You are a helpful assistant."</span>)
    .model(DashScopeChatModel.builder()
        .apiKey(System.getenv(<span class="hljs-string">"DASHSCOPE_API_KEY"</span>))
        .modelName(<span class="hljs-string">"qwen-plus"</span>)
        .build())
    .memory(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InMemoryMemory</span>())
    .toolkit(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Toolkit</span>())
    .maxIters(<span class="hljs-number">10</span>)
    .build();
</code></pre>
<p>从代码结构来看，<code>ReActAgent</code> 继承自 <code>AgentBase</code>，而 <code>AgentBase</code> 又实现了 <code>Agent</code> 接口。这种设计让框架既保证了灵活性，又提供了统一的基础能力。</p>
<h4 data-id="heading-4">1.2 核心类关系图</h4>
<p><img src="http://openwrite.cn/uploads/19881/57635/1bd1c55f-37ca-4ec0-9d7d-72a588a2f311.png" alt="image.png" loading="lazy"/></p>
<p>从类图可以看出，整个框架采用了清晰的层次结构：</p>
<ul>
<li><strong>Agent 接口</strong>：定义了智能体的基本契约</li>
<li><strong>AgentBase</strong>：提供基础设施（Hook、中断、状态管理）</li>
<li><strong>ReActAgent</strong>：实现具体的 ReAct 循环逻辑</li>
<li><strong>Toolkit</strong>：管理工具注册和执行</li>
<li><strong>Memory</strong>：管理对话历史</li>
</ul>
<h3 data-id="heading-5">2. ReAct 推理循环：智能体的"思考-行动"机制</h3>
<h4 data-id="heading-6">2.1 ReAct 循环流程</h4>
<p>ReAct（Reasoning and Acting）是 AgentScope 的核心模式，它让智能体能够在推理和行动之间循环，直到完成任务或达到最大迭代次数。</p>
<p><img src="http://openwrite.cn/uploads/19881/57635/327040d3-e51c-4b2d-8841-f8832841604e.png" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-7">2.2 关键技术点</h4>
<p><strong>Pipeline 模式</strong>：框架将推理和行动阶段分别封装成 <code>ReasoningPipeline</code> 和 <code>ActingPipeline</code>，每个 Pipeline 负责一个阶段的完整流程。这样做的好处是职责清晰，易于扩展和维护。</p>
<p>看一段核心代码：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> Mono&lt;Msg&gt; <span class="hljs-title function_">executeIteration</span><span class="hljs-params">(<span class="hljs-type">int</span> iter, StructuredOutputHandler handler)</span> {
    <span class="hljs-keyword">if</span> (iter &gt;= maxIters) {
        <span class="hljs-keyword">return</span> summarizing(handler);
    }
    
    <span class="hljs-keyword">return</span> checkInterruptedAsync()
        .then(reasoning(handler))
        .then(Mono.defer(<span class="hljs-built_in">this</span>::checkInterruptedAsync))
        .then(Mono.defer(() -&gt; actingOrFinish(iter, handler)));
}
</code></pre>
<p>这里有几个巧妙的设计：</p>
<ol>
<li><strong>响应式编程</strong>：使用 <code>Mono.then()</code> 链式调用，保证执行顺序</li>
<li><strong>中断检查</strong>：在关键节点检查中断标志，支持安全中断</li>
<li><strong>延迟执行</strong>：使用 <code>Mono.defer()</code> 确保每次迭代都重新计算</li>
</ol>
<p><strong>流式处理</strong>：推理阶段使用 <code>Flux&lt;ChatResponse&gt;</code> 进行流式处理，这意味着模型返回的内容是分块到达的，框架会实时处理每个块并触发相应的 Hook，让开发者能够实时看到智能体的"思考过程"。</p>
<h3 data-id="heading-8">3. 工具调用系统：让智能体"动手"的能力</h3>
<h4 data-id="heading-9">3.1 工具注册与调用流程</h4>
<p>工具系统是 AgentScope 的一大亮点，它让智能体能够调用外部功能，比如查询数据库、调用 API、执行计算等。
<img src="http://openwrite.cn/uploads/19881/57635/9c7d348c-5466-4c2c-90f6-4649b3d92183.png" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-10">3.2 工具系统的设计亮点</h4>
<p><strong>注解驱动</strong>：工具注册非常简单，只需要在方法上添加 <code>@Tool</code> 注解：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Tool(name = "get_current_time", description = "Get current time")</span>
<span class="hljs-keyword">public</span> String <span class="hljs-title function_">getCurrentTime</span><span class="hljs-params">(<span class="hljs-meta">@ToolParam(name = "timezone")</span> String timezone)</span> {
    <span class="hljs-type">ZoneId</span> <span class="hljs-variable">zoneId</span> <span class="hljs-operator">=</span> ZoneId.of(timezone);
    <span class="hljs-type">LocalDateTime</span> <span class="hljs-variable">now</span> <span class="hljs-operator">=</span> LocalDateTime.now(zoneId);
    <span class="hljs-keyword">return</span> now.format(DateTimeFormatter.ofPattern(<span class="hljs-string">"yyyy-MM-dd HH:mm:ss"</span>));
}
</code></pre>
<p>框架会自动：</p>
<ol>
<li>解析方法签名</li>
<li>生成 JSON Schema（用于 LLM 理解工具）</li>
<li>处理参数转换（JSON → Java 对象）</li>
<li>执行方法并转换结果</li>
</ol>
<p><strong>工具组管理</strong>：<code>ToolGroupManager</code> 允许将工具分组，动态激活/停用某些工具组。这在复杂场景中非常有用，比如不同阶段需要不同的工具集。</p>
<p><strong>MCP 协议支持</strong>：框架原生支持 Model Context Protocol，这意味着可以轻松集成外部 MCP 服务提供的工具，无需编写额外的集成代码。</p>
<p><strong>并行执行</strong>：<code>ParallelToolExecutor</code> 支持并行执行多个工具调用，提高效率。当模型同时调用多个工具时，它们可以并行执行，而不是串行等待。</p>
<h3 data-id="heading-11">4. 记忆管理：智能体的"记忆"系统</h3>
<h4 data-id="heading-12">4.1 记忆系统架构</h4>
<p>AgentScope 将记忆分为两类：短期记忆（Memory）和长期记忆（LongTermMemory）。</p>
<p><img src="http://openwrite.cn/uploads/19881/57635/1ac49987-9da1-4bf8-851f-645b4bb7e5da.png" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-13">4.2 记忆管理的实现细节</h4>
<p><strong>短期记忆</strong>：<code>InMemoryMemory</code> 是最简单的实现，它将消息存储在内存中的 <code>List&lt;Msg&gt;</code> 中。每次调用智能体时，用户消息和智能体回复都会被添加到记忆中，形成完整的对话历史。</p>
<p><strong>长期记忆</strong>：长期记忆通过 <code>LongTermMemoryTools</code> 暴露给智能体，智能体可以主动调用 <code>search_memory</code> 和 <code>add_memory</code> 工具。框架还支持自动管理模式，通过 <code>StaticLongTermMemoryHook</code> 在特定时机自动保存重要信息。</p>
<p><strong>状态持久化</strong>：<code>Memory</code> 接口继承自 <code>StateModule</code>，这意味着记忆可以被序列化并持久化到会话存储中。配合 <code>Session</code> 系统，可以实现对话的保存和恢复。</p>
<h3 data-id="heading-14">5. 多智能体协作：MsgHub 的巧妙设计</h3>
<h4 data-id="heading-15">5.1 多智能体通信流程</h4>
<p><code>MsgHub</code> 是 AgentScope 中实现多智能体协作的核心组件，它解决了智能体之间消息传递的繁琐问题。</p>
<p><img src="http://openwrite.cn/uploads/19881/57635/a27fa40a-7870-4a70-932a-f86eab6534a5.png" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-16">5.2 MsgHub 的设计精髓</h4>
<p><strong>自动广播机制</strong>：当智能体加入 <code>MsgHub</code> 后，框架会自动设置订阅关系。每个智能体发送的消息会自动广播给其他参与者，无需手动调用 <code>observe()</code>。</p>
<p><strong>观察者模式</strong>：<code>AgentBase</code> 维护了一个 <code>hubSubscribers</code> 映射，记录每个 Hub 的订阅者列表。当智能体调用 <code>call()</code> 时，框架会自动将消息发送给所有订阅者。</p>
<p>看一段关键代码：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// AgentBase 中的消息广播逻辑</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">broadcastToSubscribers</span><span class="hljs-params">(String hubName, Msg msg)</span> {
    List&lt;AgentBase&gt; subscribers = hubSubscribers.get(hubName);
    <span class="hljs-keyword">if</span> (subscribers != <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">for</span> (AgentBase subscriber : subscribers) {
            subscriber.observe(msg).subscribe();
        }
    }
}
</code></pre>
<p><strong>生命周期管理</strong>：<code>MsgHub</code> 实现了 <code>AutoCloseable</code> 接口，可以使用 try-with-resources 自动清理订阅关系，避免内存泄漏。</p>
<h3 data-id="heading-17">6. 生产就绪特性：企业级能力</h3>
<h4 data-id="heading-18">6.1 安全中断机制</h4>
<p>AgentScope 提供了完整的中断机制，支持在任意时刻安全地暂停智能体执行：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 外部中断</span>
agent.interrupt(userMsg);

<span class="hljs-comment">// 智能体内部检查点</span>
<span class="hljs-keyword">return</span> checkInterruptedAsync()
    .then(doWork())
    .flatMap(result -&gt; checkInterruptedAsync().thenReturn(result));
</code></pre>
<p>中断机制使用 <code>AtomicBoolean</code> 标志位和响应式编程模式，确保中断信号能够正确传播到 Mono 链中。</p>
<h4 data-id="heading-19">6.2 Hook 系统：可观测性和扩展性</h4>
<p>Hook 系统允许开发者在智能体执行的关键点注入自定义逻辑：</p>
<pre><code class="hljs language-java" lang="java">agent.addHook(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Hook</span>() {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Mono&lt;List&lt;Msg&gt;&gt; <span class="hljs-title function_">onPreReasoning</span><span class="hljs-params">(PreReasoningEvent event)</span> {
        <span class="hljs-comment">// 在推理前修改消息</span>
        <span class="hljs-keyword">return</span> Mono.just(modifiedMessages);
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Mono&lt;Void&gt; <span class="hljs-title function_">onPostActing</span><span class="hljs-params">(PostActingEvent event)</span> {
        <span class="hljs-comment">// 在工具执行后记录日志</span>
        logger.info(<span class="hljs-string">"Tool executed: {}"</span>, event.getToolCall());
        <span class="hljs-keyword">return</span> Mono.empty();
    }
});
</code></pre>
<p>框架定义了多个 Hook 事件类型，覆盖了智能体执行的各个阶段，这让监控、日志、调试变得非常方便。</p>
<h4 data-id="heading-20">6.3 响应式架构</h4>
<p>整个框架基于 Project Reactor，所有异步操作都返回 <code>Mono&lt;T&gt;</code> 或 <code>Flux&lt;T&gt;</code>。这种设计带来的好处是：</p>
<ul>
<li><strong>非阻塞执行</strong>：不会因为等待 I/O 而阻塞线程</li>
<li><strong>背压处理</strong>：Flux 天然支持背压，避免内存溢出</li>
<li><strong>组合能力</strong>：可以轻松组合多个异步操作</li>
</ul>
<h4 data-id="heading-21">6.4 状态管理与会话持久化</h4>
<p><code>StateModule</code> 接口提供了统一的状态管理能力，任何实现了该接口的组件都可以被序列化和持久化。配合 <code>Session</code> 系统，可以实现：</p>
<ul>
<li>对话历史的保存和恢复</li>
<li>智能体状态的持久化</li>
<li>多租户隔离</li>
</ul>
<h3 data-id="heading-22">7. 使用示例：快速上手</h3>
<h4 data-id="heading-23">7.1 基础对话示例</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 创建模型</span>
<span class="hljs-type">DashScopeChatModel</span> <span class="hljs-variable">model</span> <span class="hljs-operator">=</span> DashScopeChatModel.builder()
    .apiKey(System.getenv(<span class="hljs-string">"DASHSCOPE_API_KEY"</span>))
    .modelName(<span class="hljs-string">"qwen-plus"</span>)
    .build();

<span class="hljs-comment">// 创建智能体</span>
<span class="hljs-type">ReActAgent</span> <span class="hljs-variable">agent</span> <span class="hljs-operator">=</span> ReActAgent.builder()
    .name(<span class="hljs-string">"Assistant"</span>)
    .sysPrompt(<span class="hljs-string">"You are a helpful assistant."</span>)
    .model(model)
    .memory(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InMemoryMemory</span>())
    .toolkit(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Toolkit</span>())
    .build();

<span class="hljs-comment">// 调用智能体</span>
<span class="hljs-type">Msg</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> agent.call(Msg.builder()
    .role(MsgRole.USER)
    .textContent(<span class="hljs-string">"Hello!"</span>)
    .build()).block();

System.out.println(response.getTextContent());
</code></pre>
<h4 data-id="heading-24">7.2 工具调用示例</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 定义工具类</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SimpleTools</span> {
    <span class="hljs-meta">@Tool(name = "calculate", description = "Calculate math expression")</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">calculate</span><span class="hljs-params">(<span class="hljs-meta">@ToolParam(name = "expression")</span> String expr)</span> {
        <span class="hljs-comment">// 执行计算逻辑</span>
        <span class="hljs-keyword">return</span> result;
    }
}

<span class="hljs-comment">// 注册工具</span>
<span class="hljs-type">Toolkit</span> <span class="hljs-variable">toolkit</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Toolkit</span>();
toolkit.registerTool(<span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleTools</span>());

<span class="hljs-comment">// 创建带工具的智能体</span>
<span class="hljs-type">ReActAgent</span> <span class="hljs-variable">agent</span> <span class="hljs-operator">=</span> ReActAgent.builder()
    .toolkit(toolkit)
    <span class="hljs-comment">// ... 其他配置</span>
    .build();
</code></pre>
<h4 data-id="heading-25">7.3 多智能体协作示例</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 创建多个智能体</span>
<span class="hljs-type">ReActAgent</span> <span class="hljs-variable">alice</span> <span class="hljs-operator">=</span> ReActAgent.builder().name(<span class="hljs-string">"Alice"</span>).build();
<span class="hljs-type">ReActAgent</span> <span class="hljs-variable">bob</span> <span class="hljs-operator">=</span> ReActAgent.builder().name(<span class="hljs-string">"Bob"</span>).build();

<span class="hljs-comment">// 使用 MsgHub 进行协作</span>
<span class="hljs-keyword">try</span> (<span class="hljs-type">MsgHub</span> <span class="hljs-variable">hub</span> <span class="hljs-operator">=</span> MsgHub.builder()
        .participants(alice, bob)
        .build()) {
    hub.enter().block();
    
    <span class="hljs-comment">// Alice 的回复会自动广播给 Bob</span>
    alice.call().block();
    
    <span class="hljs-comment">// Bob 的回复会自动广播给 Alice</span>
    bob.call().block();
}
</code></pre>
<h3 data-id="heading-26">8. 总结</h3>
<p>AgentScope Java 是一个设计精良的智能体框架，它在易用性和功能完整性之间找到了很好的平衡。通过本文的分析，我们可以看到：</p>
<ol>
<li><strong>ReAct 循环</strong>：通过 Pipeline 模式实现了清晰的推理-行动循环，支持流式处理和中断</li>
<li><strong>工具系统</strong>：注解驱动的工具注册、工具组管理、MCP 协议支持，让扩展变得简单</li>
<li><strong>记忆管理</strong>：分离的短期和长期记忆，支持多种存储后端和持久化</li>
<li><strong>多智能体协作</strong>：MsgHub 的自动广播机制大大简化了多智能体应用的开发</li>
<li><strong>生产就绪</strong>：安全中断、Hook 系统、响应式架构、状态管理，这些特性让框架能够应对企业级需求</li>
</ol>
<p>框架的架构设计体现了几个重要的软件工程原则：</p>
<ul>
<li><strong>单一职责</strong>：每个组件都有明确的职责</li>
<li><strong>开闭原则</strong>：通过接口和抽象类支持扩展</li>
<li><strong>依赖倒置</strong>：依赖抽象而非具体实现</li>
<li><strong>响应式编程</strong>：充分利用 Reactor 的能力</li>
</ul>
<p>对于开发者来说，AgentScope Java 提供了从简单对话到复杂多智能体系统的完整解决方案，同时保持了代码的简洁性和可维护性。无论是快速原型开发还是生产环境部署，这个框架都能很好地满足需求。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Kafka 消息积压处理实战：百万级队列清空的优化技巧]]></title>    <link>https://juejin.cn/post/7586585498744324150</link>    <guid>https://juejin.cn/post/7586585498744324150</guid>    <pubDate>2025-12-23T02:45:14.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586585498744324150" data-draft-id="7586579021283803190" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Kafka 消息积压处理实战：百万级队列清空的优化技巧"/> <meta itemprop="keywords" content="后端,Java"/> <meta itemprop="datePublished" content="2025-12-23T02:45:14.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="天天摸鱼的java工程师"/> <meta itemprop="url" content="https://juejin.cn/user/3109843365802925"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Kafka 消息积压处理实战：百万级队列清空的优化技巧
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3109843365802925/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    天天摸鱼的java工程师
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T02:45:14.000Z" title="Tue Dec 23 2025 02:45:14 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Kafka 消息积压处理实战：百万级队列清空的优化技巧</h2>
<p>做Java开发八年，踩过的中间件坑没有一百也有八十，其中最让人头皮发麻的，莫过于生产环境Kafka消息积压——尤其是凌晨三点接到告警，看到监控面板上“未消费消息数”直奔百万，下游业务催着要数据，那种压力至今难忘。</p>
<p>上周团队刚处理完一场百万级消息积压的紧急故障，从定位问题到清空队列只用了4小时，后续通过代码升级彻底杜绝了复发。今天就以这次实战为例，从Java开发者的视角，把消息积压的处理逻辑、优化技巧和兜底方案讲透，希望能帮大家少走弯路。</p>
<h3 data-id="heading-1">一、紧急告警：先搞清楚“为什么积压”（业务+技术双维度分析）</h3>
<p>接到告警先别慌，盲目重启消费者只会让问题更复杂。作为资深Java开发，我的第一反应是“先定位根因”——消息积压本质是“生产速度＞消费速度”，但具体是生产端突增，还是消费端掉链子，必须用数据说话。</p>
<h4 data-id="heading-2">1. 快速排查三步法（Java开发必备）</h4>
<ul>
<li><strong>第一步：查监控数据</strong> 先看Kafka Manager的核心指标：① 生产TPS是否突增（排除突发流量）；② 消费TPS是否骤降（核心排查方向）；③ 消费者组是否正常心跳（避免消费组崩溃）；④ 分区消费进度是否均匀（排除分区分配不均）。</li>
<li><strong>第二步：查消费端日志</strong>登录消费服务节点，用Arthas排查：① 是否有大量异常日志（比如数据库超时、外部接口调用失败）；② 消费线程是否阻塞（jstack查看线程状态，是否有WAITING、BLOCKED）；③ JVM参数是否合理（GC频率、内存使用，避免OOM导致服务重启）。</li>
<li><strong>第三步：查业务依赖</strong> 我们的消费逻辑是“接收消息→解析→调用库存接口→入库”，排查后发现：下游库存服务因数据库主从切换响应超时（从200ms涨到5s），导致消费线程大量阻塞，消费TPS从1000+骤降到50以下，而生产TPS正常（2000+），积压自然越来越严重。</li>
</ul>
<h4 data-id="heading-3">2. 常见积压原因总结（八年经验沉淀）</h4>
<p>结合过往经历，Java项目中Kafka消息积压的核心原因无非三类，大家可以对号入座：</p>
<ul>
<li><strong>消费端问题（占比80%）</strong> ：① 业务逻辑冗余（比如循环调用外部接口、无效数据库查询）；② 依赖服务不稳定（超时、宕机）；③ 线程池配置不合理（核心线程数太少，队列满了不扩容）；④ 代码Bug（死循环、空指针导致消费线程退出）；⑤ 消费者重平衡频繁（分区分配策略不合理）。</li>
<li><strong>生产端问题（占比15%）</strong> ：① 突发流量（比如大促、活动导致生产TPS翻倍）；② 消息体过大（单条消息10MB+，序列化/反序列化耗时）；③ 生产重试机制不合理（失败消息反复发送，占用队列）。</li>
<li><strong>配置问题（占比5%）</strong> ：① Kafka分区数太少（并行消费能力上限低）；② 消费者fetch.min.bytes设置过大（等待数据导致延迟）；③ max.poll.records设置过小（单次拉取消息少，效率低）。</li>
</ul>
<h3 data-id="heading-4">二、快速止血：百万级积压的紧急处理方案（4小时清空实战）</h3>
<p>定位到“下游服务超时导致消费阻塞”后，我们的核心思路是“先兜底消费，再优化细节”，避免因积压时间过长导致消息过期（Kafka默认消息保留7天），具体分三步执行：</p>
<h4 data-id="heading-5">1. 第一步：临时隔离，避免问题扩散</h4>
<p>既然下游库存服务不稳定，继续让原消费者调用只会加剧阻塞。我们先做了两件事：</p>
<ul>
<li>① 暂停原消费服务的消费线程（通过配置中心动态开关，避免重启服务）；</li>
<li>② 部署临时消费服务，核心逻辑简化为“拉取消息→解析→写入临时表（MySQL）”，跳过外部接口调用——这样能快速降低积压速度，同时保留消息数据，避免丢失。</li>
</ul>
<h4 data-id="heading-6">2. 第二步：优化消费参数，提升并行能力</h4>
<p>临时消费服务的核心是“快”，我们针对性调整了Kafka消费者参数和Java线程池配置，这是提升消费速度的关键：</p>
<h5 data-id="heading-7">（1）Kafka消费者核心参数优化（Java代码配置示例）</h5>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 原配置</span>
properties<span class="hljs-selector-class">.put</span>(ConsumerConfig.MAX_POLL_RECORDS_CONFIG, <span class="hljs-number">100</span>); <span class="hljs-comment">// 单次拉取100条</span>
properties<span class="hljs-selector-class">.put</span>(ConsumerConfig.FETCH_MIN_BYTES_CONFIG, <span class="hljs-number">10240</span>); <span class="hljs-comment">// 等待10KB数据才拉取</span>
properties<span class="hljs-selector-class">.put</span>(ConsumerConfig.SESSION_TIMEOUT_MS_CONFIG, <span class="hljs-number">10000</span>); <span class="hljs-comment">// 会话超时10s</span>

<span class="hljs-comment">// 优化后配置</span>
properties<span class="hljs-selector-class">.put</span>(ConsumerConfig.MAX_POLL_RECORDS_CONFIG, <span class="hljs-number">1000</span>); <span class="hljs-comment">// 单次拉取1000条（根据内存调整，避免OOM）</span>
properties<span class="hljs-selector-class">.put</span>(ConsumerConfig.FETCH_MIN_BYTES_CONFIG, <span class="hljs-number">1024</span>); <span class="hljs-comment">// 降低等待阈值，减少延迟</span>
properties<span class="hljs-selector-class">.put</span>(ConsumerConfig.SESSION_TIMEOUT_MS_CONFIG, <span class="hljs-number">30000</span>); <span class="hljs-comment">// 延长会话超时，避免重平衡</span>
properties<span class="hljs-selector-class">.put</span>(ConsumerConfig.FETCH_MAX_WAIT_MS_CONFIG, <span class="hljs-number">500</span>); <span class="hljs-comment">// 最大等待500ms，没数据也拉取</span>
</code></pre>
<p>说明：调整后，单次拉取消息量提升10倍，等待时间缩短，消费效率直接翻倍。</p>
<h5 data-id="heading-8">（2）Java线程池优化（避免线程阻塞导致的效率低下）</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 原线程池配置（核心线程5，最大10，队列1000）</span>
<span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>(<span class="hljs-number">5</span>, <span class="hljs-number">10</span>, <span class="hljs-number">60L</span>, TimeUnit.SECONDS,
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedBlockingQueue</span>&lt;&gt;(<span class="hljs-number">1000</span>));

<span class="hljs-comment">// 优化后配置（核心线程20，最大50，队列100，拒绝策略改为丢弃 oldest）</span>
<span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>(<span class="hljs-number">20</span>, <span class="hljs-number">50</span>, <span class="hljs-number">60L</span>, TimeUnit.SECONDS,
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedBlockingQueue</span>&lt;&gt;(<span class="hljs-number">100</span>),
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>.DiscardOldestPolicy());
</code></pre>
<p>说明：原线程池队列太大，即使核心线程阻塞，新任务也会进入队列等待，无法触发最大线程数扩容；优化后队列缩小，触发最大线程数，同时拒绝策略保证最新消息优先处理（临时场景下可接受）。</p>
<h5 data-id="heading-9">（3）增加分区消费并行度</h5>
<p>Kafka的消费并行度上限是“分区数”，我们原Topic分区数是8，临时扩容到20（通过Kafka命令：kafka-topics.sh --alter --topic xxx --partitions 20），同时让临时消费服务启动20个消费线程（与分区数一致），避免分区分配不均导致的资源浪费。</p>
<h4 data-id="heading-10">3. 第三步：分批处理临时数据，补全业务链路</h4>
<p>临时消费服务运行2小时后，积压消息从120万降到30万，此时下游库存服务恢复正常。我们开始补全业务链路：</p>
<ul>
<li>① 开发分批处理程序，从临时表中批量读取数据（每次1000条），调用库存接口并入库；</li>
<li>② 启用线程池异步处理，同时加入重试机制（使用Guava Retryer，重试3次，间隔1s，失败写入死信表）；</li>
<li>③ 监控补全进度，每小时核对数据一致性，确保无遗漏。</li>
</ul>
<p>最终，剩余30万消息2小时内处理完成，整个积压问题4小时解决，下游业务无数据丢失。</p>
<h3 data-id="heading-11">三、代码升级：从根源避免消息积压的兜底策略</h3>
<p>紧急处理只是“救火”，作为资深Java开发，更要做好“防火”。我们针对这次问题，对原消费服务做了全方位代码升级，形成长期兜底方案：</p>
<h4 data-id="heading-12">1. 消费逻辑优化：异步化+解耦</h4>
<p>原消费逻辑是“同步调用外部接口”，一旦接口超时就会阻塞线程。升级后采用“异步化+消息解耦”：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 升级后消费逻辑</span>
@Override
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onMessage</span>(<span class="hljs-params">ConsumerRecord&lt;String, String&gt; <span class="hljs-keyword">record</span></span>)</span> {
    <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// 1. 解析消息（轻量操作，同步执行）</span>
        OrderMessage message = JSON.parseObject(<span class="hljs-keyword">record</span>.<span class="hljs-keyword">value</span>(), OrderMessage.<span class="hljs-keyword">class</span>);
        
        <span class="hljs-comment">// 2. 异步处理业务逻辑（提交到线程池）</span>
        CompletableFuture.runAsync(() -&gt; {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-comment">// 调用库存接口</span>
                inventoryService.updateStock(message.getOrderId(), message.getProductId(), message.getNum());
                <span class="hljs-comment">// 入库</span>
                orderMapper.insert(message);
            } <span class="hljs-keyword">catch</span> (Exception e) {
                <span class="hljs-comment">// 失败写入死信队列</span>
                deadLetterQueue.send(<span class="hljs-keyword">record</span>.<span class="hljs-keyword">value</span>(), e.getMessage());
                log.error(<span class="hljs-string">"消费消息失败，message:{}"</span>, <span class="hljs-keyword">record</span>.<span class="hljs-keyword">value</span>(), e);
            }
        }, businessExecutor);
        
    } <span class="hljs-keyword">catch</span> (Exception e) {
        log.error(<span class="hljs-string">"解析消息失败，record:{}"</span>, <span class="hljs-keyword">record</span>, <span class="hljs-title">e</span>);
    }
}
</code></pre>
<p>说明：通过CompletableFuture实现异步处理，消费线程只负责解析消息，不阻塞等待业务结果，即使业务逻辑耗时也不会影响消息拉取效率。</p>
<h4 data-id="heading-13">2. 依赖服务容错：降级+熔断</h4>
<p>针对外部服务不稳定的问题，集成Sentinel实现熔断降级，避免连锁故障：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 库存接口熔断降级配置</span>
@<span class="hljs-built_in">SentinelResource</span>(
    value = <span class="hljs-string">"updateStock"</span>,
    fallback = <span class="hljs-string">"updateStockFallback"</span>, <span class="hljs-comment">// 降级方法</span>
    blockHandler = <span class="hljs-string">"updateStockBlockHandler"</span>, <span class="hljs-comment">// 限流/熔断处理方法</span>
    fallbackClass = InventoryFallback.<span class="hljs-keyword">class</span>,
    blockHandlerClass = InventoryBlockHandler.<span class="hljs-keyword">class</span>
)
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title">updateStock</span><span class="hljs-params">(<span class="hljs-type">String</span> orderId, <span class="hljs-type">String</span> productId, <span class="hljs-type">int</span> num)</span> </span>{
    <span class="hljs-comment">// 调用外部库存接口</span>
    <span class="hljs-keyword">return</span> inventoryClient.<span class="hljs-built_in">updateStock</span>(orderId, productId, num);
}

<span class="hljs-comment">// 降级方法（本地缓存兜底）</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title">updateStockFallback</span><span class="hljs-params">(<span class="hljs-type">String</span> orderId, <span class="hljs-type">String</span> productId, <span class="hljs-type">int</span> num, Throwable e)</span> </span>{
    log.<span class="hljs-built_in">warn</span>(<span class="hljs-string">"库存接口降级，orderId:{}"</span>, orderId, e);
    <span class="hljs-comment">// 写入本地缓存，后续定时补偿</span>
    stockCache.<span class="hljs-built_in">put</span>(orderId, <span class="hljs-keyword">new</span> <span class="hljs-built_in">StockDTO</span>(productId, num));
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
}
</code></pre>
<p>说明：当库存接口响应超时（设置阈值1s）或失败率超过50%时，触发熔断，调用降级方法用本地缓存兜底，后续通过定时任务补全数据，避免消费线程阻塞。</p>
<h4 data-id="heading-14">3. 线程池监控：可视化+告警</h4>
<p>之前线程池状态不可见，导致阻塞问题发现不及时。升级后集成Spring Boot Actuator，暴露线程池监控指标：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 自定义线程池监控</span>
<span class="hljs-meta">@Bean</span>
<span class="hljs-keyword">public</span> <span class="hljs-title class_">ThreadPoolTaskExecutor</span> <span class="hljs-title function_">businessExecutor</span>(<span class="hljs-params"/>) {
    <span class="hljs-title class_">ThreadPoolTaskExecutor</span> executor = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolTaskExecutor</span>();
    executor.<span class="hljs-title function_">setCorePoolSize</span>(<span class="hljs-number">20</span>);
    executor.<span class="hljs-title function_">setMaxPoolSize</span>(<span class="hljs-number">50</span>);
    executor.<span class="hljs-title function_">setQueueCapacity</span>(<span class="hljs-number">500</span>);
    executor.<span class="hljs-title function_">setThreadNamePrefix</span>(<span class="hljs-string">"business-"</span>);
    <span class="hljs-comment">// 初始化</span>
    executor.<span class="hljs-title function_">initialize</span>();
    
    <span class="hljs-comment">// 注册监控指标</span>
    <span class="hljs-title class_">ThreadPoolMonitor</span>.<span class="hljs-title function_">register</span>(<span class="hljs-string">"businessExecutor"</span>, executor);
    <span class="hljs-keyword">return</span> executor;
}

<span class="hljs-comment">// 监控类核心逻辑</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ThreadPoolMonitor</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">register</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> name, ThreadPoolTaskExecutor executor</span>) {
        <span class="hljs-title class_">MeterRegistry</span> meterRegistry = <span class="hljs-title class_">ApplicationContextHolder</span>.<span class="hljs-title function_">getBean</span>(<span class="hljs-title class_">MeterRegistry</span>.<span class="hljs-property">class</span>);
        <span class="hljs-comment">// 线程池活跃线程数指标</span>
        meterRegistry.<span class="hljs-title function_">gauge</span>(<span class="hljs-string">"thread.pool.active.count"</span>, 
                <span class="hljs-title class_">Tags</span>.<span class="hljs-title function_">of</span>(<span class="hljs-string">"thread.pool.name"</span>, name), 
                executor, <span class="hljs-title class_">ThreadPoolTaskExecutor</span>::getActiveCount);
        <span class="hljs-comment">// 队列剩余容量指标</span>
        meterRegistry.<span class="hljs-title function_">gauge</span>(<span class="hljs-string">"thread.pool.queue.remaining"</span>, 
                <span class="hljs-title class_">Tags</span>.<span class="hljs-title function_">of</span>(<span class="hljs-string">"thread.pool.name"</span>, name), 
                executor, e -&gt; e.<span class="hljs-title function_">getQueueCapacity</span>() - e.<span class="hljs-title function_">getQueueSize</span>());
    }
}
</code></pre>
<p>同时在Prometheus+Grafana中配置告警规则：当活跃线程数达到最大线程数的80%，或队列剩余容量小于100时，触发告警，提前发现线程阻塞风险。</p>
<h4 data-id="heading-15">4. 消息可靠性保障：重试+死信队列</h4>
<p>为避免消息丢失，完善重试和死信机制：</p>
<ul>
<li>① 重试机制：使用Guava Retryer，针对暂时性异常（如网络超时）重试3次，间隔1s、2s、3s；</li>
<li>② 死信队列：重试失败的消息写入专门的死信Topic，后续通过后台管理系统手动处理，同时记录失败原因；</li>
<li>③ 消息幂等：通过订单ID做幂等校验（数据库唯一索引），避免重复消费导致数据不一致。</li>
</ul>
<h3 data-id="heading-16">四、复盘与沉淀：资深Java开发的避坑指南</h3>
<p>处理完这次问题，我总结了3条Kafka消息积压的避坑经验，适合所有Java开发者：</p>
<ol>
<li><strong>消费逻辑要“轻”</strong> ：尽量把重操作（外部接口调用、复杂计算）异步化，消费线程只做“解析消息+提交任务”，避免阻塞；</li>
<li><strong>依赖服务要“防”</strong> ：任何外部依赖都要加熔断、降级、超时控制，不能把希望寄托在依赖服务的稳定性上；</li>
<li><strong>监控告警要“全”</strong> ：不仅要监控Kafka的消息积压数，还要监控消费线程池状态、依赖服务响应时间、消息消费成功率，做到提前预警。</li>
</ol>
<h3 data-id="heading-17">结语</h3>
<p>Kafka消息积压不可怕，可怕的是没有清晰的处理思路和完善的兜底方案。作为八年Java开发，我深刻体会到：“紧急处理靠经验，长期稳定靠架构”。这次百万级积压的解决，核心是“先隔离再优化，先止血再根治”，而代码升级后的异步化、容错机制，才是避免问题复发的关键。</p>
<p>希望这篇实战总结能帮到大家，如果你在处理Kafka消息积压时遇到过其他问题，欢迎在评论区交流～</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🌐 技术迭代速度与监管适配：WebAIGC的发展平衡术]]></title>    <link>https://juejin.cn/post/7586555198115987462</link>    <guid>https://juejin.cn/post/7586555198115987462</guid>    <pubDate>2025-12-23T02:48:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586555198115987462" data-draft-id="7586582977708212266" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🌐 技术迭代速度与监管适配：WebAIGC的发展平衡术"/> <meta itemprop="keywords" content="前端,人工智能,AIGC"/> <meta itemprop="datePublished" content="2025-12-23T02:48:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="LeonGao"/> <meta itemprop="url" content="https://juejin.cn/user/3976252950591149"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🌐 技术迭代速度与监管适配：WebAIGC的发展平衡术
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3976252950591149/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    LeonGao
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T02:48:34.000Z" title="Tue Dec 23 2025 02:48:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body blockquote&gt;:first-child{margin-top:0}.markdown-body blockquote&gt;:last-child{margin-bottom:0}.markdown-body{overflow:hidden;line-height:1.75;font-size:15px;background-image:linear-gradient(90deg,rgba(72,42,10,.05) 5%,rgba(72,42,10,0) 0),linear-gradient(1turn,rgba(72,42,10,.05) 5%,rgba(72,42,10,0) 0);background-size:20px 20px;background-position:50%;padding-top:0!important}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{position:relative;display:flex;border-bottom:5px solid #6d4e00;line-height:35px;letter-spacing:1px;font-size:25px;padding-left:25px;color:#664900;text-shadow:1px 1px 1px #8a6200;padding-bottom:0}.markdown-body h1:before{content:"";display:flex;position:absolute;left:0;top:3px;bottom:0;margin:auto;width:20px;height:20px;background-size:20px 20px;background-image:url("data:image/png;base64,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")}.markdown-body h2{position:relative;padding:0 0 0 20px;font-size:20px;font-weight:700;color:#614500}.markdown-body h2:before{content:"";position:absolute;top:3px;bottom:0;left:0;background-image:url("data:image/png;base64,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");background-size:100% 100%;background-repeat:no-repeat;width:15px;height:15px;margin:auto}.markdown-body h3{width:100%;text-align:left;margin:20px 10px 0 0;font-size:18px;font-weight:700;display:inline-block;padding-left:10px;padding-bottom:0;border-left:5px solid #8f6600;color:#614500}.markdown-body h4,.markdown-body h5,.markdown-body h6{font-weight:700;color:#a37400}.markdown-body h4{font-size:17px}.markdown-body h5,.markdown-body h6{display:flex;align-items:center}.markdown-body h5:after,.markdown-body h6:after{display:inline-block;border:2px solid #fff6e0;color:rgba(189,134,0,.5);border-radius:50%;text-align:center;margin-left:5px}.markdown-body h5{font-size:14px}.markdown-body h5:after{content:"5";width:15px;height:15px;line-height:15px;font-size:13px}.markdown-body h6{font-size:12px}.markdown-body h6:after{content:"6";width:13px;height:13px;line-height:13px;font-size:12px}.markdown-body p{color:#412c0c;letter-spacing:1px;font-weight:400;margin-bottom:16px}.markdown-body img{max-width:100%;display:block;margin:auto}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#755300;font-weight:400;border-bottom:1px solid #755300;font-weight:bolder;text-decoration:none}.markdown-body table{width:100%!important;margin:0;font-size:12px;width:auto;max-width:100%;overflow:auto;border-collapse:collapse;border-spacing:0}.markdown-body table img{box-shadow:none}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body thead tr th{text-align:center}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px;box-sizing:border-box;border:1px solid rgba(72,42,10,.1)}.markdown-body blockquote{position:relative;text-size-adjust:100%;line-height:25px;font-weight:400;border-radius:10px;font-style:normal;text-align:left;box-sizing:inherit;border:1px solid #ffd87a;background-color:rgba(189,134,0,.5);margin:20px 0;padding:20px}.markdown-body blockquote p{color:#fff6e0;letter-spacing:2px;margin:0}.markdown-body blockquote:after,.markdown-body blockquote:before{position:absolute;color:#cc9100;font-size:34px;font-weight:700}.markdown-body blockquote:before{content:"❝";top:8px;left:5px}.markdown-body blockquote:after{content:"❞";right:5px;bottom:-5px}.markdown-body strong{color:#c28a00;font-weight:bolder}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{color:#c28a00}.markdown-body em strong{font-style:normal;color:#c28a00;background-color:#8a6200}.markdown-body s{color:#c28a00}.markdown-body hr{border-top:1px solid #805b00}.markdown-body code,.markdown-body li code,.markdown-body p code{color:#996d00;background-color:rgba(130,98,0,.3)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit;color:#858585;font-family:bold;letter-spacing:1px}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection,.markdown-body img::selection{color:rgba(189,134,0,.5);background-color:#fff}.markdown-body a::selection,.markdown-body b::selection,.markdown-body del::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:transparent}.markdown-body pre&gt;code::selection{background-color:rgba(189,134,0,.5)}.markdown-body .math .math-inline::selection,.markdown-body blockquote::selection,.markdown-body ol::selection,.markdown-body p::selection,.markdown-body strong::selection,.markdown-body table::selection,.markdown-body ul::selection{background-color:rgba(189,134,0,.5)}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">🏎️ 一、当创新踩下油门，监管还在起步线</h2>
<p>WebAIGC（Web-based AI Generated Content），即基于网络的人工智能内容生成技术，是这个时代的“像素风暴”。<br/>
从 ChatGPT 到 Midjourney，从 Copilot 到 AI网页生成器，它们正在以光速更新版本，逼得监管者一边学习 prompt，一边擦汗。</p>
<h3 data-id="heading-1">🧩 1. 技术迭代的“量子跳跃”</h3>
<p>我们不难发现，WebAIGC 的进化轨迹几乎是“指数曲线式”的。</p>
<ul>
<li>一个季度前发布的模型，到了现在可能已经“上了养老保险”。</li>
<li>数据的扩充、推理架构的优化、算力的狂飙，都在让“智能”变得越来越自然。</li>
</ul>
<p>📊 但这种加速也带来了“技术位移”：</p>
<blockquote>
<p>当我们还在理解上一代 AI 的涌现特性时，下一代模型已经在尝试理解我们。</p>
</blockquote>
<hr/>
<h2 data-id="heading-2">⚖️ 二、监管的“慢时针困境”</h2>
<p>监管者的节奏往往是“立法—试点—修正—再立法”。<br/>
而科技圈的节奏是“写代码—上线—用户反馈—迭代—再上线”。<br/>
这两个世界的时钟不同步，于是便有了最经典的场景：</p>
<blockquote>
<p>法条还在讨论“人工智能是否应当承担法律人格”，而AI已经在生成下一份法律草案。</p>
</blockquote>
<h3 data-id="heading-3">📚 举个例子</h3>
<p>一个 WebAIGC 平台可以在几秒钟内生成成千上万的网页、广告、甚至新闻内容。<br/>
但是——<br/>
谁来确定这些内容的所有权？<br/>
谁为生成的虚假信息买单？</p>
<p>监管滞后并非因为懒，而是因为在 AI 的维度下，“边界”本身在流动。</p>
<hr/>
<h2 data-id="heading-4">🧮 三、底层逻辑的简要还原：AI的加速机制</h2>
<p>WebAIGC 的进步，本质上是<strong>三个底层机制的共振</strong>：</p>
<ol>
<li>
<p><strong>数据流的多样性</strong></p>
<ul>
<li>海量的网页交互数据变成了AI的“语料粮仓”；</li>
<li>模型从多模态输入中学会了“类人表达”。</li>
</ul>
</li>
<li>
<p><strong>分布式算力的爆发</strong></p>
<ul>
<li>从单机 GPU 到分布式推理集群；</li>
<li>通过张量切片、模型并行、流水并行等手段，让 AI 以“光速”迭代。</li>
</ul>
</li>
<li>
<p><strong>模型结构的弹性设计</strong></p>
<ul>
<li>动态计算图 + 微调推理策略；</li>
<li>模型不只是“训练出来的”，而是“进化出来的”。</li>
</ul>
</li>
</ol>
<p>用类比来说：</p>
<blockquote>
<p>传统程序像是写死的食谱，而WebAIGC像是一位会自己反复试菜的厨师。</p>
</blockquote>
<hr/>
<h2 data-id="heading-5">🧱 四、监管的算法思维：用代码看世界</h2>
<p>让监管理解 AI，不妨换一个他们熟悉的语言：<strong>逻辑 + 流程控制</strong>。<br/>
假如我们用 JavaScript 比喻监管机制，它也许是这样的👇</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">WebAIGC_Regulation</span>(<span class="hljs-params">technology, law</span>) {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">while</span> (technology.<span class="hljs-title function_">isEvolving</span>()) {
      <span class="hljs-keyword">if</span> (law.<span class="hljs-title function_">isOutdated</span>()) {
        law = law.<span class="hljs-title function_">updateTo</span>(technology.<span class="hljs-title function_">newPattern</span>());
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"📜 Law updated to adapt AI iteration."</span>);
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"✅ Compliance achieved, continue monitoring..."</span>);
      }
      technology.<span class="hljs-title function_">nextIteration</span>();
    }
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">"⚠️ Unexpected AI behavior detected:"</span>, error);
    emergencyProtocol.<span class="hljs-title function_">activate</span>();
  } <span class="hljs-keyword">finally</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"🔁 Continuous audit in progress..."</span>);
  }
}

<span class="hljs-title class_">WebAIGC</span>_Regulation(<span class="hljs-title class_">WebAIGC</span>_Model, <span class="hljs-title class_">Legal</span>_System);
</code></pre>
<p>这段代码展示了一种理想的平衡哲学：</p>
<ul>
<li><strong>技术必须循环进化</strong>（<code>technology.nextIteration()</code>）</li>
<li><strong>法律必须自我升级</strong>（<code>law.updateTo()</code>）</li>
<li><strong>出现风险立即处理</strong>（<code>catch(error)</code>）</li>
</ul>
<p>换句话说，监管并不是“对抗”创新，而是“追踪”创新。</p>
<hr/>
<h2 data-id="heading-6">🚦 五、未来的平衡术：速度与秩序共舞</h2>
<p>如何在“迭代速度”与“监管适配”之间找到平衡？<br/>
以下是三条启示性的建议：</p>
<h3 data-id="heading-7">🌱 1. 建立“弹性监管架构”</h3>
<p>监管不必追着每一项技术跑，而是制定通用原则，像编写“接口文档”一样，给创新留出空间。</p>
<h3 data-id="heading-8">🧭 2. 推动“可解释的AI治理”</h3>
<p>AIGC 模型不应只是“黑箱”，而应该能回答：“我为什么生成这个结果？”<br/>
让监管具备可溯源的信息基础。</p>
<h3 data-id="heading-9">🛠️ 3. 借助技术监管技术</h3>
<p>让 AI 参与治理——自动检测违规内容、评估伦理风险、生成监管报告。<br/>
监管可以“AI化”，而不是“反AI化”。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🏗️ B端架构中的用户归因与埋点最佳实践]]></title>    <link>https://juejin.cn/post/7586582977708343338</link>    <guid>https://juejin.cn/post/7586582977708343338</guid>    <pubDate>2025-12-23T02:50:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586582977708343338" data-draft-id="7586582977708277802" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🏗️ B端架构中的用户归因与埋点最佳实践"/> <meta itemprop="keywords" content="前端,架构,React.js"/> <meta itemprop="datePublished" content="2025-12-23T02:50:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="LeonGao"/> <meta itemprop="url" content="https://juejin.cn/user/3976252950591149"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🏗️ B端架构中的用户归因与埋点最佳实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3976252950591149/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    LeonGao
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T02:50:42.000Z" title="Tue Dec 23 2025 02:50:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body blockquote&gt;:first-child{margin-top:0}.markdown-body blockquote&gt;:last-child{margin-bottom:0}.markdown-body{overflow:hidden;line-height:1.75;font-size:15px;background-image:linear-gradient(90deg,rgba(72,42,10,.05) 5%,rgba(72,42,10,0) 0),linear-gradient(1turn,rgba(72,42,10,.05) 5%,rgba(72,42,10,0) 0);background-size:20px 20px;background-position:50%;padding-top:0!important}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{position:relative;display:flex;border-bottom:5px solid #6d4e00;line-height:35px;letter-spacing:1px;font-size:25px;padding-left:25px;color:#664900;text-shadow:1px 1px 1px #8a6200;padding-bottom:0}.markdown-body h1:before{content:"";display:flex;position:absolute;left:0;top:3px;bottom:0;margin:auto;width:20px;height:20px;background-size:20px 20px;background-image:url("data:image/png;base64,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")}.markdown-body h2{position:relative;padding:0 0 0 20px;font-size:20px;font-weight:700;color:#614500}.markdown-body h2:before{content:"";position:absolute;top:3px;bottom:0;left:0;background-image:url("data:image/png;base64,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");background-size:100% 100%;background-repeat:no-repeat;width:15px;height:15px;margin:auto}.markdown-body h3{width:100%;text-align:left;margin:20px 10px 0 0;font-size:18px;font-weight:700;display:inline-block;padding-left:10px;padding-bottom:0;border-left:5px solid #8f6600;color:#614500}.markdown-body h4,.markdown-body h5,.markdown-body h6{font-weight:700;color:#a37400}.markdown-body h4{font-size:17px}.markdown-body h5,.markdown-body h6{display:flex;align-items:center}.markdown-body h5:after,.markdown-body h6:after{display:inline-block;border:2px solid #fff6e0;color:rgba(189,134,0,.5);border-radius:50%;text-align:center;margin-left:5px}.markdown-body h5{font-size:14px}.markdown-body h5:after{content:"5";width:15px;height:15px;line-height:15px;font-size:13px}.markdown-body h6{font-size:12px}.markdown-body h6:after{content:"6";width:13px;height:13px;line-height:13px;font-size:12px}.markdown-body p{color:#412c0c;letter-spacing:1px;font-weight:400;margin-bottom:16px}.markdown-body img{max-width:100%;display:block;margin:auto}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#755300;font-weight:400;border-bottom:1px solid #755300;font-weight:bolder;text-decoration:none}.markdown-body table{width:100%!important;margin:0;font-size:12px;width:auto;max-width:100%;overflow:auto;border-collapse:collapse;border-spacing:0}.markdown-body table img{box-shadow:none}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body thead tr th{text-align:center}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px;box-sizing:border-box;border:1px solid rgba(72,42,10,.1)}.markdown-body blockquote{position:relative;text-size-adjust:100%;line-height:25px;font-weight:400;border-radius:10px;font-style:normal;text-align:left;box-sizing:inherit;border:1px solid #ffd87a;background-color:rgba(189,134,0,.5);margin:20px 0;padding:20px}.markdown-body blockquote p{color:#fff6e0;letter-spacing:2px;margin:0}.markdown-body blockquote:after,.markdown-body blockquote:before{position:absolute;color:#cc9100;font-size:34px;font-weight:700}.markdown-body blockquote:before{content:"❝";top:8px;left:5px}.markdown-body blockquote:after{content:"❞";right:5px;bottom:-5px}.markdown-body strong{color:#c28a00;font-weight:bolder}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{color:#c28a00}.markdown-body em strong{font-style:normal;color:#c28a00;background-color:#8a6200}.markdown-body s{color:#c28a00}.markdown-body hr{border-top:1px solid #805b00}.markdown-body code,.markdown-body li code,.markdown-body p code{color:#996d00;background-color:rgba(130,98,0,.3)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit;color:#858585;font-family:bold;letter-spacing:1px}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection,.markdown-body img::selection{color:rgba(189,134,0,.5);background-color:#fff}.markdown-body a::selection,.markdown-body b::selection,.markdown-body del::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:transparent}.markdown-body pre&gt;code::selection{background-color:rgba(189,134,0,.5)}.markdown-body .math .math-inline::selection,.markdown-body blockquote::selection,.markdown-body ol::selection,.markdown-body p::selection,.markdown-body strong::selection,.markdown-body table::selection,.markdown-body ul::selection{background-color:rgba(189,134,0,.5)}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">🧠 一、前言：B端数据的“盲点效应”</h2>
<p>在 To B（企业级）产品架构中，用户行为分析往往是“灰色地带”：</p>
<ul>
<li>产品使用路径复杂；</li>
<li>不同角色协同操作；</li>
<li>数据入口分散在多个前后端系统。</li>
</ul>
<p>结果是：<br/>
埋点像“满天星”，日志像“银河系”，但要分析谁是核心用户、谁带来价值，却发现——<br/>
👉 “数据都在，有效信息稀缺。”</p>
<hr/>
<h2 data-id="heading-1">🧭 二、用户归因的底层逻辑</h2>
<p>B端用户归因（Attribution）本质上是要解决：“<strong>谁做了什么、在什么渠道、带来了什么价值</strong>。”</p>
<h3 data-id="heading-2">🧩 1. 三层归因模型</h3>





























<table><thead><tr><th>层级</th><th>目标</th><th>典型问题</th><th>示例</th></tr></thead><tbody><tr><td><strong>渠道归因</strong></td><td>确定流量来源</td><td>用户从哪里来？</td><td>官网➡️注册页➡️内部邀请</td></tr><tr><td><strong>账号归因</strong></td><td>识别行为账号</td><td>谁在用？</td><td>是企业管理员还是成员？</td></tr><tr><td><strong>价值归因</strong></td><td>衡量贡献</td><td>谁让转化发生？</td><td>谁推动了一次成交或激活？</td></tr></tbody></table>
<blockquote>
<p>🔍 “用户行为不是孤立事件，而是多角色协作的轨迹。”</p>
</blockquote>
<hr/>
<h2 data-id="heading-3">⚙️ 三、B端埋点的特殊挑战</h2>
<p>B端产品的复杂性主要体现在以下三个方面：</p>
<h3 data-id="heading-4">🧱 1. 多身份与多端入口</h3>
<p>同一企业下存在：管理员、运营、财务、多角色协作。<br/>
同时使用 Web、App、SDK、API、甚至嵌入第三方平台。</p>
<p>解决建议：</p>
<ul>
<li>埋点需携带 <strong>TenantID（租户ID） + UserRole（角色） + DeviceType（设备类型）</strong></li>
<li>使用一致的 <strong>UUID</strong> 跨端追踪同一用户行为。</li>
</ul>
<h3 data-id="heading-5">🕸️ 2. 行为链条长且可被中断</h3>
<p>一个业务动作可能跨越多页面、多模块，甚至多天完成。<br/>
例如：“创建一个自动化营销流程”可能涉及 7 个操作节点。</p>
<p>解决建议：</p>
<ul>
<li>关键节点用 <strong>事件ID 串联形成 Session 链路</strong>；</li>
<li>对“延迟行为”设定 <strong>窗口期（例如7天）</strong> ，防止误归因。</li>
</ul>
<h3 data-id="heading-6">🛡️ 3. 数据安全与隐私合规</h3>
<p>企业客户比C端用户更重视数据边界。</p>
<p>解决建议：</p>
<ul>
<li>匿名化处理埋点数据（Hash + Salt）</li>
<li><strong>本地采集 -&gt; 聚合 -&gt; 再上传</strong>，避免直接暴露Key。</li>
</ul>
<hr/>
<h2 data-id="heading-7">🧮 四、埋点设计哲学：从“无脑采”到“精准测”</h2>
<blockquote>
<p>“最好的埋点体系，不是埋得多，而是埋得准。”</p>
</blockquote>
<h3 data-id="heading-8">🌿 1. 埋点分层结构</h3>






























<table><thead><tr><th>层级</th><th>目标</th><th>举例</th></tr></thead><tbody><tr><td><strong>基础埋点</strong></td><td>记录关键事件</td><td>登录 / 登出 / 查看报告</td></tr><tr><td><strong>业务埋点</strong></td><td>支撑运营指标</td><td>提交审批 / 添加客户</td></tr><tr><td><strong>增长埋点</strong></td><td>支撑A/B实验</td><td>点击引导按钮 / 完成注册</td></tr><tr><td><strong>异常埋点</strong></td><td>技术指标监控</td><td>请求失败 / 脚本报错</td></tr></tbody></table>
<p>🧩 设计建议：<br/>
所有埋点的命名规范应为：</p>
<pre><code class="hljs language-arduino" lang="arduino">模块名.事件类型.动作
ex: dashboard.click.export_button
</code></pre>
<hr/>
<h3 data-id="heading-9">💬 2. 示例：事件捕获脚本（JS版）</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 通用埋点 SDK 模拟</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">AILog</span> = {
  <span class="hljs-title function_">track</span>(<span class="hljs-params">event, payload = {}</span>) {
    <span class="hljs-keyword">const</span> base = {
      <span class="hljs-attr">tenantId</span>: <span class="hljs-variable language_">window</span>.<span class="hljs-property">__TENANT_ID__</span> || <span class="hljs-string">"unknown"</span>,
      <span class="hljs-attr">userId</span>: <span class="hljs-variable language_">window</span>.<span class="hljs-property">__USER_ID__</span> || <span class="hljs-string">"anonymous"</span>,
      <span class="hljs-attr">timestamp</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>(),
      <span class="hljs-attr">source</span>: <span class="hljs-string">"web"</span>,
    };
    <span class="hljs-keyword">const</span> data = { ...base, event, ...payload };
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"📡 Sent Event:"</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(data));
    <span class="hljs-title function_">sendToServer</span>(data);
  },
};

<span class="hljs-comment">// 示例：用户点击导出功能</span>
<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">"#exportBtn"</span>).<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">"click"</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-title class_">AILog</span>.<span class="hljs-title function_">track</span>(<span class="hljs-string">"dashboard.click.export_button"</span>, {
    <span class="hljs-attr">fileType</span>: <span class="hljs-string">"csv"</span>,
    <span class="hljs-attr">module</span>: <span class="hljs-string">"reporting"</span>,
  });
});

<span class="hljs-keyword">function</span> <span class="hljs-title function_">sendToServer</span>(<span class="hljs-params">payload</span>) {
  <span class="hljs-comment">// 简化版上报逻辑</span>
  <span class="hljs-title function_">fetch</span>(<span class="hljs-string">"/api/track"</span>, {
    <span class="hljs-attr">method</span>: <span class="hljs-string">"POST"</span>,
    <span class="hljs-attr">headers</span>: { <span class="hljs-string">"Content-Type"</span>: <span class="hljs-string">"application/json"</span> },
    <span class="hljs-attr">body</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(payload),
  }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"🚨 埋点上报失败:"</span>, e));
}
</code></pre>
<blockquote>
<p>💬 <em>这一行日志，也许正是产品增长会议的灵魂来源。</em></p>
</blockquote>
<hr/>
<h2 data-id="heading-10">🧠 五、从事件到洞察：归因算法的实战启发</h2>
<p>归因不仅是日志分析，更是一种“推理算法”：</p>
<h3 data-id="heading-11">🔍 1. 时间权重归因</h3>
<p>靠近转化时刻的行为权重大。<br/>
（如：最后一次点击 &gt; 第一次点击）</p>
<h3 data-id="heading-12">🔄 2. 多触点递减模型</h3>
<p>每个行为节点都获得部分贡献值，但按时间递减。</p>
<h3 data-id="heading-13">🎯 3. 团队归因模型（B端特有）</h3>
<p>多用户协作完成一个目标时，为每个人按职能分配权重：</p>
<ul>
<li>销售：意向启动权重</li>
<li>产品：试用完成权重</li>
<li>管理员：最终续约权重</li>
</ul>
<hr/>
<h2 data-id="heading-14">🧩 六、最佳实践清单</h2>
<p>✅ <strong>结构化命名规范</strong>（避免 event1、event2）<br/>
✅ <strong>跨端统一身份体系</strong>（TenantID + UUID）<br/>
✅ <strong>可灰度可配置的埋点策略</strong><br/>
✅ <strong>事件链路可视化埋点管理平台</strong><br/>
✅ <strong>埋点审计机制</strong>（防止“僵尸点”污染指标）</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Spring AOP 面向切面编程完全指南 🚀]]></title>    <link>https://juejin.cn/post/7586559672128127028</link>    <guid>https://juejin.cn/post/7586559672128127028</guid>    <pubDate>2025-12-22T13:11:18.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586559672128127028" data-draft-id="7586493936677601320" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Spring AOP 面向切面编程完全指南 🚀"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-22T13:11:18.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="总会落叶"/> <meta itemprop="url" content="https://juejin.cn/user/766787307710060"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Spring AOP 面向切面编程完全指南 🚀
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/766787307710060/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    总会落叶
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T13:11:18.000Z" title="Mon Dec 22 2025 13:11:18 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Spring AOP 面向切面编程完全指南 🚀</h2>
<h3 data-id="heading-1">一、什么是 AOP？ 🤔</h3>
<p><strong>面向切面编程</strong>（AOP）是 Spring 框架的核心功能之一，它允许开发者将横切关注点（如日志记录、事务管理、安全控制等）从业务逻辑中分离出来，实现代码的模块化和复用。就像电影特效团队🎬，他们专注于特效制作，而不需要关心剧本内容！</p>
<h3 data-id="heading-2">二、快速开始 ⚡</h3>
<h4 data-id="heading-3">1. 导入依赖 📦</h4>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- Spring Boot AOP 依赖 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-aop<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<h4 data-id="heading-4">2. 第一个 AOP 程序：方法执行时间监控 ⏱️</h4>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@Slf4j</span>
<span class="hljs-variable">@Aspect</span>         <span class="hljs-comment">// 声明为切面类 🎯</span>
<span class="hljs-variable">@Component</span>      <span class="hljs-comment">// 交给 IOC 容器管理 🏭</span>
public class RecordTimeAspect {
    
    <span class="hljs-comment">/**
     * 切入点表达式：监控 com.example.service 包下所有类的所有方法
     */</span>
    <span class="hljs-variable">@Around</span>(<span class="hljs-string">"execution(* com.example.service.*.*(..))"</span>)
    public Object <span class="hljs-built_in">recordTime</span>(ProceedingJoinPoint pjp) throws Throwable {
        <span class="hljs-comment">// 记录开始时间</span>
        <span class="hljs-selector-tag">long</span> <span class="hljs-selector-tag">beginTime</span> = <span class="hljs-selector-tag">System</span><span class="hljs-selector-class">.currentTimeMillis</span>();
        
        <span class="hljs-comment">// 执行原始方法 🏃•♂️</span>
        <span class="hljs-selector-tag">Object</span> <span class="hljs-selector-tag">result</span> = <span class="hljs-selector-tag">pjp</span><span class="hljs-selector-class">.proceed</span>();
        
        <span class="hljs-comment">// 记录结束时间并计算耗时</span>
        <span class="hljs-selector-tag">long</span> <span class="hljs-selector-tag">endTime</span> = <span class="hljs-selector-tag">System</span><span class="hljs-selector-class">.currentTimeMillis</span>();
        <span class="hljs-selector-tag">long</span> <span class="hljs-selector-tag">costTime</span> = <span class="hljs-selector-tag">endTime</span> <span class="hljs-selector-tag">-</span> <span class="hljs-selector-tag">beginTime</span>;
        
        <span class="hljs-comment">// 获取方法签名信息</span>
        <span class="hljs-selector-tag">String</span> <span class="hljs-selector-tag">methodName</span> = <span class="hljs-selector-tag">pjp</span><span class="hljs-selector-class">.getSignature</span>()<span class="hljs-selector-class">.getName</span>();
        <span class="hljs-selector-tag">String</span> <span class="hljs-selector-tag">className</span> = <span class="hljs-selector-tag">pjp</span><span class="hljs-selector-class">.getTarget</span>()<span class="hljs-selector-class">.getClass</span>()<span class="hljs-selector-class">.getSimpleName</span>();
        
        <span class="hljs-selector-tag">log</span><span class="hljs-selector-class">.info</span>(<span class="hljs-string">"🎯 [{}] - [{}] 执行耗时: {}ms"</span>, className, methodName, costTime);
        
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">result</span>;
    }
}
</code></pre>
<h3 data-id="heading-5">三、AOP 核心概念详解 🎓</h3>
<h4 data-id="heading-6">1. 核心术语 📚</h4>









































<table><thead><tr><th>概念</th><th>说明</th><th>类比</th><th>表情</th></tr></thead><tbody><tr><td><strong>连接点 (JoinPoint)</strong></td><td>程序执行过程中可以插入切面的点</td><td>电影中的每个场景</td><td>🎬</td></tr><tr><td><strong>通知 (Advice)</strong></td><td>切面在特定连接点执行的动作</td><td>特效团队的工作</td><td>🎨</td></tr><tr><td><strong>切入点 (Pointcut)</strong></td><td>匹配连接点的谓词</td><td>需要加特效的场景</td><td>📍</td></tr><tr><td><strong>切面 (Aspect)</strong></td><td>通知和切入点的组合</td><td>完整的特效设计方案</td><td>📋</td></tr><tr><td><strong>目标对象 (Target)</strong></td><td>被一个或多个切面所通知的对象</td><td>原始电影片段</td><td>🎥</td></tr></tbody></table>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f12e563f76c942e59abee35719e80c73~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oC75Lya6JC95Y-2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767013878&amp;x-signature=SQMr%2F97IazUsGc%2BeAMZ%2Fter4pvQ%3D" alt="image-20251221183926108.png" loading="lazy"/></p>
<h4 data-id="heading-7">2. AOP 底层原理：动态代理 🧙‍♂️</h4>
<p>Spring AOP 默认使用两种代理方式：</p>
<ul>
<li><strong>JDK 动态代理</strong>：基于接口实现 ✨</li>
<li><strong>CGLIB 代理</strong>：基于继承实现 🔄</li>
</ul>
<h3 data-id="heading-8">四、通知类型详解 🎪</h3>
<h4 data-id="heading-9">1. 五种通知类型 🖐️</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Aspect</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AllAdviceExample</span> {
    
    <span class="hljs-comment">/**
     * 1. 环绕通知 - 最强大的通知类型 💪
     */</span>
    <span class="hljs-meta">@Around("execution(* com.example.service.*.*(..))")</span>
    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">aroundAdvice</span><span class="hljs-params">(ProceedingJoinPoint pjp)</span> <span class="hljs-keyword">throws</span> Throwable {
        log.info(<span class="hljs-string">"🔄 @Around - 方法执行前"</span>);
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">Object</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> pjp.proceed();  <span class="hljs-comment">// 必须显式调用原始方法</span>
            log.info(<span class="hljs-string">"✅ @Around - 方法执行后"</span>);
            <span class="hljs-keyword">return</span> result;
        } <span class="hljs-keyword">catch</span> (Exception e) {
            log.error(<span class="hljs-string">"❌ @Around - 方法执行异常"</span>);
            <span class="hljs-keyword">throw</span> e;
        }
    }
    
    <span class="hljs-comment">/**
     * 2. 前置通知 - 在目标方法执行前执行 ⬆️
     */</span>
    <span class="hljs-meta">@Before("execution(* com.example.service.*.*(..))")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">beforeAdvice</span><span class="hljs-params">(JoinPoint joinPoint)</span> {
        log.info(<span class="hljs-string">"⬆️ @Before - 方法执行前"</span>);
    }
    
    <span class="hljs-comment">/**
     * 3. 后置通知 - 在目标方法执行后执行（无论是否异常） ⬇️
     */</span>
    <span class="hljs-meta">@After("execution(* com.example.service.*.*(..))")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">afterAdvice</span><span class="hljs-params">(JoinPoint joinPoint)</span> {
        log.info(<span class="hljs-string">"⬇️ @After - 方法执行后（总执行）"</span>);
    }
    
    <span class="hljs-comment">/**
     * 4. 返回后通知 - 在目标方法正常返回后执行 ✅
     */</span>
    <span class="hljs-meta">@AfterReturning(value = "execution(* com.example.service.*.*(..))", 
                   returning = "result")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">afterReturningAdvice</span><span class="hljs-params">(JoinPoint joinPoint, Object result)</span> {
        log.info(<span class="hljs-string">"✅ @AfterReturning - 方法正常返回，结果: {}"</span>, result);
    }
    
    <span class="hljs-comment">/**
     * 5. 异常通知 - 在目标方法抛出异常后执行 ❌
     */</span>
    <span class="hljs-meta">@AfterThrowing(value = "execution(* com.example.service.*.*(..))", 
                   throwing = "ex")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">afterThrowingAdvice</span><span class="hljs-params">(JoinPoint joinPoint, Exception ex)</span> {
        log.error(<span class="hljs-string">"❌ @AfterThrowing - 方法执行异常: {}"</span>, ex.getMessage());
    }
}
</code></pre>
<h4 data-id="heading-10">2. 通知执行顺序 📊</h4>
<p>默认执行顺序（同一切面内）： <strong>🔄 @Around</strong>（前半部分） → <strong>⬆️ @Before</strong> → <strong>🎯 目标方法</strong> → <strong>🔄 @Around</strong>（后半部分） → <strong>✅ @AfterReturning/❌ @AfterThrowing</strong> → <strong>⬇️ @After</strong></p>
<h3 data-id="heading-11">五、切入点表达式 ✨</h3>
<h4 data-id="heading-12">1. execution 表达式 🎯</h4>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@Aspect</span>
<span class="hljs-variable">@Component</span>
public class PointcutExamples {
    
    <span class="hljs-comment">// 1. 抽取公共切入点表达式 📝</span>
    <span class="hljs-variable">@Pointcut</span>(<span class="hljs-string">"execution(* com.example.service.*.*(..))"</span>)
    public void <span class="hljs-built_in">serviceLayer</span>() {}
    
    <span class="hljs-comment">// 2. 精确匹配方法 🎯</span>
    <span class="hljs-variable">@Pointcut</span>(<span class="hljs-string">"execution(public String com.example.service.UserService.getUserById(Integer))"</span>)
    public void <span class="hljs-built_in">specificMethod</span>() {}
    
    <span class="hljs-comment">// 3. 匹配包下所有方法 📁</span>
    <span class="hljs-variable">@Pointcut</span>(<span class="hljs-string">"execution(* com.example.service..*.*(..))"</span>)  <span class="hljs-comment">// ..表示子包</span>
    public void <span class="hljs-built_in">allServiceMethods</span>() {}
    
    <span class="hljs-comment">// 4. 匹配特定注解的方法 🏷️</span>
    <span class="hljs-variable">@Pointcut</span>(<span class="hljs-string">"@annotation(com.example.annotation.Log)"</span>)
    public void <span class="hljs-built_in">logAnnotation</span>() {}
    
    <span class="hljs-comment">// 5. 组合切入点表达式 🔗</span>
    <span class="hljs-variable">@Pointcut</span>(<span class="hljs-string">"serviceLayer() &amp;&amp; !specificMethod()"</span>)
    public void <span class="hljs-built_in">serviceButNotSpecific</span>() {}
    
    <span class="hljs-variable">@Around</span>(<span class="hljs-string">"serviceLayer()"</span>)  <span class="hljs-comment">// 引用切入点表达式</span>
    public Object <span class="hljs-built_in">adviceMethod</span>(ProceedingJoinPoint pjp) throws Throwable {
        <span class="hljs-comment">// 业务逻辑</span>
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">pjp</span><span class="hljs-selector-class">.proceed</span>();
    }
}
</code></pre>
<h4 data-id="heading-13">2. @annotation 表达式（基于注解） 🏷️</h4>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">/**
 * 自定义日志注解
 */</span>
<span class="hljs-variable">@Target</span>(ElementType.METHOD)    <span class="hljs-comment">// 只能用在方法上</span>
<span class="hljs-variable">@Retention</span>(RetentionPolicy.RUNTIME)  <span class="hljs-comment">// 运行时生效</span>
public <span class="hljs-variable">@interface</span> Log {
    <span class="hljs-selector-tag">String</span> <span class="hljs-selector-tag">value</span>() <span class="hljs-selector-tag">default</span> "";
    <span class="hljs-selector-tag">boolean</span> <span class="hljs-selector-tag">recordParams</span>() <span class="hljs-selector-tag">default</span> <span class="hljs-selector-tag">true</span>;
    <span class="hljs-selector-tag">boolean</span> <span class="hljs-selector-tag">recordResult</span>() <span class="hljs-selector-tag">default</span> <span class="hljs-selector-tag">true</span>;
}
</code></pre>
<h3 data-id="heading-14">六、实战：操作日志记录到数据库 💾</h3>
<h4 data-id="heading-15">1. 创建操作日志实体 📋</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Data</span>
<span class="hljs-meta">@TableName(<span class="hljs-string">"t_operate_log"</span>)</span>  <span class="hljs-comment">// MyBatis-Plus 注解</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OperateLog</span> {
    
    <span class="hljs-meta">@TableId(type = IdType.AUTO)</span>
    <span class="hljs-keyword">private</span> <span class="hljs-built_in">Long</span> id;
    
    <span class="hljs-keyword">private</span> <span class="hljs-built_in">Long</span> operateUserId;        <span class="hljs-comment">// 操作人ID 👤</span>
    <span class="hljs-keyword">private</span> String operateUserName;    <span class="hljs-comment">// 操作人姓名</span>
    
    <span class="hljs-meta">@JsonFormat(pattern = <span class="hljs-string">"yyyy-MM-dd HH:mm:ss"</span>)</span>
    <span class="hljs-keyword">private</span> LocalDateTime operateTime; <span class="hljs-comment">// 操作时间 ⏰</span>
    
    <span class="hljs-keyword">private</span> String className;          <span class="hljs-comment">// 类名</span>
    <span class="hljs-keyword">private</span> String methodName;         <span class="hljs-comment">// 方法名</span>
    
    <span class="hljs-meta">@TableField(typeHandler = JacksonTypeHandler.class)</span>
    <span class="hljs-keyword">private</span> Object methodParams;       <span class="hljs-comment">// 方法参数（JSON格式） 📄</span>
    
    <span class="hljs-meta">@TableField(typeHandler = JacksonTypeHandler.class)</span>
    <span class="hljs-keyword">private</span> Object returnValue;        <span class="hljs-comment">// 返回值（JSON格式） 📋</span>
    
    <span class="hljs-keyword">private</span> <span class="hljs-built_in">Boolean</span> success;           <span class="hljs-comment">// 操作是否成功 ✅</span>
    <span class="hljs-keyword">private</span> String errorMessage;       <span class="hljs-comment">// 错误信息 ❌</span>
    <span class="hljs-keyword">private</span> <span class="hljs-built_in">Long</span> costTime;             <span class="hljs-comment">// 耗时（毫秒） ⏱️</span>
    <span class="hljs-keyword">private</span> String clientIp;           <span class="hljs-comment">// 客户端IP 🌐</span>
    <span class="hljs-keyword">private</span> String requestUri;         <span class="hljs-comment">// 请求URI 🔗</span>
}
</code></pre>
<h4 data-id="heading-16">2. Mapper 接口 🔧</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Mapper</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">OperateLogMapper</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseMapper</span>&lt;OperateLog&gt; {
    <span class="hljs-comment">// 这里可以添加自定义查询方法</span>
}
</code></pre>
<h4 data-id="heading-17">3. 用户上下文工具类（ThreadLocal） 🧵</h4>
<pre><code class="hljs language-csharp" lang="csharp">@Component
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">UserContext</span> {
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> final ThreadLocal&lt;CurrentUser&gt; USER_CONTEXT = <span class="hljs-keyword">new</span> ThreadLocal&lt;&gt;();
    
    <span class="hljs-comment">/**
     * 设置当前用户信息 👤
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setCurrentUser</span>(<span class="hljs-params">CurrentUser user</span>)</span> {
        USER_CONTEXT.<span class="hljs-keyword">set</span>(user);
    }
    
    <span class="hljs-comment">/**
     * 获取当前用户ID 🔑
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Long <span class="hljs-title">getCurrentUserId</span>()</span> {
        CurrentUser user = USER_CONTEXT.<span class="hljs-keyword">get</span>();
        <span class="hljs-keyword">return</span> user != <span class="hljs-literal">null</span> ? user.getId() : <span class="hljs-literal">null</span>;
    }
    
    <span class="hljs-comment">/**
     * 获取当前用户信息 📋
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> CurrentUser <span class="hljs-title">getCurrentUser</span>()</span> {
        <span class="hljs-keyword">return</span> USER_CONTEXT.<span class="hljs-keyword">get</span>();
    }
    
    <span class="hljs-comment">/**
     * 清除用户信息（防止内存泄漏） 🧹
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">clear</span>()</span> {
        USER_CONTEXT.<span class="hljs-keyword">remove</span>();
    }
    
    @Data
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title">CurrentUser</span> {
        <span class="hljs-keyword">private</span> Long id;
        <span class="hljs-keyword">private</span> String username;
        <span class="hljs-keyword">private</span> String name;
        <span class="hljs-keyword">private</span> String role;
    }
}
</code></pre>
<h4 data-id="heading-18">4. 切面类实现 🛡️</h4>
<pre><code class="hljs language-ini" lang="ini">@Slf4j
@Aspect
@Component
public class OperateLogAspect {
    
    @Autowired
    private OperateLogMapper operateLogMapper<span class="hljs-comment">;</span>
    
    @Autowired
    private HttpServletRequest request<span class="hljs-comment">;</span>
    
    /**
     * 基于注解的切入点 🎯
     */
    @Around("@annotation(logAnnotation)")
    public Object logOperate(ProceedingJoinPoint pjp, Log logAnnotation) throws Throwable {
        // 记录开始时间 ⏰
        long <span class="hljs-attr">startTime</span> = System.currentTimeMillis()<span class="hljs-comment">;</span>
        
        // 创建日志对象 📝
        OperateLog <span class="hljs-attr">operateLog</span> = new OperateLog()<span class="hljs-comment">;</span>
        operateLog.setOperateTime(LocalDateTime.now())<span class="hljs-comment">;</span>
        operateLog.setSuccess(true)<span class="hljs-comment">;</span>
        
        // 获取方法信息 🔍
        MethodSignature <span class="hljs-attr">signature</span> = (MethodSignature) pjp.getSignature()<span class="hljs-comment">;</span>
        Method <span class="hljs-attr">method</span> = signature.getMethod()<span class="hljs-comment">;</span>
        
        // 设置基本信息
        operateLog.setClassName(pjp.getTarget().getClass().getName())<span class="hljs-comment">;</span>
        operateLog.setMethodName(method.getName())<span class="hljs-comment">;</span>
        
        // 获取当前用户 👤
        Long <span class="hljs-attr">currentUserId</span> = UserContext.getCurrentUserId()<span class="hljs-comment">;</span>
        operateLog.setOperateUserId(currentUserId)<span class="hljs-comment">;</span>
        
        // 获取请求信息 🌐
        if (request != null) {
            operateLog.setClientIp(getClientIp(request))<span class="hljs-comment">;</span>
            operateLog.setRequestUri(request.getRequestURI())<span class="hljs-comment">;</span>
        }
        
        // 记录方法参数（根据配置） 📄
        if (logAnnotation.recordParams()) {
            Object<span class="hljs-section">[]</span> <span class="hljs-attr">args</span> = pjp.getArgs()<span class="hljs-comment">;</span>
            String<span class="hljs-section">[]</span> <span class="hljs-attr">paramNames</span> = signature.getParameterNames()<span class="hljs-comment">;</span>
            Map&lt;String, Object&gt; <span class="hljs-attr">params</span> = new HashMap&lt;&gt;()<span class="hljs-comment">;</span>
            
            for (int <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; args.length; i++) {</span>
                // 过滤掉敏感参数 🚫
                if (!isSensitiveParam(paramNames<span class="hljs-section">[i]</span>)) {
                    params.put(paramNames<span class="hljs-section">[i]</span>, args<span class="hljs-section">[i]</span>)<span class="hljs-comment">;</span>
                }
            }
            operateLog.setMethodParams(params)<span class="hljs-comment">;</span>
        }
        
        Object <span class="hljs-attr">result</span> = null<span class="hljs-comment">;</span>
        try {
            // 执行目标方法 🏃‍♂️
            <span class="hljs-attr">result</span> = pjp.proceed()<span class="hljs-comment">;</span>
            
            // 记录返回值（根据配置） ✅
            if (logAnnotation.recordResult()) {
                operateLog.setReturnValue(result)<span class="hljs-comment">;</span>
            }
            
            // 计算耗时 ⏱️
            long <span class="hljs-attr">endTime</span> = System.currentTimeMillis()<span class="hljs-comment">;</span>
            operateLog.setCostTime(endTime - startTime)<span class="hljs-comment">;</span>
            
            log.info("✅ 操作日志记录成功: {}.{}", 
                    operateLog.getClassName(), 
                    operateLog.getMethodName())<span class="hljs-comment">;</span>
            
        } catch (Throwable throwable) {
            // 记录异常信息 ❌
            operateLog.setSuccess(false)<span class="hljs-comment">;</span>
            operateLog.setErrorMessage(throwable.getMessage())<span class="hljs-comment">;</span>
            operateLog.setCostTime(System.currentTimeMillis() - startTime)<span class="hljs-comment">;</span>
            
            log.error("❌ 操作执行失败: {}", throwable.getMessage())<span class="hljs-comment">;</span>
            throw throwable<span class="hljs-comment">;</span>
            
        } finally {
            // 异步保存日志到数据库 💾
            saveLogAsync(operateLog)<span class="hljs-comment">;</span>
        }
        
        return result<span class="hljs-comment">;</span>
    }
    
    /**
     * 异步保存日志 🚀
     */
    private void saveLogAsync(OperateLog operateLog) {
        CompletableFuture.runAsync(() -&gt; {
            try {
                operateLogMapper.insert(operateLog)<span class="hljs-comment">;</span>
                log.debug("💾 操作日志已保存到数据库")<span class="hljs-comment">;</span>
            } catch (Exception e) {
                log.error("❌ 保存操作日志失败: {}", e.getMessage())<span class="hljs-comment">;</span>
            }
        })<span class="hljs-comment">;</span>
    }
    
    /**
     * 获取客户端IP地址 🌐
     */
    private String getClientIp(HttpServletRequest request) {
        String <span class="hljs-attr">ip</span> = request.getHeader(<span class="hljs-string">"X-Forwarded-For"</span>)<span class="hljs-comment">;</span>
        if (<span class="hljs-attr">ip</span> == null || ip.length() == <span class="hljs-number">0</span> || <span class="hljs-string">"unknown"</span>.equalsIgnoreCase(ip)) {
            <span class="hljs-attr">ip</span> = request.getHeader(<span class="hljs-string">"Proxy-Client-IP"</span>)<span class="hljs-comment">;</span>
        }
        if (<span class="hljs-attr">ip</span> == null || ip.length() == <span class="hljs-number">0</span> || <span class="hljs-string">"unknown"</span>.equalsIgnoreCase(ip)) {
            <span class="hljs-attr">ip</span> = request.getHeader(<span class="hljs-string">"WL-Proxy-Client-IP"</span>)<span class="hljs-comment">;</span>
        }
        if (<span class="hljs-attr">ip</span> == null || ip.length() == <span class="hljs-number">0</span> || <span class="hljs-string">"unknown"</span>.equalsIgnoreCase(ip)) {
            <span class="hljs-attr">ip</span> = request.getRemoteAddr()<span class="hljs-comment">;</span>
        }
        return ip<span class="hljs-comment">;</span>
    }
    
    /**
     * 判断是否为敏感参数 🚫
     */
    private boolean isSensitiveParam(String paramName) {
        List&lt;String&gt; <span class="hljs-attr">sensitiveParams</span> = Arrays.asList(<span class="hljs-string">"password"</span>, <span class="hljs-string">"token"</span>, <span class="hljs-string">"secret"</span>)<span class="hljs-comment">;</span>
        return sensitiveParams.stream()
                .anyMatch(paramName::contains)<span class="hljs-comment">;</span>
    }
}
</code></pre>
<h3 data-id="heading-19">七、最佳实践与注意事项 ⚠️</h3>
<h4 data-id="heading-20">1. 性能优化建议 🚀</h4>
<ul>
<li><strong>合理使用切入点表达式</strong>：避免过于宽泛的匹配</li>
<li><strong>异步处理耗时操作</strong>：如数据库日志保存</li>
<li><strong>缓存频繁访问的数据</strong>：如方法签名信息</li>
</ul>
<h4 data-id="heading-21">2. 常见陷阱 🕳️</h4>
<ul>
<li><strong>自调用问题</strong>：同一个类中方法互相调用，AOP不会生效</li>
<li><strong>异常处理</strong>：确保异常被正确处理和传播</li>
<li><strong>内存泄漏</strong>：ThreadLocal使用后必须清理</li>
</ul>
<h4 data-id="heading-22">3. 调试技巧 🔧</h4>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// 在通知中打印详细信息</span>
<span class="hljs-variable">@Before</span>(<span class="hljs-string">"execution(* com.example..*.*(..))"</span>)
public void <span class="hljs-built_in">debugAdvice</span>(JoinPoint joinPoint) {
    <span class="hljs-selector-tag">log</span><span class="hljs-selector-class">.debug</span>(<span class="hljs-string">"🎯 目标类: {}"</span>, joinPoint.<span class="hljs-built_in">getTarget</span>().<span class="hljs-built_in">getClass</span>().<span class="hljs-built_in">getName</span>());
    <span class="hljs-selector-tag">log</span><span class="hljs-selector-class">.debug</span>(<span class="hljs-string">"🔧 方法名: {}"</span>, joinPoint.<span class="hljs-built_in">getSignature</span>().<span class="hljs-built_in">getName</span>());
    <span class="hljs-selector-tag">log</span><span class="hljs-selector-class">.debug</span>(<span class="hljs-string">"📋 参数: {}"</span>, Arrays.<span class="hljs-built_in">toString</span>(joinPoint.<span class="hljs-built_in">getArgs</span>()));
}
</code></pre>
<h3 data-id="heading-23">八、总结 🎉</h3>
<p>Spring AOP 是一个强大的面向切面编程框架，它通过动态代理机制实现了横切关注点的模块化。掌握 AOP 可以让你的代码更加：</p>
<ul>
<li>✅ <strong>干净整洁</strong> - 分离关注点</li>
<li>✅ <strong>易于维护</strong> - 集中化管理</li>
<li>✅ <strong>高度复用</strong> - 一处定义，多处使用</li>
<li>✅ <strong>灵活扩展</strong> - 非侵入式增强</li>
</ul>
<p>希望这篇指南能帮助你更好地理解和使用 Spring AOP！Happy coding! 😊👨‍💻👩‍💻</p>
<hr/>
<p><strong>小提示</strong>：在实际项目中，建议将AOP配置放在独立的配置类中，便于管理和维护。记得根据具体业务场景选择合适的通知类型和切入点表达式哦！✨</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JUC 小试牛刀：从源码分析「ArrayBlockingQueue」，Java自带的线程安全的、有界的阻塞队列]]></title>    <link>https://juejin.cn/post/7586500093843849258</link>    <guid>https://juejin.cn/post/7586500093843849258</guid>    <pubDate>2025-12-22T13:34:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586500093843849258" data-draft-id="7586540799250350134" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JUC 小试牛刀：从源码分析「ArrayBlockingQueue」，Java自带的线程安全的、有界的阻塞队列"/> <meta itemprop="keywords" content="后端,Java"/> <meta itemprop="datePublished" content="2025-12-22T13:34:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="沐浴露z"/> <meta itemprop="url" content="https://juejin.cn/user/1883894812774922"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JUC 小试牛刀：从源码分析「ArrayBlockingQueue」，Java自带的线程安全的、有界的阻塞队列
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1883894812774922/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    沐浴露z
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T13:34:44.000Z" title="Mon Dec 22 2025 13:34:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>​</p>
<h2 data-id="heading-0">场景引入</h2>
<p>正如标题所言，ArrayBlockingQueue是一个阻塞队列的数组实现，如果要生动地描述阻塞队列的应用场景，我想还是餐厅取餐、出餐的场景是最合适的（虽然我想这个场景已经被用烂了）。</p>
<p>试想在学校的窗口取餐，一个窗口是预制好的烤肉拌饭，另一个窗口则是现炒的小炒菜，要如何选择？先把目光移向烤肉拌饭，因为出餐太快，预制好的菜已经放满了窗台前，出餐阿姨只能在窗口闲等，等哪个着急的学生过来拿走一份饭，她才能继续向上摆。再看向小炒菜，由于味道美味，很多学生都想吃，但炒菜的出餐量有限，学生没法立即享受到美味，来晚的只能排队等待。哪怕学生再想吃，窗台前都是空的，没得拿，只有出餐了才能拿。</p>
<p>这就是阻塞队列的典型场景，烤肉拌饭的窗台口已经摆满饭了，阿姨只能阻塞等待有空了再放餐（put操作）。小炒菜的窗口太火爆了，学生要想吃只能阻塞等待，等轮到自己了在取餐（take操作）。</p>
<h2 data-id="heading-1">API介绍</h2>
<h3 data-id="heading-2">放餐操作：add、offer、put</h3>
<p>add: 如果队列容量未满，则插入指定元素; 成功时返回 true，若当前无空位则抛出【IllegalStateException】</p>
<p>offer: 如果队列容量未满，则插入指定元素; 成功时返回 true，若当前无空位则抛出 false</p>
<p>put: 如果队列容量未满，则插入指定元素; 如果满了，则阻塞等待有空位。如果等待时被打断，则抛异常</p>
<p>offer(long timeout, TimeUnit unit): 超时等待的put()。如果等着空了返回true，如果超过timeout还是没有空位，返回false</p>
<h3 data-id="heading-3">取餐操作：take、poll</h3>
<p>poll: 如果队列容量不为空，则取出队列头部并返回。如果为空返回null</p>
<p>take: 如果队列容量不为空，则取出队列头部并返回。如果为空则阻塞等待</p>
<p>poll(long timeout, TimeUnit unit): 超时等待的take()，如果队列容量不为空，则取出队列头部并返回。如果为空则阻塞等待指定时间。如果超过时间还为空，则返回null</p>
<h2 data-id="heading-4">源码分析</h2>
<p>ArrayBlockingQueue的精髓之处就是阻塞等待的处理，因此我将详细分析阻塞 take, put 相关的源码，理解“阻塞”的灵魂所在。</p>
<p>在此之前，我们要先理解ArrayBlockingQueue的结构。从名字来看，这个阻塞队列是以Array为基础的，因此有界就很好理解。它是以数组为基础的，数组的分配必须是连续的空间，这段连续的空间就是阻塞队列的容量。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a300ccb221b64b428ea8c38ddfee59a1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rKQ5rW06Zyyeg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767015283&amp;x-signature=UEanjM%2B2fxb4NjAabfrJDj4%2FZ1A%3D" alt="" loading="lazy"/>​</p>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>同时，我开篇也提到了，这样的阻塞队列必须是线程安全的，它底层使用了ReentrantLock来保证线程的安全。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/309f6e1f41354d2aa664222c0d9f3f7a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rKQ5rW06Zyyeg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767015283&amp;x-signature=6fuKu715vSZAcqGcAPJ8BPBlKPQ%3D" alt="" loading="lazy"/>​</p>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>为什么还要有Condition？等我们下文看源码就能知道了。</p>
<h3 data-id="heading-5">enqueue、dequeue：入队出队的底层</h3>
<pre><code class="hljs language-ini" lang="ini">//入队操作

private void enqueue(E e) {      
  final Object<span class="hljs-section">[]</span> <span class="hljs-attr">items</span> = this.items<span class="hljs-comment">;    </span>
  items<span class="hljs-section">[putIndex]</span> = e<span class="hljs-comment">;    </span>
  if (++<span class="hljs-attr">putIndex</span> == items.length) 
    <span class="hljs-attr">putIndex</span> = <span class="hljs-number">0</span><span class="hljs-comment">;    //如果当前元素入队后队列已满，重置索引，下一次再从队末进</span>
  count++<span class="hljs-comment">;    </span>
  notEmpty.signal()<span class="hljs-comment">;//如果元素加入到空队列中，则唤醒阻塞等待的元素</span>
}
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p><strong>为什么不直接操作items，反而要先定义一个局部变量 <code>final Object[] items = this.items</code> 来接收它？</strong></p>
<p><strong>一、避免多次访问堆内存，提升执行效率</strong></p>
<p>首先要明确 Java 的内存访问特性：</p>
<ul>
<li>
<p><code>this.items</code></p>
<p> 是类的成员变量，存储在<strong>堆内存</strong>中，每次访问 <code>this.items</code> 都需要通过 <code>this</code> 引用（堆地址）去寻址，相对耗时；</p>
</li>
<li>
<p>局部变量 <code>items</code> 存储在<strong>栈内存</strong>中，栈内存的访问速度远快于堆内存，而且局部变量的寻址是直接的，无需额外间接引用。</p>
</li>
</ul>
<p><code>enqueue</code> 方法中多次用到了 <code>items</code>（<code>items[putIndex] = e</code>、<code>putIndex == items.length</code>），如果直接用 <code>this.items</code>，会多次触发堆内存寻址；而先把 <code>this.items</code> 赋值给局部变量，后续只需要访问栈上的局部变量即可，减少了堆内存访问次数，提升了执行效率。</p>
<p><strong>二、防止指令重排导致的可见性问题，保证线程安全</strong></p>
<p><code>ArrayBlockingQueue</code> 是线程安全类，<code>items</code> 是共享成员变量，虽然有 <code>ReentrantLock</code> 保证原子性，但 Java 虚拟机的<strong>指令重排</strong>可能会导致潜在的可见性问题</p>
<p>简单说：<code>final</code> 局部变量相当于给 <code>items</code> 数组拍了一张 “快照”，确保整个 <code>enqueue</code> 方法执行期间，使用的是同一个数组引用，不会因为 JVM 优化而读取到错误的数组对象。</p>
<pre><code class="hljs language-ini" lang="ini">//出队操作
private E dequeue() {      
  final Object<span class="hljs-section">[]</span> <span class="hljs-attr">items</span> = this.items<span class="hljs-comment">;    </span>
  @SuppressWarnings("unchecked")    
  E <span class="hljs-attr">e</span> = (E) items[takeIndex]<span class="hljs-comment">;    //取出队列头部元素</span>
  items<span class="hljs-section">[takeIndex]</span> = null<span class="hljs-comment">;    //设为null</span>
  if (++<span class="hljs-attr">takeIndex</span> == items.length) 
    <span class="hljs-attr">takeIndex</span> = <span class="hljs-number">0</span><span class="hljs-comment">;    //与入队对应，回到队末</span>
  count--<span class="hljs-comment">;    </span>
  if (itrs != null)        
    itrs.elementDequeued()<span class="hljs-comment">;    </span>
  notFull.signal()<span class="hljs-comment">;   //唤醒因队列满而阻塞等待的队列，队列有空了 </span>
  return e<span class="hljs-comment">;</span>
}
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h4 data-id="heading-6">itrs是干什么的？</h4>
<p><strong><code>itrs</code> 是 <code>ArrayBlockingQueue</code> 用来管理当前所有活跃迭代器（Iterator）的集合，目的是保证迭代器的弱一致性，避免迭代过程中出现异常或错误的元素引用</strong>。</p>
<p>当队列执行 <code>dequeue</code> 出队操作（删除队首元素）时，会调用 <code>itrs.elementDequeued()</code>，核心目的是<strong>通知所有活跃迭代器：“某个元素被删除了，你们需要更新自己的状态，避免遍历出错”</strong> 。</p>
<pre><code class="hljs language-scss" lang="scss">void <span class="hljs-built_in">elementDequeued</span>() {    
<span class="hljs-comment">// assert lock.isHeldByCurrentThread();    </span>
if (count == <span class="hljs-number">0</span>)        
  <span class="hljs-built_in">queueIsEmpty</span>();    
else if (takeIndex == <span class="hljs-number">0</span>)        
  <span class="hljs-built_in">takeIndexWrapped</span>();
}
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p><code>queueIsEmpty() ：在本次出队后队列变空时，重置迭代器状态（``nextIndex=-1</code>、<code>remaining=0</code>），标记迭代器遍历完毕，避免无效遍历；</p>
<p><code>takeIndexWrapped() ：在本次出队后 ``takeIndex</code> 循环回绕到数组开头时，修正迭代器的 <code>nextWrapped</code> 状态，保证迭代器能正确适配队列的循环结构；</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cca622d016db4a9285b572f442f15f92~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rKQ5rW06Zyyeg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767015283&amp;x-signature=jiv%2Bf%2BIzC4VbEKZKy6z4m8O02AM%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-7">put、take：入队出队的实现</h3>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">put</span>(<span class="hljs-params">E e</span>) throws InterruptedException</span> {    
  Objects.requireNonNull(e);    
  final ReentrantLock <span class="hljs-keyword">lock</span> = <span class="hljs-keyword">this</span>.<span class="hljs-keyword">lock</span>;    
  <span class="hljs-keyword">lock</span>.lockInterruptibly();    
  <span class="hljs-keyword">try</span> {        
    <span class="hljs-keyword">while</span> (count == items.length)            
      notFull.<span class="hljs-keyword">await</span>();        <span class="hljs-comment">//如果队列满了，阻塞等待</span>
    enqueue(e);    
  } <span class="hljs-keyword">finally</span> {        
    <span class="hljs-keyword">lock</span>.unlock();    
  }
}
<span class="hljs-function"><span class="hljs-keyword">public</span> E <span class="hljs-title">take</span>() throws InterruptedException</span> {    
  final ReentrantLock <span class="hljs-keyword">lock</span> = <span class="hljs-keyword">this</span>.<span class="hljs-keyword">lock</span>;    
  <span class="hljs-keyword">lock</span>.lockInterruptibly();    
  <span class="hljs-keyword">try</span> {        
    <span class="hljs-keyword">while</span> (count == <span class="hljs-number">0</span>)            
      notEmpty.<span class="hljs-keyword">await</span>();     <span class="hljs-comment">//如果队列是空的，阻塞等待   </span>
    <span class="hljs-keyword">return</span> dequeue();    
  } <span class="hljs-keyword">finally</span> {        
    <span class="hljs-keyword">lock</span>.unlock();    
  }
}
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>可以看到，ArrayBlockingQueue使用了ReentrantLock保证了入队出队的线程安全，同时使用了条件变量实现了当队列为空/队列满了的情况下的阻塞等待。</p>
<h2 data-id="heading-8">思考</h2>
<ol>
<li>
<p>可以看到，take、put操作使用的都是同一把ReentrantLock，这说明这两个操作是会互相阻塞的。怎么样才能让这两个操作独立起来？</p>
</li>
<li>
<p>这个数组阻塞队列是强制有界的，如果不确定队列大小的情况下，该怎么处理？</p>
</li>
</ol>
<p>这两个问题在 LinkedBlockingQueue 都给出了答复，有兴趣的可以自行了解。</p>
<blockquote>
<p>我是沐浴露zz，将持续更新有趣的技术，欢迎互动交流！</p>
</blockquote>
<p>​</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[化整为零、分而治之、异步编排：一文读懂现代并发的底层心法]]></title>    <link>https://juejin.cn/post/7586491717873483795</link>    <guid>https://juejin.cn/post/7586491717873483795</guid>    <pubDate>2025-12-22T13:35:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586491717873483795" data-draft-id="7586540799250448438" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="化整为零、分而治之、异步编排：一文读懂现代并发的底层心法"/> <meta itemprop="keywords" content="后端,面试,架构"/> <meta itemprop="datePublished" content="2025-12-22T13:35:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="poemyang"/> <meta itemprop="url" content="https://juejin.cn/user/4487542162594953"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            化整为零、分而治之、异步编排：一文读懂现代并发的底层心法
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4487542162594953/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    poemyang
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T13:35:40.000Z" title="Mon Dec 22 2025 13:35:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>LongAdder：化整为零，热点分散</strong><br/>
在Java多线程编程中，‌原子变量（如AtomicLong）‌通过CAS操作实现线程安全的累加。然而，在高并发场景下，大量线程争抢同一原子变量会引发严重的‌缓存一致性问题‌。
‌ 1）缓存行伪共享‌：多个线程频繁更新同一缓存行，导致缓存失效和MESI协议频繁触发，处理器性能急剧下降。
‌ 2）CAS冲突开销‌：CAS操作需自旋重试，线程竞争激烈时重试次数增加，进一步拖慢性能。
为解决上述瓶颈，Java 8引入了‌LongAdder‌，其核心思想是‌“分散竞争，延迟求和‌”。
‌ 1）分段累加‌：将单一累加变量拆分为多个‌分段变量（cells）‌，每个线程仅更新其专属的分段，避免全局竞争。
‌ 2）基础值优化‌：在低并发场景下，直接更新基础值（base），减少分段数组的开销。
‌ 3）最终一致性求和‌：通过遍历所有分段和基础值，延迟计算总和，降低实时竞争压力。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cdfec7c837c647df92f69dbcc0cc5286~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcG9lbXlhbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767015339&amp;x-signature=keDgU8L4xG%2F9mcZwyXfMscW%2FU5I%3D" alt="添加图片注释，不超过 140 字（可选）" loading="lazy"/></p>
<p>LongAdder的内部实现原理，可以用下面的伪代码演示。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LongAdder</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> AtomicLong[] cells; <span class="hljs-comment">// 分段数组，每个线程映射到特定分段</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> AtomicLong base;    <span class="hljs-comment">// 基础值，低并发时直接更新</span>

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">LongAdder</span><span class="hljs-params">()</span> {
        cells = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicLong</span>[<span class="hljs-number">16</span>]; <span class="hljs-comment">// 假设初始化16个分段</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; cells.length; i++) {
            cells[i] = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicLong</span>(<span class="hljs-number">0</span>); <span class="hljs-comment">// 初始化分段值为0</span>
        }
        base = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicLong</span>(<span class="hljs-number">0</span>); <span class="hljs-comment">// 初始化基础值为0</span>
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">add</span><span class="hljs-params">(<span class="hljs-type">long</span> x)</span> {
        <span class="hljs-comment">// 1. 计算线程对应的分段索引（简单取模实现）</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">index</span> <span class="hljs-operator">=</span> (<span class="hljs-type">int</span>) (Thread.currentThread().getId() % cells.length);
        <span class="hljs-comment">// 2. 对专属分段执行CAS累加，避免全局竞争</span>
        cells[index].addAndGet(x);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-type">long</span> <span class="hljs-title function_">sum</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 3. 求和：累加基础值和所有分段值</span>
        <span class="hljs-type">long</span> <span class="hljs-variable">sum</span> <span class="hljs-operator">=</span> base.get();
        <span class="hljs-keyword">for</span> (AtomicLong cell : cells) {
            sum += cell.get();
        }
        <span class="hljs-keyword">return</span> sum;
    }
}
</code></pre>
<p>然而，LongAdder 并非万能钥匙。在并发度较低的场景，AtomicLong 的简单直接反而更高效，就好比小型聚会中，大家直接共享一个果盘更方便，而不需要多个果篮。另外，当需要频繁读取累计结果时，LongAdder 的汇总过程就像逐个篮子统计水果数量，略显繁琐，性能会受影响。Fork/Join：分而治之，任务窃取
Java 7 引入的 ‌Fork/Join Framework‌ 是一种强大的并行编程模型，专为解决“分而治之”（Divide and Conquer）类型的问题而设计。它充分利用多核处理器的计算能力，通过分解任务、并行执行和合并结果，显著提升程序的执行效率。
Fork/Join特别适合处理可以被分解成独立子任务的问题，以实现任务的并行执行，如排序、搜索等。
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b9e936d2dd42466fbf2a41ca4a59b0d9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcG9lbXlhbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767015339&amp;x-signature=x9Xs1A72ZeAHp5W88LXNw7fmRAw%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">if</span> (任务足够小) {
    直接计算并返回结果;
} <span class="hljs-keyword">else</span> {
    将任务拆分为N个子任务;
    对每个子任务调用 fork() 进行并行计算;
    调用 join() 合并子任务的结果;
    返回最终结果;
}
</code></pre>
<p>在Java 8中引入的并行流计算（Parallel stream computing），内部就是采用的ForkJoinPool来实现的。例如，下面使用并行流实现数组并行求和计算。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SumArray</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        List&lt;Integer&gt; numbers = Arrays.asList(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-number">7</span>, <span class="hljs-number">8</span>, <span class="hljs-number">9</span>);
         <span class="hljs-comment">// map在实际编程中，可以是耗时高，计算量大的任务</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">sum</span> <span class="hljs-operator">=</span> numbers.parallelStream().map(i -&gt; i * i).reduce(<span class="hljs-number">0</span>, Integer::sum);
    }
}
</code></pre>
<p><strong>并行编程模型</strong><br/>
并行编程模型（Parallel programming model）是一种用于描述和组织并行计算的框架或范式。它提供了一组抽象概念、编程接口和规范，用于指导开发者在多核处理器、分布式系统或并行计算环境中编写并行程序。
常见的并行编程模型包括：数据并行（Data parallelism）、任务并行（Task parallelism）、多线程并行（Multithread parallelism）等。工作窃取
工作窃取（Work Stealing）是一种高效的并行计算调度策略，其主要目标是解决负载不均衡问题，以充分利用所有的处理器核心，从而提升程序的执行效率。
在工作窃取模型中，每个处理器都维护着自己的双端队列（Deque），用于存储分配给自己的任务。当一个处理器完成了所有自己的任务后，它会尝试从其他处理器的任务队列的末尾“窃取”任务来执行。这种策略确保了所有的处理器都能尽可能地保持忙碌状态，从而提高整体的并行性能。
工作窃取策略的一个显著优点是其能够动态地平衡负载。这意味着它能够适应各种不同的任务分布和处理器性能，从而在各种情况下都能提供优秀的性能。
在实际编程实践中，工作窃取调度策略通常由并行编程框架或库来实现。例如，Java的Fork/Join框架就采用了工作窃取策略来动态地分配任务，C++的Intel TBB（Threading Building Blocks）库也使用了类似的策略。
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cd68ac1c1a1f42cb9272cf72adc85f5b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcG9lbXlhbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767015339&amp;x-signature=Y7art1cA70V8L5W3Xsr1uSY6p4k%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p><strong>CompletableFuture：构建优雅的异步流水线</strong><br/>
CompletableFuture 是 Java 8 引入的一个核心类，它实现了 Future 接口，并在其基础上提供了更强大、更灵活的异步编程能力。与传统的 Future 相比，CompletableFuture 不仅能够表示一个异步计算的结果，还支持丰富的函数式编程特性，使得开发者能够以声明式的方式处理异步任务的执行流程。
CompletableFuture 的核心优势在于其支持链式调用（Chaining），允许在一个 CompletableFuture 上附加多个操作（如转换结果、处理异常、组合多个任务等）。这些操作会在 CompletableFuture 完成时自动触发，从而形成一个流水线式的任务处理流程。
‌ 以下是一个简单的示例，展示了 ‌CompletableFuture‌ 的链式调用。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// supplyAsync方法用于启动一个异步任务，thenApply方法用于在任务完成时对结果进行转换</span>
CompletableFuture&lt;String&gt; future = CompletableFuture.supplyAsync(() -&gt; {
     ......
    <span class="hljs-comment">// 异步任务，模拟网络请求</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">"Hello"</span>;
}).thenApply(result -&gt; {
    <span class="hljs-comment">// 对结果进行转换</span>
    <span class="hljs-keyword">return</span> result + <span class="hljs-string">" World"</span>;
});
<span class="hljs-comment">// 主线程等待异步操作完成</span>
future.join();
<span class="hljs-comment">// 获取异步执行结果</span>
future.get();
</code></pre>
<p><strong>异步编程</strong><br/>
异步编程是一种高效的编程范式，旨在优化程序的执行效率和资源利用率。它通过允许程序在等待耗时操作（如网络请求、文件I/O等）完成的同时，继续执行其他任务，从而避免了传统同步编程中的线程阻塞问题。这种非阻塞的执行方式显著提升了程序的响应速度和并发处理能力，尤其适用于I/O密集型任务。
在传统的同步编程模型中，当一个操作需要较长时间完成时，程序会停滞在该操作上，直到操作结束，这种现象称为阻塞。相比之下，异步编程模型允许程序在启动一个耗时操作后，立即转而执行其他任务，而无需等待该操作完成。当操作完成后，程序会通过回调、事件或Future等机制收到通知，并处理操作结果。
异步编程在多种编程语言中都有应用和实现。例如，Java中的CompletableFuture、JavaScript中的Promise，以及Python中的asyncio库等，都提供了强大的异步编程支持。
以下是一个简单的同步与异步读取文件的对比示例（伪代码）。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 同步执行读取文件操作</span>
<span class="hljs-type">let</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> read(<span class="hljs-string">"a.txt"</span>);
<span class="hljs-comment">// 同步等待上次一次文件操作完成</span>
<span class="hljs-type">let</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> read(<span class="hljs-string">"b.txt"</span>);
<span class="hljs-comment">// 假设单个文件读取耗时50ms，一共需要耗时100ms</span>
print(a+b)

<span class="hljs-comment">// 异步执行读取文件操作</span>
<span class="hljs-type">let</span> <span class="hljs-variable">op_a</span> <span class="hljs-operator">=</span> read_async(<span class="hljs-string">"a.txt"</span>);
<span class="hljs-type">let</span> <span class="hljs-variable">op_b</span> <span class="hljs-operator">=</span> read_async(<span class="hljs-string">"b.txt"</span>);
<span class="hljs-type">let</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> wait_until_get_ready(op_a);
<span class="hljs-type">let</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> wait_until_get_ready(op_b);
<span class="hljs-comment">// 假设单个文件读取耗时50ms， 由于两次读取文件操作同时异步执行，最终耗时50ms</span>
print(a+b);

fn <span class="hljs-title function_">wait_until_get_ready</span><span class="hljs-params">(Operation)</span> -&gt; Response {
  <span class="hljs-comment">// 阻塞任务，挂起线程，直到operation就绪再唤醒线程（唤醒操作，需要操作系统和硬件的底层支撑）</span>
}
</code></pre>
<p>异步编程可以更有效地处理并发问题。当程序需要同时处理多个任务时，异步编程可以让这些任务并发执行，而不是按顺序一个接一个地执行。然而，异步编程的实现离不开操作系统和硬件的底层支持。如果在异步任务执行完之前，处理线程一直对异步任务执行状态进行空轮询，这将会浪费处理器资源。因此，操作系统和硬件的底层支持，如Linux系统支持的select、poll、epoll等技术，对于异步编程的实现至关重要。
以下是一个没有底层支持时，异步编程可能面临的问题的示例（伪代码）。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">let</span> <span class="hljs-variable">op_a</span> <span class="hljs-operator">=</span> read_async(<span class="hljs-string">"a.txt"</span>);
<span class="hljs-type">let</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> <span class="hljs-string">""</span>;
<span class="hljs-comment">// 如果没有操作系统和硬件的底层支撑，将不断轮询op_a的任务状态</span>
<span class="hljs-keyword">while</span> <span class="hljs-literal">true</span> {
  <span class="hljs-keyword">if</span> op_a.is_finish() {
    a = op_a.get_content();
    <span class="hljs-keyword">break</span>;
  }
}
print(a);
</code></pre>
<p><strong>链式调用</strong><br/>
“回调地狱”（Callback Hell）是异步编程中常见的一个问题，尤其在 JavaScript 等单线程、事件驱动型语言中尤为突出。当多个异步操作需要按照特定顺序执行时，开发者可能不得不在一个回调函数中嵌套另一个回调函数，导致代码层级过深、可读性差、难以维护。
以下是一个典型的“回调地狱”示例（JavaScript）。</p>
<pre><code class="hljs language-java" lang="java">login(user =&gt; {
    getStatus(status =&gt; {
        getOrder(order =&gt; {
            getPayment(payment =&gt; {
                getRecommendAdvertisements(ads =&gt; {
                    setTimeout(() =&gt; {
                        alert(ads)
                    }, <span class="hljs-number">1000</span>)
                })
            })
        })
    })
})
</code></pre>
<p>链式调用（Chaining）成为一种常用的优化手段。在 JavaScript 中，‌Promise‌ 机制提供了链式调用的能力。每个 ‌Promise‌ 对象都包含一个 ‌then‌ 方法，该方法返回一个新的 ‌Promise‌ 对象，从而允许开发者将多个异步操作串联起来，形成清晰的逻辑流。
以下是一个使用 ‌Promise‌ 链式调用的示例（JavaScript）。</p>
<pre><code class="hljs language-java" lang="java">login(username, password)
    .then(user =&gt; getStatus(user.id))
    .then(status =&gt; getOrder(status.id))
    .then(order =&gt; getPayment(order.id))
    .then(payment =&gt; getRecommendAdvertisements(payment.total_amount))
    .then(ads =&gt; {<span class="hljs-comment">/*...*/</span>});
</code></pre>
<p>需要注意的是，‌Promise‌ 并不是一种可以将同步代码转变为异步代码的魔法工具。它只是一种编程手法，或者说是一种封装方式，并没有借助操作系统的额外能力。‌Promise‌ 的主要作用是提供了一种更优雅的方式来组织和管理异步操作，使得代码更易于阅读和理解。</p>
<p><strong>总结：与硬件共舞，与冲突和解</strong><br/>
Disruptor的环形缓冲、LongAdder的分散热点、Fork/Join的工作窃取、CompletableFuture的异步编排——这些看似迥异的技术，实则殊途同归。它们共同揭示了现代并发设计的核心要义：与其在冲突发生后被动地加锁仲裁，不如在设计之初就主动地消除冲突。
这标志着并发编程的关注点，已从“如何正确加锁”的战术层面，升华为“如何精妙分工、避免锁”的战略高度。
当摩尔定律的红利逐渐消退，真正的性能突破不再依赖于硬件的暴力堆砌，而是源于软件层面与硬件底层机制的“共舞”。无论是利用缓存行特性的内存对齐，还是借助CAS原子指令的乐观更新，每一次技术优化都印证了一个理念：硬件性能的极致发挥，源于对计算本质的深刻理解。这正是并发编程从技术迈向艺术的精髓所在。</p>
<p><strong>很高兴与你相遇！如果你喜欢本文内容，记得关注哦!!!</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[HarmonyOS6 接入快手 SDK 指南]]></title>    <link>https://juejin.cn/post/7586559672129355828</link>    <guid>https://juejin.cn/post/7586559672129355828</guid>    <pubDate>2025-12-23T01:52:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586559672129355828" data-draft-id="7586531677721083939" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="HarmonyOS6 接入快手 SDK 指南"/> <meta itemprop="keywords" content="前端,HarmonyOS"/> <meta itemprop="datePublished" content="2025-12-23T01:52:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="万少"/> <meta itemprop="url" content="https://juejin.cn/user/4441682708283191"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            HarmonyOS6 接入快手 SDK 指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4441682708283191/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    万少
  </span> <!----> <!----> <div class="vip-level" data-v-cd7d0a50="" data-v-292f6e48=""><span class="tooltip" data-v-cd7d0a50=""><div class="byte-tooltip byte-tooltip--dark" style="display:none;">
        VIP.5 如鱼得水
      </div><span class="byte-tooltip__wrapper"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAAA8AQMAAAAAMksxAAAAA1BMVEUAAACnej3aAAAAAXRSTlMAQObYZgAAAA5JREFUKM9jGAWjAAcAAAIcAAE27nY6AAAAAElFTkSuQmCC" alt="VIP.5 如鱼得水" title="VIP.5 如鱼得水" class="lazy" style="aspect-ratio:NaN;" data-v-5244ef91="" data-v-cd7d0a50=""/></span></span></div> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T01:52:05.000Z" title="Tue Dec 23 2025 01:52:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"/>
<h3 data-id="heading-1">介绍</h3>
<p>目前快手开放了 授权、发布单图、发布单视频的鸿蒙能力，开发者如果有需要接入，可以按照以下流程操作。</p>
<h3 data-id="heading-2">效果一览</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d2efb24bff1c43b98eca37630f81061b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiH5bCR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767059524&amp;x-signature=SCXwcT%2BvwrYJxaf7yjl4Q0Aa2%2Bo%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-3">环境准备</h3>
<p>开发者需要在快手开放平台完成<strong>注册</strong>，新建一个<strong>应用</strong>，并获取<strong>应用标识 appId</strong> ，详细参考申请注册流程，官网地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fopen.kuaishou.com%2Fplatform" target="_blank" title="https://open.kuaishou.com/platform" ref="nofollow noopener noreferrer">open.kuaishou.com/platform</a></p>
<h3 data-id="heading-4">环境要求</h3>
<ul>
<li>快手版本 &gt;= 13.0.10</li>
<li>鸿蒙SDK版本 &gt;= 12</li>
</ul>
<h3 data-id="heading-5">接入步骤</h3>
<ol>
<li>在模块中引入 SDK依赖，如 Entry模块</li>
</ol>

<pre><code class="hljs language-perl" lang="perl">  <span class="hljs-string">"dependencies"</span>: {    <span class="hljs-string">"@kwai_open_platform/opensdk"</span>: <span class="hljs-string">"^1.0.1"</span>
  }
</code></pre>
<p>2.  在 entry 模块下的 module.json5 文件中添加querySchemes配置。</p>
<blockquote>
<p>在鸿蒙应用的<code>module.json5</code>文件中配置<code>querySchemes</code>的作用是<strong>声明应用支持的URL协议（URL Scheme）</strong> ，允许其他应用或网页通过特定格式的URL调起当前应用。具体解析如下：</p>
<ol>
<li>
<p><strong>核心功能实现</strong>示例中配置的<code>"kwai"</code>和<code>"ksnebula"</code>表示该应用可以响应以下两种格式的URL请求：</p>
</li>
</ol>
<ul>
<li>
<p><code>kwai://...</code></p>
</li>
<li>
<p><code>ksnebula://...</code>当其他应用或系统触发这类链接时，鸿蒙系统会尝试启动当前应用并传递参数。</p>
</li>
</ul>
<ol start="3">
<li>
<p><strong>典型应用场景</strong></p>
</li>
</ol>
<ul>
<li>跨应用跳转：其他应用通过<code>startAbility</code>发送包含对应Scheme的Want对象调起本应用</li>
<li>网页跳转：在浏览器中点击<code>&lt;a href="kwai://detail?id=123"&gt;</code>类链接触发应用打开</li>
<li>广告引流：通过短信、二维码等方式引导用户通过特定Scheme打开应用指定页面</li>
</ul>
</blockquote>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"module"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"querySchemes"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-string">"kwai"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"ksnebula"</span>
    <span class="hljs-punctuation">]</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>3.  同时还需求申请网络权限</p>

<pre><code class="hljs language-json" lang="json">    <span class="hljs-attr">"requestPermissions"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"name"</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">"ohos.permission.INTERNET"</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">]</span>
</code></pre>
<p>4.  在接受回调的 UIAbility 的 onCreate 和 onNewWant 方法中，调用 kwaiOpenSdk.handleCallback 方法处理回调数据。</p>
<blockquote>
<p><strong>onCreate</strong> 表示应用首次启动</p>
<p><strong>onNewWant</strong> 表示应用已经启动的，然后被重新拉起</p>
</blockquote>
<pre><code class="hljs language-php" lang="php">import { kwaiOpenSdk } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kwai_open_platform/opensdk/src/main/ets/KwaiOpensdk'</span>;

export <span class="hljs-keyword">default</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EntryAbility</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">UIAbility</span> </span>{
  <span class="hljs-title function_ invoke__">onCreate</span>(<span class="hljs-attr">want</span>: Want, <span class="hljs-attr">launchParam</span>: AbilityConstant.LaunchParam): <span class="hljs-keyword">void</span> {
    kwaiOpenSdk.<span class="hljs-title function_ invoke__">handleCallback</span>(want)
  }

  <span class="hljs-title function_ invoke__">onNewWant</span>(<span class="hljs-attr">want</span>: Want, <span class="hljs-attr">launchParam</span>: AbilityConstant.LaunchParam): <span class="hljs-keyword">void</span> {
    kwaiOpenSdk.<span class="hljs-title function_ invoke__">handleCallback</span>(want)
  }
}
</code></pre>
<p>5.  初始化SDK，如在 Index.ets的aboutToAppear中初始化</p>

<pre><code class="hljs language-csharp" lang="csharp">  aboutToAppear(): <span class="hljs-keyword">void</span> {
    <span class="hljs-comment">// 初始化快手SDK</span>
    kwaiOpenSdk.<span class="hljs-keyword">init</span>(<span class="hljs-keyword">this</span>.context);
  }
</code></pre>
<h3 data-id="heading-6">相关功能</h3>
<p>目前SDK提供有 授权 和 发布单图和发单视频能力，开发者可以根据需求引入使用</p>
<h4 data-id="heading-7">初始化代码数据</h4>
<blockquote>
<p>定义快手应用ID <strong>APPID</strong></p>
<p>定义鸿蒙应用ID  harmonyAppID</p>
<p>定义媒体选择通用方法 <strong>selectMedia</strong></p>
</blockquote>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 导入快手开放平台SDK</span>
<span class="hljs-keyword">import</span> { kwaiOpenSdk } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kwai_open_platform/opensdk/src/main/ets/KwaiOpensdk'</span>;
<span class="hljs-comment">// 导入AbilityKit相关组件</span>
<span class="hljs-keyword">import</span> { common } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;
<span class="hljs-comment">// 导入授权请求模型</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">AuthRequest</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kwai_open_platform/opensdk/src/main/ets/model/request/AuthRequest'</span>;
<span class="hljs-comment">// 导入授权响应模型</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">AuthResponse</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kwai_open_platform/opensdk/src/main/ets/model/response/AuthResponse'</span>;
<span class="hljs-comment">// 导入日志工具</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Logger</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kwai_open_platform/opensdk/src/main/ets/utils/Logger'</span>;
<span class="hljs-comment">// 导入分享请求模型创建函数</span>
<span class="hljs-keyword">import</span> {
  createSingleImagePublish,
  createSingleVideoPublish
} <span class="hljs-keyword">from</span> <span class="hljs-string">'@kwai_open_platform/opensdk/src/main/ets/model/request/ShareRequest'</span>;
<span class="hljs-comment">// 导入ArkTS集合框架</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ArrayList</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkTS'</span>;
<span class="hljs-comment">// 导入媒体库访问助手</span>
<span class="hljs-keyword">import</span> { photoAccessHelper } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.MediaLibraryKit'</span>;
<span class="hljs-comment">// 导入文件操作相关工具</span>
<span class="hljs-keyword">import</span> { fileIo, fileUri } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.CoreFileKit'</span>;

<span class="hljs-comment">// 定义快手应用ID</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">APPID</span> = <span class="hljs-string">"ks669910448092164647"</span>

<span class="hljs-comment">// 定义鸿蒙应用ID</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">harmonyAppID</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">"6917560710208292268"</span>;

<span class="hljs-meta">@Entry</span>
<span class="hljs-meta">@Component</span>
struct <span class="hljs-title class_">Index</span> {
  <span class="hljs-comment">// 获取UIAbility上下文</span>
  context = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getHostContext</span>() <span class="hljs-keyword">as</span> common.<span class="hljs-property">UIAbilityContext</span>;
  <span class="hljs-comment">// 回调结果状态</span>
  <span class="hljs-meta">@State</span> <span class="hljs-attr">callbackResult</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span>;
  <span class="hljs-comment">// 授权码</span>
  <span class="hljs-meta">@State</span> <span class="hljs-attr">authCode</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">""</span>;
  <span class="hljs-comment">// 错误信息</span>
  <span class="hljs-meta">@State</span> <span class="hljs-attr">errMsg</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">""</span>;
  <span class="hljs-comment">// 错误码</span>
  <span class="hljs-meta">@State</span> <span class="hljs-attr">errCode</span>: <span class="hljs-built_in">number</span> = -<span class="hljs-number">1</span>;

  <span class="hljs-title function_">aboutToAppear</span>(): <span class="hljs-built_in">void</span> {
    <span class="hljs-comment">// 初始化快手SDK</span>
    kwaiOpenSdk.<span class="hljs-title function_">init</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>);
  }


  <span class="hljs-comment">// 媒体选择通用方法</span>
  <span class="hljs-keyword">private</span> selectMedia&lt;T&gt;(
    <span class="hljs-attr">callback</span>: <span class="hljs-function">(<span class="hljs-params">t: T</span>) =&gt;</span> <span class="hljs-built_in">void</span>,
    <span class="hljs-attr">type</span>: photoAccessHelper.<span class="hljs-property">PhotoViewMIMETypes</span>.<span class="hljs-property">IMAGE_TYPE</span> | photoAccessHelper.<span class="hljs-property">PhotoViewMIMETypes</span>.<span class="hljs-property">VIDEO_TYPE</span>,
    <span class="hljs-attr">num</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">1</span>
  ) {
    <span class="hljs-comment">// 创建照片选择选项</span>
    <span class="hljs-keyword">let</span> photoOptions = <span class="hljs-keyword">new</span> photoAccessHelper.<span class="hljs-title class_">PhotoSelectOptions</span>();
    <span class="hljs-comment">// 设置MIME类型（图片或视频）</span>
    photoOptions.<span class="hljs-property">MIMEType</span> = <span class="hljs-keyword">type</span>;
    <span class="hljs-comment">// 设置最大选择数量</span>
    photoOptions.<span class="hljs-property">maxSelectNumber</span> = num;

    <span class="hljs-comment">// 创建照片选择器</span>
    <span class="hljs-keyword">let</span> picker = <span class="hljs-keyword">new</span> photoAccessHelper.<span class="hljs-title class_">PhotoViewPicker</span>();
    <span class="hljs-comment">// 调用选择方法</span>
    picker.<span class="hljs-title function_">select</span>(photoOptions).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">photoSelectResult: photoAccessHelper.PhotoSelectResult</span>) =&gt;</span> {
      <span class="hljs-comment">// 获取选中的URI列表</span>
      <span class="hljs-keyword">let</span> <span class="hljs-attr">uris</span>: <span class="hljs-title class_">Array</span>&lt;<span class="hljs-built_in">string</span>&gt; = photoSelectResult.<span class="hljs-property">photoUris</span>;
      <span class="hljs-keyword">if</span> (uris.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-comment">// 获取第一个URI</span>
        <span class="hljs-keyword">let</span> str = uris[<span class="hljs-number">0</span>];
        <span class="hljs-comment">// 提取文件名</span>
        <span class="hljs-keyword">let</span> fileName = str.<span class="hljs-title function_">substring</span>(str.<span class="hljs-title function_">lastIndexOf</span>(<span class="hljs-string">'/'</span>));
        <span class="hljs-comment">// 构建目标文件路径</span>
        <span class="hljs-keyword">let</span> desFilePath = <span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>.<span class="hljs-title function_">getApplicationContext</span>().<span class="hljs-property">tempDir</span> + fileName;
        <span class="hljs-comment">// 打开源文件（只读）</span>
        <span class="hljs-keyword">let</span> srcFile = fileIo.<span class="hljs-title function_">openSync</span>(str, fileIo.<span class="hljs-property">OpenMode</span>.<span class="hljs-property">READ_ONLY</span>);
        <span class="hljs-comment">// 打开目标文件（写，如不存在则创建）</span>
        <span class="hljs-keyword">let</span> desFile = fileIo.<span class="hljs-title function_">openSync</span>(desFilePath, fileIo.<span class="hljs-property">OpenMode</span>.<span class="hljs-property">WRITE_ONLY</span> | fileIo.<span class="hljs-property">OpenMode</span>.<span class="hljs-property">CREATE</span>);
        <span class="hljs-comment">// 复制文件内容</span>
        fileIo.<span class="hljs-title function_">copyFileSync</span>(srcFile.<span class="hljs-property">fd</span>, desFile.<span class="hljs-property">fd</span>)
        <span class="hljs-comment">// 回调处理，传递文件URI</span>
        callback?.(fileUri.<span class="hljs-title function_">getUriFromPath</span>(desFilePath) <span class="hljs-keyword">as</span> T);
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// 未选择资源时显示提示</span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getPromptAction</span>().<span class="hljs-title function_">showToast</span>({
          <span class="hljs-attr">message</span>: <span class="hljs-string">'没有选择资源'</span>
        })
      }
    }).<span class="hljs-keyword">catch</span>(<span class="hljs-function">(<span class="hljs-params">error: BusinessError</span>) =&gt;</span> {
      <span class="hljs-comment">// 选择出错时显示提示</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getPromptAction</span>().<span class="hljs-title function_">showToast</span>({
        <span class="hljs-attr">message</span>: <span class="hljs-string">'选择资源error'</span>
      })
    })
  }
}
</code></pre>
<h4 data-id="heading-8">接入快手授权能力</h4>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/56d1f69d57684e85ae3b0522390890f1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiH5bCR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767059524&amp;x-signature=DHyx5S3XDq9L1R2vqMBsgJu3js0%3D" alt="图片" loading="lazy"/></p>
<p>参数说明:</p>
<p>参数</p>
<p>说明</p>
<p>是否必填</p>
<p>requiredScopes</p>
<p>申请获取用户的那些授权信息，如果需要多个scope，用 “,” 分割。比如：user_info,user_phone</p>
<p>是</p>
<p>optional0Scopes</p>
<p>可选scope，授权页可以取消勾选，默非认勾选态</p>
<p>否</p>
<p>optional1Scopes</p>
<p>可选scope，授权页可以取消勾选，默认勾选态</p>
<p>否</p>
<p>callbackLocalEntry</p>
<p>回调的UIAbility名称，需要在module.json中声明</p>
<p>是</p>
<p>abilityContext</p>
<p>如果没有安装快手，会跳转到应用市场安装。不传则不会跳转到应用市场</p>
<p>否</p>
<pre><code class="hljs language-javascript" lang="javascript">  <span class="hljs-comment">// 授权功能实现</span>
  fn1 = <span class="hljs-function">() =&gt;</span> {
    {
      <span class="hljs-comment">// 创建授权请求对象</span>
      <span class="hljs-keyword">let</span> request = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AuthRequest</span>(<span class="hljs-variable constant_">APPID</span>);
      <span class="hljs-comment">// 设置必需的权限范围</span>
      request.<span class="hljs-property">requiredScopes</span> = <span class="hljs-string">"user_phone,user_info"</span>;
      <span class="hljs-comment">// 设置可选权限范围0</span>
      request.<span class="hljs-property">optional0Scopes</span> = <span class="hljs-string">"user_base,share_media,following,share_message"</span>
      <span class="hljs-comment">// 设置可选权限范围1</span>
      request.<span class="hljs-property">optional1Scopes</span> = <span class="hljs-string">"user_growth_distribution,message,live,relation"</span>
      <span class="hljs-comment">// 设置回调入口</span>
      request.<span class="hljs-property">callbackLocalEntry</span> = <span class="hljs-string">"EntryAbility"</span>;
      <span class="hljs-comment">// 设置Ability上下文</span>
      request.<span class="hljs-property">abilityContext</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>;
      <span class="hljs-comment">// 重要提示，这行代码不要复制</span>
      request.<span class="hljs-property">harmonyAppId</span> = harmonyAppID
      <span class="hljs-comment">// 调用SDK授权接口</span>
      kwaiOpenSdk.<span class="hljs-title function_">createApi</span>().<span class="hljs-title function_">authorize</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>, request, {
        <span class="hljs-comment">// 授权成功回调</span>
        <span class="hljs-attr">onSuccess</span>: <span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {
          <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">i</span>(<span class="hljs-string">"authCallback"</span>, <span class="hljs-string">"success......."</span>);
          <span class="hljs-comment">// 保存授权码</span>
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">authCode</span> = (res <span class="hljs-keyword">as</span> <span class="hljs-title class_">AuthResponse</span>).<span class="hljs-property">code</span>;
          <span class="hljs-comment">// 设置回调结果为成功</span>
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">callbackResult</span> = <span class="hljs-literal">true</span>;
        },
        <span class="hljs-comment">// 授权失败回调</span>
        <span class="hljs-attr">onError</span>: <span class="hljs-function">(<span class="hljs-params">errorCode, msg</span>) =&gt;</span> {
          <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">i</span>(<span class="hljs-string">"authCallback"</span>, <span class="hljs-string">`failed, code: <span class="hljs-subst">${errorCode}</span>, msg: <span class="hljs-subst">${msg}</span>`</span>);
          <span class="hljs-comment">// 保存错误信息</span>
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">errMsg</span> = msg
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">errCode</span> = errorCode
          <span class="hljs-comment">// 设置回调结果为失败</span>
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">callbackResult</span> = <span class="hljs-literal">false</span>;
        }
      })
    }
  }
</code></pre>
<h4 data-id="heading-9">授权-错误码</h4>
<p>错误码</p>
<p>描述</p>
<p>999</p>
<p>成功</p>
<p>1000</p>
<p>appId is empty</p>
<p>1001</p>
<p>request is error</p>
<p>1002</p>
<p>request is empty</p>
<p>1003</p>
<p>request bundle id is empty</p>
<p>1004</p>
<p>request harmony app id is empty</p>
<p>1005</p>
<p>not install kuaishou app</p>
<p>2000</p>
<p>auth request requiredScopes is empty</p>
<p>2002</p>
<p>无效的授权内容</p>
<p>2101</p>
<p>提交授权信息失败，缺少授权参数</p>
<p>100200100</p>
<p>请求缺少参数或参数类型错误</p>
<p>100200101</p>
<p>无效的client，无效的 app 或 developer，可能是验证参数不正确（回调地址等信息）</p>
<p>100200102</p>
<p>请求被拒绝，可能是无效的 token 等</p>
<p>100200103</p>
<p>请求的 responseType 错误</p>
<p>100200104</p>
<p>请求的 grantType 不支持</p>
<p>100200105</p>
<p>请求的 code 错误</p>
<p>100200106</p>
<p>请求的 scope 错误</p>
<p>100200107</p>
<p>无效的 openid</p>
<p>100200108</p>
<p>access_token过期</p>
<p>100200109</p>
<p>用户取消该 app 授权</p>
<p>100200110</p>
<p>用户授权过期</p>
<p>100200111</p>
<p>用户未授权过</p>
<p>100200112</p>
<p>bundleToken不合法</p>
<p>100200113</p>
<p>refresh_token过期</p>
<p>100200500</p>
<p>服务内部错误</p>
<h4 data-id="heading-10">接入发布单图能力</h4>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e45648e69f8d4128881e4695df231e5f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiH5bCR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767059524&amp;x-signature=JGyeCEueX6yHa39i64aDS9EMY%2Bk%3D" alt="图片" loading="lazy"/></p>
<ol>
<li><strong>分享请求构建</strong>：</li>
<li>使用<code>createSingleImagePublish(APPID)</code>创建单图分享请求对象</li>
<li>初始化<code>ArrayList</code>存储媒体URI列表，并添加选中图片的URI</li>
<li>设置<code>callbackLocalEntry</code>指定回调入口为<strong>EntryAbility</strong></li>
<li><strong>关键参数配置</strong>：</li>
<li>显式设置<code>harmonyAppId</code>参数（注释提示该行代码具有重要性）</li>
<li>通过上下文<code>this.context</code>保持与当前页面的关联</li>
<li><strong>SDK调用与结果处理</strong>：</li>
</ol>
<p>调用<code>kwaiOpenSdk.createApi().share()</code>方法执行实际分享操作</p>
<pre><code class="hljs language-typescript" lang="typescript">  fn2 = <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// 调用媒体选择方法，指定图片类型</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">selectMedia</span>&lt;<span class="hljs-built_in">string</span>&gt;(<span class="hljs-function">(<span class="hljs-params">url: <span class="hljs-built_in">string</span></span>) =&gt;</span> {
      <span class="hljs-comment">// 创建单图分享请求对象</span>
      <span class="hljs-keyword">let</span> shareRequest = <span class="hljs-title function_">createSingleImagePublish</span>(<span class="hljs-variable constant_">APPID</span>);
      <span class="hljs-comment">// 创建媒体URI列表</span>
      <span class="hljs-keyword">let</span> <span class="hljs-attr">list</span>: <span class="hljs-title class_">ArrayList</span>&lt;<span class="hljs-built_in">string</span>&gt; = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>();
      <span class="hljs-comment">// 添加选中的图片URI</span>
      list.<span class="hljs-title function_">add</span>(url);
      <span class="hljs-comment">// 设置媒体URI列表</span>
      shareRequest.<span class="hljs-property">mediaUri</span> = list;
      <span class="hljs-comment">// 设置回调入口</span>
      shareRequest.<span class="hljs-property">callbackLocalEntry</span> = <span class="hljs-string">"EntryAbility"</span>;
      <span class="hljs-comment">// 重要提示，这行代码不要复制</span>
      shareRequest.<span class="hljs-property">harmonyAppId</span> = harmonyAppID

      <span class="hljs-comment">// 调用SDK分享接口</span>
      kwaiOpenSdk.<span class="hljs-title function_">createApi</span>().<span class="hljs-title function_">share</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>, shareRequest, {
        <span class="hljs-comment">// 分享成功回调</span>
        <span class="hljs-attr">onSuccess</span>: <span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {
          <span class="hljs-comment">// 设置回调结果为成功</span>
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">callbackResult</span> = <span class="hljs-literal">true</span>;
          <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">i</span>(<span class="hljs-string">"shareCallback"</span>, <span class="hljs-string">"success......."</span>);
        },
        <span class="hljs-comment">// 分享失败回调</span>
        <span class="hljs-attr">onError</span>: <span class="hljs-function">(<span class="hljs-params">errorCode, msg</span>) =&gt;</span> {
          <span class="hljs-comment">// 设置回调结果为失败</span>
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">callbackResult</span> = <span class="hljs-literal">false</span>;
          <span class="hljs-comment">// 保存错误信息</span>
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">errMsg</span> = msg
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">errCode</span> = errorCode
          <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">i</span>(<span class="hljs-string">"shareCallback"</span>, <span class="hljs-string">`failed, code: <span class="hljs-subst">${errorCode}</span>, msg: <span class="hljs-subst">${msg}</span>`</span>);
        }
      })
    }, photoAccessHelper.<span class="hljs-property">PhotoViewMIMETypes</span>.<span class="hljs-property">IMAGE_TYPE</span>);
  }
</code></pre>
<h4 data-id="heading-11">接入发布单视频能力</h4>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/63f49a52ff4a4256b69c2fd950e84b56~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiH5bCR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767059524&amp;x-signature=EFFPl7pdS2xGPvci74YRiep%2BS7g%3D" alt="图片" loading="lazy"/></p>
<ol>
<li><strong>视频分享请求构建</strong></li>
</ol>
<ul>
<li>初始化<code>ArrayList</code>容器</li>
<li>将视频URI添加到容器</li>
<li>设置请求的<code>mediaUri</code>属性为容器对象</li>
</ul>
<ol>
<li>对象创建：<code>createSingleVideoPublish(APPID)</code>生成视频分享请求对象（区别于图片接口）</li>
<li>媒体列表管理：</li>
<li><strong>关键参数配置</strong></li>
<li><code>callbackLocalEntry</code>指定回调入口为"EntryAbility"（需与实际Ability名称一致）</li>
<li><code>harmonyAppId</code>显式赋值（通过独立变量<code>harmonyAppID</code>注入，需确保配置有效性）</li>
<li><strong>SDK调用与响应处理</strong></li>
</ol>
<p>通过<code>kwaiOpenSdk.createApi().share()</code>发起分享请求，传入上下文对象和配置参</p>
<pre><code class="hljs language-typescript" lang="typescript">  <span class="hljs-comment">// 发布单视频功能实现</span>
  fn3 = <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// 调用媒体选择方法，指定视频类型</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">selectMedia</span>&lt;<span class="hljs-built_in">string</span>&gt;(<span class="hljs-function">(<span class="hljs-params">url: <span class="hljs-built_in">string</span></span>) =&gt;</span> {
      <span class="hljs-comment">// 创建单视频分享请求对象</span>
      <span class="hljs-keyword">let</span> shareRequest = <span class="hljs-title function_">createSingleVideoPublish</span>(<span class="hljs-variable constant_">APPID</span>);
      <span class="hljs-comment">// 创建媒体URI列表</span>
      <span class="hljs-keyword">let</span> <span class="hljs-attr">list</span>: <span class="hljs-title class_">ArrayList</span>&lt;<span class="hljs-built_in">string</span>&gt; = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>();
      <span class="hljs-comment">// 添加选中的视频URI</span>
      list.<span class="hljs-title function_">add</span>(url);
      <span class="hljs-comment">// 设置媒体URI列表</span>
      shareRequest.<span class="hljs-property">mediaUri</span> = list;
      <span class="hljs-comment">// 设置回调入口</span>
      shareRequest.<span class="hljs-property">callbackLocalEntry</span> = <span class="hljs-string">"EntryAbility"</span>;
      <span class="hljs-comment">// 重要提示，这行代码不要复制</span>
      shareRequest.<span class="hljs-property">harmonyAppId</span> = harmonyAppID
      <span class="hljs-comment">// 调用SDK分享接口</span>
      kwaiOpenSdk.<span class="hljs-title function_">createApi</span>().<span class="hljs-title function_">share</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>, shareRequest, {
        <span class="hljs-comment">// 分享成功回调</span>
        <span class="hljs-attr">onSuccess</span>: <span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {
          <span class="hljs-comment">// 设置回调结果为成功</span>
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">callbackResult</span> = <span class="hljs-literal">true</span>;
          <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">i</span>(<span class="hljs-string">"shareCallback"</span>, <span class="hljs-string">"success......."</span>);
        },
        <span class="hljs-comment">// 分享失败回调</span>
        <span class="hljs-attr">onError</span>: <span class="hljs-function">(<span class="hljs-params">errorCode, msg</span>) =&gt;</span> {
          <span class="hljs-comment">// 设置回调结果为失败</span>
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">callbackResult</span> = <span class="hljs-literal">false</span>;
          <span class="hljs-comment">// 保存错误信息</span>
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">errMsg</span> = msg
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">errCode</span> = errorCode
          <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">i</span>(<span class="hljs-string">"shareCallback"</span>, <span class="hljs-string">`failed, code: <span class="hljs-subst">${errorCode}</span>, msg: <span class="hljs-subst">${msg}</span>`</span>);
        }
      })
    }, photoAccessHelper.<span class="hljs-property">PhotoViewMIMETypes</span>.<span class="hljs-property">VIDEO_TYPE</span>);
  }
</code></pre>
<h4 data-id="heading-12">发布单图-发布单视频的错误码</h4>
<p>错误码</p>
<p>描述</p>
<p>999</p>
<p>成功</p>
<p>1000</p>
<p>appId is empty</p>
<p>1001</p>
<p>request is error</p>
<p>1002</p>
<p>request is empty</p>
<p>1003</p>
<p>request bundle id is empty</p>
<p>1004</p>
<p>request harmony app id is empty</p>
<p>1005</p>
<p>not install kuaishou app</p>
<p>3000</p>
<p>用户取消</p>
<p>3001</p>
<p>框架出错，请反馈客服</p>
<p>3002</p>
<p>参数错误，包含shareType、appId、harmonyId、mediaUri等相关参数</p>
<p>3003</p>
<p>打开发布页失败</p>
<p>3004</p>
<p>网络错误</p>
<p>3005</p>
<p>发布请求过于频繁（3s内重复调用）</p>
<p>3006</p>
<p>视频size超过最大大小</p>
<p>3007</p>
<p>图片size超过最大大小</p>
<p>3008</p>
<p>拒绝当次分享动作；如果是发布视频:请检查视频长度</p>
<p>3009</p>
<p>鉴权失败</p>
<h3 data-id="heading-13">完整 Index.ets 代码</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 导入快手开放平台SDK</span>
<span class="hljs-keyword">import</span> { kwaiOpenSdk } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kwai_open_platform/opensdk/src/main/ets/KwaiOpensdk'</span>;
<span class="hljs-comment">// 导入AbilityKit相关组件</span>
<span class="hljs-keyword">import</span> { common } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;
<span class="hljs-comment">// 导入授权请求模型</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">AuthRequest</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kwai_open_platform/opensdk/src/main/ets/model/request/AuthRequest'</span>;
<span class="hljs-comment">// 导入授权响应模型</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">AuthResponse</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kwai_open_platform/opensdk/src/main/ets/model/response/AuthResponse'</span>;
<span class="hljs-comment">// 导入日志工具</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Logger</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kwai_open_platform/opensdk/src/main/ets/utils/Logger'</span>;
<span class="hljs-comment">// 导入分享请求模型创建函数</span>
<span class="hljs-keyword">import</span> {
  createSingleImagePublish,
  createSingleVideoPublish
} <span class="hljs-keyword">from</span> <span class="hljs-string">'@kwai_open_platform/opensdk/src/main/ets/model/request/ShareRequest'</span>;
<span class="hljs-comment">// 导入ArkTS集合框架</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ArrayList</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkTS'</span>;
<span class="hljs-comment">// 导入媒体库访问助手</span>
<span class="hljs-keyword">import</span> { photoAccessHelper } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.MediaLibraryKit'</span>;
<span class="hljs-comment">// 导入文件操作相关工具</span>
<span class="hljs-keyword">import</span> { fileIo, fileUri } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.CoreFileKit'</span>;

<span class="hljs-comment">// 定义快手应用ID</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">APPID</span> = <span class="hljs-string">"ks669910448092164647"</span>

<span class="hljs-comment">// 定义鸿蒙应用ID</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">harmonyAppID</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">"6917560710208292268"</span>;

<span class="hljs-meta">@Entry</span>
<span class="hljs-meta">@Component</span>
struct <span class="hljs-title class_">Index</span> {
  <span class="hljs-comment">// 获取UIAbility上下文</span>
  context = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getHostContext</span>() <span class="hljs-keyword">as</span> common.<span class="hljs-property">UIAbilityContext</span>;
  <span class="hljs-comment">// 回调结果状态</span>
  <span class="hljs-meta">@State</span> <span class="hljs-attr">callbackResult</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span>;
  <span class="hljs-comment">// 授权码</span>
  <span class="hljs-meta">@State</span> <span class="hljs-attr">authCode</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">""</span>;
  <span class="hljs-comment">// 错误信息</span>
  <span class="hljs-meta">@State</span> <span class="hljs-attr">errMsg</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">""</span>;
  <span class="hljs-comment">// 错误码</span>
  <span class="hljs-meta">@State</span> <span class="hljs-attr">errCode</span>: <span class="hljs-built_in">number</span> = -<span class="hljs-number">1</span>;

  <span class="hljs-title function_">aboutToAppear</span>(): <span class="hljs-built_in">void</span> {
    <span class="hljs-comment">// 初始化快手SDK</span>
    kwaiOpenSdk.<span class="hljs-title function_">init</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>);
  }

  <span class="hljs-comment">// 授权功能实现</span>
  fn1 = <span class="hljs-function">() =&gt;</span> {
    {
      <span class="hljs-comment">// 创建授权请求对象</span>
      <span class="hljs-keyword">let</span> request = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AuthRequest</span>(<span class="hljs-variable constant_">APPID</span>);
      <span class="hljs-comment">// 设置必需的权限范围</span>
      request.<span class="hljs-property">requiredScopes</span> = <span class="hljs-string">"user_phone,user_info"</span>;
      <span class="hljs-comment">// 设置可选权限范围0</span>
      request.<span class="hljs-property">optional0Scopes</span> = <span class="hljs-string">"user_base,share_media,following,share_message"</span>
      <span class="hljs-comment">// 设置可选权限范围1</span>
      request.<span class="hljs-property">optional1Scopes</span> = <span class="hljs-string">"user_growth_distribution,message,live,relation"</span>
      <span class="hljs-comment">// 设置回调入口</span>
      request.<span class="hljs-property">callbackLocalEntry</span> = <span class="hljs-string">"EntryAbility"</span>;
      <span class="hljs-comment">// 设置Ability上下文</span>
      request.<span class="hljs-property">abilityContext</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>;
      <span class="hljs-comment">// 重要提示，这行代码不要复制</span>
      request.<span class="hljs-property">harmonyAppId</span> = harmonyAppID
      <span class="hljs-comment">// 调用SDK授权接口</span>
      kwaiOpenSdk.<span class="hljs-title function_">createApi</span>().<span class="hljs-title function_">authorize</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>, request, {
        <span class="hljs-comment">// 授权成功回调</span>
        <span class="hljs-attr">onSuccess</span>: <span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {
          <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">i</span>(<span class="hljs-string">"authCallback"</span>, <span class="hljs-string">"success......."</span>);
          <span class="hljs-comment">// 保存授权码</span>
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">authCode</span> = (res <span class="hljs-keyword">as</span> <span class="hljs-title class_">AuthResponse</span>).<span class="hljs-property">code</span>;
          <span class="hljs-comment">// 设置回调结果为成功</span>
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">callbackResult</span> = <span class="hljs-literal">true</span>;
        },
        <span class="hljs-comment">// 授权失败回调</span>
        <span class="hljs-attr">onError</span>: <span class="hljs-function">(<span class="hljs-params">errorCode, msg</span>) =&gt;</span> {
          <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">i</span>(<span class="hljs-string">"authCallback"</span>, <span class="hljs-string">`failed, code: <span class="hljs-subst">${errorCode}</span>, msg: <span class="hljs-subst">${msg}</span>`</span>);
          <span class="hljs-comment">// 保存错误信息</span>
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">errMsg</span> = msg
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">errCode</span> = errorCode
          <span class="hljs-comment">// 设置回调结果为失败</span>
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">callbackResult</span> = <span class="hljs-literal">false</span>;
        }
      })
    }
  }
  <span class="hljs-comment">// 发布单图功能实现</span>
  fn2 = <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// 调用媒体选择方法，指定图片类型</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">selectMedia</span>&lt;<span class="hljs-built_in">string</span>&gt;(<span class="hljs-function">(<span class="hljs-params">url: <span class="hljs-built_in">string</span></span>) =&gt;</span> {
      <span class="hljs-comment">// 创建单图分享请求对象</span>
      <span class="hljs-keyword">let</span> shareRequest = <span class="hljs-title function_">createSingleImagePublish</span>(<span class="hljs-variable constant_">APPID</span>);
      <span class="hljs-comment">// 创建媒体URI列表</span>
      <span class="hljs-keyword">let</span> <span class="hljs-attr">list</span>: <span class="hljs-title class_">ArrayList</span>&lt;<span class="hljs-built_in">string</span>&gt; = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>();
      <span class="hljs-comment">// 添加选中的图片URI</span>
      list.<span class="hljs-title function_">add</span>(url);
      <span class="hljs-comment">// 设置媒体URI列表</span>
      shareRequest.<span class="hljs-property">mediaUri</span> = list;
      <span class="hljs-comment">// 设置回调入口</span>
      shareRequest.<span class="hljs-property">callbackLocalEntry</span> = <span class="hljs-string">"EntryAbility"</span>;
      <span class="hljs-comment">// 重要提示，这行代码不要复制</span>
      shareRequest.<span class="hljs-property">harmonyAppId</span> = harmonyAppID

      <span class="hljs-comment">// 调用SDK分享接口</span>
      kwaiOpenSdk.<span class="hljs-title function_">createApi</span>().<span class="hljs-title function_">share</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>, shareRequest, {
        <span class="hljs-comment">// 分享成功回调</span>
        <span class="hljs-attr">onSuccess</span>: <span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {
          <span class="hljs-comment">// 设置回调结果为成功</span>
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">callbackResult</span> = <span class="hljs-literal">true</span>;
          <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">i</span>(<span class="hljs-string">"shareCallback"</span>, <span class="hljs-string">"success......."</span>);
        },
        <span class="hljs-comment">// 分享失败回调</span>
        <span class="hljs-attr">onError</span>: <span class="hljs-function">(<span class="hljs-params">errorCode, msg</span>) =&gt;</span> {
          <span class="hljs-comment">// 设置回调结果为失败</span>
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">callbackResult</span> = <span class="hljs-literal">false</span>;
          <span class="hljs-comment">// 保存错误信息</span>
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">errMsg</span> = msg
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">errCode</span> = errorCode
          <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">i</span>(<span class="hljs-string">"shareCallback"</span>, <span class="hljs-string">`failed, code: <span class="hljs-subst">${errorCode}</span>, msg: <span class="hljs-subst">${msg}</span>`</span>);
        }
      })
    }, photoAccessHelper.<span class="hljs-property">PhotoViewMIMETypes</span>.<span class="hljs-property">IMAGE_TYPE</span>);
  }
  <span class="hljs-comment">// 发布单视频功能实现</span>
  fn3 = <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// 调用媒体选择方法，指定视频类型</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">selectMedia</span>&lt;<span class="hljs-built_in">string</span>&gt;(<span class="hljs-function">(<span class="hljs-params">url: <span class="hljs-built_in">string</span></span>) =&gt;</span> {
      <span class="hljs-comment">// 创建单视频分享请求对象</span>
      <span class="hljs-keyword">let</span> shareRequest = <span class="hljs-title function_">createSingleVideoPublish</span>(<span class="hljs-variable constant_">APPID</span>);
      <span class="hljs-comment">// 创建媒体URI列表</span>
      <span class="hljs-keyword">let</span> <span class="hljs-attr">list</span>: <span class="hljs-title class_">ArrayList</span>&lt;<span class="hljs-built_in">string</span>&gt; = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>();
      <span class="hljs-comment">// 添加选中的视频URI</span>
      list.<span class="hljs-title function_">add</span>(url);
      <span class="hljs-comment">// 设置媒体URI列表</span>
      shareRequest.<span class="hljs-property">mediaUri</span> = list;
      <span class="hljs-comment">// 设置回调入口</span>
      shareRequest.<span class="hljs-property">callbackLocalEntry</span> = <span class="hljs-string">"EntryAbility"</span>;
      <span class="hljs-comment">// 重要提示，这行代码不要复制</span>
      shareRequest.<span class="hljs-property">harmonyAppId</span> = harmonyAppID
      <span class="hljs-comment">// 调用SDK分享接口</span>
      kwaiOpenSdk.<span class="hljs-title function_">createApi</span>().<span class="hljs-title function_">share</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>, shareRequest, {
        <span class="hljs-comment">// 分享成功回调</span>
        <span class="hljs-attr">onSuccess</span>: <span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {
          <span class="hljs-comment">// 设置回调结果为成功</span>
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">callbackResult</span> = <span class="hljs-literal">true</span>;
          <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">i</span>(<span class="hljs-string">"shareCallback"</span>, <span class="hljs-string">"success......."</span>);
        },
        <span class="hljs-comment">// 分享失败回调</span>
        <span class="hljs-attr">onError</span>: <span class="hljs-function">(<span class="hljs-params">errorCode, msg</span>) =&gt;</span> {
          <span class="hljs-comment">// 设置回调结果为失败</span>
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">callbackResult</span> = <span class="hljs-literal">false</span>;
          <span class="hljs-comment">// 保存错误信息</span>
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">errMsg</span> = msg
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">errCode</span> = errorCode
          <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">i</span>(<span class="hljs-string">"shareCallback"</span>, <span class="hljs-string">`failed, code: <span class="hljs-subst">${errorCode}</span>, msg: <span class="hljs-subst">${msg}</span>`</span>);
        }
      })
    }, photoAccessHelper.<span class="hljs-property">PhotoViewMIMETypes</span>.<span class="hljs-property">VIDEO_TYPE</span>);
  }

  <span class="hljs-title function_">build</span>(<span class="hljs-params"/>) {
    <span class="hljs-title class_">Column</span>({ <span class="hljs-attr">space</span>: <span class="hljs-number">10</span> }) {
      <span class="hljs-title class_">Button</span>(<span class="hljs-string">"授权"</span>)
        .<span class="hljs-title function_">onClick</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">fn1</span>)
      <span class="hljs-title class_">Button</span>(<span class="hljs-string">"发布单图"</span>)
        .<span class="hljs-title function_">onClick</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">fn2</span>)
      <span class="hljs-title class_">Button</span>(<span class="hljs-string">"发布单视频"</span>)
        .<span class="hljs-title function_">onClick</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">fn3</span>)
    }
    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)
    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)
  }

  <span class="hljs-comment">// 媒体选择通用方法</span>
  <span class="hljs-keyword">private</span> selectMedia&lt;T&gt;(
    <span class="hljs-attr">callback</span>: <span class="hljs-function">(<span class="hljs-params">t: T</span>) =&gt;</span> <span class="hljs-built_in">void</span>,
    <span class="hljs-attr">type</span>: photoAccessHelper.<span class="hljs-property">PhotoViewMIMETypes</span>.<span class="hljs-property">IMAGE_TYPE</span> | photoAccessHelper.<span class="hljs-property">PhotoViewMIMETypes</span>.<span class="hljs-property">VIDEO_TYPE</span>,
    <span class="hljs-attr">num</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">1</span>
  ) {
    <span class="hljs-comment">// 创建照片选择选项</span>
    <span class="hljs-keyword">let</span> photoOptions = <span class="hljs-keyword">new</span> photoAccessHelper.<span class="hljs-title class_">PhotoSelectOptions</span>();
    <span class="hljs-comment">// 设置MIME类型（图片或视频）</span>
    photoOptions.<span class="hljs-property">MIMEType</span> = <span class="hljs-keyword">type</span>;
    <span class="hljs-comment">// 设置最大选择数量</span>
    photoOptions.<span class="hljs-property">maxSelectNumber</span> = num;

    <span class="hljs-comment">// 创建照片选择器</span>
    <span class="hljs-keyword">let</span> picker = <span class="hljs-keyword">new</span> photoAccessHelper.<span class="hljs-title class_">PhotoViewPicker</span>();
    <span class="hljs-comment">// 调用选择方法</span>
    picker.<span class="hljs-title function_">select</span>(photoOptions).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">photoSelectResult: photoAccessHelper.PhotoSelectResult</span>) =&gt;</span> {
      <span class="hljs-comment">// 获取选中的URI列表</span>
      <span class="hljs-keyword">let</span> <span class="hljs-attr">uris</span>: <span class="hljs-title class_">Array</span>&lt;<span class="hljs-built_in">string</span>&gt; = photoSelectResult.<span class="hljs-property">photoUris</span>;
      <span class="hljs-keyword">if</span> (uris.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-comment">// 获取第一个URI</span>
        <span class="hljs-keyword">let</span> str = uris[<span class="hljs-number">0</span>];
        <span class="hljs-comment">// 提取文件名</span>
        <span class="hljs-keyword">let</span> fileName = str.<span class="hljs-title function_">substring</span>(str.<span class="hljs-title function_">lastIndexOf</span>(<span class="hljs-string">'/'</span>));
        <span class="hljs-comment">// 构建目标文件路径</span>
        <span class="hljs-keyword">let</span> desFilePath = <span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>.<span class="hljs-title function_">getApplicationContext</span>().<span class="hljs-property">tempDir</span> + fileName;
        <span class="hljs-comment">// 打开源文件（只读）</span>
        <span class="hljs-keyword">let</span> srcFile = fileIo.<span class="hljs-title function_">openSync</span>(str, fileIo.<span class="hljs-property">OpenMode</span>.<span class="hljs-property">READ_ONLY</span>);
        <span class="hljs-comment">// 打开目标文件（写，如不存在则创建）</span>
        <span class="hljs-keyword">let</span> desFile = fileIo.<span class="hljs-title function_">openSync</span>(desFilePath, fileIo.<span class="hljs-property">OpenMode</span>.<span class="hljs-property">WRITE_ONLY</span> | fileIo.<span class="hljs-property">OpenMode</span>.<span class="hljs-property">CREATE</span>);
        <span class="hljs-comment">// 复制文件内容</span>
        fileIo.<span class="hljs-title function_">copyFileSync</span>(srcFile.<span class="hljs-property">fd</span>, desFile.<span class="hljs-property">fd</span>)
        <span class="hljs-comment">// 回调处理，传递文件URI</span>
        callback?.(fileUri.<span class="hljs-title function_">getUriFromPath</span>(desFilePath) <span class="hljs-keyword">as</span> T);
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// 未选择资源时显示提示</span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getPromptAction</span>().<span class="hljs-title function_">showToast</span>({
          <span class="hljs-attr">message</span>: <span class="hljs-string">'没有选择资源'</span>
        })
      }
    }).<span class="hljs-keyword">catch</span>(<span class="hljs-function">(<span class="hljs-params">error: BusinessError</span>) =&gt;</span> {
      <span class="hljs-comment">// 选择出错时显示提示</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getPromptAction</span>().<span class="hljs-title function_">showToast</span>({
        <span class="hljs-attr">message</span>: <span class="hljs-string">'选择资源error'</span>
      })
    })
  }
}
</code></pre>
<h3 data-id="heading-14">参考文档</h3>
<ol>
<li><strong>@kwai_open_platform/opensdk(V1.0.1)</strong></li>
</ol>
<blockquote>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fopen.kuaishou.com%2FplatformDocs%2Fdevelop%2Fmobile-app%2FHarmony-OS.html%23%25E4%25B8%2580%25E3%2580%2581%25E8%25AE%25BE%25E8%25AE%25A1%25E7%259B%25AE%25E6%25A0%2587" target="_blank" title="https://open.kuaishou.com/platformDocs/develop/mobile-app/Harmony-OS.html#%E4%B8%80%E3%80%81%E8%AE%BE%E8%AE%A1%E7%9B%AE%E6%A0%87" ref="nofollow noopener noreferrer">open.kuaishou.com/platformDoc…</a></p>
</blockquote>
<ol start="2">
<li><strong>快手接入鸿蒙应用指南</strong></li>
</ol>
<blockquote>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fohpm.openharmony.cn%2F%23%2Fcn%2Fdetail%2F%40kwai_open_platform%252Fopensdk" target="_blank" title="https://ohpm.openharmony.cn/#/cn/detail/@kwai_open_platform%2Fopensdk" ref="nofollow noopener noreferrer">ohpm.openharmony.cn/#/cn/detail…</a></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Rust常用集合]]></title>    <link>https://juejin.cn/post/7586482860104073243</link>    <guid>https://juejin.cn/post/7586482860104073243</guid>    <pubDate>2025-12-22T13:44:26.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586482860104073243" data-draft-id="7586504691845578761" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Rust常用集合"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-22T13:44:26.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="GKunLi"/> <meta itemprop="url" content="https://juejin.cn/user/430664725579725"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Rust常用集合
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/430664725579725/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    GKunLi
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T13:44:26.000Z" title="Mon Dec 22 2025 13:44:26 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Rust 的标准库（std::collections）提供了多种通用的集合数据结构。与基础的数组和元组不同，这些集合存储在 <strong>堆（Heap）</strong> 上，这意味着它们的大小可以在运行时动态增长或缩小。</p>
<h2 data-id="heading-0">1. 动态数组：<code>Vec&lt;T&gt;</code> (Vector)</h2>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() {
    <span class="hljs-comment">// 创建</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">v</span> = <span class="hljs-built_in">vec!</span>[<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>];

    <span class="hljs-comment">// 增加元素</span>
    v.<span class="hljs-title function_ invoke__">push</span>(<span class="hljs-number">4</span>);
    v.<span class="hljs-title function_ invoke__">push</span>(<span class="hljs-number">5</span>);

    <span class="hljs-comment">// 读取元素 (索引方式)</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">third</span> = &amp;v[<span class="hljs-number">2</span>]; 
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"第三个元素是: {}"</span>, third);

    <span class="hljs-comment">// 安全读取 (get 方法，返回 Option)</span>
    <span class="hljs-keyword">match</span> v.<span class="hljs-title function_ invoke__">get</span>(<span class="hljs-number">10</span>) {
        <span class="hljs-title function_ invoke__">Some</span>(val) =&gt; <span class="hljs-built_in">println!</span>(<span class="hljs-string">"找到了: {}"</span>, val),
        <span class="hljs-literal">None</span> =&gt; <span class="hljs-built_in">println!</span>(<span class="hljs-string">"索引越界，没有第11个元素"</span>),
    }

    <span class="hljs-comment">// 遍历</span>
    <span class="hljs-keyword">for</span> <span class="hljs-variable">i</span> <span class="hljs-keyword">in</span> &amp;v {
        <span class="hljs-built_in">println!</span>(<span class="hljs-string">"{}"</span>, i);
    }
}
</code></pre>
<h2 data-id="heading-1">2. 字符串：String</h2>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() {
    <span class="hljs-comment">// 创建</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">s</span> = <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">from</span>(<span class="hljs-string">"Hello"</span>);

    <span class="hljs-comment">// 更新</span>
    s.<span class="hljs-title function_ invoke__">push_str</span>(<span class="hljs-string">", Rust!"</span>); <span class="hljs-comment">// 追加字符串切片</span>
    s.<span class="hljs-title function_ invoke__">push</span>('🚀');          <span class="hljs-comment">// 追加单个字符</span>

    <span class="hljs-comment">// 合并字符串</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">s1</span> = <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">from</span>(<span class="hljs-string">"tic"</span>);
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">s2</span> = <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">from</span>(<span class="hljs-string">"tac"</span>);
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">s3</span> = <span class="hljs-built_in">format!</span>(<span class="hljs-string">"{}-{}-{}"</span>, s1, s2, <span class="hljs-string">"toe"</span>); <span class="hljs-comment">// 使用 format! 宏不获取所有权</span>
    
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"{}"</span>, s3); <span class="hljs-comment">// tic-tac-toe</span>
}
</code></pre>
<h2 data-id="heading-2">3. 哈希映射：HashMap&lt;K, V&gt;</h2>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">use</span> std::collections::HashMap;

<span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">scores</span> = HashMap::<span class="hljs-title function_ invoke__">new</span>();

    <span class="hljs-comment">// 插入数据</span>
    scores.<span class="hljs-title function_ invoke__">insert</span>(<span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">from</span>(<span class="hljs-string">"Blue"</span>), <span class="hljs-number">10</span>);
    scores.<span class="hljs-title function_ invoke__">insert</span>(<span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">from</span>(<span class="hljs-string">"Yellow"</span>), <span class="hljs-number">50</span>);

    <span class="hljs-comment">// 查询数据</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">team_name</span> = <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">from</span>(<span class="hljs-string">"Blue"</span>);
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">score</span> = scores.<span class="hljs-title function_ invoke__">get</span>(&amp;team_name); <span class="hljs-comment">// 返回 Option&lt;&amp;i32&gt;</span>

    <span class="hljs-comment">// 遍历</span>
    <span class="hljs-title function_ invoke__">for</span> (key, value) <span class="hljs-keyword">in</span> &amp;scores {
        <span class="hljs-built_in">println!</span>(<span class="hljs-string">"{}: {}"</span>, key, value);
    }

    <span class="hljs-comment">// 只有当键不存在时才插入 (Entry API)</span>
    scores.<span class="hljs-title function_ invoke__">entry</span>(<span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">from</span>(<span class="hljs-string">"Red"</span>)).<span class="hljs-title function_ invoke__">or_insert</span>(<span class="hljs-number">30</span>);
}
</code></pre>













































<table><thead><tr><th align="left">集合</th><th align="left">核心逻辑</th><th align="left">典型应用场景</th></tr></thead><tbody><tr><td align="left"><strong><code>Vec&lt;T&gt;</code></strong></td><td align="left">连续内存的动态数组</td><td align="left">存储线性数据、任务清单、缓冲区。这是最通用的集合。</td></tr><tr><td align="left"><strong><code>String</code></strong></td><td align="left">UTF-8 编码的文本</td><td align="left">存储和处理动态文本、用户输入、格式化字符串。</td></tr><tr><td align="left"><strong><code>HashMap&lt;K, V&gt;</code></strong></td><td align="left">哈希键值对映射</td><td align="left">数据库索引模拟、缓存系统、统计（如单词计数）。</td></tr><tr><td align="left"><strong><code>VecDeque&lt;T&gt;</code></strong></td><td align="left">双端队列（环形缓冲区）</td><td align="left">实现先进先出（FIFO）队列、广度优先搜索（BFS）。</td></tr><tr><td align="left"><strong><code>HashSet&lt;T&gt;</code></strong></td><td align="left">唯一值的哈希集合</td><td align="left">数据去重、成员身份快速验证（判断某项是否存在）。</td></tr><tr><td align="left"><strong><code>BTreeMap&lt;K, V&gt;</code></strong></td><td align="left">基于 B 树的有序映射</td><td align="left">需要按键（Key）排序存储数据，或进行范围查询时。</td></tr><tr><td align="left"><strong><code>BinaryHeap&lt;T&gt;</code></strong></td><td align="left">二叉堆（优先队列）</td><td align="left">始终获取最大/最小值的场景，如任务调度、Dijkstra 算法。</td></tr></tbody></table></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[axios 的 withCredentials 到底做了什么？]]></title>    <link>https://juejin.cn/post/7586479864271716358</link>    <guid>https://juejin.cn/post/7586479864271716358</guid>    <pubDate>2025-12-22T10:17:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586479864271716358" data-draft-id="7586491717872910355" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="axios 的 withCredentials 到底做了什么？"/> <meta itemprop="keywords" content="前端,JavaScript,HTTP"/> <meta itemprop="datePublished" content="2025-12-22T10:17:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="RichardMiao"/> <meta itemprop="url" content="https://juejin.cn/user/2330620379279950"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            axios 的 withCredentials 到底做了什么？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2330620379279950/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    RichardMiao
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T10:17:02.000Z" title="Mon Dec 22 2025 10:17:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">一、核心结论</h3>
<p><code>withCredentials</code> 是 axios 中控制<strong>跨域请求是否携带凭证（Cookie、HTTP 认证信息、TLS 客户端证书等）</strong> 的布尔值配置项，本质是对浏览器 <code>XMLHttpRequest.withCredentials</code> 原生属性的封装，默认值为 <code>false</code>。</p>
<p>简单说：</p>
<ul>
<li><code>withCredentials: false</code>（默认）：跨域请求时，浏览器<strong>不会</strong>携带目标域名下的 Cookie/认证信息；</li>
<li><code>withCredentials: true</code>：跨域请求时，浏览器<strong>会</strong>主动携带目标域名下的 Cookie/认证信息，且服务端响应的 Set-Cookie 也会生效。</li>
</ul>
<blockquote>
<p>注意：该配置<strong>仅对跨域请求有效</strong>，同域请求不受影响（默认携带凭证）。</p>
</blockquote>
<h3 data-id="heading-1">二、底层原理：浏览器的同源策略 &amp; CORS 规范</h3>
<p>要理解 <code>withCredentials</code>，必须先明确浏览器的核心规则：</p>
<h4 data-id="heading-2">1. 同源策略的限制</h4>
<p>浏览器默认禁止跨域请求携带凭证（比如 A 域名请求 B 域名接口时，不会带 B 域名的 Cookie），这是为了防止第三方网站盗用用户的认证信息。</p>
<h4 data-id="heading-3">2. CORS 规范对凭证的要求</h4>
<p>当前端设置 <code>withCredentials: true</code> 时，必须满足<strong>服务端+客户端</strong>双向配置，否则请求会被浏览器拦截：</p>

















<table><thead><tr><th>端</th><th>必要配置</th></tr></thead><tbody><tr><td>前端（axios）</td><td><code>withCredentials: true</code></td></tr><tr><td>服务端</td><td>响应头必须包含：<br/>1. <code>Access-Control-Allow-Credentials: true</code><br/>2. <code>Access-Control-Allow-Origin</code> 不能为 <code>*</code>（必须是具体域名，如 <code>https://xxx.com</code>）</td></tr></tbody></table>
<h3 data-id="heading-4">三、<code>withCredentials</code> 具体行为拆解</h3>
<h4 data-id="heading-5">1. 当 <code>withCredentials: false</code>（默认）</h4>
<ul>
<li>请求阶段：浏览器发送跨域请求时，<strong>不会携带</strong>目标域名的 Cookie、Authorization 头等凭证；</li>
<li>响应阶段：即使服务端返回 <code>Set-Cookie</code> 响应头，浏览器也<strong>不会保存</strong>该 Cookie（相当于忽略）；</li>
<li>场景：无需用户认证的跨域请求（如公开接口、静态资源）。</li>
</ul>
<h4 data-id="heading-6">2. 当 <code>withCredentials: true</code></h4>
<ul>
<li>请求阶段：浏览器主动携带目标域名下的 Cookie（仅该域名的 Cookie，非当前域名）、HTTP 认证信息（如 Basic Auth）；</li>
<li>响应阶段：
✅ 若服务端返回 <code>Access-Control-Allow-Credentials: true</code> + 具体的 <code>Access-Control-Allow-Origin</code>：浏览器会保存服务端的 <code>Set-Cookie</code>，且后续请求会自动携带；
❌ 若服务端未满足上述条件：浏览器会触发 CORS 错误，拦截响应（控制台报错：<code>Access to XMLHttpRequest at 'xxx' from origin 'xxx' has been blocked by CORS policy: The value of the 'Access-Control-Allow-Credentials' header in the response is '' which must be 'true' when the request's credentials mode is 'include'</code>）；</li>
<li>场景：需要用户登录态的跨域请求（如登录后获取用户信息、提交订单）。</li>
</ul>
<h3 data-id="heading-7">四、典型使用场景 &amp; 示例</h3>
<h4 data-id="heading-8">场景：前端（<code>http://localhost:3000</code>）请求后端（<code>http://api.example.com</code>）的登录接口</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// axios 配置（前端）</span>
<span class="hljs-title function_">axios</span>({
  <span class="hljs-attr">url</span>: <span class="hljs-string">'http://api.example.com/user/info'</span>,
  <span class="hljs-attr">method</span>: <span class="hljs-string">'GET'</span>,
  <span class="hljs-attr">withCredentials</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 跨域携带 Cookie（后端域名下的登录 Cookie）</span>
})
.<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(res))
.<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(err));
</code></pre>
<h4 data-id="heading-9">服务端配置（以 Node.js/Express 为例）</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express'</span>);
<span class="hljs-keyword">const</span> app = <span class="hljs-title function_">express</span>();

<span class="hljs-comment">// 跨域中间件配置</span>
app.<span class="hljs-title function_">use</span>(<span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {
  <span class="hljs-comment">// 允许指定前端域名跨域（不能用 *）</span>
  res.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">'Access-Control-Allow-Origin'</span>, <span class="hljs-string">'http://localhost:3000'</span>);
  <span class="hljs-comment">// 允许携带凭证</span>
  res.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">'Access-Control-Allow-Credentials'</span>, <span class="hljs-string">'true'</span>);
  <span class="hljs-comment">// 允许的请求头</span>
  res.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">'Access-Control-Allow-Headers'</span>, <span class="hljs-string">'Content-Type'</span>);
  <span class="hljs-title function_">next</span>();
});

<span class="hljs-comment">// 接口返回用户信息（依赖 Cookie 中的登录态）</span>
app.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/user/info'</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {
  res.<span class="hljs-title function_">json</span>({ <span class="hljs-attr">name</span>: <span class="hljs-string">'张三'</span>, <span class="hljs-attr">id</span>: <span class="hljs-number">123</span> });
});

app.<span class="hljs-title function_">listen</span>(<span class="hljs-number">8080</span>);
</code></pre>
<h3 data-id="heading-10">五、常见坑点</h3>
<ol>
<li>
<p><strong><code>Access-Control-Allow-Origin</code> 不能为 <code>*</code></strong>：
若服务端设置 <code>*</code>，同时前端开了 <code>withCredentials: true</code>，浏览器会直接拦截请求（因为 <code>*</code> 无法和具体域名的凭证绑定）。</p>
</li>
<li>
<p><strong>跨域 Cookie 的 SameSite 限制</strong>：
若服务端设置的 Cookie 的 <code>SameSite</code> 为 <code>Strict</code>/<code>Lax</code>，跨域请求时即使开了 <code>withCredentials</code>，Cookie 也可能无法携带（需设置 <code>SameSite=None; Secure</code>，且请求必须是 HTTPS）。</p>
</li>
<li>
<p><strong>凭证仅对目标域名生效</strong>：
比如前端 <code>a.com</code> 请求 <code>b.com</code>，<code>withCredentials: true</code> 只会携带 <code>b.com</code> 的 Cookie，而非 <code>a.com</code> 的 Cookie。</p>
</li>
<li>
<p><strong>预检请求（OPTIONS）也需配置</strong>：
复杂请求（如 POST 带 JSON、自定义头）会先发送 OPTIONS 预检请求，服务端必须对 OPTIONS 请求返回相同的 CORS 配置（尤其是 <code>Access-Control-Allow-Credentials</code>）。</p>
</li>
</ol>
<h3 data-id="heading-11">六、总结</h3>
<p><code>withCredentials</code> 的核心作用是<strong>突破浏览器同源策略对跨域凭证的限制</strong>，让跨域请求能携带 Cookie/认证信息，但必须配合服务端的 CORS 配置才能生效。它是实现跨域登录态保持的关键配置，也是处理跨域认证请求的必备项。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React父子组件回调传参避坑指南：从基础到进阶实践]]></title>    <link>https://juejin.cn/post/7586506307726442506</link>    <guid>https://juejin.cn/post/7586506307726442506</guid>    <pubDate>2025-12-22T10:51:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586506307726442506" data-draft-id="7586505172814921779" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React父子组件回调传参避坑指南：从基础到进阶实践"/> <meta itemprop="keywords" content="前端,React.js"/> <meta itemprop="datePublished" content="2025-12-22T10:51:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="前端无涯"/> <meta itemprop="url" content="https://juejin.cn/user/3967483738859639"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React父子组件回调传参避坑指南：从基础到进阶实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3967483738859639/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    前端无涯
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T10:51:29.000Z" title="Mon Dec 22 2025 10:51:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>​</p>
<blockquote>
<p>在React开发中，父子组件间的通信是高频需求，其中通过回调函数传递参数更是核心场景。但很多开发者在实际编码中会遇到诸如“参数传不到”“函数提前执行”“组件无限渲染”等问题。本文结合实际开发案例，拆解回调传参的核心逻辑，剖析常见错误，给出不同场景下的最优实践，帮你彻底搞懂React回调传参。</p>
</blockquote>
<h2 data-id="heading-0">一、场景引入：从实际代码看问题</h2>
<p>先看一段大家可能写过的代码，这是父组件中向子组件传递刷新回调的场景：</p>
<pre><code class="hljs language-ini" lang="ini">// 父组件核心代码
const <span class="hljs-attr">fetchData</span> = async (showLoading = <span class="hljs-literal">true</span>) =&gt; {
  if (!appName) return<span class="hljs-comment">;</span>
  try {
    const <span class="hljs-attr">res</span> = await getProductDetail({ appName, loading: showLoading })<span class="hljs-comment">;</span>
    setData(res)<span class="hljs-comment">;</span>
  } catch (error) {
    console.error(error)<span class="hljs-comment">;</span>
  } finally {
    setLoading(false)<span class="hljs-comment">;</span>
  }
}<span class="hljs-comment">;</span>

// 向子组件传递回调
if (<span class="hljs-attr">keyway</span> === <span class="hljs-number">200</span> || keyway === <span class="hljs-number">300</span>) {
  return &lt;AuditPending 
    <span class="hljs-attr">data</span>={data} 
    <span class="hljs-attr">onRefresh</span>={(showLoading) =&gt; { fetchData(showLoading) }} 
  /&gt;<span class="hljs-comment">;</span>
}
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>在这个场景中，你可能会有这些疑问：</p>
<ul>
<li>onRefresh里的箭头函数为什么要包裹一层，直接写onRefresh={fetchData}不行吗？</li>
<li>为什么绝对不能写成onRefresh={fetchData()}？</li>
<li>直接传函数引用和用箭头函数包裹，哪种写法更好？</li>
</ul>
<p>要解答这些问题，我们首先要理清一个核心概念：<strong>函数引用 vs 函数执行结果</strong>。</p>
<h2 data-id="heading-1">二、核心概念：搞懂这两个区别，少踩80%的坑</h2>
<p>在React回调传参中，“是否加括号”“是否用箭头函数”的本质，都是在区分“传递函数引用”和“传递函数执行结果”。</p>
<h3 data-id="heading-2">1. 函数引用：传递“函数本身”</h3>
<p>当我们写 <code>onRefresh={fetchData}</code> 时，传递给子组件的是 <code>fetchData</code> 这个函数的“引用”（可以理解为函数的“地址”）。</p>
<p>核心特点：</p>
<ul>
<li>执行时机：<strong>不会立即执行</strong>，只有子组件主动调用这个引用时（比如触发刷新事件），函数才会执行。</li>
<li>参数传递：子组件调用时可以传入参数，这些参数会直接被目标函数接收（前提是目标函数定义了对应形参）。</li>
</ul>
<h3 data-id="heading-3">2. 函数执行结果：传递“函数运行后的返回值”</h3>
<p>当我们写 <code>onRefresh={fetchData()}</code> 时，会先立即执行 <code>fetchData</code>函数，然后把函数的返回值传递给子组件。</p>
<p>核心特点：</p>
<ul>
<li>执行时机：<strong>组件渲染/重渲染时立即执行</strong>，而非子组件触发事件时。</li>
<li>传递内容：取决于函数的返回值。比如本例中 <code>fetchData</code> 是async函数，返回值是Promise对象，子组件拿到的就是Promise，而非可执行的函数。</li>
</ul>
<h2 data-id="heading-4">三、常见回调传参写法对比：优缺点与适用场景</h2>
<p>结合前面的场景，我们梳理三种最常见的回调传参写法，帮你快速选择。</p>
<h3 data-id="heading-5">写法1：直接传递函数引用（<code>onRefresh={fetchData}</code>）</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 父组件</span>
<span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">AuditPending</span> <span class="hljs-attr">data</span>=<span class="hljs-string">{data}</span> <span class="hljs-attr">onRefresh</span>=<span class="hljs-string">{fetchData}</span> /&gt;</span></span>;
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h4 data-id="heading-6">优点：</h4>
<ul>
<li>性能最优：函数引用稳定，若子组件用了 <code>React.memo</code> 做性能优化，不会导致子组件不必要的重渲染。</li>
<li>代码简洁：无多余包裹，逻辑清晰。</li>
</ul>
<h4 data-id="heading-7">缺点：</h4>
<ul>
<li>灵活性差：无法对参数做加工，也无法额外传递父组件的状态/属性（比如父组件的id、name等）。</li>
<li>类组件需注意this绑定：若在类组件中直接传递类方法（如 <code>this.fetchData</code>），会丢失this上下文（函数组件无此问题）。</li>
</ul>
<h4 data-id="heading-8">适用场景：</h4>
<p>函数组件场景、子组件参数可直接透传给目标函数、无需额外加工参数。</p>
<h3 data-id="heading-9">写法2：箭头函数包裹透传参数（<code>onRefresh={(showLoading) =&gt; fetchData(showLoading)}</code>）</h3>
<pre><code class="hljs language-ini" lang="ini">// 父组件
return &lt;AuditPending 
  <span class="hljs-attr">data</span>={data} 
  <span class="hljs-attr">onRefresh</span>={(showLoading) =&gt; fetchData(showLoading)} 
/&gt;<span class="hljs-comment">;</span>
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h4 data-id="heading-10">优点：</h4>
<ul>
<li>灵活性高：可加工子组件参数（如<code>(data) =&gt; fetchData(data + ' 加工后')</code>），也可传递父组件额外参数（如 <code>(data) =&gt; fetchData(data, parentId)</code>）。</li>
<li>避免类组件this问题：箭头函数的this继承自父作用域，可解决类组件中this丢失问题。</li>
<li>可读性强：直观体现参数传递链路，新手更容易理解。</li>
</ul>
<h4 data-id="heading-11">缺点：</h4>
<ul>
<li>性能损耗：每次父组件渲染都会创建新的箭头函数实例，若子组件用了 <code>React.memo</code>，会导致子组件不必要重渲染。</li>
</ul>
<h4 data-id="heading-12">适用场景：</h4>
<p>需要加工参数、需传递父组件额外数据、类组件中解决this绑定问题。</p>
<h3 data-id="heading-13">写法3：立即执行函数（<code>onRefresh={fetchData()}</code>）</h3>
<p>❌ 不推荐（除非函数返回另一个函数，且有明确业务需求）</p>
<h4 data-id="heading-14">问题：</h4>
<ul>
<li>执行时机错误：组件渲染时就触发函数（如本例中会立即发起接口请求），而非子组件触发刷新时。</li>
<li>导致报错：若函数返回非函数值（如Promise、undefined），子组件调用 <code>onRefresh()</code> 时会抛出“不是函数”的错误。</li>
<li>可能引发无限渲染：若函数内部有修改组件状态的操作（如 <code>setData</code>），会导致组件重新渲染，进而再次执行函数，形成循环。</li>
</ul>
<h4 data-id="heading-15">特殊可行场景：</h4>
<p>函数执行后返回一个新的回调函数（高阶函数场景），例如：</p>
<pre><code class="hljs language-ini" lang="ini">// 高阶函数：返回一个回调函数
const <span class="hljs-attr">createFetchData</span> = (parentId) =&gt; {
  return async (showLoading) =&gt; {
    const <span class="hljs-attr">res</span> = await getProductDetail({ appName, loading: showLoading, parentId })<span class="hljs-comment">;</span>
    setData(res)<span class="hljs-comment">;</span>
  }<span class="hljs-comment">;</span>
}<span class="hljs-comment">;</span>

// 此时可写为（执行createFetchData返回回调函数）
return &lt;AuditPending <span class="hljs-attr">onRefresh</span>={createFetchData(<span class="hljs-number">123</span>)} /&gt;<span class="hljs-comment">;</span>
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h2 data-id="heading-16">四、进阶：性能优化方案（平衡灵活性与性能）</h2>
<p>如果既需要箭头函数的灵活性，又想避免子组件不必要的重渲染，可以结合 <code>useCallback</code> 和 <code>React.memo</code> 实现优化，步骤如下：</p>
<h3 data-id="heading-17">1. 用useCallback保持函数引用稳定</h3>
<p>通过 <code>useCallback</code> 包裹父组件的回调函数，确保函数引用在组件渲染过程中保持不变（仅在依赖项变化时更新）。</p>
<h3 data-id="heading-18">2. 用React.memo优化子组件</h3>
<p>用 <code>React.memo</code> 包裹子组件，使子组件仅在props发生实质性变化时才重新渲染。</p>
<h3 data-id="heading-19">优化后完整示例：</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 父组件</span>
<span class="hljs-keyword">import</span> { useState, useCallback } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> { memo } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">ParentComponent</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [data, setData] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">null</span>);
  <span class="hljs-keyword">const</span> [appName] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">'test-app'</span>);
  <span class="hljs-keyword">const</span> [parentId] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">123</span>); <span class="hljs-comment">// 父组件额外参数</span>

  <span class="hljs-comment">// 用useCallback包裹，保持函数引用稳定</span>
  <span class="hljs-keyword">const</span> fetchData = <span class="hljs-title function_">useCallback</span>(<span class="hljs-keyword">async</span> (showLoading = <span class="hljs-literal">true</span>) =&gt; {
    <span class="hljs-keyword">if</span> (!appName) <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getProductDetail</span>({ 
        appName, 
        <span class="hljs-attr">loading</span>: showLoading,
        parentId <span class="hljs-comment">// 使用父组件额外参数</span>
      });
      <span class="hljs-title function_">setData</span>(res);
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(error);
    } <span class="hljs-keyword">finally</span> {
      <span class="hljs-title function_">setLoading</span>(<span class="hljs-literal">false</span>);
    }
  }, [appName, parentId]); <span class="hljs-comment">// 依赖项：仅当appName或parentId变化时，函数引用才更新</span>

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      {keyway === 200 || keyway === 300 ? (
        <span class="hljs-tag">&lt;<span class="hljs-name">AuditPending</span> 
          <span class="hljs-attr">data</span>=<span class="hljs-string">{data}</span> 
          // <span class="hljs-attr">箭头函数传递子组件参数</span>+<span class="hljs-attr">父组件额外参数</span>
          <span class="hljs-attr">onRefresh</span>=<span class="hljs-string">{(showLoading)</span> =&gt;</span> fetchData(showLoading)} 
        /&gt;
      ) : null}
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}

<span class="hljs-comment">// 子组件用memo包裹，优化渲染</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">AuditPending</span> = <span class="hljs-title function_">memo</span>(<span class="hljs-function">(<span class="hljs-params">{ data, onRefresh }</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleRefresh</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-comment">// 子组件根据业务逻辑决定是否传参（如下拉刷新时已有spinner，传false）</span>
    <span class="hljs-title function_">onRefresh</span>(<span class="hljs-literal">false</span>);
  };

  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{handleRefresh}</span>&gt;</span>刷新<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>;
});
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h2 data-id="heading-20">五、总结：不同场景的最优选择指南</h2>
<ol>
<li>简单场景（函数组件、直接透传参数）：优先用 <strong>直接传递函数引用</strong>（性能好、代码简洁）。</li>
<li>复杂场景（加工参数、传递父组件额外数据、类组件）：用 <strong>箭头函数包裹</strong>（灵活性高、解决this问题）。</li>
<li>追求性能优化：结合 <strong>useCallback + React.memo</strong>（平衡灵活性与性能）。</li>
<li>绝对避免：无特殊需求时，不要写 <strong>立即执行函数</strong>（<code>onRefresh={fetchData()}</code>），否则会导致执行时机错误、报错或无限渲染。</li>
</ol>
<p>其实React回调传参的核心就是“搞懂执行时机”和“控制函数引用稳定性”。记住以上原则，就能避开大部分坑，写出高效、清晰的组件通信代码～</p>
<p>​</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React + ECharts 多图表联动实战：从零实现 Tooltip 同步与锁定功能]]></title>    <link>https://juejin.cn/post/7586540799249940534</link>    <guid>https://juejin.cn/post/7586540799249940534</guid>    <pubDate>2025-12-22T11:01:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586540799249940534" data-draft-id="7586263211089166362" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React + ECharts 多图表联动实战：从零实现 Tooltip 同步与锁定功能"/> <meta itemprop="keywords" content="前端,ECharts,React.js"/> <meta itemprop="datePublished" content="2025-12-22T11:01:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小肥宅仙女"/> <meta itemprop="url" content="https://juejin.cn/user/2124677778769838"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React + ECharts 多图表联动实战：从零实现 Tooltip 同步与锁定功能
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2124677778769838/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小肥宅仙女
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T11:01:35.000Z" title="Mon Dec 22 2025 11:01:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">React + ECharts 进阶：优雅实现“带记忆”的多图联动与 Tooltip 点击锁定</h2>
<h3 data-id="heading-1">前言</h3>
<p>在开发复杂的数据看板时，我们经常会遇到这样的痛点：</p>
<ol>
<li><strong>联动难</strong>：虽然 ECharts 自带 connect，但它只能同步悬停，无法自定义复杂的交互逻辑。</li>
<li><strong>看数难</strong>：鼠标一旦移开，Tooltip 消失。想对比两个相距较远的点？甚至想截图保存当前数据状态？难如登天。</li>
<li><strong>视觉乱</strong>：多图联动时，所有图表同时弹出 Tooltip，画面瞬间被密密麻麻的浮层塞满。</li>
</ol>
<p>今天我将分享一个基于 <strong>React Context + ECharts 手动派发 Action</strong> 的方案，实现<strong>多表同步悬停、点击锁定数据点、智能 Tooltip 显示</strong>等高阶交互功能。</p>
<hr/>
<h3 data-id="heading-2">🚀 核心交互预览</h3>
<ul>
<li><strong>全场同步</strong>：鼠标在 A 图滑过，B、C、D 图的指示线（AxisPointer）精准同步。</li>
<li><strong>点击锁定</strong>：点击某一数据点，所有图表进入“锁定模式”，即便鼠标移走，数据依然停留在那一刻，方便深度对比。</li>
<li><strong>智能激活</strong>：只有当前鼠标所在的图表（Active Chart）才显示详细浮层，其他图表保持简洁，仅保留指示线。</li>
</ul>
<p>👉 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.google.com%2Furl%3Fsa%3DE%26q%3Dhttps%253A%252F%252Fcodesandbox.io%252Fp%252Fsandbox%252Fwild-sea-c8wqx9%253Ffile%253D%25252Fsrc%25252Fcomponents%25252FSyncChart.tsx%25253A1%25252C1-301%25252C1" target="_blank" title="https://www.google.com/url?sa=E&amp;q=https%3A%2F%2Fcodesandbox.io%2Fp%2Fsandbox%2Fwild-sea-c8wqx9%3Ffile%3D%252Fsrc%252Fcomponents%252FSyncChart.tsx%253A1%252C1-301%252C1" ref="nofollow noopener noreferrer"><strong>交互 Demo 展示</strong></a></p>
<hr/>
<h3 data-id="heading-3">一、 为什么不直接用 echarts.connect？</h3>
<p>ECharts 官方提供的 connect 能够满足 80% 的联动场景。但剩下的 20%（比如我们要实现的“点击锁定”），官方 API 就显得捉襟见肘了。</p>
<p><strong>本方案的优势：</strong></p>
<ul>
<li><strong>高度受控</strong>：所有图表的状态（选中索引、激活状态）全部收拢在 React State 中。</li>
<li><strong>交互定制</strong>：可以自由定义“解锁”逻辑（如点击空白、鼠标再次进入时自动解锁）。</li>
<li><strong>性能优异</strong>：通过 Ref 和 dispatchAction 精准控制图表更新，避免了因 setOption 导致的频繁重绘。</li>
</ul>
<hr/>
<h3 data-id="heading-4">二、 架构设计：给图表装上“指挥部”</h3>
<p>我们采用 <strong>Context + Provider</strong> 模式。所有图表组件都是“订阅者”，指挥部（Context）负责分发指令。</p>
<h4 data-id="heading-5">1. 逻辑分发图</h4>
<p>这里的核心是<strong>单向数据流</strong>：</p>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e410a8b9d897498ca304729da9ced9c0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP6IKl5a6F5LuZ5aWz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767006282&amp;x-signature=9UBEsyQPRYTZpzBEq9TrnXaLcqc%3D" alt="image.png" width="50%" loading="lazy"/>
<h4 data-id="heading-6">2. 定义通讯协议</h4>
<p>codeTypeScript</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">SyncContext</span> {
  <span class="hljs-attr">lockedIndex</span>: <span class="hljs-built_in">number</span> | <span class="hljs-literal">null</span>;   <span class="hljs-comment">// “锁定”的索引：一旦确定，全场静止</span>
  <span class="hljs-attr">hoverIndex</span>: <span class="hljs-built_in">number</span> | <span class="hljs-literal">null</span>;    <span class="hljs-comment">// “悬停”的索引：随鼠标起舞</span>
  <span class="hljs-attr">activeChartId</span>: <span class="hljs-built_in">string</span> | <span class="hljs-literal">null</span>; <span class="hljs-comment">// 谁是当前的“指挥官”：只有它能显示气泡</span>
}
</code></pre>
<hr/>
<h3 data-id="heading-7">三、 核心代码实现</h3>
<h4 data-id="heading-8">1. 夺回控制权：禁用自动触发</h4>
<p>要实现手动联动，首先要关掉 ECharts 默认的鼠标响应。</p>
<p>codeJavaScript</p>
<pre><code class="hljs language-arduino" lang="arduino">tooltip: {
  trigger: <span class="hljs-string">"axis"</span>,
  triggerOn: <span class="hljs-string">"none"</span>,      <span class="hljs-comment">// 重点：禁用默认的自动触发，改由代码接管</span>
  showContent: isActive,  <span class="hljs-comment">// 只有被激活的图表才显示气泡内容</span>
},
</code></pre>
<h4 data-id="heading-9">2. 时空转换：像素坐标到数据索引</h4>
<p>如何知道鼠标指在哪个点？我们需要把屏幕上的像素点“翻译”成数据的 index。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 使用 zr (ZRender) 监听，比普通图表事件更灵敏</span>
zr.<span class="hljs-title function_">on</span>(<span class="hljs-string">"mousemove"</span>, <span class="hljs-function">(<span class="hljs-params">params</span>) =&gt;</span> {
  <span class="hljs-keyword">if</span> (lockedIndexRef.<span class="hljs-property">current</span> !== <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span>; <span class="hljs-comment">// 锁定状态下不响应悬停</span>

  <span class="hljs-keyword">const</span> pointInPixel = [params.<span class="hljs-property">offsetX</span>, params.<span class="hljs-property">offsetY</span>];
  <span class="hljs-keyword">if</span> (chart.<span class="hljs-title function_">containPixel</span>(<span class="hljs-string">"grid"</span>, pointInPixel)) {
    <span class="hljs-comment">// 关键：将像素坐标转换为数据坐标</span>
    <span class="hljs-keyword">const</span> pointInGrid = chart.<span class="hljs-title function_">convertFromPixel</span>({ <span class="hljs-attr">seriesIndex</span>: <span class="hljs-number">0</span> }, pointInPixel);
    <span class="hljs-keyword">const</span> xIndex = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">round</span>(pointInGrid[<span class="hljs-number">0</span>]); <span class="hljs-comment">// 获取数据索引</span>
    
    <span class="hljs-title function_">setHoverIndex</span>(xIndex);
    <span class="hljs-title function_">setActiveChartId</span>(id);
  }
});
</code></pre>
<h4 data-id="heading-10">3. 精准打击：使用 dispatchAction</h4>
<p>这是实现联动的“魔法棒”。我们不通过 setOption 改数据，而是直接向图表发送动作指令。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> chart = instanceRef.<span class="hljs-property">current</span>;
  <span class="hljs-keyword">if</span> (!chart) <span class="hljs-keyword">return</span>;

  <span class="hljs-comment">// 优先级：锁定索引 &gt; 悬停索引</span>
  <span class="hljs-keyword">const</span> targetIndex = lockedIndex !== <span class="hljs-literal">null</span> ? lockedIndex : hoverIndex;
  <span class="hljs-keyword">const</span> isActive = activeChartId === id;

  <span class="hljs-keyword">if</span> (targetIndex !== <span class="hljs-literal">null</span>) {
    <span class="hljs-comment">// 1. 同步坐标轴指示线 (所有图表同步)</span>
    chart.<span class="hljs-title function_">dispatchAction</span>({
      <span class="hljs-attr">type</span>: <span class="hljs-string">"updateAxisPointer"</span>,
      <span class="hljs-attr">seriesIndex</span>: <span class="hljs-number">0</span>,
      <span class="hljs-attr">dataIndex</span>: targetIndex,
    });

    <span class="hljs-comment">// 2. 控制气泡显示 (仅激活图表显示)</span>
    <span class="hljs-keyword">if</span> (isActive) {
      chart.<span class="hljs-title function_">dispatchAction</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">"showTip"</span>, <span class="hljs-attr">dataIndex</span>: targetIndex });
    } <span class="hljs-keyword">else</span> {
      chart.<span class="hljs-title function_">dispatchAction</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">"hideTip"</span> });
    }
  }
}, [lockedIndex, hoverIndex, activeChartId]);
</code></pre>
<hr/>
<h3 data-id="heading-11">四、 进阶优化（避坑指南）</h3>
<h4 data-id="heading-12">1. 解决 React 闭包陷阱</h4>
<p>在 zr.on 的异步回调中，直接访问 lockedIndex 拿到的是组件初次渲染时的旧值。<br/>
<strong>方案</strong>：引入 useRef 实时同步状态，确保回调函数永远能拿到“现在”的值。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> lockedIndexRef = <span class="hljs-title function_">useRef</span>(lockedIndex);
<span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
  lockedIndexRef.<span class="hljs-property">current</span> = lockedIndex; <span class="hljs-comment">// 同步 ref</span>
}, [lockedIndex]);
</code></pre>
<h4 data-id="heading-13">2. 极致性能：防止配置重载</h4>
<p>频繁切换 showContent 可能会触发 ECharts 内部的重绘逻辑。<br/>
<strong>方案</strong>：在组件内部维护一个 tooltipStateRef，只有当激活状态<strong>真正发生切换</strong>时，才调用 chart.setOption。</p>
<h4 data-id="heading-14">3. 视觉反馈优化</h4>
<p>为了增强交互感，我在外层容器使用了 Tailwind 动态类名：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 当锁定发生时，外层边框发光提醒</span>
className={<span class="hljs-string">`transition-all duration-300 <span class="hljs-subst">${
  lockedIndex !== <span class="hljs-literal">null</span> ? <span class="hljs-string">"border-indigo-500 shadow-indigo-500/20"</span> : <span class="hljs-string">"border-transparent"</span>
}</span>`</span>}
</code></pre>
<hr/>
<h3 data-id="heading-15">五、 总结</h3>
<p>这套方案的核心思想是：<strong>将 ECharts 的内部状态“外部化”</strong> 。</p>
<p>通过 React 控制 ECharts 的 dispatchAction，我们不仅实现了多表联动和点击锁定，更重要的是，我们为数据图表赋予了“记忆”和“主从关系”。</p>
<p>这种“受控图表”的思路可以轻易扩展到：</p>
<ul>
<li><strong>多维数据刷选 (Brush)</strong>  同步</li>
<li><strong>时间轴缩放 (DataZoom)</strong>  同步</li>
<li><strong>多维度对比</strong> 的持久化展示</li>
</ul>
<p>如果你正在开发高性能的可视化大屏，不妨尝试这套方案，它会让你的看板交互瞬间提升一个档次。</p>
<hr/>
<blockquote>
<p><strong>作者注</strong>：文中代码片段为核心逻辑，完整实现需要配合 Context.Provider。如果在开发过程中遇到坐标转换偏移、多图同步延迟等细节问题，欢迎在评论区交流讨论！</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[CSS scroll-behavior 与 JS scrollTo 的协同与博弈]]></title>    <link>https://juejin.cn/post/7586490798431469631</link>    <guid>https://juejin.cn/post/7586490798431469631</guid>    <pubDate>2025-12-22T11:08:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586490798431469631" data-draft-id="7586540799249956918" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="CSS scroll-behavior 与 JS scrollTo 的协同与博弈"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-22T11:08:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="donecoding"/> <meta itemprop="url" content="https://juejin.cn/user/3192637500430093"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            CSS scroll-behavior 与 JS scrollTo 的协同与博弈
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3192637500430093/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    donecoding
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T11:08:37.000Z" title="Mon Dec 22 2025 11:08:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<p>在现代 Web 开发中，平滑滚动已成为提升用户体验的重要细节。CSS 和 JavaScript 都提供了实现滚动动画的方案，但它们之间的交互关系却常被误解。本文将深入探讨 CSS <code>scroll-behavior</code> 与 JavaScript <code>scrollTo()</code> 的用法、优先级规则和实际应用中的注意事项。</p>
<h2 data-id="heading-1">两种滚动动画方案</h2>
<h3 data-id="heading-2">1. CSS scroll-behavior</h3>
<p>CSS 的 <code>scroll-behavior</code> 属性提供了一种声明式的滚动动画控制方式：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 启用平滑滚动 */</span>
<span class="hljs-selector-class">.container</span> {
    scroll-behavior: smooth;
}

<span class="hljs-comment">/* 禁用平滑滚动（默认） */</span>
<span class="hljs-selector-class">.container</span> {
    scroll-behavior: auto;
}
</code></pre>
<p><strong>特性：</strong></p>
<ul>
<li>声明式配置，简单直观</li>
<li>影响容器内所有符合条件的滚动行为</li>
<li>包括锚点链接、浏览器默认滚动等</li>
</ul>
<p>MDN 文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FCSS%2FReference%2FProperties%2Fscroll-behavior" target="_blank" title="https://developer.mozilla.org/zh-CN/docs/Web/CSS/Reference/Properties/scroll-behavior" ref="nofollow noopener noreferrer">scroll-behavior</a></p>
<h3 data-id="heading-3">2. JavaScript scrollTo()</h3>
<p>JavaScript 的 <code>scrollTo()</code> 方法提供了命令式的滚动控制：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 简单用法</span>
element.<span class="hljs-title function_">scrollTo</span>(x, y);

<span class="hljs-comment">// 配置对象形式</span>
element.<span class="hljs-title function_">scrollTo</span>({
    <span class="hljs-attr">top</span>: <span class="hljs-number">100</span>,
    <span class="hljs-attr">left</span>: <span class="hljs-number">0</span>,
    <span class="hljs-attr">behavior</span>: <span class="hljs-string">'smooth'</span> <span class="hljs-comment">// 或 'auto'</span>
});
</code></pre>
<p><strong>特性：</strong></p>
<ul>
<li>程序化控制，灵活性强</li>
<li>可动态决定滚动行为</li>
<li>支持精确的位置控制</li>
</ul>
<p>MDN 文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FAPI%2FElement%2FscrollTo" target="_blank" title="https://developer.mozilla.org/zh-CN/docs/Web/API/Element/scrollTo" ref="nofollow noopener noreferrer">Element.scrollTo()</a></p>
<h2 data-id="heading-4">交互规则与优先级</h2>
<h3 data-id="heading-5">1. 基本原则</h3>
<p>当 CSS <code>scroll-behavior</code> 与 JS <code>scrollTo()</code> 同时存在时，遵循以下规则：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 示例：假设容器已设置 scroll-behavior: smooth</span>

<span class="hljs-comment">// 情况1：JS 明确指定 behavior，以 JS 为准</span>
element.<span class="hljs-title function_">scrollTo</span>({
    <span class="hljs-attr">top</span>: <span class="hljs-number">500</span>,
    <span class="hljs-attr">behavior</span>: <span class="hljs-string">'auto'</span> <span class="hljs-comment">// 立即滚动，覆盖 CSS 的 smooth</span>
});

<span class="hljs-comment">// 情况2：JS 未指定 behavior，以 CSS 为准</span>
element.<span class="hljs-title function_">scrollTo</span>({ <span class="hljs-attr">top</span>: <span class="hljs-number">500</span> }); <span class="hljs-comment">// 平滑滚动</span>
</code></pre>
<h3 data-id="heading-6">2. 特殊情况：scrollTop 的意外行为</h3>
<p>一个常见的误解是：直接设置 <code>scrollTop</code> 属性不会触发平滑滚动。但实际测试发现，在某些浏览器（特别是 Chrome）中，当 CSS 设置了 <code>scroll-behavior: smooth</code> 时，直接设置 <code>scrollTop</code> 也可能触发平滑效果。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 在某些浏览器中可能触发平滑滚动</span>
element.<span class="hljs-property">scrollTop</span> = <span class="hljs-number">500</span>;

<span class="hljs-comment">// 而使用 scrollTo 明确指定 auto 则不会</span>
element.<span class="hljs-title function_">scrollTo</span>({ <span class="hljs-attr">top</span>: <span class="hljs-number">500</span>, <span class="hljs-attr">behavior</span>: <span class="hljs-string">'auto'</span> });
</code></pre>
<p>这种行为的不一致性源于浏览器实现的差异，不应作为可靠的功能依赖。</p>
<h2 data-id="heading-7">实际应用指导</h2>
<h3 data-id="heading-8">1. 明确性原则</h3>
<p>为确保滚动行为的一致性，建议始终明确指定滚动方式：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 推荐：始终明确指定 behavior</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">scrollToPosition</span>(<span class="hljs-params">element, position, smooth = <span class="hljs-literal">true</span></span>) {
    element.<span class="hljs-title function_">scrollTo</span>({
        <span class="hljs-attr">top</span>: position,
        <span class="hljs-attr">behavior</span>: smooth ? <span class="hljs-string">'smooth'</span> : <span class="hljs-string">'auto'</span>
    });
}
</code></pre>
<h3 data-id="heading-9">2. 首次加载特殊处理</h3>
<p>首次加载页面时，通常需要立即滚动到特定位置，无需动画：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 首次加载：立即滚动</span>
<span class="hljs-keyword">const</span> container = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.container'</span>);
container.<span class="hljs-property">style</span>.<span class="hljs-property">scrollBehavior</span> = <span class="hljs-string">'auto'</span>;
container.<span class="hljs-property">scrollTop</span> = container.<span class="hljs-property">scrollHeight</span>;

<span class="hljs-comment">// 延迟恢复平滑效果</span>
<span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
    container.<span class="hljs-property">style</span>.<span class="hljs-property">scrollBehavior</span> = <span class="hljs-string">'smooth'</span>;
}, <span class="hljs-number">100</span>);
</code></pre>
<h3 data-id="heading-10">3. 中止滚动动画</h3>
<p>浏览器未提供直接中止平滑滚动的 API，但可通过以下方式模拟：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">cancelSmoothScroll</span>(<span class="hljs-params">element</span>) {
    <span class="hljs-keyword">const</span> currentScroll = element.<span class="hljs-property">scrollTop</span>;
    element.<span class="hljs-property">style</span>.<span class="hljs-property">scrollBehavior</span> = <span class="hljs-string">'auto'</span>;
    element.<span class="hljs-property">scrollTop</span> = currentScroll;
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
        element.<span class="hljs-property">style</span>.<span class="hljs-property">scrollBehavior</span> = <span class="hljs-string">''</span>;
    }, <span class="hljs-number">0</span>);
}
</code></pre>
<h2 data-id="heading-11">兼容性考量</h2>
<h3 data-id="heading-12">1. 特性检测</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 检测是否支持平滑滚动</span>
<span class="hljs-keyword">const</span> supportsSmoothScroll = <span class="hljs-string">'scrollBehavior'</span> <span class="hljs-keyword">in</span> <span class="hljs-variable language_">document</span>.<span class="hljs-property">documentElement</span>.<span class="hljs-property">style</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">safeScrollTo</span>(<span class="hljs-params">element, options</span>) {
    <span class="hljs-keyword">if</span> (supportsSmoothScroll) {
        element.<span class="hljs-title function_">scrollTo</span>(options);
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// 降级方案</span>
        element.<span class="hljs-property">scrollTop</span> = options.<span class="hljs-property">top</span>;
        element.<span class="hljs-property">scrollLeft</span> = options.<span class="hljs-property">left</span> || <span class="hljs-number">0</span>;
    }
}
</code></pre>
<h3 data-id="heading-13">2. 用户偏好尊重</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 检测用户是否偏好减少动画</span>
<span class="hljs-keyword">const</span> prefersReducedMotion = <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">matchMedia</span>(
    <span class="hljs-string">'(prefers-reduced-motion: reduce)'</span>
).<span class="hljs-property">matches</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">respectfulScrollTo</span>(<span class="hljs-params">element, target</span>) {
    element.<span class="hljs-title function_">scrollTo</span>({
        <span class="hljs-attr">top</span>: target,
        <span class="hljs-attr">behavior</span>: prefersReducedMotion ? <span class="hljs-string">'auto'</span> : <span class="hljs-string">'smooth'</span>
    });
}
</code></pre>
<h2 data-id="heading-14">最佳实践总结</h2>
<ol>
<li><strong>优先使用 JavaScript 控制</strong>：<code>scrollTo()</code> 方法提供更精确的控制和更好的兼容性</li>
<li><strong>避免依赖不一致行为</strong>：不要依赖 <code>scrollTop</code> 的动画效果，不同浏览器表现不一</li>
<li><strong>明确指定滚动行为</strong>：始终通过 <code>behavior</code> 参数明确指定滚动方式</li>
<li><strong>考虑首次加载场景</strong>：首次加载通常需要无动画的立即滚动</li>
<li><strong>尊重用户偏好</strong>：检测 <code>prefers-reduced-motion</code> 媒体查询</li>
<li><strong>提供降级方案</strong>：为不支持平滑滚动的浏览器提供替代方案</li>
</ol>
<h2 data-id="heading-15">结语</h2>
<p>CSS <code>scroll-behavior</code> 和 JavaScript <code>scrollTo()</code> 共同构成了现代 Web 滚动动画的基础设施。理解它们的交互规则和优先级，能帮助我们创建更稳定、一致的用户体验。在实际开发中，推荐以 JavaScript 的 <code>scrollTo()</code> 方法为主，通过明确的参数配置控制滚动行为，同时兼顾 CSS 的声明式简洁性，达到最佳的实现效果。</p>
<p>记住，良好的滚动体验应该是顺滑自然的，但更重要的是可靠和可控。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue3 + Axios 企业级请求封装实战：从零搭建完整的 HTTP 请求层]]></title>    <link>https://juejin.cn/post/7586477908758478883</link>    <guid>https://juejin.cn/post/7586477908758478883</guid>    <pubDate>2025-12-22T10:57:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586477908758478883" data-draft-id="7586518130760810536" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue3 + Axios 企业级请求封装实战：从零搭建完整的 HTTP 请求层"/> <meta itemprop="keywords" content="前端,axios,Vue.js"/> <meta itemprop="datePublished" content="2025-12-22T10:57:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="鹏北海"/> <meta itemprop="url" content="https://juejin.cn/user/1425415102792237"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue3 + Axios 企业级请求封装实战：从零搭建完整的 HTTP 请求层
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1425415102792237/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    鹏北海
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T10:57:25.000Z" title="Mon Dec 22 2025 10:57:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,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) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atelier-estuary-light">.hljs-comment,.hljs-quote{color:#6c6b5a}.hljs-attribute,.hljs-link,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ba6236}.hljs-built_in,.hljs-builtin-name,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#ae7313}.hljs-bullet,.hljs-string,.hljs-symbol{color:#7d9726}.hljs-section,.hljs-title{color:#36a166}.hljs-keyword,.hljs-selector-tag{color:#5f9182}.hljs-addition,.hljs-deletion{color:#22221b;display:inline-block;width:100%}.hljs-deletion{background-color:#ba6236}.hljs-addition{background-color:#7d9726}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#f4f3ec;color:#5f5e4e}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>本文将分享一套经过生产环境验证的 Axios 请求封装方案，涵盖请求拦截、响应处理、Token 管理、多端适配等核心功能，适用于 Vue3 + TypeScript 项目。</p>
</blockquote>
<h2 data-id="heading-0">前言</h2>
<p>在实际的企业级项目中，一个健壮的 HTTP 请求层需要处理很多问题：</p>
<ul>
<li>统一的请求头管理（Token、设备信息、来源追踪等）</li>
<li>灵活的响应拦截（错误处理、消息提示、登录态失效）</li>
<li>多端环境适配（H5、微信浏览器、App WebView）</li>
<li>参数加密与安全传输</li>
<li>营销追踪参数透传</li>
</ul>
<p>本文将逐一拆解这些问题的解决方案。</p>
<hr/>
<h2 data-id="heading-1">一、整体架构设计</h2>
<pre><code class="hljs language-scss" lang="scss">┌─────────────────────────────────────────────────────────────┐
│                      业务层 (APIs)                           │
│              各业务模块的 API 调用                            │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                    HTTP 实例 (单例)                          │
│              配置 baseURL，导出全局实例                       │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                   Axios 封装类                               │
│         请求拦截器 + 响应拦截器 + 参数加密                    │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                      工具层                                  │
│       缓存管理、存储封装、环境判断、Cookie 操作               │
└─────────────────────────────────────────────────────────────┘
</code></pre>
<hr/>
<h2 data-id="heading-2">二、核心封装实现</h2>
<h3 data-id="heading-3">2.1 Axios 类封装</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/plugins/axios/axios.ts</span>
<span class="hljs-keyword">import</span> axios, { <span class="hljs-title class_">AxiosRequestConfig</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'axios'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Http</span> {
    <span class="hljs-keyword">private</span> instance

    <span class="hljs-title function_">constructor</span>(<span class="hljs-params">config: AxiosRequestConfig</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">instance</span> = axios.<span class="hljs-title function_">create</span>(config)
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">interceptors</span>()
    }

    <span class="hljs-comment">// 通用请求方法</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> request&lt;T, D = <span class="hljs-title class_">ResponseResult</span>&lt;T&gt;&gt;(<span class="hljs-attr">config</span>: <span class="hljs-title class_">AxiosRequestConfig</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-keyword">async</span> (resolve, reject) =&gt; {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">instance</span>.<span class="hljs-property">request</span>&lt;D&gt;(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">encryption</span>(config))
                <span class="hljs-title function_">resolve</span>(response.<span class="hljs-property">data</span>)
            } <span class="hljs-keyword">catch</span> (error) {
                <span class="hljs-title function_">reject</span>(error)
            }
        }) <span class="hljs-keyword">as</span> <span class="hljs-title class_">Promise</span>&lt;D&gt;
    }

    <span class="hljs-comment">// 分页请求方法</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> requestMeta&lt;T, D = <span class="hljs-title class_">ResponsePageResult</span>&lt;T&gt;&gt;(<span class="hljs-attr">config</span>: <span class="hljs-title class_">AxiosRequestConfig</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-keyword">async</span> (resolve, reject) =&gt; {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">instance</span>.<span class="hljs-property">request</span>&lt;D&gt;(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">encryption</span>(config))
                <span class="hljs-title function_">resolve</span>(response.<span class="hljs-property">data</span>)
            } <span class="hljs-keyword">catch</span> (error) {
                <span class="hljs-title function_">reject</span>(error)
            }
        }) <span class="hljs-keyword">as</span> <span class="hljs-title class_">Promise</span>&lt;D&gt;
    }

    <span class="hljs-keyword">private</span> <span class="hljs-title function_">interceptors</span>(<span class="hljs-params"/>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">interceptorsRequest</span>()
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">interceptorsResponse</span>()
    }

    <span class="hljs-comment">// 参数加密（下文详解）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title function_">encryption</span>(<span class="hljs-params">config: AxiosRequestConfig</span>) {
        <span class="hljs-comment">// ...</span>
    }
}
</code></pre>
<h3 data-id="heading-4">2.2 创建全局实例</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/plugins/axios/index.ts</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Http</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./axios'</span>
<span class="hljs-keyword">import</span> env <span class="hljs-keyword">from</span> <span class="hljs-string">'@/utils/env'</span>

<span class="hljs-keyword">const</span> http = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Http</span>({
    <span class="hljs-attr">baseURL</span>: <span class="hljs-string">`<span class="hljs-subst">${env.VITE_API_URL}</span>/<span class="hljs-subst">${env.VITE_API_PREFIX}</span>`</span>
})

<span class="hljs-keyword">export</span> { http }
</code></pre>
<hr/>
<h2 data-id="heading-5">三、请求拦截器：统一注入请求头</h2>
<p>请求拦截器是整个封装的核心，需要处理以下信息：</p>
<h3 data-id="heading-6">3.1 完整实现</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">private</span> <span class="hljs-title function_">interceptorsRequest</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">instance</span>.<span class="hljs-property">interceptors</span>.<span class="hljs-property">request</span>.<span class="hljs-title function_">use</span>(
        <span class="hljs-function">(<span class="hljs-params">config: <span class="hljs-built_in">any</span></span>) =&gt;</span> {
            <span class="hljs-comment">// 1. 来源标识：区分微信浏览器和普通移动端</span>
            <span class="hljs-keyword">const</span> source = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">isWeiXin</span>() ? <span class="hljs-string">'MP'</span> : <span class="hljs-string">'MB'</span>

            <span class="hljs-comment">// 2. 平台标识</span>
            <span class="hljs-keyword">const</span> platform = sessionStorage.<span class="hljs-title function_">getItem</span>(<span class="hljs-string">'platform'</span>) || <span class="hljs-string">'h5'</span>

            <span class="hljs-comment">// 3. 组装请求头</span>
            <span class="hljs-keyword">let</span> headers = {
                ...config.<span class="hljs-property">headers</span>,
                platform,
                source,
                <span class="hljs-title class_">Accept</span>: <span class="hljs-string">'application/json'</span>,
            } <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>

            <span class="hljs-comment">// 4. 设备ID（用于设备指纹）</span>
            <span class="hljs-keyword">const</span> deviceId = sessionStorage.<span class="hljs-title function_">getItem</span>(<span class="hljs-string">'deviceId'</span>)
            <span class="hljs-keyword">if</span> (deviceId) {
                headers[<span class="hljs-string">'device-id'</span>] = deviceId
            }

            <span class="hljs-comment">// 5. 营销追踪参数</span>
            <span class="hljs-keyword">const</span> marketLinkUuid = <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(<span class="hljs-string">'market-link-uuid'</span>)
            <span class="hljs-keyword">if</span> (marketLinkUuid) {
                headers[<span class="hljs-string">'market-link-uuid'</span>] = marketLinkUuid
            }

            <span class="hljs-comment">// 6. 认证 Token</span>
            <span class="hljs-keyword">const</span> token = <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(<span class="hljs-string">'token'</span>)
            <span class="hljs-keyword">if</span> (token) {
                headers.<span class="hljs-property">Authorization</span> = <span class="hljs-string">`Bearer <span class="hljs-subst">${token}</span>`</span>
            }

            <span class="hljs-comment">// 7. 自定义消息头编码（防止中文乱码）</span>
            <span class="hljs-keyword">if</span> (headers.<span class="hljs-property">sucMsg</span>) {
                headers.<span class="hljs-property">sucMsg</span> = <span class="hljs-built_in">encodeURIComponent</span>(headers.<span class="hljs-property">sucMsg</span>)
            }
            <span class="hljs-keyword">if</span> (headers.<span class="hljs-property">errMsg</span>) {
                headers.<span class="hljs-property">errMsg</span> = <span class="hljs-built_in">encodeURIComponent</span>(headers.<span class="hljs-property">errMsg</span>)
            }

            <span class="hljs-comment">// 8. 浏览器信息（用于日志分析）</span>
            <span class="hljs-keyword">const</span> { name, info } = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getOSAndBrowserName</span>()
            headers[<span class="hljs-string">'browser-name'</span>] = name
            headers[<span class="hljs-string">'browser-info'</span>] = info

            config.<span class="hljs-property">headers</span> = headers
            <span class="hljs-keyword">return</span> config
        },
        <span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(error)
    )
}
</code></pre>
<h3 data-id="heading-7">3.2 请求头字段说明</h3>













































<table><thead><tr><th>字段</th><th>说明</th><th>示例值</th></tr></thead><tbody><tr><td><code>platform</code></td><td>平台标识</td><td><code>h5</code></td></tr><tr><td><code>source</code></td><td>来源标识</td><td><code>MP</code>(微信) / <code>MB</code>(移动端)</td></tr><tr><td><code>device-id</code></td><td>设备唯一标识</td><td><code>uuid-xxx</code></td></tr><tr><td><code>Authorization</code></td><td>认证令牌</td><td><code>Bearer eyJhbG...</code></td></tr><tr><td><code>market-link-uuid</code></td><td>营销链接追踪</td><td><code>link-uuid</code></td></tr><tr><td><code>browser-name</code></td><td>浏览器标识</td><td><code>Android-WeChat</code></td></tr><tr><td><code>sucMsg</code> / <code>errMsg</code></td><td>自定义提示消息</td><td><code>%E6%93%8D%E4%BD%9C%E6%88%90%E5%8A%9F</code></td></tr></tbody></table>
<hr/>
<h2 data-id="heading-8">四、响应拦截器：统一错误处理</h2>
<h3 data-id="heading-9">4.1 成功响应处理</h3>
<p>一个亮点设计是<strong>动态消息替换机制</strong>，允许前端自定义提示文案：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 响应拦截器 - 成功处理</span>
(response) =&gt; {
    <span class="hljs-comment">// 后端返回的消息包含占位符 {#title}</span>
    <span class="hljs-keyword">if</span> (response.<span class="hljs-property">data</span>.<span class="hljs-property">message</span>.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'{#title}'</span>)) {
        <span class="hljs-comment">// 解码前端传入的自定义消息</span>
        <span class="hljs-keyword">const</span> sucMsg = <span class="hljs-built_in">decodeURIComponent</span>(response.<span class="hljs-property">config</span>.<span class="hljs-property">headers</span>.<span class="hljs-property">sucMsg</span> || <span class="hljs-string">''</span>)
        <span class="hljs-keyword">const</span> errMsg = <span class="hljs-built_in">decodeURIComponent</span>(response.<span class="hljs-property">config</span>.<span class="hljs-property">headers</span>.<span class="hljs-property">errMsg</span> || <span class="hljs-string">''</span>)

        <span class="hljs-comment">// 根据业务码替换消息</span>
        <span class="hljs-keyword">if</span> (response.<span class="hljs-property">data</span>.<span class="hljs-property">code</span> === <span class="hljs-number">20000</span>) {
            response.<span class="hljs-property">data</span>.<span class="hljs-property">message</span> = response.<span class="hljs-property">data</span>.<span class="hljs-property">message</span>.<span class="hljs-title function_">replace</span>(<span class="hljs-string">'{#title}'</span>, sucMsg)
        } <span class="hljs-keyword">else</span> {
            response.<span class="hljs-property">data</span>.<span class="hljs-property">message</span> = response.<span class="hljs-property">data</span>.<span class="hljs-property">message</span>.<span class="hljs-title function_">replace</span>(<span class="hljs-string">'{#title}'</span>, errMsg)
        }
    }
    <span class="hljs-keyword">return</span> response
}
</code></pre>
<p><strong>使用示例：</strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 同一个收藏接口，不同场景显示不同提示</span>
<span class="hljs-keyword">await</span> http.<span class="hljs-title function_">request</span>({
    <span class="hljs-attr">url</span>: <span class="hljs-string">'/api/favorite'</span>,
    <span class="hljs-attr">method</span>: <span class="hljs-string">'POST'</span>,
    <span class="hljs-attr">headers</span>: {
        <span class="hljs-attr">sucMsg</span>: <span class="hljs-string">'课程收藏成功'</span>,  <span class="hljs-comment">// 前端自定义</span>
        <span class="hljs-attr">errMsg</span>: <span class="hljs-string">'课程收藏失败'</span>
    }
})
</code></pre>
<h3 data-id="heading-10">4.2 错误响应处理</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 响应拦截器 - 错误处理</span>
(error) =&gt; {
    <span class="hljs-title function_">closeToast</span>()  <span class="hljs-comment">// 关闭加载提示</span>

    <span class="hljs-keyword">const</span> { status, data } = error.<span class="hljs-property">response</span>

    <span class="hljs-keyword">switch</span> (status) {
        <span class="hljs-keyword">case</span> <span class="hljs-number">401</span>:
            <span class="hljs-comment">// 认证失效处理</span>
            <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">handle401Error</span>()
            <span class="hljs-keyword">break</span>

        <span class="hljs-keyword">case</span> <span class="hljs-number">422</span>:
            <span class="hljs-comment">// 参数验证错误：提取第一个错误信息</span>
            <span class="hljs-keyword">const</span> firstErrKey = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(data.<span class="hljs-property">errors</span>)[<span class="hljs-number">0</span>]
            <span class="hljs-keyword">const</span> errorMsg = data.<span class="hljs-property">errors</span>[firstErrKey][<span class="hljs-number">0</span>]
            <span class="hljs-title function_">showToast</span>(errorMsg || data.<span class="hljs-property">message</span>)
            <span class="hljs-keyword">break</span>

        <span class="hljs-attr">default</span>:
            <span class="hljs-title function_">showToast</span>(data.<span class="hljs-property">message</span>)
    }

    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(error)
}
</code></pre>
<h3 data-id="heading-11">4.3 401 认证失效的完整处理</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">private</span> <span class="hljs-title function_">handle401Error</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 1. 判断是否在 App WebView 中</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">isFlutterWebView</span>()) {
        <span class="hljs-comment">// 通知原生 App 处理登录</span>
        <span class="hljs-variable language_">window</span>.<span class="hljs-property">flutter_inappwebview</span>.<span class="hljs-title function_">callHandler</span>(<span class="hljs-string">'flutterHandler'</span>, {
            <span class="hljs-attr">code</span>: <span class="hljs-string">'token_expired'</span>,
            <span class="hljs-attr">msg</span>: <span class="hljs-string">'登录已过期'</span>
        })
        <span class="hljs-keyword">return</span>
    }

    <span class="hljs-comment">// 2. 清除本地登录信息</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">clearLoginInfo</span>()

    <span class="hljs-comment">// 3. 跳转登录页</span>
    router.<span class="hljs-title function_">replace</span>(<span class="hljs-string">'/login'</span>)
}
</code></pre>
<hr/>
<h2 data-id="heading-12">五、参数加密机制</h2>
<p>对于敏感参数，可以使用 Base64 编码进行简单加密：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Base64</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'js-base64'</span>

<span class="hljs-comment">// 加密方法</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">encryption</span>(<span class="hljs-params">data: <span class="hljs-built_in">any</span></span>): <span class="hljs-built_in">string</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Base64</span>.<span class="hljs-title function_">encode</span>(
        <span class="hljs-built_in">encodeURI</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(data))
    ).<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/=/g</span>, <span class="hljs-string">''</span>)  <span class="hljs-comment">// 移除末尾的等号</span>
}

<span class="hljs-comment">// 解密方法</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">decryption</span>(<span class="hljs-params">data: <span class="hljs-built_in">string</span></span>): <span class="hljs-built_in">any</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(
        <span class="hljs-built_in">decodeURIComponent</span>(<span class="hljs-title class_">Base64</span>.<span class="hljs-title function_">decode</span>(data))
    )
}

<span class="hljs-comment">// 在请求中使用</span>
<span class="hljs-keyword">private</span> <span class="hljs-title function_">encryption</span>(<span class="hljs-params">config: AxiosRequestConfig</span>) {
    <span class="hljs-keyword">if</span> (config.<span class="hljs-property">params</span>?.<span class="hljs-property">f</span>) {
        config.<span class="hljs-property">params</span>.<span class="hljs-property">f</span> = <span class="hljs-title function_">encryption</span>(config.<span class="hljs-property">params</span>.<span class="hljs-property">f</span>)
    }
    <span class="hljs-keyword">return</span> config
}
</code></pre>
<p><strong>使用示例：</strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 原始请求</span>
http.<span class="hljs-title function_">request</span>({
    <span class="hljs-attr">url</span>: <span class="hljs-string">'/api/config'</span>,
    <span class="hljs-attr">params</span>: {
        <span class="hljs-attr">f</span>: { <span class="hljs-attr">code</span>: <span class="hljs-string">'website_settings'</span>, <span class="hljs-attr">type</span>: <span class="hljs-string">'public'</span> }
    }
})

<span class="hljs-comment">// 实际发送</span>
<span class="hljs-comment">// GET /api/config?f=eyJjb2RlIjoid2Vic2l0ZV9zZXR0aW5ncyIsInR5cGUiOiJwdWJsaWMifQ</span>
</code></pre>
<hr/>
<h2 data-id="heading-13">六、本地存储封装</h2>
<h3 data-id="heading-14">6.1 带过期时间的存储工具</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/utils/store.ts</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">CacheData</span> {
    <span class="hljs-attr">data</span>: <span class="hljs-built_in">any</span>
    expire?: <span class="hljs-built_in">number</span>  <span class="hljs-comment">// 过期时间戳</span>
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
    <span class="hljs-title function_">set</span>(<span class="hljs-params">key: <span class="hljs-built_in">string</span>, data: <span class="hljs-built_in">any</span>, useLocalStorage = <span class="hljs-literal">true</span>, expireSeconds?: <span class="hljs-built_in">number</span></span>) {
        <span class="hljs-keyword">const</span> <span class="hljs-attr">cache</span>: <span class="hljs-title class_">CacheData</span> = { data }

        <span class="hljs-keyword">if</span> (expireSeconds) {
            cache.<span class="hljs-property">expire</span> = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() + expireSeconds * <span class="hljs-number">1000</span>
        }

        <span class="hljs-keyword">const</span> storage = useLocalStorage ? <span class="hljs-variable language_">localStorage</span> : sessionStorage
        storage.<span class="hljs-title function_">setItem</span>(key, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(cache))
    },

    <span class="hljs-title function_">get</span>(<span class="hljs-params">key: <span class="hljs-built_in">string</span>, useLocalStorage = <span class="hljs-literal">true</span>, defaultValue: <span class="hljs-built_in">any</span> = <span class="hljs-literal">null</span></span>) {
        <span class="hljs-keyword">const</span> storage = useLocalStorage ? <span class="hljs-variable language_">localStorage</span> : sessionStorage
        <span class="hljs-keyword">const</span> cacheStr = storage.<span class="hljs-title function_">getItem</span>(key)

        <span class="hljs-keyword">if</span> (!cacheStr) <span class="hljs-keyword">return</span> defaultValue

        <span class="hljs-keyword">const</span> <span class="hljs-attr">cache</span>: <span class="hljs-title class_">CacheData</span> = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(cacheStr)

        <span class="hljs-comment">// 检查是否过期</span>
        <span class="hljs-keyword">if</span> (cache.<span class="hljs-property">expire</span> &amp;&amp; cache.<span class="hljs-property">expire</span> &lt; <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>()) {
            storage.<span class="hljs-title function_">removeItem</span>(key)
            <span class="hljs-keyword">return</span> defaultValue
        }

        <span class="hljs-keyword">return</span> cache.<span class="hljs-property">data</span>
    },

    <span class="hljs-title function_">remove</span>(<span class="hljs-params">key: <span class="hljs-built_in">string</span>, useLocalStorage = <span class="hljs-literal">true</span></span>) {
        <span class="hljs-keyword">const</span> storage = useLocalStorage ? <span class="hljs-variable language_">localStorage</span> : sessionStorage
        storage.<span class="hljs-title function_">removeItem</span>(key)
    }
}
</code></pre>
<h3 data-id="heading-15">6.2 登录状态管理</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/utils/cache.ts</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
    <span class="hljs-comment">// 判断登录状态：同时检查 localStorage 和 Cookie</span>
    <span class="hljs-title function_">getIsLogin</span>(): <span class="hljs-built_in">boolean</span> {
        <span class="hljs-keyword">const</span> token = store.<span class="hljs-title function_">get</span>(<span class="hljs-string">'token'</span>)
        <span class="hljs-keyword">const</span> cookieToken = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getCookie</span>(<span class="hljs-string">'token'</span>)
        <span class="hljs-keyword">return</span> !!token &amp;&amp; !!cookieToken
    },

    <span class="hljs-comment">// 设置登录信息</span>
    <span class="hljs-title function_">setLoginInfo</span>(<span class="hljs-params">data: { token: <span class="hljs-built_in">string</span> }</span>) {
        store.<span class="hljs-title function_">set</span>(<span class="hljs-string">'token'</span>, data.<span class="hljs-property">token</span>)
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setCookie</span>(<span class="hljs-string">'token'</span>, data.<span class="hljs-property">token</span>, {
            <span class="hljs-attr">domain</span>: <span class="hljs-string">'.yourdomain.com'</span>,
            <span class="hljs-attr">path</span>: <span class="hljs-string">'/'</span>,
            <span class="hljs-attr">expires</span>: <span class="hljs-title class_">Infinity</span>
        })
    },

    <span class="hljs-comment">// 清除登录信息</span>
    <span class="hljs-title function_">clearLoginInfo</span>(<span class="hljs-params"/>) {
        store.<span class="hljs-title function_">remove</span>(<span class="hljs-string">'token'</span>)
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">removeCookie</span>(<span class="hljs-string">'token'</span>)
        store.<span class="hljs-title function_">remove</span>(<span class="hljs-string">'user_info'</span>)
    }
}
</code></pre>
<hr/>
<h2 data-id="heading-16">七、多端环境判断</h2>
<h3 data-id="heading-17">7.1 微信浏览器判断</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">isWeiXin</span>(<span class="hljs-params"/>): <span class="hljs-built_in">boolean</span> {
    <span class="hljs-keyword">const</span> ua = navigator.<span class="hljs-property">userAgent</span>.<span class="hljs-title function_">toLowerCase</span>()
    <span class="hljs-keyword">return</span> <span class="hljs-regexp">/micromessenger/i</span>.<span class="hljs-title function_">test</span>(ua)
}
</code></pre>
<h3 data-id="heading-18">7.2 操作系统和浏览器识别</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">getOSAndBrowserName</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> ua = navigator.<span class="hljs-property">userAgent</span>

    <span class="hljs-comment">// 操作系统识别</span>
    <span class="hljs-keyword">const</span> osMap = [
        { <span class="hljs-attr">regex</span>: <span class="hljs-regexp">/Android/i</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'Android'</span> },
        { <span class="hljs-attr">regex</span>: <span class="hljs-regexp">/iPhone|iPad|iPod/i</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'iOS'</span> },
        { <span class="hljs-attr">regex</span>: <span class="hljs-regexp">/Windows/i</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'Windows'</span> },
        { <span class="hljs-attr">regex</span>: <span class="hljs-regexp">/Macintosh/i</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'Mac'</span> },
        { <span class="hljs-attr">regex</span>: <span class="hljs-regexp">/Linux/i</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'Linux'</span> }
    ]
    <span class="hljs-keyword">const</span> os = osMap.<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> item.<span class="hljs-property">regex</span>.<span class="hljs-title function_">test</span>(ua))?.<span class="hljs-property">name</span> || <span class="hljs-string">'Unknown'</span>

    <span class="hljs-comment">// 浏览器识别（注意顺序，微信优先）</span>
    <span class="hljs-keyword">const</span> browserMap = [
        { <span class="hljs-attr">regex</span>: <span class="hljs-regexp">/MicroMessenger/i</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'WeChat'</span> },
        { <span class="hljs-attr">regex</span>: <span class="hljs-regexp">/QQBrowser/i</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'QQBrowser'</span> },
        { <span class="hljs-attr">regex</span>: <span class="hljs-regexp">/Edg/i</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'Edge'</span> },
        { <span class="hljs-attr">regex</span>: <span class="hljs-regexp">/Chrome/i</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'Chrome'</span> },
        { <span class="hljs-attr">regex</span>: <span class="hljs-regexp">/Safari/i</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'Safari'</span> },
        { <span class="hljs-attr">regex</span>: <span class="hljs-regexp">/Firefox/i</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'Firefox'</span> }
    ]
    <span class="hljs-keyword">const</span> browser = browserMap.<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> item.<span class="hljs-property">regex</span>.<span class="hljs-title function_">test</span>(ua))?.<span class="hljs-property">name</span> || <span class="hljs-string">'Unknown'</span>

    <span class="hljs-keyword">return</span> {
        <span class="hljs-attr">name</span>: <span class="hljs-string">`<span class="hljs-subst">${os}</span>-<span class="hljs-subst">${browser}</span>`</span>,
        <span class="hljs-attr">info</span>: ua
    }
}
</code></pre>
<h3 data-id="heading-19">7.3 Flutter WebView 判断</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">isFlutterWebView</span>(<span class="hljs-params"/>): <span class="hljs-built_in">boolean</span> {
    <span class="hljs-keyword">return</span> !!sessionStorage.<span class="hljs-title function_">getItem</span>(<span class="hljs-string">'flutter_flag'</span>)
}

<span class="hljs-comment">// 在 Flutter 中打开 WebView 时设置标识</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">setFlutterFlag</span>(<span class="hljs-params"/>) {
    sessionStorage.<span class="hljs-title function_">setItem</span>(<span class="hljs-string">'flutter_flag'</span>, <span class="hljs-string">'true'</span>)
}
</code></pre>
<hr/>
<h2 data-id="heading-20">八、TypeScript 类型定义</h2>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// types/response.d.ts</span>

<span class="hljs-comment">// 通用响应结构</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">ResponseResult</span>&lt;T&gt; {
    <span class="hljs-attr">code</span>: <span class="hljs-built_in">number</span>
    <span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span>
    <span class="hljs-attr">success</span>: <span class="hljs-built_in">boolean</span>
    <span class="hljs-attr">data</span>: T
}

<span class="hljs-comment">// 分页响应结构</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">ResponsePageResult</span>&lt;T&gt; {
    <span class="hljs-attr">code</span>: <span class="hljs-built_in">number</span>
    <span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span>
    <span class="hljs-attr">success</span>: <span class="hljs-built_in">boolean</span>
    <span class="hljs-attr">data</span>: T[]
    <span class="hljs-attr">meta</span>: {
        <span class="hljs-attr">current_page</span>: <span class="hljs-built_in">number</span>
        <span class="hljs-attr">last_page</span>: <span class="hljs-built_in">number</span>
        <span class="hljs-attr">per_page</span>: <span class="hljs-built_in">number</span>
        <span class="hljs-attr">total</span>: <span class="hljs-built_in">number</span>
    }
}
</code></pre>
<hr/>
<h2 data-id="heading-21">九、实际使用示例</h2>
<h3 data-id="heading-22">9.1 基础请求</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { http } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/plugins/axios'</span>

<span class="hljs-comment">// GET 请求</span>
<span class="hljs-keyword">const</span> userInfo = <span class="hljs-keyword">await</span> http.<span class="hljs-property">request</span>&lt;<span class="hljs-title class_">UserInfo</span>&gt;({
    <span class="hljs-attr">method</span>: <span class="hljs-string">'GET'</span>,
    <span class="hljs-attr">url</span>: <span class="hljs-string">'/user/info'</span>
})

<span class="hljs-comment">// POST 请求</span>
<span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> http.<span class="hljs-property">request</span>&lt;<span class="hljs-title class_">LoginResult</span>&gt;({
    <span class="hljs-attr">method</span>: <span class="hljs-string">'POST'</span>,
    <span class="hljs-attr">url</span>: <span class="hljs-string">'/auth/login'</span>,
    <span class="hljs-attr">data</span>: { username, password }
})
</code></pre>
<h3 data-id="heading-23">9.2 分页请求</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> courseList = <span class="hljs-keyword">await</span> http.<span class="hljs-property">requestMeta</span>&lt;<span class="hljs-title class_">Course</span>&gt;({
    <span class="hljs-attr">method</span>: <span class="hljs-string">'GET'</span>,
    <span class="hljs-attr">url</span>: <span class="hljs-string">'/courses'</span>,
    <span class="hljs-attr">params</span>: { <span class="hljs-attr">page</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">per_page</span>: <span class="hljs-number">10</span> }
})

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(courseList.<span class="hljs-property">data</span>)       <span class="hljs-comment">// Course[]</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(courseList.<span class="hljs-property">meta</span>.<span class="hljs-property">total</span>) <span class="hljs-comment">// 总数</span>
</code></pre>
<h3 data-id="heading-24">9.3 带加密参数</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> config = <span class="hljs-keyword">await</span> http.<span class="hljs-title function_">request</span>({
    <span class="hljs-attr">method</span>: <span class="hljs-string">'GET'</span>,
    <span class="hljs-attr">url</span>: <span class="hljs-string">'/config'</span>,
    <span class="hljs-attr">params</span>: {
        <span class="hljs-attr">f</span>: { <span class="hljs-attr">code</span>: <span class="hljs-string">'site_settings'</span> }  <span class="hljs-comment">// 自动 Base64 加密</span>
    }
})
</code></pre>
<h3 data-id="heading-25">9.4 自定义提示消息</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">await</span> http.<span class="hljs-title function_">request</span>({
    <span class="hljs-attr">method</span>: <span class="hljs-string">'POST'</span>,
    <span class="hljs-attr">url</span>: <span class="hljs-string">'/favorite'</span>,
    <span class="hljs-attr">data</span>: { <span class="hljs-attr">course_id</span>: <span class="hljs-number">123</span> },
    <span class="hljs-attr">headers</span>: {
        <span class="hljs-attr">sucMsg</span>: <span class="hljs-string">'收藏成功，可在"我的收藏"中查看'</span>,
        <span class="hljs-attr">errMsg</span>: <span class="hljs-string">'收藏失败，请稍后重试'</span>
    }
})
</code></pre>
<hr/>
<h2 data-id="heading-26">十、最佳实践总结</h2>
<ol>
<li>
<p><strong>单例模式</strong>：全局只创建一个 HTTP 实例，避免重复配置</p>
</li>
<li>
<p><strong>拦截器分离</strong>：请求拦截和响应拦截逻辑清晰分离，便于维护</p>
</li>
<li>
<p><strong>Token 双重存储</strong>：同时存储在 localStorage 和 Cookie 中，兼容不同场景</p>
</li>
<li>
<p><strong>环境适配</strong>：通过 UA 判断自动适配微信、App WebView 等环境</p>
</li>
<li>
<p><strong>消息定制化</strong>：通过 headers 传递自定义消息，同一接口可显示不同提示</p>
</li>
<li>
<p><strong>类型安全</strong>：充分利用 TypeScript 泛型，保证类型推导正确</p>
</li>
<li>
<p><strong>优雅降级</strong>：401 错误时区分 Web 和 App 环境，分别处理</p>
</li>
</ol>
<hr/>
<h2 data-id="heading-27">结语</h2>
<p>一个好的请求封装层应该是"无感"的——业务开发者只需要关注接口调用，而不用操心 Token 注入、错误处理、环境适配等底层细节。</p>
<p>本文分享的方案已在多个生产项目中稳定运行，希望能给你的项目带来一些启发。</p>
<p>如果你有更好的实践方案，欢迎在评论区交流讨论！</p>
<hr/>
<p><strong>相关技术栈：</strong> Vue 3 + TypeScript + Axios + Vant + Pinia</p>
<p><strong>适用场景：</strong> H5 移动端、微信公众号、App 内嵌 WebView</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[在react native中实现短视频平台滑动视频播放组件]]></title>    <link>https://juejin.cn/post/7586505172815265843</link>    <guid>https://juejin.cn/post/7586505172815265843</guid>    <pubDate>2025-12-22T13:56:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586505172815265843" data-draft-id="7586482860104007707" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="在react native中实现短视频平台滑动视频播放组件"/> <meta itemprop="keywords" content="前端,React Native"/> <meta itemprop="datePublished" content="2025-12-22T13:56:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="sure282"/> <meta itemprop="url" content="https://juejin.cn/user/1410005296489149"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            在react native中实现短视频平台滑动视频播放组件
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1410005296489149/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    sure282
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T13:56:59.000Z" title="Mon Dec 22 2025 13:56:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>短视频软件现在人人都离不开，最大的特点之一就是可以无限连刷，通常是上下滑动切换视频，划入自动播放，整体的功能看起来简单清晰明了，但是不同技术栈实现放肆肯定不同，今天在expo创建的react native环境中实现</p>
<p>开发环境关键依赖版本：</p>
<ul>
<li>expo:54+</li>
<li>react-native:0.81+</li>
<li>react:19.1+</li>
<li>expo-video</li>
<li>react-native-reanimated：4.1+</li>
<li>@shopify/flash-list:2+</li>
</ul>
<p>版本依赖有必要简单交代一下，版本不同依赖不匹配会有大问题，本功能片段来自本地视频查看功能，列表加播放，可以控制播放进度，并将选中的视频中的音频提取为独立文件：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f275076dd9ad472e8430d22cc3f434b0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc3VyZTI4Mg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767016618&amp;x-signature=cQCRNW1S%2FWyU6sMhfJcSLUuKfjM%3D" alt="微信图片_20251222205158_66_23.jpg" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/79254410e2ce445eaf44e3094d58d1e5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc3VyZTI4Mg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767016618&amp;x-signature=RyonYVdr0w9Gl5D%2FE%2B3b1j43TfY%3D" alt="微信图片_20251222205159_67_23.jpg" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a937694848e84025bc8b9596ad33710e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc3VyZTI4Mg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767016618&amp;x-signature=7EUC%2BmoaSUWJzCVUfwu1LGkmoMo%3D" alt="微信图片_20251222205200_68_23.jpg" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/842cd99d3ca94b2fb89326ab814c424d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc3VyZTI4Mg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767016618&amp;x-signature=yUG0BzveM1c0XELG6C0rwiude2k%3D" alt="微信图片_20251222205201_69_23.jpg" loading="lazy"/></p>
<p>核心思路:</p>
<ol>
<li>每条视频占据可视区域的绝大部分(满屏);</li>
<li>上下滑动切换(列表);</li>
<li>滑动切换视频自动播放，隐藏的视频不再播放(处于可视区域播放，不可视区域终止播放，释放内存)</li>
<li>播放暂停进度条控制，播放时间等简易功能</li>
</ol>
<p>用户在查看本地视频时分两步走：先以较小的缩略图查看笼统的视频列表，然后可以点击任意一个视频弹出页面中
上下滑动切换播放视频，因此这是两个列表，在rn中有、FlatList列表组件，如下是图1图2的列表组件:</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> { useEffect, useState, useRef, <span class="hljs-keyword">type</span> <span class="hljs-variable constant_">FC</span>, useCallback, useMemo } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> { formatTime } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/utils'</span>;
<span class="hljs-keyword">import</span> { getAssetsAsync, <span class="hljs-title class_">MediaType</span>, requestPermissionsAsync, <span class="hljs-keyword">type</span> <span class="hljs-title class_">AssetsOptions</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'expo-media-library'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">StyleSheet</span>, <span class="hljs-title class_">Text</span>, useWindowDimensions, <span class="hljs-title class_">View</span>, <span class="hljs-title class_">RefreshControl</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'react-native'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">CustomButton</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'@/components/ui/CustomButton'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Empty</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'@/components/ui/Empty'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">VideoModalProps</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/components/VideoModal'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">GlobalLoading</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'@/components/GloablLoading'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">VideoListItem</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'@/components/VideoListItem'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">FlashList</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@shopify/flash-list"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">VideoAsset</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/types'</span>;
<span class="hljs-keyword">import</span> { useThemeNotification, useTheme } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/hooks/useTheme'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">ListFooter</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'@/components/ui/ListFooter'</span>;
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">VideoListProps</span> {
    onPress?: <span class="hljs-function">(<span class="hljs-params">video: VideoAsset</span>) =&gt;</span> <span class="hljs-built_in">void</span>;
}
<span class="hljs-comment">/**
 * 视频列表页面组件
 * 该组件用于展示设备中的视频文件列表，并支持分页加载、权限申请等功能。
 * 用户可以选择某个视频进行后续操作。
 *
 * <span class="hljs-doctag">@param</span> onVideoSelect 当用户点击某一个视频项时触发的回调函数，接收选中的 Asset 对象作为参数
 */</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">VideoList</span>: <span class="hljs-variable constant_">FC</span>&lt;<span class="hljs-title class_">VideoListProps</span>&gt; = <span class="hljs-function">(<span class="hljs-params">{ onPress }</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> [video, setVideo] = useState&lt;<span class="hljs-title class_">VideoAsset</span> | <span class="hljs-literal">null</span>&gt;(<span class="hljs-literal">null</span>);
    <span class="hljs-keyword">const</span> [videos, setVideos] = useState&lt;<span class="hljs-title class_">VideoAsset</span>[]&gt;([]);
    <span class="hljs-keyword">const</span> [loading, setLoading] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);
    <span class="hljs-keyword">const</span> [hasPermission, setHasPermission] = useState&lt;<span class="hljs-built_in">boolean</span> | <span class="hljs-literal">null</span>&gt;(<span class="hljs-literal">null</span>);
    <span class="hljs-keyword">const</span> [after, setAfter] = useState&lt;<span class="hljs-built_in">string</span> | <span class="hljs-literal">undefined</span>&gt;(<span class="hljs-literal">undefined</span>);
    <span class="hljs-keyword">const</span> [hasMore, setHasMore] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">true</span>);
    <span class="hljs-comment">// 防止 FlatList 在首次挂载时触发 onEndReached 导致意外加载,初次加载判定ref的值设置为false</span>
    <span class="hljs-keyword">const</span> initialEndReachedRef = useRef&lt;<span class="hljs-built_in">boolean</span>&gt;(<span class="hljs-literal">true</span>);
    <span class="hljs-comment">// 计算响应式列数 - 强制3列布局</span>
    <span class="hljs-keyword">const</span> targetColumns = <span class="hljs-number">3</span>; <span class="hljs-comment">// 目标列数</span>
    <span class="hljs-keyword">const</span> padding = <span class="hljs-number">32</span>; <span class="hljs-comment">// 左右边距总和</span>
    <span class="hljs-keyword">const</span> [modalVisible, setModalVisible] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);
    <span class="hljs-keyword">const</span> [modalLoading, setModalLoading] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);
    <span class="hljs-keyword">const</span> [<span class="hljs-title class_">VideoModal</span>, setVideoModal] = useState&lt;<span class="hljs-variable constant_">FC</span>&lt;<span class="hljs-title class_">VideoModalProps</span>&gt; | <span class="hljs-literal">null</span>&gt;(<span class="hljs-literal">null</span>);
    <span class="hljs-keyword">const</span> { width } = <span class="hljs-title function_">useWindowDimensions</span>();
    <span class="hljs-keyword">const</span> theme = <span class="hljs-title function_">useTheme</span>();
    <span class="hljs-comment">// 强制使用3列布局（除非屏幕太窄）</span>
    <span class="hljs-keyword">const</span> numColumns = width &gt; <span class="hljs-number">320</span> ? targetColumns : <span class="hljs-number">2</span>;
    <span class="hljs-comment">// 确定每次加载的视频数量，确保能填充3列</span>
    <span class="hljs-keyword">const</span> first = numColumns === <span class="hljs-number">3</span> ? <span class="hljs-number">21</span> : <span class="hljs-number">20</span>;
    <span class="hljs-comment">// 使用margin控制间距，所以这里不考虑spacing</span>
    <span class="hljs-keyword">const</span> itemWidth = <span class="hljs-title function_">useMemo</span>(<span class="hljs-function">() =&gt;</span> (width - padding - numColumns * <span class="hljs-number">10</span>) / numColumns, [width, numColumns]); <span class="hljs-comment">// 10是左右的margin总和</span>
    <span class="hljs-keyword">const</span> showNotification = <span class="hljs-title function_">useThemeNotification</span>();
    <span class="hljs-comment">/**
     * 请求权限并获取视频列表
     *
     * 此方法会先请求媒体库读取权限，如果授权成功则调用 fetchVideos 方法加载视频数据。
     * 如果未获得权限，则弹出提示框告知用户。
     *
     * <span class="hljs-doctag">@param</span> reset 是否重置当前已有的视频列表，默认为 false
     * <span class="hljs-doctag">@returns</span> Promise&lt;void&gt;
     */</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">requestPermissionAndGetVideos</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">reset = <span class="hljs-literal">true</span></span>) =&gt; {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-title function_">setLoading</span>(<span class="hljs-literal">true</span>);
            <span class="hljs-comment">// 请求媒体库权限</span>
            <span class="hljs-keyword">const</span> { status } = <span class="hljs-keyword">await</span> <span class="hljs-title function_">requestPermissionsAsync</span>();
            <span class="hljs-keyword">if</span> (status !== <span class="hljs-string">'granted'</span>) {
                <span class="hljs-title function_">showNotification</span>({ <span class="hljs-attr">tip</span>: <span class="hljs-string">'需要访问媒体库权限才能获取视频文件，请在设置中开启权限。'</span>, <span class="hljs-attr">type</span>: <span class="hljs-string">'warning'</span> });
                <span class="hljs-title function_">setHasPermission</span>(<span class="hljs-literal">false</span>);
                <span class="hljs-keyword">return</span>;
            }
            <span class="hljs-title function_">setHasPermission</span>(<span class="hljs-literal">true</span>);
            <span class="hljs-comment">// 获取视频文件，重新请求权限时默认重置列表</span>
            <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchVideos</span>(reset);
        } <span class="hljs-keyword">catch</span> (error) {
            <span class="hljs-title function_">showNotification</span>({ <span class="hljs-attr">tip</span>: <span class="hljs-string">'获取视频文件失败，请重试'</span>, <span class="hljs-attr">type</span>: <span class="hljs-string">'error'</span> });
        } <span class="hljs-keyword">finally</span> {
            <span class="hljs-title function_">setLoading</span>(<span class="hljs-literal">false</span>);
        }
    };
    <span class="hljs-comment">/**
     * 使用expo-media-library 获取视频文件列表
     * 和expo-document-picker 获取视频文件列表结果不太一样，expo-media-library 会返回更多的视频文件
     * 调用系统 API 获取指定范围内的视频资源，并更新状态以渲染到界面。
     * 支持分页加载与刷新功能。
     *
     * <span class="hljs-doctag">@param</span> reset 是否清空已有数据后重新加载，默认为 false
     * <span class="hljs-doctag">@returns</span> Promise&lt;void&gt;
     */</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">fetchVideos</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">reset = <span class="hljs-literal">false</span></span>) =&gt; {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">const</span> <span class="hljs-attr">options</span>: <span class="hljs-title class_">AssetsOptions</span> = {
                <span class="hljs-attr">mediaType</span>: <span class="hljs-title class_">MediaType</span>.<span class="hljs-property">video</span>, <span class="hljs-comment">// 只获取视频文件</span>
                first, <span class="hljs-comment">// 每次加载根据列数动态调整</span>
                <span class="hljs-attr">after</span>: reset ? <span class="hljs-literal">undefined</span> : after, <span class="hljs-comment">// 分页加载</span>
                <span class="hljs-attr">sortBy</span>: [[<span class="hljs-string">'modificationTime'</span>, <span class="hljs-literal">false</span>]], <span class="hljs-comment">// 按修改时间降序排序</span>
            };
            <span class="hljs-keyword">const</span> { assets = [], endCursor, hasNextPage } = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getAssetsAsync</span>(options);
            <span class="hljs-keyword">const</span> videoList = assets.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">asset</span> =&gt;</span> ({
                ...asset,
                <span class="hljs-attr">durationString</span>: <span class="hljs-title function_">formatTime</span>(asset.<span class="hljs-property">duration</span>),
            }));
            <span class="hljs-keyword">if</span> (reset) {
                <span class="hljs-title function_">setVideos</span>(videoList);
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-title function_">setVideos</span>(<span class="hljs-function"><span class="hljs-params">prev</span> =&gt;</span> [...prev, ...videoList]);
            }
            <span class="hljs-title function_">setAfter</span>(endCursor);
            <span class="hljs-title function_">setHasMore</span>(hasNextPage);
        } <span class="hljs-keyword">catch</span> (error) {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'获取视频列表失败:'</span>, error);
            <span class="hljs-keyword">throw</span> error;
        }
    };
    <span class="hljs-keyword">const</span> handlePressItem = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">(<span class="hljs-params">item: VideoAsset</span>) =&gt;</span> {
        <span class="hljs-title function_">setVideo</span>(item);
        <span class="hljs-keyword">if</span> (!<span class="hljs-title class_">VideoModal</span>) {
            <span class="hljs-title function_">setModalLoading</span>(<span class="hljs-literal">true</span>);
            <span class="hljs-keyword">import</span>(<span class="hljs-string">'@/components/VideoModal'</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">module</span> =&gt;</span> {
                <span class="hljs-title function_">setVideoModal</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">module</span>.<span class="hljs-property">default</span>);
                <span class="hljs-title function_">setModalVisible</span>(<span class="hljs-literal">true</span>);
            }).<span class="hljs-title function_">finally</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">setModalLoading</span>(<span class="hljs-literal">false</span>));
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-title function_">setModalVisible</span>(<span class="hljs-literal">true</span>);
        }
    }, [<span class="hljs-title class_">VideoModal</span>]);
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleConvertPress</span> = (<span class="hljs-params">video: VideoAsset</span>) =&gt; {
        <span class="hljs-title function_">setVideo</span>(video);
        onPress?.(video);
        <span class="hljs-title function_">setModalVisible</span>(<span class="hljs-literal">false</span>);
    };
    <span class="hljs-comment">/**
     * 渲染单个视频项组件
     * 展示缩略图、名称及持续时间等信息。点击可触发选择事件。
     * <span class="hljs-doctag">@param</span> param 包含 item 字段的对象，代表当前要渲染的 Asset 数据
     * <span class="hljs-doctag">@returns</span> JSX 元素
     */</span>
    <span class="hljs-keyword">const</span> renderVideoItem = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">(<span class="hljs-params">{ item }: { item: VideoAsset }</span>) =&gt;</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">VideoListItem</span>
            <span class="hljs-attr">item</span>=<span class="hljs-string">{item}</span>
            <span class="hljs-attr">itemWidth</span>=<span class="hljs-string">{itemWidth}</span>
            <span class="hljs-attr">isSelected</span>=<span class="hljs-string">{item.id</span> === <span class="hljs-string">video?.id}</span>
            <span class="hljs-attr">onPress</span>=<span class="hljs-string">{handlePressItem}</span>
        /&gt;</span></span>
    ), [itemWidth, video?.<span class="hljs-property">id</span>, handlePressItem]);

    <span class="hljs-comment">// 初始化时请求权限（调用被注释或由上层控制时，FlatList 的 onEndReached 可能在挂载时触发，导致 fetchVideos 被调用）</span>
    <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-title function_">requestPermissionAndGetVideos</span>();
    }, []);

    <span class="hljs-comment">/**
     * 页面初次加载可能会导致 FlatList 触发 onEndReached 事件，导致意外加载
     * 因此初次执行FlatList 的 onEndReached 时，只标记已触发，修改ref的值为false，
     * 不执行加载，待后续值为false再执行请求
     * 处理列表滚动到底部的事件回调函数
     * 该函数用于实现无限滚动加载功能，在用户滚动到列表底部时自动加载更多数据
     *
     * 暂不触底加载更多视频，点击底部加载更多按钮触发加载，触发不稳定
     * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">Promise&lt;void&gt;</span>} 返回一个空的 Promise，表示异步操作完成
     */</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleEndReached</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
        <span class="hljs-keyword">if</span> (!hasMore || loading) <span class="hljs-keyword">return</span>;
        <span class="hljs-comment">// 第一次触发 onEndReached 时只标记已触发，不执行加载（常见于 FlatList 在 mount 时触发）</span>
        <span class="hljs-keyword">if</span> (initialEndReachedRef.<span class="hljs-property">current</span>) {
            initialEndReachedRef.<span class="hljs-property">current</span> = <span class="hljs-literal">false</span>;
            <span class="hljs-keyword">return</span>;
        }
        <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchVideos</span>();
    };
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">View</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{styles.container}</span>&gt;</span>
            {hasPermission === false ? (
                <span class="hljs-tag">&lt;<span class="hljs-name">View</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{styles.permissionContainer}</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">Text</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{styles.permissionText}</span>&gt;</span>需要媒体库权限才能访问视频文件<span class="hljs-tag">&lt;/<span class="hljs-name">Text</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">CustomButton</span> <span class="hljs-attr">text</span>=<span class="hljs-string">"重新请求权限"</span> <span class="hljs-attr">onPress</span>=<span class="hljs-string">{()</span> =&gt;</span> requestPermissionAndGetVideos()} /&gt;
                <span class="hljs-tag">&lt;/<span class="hljs-name">View</span>&gt;</span>
            ) : (
                <span class="hljs-tag">&lt;&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">Text</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{styles.countText}</span>&gt;</span>
                        {videos.length &gt; 0 ? `共找到 ${videos.length} 个视频文件` : ''}
                    <span class="hljs-tag">&lt;/<span class="hljs-name">Text</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">FlashList</span>
                        <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">width</span> }}
                        <span class="hljs-attr">data</span>=<span class="hljs-string">{videos}</span>
                        <span class="hljs-attr">refreshControl</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">RefreshControl</span>
                            <span class="hljs-attr">tintColor</span>=<span class="hljs-string">"#007aff"</span>
                            <span class="hljs-attr">refreshing</span>=<span class="hljs-string">{loading}</span>
                            <span class="hljs-attr">onRefresh</span>=<span class="hljs-string">{()</span> =&gt;</span> fetchVideos(true)}
                            colors={['red']}
                            progressBackgroundColor="transparent"
                        /&gt;}
                        showsVerticalScrollIndicator={false}
                        renderItem={renderVideoItem}
                        keyExtractor={({ id }, index) =&gt; `${id}-${index}`}
                        numColumns={numColumns}
                        ListEmptyComponent={!loading ? <span class="hljs-tag">&lt;<span class="hljs-name">Empty</span>
                            <span class="hljs-attr">tip</span>=<span class="hljs-string">"没有找到视频文件"</span>
                            <span class="hljs-attr">style</span>=<span class="hljs-string">{styles.emptyContainer}</span>
                            <span class="hljs-attr">onPress</span>=<span class="hljs-string">{()</span> =&gt;</span> requestPermissionAndGetVideos()}
                        /&gt; : null}
                        onEndReached={handleEndReached}
                        onEndReachedThreshold={0.1}
                        ListFooterComponent={!loading ? <span class="hljs-tag">&lt;<span class="hljs-name">ListFooter</span>
                            <span class="hljs-attr">hasMore</span>=<span class="hljs-string">{hasMore}</span>
                            <span class="hljs-attr">onPress</span>=<span class="hljs-string">{()</span> =&gt;</span> fetchVideos()}
                        /&gt; : null}
                        contentContainerStyle={styles.gridListContainer}
                    /&gt;
                <span class="hljs-tag">&lt;/&gt;</span></span>
            )}
            {modalLoading &amp;&amp; <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">GlobalLoading</span> /&gt;</span></span>}
            {
                <span class="hljs-title class_">VideoModal</span> &amp;&amp; (<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">VideoModal</span>
                    <span class="hljs-attr">visible</span>=<span class="hljs-string">{modalVisible}</span>
                    <span class="hljs-attr">onClose</span>=<span class="hljs-string">{()</span> =&gt;</span> setModalVisible(false)}
                    videoList={videos}
                    currentVideo={video}
                    onPress={handleConvertPress}
                /&gt;</span>)
            }
        &lt;/<span class="hljs-title class_">View</span>&gt;
    );
};

<span class="hljs-keyword">const</span> styles = <span class="hljs-title class_">StyleSheet</span>.<span class="hljs-title function_">create</span>({
    <span class="hljs-attr">container</span>: {
        <span class="hljs-attr">flex</span>: <span class="hljs-number">1</span>,
    },
    <span class="hljs-attr">gridListContainer</span>: {
        <span class="hljs-attr">paddingHorizontal</span>: <span class="hljs-number">16</span>,
    },
    <span class="hljs-attr">emptyContainer</span>: {
        <span class="hljs-attr">marginTop</span>: <span class="hljs-number">50</span>,
    },
    <span class="hljs-attr">permissionContainer</span>: {
        <span class="hljs-attr">flex</span>: <span class="hljs-number">1</span>,
        <span class="hljs-attr">justifyContent</span>: <span class="hljs-string">'center'</span>,
        <span class="hljs-attr">alignItems</span>: <span class="hljs-string">'center'</span>,
        <span class="hljs-attr">paddingHorizontal</span>: <span class="hljs-number">32</span>,
    },
    <span class="hljs-attr">permissionText</span>: {
        <span class="hljs-attr">fontSize</span>: <span class="hljs-number">16</span>,
        <span class="hljs-attr">color</span>: <span class="hljs-string">'#333333'</span>,
        <span class="hljs-attr">textAlign</span>: <span class="hljs-string">'center'</span>,
        <span class="hljs-attr">marginBottom</span>: <span class="hljs-number">20</span>,
    },
    <span class="hljs-attr">countText</span>: {
        <span class="hljs-attr">fontSize</span>: <span class="hljs-number">14</span>,
        <span class="hljs-attr">color</span>: <span class="hljs-string">'#666666'</span>,
        <span class="hljs-attr">textAlign</span>: <span class="hljs-string">'center'</span>,
        <span class="hljs-attr">paddingVertical</span>: <span class="hljs-number">5</span>,
    },
});

</code></pre>
<p>以上是三列列表，元素使用ImageBackground渲染，此时还不具备播放功能，当点击任意一项时将打开VideoModal组件，它是用rn的Modal编写的组件，在其中有一个垂直一列的列表，每一项都会渲染expo-video的VideoView组件：</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> { useRef, useState, useCallback, useEffect, <span class="hljs-keyword">type</span> <span class="hljs-variable constant_">FC</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">View</span>, <span class="hljs-title class_">Modal</span>, <span class="hljs-title class_">StyleSheet</span>, <span class="hljs-title class_">Dimensions</span>, <span class="hljs-title class_">TouchableOpacity</span>, <span class="hljs-title class_">Text</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'react-native'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Ionicons</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@expo/vector-icons'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">VideoItem</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./VideoItem'</span>;
<span class="hljs-keyword">import</span> { useSafeAreaInsets } <span class="hljs-keyword">from</span> <span class="hljs-string">'react-native-safe-area-context'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">FlashList</span>, <span class="hljs-keyword">type</span> <span class="hljs-title class_">FlashListRef</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@shopify/flash-list"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">VideoAsset</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/types'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Image</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'expo-image'</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">type</span> <span class="hljs-title class_">VideoModalProps</span> = {
    <span class="hljs-attr">videoList</span>: <span class="hljs-title class_">Array</span>&lt;<span class="hljs-title class_">VideoAsset</span>&gt;;
    <span class="hljs-attr">visible</span>: <span class="hljs-built_in">boolean</span>;
    <span class="hljs-attr">onClose</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span>;
    <span class="hljs-attr">currentVideo</span>: <span class="hljs-title class_">VideoAsset</span> | <span class="hljs-literal">null</span>;
    onPress?: <span class="hljs-function">(<span class="hljs-params">video: VideoAsset</span>) =&gt;</span> <span class="hljs-built_in">void</span>;
};
<span class="hljs-keyword">const</span> list = [
    {
        <span class="hljs-attr">id</span>: <span class="hljs-string">'0'</span>,
        <span class="hljs-attr">icon</span>: <span class="hljs-string">'heart'</span>,
        <span class="hljs-attr">count</span>: <span class="hljs-string">'1.1万'</span>,
        <span class="hljs-attr">color</span>: <span class="hljs-string">'#fff'</span>,
    },
    {
        <span class="hljs-attr">id</span>: <span class="hljs-string">'1'</span>,
        <span class="hljs-attr">icon</span>: <span class="hljs-string">'chatbubble-ellipses'</span>,
        <span class="hljs-attr">count</span>: <span class="hljs-string">'123'</span>,
        <span class="hljs-attr">color</span>: <span class="hljs-string">'#fff'</span>,
    },
    {
        <span class="hljs-attr">id</span>: <span class="hljs-string">'2'</span>,
        <span class="hljs-attr">icon</span>: <span class="hljs-string">'star'</span>,
        <span class="hljs-attr">count</span>: <span class="hljs-string">'123'</span>,
        <span class="hljs-attr">color</span>: <span class="hljs-string">'#fff'</span>,
    },
    {
        <span class="hljs-attr">id</span>: <span class="hljs-string">'3'</span>,
        <span class="hljs-attr">icon</span>: <span class="hljs-string">'arrow-redo'</span>,
        <span class="hljs-attr">count</span>: <span class="hljs-string">'123'</span>,
        <span class="hljs-attr">color</span>: <span class="hljs-string">'#fff'</span>,
    },
    {
        <span class="hljs-attr">id</span>: <span class="hljs-string">'4'</span>,
        <span class="hljs-attr">icon</span>: <span class="hljs-string">'build'</span>,
        <span class="hljs-attr">count</span>: <span class="hljs-string">'转音频'</span>,
        <span class="hljs-attr">color</span>: <span class="hljs-string">'orangered'</span>,
    },
]
<span class="hljs-keyword">const</span> <span class="hljs-title class_">VideoModal</span>: <span class="hljs-variable constant_">FC</span>&lt;<span class="hljs-title class_">VideoModalProps</span>&gt; = <span class="hljs-function">(<span class="hljs-params">{ visible, onClose, onPress, videoList = [], currentVideo = <span class="hljs-literal">null</span> }</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> [activeVideo, setActiveVideo] = useState&lt;<span class="hljs-title class_">VideoAsset</span> | <span class="hljs-literal">null</span>&gt;(currentVideo);
    <span class="hljs-keyword">const</span> flatListRef = useRef&lt;<span class="hljs-title class_">FlashListRef</span>&lt;<span class="hljs-title class_">VideoAsset</span>&gt;&gt;(<span class="hljs-literal">null</span>);
    <span class="hljs-keyword">const</span> { height } = <span class="hljs-title class_">Dimensions</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'screen'</span>);
    <span class="hljs-keyword">const</span> { bottom, top } = <span class="hljs-title function_">useSafeAreaInsets</span>();
    <span class="hljs-keyword">const</span> viewabilityConfig = <span class="hljs-title function_">useRef</span>({
        <span class="hljs-attr">itemVisiblePercentThreshold</span>: <span class="hljs-number">80</span>,
        <span class="hljs-attr">minimumViewTime</span>: <span class="hljs-number">100</span>,
    }).<span class="hljs-property">current</span>;

    <span class="hljs-comment">// 处理可见性变化</span>
    <span class="hljs-keyword">const</span> onViewableItemsChanged = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">(<span class="hljs-params">{ viewableItems }: <span class="hljs-built_in">any</span></span>) =&gt;</span> {
        <span class="hljs-comment">// 获取所有可见的项目</span>
        <span class="hljs-keyword">if</span> (viewableItems.<span class="hljs-property">length</span> === <span class="hljs-number">1</span>) {
            <span class="hljs-comment">// 使用第一个可见项目（FlatList确保只有一个项目是主要可见的）</span>
            <span class="hljs-title function_">setActiveVideo</span>(viewableItems[<span class="hljs-number">0</span>].<span class="hljs-property">item</span>);
        }
    }, []);
    <span class="hljs-comment">// 获取初始滚动索引</span>
    <span class="hljs-keyword">const</span> getInitialIndex = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-keyword">if</span> (!currentVideo) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
        <span class="hljs-keyword">const</span> index = videoList.<span class="hljs-title function_">findIndex</span>(<span class="hljs-function"><span class="hljs-params">v</span> =&gt;</span> v.<span class="hljs-property">id</span> === currentVideo.<span class="hljs-property">id</span>);
        <span class="hljs-keyword">return</span> index &gt;= <span class="hljs-number">0</span> ? index : <span class="hljs-number">0</span>;
    }, [currentVideo, videoList]);

    <span class="hljs-comment">// 当modal打开或视频列表变化时，初始化activeVideoId</span>
    <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-keyword">if</span> (visible &amp;&amp; currentVideo) {
            <span class="hljs-title function_">setActiveVideo</span>(currentVideo);
        }
    }, [visible, currentVideo]);
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">handlePress</span> = (<span class="hljs-params">id: <span class="hljs-built_in">string</span></span>) =&gt; {
        <span class="hljs-keyword">if</span> (id === <span class="hljs-string">'4'</span>) {
            <span class="hljs-keyword">if</span> (activeVideo) {
                onPress?.(activeVideo);
            }
        }
    };
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Modal</span>
            <span class="hljs-attr">visible</span>=<span class="hljs-string">{visible}</span>
            <span class="hljs-attr">transparent</span>
            <span class="hljs-attr">animationType</span>=<span class="hljs-string">"slide"</span>
            <span class="hljs-attr">onRequestClose</span>=<span class="hljs-string">{onClose}</span>
        &gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">View</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{styles.container}</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">TouchableOpacity</span>
                    <span class="hljs-attr">style</span>=<span class="hljs-string">{[styles.closeButton,</span> { <span class="hljs-attr">top:</span> <span class="hljs-attr">top</span> + <span class="hljs-attr">10</span> }]}
                    <span class="hljs-attr">onPress</span>=<span class="hljs-string">{onClose}</span>
                &gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">Ionicons</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"close"</span> <span class="hljs-attr">size</span>=<span class="hljs-string">{30}</span> <span class="hljs-attr">color</span>=<span class="hljs-string">"white"</span> /&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">TouchableOpacity</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">FlashList</span>
                    <span class="hljs-attr">data</span>=<span class="hljs-string">{videoList}</span>
                    <span class="hljs-attr">keyExtractor</span>=<span class="hljs-string">{({</span> <span class="hljs-attr">id</span> }) =&gt;</span> id}
                    ref={flatListRef}
                    showsVerticalScrollIndicator={false}
                    pagingEnabled
                    decelerationRate="fast"
                    initialScrollIndex={getInitialIndex()}
                    renderItem={({ item }) =&gt; (
                        <span class="hljs-tag">&lt;<span class="hljs-name">VideoItem</span>
                            <span class="hljs-attr">top</span>=<span class="hljs-string">{top}</span>
                            <span class="hljs-attr">bottom</span>=<span class="hljs-string">{bottom}</span>
                            <span class="hljs-attr">modalVisible</span>=<span class="hljs-string">{visible}</span>
                            <span class="hljs-attr">video</span>=<span class="hljs-string">{item}</span>
                            <span class="hljs-attr">isActive</span>=<span class="hljs-string">{item.id</span> === <span class="hljs-string">activeVideo?.id}</span>
                            <span class="hljs-attr">height</span>=<span class="hljs-string">{height}</span>
                        /&gt;</span>
                    )}
                    onViewableItemsChanged={onViewableItemsChanged}
                    viewabilityConfig={viewabilityConfig}
                    removeClippedSubviews={false}
                /&gt;
                <span class="hljs-tag">&lt;<span class="hljs-name">View</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{[styles.sideList,</span> { <span class="hljs-attr">bottom:</span> <span class="hljs-attr">bottom</span> + <span class="hljs-attr">70</span> }]}&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">TouchableOpacity</span>
                        <span class="hljs-attr">style</span>=<span class="hljs-string">{[styles.sideItem,</span> { <span class="hljs-attr">marginBottom:</span> <span class="hljs-attr">10</span> }]}
                    &gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">Image</span>
                            <span class="hljs-attr">source</span>=<span class="hljs-string">{require(</span>'@/<span class="hljs-attr">assets</span>/<span class="hljs-attr">images</span>/<span class="hljs-attr">singer</span>/<span class="hljs-attr">singer2.png</span>')}
                            <span class="hljs-attr">style</span>=<span class="hljs-string">{styles.photo}</span>
                        /&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">Text</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{[styles.ItemText,</span> <span class="hljs-attr">styles.plus</span>]}&gt;</span>+<span class="hljs-tag">&lt;/<span class="hljs-name">Text</span>&gt;</span>
                    <span class="hljs-tag">&lt;/<span class="hljs-name">TouchableOpacity</span>&gt;</span>
                    {
                        list.map(({ id, color, icon, count }) =&gt; (
                            <span class="hljs-tag">&lt;<span class="hljs-name">TouchableOpacity</span>
                                <span class="hljs-attr">key</span>=<span class="hljs-string">{id}</span>
                                <span class="hljs-attr">style</span>=<span class="hljs-string">{styles.sideItem}</span>
                                <span class="hljs-attr">onPress</span>=<span class="hljs-string">{()</span> =&gt;</span> handlePress(id)}
                            &gt;
                                <span class="hljs-tag">&lt;<span class="hljs-name">Ionicons</span>
                                    <span class="hljs-attr">name</span>=<span class="hljs-string">{icon</span> <span class="hljs-attr">as</span> <span class="hljs-attr">any</span>}
                                    <span class="hljs-attr">size</span>=<span class="hljs-string">{32}</span>
                                    <span class="hljs-attr">color</span>=<span class="hljs-string">{color}</span>
                                /&gt;</span>
                                <span class="hljs-tag">&lt;<span class="hljs-name">Text</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{[styles.ItemText,</span> { <span class="hljs-attr">color</span> }]}&gt;</span>{count}<span class="hljs-tag">&lt;/<span class="hljs-name">Text</span>&gt;</span>
                            <span class="hljs-tag">&lt;/<span class="hljs-name">TouchableOpacity</span>&gt;</span>
                        ))
                    }
                <span class="hljs-tag">&lt;/<span class="hljs-name">View</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">View</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">Modal</span>&gt;</span></span>
    );
};

<span class="hljs-keyword">const</span> styles = <span class="hljs-title class_">StyleSheet</span>.<span class="hljs-title function_">create</span>({
    <span class="hljs-attr">container</span>: {
        <span class="hljs-attr">flex</span>: <span class="hljs-number">1</span>,
    },
    <span class="hljs-attr">photo</span>: {
        <span class="hljs-attr">width</span>: <span class="hljs-number">42</span>,
        <span class="hljs-attr">height</span>: <span class="hljs-number">42</span>,
        <span class="hljs-attr">borderRadius</span>: <span class="hljs-number">20</span>,
    },
    <span class="hljs-attr">plus</span>: {
        <span class="hljs-attr">width</span>: <span class="hljs-number">34</span>,
        <span class="hljs-attr">height</span>: <span class="hljs-number">15</span>,
        <span class="hljs-attr">borderRadius</span>: <span class="hljs-number">20</span>,
        <span class="hljs-attr">position</span>: <span class="hljs-string">'absolute'</span>,
        <span class="hljs-attr">bottom</span>: -<span class="hljs-number">10</span>,
        <span class="hljs-attr">textAlign</span>: <span class="hljs-string">'center'</span>,
        <span class="hljs-attr">backgroundColor</span>: <span class="hljs-string">'#ccc'</span>,
        <span class="hljs-attr">fontWeight</span>: <span class="hljs-number">700</span>,
        <span class="hljs-attr">lineHeight</span>: <span class="hljs-number">15</span>,
        <span class="hljs-attr">left</span>: <span class="hljs-string">'50%'</span>,
        <span class="hljs-attr">transform</span>: [{ <span class="hljs-attr">translateX</span>: -<span class="hljs-number">17</span> }],
    },
    <span class="hljs-attr">closeButton</span>: {
        <span class="hljs-attr">position</span>: <span class="hljs-string">'absolute'</span>,
        <span class="hljs-attr">right</span>: <span class="hljs-number">20</span>,
        <span class="hljs-attr">zIndex</span>: <span class="hljs-number">10</span>,
    },
    <span class="hljs-attr">sideList</span>: {
        <span class="hljs-attr">alignItems</span>: <span class="hljs-string">'center'</span>,
        <span class="hljs-attr">gap</span>: <span class="hljs-number">10</span>,
        <span class="hljs-attr">position</span>: <span class="hljs-string">'absolute'</span>,
        <span class="hljs-attr">right</span>: <span class="hljs-number">20</span>,
    },
    <span class="hljs-attr">sideItem</span>: {
        <span class="hljs-attr">alignItems</span>: <span class="hljs-string">'center'</span>,
        <span class="hljs-attr">gap</span>: <span class="hljs-number">5</span>,
    },
    <span class="hljs-title class_">ItemText</span>: {
        <span class="hljs-attr">color</span>: <span class="hljs-string">'#fff'</span>,
        <span class="hljs-attr">fontSize</span>: <span class="hljs-number">12</span>,
    },
});

</code></pre>
<p>如上，可以上下滑动的视频播放列表核心代码在于列表项的每一项应该考虑高度应该是视口高度，列表每次滑动距离应该是视口高度，因此需要获取视口高度和上下的安全距离，将这些传递给视频列表项，如下是列表项组件</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> { useEffect, useState, useRef, <span class="hljs-keyword">type</span> <span class="hljs-variable constant_">FC</span>, act } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">View</span>, <span class="hljs-title class_">StyleSheet</span>, <span class="hljs-title class_">Text</span>, <span class="hljs-title class_">Pressable</span>, <span class="hljs-title class_">TouchableOpacity</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'react-native'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">VideoView</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'expo-video'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">VideoAsset</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/types'</span>;
<span class="hljs-keyword">import</span> { useVideoPlayer } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/hooks/useVideoPlayer'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Slider</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'@react-native-community/slider'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Ionicons</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@expo/vector-icons'</span>;
<span class="hljs-keyword">import</span> { formatTime } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/utils'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Animated</span>, { useSharedValue, withTiming, useAnimatedStyle } <span class="hljs-keyword">from</span> <span class="hljs-string">'react-native-reanimated'</span>;
<span class="hljs-keyword">type</span> <span class="hljs-title class_">Props</span> = {
    <span class="hljs-attr">video</span>: <span class="hljs-title class_">VideoAsset</span>;
    <span class="hljs-attr">isActive</span>: <span class="hljs-built_in">boolean</span>;
    <span class="hljs-attr">height</span>: <span class="hljs-built_in">number</span>;
    <span class="hljs-attr">modalVisible</span>: <span class="hljs-built_in">boolean</span>;
    top?: <span class="hljs-built_in">number</span>;
    bottom?: <span class="hljs-built_in">number</span>;
};

<span class="hljs-comment">/**
 * 视频列表子项多，如果每个item都useVideoPler(uri)会在初始化时创建播放器导致崩溃闪退
 * expo-video的videoView必须接收一个player对象且必须存在，否则报错
 * 因此，使用createVideoPlayer创建一个播放器对象，并保存在组件内部，避免 hooks不能在useEffect中创建播放器对象
 * 1.监听isActive变化，当isActive为true时，创建播放器并播放视频，当isActive为false时，暂停并释放播放器
 * 视频列表子项组件
 * FlatList渲染的视频子项
 * <span class="hljs-doctag">@param</span> video 当前组件应该播放的视频
 * <span class="hljs-doctag">@param</span> isActive 当前视频是否处于屏幕上，是否应该播放
 * <span class="hljs-doctag">@param</span> height 视频组件高度
 * <span class="hljs-doctag">@returns</span> JSX 元素
 */</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">VideoItem</span>: <span class="hljs-variable constant_">FC</span>&lt;<span class="hljs-title class_">Props</span>&gt; = <span class="hljs-function">(<span class="hljs-params">{ video, isActive, height, modalVisible, top, bottom }</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> { player, isPlayerReady, isPlaying, play, pause } = <span class="hljs-title function_">useVideoPlayer</span>({
        <span class="hljs-attr">uri</span>: video.<span class="hljs-property">uri</span>,
        isActive,
        modalVisible
    });
    <span class="hljs-keyword">const</span> [currentTime, setCurrentTime] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);
    <span class="hljs-keyword">const</span> [visible, setVisible] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">true</span>);
    <span class="hljs-keyword">const</span> timerRef = useRef&lt;<span class="hljs-title class_">ReturnType</span>&lt;<span class="hljs-keyword">typeof</span> <span class="hljs-built_in">setTimeout</span>&gt; | <span class="hljs-literal">null</span>&gt;(<span class="hljs-literal">null</span>);
    <span class="hljs-keyword">const</span> topTranslateY = <span class="hljs-title function_">useSharedValue</span>(-<span class="hljs-number">50</span>);
    <span class="hljs-keyword">const</span> bottomTranslateY = <span class="hljs-title function_">useSharedValue</span>(<span class="hljs-number">0</span>);
    <span class="hljs-keyword">const</span> centerOpacity = <span class="hljs-title function_">useSharedValue</span>(<span class="hljs-number">0</span>);
    <span class="hljs-keyword">const</span> centerDisplay = useSharedValue&lt;<span class="hljs-string">'flex'</span> | <span class="hljs-string">'none'</span>&gt;(<span class="hljs-string">'flex'</span>);
    <span class="hljs-keyword">const</span> topStyle = <span class="hljs-title function_">useAnimatedStyle</span>(<span class="hljs-function">() =&gt;</span> ({
        <span class="hljs-attr">transform</span>: [{ <span class="hljs-attr">translateY</span>: topTranslateY.<span class="hljs-property">value</span> }],
    }));
    <span class="hljs-keyword">const</span> centerStye = <span class="hljs-title function_">useAnimatedStyle</span>(<span class="hljs-function">() =&gt;</span> ({
        <span class="hljs-attr">opacity</span>: centerOpacity.<span class="hljs-property">value</span>,
        <span class="hljs-attr">display</span>: centerDisplay.<span class="hljs-property">value</span>,
    }));
    <span class="hljs-keyword">const</span> bottomStyle = <span class="hljs-title function_">useAnimatedStyle</span>(<span class="hljs-function">() =&gt;</span> ({
        <span class="hljs-attr">transform</span>: [{ <span class="hljs-attr">translateY</span>: bottomTranslateY.<span class="hljs-property">value</span> }],
    }));
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">handlleControl</span> = (<span class="hljs-params"/>) =&gt; {
        <span class="hljs-keyword">if</span> (isPlaying) {
            <span class="hljs-title function_">pause</span>();
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-title function_">play</span>();
        }
    };
    <span class="hljs-comment">// 监听播放进度变化</span>
    <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-keyword">if</span> (!player || !isPlayerReady) {
            <span class="hljs-keyword">return</span>;
        }
        <span class="hljs-comment">// 定时更新播放进度</span>
        <span class="hljs-keyword">let</span> <span class="hljs-attr">progressInterval</span>: <span class="hljs-built_in">any</span>;
        <span class="hljs-keyword">if</span> (isPlaying) {
            progressInterval = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
                <span class="hljs-keyword">if</span> (player &amp;&amp; player.<span class="hljs-property">currentTime</span>) {
                    <span class="hljs-title function_">setCurrentTime</span>(player.<span class="hljs-property">currentTime</span>);
                }
            }, <span class="hljs-number">1000</span>); <span class="hljs-comment">// 每100ms更新一次</span>
        }
        <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
            <span class="hljs-keyword">if</span> (progressInterval) {
                <span class="hljs-built_in">clearInterval</span>(progressInterval);
            }
        };
    }, [player, isPlayerReady, isPlaying]);
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">clearTimer</span> = (<span class="hljs-params"/>) =&gt; {
        <span class="hljs-keyword">if</span> (timerRef.<span class="hljs-property">current</span>) {
            <span class="hljs-built_in">clearTimeout</span>(timerRef.<span class="hljs-property">current</span>);
            timerRef.<span class="hljs-property">current</span> = <span class="hljs-literal">null</span>;
        }
    };
    <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-keyword">if</span> (visible) {
            <span class="hljs-title function_">clearTimer</span>();
            topTranslateY.<span class="hljs-property">value</span> = <span class="hljs-title function_">withTiming</span>(<span class="hljs-number">0</span>, { <span class="hljs-attr">duration</span>: <span class="hljs-number">300</span> });
            centerOpacity.<span class="hljs-property">value</span> = <span class="hljs-title function_">withTiming</span>(<span class="hljs-number">1</span>, { <span class="hljs-attr">duration</span>: <span class="hljs-number">300</span> });
            bottomTranslateY.<span class="hljs-property">value</span> = <span class="hljs-title function_">withTiming</span>(<span class="hljs-number">0</span>, { <span class="hljs-attr">duration</span>: <span class="hljs-number">300</span> });
            centerDisplay.<span class="hljs-property">value</span> = <span class="hljs-string">'flex'</span>;
            timerRef.<span class="hljs-property">current</span> = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
                topTranslateY.<span class="hljs-property">value</span> = <span class="hljs-title function_">withTiming</span>(-<span class="hljs-number">50</span>, { <span class="hljs-attr">duration</span>: <span class="hljs-number">300</span> });
                centerOpacity.<span class="hljs-property">value</span> = <span class="hljs-title function_">withTiming</span>(<span class="hljs-number">0</span>, { <span class="hljs-attr">duration</span>: <span class="hljs-number">300</span> });
                bottomTranslateY.<span class="hljs-property">value</span> = <span class="hljs-title function_">withTiming</span>(<span class="hljs-number">70</span>, { <span class="hljs-attr">duration</span>: <span class="hljs-number">300</span> });
                centerDisplay.<span class="hljs-property">value</span> = <span class="hljs-string">'none'</span>;
                <span class="hljs-title function_">setVisible</span>(<span class="hljs-literal">false</span>)
            }, <span class="hljs-number">3000</span>);
        };
        <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
            <span class="hljs-title function_">clearTimer</span>();
        };
    }, [visible])
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">handlePressBg</span> = (<span class="hljs-params"/>) =&gt; {
        <span class="hljs-title function_">setVisible</span>(!visible);
    }

    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Pressable</span>
            <span class="hljs-attr">style</span>=<span class="hljs-string">{[styles.container,</span> { <span class="hljs-attr">height</span>, <span class="hljs-attr">paddingTop:</span> <span class="hljs-attr">top</span>, <span class="hljs-attr">paddingBottom:</span> <span class="hljs-attr">bottom</span> }]}
            <span class="hljs-attr">onPress</span>=<span class="hljs-string">{handlePressBg}</span>
        &gt;</span>
            {/* 只有当播放器存在且准备就绪时才渲染 VideoView */}
            {player &amp;&amp; isPlayerReady &amp;&amp; player.status !== 'idle' &amp;&amp; (
                <span class="hljs-tag">&lt;<span class="hljs-name">VideoView</span>
                    <span class="hljs-attr">style</span>=<span class="hljs-string">{[StyleSheet.absoluteFill,</span> { <span class="hljs-attr">marginBottom:</span> <span class="hljs-attr">bottom</span>, <span class="hljs-attr">marginTop:</span> <span class="hljs-attr">top</span> }]}
                    <span class="hljs-attr">player</span>=<span class="hljs-string">{player}</span>
                    <span class="hljs-attr">nativeControls</span>=<span class="hljs-string">{false}</span>
                    <span class="hljs-attr">fullscreenOptions</span>=<span class="hljs-string">{{</span>
                        <span class="hljs-attr">enable:</span> <span class="hljs-attr">true</span>, //<span class="hljs-attr">能否全屏</span>
                        <span class="hljs-attr">orientation:</span> '<span class="hljs-attr">landscape</span>', //<span class="hljs-attr">全屏时屏幕方向</span>
                        <span class="hljs-attr">autoExitOnRotate:</span> <span class="hljs-attr">false</span>, //<span class="hljs-attr">屏幕旋转时是否退出全屏</span>
                    }}
                /&gt;</span>
            )}
            <span class="hljs-tag">&lt;<span class="hljs-name">View</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{[styles.overlay,</span> { <span class="hljs-attr">top</span> }]}&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">Animated.Text</span>
                    <span class="hljs-attr">style</span>=<span class="hljs-string">{[styles.videoTitle,</span> <span class="hljs-attr">topStyle</span>]}
                    <span class="hljs-attr">numberOfLines</span>=<span class="hljs-string">{1}</span>
                &gt;</span>
                    {video.filename ?? '未知视频'}
                <span class="hljs-tag">&lt;/<span class="hljs-name">Animated.Text</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">Animated.View</span>
                    <span class="hljs-attr">style</span>=<span class="hljs-string">{[styles.center,</span> <span class="hljs-attr">centerStye</span>]}
                &gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">TouchableOpacity</span> <span class="hljs-attr">onPress</span>=<span class="hljs-string">{handlleControl}</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">Ionicons</span> <span class="hljs-attr">name</span>=<span class="hljs-string">{isPlaying</span> ? "<span class="hljs-attr">pause</span>" <span class="hljs-attr">:</span> "<span class="hljs-attr">play</span>"} <span class="hljs-attr">size</span>=<span class="hljs-string">{50}</span> <span class="hljs-attr">color</span>=<span class="hljs-string">"white"</span> /&gt;</span>
                    <span class="hljs-tag">&lt;/<span class="hljs-name">TouchableOpacity</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">Animated.View</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">Animated.View</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{[styles.bottom,</span> <span class="hljs-attr">bottomStyle</span>]}&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">Slider</span>
                        <span class="hljs-attr">style</span>=<span class="hljs-string">{styles.slider}</span>
                        <span class="hljs-attr">minimumValue</span>=<span class="hljs-string">{0}</span>
                        <span class="hljs-attr">maximumValue</span>=<span class="hljs-string">{video.duration</span> || <span class="hljs-attr">0</span>}
                        <span class="hljs-attr">value</span>=<span class="hljs-string">{currentTime}</span>
                        <span class="hljs-attr">onSlidingComplete</span>=<span class="hljs-string">{(value)</span> =&gt;</span> {
                            if (player) {
                                player.currentTime = value; // expo-video 使用秒为单位
                            }
                        }}
                        minimumTrackTintColor="#fff" // 滑块左侧轨道颜色
                        maximumTrackTintColor="#d3d3d3" // 滑块右侧轨道颜色
                        thumbTintColor="#fff" // 滑块颜色
                    /&gt;
                    <span class="hljs-tag">&lt;<span class="hljs-name">View</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{styles.time}</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">Text</span>
                            <span class="hljs-attr">numberOfLines</span>=<span class="hljs-string">{1}</span>
                            <span class="hljs-attr">style</span>=<span class="hljs-string">{styles.timeText}</span>
                        &gt;</span>{formatTime(currentTime)}<span class="hljs-tag">&lt;/<span class="hljs-name">Text</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">Text</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{styles.timeText}</span>&gt;</span>/<span class="hljs-tag">&lt;/<span class="hljs-name">Text</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">Text</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{styles.timeText}</span> <span class="hljs-attr">numberOfLines</span>=<span class="hljs-string">{1}</span>&gt;</span>{video.durationString}<span class="hljs-tag">&lt;/<span class="hljs-name">Text</span>&gt;</span>
                    <span class="hljs-tag">&lt;/<span class="hljs-name">View</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">Animated.View</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">View</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">Pressable</span>&gt;</span></span>
    );
};

<span class="hljs-keyword">const</span> styles = <span class="hljs-title class_">StyleSheet</span>.<span class="hljs-title function_">create</span>({
    <span class="hljs-attr">container</span>: {
        <span class="hljs-attr">backgroundColor</span>: <span class="hljs-string">'#000'</span>,
    },
    <span class="hljs-attr">time</span>: {
        <span class="hljs-attr">flexDirection</span>: <span class="hljs-string">'row'</span>,
        <span class="hljs-attr">alignItems</span>: <span class="hljs-string">'center'</span>,
        <span class="hljs-attr">justifyContent</span>: <span class="hljs-string">'center'</span>,
        <span class="hljs-attr">gap</span>: <span class="hljs-number">5</span>,
    },
    <span class="hljs-attr">timeText</span>: {
        <span class="hljs-attr">color</span>: <span class="hljs-string">'#fff'</span>,
        <span class="hljs-attr">fontSize</span>: <span class="hljs-number">14</span>,
    },
    <span class="hljs-attr">slider</span>: {
        <span class="hljs-attr">height</span>: <span class="hljs-number">20</span>,
        <span class="hljs-attr">width</span>: <span class="hljs-string">'70%'</span>,
    },
    <span class="hljs-attr">center</span>: {
        <span class="hljs-attr">height</span>: <span class="hljs-number">70</span>,
        <span class="hljs-attr">justifyContent</span>: <span class="hljs-string">'center'</span>,
        <span class="hljs-attr">alignItems</span>: <span class="hljs-string">'center'</span>,
    },
    <span class="hljs-attr">overlay</span>: {
        <span class="hljs-attr">width</span>: <span class="hljs-string">'100%'</span>,
        <span class="hljs-attr">height</span>: <span class="hljs-string">'100%'</span>,
        <span class="hljs-attr">paddingHorizontal</span>: <span class="hljs-number">20</span>,
        <span class="hljs-attr">position</span>: <span class="hljs-string">'absolute'</span>,
        <span class="hljs-attr">justifyContent</span>: <span class="hljs-string">'center'</span>,
        <span class="hljs-attr">overflow</span>: <span class="hljs-string">'hidden'</span>,
    },
    <span class="hljs-attr">bottom</span>: {
        <span class="hljs-attr">height</span>: <span class="hljs-number">70</span>,
        <span class="hljs-attr">flexDirection</span>: <span class="hljs-string">'row'</span>,
        <span class="hljs-attr">alignItems</span>: <span class="hljs-string">'center'</span>,
        <span class="hljs-attr">justifyContent</span>: <span class="hljs-string">'space-between'</span>,
        <span class="hljs-attr">marginTop</span>: <span class="hljs-number">10</span>,
        <span class="hljs-attr">width</span>: <span class="hljs-string">'100%'</span>,
        <span class="hljs-attr">position</span>: <span class="hljs-string">'absolute'</span>,
        <span class="hljs-attr">bottom</span>: <span class="hljs-number">0</span>,
        <span class="hljs-attr">left</span>: <span class="hljs-number">20</span>,
    },
    <span class="hljs-attr">videoTitle</span>: {
        <span class="hljs-attr">fontSize</span>: <span class="hljs-number">16</span>,
        <span class="hljs-attr">fontWeight</span>: <span class="hljs-string">'bold'</span>,
        <span class="hljs-attr">width</span>: <span class="hljs-number">200</span>,
        <span class="hljs-attr">color</span>: <span class="hljs-string">'#fff'</span>,
        <span class="hljs-attr">height</span>: <span class="hljs-number">50</span>,
        <span class="hljs-attr">lineHeight</span>: <span class="hljs-number">50</span>,
        <span class="hljs-attr">position</span>: <span class="hljs-string">'absolute'</span>,
        <span class="hljs-attr">left</span>: <span class="hljs-number">20</span>,
        <span class="hljs-attr">top</span>: <span class="hljs-number">0</span>,
    },
    <span class="hljs-attr">duration</span>: {
        <span class="hljs-attr">fontSize</span>: <span class="hljs-number">14</span>,
        <span class="hljs-attr">marginTop</span>: <span class="hljs-number">4</span>,
        <span class="hljs-attr">color</span>: <span class="hljs-string">'#fff'</span>,
    },
});

</code></pre>
<p>视频组件使用的依赖库是expo-video，这个依赖库中的VideoView组件是视频组件，必须接收VideoPlayer类型的player属性，而这么多视频我们不可能都创建出这个player，创建player的方式有两种，</p>
<ol>
<li>
<p>用该依赖库提供的useAudioPlayer hooks创建，不用手动处理卸载加载
这意味着视频列表项目很多，而hooks又不能在条件语句中执行，这将会导致视频列表模态框加载即崩溃，
上面的item项目每一个都初始化加载视频，又无法控制列表项出现在视口时创建player加载视频，所以在这个场景下肯定不行的，因此上面引入的useAudioPlayer组件不是依赖库提供的，而是基于下面的api按需封装的</p>
</li>
<li>
<p>createAudioPlayer，，这个api可以控制创建player时机，以及释放销毁的时机，同样，VideoView仍然需要player，因此只有当播放器存在且准备就绪时才渲染 VideoView</p>
</li>
<li>
<p>正确更新当前播放时间，使用了上面的api就意味着不能再使用expo提供的useEvent和useEventListener监听player的播放情况，同样是因为hooks必须在组件顶层使用，</p>
</li>
</ol>
<p>基于以上问题，播放进度更新，采用监听是否在播放，player是否存在，然后setInterval获取player.currentTime属性值，更新state</p>
<p>视频的播放卸载，按需编写一个hooks：</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> { useRef, useState, useCallback, useEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> { createVideoPlayer, <span class="hljs-keyword">type</span> <span class="hljs-title class_">VideoPlayer</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'expo-video'</span>;

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">UseVideoPlayerOptions</span> {
    <span class="hljs-attr">uri</span>: <span class="hljs-built_in">string</span>;
    isActive?: <span class="hljs-built_in">boolean</span>;
    modalVisible?: <span class="hljs-built_in">boolean</span>;
}

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">UseVideoPlayerReturn</span> {
    <span class="hljs-attr">player</span>: <span class="hljs-title class_">VideoPlayer</span> | <span class="hljs-literal">null</span>;
    <span class="hljs-attr">isPlayerReady</span>: <span class="hljs-built_in">boolean</span>;
    <span class="hljs-attr">isPlaying</span>: <span class="hljs-built_in">boolean</span>;
    <span class="hljs-attr">play</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span>;
    <span class="hljs-attr">pause</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span>;
    <span class="hljs-attr">release</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span>;
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> useVideoPlayer = ({ uri, isActive = <span class="hljs-literal">false</span>, modalVisible = <span class="hljs-literal">false</span> }: <span class="hljs-title class_">UseVideoPlayerOptions</span>): <span class="hljs-function"><span class="hljs-params">UseVideoPlayerReturn</span> =&gt;</span> {
    <span class="hljs-keyword">const</span> playerRef = useRef&lt;<span class="hljs-title class_">VideoPlayer</span> | <span class="hljs-literal">null</span>&gt;(<span class="hljs-literal">null</span>);
    <span class="hljs-keyword">const</span> [player, setPlayer] = useState&lt;<span class="hljs-title class_">VideoPlayer</span> | <span class="hljs-literal">null</span>&gt;(<span class="hljs-literal">null</span>);
    <span class="hljs-keyword">const</span> [isPlayerReady, setIsPlayerReady] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);
    <span class="hljs-keyword">const</span> [isPlaying, setIsPlaying] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);

    <span class="hljs-keyword">const</span> initializePlayer = <span class="hljs-title function_">useCallback</span>(<span class="hljs-keyword">async</span> () =&gt; {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 清理之前的播放器</span>
            <span class="hljs-keyword">if</span> (playerRef.<span class="hljs-property">current</span> &amp;&amp; playerRef.<span class="hljs-property">current</span>.<span class="hljs-property">status</span> !== <span class="hljs-string">'idle'</span>) {
                playerRef.<span class="hljs-property">current</span>.<span class="hljs-title function_">pause</span>();
                playerRef.<span class="hljs-property">current</span>.<span class="hljs-title function_">release</span>();
                playerRef.<span class="hljs-property">current</span> = <span class="hljs-literal">null</span>;
            }

            <span class="hljs-title function_">setPlayer</span>(<span class="hljs-literal">null</span>);
            <span class="hljs-title function_">setIsPlayerReady</span>(<span class="hljs-literal">false</span>);
            <span class="hljs-title function_">setIsPlaying</span>(<span class="hljs-literal">false</span>);

            <span class="hljs-comment">// 只有在活跃和模态框可见时才创建新播放器</span>
            <span class="hljs-keyword">if</span> (modalVisible &amp;&amp; isActive &amp;&amp; uri) {
                <span class="hljs-keyword">const</span> newPlayer = <span class="hljs-title function_">createVideoPlayer</span>(uri);
                playerRef.<span class="hljs-property">current</span> = newPlayer;

                <span class="hljs-comment">// 监听播放状态</span>
                <span class="hljs-keyword">const</span> playingListener = newPlayer.<span class="hljs-title function_">addListener</span>(<span class="hljs-string">'playingChange'</span>, <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
                    <span class="hljs-title function_">setIsPlaying</span>(event.<span class="hljs-property">isPlaying</span>);
                });

                <span class="hljs-comment">// 监听播放器状态变化</span>
                <span class="hljs-keyword">const</span> statusListener = newPlayer.<span class="hljs-title function_">addListener</span>(<span class="hljs-string">'statusChange'</span>, <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
                    <span class="hljs-keyword">if</span> (event.<span class="hljs-property">status</span> === <span class="hljs-string">'readyToPlay'</span>) {
                        <span class="hljs-title function_">setPlayer</span>(newPlayer);
                        <span class="hljs-title function_">setIsPlayerReady</span>(<span class="hljs-literal">true</span>);
                        <span class="hljs-comment">// 自动开始播放</span>
                        newPlayer.<span class="hljs-title function_">play</span>();
                    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (event.<span class="hljs-property">status</span> === <span class="hljs-string">'error'</span>) {
                        <span class="hljs-title function_">setPlayer</span>(<span class="hljs-literal">null</span>);
                        <span class="hljs-title function_">setIsPlayerReady</span>(<span class="hljs-literal">false</span>);
                    }
                });

                <span class="hljs-comment">// 保存监听器引用以便清理</span>
                (newPlayer <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>).<span class="hljs-property">playingListener</span> = playingListener;
                (newPlayer <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>).<span class="hljs-property">statusListener</span> = statusListener;
            }
        } <span class="hljs-keyword">catch</span> (error) {
            <span class="hljs-title function_">setPlayer</span>(<span class="hljs-literal">null</span>);
            <span class="hljs-title function_">setIsPlayerReady</span>(<span class="hljs-literal">false</span>);
            <span class="hljs-title function_">setIsPlaying</span>(<span class="hljs-literal">false</span>);
        }
    }, [modalVisible, isActive, uri]);

    <span class="hljs-keyword">const</span> play = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-keyword">if</span> (playerRef.<span class="hljs-property">current</span> &amp;&amp; playerRef.<span class="hljs-property">current</span>.<span class="hljs-property">status</span> !== <span class="hljs-string">'idle'</span>) {
            playerRef.<span class="hljs-property">current</span>.<span class="hljs-title function_">play</span>();
        }
    }, []);

    <span class="hljs-keyword">const</span> pause = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-keyword">if</span> (playerRef.<span class="hljs-property">current</span> &amp;&amp; playerRef.<span class="hljs-property">current</span>.<span class="hljs-property">status</span> !== <span class="hljs-string">'idle'</span>) {
            playerRef.<span class="hljs-property">current</span>.<span class="hljs-title function_">pause</span>();
        }
    }, []);

    <span class="hljs-keyword">const</span> release = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-keyword">if</span> (playerRef.<span class="hljs-property">current</span> &amp;&amp; playerRef.<span class="hljs-property">current</span>.<span class="hljs-property">status</span> !== <span class="hljs-string">'idle'</span>) {
            <span class="hljs-comment">// 清理监听器</span>
            <span class="hljs-keyword">const</span> playingListener = (playerRef.<span class="hljs-property">current</span> <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>).<span class="hljs-property">playingListener</span>;
            <span class="hljs-keyword">const</span> statusListener = (playerRef.<span class="hljs-property">current</span> <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>).<span class="hljs-property">statusListener</span>;

            <span class="hljs-keyword">if</span> (playingListener) {
                playingListener.<span class="hljs-title function_">remove</span>();
            }
            <span class="hljs-keyword">if</span> (statusListener) {
                statusListener.<span class="hljs-title function_">remove</span>();
            }

            playerRef.<span class="hljs-property">current</span>.<span class="hljs-title function_">pause</span>();
            playerRef.<span class="hljs-property">current</span>.<span class="hljs-title function_">release</span>();
            playerRef.<span class="hljs-property">current</span> = <span class="hljs-literal">null</span>;
        }
        <span class="hljs-title function_">setPlayer</span>(<span class="hljs-literal">null</span>);
        <span class="hljs-title function_">setIsPlayerReady</span>(<span class="hljs-literal">false</span>);
        <span class="hljs-title function_">setIsPlaying</span>(<span class="hljs-literal">false</span>);
    }, []);

    <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-title function_">initializePlayer</span>()

        <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
            <span class="hljs-comment">// 组件卸载时清理</span>
            <span class="hljs-title function_">release</span>();
        };
    }, [initializePlayer, release]);

    <span class="hljs-keyword">return</span> {
        player,
        isPlayerReady,
        isPlaying,
        play,
        pause,
        release
    };
}
</code></pre>
<p>看似不复杂的需求(上面的右侧边栏的消息，评论都没有功能，主要是用于演示)，就已经编写了这么多代码，最大的坑来自于expo-audio，也没有去找其他视频相关的组件，大家可以作为参考，可能其他视频依赖库更简单，后续可能会更新一篇 在rn中使用ffmpeg-kit实现，提取视频文件的音频部分为独立文件的功能篇，这个功能已经实现，</p>
<p>有任何疑问见解欢迎评论区交流</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[HarmonyOS ArkTS 实战：阅读器顶部栏“高度收缩 + 背景透明度过渡”（@AnimatableExtend 方案，能直接抄）]]></title>    <link>https://juejin.cn/post/7586482860104204315</link>    <guid>https://juejin.cn/post/7586482860104204315</guid>    <pubDate>2025-12-22T14:15:18.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586482860104204315" data-draft-id="7586506307727065098" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="HarmonyOS ArkTS 实战：阅读器顶部栏“高度收缩 + 背景透明度过渡”（@AnimatableExtend 方案，能直接抄）"/> <meta itemprop="keywords" content="HarmonyOS"/> <meta itemprop="datePublished" content="2025-12-22T14:15:18.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="帅哥一天八碗米饭"/> <meta itemprop="url" content="https://juejin.cn/user/4026886813920339"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            HarmonyOS ArkTS 实战：阅读器顶部栏“高度收缩 + 背景透明度过渡”（@AnimatableExtend 方案，能直接抄）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4026886813920339/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    帅哥一天八碗米饭
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T14:15:18.000Z" title="Mon Dec 22 2025 14:15:18 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">HarmonyOS ArkTS 实战：阅读器顶部栏“高度收缩 + 背景透明度过渡”（<code>@AnimatableExtend</code> 方案，能直接抄）</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.huawei.com%2Fconsumer%2Fcn%2Ftraining%2FclassDetail%2F4109a3b759684c5386806e1fe6db5988%3Ftype%3D1%253Fha_source%253Dhmosclass%26ha_sourceId%3D89000248" target="_blank" title="https://developer.huawei.com/consumer/cn/training/classDetail/4109a3b759684c5386806e1fe6db5988?type=1%3Fha_source%3Dhmosclass&amp;ha_sourceId=89000248" ref="nofollow noopener noreferrer">一起来构建生态吧~</a></p>
<blockquote>
<p>需求场景很典型：阅读器页面一滚动，顶部栏从“有点高、信息完整”逐步收缩成“更薄、更沉浸”；同时背景从透明慢慢变成不透明（避免内容顶到状态栏后看不清）。</p>
<p>这类动效如果用“手动 onScroll 改样式”，很容易出现：跳变、卡顿、代码散。 我这里给你一套更工程化的写法： <strong>用 <code>@AnimatableExtend</code> 把“高度”和“背景透明度”都做成可动画参数</strong>，你只负责给目标值，系统负责补间过渡。</p>
</blockquote>
<hr/>
<h3 data-id="heading-1">1. 效果目标（先把体验说清楚）</h3>
<p>我们把顶部栏拆成两个维度：</p>
<h4 data-id="heading-2">1）高度收缩（Height）</h4>
<ul>
<li>初始：比如 <strong>64</strong></li>
<li>收缩后：比如 <strong>44</strong></li>
<li>滚动时随进度线性变化（或你自己换曲线）</li>
</ul>
<h4 data-id="heading-3">2）背景透明度（Alpha）</h4>
<ul>
<li>初始：<strong>0</strong>（完全透明，沉浸）</li>
<li>收缩后：<strong>1</strong>（完全不透明，保证可读性）</li>
<li>同样随滚动进度变化</li>
</ul>
<p>同时再加两个“人写出来的细节”：</p>
<ul>
<li><strong>标题渐隐 / 渐显</strong>：大标题在展开态更明显，收缩后变淡或缩小</li>
<li><strong>阴影出现</strong>：背景变实后加一点阴影，像真实 App 顶部栏一样“压住内容”</li>
</ul>
<hr/>
<h3 data-id="heading-4">2. 整体结构（别急着写动画，先搭骨架）</h3>
<p>我建议阅读器页结构像这样（你之前有 Web 阅读器，照样适用）：</p>
<pre><code class="hljs language-sql" lang="sql"> Stack（全屏）
 ├── 内容层（Web <span class="hljs-operator">/</span> List <span class="hljs-operator">/</span> <span class="hljs-keyword">Scroll</span>）
 └── 顶部栏（<span class="hljs-keyword">Overlay</span>，永远浮在最上）
</code></pre>
<p>顶部栏用 <code>Stack</code>/<code>Row</code> 都行，关键是： <strong>它不参与内容布局</strong>（不然高度变化会挤压内容，体验很怪）。</p>
<hr/>
<h3 data-id="heading-5">3. 核心思路：用 1 个“折叠进度”驱动一切</h3>
<p>我们定义一个折叠进度 <code>collapseT</code>：</p>
<ul>
<li>取值范围：<code>0 ~ 1</code></li>
<li><code>0</code>：完全展开</li>
<li><code>1</code>：完全收缩</li>
</ul>
<p>然后把所有视觉变化都变成数学映射：</p>
<ul>
<li><code>height = lerp(expandedH, collapsedH, collapseT)</code></li>
<li><code>alpha = lerp(0, 1, collapseT)</code></li>
<li><code>titleOpacity = 1 - collapseT</code>（或者更柔一点）</li>
<li><code>shadowOpacity = collapseT</code></li>
</ul>
<p>这样代码会特别干净： <strong>滚动只负责更新 collapseT，其它都是派生出来的。</strong></p>
<hr/>
<h3 data-id="heading-6">4. 关键：<code>@AnimatableExtend</code> 两个扩展方法</h3>
<blockquote>
<p>为什么要用 <code>@AnimatableExtend</code>？ 因为你会发现：有些属性你想“丝滑过渡”，直接写 <code>.height()</code> <code>.backgroundColor()</code> 并不一定能跟你预期一样顺。 用 <code>@AnimatableExtend</code> 的思路是： <strong>让参数可动画，参数每帧变化，你每帧把它应用到组件属性上。</strong></p>
</blockquote>
<h4 data-id="heading-7">4.1 扩展 1：可动画高度</h4>
<pre><code class="hljs language-java" lang="java"> <span class="hljs-meta">@AnimatableExtend(Column)</span>
 function <span class="hljs-title function_">animHeight</span><span class="hljs-params">(h: number)</span> {
   <span class="hljs-built_in">this</span>.height(h)
 }
</code></pre>
<blockquote>
<p>这里我扩展在 <code>Column</code> 上，是因为顶部栏我会用 <code>Column/Row/Stack</code> 包一层。 你也可以写 <code>@AnimatableExtend(Stack)</code> 或 <code>@AnimatableExtend(Row)</code>，看你实际结构。</p>
</blockquote>
<h4 data-id="heading-8">4.2 扩展 2：可动画背景透明度（用 alpha 控制）</h4>
<p>背景透明度最稳的做法： <strong>用 <code>rgba</code>（或 Color + alpha 的方式）生成颜色</strong>，把 alpha 作为动画参数。</p>
<pre><code class="hljs language-typescript" lang="typescript"> <span class="hljs-meta">@AnimatableExtend</span>(<span class="hljs-title class_">Stack</span>)
 <span class="hljs-keyword">function</span> <span class="hljs-title function_">animBgAlpha</span>(<span class="hljs-params">alpha: <span class="hljs-built_in">number</span></span>) {
   <span class="hljs-comment">// alpha: 0~1</span>
   <span class="hljs-comment">// 用 RGBA 生成颜色（下面是白底示例，你可以换成你的主题色）</span>
   <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">`rgba(255, 255, 255, <span class="hljs-subst">${alpha}</span>)`</span>)
 }
</code></pre>
<blockquote>
<p>注意：有的同学会直接在 stateStyles 里写背景，但我们这里是“连续渐变”，更适合用 animatable 参数驱动。</p>
</blockquote>
<hr/>
<h3 data-id="heading-9">5. 完整示例：阅读器页（滚动驱动顶部栏动效）</h3>
<blockquote>
<p>这里我用 <code>Scroll</code> + <code>Column</code> 模拟内容滚动。 你如果是 <code>Web</code>，只要把“滚动位置 scrollTop / progress”换成你 Web 上报的值即可（你前面已经做过 onMessage 上报进度，那套能直接接）。</p>
</blockquote>
<h4 data-id="heading-10">5.1 关键工具函数：lerp + clamp</h4>
<pre><code class="hljs language-typescript" lang="typescript"> <span class="hljs-keyword">function</span> <span class="hljs-title function_">clamp01</span>(<span class="hljs-params">x: <span class="hljs-built_in">number</span></span>): <span class="hljs-built_in">number</span> {
   <span class="hljs-keyword">if</span> (x &lt; <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>
   <span class="hljs-keyword">if</span> (x &gt; <span class="hljs-number">1</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>
   <span class="hljs-keyword">return</span> x
 }
 ​
 <span class="hljs-keyword">function</span> <span class="hljs-title function_">lerp</span>(<span class="hljs-params">a: <span class="hljs-built_in">number</span>, b: <span class="hljs-built_in">number</span>, t: <span class="hljs-built_in">number</span></span>): <span class="hljs-built_in">number</span> {
   <span class="hljs-keyword">return</span> a + (b - a) * t
 }
</code></pre>
<h4 data-id="heading-11">5.2 页面代码（可直接抄，逻辑尽量写得像真实项目）</h4>
<pre><code class="hljs language-scss" lang="scss"> <span class="hljs-keyword">@Entry</span>
 <span class="hljs-keyword">@Component</span>
 struct ReaderPage {
   <span class="hljs-comment">// 顶部栏展开/收缩配置（你可以按设计稿改）</span>
   private readonly expandedH: number = <span class="hljs-number">64</span>
   private readonly collapsedH: number = <span class="hljs-number">44</span>
 ​
   // 这个是“动画目标值”，我们只改它，不直接改 UI
   @State private collapseT: number = <span class="hljs-number">0</span>
 ​
   // 真实滚动高度（示例用 scrollY 近似）
   @State private scrollY: number = <span class="hljs-number">0</span>
 ​
   // 当 scrollY 到达这个阈值时，顶部栏基本收缩完成
   private readonly collapseRange: number = <span class="hljs-number">120</span>
 ​
   <span class="hljs-built_in">build</span>() {
     <span class="hljs-built_in">Stack</span>() {
       <span class="hljs-comment">// ========= 内容层 =========</span>
       Scroll() {
         <span class="hljs-built_in">Column</span>({ space: <span class="hljs-number">12</span> }) {
           <span class="hljs-comment">// 模拟内容</span>
           <span class="hljs-built_in">ForEach</span>(new Array(<span class="hljs-number">60</span>)<span class="hljs-selector-class">.fill</span>(<span class="hljs-number">0</span>)<span class="hljs-selector-class">.map</span>((_, i) =&gt; <span class="hljs-selector-tag">i</span>), (i: number) =&gt; {
             Text(`第 ${i + <span class="hljs-number">1</span>} 段内容：这里模拟阅读器正文...`)
               <span class="hljs-selector-class">.fontSize</span>(<span class="hljs-number">16</span>)
               <span class="hljs-selector-class">.fontColor</span>('#<span class="hljs-number">222</span>')
               <span class="hljs-selector-class">.padding</span>({ left: <span class="hljs-number">16</span>, right: <span class="hljs-number">16</span>, top: <span class="hljs-number">8</span>, bottom: <span class="hljs-number">8</span> })
           })
         }
         <span class="hljs-selector-class">.padding</span>({ top: this.expandedH + <span class="hljs-number">8</span> }) <span class="hljs-comment">// 给内容让出顶部栏空间（很关键！）</span>
       }
       <span class="hljs-selector-class">.onScroll</span>((xOffset: number, yOffset: number) =&gt; {
         this<span class="hljs-selector-class">.scrollY</span> = yOffset
 ​
         <span class="hljs-comment">// 把滚动距离映射成 0~1</span>
         const t = <span class="hljs-built_in">clamp01</span>(yOffset / this.collapseRange)
 ​
         <span class="hljs-comment">// 只更新目标值，让动画系统去补间</span>
         <span class="hljs-comment">// 这里用 animateTo 更“人写”，可控性更好</span>
         <span class="hljs-built_in">animateTo</span>({ duration: <span class="hljs-number">220</span>, curve: Curve.EaseInOut }, () =&gt; {
           this<span class="hljs-selector-class">.collapseT</span> = t
         })
       })
 ​
       <span class="hljs-comment">// ========= 顶部栏（覆盖层） =========</span>
       this<span class="hljs-selector-class">.TopBar</span>()
     }
     <span class="hljs-selector-class">.width</span>('<span class="hljs-number">100%</span>')
     <span class="hljs-selector-class">.height</span>('<span class="hljs-number">100%</span>')
     <span class="hljs-selector-class">.backgroundColor</span>('#F6F7F9')
   }
 ​
   <span class="hljs-keyword">@Builder</span>
   TopBar() {
     <span class="hljs-comment">// 派生：高度与背景透明度</span>
     const h = <span class="hljs-built_in">lerp</span>(this.expandedH, this.collapsedH, this.collapseT)
     const bgAlpha = <span class="hljs-built_in">lerp</span>(<span class="hljs-number">0.0</span>, <span class="hljs-number">1.0</span>, this.collapseT)
     const titleOpacity = <span class="hljs-built_in">lerp</span>(<span class="hljs-number">1.0</span>, <span class="hljs-number">0.0</span>, this.collapseT)      <span class="hljs-comment">// 大标题渐隐</span>
     const smallTitleOpacity = <span class="hljs-built_in">lerp</span>(<span class="hljs-number">0.0</span>, <span class="hljs-number">1.0</span>, this.collapseT) <span class="hljs-comment">// 小标题渐显</span>
     const shadowAlpha = <span class="hljs-built_in">lerp</span>(<span class="hljs-number">0.0</span>, <span class="hljs-number">0.12</span>, this.collapseT)      <span class="hljs-comment">// 阴影随收缩出现</span>
 ​
     <span class="hljs-built_in">Stack</span>() {
       <span class="hljs-comment">// 顶部栏内容</span>
       <span class="hljs-built_in">Row</span>() {
         Text('返回')
           <span class="hljs-selector-class">.fontSize</span>(<span class="hljs-number">14</span>)
           <span class="hljs-selector-class">.fontColor</span>('#<span class="hljs-number">2</span>F7BFF')
           <span class="hljs-selector-class">.padding</span>(<span class="hljs-number">8</span>)
           <span class="hljs-selector-class">.onClick</span>(() =&gt; {
             <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> router back</span>
           })
 ​
         <span class="hljs-built_in">Blank</span>()
 ​
         <span class="hljs-comment">// 收缩后显示的小标题（更像真实阅读器）</span>
         Text('章节标题')
           <span class="hljs-selector-class">.fontSize</span>(<span class="hljs-number">16</span>)
           <span class="hljs-selector-class">.fontWeight</span>(FontWeight.Medium)
           <span class="hljs-selector-class">.fontColor</span>('#<span class="hljs-number">222</span>')
           <span class="hljs-selector-class">.opacity</span>(smallTitleOpacity)
 ​
         <span class="hljs-built_in">Blank</span>()
 ​
         Text('目录')
           <span class="hljs-selector-class">.fontSize</span>(<span class="hljs-number">14</span>)
           <span class="hljs-selector-class">.fontColor</span>('#<span class="hljs-number">2</span>F7BFF')
           <span class="hljs-selector-class">.padding</span>(<span class="hljs-number">8</span>)
           <span class="hljs-selector-class">.onClick</span>(() =&gt; {
             <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> open chapter list</span>
           })
       }
       <span class="hljs-selector-class">.padding</span>({ left: <span class="hljs-number">12</span>, right: <span class="hljs-number">12</span> })
       <span class="hljs-selector-class">.height</span>('<span class="hljs-number">100%</span>')
       <span class="hljs-selector-class">.alignItems</span>(VerticalAlign.Center)
 ​
       <span class="hljs-comment">// 展开态的大标题（更沉浸、更像“阅读页顶部信息”）</span>
       <span class="hljs-built_in">Column</span>() {
         Text('书名 / 阅读器')
           <span class="hljs-selector-class">.fontSize</span>(<span class="hljs-number">20</span>)
           <span class="hljs-selector-class">.fontWeight</span>(FontWeight.Bold)
           <span class="hljs-selector-class">.fontColor</span>('#<span class="hljs-number">111</span>')
           <span class="hljs-selector-class">.opacity</span>(titleOpacity)
       }
       <span class="hljs-selector-class">.position</span>({ x: <span class="hljs-number">16</span>, y: <span class="hljs-number">10</span> })
     }
     <span class="hljs-comment">// 关键：可动画高度 + 可动画背景透明度</span>
     <span class="hljs-selector-class">.animHeight</span>(h)
     <span class="hljs-selector-class">.animBgAlpha</span>(bgAlpha)
     <span class="hljs-comment">// 轻微阴影：背景变实的时候出现一点压住正文的感觉</span>
     <span class="hljs-selector-class">.shadow</span>({
       radius: <span class="hljs-number">12</span>,
       color: `rgba(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,${shadowAlpha})`,
       offsetX: <span class="hljs-number">0</span>,
       offsetY: <span class="hljs-number">6</span>
     })
     <span class="hljs-selector-class">.width</span>('<span class="hljs-number">100%</span>')
     <span class="hljs-selector-class">.position</span>({ x: <span class="hljs-number">0</span>, y: <span class="hljs-number">0</span> })
   }
 }
</code></pre>
<hr/>
<h3 data-id="heading-12">6. 这段代码里最容易忽略的“真实细节”</h3>
<h4 data-id="heading-13">6.1 内容顶部 padding 必须给出来</h4>
<p>你看到我这里写了：</p>
<pre><code class="hljs language-css" lang="css"> <span class="hljs-selector-class">.padding</span>({ <span class="hljs-attribute">top</span>: this.expandedH + <span class="hljs-number">8</span> })
</code></pre>
<p>这是很现实的问题： 顶部栏是 overlay，如果内容不让空间，正文会被盖住，看起来像“顶到状态栏”，体验会很差。</p>
<blockquote>
<p>你也可以做得更精细：padding 跟着顶部栏高度动态变化。 但一般阅读器里为了稳定，直接用展开高度固定 padding 就够用。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI帮我搭猫窝：一场空间推理能力的实战测评]]></title>    <link>https://juejin.cn/post/7586579021283409974</link>    <guid>https://juejin.cn/post/7586579021283409974</guid>    <pubDate>2025-12-23T01:57:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586579021283409974" data-draft-id="7586579021283393590" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI帮我搭猫窝：一场空间推理能力的实战测评"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-12-23T01:57:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="飞哥数智谈"/> <meta itemprop="url" content="https://juejin.cn/user/3825956195409223"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI帮我搭猫窝：一场空间推理能力的实战测评
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3825956195409223/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    飞哥数智谈
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T01:57:04.000Z" title="Tue Dec 23 2025 01:57:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>我家里有两只“猪咪”，它们的窝被自己压坏了，加上冬天地上有些凉，就想着亲手给它们打造一个坚固、悬空的猫窝/猫架。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9f3f5b9c46b040549b749b252f9ae2cd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767059824&amp;x-signature=lfNB2N6Lx%2Fo2UOD72VyvaW338q4%3D" alt="" loading="lazy"/></p>
<p>X书搜了下，实践的人倒是不少，就是教程的材料购买写的不是那么清楚，还需要我自己计算需要几根管，各是多长的。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5df3c341110c44e9933ef6592bd804be~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767059824&amp;x-signature=hm30JyvVxEyf26lHe0edifHhvL4%3D" alt="图侵删" loading="lazy"/></p>
<p>对于我这种“懒”人，肯定要去“压迫” AI 了。</p>
<h2 data-id="heading-0">失败的尝试</h2>
<p>本来，我以为这个问题很简单，图一传，指令简单一写就搞定了。</p>
<p>不出意外地发生了意外。</p>
<p>先来看下提示词，为了更好地对比，后续所有 AI 的提示词都是一致的。</p>
<pre><code class="hljs">我要使用pvc制作如图的猫窝，请帮我编制原材料采购清单，整个猫窝大概50cmx50cmx60cm
</code></pre>
<h3 data-id="heading-1">千问</h3>
<p>竟然只需要<code>4根立柱</code>+<code>4根横梁</code>，这出来的东西，自己都站不住吧。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ffe21cef70094ea98191a842a757c73f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767059824&amp;x-signature=L8k%2FiqWZbrKoMCx5vJXn6VS61ZY%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-2">豆包</h3>
<p><code>PVC</code> 管倒是分析的还行，就是连接件肯定没法连接上这几根管。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/618358d5aac24665b61ac296a3f77411~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767059824&amp;x-signature=Jv1yOoVNgDH%2Bja8cOuu59fTf9Bw%3D" alt="" loading="lazy"/></p>
<p>国内的不行，我试试国外的。</p>
<h3 data-id="heading-3">GPT-5.2</h3>
<p>正好前几天 <code>OpenAI</code> 发布了 <code>GPT-5.2</code>，我尝试了编程场景还不错，今天试试空间能力如何。</p>
<p>采用的 <code>TRAE</code> 下的 <code>GPT-5.2</code>。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2a893b783f624d30a13e8fb2de99a11a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767059824&amp;x-signature=VlOnlxHHhmRX28C9MS5VycFxvLQ%3D" alt="" loading="lazy"/></p>
<p>整体理解没什么太大问题，硬管的分析也比较正确。</p>
<p>但整个结构提出了 2 种方案，可以说是 <code>GPT</code> 比较保守，也可以理解为识别的不是特别准确。</p>
<p>并且，对于接口构件的知识有所欠缺，比如竟然不用专业名词“立体三通”，这让我买东西的时候怎么给商家说。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dcd76626a7d048ca9d8b3f4c117dcf27~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767059824&amp;x-signature=YyzTAJ1%2BN1%2Bj0onijMSY2kQro4k%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-4">成功的尝试</h2>
<p>最终，我又尝试了空间感超强的 <code>Gemini 3 Pro</code>。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1b01719c11c4468d8608be5226ade974~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767059824&amp;x-signature=lqoAl5rAT%2Ba1oItEoUIP2ETi1F4%3D" alt="" loading="lazy"/></p>
<p>硬管的数量、尺寸，都没什么问题。</p>
<p>立柱采用了两节的方式，并且分别计算出了正确的长度。</p>
<p>甚至，连接头本身的<strong>多余尺寸</strong>都考虑到了。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d473ce04ddb64e60beae2a83fe73e773~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767059824&amp;x-signature=BUDwRhsYoWAUT%2B4QPdI0lAMmOpE%3D" alt="" loading="lazy"/></p>
<p>确实厉害。</p>
<h2 data-id="heading-5">更进一步的尝试</h2>
<p>既然，<code>Gemini 3 Pro</code> 这么厉害，那我就忍不住想试试再难一点的了。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/edcff4160a914d3ba153b6ce72d4efa0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767059824&amp;x-signature=MCdWL%2FrUx%2BPCoaKfl3YzKlivkQk%3D" alt="图侵删" loading="lazy"/></p>
<p>找了个稍微<strong>异形</strong>一点的。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/76d7a356d7ea4424be503e39b362e6a1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767059824&amp;x-signature=dBWizNnFOzMrgpTdr2XmCuKjCTI%3D" alt="" loading="lazy"/></p>
<p>硬管数量、长度依然正确。</p>
<p>甚至连异形所需的“立体三通”，“45度弯头”都是对的。</p>
<p>唯一一个不太完美的就是“垂直立柱”的上下段拆分长度（20cm+20cm）不太完美。</p>
<p>不过，依然非常惊艳。</p>
<h2 data-id="heading-6">结语</h2>
<p>本来只是想简单的偷点懒，没想到各 <code>AI</code> 的空间理解能力相差竟然如此之大。</p>
<p>还好最终 <code>Gemini 3 Pro</code> 给出了比较完美的结果。不然，今天猫窝的原料采购都搞不完了。</p>
<p>现有 AI 肯定不能完全搞定全部事情，因此，我们需要不断尝试并了解各个 AI 的脾性，这样才能更好地利用 AI 能力帮我们解决问题。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[HarmonyOS ArkTS：自动“缓存池复用监控日志”怎么做]]></title>    <link>https://juejin.cn/post/7586505172815298611</link>    <guid>https://juejin.cn/post/7586505172815298611</guid>    <pubDate>2025-12-22T14:18:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586505172815298611" data-draft-id="7586482860104237083" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="HarmonyOS ArkTS：自动“缓存池复用监控日志”怎么做"/> <meta itemprop="keywords" content="HarmonyOS"/> <meta itemprop="datePublished" content="2025-12-22T14:18:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="帅哥一天八碗米饭"/> <meta itemprop="url" content="https://juejin.cn/user/4026886813920339"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            HarmonyOS ArkTS：自动“缓存池复用监控日志”怎么做
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4026886813920339/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    帅哥一天八碗米饭
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T14:18:23.000Z" title="Mon Dec 22 2025 14:18:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">HarmonyOS ArkTS：自动“缓存池复用监控日志”怎么做</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.huawei.com%2Fconsumer%2Fcn%2Ftraining%2FclassDetail%2F4109a3b759684c5386806e1fe6db5988%3Ftype%3D1%253Fha_source%253Dhmosclass%26ha_sourceId%3D89000248" target="_blank" title="https://developer.huawei.com/consumer/cn/training/classDetail/4109a3b759684c5386806e1fe6db5988?type=1%3Fha_source%3Dhmosclass&amp;ha_sourceId=89000248" ref="nofollow noopener noreferrer">一起来构建生态吧~</a></p>
<blockquote>
<p>先说结论：ArkUI 的 <code>@Reusable</code> <strong>复用池本身不是一个你能直接拿到的对象</strong>，也没有一个官方 API 让你“读出当前池子里有多少个实例”。 所以所谓“监控复用池”，本质上是： ✅ <strong>通过组件生命周期回调 + 统一打点工具</strong>，去<strong>推断</strong>复用发生了多少次、哪些组件在复用、有没有状态没重置导致串数据。</p>
</blockquote>
<p>下面给你一套我在项目里会用的“监控方案”，特点是：</p>
<ul>
<li>侵入性低（加几行就能看到复用情况）</li>
<li>日志清晰（创建 / 复用 / 退出 / 重置）</li>
<li>能按 <code>reuseId</code> 归类统计</li>
<li>能定位“复用导致的脏状态”问题</li>
</ul>
<hr/>
<h3 data-id="heading-1">1）监控目标：我们到底想看到什么？</h3>
<p>我建议至少把这 4 类信息打出来：</p>
<ol start="0">
<li><strong>create</strong>：首次创建（不是复用池拿出来的）</li>
<li><strong>reuse</strong>：从复用池中取出再利用（关键指标）</li>
<li><strong>detach / disappear</strong>：从树上移除/不可见（进入复用池的前置条件）</li>
<li><strong>state reset</strong>：复用时你做了哪些重置（防串数据）</li>
</ol>
<p>然后统计两个核心指标：</p>
<ul>
<li><code>reuseRate = reuseCount / (createCount + reuseCount)</code></li>
<li><code>activeCount</code>：当前在树上的实例数（帮助判断列表滚动时是否稳定）</li>
</ul>
<hr/>
<h3 data-id="heading-2">2）核心思路：做一个全局 ReusePoolMonitor（只管日志和计数）</h3>
<p>新建一个文件：</p>
<pre><code class="hljs language-typescript" lang="typescript"> entry/src/main/ets/utils/<span class="hljs-title class_">ReusePoolMonitor</span>.<span class="hljs-property">ts</span>
 <span class="hljs-comment">// entry/src/main/ets/utils/ReusePoolMonitor.ts</span>
 <span class="hljs-keyword">type</span> <span class="hljs-title class_">ReuseEvent</span> =
   | <span class="hljs-string">'create'</span>
   | <span class="hljs-string">'reuse'</span>
   | <span class="hljs-string">'appear'</span>
   | <span class="hljs-string">'disappear'</span>
   | <span class="hljs-string">'reset'</span>;
 ​
 <span class="hljs-keyword">type</span> <span class="hljs-title class_">MonitorKey</span> = <span class="hljs-built_in">string</span>; <span class="hljs-comment">// 通常用: `${reuseId}:${componentName}`</span>
 ​
 <span class="hljs-keyword">interface</span> <span class="hljs-title class_">InstanceInfo</span> {
   <span class="hljs-attr">instanceId</span>: <span class="hljs-built_in">string</span>;     <span class="hljs-comment">// 你自己生成的 id</span>
   <span class="hljs-attr">firstSeenAt</span>: <span class="hljs-built_in">number</span>;
   <span class="hljs-attr">lastEventAt</span>: <span class="hljs-built_in">number</span>;
   lastItemKey?: <span class="hljs-built_in">string</span>;   <span class="hljs-comment">// 业务数据 key（例如 item.id）</span>
 }
 ​
 <span class="hljs-keyword">interface</span> <span class="hljs-title class_">GroupStats</span> {
   <span class="hljs-attr">createCount</span>: <span class="hljs-built_in">number</span>;
   <span class="hljs-attr">reuseCount</span>: <span class="hljs-built_in">number</span>;
   <span class="hljs-attr">appearCount</span>: <span class="hljs-built_in">number</span>;
   <span class="hljs-attr">disappearCount</span>: <span class="hljs-built_in">number</span>;
   <span class="hljs-attr">resetCount</span>: <span class="hljs-built_in">number</span>;
   <span class="hljs-attr">activeInstanceIds</span>: <span class="hljs-title class_">Set</span>&lt;<span class="hljs-built_in">string</span>&gt;;
   <span class="hljs-attr">instances</span>: <span class="hljs-title class_">Map</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-title class_">InstanceInfo</span>&gt;; <span class="hljs-comment">// instanceId -&gt; info</span>
 }
 ​
 <span class="hljs-keyword">class</span> <span class="hljs-title class_">ReusePoolMonitor</span> {
   <span class="hljs-keyword">private</span> <span class="hljs-attr">groups</span>: <span class="hljs-title class_">Map</span>&lt;<span class="hljs-title class_">MonitorKey</span>, <span class="hljs-title class_">GroupStats</span>&gt; = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
   <span class="hljs-keyword">private</span> <span class="hljs-attr">enabled</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">true</span>;
 ​
   <span class="hljs-title function_">enable</span>(<span class="hljs-params">on: <span class="hljs-built_in">boolean</span></span>) {
     <span class="hljs-variable language_">this</span>.<span class="hljs-property">enabled</span> = on;
   }
 ​
   <span class="hljs-keyword">private</span> <span class="hljs-title function_">getGroup</span>(<span class="hljs-attr">key</span>: <span class="hljs-title class_">MonitorKey</span>): <span class="hljs-title class_">GroupStats</span> {
     <span class="hljs-keyword">let</span> g = <span class="hljs-variable language_">this</span>.<span class="hljs-property">groups</span>.<span class="hljs-title function_">get</span>(key);
     <span class="hljs-keyword">if</span> (!g) {
       g = {
         <span class="hljs-attr">createCount</span>: <span class="hljs-number">0</span>,
         <span class="hljs-attr">reuseCount</span>: <span class="hljs-number">0</span>,
         <span class="hljs-attr">appearCount</span>: <span class="hljs-number">0</span>,
         <span class="hljs-attr">disappearCount</span>: <span class="hljs-number">0</span>,
         <span class="hljs-attr">resetCount</span>: <span class="hljs-number">0</span>,
         <span class="hljs-attr">activeInstanceIds</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>&lt;<span class="hljs-built_in">string</span>&gt;(),
         <span class="hljs-attr">instances</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-title class_">InstanceInfo</span>&gt;(),
       };
       <span class="hljs-variable language_">this</span>.<span class="hljs-property">groups</span>.<span class="hljs-title function_">set</span>(key, g);
     }
     <span class="hljs-keyword">return</span> g;
   }
 ​
   <span class="hljs-title function_">mark</span>(<span class="hljs-params">
     groupKey: MonitorKey,
     event: ReuseEvent,
     payload: { instanceId: <span class="hljs-built_in">string</span>; itemKey?: <span class="hljs-built_in">string</span>; extra?: <span class="hljs-built_in">string</span> } = { instanceId: <span class="hljs-string">'unknown'</span> }
   </span>) {
     <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">enabled</span>) <span class="hljs-keyword">return</span>;
 ​
     <span class="hljs-keyword">const</span> now = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
     <span class="hljs-keyword">const</span> g = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getGroup</span>(groupKey);
 ​
     <span class="hljs-comment">// 维护实例信息</span>
     <span class="hljs-keyword">let</span> info = g.<span class="hljs-property">instances</span>.<span class="hljs-title function_">get</span>(payload.<span class="hljs-property">instanceId</span>);
     <span class="hljs-keyword">if</span> (!info) {
       info = {
         <span class="hljs-attr">instanceId</span>: payload.<span class="hljs-property">instanceId</span>,
         <span class="hljs-attr">firstSeenAt</span>: now,
         <span class="hljs-attr">lastEventAt</span>: now,
         <span class="hljs-attr">lastItemKey</span>: payload.<span class="hljs-property">itemKey</span>,
       };
       g.<span class="hljs-property">instances</span>.<span class="hljs-title function_">set</span>(payload.<span class="hljs-property">instanceId</span>, info);
     } <span class="hljs-keyword">else</span> {
       info.<span class="hljs-property">lastEventAt</span> = now;
       <span class="hljs-keyword">if</span> (payload.<span class="hljs-property">itemKey</span> !== <span class="hljs-literal">undefined</span>) info.<span class="hljs-property">lastItemKey</span> = payload.<span class="hljs-property">itemKey</span>;
     }
 ​
     <span class="hljs-comment">// 统计</span>
     <span class="hljs-keyword">switch</span> (event) {
       <span class="hljs-keyword">case</span> <span class="hljs-string">'create'</span>:
         g.<span class="hljs-property">createCount</span>++;
         <span class="hljs-keyword">break</span>;
       <span class="hljs-keyword">case</span> <span class="hljs-string">'reuse'</span>:
         g.<span class="hljs-property">re_toggleReuseCount</span> ? <span class="hljs-literal">null</span> : <span class="hljs-literal">null</span>; <span class="hljs-comment">// 占位避免你复制后误删结构</span>
         g.<span class="hljs-property">reuseCount</span>++;
         <span class="hljs-keyword">break</span>;
       <span class="hljs-keyword">case</span> <span class="hljs-string">'appear'</span>:
         g.<span class="hljs-property">appearCount</span>++;
         g.<span class="hljs-property">activeInstanceIds</span>.<span class="hljs-title function_">add</span>(payload.<span class="hljs-property">instanceId</span>);
         <span class="hljs-keyword">break</span>;
       <span class="hljs-keyword">case</span> <span class="hljs-string">'disappear'</span>:
         g.<span class="hljs-property">disappearCount</span>++;
         g.<span class="hljs-property">activeInstanceIds</span>.<span class="hljs-title function_">delete</span>(payload.<span class="hljs-property">instanceId</span>);
         <span class="hljs-keyword">break</span>;
       <span class="hljs-keyword">case</span> <span class="hljs-string">'reset'</span>:
         g.<span class="hljs-property">resetCount</span>++;
         <span class="hljs-keyword">break</span>;
     }
 ​
     <span class="hljs-comment">// 日志输出（格式尽量“人能看懂”）</span>
     <span class="hljs-keyword">const</span> itemPart = payload.<span class="hljs-property">itemKey</span> !== <span class="hljs-literal">undefined</span> ? <span class="hljs-string">` itemKey=<span class="hljs-subst">${payload.itemKey}</span>`</span> : <span class="hljs-string">''</span>;
     <span class="hljs-keyword">const</span> extraPart = payload.<span class="hljs-property">extra</span> ? <span class="hljs-string">` <span class="hljs-subst">${payload.extra}</span>`</span> : <span class="hljs-string">''</span>;
     <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(
       <span class="hljs-string">`[ReusableMonitor] [<span class="hljs-subst">${groupKey}</span>] <span class="hljs-subst">${event}</span> instance=<span class="hljs-subst">${payload.instanceId}</span><span class="hljs-subst">${itemPart}</span> active=<span class="hljs-subst">${g.activeInstanceIds.size}</span><span class="hljs-subst">${extraPart}</span>`</span>
     );
   }
 ​
   <span class="hljs-title function_">snapshot</span>(<span class="hljs-params">groupKey?: MonitorKey</span>) {
     <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">enabled</span>) <span class="hljs-keyword">return</span>;
 ​
     <span class="hljs-keyword">const</span> keys = groupKey ? [groupKey] : <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">groups</span>.<span class="hljs-title function_">keys</span>());
     keys.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">k</span>) =&gt;</span> {
       <span class="hljs-keyword">const</span> g = <span class="hljs-variable language_">this</span>.<span class="hljs-property">groups</span>.<span class="hljs-title function_">get</span>(k);
       <span class="hljs-keyword">if</span> (!g) <span class="hljs-keyword">return</span>;
 ​
       <span class="hljs-keyword">const</span> total = g.<span class="hljs-property">createCount</span> + g.<span class="hljs-property">reuseCount</span>;
       <span class="hljs-keyword">const</span> reuseRate = total === <span class="hljs-number">0</span> ? <span class="hljs-number">0</span> : (g.<span class="hljs-property">reuseCount</span> / total) * <span class="hljs-number">100</span>;
 ​
       <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(
         <span class="hljs-string">`[ReusableMonitor] [<span class="hljs-subst">${k}</span>] SNAPSHOT create=<span class="hljs-subst">${g.createCount}</span> reuse=<span class="hljs-subst">${g.reuseCount}</span> reuseRate=<span class="hljs-subst">${reuseRate.toFixed(
           <span class="hljs-number">1</span>
         )}</span>% appear=<span class="hljs-subst">${g.appearCount}</span> disappear=<span class="hljs-subst">${g.disappearCount}</span> reset=<span class="hljs-subst">${g.resetCount}</span> active=<span class="hljs-subst">${g.activeInstanceIds.size}</span> knownInstances=<span class="hljs-subst">${g.instances.size}</span>`</span>
       );
     });
   }
 }
 ​
 <span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> reuseMonitor = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReusePoolMonitor</span>();
</code></pre>
<blockquote>
<p>说明：上面我用的是“推断式监控”。你只要在生命周期里调用 <code>reuseMonitor.mark(...)</code>，就能看到复用是否发生、发生频率如何。</p>
</blockquote>
<hr/>
<h3 data-id="heading-3">3）在 <code>@Reusable</code> 组件里接入监控（关键：实例 ID + itemKey）</h3>
<h4 data-id="heading-4">3.1 一个可复用的列表项组件（带监控日志）</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"> <span class="hljs-comment">// entry/src/main/ets/components/BookRow.ets</span>
 ​
 <span class="hljs-keyword">import</span> { reuseMonitor } from <span class="hljs-string">'../utils/ReusePoolMonitor'</span>;
 ​
 <span class="hljs-meta">@Reusable</span>
 <span class="hljs-meta">@Component</span>
 export struct BookRow {
   <span class="hljs-comment">// 业务入参：列表数据</span>
   <span class="hljs-meta">@Prop</span> itemId: string = <span class="hljs-string">''</span>
   <span class="hljs-meta">@Prop</span> title: string = <span class="hljs-string">''</span>
 ​
   <span class="hljs-comment">// 给每个组件实例一个固定的 id（用于追踪同一个实例被复用多少次）</span>
   <span class="hljs-keyword">private</span> instanceId: string = `BookRow#${Math.random().toString(<span class="hljs-number">16</span>).slice(<span class="hljs-number">2</span>)}`;
 ​
   <span class="hljs-comment">// 你组件里可能有 @State，这就是最容易“复用串数据”的地方</span>
   <span class="hljs-meta">@State</span> <span class="hljs-keyword">private</span> highlight: boolean = <span class="hljs-literal">false</span>;
 ​
   aboutToAppear() {
     <span class="hljs-comment">// 说明：aboutToAppear 更像“进树前”，你可以当作 appear</span>
     reuseMonitor.mark(<span class="hljs-string">'BookRow:default'</span>, <span class="hljs-string">'appear'</span>, {
       instanceId: <span class="hljs-keyword">this</span>.instanceId,
       itemKey: <span class="hljs-keyword">this</span>.itemId,
     });
   }
 ​
   aboutToDisappear() {
     reuseMonitor.mark(<span class="hljs-string">'BookRow:default'</span>, <span class="hljs-string">'disappear'</span>, {
       instanceId: <span class="hljs-keyword">this</span>.instanceId,
       itemKey: <span class="hljs-keyword">this</span>.itemId,
     });
   }
 ​
   <span class="hljs-comment">// 复用发生时会走这里（重点）</span>
   aboutToReuse(params: Record&lt;string, <span class="hljs-keyword">object</span>&gt;) {
     <span class="hljs-comment">// params 里通常会带新的入参（不同版本/写法会有差异，你按你项目实际来取）</span>
     <span class="hljs-comment">// 这里我们只演示：复用时重置状态 + 打日志</span>
     reuseMonitor.mark(<span class="hljs-string">'BookRow:default'</span>, <span class="hljs-string">'reuse'</span>, {
       instanceId: <span class="hljs-keyword">this</span>.instanceId,
       itemKey: <span class="hljs-keyword">this</span>.itemId,
       extra: <span class="hljs-string">'(before reset)'</span>,
     });
 ​
     <span class="hljs-comment">// ✅ 复用最关键的一步：重置本地状态，避免串数据</span>
     <span class="hljs-keyword">this</span>.highlight = <span class="hljs-literal">false</span>;
     reuseMonitor.mark(<span class="hljs-string">'BookRow:default'</span>, <span class="hljs-string">'reset'</span>, {
       instanceId: <span class="hljs-keyword">this</span>.instanceId,
       itemKey: <span class="hljs-keyword">this</span>.itemId,
       extra: <span class="hljs-string">'highlight=false'</span>,
     });
   }
 ​
   <span class="hljs-comment">// 首次创建时记录 create（你可以放在 aboutToAppear 的第一次触发里，这里简单起见写在构造逻辑附近不太好判断）</span>
   <span class="hljs-comment">// 实际上：我们用一个小技巧 —— instanceId 初次出现时在 monitor 内会新增实例，你也可以把 “firstSeenAt” 当 create</span>
   <span class="hljs-comment">// 如果你一定要明确 create，可以在 aboutToAppear 里判断一个 flag。</span>
   <span class="hljs-keyword">private</span> createdOnce: boolean = <span class="hljs-literal">false</span>;
 ​
   build() {
     <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.createdOnce) {
       <span class="hljs-keyword">this</span>.createdOnce = <span class="hljs-literal">true</span>;
       reuseMonitor.mark(<span class="hljs-string">'BookRow:default'</span>, <span class="hljs-string">'create'</span>, {
         instanceId: <span class="hljs-keyword">this</span>.instanceId,
         itemKey: <span class="hljs-keyword">this</span>.itemId,
       });
     }
 ​
     Row() {
       Text(<span class="hljs-keyword">this</span>.title)
         .fontSize(<span class="hljs-number">16</span>)
         .fontColor(<span class="hljs-keyword">this</span>.highlight ? <span class="hljs-string">'#2F7BFF'</span> : <span class="hljs-string">'#222'</span>)
       Blank()
       Text(<span class="hljs-keyword">this</span>.itemId)
         .fontSize(<span class="hljs-number">12</span>)
         .fontColor(<span class="hljs-string">'#999'</span>)
     }
     .padding({ left: <span class="hljs-number">16</span>, right: <span class="hljs-number">16</span>, top: <span class="hljs-number">12</span>, bottom: <span class="hljs-number">12</span> })
     .backgroundColor(<span class="hljs-string">'#FFF'</span>)
     .onClick(() =&gt; {
       <span class="hljs-keyword">this</span>.highlight = !<span class="hljs-keyword">this</span>.highlight;
     })
   }
 }
</code></pre>
<blockquote>
<p>你会发现我特别强调 <code>@State</code> 的 reset。 因为复用的 bug，十有八九就是：<strong>上一个 item 的状态残留到了下一个 item</strong>。</p>
</blockquote>
<hr/>
<h3 data-id="heading-5">4）在列表里使用，并且定期打 Snapshot（更像真实排查）</h3>
<pre><code class="hljs language-typescript" lang="typescript"> <span class="hljs-comment">// entry/src/main/ets/pages/ReuseListDemo.ets</span>
 <span class="hljs-keyword">import</span> { reuseMonitor } <span class="hljs-keyword">from</span> <span class="hljs-string">'../utils/ReusePoolMonitor'</span>;
 <span class="hljs-keyword">import</span> { <span class="hljs-title class_">BookRow</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../components/BookRow'</span>;
 ​
 <span class="hljs-meta">@Entry</span>
 <span class="hljs-meta">@Component</span>
 struct <span class="hljs-title class_">ReuseListDemo</span> {
   <span class="hljs-meta">@State</span> <span class="hljs-attr">items</span>: <span class="hljs-title class_">Array</span>&lt;{ <span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span>; <span class="hljs-attr">title</span>: <span class="hljs-built_in">string</span> }&gt; = []
 ​
   <span class="hljs-title function_">aboutToAppear</span>(<span class="hljs-params"/>) {
     <span class="hljs-variable language_">this</span>.<span class="hljs-property">items</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(<span class="hljs-number">200</span>).<span class="hljs-title function_">fill</span>(<span class="hljs-number">0</span>).<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">_, i</span>) =&gt;</span> ({
       <span class="hljs-attr">id</span>: <span class="hljs-string">`ID-<span class="hljs-subst">${i}</span>`</span>,
       <span class="hljs-attr">title</span>: <span class="hljs-string">`第 <span class="hljs-subst">${i + <span class="hljs-number">1</span>}</span> 本书：示例标题`</span>,
     }));
 ​
     <span class="hljs-comment">// 每隔 2 秒输出一次快照（调试用，上线前关掉）</span>
     <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
       reuseMonitor.<span class="hljs-title function_">snapshot</span>(<span class="hljs-string">'BookRow:default'</span>);
     }, <span class="hljs-number">2000</span>);
   }
 ​
   <span class="hljs-title function_">build</span>(<span class="hljs-params"/>) {
     <span class="hljs-title class_">List</span>() {
       <span class="hljs-title class_">ForEach</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">items</span>, <span class="hljs-function">(<span class="hljs-params">it</span>) =&gt;</span> {
         <span class="hljs-title class_">ListItem</span>() {
           <span class="hljs-title class_">BookRow</span>({ <span class="hljs-attr">itemId</span>: it.<span class="hljs-property">id</span>, <span class="hljs-attr">title</span>: it.<span class="hljs-property">title</span> })
             .<span class="hljs-title function_">reuseId</span>(<span class="hljs-string">'BookRow:default'</span>) <span class="hljs-comment">// 复用分组：同组才能复用</span>
         }
       }, <span class="hljs-function">(<span class="hljs-params">it</span>) =&gt;</span> it.<span class="hljs-property">id</span>) <span class="hljs-comment">// key 很重要：帮助框架稳定识别 item</span>
     }
     .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)
     .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)
     .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#F6F7F9'</span>)
   }
 }
</code></pre>
<hr/>
<h3 data-id="heading-6">5）你会看到怎样的日志？怎么读才“有用”？</h3>
<p>你滚动列表时，大致会看到类似：</p>
<pre><code class="hljs language-ini" lang="ini"> <span class="hljs-section">[ReusableMonitor]</span> <span class="hljs-section">[BookRow:default]</span> create <span class="hljs-attr">instance</span>=BookRow<span class="hljs-comment">#9af3 itemKey=ID-0 active=1</span>
 <span class="hljs-section">[ReusableMonitor]</span> <span class="hljs-section">[BookRow:default]</span> appear <span class="hljs-attr">instance</span>=BookRow<span class="hljs-comment">#9af3 itemKey=ID-0 active=1</span>
 ​
 ...滚动...
 ​
 <span class="hljs-section">[ReusableMonitor]</span> <span class="hljs-section">[BookRow:default]</span> disappear <span class="hljs-attr">instance</span>=BookRow<span class="hljs-comment">#9af3 itemKey=ID-0 active=10</span>
 <span class="hljs-section">[ReusableMonitor]</span> <span class="hljs-section">[BookRow:default]</span> reuse <span class="hljs-attr">instance</span>=BookRow<span class="hljs-comment">#9af3 itemKey=ID-20 active=10 (before reset)</span>
 <span class="hljs-section">[ReusableMonitor]</span> <span class="hljs-section">[BookRow:default]</span> reset <span class="hljs-attr">instance</span>=BookRow<span class="hljs-comment">#9af3 itemKey=ID-20 active=10 highlight=false</span>
 <span class="hljs-section">[ReusableMonitor]</span> <span class="hljs-section">[BookRow:default]</span> appear <span class="hljs-attr">instance</span>=BookRow<span class="hljs-comment">#9af3 itemKey=ID-20 active=10</span>
</code></pre>
<p>这行日志的“人话解读”是：</p>
<ul>
<li><code>BookRow#9af3</code> 这个实例原来显示 <code>ID-0</code></li>
<li>滚出屏幕后 <code>disappear</code></li>
<li>再次被拿出来复用显示 <code>ID-20</code></li>
<li>复用时我们重置了 highlight，避免串数据</li>
<li>然后重新 appear</li>
</ul>
<p>快照会输出：</p>
<pre><code class="hljs language-ini" lang="ini"> SNAPSHOT <span class="hljs-attr">create</span>=<span class="hljs-number">12</span> reuse=<span class="hljs-number">180</span> reuseRate=<span class="hljs-number">93.8</span>% appear=... disappear=... reset=<span class="hljs-number">180</span> active=<span class="hljs-number">10</span> knownInstances=<span class="hljs-number">12</span>
</code></pre>
<p>重点看两个数：</p>
<ul>
<li><code>reuseRate</code>：越高说明复用越充分（通常长列表会非常高）</li>
<li><code>knownInstances</code>：基本能近似理解为“池子里曾经创建过多少个实例”（不会无限增长的话，说明复用稳定）</li>
</ul>
<hr/>
<h3 data-id="heading-7">6）最常见的“复用串数据”怎么用日志定位？</h3>
<h4 data-id="heading-8">症状</h4>
<p>你发现某一行高亮了、按钮 disabled 了、进度条停在某个值……但那是上一条数据的状态。</p>
<h4 data-id="heading-9">定位方式（很快）</h4>
<ol start="0">
<li>看日志里同一个 <code>instanceId</code></li>
<li>它从 <code>itemKeyA</code> reuse 到 <code>itemKey=B</code></li>
<li>如果你没看到对应的 <code>reset</code> 日志（或 reset 不完整） → 99% 就是状态没清干净</li>
</ol>
<p>我一般会把 reset 写得很“啰嗦”，调试阶段宁可多打两行：</p>
<ul>
<li>reset highlight</li>
<li>reset progress</li>
<li>reset selected</li>
<li>reset loading</li>
</ul>
<p>调通后再精简。</p>
<hr/>
<h3 data-id="heading-10">7）上线建议：怎么不影响性能？</h3>
<ul>
<li>监控类里加 <code>enable(false)</code> 开关</li>
<li>或者用环境变量控制（Debug 开、Release 关）</li>
<li><code>setInterval(snapshot)</code> 只在调试打开，上线必须关</li>
</ul>
<p>示例：</p>
<pre><code class="hljs language-arduino" lang="arduino"> reuseMonitor.<span class="hljs-built_in">enable</span>(<span class="hljs-literal">false</span>) <span class="hljs-comment">// release 环境</span>
</code></pre>
<hr/>
<h3 data-id="heading-11">8）一句总结</h3>
<p>复用池监控这件事，说白了就是：<strong>你无法直接看池子，但你能看“复用行为”</strong> 。 只要把 <code>create / reuse / disappear / reset</code> 这条链路跑通，再配上按 <code>reuseId</code> 的统计快照，排查性能和串状态问题会省非常多时间。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一文了解 Cookie、localStorage、sessionStorage的区别与实战案例]]></title>    <link>https://juejin.cn/post/7586498198149365811</link>    <guid>https://juejin.cn/post/7586498198149365811</guid>    <pubDate>2025-12-22T14:24:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586498198149365811" data-draft-id="7586482860104269851" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" 一文了解 Cookie、localStorage、sessionStorage的区别与实战案例"/> <meta itemprop="keywords" content="JavaScript,前端"/> <meta itemprop="datePublished" content="2025-12-22T14:24:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="如果你好"/> <meta itemprop="url" content="https://juejin.cn/user/2272012281328215"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             一文了解 Cookie、localStorage、sessionStorage的区别与实战案例
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2272012281328215/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    如果你好
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T14:24:05.000Z" title="Mon Dec 22 2025 14:24:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一文了解 Cookie、localStorage、sessionStorage的区别与实战案例</h2>
<p>在前端开发中，浏览器存储是不可或缺的核心能力，无论是保存用户登录状态、记住主题偏好，还是暂存表单中间数据，都离不开它。而Cookie、localStorage、sessionStorage作为最常用的三种浏览器存储方案，很多开发者在实际项目中容易混淆它们的使用场景。</p>
<p>本文将从核心特性出发，清晰对比三者的区别，再结合Vue框架给出可直接复用的实战代码案例，帮你彻底搞懂何时用哪种存储方案。</p>
<h3 data-id="heading-1">一、核心区别对比（一张表看懂）</h3>
<p>先通过一张对比表，快速掌握三者的核心差异知识点：</p>















































<table><thead><tr><th>特性</th><th>Cookie</th><th>localStorage</th><th>sessionStorage</th></tr></thead><tbody><tr><td>存储容量</td><td>约 4KB（容量较小，适合存储少量数据）</td><td>约 5MB（容量较大，可存储更多本地数据）</td><td>约 5MB（容量较大）</td></tr><tr><td>生命周期</td><td>可手动设置过期时间，默认随会话结束（关闭浏览器）清除</td><td>永久存储，除非手动清除（清除浏览器缓存、代码删除）</td><td>会话级存储，关闭当前标签页即清除（同一浏览器不同标签页不共享）</td></tr><tr><td>作用域</td><td>同源（协议、域名、端口一致）下共享，且自动随每次HTTP请求发送到服务器</td><td>同源下共享，仅通过JS访问，不主动发送给服务器</td><td>同源且同标签页下共享，不同标签页即使同源也不共享</td></tr><tr><td>是否自动发送给服务器</td><td>是（每次请求都会携带，可能增加请求体积）</td><td>否</td><td>否</td></tr><tr><td>访问方式</td><td>JS和服务器均可访问</td><td>仅JS可访问</td><td>仅JS可访问</td></tr><tr><td>典型用途</td><td>会话管理、身份验证（如登录Token）、记住密码</td><td>长期保存用户偏好（如暗黑模式）、本地缓存不敏感数据</td><td>暂存单次会话数据（如多步骤表单中间值、页面临时状态）</td></tr></tbody></table>
<h3 data-id="heading-2">二、Vue实战案例（可直接复用）</h3>
<p>在Vue项目中，不同存储方案的使用方式略有差异，下面结合实际业务场景，给出完整的代码示例。</p>
<h4 data-id="heading-3">1. Cookie：适合存储登录状态等需要和服务器交互的数据</h4>
<p>Cookie原生API使用起来不够便捷，推荐使用 <code>js-cookie</code> 库（轻量、易用），专门用于管理Cookie。</p>
<h5 data-id="heading-4">步骤1：安装依赖</h5>
<pre><code class="hljs language-css" lang="css">npm install js-cookie <span class="hljs-attr">--save</span>
</code></pre>
<h5 data-id="heading-5">步骤2：实战代码（登录状态管理）</h5>
<p>场景：用户登录后保存Token，退出登录时删除Token，页面刷新后保留登录状态。</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"login-container"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>用户登录<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> 
      <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span> 
      <span class="hljs-attr">v-model</span>=<span class="hljs-string">"username"</span> 
      <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"请输入用户名"</span>
      <span class="hljs-attr">class</span>=<span class="hljs-string">"input"</span>
    &gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> 
      <span class="hljs-attr">type</span>=<span class="hljs-string">"password"</span> 
      <span class="hljs-attr">v-model</span>=<span class="hljs-string">"password"</span> 
      <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"请输入密码"</span>
      <span class="hljs-attr">class</span>=<span class="hljs-string">"input"</span>
    &gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"handleLogin"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"btn"</span>&gt;</span>登录<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"handleLogout"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"btn btn-logout"</span>&gt;</span>退出登录<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"token"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"login-status"</span>&gt;</span>当前登录状态：已登录（Token：{{ token }}）<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">v-else</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"login-status"</span>&gt;</span>当前登录状态：未登录<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-comment">// 引入js-cookie库</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Cookies</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'js-cookie'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">name</span>: <span class="hljs-string">'LoginPage'</span>,
  <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">username</span>: <span class="hljs-string">''</span>,
      <span class="hljs-attr">password</span>: <span class="hljs-string">''</span>,
      <span class="hljs-comment">// 初始化时从Cookie获取Token，无则为空</span>
      <span class="hljs-attr">token</span>: <span class="hljs-title class_">Cookies</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'userToken'</span>) || <span class="hljs-string">''</span>
    };
  },
  <span class="hljs-attr">methods</span>: {
    <span class="hljs-title function_">handleLogin</span>(<span class="hljs-params"/>) {
      <span class="hljs-comment">// 模拟接口请求登录（实际项目中替换为真实接口）</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">username</span> &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">password</span>) {
        <span class="hljs-keyword">const</span> mockToken = <span class="hljs-string">'mock_user_token_123456'</span>; <span class="hljs-comment">// 接口返回的Token</span>
        <span class="hljs-comment">// 设置Cookie：key为userToken，值为mockToken，过期时间1天</span>
        <span class="hljs-title class_">Cookies</span>.<span class="hljs-title function_">set</span>(<span class="hljs-string">'userToken'</span>, mockToken, { <span class="hljs-attr">expires</span>: <span class="hljs-number">1</span> });
        <span class="hljs-comment">// 更新本地Token状态</span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">token</span> = mockToken;
        <span class="hljs-title function_">alert</span>(<span class="hljs-string">'登录成功！'</span>);
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-title function_">alert</span>(<span class="hljs-string">'请输入用户名和密码！'</span>);
      }
    },
    <span class="hljs-title function_">handleLogout</span>(<span class="hljs-params"/>) {
      <span class="hljs-comment">// 删除Cookie</span>
      <span class="hljs-title class_">Cookies</span>.<span class="hljs-title function_">remove</span>(<span class="hljs-string">'userToken'</span>);
      <span class="hljs-comment">// 重置状态</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">token</span> = <span class="hljs-string">''</span>;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">username</span> = <span class="hljs-string">''</span>;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">password</span> = <span class="hljs-string">''</span>;
      <span class="hljs-title function_">alert</span>(<span class="hljs-string">'退出登录成功！'</span>);
    }
  }
};
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>


</code></pre>
<h5 data-id="heading-6">核心说明</h5>
<ul>
<li>设置Cookie时，<code>expires: 1</code> 表示1天后过期，也可设置为具体日期（如 <code>new Date('2025-12-31')</code>）；</li>
<li>删除Cookie时，需确保 <code>Cookies.remove()</code> 的key与设置时一致；</li>
<li>适合存储需要和服务器交互的身份信息，因为Cookie会自动随请求发送。</li>
</ul>
<h4 data-id="heading-7">2. localStorage：适合长期保存用户偏好数据</h4>
<p>localStorage原生API已足够简洁，无需额外安装依赖，适合存储长期不失效的本地数据。</p>
<h5 data-id="heading-8">实战代码（主题切换功能）</h5>
<p>场景：用户切换暗黑/亮色主题后，刷新页面依然保留当前主题设置。</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"theme-container"</span> <span class="hljs-attr">:class</span>=<span class="hljs-string">"theme"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>主题切换演示<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>当前主题：{{ theme === 'light' ? '亮色模式' : '暗黑模式' }}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"toggleTheme"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"theme-btn"</span>&gt;</span>切换主题<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">name</span>: <span class="hljs-string">'ThemeSwitch'</span>,
  <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-comment">// 初始化时从localStorage获取主题，无则默认亮色模式</span>
      <span class="hljs-attr">theme</span>: <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(<span class="hljs-string">'appTheme'</span>) || <span class="hljs-string">'light'</span>
    };
  },
  <span class="hljs-attr">methods</span>: {
    <span class="hljs-title function_">toggleTheme</span>(<span class="hljs-params"/>) {
      <span class="hljs-comment">// 切换主题状态</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">theme</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">theme</span> === <span class="hljs-string">'light'</span> ? <span class="hljs-string">'dark'</span> : <span class="hljs-string">'light'</span>;
      <span class="hljs-comment">// 保存主题到localStorage（永久有效，除非手动清除）</span>
      <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">setItem</span>(<span class="hljs-string">'appTheme'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">theme</span>);
    }
  }
};
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

</code></pre>
<h5 data-id="heading-9">核心说明</h5>
<ul>
<li>使用 <code>localStorage.setItem(key, value)</code> 存储数据，<code>localStorage.getItem(key)</code> 获取数据；</li>
<li>数据永久保存，即使关闭浏览器再重新打开，依然能获取到；</li>
<li>适合存储用户偏好、本地缓存数据等不需要和服务器交互的长期数据。</li>
</ul>
<h4 data-id="heading-10">3. sessionStorage：适合暂存会话级临时数据</h4>
<p>sessionStorage的API和localStorage完全一致，但生命周期是会话级，关闭标签页后数据即丢失。</p>
<h5 data-id="heading-11">实战代码（多步骤表单暂存）</h5>
<p>场景：多步骤表单（如注册表单），用户填写完第一步内容后，切换页面再返回，依然保留已填写的内容（关闭标签页后丢失）。</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"form-container"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>多步骤注册表单（步骤1）<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> 
      <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span> 
      <span class="hljs-attr">v-model</span>=<span class="hljs-string">"formData.username"</span> 
      <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"请输入用户名"</span>
      <span class="hljs-attr">class</span>=<span class="hljs-string">"input"</span>
    &gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> 
      <span class="hljs-attr">type</span>=<span class="hljs-string">"tel"</span> 
      <span class="hljs-attr">v-model</span>=<span class="hljs-string">"formData.phone"</span> 
      <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"请输入手机号"</span>
      <span class="hljs-attr">class</span>=<span class="hljs-string">"input"</span>
    &gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"goToNextStep"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"form-btn"</span>&gt;</span>下一步（暂存数据）<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"tip"</span>&gt;</span>提示：关闭当前标签页后，已填写内容将丢失<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">name</span>: <span class="hljs-string">'MultiStepForm'</span>,
  <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-comment">// 初始化时从sessionStorage获取暂存的表单数据，无则为空对象</span>
      <span class="hljs-attr">formData</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(sessionStorage.<span class="hljs-title function_">getItem</span>(<span class="hljs-string">'step1Form'</span>)) || {
        <span class="hljs-attr">username</span>: <span class="hljs-string">''</span>,
        <span class="hljs-attr">phone</span>: <span class="hljs-string">''</span>
      }
    };
  },
  <span class="hljs-attr">watch</span>: {
    <span class="hljs-comment">// 监听formData变化，实时暂存到sessionStorage</span>
    <span class="hljs-attr">formData</span>: {
      <span class="hljs-attr">deep</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 深度监听对象内部属性变化</span>
      <span class="hljs-title function_">handler</span>(<span class="hljs-params">newVal</span>) {
        <span class="hljs-comment">// sessionStorage只能存储字符串，需将对象转为JSON字符串</span>
        sessionStorage.<span class="hljs-title function_">setItem</span>(<span class="hljs-string">'step1Form'</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(newVal));
      }
    }
  },
  <span class="hljs-attr">methods</span>: {
    <span class="hljs-title function_">goToNextStep</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">formData</span>.<span class="hljs-property">username</span> &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">formData</span>.<span class="hljs-property">phone</span>) {
        <span class="hljs-comment">// 模拟跳转到下一步表单（实际项目中用路由跳转）</span>
        <span class="hljs-title function_">alert</span>(<span class="hljs-string">'已暂存步骤1数据，跳转到步骤2'</span>);
        <span class="hljs-comment">// 此处可添加路由跳转代码，如：this.$router.push('/register-step2')</span>
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-title function_">alert</span>(<span class="hljs-string">'请填写完整用户名和手机号！'</span>);
      }
    }
  }
};
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

</code></pre>
<h5 data-id="heading-12">核心说明</h5>
<ul>
<li>API和localStorage一致，但数据仅在当前标签页有效，关闭标签页或打开新标签页均无法获取；</li>
<li>存储对象时，需用 <code>JSON.stringify()</code> 转为字符串，获取时用 <code>JSON.parse()</code> 转回对象；</li>
<li>适合暂存单次会话的临时数据，如多步骤表单、页面临时状态等，无需长期保留的数据。</li>
</ul>
<h3 data-id="heading-13">三、总结：如何选择合适的存储方案？</h3>
<p>最后用一张表快速梳理三种方案的Vue使用场景和核心要点，方便实际开发中快速决策：</p>

























<table><thead><tr><th>存储方式</th><th>Vue中典型使用场景</th><th>核心要点</th></tr></thead><tbody><tr><td>Cookie</td><td>登录状态管理、身份验证（Token）、记住密码</td><td>用js-cookie库简化操作，可设置过期时间，自动随请求发送</td></tr><tr><td>localStorage</td><td>用户主题偏好、本地缓存数据、长期保存的不敏感信息</td><td>原生API简洁，永久存储，需手动清除，不发送给服务器</td></tr><tr><td>sessionStorage</td><td>多步骤表单暂存、页面临时状态、单次会话数据</td><td>API同localStorage，会话级生命周期，关闭标签页即清除</td></tr></tbody></table></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[link和@import有什么区别]]></title>    <link>https://juejin.cn/post/7586500093844111402</link>    <guid>https://juejin.cn/post/7586500093844111402</guid>    <pubDate>2025-12-22T14:24:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586500093844111402" data-draft-id="7586491717873598483" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="link和@import有什么区别"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-22T14:24:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="代码猎人"/> <meta itemprop="url" content="https://juejin.cn/user/624972624037374"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            link和@import有什么区别
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/624972624037374/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    代码猎人
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T14:24:09.000Z" title="Mon Dec 22 2025 14:24:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>这是一个非常经典的前端问题。<code>&lt;link&gt;</code> 和 <code>@import</code> 都是用来引入外部 CSS 文件的方法，但它们在<strong>加载机制、性能、兼容性和控制力</strong>上有显著区别。</p>
<p>简单来说：<strong>现代 Web 开发中，强烈推荐使用 <code>&lt;link&gt;</code> 方法，避免使用 <code>@import</code>。</strong></p>
<p>下面是详细的对比：</p>


















































<table><thead><tr><th>特性</th><th><code>&lt;link&gt;</code> 标签 (HTML)</th><th><code>@import</code> 规则 (CSS)</th></tr></thead><tbody><tr><td><strong>归属</strong></td><td><strong>HTML 标签</strong>，位于 <code>&lt;head&gt;</code> 中。</td><td><strong>CSS 语法</strong>，必须写在 CSS 文件或 <code>&lt;style&gt;</code> 标签的开头。</td></tr><tr><td><strong>语法</strong></td><td><code>&lt;link rel="stylesheet" href="style.css"&gt;</code></td><td><code>@import url("style.css");</code></td></tr><tr><td><strong>加载机制</strong></td><td><strong>并行加载</strong>。浏览器在解析 HTML 时遇到 <code>&lt;link&gt;</code> 会立即发起对该 CSS 文件的请求，不会阻塞 HTML 的继续解析（但会阻塞渲染，以确保样式正确应用）。</td><td><strong>串行加载</strong>。浏览器需要先下载并解析包含 <code>@import</code> 的 CSS 文件，然后才发现并开始下载被导入的 CSS 文件。这会显著增加页面整体加载时间。</td></tr><tr><td><strong>DOM 可控性</strong></td><td><strong>可以被 JavaScript 动态操作</strong>。例如，可以通过 JS 创建、修改或删除 <code>&lt;link&gt;</code> 元素来切换样式表。</td><td><strong>无法用 JavaScript 直接控制或删除</strong>。一旦通过 <code>@import</code> 引入，就很难动态修改。</td></tr><tr><td><strong>兼容性</strong></td><td><strong>完美兼容所有浏览器</strong>（包括非常古老的浏览器）。</td><td>CSS2.1 的特性。在 <strong>IE5+</strong>  上基本支持，但仍有细微的兼容性问题。</td></tr><tr><td><strong>性能影响</strong></td><td><strong>更优</strong>。允许多个 CSS 文件并行下载，有利于加快页面加载速度。</td><td><strong>较差</strong>。容易引起<strong>资源加载的串行化</strong>，导致页面渲染延迟，特别是在网速慢或文件多时。</td></tr><tr><td><strong>预加载扫描器</strong></td><td><strong>可以被捕获</strong>。现代浏览器的“预加载扫描器”会快速扫描 HTML，提前发现 <code>&lt;link&gt;</code> 并开始下载资源。</td><td><strong>无法被捕获</strong>。预加载扫描器通常不解析 CSS 文件内部的 <code>@import</code>，因此无法提前发现这些资源。</td></tr><tr><td><strong>用途限制</strong></td><td>不仅可以引入 CSS，还可以引入网站图标、预加载资源、定义 RSS 源等（通过 <code>rel</code> 属性）。</td><td><strong>仅用于引入 CSS</strong>。</td></tr></tbody></table>
<h3 data-id="heading-0">核心区别详解</h3>
<h4 data-id="heading-1">1. 加载顺序与性能（最关键的区别）</h4>
<ul>
<li><strong><code>&lt;link&gt;</code></strong> ：假设你在 HTML 中写了两个 <code>&lt;link&gt;</code> 标签。浏览器会<strong>同时请求</strong>这两个 CSS 文件。它们和页面的 HTML、图片等资源一起并行下载。</li>
<li><strong><code>@import</code></strong>：假设在 <code>main.css</code> 文件中写了 <code>@import url("imported.css")</code>。浏览器必须先下载 <code>main.css</code>，然后解析它，读到 <code>@import</code> 语句时，才去下载 <code>imported.css</code>。<strong>这形成了一个“请求链”</strong> ，严重拖慢页面渲染速度。如果 <code>imported.css</code> 里又 <code>@import</code> 了其他文件，情况会更糟。</li>
</ul>
<h4 data-id="heading-2">2. 渲染阻塞</h4>
<p>两者都会阻塞渲染，浏览器需要知道样式规则才能正确绘制页面。但 <code>@import</code> 因为其<strong>串行加载</strong>的特性，会导致浏览器开始渲染的时间点更晚。</p>
<h4 data-id="heading-3">3. 如何使用与书写位置</h4>
<ul>
<li><strong><code>&lt;link&gt;</code></strong> ： 写在 HTML 的 <code>&lt;head&gt;</code> 部分。</li>
</ul>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"stylesheet"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"reset.css"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"stylesheet"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"global.css"</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<ul>
<li><strong><code>@import</code></strong>： 写在 CSS 文件或 <code>&lt;style&gt;</code> 块的<strong>最顶端</strong>（在其它规则之前）。</li>
</ul>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 在 global.css 文件中 */</span>
<span class="hljs-keyword">@import</span> url(<span class="hljs-string">"reset.css"</span>); <span class="hljs-comment">/* 必须写在第一行 */</span>
<span class="hljs-keyword">@import</span> url(<span class="hljs-string">"components.css"</span>);

<span class="hljs-selector-tag">body</span> { <span class="hljs-attribute">font-size</span>: <span class="hljs-number">16px</span>; } <span class="hljs-comment">/* 自己的规则写在下面 */</span>
</code></pre>
<h3 data-id="heading-4">结论与最佳实践</h3>
<p><strong>尽量避免使用 <code>@import</code>。</strong></p>
<p><strong>使用 <code>&lt;link&gt;</code> 标签来引入所有主要的 CSS 文件</strong>。这是性能最佳、兼容性最好、也最可控的方式。</p>
<p><strong><code>@import</code> 的合理使用场景</strong>（较少）：</p>
<ol>
<li><strong>在 CSS 预处理器中</strong>： 在 Sass/Less 文件中使用 <code>@import</code> 来合并模块文件是<strong>可以接受且推荐的</strong>，因为预处理器会在编译阶段将这些 <code>@import</code> 的文件合并成一个最终的 CSS 文件输出给浏览器，浏览器最终看到的仍然是一个由 <code>&lt;link&gt;</code> 引入的单一文件，避免了性能问题。</li>
<li><strong>非常特殊的需求</strong>： 例如需要根据某些媒体查询条件来有选择地加载样式表，但又希望将这些逻辑写在 CSS 内。不过，现代 <code>&lt;link&gt;</code> 标签的 <code>media</code> 属性也能很好实现。</li>
</ol>
<p><strong>性能优化进阶</strong>：<br/>
为了进一步优化，可以将多个 CSS 文件在构建阶段（使用 Webpack, Vite, Gulp 等工具）合并、压缩，然后用一个或少数几个 <code>&lt;link&gt;</code> 标签引入，减少 HTTP 请求数。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Figma画布协议揭秘：组件系统的设计哲学]]></title>    <link>https://juejin.cn/post/7586505172815478835</link>    <guid>https://juejin.cn/post/7586505172815478835</guid>    <pubDate>2025-12-22T14:42:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586505172815478835" data-draft-id="7586506307726999562" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Figma画布协议揭秘：组件系统的设计哲学"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-22T14:42:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="听风说图"/> <meta itemprop="url" content="https://juejin.cn/user/198345371681864"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Figma画布协议揭秘：组件系统的设计哲学
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/198345371681864/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    听风说图
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T14:42:23.000Z" title="Mon Dec 22 2025 14:42:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>此前我们介绍了<strong>组件实例的 SymbolOverrides 覆盖机制</strong>，作为今日内容的铺垫，现在我们来深入解析从 Overrides 到 Props 的架构哲学，并将其与前端工程化概念进行对比。</p>
<hr/>
<h2 data-id="heading-0">1. 实例个性化的两条路径：Overrides vs Props</h2>
<p>在Figma的协议中，实现“实例与组件不同”主要有两种机制，它们代表了两种完全不同的设计哲学：</p>
<h3 data-id="heading-1">🔧 <strong>1.1 SymbolOverrides（灵活性设计：直接操作）</strong></h3>
<ul>
<li><strong>机制</strong>：基于路径（Path），类似于jQuery的<code>$('.parent .child').css(...)</code></li>
<li><strong>特点</strong>：</li>
<li>
<ul>
<li><strong>侵入式</strong>：实例必须知道组件内部的结构（GUID Path）</li>
<li><strong>无限灵活</strong>：可以修改组件内部任何未锁定的节点，无需组件作者显式允许</li>
</ul>
</li>
<li><strong>数据结构</strong>：存储在<code>symbolOverrides</code>数组中，包含<code>guidPath</code>和具体的属性覆盖（如<code>textData</code>、<code>fillPaints</code>）</li>
</ul>
<h3 data-id="heading-2">🎯 <strong>1.2 ComponentPropAssignments（现代化设计：API接口）</strong></h3>
<ul>
<li><strong>机制</strong>：基于定义（Definition），类似于React/Vue的<code>&lt;Button label="提交" /&gt;</code></li>
<li><strong>特点</strong>：</li>
<li>
<ul>
<li><strong>封装性</strong>：实例只通过组件暴露的“接口”（Props）进行交互，不关心内部实现</li>
<li><strong>受控</strong>：组件作者决定了哪些属性可以被修改</li>
</ul>
</li>
<li><strong>数据结构</strong>：存储在<code>componentPropAssignments</code>中，直接映射组件定义的属性值</li>
</ul>
<h3 data-id="heading-3">❓ <strong>为什么两者共存？</strong></h3>
<p>如果完全按照前端工程化的思路，应该只保留Props。但在设计工具中：</p>
<blockquote>
<p><strong>避免属性爆炸</strong>：如果每个微小的修改都需要定义Prop，右侧属性面板将变得不可维护。Overrides提供了“所见即所得”的自由。</p>
</blockquote>
<hr/>
<h2 data-id="heading-4">2. 数据流向：扁平化 vs 层级化</h2>
<p>前端开发者习惯于Prop Drilling（属性层层传递），但在Figma中，数据流是扁平化的。</p>
<h3 data-id="heading-5">🤔 <strong>2.1 为什么不做Prop Drilling？</strong></h3>
<p>在可视化工具中，如果组件A包含B，B包含C，要让A控制C的颜色，强制层层定义Props会导致<strong>交互灾难</strong>（每封装一层都要手动Re-export所有属性）。</p>
<h3 data-id="heading-6">💡 <strong>2.2 Figma的解决方案</strong></h3>
<h4 data-id="heading-7"><strong>属性暴露（Bubbling）</strong></h4>
<ul>
<li>对应字段：<code>propsAreBubbled: true</code></li>
<li>机制：允许将深层嵌套实例的属性直接“提升”到最外层面板显示。这不是数据传递，而是控制权提升</li>
</ul>
<h4 data-id="heading-8"><strong>变量系统（Variables）</strong></h4>
<ul>
<li>类似React Context / Vue Provide-Inject</li>
<li>通过绑定全局变量（Design Tokens），实现跨层级的数据共享，跳过中间层</li>
</ul>
<hr/>
<h2 data-id="heading-9">3. 底层机制：消费与映射</h2>
<h3 data-id="heading-10"><strong>3.1 parameterConsumptionMap vs componentPropRefs</strong></h3>
<p>这两个字段都涉及属性绑定，但职责不同：</p>




















<table><thead><tr><th>字段</th><th>职责</th><th>作用域</th></tr></thead><tbody><tr><td><strong>componentPropRefs</strong></td><td>元数据（Metadata）</td><td>主要用于UI显示（如紫色菱形图标）和依赖追踪。是早期的专用设计</td></tr><tr><td><strong>parameterConsumptionMap</strong></td><td>执行（Execution）</td><td>通用的数据消费机制。它告诉渲染引擎如何将“值”（Props/Variables）解析并应用到具体的节点字段（如TEXT_DATA, VISIBLE, INSTANCE_SWAP）</td></tr></tbody></table>
<h3 data-id="heading-11"><strong>3.2 为什么嵌套实例的Props在symbolOverrides里？</strong></h3>
<p>当你修改一个嵌套组件的Prop时，数据结构如下：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-attr">[{  <span class="hljs-string">"symbolOverrides"</span>:[{<span class="hljs-string">"guidPath"</span>:[...]</span>,<span class="hljs-comment">// 1. 寻址：找到内部的那个组件实例 </span>
"<span class="hljs-selector-tag">componentPropAssignments</span>":<span class="hljs-selector-attr">[...]</span><span class="hljs-comment">// 2. 赋值：修改它的Props</span>
}]
</code></pre>
<ul>
<li>顶层属性：直接挂载在实例上（O(1)访问，代表“我自己的配置”）</li>
</ul>

<ul>
<li><strong>嵌套属性</strong>：必须通过<code>symbolOverrides</code>寻址（O(N)查找，代表“对他人的修改”）</li>
</ul>
<hr/>
<h2 data-id="heading-12">4. 渲染流水线（Pipeline）</h2>
<p>理解了上述结构，就能推导出渲染引擎的正确处理顺序：</p>
<ol>
<li><strong>属性解析（Props Resolution）</strong> ：读取<code>componentPropAssignments</code>，确定所有Props的值</li>
<li><strong>结构扩展（Tree Expansion）</strong> ：</li>
<li>
<ul>
<li>关键点：必须先解析Props，因为<code>INSTANCE_SWAP</code>属性会改变子树的结构（决定加载哪个Symbol）</li>
<li>根据解析出的Symbol ID递归生成节点树</li>
</ul>
</li>
<li><strong>覆盖应用（Apply Overrides）</strong> ：</li>
<li>
<ul>
<li>树结构确定后，利用<code>parameterConsumptionMap</code>应用非结构性属性（文本、可见性）</li>
<li>遍历<code>symbolOverrides</code>，通过路径匹配应用手动修改的样式</li>
</ul>
</li>
</ol>
<hr/>
<h2 data-id="heading-13">5. 总结</h2>
<blockquote>
<p>Figma的协议设计是在<strong>工程规范性（Props）</strong> 和<strong>设计灵活性（Overrides）</strong> 之间寻找平衡的结果。它没有照搬代码世界的“单向数据流”，而是通过<strong>属性提升</strong>和<strong>变量上下文</strong>解决了可视化编辑中的效率问题。</p>
</blockquote>
<hr/>
<p><strong>💡 关键洞察</strong>：</p>
<ul>
<li>Overrides是设计工具的特有机制，提供编辑自由</li>
<li>Props借鉴了前端组件化思想，强调封装和可控</li>
<li>扁平化数据流+变量系统是Figma应对复杂性的核心方案</li>
<li>渲染顺序体现了数据结构决定算法设计的经典思想</li>
</ul>
<p><strong>🔮 思考延伸</strong>：这套混合架构是否预示着未来设计工具与开发工具的进一步融合？在低代码/无代码平台中，这种平衡艺术又将如何演进？</p>
<hr/>
<blockquote>
<p>本文深度解析了Figma组件系统的底层设计哲学，希望能帮助你更深刻地理解现代设计工具的架构思考。对于前端开发者来说，这种对比学习也能加深对组件化本质的理解。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[深入理解 Webpack5：从打包到热更新原理]]></title>    <link>https://juejin.cn/post/7586569284551229480</link>    <guid>https://juejin.cn/post/7586569284551229480</guid>    <pubDate>2025-12-23T01:59:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586569284551229480" data-draft-id="7586559672129372212" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="深入理解 Webpack5：从打包到热更新原理"/> <meta itemprop="keywords" content="前端,Webpack"/> <meta itemprop="datePublished" content="2025-12-23T01:59:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="政采云技术"/> <meta itemprop="url" content="https://juejin.cn/user/3456520257288974"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            深入理解 Webpack5：从打包到热更新原理
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3456520257288974/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    政采云技术
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T01:59:42.000Z" title="Tue Dec 23 2025 01:59:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读21分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b637793da67b4e068460a99d94b333ed~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=4722&amp;h=696&amp;s=276733&amp;e=png&amp;b=fafcff" alt="文章顶部.png" loading="lazy"/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9e02b965140a4a3499441e0f1d7b84f4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pS_6YeH5LqR5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767059982&amp;x-signature=kvLbOfragtPb9sggf1gvtnGLBS4%3D" alt="作者卡片" loading="lazy"/></p>
<h2 data-id="heading-0">为什么需要构建工具？</h2>
<h4 data-id="heading-1">一、解决 “高级语法与浏览器兼容性” 的矛盾</h4>
<p>前端技术迭代快（如 ES6+ 的 <code>async/await</code>、箭头函数，CSS 的 <code>grid</code> 布局），但旧浏览器（如 IE11、Safari 10）不支持这些新特性。构建工具通过转译（Transpile）和前缀添加（Prefixing）解决兼容问题：</p>
<ol>
<li>JavaScript 转译</li>
</ol>
<p>发者会使用 ES6+ 及以上语法（如类 <code>class</code>）、TypeScript（类型增强的 JS）、JSX（React 组件语法）等提高开发效率，但这些语法在低版本浏览器或部分现代浏览器中无法直接运行。构建工具（配合 Babel、tsc 等）会将这些高级语法转译为浏览器可识别的 ES5 语法。例如：</p>
<pre><code class="hljs language-css" lang="css">// 开发时写的 ES6 语法
const sum = (<span class="hljs-selector-tag">a</span>, <span class="hljs-selector-tag">b</span>) =&gt; <span class="hljs-selector-tag">a</span> + <span class="hljs-selector-tag">b</span>;
// 构建工具转译后（兼容旧浏览器）
<span class="hljs-selector-tag">var</span> sum = function(<span class="hljs-selector-tag">a</span>, <span class="hljs-selector-tag">b</span>) { return <span class="hljs-selector-tag">a</span> + <span class="hljs-selector-tag">b</span>; };
</code></pre>
<p>2.  CSS 属性添加浏览器前缀</p>
<p>开发者常用 Sass/Less/Stylus 等预处理器（支持变量、嵌套、混入等功能）编写 CSS，或使用 CSS Modules 解决样式冲突，但浏览器只认识原生 CSS。构建工具（配合 <code>sass-loader</code>、<code>postcss</code> 等）会将预处理器语法编译为原生 CSS，同时通过 <code>autoprefixer</code>自动添加浏览器前缀（如 <code>-webkit-</code>、<code>-moz-</code>），适配不同浏览器的 CSS 特性支持。例如：</p>
<pre><code class="hljs language-css" lang="css">// 开发时写的 Sass
$<span class="hljs-attribute">color</span>: red;
<span class="hljs-selector-class">.box</span> {
  <span class="hljs-attribute">color</span>: $color;
  &amp;<span class="hljs-selector-pseudo">:hover</span> { <span class="hljs-attribute">color</span>: blue; }
}
// 构建后生成的 CSS（带前缀）
<span class="hljs-selector-class">.box</span> { <span class="hljs-attribute">color</span>: red; }
<span class="hljs-selector-class">.box</span><span class="hljs-selector-pseudo">:hover</span> { <span class="hljs-attribute">color</span>: blue; }
<span class="hljs-keyword">@supports</span> (<span class="hljs-attribute">-webkit-appearance</span>: none) { <span class="hljs-selector-class">.box</span> { <span class="hljs-comment">/* 适配webkit内核 */</span> } }
</code></pre>
<h4 data-id="heading-2">二、处理 “模块化开发与浏览器加载限制” 的矛盾</h4>
<p>前端项目早已从 “单文件” 发展为 “多模块组合”，但浏览器对模块化的原生支持有限，需要构建工具进行依赖管理与打包：</p>
<ol>
<li>
<p>模块化语法统一与解析前端模块化规范众多（ES Modules <code>import/export</code>、CommonJS <code>require/module.exports</code>、AMD 等），不同库可能使用不同规范，浏览器原生无法统一处理。构建工具会解析所有模块的依赖关系，并将不同规范的模块转换为统一格式（通常是 ES Modules 或打包后的单文件），确保代码能正确运行。</p>
</li>
<li>
<p>依赖合并与路径处理一个复杂项目可能依赖数百个模块（如业务组件、工具函数、第三方库），若直接让浏览器加载这些模块，会导致：</p>
</li>
</ol>
<ul>
<li>大量网络请求（浏览器对同一域名的并发请求数有限，通常 6-8 个），严重拖慢加载速度；</li>
<li>模块路径混乱（如相对路径、别名路径 <code>@/components</code> 等，浏览器无法直接识别）。</li>
</ul>
<p>构建工具会将多个关联模块合并为少数几个 “chunk”（打包产物），并自动处理路径解析（如将 <code>@/components</code> 映射到实际目录），减少请求数并解决路径问题。</p>
<h4 data-id="heading-3">三、优化 “开发效率与生产性能” 的矛盾</h4>
<p>开发时，我们追求的是高效的调试和快速的代码变更反馈（开发体验）。而生产环境追求的是极致的加载性能和用户体验。构建工具通过区分开发模式（development） 和生产模式（production），用一套配置完美解决两种截然不同的需求。</p>
<ol>
<li>开发模式（Development） - 追求速度与可调试性</li>
</ol>
<ul>
<li>Source Map：将打包压缩后的代码映射回原始源代码。当你在浏览器调试时，看到的仍然是清晰可读的原始文件结构，而不是一团混乱的打包后代码，使得调试变得非常简单。</li>
<li>热更新（HMR）：只替换修改了的模块，保持应用当前状态（如表单输入、滚动位置），无需整页刷新，实现秒级更新。</li>
<li>更快的构建速度：会跳过代码压缩、Tree Shaking 等耗时的优化步骤，保证开发时重新打包的速度。</li>
</ul>
<ol start="2">
<li>生产模式（Production） - 追求体积与性能</li>
</ol>
<ul>
<li>代码压缩（Minification）：使用 Terser 压缩 JavaScript，cssnano 压缩 CSS，移除所有注释、空格、缩短变量名，能显著减小文件体积（通常减少 60%-70%）。</li>
<li>代码分割（Code Splitting）：将代码拆分成多个按需加载的块（chunk）。结合动态导入（<code>import()</code>），可以实现懒加载，让用户只加载当前页面或路由所需的代码，极大加速首屏加载时间。</li>
<li>Tree Shaking：像摇树一样，通过静态分析抖落未被使用的代码（dead code），并将其从最终打包文件中移除。例如，你只引用了 Lodash 中的 <code>debounce</code> 函数，打包后就只会包含 <code>debounce</code> 及其依赖，而不是整个 Lodash 库。</li>
<li>资源优化与压缩：自动压缩图片、将小图片转为 Base64 内联、为现代浏览器提供更高效的图片格式（如 WebP/AVIF）。</li>
</ul>
<h2 data-id="heading-4">有哪些构建工具？</h2>







































































































<table><thead><tr><th>构建工具</th><th>开发语言</th><th>Github Star</th><th>发布时间</th><th>作者</th></tr></thead><tbody><tr><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fcn.vite.dev%2F" target="_blank" title="https://cn.vite.dev/" ref="nofollow noopener noreferrer">Vite</a></td><td>TypeScript</td><td>75k</td><td>2020年4月</td><td>ViteJS</td></tr><tr><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fwebpack.js.org%2F" target="_blank" title="https://webpack.js.org/" ref="nofollow noopener noreferrer">Webpack</a></td><td>JavaScript</td><td>65.5k</td><td>2012年3月</td><td>Facebook</td></tr><tr><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fparceljs.org%2F" target="_blank" title="https://parceljs.org/" ref="nofollow noopener noreferrer">Parcel</a></td><td>JavaScript</td><td>43.9k</td><td>2017年12月</td><td>Filament Group</td></tr><tr><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fesbuild.github.io%2F" target="_blank" title="https://esbuild.github.io/" ref="nofollow noopener noreferrer">esbuild</a></td><td>Go</td><td>39.3k</td><td>2020年</td><td>Evan Wallace</td></tr><tr><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fgulpjs.com%2F" target="_blank" title="https://gulpjs.com/" ref="nofollow noopener noreferrer">Gulp</a></td><td>JavaScript</td><td>33.1k</td><td>2013年</td><td>Eric Schoffstall</td></tr><tr><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fswc.rs%2F" target="_blank" title="https://swc.rs/" ref="nofollow noopener noreferrer">swc</a></td><td>Rust</td><td>32.7k</td><td>2017年</td><td>Vercel</td></tr><tr><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fturborepo.com%2F" target="_blank" title="https://turborepo.com/" ref="nofollow noopener noreferrer">Turbopack</a></td><td>Rust</td><td>28.5k</td><td>2022年10月</td><td>Vercel</td></tr><tr><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fnx.dev%2F" target="_blank" title="https://nx.dev/" ref="nofollow noopener noreferrer">Nx</a></td><td>TypeScript</td><td>26.8k</td><td>-</td><td>Nrwl</td></tr><tr><td><a href="https://link.juejin.cn?target=https%3A%2F%2Frollupjs.org%2F" target="_blank" title="https://rollupjs.org/" ref="nofollow noopener noreferrer">Rollup</a></td><td>JavaScript</td><td>26k</td><td>2015年</td><td>Rich Harris</td></tr><tr><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.snowpack.dev%2F" target="_blank" title="https://www.snowpack.dev/" ref="nofollow noopener noreferrer">Snowpack</a></td><td>JavaScript</td><td>19.4k</td><td>2020年5月</td><td>Pika</td></tr><tr><td><a href="https://link.juejin.cn?target=https%3A%2F%2Frolldown.rs%2F" target="_blank" title="https://rolldown.rs/" ref="nofollow noopener noreferrer">Rolldown</a></td><td>Rust</td><td>11.9k</td><td>2024年</td><td>VueJS</td></tr><tr><td><a href="https://link.juejin.cn?target=https%3A%2F%2Frspack.rs%2Fzh%2F" target="_blank" title="https://rspack.rs/zh/" ref="nofollow noopener noreferrer">Rspack</a></td><td>Rust</td><td>11.9k</td><td>2023年3月</td><td>Bytedance</td></tr><tr><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fwmr.dev%2F" target="_blank" title="https://wmr.dev/" ref="nofollow noopener noreferrer">WMR</a></td><td>JavaScript</td><td>4.9k</td><td>-</td><td>Preact</td></tr></tbody></table>
<h2 data-id="heading-5">Webpack 工作原理</h2>
<p>在众多前端构建工具中，Webpack 由于其高度的灵活性和强大的生态系统，依然是最广泛使用的打包工具之一。与 Vite、Parcel 等工具相比，Webpack 提供了更为细致的定制能力，能够满足复杂项目的需求，如代码分割、资源优化和热更新等功能。掌握 Webpack 不仅有助于提升开发效率，更能优化应用性能，因此本文将深入介绍 Webpack 的工作原理。</p>
<h4 data-id="heading-6">一、打包过程</h4>
<p>Webpack 的打包流程可以分为以下关键步骤：</p>
<ol>
<li>读取配置文件，加载构建参数</li>
</ol>
<p>Webpack CLI 启动后，会首先加载开发者提供的配置文件<code>webpack.config.js</code>，包括：</p>
<ul>
<li>mode、entry、output 等基本配置</li>
<li>module.rules 中的 loader 配置</li>
<li>plugins 列表</li>
<li>optimization 配置</li>
</ul>
<p>Webpack 采用 webpack-cli 来解析命令行参数，并最终调用：</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">webpack</span> = require(<span class="hljs-string">"webpack"</span>)<span class="hljs-comment">;</span>
webpack(options)
</code></pre>
<p>此时 Webpack 会完成配置合并（Webpack 内部使用 webpack-merge 的策略），将默认配置与用户配置拼接成最终 options 对象。</p>
<p>这一步的作用是确定 Webpack 后续构建过程所依赖的全部元信息。</p>
<ol>
<li>创建 Compiler 对象，初始化编译总体调度器</li>
</ol>
<p>Webpack 的主控制器是 <code>Compiler</code> 类，Compiler 是 Webpack 从开始到结束贯穿始终的对象，它控制着构建生命周期的每一个阶段，并将生命周期开放给插件系统（基于 Tapable）。</p>
<p>Compiler 的职责包括：</p>
<ul>
<li>管理整个构建生命周期</li>
<li>负责调用插件、触发钩子</li>
<li>统一调度 Compilation、模块工厂、Chunk 构建等核心内容</li>
</ul>
<p>简化后的核心结构如下：</p>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Compiler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Tapable</span> </span>{
  constructor(options) {
    <span class="hljs-keyword">super</span>();
    <span class="hljs-keyword">this</span>.options = options;
    <span class="hljs-keyword">this</span>.hooks = {
      initialize: <span class="hljs-keyword">new</span> <span class="hljs-type">SyncHook</span>(),
      run: <span class="hljs-keyword">new</span> <span class="hljs-type">AsyncSeriesHook</span>([<span class="hljs-string">"compiler"</span>]),
      compile: <span class="hljs-keyword">new</span> <span class="hljs-type">SyncHook</span>([<span class="hljs-string">"params"</span>]),
      make: <span class="hljs-keyword">new</span> <span class="hljs-type">AsyncParallelHook</span>([<span class="hljs-string">"compilation"</span>]),
      emit: <span class="hljs-keyword">new</span> <span class="hljs-type">AsyncSeriesHook</span>([<span class="hljs-string">"compilation"</span>]),
      done: <span class="hljs-keyword">new</span> <span class="hljs-type">SyncHook</span>([<span class="hljs-string">"stats"</span>]),
      <span class="hljs-comment">// ...</span>
    };
  }

  run(callback) {
    <span class="hljs-keyword">this</span>.hooks.run.callAsync(<span class="hljs-keyword">this</span>, err =&gt; {
      <span class="hljs-keyword">this</span>.compile(onCompiled);
    });
  }

  compile(callback) {
    const compilation = <span class="hljs-keyword">this</span>.newCompilation();
    <span class="hljs-keyword">this</span>.hooks.make.callAsync(compilation, err =&gt; {
      compilation.finish(() =&gt; {
        compilation.seal(callback);
      });
    });
  }
}
</code></pre>
<p><code>compiler.run()</code> 是 Webpack 单次构建流程的启动函数。它做三件事：</p>
<ul>
<li>调度构建生命周期钩子，如 <code>beforeRun</code> / <code>run</code></li>
<li>调用 <code>compiler.compile()</code> 执行真正的编译逻辑</li>
<li>调用 <code>emit</code> / <code>afterEmit</code> / <code>done</code> 等钩子产出结果</li>
</ul>
<p>Compiler 控制整体流程，而 Compilation 则控制：</p>
<ul>
<li>模块构建（构建每一个 JS/CSS/图片等模块）</li>
<li>模块依赖分析</li>
<li>Chunk 构建</li>
<li>代码优化（Tree Shaking、SplitChunks）</li>
<li>生成最终资源（assets）</li>
</ul>
<p>Compilation 是构建的“工作单位”，负责所有实际的打包工作。</p>
<ol>
<li>从入口文件开始，递归查找和编译模块</li>
</ol>
<p>EntryPlugin 会根据 entry 配置向 Compilation 注册入口模块。Webpack 随后会从入口开始递归解析依赖，构建整个依赖图。当遇到非 JS 模块时，通过 Loader 进行处理（如将 TS/LESS/图片等转为可用模块）。</p>
<p>Webpack 在构建模块时，会根据 module.rules 匹配对应的 loader，从右向左依次对模块内容进行转换。</p>
<p>Loader 的作用包括但不限于：</p>
<ul>
<li>Babel：将 ES6+ 转译为 ES5</li>
<li>css-loader：处理 CSS 文件内容</li>
<li>url-loader / file-loader：处理图片资源</li>
<li>vue-loader / ts-loader：处理 SFC 或 TS</li>
</ul>
<p>最终，所有文件都会被转换成 JavaScript 字符串供后续 AST 解析。</p>
<ol>
<li>解析每个模块的依赖关系，构建模块图 ModuleGraph</li>
</ol>
<p>webpack 把 loader 产出的 JS 代码解析成 AST，识别出所有依赖节点（<code>import</code> / <code>require</code> / <code>import()</code> / loader 插入的依赖等），并把这些依赖投影到 ModuleGraph 上，形成可供后续优化和分块的有向依赖图。</p>
<pre><code class="hljs language-ini" lang="ini">// NormalModule.build() 内部流程（精简）
runLoaders(resource, loaders, (err, result) =&gt; {
  const <span class="hljs-attr">source</span> = result.result[<span class="hljs-number">0</span>]<span class="hljs-comment">;             // loader 输出 -&gt; JS 字符串 / Source</span>
  const <span class="hljs-attr">parser</span> = compilation.getParser(<span class="hljs-string">"javascript"</span>)<span class="hljs-comment">;</span>
  const <span class="hljs-attr">ast</span> = parser.parse(source)<span class="hljs-comment">;            // acorn -&gt; AST</span>
  const <span class="hljs-attr">dependencies</span> = parser.collectDependencies(ast)<span class="hljs-comment">; // 解析产生 Dependency 实例</span>
  for (const dep of dependencies) {
    const <span class="hljs-attr">resolved</span> = resolver.resolve(dep.request)<span class="hljs-comment">;</span>
    const <span class="hljs-attr">depModule</span> = normalModuleFactory.create(resolved)<span class="hljs-comment">;</span>
    moduleGraph.connect(module, dep, depModule)<span class="hljs-comment">; // 建图：模块 -&gt; 依赖 -&gt; 目标模块</span>
  }
})<span class="hljs-comment">;</span>
</code></pre>
<ul>
<li>解析器（JavascriptParser）是通过 Tapable hook 逐节点触发、生成  实例（以便插件/loader 能介入解析过程）。</li>
</ul>

<ul>
<li>NormalModuleFactory / Resolver 负责把语法层面的请求（request）解析到具体路径并创建 Module 实例，Compilation 将这些新模块加入构建队列直至递归完成。</li>
</ul>
<ol>
<li>
<p>优化模块</p>
<p>在模块级别上减少最终运行时代码体积并提升运行时性能的策略，包括剔除未使用代码（Tree Shaking）、合并模块以缩短调用链与减少函数包装开销（Scope Hoisting / Module Concatenation）、以及其他小粒度优化（常量折叠、dead code elimination 交给 Terser 等压缩器完成）。</p>
</li>
<li>
<p>根据模块图生成 Chunk，对生成的代码块进行进一步优化</p>
</li>
</ol>
<p>Webpack 将完成构建的模块根据入口点和不同类型的依赖关系构建多个 Chunk，Chunk 是 Webpack 打包产物的基础单位，每个 Chunk 对应一个最终输出文件（或多个文件组合），同时承载 runtime、依赖关系、模块顺序和异步加载信息。ChunkGraph 会在这一阶段被创建并建立，它记录：</p>
<ul>
<li>当前 Chunk 包含哪些模块</li>
<li>模块属于哪些 Chunk</li>
<li>Chunk 与 Chunk 之间的关系</li>
</ul>
<p>生成的 Chunk 进行最终优化，包括渲染 Chunk 内部代码、处理异步加载和动态 import、应用代码分割策略提取公共模块、注入 runtime 逻辑、生成按需加载和预加载提示，以及通过 [contenthash] 和独立 runtime Chunk 实现长期缓存，从而使输出文件体积最小化、加载高效并支持浏览器缓存优化。</p>
<ol>
<li>生成最终资源并写入输出目录</li>
</ol>
<p>Webpack 构建完成后会将所有 Chunk 转换为可执行文件（assets），例如：</p>
<ul>
<li>main.js</li>
<li>vendors.js</li>
<li>style.css</li>
<li>图片 / 字体等静态资源</li>
</ul>
<p>输出阶段触发 Compiler 的 <code>emit</code> 钩子，随后写入文件系统。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">emitAssets</span>(<span class="hljs-params">compilation, callback</span>) {
  <span class="hljs-keyword">const</span> { entries, modules, chunks, assets } = compilation;
  <span class="hljs-keyword">const</span> output = <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">output</span>;
    
  <span class="hljs-comment">// 调用 Plugin emit 钩子</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">hooks</span>.<span class="hljs-property">emit</span>.<span class="hljs-title function_">call</span>();
  
  <span class="hljs-comment">// 若 output.path 不存在，进行创建</span>
  <span class="hljs-keyword">if</span> (!fs.<span class="hljs-title function_">existsSync</span>(output.<span class="hljs-property">path</span>)) {
    fs.<span class="hljs-title function_">mkdirSync</span>(output.<span class="hljs-property">path</span>);
  }
    
  <span class="hljs-comment">// 将 assets 中的内容写入文件系统中</span>
  <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(assets).<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">fileName</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> filePath = path.<span class="hljs-title function_">join</span>(output.<span class="hljs-property">path</span>, fileName);
    fs.<span class="hljs-title function_">writeFileSync</span>(filePath, assets[fileName]);
  });
  
  <span class="hljs-comment">// 结束之后触发钩子</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">hooks</span>.<span class="hljs-property">done</span>.<span class="hljs-title function_">call</span>();
  
  <span class="hljs-title function_">callback</span>(<span class="hljs-literal">null</span>, {
    <span class="hljs-attr">toJSON</span>: <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">return</span> {
        entries,
        modules,
        chunks,
        assets,
      };
    },
  });
}
</code></pre>
<h4 data-id="heading-7">二、热更新过程</h4>
<p>热模块替换（HMR，Hot Module Replacement）是指当我们对代码修改并保存后，Webpack 将会对代码进行重新打包，并将新的模块发送到浏览器端，浏览器用新的模块替换掉旧的模块 ，以实现在不刷新浏览器的前提下更新页面。</p>
<p>整体流程：</p>
<ul>
<li>首先是 Webpack 监听到文件修改后，进行编译，打包出新的文件，得到新的 hash。</li>
<li>其次是 webpack-dev-server 通过 websocket 通知浏览器，告诉浏览器新的 hash。</li>
<li>浏览器收到通知后，请求新的文件，拿到新的文件后，更新页面。</li>
</ul>
<h6 data-id="heading-8">文件监听</h6>
<p>Webpack 的文件监听机制用于在开发模式下自动检测文件变化并触发增量编译。其核心由三个组件构成：</p>
<ul>
<li>Watching（调度层）</li>
<li>Watchpack（抽象管理层）</li>
<li>DirectoryWatcher（底层监听实现层）</li>
</ul>
<p>整体基于 发布–订阅模型（EventEmitter） 实现，整个过程是典型的 事件驱动的监听 → 通知 → 重新编译。Webpack 通过以下流程实现监听：</p>
<ol>
<li><code>compiler.watch()</code> 创建 Watching 实例，负责整个监听调度。</li>
<li>Watching 初始化 Watchpack，并让其负责监听所有文件和目录。</li>
<li>Watchpack 内部使用 DirectoryWatcher 监听目录变动，同时监听单文件变化。</li>
<li>文件变动发生时，DirectoryWatcher 发出 <code>change</code> 事件。</li>
<li>Watchpack 将事件上报给 Watching。</li>
<li>Watching 调用 Webpack 的增量编译流程，生成新的构建文件。</li>
</ol>
<p>Watching</p>
<p>Watching 是 Webpack 启动 watch 时最上层的控制者，通过：</p>
<ul>
<li>创建并启动 Watchpack；</li>
<li>订阅 Watchpack 的 <code>change</code>、<code>remove</code> 事件；</li>
<li>触发增量编译；</li>
<li>将新的 hash 传给 dev-server，使浏览器执行 HMR 刷新。</li>
</ul>

<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Watching</span> {
    <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>){
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">startTime</span> = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>()
    }
    <span class="hljs-title function_">watch</span>(<span class="hljs-params">files</span>){
        <span class="hljs-keyword">let</span> watcher = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Watchpack</span>();
        <span class="hljs-keyword">let</span> <span class="hljs-title function_">callback</span> =  (<span class="hljs-params">changes, removals</span>)=&gt;{
             <span class="hljs-comment">// 执行各种hooks</span>
        }
        watcher.<span class="hljs-title function_">once</span>(<span class="hljs-string">"aggregated"</span>,callback);
        watcher.<span class="hljs-title function_">watch</span>(files, directories, <span class="hljs-variable language_">this</span>.<span class="hljs-property">startTime</span>);
        <span class="hljs-keyword">return</span> watcher;
    }
}
</code></pre>
<p>Watchpack</p>
<p>Watchpack 是 Webpack 文件监听功能的核心抽象层，负责：</p>
<ul>
<li>
<p>统一管理所有被监听的文件和目录；</p>
</li>
<li>
<p>为每个目录创建 DirectoryWatcher；</p>
</li>
<li>
<p>决定具体监听方式（fs.watch、fs.watchFile、轮询）；</p>
</li>
<li>
<p>将底层监听事件汇总后统一向外发射：</p>
<ul>
<li><code>change</code>（文件变化）</li>
<li><code>remove</code>（文件被删除）</li>
</ul>
</li>
</ul>
<p>所以它不直接监听，而是管理多个监听者。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Watchpack</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">EventEmitter</span>{
    <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>){
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">fileWatchers</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">directoryWatchers</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
    }
    <span class="hljs-title function_">watch</span>(<span class="hljs-params">files, directories, startTime</span>){
        <span class="hljs-comment">// 为每个文件添加一个或多个 DirectoryWatcher</span>
        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">let</span> file <span class="hljs-keyword">of</span> files){
            <span class="hljs-keyword">let</span> watcher = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DirectoryWatcher</span>();
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">fileWatchers</span>.<span class="hljs-title function_">set</span>(file, watcher);
            watcher.<span class="hljs-title function_">on</span>(<span class="hljs-string">"change"</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">_onTimeout</span>);
            watcher.<span class="hljs-title function_">watch</span>(file, startTime);
        }
        <span class="hljs-comment">// for of directories</span>
        <span class="hljs-comment">// bala bala</span>
        
        <span class="hljs-comment">// 源码这里的方法调用，没太明白是个啥意思？</span>
        <span class="hljs-comment">// 后面还有一个watchEventSource.watch()</span>
        watchEventSource.<span class="hljs-title function_">batch</span>()
    }
    <span class="hljs-title function_">_onTimeout</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">const</span> changes = <span class="hljs-variable language_">this</span>.<span class="hljs-property">aggregatedChanges</span>;
        <span class="hljs-keyword">const</span> removals = <span class="hljs-variable language_">this</span>.<span class="hljs-property">aggregatedRemovals</span>;
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">emit</span>(<span class="hljs-string">"aggregated"</span>, changes, removals);
    }
}
</code></pre>
<p>DirectoryWatcher</p>
<p>DirectoryWatcher 是最底层、最核心的监听器，负责检测：</p>
<ul>
<li>文件内容修改（mtime 改变）</li>
<li>新文件创建</li>
<li>文件删除（readdir 不存在）</li>
</ul>

<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">DirectoryWatcher</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">EventEmitter</span> {
    <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>){
       <span class="hljs-variable language_">this</span>.<span class="hljs-property">watchers</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
       <span class="hljs-variable language_">this</span>.<span class="hljs-property">files</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
       
       <span class="hljs-variable language_">this</span>.<span class="hljs-property">watcher</span> = watchEventSource.<span class="hljs-title function_">watch</span>(file);
       <span class="hljs-variable language_">this</span>.<span class="hljs-property">watcher</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">"change"</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">onWatchEvent</span>);
    }
    <span class="hljs-title function_">watch</span>(<span class="hljs-params">file, startTime</span>){
        <span class="hljs-keyword">let</span> watchers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>();
        <span class="hljs-keyword">let</span> watcher = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Watcher</span>(startTime);
        watchers.<span class="hljs-title function_">add</span>(watcher);
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">watchers</span>.<span class="hljs-title function_">set</span>(file, watchers);     
    }
    <span class="hljs-title function_">onWatchEvent</span>(<span class="hljs-params">eventType, filename</span>){
        fs.<span class="hljs-title function_">lstat</span>(filePath, <span class="hljs-function">(<span class="hljs-params">err, stats</span>)=&gt;</span>{
            <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setFileTime</span>(filePath, stats.<span class="hljs-property">mtime</span>);
            <span class="hljs-comment">// this.setDirectory(filePath, eventType);</span>
        })
    }
    <span class="hljs-title function_">setFileTime</span>(<span class="hljs-params">filePath, mtime</span>){
        <span class="hljs-comment">// 记录文件信息</span>
        <span class="hljs-keyword">let</span> safeTime = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">files</span>.<span class="hljs-title function_">set</span>(filePath, {
            safeTime,
            <span class="hljs-attr">timestamp</span>: mtime
        })
        <span class="hljs-keyword">let</span> watchers = <span class="hljs-variable language_">this</span>.<span class="hljs-property">watchers</span>.<span class="hljs-title function_">get</span>(filePath)
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> w <span class="hljs-keyword">of</span> watchers) {
           <span class="hljs-keyword">if</span> (w.<span class="hljs-title function_">checkStartTime</span>(safeTime)) {
                <span class="hljs-comment">// 文件更新后触发的事件源</span>
                w.<span class="hljs-title function_">emit</span>(<span class="hljs-string">"change"</span>, mtime);
            }
        }
       
    }
}
</code></pre>
<ul>
<li>
<p>优先使用操作系统事件（fs.watch）</p>
</li>
<li>
<p>系统不支持时退回轮询（Polling）</p>
<ul>
<li>通过周期性的 <code>fs.stat</code> + mtime 对比检测变化。</li>
</ul>
</li>
</ul>
<h6 data-id="heading-9">模块编译处理</h6>
<p>当文件监听到变化后，Webpack 会触发一次增量编译，除了与打包类似的编译外，webpack 还会往 Compiler 注入 HotModuleReplacementPlugin 插件，插件内部做了三方面处理：</p>
<ul>
<li>语法转译：模块代码允许使用 <code>module.hot.xxx</code> 进行个性化处理，需要将这些语法处理为符合运行时能力的代码；</li>
<li>HMR Runtime Module：HMR模式下会将 HMR Runtime 模块进行注入操作。</li>
<li>产物生成：HMR 模式下每次变更都会产生 manifest 和 update chunks 文件，编译器需要额外处理这些产生生成逻辑。</li>
</ul>
<p>语法转译</p>
<p>在开发模式下，模块里可能会用到 HMR API，例如：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">if</span> (<span class="hljs-variable language_">module</span>.<span class="hljs-property">hot</span>) {
    <span class="hljs-variable language_">module</span>.<span class="hljs-property">hot</span>.<span class="hljs-title function_">accept</span>(<span class="hljs-string">'./foo.js'</span>, <span class="hljs-function">() =&gt;</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'foo.js 更新了'</span>);
    });
}
</code></pre>
<p>HotModuleReplacementPlugin 提供了语法转义能力：</p>
<ul>
<li>
<p>对模块代码进行解析，找到 <code>module.hot.xxx</code> 相关调用；</p>
<ul>
<li>主要替换语法有 module.hot、module.hot.accept、module.hot.decline 语法</li>
</ul>
</li>
<li>
<p>将这些调用转换成运行时可以识别的代码（符合 HMR Runtime 约定）；</p>
</li>
<li>
<p>注入必要的回调钩子，保证模块在被替换时能够正确触发 accept、dispose 回调。</p>
</li>
</ul>
<p>让开发者书写的 HMR API 能够在浏览器端的 HMR Runtime 中生效，实现模块级别的热替换。</p>
<p>HMR Runtime Module 注入</p>
<p>HMR 在运行时需要相应基础能力才能够运行，在 HotModuleReplacementPlugin 内部会往编译器注入 HotModuleReplacementRuntimeModule 保证应用能够正常提供运行时能力。</p>
<p>该 Runtime Module 实现了：</p>
<ul>
<li>WebSocket 通信（接收 hash / ok 消息）；</li>
<li>补丁文件的加载（hot-update.js / hot-update.json）；</li>
<li>模块替换逻辑（dispose → apply → accept）；</li>
<li>状态管理（已替换的模块、更新队列等）。</li>
</ul>
<p>作用：保证浏览器端可以正确识别 HMR 消息，拉取补丁并执行模块替换，而不刷新整个页面。</p>
<p>manifest 及 Chunk 生成</p>
<p>Compiler 每次编译之后都会得到每个模块、Chunk 的哈希值，Compiler 通过判断本次编译的产物的哈希和上次编译记录的Hash得出模块变更信息，HotModuleReplacementPlugin 根据模块变更信息生成两份数据：</p>
<ol>
<li>更新描述<code>manifest.json</code>：以JSON形式数据</li>
</ol>
<ul>
<li><code>updateChunkIds</code>：更新的 Chunk Id</li>
<li><code>removedChunkIds</code>：移除的 Chunk Id</li>
<li><code>removedModuleIds</code>：移除的 Module Id</li>
</ul>
<ol start="2">
<li>模块 Chunk 产物<code>[key].[newHash].hot-update.js</code>：只包含更新模块代码</li>
</ol>

<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// [key].[newHash].hot-update.js</span>
self[<span class="hljs-string">"webpackHotUpdate_myApp"</span>](<span class="hljs-string">"main"</span>, {
  <span class="hljs-number">0</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"><span class="hljs-variable language_">module</span>, __webpack_exports__, __webpack_require__</span>) {
    <span class="hljs-comment">// 新模块代码</span>
  },
  <span class="hljs-number">2</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"><span class="hljs-variable language_">module</span>, __webpack_exports__, __webpack_require__</span>) {
    <span class="hljs-comment">// 新模块代码</span>
  }});
</code></pre>
<p>当 Webpack 完成增量编译后，会将新的构建产物与新的 hash 生 成在内存中，此时 Webpack-dev-server 会通过 WebSocket 将更新消息推送给浏览器。</p>
<p>Webpack-dev-server 的核心功能是作为 浏览器与编译器之间的中间层，让前端项目在开发阶段拥有实时更新能力。</p>
<p>在传统的 LiveReload 模式下，文件变更后浏览器会被强制刷新整个页面；而 HMR 在此基础上更进一步，只更新变化的模块而不刷新整页。这两种机制最终都依赖 Webpack-dev-server 提供的能力。</p>
<p>从整体设计来看，Webpack-dev-server 可以拆分为两个主要模块：</p>
<ul>
<li>
<p>应用通信模块（推送更新消息）</p>
</li>
<li>
<p>静态资源服务模块（返回构建产物）</p>
<ul>
<li>使用 express 框架提供静态资源服务器功能</li>
</ul>
</li>
</ul>
<h6 data-id="heading-10">更新通知</h6>
<p>服务器与浏览器之间通过 WebSocket 建立长连接，并会使用长轮询作为兜底方法。</p>
<ol>
<li>监听 Webpack 编译完成后，主动触发 <code>sendStats</code> 方法</li>
<li>本地服务端的 WebSocket 主动发送 hash 命令和 ok 命令到本地浏览器 client 端</li>
</ol>

<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Server</span> {
 setupHooks() {
     <span class="hljs-comment">// 初始化时注册done的监听事件，编译完成后，调用sendStats方法进行webSocket的命令发送</span>
     <span class="hljs-keyword">this</span>.compiler.hooks.done.tap(
         <span class="hljs-string">"webpack-dev-server"</span>,
         (stats) =&gt; {
             <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.webSocketServer) {
                 <span class="hljs-keyword">this</span>.sendStats(<span class="hljs-keyword">this</span>.webSocketServer.clients, <span class="hljs-keyword">this</span>.getStats(stats));
             }
             <span class="hljs-keyword">this</span>.stats = stats;
         }
     );
 }

 sendStats(clients, stats, force) {
     <span class="hljs-comment">// 更新当前的hash</span>
     <span class="hljs-keyword">this</span>.currentHash = stats.hash;
   
     <span class="hljs-comment">// 发送给客户端当前的hash值</span>
     <span class="hljs-keyword">this</span>.sendMessage(clients, <span class="hljs-string">"hash"</span>, stats.hash);

     <span class="hljs-comment">// 发送给客户端ok的指令</span>
     <span class="hljs-keyword">this</span>.sendMessage(clients, <span class="hljs-string">"ok"</span>);
 }
}
</code></pre>
<h6 data-id="heading-11">模块替换</h6>
<p>当浏览器端收到 ok 消息后，Webpack 的 HMR Runtime 便会开始执行模块热替换流程。浏览器端调用 <code>emitter</code>将最新 hash 值发送给 HMR runtime。</p>
<pre><code class="hljs language-ini" lang="ini">import hotEmitter from "webpack/hot/emitter.js"<span class="hljs-comment">;</span>

function reloadApp(_ref, status) {
  var <span class="hljs-attr">hot</span> = _ref.hot, liveReload = _ref.liveReload<span class="hljs-comment">;</span>
  ...
  var <span class="hljs-attr">currentHash</span> = status.currentHash, previousHash = status.previousHash<span class="hljs-comment">;</span>
  ...
  var <span class="hljs-attr">allowToHot</span> = search.indexOf(<span class="hljs-string">"webpack-dev-server-hot=false"</span>) === -<span class="hljs-number">1</span><span class="hljs-comment">;</span>
  if (hot &amp;&amp; allowToHot) {
    log.info("App hot update...")<span class="hljs-comment">;</span>
    hotEmitter.emit("webpackHotUpdate", status.currentHash)<span class="hljs-comment">;</span>
    ...
  }
  ...
}
</code></pre>
<p>HMR runtime 会更新 lastHash，并在必要时调用 <code>check()</code>，发起更新检查</p>
<pre><code class="hljs language-javascript" lang="javascript">hotEmitter.<span class="hljs-title function_">on</span>(<span class="hljs-string">"webpackHotUpdate"</span>, <span class="hljs-keyword">function</span> (<span class="hljs-params">currentHash</span>) {
  lastHash = currentHash;
  <span class="hljs-keyword">if</span> (!<span class="hljs-title function_">upToDate</span>() &amp;&amp; <span class="hljs-variable language_">module</span>.<span class="hljs-property">hot</span>.<span class="hljs-title function_">status</span>() === <span class="hljs-string">"idle"</span>) {
    <span class="hljs-title function_">log</span>(<span class="hljs-string">"info"</span>, <span class="hljs-string">"[HMR] Checking for updates on the server..."</span>);
    <span class="hljs-title function_">check</span>();
  }
});
<span class="hljs-keyword">var</span> check = <span class="hljs-keyword">function</span> <span class="hljs-title function_">check</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">module</span>.<span class="hljs-property">hot</span>
    .<span class="hljs-title function_">check</span>(<span class="hljs-literal">true</span>)
    .<span class="hljs-title function_">then</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params">updatedModules</span>) {
      ...
    })
    .<span class="hljs-keyword">catch</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params">err</span>) {
      ...
    });
};
</code></pre>
<p><code>module.hot.check</code>最终会触发<code>hotCheck()</code>方法</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">hotCheck</span>(<span class="hljs-params">applyOnUpdate</span>) {
  ...
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">setStatus</span>(<span class="hljs-string">"check"</span>)
  .<span class="hljs-title function_">then</span>(__webpack_require__.<span class="hljs-property">hmrM</span>)
  .<span class="hljs-title function_">then</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">update</span>) {
      ...
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">setStatus</span>(<span class="hljs-string">"prepare"</span>).<span class="hljs-title function_">then</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
            <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>(
              <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(__webpack_require__.<span class="hljs-property">hmrC</span>).<span class="hljs-title function_">reduce</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params">
              			promises,
              			key
              		</span>) {
                        <span class="hljs-comment">// key = jsonp</span>
              			__webpack_require__.<span class="hljs-property">hmrC</span>[key](
              					update.<span class="hljs-property">c</span>,
              					update.<span class="hljs-property">r</span>,
              					update.<span class="hljs-property">m</span>,
              					promises,
              					currentUpdateApplyHandlers,
              					updatedModules
              				);
              			<span class="hljs-keyword">return</span> promises;
              		},
              	[])
          ).<span class="hljs-title function_">then</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
              <span class="hljs-keyword">return</span> <span class="hljs-title function_">waitForBlockingPromises</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
                  ...
                  <span class="hljs-keyword">return</span> <span class="hljs-title function_">internalApply</span>(applyOnUpdate);
              });
          });
      });
  });
}
__webpack_require__.<span class="hljs-property">hmrC</span>.<span class="hljs-property">jsonp</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">
  chunkIds,
  removedChunks,
  removedModules,
  promises,
  applyHandlers,
  updatedModulesList,
</span>) {
    applyHandlers.<span class="hljs-title function_">push</span>(applyHandler);
    ...
    chunkIds.<span class="hljs-title function_">forEach</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">chunkId</span>) {
        <span class="hljs-keyword">if</span> (
        __webpack_require__.<span class="hljs-title function_">o</span>(installedChunks, chunkId) &amp;&amp;
        installedChunks[chunkId] !== <span class="hljs-literal">undefined</span>
        ) {
            promises.<span class="hljs-title function_">push</span>(<span class="hljs-title function_">loadUpdateChunk</span>(chunkId, updatedModulesList));
        }
    });
};
</code></pre>
<p><strong>webpack_require</strong>.hmrM 中 fetch 到新的 manifest.json 文件，完成后，触发 <strong>webpack_require</strong>.hmrC.jsonp 方法执行</p>
<p>执行 <strong>webpack_require</strong>.hmrC.jsonp，传入 manifest.json 文件中返回的key，通过 jsonp 方式请求得到 [key].[newHash].hot-update.js，执行对应的 moudle 代码的缓存并且触发对应 promise 的<code>resolve</code>请求，从而顺利回调<code>internalApply()</code>方法</p>
<p><code>internalApply()</code>方法是 HMR 的“内部调度器”，连接了 检查更新 和 实际替换模块 两个阶段。根据更新的模块和依赖信息，决定哪些模块可以热替换、哪些模块需要 dispose，并最终调用 <code>apply()</code> 来应用新模块</p>
<pre><code class="hljs language-ini" lang="ini">function internalApply(options) {
 // 这里的currentUpdateApplyHandlers存储的是上面jsonp请求js文件所创建的callback
 var <span class="hljs-attr">results</span> = currentUpdateApplyHandlers.map(function (handler) {
     return handler(options)<span class="hljs-comment">;</span>
 })<span class="hljs-comment">;</span>
 <span class="hljs-attr">currentUpdateApplyHandlers</span> = undefined<span class="hljs-comment">;</span>

 results.forEach(function (result) {
   if (result.dispose) result.dispose()<span class="hljs-comment">;</span>
 })<span class="hljs-comment">;</span>

 var <span class="hljs-attr">outdatedModules</span> = []<span class="hljs-comment">;</span>
 results.forEach(function (result) {
     if (result.apply) {
         // 这里的result的是上面jsonp请求js文件所创建的callback所返回Object的apply方法
         var <span class="hljs-attr">modules</span> = result.apply(reportError)<span class="hljs-comment">;</span>
         if (modules) {
             for (var <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; modules.length; i++) {</span>
                 outdatedModules.push(modules<span class="hljs-section">[i]</span>)<span class="hljs-comment">;</span>
             }
         }
     }
 })<span class="hljs-comment">;</span>

 return Promise.all(<span class="hljs-section">[disposePromise, applyPromise]</span>).then(function () {

     return setStatus("idle").then(function () {
         return outdatedModules<span class="hljs-comment">;</span>
     })<span class="hljs-comment">;</span>
 })<span class="hljs-comment">;</span>
}
</code></pre>
<p>替换的总体执行逻辑：</p>
<ol>
<li>根据webpack配置拼接出当前 moduleId 的热更新策略，比如允许热更新，比如不允许热更新等等</li>
<li>根据热更新策略，拼接多个数据结构，为<code>applay()</code>方法代码服务</li>
</ol>

<ol start="3">
<li>从<code>internalApply()</code>可以知道，最终会先执行<code>result.dispose()</code>，然后再执行<code>result.apply()</code>方法</li>
</ol>
<p>拼接数据结构</p>
<ol>
<li>根据<code>getAffectedModuleEffects(moduleId)</code>整理出该<code>moduleId</code>的热更新策略，是否需要热更新</li>
<li>根据多个对象拼凑出<code>dispose</code>和<code>apply</code>方法所需要的数据结构</li>
</ol>

<pre><code class="hljs language-ini" lang="ini">function applyHandler(options) {
   <span class="hljs-attr">currentUpdateChunks</span> = undefined<span class="hljs-comment">;</span>

   // at begin all updates modules are outdated
   // the "outdated" status can propagate to parents if they don't accept the children
   var <span class="hljs-attr">outdatedDependencies</span> = {}<span class="hljs-comment">; // 使用module.hot.accept部署了依赖发生更新后的回调函数</span>
   var <span class="hljs-attr">outdatedModules</span> = []<span class="hljs-comment">; // 当前过期需要更新的modules</span>
   var <span class="hljs-attr">appliedUpdate</span> = {}<span class="hljs-comment">; // 准备更新的modules</span>


   for (var moduleId in currentUpdate) {
       var <span class="hljs-attr">newModuleFactory</span> = currentUpdate[moduleId]<span class="hljs-comment">;</span>

       // 获取之前的配置：该moduleId是否允许热更新
       var <span class="hljs-attr">result</span> = getAffectedModuleEffects(moduleId)<span class="hljs-comment">;</span>

       var <span class="hljs-attr">doApply</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>
       var <span class="hljs-attr">doDispose</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>

       switch (result.type) {
           // ...
           case "accepted":
               if (options.onAccepted) options.onAccepted(result)<span class="hljs-comment">;</span>
               <span class="hljs-attr">doApply</span> = <span class="hljs-literal">true</span><span class="hljs-comment">;</span>
               break<span class="hljs-comment">;</span>
           //...
       }
       if (doApply) {
           appliedUpdate<span class="hljs-section">[moduleId]</span> = newModuleFactory<span class="hljs-comment">;</span>
           //...代码省略... 拼凑出outdatedDependencies过期的依赖，为下面的module.hot.accept(moduleId, function() {})做准备
       }
       if (doDispose) {
           //...代码省略... 处理配置为dispose的情况
       }

   }
   <span class="hljs-attr">currentUpdate</span> = undefined<span class="hljs-comment">;</span>

   // 根据outdatedModules拼凑出需要<span class="hljs-attr">_selfAccepted</span>=<span class="hljs-literal">true</span>，即热更新是重新加载一次自己的module的数据到outdatedSelfAcceptedModules中
   var <span class="hljs-attr">outdatedSelfAcceptedModules</span> = []<span class="hljs-comment">;</span>
   for (var <span class="hljs-attr">j</span> = <span class="hljs-number">0</span><span class="hljs-comment">; j &lt; outdatedModules.length; j++) {</span>
       var <span class="hljs-attr">outdatedModuleId</span> = outdatedModules[j]<span class="hljs-comment">;</span>
       // <span class="hljs-attr">__webpack_require__.c</span> = __webpack_module_cache__
       var <span class="hljs-attr">module</span> = __webpack_require__.c[outdatedModuleId]<span class="hljs-comment">;</span>
       if (module &amp;&amp; (module.hot._selfAccepted || module.hot._main) &amp;&amp;
           appliedUpdate<span class="hljs-section">[outdatedModuleId]</span> !== warnUnexpectedRequire &amp;&amp;
           !module.hot._selfInvalidated
       ) {
           // _requireSelf: function () {
           //      <span class="hljs-attr">currentParents</span> = me.parents.slice()<span class="hljs-comment">;</span>
           //      <span class="hljs-attr">currentChildModule</span> = _main ? undefined : moduleId<span class="hljs-comment">;</span>
           //         __webpack_require__(moduleId)<span class="hljs-comment">;</span>
           // },
           outdatedSelfAcceptedModules.push({
               module: outdatedModuleId,
               require: module.hot._requireSelf, // 重新加载自己
               errorHandler: module.hot._selfAccepted
           })<span class="hljs-comment">;</span>
       }
   }

   var moduleOutdatedDependencies<span class="hljs-comment">;</span>

   return {
       dispose: function() {...}
       apply: function(reportError) {...}
   }<span class="hljs-comment">;</span>
}
</code></pre>

<pre><code class="hljs language-ini" lang="ini">function getAffectedModuleEffects(updateModuleId) {
   var <span class="hljs-attr">outdatedModules</span> = [updateModuleId]<span class="hljs-comment">;</span>
   var <span class="hljs-attr">outdatedDependencies</span> = {}<span class="hljs-comment">;</span>

   var <span class="hljs-attr">queue</span> = outdatedModules.map(function (id) {
       return {
           chain: <span class="hljs-section">[id]</span>,
           id: id
       }<span class="hljs-comment">;</span>
   })<span class="hljs-comment">;</span>
   while (queue.length &gt; 0) {
       var <span class="hljs-attr">queueItem</span> = queue.pop()<span class="hljs-comment">;</span>
       var <span class="hljs-attr">moduleId</span> = queueItem.id<span class="hljs-comment">;</span>
       var <span class="hljs-attr">chain</span> = queueItem.chain<span class="hljs-comment">;</span>
       var <span class="hljs-attr">module</span> = __webpack_require__.c[moduleId]<span class="hljs-comment">;</span>
       if (!module || (module.hot._selfAccepted &amp;&amp; !module.hot._selfInvalidated)) { continue<span class="hljs-comment">; }</span>

       // ************ 处理不热更新的情况 ************
       if (module.hot._selfDeclined) {
           return {
               type: "self-declined",
               chain: chain,
               moduleId: moduleId
           }<span class="hljs-comment">;</span>
       }
       if (module.hot._main) {
           return {
               type: "unaccepted",
               chain: chain,
               moduleId: moduleId
           }<span class="hljs-comment">;</span>
       }
       // ************ 处理不热更新的情况 ************

       for (var <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; module.parents.length; i++) {</span>
           // <span class="hljs-attr">module.parents</span>=依赖这个模块的modules
           // 遍历所有依赖这个模块的 modules
           var <span class="hljs-attr">parentId</span> = module.parents[i]<span class="hljs-comment">;</span>
           var <span class="hljs-attr">parent</span> = __webpack_require__.c[parentId]<span class="hljs-comment">;</span>
           if (!parent) continue<span class="hljs-comment">;</span>
           if (parent.hot._declinedDependencies<span class="hljs-section">[moduleId]</span>) {
               // 如果依赖这个模块的parentModule设置了不理会当前moduleId热更新的策略，则不处理该parentModule
               return {
                   type: "declined",
                   chain: chain.concat(<span class="hljs-section">[parentId]</span>),
                   moduleId: moduleId,
                   parentId: parentId
               }<span class="hljs-comment">;</span>
           }
           // 如果已经包含在准备更新的队列中，则不重复添加
           if (outdatedModules.indexOf(parentId) !== -1) continue<span class="hljs-comment">;</span>
           if (parent.hot._acceptedDependencies<span class="hljs-section">[moduleId]</span>) {
               if (!outdatedDependencies<span class="hljs-section">[parentId]</span>)
                   outdatedDependencies<span class="hljs-section">[parentId]</span> = <span class="hljs-section">[]</span><span class="hljs-comment">;</span>
               // TODO 这个parentModule设置了监听其依赖module的热更新
               addAllToSet(outdatedDependencies<span class="hljs-section">[parentId]</span>, <span class="hljs-section">[moduleId]</span>)<span class="hljs-comment">;</span>
               continue<span class="hljs-comment">;</span>
           }
           delete outdatedDependencies<span class="hljs-section">[parentId]</span><span class="hljs-comment">;</span>
           outdatedModules.push(parentId)<span class="hljs-comment">; // 添加该parentModuleId到队列中，准备更新</span>

           // 加入该parentModuleId到队列中，进行下一轮循环，把parentModule的相关parent也加入到更新中
           queue.push({
               chain: chain.concat(<span class="hljs-section">[parentId]</span>),
               id: parentId
           })<span class="hljs-comment">;</span>
       }
   }

   return {
       type: "accepted",
       moduleId: updateModuleId,
       outdatedModules: outdatedModules,
       outdatedDependencies: outdatedDependencies
   }<span class="hljs-comment">;</span>
}

function addAllToSet(a, b) {
   for (var <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; b.length; i++) {</span>
       var <span class="hljs-attr">item</span> = b[i]<span class="hljs-comment">;</span>
       if (a.indexOf(item) === -1) a.push(item)<span class="hljs-comment">;</span>
   }
}
</code></pre>
<p>dispose 方法</p>
<p><code>dispose</code> 方法是 HMR 模块替换流程中的“销毁旧模块”阶段，主要负责：</p>
<ul>
<li>清理缓存，将旧模块从模块系统中移除</li>
<li>移除之前注册的回调函数</li>
<li>移除目前 module 与其它 module 的绑定关系（ parent 和 children），避免旧模块残留影响新模块</li>
<li>为后续热更新的模块替换（apply 阶段）做准备</li>
</ul>

<pre><code class="hljs language-ini" lang="ini">dispose: function () {
   currentUpdateRemovedChunks.forEach(function (chunkId) {
       delete installedChunks<span class="hljs-section">[chunkId]</span><span class="hljs-comment">;</span>
   })<span class="hljs-comment">;</span>
   <span class="hljs-attr">currentUpdateRemovedChunks</span> = undefined<span class="hljs-comment">;</span>

   var idx<span class="hljs-comment">;</span>
   var <span class="hljs-attr">queue</span> = outdatedModules.slice()<span class="hljs-comment">;</span>
   while (queue.length &gt; 0) {
       var <span class="hljs-attr">moduleId</span> = queue.pop()<span class="hljs-comment">;</span>
       var <span class="hljs-attr">module</span> = __webpack_require__.c[moduleId]<span class="hljs-comment">;</span>
       if (!module) continue<span class="hljs-comment">;</span>

       var <span class="hljs-attr">data</span> = {}<span class="hljs-comment">;</span>

       // Call dispose handlers: 回调注册的disposeHandlers
       var <span class="hljs-attr">disposeHandlers</span> = module.hot._disposeHandlers<span class="hljs-comment">;</span>
       for (<span class="hljs-attr">j</span> = <span class="hljs-number">0</span><span class="hljs-comment">; j &lt; disposeHandlers.length; j++) {</span>
           disposeHandlers<span class="hljs-section">[j]</span>.call(null, data)<span class="hljs-comment">;</span>
       }
       // <span class="hljs-attr">__webpack_require__.hmrD</span> = currentModuleData置为空
       __webpack_require__.hmrD<span class="hljs-section">[moduleId]</span> = data<span class="hljs-comment">;</span>

       // disable module (this disables requires from this module)
       <span class="hljs-attr">module.hot.active</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>

       // remove module from cache: 删除module的缓存数据
       delete __webpack_require__.c<span class="hljs-section">[moduleId]</span><span class="hljs-comment">;</span>

       // when disposing there is no need to call dispose handler: 删除其它模块对该moduleId的accept回调
       delete outdatedDependencies<span class="hljs-section">[moduleId]</span><span class="hljs-comment">;</span>

       // remove "parents" references from all children: 
       // 解除moduleId引用的其它模块跟moduleId的绑定关系，跟下面的解除关系是互相补充的
       // 一个是children，一个是parent
       for (<span class="hljs-attr">j</span> = <span class="hljs-number">0</span><span class="hljs-comment">; j &lt; module.children.length; j++) {</span>
           var <span class="hljs-attr">child</span> = __webpack_require__.c[module.children[j]]<span class="hljs-comment">;</span>
           if (!child) continue<span class="hljs-comment">;</span>
           <span class="hljs-attr">idx</span> = child.parents.indexOf(moduleId)<span class="hljs-comment">;</span>
           if (idx &gt;= 0) {
               child.parents.splice(idx, 1)<span class="hljs-comment">;</span>
           }
       }
   }

   // remove outdated dependency from module children: 
   // 解除引用该moduleId的模块跟moduleId的绑定关系，可以理解为moduleId.parent删除children，跟上面的解除关系是互相补充的
   // 一个是children，一个是parent
   var dependency<span class="hljs-comment">;</span>
   for (var outdatedModuleId in outdatedDependencies) {
       <span class="hljs-attr">module</span> = __webpack_require__.c[outdatedModuleId]<span class="hljs-comment">;</span>
       if (module) {
           <span class="hljs-attr">moduleOutdatedDependencies</span> =
               outdatedDependencies<span class="hljs-section">[outdatedModuleId]</span><span class="hljs-comment">;</span>
           for (<span class="hljs-attr">j</span> = <span class="hljs-number">0</span><span class="hljs-comment">; j &lt; moduleOutdatedDependencies.length; j++) {</span>
               <span class="hljs-attr">dependency</span> = moduleOutdatedDependencies[j]<span class="hljs-comment">;</span>
               <span class="hljs-attr">idx</span> = module.children.indexOf(dependency)<span class="hljs-comment">;</span>
               if (idx &gt;= 0) module.children.splice(idx, 1)<span class="hljs-comment">;</span>
           }
       }

   }
}
</code></pre>
<p>apply方法</p>
<p><code>apply()</code>方法是HMR 模块替换流程中的“加载新模块”阶段，主要执行的逻辑是：</p>
<ul>
<li>更新全局的 window.<strong>webpack_require</strong> 对象，存储了所有路径+内容的对象</li>
<li>执行 runtime 代码，比如 <code>_webpack_require__.h = ()=&gt; {"xxxxxhash值"}</code></li>
<li>触发之前 hot.accept 部署了依赖变化时的回调 callBack</li>
<li>重新加载标识 _selfAccepted 的 module，这种模块会重新 require 一次</li>
</ul>

<pre><code class="hljs language-ini" lang="ini">apply: function (reportError) {
   // insert new code
   for (var updateModuleId in appliedUpdate) {
       // <span class="hljs-attr">__webpack_require__.m</span> = __webpack_modules__
       // 更新全局的window.__webpack_require__对象，存储了所有路径+内容的对象
       __webpack_require__.m<span class="hljs-section">[updateModuleId]</span> = appliedUpdate<span class="hljs-section">[updateModuleId]</span><span class="hljs-comment">;</span>
   }

   // run new runtime modules
   // 执行runtime代码，比如<span class="hljs-attr">_webpack_require__.h</span> = ()=&gt; {<span class="hljs-string">"xxxxxhash值"</span>}
   for (var <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; currentUpdateRuntime.length; i++) {</span>
       currentUpdateRuntime<span class="hljs-section">[i]</span>(__webpack_require__)<span class="hljs-comment">;</span>
   }

   // call accept handlers：触发之前hot.accept部署了依赖变化时的回调callBack
   for (var outdatedModuleId in outdatedDependencies) {
       var <span class="hljs-attr">module</span> = __webpack_require__.c[outdatedModuleId]<span class="hljs-comment">;</span>
       if (module) {
           <span class="hljs-attr">moduleOutdatedDependencies</span> =
               outdatedDependencies<span class="hljs-section">[outdatedModuleId]</span><span class="hljs-comment">;</span>
           var <span class="hljs-attr">callbacks</span> = []<span class="hljs-comment">;</span>
           var <span class="hljs-attr">errorHandlers</span> = []<span class="hljs-comment">;</span>
           var <span class="hljs-attr">dependenciesForCallbacks</span> = []<span class="hljs-comment">;</span>
           for (var <span class="hljs-attr">j</span> = <span class="hljs-number">0</span><span class="hljs-comment">; j &lt; moduleOutdatedDependencies.length; j++) {</span>
               var <span class="hljs-attr">dependency</span> = moduleOutdatedDependencies[j]<span class="hljs-comment">;</span>
               var <span class="hljs-attr">acceptCallback</span> = module.hot._acceptedDependencies[dependency]<span class="hljs-comment">;</span>
               var <span class="hljs-attr">errorHandler</span> = module.hot._acceptedErrorHandlers[dependency]<span class="hljs-comment">;</span>
               if (acceptCallback) {
                   if (callbacks.indexOf(acceptCallback) !== -1) continue<span class="hljs-comment">;</span>
                   callbacks.push(acceptCallback)<span class="hljs-comment">;</span>
                   errorHandlers.push(errorHandler)<span class="hljs-comment">;</span>
                   dependenciesForCallbacks.push(dependency)<span class="hljs-comment">;</span>
               }
           }
           for (var <span class="hljs-attr">k</span> = <span class="hljs-number">0</span><span class="hljs-comment">; k &lt; callbacks.length; k++) {</span>
               callbacks<span class="hljs-section">[k]</span>.call(null, moduleOutdatedDependencies)<span class="hljs-comment">;</span>
           }
       }
   }

   // Load self accepted modules：重新加载标识_selfAccepted的module，这种模块会重新require一次
   for (var <span class="hljs-attr">o</span> = <span class="hljs-number">0</span><span class="hljs-comment">; o &lt; outdatedSelfAcceptedModules.length; o++) {</span>
       var <span class="hljs-attr">item</span> = outdatedSelfAcceptedModules[o]<span class="hljs-comment">;</span>
       var <span class="hljs-attr">moduleId</span> = item.module<span class="hljs-comment">;</span>

       item.require(moduleId)<span class="hljs-comment">;</span>
   }

   return outdatedModules<span class="hljs-comment">;</span>
  }
</code></pre>
<h2 data-id="heading-12">总结</h2>
<p>前端构建工具让模块管理、资源打包和优化变得高效，提升了开发体验和应用性能。Webpack 的工作原理尤其值得学习：从模块解析、依赖图构建，到 Chunk 生成和热更新，它展示了现代前端构建的完整机制。理解这些原理不仅能帮助我们更好地使用工具，也能为优化前端项目打下坚实基础。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Flutter 实现一个容器内部元素可平移、缩放和旋转等功能（七）]]></title>    <link>https://juejin.cn/post/7586500093844291626</link>    <guid>https://juejin.cn/post/7586500093844291626</guid>    <pubDate>2025-12-22T14:56:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586500093844291626" data-draft-id="7586490798432256063" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Flutter 实现一个容器内部元素可平移、缩放和旋转等功能（七）"/> <meta itemprop="keywords" content="Flutter"/> <meta itemprop="datePublished" content="2025-12-22T14:56:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="名字被你们想完了"/> <meta itemprop="url" content="https://juejin.cn/user/3065854916834782"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Flutter 实现一个容器内部元素可平移、缩放和旋转等功能（七）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3065854916834782/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    名字被你们想完了
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T14:56:11.000Z" title="Mon Dec 22 2025 14:56:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Flutter 实现一个容器内部元素可平移、缩放和旋转等功能（七）</h2>
<p>Flutter: 3.35.7</p>
<p>前面我们抽取了区域的配置，主要实现了对内置区域的自定义，现在有个问题，如果是我们想自定义某个特定区域实现特定的效果，现在的数据都在部件的内部，如果不能提升到外部，那我们不能由外界传入貌似也没有什么用，因为功能需求都不一样，只有尽可能的以我现在的能力去进行封装。其实对于大多数的场景，修改内置的区域配置即可，我们就不需要考虑自定义这些，然而预留一些口子就可以极大地方便其他人使用。</p>
<p>这里就简单实现一下自定义区域，之前我们预留了自定义区域的fn，但那只是一个简单的占位，如果用户想自定义一些区域实现部分的功能，基本上就是对当前选中元素的操作，我们将可以给出的数据给到用户，让用户自行计算，并将计算完成的元素返回：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">typedef</span> AreaFunction = ElementModel <span class="hljs-built_in">Function</span>({
  <span class="hljs-comment">/// <span class="markdown">点击的坐标</span></span>
  <span class="hljs-keyword">required</span> Offset tapPoint,
  <span class="hljs-comment">/// <span class="markdown">选中的元素</span></span>
  <span class="hljs-keyword">required</span> ElementModel element,
  <span class="hljs-comment">/// <span class="markdown">容器的宽度</span></span>
  <span class="hljs-keyword">required</span> <span class="hljs-built_in">double</span> containerWidth,
  <span class="hljs-comment">/// <span class="markdown">容器的高度</span></span>
  <span class="hljs-keyword">required</span> <span class="hljs-built_in">double</span> containerHeight,
  <span class="hljs-comment">/// <span class="markdown">移动的坐标</span></span>
  Offset? movePoint,
});
</code></pre>
<p>接下来我们基于此实现一个简单的点击将元素移动到容器中心的功能，用这个例子来大概说明一下自定义区域的使用。我们之前实现了初始化区域配置的函数，现在加入自定义的区域，所以我们得对其进行改造：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">/// <span class="markdown">初始化响应区域</span></span>
<span class="hljs-keyword">void</span> _initArea() {
  <span class="hljs-comment">// 初始为配置里面定义的</span>
  <span class="hljs-built_in">List</span>&lt;ResponseAreaModel&gt; areaList = [...ConstantsConfig.baseAreaList];

  <span class="hljs-keyword">if</span> (widget.areaConfigList != <span class="hljs-keyword">null</span>) {
    <span class="hljs-comment">// 将外界传递的配置合并</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> area <span class="hljs-keyword">in</span> widget.areaConfigList!) {
      <span class="hljs-keyword">final</span> <span class="hljs-built_in">int</span> index = areaList.indexWhere((item) =&gt; item.status == area.status);

      <span class="hljs-comment">// 如果是内置的区域，则修改配置</span>
      <span class="hljs-keyword">if</span> (index &gt; <span class="hljs-number">-1</span>) {
        <span class="hljs-comment">// 如果是不使用，则移除</span>
        <span class="hljs-keyword">if</span> (area.use == <span class="hljs-keyword">false</span>) {
          areaList.removeAt(index);
        } <span class="hljs-keyword">else</span> {
          <span class="hljs-comment">// 否则进行修改配置</span>
          areaList[index].copyWith(
            xRatio: area.xRatio,
            yRatio: area.yRatio,
            icon: area.icon,
            fn: area.fn,
          );
        }
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// 如果是自定义的区域，我们默认该有的参数是存在的</span>
        areaList.add(ResponseAreaModel(
          areaWidth: ConstantsConfig.minSize,
          areaHeight: ConstantsConfig.minSize,
          xRatio: area.xRatio!,
          yRatio: area.yRatio!,
          trigger: area.trigger,
          icon: area.icon!,
          status: area.status,
          fn: area.fn,
        ));
      }
    }
  }

  setState(() {
    _areaList = areaList;
  });
}
</code></pre>
<p>配置（已经让外界传入）：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 外界容器</span>
<span class="hljs-comment">// 其他省略...</span>

<span class="hljs-keyword">late</span> <span class="hljs-built_in">List</span>&lt;CustomAreaConfig&gt; _customAreaList;

<span class="hljs-meta">@override</span>
<span class="hljs-keyword">void</span> initState() {
  <span class="hljs-keyword">super</span>.initState();

  _customAreaList = [
    <span class="hljs-comment">// 不使用缩放区域</span>
    CustomAreaConfig(
      status: ElementStatus.scale.value,
      use: <span class="hljs-keyword">false</span>,
    ),
    <span class="hljs-comment">// 将旋转移到右下角</span>
    CustomAreaConfig(
      status: ElementStatus.rotate.value,
      xRatio: <span class="hljs-number">1</span>,
      yRatio: <span class="hljs-number">1</span>,
    ),
    <span class="hljs-comment">// 测试自定义区域</span>
    CustomAreaConfig(
      status: <span class="hljs-string">'center'</span>,
      xRatio: <span class="hljs-number">0</span>,
      yRatio: <span class="hljs-number">1</span>,
      icon: <span class="hljs-string">'assets/images/icon_center.png'</span>,
      trigger: TriggerMethod.down,
      fn: _centerFn,
    ),
  ];
}

<span class="hljs-comment">/// <span class="markdown">测试自定义区域的函数</span></span>
ElementModel _centerFn({
  <span class="hljs-comment">/// <span class="markdown">点击的坐标</span></span>
  <span class="hljs-keyword">required</span> Offset tapPoint,
  <span class="hljs-comment">/// <span class="markdown">选中的元素</span></span>
  <span class="hljs-keyword">required</span> ElementModel element,
  <span class="hljs-comment">/// <span class="markdown">容器的宽度</span></span>
  <span class="hljs-keyword">required</span> <span class="hljs-built_in">double</span> containerWidth,
  <span class="hljs-comment">/// <span class="markdown">容器的高度</span></span>
  <span class="hljs-keyword">required</span> <span class="hljs-built_in">double</span> containerHeight,
  <span class="hljs-comment">/// <span class="markdown">移动的坐标</span></span>
  Offset? movePoint,
}) {
  <span class="hljs-keyword">return</span> ElementModel(
    id: element.id,
    elementWidth: element.elementWidth,
    elementHeight: element.elementHeight,
  );
}

<span class="hljs-comment">// 其他省略...</span>

Column(
  children: [
    Expanded(
      child: MultipleTransformContainer(
        <span class="hljs-comment">// 传入配置</span>
        areaConfigList: _customAreaList,
      ),
    ),
  ],
),
</code></pre>
<p>运行效果：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9ed2b18dd54640fab244c3a0c26f9998~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCN5a2X6KKr5L2g5Lus5oOz5a6M5LqG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767020171&amp;x-signature=AnplTG3MLp7X0bvXyyJOg3YmT6c%3D" alt="image01.gif" loading="lazy"/></p>
<p>可以看到我们定义了左下角为自定义区域，其他内置的区域配置也生效了，接下来我们来实现这个区域的方法。在实现之前，我们得对按下事件函数、移动事件函数和更新属性函数进行逻辑新增，新增如果是点击的自定义区域，则响应自定义的方法，将必要参数传递过去：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">/// <span class="markdown">当前元素属性变化的时候更新列表中对应元素的属性</span></span>
<span class="hljs-comment">///</span>
<span class="hljs-comment">/// <span class="markdown">因为可能是触发用户的自定义区域，</span></span>
<span class="hljs-comment">/// <span class="markdown">所以如果是用户自定义的区域，则将对应元素的属性修改成用户计算后的元素属性</span></span>
<span class="hljs-keyword">void</span> _onChange({ElementModel? data}) {
  <span class="hljs-keyword">if</span> (_currentElement == <span class="hljs-keyword">null</span> || _temporary == <span class="hljs-keyword">null</span>) <span class="hljs-keyword">return</span>;

  <span class="hljs-keyword">final</span> ElementModel? tempElement = data ?? _currentElement;
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; _elementList.length; i++) {
    <span class="hljs-keyword">final</span> ElementModel item = _elementList[i];

    <span class="hljs-keyword">if</span> (item.id == tempElement?.id) {
      _elementList[i] = item.copyWith(
        x: tempElement?.x,
        y: tempElement?.y,
        elementWidth: tempElement?.elementWidth,
        elementHeight: tempElement?.elementHeight,
        rotationAngle: tempElement?.rotationAngle,
      );
      setState(() {});
      <span class="hljs-keyword">break</span>;
    }
  }
}

<span class="hljs-comment">/// <span class="markdown">处理自定义事件</span></span>
<span class="hljs-comment">///</span>
<span class="hljs-comment">/// <span class="markdown">通过当前状态[status]来确定是否是自定义区域, 如果是,</span></span>
<span class="hljs-comment">/// <span class="markdown">则将按下坐标 [tapPoint], 移动坐标 [movePoint] (如果是移动状态),</span></span>
<span class="hljs-comment">/// <span class="markdown">和当前元素[element]传递过去用于自定义的计算</span></span>
<span class="hljs-keyword">void</span> _onCustomFn({
  <span class="hljs-keyword">required</span> ElementModel element,
  <span class="hljs-keyword">required</span> Offset tapPoint,
  <span class="hljs-keyword">required</span> <span class="hljs-built_in">String?</span> status,
  Offset? movePoint,
}) {
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">int</span> index = _areaList.indexWhere((item) =&gt; item.status == status);

  <span class="hljs-keyword">if</span> (index &gt; <span class="hljs-number">-1</span>) {
    <span class="hljs-keyword">final</span> ResponseAreaModel item = _areaList[index];

    <span class="hljs-keyword">if</span> (item.fn != <span class="hljs-keyword">null</span>) {
      <span class="hljs-keyword">final</span> ElementModel data = item.fn!(
        tapPoint: tapPoint,
        element: element,
        movePoint: movePoint,
        containerHeight: _containerHeight,
        containerWidth: _containerWidth,
      );
      _onChange(data: data);
    }
  }
}

<span class="hljs-comment">/// <span class="markdown">按下事件</span></span>
<span class="hljs-keyword">void</span> _onPanDown(DragDownDetails details) {
  <span class="hljs-comment">// 其他省略...</span>

  <span class="hljs-comment">// 新增判断</span>
  <span class="hljs-comment">// 如果当前有选中的元素且和点击区域的currentElement是一个元素</span>
  <span class="hljs-comment">// 并且 temp 的 status对应的触发方式为点击，那么就响应对应的点击事件</span>
  <span class="hljs-keyword">if</span> (currentElement?.id == _currentElement?.id &amp;&amp; temp.trigger == TriggerMethod.down) {
    <span class="hljs-keyword">final</span> <span class="hljs-built_in">Function?</span> fn = _onElementStatus(x: dx, y: dy)[temp.status];

    <span class="hljs-keyword">if</span> (fn != <span class="hljs-keyword">null</span>) {
      fn();
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">// final int index = _areaList.indexWhere((item) =&gt; item.status == temp.status);</span>
      <span class="hljs-comment">//</span>
      <span class="hljs-comment">// if (index &gt; -1) {</span>
      <span class="hljs-comment">//   final ResponseAreaModel item = _areaList[index];</span>
      <span class="hljs-comment">//</span>
      <span class="hljs-comment">//   if (item.fn != null) {</span>
      <span class="hljs-comment">//     final ElementModel data = item.fn!(</span>
      <span class="hljs-comment">//       tapPoint: Offset(dx, dy),</span>
      <span class="hljs-comment">//       element: currentElement!,</span>
      <span class="hljs-comment">//       containerHeight: _containerHeight,</span>
      <span class="hljs-comment">//       containerWidth: _containerWidth,</span>
      <span class="hljs-comment">//     );</span>
      <span class="hljs-comment">//     _onChange(data: data);</span>
      <span class="hljs-comment">//   }</span>
      <span class="hljs-comment">// }</span>
      <span class="hljs-comment">// 新增处理自定义函数</span>
      _onCustomFn(
        element: currentElement!,
        tapPoint: Offset(dx, dy),
        status: temp.status,
      );
    }

    <span class="hljs-keyword">if</span> (temp.status == ElementStatus.deleteStatus.value) {
      <span class="hljs-comment">// 因为是删除，就置空选中，让下面代码执行最后的清除</span>
      currentElement = <span class="hljs-keyword">null</span>;
    }
  }

  <span class="hljs-comment">// 其他省略...</span>
}

<span class="hljs-comment">/// <span class="markdown">按下移动事件</span></span>
<span class="hljs-keyword">void</span> _onPanUpdate(DragUpdateDetails details) {
  <span class="hljs-comment">// 其他省略...</span>

  <span class="hljs-comment">// if (_temporary?.trigger == TriggerMethod.move &amp;&amp; fn != null) fn();</span>
  <span class="hljs-keyword">if</span> (_temporary?.trigger == TriggerMethod.move) {
    <span class="hljs-keyword">if</span> (fn != <span class="hljs-keyword">null</span>) {
      fn();
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">// 新增处理自定义函数</span>
      _onCustomFn(
        element: _currentElement!,
        tapPoint: _startPosition,
        movePoint: Offset(x, y),
        status: _temporary?.status,
      );
    }
  }
}
</code></pre>
<p>接下来我们简单实现自定义区域的功能</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">/// <span class="markdown">测试自定义区域的函数</span></span>
ElementModel _centerFn({
  <span class="hljs-comment">/// <span class="markdown">点击的坐标</span></span>
  <span class="hljs-keyword">required</span> Offset tapPoint,
  <span class="hljs-comment">/// <span class="markdown">选中的元素</span></span>
  <span class="hljs-keyword">required</span> ElementModel element,
  <span class="hljs-comment">/// <span class="markdown">容器的宽度</span></span>
  <span class="hljs-keyword">required</span> <span class="hljs-built_in">double</span> containerWidth,
  <span class="hljs-comment">/// <span class="markdown">容器的高度</span></span>
  <span class="hljs-keyword">required</span> <span class="hljs-built_in">double</span> containerHeight,
  <span class="hljs-comment">/// <span class="markdown">移动的坐标</span></span>
  Offset? movePoint,
}) {
  <span class="hljs-comment">// 计算容器中心</span>
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> x = (containerWidth - element.elementWidth) / <span class="hljs-number">2</span>;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> y = (containerHeight - element.elementHeight) / <span class="hljs-number">2</span>;

  <span class="hljs-keyword">return</span> ElementModel(
    id: element.id,
    elementWidth: element.elementWidth,
    elementHeight: element.elementHeight,
    x: x,
    y: y,
    rotationAngle: element.rotationAngle,
  );
}
</code></pre>
<p>运行效果：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7d8d996753f945138299a33c8fbd9206~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCN5a2X6KKr5L2g5Lus5oOz5a6M5LqG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767020171&amp;x-signature=JD6x2AdRT8K8Zpya8MathoqUbMs%3D" alt="image02.gif" loading="lazy"/></p>
<p>这样我们就对自定义区域及事件做出了响应，虽然可能很少使用，但因为预留了这个口子而多了一丝灵活性。如果还需要实现其他自定义可能，可以按照类似的方式来实现。</p>
<p>感兴趣的也可以关注我的微信公众号【前端学习小营地】，不定时会分享一些小功能～</p>
<p>好了，今天的分享就结束了，后续就开始实现容器属性的设置了，比如辅助线，比如撤销还原。感谢阅读～拜拜～</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Flutter 实现一个容器内部元素可平移、缩放和旋转等功能（八）]]></title>    <link>https://juejin.cn/post/7586540799250874422</link>    <guid>https://juejin.cn/post/7586540799250874422</guid>    <pubDate>2025-12-22T15:02:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586540799250874422" data-draft-id="7586500093844340778" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Flutter 实现一个容器内部元素可平移、缩放和旋转等功能（八）"/> <meta itemprop="keywords" content="Flutter,前端"/> <meta itemprop="datePublished" content="2025-12-22T15:02:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="名字被你们想完了"/> <meta itemprop="url" content="https://juejin.cn/user/3065854916834782"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Flutter 实现一个容器内部元素可平移、缩放和旋转等功能（八）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3065854916834782/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    名字被你们想完了
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T15:02:09.000Z" title="Mon Dec 22 2025 15:02:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Flutter 实现一个容器内部元素可平移、缩放和旋转等功能（八）</h2>
<p>Flutter: 3.35.7</p>
<p>前面我们实现了元素的变换操作，单纯的变换操作只是为了后续功能的实现，接下来我们就开始扩展容器的属性。</p>
<p>我们要新增容器功能的扩展，那么就要划分新的区域来实现这部分功能，所以我们得重新规划和计算。</p>
<p>有许多方式实现扩展功能区域，第一种就是划分区域，划分下面为属性扩展区域，元素变换区域则会相应的压缩，所以涉及到变换的计算有使用到容器宽高属性的都要变化；第二种就是将功能区域设计成一个底部弹框覆盖在元素变换区域，在元素变换过程中隐藏，未变换就展示，这样就不用更改，不过得制定弹出时机。这里我们使用第一种，感兴趣的可以自行研究第二种。</p>
<p>常量新增配置：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">/// <span class="markdown">底部功能区域的高度</span></span>
<span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> <span class="hljs-built_in">double</span> bottomHeight = <span class="hljs-number">100</span>;
<span class="hljs-comment">/// <span class="markdown">变换区域的左右margin</span></span>
<span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> <span class="hljs-built_in">double</span> transformMargin = <span class="hljs-number">20</span>;
</code></pre>
<p>重新计算宽高、重新设计布局和更改变换过程中应用到容器宽高的计算（将变换计算中的_containerWidth换成_transformWidth，_containerHeight换成_transformHeight）：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">/// <span class="markdown">变换区域的宽</span></span>
<span class="hljs-built_in">double</span> <span class="hljs-keyword">get</span> _transformWidth {
  <span class="hljs-keyword">return</span> _width - ConstantsConfig.transformMargin * <span class="hljs-number">2</span>;
}

<span class="hljs-comment">/// <span class="markdown">变换区域的高</span></span>
<span class="hljs-built_in">double</span> <span class="hljs-keyword">get</span> _transformHeight {
  <span class="hljs-keyword">return</span> _height - ConstantsConfig.bottomHeight;
}

<span class="hljs-comment">/// <span class="markdown">最终容器的宽</span></span>
<span class="hljs-built_in">double</span> <span class="hljs-keyword">get</span> _width {
  <span class="hljs-keyword">return</span> _containerWidth == <span class="hljs-number">0</span> ? (widget.containerWidth ?? <span class="hljs-built_in">double</span>.infinity) : _containerWidth;
}

<span class="hljs-comment">/// <span class="markdown">最终容器的高</span></span>
<span class="hljs-built_in">double</span> <span class="hljs-keyword">get</span> _height {
  <span class="hljs-keyword">return</span> _containerHeight == <span class="hljs-number">0</span> ? (widget.containerHeight ?? <span class="hljs-built_in">double</span>.infinity) : _containerHeight;
}

SizedBox(
  key: _multipleTransformContainerGlobalKey,
  width: _width,
  height: _height,
  child: _containerWidth == <span class="hljs-number">0</span> || _containerHeight == <span class="hljs-number">0</span> ? <span class="hljs-keyword">null</span> : Column(
    children: [
      <span class="hljs-comment">// 变换区域</span>
      GestureDetector(
        <span class="hljs-comment">// 其他省略...</span>
        child: Container(
          width: _transformWidth,
          height: _transformHeight,
          margin: EdgeInsets.symmetric(
            horizontal: ConstantsConfig.transformMargin,
          ),
          color: Colors.white,
          child: _containerWidth == <span class="hljs-number">0</span> || _containerHeight == <span class="hljs-number">0</span> ? <span class="hljs-keyword">null</span> : Stack(
            <span class="hljs-comment">// 其他省略...</span>
          ),
        ),
      ),
      <span class="hljs-comment">// 底部功能区域</span>
      Container(
        height: ConstantsConfig.bottomHeight,
        color: Colors.white60,
      ),
    ],
  ),
);
</code></pre>
<p>运行效果：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e59a4852538c435ca23cde93a934c63f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCN5a2X6KKr5L2g5Lus5oOz5a6M5LqG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767020529&amp;x-signature=W8Mm995kSWN0yuSfGmwGV9HKMWE%3D" alt="image01.png" loading="lazy"/></p>
<p>顺便将使用外层的容器设置了顶部边距。</p>
<p>后续的功能扩展就在这个小小的区域上面实现。规划完区域，我们就要对变换元素做出修改，总不可能一直操作一个矩形吧；按照部分经验，这种功能操作的大多数是图片+文本，所以我们以这两种来划分元素的类型为例，后续如果有新的类型再增加即可。</p>
<p>新增元素类型：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">enum</span> ElementType {
  <span class="hljs-comment">/// <span class="markdown">图片</span></span>
  imageType(type: <span class="hljs-string">'image'</span>),
  <span class="hljs-comment">/// <span class="markdown">文本</span></span>
  textType(type: <span class="hljs-string">'text'</span>),;

  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> type;
  <span class="hljs-keyword">const</span> ElementType({<span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.type});
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ElementModel</span> </span>{
  <span class="hljs-comment">// 其他省略...</span>

  <span class="hljs-comment">/// <span class="markdown">元素的类型</span></span>
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> type;
  <span class="hljs-comment">/// <span class="markdown">如果是元素是图片类型，图片的path</span></span>
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String?</span> imagePath;
  <span class="hljs-comment">/// <span class="markdown">如果元素是文本类型，文本属性</span></span>
  <span class="hljs-keyword">final</span> ElementTextOptions? textOptions;

  <span class="hljs-comment">// 其他省略...</span>
}

<span class="hljs-comment">// 其他省略...</span>

<span class="hljs-keyword">enum</span> TextAlignType {
  left(type: <span class="hljs-string">'left'</span>, textAlign: TextAlign.left),
  right(type: <span class="hljs-string">'right'</span>, textAlign: TextAlign.right),
  center(type: <span class="hljs-string">'center'</span>, textAlign: TextAlign.center),
  justify(type: <span class="hljs-string">'justify'</span>, textAlign: TextAlign.justify),
  ;

  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String?</span> type;
  <span class="hljs-keyword">final</span> TextAlign textAlign;
  <span class="hljs-keyword">const</span> TextAlignType({
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.type,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.textAlign,
  });
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ElementTextOptions</span> </span>{
  <span class="hljs-keyword">const</span> ElementTextOptions({
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.text,
    <span class="hljs-keyword">this</span>.textHeight = ConstantsConfig.initFontHeight,
    <span class="hljs-keyword">this</span>.fontSize = ConstantsConfig.initFontSize,
    <span class="hljs-keyword">this</span>.fontColor = Colors.black,
    <span class="hljs-keyword">this</span>.fontWeight,
    <span class="hljs-keyword">this</span>.fontFamily,
    <span class="hljs-keyword">this</span>.textAlign = ConstantsConfig.initFontAlign,
    <span class="hljs-keyword">this</span>.letterSpacing,
  });

  <span class="hljs-comment">/// <span class="markdown">文本内容</span></span>
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> text;
  <span class="hljs-comment">/// <span class="markdown">文本行高</span></span>
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> textHeight;
  <span class="hljs-comment">/// <span class="markdown">文本大小</span></span>
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> fontSize;
  <span class="hljs-comment">/// <span class="markdown">文本颜色</span></span>
  <span class="hljs-keyword">final</span> Color fontColor;
  <span class="hljs-comment">/// <span class="markdown">文本字重（100-1000，1000就是bold）</span></span>
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">int?</span> fontWeight;
  <span class="hljs-comment">/// <span class="markdown">文本字体</span></span>
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String?</span> fontFamily;
  <span class="hljs-comment">/// <span class="markdown">文本对齐方式</span></span>
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String?</span> textAlign;
  <span class="hljs-comment">/// <span class="markdown">文本字间距</span></span>
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">double?</span> letterSpacing;

  ElementTextOptions copyWith({
    <span class="hljs-built_in">String?</span> text,
    <span class="hljs-built_in">double?</span> textHeight,
    <span class="hljs-built_in">double?</span> fontSize,
    Color? fontColor,
    <span class="hljs-built_in">int?</span> fontWeight,
    <span class="hljs-built_in">String?</span> fontFamily,
    <span class="hljs-built_in">String?</span> textAlign,
    <span class="hljs-built_in">double?</span> letterSpacing,
  }) {
    <span class="hljs-keyword">return</span> ElementTextOptions(
      text: text ?? <span class="hljs-keyword">this</span>.text,
      textHeight: textHeight ?? <span class="hljs-keyword">this</span>.textHeight,
      fontSize: fontSize ?? <span class="hljs-keyword">this</span>.fontSize,
      fontColor: fontColor ?? <span class="hljs-keyword">this</span>.fontColor,
      fontWeight: fontWeight ?? <span class="hljs-keyword">this</span>.fontWeight,
      fontFamily: fontFamily ?? <span class="hljs-keyword">this</span>.fontFamily,
      textAlign: textAlign ?? <span class="hljs-keyword">this</span>.textAlign,
      letterSpacing: letterSpacing ?? <span class="hljs-keyword">this</span>.letterSpacing,
    );
  }
}
</code></pre>
<p>定义完属性，我们就开始新增图片元素，在功能区新增图片选择按钮，从本地文件中选择图片，所以我们得增加图片选择插件(image_picker)，在获取到图片的时候再将部分必要信息填充，然后将选择的图片添加到元素列表中即可：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 其他省略...</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ImageElementAdd</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatefulWidget</span> </span>{
  <span class="hljs-keyword">const</span> ImageElementAdd({
    <span class="hljs-keyword">super</span>.key,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.transformWidth,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.transformHeight,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.addElement,
  });

  <span class="hljs-comment">/// <span class="markdown">变换区域的宽，用于计算选择图片的初始宽度</span></span>
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> transformWidth;
  <span class="hljs-comment">/// <span class="markdown">变换区域的高，用于计算选择图片的初始高度</span></span>
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> transformHeight;
  <span class="hljs-comment">/// <span class="markdown">新增元素方法，用于将选择的图片添加到元素列表中</span></span>
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">Function</span>(ElementModel) addElement;

  <span class="hljs-meta">@override</span>
  State&lt;ImageElementAdd&gt; createState() =&gt; _ImageElementAddState();
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_ImageElementAddState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State</span>&lt;<span class="hljs-title">ImageElementAdd</span>&gt; </span>{
  <span class="hljs-comment">/// <span class="markdown">选择图片</span></span>
  Future&lt;<span class="hljs-keyword">void</span>&gt; _imagePicker() <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">final</span> ImagePicker picker = ImagePicker();
    <span class="hljs-keyword">final</span> XFile? imageFile = <span class="hljs-keyword">await</span> picker.pickImage(source: ImageSource.gallery);

    <span class="hljs-keyword">if</span> (imageFile != <span class="hljs-keyword">null</span>) {
      <span class="hljs-keyword">final</span> imageInfo = <span class="hljs-keyword">await</span> _loadImageFromFile(imageFile.path);

      widget.addElement(ElementModel(
        id: <span class="hljs-built_in">DateTime</span>.now().millisecondsSinceEpoch,
        elementWidth: imageInfo.$<span class="hljs-number">1</span>,
        elementHeight: imageInfo.$<span class="hljs-number">2</span>,
        type: ElementType.imageType.type,
        imagePath: imageFile.path,
      ));
    }
  }

  <span class="hljs-comment">/// <span class="markdown">从本地文件加载图片并获取宽高</span></span>
  <span class="hljs-comment">///</span>
  <span class="hljs-comment">/// <span class="markdown">通过[filePath]获取这张图片的宽高</span></span>
  Future&lt;(<span class="hljs-built_in">double</span>, <span class="hljs-built_in">double</span>)&gt; _loadImageFromFile(<span class="hljs-built_in">String</span> filePath) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">final</span> file = File(filePath);
    <span class="hljs-keyword">final</span> bytes = <span class="hljs-keyword">await</span> file.readAsBytes();
    <span class="hljs-keyword">final</span> codec = <span class="hljs-keyword">await</span> ui.instantiateImageCodec(bytes);
    <span class="hljs-keyword">final</span> frame = <span class="hljs-keyword">await</span> codec.getNextFrame();
    <span class="hljs-keyword">final</span> imageInfo = frame.image;

    <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> imageWidth = imageInfo.width.toDouble();
    <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> imageHeight = imageInfo.height.toDouble();
    <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> tempContainerWidth = widget.transformWidth / <span class="hljs-number">2</span>;
    <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> tempContainerHeight = widget.transformHeight / <span class="hljs-number">2</span>;
    <span class="hljs-built_in">double</span> tempWidth = imageWidth;
    <span class="hljs-built_in">double</span> tempHeight = imageHeight;

    <span class="hljs-comment">// 以长边来设置图片的最终初始宽高</span>
    <span class="hljs-keyword">if</span> (imageWidth &gt;= imageHeight) {
      tempWidth = imageWidth &gt; tempContainerWidth ? tempContainerWidth : imageWidth;
      tempHeight = (tempWidth / imageWidth) * imageHeight;
    } <span class="hljs-keyword">else</span> {
      tempHeight = imageHeight &gt; tempContainerHeight ? tempContainerHeight : imageHeight;
      tempWidth = (tempHeight / imageHeight) * imageWidth;
    }

    <span class="hljs-keyword">return</span> (tempWidth, tempHeight);
  }

  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> ElevatedButton(
      onPressed: _imagePicker,
      child: Text(<span class="hljs-string">'图片选择'</span>),
    );
  }
}
</code></pre>
<p>运行效果：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/db57886f6de2439c90d92465ad5384ea~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCN5a2X6KKr5L2g5Lus5oOz5a6M5LqG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767020529&amp;x-signature=WYEt4vImxZ3qv0GKYQdt3gUsKrQ%3D" alt="image02.gif" loading="lazy"/></p>
<p>这样我们就简单实现了图片元素的新增。接下来我们简单实现文本元素的新增。文本元素就需要考虑多些了，因为涉及到文本属性的修改，新增的时候将对应的属性修改放开，后续也涉及到编辑，所以封装成一个部件，为了后续能更好的展示，我们封装成一个Positioned，通过控制状态来展示：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 其他省略...</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TextOptions</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatefulWidget</span> </span>{
  <span class="hljs-keyword">const</span> TextOptions({
    <span class="hljs-keyword">super</span>.key,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.transformWidth,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.isShow,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.addElement,
  });

  <span class="hljs-comment">/// <span class="markdown">变换区域的宽，用于计算选择文本元素的最大宽度</span></span>
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> transformWidth;
  <span class="hljs-comment">/// <span class="markdown">文本元素属性部件是否展示</span></span>
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">bool</span> isShow;
  <span class="hljs-comment">/// <span class="markdown">新增元素方法，用于新增文本部件</span></span>
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">Function</span>(ElementModel) addElement;

  <span class="hljs-meta">@override</span>
  State&lt;TextOptions&gt; createState() =&gt; _TextOptionsState();
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_TextOptionsState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State</span>&lt;<span class="hljs-title">TextOptions</span>&gt; </span>{
  <span class="hljs-comment">/// <span class="markdown">新增文本元素</span></span>
  <span class="hljs-keyword">void</span> _onAddTextElement(<span class="hljs-built_in">String</span> text) {}

  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> AnimatedPositioned(
      duration: <span class="hljs-built_in">Duration</span>(milliseconds: <span class="hljs-number">100</span>),
      left: <span class="hljs-number">0</span>,
      right: <span class="hljs-number">0</span>,
      bottom: widget.isShow ? <span class="hljs-number">0</span> : -ConstantsConfig.fontOptionsWidgetHeight,
      child: Container(
        padding: EdgeInsets.all(<span class="hljs-number">20</span>),
        color: Colors.white,
        height: ConstantsConfig.fontOptionsWidgetHeight,
        child: TextField(
          style: TextStyle(
            fontSize: <span class="hljs-number">15</span>,
            fontWeight: FontWeight.w600,
            height: <span class="hljs-number">1.333</span>,
          ),
          decoration: InputDecoration(
            isCollapsed: <span class="hljs-keyword">true</span>,
            contentPadding: EdgeInsets.zero,
            border: InputBorder.none,
            counter: <span class="hljs-keyword">const</span> Offstage(),
            hintText: <span class="hljs-string">'请输入'</span>,
            hintStyle: TextStyle(
              fontSize: <span class="hljs-number">15</span>,
              fontWeight: FontWeight.w600,
              height: <span class="hljs-number">1.333</span>,
            ),
          ),
          onSubmitted: _onAddTextElement,
        ),
      ),
    );
  }
}
</code></pre>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 其他省略...</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TextElementAdd</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatefulWidget</span> </span>{
  <span class="hljs-keyword">const</span> TextElementAdd({
    <span class="hljs-keyword">super</span>.key,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.onShowTextOptions,
  });

  <span class="hljs-comment">/// <span class="markdown">展示文本属性部件</span></span>
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">Function</span>(<span class="hljs-built_in">bool</span>) onShowTextOptions;

  <span class="hljs-meta">@override</span>
  State&lt;TextElementAdd&gt; createState() =&gt; _TextElementAddState();
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_TextElementAddState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State</span>&lt;<span class="hljs-title">TextElementAdd</span>&gt; </span>{
  <span class="hljs-keyword">void</span> _onShowText() {
    widget.onShowTextOptions(<span class="hljs-keyword">true</span>);
  }

  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> ElevatedButton(
      onPressed: _onShowText,
      child: Text(
        <span class="hljs-string">'文本'</span>,
        style: TextStyle(
          fontSize: <span class="hljs-number">12</span>,
        ),
      ),
    );
  }
}
</code></pre>
<p>运行效果：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2c8a2e6843e8456a9f2556858a1e4060~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCN5a2X6KKr5L2g5Lus5oOz5a6M5LqG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767020529&amp;x-signature=KFeSoFScg9UVU9hKUYqCJmezWWA%3D" alt="image03.gif" loading="lazy"/></p>
<p>接下来就在这个基础上实现新增文本的逻辑。首先，新增文本的时候我也也要得到这个字符串应该拥有的宽高。通过 flutter 提供的 TextPainter 来获取：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">/// <span class="markdown">计算文本的宽高</span></span>
<span class="hljs-comment">///</span>
<span class="hljs-comment">/// <span class="markdown">传入文本字符串[text]、文本的样式[style]和最大的宽度[maxWidth]来计算文本的宽高</span></span>
<span class="hljs-keyword">static</span> (<span class="hljs-built_in">double</span>, <span class="hljs-built_in">double</span>) calculateTextSize({
  <span class="hljs-keyword">required</span> <span class="hljs-built_in">String</span> text,
  <span class="hljs-keyword">required</span> TextStyle style,
  <span class="hljs-keyword">required</span> <span class="hljs-built_in">double</span> maxWidth
}) {
  <span class="hljs-keyword">if</span> (text.isEmpty) {
    <span class="hljs-keyword">return</span> (<span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
  }

  <span class="hljs-keyword">final</span> TextPainter textPainter = TextPainter(
    text: TextSpan(text: text, style: style),
    textDirection: TextDirection.ltr,
  )..layout(maxWidth: maxWidth);
  <span class="hljs-keyword">final</span> tempWidth = textPainter.width;
  <span class="hljs-keyword">final</span> tempHeight = textPainter.height;
  <span class="hljs-comment">// 不能小于最小值</span>
  <span class="hljs-keyword">final</span> minSize = ConstantsConfig.minSize;

  <span class="hljs-keyword">return</span> (
    tempWidth &lt;= minSize ? minSize : tempWidth,
    tempHeight &lt;= minSize ? minSize : tempHeight
  );
}
</code></pre>
<p>获取到文本元素的宽高后，就可以实现新增的逻辑了：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">/// <span class="markdown">新增文本元素</span></span>
<span class="hljs-keyword">void</span> _onAddTextElement(<span class="hljs-built_in">String</span> text) {
  <span class="hljs-comment">// 一些初始化的文本属性</span>
  TextStyle style = TextStyle(
    fontSize: ConstantsConfig.initFontSize,
    height: ConstantsConfig.initFontHeight,
  );

  <span class="hljs-keyword">final</span> (tempWidth, tempHeight) = TransformUtils.calculateTextSize(
    text: text,
    style: style,
    maxWidth: widget.transformWidth,
  );

  widget.addElement(ElementModel(
    id: <span class="hljs-built_in">DateTime</span>.now().millisecondsSinceEpoch,
    elementHeight: tempHeight,
    elementWidth: tempWidth,
    type: ElementType.textType.type,
    textOptions: ElementTextOptions(text: text),
  ));
}
</code></pre>
<p>运行效果：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/408f1af88dd3444db8aa4afcdc27d711~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCN5a2X6KKr5L2g5Lus5oOz5a6M5LqG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767020529&amp;x-signature=i1TCvmzqvF%2Fp6MqD6blgq%2BlIltM%3D" alt="image04.gif" loading="lazy"/></p>
<p>这样我们就简单实现了新增文本元素，下面就来设计文本元素属性的修改。因为属性比较多，我们可以使用tab来分开（前面简单封装过一个tab，感兴趣的朋友可以看看），也可以使用滑动组件，这里为了方便，所以使用滑动组件（我们以行高属性为例，其他的实现类似，只是结构稍微调整即可）：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">/// <span class="markdown">设置文本的属性</span></span>
<span class="hljs-keyword">void</span> _setTextOptions(ElementTextOptions textOptions) {
  <span class="hljs-keyword">if</span> (_currentElement?.type == ElementType.textType.type) {
    TextStyle style = TextStyle(
      fontSize: textOptions.fontSize,
      height: textOptions.textHeight,
      letterSpacing: textOptions.letterSpacing,
      fontWeight: TransformUtils.getFontWeight(
        textOptions.fontWeight,
      ),
    );

    <span class="hljs-keyword">final</span> (tempWidth, tempHeight) = TransformUtils.calculateTextSize(
      text: textOptions.text,
      style: style,
      maxWidth: _currentElement!.elementWidth,
    );

    _currentElement = _currentElement?.copyWith(
      <span class="hljs-comment">// elementWidth: tempWidth,</span>
      elementHeight: tempHeight,
      textOptions: _currentElement?.textOptions?.copyWith(
        text: textOptions.text,
        textHeight: textOptions.textHeight,
        fontSize: textOptions.fontSize,
        fontColor: textOptions.fontColor,
        fontWeight: textOptions.fontWeight,
        fontFamily: textOptions.fontFamily,
        textAlign: textOptions.textAlign,
        letterSpacing: textOptions.letterSpacing,
      ),
    );
    _onChange();
  }
}
</code></pre>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">void</span> _onReduceFontHeight() {
  <span class="hljs-keyword">if</span> (widget.textOptions != <span class="hljs-keyword">null</span> &amp;&amp; widget.textOptions!.textHeight &gt; <span class="hljs-number">0</span>) {
    widget.setTextOptions(
      widget.textOptions!.copyWith(
        textHeight: (
          Decimal.parse(<span class="hljs-string">'<span class="hljs-subst">${widget.textOptions!.textHeight}</span>'</span>) - Decimal.parse(<span class="hljs-string">'0.1'</span>)
        ).toDouble(),
      ),
    );
  }
}

<span class="hljs-keyword">void</span> _onAddFontHeight() {
  <span class="hljs-keyword">if</span> (widget.textOptions != <span class="hljs-keyword">null</span>) {
    widget.setTextOptions(
      widget.textOptions!.copyWith(
        textHeight: (
          Decimal.parse(<span class="hljs-string">'<span class="hljs-subst">${widget.textOptions!.textHeight}</span>'</span>) + Decimal.parse(<span class="hljs-string">'0.1'</span>)
        ).toDouble(),
      ),
    );
  }
}
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/39d5aadcd00d4a049d563047c86252fb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCN5a2X6KKr5L2g5Lus5oOz5a6M5LqG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767020529&amp;x-signature=sN04mTDJWvuKeirxNWtE9rXIwdw%3D" alt="image05.gif" loading="lazy"/></p>
<p>这样我们就简单实现了属性的修改，样式什么的后面有时间再慢慢调整，现在只是功能为主，毕竟真实的开发总会有UI的。</p>
<p>下面快速预览一下文本属性修改的完整效果：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/564e57efe3764282b952e52c5632f152~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCN5a2X6KKr5L2g5Lus5oOz5a6M5LqG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767020529&amp;x-signature=QFC9yR2t4GdLb%2F68PpjC6uKZ1g0%3D" alt="image06.gif" loading="lazy"/></p>
<p>字体因为难得找相关的所以就暂未实现。</p>
<p>感兴趣的也可以关注我的微信公众号【前端学习小营地】，不定时会分享一些小功能～</p>
<p>好了，今天的分享到此结束了，感谢阅读～拜拜～</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI Agent 设计模式 - ReAct 模式]]></title>    <link>https://juejin.cn/post/7586555198115151878</link>    <guid>https://juejin.cn/post/7586555198115151878</guid>    <pubDate>2025-12-23T00:07:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586555198115151878" data-draft-id="7586498198149627955" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI Agent 设计模式 - ReAct 模式"/> <meta itemprop="keywords" content="前端,后端,人工智能"/> <meta itemprop="datePublished" content="2025-12-23T00:07:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="子洋"/> <meta itemprop="url" content="https://juejin.cn/user/1099167359835015"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI Agent 设计模式 - ReAct 模式
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1099167359835015/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    子洋
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T00:07:24.000Z" title="Tue Dec 23 2025 00:07:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,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) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,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) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="tomorrow">.hljs-comment,.hljs-quote{color:#8e908c}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#c82829}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5871f}.hljs-attribute{color:#eab700}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#718c00}.hljs-section,.hljs-title{color:#4271ae}.hljs-keyword,.hljs-selector-tag{color:#8959a8}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fff;color:#4d4d4c}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>上一篇我们介绍了 AI 应用的发展历程以及 Agent 的整体概念，这一篇将针对 <strong>ReAct（Reasoning + Acting）模式</strong>，并对其设计思想和工程实现进行一次更为系统、偏实战向的讲解。</p>
<p>在讲解 ReAct 之前，有必要先澄清一个经常被混用的问题：<strong>Agent 到底是什么？</strong></p>
<p>在早期以及当下大量工程实践中，不同 AI 应用对 Agent 的定义并不一致。很多所谓的 Agent，本质上更接近一个<strong>预先定义好的 AI workflow</strong>：流程、工具、策略都由应用侧提前固化，用户只是触发执行。例如，一个 WebSearch 场景往往就对应一个「搜索 Agent」，或者通过特定提示词（如 <code>/agent</code>）来唤醒一组固定的搜索工具。</p>
<p>从工程视角看，这类 Agent 更多是<strong>能力封装与产品抽象</strong>，而不是研究语境中强调的「具备自主决策与反馈能力的智能体」。也正因为如此，随着概念被频繁复用，<code>agent</code> 这个词在实际讨论中逐渐变得模糊，单独听到它已很难准确判断其具体能力边界。</p>
<p>如果暂时抛开命名争议，从实现层面抽象来看，一个 Agent 的核心逻辑其实非常简单：<strong>一个受控的循环（loop）</strong>。在这个循环中，模型不断获取上下文、进行推理、执行动作，并根据结果继续调整行为，直到满足终止条件为止。</p>
<p>在工程实现中，这个过程往往可以被近似理解为：</p>
<ul>
<li>多轮调用 LLM</li>
<li>中间可能伴随工具调用</li>
<li>有明确的退出条件（如任务完成、步数上限、token 预算）</li>
</ul>
<p>基于这样的背景，各类 Agent 设计模式（也可以称为范式或框架）逐步出现，而其中最经典、也最具代表性的，便是 <strong>ReAct 模式</strong>。该模式最早发表于 2022 年，其结构至今仍足以支撑大量中低复杂度的 Agent 场景。</p>
<h2 data-id="heading-1">ReAct 模式</h2>
<h3 data-id="heading-2">核心思想</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d2d1ed965f844c919ea69313b89065c3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2Q5rSL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767053244&amp;x-signature=qL5MuILhjAp6RcO4YY9jaQ2NlTM%3D" alt="" loading="lazy"/></p>
<p>ReAct 的提出，本质上是为了解决一个早期 LLM 应用中的割裂问题：<strong>推理与行动往往是分离的</strong>。</p>
<p>在 ReAct 出现之前，常见的两类模式分别是：</p>
<ul>
<li><strong>Reason-only</strong>：模型进行显式推理（如 CoT、Scratchpad），但不与外部环境交互</li>
<li><strong>Act-heavy / Tool-driven</strong>：模型频繁调用工具获取信息，但推理过程并不显式呈现或不与行动交错</li>
</ul>
<p>需要说明的是，这里的分类来自 ReAct 论文中的抽象对比，而并非对具体系统内部实现的严格学术归类。例如：</p>
<ul>
<li>SayCan 内部同样包含推理与可行性评估，并非“无 reasoning”</li>
<li>WebGPT 也存在内部推理过程，只是推理与行动并未以交错形式呈现给模型</li>
</ul>
<p>在这种背景下，<strong>ReAct（Reasoning + Acting）</strong> 的核心思想可以概括为一句话：</p>
<blockquote>
<p><strong>在行动中思考，在思考中决定行动。</strong></p>
</blockquote>
<p>它尝试将<strong>思考</strong>和<strong>行动</strong>统一到一个连续的闭环中，模拟人类解决问题时的自然过程：</p>
<ol>
<li><strong>Thought</strong>：分析当前状态与目标</li>
<li><strong>Action</strong>：基于判断调用工具或执行操作</li>
<li><strong>Observation</strong>：观察行动结果</li>
<li><strong>Thought</strong>：根据新信息再次推理</li>
<li>重复上述过程，直到问题解决</li>
</ol>
<p>从形式上看，ReAct 并没有引入复杂的新组件，而是通过 <strong>Thought → Action → Observation</strong> 的反复交替，显著提升了模型在多步任务、信息不完备任务中的表现稳定性。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/54b2fcf4b5c1480a843b66419e2e2a8c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2Q5rSL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767053244&amp;x-signature=sffR0OM%2BhSqLAVWpgOglV802ZW4%3D" alt="" loading="lazy"/></p>
<p>上图是 ReAct 论文中的一个示例，主要对比了 <strong>Standard、Reason Only、Act Only 以及 ReAct</strong> 四种不同范式在同一问题下的表现差异。Standard 方式直接给出答案，既不显式展开推理，也不与外部环境交互；Reason Only 虽然在回答前进行了逐步推理，但推理过程完全依赖模型自身的知识，一旦前提判断错误，结论便无法被外部信息纠正；Act Only 则能够多轮调用搜索等工具获取信息，但由于缺乏明确的推理指导，行动过程较为盲目，最终仍然得出了错误结果。相比之下，ReAct 通过多轮 <strong>Thought → Act → Observation</strong> 的交错执行，使模型能够在行动结果的反馈下不断修正推理路径，最终在后续轮次中得到正确答案。</p>
<h3 data-id="heading-3">核心实现</h3>
<p>从工程角度看，ReAct 的实现并不复杂，其本质就是一个<strong>带有终止条件的循环控制结构</strong>。可以用下面这段高度简化的伪代码来概括：</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-comment">// 简化版实现逻辑</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; maxLoops; i++) {
    <span class="hljs-comment">// 1. 思考：LLM分析当前情况，决定做什么</span>
    <span class="hljs-keyword">const</span> { thought, action, args, final } = <span class="hljs-keyword">await</span> <span class="hljs-title function_">llmThink</span>();
    
    <span class="hljs-keyword">if</span> (final) {
        <span class="hljs-comment">// 任务完成</span>
        <span class="hljs-keyword">break</span>;
    }
    
    <span class="hljs-comment">// 2. 行动：调用具体的工具</span>
    <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> <span class="hljs-title function_">callTool</span>(action, args);
    
    <span class="hljs-comment">// 3. 观察：将结果作为下一次思考的输入</span>
    context.<span class="hljs-title function_">push</span>(<span class="hljs-string">`观察到：<span class="hljs-subst">${result}</span>`</span>);
}
</code></pre>
<p>这段代码已经基本覆盖了 ReAct 的核心机制：</p>
<ul>
<li><strong>循环驱动</strong>：模型在多轮中逐步逼近目标</li>
<li><strong>模型自决策</strong>：由 LLM 决定是否继续、是否调用工具</li>
<li><strong>显式终止条件</strong>：通过 <code>final</code> 或循环上限避免失控</li>
</ul>
<p>在真实系统中，通常还会叠加更多安全与成本控制机制，例如：</p>
<ul>
<li>最大循环次数（maxLoops）</li>
<li>token 或调用预算</li>
<li>工具调用白名单</li>
</ul>
<h3 data-id="heading-4">具体实现</h3>
<p>下面将结合一份实际可运行的代码示例，展示一个简化但完整的 ReAct Agent 实现。</p>
<h4 data-id="heading-5">LLM 调用</h4>
<p>这里使用 <code>@ai-sdk</code> 封装多厂商模型调用，示例中支持 OpenAI 与 Azure OpenAI。该部分属于基础设施层，与 ReAct 本身并无强耦合，因此不再展开其原理。具体的介绍和使用方式可以看我之前写的这篇文章 <a href="https://juejin.cn/user/1099167359835015/posts" target="_blank" title="https://juejin.cn/user/1099167359835015/posts">《AI 开发者必备：Vercel AI SDK 轻松搞定多厂商 AI 调用》</a> 。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { generateText } <span class="hljs-keyword">from</span> <span class="hljs-string">"ai"</span>;
<span class="hljs-keyword">import</span> { createOpenAI } <span class="hljs-keyword">from</span> <span class="hljs-string">"@ai-sdk/openai"</span>;
<span class="hljs-keyword">import</span> { createAzure } <span class="hljs-keyword">from</span> <span class="hljs-string">"@ai-sdk/azure"</span>;

<span class="hljs-comment">/**
 * Build a model client from env/config.
 * Supported providers: 'openai', 'azure'.
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getModelClient</span>(<span class="hljs-params">options = {}</span>) {
  <span class="hljs-keyword">const</span> {
    provider = process.<span class="hljs-property">env</span>.<span class="hljs-property">AI_PROVIDER</span> || <span class="hljs-string">"openai"</span>,
    apiKey = process.<span class="hljs-property">env</span>.<span class="hljs-property">AI_PROVIDER_API_KEY</span>,
    baseURL = process.<span class="hljs-property">env</span>.<span class="hljs-property">OPENAI_BASE_URL</span> || process.<span class="hljs-property">env</span>.<span class="hljs-property">AZURE_OPENAI_BASE_URL</span>,
    resourceName = process.<span class="hljs-property">env</span>.<span class="hljs-property">AZURE_OPENAI_RESOURCE_NAME</span>, <span class="hljs-comment">// for azure</span>
  } = options;

  <span class="hljs-keyword">if</span> (process.<span class="hljs-property">env</span>.<span class="hljs-property">AI_MOCK</span> === <span class="hljs-string">"1"</span>) {
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">client</span>: <span class="hljs-literal">null</span>, <span class="hljs-attr">model</span>: <span class="hljs-literal">null</span> };
  }

  <span class="hljs-keyword">if</span> (!apiKey) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"Missing API key: set AI_PROVIDER_API_KEY"</span>);
  }

  <span class="hljs-keyword">if</span> (provider === <span class="hljs-string">"azure"</span>) {
    <span class="hljs-keyword">const</span> azure = <span class="hljs-title function_">createAzure</span>({ apiKey, resourceName });
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">client</span>: azure, <span class="hljs-attr">model</span>: <span class="hljs-title function_">azure</span>(<span class="hljs-string">"gpt-5"</span>) };
  }

  <span class="hljs-keyword">const</span> openai = <span class="hljs-title function_">createOpenAI</span>({ apiKey, baseURL });
  <span class="hljs-keyword">const</span> modelName = process.<span class="hljs-property">env</span>.<span class="hljs-property">OPENAI_MODEL</span> || <span class="hljs-string">"gpt-4o-mini"</span>;
  <span class="hljs-keyword">return</span> { <span class="hljs-attr">client</span>: openai, <span class="hljs-attr">model</span>: <span class="hljs-title function_">openai</span>(modelName) };
}

<span class="hljs-comment">/**
 * Chat-like step with messages array support.
 * messages: [{ role: 'system'|'user'|'assistant', content: string }]
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">llmChat</span>(<span class="hljs-params">{ messages, schema, options = {} }</span>) {
  <span class="hljs-keyword">const</span> { model } = <span class="hljs-title function_">getModelClient</span>(options);
  <span class="hljs-keyword">const</span> system = messages.<span class="hljs-title function_">find</span>(<span class="hljs-function">(<span class="hljs-params">m</span>) =&gt;</span> m.<span class="hljs-property">role</span> === <span class="hljs-string">"system"</span>)?.<span class="hljs-property">content</span>;

  <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> <span class="hljs-title function_">generateText</span>({
    model,
    system,
    messages,
    ...(schema ? { schema } : {}),
  });
  <span class="hljs-keyword">return</span> result;
}
</code></pre>
<p>核心作用只有一个：<strong>以 Chat 形式向模型发送上下文，并获得结构化输出</strong>。</p>
<h4 data-id="heading-6">ReAct 主逻辑</h4>
<p>在下面这段代码中，我们完整实现了一个 ReAct Agent 的核心循环逻辑。首先通过 system prompt 对模型的输出形式和行为进行强约束，明确要求其<strong>仅以 JSON 格式返回结果</strong>，且只能包含 <code>thought</code>、<code>action</code>、<code>args</code>、<code>final</code> 四个字段，并分别约定了调用工具与结束任务时的输出规范。与此同时，在 <code>user</code> 消息中显式告知模型当前可用的 tools 列表，并附带每个工具的功能说明与参数定义，使模型能够在循环过程中基于明确的能力边界自主决策是否进行工具调用。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { llmChat } <span class="hljs-keyword">from</span> <span class="hljs-string">"../llm/provider.js"</span>;
<span class="hljs-keyword">import</span> { callTool, formatToolList } <span class="hljs-keyword">from</span> <span class="hljs-string">"../tools/index.js"</span>;

<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">SYSTEM</span> = <span class="hljs-string">`You are a ReAct-style agent.

You must reason and act using the following loop:
Thought → Action → Observation
This loop may repeat multiple times.

Output format rules:
- You MUST respond with a single JSON object
- The JSON object MUST contain only the following keys:
  - thought (string)
  - action (string, optional)
  - args (object, optional)
  - final (string, optional)
- No additional keys are allowed
- Do NOT use Markdown
- Do NOT include any text outside the JSON object

Behavior rules:
- If you need to call a tool, output "thought", "action", and "args"
- If no further action is required, output "thought" and "final"
- When "final" is present, the response is considered complete and no further steps will be taken
- Do NOT include "action" or "args" when returning "final"

Always follow these rules strictly.`</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">runReAct</span>(<span class="hljs-params">{ task, maxLoops = <span class="hljs-number">6</span>, options = {} } = {}</span>) {
  <span class="hljs-keyword">const</span> messages = [
    { <span class="hljs-attr">role</span>: <span class="hljs-string">"system"</span>, <span class="hljs-attr">content</span>: <span class="hljs-variable constant_">SYSTEM</span> },
    {
      <span class="hljs-attr">role</span>: <span class="hljs-string">"user"</span>,
      <span class="hljs-attr">content</span>: <span class="hljs-string">`Task: <span class="hljs-subst">${task}</span>\nAvailable tools: <span class="hljs-subst">${formatToolList()}</span>`</span>,
    },
  ];

  <span class="hljs-keyword">const</span> trace = [];

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; maxLoops; i++) {
    <span class="hljs-keyword">const</span> { text } = <span class="hljs-keyword">await</span> <span class="hljs-title function_">llmChat</span>({ messages, options });
    <span class="hljs-keyword">let</span> parsed;
    <span class="hljs-keyword">try</span> {
      parsed = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(text);
    } <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-comment">// console.warn("Parse failed. Text:", text);</span>
      <span class="hljs-comment">// console.warn("Error:", String(e));</span>
      messages.<span class="hljs-title function_">push</span>({ <span class="hljs-attr">role</span>: <span class="hljs-string">"assistant"</span>, <span class="hljs-attr">content</span>: text });
      messages.<span class="hljs-title function_">push</span>({
        <span class="hljs-attr">role</span>: <span class="hljs-string">"user"</span>,
        <span class="hljs-attr">content</span>: <span class="hljs-string">`Format error: <span class="hljs-subst">${<span class="hljs-built_in">String</span>(e)}</span>.
        You previously violated the required JSON format.
        This is a strict requirement.

        If the response is not valid JSON or contains extra text, it will be discarded.
        Retry now.`</span>,
      });
      <span class="hljs-keyword">continue</span>;
    }

    trace.<span class="hljs-title function_">push</span>({ <span class="hljs-attr">step</span>: i + <span class="hljs-number">1</span>, <span class="hljs-attr">model</span>: parsed });

    <span class="hljs-keyword">if</span> (parsed.<span class="hljs-property">final</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Final result:"</span>, parsed.<span class="hljs-property">final</span>);
      <span class="hljs-keyword">return</span> { <span class="hljs-attr">final</span>: parsed.<span class="hljs-property">final</span>, trace };
    }

    <span class="hljs-keyword">if</span> (!parsed.<span class="hljs-property">action</span>) {
      messages.<span class="hljs-title function_">push</span>({ <span class="hljs-attr">role</span>: <span class="hljs-string">"assistant"</span>, <span class="hljs-attr">content</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(parsed) });
      messages.<span class="hljs-title function_">push</span>({
        <span class="hljs-attr">role</span>: <span class="hljs-string">"user"</span>,
        <span class="hljs-attr">content</span>:
          <span class="hljs-string">"No action provided. Please continue with a tool call or final."</span>,
      });
      <span class="hljs-keyword">continue</span>;
    }

    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Action:"</span>, parsed.<span class="hljs-property">action</span>);
    <span class="hljs-keyword">const</span> observation = <span class="hljs-keyword">await</span> <span class="hljs-title function_">callTool</span>(parsed.<span class="hljs-property">action</span>, parsed.<span class="hljs-property">args</span> || {});
    trace[trace.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>].<span class="hljs-property">observation</span> = observation;
    messages.<span class="hljs-title function_">push</span>({ <span class="hljs-attr">role</span>: <span class="hljs-string">"assistant"</span>, <span class="hljs-attr">content</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(parsed) });
    messages.<span class="hljs-title function_">push</span>({
      <span class="hljs-attr">role</span>: <span class="hljs-string">"user"</span>,
      <span class="hljs-attr">content</span>: <span class="hljs-string">`Observation: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(observation)}</span>. Continue.`</span>,
    });
  }

  <span class="hljs-keyword">return</span> { <span class="hljs-attr">final</span>: <span class="hljs-string">"Max loops reached without final."</span>, trace };
}

</code></pre>
<h4 data-id="heading-7">Tools</h4>
<p>Tools 指的是模型在 ReAct 循环中可以调用的具体外部能力接口。通常，一个工具由<strong>工具名称、功能描述、参数定义以及对应的 handler 实现</strong>组成。下面示例中实现了两个最基础的文件操作工具：<code>readFileTool</code> 用于读取文件内容，<code>writeFileTool</code> 用于写入文件，两者都完整描述了工具名称、用途、参数 Schema 以及实际执行逻辑。<code>createTool</code> 只是一个用于约定工具输出结构的辅助函数，本身并不涉及核心逻辑，主要用于在非 TS 环境下做基础的参数校验。</p>
<p>这里使用 <code>zod</code> 作为参数校验工具，它可以在 JS / TS 环境中统一使用，通过定义 schema 并在运行时执行 <code>parse</code> 校验，有效缓解模型参数幻觉问题；同时可以直接使用 schema 生成标准的 JSON Schema，作为工具参数说明提供给模型，从而减少手写参数描述的成本。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> fs <span class="hljs-keyword">from</span> <span class="hljs-string">"fs/promises"</span>;
<span class="hljs-keyword">import</span> path <span class="hljs-keyword">from</span> <span class="hljs-string">"path"</span>;
<span class="hljs-keyword">import</span> { z } <span class="hljs-keyword">from</span> <span class="hljs-string">"zod"</span>;
<span class="hljs-keyword">import</span> { createTool } <span class="hljs-keyword">from</span> <span class="hljs-string">"./types.js"</span>;

<span class="hljs-keyword">const</span> readFileSchema = z.<span class="hljs-title function_">object</span>({ <span class="hljs-attr">file</span>: z.<span class="hljs-title function_">string</span>() });
<span class="hljs-keyword">const</span> writeFileSchema = z.<span class="hljs-title function_">object</span>({ <span class="hljs-attr">file</span>: z.<span class="hljs-title function_">string</span>(), <span class="hljs-attr">content</span>: z.<span class="hljs-title function_">string</span>() });

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> readFileTool = <span class="hljs-title function_">createTool</span>({
  <span class="hljs-attr">name</span>: <span class="hljs-string">"read_file"</span>,
  <span class="hljs-attr">description</span>: <span class="hljs-string">"Read a UTF-8 text file from workspace"</span>,
  <span class="hljs-attr">schema</span>: readFileSchema,
  <span class="hljs-attr">handler</span>: <span class="hljs-keyword">async</span> ({ file }) =&gt; {
    <span class="hljs-keyword">const</span> abs = path.<span class="hljs-title function_">resolve</span>(process.<span class="hljs-title function_">cwd</span>(), file);
    <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> fs.<span class="hljs-title function_">readFile</span>(abs, <span class="hljs-string">"utf-8"</span>);
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">ok</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">content</span>: data };
  },
});

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> writeFileTool = <span class="hljs-title function_">createTool</span>({
  <span class="hljs-attr">name</span>: <span class="hljs-string">"write_file"</span>,
  <span class="hljs-attr">description</span>: <span class="hljs-string">"Write a UTF-8 text file to workspace (overwrite)"</span>,
  <span class="hljs-attr">schema</span>: writeFileSchema,
  <span class="hljs-attr">handler</span>: <span class="hljs-keyword">async</span> ({ file, content }) =&gt; {
    <span class="hljs-keyword">const</span> abs = path.<span class="hljs-title function_">resolve</span>(process.<span class="hljs-title function_">cwd</span>(), file);
    <span class="hljs-keyword">await</span> fs.<span class="hljs-title function_">mkdir</span>(path.<span class="hljs-title function_">dirname</span>(abs), { <span class="hljs-attr">recursive</span>: <span class="hljs-literal">true</span> });
    <span class="hljs-keyword">await</span> fs.<span class="hljs-title function_">writeFile</span>(abs, content, <span class="hljs-string">"utf-8"</span>);
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">ok</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">`wrote <span class="hljs-subst">${file}</span>`</span> };
  },
});
</code></pre>
<h3 data-id="heading-8">实际效果</h3>
<p>基于上述 ReAct 实现，我尝试让模型在本地环境中完成多个小游戏的生成与迭代，包括：<code>2048</code>、<code>飞机大战</code>、<code>贪吃蛇</code>、<code>五子棋</code>。从结果来看，整体完成度和可玩性都明显优于我<a href="https://link.juejin.cn?target=alexpang.cn%2Fleafer-games%2F" target="_blank" title="alexpang.cn/leafer-games/" ref="nofollow noopener noreferrer">早期纯手写的一些 demo</a>。当然，需要强调的是：<strong>ReAct 并不会凭空提升模型能力，它更多是一种能力放大器。</strong></p>
<p>最终效果在很大程度上仍然依赖于底层模型本身的代码生成、规划与理解能力，而 ReAct 负责的，是为这些能力提供一个稳定的执行框架。</p>
<h4 data-id="heading-9">2048</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/af622ebf37304576a7bb9ca20821ac56~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2Q5rSL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767053244&amp;x-signature=KANcNJ1zxfeDyYRbdHmQcDFPWK8%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-10">飞机大战</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7136ce6e72fc48b9881d0e63e0bbcbe0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2Q5rSL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767053244&amp;x-signature=QC%2FvP0NguOuKg5HhWX8DV2OyY14%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-11">贪吃蛇</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/969ede2823b844219528d2112ed217b6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2Q5rSL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767053244&amp;x-signature=w6La6lPHlBabkIcuAYIcm%2FeAoi4%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-12">五子棋</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ba52da741cba462a9cc56c06a994bc83~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2Q5rSL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767053244&amp;x-signature=CPRLifd3j0ktRO%2BX7LZ7z9ITd0U%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-13">结语</h2>
<p>ReAct 并不是最复杂、也不是最“智能”的 Agent 模式，但它结构清晰、实现成本低、工程可控性强，是理解和实践 Agent 系统非常合适的起点。</p>
<p>在后续更复杂的场景中，往往会在 ReAct 之上叠加：规划（Plan &amp; Execute）、反思（Reflection）、记忆与长期状态，但无论如何，ReAct 所确立的 <strong>思考—行动—反馈闭环</strong>，仍然是多数 Agent 系统绕不开的基础结构。</p>
<p>在下一篇中，我们将展开对 <strong>P&amp;E（Plan and Execute）模式</strong> 的详细解析，重点介绍其设计理念、执行流程及具体实现方式。</p>
<blockquote>
<p>我已将相关代码开源到 GitHub，感兴趣的同学可以下载到本地后执行一下玩玩：
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FAlessandro-Pang%2Fagent-desgin-pattern-demo" target="_blank" title="https://github.com/Alessandro-Pang/agent-desgin-pattern-demo" ref="nofollow noopener noreferrer">github.com/Alessandro-…</a></p>
</blockquote>
<h2 data-id="heading-14">相关资料</h2>
<ul>
<li><strong>GitHub 仓库</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FAlessandro-Pang%2Fagent-desgin-pattern-demo" target="_blank" title="https://github.com/Alessandro-Pang/agent-desgin-pattern-demo" ref="nofollow noopener noreferrer">github.com/Alessandro-…</a></li>
<li><strong>AI Agent 介绍:</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fshort.pangcy.cn%2Fu%2F139a9efccce1fce2" target="_blank" title="https://short.pangcy.cn/u/139a9efccce1fce2" ref="nofollow noopener noreferrer">short.pangcy.cn/u/139a9efcc…</a></li>
<li><strong>ReAct 模式</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bohrium.com%2Fpaper%2Fread%3FlibraryId%3D8446066" target="_blank" title="https://www.bohrium.com/paper/read?libraryId=8446066" ref="nofollow noopener noreferrer">www.bohrium.com/paper/read?…</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JavaScript 性能优化实战：7 个让你的应用提速 50%+ 的 V8 引擎技巧]]></title>    <link>https://juejin.cn/post/7586570254860730408</link>    <guid>https://juejin.cn/post/7586570254860730408</guid>    <pubDate>2025-12-23T00:16:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586570254860730408" data-draft-id="7586531677720494115" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JavaScript 性能优化实战：7 个让你的应用提速 50%+ 的 V8 引擎技巧"/> <meta itemprop="keywords" content="后端,前端,人工智能"/> <meta itemprop="datePublished" content="2025-12-23T00:16:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿橙的百宝箱"/> <meta itemprop="url" content="https://juejin.cn/user/1638743356481367"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JavaScript 性能优化实战：7 个让你的应用提速 50%+ 的 V8 引擎技巧
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1638743356481367/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿橙的百宝箱
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T00:16:40.000Z" title="Tue Dec 23 2025 00:16:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>JavaScript 性能优化实战：7 个让你的应用提速 50%+ 的 V8 引擎技巧</strong></h2>
<h2 data-id="heading-1">引言</h2>
<p>在现代 Web 开发中，JavaScript 的性能直接影响用户体验和业务指标。随着应用复杂度的提升，性能瓶颈往往隐藏在代码的底层细节中。V8 引擎作为 Chrome 和 Node.js 的核心 JavaScript 执行引擎，其内部优化机制为开发者提供了巨大的性能潜力。本文将深入剖析 V8 的工作原理，揭示 7 个经过实战验证的优化技巧，帮助你将应用性能提升至少 50%。</p>
<h2 data-id="heading-2">V8 引擎基础架构</h2>
<p>在深入优化技巧前，我们需要理解 V8 的核心工作流程：</p>
<ol>
<li><strong>解析器（Parser）</strong>：将 JS 代码转换为抽象语法树（AST）</li>
<li><strong>解释器（Ignition）</strong>：生成字节码并执行</li>
<li><strong>编译器（TurboFan）</strong>：将热点代码编译为优化后的机器码</li>
<li><strong>垃圾回收（Orinoco）</strong>：管理内存分配与回收</li>
</ol>
<p>这种分层架构使得 V8 能够平衡启动速度和执行效率，同时也为我们的优化提供了明确的方向。</p>
<hr/>
<h2 data-id="heading-3">Part I: JavaScript Object Optimization</h2>
<h3 data-id="heading-4">Tip #1: Object Shape Consistency (隐藏类优化)</h3>
<p>V8使用"隐藏类"（Hidden Class）机制来加速对象属性访问。违反这一机制会导致严重的性能下降：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ❌ Bad: Inconsistent property order</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">createUser</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> user = {};
    user.<span class="hljs-property">name</span> = <span class="hljs-string">'John'</span>;
    user.<span class="hljs-property">age</span> = <span class="hljs-number">30</span>;
    <span class="hljs-keyword">return</span> user;
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">createAdmin</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> admin = {};
    admin.<span class="hljs-property">age</span> = <span class="hljs-number">40</span>;   <span class="hljs-comment">// Different property order!</span>
    admin.<span class="hljs-property">name</span> = <span class="hljs-string">'Jane'</span>;
    <span class="hljs-keyword">return</span> admin;
}

<span class="hljs-comment">// ✅ Good: Consistent property order</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">createUserOpt</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> user = { <span class="hljs-attr">name</span>: <span class="hljs-literal">null</span>, <span class="hljs-attr">age</span>: <span class="hljs-literal">null</span> };
    user.<span class="hljs-property">name</span> = <span class="hljs-string">'John'</span>;
    user.<span class="hljs-property">age</span> = <span class="hljs-number">30</span>;
    <span class="hljs-keyword">return</span> user;
}
</code></pre>
<p>Benchmark测试表明：一致的对象结构可使属性访问速度提升3-5倍。</p>
<h3 data-id="heading-5">Tip #2: Preallocate Arrays for Fixed Collections</h3>
<p>动态扩容数组会触发V8的存储格式转换：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ❌ Bad: Dynamic growth triggers transition to dictionary mode</span>
<span class="hljs-keyword">const</span> arr = [];
<span class="hljs-keyword">for</span>(<span class="hljs-keyword">let</span> i=<span class="hljs-number">0</span>; i&lt;<span class="hljs-number">100000</span>; i++) {
    arr[i] = i; 
}

<span class="hljs-comment">// ✅ Good: Preallocated array maintains fast elements</span>
<span class="hljs-keyword">const</span> arrOpt = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(<span class="hljs-number">100000</span>);
<span class="hljs-keyword">for</span>(<span class="hljs-keyword">let</span> i=<span class="hljs-number">0</span>; i&lt;<span class="hljs-number">100000</span>; i++) {
    arrOpt[i] = i;
}
</code></pre>
<p>实测显示预分配大数组可减少70%的内存操作耗时。</p>
<hr/>
<h2 data-id="heading-6">Part II: Function Optimization Techniques</h2>
<h3 data-id="heading-7">Tip #3: Avoid Polymorphic Functions</h3>
<p>TurboFan对单态函数有特殊优化：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ❌ Bad: Polymorphic function (multiple argument types)</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">a, b</span>) {
    <span class="hljs-keyword">return</span> a + b;
}
<span class="hljs-title function_">add</span>(<span class="hljs-number">1</span>,<span class="hljs-number">2</span>);       <span class="hljs-comment">// Number addition</span>
<span class="hljs-title function_">add</span>(<span class="hljs-string">'a'</span>,<span class="hljs-string">'b'</span>);   <span class="hljs-comment">// String concatenation </span>

<span class="hljs-comment">// ✅ Good: Monomorphic version</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">addNumbers</span>(<span class="hljs-params">a, b</span>) { <span class="hljs-comment">/* numbers only */</span> }
<span class="hljs-keyword">function</span> <span class="hljs-title function_">concatStrings</span>(<span class="hljs-params">a, b</span>) { <span class="hljs-comment">/* strings only */</span> }
</code></pre>
<p>单一类型函数比多态函数快达10倍以上。</p>
<h3 data-id="heading-8">Tip #4: Use Inline Caching-Friendly Patterns</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ❌ Bad breaks IC chains due to dynamic lookup</span>
<span class="hljs-keyword">const</span> handlers1 = {};
handlers1[<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() &gt;<span class="hljs-number">0.5</span> ? <span class="hljs-string">'a'</span>:<span class="hljs-string">'b'</span>] = <span class="hljs-function">() =&gt;</span> {...};

<span class="hljs-comment">// ✅ Good maintains stable IC slots</span>
<span class="hljs-keyword">const</span> handlers2 = { 
   <span class="hljs-title function_">a</span>(<span class="hljs-params"/>){...}, 
   <span class="hljs-title function_">b</span>(<span class="hljs-params"/>){...} 
};
</code></pre>
<p>稳定的属性访问路径可使方法调用时间从5ns降至1ns。</p>
<hr/>
<h2 data-id="heading-9">Part III: Memory &amp; Execution Optimizations</h2>
<h3 data-id="heading-10">Tip #5: Avoid Arguments Leakage in Hot Functions</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ❌ Bad leaks arguments object preventing optimization</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">sum</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">let</span> total=<span class="hljs-number">0</span>;
    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">let</span> i=<span class="hljs-number">0</span>;i&lt;<span class="hljs-variable language_">arguments</span>.<span class="hljs-property">length</span>;i++){
        total+=<span class="hljs-variable language_">arguments</span>[i];
    }
}

<span class="hljs-comment">// ✅ Good rest parameters are optimizable</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">sumOpt</span>(<span class="hljs-params">...numbers</span>) {
    <span class="hljs-keyword">return</span> numbers.<span class="hljs-title function_">reduce</span>(<span class="hljs-function">(<span class="hljs-params">s,n</span>)=&gt;</span>s+n,<span class="hljs-number">0</span>);
}
</code></pre>
<p>ES6参数语法可使计算密集型函数提速40%。</p>
<h3 data-id="heading-11">Tip #6: Use TypedArrays for Binary Data Processing</h3>
<p>传统数组处理二进制数据效率低下：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ❌ Slow (~120ms per MB processed)</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">processBuffer</span>(<span class="hljs-params">buffer</span>) {
   <span class="hljs-keyword">const</span> data=[];
   <span class="hljs-keyword">for</span>(<span class="hljs-keyword">let</span> i=<span class="hljs-number">0</span>;i&lt;buffer.<span class="hljs-property">length</span>;i++){
       data.<span class="hljs-title function_">push</span>(buffer[i]*<span class="hljs-number">2</span>);
   }
}

<span class="hljs-comment">// ✅ Fast (~15ms per MB)</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">processBufferOpt</span>(<span class="hljs-params">buffer</span>) {
   <span class="hljs-keyword">const</span> view=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(buffer);
   <span class="hljs-keyword">const</span> result=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(view.<span class="hljs-property">length</span>);
   <span class="hljs-keyword">for</span>(<span class="hljs-keyword">let</span> i=<span class="hljs-number">0</span>;i&lt;view.<span class="hljs-property">length</span>;i++){
       result[i]=view[i]*<span class="hljs-number">2</span>;
   }
}
</code></pre>
<p>TypedArrays在处理二进制数据时比普通数组快约800%。</p>
<hr/>
<h2 data-id="heading-12">Part IV Advanced Optimization Patterns</h2>
<h3 data-id="heading-13">Tip #7 Leverage Warm-Up Phase Strategically</h3>
<p>V8需要"热身"才能达到最佳性能：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">/* Benchmarking best practice */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">benchmark</span>(<span class="hljs-params">fn</span>) {
   <span class="hljs-comment">// Warm-up phase (run multiple times before timing)</span>
   <span class="hljs-keyword">for</span>(<span class="hljs-keyword">let</span> i=<span class="hljs-number">0</span>;i&lt;<span class="hljs-number">100</span>;i++) <span class="hljs-title function_">fn</span>(); 
   
   <span class="hljs-comment">// Actual measurement starts here...</span>
}
</code></pre>
<p>生产环境中可以通过以下方式利用预热：</p>
<ul>
<li>SSR时提前执行关键路径函数</li>
<li>Service Worker安装阶段初始化核心逻辑</li>
<li>WebAssembly模块预编译</li>
</ul>
<hr/>
<h2 data-id="heading-14">Conclusion &amp; Further Reading</h2>
<p>本文揭示的7个技巧覆盖了从对象设计到内存管理的多个层面。要实现显著的性能提升，关键在于理解V8的行为模式并据此编写引擎友好的代码。</p>
<p>要进一步深入V8优化技术建议研究：</p>
<ol>
<li>TurboFan JIT编译器的中间表示（IR）</li>
<li>Orinoco垃圾回收器的分代策略</li>
<li>Ignition解释器的字节码设计</li>
</ol>
<p>记住：所有优化都应基于实际profile数据进行，避免过早或过度优化影响代码可维护性。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【性能监控】别只做工具人了！手把手带你写一个前端性能检测SDK]]></title>    <link>https://juejin.cn/post/7586482860104613915</link>    <guid>https://juejin.cn/post/7586482860104613915</guid>    <pubDate>2025-12-23T00:17:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586482860104613915" data-draft-id="7585555806668226594" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【性能监控】别只做工具人了！手把手带你写一个前端性能检测SDK"/> <meta itemprop="keywords" content="前端,JavaScript,监控"/> <meta itemprop="datePublished" content="2025-12-23T00:17:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="不一样的少年_"/> <meta itemprop="url" content="https://juejin.cn/user/3035079961218551"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【性能监控】别只做工具人了！手把手带你写一个前端性能检测SDK
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3035079961218551/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    不一样的少年_
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T00:17:47.000Z" title="Tue Dec 23 2025 00:17:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读30分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252b3a}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px;color:#5e7ce0}.markdown-body h1{font-size:24px;margin-bottom:5px;margin-top:80px;position:relative;text-align:center}.markdown-body h2{font-size:20px;padding-bottom:12px;border-bottom:1px solid #dfe1e6}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:16px;margin-top:30px}.markdown-body h5{font-size:14px;margin-top:20px}.markdown-body h6{font-size:14px;margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #dfe1e6;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#ffeeed;color:#c73636;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#252b3a;background:#f8f8f8}.markdown-body a{position:relative;text-decoration:none;color:#5e7ce0;padding-right:18px;padding-bottom:4px}.markdown-body a[href^=http]:after{position:absolute;display:inline-block;width:16px;height:16px;margin-left:2px;margin-top:6px;content:"";background:url("data:image/png;base64,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");background-size:100%}.markdown-body a:active,.markdown-body a:hover{border-bottom:2px solid #5e7ce0}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #5e7ce0;border-spacing:0}.markdown-body thead{color:#fff;text-align:left}.markdown-body thead tr{background:#5e7ce0}.markdown-body thead th{border-bottom:1px solid #dfe1e6}.markdown-body tr{background-color:#fff}.markdown-body tr:nth-child(2n){background-color:#f2f5fc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#252b3a;padding:1px 23px;margin:22px 0;border-left:4px solid #5e7ce0;background-color:#f2f5fc}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{padding-left:10px;margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#5e7ce0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body ul li::marker{content:"•";color:#5e7ce0}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}.markdown-body input[type=checkbox]:before{display:inline-block;width:16px;height:16px;content:"";background:url("data:image/png;base64,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");background-size:100%;position:relative;right:2px;top:-5px}.markdown-body input[type=checkbox]:checked:before{background:url("data:image/png;base64,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");background-size:100%}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><blockquote>
<p>你是否一直对前端<strong>性能监控</strong>系统的底层原理充满好奇？</p>
<p>想知道那些 FCP、LCP、FID 指标是如何被<strong>精准捕获</strong>的？</p>
<p>页面卡顿、资源加载缓慢、API 请求耗时过长，这些隐形杀手是如何被 SDK <strong>揪出来</strong>的？</p>
<p>与其只做工具的使用者，不如深入底层，探寻背后的实现机制。</p>
<p>本文将从原理角度切入，手把手带你设计并实现一个轻量级、功能完备的<strong>性能监控 SDK</strong>。</p>
</blockquote>
<h2 data-id="heading-0">读完这篇，你将收获什么？</h2>
<p>通过手写这个 SDK，你不仅能获得一个可用的性能监控工具，更能深入掌握以下核心知识点：</p>
<ol>
<li>
<p><strong>浏览器性能底层 API</strong>：别光听过没用过！带你彻底搞懂 <code>PerformanceObserver</code> 到底怎么用，把 <code>Resource Timing</code> 、 <code>Event Timing</code> 这些原生 API 玩出花来，不用重轮子也能精准抓数据。</p>
</li>
<li>
<p><strong>指标体系全覆盖</strong>：用户觉得卡，到底卡在哪？是从白屏到出内容的 FCP/LCP？还是图片加载太慢？或者是点击按钮没反应？不管是网络请求慢，还是 JS 任务太长，咱们这次一次性全搞定，给体验做个体检。</p>
</li>
<li>
<p><strong>SDK 架构设计实战</strong>：SDK 怎么写才不乱？采集归采集，上报归上报，配置还要灵活。带你设计一个插件化的架构，想加功能随时加，代码干净又好维护。</p>
</li>
<li>
<p><strong>轻量级黑科技封装</strong>：利用简单的 JS<code>闭包</code>与 <code>Proxy</code>，实现同步/异步函数的精准耗时测量。</p>
</li>
</ol>
<h2 data-id="heading-1">指标扫盲：别被指标缩写吓跑了</h2>
<p>在开始撸代码之前，咱们先灵魂拷问一下：到底啥叫“性能好”？</p>
<p>虽说 Google 搞了一套 Core Web Vitals 标准，web-vitals 库可以直接用，但这次咱们 偏不 。为啥要自讨苦吃手写 SDK？</p>
<ol>
<li><strong>原生掌控</strong>：我们要利用浏览器<strong>原生 API</strong>，亲手把<strong>快不快、卡不卡、稳不稳</strong>这三个维度的“真凶”抓出来。</li>
<li><strong>兼容性黑洞</strong>： Web Vitals 的很多高级指标（如 LCP、CLS）在 Firefox 或 Safari 的旧版本上并不完全支持。手写 SDK 让我们能灵活处理这些<strong>兼容性差异</strong>，做到“能监控的监控，不能监控的静默”，而不是直接报错。</li>
</ol>
<h3 data-id="heading-2">1. Loading (加载)：别让我等太久！</h3>
<p>用户最怕面对一片白屏。这个阶段我们关注三个瞬间：</p>
<ul>
<li><strong>FP (First Paint) —— “屏幕亮了”</strong>
<ul>
<li><strong>啥意思</strong>：浏览器开始渲染任何东西的时刻（哪怕只是背景色）。</li>
<li><strong>场景</strong>：你打开一个页面，屏幕从纯白变成浅灰色，虽然啥内容都没有，但你知道“它活着”。</li>
</ul>
</li>
<li><strong>FCP (First Contentful Paint) —— “看到东西了”</strong>
<ul>
<li><strong>啥意思</strong>：浏览器渲染出第一个内容（文字、图片、Logo）的时刻。</li>
<li><strong>场景</strong>：页面上出现了一个“Loading...”的文字或者导航栏的 Logo。这时候你会稍微安心一点，愿意再等两秒。</li>
</ul>
</li>
<li><strong>LCP (Largest Contentful Paint) —— “主角登场了”</strong>
<ul>
<li><strong>啥意思</strong>：视口内可见的最大图片或文本块渲染完成的时刻。这是 Google 最看重的加载指标。</li>
<li><strong>场景</strong>：你打开淘宝详情页，标题和价格都出来了，但那张最大的商品主图过了 5 秒才刷出来。这 5 秒内你根本不想买，因为你没看到货。LCP 就是衡量这个“主图”多久出来的。</li>
<li><strong>及格线</strong>：2.5 秒内算优秀，超过 4 秒就是“慢得离谱”。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-3">2. Interaction (交互)：别卡得像 PPT！</h3>
<p>东西加载出来了，用户开始点了，这时候最怕卡顿。</p>
<ul>
<li>
<p><strong>FID (First Input Delay) —— “第一下没反应？”</strong></p>
<ul>
<li><strong>啥意思</strong>：用户第一次与页面交互（点击按钮、链接）到浏览器真正开始处理这个事件的时间差。</li>
<li><strong>场景</strong>：你看到页面加载完了，兴奋地去点“登录”按钮，结果点了没反应，过了 1 秒钟按钮才变色。这种“按下去没感觉”的延迟，就是 FID。</li>
</ul>
</li>
<li>
<p><strong>INP (Interaction to Next Paint) —— “越用越卡？”</strong></p>
<ul>
<li><strong>啥意思</strong>：FID 的升级版。它不仅看第一下，还看你浏览全程中所有交互的延迟，取最慢的那几次。</li>
<li><strong>场景</strong>：你在填写一个长表单，每输入一个字，输入框都要卡顿一下才能显示出来。这种持续的“粘滞感”，会让 INP 分数暴跌。</li>
</ul>
</li>
<li>
<p><strong>Long Task (长任务) —— “谁在堵路？”</strong></p>
<ul>
<li>
<p><strong>啥意思</strong>：任何执行时间超过 50ms 的 JavaScript 任务。</p>
</li>
<li>
<p><strong>场景</strong>：主线程就像一条单行道。如果前面有一辆大卡车（复杂的 JS 计算）走了 200ms，后面的小轿车（点击事件响应）就只能排队等着。我们要做的，就是把大卡车拆成<strong>一支灵活的小车队</strong>，每辆车之间留出空隙，让紧急车辆（用户交互）能随时插队通过。</p>
</li>
<li>
<p><strong>注</strong>：长任务不光交互期会出现，加载时也常见；它会让白屏更久、把 <code>TBT</code>（总阻塞时间）拉高。我们归到“交互”里讲，是因为它最直接拖慢的是点击/输入的响应（<code>FID</code>、<code>INP</code>）。</p>
</li>
</ul>
</li>
</ul>
<h3 data-id="heading-4">3. Visual Stability (视觉稳定性)：别乱动！</h3>
<p>这可能是最让人抓狂的体验。</p>
<ul>
<li><strong>CLS (Cumulative Layout Shift) —— “手滑点错了！”</strong>
<ul>
<li><strong>啥意思</strong>：页面布局在加载过程中发生意外移动的程度。</li>
<li><strong>场景</strong>：你正准备点“取消订单”，突然顶部加载出来一张广告图，把整个页面往下挤了 50 像素，结果你的手指正好点在了“立即支付”上……这种布局的意外位移，就叫 CLS。分数越低，页面越稳。</li>
</ul>
</li>
</ul>
<hr/>
<h2 data-id="heading-5">系统架构与功能设计</h2>
<p>为了保证 SDK 的轻量性与可扩展性，我们采用了<strong>分层架构设计</strong>。整个系统由 <strong>核心采集层</strong>、<strong>数据处理层</strong>、<strong>数据上报层</strong> 和 <strong>配置中心</strong> 四大模块组成，并通过统一的 <code>PerformanceMonitor</code> 类进行调度。</p>
<p>*简单说，就是把活儿分得明明白白：<strong>采集模块只管抓数据，处理模块只管处理数据，上报只管发送数据到服务端，配置只管配置*</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/69fbf4592eaa42a48ec9e1167c09b8e4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5LiA5qC355qE5bCR5bm0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767054012&amp;x-signature=a7zXBXqMnkDvBmyB12waKb6JXag%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-6">1. 核心采集层 (Collectors) —— 用户体验三步走</h3>
<p>这是 SDK 的心脏。咱们不按技术分类，按<strong>用户实际感受</strong>来分（这也是为什么我们的源码目录叫 <code>loading</code>、<code>interaction</code>、<code>network</code>）：</p>
<ul>
<li>
<p><strong>Step 1: Loading (看得见吗？)</strong> —— <code>src/loading</code></p>
<ul>
<li><strong>核心目标</strong>：紧盯白屏时间与关键内容渲染。</li>
<li><strong>实现手段</strong>：利用 <code>Paint Timing</code> 与 <code>Largest Contentful Paint</code> API，捕获 FP、FCP、LCP 及页面加载完成时机。</li>
</ul>
</li>
<li>
<p><strong>Step 2: Interaction &amp; Visual Stability (好用且稳吗？)</strong> —— <code>src/interaction</code></p>
<ul>
<li><strong>核心目标</strong>：同时监控 <strong>交互响应速度</strong> 与 <strong>页面视觉稳定性</strong>。</li>
<li><strong>实现手段</strong>：
<ul>
<li><strong>交互</strong>：通过 <code>Event Timing</code> 监听点击/滚动延迟（FID/INP），并用 <code>Long Task</code> API 揪出主线程阻塞元凶。</li>
<li><strong>稳定性</strong>：结合 <code>Layout Shift</code> API 计算布局偏移（CLS），防止页面“乱动”。</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>Step 3: Network (为啥慢？)</strong> —— <code>src/network</code></p>
<ul>
<li><strong>核心目标</strong>：定位资源加载与接口响应的瓶颈。</li>
<li><strong>实现手段</strong>：复用 <code>Resource Timing</code> 接口，深度解析静态资源与 XHR/Fetch 请求的 DNS、TCP、TTFB 等关键耗时。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-7">2. 数据处理层 (Processor) —— 数据清洗工</h3>
<ul>
<li><strong>洗数据</strong>：浏览器原生的 API 给的数据太杂太乱，咱们得把它洗成干净统一的 JSON 格式，方便后端存。</li>
<li><strong>加料</strong>：光知道卡了没用，还得知道<strong>哪儿卡了</strong>。比如 LCP 慢，我们会自动把那个慢元素的 DOM 选择器加上；长任务卡，我们会尝试解析出是哪个脚本干的。</li>
</ul>
<h3 data-id="heading-8">3. 数据上报层 (Reporter) —— 快递员</h3>
<ul>
<li><strong>使命必达</strong>：用户都要关页面了，数据还没发出去？这时候就得用 <code>Navigator.sendBeacon</code>，它能保证在页面卸载时，数据也能稳稳地发给服务器。</li>
<li><strong>省流模式</strong>：平时不重要的日志先攒一攒（批量上报），关键的报错立刻发（实时上报），给用户的流量省点钱。</li>
</ul>
<h3 data-id="heading-9">4. 配置中心 (Configurator) —— 遥控器</h3>
<ul>
<li><strong>随心所欲</strong>：通过 <code>options</code> 参数控制。开发环境想看日志？开！生产环境只报错误？关！采样率设多少？你说了算。</li>
</ul>
<h2 data-id="heading-10"><strong>核心代码实现</strong></h2>
<ol>
<li>
<h3 data-id="heading-11"><strong>主入口 (index.ts)</strong></h3>
</li>
</ol>
<p>入口文件负责对外暴露初始化方法，串联各个模块。</p>
<ul>
<li>
<p><strong>职责明确</strong>：<code>init()</code> 方法一键启动所有监控，按用户体验生命周期（加载 -&gt; 交互 -&gt; 网络）依次调用。</p>
</li>
<li>
<p><strong>配置中心</strong>：构造函数接收 <code>options</code>，实现配置合并（如开发模式开启日志）。</p>
</li>
<li>
<p><strong>模块解耦</strong>：不直接写监控逻辑，而是通过 <code>import</code> 引入 <code>loading/interaction/network</code> 三大模块的 <code>startXXX</code> 函数，各司其职。</p>
</li>
<li>
<p><strong>示例代码</strong>：</p>
</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { startFP, startFCP, startLCP, startLoad } <span class="hljs-keyword">from</span> <span class="hljs-string">'./loading'</span>;
<span class="hljs-keyword">import</span> {
  startCLS,
  startFID,
  startInteraction,
  startLongTask,
} <span class="hljs-keyword">from</span> <span class="hljs-string">'./interaction'</span>;
<span class="hljs-keyword">import</span> { startEntries, startRequest } <span class="hljs-keyword">from</span> <span class="hljs-string">'./network'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PerformanceMonitor</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">options = {}</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span> = {
      <span class="hljs-attr">log</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 开发模式下开启日志</span>
      ...options,
    };
  }

  <span class="hljs-title function_">init</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 1. 页面加载与渲染 (Loading &amp; Rendering)</span>
    <span class="hljs-title function_">startFP</span>();
    <span class="hljs-title function_">startFCP</span>();
    <span class="hljs-title function_">startLCP</span>();
    <span class="hljs-title function_">startLoad</span>();

    <span class="hljs-comment">// 2. 交互响应 (Interaction)</span>
    <span class="hljs-title function_">startFID</span>();
    <span class="hljs-title function_">startInteraction</span>(); <span class="hljs-comment">// INP</span>
    <span class="hljs-title function_">startLongTask</span>();

    <span class="hljs-comment">// 3. 视觉稳定性 (Visual Stability)</span>
    <span class="hljs-title function_">startCLS</span>();

    <span class="hljs-comment">// 4. 资源与网络 (Resource &amp; Network)</span>
    <span class="hljs-title function_">startEntries</span>();
    <span class="hljs-title function_">startRequest</span>();

    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Performance Monitor Initialized'</span>);
  }
}
</code></pre>
<h3 data-id="heading-12"><strong>2. Loading 监控 (loading/index.js)</strong></h3>
<p>这部分主要负责捕捉页面从白屏到内容出现的关键时刻。我们把这个过程拆解为三个关键动作：<strong>变色 (FP)</strong> -&gt; <strong>有内容 (FCP)</strong> -&gt; <strong>主角登场 (LCP)</strong>。</p>
<ol>
<li><strong>FP (First Paint)</strong>：屏幕变色了（不白屏了）。</li>
<li><strong>FCP (First Contentful Paint)</strong>：看见字或图了（有内容了）。</li>
<li><strong>LCP (Largest Contentful Paint)</strong>：主角（大图/正文）出来了。</li>
<li><strong>Load</strong>：资源全加载完了。</li>
</ol>
<h4 data-id="heading-13"><strong>(1) FP &amp; FCP：屏幕终于亮了</strong></h4>
<p><strong>先讲道理：</strong></p>
<ul>
<li><strong>为什么要一起抓这两个指标是一起抓的？</strong> 因为它俩在浏览器眼里都属于 <code>paint</code>（绘制）类型，都是“第一眼”的感觉。</li>
<li><strong>怎么抓？</strong> 用 <code>PerformanceObserver</code> 蹲守。</li>
<li><strong>避坑指南（Buffered 标志）：</strong> 这是一个极其容易被忽略的参数！
<ul>
<li>SDK 初始化往往比页面渲染晚。</li>
<li>如果你不开启 <code>buffered: true</code>，就像你 10 点才去蹲守 9 点的日出，永远蹲不到。</li>
<li>开启后，浏览器会把<strong>过去发生过</strong>的指标打包补发给你。</li>
</ul>
</li>
</ul>
<p><strong>代码实战：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// src/loading/FP.js (FCP 逻辑完全一致，只需改 entry.name)</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">startFP</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">entryHandler</span> = (<span class="hljs-params">list</span>) =&gt; {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> entry <span class="hljs-keyword">of</span> list.<span class="hljs-title function_">getEntries</span>()) {
      <span class="hljs-comment">// 筛选 'first-paint'</span>
      <span class="hljs-keyword">if</span> (entry.<span class="hljs-property">name</span> === <span class="hljs-string">'first-paint'</span>) {
        observer.<span class="hljs-title function_">disconnect</span>(); <span class="hljs-comment">// FP 一辈子只发生一次，抓到就撤，省内存</span>

        <span class="hljs-keyword">const</span> json = entry.<span class="hljs-title function_">toJSON</span>();
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'FP Captured:'</span>, json);

        <span class="hljs-comment">// 上报数据结构</span>
        <span class="hljs-keyword">const</span> reportData = {
          ...json,
          <span class="hljs-attr">type</span>: <span class="hljs-string">'performance'</span>,
          <span class="hljs-attr">name</span>: entry.<span class="hljs-property">name</span>,
          <span class="hljs-attr">pageUrl</span>: <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">href</span>,
        };
      }
    }
  };

  <span class="hljs-comment">// 1. 创建观测者</span>
  <span class="hljs-keyword">const</span> observer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PerformanceObserver</span>(entryHandler);

  <span class="hljs-comment">// 2. 开始蹲守 'paint' 频道</span>
  <span class="hljs-comment">// buffered: true 是关键，确保能拿到 SDK 初始化之前的记录</span>
  observer.<span class="hljs-title function_">observe</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">'paint'</span>, <span class="hljs-attr">buffered</span>: <span class="hljs-literal">true</span> });

  <span class="hljs-comment">// 3. 返回清理函数</span>
  <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> observer.<span class="hljs-title function_">disconnect</span>();
}
</code></pre>
<h4 data-id="heading-14"><strong>(2) LCP：主角登场</strong></h4>
<p><strong>先讲道理：</strong></p>
<ul>
<li>
<p><strong>为什么 LCP 会变？</strong> 浏览器渲染是渐进式的。它刚画了一行字，觉得是 LCP；过了一会图片加载出来，它又觉得图片是 LCP。所以 LCP 可能会触发多次，我们通常取<strong>最后一次</strong>。</p>
</li>
<li>
<p><strong>光有时间够吗？</strong> 不够！老板问你“为什么 LCP 慢”，你不能光说“慢了”，你得告诉他是<strong>哪张图</strong>慢了。所以我们需要记录 <code>element</code> 并转成选择器。</p>
</li>
</ul>
<p><strong>代码实战：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// src/loading/LCP.js</span>
<span class="hljs-keyword">import</span> { getElementSelector } <span class="hljs-keyword">from</span> <span class="hljs-string">'../../util/index'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">startLCP</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">entryHandler</span> = (<span class="hljs-params">list</span>) =&gt; {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> entry <span class="hljs-keyword">of</span> list.<span class="hljs-title function_">getEntries</span>()) {
      <span class="hljs-keyword">const</span> json = entry.<span class="hljs-title function_">toJSON</span>();
      <span class="hljs-keyword">const</span> reportData = {
        ...json,
        <span class="hljs-attr">lcpTime</span>: entry.<span class="hljs-property">startTime</span>, <span class="hljs-comment">// 记录时间</span>
        <span class="hljs-comment">// 核心：利用 element 属性计算出 CSS 选择器，帮你定位是哪个元素慢</span>
        <span class="hljs-attr">elementSelector</span>: <span class="hljs-title function_">getElementSelector</span>(entry.<span class="hljs-property">element</span>),
        <span class="hljs-attr">type</span>: <span class="hljs-string">'performance'</span>,
        <span class="hljs-attr">name</span>: entry.<span class="hljs-property">name</span>,
        <span class="hljs-attr">pageUrl</span>: <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">href</span>,
      };
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'LCP Update:'</span>, reportData);
    }
  };

  <span class="hljs-keyword">const</span> observer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PerformanceObserver</span>(entryHandler);
  <span class="hljs-comment">// 同样开启 buffered，防止漏掉</span>
  observer.<span class="hljs-title function_">observe</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">'largest-contentful-paint'</span>, <span class="hljs-attr">buffered</span>: <span class="hljs-literal">true</span> });
  <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> observer.<span class="hljs-title function_">disconnect</span>();
}
</code></pre>
<h4 data-id="heading-15"><strong>(3) 加载完成</strong></h4>
<p><strong>先讲道理：</strong></p>
<ul>
<li><strong>为什么不用 <code>window.onload</code>？</strong> 现在的 SPA（单页应用）和浏览器的“往返缓存”（BFCache）机制，让 <code>onload</code> 变得不那么靠谱（有时候回退页面不会触发 onload）。</li>
<li><strong>为什么用 <code>pageshow</code>？</strong> 它能覆盖更多场景，无论你是新打开的，还是后退回来的，它都会触发。</li>
<li><strong>为什么套一层 <code>requestAnimationFrame</code>？</strong> <code>pageshow</code> 触发时，浏览器可能还在忙着处理最后的渲染。我们用 <code>rAF</code> 往后稍一稍，让主线程先喘口气，获取的时间更精准，也不影响页面交互。</li>
</ul>
<p><strong>代码实战：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// src/loading/load.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">startLoad</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">onPageShow</span> = (<span class="hljs-params">event</span>) =&gt; {
    <span class="hljs-comment">// 往后推一帧，避免抢占主线程</span>
    <span class="hljs-title function_">requestAnimationFrame</span>(<span class="hljs-function">() =&gt;</span> {
      [<span class="hljs-string">'load'</span>].<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">type</span>) =&gt;</span> {
        <span class="hljs-keyword">const</span> reportData = {
          <span class="hljs-attr">type</span>: <span class="hljs-string">'performance'</span>,
          <span class="hljs-attr">subType</span>: type,
          <span class="hljs-attr">pageUrl</span>: <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">href</span>,
          <span class="hljs-comment">// 计算相对时间</span>
          <span class="hljs-attr">startTime</span>: performance.<span class="hljs-title function_">now</span>() - event.<span class="hljs-property">timeStamp</span>,
        };
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Load Captured:'</span>, reportData);
      });
    });
  };

  <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'pageshow'</span>, onPageShow, <span class="hljs-literal">true</span>);

  <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'pageshow'</span>, onPageShow, <span class="hljs-literal">true</span>);
  };
}
</code></pre>
<h3 data-id="heading-16"><strong>3. Interaction 监控</strong></h3>
<p>交互性能直接决定了用户觉得你的页面“顺不顺手”。这里我们重点关注 <strong>FID/INP (响应速度)</strong> 和 <strong>Long Task (主线程阻塞)</strong>。</p>
<h4 data-id="heading-17"><strong>(1) FID &amp; INP：点击要灵敏</strong></h4>
<p><strong>先认个脸：</strong></p>
<ul>
<li>
<p><strong>FID (First Input Delay)</strong>：<strong>首次输入延迟</strong>。看的是“第一印象”。用户刚进页面，第一次点按钮或者链接时，浏览器是不是在发呆？延迟了多久才理你？</p>
</li>
<li>
<p><strong>INP (Interaction to Next Paint)</strong>：<strong>交互到下一次绘制</strong>。看的是“全程表现”。不管你是刚来还是快走，只要在页面上点的任何一下卡了，INP 都会记下来，最后取最慢的那几次算总账。</p>
</li>
</ul>
<p><strong>三句话讲明白</strong></p>
<ul>
<li><strong>相亲 vs 过日子</strong>：FID 就像相亲，只要第一眼（第一次交互）没问题，后面拉胯它也不管；INP 就像过日子，日久见人心，它会盯着你全程的每一次表现，哪怕你前面表现再好，最后一下卡了，分也高不了。</li>
<li><strong>只管排队 vs 全程跟踪</strong>：FID 只管“排队时间”（你点下去到浏览器开始处理的时间）；INP 管得更宽，它包括“排队 + 处理 + 渲染”的全过程。所以 INP 更能代表用户的真实感受。</li>
<li><strong>谁在堵路</strong>：想象你去餐厅吃饭（点击），服务员（主线程）正忙着给隔壁桌上菜（执行 JS），没空理你。你等服务员转过身来理你的这段时间，就是 FID。如果服务员理你了，但做菜慢（处理逻辑复杂），上菜也慢（渲染慢），这整个过程太久，INP 就会炸。</li>
</ul>
<p><strong>直接上代码：FID</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// src/interaction/FID.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">startFID</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> observer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PerformanceObserver</span>(<span class="hljs-function">(<span class="hljs-params">list</span>) =&gt;</span> {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> entry <span class="hljs-keyword">of</span> list.<span class="hljs-title function_">getEntries</span>()) {
      <span class="hljs-comment">// 核心公式：处理开始时间 - 点击时间 = 延迟时间</span>
      <span class="hljs-keyword">const</span> delay = entry.<span class="hljs-property">processingStart</span> - entry.<span class="hljs-property">startTime</span>;
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'FID:'</span>, delay, entry.<span class="hljs-property">target</span>);
      observer.<span class="hljs-title function_">disconnect</span>(); <span class="hljs-comment">// FID 只看第一下，拿到就撤</span>
    }
  });
  observer.<span class="hljs-title function_">observe</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">'first-input'</span>, <span class="hljs-attr">buffered</span>: <span class="hljs-literal">true</span> });
}
</code></pre>
<p><strong>代码怎么理解？</strong></p>
<ul>
<li><code>processingStart - startTime</code>：<code>startTime</code> 是你手指按下的瞬间，<code>processingStart</code> 是代码终于开始跑的瞬间。这中间的差值，就是浏览器因为“忙不过来”而让用户等待的时间。</li>
<li><code>disconnect()</code>：FID 全称是 <strong>First</strong> Input Delay，既然是 First，抓到一次就可以收工了，省点内存。</li>
<li><code>buffered: true</code>：防止 SDK 加载晚了。万一用户手快，脚本还没加载完就点了，这个参数能把那次点击记录补发给你。</li>
</ul>
<p><strong>直接上代码 INP：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// src/interaction/INP.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">startINP</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> observer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PerformanceObserver</span>(<span class="hljs-function">(<span class="hljs-params">list</span>) =&gt;</span> {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> entry <span class="hljs-keyword">of</span> list.<span class="hljs-title function_">getEntries</span>()) {
      <span class="hljs-comment">// 不断收集，因为我们要找最慢的那个</span>
      <span class="hljs-comment">// 这里只是简单的打印，实际开发中需要一个算法来取 top 几位</span>
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Interaction Latency:'</span>, entry.<span class="hljs-property">duration</span>, entry.<span class="hljs-property">target</span>);
    }
  });
  <span class="hljs-comment">// 注意：INP 监听的是 'event' 类型，不是 'first-input'</span>
  observer.<span class="hljs-title function_">observe</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">'event'</span>, <span class="hljs-attr">durationThreshold</span>: <span class="hljs-number">16</span>, <span class="hljs-attr">buffered</span>: <span class="hljs-literal">true</span> });
}
</code></pre>
<p><strong>代码怎么理解？</strong></p>
<ul>
<li><strong>INP 代码</strong>：<code>type: 'event'</code>。这里我们不断监听，不断打 log。实际场景里，你需要维护一个数组，把耗时最长的几次交互存下来，最后上报那个最慢的。</li>
<li><strong>durationThreshold: 16</strong>：这是个优化参数。意思是“小于 16ms（一帧）的交互我就不看了”，省得数据太多刷屏。</li>
</ul>
<p><strong>踩坑提醒</strong></p>
<ul>
<li>
<p><strong>及格线在哪？(Google 标准)</strong></p>
<ul>
<li><strong>FID (第一印象)</strong>：<strong>100ms</strong> 100ms 以内都是优秀，超过 300ms 用户就会觉得“破网站怎么点不动”。</li>
<li><strong>INP (全程体验)</strong>：<strong>200ms</strong> 以内算优秀，超过 <strong>500ms</strong> 用户就想砸键盘了。</li>
</ul>
<p><strong>为啥 FID 和 INP 的标准不一样？</strong></p>
<ul>
<li>因为 <strong>FID 只算排队时间</strong>（你还在门口等服务员），而 <strong>INP 算的是全套服务时间</strong>（排队 + 吃饭 + 买单）。INP 包含的阶段更多（处理 + 渲染），所以 Google 给的宽容度自然也更高。</li>
</ul>
</li>
<li>
<p><strong>INP 才是未来</strong>：Google 已经在 2024 年正式用 INP 取代了 FID。想监控 INP？把 <code>type</code> 改成 <code>event</code>，然后别断开 (<code>disconnect</code>)，一直记到页面走人就行。</p>
</li>
<li>
<p><strong>谁在堵路</strong>：通常是因为主线程在忙着执行巨大的 JS 脚本（Long Task），导致没空搭理用户的点击。</p>
</li>
</ul>
<h4 data-id="heading-18"><strong>(2) Long Task：主线程别堵车</strong></h4>
<p><strong>先认个脸：</strong></p>
<ul>
<li><strong>Long Task (长任务)</strong>：只要执行时间超过 <strong>50 毫秒</strong> 的任务，都叫长任务。</li>
<li><strong>危害</strong>：浏览器的主线程是“单线程”的，一次只能干一件事。如果一个任务霸占了主线程太久，其他的点击、滚动、渲染就都得排队，用户就会觉得“卡死”了。</li>
</ul>
<p><strong>三句话讲明白</strong></p>
<ul>
<li><strong>独木桥效应</strong>：主线程就像一座独木桥。平时过的小车（短任务）很快，大家都有路走。突然来了一辆大卡车（长任务），把桥堵得死死的，后面的车（用户交互）全被堵住了。</li>
<li><strong>50ms 分界线</strong>：为啥是 50ms？
<ul>
<li><strong>100ms 法则</strong>：心理学上，用户点击后 <strong>100ms</strong> 内有反应就算“即时”。</li>
<li><strong>对半分</strong>：Google 把这 100ms 切成两半：<strong>50ms 给你跑代码</strong>，<strong>50ms 留给浏览器画画</strong>。这样加起来刚好 100ms。</li>
<li><strong>高刷屏怎么办</strong>：虽然 120Hz 屏幕每帧只有 8ms，但在 Web 标准里，50ms 依然是那个平衡了“体验”和“代码复杂度”的安全及格线。</li>
</ul>
</li>
<li><strong>抓元凶</strong>：监控 Long Task 不光是为了知道“卡了”，更是为了知道“谁卡了”。API 会告诉你是因为哪个 iframe 或者哪个脚本文件导致的。</li>
</ul>
<p><strong>直接上代码：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// src/interaction/longTask.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">startLongTask</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> observer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PerformanceObserver</span>(<span class="hljs-function">(<span class="hljs-params">list</span>) =&gt;</span> {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> entry <span class="hljs-keyword">of</span> list.<span class="hljs-title function_">getEntries</span>()) {
      <span class="hljs-keyword">if</span> (entry.<span class="hljs-property">duration</span> &gt; <span class="hljs-number">50</span>) {
        <span class="hljs-comment">// 抓到个慢的！看看是谁</span>
        <span class="hljs-comment">// attribution 里面藏着“罪魁祸首”的名字</span>
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'LongTask:'</span>, entry.<span class="hljs-property">duration</span>, entry.<span class="hljs-property">attribution</span>);
      }
    }
  });
  <span class="hljs-comment">// 开启监听，buffered 同样重要</span>
  observer.<span class="hljs-title function_">observe</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">'longtask'</span>, <span class="hljs-attr">buffered</span>: <span class="hljs-literal">true</span> });
}
</code></pre>
<p><strong>代码怎么理解？</strong></p>
<ul>
<li><code>entry.duration &gt; 50</code>：虽然 API 只会返回长任务，但为了保险（或者你想设置更严格的 100ms 阈值），可以再判断一下。</li>
<li><code>entry.attribution</code>：这是个数组，里面会告诉你这个任务来自哪个 <code>container</code>（比如是当前窗口，还是广告 iframe），有的浏览器还能精确到 <code>scriptURL</code>（脚本文件路径）。</li>
</ul>
<p><strong>踩坑提醒</strong></p>
<ul>
<li><strong>拆分任务</strong>：遇到 Long Task 咋办？<strong>拆！</strong> 把一个大函数拆成几个小函数，用 <code>setTimeout</code> 或者 <code>requestIdleCallback</code> 分批执行，给主线程留出喘息的机会（让“大卡车”变成“小车队”）。</li>
<li><strong>广告背锅</strong>：很多时候你会发现 Long Task 都是广告脚本（iframe）带来的。这种时候……你可以甩锅给广告商，或者延迟加载广告。</li>
<li><strong>兼容性</strong>：这个 API 兼容性还不错，但还是老规矩，Safari 可能比较高冷（较新版本才支持）。</li>
</ul>
<h3 data-id="heading-19"><strong>4. Visual Stability (视觉稳定性) 监控</strong></h3>
<p>这可能是最让人抓狂的体验。</p>
<h4 data-id="heading-20"><strong>CLS：页面别乱动</strong></h4>
<ul>
<li><strong>别冤枉好人</strong>：用户点了个按钮展开菜单，布局肯定会变，这叫“符合预期”</li>
<li><strong>聚沙成塔</strong>：CLS 不是一次性的，它是“积分制”。用户在页面上待多久，这期间所有的小抖动都要加起来，算总账。</li>
<li><strong>秋后算账</strong>：千万别抖一下报一下！CLS 是“长跑比赛”，不到终点（页面关闭/隐藏）不知道最终成绩。必须等用户关页面或者切后台的时候，把最后的总分一次性报上去。</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// src/interaction/CLS.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">startCLS</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">let</span> clsValue = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">const</span> observer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PerformanceObserver</span>(<span class="hljs-function">(<span class="hljs-params">list</span>) =&gt;</span> {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> entry <span class="hljs-keyword">of</span> list.<span class="hljs-title function_">getEntries</span>()) {
      <span class="hljs-comment">// 核心：剔除用户交互（点击/输入）导致的预期偏移</span>
      <span class="hljs-keyword">if</span> (!entry.<span class="hljs-property">hadRecentInput</span>) {
        clsValue += entry.<span class="hljs-property">value</span>;
      }
    }
  });
  observer.<span class="hljs-title function_">observe</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">'layout-shift'</span>, <span class="hljs-attr">buffered</span>: <span class="hljs-literal">true</span> });

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">report</span> = (<span class="hljs-params"/>) =&gt; <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'CLS Final:'</span>, clsValue);

  <span class="hljs-comment">// 双重保险：兼容各类浏览器的卸载场景</span>
  <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'pagehide'</span>, report, { <span class="hljs-attr">once</span>: <span class="hljs-literal">true</span> });
  <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(
    <span class="hljs-string">'visibilitychange'</span>,
    <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">document</span>.<span class="hljs-property">visibilityState</span> === <span class="hljs-string">'hidden'</span>) <span class="hljs-title function_">report</span>();
    },
    { <span class="hljs-attr">once</span>: <span class="hljs-literal">true</span> }
  );
}
</code></pre>
<p><strong>代码怎么理解？</strong></p>
<ul>
<li>
<p><strong>怎么区分是“好动”还是“乱动”？</strong></p>
<p>刚刚我们说用户交互（比如点按钮展开菜单）导致的布局变化不能算 CLS。那怎么判断呢？
浏览器提供了 <code>hadRecentInput</code> 字段。只要用户最近 <strong>500ms</strong> 内有过点击或按键，浏览器就会把这个字段标为 <code>true</code>。咱们代码里必须把这些“良民”过滤掉，只抓那些“莫名其妙”的抖动。</p>
</li>
<li>
<p><strong>分数怎么算？</strong></p>
<p><code>entry.value</code> 就是每一次抖动的分数。比如一张大图突然插进来，把文字挤下去 100px，可能就贡献了 0.05 分。我们要做的就是一个无情的“加法器”，把这些分数全加起来。</p>
</li>
<li>
<p><strong>为啥要监听两个卸载事件？</strong></p>
<p><code>visibilitychange</code> 和 <code>pagehide</code> 都是用来监听页面关闭/隐藏的。为啥要搞两个？因为浏览器脾气不一样：有的喜欢 <code>pagehide</code>（比如 Safari），有的推荐 <code>visibilitychange</code>。为了保证数据不丢，咱们搞个“双保险”，谁先触发就算谁的。</p>
<ul>
<li><strong>为啥不用 beforeunload？</strong>
早年间确实流行用 <code>beforeunload</code> 或 <code>unload</code>，但现在它们<strong>不靠谱</strong>了，尤其是在手机上。用户直接划掉 App、切后台，这些事件经常<strong>不会触发</strong>。而且它还会阻止浏览器做“往返缓存”（BFCache），拖慢页面后退速度。所以现在的标准姿势就是 <code>visibilitychange</code> + <code>pagehide</code>。</li>
</ul>
</li>
</ul>
<p><strong>踩坑提醒</strong></p>
<ul>
<li>成绩线：CLS &lt; 0.1 很好，&gt; 0.25 需要重点优化</li>
<li>动态内容要“留坑位”：骨架屏/固定尺寸，能明显降低位移</li>
<li>广告/懒加载图片经常是元凶，优先排查</li>
</ul>
<h3 data-id="heading-21"><strong>5. Network 监控：查查谁在拖后腿</strong></h3>
<p><strong>先认个脸：</strong></p>
<ul>
<li><strong>Resource Timing (资源计时)</strong>：专门管资源加载的。不管是图片、CSS、JS 文件，还是接口请求 (XHR/Fetch)，只要是从网络下载的东西，它都能记一笔。</li>
<li><strong>核心指标</strong>：除了总耗时 (<code>duration</code>)，还能细到 DNS 解析多久、TCP 建连多久、首字节时间 (TTFB) 等等。</li>
</ul>
<p><strong>三句话讲明白</strong></p>
<ul>
<li><strong>查快递</strong>：你买东西（请求资源），想知道为什么这么慢？是卖家发货慢（TTFB），还是路上堵车（下载慢）？Resource Timing 就是那个详细的物流单。</li>
<li><strong>不只是图片</strong>：别被名字骗了，它不光管图片 CSS，你的 <code>fetch</code> 请求、<code>axios</code> 请求，只要走了网络，它都能监控到。</li>
<li><strong>严防死守</strong>：浏览器为了安全，对于跨域的资源（比如你用了百度的图片），默认只告诉你“用了多久”，不告诉你“怎么用的”（DNS/TCP 细节），除非对方给了通行证。</li>
</ul>
<p><strong>直接上代码：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">startEntries</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> observer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PerformanceObserver</span>(<span class="hljs-function">(<span class="hljs-params">list</span>) =&gt;</span> {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> entry <span class="hljs-keyword">of</span> list.<span class="hljs-title function_">getEntries</span>()) {
      <span class="hljs-comment">// resource 类型包含了 img, script, css, fetch, xmlhttprequest, link 等</span>
      <span class="hljs-keyword">if</span> (entry.<span class="hljs-property">entryType</span> === <span class="hljs-string">'resource'</span>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(
          <span class="hljs-string">'Resource:'</span>,
          entry.<span class="hljs-property">name</span>,
          entry.<span class="hljs-property">initiatorType</span>,
          entry.<span class="hljs-property">duration</span>
        );
      }
    }
  });
  <span class="hljs-comment">// 同样记得 buffered: true，防止漏掉页面刚开始加载的那些资源</span>
  observer.<span class="hljs-title function_">observe</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">'resource'</span>, <span class="hljs-attr">buffered</span>: <span class="hljs-literal">true</span> });
}
</code></pre>
<p><strong>代码怎么理解？</strong></p>
<ul>
<li><code>entryType === 'resource'</code>：这个频道包罗万象。图片 (<code>img</code>)、样式 (<code>css</code>)、脚本 (<code>script</code>) 甚至你的接口调用 (<code>fetch</code>/<code>xmlhttprequest</code>) 都在这儿。</li>
<li><code>initiatorType</code>：这个字段告诉你资源是谁发起的。是 <code>&lt;img src="..."&gt;</code> 发起的？还是 <code>fetch()</code> 发起的？一看便知。</li>
</ul>
<p><strong>进阶用法：监控接口 (API) 耗时详情</strong></p>
<p>有时候我们不关心图片资源，而是重点关注<strong>后端接口的响应耗时</strong>。通过过滤 <code>fetch</code> 和 <code>xmlhttprequest</code>，我们不仅能知道接口慢不慢，还能知道<strong>慢在哪里</strong>（是 DNS、TCP 还是服务端处理）。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">startRequest</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">entryHandler</span> = (<span class="hljs-params">list</span>) =&gt; {
    <span class="hljs-keyword">const</span> data = list.<span class="hljs-title function_">getEntries</span>();
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> entry <span class="hljs-keyword">of</span> data) {
      <span class="hljs-comment">// 过滤出 API 请求 (Fetch 和 XHR)</span>
      <span class="hljs-keyword">if</span> (
        entry.<span class="hljs-property">initiatorType</span> === <span class="hljs-string">'fetch'</span> ||
        entry.<span class="hljs-property">initiatorType</span> === <span class="hljs-string">'xmlhttprequest'</span>
      ) {
        <span class="hljs-keyword">const</span> reportData = {
          <span class="hljs-attr">name</span>: entry.<span class="hljs-property">name</span>, <span class="hljs-comment">// 请求地址</span>
          <span class="hljs-attr">type</span>: <span class="hljs-string">'performance'</span>,
          <span class="hljs-attr">subType</span>: entry.<span class="hljs-property">entryType</span>,
          <span class="hljs-attr">sourceType</span>: entry.<span class="hljs-property">initiatorType</span>,
          <span class="hljs-attr">duration</span>: entry.<span class="hljs-property">duration</span>, <span class="hljs-comment">// 请求总耗时</span>
          <span class="hljs-attr">dns</span>: entry.<span class="hljs-property">domainLookupEnd</span> - entry.<span class="hljs-property">domainLookupStart</span>, <span class="hljs-comment">// DNS 解析耗时</span>
          <span class="hljs-attr">tcp</span>: entry.<span class="hljs-property">connectEnd</span> - entry.<span class="hljs-property">connectStart</span>, <span class="hljs-comment">// TCP 连接耗时</span>
          <span class="hljs-attr">ttfb</span>: entry.<span class="hljs-property">responseStart</span> - entry.<span class="hljs-property">requestStart</span>, <span class="hljs-comment">// 首字节响应时间 (服务端处理时间)</span>
          <span class="hljs-attr">transferSize</span>: entry.<span class="hljs-property">transferSize</span>, <span class="hljs-comment">// 传输字节数</span>
          <span class="hljs-attr">startTime</span>: entry.<span class="hljs-property">startTime</span>, <span class="hljs-comment">// 请求开始时间</span>
          <span class="hljs-attr">pageUrl</span>: <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">href</span>,
        };
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Network Request:'</span>, reportData);
      }
    }
  };

  <span class="hljs-comment">// 这里不调用 disconnect()，以便持续监听后续产生的网络请求</span>
  <span class="hljs-keyword">const</span> observer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PerformanceObserver</span>(entryHandler);
  observer.<span class="hljs-title function_">observe</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">'resource'</span>, <span class="hljs-attr">buffered</span>: <span class="hljs-literal">true</span> });
}
</code></pre>
<p><strong>代码怎么理解？</strong></p>
<ul>
<li>
<p><strong>TTFB (首字节时间) —— “厨师做菜慢”</strong></p>
<ul>
<li>公式：<code>responseStart - requestStart</code>。</li>
<li><strong>大白话</strong>：你点完菜（发送请求）到服务员端上第一盘菜（收到第一个字节）的时间。</li>
<li><strong>谁背锅</strong>：这时间长，说明<strong>后端处理慢</strong>（查数据库慢、业务逻辑太复杂）。跟网速没啥关系，纯粹是“后厨”忙不过来。赶紧截图甩给后端开发！</li>
</ul>
</li>
<li>
<p><strong>TCP &amp; DNS —— “找路和打招呼”</strong></p>
<ul>
<li><strong>DNS</strong>：就像查电话本。要把 <code>api.example.com</code> 变成 IP 地址。如果这块慢，说明用户离你的服务器太远，该上 CDN 了。</li>
<li><strong>TCP</strong>：就像见面握手。客户端和服务器得先“握手”建立连接才能说话。如果是 HTTPS，还得再加一轮 SSL 握手（查身份证）。这一套下来也得耗不少时间。</li>
</ul>
</li>
<li>
<p><strong>TransferSize (传输大小) —— “运货量”</strong></p>
<ul>
<li><strong>大白话</strong>：接口到底吐了多少数据给你？</li>
<li><strong>场景</strong>：有时候接口慢，不是因为后端慢，而是因为<strong>数据量太大</strong>。比如一个列表接口，一下子返回了 10000 条数据，足足 5MB。光是下载这 5MB 就得好几秒。这时候就得让后端搞“分页”了。</li>
</ul>
</li>
</ul>
<p><strong>踩坑提醒</strong></p>
<ul>
<li><strong>跨域拿不到细节</strong>：这是最常见的坑。看到 DNS 时间是 0 别奇怪，八成是跨域了且没加 <code>Timing-Allow-Origin</code> 头。这是浏览器为了保护隐私。</li>
<li><strong>别全报</strong>：一个页面可能有上百个资源，全报上去服务器受不了。建议设个门槛（比如只报 &gt; 1 秒的），或者只报核心的 JS/CSS。</li>
<li><strong>接口监控</strong>：很多人不知道 <code>fetch</code> 请求也能在这里抓到。其实用它来监控后端接口性能，比自己封装 <code>axios</code> 拦截器要准得多，因为它算的是浏览器底层的真实时间。</li>
</ul>
<h3 data-id="heading-22"><strong>6. 必备工具函数：定位神器 (util/index.js)</strong></h3>
<p>最后，我们得有个工具能帮我们“指路”。只告诉老板“图片慢”没用，你得告诉他是“哪个图片慢”。</p>
<p><code>getElementSelector</code> 就是这个“定位神器”。它能把一个 DOM 元素转换成 CSS 选择器（比如 <code>body &gt; div#app &gt; h1</code>），让你直接在代码里找到它。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// src/util/index.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getElementSelector</span>(<span class="hljs-params">element</span>) {
  <span class="hljs-keyword">if</span> (!element || element.<span class="hljs-property">nodeType</span> !== <span class="hljs-number">1</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">''</span>;

  <span class="hljs-comment">// 如果有 id，直接返回 #id</span>
  <span class="hljs-keyword">if</span> (element.<span class="hljs-property">id</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">`#<span class="hljs-subst">${element.id}</span>`</span>;
  }

  <span class="hljs-comment">// 递归向上查找</span>
  <span class="hljs-keyword">let</span> path = [];
  <span class="hljs-keyword">while</span> (element) {
    <span class="hljs-keyword">let</span> name = element.<span class="hljs-property">localName</span>;
    <span class="hljs-keyword">if</span> (!name) <span class="hljs-keyword">break</span>;

    <span class="hljs-comment">// 如果有 id，拼接后停止</span>
    <span class="hljs-keyword">if</span> (element.<span class="hljs-property">id</span>) {
      path.<span class="hljs-title function_">unshift</span>(<span class="hljs-string">`#<span class="hljs-subst">${element.id}</span>`</span>);
      <span class="hljs-keyword">break</span>;
    }

    <span class="hljs-comment">// 加上 class</span>
    <span class="hljs-keyword">let</span> className = element.<span class="hljs-title function_">getAttribute</span>(<span class="hljs-string">'class'</span>);
    <span class="hljs-keyword">if</span> (className) {
      name += <span class="hljs-string">'.'</span> + className.<span class="hljs-title function_">split</span>(<span class="hljs-regexp">/\s+/</span>).<span class="hljs-title function_">join</span>(<span class="hljs-string">'.'</span>);
    }

    path.<span class="hljs-title function_">unshift</span>(name);
    element = element.<span class="hljs-property">parentElement</span>;
  }

  <span class="hljs-keyword">return</span> path.<span class="hljs-title function_">join</span>(<span class="hljs-string">' &gt; '</span>);
}
</code></pre>
<h3 data-id="heading-23"><strong>7. 自定义指标：代码秒表</strong></h3>
<p>除了浏览器给的指标，有时候我们想知道<strong>某个具体函数到底跑了多久</strong>，或者<strong>滚动列表卡不卡</strong>。这时候就需要我们自己造个“秒表”。</p>
<h4 data-id="heading-24"><strong>(1) 函数耗时监控 (Wrapper)</strong></h4>
<p><strong>三句话讲明白</strong></p>
<ul>
<li><strong>不改业务代码</strong>：不用在每个函数里写 <code>start</code> 和 <code>end</code>，用这个“高阶函数”包一下就行。</li>
<li><strong>支持异步</strong>：不管是普通的 <code>for</code> 循环，还是 <code>await</code> 数据库查询，都能监控。</li>
<li><strong>自动抓报错</strong>：如果函数跑挂了，它还能顺便把错误信息记下来。</li>
</ul>
<p><strong>直接上代码：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">/**
 * 同步函数计时器
 * 用法：const newData = timeFunction('处理数据', processData, rawData);
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">timeFunction</span> = (<span class="hljs-params">name, fn, ...args</span>) =&gt; {
  <span class="hljs-keyword">const</span> start = performance.<span class="hljs-title function_">now</span>();
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> result = <span class="hljs-title function_">fn</span>(...args);
    <span class="hljs-keyword">const</span> duration = performance.<span class="hljs-title function_">now</span>() - start;
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Function [<span class="hljs-subst">${name}</span>]:`</span>, duration.<span class="hljs-title function_">toFixed</span>(<span class="hljs-number">2</span>) + <span class="hljs-string">'ms'</span>);
    <span class="hljs-keyword">return</span> result;
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Function [<span class="hljs-subst">${name}</span>] Error:`</span>, error);
    <span class="hljs-keyword">throw</span> error; <span class="hljs-comment">// 别吞掉错误，继续抛出</span>
  }
};

<span class="hljs-comment">/**
 * 异步函数计时器 (Promise)
 * 用法：const user = await timeAsyncFunction('获取用户', fetchUser, id);
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">timeAsyncFunction</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">name, fn, ...args</span>) =&gt; {
  <span class="hljs-keyword">const</span> start = performance.<span class="hljs-title function_">now</span>();
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fn</span>(...args); <span class="hljs-comment">// 等待异步完成</span>
    <span class="hljs-keyword">const</span> duration = performance.<span class="hljs-title function_">now</span>() - start;
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Async Function [<span class="hljs-subst">${name}</span>]:`</span>, duration.<span class="hljs-title function_">toFixed</span>(<span class="hljs-number">2</span>) + <span class="hljs-string">'ms'</span>);
    <span class="hljs-keyword">return</span> result;
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Async Function [<span class="hljs-subst">${name}</span>] Error:`</span>, error);
    <span class="hljs-keyword">throw</span> error;
  }
};
</code></pre>
<h4 data-id="heading-25"><strong>(2) 滚动流畅度监控</strong></h4>
<p><strong>三句话讲明白</strong></p>
<ul>
<li><strong>不看帧率看延迟</strong>：算 FPS 太复杂。我们就看最朴素的道理：<strong>我划了一下屏幕，浏览器多久才画出下一帧？</strong></li>
<li><strong>搭便车 (rAF)</strong>：<code>requestAnimationFrame</code> (rAF) 是浏览器的“渲染末班车”。我们在滚动事件里跳上这趟车，等车到站了（渲染完成了），看看表，就知道这一路花了多久。</li>
<li><strong>抽查机制</strong>：滚动事件触发频率极高（一秒几百次）。我们没必要次次都查，每隔半秒（500ms）抽查一次“末班车”准不准点就行了。</li>
</ul>
<p><strong>直接上代码：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// src/interaction/scroll.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">startScroll</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">let</span> lastScrollLog = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">const</span> scrollMinInterval = <span class="hljs-number">500</span>; <span class="hljs-comment">// ms，限流，每半秒检查一次</span>

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">onScroll</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">const</span> start = performance.<span class="hljs-title function_">now</span>();
    <span class="hljs-comment">// 没到时间就别折腾，省点 CPU</span>
    <span class="hljs-keyword">if</span> (start - lastScrollLog &lt; scrollMinInterval) <span class="hljs-keyword">return</span>;

    lastScrollLog = start;

    <span class="hljs-comment">// 核心逻辑：预约下一帧渲染</span>
    <span class="hljs-comment">// 就像你对浏览器说：“兄弟，画完这帧叫我一声。”</span>
    <span class="hljs-title function_">requestAnimationFrame</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">const</span> afterRAF = performance.<span class="hljs-title function_">now</span>();
      <span class="hljs-keyword">const</span> duration = afterRAF - start; <span class="hljs-comment">// 这一帧到底花了多久？</span>

      <span class="hljs-comment">// 16ms 是 60Hz 屏幕的标准一帧时间</span>
      <span class="hljs-comment">// 如果超过 16ms，说明浏览器忙不过来了，这就叫“掉帧”</span>
      <span class="hljs-keyword">if</span> (duration &gt; <span class="hljs-number">16</span>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Scroll Lag:'</span>, duration.<span class="hljs-title function_">toFixed</span>(<span class="hljs-number">2</span>) + <span class="hljs-string">'ms'</span>);
      }
    });
  };

  <span class="hljs-comment">// passive: true 告诉浏览器“我不阻止滚动”，能让滚动更丝滑</span>
  <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'scroll'</span>, onScroll, { <span class="hljs-attr">passive</span>: <span class="hljs-literal">true</span> });
}
</code></pre>
<p><strong>代码怎么理解？</strong></p>
<ul>
<li><strong>为什么要用 <code>requestAnimationFrame</code>？</strong>
<ul>
<li>JS 是单线程的。当你触发 <code>scroll</code> 事件时，浏览器可能正忙着处理别的事（比如重排重绘）。</li>
<li><code>requestAnimationFrame</code> 会把你的代码放到<strong>浏览器准备画下一帧</strong>的时候执行。</li>
<li>所以，<code>start</code> 是你触发滚动的时间，<code>afterRAF</code> 是画面终于画出来的时间。这俩的差值 (<code>duration</code>) 越大，说明浏览器卡得越久，你感觉到的“顿挫感”就越强。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-26">8. 数据上报（sender.ts）</h3>
<p>收集到数据后，如何发给后端？这看似简单，实则暗藏玄机。</p>
<h4 data-id="heading-27">1. 核心痛点：页面关了，请求还没发完怎么办？</h4>
<p>用户看完网页直接关掉（或者刷新跳转），这时候浏览器会无情地杀掉当前页面进程里所有正在跑的异步请求（XHR/Fetch）。</p>
<p>结果就是：<strong>监控数据还没发出去，就死在半路上了。</strong></p>
<h4 data-id="heading-28">2. 解决方案</h4>
<p>为了确保数据必达，我们采用一套组合拳：</p>
<ol>
<li>
<p><strong>首选</strong> <strong>Navigator.sendBeacon</strong>：</p>
<p>它是专门为“页面卸载上报”设计的。</p>
<p><strong>特点</strong>：浏览器会在后台默默把数据发完，不阻塞页面关闭，也不会被杀掉。</p>
</li>
<li>
<p><strong>次选</strong> <strong>fetch</strong> <strong>+</strong> <strong>keepalive</strong>：</p>
<p>如果浏览器不支持 Beacon，或者你需要自定义 Header（Beacon 不支持自定义 Header），就用 <strong>fetch</strong> 并开启 <strong>keepalive: true</strong>。</p>
<p><strong>特点</strong>：告诉浏览器“这个请求很重要，页面关了也请帮我发完”。</p>
</li>
</ol>
<h4 data-id="heading-29">3. 代码实现</h4>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">sendBehaviorData</span> = (<span class="hljs-params">data: Record&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">any</span>&gt;, url: <span class="hljs-built_in">string</span></span>) =&gt; {
  <span class="hljs-comment">// 1. 包装数据：加上一些公共信息（比如 UserAgent，屏幕分辨率等）</span>
  <span class="hljs-keyword">const</span> dataToSend = {
    ...data,
    <span class="hljs-attr">userAgent</span>: navigator.<span class="hljs-property">userAgent</span>,
    <span class="hljs-comment">// screenWidth: window.screen.width, // 可选</span>
  };

  <span class="hljs-comment">// 2. 优先使用 sendBeacon (最稳，且不阻塞)</span>
  <span class="hljs-comment">// 注意：sendBeacon 不支持自定义 Content-Type，默认是 text/plain</span>
  <span class="hljs-comment">// 这里用 Blob 强制指定为 application/json</span>
  <span class="hljs-keyword">if</span> (navigator.<span class="hljs-property">sendBeacon</span>) {
    <span class="hljs-keyword">const</span> blob = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Blob</span>([<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(dataToSend)], {
      <span class="hljs-attr">type</span>: <span class="hljs-string">'application/json'</span>,
    });

    <span class="hljs-comment">// sendBeacon 返回 true 表示进入队列成功</span>
    navigator.<span class="hljs-title function_">sendBeacon</span>(url, blob);

    <span class="hljs-keyword">return</span>;
  }

  <span class="hljs-comment">// 3. 降级方案：使用 fetch + keepalive</span>
  <span class="hljs-comment">// 即使页面关闭，keepalive 也能保证请求发出</span>
  <span class="hljs-title function_">fetch</span>(url, {
    <span class="hljs-attr">method</span>: <span class="hljs-string">'POST'</span>,
    <span class="hljs-attr">headers</span>: { <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'application/json'</span> },
    <span class="hljs-attr">body</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(dataToSend),
    <span class="hljs-attr">keepalive</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// &lt;--- 关键参数！防止页面关闭时请求被杀</span>
  }).<span class="hljs-keyword">catch</span>(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'上报失败:'</span>, err);
  });
};
</code></pre>
<hr/>
<h2 data-id="heading-30">3. 工程化构建配置</h2>
<p>既然是 SDK，最好的分发方式当然是发布到 NPM。这样其他项目只需要一行命令就能接入你的前端错误监控系统。</p>
<p>这里我们选择 <strong>Rollup</strong>对代码进行打包，因为它比 Webpack 更适合打包库（Library），生成的代码更简洁。</p>
<h3 data-id="heading-31">3.1 package 配置 (<code>package.json</code>)</h3>
<p><code>package.json</code> 不仅仅是依赖管理，它还定义了你的包如何被外部使用。配置不当会导致用户引入报错或无法获得代码提示。</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"performance-sdk"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1.0.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"A lightweight performance monitoring SDK"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"main"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"dist/index.cjs.js"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"module"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"dist/index.esm.js"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"browser"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"dist/index.umd.js"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"module"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"build"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"rollup -c"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"dev"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"rollup -c -w"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"keywords"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"performance"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"monitor"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"sdk"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"license"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"MIT"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"files"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"dist"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"devDependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"rollup"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^4.9.0"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"@rollup/plugin-typescript"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^11.1.0"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"@rollup/plugin-terser"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^0.4.0"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"typescript"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^5.3.0"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"tslib"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^2.6.0"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>💡 关键字段解读：</strong></p>
<ul>
<li><strong><code>name</code></strong>: 包的“身份证号”。在 NPM 全球范围内必须唯一，发布前记得先去搜一下有没有重名。</li>
<li><strong>入口文件“三剑客”</strong>（决定了别人怎么引用你的包）：
<ul>
<li><strong><code>main</code></strong>: <strong>CommonJS 入口</strong>。给 Node.js 环境或老旧构建工具（如 Webpack 4）使用的。</li>
<li><strong><code>module</code></strong>: <strong>ESM 入口</strong>。给现代构建工具（Vite, Webpack 5）使用的。支持 Tree Shaking（摇树优化），能减小体积。</li>
<li><strong><code>browser</code></strong>: <strong>UMD 入口</strong>。给浏览器直接通过 <code>&lt;script&gt;</code> 标签引入使用的（如 CDN）。</li>
</ul>
</li>
<li><strong><code>files</code></strong>: <strong>发布白名单</strong>。指定 <code>npm publish</code> 时只上传哪些文件（这里我们只传编译后的 <code>dist</code> 目录）。源码、测试代码等不需要发上去，以减小包体积。</li>
</ul>
<h3 data-id="heading-32">3.2 TypeScript 配置 (<code>tsconfig.json</code>)</h3>
<p>我们需要配置 TypeScript 如何编译代码，并生成类型声明文件（<code>.d.ts</code>），这对使用 TS 的用户非常友好。</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"compilerOptions"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"target"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"es5"</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 编译成 ES5，兼容旧浏览器</span>
    <span class="hljs-attr">"module"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"esnext"</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 保留 ES 模块语法，交给 Rollup 处理</span>
    <span class="hljs-attr">"declaration"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 生成 .d.ts 类型文件 (关键！)</span>
    <span class="hljs-attr">"declarationDir"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./dist"</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 类型文件输出目录</span>
    <span class="hljs-attr">"strict"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 开启严格模式，代码更健壮</span>
    <span class="hljs-attr">"moduleResolution"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"node"</span> <span class="hljs-comment">// 按 Node 方式解析模块</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"include"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"src/**/*"</span><span class="hljs-punctuation">]</span> <span class="hljs-comment">// 编译 src 下的所有文件</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-33">3.3 Rollup 打包配置 (<code>rollup.config.js</code>)</h3>
<p>为了兼容各种使用场景，我们配置 Rollup 输出三种格式：</p>
<ol>
<li><strong>ESM (<code>.esm.js</code>)</strong>: 给现代构建工具（Vite, Webpack）使用，支持 Tree Shaking。</li>
<li><strong>CJS (<code>.cjs.js</code>)</strong>: 给 Node.js 或旧版工具使用。</li>
<li><strong>UMD (<code>.umd.js</code>)</strong>: 可以直接在浏览器通过 <code>&lt;script&gt;</code> 标签引入，会挂载全局变量。</li>
</ol>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> typescript <span class="hljs-keyword">from</span> <span class="hljs-string">'@rollup/plugin-typescript'</span>;
<span class="hljs-keyword">import</span> terser <span class="hljs-keyword">from</span> <span class="hljs-string">'@rollup/plugin-terser'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">input</span>: <span class="hljs-string">'src/index.ts'</span>,
  <span class="hljs-attr">output</span>: [
    { <span class="hljs-attr">file</span>: <span class="hljs-string">'dist/index.cjs.js'</span>, <span class="hljs-attr">format</span>: <span class="hljs-string">'cjs'</span>, <span class="hljs-attr">sourcemap</span>: <span class="hljs-literal">true</span> },
    { <span class="hljs-attr">file</span>: <span class="hljs-string">'dist/index.esm.js'</span>, <span class="hljs-attr">format</span>: <span class="hljs-string">'es'</span>, <span class="hljs-attr">sourcemap</span>: <span class="hljs-literal">true</span> },
    {
      <span class="hljs-attr">file</span>: <span class="hljs-string">'dist/index.umd.js'</span>,
      <span class="hljs-attr">format</span>: <span class="hljs-string">'umd'</span>,
      <span class="hljs-attr">name</span>: <span class="hljs-string">'PerformanceSDK'</span>,
      <span class="hljs-attr">sourcemap</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">plugins</span>: [<span class="hljs-title function_">terser</span>()],
    },
  ],
  <span class="hljs-attr">plugins</span>: [
    <span class="hljs-title function_">typescript</span>({
      <span class="hljs-attr">tsconfig</span>: <span class="hljs-string">'./tsconfig.json'</span>,
      <span class="hljs-attr">declaration</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">declarationDir</span>: <span class="hljs-string">'dist'</span>,
    }),
  ],
};
</code></pre>
<h2 data-id="heading-34">4. 发布到 NPM (保姆级教程)</h2>
<h3 data-id="heading-35">4.1 准备工作</h3>
<ol>
<li><strong>注册账号</strong>：去 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.npmjs.com%2F" target="_blank" title="https://www.npmjs.com/" ref="nofollow noopener noreferrer">npmjs.com</a> 注册一个账号（记得验证邮箱，否则无法发布）。</li>
<li><strong>检查包名</strong>：在 NPM 搜一下你的 <code>package.json</code> 里的 <code>name</code>，确保没有被占用。如果不幸重名，改个独特的名字，比如 <code>performance-sdk-vip</code>。</li>
</ol>
<h3 data-id="heading-36">4.2 终端操作三步走</h3>
<p>打开终端（Terminal），在项目根目录下操作：</p>
<p><strong>第一步：登录 NPM</strong></p>
<pre><code class="hljs language-bash" lang="bash">npm login
</code></pre>
<ul>
<li>输入命令后按回车，浏览器会弹出登录页面。</li>
<li>或者在终端根据提示输入用户名、密码和邮箱验证码。</li>
<li>登录成功后会显示 <code>Logged in as &lt;your-username&gt;</code>.</li>
<li><em>注意：如果你之前切换过淘宝源，发布时必须切回官方源：<code>npm config set registry https://registry.npmjs.org/</code></em></li>
</ul>
<p><strong>第二步：打包代码</strong></p>
<p>确保 <code>dist</code> 目录是最新的，不要发布空代码。</p>
<pre><code class="hljs language-bash" lang="bash">npm run build
</code></pre>
<p><strong>第三步：正式发布</strong></p>
<pre><code class="hljs language-bash" lang="bash">npm publish --access public
</code></pre>
<ul>
<li><code>--access public</code> 参数用于确保发布的包是公开的（特别是当包名带 <code>@</code> 前缀时）。</li>
<li>看到 <code>+ performance-sdk-vip@1.0.0</code> 字样，恭喜你，发布成功！</li>
</ul>
<p>现在，全世界的开发者都可以通过 <code>npm install performance-sdk-vip</code> 来使用你的作品了！</p>
<h2 data-id="heading-37">5. 如何使用</h2>
<p>SDK 发布后，支持多种引入方式，适配各种开发场景。</p>
<ul>
<li>NPM + ES Modules（推荐）</li>
</ul>
<pre><code class="hljs language-bash" lang="bash">npm install performance-sdk
</code></pre>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">PerformanceMonitor</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'performance-sdk'</span>;

<span class="hljs-keyword">const</span> monitor = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PerformanceMonitor</span>({
  <span class="hljs-comment">/* 可选：log, sampleRate, reportUrl */</span>
});
monitor.<span class="hljs-title function_">init</span>();
</code></pre>
<ul>
<li>CDN 直接引入（UMD）</li>
</ul>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://unpkg.com/performance-sdk@x.x.x/dist/index.umd.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
  <span class="hljs-keyword">const</span> monitor = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PerformanceSDK</span>.<span class="hljs-title class_">PerformanceMonitor</span>({
    <span class="hljs-comment">/* 可选配置 */</span>
  });
  monitor.<span class="hljs-title function_">init</span>();
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<h2 data-id="heading-38">6. 总结与展望</h2>
<p>恭喜你！到这里，你已经亲手打造了一套<strong>麻雀虽小，五脏俱全</strong>的性能监控 SDK。</p>
<p>咱们再回头看看这四大支柱：</p>
<ol>
<li><strong>Loading (加载)</strong>：FP/FCP/LCP 负责盯着**“快不快”**。白屏时间短，用户才愿意留下来。</li>
<li><strong>Interaction (交互)</strong>：FID/INP 负责盯着**“顺不顺”**。点击有反馈，用户才觉得好用。</li>
<li><strong>Visual Stability (稳定性)</strong>：CLS 负责盯着**“稳不稳”**。页面不乱跳，用户才不心烦。</li>
<li><strong>Network (网络)</strong>：Resource Timing 负责盯着**“通不通”**。接口响应快，体验才有底气。</li>
</ol>
<p><strong>下一步可以玩点啥？</strong></p>
<p>性能监控只是前端监控体系的<strong>三分之一</strong>。如果你想打造一个无死角的监控系统，光看性能是不够的：</p>
<ul>
<li><strong>报错了咋办？</strong> JS 挂了、接口 500 了、资源加载失败了……这些需要<strong>错误监控</strong>来兜底。</li>
</ul>
<p>👉 传送门：
<a href="https://juejin.cn/post/7580674010837549102" target="_blank" title="https://juejin.cn/post/7580674010837549102">《【错误监控】别只做工具人了！手把手带你写一个前端错误监控 SDK》（https://juejin.cn/post/7580674010837549102）</a></p>
<ul>
<li><strong>用户在干啥？</strong> 用户点了哪个按钮？在哪个页面停留最久？这些需要<strong>行为监控</strong>来分析。</li>
</ul>
<p>👉 传送门：<a href="https://juejin.cn/post/7583612559443279923" target="_blank" title="https://juejin.cn/post/7583612559443279923">《【用户行为监控】别只做工具人了！手把手带你写一个前端埋点统计 SDK》（https://juejin.cn/post/7583612559443279923）</a></p>
<p>当然，你还可以结合：</p>
<ul>
<li><strong>可视化大屏</strong>：光有数据不行，得画成图表（ECharts/Grafana）。看着曲线波动，才有成就感。</li>
<li><strong>报警机器人</strong>：LCP 超过 4 秒了？接口报错率飙升了？直接钉钉/飞书群里 @ 全体成员，把问题扼杀在摇篮里。</li>
</ul>
<p>性能优化是一场<strong>没有终点的马拉松</strong>。希望这篇文章能是你打造专属监控系统的起点。<strong>Happy Coding!</strong></p>
<blockquote>
<p>如果觉得对您有帮助，欢迎<strong>点赞</strong>👍 <strong>收藏</strong> ⭐ <strong>关注</strong> 🔔 支持一下！</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[你知道三国志战略版是怎么实现横竖屏动态切换的吗？]]></title>    <link>https://juejin.cn/post/7586506307727556618</link>    <guid>https://juejin.cn/post/7586506307727556618</guid>    <pubDate>2025-12-23T00:39:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586506307727556618" data-draft-id="7586504691846103049" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="你知道三国志战略版是怎么实现横竖屏动态切换的吗？"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-23T00:39:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="亿元程序员"/> <meta itemprop="url" content="https://juejin.cn/user/1972988307323236"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            你知道三国志战略版是怎么实现横竖屏动态切换的吗？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1972988307323236/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    亿元程序员
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T00:39:25.000Z" title="Tue Dec 23 2025 00:39:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<p><strong>哈喽大家好</strong>，我是亿元程序员。</p>
<p><strong>说实话我也不知道三国志战略版是怎么实现横竖屏动态切换的。</strong></p>
<p><strong>但是</strong>，我们可以看看它的源码是怎么实现的。</p>
<p><strong>什么？没有源码？</strong></p>
<p><strong>言归正传</strong>，今天小伙伴们跟随笔者，一起来看下如何在<strong>Cocos游戏开发中实现横竖屏动态切换！</strong></p>
<h2 data-id="heading-1">1. 拆解分析一下</h2>
<p>**《孙子兵法》**说得好，“知己知彼，百战不殆”。</p>
<p><strong>虽然</strong>我们没有三国志战略版的源码，但是我们可以通过游戏分析推测一下三国志战略版是怎么实现的。</p>
<h3 data-id="heading-2">1.横竖屏同一套UI和代码</h3>
<p><strong>我们先看看</strong>录屏：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8fda3b9e0fcc4e679519ba155363ac13~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767055165&amp;x-signature=pMO10Gtp6ue9Jm5Fd%2FmzFhJDJHU%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p><strong>从录屏</strong>当中我们可以通过肉眼看出，像这样简单的一个提示弹框，在横竖屏中的尺寸是一样的，因此猜测是使用的是同一套<code>UI</code>。</p>
<p>**为什么可以这么确定？**因为我是用尺子量出来的，下面是竖屏状态下的<code>UI</code>尺寸。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/45c59c3db724402abf155a89775b53dd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767055165&amp;x-signature=m8K9UbNDg450e0DsvvtKcCyMAyA%3D" alt="" loading="lazy"/></p>
<p><strong>而下面</strong>是横屏状态下的<code>UI</code>尺寸。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/577fbd10879345eaa6ded5fba907808c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767055165&amp;x-signature=9IDdAx1Z7gJA0z9tKGIeIS7x4uA%3D" alt="" loading="lazy"/></p>
<p><strong>通过上面的对比</strong>，<code>UI</code>尺寸是一样的，因此我们可以推断，它们使用的是同一套<code>UI</code>。</p>
<p><strong>使用同一套UI</strong>是最理想的状态，我们不需要做额外的处理，即可在横竖屏下使用。</p>
<h3 data-id="heading-3">2.横竖屏使用两套UI，一套代码</h3>
<p><strong>还是</strong>先看看录屏：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ceb62d456bd846c4b44856785668e286~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767055165&amp;x-signature=WTQJ%2BfQodkDe10SIL0jCVhDB9R8%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p><strong>首先是</strong>竖屏状态下：</p>
<ul>
<li><strong>卡牌布局</strong>：垂直的<strong>Scrollview</strong>, 限制列数为<strong>3</strong>。</li>
<li><strong>返回按钮</strong>：在左下方。</li>
<li><strong>查询模块</strong>：与返回按钮在同一行。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a76a52fac5714038a8a4321409c924ef~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767055165&amp;x-signature=qHu3Vcb5XgM3NOqjFeaitqLVHz4%3D" alt="" loading="lazy"/></p>
<p><strong>接着是</strong>横屏状态下：</p>
<ul>
<li><strong>卡牌布局</strong>：垂直的<strong>Scrollview</strong>, 限制列数为<strong>6</strong>。</li>
<li><strong>返回按钮</strong>：在右上方。</li>
<li><strong>查询模块</strong>：与功能按钮在同一行。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/28852b3097fb46abb1d09da813daebae~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767055165&amp;x-signature=YldhR0wk6kQs54PzGOk3VV7Qm%2FA%3D" alt="" loading="lazy"/></p>
<p><strong>通过</strong>上述的简单对比，笔者推测是使用了两套不同的<code>UI</code>。当然也可以是同一套，下面会讲到。</p>
<p><strong>如果</strong>使用的是两套<code>UI</code>，我们需要同时维护的东西就比较多了。例如修改布局或者修改功能，我们需要同时处理横竖屏的界面，需要的人力物力就会成倍增加。</p>
<p><strong>但是</strong>通过我们对厂商的判断，这是非常可能的。维护多套<code>UI</code>和代码最主要要解决规范和人员问题，要保证同时修改，互不影响。</p>
<h3 data-id="heading-4">3.横竖屏使用同套UI，代码适配</h3>
<p><strong>依旧是</strong>先看看录屏：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7c67e20c700c4c87bdad50f4c26c7d09~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767055165&amp;x-signature=eszLEfBhGEGxTskbXBCZL%2BnxP5g%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p><strong>竖屏</strong>状态下，活动图标是<strong>2行</strong>。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3fa419b685b04c99a9bf288073eccfe4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767055165&amp;x-signature=ylZ7BrvsMsfrNS9fTRa3w0Sj2Ck%3D" alt="" loading="lazy"/></p>
<p><strong>横屏</strong>状态下，活动图标是<strong>1行</strong>。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b2f3fb123ee14684a2447b92596b3111~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767055165&amp;x-signature=GxoHTCkrT14It408n07tR6XSKAM%3D" alt="" loading="lazy"/></p>
<p><strong>像</strong>这种，<code>UI</code>布局只有一点点不同，我们就可以采用同一套<code>UI</code>，把不同的部分，通过代码根据横竖屏判断，设置不同的参数，进行区分。</p>
<p><strong>综合</strong>上面三种情况，最理想的顺序是先考虑采用同一套<code>UI</code>和代码。其次是同一套<code>UI</code>，代码去适配不同的布局。最后万不得已才采用不同的<code>UI</code>和一套/两套代码。</p>
<h2 data-id="heading-5">2.实战一下</h2>
<p><strong>想要</strong>在<code>Cocos</code>游戏开发中实现横竖屏动态切换,最关键的步骤就是要能知道当前是横屏还是竖屏，以及横竖屏切换的时机。</p>
<p><strong>下面</strong>和笔者一起来实战一下。</p>
<p><strong>引擎版本</strong>：<code>Cocoscreator 3.8.7</code></p>
<p><strong>编程语言</strong>：<code>TypeScript</code></p>
<h3 data-id="heading-6">1.资源准备</h3>
<p><strong>为了</strong>更好的节目效果，我们“借用”(扣)一下资源，仅做学习和交流。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e89b5c6057aa4a1db97ec8b4abaa2c4d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767055165&amp;x-signature=BTxpUUZASo6NzS1ygceaSrFY2bQ%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-7">2.UI准备</h3>
<p><strong>把资源</strong>拼凑成界面，其中如果需要两套<code>UI</code>的，分别用<code>_V</code>和<code>_H</code>来区分竖屏和横屏的界面。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/04efbc36742b4d15a354d3cfd9fa8e99~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767055165&amp;x-signature=TGkADR8QpcI3p%2Fn2J2NfvWC47bI%3D" alt="" loading="lazy"/></p>
<p><strong>例如</strong>竖屏界面长这样，<code>1秒</code>完成拼UI。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3c06268ca00c4a8db7c31ec95c2aaa4e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767055165&amp;x-signature=FoOfVDUOVLk%2BlJM1rBYUOHuPvD8%3D" alt="" loading="lazy"/></p>
<p><strong>横屏</strong>界面长这样，节目效果，实际上没有一张图片就能完成界面这么轻松。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2621b7ae64e842078c91b62ebb805f6a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767055165&amp;x-signature=INS%2BbJjAeTCMD%2Bkabe38%2BPoxrE4%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-8">3.核心代码实现</h3>
<p><strong>由于</strong>文章篇幅较长，本次实战只列出核心代码。</p>
<ul>
<li><strong>监听屏幕方向变化</strong>：通过<code>screen</code>的<code>orientation-change</code>事件进行监听。
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d66ca3f1b4ec46bbb96605487674c794~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767055165&amp;x-signature=GBMshsKYWlGzQoCSUN%2FyhF2Ahbs%3D" alt="" loading="lazy"/></li>
<li><strong>修改设计分辨率</strong>：当屏幕发生变化时，我们可以通过<code>view</code>的<code>setDesignResolutionSize</code>方法进行设置。
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fcf0cb83d66d487eb5df6693d0f3fffe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767055165&amp;x-signature=zgrkbqN8p%2BYiRRKLUWy7LTg%2FKqI%3D" alt="" loading="lazy"/></li>
<li><strong>UI配置</strong>：通过配置界面的名字、竖屏的界面、横屏的界面、层级和管理组件。
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/89a80768e00849da96f926d337694e05~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767055165&amp;x-signature=aGLQ4EmIQb3sUpQ3mijc67P%2FTVU%3D" alt="" loading="lazy"/></li>
<li><strong>显示UI</strong>：通过横竖屏获取预制体、动态加载预制体、自动添加管理组件。
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9882d65b1f4c4103b4e2e954c02f1ef3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767055165&amp;x-signature=7rLeZCjuhDLJDVSv9ir0qNaV78U%3D" alt="" loading="lazy"/></li>
<li><strong>同套UI切换</strong>：通过基类的<code>onOrientationChange</code>方法通知管理组件。
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8eb4036026fe4e049258762342c2ffdb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767055165&amp;x-signature=JCDs1SxMMjQWuj2YjakYF0vCfgM%3D" alt="" loading="lazy"/></li>
<li><strong>不同UI切换</strong>：删除旧的、添加新的、恢复层级。
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/91a19645af8a4bd2b3c7415f9286f5e2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767055165&amp;x-signature=wHmF%2FNPJYwWxlPPJKF7UGgFZPrQ%3D" alt="" loading="lazy"/></li>
<li><strong>同UI代码适配</strong>：通过<code>onOrientationChange</code>时间调整布局。
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a05026f88ddb4cdfab60e320a1bcd27f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767055165&amp;x-signature=OwEdZEuwJOQ%2BOPi8VaAxdiNBTyw%3D" alt="" loading="lazy"/></li>
</ul>
<h3 data-id="heading-9">4.效果演示</h3>
<p><strong>模拟器</strong>：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3e565475ea4c4030a937495060bd0835~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767055165&amp;x-signature=Myi%2Bdx4dN5i8fnDiLH9P%2Fo9fS4Q%3D" alt="" loading="lazy"/></p>
<p><strong>手机</strong>：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e7902f3e7f724044ac1bdbae4a6cb08c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767055165&amp;x-signature=DEDEI%2FW3uOf9DYWUp%2F1RkTscLus%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h2 data-id="heading-10">结语</h2>
<p>**以上就是Cocos游戏开发中实现横竖屏动态切换的全部内容。**比起技术，横竖屏切换更考验的应该是<code>UI</code>的设计。</p>
<p><strong>小伙伴们觉得我猜对了吗？</strong></p>
<p><strong>我是"亿元程序员"，一位有着8年游戏行业经验的主程。在游戏开发中，希望能给到您帮助, 也希望通过您能帮助到大家。</strong></p>
<p>AD:笔者线上的小游戏《打螺丝闯关》《贪吃蛇掌机经典》《重力迷宫球》《填色之旅》《方块掌机经典》大家可以自行点击搜索体验。</p>
<p>实不相瞒，想要个<strong>赞</strong>和<strong>爱心</strong>！请把该文章<strong>分享</strong>给你觉得有需要的其他小伙伴。谢谢！</p>
<p>推荐文章：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FXLCknL3fJDubec2GW6KLFA" target="_blank" title="https://mp.weixin.qq.com/s/XLCknL3fJDubec2GW6KLFA" ref="nofollow noopener noreferrer">Cocos游戏如何接入安卓穿山甲广告变现？</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F3_VrSld4KnDKY_7hxjSoKg" target="_blank" title="https://mp.weixin.qq.com/s/3_VrSld4KnDKY_7hxjSoKg" ref="nofollow noopener noreferrer">你知道和不知道的微信小游戏常用API整理，赶紧收藏用起来~</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F0Lj24VHJ-pL8z82hHqQLiA" target="_blank" title="https://mp.weixin.qq.com/s/0Lj24VHJ-pL8z82hHqQLiA" ref="nofollow noopener noreferrer">Cocos游戏如何快速接入抖音小游戏广告变现？</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FZ7DusUJA2v1IFZDFtBsueg" target="_blank" title="https://mp.weixin.qq.com/s/Z7DusUJA2v1IFZDFtBsueg" ref="nofollow noopener noreferrer">如何在CocosCreator3.8中实现割绳子游戏效果</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F3BzzFBzeVAO-a6LPTeFTrA" target="_blank" title="https://mp.weixin.qq.com/s/3BzzFBzeVAO-a6LPTeFTrA" ref="nofollow noopener noreferrer">如何在CocosCreator3.8中实现动态切割模型？</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[自由职业者 2025 年终总结：转型 AI 全栈]]></title>    <link>https://juejin.cn/post/7586555198115266566</link>    <guid>https://juejin.cn/post/7586555198115266566</guid>    <pubDate>2025-12-23T00:41:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586555198115266566" data-draft-id="7582156410320289802" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="自由职业者 2025 年终总结：转型 AI 全栈"/> <meta itemprop="keywords" content="面试,全栈,AI编程"/> <meta itemprop="datePublished" content="2025-12-23T00:41:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="前端双越老师"/> <meta itemprop="url" content="https://juejin.cn/user/1714893868765373"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            自由职业者 2025 年终总结：转型 AI 全栈
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1714893868765373/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    前端双越老师
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T00:41:05.000Z" title="Tue Dec 23 2025 00:41:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是双越。前百度 滴滴 资深前端工程师，慕课网金牌讲师，PMP。我的代表作有：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.wangeditor.com%2F" target="_blank" title="https://www.wangeditor.com/" ref="nofollow noopener noreferrer">wangEditor</a> 开源 web 富文本编辑器，GitHub 18k star，npm 周下载量 20k</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.huashuiai.com%2F" target="_blank" title="https://www.huashuiai.com/" ref="nofollow noopener noreferrer">划水AI</a> Node 全栈 AIGC 知识库，包括 AI 写作、多人协同编辑。复杂业务，真实上线。</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.mianshipai.com%2F" target="_blank" title="https://www.mianshipai.com/" ref="nofollow noopener noreferrer">前端面试派</a> 系统专业的面试导航，刷题，写简历，看面试技巧，内推工作。开源免费。</li>
</ul>
<blockquote>
<p>我在正在开发一个 AI Agent 智能体项目【<a href="https://link.juejin.cn?target=https%3A%2F%2Fzhitalk.chat%2F" target="_blank" title="https://zhitalk.chat/" ref="nofollow noopener noreferrer">智语</a>】一个智能面试官，可以优化简历、模拟面试、解答题目等。<strong>即将内测</strong>，有兴趣的同学可以围观、学习。</p>
</blockquote>
<h2 data-id="heading-0">开始</h2>
<p>最近这段时间一直忙于 AI Agent 【智语】项目的开发和 wiki，好久没有更新博客了，正好项目即将有一个阶段性的成果了，即将内测。</p>
<p>也正好年底了，按惯例要写一个年终总结，看看今年自己都干了点啥，有啥成长，有啥不足，有啥想法，明年有什么计划。</p>
<p>PS. 感觉今年过的最快，一晃一年了，感觉春天夏天做的一些工作就像前几天做的似的。这种感觉是好是坏呢？</p>
<h2 data-id="heading-1">主题</h2>
<p>2025 年最重要的一个主题就是：<strong>AI 带来的变化和转型</strong>。</p>
<p>这不仅仅针对我，对于整个行业都是这样的。眼看着 AI 编程工具普及，眼看着各个大模型发布，眼看着国内外人人都在讨论 AI ... AI 至少在编程领域，无处不在。</p>
<p>第二个主题依然是：招聘市场冷淡。尤其是现在这个冬天，看不到任何活跃的迹象。希望明年春天能再好一点，但是按前两年的情况来看，也好不到哪里去。</p>
<p>整个软件互联网行业，除了 AI 开发，其他没有任何增长，甚至是都在倒退。</p>
<p>基于这个现状，我个人已经从之前的前端开发，转型为 全栈 和 AI 开发。从 2024 年初开始的。</p>
<p>我也建议所有的开发人员，无论你现在转还是不转，都要看到这个转型的可能，主动去思考一下未来的趋势和发展，居安思危，才不至于以后被动。</p>
<h2 data-id="heading-2">工作内容</h2>
<p>自由职业这几年，我一直坚持一个好习惯：写日报、周报和月报，随时记录工作内容，梳理工作计划。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dfd0e4b88dcf49698c185dcf9e013c25~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5Y-M6LaK6ICB5biI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767055265&amp;x-signature=sWvLmL3fFwHO4P8iwPzClQj5fr0%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-3">面试咨询</h3>
<p>今年 1v1 面试咨询人数并不多，平均每周 1-2 个人吧，最近冬天淡季就很少了。但这足以让我接触到各种找工作和面试的群体，及时了解外面的情况。</p>
<p>整体的感觉就是，招聘市场还是比较冷淡。除了几个大厂、名校毕业的，其他人没有几个能特别顺利的找到合适的工作。大部分人能找到工作，但薪资可能不会完全符合预期，真实有些人只能找个外包先干着了。</p>
<p>所以，我在面试咨询的时候，如果遇到现在裸辞、或被裁员无工作的同学，我都会劝他们尽快找一个工作，先工作了再说，尤其是秋天、冬天这个时节，不要拖到元旦或者春节，否则这种失业状态会非常影响心理。</p>
<p>还有就是面试时考八股文的概率低了很多，会更加注重项目、设计和场景问题，即更注重实践能力。</p>
<p>“被裁员”现在已经不是一个贬义词了，只是一个中性词，所以面试时在说离职原因的时候，可以理直气壮的说被裁员，没毛病。</p>
<p>绝大部分同学还是无法流畅的介绍项目，更别说项目难点和亮点。自己做过的项目，自己最熟悉的项目，却无法用语言表达出来让别人听懂，这是程序员的通病。面试之前一定要注意刻意练习。</p>
<p>还有相当一部分同学，工作很多年了，依然是 Vue 工程师，其他的啥也不会，技术广度太差了。</p>
<p>在 AI 编程持续普及的情况下，未来可能就不会分什么前端、后端技术栈了，在 AI 加持下，未来大家都是“通用程序员”，啥代码都会写。技术广度是一个很重要的话题。</p>
<h3 data-id="heading-4">全栈开发</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.huashuiai.com%2F" target="_blank" title="https://www.huashuiai.com/" ref="nofollow noopener noreferrer">划水AI</a> 之前是在亚马逊 AWS 服务器上的，最早域名也没有备案。今年春天把域名备案了，把服务器迁移到了国内，访问速度瞬间快了好几倍。</p>
<p>还增加了 Sentry 的错误统计和性能统计，发现了好几个线上的 bug ，频繁出现的都解决了，并记录在 wiki 。</p>
<p>当时还有一个特别烦人的问题，使用邮件登录的时候总是报错，就是使用 gmail 邮件服务不稳定，国内的邮箱服务也是一堆问题。最后经过调研使用 resend 第三方服务发邮件，至今很稳定。</p>
<p>另外，还把 AI 写作的面板放在了右侧，这样的左、中、右结构，也比较合理。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4c27407bec934549ac2fdd0ba65dd97d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5Y-M6LaK6ICB5biI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767055265&amp;x-signature=Ha42rWNZBqPBmHqE0raa9dIjWhs%3D" alt="image.png" loading="lazy"/></p>
<p>今年所有的 1v1 咨询都是在 划水AI 写的文档，使用多人编辑功能，一边在线聊天，一边记录，效果非常好。</p>
<p>现在网站服务运行在阿里云 FC 函数计算，协同编辑的 websocket 服务运行在阿里云 ECS 云服务器，一直非常稳定。</p>
<p>但是最近也出现了新的问题</p>
<ul>
<li>阿里云 FC 价格调整，导致我现在的费用比之前增加不少</li>
<li>现在使用 supabse 的 postgres 服务器，国外的，连接也不是很稳定，经常出现服务报警</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9779029c7e0947cd9f8399fe6b145c31~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5Y-M6LaK6ICB5biI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767055265&amp;x-signature=CpQjkauAQrQ%2BfCJz4y33RIO35do%3D" alt="image.png" loading="lazy"/></p>
<p>总之一句话：<strong>真实上线的项目、生产环境下，情况要复杂很多，经历了才能知道，这也是真正的项目经验。这不是本地开发几个 demo 纸上谈兵 能比的。</strong></p>
<p>最近忙 AI Agent 项目开发，我还一直没管它。等明年继续搞</p>
<ul>
<li>想办法解决这些不稳定的问题，如数据库连接问题</li>
<li>继续增加新功能、优化或重构当前的功能</li>
</ul>
<p>划水AI 是我的名片项目，要持续做好。</p>
<h3 data-id="heading-5">AI Agent</h3>
<p>这是我今年夏天想出来的一个主题：AI 开发很火爆，而且一定是未来趋势，何不自己搞一个？</p>
<p>于是我就启动了 AI Agent <a href="https://link.juejin.cn?target=https%3A%2F%2Fzhitalk.chat%2F" target="_blank" title="https://zhitalk.chat/" ref="nofollow noopener noreferrer">智语</a> 项目：一个 AI 智能面试官，可以优化简历、模拟面试。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/72c187526a134f7b9fdd0916e1127e7d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5Y-M6LaK6ICB5biI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767055265&amp;x-signature=mcydv0l7%2BZqSTKGZINa170Yyu%2Fk%3D" alt="image.png" loading="lazy"/></p>
<p>AI 开发是一个新事物，目前还没有一套完全成熟的、普及大众的开发框架和流程。最好的可能是 langChain 和 langGraph ，但它自己也还在完善和进化中。</p>
<p>为此我做了大量的调研和准备，把关于 AI 开发相关的常见技术都看了一遍：LLM，提示词工程，Reasoning，LangChain，ReAct Agent，RAG，Vector 向量，tool， function-call ，MCP sever 等等。</p>
<p>即便是这样，在真实开发的时候还是被卡住了一次，后来切换了一套技术方案才规避了这个问题。</p>
<p>所以，看多少资料，做多少 demo 都不如从 0 做一个项目，并且真实发布上线，来的实在。</p>
<p>你看文档写 demo 好好的，一做项目可能就不行了。你做项目本地运行好好的，一发布上线就不行了 —— 这太正常了。</p>
<p>未来项目内测、公测、上线，到时候再和大家分享。</p>
<p>和【划水AI】一样，这个【智语】项目也会作为我在 AI 开发领域的名片项目，我也会持续做好。</p>
<h2 data-id="heading-6">明年计划</h2>
<p>文章开头讲到，现在除了 AI 没有任何增长，而且招聘市场整体冷淡。基于这样的大环境，和大家的需求，我明年暂不打算启动新项目。</p>
<p>这其实正是一个好机会，利用这个时机，把现有的两个项目、和面试咨询做好做精，沉淀自己，修炼内功。</p>
<p>有同学可能问：你忙得过来吗？</p>
<p>如果两个项目同时从 0 开发，那有点忙不过来。但明年是同时维护，还是忙得过来的，毕竟我全职做，时间有的是。</p>
<p>2026 年，不说加油，大家能稳稳的度过就好～</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[鸿蒙开发：一个底部的曲线导航]]></title>    <link>https://juejin.cn/post/7586500093844684842</link>    <guid>https://juejin.cn/post/7586500093844684842</guid>    <pubDate>2025-12-23T00:55:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586500093844684842" data-draft-id="7586491717874237459" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="鸿蒙开发：一个底部的曲线导航"/> <meta itemprop="keywords" content="HarmonyOS,Android,iOS"/> <meta itemprop="datePublished" content="2025-12-23T00:55:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员一鸣"/> <meta itemprop="url" content="https://juejin.cn/user/1398234520239095"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            鸿蒙开发：一个底部的曲线导航
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1398234520239095/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员一鸣
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T00:55:23.000Z" title="Tue Dec 23 2025 00:55:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,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) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,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) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><h2 data-id="heading-0">前言</h2>
<p>似乎现在的应用，底部导航都是千篇一律，基本上都是几个按钮，点击之后，切换切换图标，更改更改颜色，稍微好点的会增加动画效果，今天，给大家推荐一款，底部的曲线导航，它可以让底部导航的实现方式别具一格。</p>
<p>我们先看下静态效果：</p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f041a5ca9d4c45a881971553d33c89cd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5LiA6bij:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767056123&amp;x-signature=9suh0nqVyaIrkNUlpb4HGhvtOIE%3D" alt="" width="50%" loading="lazy"/></p>
<p>动态效果如下：</p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9073068a2d4442ce8611c7bcb4925e6a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5LiA6bij:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767056123&amp;x-signature=pso7Bbd5T1QpDUHMz4CJ%2Fw%2BZbHw%3D" alt="" width="50%" loading="lazy"/></p>
<p>目前第一个版本，完成了基本的曲线形式效果，还未追加曲线的移动动画，在下一个版本会加上，那么针对这样的一个曲线形式导航，它是如何来实现的呢？答案很简单，就是使用简单的Path路径绘制。</p>
<p>Path路径，有两种方式实现，一种是系统提供的Path组件，另一种就是使用new drawing.Path()，然后使用canvas来绘制，两种方式都可以实现，看大家的技术选型，这里我使用的是Path组件，因为只需要设置符合SVG路径描述规范的命令字符串即可实现。</p>
<h2 data-id="heading-1">SVG路径介绍</h2>
<p>SVG路径是SVG（可缩放矢量图形）中用于创建复杂形状的核心元素，通过数学描述定义图形轮廓，支持直线、曲线、弧线等多种图形绘制。‌</p>
<p>例如，绘制一个三角形，直接在属性commands传递SVG路径即可，代码如下：</p>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-title class_">Path</span>()
        .<span class="hljs-title function_">width</span>(<span class="hljs-string">'210px'</span>)
        .<span class="hljs-title function_">height</span>(<span class="hljs-string">'310px'</span>)
        .<span class="hljs-title function_">commands</span>(<span class="hljs-string">'M100 0 L200 240 L0 240 Z'</span>)
        .<span class="hljs-title function_">fillOpacity</span>(<span class="hljs-number">0</span>)
        .<span class="hljs-title function_">stroke</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">Black</span>)
        .<span class="hljs-title function_">strokeWidth</span>(<span class="hljs-number">3</span>)
</code></pre>
<p>相对来说还是比较的简单，下面就针对SVG中的绘制命令，简单的罗列一下：</p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/80e8acfb872f474e95bd047f8b3d2bef~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5LiA6bij:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767056123&amp;x-signature=1%2FCDeBxyVgsk%2BOet1aGSYFhgZ4Q%3D" alt="" width="50%" loading="lazy"/></p>
<h2 data-id="heading-2">曲线绘制</h2>
<p>由于需要点击时，让本按钮进行曲线展示，有两个方面需要考虑，一是曲线的位置，点击不同位置的按钮，曲线就会移动到指定位置，二是曲线连接之处，保持平滑过渡，使用三次贝塞尔曲线段完成。</p>
<p>完整的绘制曲线代码如下，大家可以作为参考，averageWidth为每个tab按钮的宽度，navigationSize为导航数量。</p>
<pre><code class="hljs language-TypeScript" lang="TypeScript"> <span class="hljs-comment">// 绘制曲线的函数</span>
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">drawCurve</span>(<span class="hljs-params">position: <span class="hljs-built_in">number</span></span>) {
    <span class="hljs-comment">// 初始点：0,100</span>
    <span class="hljs-keyword">let</span> tagPosition = <span class="hljs-number">0</span>
    <span class="hljs-keyword">let</span> d = <span class="hljs-string">'M 0 '</span> + tagPosition;

    <span class="hljs-comment">// 计算曲线的起始和结束位置</span>
    <span class="hljs-keyword">const</span> curveStart = (position - <span class="hljs-number">1</span>) * <span class="hljs-variable language_">this</span>.<span class="hljs-property">averageWidth</span>;
    <span class="hljs-keyword">const</span> curveEnd = position * <span class="hljs-variable language_">this</span>.<span class="hljs-property">averageWidth</span>;

    <span class="hljs-comment">// 0到曲线起始位置的直线部分</span>
    <span class="hljs-keyword">if</span> (curveStart &gt; <span class="hljs-number">0</span>) {
      d += <span class="hljs-string">' L '</span> + curveStart + <span class="hljs-string">' '</span> + tagPosition;
    }

    <span class="hljs-comment">// 曲线部分：使用两个三次贝塞尔曲线段确保平滑连接</span>
    <span class="hljs-keyword">const</span> midPoint = (curveStart + curveEnd) / <span class="hljs-number">2</span>;
    <span class="hljs-keyword">const</span> controlPoint1X = curveStart + (<span class="hljs-variable language_">this</span>.<span class="hljs-property">averageWidth</span> / <span class="hljs-variable language_">this</span>.<span class="hljs-property">navigationSize</span>);
    <span class="hljs-keyword">const</span> controlPoint2X = curveEnd - (<span class="hljs-variable language_">this</span>.<span class="hljs-property">averageWidth</span> / <span class="hljs-variable language_">this</span>.<span class="hljs-property">navigationSize</span>);

    d += <span class="hljs-string">' C '</span> + controlPoint1X + <span class="hljs-string">' '</span> + tagPosition + <span class="hljs-string">' '</span> + controlPoint1X + <span class="hljs-string">' '</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">_privateCurveBottom</span> + <span class="hljs-string">' '</span> +
      midPoint +
      <span class="hljs-string">' '</span> +
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_privateCurveBottom</span>;
    d += <span class="hljs-string">' C '</span> + controlPoint2X + <span class="hljs-string">' '</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">_privateCurveBottom</span> + <span class="hljs-string">' '</span> + controlPoint2X + <span class="hljs-string">' '</span> + tagPosition + <span class="hljs-string">' '</span> +
      curveEnd +
      <span class="hljs-string">' '</span> + tagPosition;

    <span class="hljs-comment">// 曲线结束位置到最大宽度的直线部分</span>
    <span class="hljs-keyword">if</span> (curveEnd &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">_privateMaxWidth</span>) {
      d += <span class="hljs-string">' L '</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">_privateMaxWidth</span> + <span class="hljs-string">' '</span> + tagPosition;
    }

    <span class="hljs-comment">// 新增闭合路径逻辑</span>
    d += <span class="hljs-string">` V <span class="hljs-subst">${<span class="hljs-variable language_">this</span>._privateCurveBottom}</span>`</span>; <span class="hljs-comment">// 垂直延伸到底部</span>
    d += <span class="hljs-string">' H 0'</span>; <span class="hljs-comment">// 水平返回起点</span>
    d += <span class="hljs-string">' Z'</span>;

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_privatePathCommands</span> = d

  }
</code></pre>
<h2 data-id="heading-3">快速使用</h2>
<p>如果你不想自己实现，而是想快速的使用，这个已经为大家考虑到了，目前已经上传到到了中心仓库，有需要的同学，可以前去体验。</p>
<p>中心仓库地址：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fohpm.openharmony.cn%2F%23%2Fcn%2Fdetail%2F%40abner%252Fcurve_navigation" target="_blank" title="https://ohpm.openharmony.cn/#/cn/detail/@abner%2Fcurve_navigation" ref="nofollow noopener noreferrer">ohpm.openharmony.cn/#/cn/detail…</a></p>
<h3 data-id="heading-4">依赖方式</h3>
<h4 data-id="heading-5">1、远程依赖</h4>
<p>方式一：在Terminal窗口中，执行如下命令安装三方包，DevEco Studio会自动在工程的oh-package.json5中自动添加三方包依赖。</p>
<p><strong>建议：在使用的模块路径下进行执行命令。</strong></p>
<pre><code class="hljs language-TypeScript" lang="TypeScript">ohpm install <span class="hljs-meta">@abner</span>/curve_navigation
</code></pre>
<p>方式二：在模块的oh-package.json5中设置三方包依赖，配置示例如下：</p>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-string">"dependencies"</span>: { <span class="hljs-string">"@abner/curve_navigation"</span>: <span class="hljs-string">"^1.0.1"</span>}
</code></pre>
<h3 data-id="heading-6">代码使用</h3>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-title class_">CurveNavigation</span>({
  <span class="hljs-attr">navigationSize</span>: <span class="hljs-number">5</span>, <span class="hljs-comment">//tab数量</span>
  <span class="hljs-attr">navigationPaddingBottom</span>: <span class="hljs-title class_">WindowUtils</span>.<span class="hljs-property">windowBottomNavHeight</span>,<span class="hljs-comment">//距离底部距离</span>
  <span class="hljs-attr">onPageChange</span>: <span class="hljs-function">(<span class="hljs-params">position: <span class="hljs-built_in">number</span></span>) =&gt;</span> {
    <span class="hljs-comment">//page改变</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">selectIndex</span> = position
  },
  <span class="hljs-attr">tabView</span>: <span class="hljs-function">(<span class="hljs-params">position: <span class="hljs-built_in">number</span></span>) =&gt;</span> {
    <span class="hljs-comment">//导航视图</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">tabView</span>(position)
  },
  <span class="hljs-attr">pageView</span>: <span class="hljs-function">(<span class="hljs-params">position: <span class="hljs-built_in">number</span></span>) =&gt;</span> {
    <span class="hljs-comment">//页面视图</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">pageView</span>(position)
  }
})
</code></pre>
<h3 data-id="heading-7">完整案例</h3>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-meta">@Entry</span>
<span class="hljs-meta">@Component</span>
struct <span class="hljs-title class_">Index</span> {
  <span class="hljs-keyword">private</span> <span class="hljs-attr">tempColorArray</span>: <span class="hljs-title class_">ResourceColor</span>[] = [<span class="hljs-string">"#ffcc80"</span>, <span class="hljs-string">"#ff9323ac"</span>, <span class="hljs-string">"#ff26a965"</span>, <span class="hljs-string">"#ff93d923"</span>, <span class="hljs-string">"#ff11c5de"</span>,]
  <span class="hljs-meta">@State</span> <span class="hljs-attr">selectIndex</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>
  <span class="hljs-keyword">private</span> <span class="hljs-attr">tabArray</span>: <span class="hljs-title class_">Resource</span>[] =
    [$r(<span class="hljs-string">'sys.symbol.house_fill'</span>), $r(<span class="hljs-string">'sys.symbol.square_fill_grid_2x2'</span>), $r(<span class="hljs-string">'sys.symbol.bell_fill'</span>),
      $r(<span class="hljs-string">'sys.symbol.externaldrive_fill'</span>), $r(<span class="hljs-string">'sys.symbol.person_2_fill'</span>)]

  <span class="hljs-meta">@Builder</span>
  <span class="hljs-title function_">tabView</span>(<span class="hljs-params">position: <span class="hljs-built_in">number</span></span>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">selectIndex</span> == position) {
      <span class="hljs-title class_">Column</span>() {
        <span class="hljs-title class_">SymbolGlyph</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">tabArray</span>[position])
          .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">20</span>)
          .<span class="hljs-title function_">renderingStrategy</span>(<span class="hljs-title class_">SymbolRenderingStrategy</span>.<span class="hljs-property">SINGLE</span>)
          .<span class="hljs-title function_">fontColor</span>([<span class="hljs-title class_">Color</span>.<span class="hljs-property">Black</span>])
      }
      .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">White</span>)
      .<span class="hljs-title function_">width</span>(<span class="hljs-number">35</span>)
      .<span class="hljs-title function_">height</span>(<span class="hljs-number">35</span>)
      .<span class="hljs-title function_">borderRadius</span>(<span class="hljs-number">35</span>)
      .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-title class_">FlexAlign</span>.<span class="hljs-property">Center</span>)
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-title class_">SymbolGlyph</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">tabArray</span>[position])
        .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">20</span>)
        .<span class="hljs-title function_">renderingStrategy</span>(<span class="hljs-title class_">SymbolRenderingStrategy</span>.<span class="hljs-property">SINGLE</span>)
        .<span class="hljs-title function_">fontColor</span>([<span class="hljs-title class_">Color</span>.<span class="hljs-property">Gray</span>])
    }

  }

  <span class="hljs-meta">@Builder</span>
  <span class="hljs-title function_">pageView</span>(<span class="hljs-params">position: <span class="hljs-built_in">number</span></span>) {
    <span class="hljs-title class_">Column</span>() {
      <span class="hljs-title class_">Text</span>(position.<span class="hljs-title function_">toString</span>())
    }.<span class="hljs-title function_">width</span>(<span class="hljs-string">"100%"</span>)
    .<span class="hljs-title function_">height</span>(<span class="hljs-string">"100%"</span>)
    .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-title class_">FlexAlign</span>.<span class="hljs-property">Center</span>)
    .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">tempColorArray</span>[position])
  }

  <span class="hljs-title function_">build</span>(<span class="hljs-params"/>) {
    <span class="hljs-title class_">RelativeContainer</span>() {
      <span class="hljs-title class_">CurveNavigation</span>({
        <span class="hljs-attr">navigationSize</span>: <span class="hljs-number">5</span>, <span class="hljs-comment">//tab数量</span>
        <span class="hljs-attr">navigationPaddingBottom</span>: <span class="hljs-title class_">WindowUtils</span>.<span class="hljs-property">windowBottomNavHeight</span>,
        <span class="hljs-attr">onPageChange</span>: <span class="hljs-function">(<span class="hljs-params">position: <span class="hljs-built_in">number</span></span>) =&gt;</span> {
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">selectIndex</span> = position
        },
        <span class="hljs-attr">tabView</span>: <span class="hljs-function">(<span class="hljs-params">position: <span class="hljs-built_in">number</span></span>) =&gt;</span> {
          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">tabView</span>(position)
        },
        <span class="hljs-attr">pageView</span>: <span class="hljs-function">(<span class="hljs-params">position: <span class="hljs-built_in">number</span></span>) =&gt;</span> {
          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">pageView</span>(position)
        }
      })
    }
    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)
    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)
  }
}
</code></pre>
<h4 data-id="heading-8">属性介绍</h4>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0b2c5ded8c4647e0a9ef6626693bb82c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5LiA6bij:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767056123&amp;x-signature=YyLI5MEVxt%2FqlxkIPnUgDV5roQ8%3D" alt="" width="70%" loading="lazy"/></p>
<h2 data-id="heading-9">相关总结</h2>
<p>目前唯一的遗憾是，没有实现曲线在切换时的动画偏移，而是直接的切换，后续会针对这块再单独的处理，大家可以先进行使用。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[数据传参明妙理 临危受命逢转机]]></title>    <link>https://juejin.cn/post/7586531677720723491</link>    <guid>https://juejin.cn/post/7586531677720723491</guid>    <pubDate>2025-12-23T00:57:57.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586531677720723491" data-draft-id="7584909732612554787" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="数据传参明妙理 临危受命逢转机"/> <meta itemprop="keywords" content="Kotlin,Android"/> <meta itemprop="datePublished" content="2025-12-23T00:57:57.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="RockByte"/> <meta itemprop="url" content="https://juejin.cn/user/1046390797768519"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            数据传参明妙理 临危受命逢转机
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1046390797768519/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    RockByte
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T00:57:57.000Z" title="Tue Dec 23 2025 00:57:57 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:2;font-weight:400;font-size:15px;overflow-x:hidden;color:#333;letter-spacing:1.2px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1:first-child,.markdown-body h2:first-child,.markdown-body h3:first-child,.markdown-body h4:first-child,.markdown-body h5:first-child,.markdown-body h6:first-child{margin-top:-1.5rem;margin-bottom:1rem}.markdown-body h1:before,.markdown-body h2:before,.markdown-body h3:before,.markdown-body h4:before,.markdown-body h5:before,.markdown-body h6:before{content:"#";display:inline-block;color:#3eaf7c;padding-right:.23em}.markdown-body h1{position:relative;font-size:2.5rem;margin-bottom:5px}.markdown-body h1:before{font-size:2.5rem}.markdown-body h2{padding-bottom:.5rem;font-size:2.2rem;border-bottom:1px solid #ececec}.markdown-body h3{font-size:1.5rem;padding-bottom:0}.markdown-body h4{font-size:1.25rem}.markdown-body h5{font-size:1rem}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body strong{color:#3eaf7c}.markdown-body img{max-width:100%;border-radius:2px;display:block;margin:auto}.markdown-body hr{border:none;border-top:1px solid #3eaf7c;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;overflow-x:auto;padding:.2rem .5rem;margin:0;color:#3eaf7c;font-size:.85em;background-color:rgba(27,31,35,.05);border-radius:3px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border:.5rem solid #3eaf7c}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{font-weight:500;text-decoration:none;color:#3eaf7c;margin:0 5px}.markdown-body a:active,.markdown-body a:hover{text-decoration:none;border-bottom:1.5px solid #3eaf7c}.markdown-body a[href^=http]:after{content:url("data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTQiIGhlaWdodD0iMTQiPjxkZWZzPjxzdHlsZS8+PC9kZWZzPjxwYXRoIGQ9Ik04MzIgMTI4SDY0MHY2NGgxNDYuNzUyTDUyMS4zNzYgNDU3LjM3Nmw0NS4yNDggNDUuMjQ4TDgzMiAyMzcuMjQ4VjM4NGg2NFYxMjh6IiBmaWxsPSIjM2VhZjdjIi8+PHBhdGggZD0iTTc2OCA4MzJIMTkyVjI1NmgzNTJ2LTY0SDE2MGEzMiAzMiAwIDAwLTMyIDMydjY0MGEzMiAzMiAwIDAwMzIgMzJoNjQwYTMyIDMyIDAgMDAzMi0zMlY0ODBoLTY0djM1MnoiIGZpbGw9IiMzZWFmN2MiLz48L3N2Zz4=");margin-left:2px}.markdown-body a[href^="#"]:before{content:"#"}.markdown-body table{display:inline-block!important;font-size:13px;width:auto;max-width:100%;overflow:auto;border:1px solid #3eaf7c;border-collapse:collapse}.markdown-body thead{background:#3eaf7c;color:#fff;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(153,255,188,.1)}.markdown-body td,.markdown-body th{padding:4px 8px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#7b7878;padding:1px 23px;border-left:.5rem solid;border-color:#42b983;background-color:rgba(66,184,131,.1);position:relative;margin:14px 8px 0}.markdown-body blockquote:before{display:inline-block;position:absolute;content:url("data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjUiIGhlaWdodD0iMjUiIHZpZXdCb3g9IjAgMCAyNyAyNyIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSgxLjg2MiAxLjg2MikiIGZpbGwtcnVsZT0ibm9uemVybyIgZmlsbD0ibm9uZSI+PGNpcmNsZSBzdHJva2U9IiNGRkYiIHN0cm9rZS13aWR0aD0iMS43MjQiIGZpbGw9IiM0MkI5ODMiIGN4PSIxMS42MzgiIGN5PSIxMS42MzgiIHI9IjExLjYzOCIvPjxwYXRoIGQ9Ik0xNC45NzggNi4yN0E1LjAwNiA1LjAwNiAwIDAwNi42NyA5LjQ2OGE0LjkwMSA0LjkwMSAwIDAwMS43NzMgNC4zNjJjLjMyMy4yNTguNTE0LjY0Ny41MjIgMS4wNnYxLjA2YTIuNjg1IDIuNjg1IDAgMDA1LjM3IDB2LTEuMDA4Yy4wMDItLjM5OC4xNzMtLjc3Ny40Ny0xLjA0MmE1LjAyMyA1LjAyMyAwIDAwLjE3My03LjYzem0tMy4zMzcgMTAuOTY3YTEuMzA0IDEuMzA0IDAgMDEtMS4yODYtMS4yODd2LS4yNzhoMi41NzJ2LjI2MWMwIC43MTMtLjU3MyAxLjI5NC0xLjI4NiAxLjMwNHptMi4yNi00LjQxNWMtLjQ0LjM4My0uNzUuODkzLS44ODcgMS40NmgtMi43NDZhMi44NjggMi44NjggMCAwMC0uOTM4LTEuNTNoLS4wMThhMy40NzYgMy40NzYgMCAwMS0xLjI2OS0zLjE0NSAzLjYxNSAzLjYxNSAwIDAxNy4xOTYuNCAzLjY1IDMuNjUgMCAwMS0xLjMzOCAyLjgxNXoiIGZpbGw9IiNGRkYiLz48L2c+PC9zdmc+");width:25px;height:25px;left:-16px;top:12px}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body details{outline:none;border:none;border-left:4px solid #3eaf7c;padding-left:10px;margin-left:4px}.markdown-body details summary{cursor:pointer;border:none;outline:none;background:#fff;margin:0 -17px}.markdown-body details summary::-webkit-details-marker{color:#3eaf7c}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body ol li::marker{color:#3eaf7c}.markdown-body ul li{list-style:none;padding-left:10px}.markdown-body ul li::marker{content:"•";color:#3eaf7c}.markdown-body ul li.task-list-item:before{content:"";margin-right:0}.markdown-body input[type=checkbox]{vertical-align:text-bottom;box-shadow:inset 0 0 0 10px #fff}.markdown-body input[type=checkbox]:before{content:url("data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTYiIGhlaWdodD0iMTYiPjxkZWZzPjxzdHlsZS8+PC9kZWZzPjxwYXRoIGQ9Ik04NzcuMDU2IDE0Ni45NDR2NzMwLjExMkgxNDYuOTQ0VjE0Ni45NDRoNzMwLjExMnptMC0xMDQuMjc3SDE0Ni45NDRjLTU3LjYyOCAwLTEwNC4yNzcgNDYuNjQ5LTEwNC4yNzcgMTA0LjI3N3Y3MzAuMTEyYzAgNTcuNjI4IDQ2LjY0OSAxMDQuMjc3IDEwNC4yNzcgMTA0LjI3N2g3MzAuMTEyYzU3LjYyOCAwIDEwNC4yNzctNDYuNjQ5IDEwNC4yNzctMTA0LjI3N1YxNDYuOTQ0YzAtNTcuNjI4LTQ2LjY0OS0xMDQuMjc3LTEwNC4yNzctMTA0LjI3N3oiIGZpbGw9IiMzZWFmN2MiLz48L3N2Zz4=");position:relative;top:-2px;right:2px}.markdown-body input[type=checkbox]:checked:before{content:url("data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTUiIGhlaWdodD0iMTUiPjxkZWZzPjxzdHlsZS8+PC9kZWZzPjxwYXRoIGQ9Ik05MTAuMjA4IDBIMTEzLjc2QTExNC4xMTIgMTE0LjExMiAwIDAwLS4wMzIgMTEzLjc5MlY5MTAuMjRjMCA2Mi41OTIgNTEuMiAxMTMuNzkyIDExMy43OTIgMTEzLjc5Mmg3OTYuNDQ4YzYyLjU5MiAwIDExMy43OTItNTEuMiAxMTMuNzkyLTExMy43OTJWMTEzLjc5MkMxMDI0IDUxLjIgOTcyLjggMCA5MTAuMjA4IDB6bS01MTIgNzk2LjQ0OEwxMTMuNzYgNTEybDc5LjY0OC03OS42NDggMjA0LjggMjA0LjhMODMwLjU2IDIwNC44bDc5LjY0OCA3OS42NDgtNTEyIDUxMnoiIGZpbGw9IiMzZWFmN2MiLz48L3N2Zz4=");position:relative;top:-2px;right:2px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="xcode">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fff;color:#000}.xml .hljs-meta{color:silver}.hljs-comment,.hljs-quote{color:#007400}.hljs-attribute,.hljs-keyword,.hljs-literal,.hljs-name,.hljs-selector-tag,.hljs-tag{color:#aa0d91}.hljs-template-variable,.hljs-variable{color:#3f6e74}.hljs-code,.hljs-meta-string,.hljs-string{color:#c41a16}.hljs-link,.hljs-regexp{color:#0e0eff}.hljs-bullet,.hljs-number,.hljs-symbol,.hljs-title{color:#1c00cf}.hljs-meta,.hljs-section{color:#643820}.hljs-built_in,.hljs-builtin-name,.hljs-class .hljs-title,.hljs-params,.hljs-type{color:#5c2699}.hljs-attr{color:#836c28}.hljs-subst{color:#000}.hljs-formula{background-color:#eee;font-style:italic}.hljs-addition{background-color:#baeeba}.hljs-deletion{background-color:#ffc8bd}.hljs-selector-class,.hljs-selector-id{color:#9b703f}.hljs-doctag,.hljs-strong{font-weight:700}.hljs-emphasis{font-style:italic}</style><p><em>本系列为 Android 技术职场题材虚构小说，所有登场人物、公司名称、组织架构及相关情节均为创作所需虚构而来，若有雷同，纯属偶然。书中涉及的技术知识经专业梳理，仅供参考。</em></p>
<h2 data-id="heading-0">六）数据传参明妙理 临危受命逢转机</h2>
<p>第二天一早，培训室里阳光正好，三个实习生却对着林卓昨天布置的项目任务愁眉不展。</p>
<p>这次任务的核心是用Android四大组件串联各功能模块，可实际开发起来，不少技术细节都让他们卡了壳。培训室里静悄悄的，只有鼠标点击和翻笔记的声音。</p>
<p>阿泽卡在了 <code>Activity</code> 跳转功能的拓展需求上，翻文档时偶然看到 <code>Deep link</code> 相关内容，却完全摸不着头绪。</p>
<p>他犹豫了几秒，还是打开公司内部通讯软件“Q书”，在林卓创建的实习生答疑群里发去提问消息。</p>
<p>“林哥，我在做这次任务里的 <code>Activity</code> 跳转功能，想加个外部唤醒的拓展，翻文档时看到了 <code>Deep link</code>，但没搞懂它是怎么实现从外部直接跳转到APP特定页面的呀？”</p>
<p>同一时间，正在工位处理工作的林卓，目光早已不受控制地飘向不远处测试区小安的工位。他的思绪有些飘忽，满是细碎的念头——昨天一整天忙着给实习生讲解，竟没怎么见到小安，桌上Q书弹出的群消息提醒，全然没入他的眼。</p>
<p>此时小安正低头调试设备，阳光落在她的发顶，勾勒出一圈柔和的光晕。</p>
<p>林卓的目光在她身上多停留了几秒，指尖无意识地敲着桌面，连回复消息的动作都慢了半拍。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8c6c712a0f5f4619ae94554689ffdef1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUm9ja0J5dGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767056277&amp;x-signature=JIj5U97d1GgH8Zru9oCa3TxSRHc%3D" alt="1.png" loading="lazy"/></p>
<p>他收回目光，快速在群里回复阿泽，还附上简单的示例代码说明。</p>
<p>“要实现 <code>Deep link</code>，核心是在 <code>AndroidManifest.xml</code> 里给目标<code>Activity</code> 配置 <code>intent-filter</code>，指定对应的协议、域名和路径，就像给页面配了个专属‘外部门牌号’。”</p>
<p>阿泽看到群里的回复后，紧接着追问：“林哥，那测试时咋验证 <code>Deep link</code> 能用啊？”</p>
<p>林卓指尖敲键盘的速度慢了些，语气依旧带着几分心不在焉。</p>
<p>“用 <code>adb</code> 命令模拟就行，文档里有现成的命令模板，把包名和链接替换成自己的。至于多设备兼容，重点测不同Android版本。”</p>
<p>他没像往常一样展开举例，只捡核心要点回复。</p>
<p>阿泽对着消息琢磨片刻，赶紧在笔记本上划了重点。</p>
<p>博文和晓雅也都看到了群里的回复，三人一起讨论着 <code>Deep link</code> 的实现细节，各自对照文档梳理要点。</p>
<p>没过多久，晓雅在群里发起提问。</p>
<p>“林哥，<code>Activity</code> 的 <code>singleTask</code> 和 <code>singleInstance</code> 启动模式，我对着文档看了半天还是分不清，它们不都是只有一个实例吗？”</p>
<p>林卓的语气有几分心不在焉：“核心区别在任务归属：<code>singleTask</code> 是在当前任务里保持单例；<code>singleInstance</code> 会单独占一个任务，该 <code>Activity</code> 所在的任务栈只允许它自己存在，新启动的其他 <code>Activity</code> 会被放入其他任务栈。”</p>
<p>而博文，则对传参有疑问：“林哥，<code>Bundle</code> 和 <code>Intent</code> 传参有啥区别啊？文档里说它能在组件间传数据，我咋感觉用 <code>Intent.putExtra()</code> 也能直接传呢？”</p>
<p>林卓机械地复述道：“<code>Intent.putExtra()</code> 本质就是把数据封装进 <code>Bundle</code> 里了，<code>Bundle</code> 是专门的键值对结构，除了 <code>Activity</code> 间传参，还能在 <code>Fragment</code> 间用 <code>setArguments()</code> 传，或者在 <code>onSaveInstanceState()</code> 里保存 UI 状态。”</p>
<p>其实他脑子里闪过了“可存储类型”这个技术要点，本想补充说明几句。</p>
<p>可心思又不由自主飘到了小安那边，敲键盘的动作一顿，最终只潦草地结束了回复。</p>
<p>阿泽赶紧在笔记本上划了重点符号，生怕漏了关键信息。待博文的问题告一段落，他又在群里提问：“林哥，我看到文档里讲配置变更，说屏幕旋转会销毁重建 <code>Activity</code>，那怎么防止用户输入的内容丢了啊？”</p>
<p>这个问题其实是个关键技术点，面试常考，但是林卓的注意力全然不在这里，只是草草回应：“两种办法，要么用 <code>onSaveInstanceState()</code> 通过 <code>Bundle</code> 存临时状态，要么用 <code>ViewModel</code> 管理数据，它能在 <code>Activity</code> 重建时保留数据。也可以在 <code>AndroidManifest</code> 里加 <code>android:configChanges</code> 属性避免重建，但容易出问题，慎用。”</p>
<p>他没展开讲 <code>onRestoreInstanceState()</code> 的用法，也没细说各方法的适用场景。</p>
<p>三个实习生只好对着文档里的代码示例反复琢磨。</p>
<p>晓雅研究片刻后，又在群里追问：“那 <code>Fragment</code> 之间传数据，除了 <code>Bundle</code> 还有别的办法吗？文档里提的共享 <code>ViewModel</code> 和 <code>Fragment Result API</code> 我完全没看懂。”</p>
<p>林卓敷衍道：“同一个 <code>Activity</code> 里的 <code>Fragment</code>，用共享 <code>ViewModel</code> 最方便，通过 <code>activityViewModels()</code> 获取同一个实例就能共享数据；如果是需要返回一次性结果的，比如扫描二维码后回传结果，就用 <code>Fragment Result API</code>，用 <code>setFragmentResultListener()</code> 注册监听就行。”</p>
<p>他既没提代码示例，也没解释核心原理。</p>
<p>晓雅把“共享 <code>ViewModel</code> 作用域”这个关键词圈了出来，打算后续自己查资料补充。</p>
<p>临近中午，林卓借口去茶水间，绕到了小安的工位旁。</p>
<p>小安正忙着给测试设备充电，桌上摆满了各式各样的手机和平板，正是昨天三人看到的那一大堆测试设备。</p>
<p>“小安，中午一起去楼下吃那家新开的轻食怎么样？听说沙拉做得不错。”</p>
<p>林卓的声音带着一丝不易察觉的紧张。</p>
<p>小安手上的动作没停，头也没抬地说：“我手上还有几个测试用例没跑完，不知道能不能赶得及。”</p>
<p>她没有直接拒绝，林卓立刻接话：“我等你，反正我也不着急。”</p>
<p>小安没再回应，只是嘴角悄悄勾了一下，快得让人以为是错觉。</p>
<p>十二点半，小安终于处理完手头的工作，跟着林卓下了楼。</p>
<p>轻食店人不多，两人找了个靠窗的位置坐下。服务员递来菜单，两人简单点完餐。</p>
<p>桌上一时陷入沉默，只有窗外的车流声隐约传来。</p>
<p>林卓攥了攥手指，主动打破安静。他带着点委屈的语气开了口：“你是不知道我这两天有多熬人，手上攒了一堆项目Bug没清理，还得给实习生整理资料、布置任务。今天他们在Q书群里追着问各种技术问题，我脑子全程都是乱的，连静下心来好好理理思路的时间都没有。”</p>
<p>他絮絮叨叨地说着，从实习生五花八门的追问，说到自己被工作缠得脱不开身的状态。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/567ca8cdb78143ca86b16234ed84dd52~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUm9ja0J5dGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767056277&amp;x-signature=6UgO8y%2BptdOepVxAFL1o5l3s4TM%3D" alt="2.png" loading="lazy"/></p>
<p>眼神却一直悄悄留意着小安的反应。</p>
<p>小安起初还维持着几分疏离，安静地听着。她指尖无意识地摩挲着水杯边缘，眼神里却藏着点没说破的情绪。</p>
<p>听着听着，她没忍住开口，语气里带着点不易察觉的酸意，却又装得漫不经心：“我看你嘴也不笨啊，给晓雅他们讲解问题的时候，不是挺认真的嘛，瞧着倒像是乐在其中，哪来的什么苦可诉。”</p>
<p>话锋一转，她又带上了点工作上的严肃，像是在吐槽却又没真的动气。</p>
<p>“再说我这儿，昨天测试任务本就堆得满，偏偏还从你负责的模块里，测出了一堆Bug。我估摸着这两天还得查出不少，你可得抓紧时间改，别到时候耽误了整体的项目进度。”</p>
<p>她说完，垂眸抿了口水杯里的水。耳尖却悄悄泛起一点红，没敢去看林卓的眼睛。</p>
<p>林卓一听她这话，原本的紧张消散了大半，却又多了点小心翼翼的欣喜。</p>
<p>他赶紧接话，语气带着点讨好又不失真诚：“哪儿能乐在其中啊，跟他们讲解纯属工作，还没有给你改Bug自在。”</p>
<p>顿了顿，他又赶紧表态度：“Bug你放心，我今晚上加个班都给清干净，绝对不耽误你测试。对了，你测出的那些Bug，有没有优先级特别高的？你抽空跟我说说，我重点优先改，省得你反复跑测试用例费功夫。”</p>
<p>两人边吃边聊，话题从工作慢慢延伸到生活琐事。</p>
<p>先前的疏离感渐渐消散，气氛早已恢复了往日的融洽。</p>
<p>下午一点多，两人回到公司。</p>
<p>刚走到办公区门口，就碰到了老杨。</p>
<p>老杨笑着迎上来，随口问了一句：“小林，小安，中午去哪儿吃了？”</p>
<p>林卓回道：“去楼下新开的那家轻食店尝了尝，味道还不错。”</p>
<p>小安在一旁轻轻点头附和：“嗯，沙拉做得挺新鲜的。”</p>
<p>她的目光忽然落在了老杨手里端着的搪瓷杯上。杯里沉着些褐绿色的东西，看着有些奇特。</p>
<p>她开口问道：“老杨，你杯子里这褐绿色的是啥呀？”</p>
<p>老杨扬了扬手里的杯子，笑着解释：“这是我自己泡的抹茶美式，今天手一抖，抹茶放多了，颜色就成这样了。”</p>
<p>他轻轻抿了一口，又接着说道：“其实一开始我也觉得，抹茶和咖啡这俩东西根本不搭，一个清苦一个醇厚，咋想都觉得会串味儿。”</p>
<p>“可架不住想试试，没想到泡出来还挺合我胃口。”</p>
<p>说到这儿，他意味深长地看了林卓和小安一眼。语气里带着生活的通透：“很多事儿都这样，看着不搭、有隔阂，可真说开了，就融洽了。”</p>
<p>小安领会了其中的隐喻，没再停留，轻声说了句“老杨我们先回工位了”，便转身快步走回了测试区。</p>
<p>林卓也听出了老杨话里的深意，脸颊微微发烫，一时竟不知该如何接话。点了点头，朝老杨笑了笑，转身往培训室的方向走。</p>
<p>走到培训室门口，他忽然想起上午给实习生答疑时的疏漏。不仅遗漏了 <code>ActivityManager</code> 这个重要知识点，对屏幕旋转相关问题的讲解也不够透彻。</p>
<p>他便决定下午给实习生补充讲解一番。</p>
<p>走进培训室时，只见三个实习生早已没了清晨的愁眉不展，正围坐在一起对着代码调试，全然沉浸在项目实践中。林卓见状没有贸然打扰，而是轻咳一声示意大家暂停，待三人抬头望过来，才温和地开口：</p>
<p>“上午大家在Q书群里问的问题，不少知识点我都没展开细讲，咱们结合实际业务场景再梳理一遍。”</p>
<p>“另外，还有个 <code>ActivityManager</code> 的知识点得补一补，它是系统服务，能查内存信息、运行进程，调试时用 <code>getMemoryInfo()</code> 能判断设备是否低内存，避免 <code>OOM</code> 问题。”</p>
<p>晓雅赶紧抬笔做好记录准备。顺便问道：“林哥，你说 <code>ActivityManager</code> 能查内存信息，那具体咋获取这些内存数据呀？开发中知道这些信息有啥实际用处吗？”</p>
<p>林卓讲解道：“获取内存信息很简单，先用<code>getSystemService(Context.ACTIVITY_SERVICE)</code> 获取 <code>ActivityManager</code> 实例，再通过 <code>getMemoryInfo()</code> 方法就能拿到 <code>MemoryInfo</code> 对象，里面包含总内存、可用内存这些关键数据。”</p>
<p>接着他举了开发中常用的例子：“实际用处可不小，比如咱们做视频播放或者图片浏览类功能时，能通过这些数据判断设备内存是否充足。要是检测到可用内存过低，就主动释放一些非必要的缓存资源，比如清空图片缓存、暂停后台预加载任务，这样能有效避免 <strong>OOM</strong> 崩溃问题，提升APP的稳定性。”</p>
<p>他还补充了文档里的核心要点：“这个是开发中常用的关键知识点，记住别用它随便杀其他应用进程，容易触发系统限制。”</p>
<p>讲解完 <code>ActivityManager</code>，晓雅又顺着上午的问题追问。</p>
<p>“林哥，上午你说用 <code>android:configChanges</code> 能避免 <code>Activity</code> 重建，可要是真这么做了，屏幕旋转时的布局变化该咋处理啊？我看文档里提了<code>onConfigurationChanged</code>，但没看明白具体咋用。”</p>
<p>林卓清了清嗓子，语气比上午认真了不少。</p>
<p>“首先得明确，给 <code>Activity</code> 配置<code>android:configChanges</code> 属性后，系统就不会销毁重建<code>Activity</code> 了，而是会调用 <code>onConfigurationChanged()</code> 这个回调方法。”</p>
<p>“咱们要做的，就是在这个方法里手动处理配置变化，比如屏幕旋转后的布局适配、资源重新加载这些操作。”</p>
<p>说着，他在白板上简单写了段核心代码框架。</p>
<p>“你们看，这个方法会接收一个 <code>Configuration</code> 类型的参数 <code>newConfig</code>，通过它就能获取到新的配置信息。”</p>
<p>“比如判断屏幕方向，就用 <code>newConfig.orientation == Configuration.ORIENTATION_LANDSCAPE</code> 表示横屏，<code>ORIENTATION_PORTRAIT</code> 表示竖屏，根据不同方向加载对应的布局文件就行。”</p>
<p>他还补充了实际开发中的注意事项。</p>
<p>“举个例子，要是咱们的APP有横屏和竖屏两种不同的布局，横屏是两列展示，竖屏是一列展示，就可以在 <code>onConfigurationChanged()</code> 里，根据新的屏幕方向去 <code>findViewById</code> 重新绑定控件，或者切换不同的布局资源。”</p>
<p>“另外，像图片、字符串这些跟配置相关的资源，也得在这里重新获取，不然可能会出现资源错乱的问题。”</p>
<p>讲到这儿，他特意强调。</p>
<p>“但我必须再提醒你们一次，这种方式是有弊端的。所有配置变化的处理都得靠咱们自己手动写代码，比如除了屏幕旋转，还有字体大小变化、语言切换这些配置，要是漏处理了，很容易出现BUG。”</p>
<p>“所以非必要的情况下，还是优先用 <code>ViewModel</code> 来保存数据，让系统正常销毁重建 <code>Activity</code>，这样更省心也更稳妥。”</p>
<p>林卓正讲得投入，培训室门口突然传来一阵急促的脚步声——研发二组的掌舵人，张磊。</p>
<p>“林卓，有紧急项目支援一下。”张磊语气简短，没多余寒暄，“立刻把手头工作交接一下，跟我去会议室。”</p>
<p>林卓心里咯噔一下。他下意识扫过三个一脸错愕的实习生，刚想开口询问，就被张磊的眼神制止。</p>
<p>“别耽搁，项目优先级最高。”张磊说完，转身就往门外走，只留了句“我在门口等你”。</p>
<p>林卓僵在原地，实习生们面面相觑。</p>
<p>就在这时，老杨来到培训室，走到林卓身边，拍了拍他的肩膀，压低声音悄悄叮嘱：“别慌，赶紧去，这可是表现的好机会，对你下半年转正大有好处。实习生这边我帮你看着。”</p>
<p>林卓回过神，冲老杨匆匆点了点头，便快步回工位抓了笔记本和手机，快步跟上张磊的脚步。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cc4b3b493b3d4de297ab452410ac87be~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUm9ja0J5dGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767056277&amp;x-signature=JV10W102fl%2BtEqmg4mBlJfjZYpU%3D" alt="3.png" loading="lazy"/></p>
<p>走廊里的灯光映着两人急促的身影，林卓攥着笔记本的指尖微微发紧。</p>
<p>他知道，张磊亲自点名的紧急任务，一定不会简单......</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[使用 Laravel Workflow 作为 MCP 工具提供给 AI 客户端]]></title>    <link>https://juejin.cn/post/7586500093844733994</link>    <guid>https://juejin.cn/post/7586500093844733994</guid>    <pubDate>2025-12-23T01:02:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586500093844733994" data-draft-id="7586555198115348486" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="使用 Laravel Workflow 作为 MCP 工具提供给 AI 客户端"/> <meta itemprop="keywords" content="Laravel,PHP,后端"/> <meta itemprop="datePublished" content="2025-12-23T01:02:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="BingoGo"/> <meta itemprop="url" content="https://juejin.cn/user/993614242266077"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            使用 Laravel Workflow 作为 MCP 工具提供给 AI 客户端
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/993614242266077/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    BingoGo
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-23T01:02:52.000Z" title="Tue Dec 23 2025 01:02:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-23
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="arduino-light">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fff}.hljs-subst,.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#434f54}.hljs-attribute,.hljs-doctag,.hljs-keyword,.hljs-name,.hljs-selector-tag{color:#00979d}.hljs-addition,.hljs-built_in,.hljs-bullet,.hljs-code,.hljs-literal{color:#d35400}.hljs-link,.hljs-regexp,.hljs-selector-attr,.hljs-selector-pseudo,.hljs-symbol,.hljs-template-variable,.hljs-variable{color:#00979d}.hljs-deletion,.hljs-quote,.hljs-selector-class,.hljs-selector-id,.hljs-string,.hljs-template-tag,.hljs-type{color:#005c5f}.hljs-section,.hljs-title{color:#800;font-weight:700}.hljs-comment{color:rgba(149,165,166,.8)}.hljs-meta-keyword{color:#728e00}.hljs-meta{color:#434f54}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-function{color:#728e00}.hljs-number{color:#8a7b52}</style><h2 data-id="heading-0">使用 Laravel Workflow 作为 MCP 工具提供给 AI 客户端</h2>
<p><code>Model Context Protocol</code> (MCP) 正在迅速成为 AI 助手(如 Claude、ChatGPT 和 GitHub Copilot)与外部工具和服务交互的标准方式。通过 Laravel MCP,你可以将 Laravel Workflow 流程暴露为可调用的工具,任何兼容 MCP 的 AI 客户端都可以发现、调用和监控这些工具。</p>
<p>在本文中,我们将展示如何构建一个 MCP 服务器,使 AI 客户端能够:</p>
<ul>
<li>发现可用的工作流</li>
<li>异步启动工作流</li>
<li>轮询状态并检索结果</li>
</ul>
<p>这创建了一个强大的模式,AI 代理可以编排长时间运行的持久化工作流,非常适合无法在单个请求中完成的复杂任务。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fcatchadmin.com%2Fpost%2F2025-12%2Flaravel-workflows-mcp-tools-ai-clients" target="_blank" title="https://catchadmin.com/post/2025-12/laravel-workflows-mcp-tools-ai-clients" ref="nofollow noopener noreferrer">原文链接 使用 Laravel Workflow 作为 MCP 工具提供给 AI 客户端</a></p>
<h3 data-id="heading-1">为什么选择 MCP + Laravel Workflow?</h3>
<p>Laravel Workflow 擅长持久化、有状态的执行。MCP 擅长为 AI 客户端提供对外部能力的结构化访问。两者结合可以实现:</p>
<ul>
<li><strong>异步 AI 操作</strong>:启动工作流,继续对话,稍后检查结果</li>
<li><strong>可靠执行</strong>:工作流可以在崩溃、重试和长时间等待中存活</li>
<li><strong>可观察性</strong>:通过 Waterline 的仪表板跟踪每个工作流</li>
<li><strong>无状态服务器</strong>:MCP 服务器不保存状态。客户端跟踪工作流 ID</li>
</ul>
<p>这类似于人类委派任务的方式:"开始这个报告,我稍后再检查。"</p>
<h3 data-id="heading-2">我们要构建什么</h3>
<p>我们将创建一个包含三个工具的 MCP 服务器:</p>





















<table><thead><tr><th>工具</th><th>用途</th></tr></thead><tbody><tr><td>list_workflows</td><td>发现可用的工作流并查看最近的运行记录</td></tr><tr><td>start_workflow</td><td>启动工作流并获取跟踪 ID</td></tr><tr><td>get_workflow_result</td><td>检查状态并在完成时检索输出</td></tr></tbody></table>
<h3 data-id="heading-3">分步实现</h3>
<h4 data-id="heading-4">安装 Laravel MCP</h4>
<pre><code class="hljs language-bash" lang="bash">composer require laravel/mcp
php artisan vendor:publish --tag=ai-routes
</code></pre>
<p>这会为你提供 <code>routes/ai.php</code>,你将在其中注册 MCP 服务器。</p>
<h4 data-id="heading-5">创建 MCP 服务器</h4>
<pre><code class="hljs language-bash" lang="bash">php artisan make:mcp-server WorkflowServer
</code></pre>
<p>为 AI 配置说明:</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">namespace</span> <span class="hljs-title class_">App</span>\<span class="hljs-title class_">Mcp</span>\<span class="hljs-title class_">Servers</span>;

<span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">Mcp</span>\<span class="hljs-title">Tools</span>\<span class="hljs-title">GetWorkflowResultTool</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">Mcp</span>\<span class="hljs-title">Tools</span>\<span class="hljs-title">ListWorkflowsTool</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">Mcp</span>\<span class="hljs-title">Tools</span>\<span class="hljs-title">StartWorkflowTool</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Laravel</span>\<span class="hljs-title">Mcp</span>\<span class="hljs-title">Server</span>;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">WorkflowServer</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Server</span>
</span>{
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">string</span> <span class="hljs-variable">$name</span> = <span class="hljs-string">'Laravel Workflow Server'</span>;
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">string</span> <span class="hljs-variable">$version</span> = <span class="hljs-string">'1.0.0'</span>;

    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">string</span> <span class="hljs-variable">$instructions</span> = &lt;&lt;&lt;<span class="hljs-string">'MARKDOWN'</span>
        This server allows you to start <span class="hljs-keyword">and</span> monitor Laravel Workflows.

        <span class="hljs-comment">## Typical Usage Pattern</span>

        <span class="hljs-number">1</span>. Call `list_workflows` to see what workflows are available.
        <span class="hljs-number">2</span>. Call `start_workflow` with the workflow name <span class="hljs-keyword">and</span> arguments.
        <span class="hljs-number">3</span>. Store the returned `workflow_id`.
        <span class="hljs-number">4</span>. Call `get_workflow_result` until status is `WorkflowCompletedStatus`.
        <span class="hljs-number">5</span>. Read the `output` field <span class="hljs-keyword">for</span> the result.

        <span class="hljs-comment">## Status Values</span>

        - `WorkflowCreatedStatus` - Workflow has been created
        - `WorkflowPendingStatus` - Queued <span class="hljs-keyword">for</span> execution
        - `WorkflowRunningStatus` - Currently executing
        - `WorkflowWaitingStatus` - <span class="hljs-title function_ invoke__">Waiting</span> (timer, signal, etc.)
        - `WorkflowCompletedStatus` - Finished successfully
        - `WorkflowFailedStatus` - Encountered an error
    MARKDOWN;

    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">array</span> <span class="hljs-variable">$tools</span> = [
        <span class="hljs-title class_">ListWorkflowsTool</span>::<span class="hljs-variable language_">class</span>,
        <span class="hljs-title class_">StartWorkflowTool</span>::<span class="hljs-variable language_">class</span>,
        <span class="hljs-title class_">GetWorkflowResultTool</span>::<span class="hljs-variable language_">class</span>,
    ];
}
</code></pre>
<h4 data-id="heading-6">创建启动工作流工具</h4>
<pre><code class="hljs language-bash" lang="bash">php artisan make:mcp-tool StartWorkflowTool
</code></pre>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">namespace</span> <span class="hljs-title class_">App</span>\<span class="hljs-title class_">Mcp</span>\<span class="hljs-title class_">Tools</span>;

<span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Contracts</span>\<span class="hljs-title">JsonSchema</span>\<span class="hljs-title">JsonSchema</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Support</span>\<span class="hljs-title">Arr</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Laravel</span>\<span class="hljs-title">Mcp</span>\<span class="hljs-title">Request</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Laravel</span>\<span class="hljs-title">Mcp</span>\<span class="hljs-title">Response</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Laravel</span>\<span class="hljs-title">Mcp</span>\<span class="hljs-title">Server</span>\<span class="hljs-title">Tool</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Workflow</span>\<span class="hljs-title">Workflow</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Workflow</span>\<span class="hljs-title">WorkflowStub</span>;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">StartWorkflowTool</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Tool</span>
</span>{
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">string</span> <span class="hljs-variable">$description</span> = &lt;&lt;&lt;<span class="hljs-string">'MARKDOWN'</span>
        Start a Laravel Workflow asynchronously <span class="hljs-keyword">and</span> <span class="hljs-keyword">return</span> its workflow ID.
        
        The workflow will execute in the background on the queue. Use the
        `get_workflow_result` tool to poll <span class="hljs-keyword">for</span> status <span class="hljs-keyword">and</span> retrieve results
        once the workflow completes.
    MARKDOWN;

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handle</span>(<span class="hljs-params">Request <span class="hljs-variable">$request</span></span>): <span class="hljs-title">Response</span>
    </span>{
        <span class="hljs-variable">$data</span> = <span class="hljs-variable">$request</span>-&gt;<span class="hljs-title function_ invoke__">validate</span>([
            <span class="hljs-string">'workflow'</span> =&gt; [<span class="hljs-string">'required'</span>, <span class="hljs-string">'string'</span>],
            <span class="hljs-string">'args'</span> =&gt; [<span class="hljs-string">'nullable'</span>, <span class="hljs-string">'array'</span>],
            <span class="hljs-string">'external_id'</span> =&gt; [<span class="hljs-string">'nullable'</span>, <span class="hljs-string">'string'</span>, <span class="hljs-string">'max:255'</span>],
        ]);

        <span class="hljs-variable">$workflowKey</span> = <span class="hljs-variable">$data</span>[<span class="hljs-string">'workflow'</span>];
        <span class="hljs-variable">$args</span> = <span class="hljs-title class_">Arr</span>::<span class="hljs-title function_ invoke__">get</span>(<span class="hljs-variable">$data</span>, <span class="hljs-string">'args'</span>, []);
        <span class="hljs-variable">$externalId</span> = <span class="hljs-variable">$data</span>[<span class="hljs-string">'external_id'</span>] ?? <span class="hljs-literal">null</span>;

        <span class="hljs-variable">$workflowClass</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">resolveWorkflowClass</span>(<span class="hljs-variable">$workflowKey</span>);

        <span class="hljs-keyword">if</span> (<span class="hljs-variable">$workflowClass</span> === <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-title class_">Response</span>::<span class="hljs-title function_ invoke__">error</span>(<span class="hljs-string">"Unknown workflow: <span class="hljs-subst">{$workflowKey}</span>"</span>);
        }

        <span class="hljs-keyword">if</span> (! <span class="hljs-title function_ invoke__">class_exists</span>(<span class="hljs-variable">$workflowClass</span>) || ! <span class="hljs-title function_ invoke__">is_subclass_of</span>(<span class="hljs-variable">$workflowClass</span>, <span class="hljs-title class_">Workflow</span>::<span class="hljs-variable language_">class</span>)) {
            <span class="hljs-keyword">return</span> <span class="hljs-title class_">Response</span>::<span class="hljs-title function_ invoke__">error</span>(<span class="hljs-string">"Invalid workflow class: <span class="hljs-subst">{$workflowClass}</span>"</span>);
        }

        <span class="hljs-variable">$stub</span> = <span class="hljs-title class_">WorkflowStub</span>::<span class="hljs-title function_ invoke__">make</span>(<span class="hljs-variable">$workflowClass</span>);
        <span class="hljs-variable">$stub</span>-&gt;<span class="hljs-title function_ invoke__">start</span>(...<span class="hljs-title function_ invoke__">array_values</span>(<span class="hljs-variable">$args</span>));

        <span class="hljs-variable">$status</span> = <span class="hljs-variable">$stub</span>-&gt;<span class="hljs-title function_ invoke__">status</span>();
        <span class="hljs-variable">$statusName</span> = <span class="hljs-title function_ invoke__">is_object</span>(<span class="hljs-variable">$status</span>) ? <span class="hljs-title function_ invoke__">class_basename</span>(<span class="hljs-variable">$status</span>) : <span class="hljs-title function_ invoke__">class_basename</span>((<span class="hljs-keyword">string</span>) <span class="hljs-variable">$status</span>);

        <span class="hljs-keyword">return</span> <span class="hljs-title class_">Response</span>::<span class="hljs-title function_ invoke__">json</span>([
            <span class="hljs-string">'workflow_id'</span> =&gt; <span class="hljs-variable">$stub</span>-&gt;<span class="hljs-title function_ invoke__">id</span>(),
            <span class="hljs-string">'workflow'</span> =&gt; <span class="hljs-variable">$workflowKey</span>,
            <span class="hljs-string">'status'</span> =&gt; <span class="hljs-variable">$statusName</span>,
            <span class="hljs-string">'external_id'</span> =&gt; <span class="hljs-variable">$externalId</span>,
            <span class="hljs-string">'message'</span> =&gt; <span class="hljs-string">'Workflow started. Use get_workflow_result to poll status.'</span>,
        ]);
    }

    <span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">resolveWorkflowClass</span>(<span class="hljs-params"><span class="hljs-keyword">string</span> <span class="hljs-variable">$key</span></span>): ?<span class="hljs-title">string</span>
    </span>{
        <span class="hljs-variable">$mapped</span> = <span class="hljs-title function_ invoke__">config</span>(<span class="hljs-string">"workflow_mcp.workflows.<span class="hljs-subst">{$key}</span>"</span>);
        <span class="hljs-keyword">if</span> (<span class="hljs-variable">$mapped</span> !== <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-variable">$mapped</span>;
        }

        <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">config</span>(<span class="hljs-string">'workflow_mcp.allow_fqcn'</span>, <span class="hljs-literal">false</span>) &amp;&amp; <span class="hljs-title function_ invoke__">str_contains</span>(<span class="hljs-variable">$key</span>, <span class="hljs-string">'\\'</span>)) {
            <span class="hljs-keyword">return</span> <span class="hljs-variable">$key</span>;
        }

        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">schema</span>(<span class="hljs-params">JsonSchema <span class="hljs-variable">$schema</span></span>): <span class="hljs-title">array</span>
    </span>{
        <span class="hljs-variable">$workflows</span> = <span class="hljs-title function_ invoke__">implode</span>(<span class="hljs-string">', '</span>, <span class="hljs-title function_ invoke__">array_keys</span>(<span class="hljs-title function_ invoke__">config</span>(<span class="hljs-string">'workflow_mcp.workflows'</span>, [])));

        <span class="hljs-keyword">return</span> [
            <span class="hljs-string">'workflow'</span> =&gt; <span class="hljs-variable">$schema</span>-&gt;<span class="hljs-keyword">string</span>()
                -&gt;<span class="hljs-title function_ invoke__">description</span>(<span class="hljs-string">"The workflow to start. Available: <span class="hljs-subst">{$workflows}</span>"</span>),
            <span class="hljs-string">'args'</span> =&gt; <span class="hljs-variable">$schema</span>-&gt;<span class="hljs-keyword">object</span>()
                -&gt;<span class="hljs-title function_ invoke__">description</span>(<span class="hljs-string">'Arguments for the workflow execute() method.'</span>),
            <span class="hljs-string">'external_id'</span> =&gt; <span class="hljs-variable">$schema</span>-&gt;<span class="hljs-keyword">string</span>()
                -&gt;<span class="hljs-title function_ invoke__">description</span>(<span class="hljs-string">'Optional idempotency key for tracking.'</span>),
        ];
    }
}
</code></pre>
<h4 data-id="heading-7">创建获取结果工具</h4>
<pre><code class="hljs language-bash" lang="bash">php artisan make:mcp-tool GetWorkflowResultTool
</code></pre>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">namespace</span> <span class="hljs-title class_">App</span>\<span class="hljs-title class_">Mcp</span>\<span class="hljs-title class_">Tools</span>;

<span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">Models</span>\<span class="hljs-title">StoredWorkflow</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Contracts</span>\<span class="hljs-title">JsonSchema</span>\<span class="hljs-title">JsonSchema</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Laravel</span>\<span class="hljs-title">Mcp</span>\<span class="hljs-title">Request</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Laravel</span>\<span class="hljs-title">Mcp</span>\<span class="hljs-title">Response</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Laravel</span>\<span class="hljs-title">Mcp</span>\<span class="hljs-title">Server</span>\<span class="hljs-title">Tool</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Workflow</span>\<span class="hljs-title">States</span>\<span class="hljs-title">WorkflowCompletedStatus</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Workflow</span>\<span class="hljs-title">States</span>\<span class="hljs-title">WorkflowFailedStatus</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Workflow</span>\<span class="hljs-title">WorkflowStub</span>;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">GetWorkflowResultTool</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Tool</span>
</span>{
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">string</span> <span class="hljs-variable">$description</span> = &lt;&lt;&lt;<span class="hljs-string">'MARKDOWN'</span>
        Fetch the status <span class="hljs-keyword">and</span>, <span class="hljs-keyword">if</span> completed, the output of a Laravel Workflow.
        
        Use the workflow_id returned by `start_workflow` to check progress.
        Once status is `WorkflowCompletedStatus`, the output field contains the result.
    MARKDOWN;

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handle</span>(<span class="hljs-params">Request <span class="hljs-variable">$request</span></span>): <span class="hljs-title">Response</span>
    </span>{
        <span class="hljs-variable">$data</span> = <span class="hljs-variable">$request</span>-&gt;<span class="hljs-title function_ invoke__">validate</span>([
            <span class="hljs-string">'workflow_id'</span> =&gt; [<span class="hljs-string">'required'</span>],
        ]);

        <span class="hljs-variable">$workflowId</span> = <span class="hljs-variable">$data</span>[<span class="hljs-string">'workflow_id'</span>];
        <span class="hljs-variable">$stored</span> = <span class="hljs-title class_">StoredWorkflow</span>::<span class="hljs-title function_ invoke__">find</span>(<span class="hljs-variable">$workflowId</span>);

        <span class="hljs-keyword">if</span> (! <span class="hljs-variable">$stored</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-title class_">Response</span>::<span class="hljs-title function_ invoke__">json</span>([
                <span class="hljs-string">'found'</span> =&gt; <span class="hljs-literal">false</span>,
                <span class="hljs-string">'message'</span> =&gt; <span class="hljs-string">"Workflow <span class="hljs-subst">{$workflowId}</span> not found."</span>,
            ]);
        }

        <span class="hljs-variable">$workflow</span> = <span class="hljs-title class_">WorkflowStub</span>::<span class="hljs-title function_ invoke__">load</span>(<span class="hljs-variable">$workflowId</span>);
        <span class="hljs-variable">$status</span> = <span class="hljs-variable">$workflow</span>-&gt;<span class="hljs-title function_ invoke__">status</span>();
        <span class="hljs-variable">$statusName</span> = <span class="hljs-title function_ invoke__">is_object</span>(<span class="hljs-variable">$status</span>) ? <span class="hljs-title function_ invoke__">class_basename</span>(<span class="hljs-variable">$status</span>) : <span class="hljs-title function_ invoke__">class_basename</span>((<span class="hljs-keyword">string</span>) <span class="hljs-variable">$status</span>);
        <span class="hljs-variable">$running</span> = <span class="hljs-variable">$workflow</span>-&gt;<span class="hljs-title function_ invoke__">running</span>();

        <span class="hljs-variable">$result</span> = <span class="hljs-literal">null</span>;
        <span class="hljs-variable">$error</span> = <span class="hljs-literal">null</span>;

        <span class="hljs-keyword">if</span> (! <span class="hljs-variable">$running</span> &amp;&amp; <span class="hljs-title function_ invoke__">str_contains</span>(<span class="hljs-variable">$statusName</span>, <span class="hljs-string">'Completed'</span>)) {
            <span class="hljs-variable">$result</span> = <span class="hljs-variable">$workflow</span>-&gt;<span class="hljs-title function_ invoke__">output</span>();
        }

        <span class="hljs-keyword">if</span> (! <span class="hljs-variable">$running</span> &amp;&amp; <span class="hljs-title function_ invoke__">str_contains</span>(<span class="hljs-variable">$statusName</span>, <span class="hljs-string">'Failed'</span>)) {
            <span class="hljs-variable">$exception</span> = <span class="hljs-variable">$stored</span>-&gt;<span class="hljs-title function_ invoke__">exceptions</span>()-&gt;<span class="hljs-title function_ invoke__">latest</span>()-&gt;<span class="hljs-title function_ invoke__">first</span>();
            <span class="hljs-variable">$error</span> = <span class="hljs-variable">$exception</span>?-&gt;exception ?? <span class="hljs-string">'Unknown error'</span>;
        }

        <span class="hljs-keyword">return</span> <span class="hljs-title class_">Response</span>::<span class="hljs-title function_ invoke__">json</span>([
            <span class="hljs-string">'found'</span> =&gt; <span class="hljs-literal">true</span>,
            <span class="hljs-string">'workflow_id'</span> =&gt; <span class="hljs-variable">$workflowId</span>,
            <span class="hljs-string">'status'</span> =&gt; <span class="hljs-variable">$statusName</span>,
            <span class="hljs-string">'running'</span> =&gt; <span class="hljs-variable">$running</span>,
            <span class="hljs-string">'output'</span> =&gt; <span class="hljs-variable">$result</span>,
            <span class="hljs-string">'error'</span> =&gt; <span class="hljs-variable">$error</span>,
            <span class="hljs-string">'created_at'</span> =&gt; <span class="hljs-variable">$stored</span>-&gt;created_at?-&gt;<span class="hljs-title function_ invoke__">toIso8601String</span>(),
            <span class="hljs-string">'updated_at'</span> =&gt; <span class="hljs-variable">$stored</span>-&gt;updated_at?-&gt;<span class="hljs-title function_ invoke__">toIso8601String</span>(),
        ]);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">schema</span>(<span class="hljs-params">JsonSchema <span class="hljs-variable">$schema</span></span>): <span class="hljs-title">array</span>
    </span>{
        <span class="hljs-keyword">return</span> [
            <span class="hljs-string">'workflow_id'</span> =&gt; <span class="hljs-variable">$schema</span>-&gt;<span class="hljs-keyword">string</span>()
                -&gt;<span class="hljs-title function_ invoke__">description</span>(<span class="hljs-string">'The workflow ID returned by start_workflow.'</span>),
        ];
    }
}
</code></pre>
<h4 data-id="heading-8">创建列表工作流工具</h4>
<pre><code class="hljs language-bash" lang="bash">php artisan make:mcp-tool ListWorkflowsTool
</code></pre>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">namespace</span> <span class="hljs-title class_">App</span>\<span class="hljs-title class_">Mcp</span>\<span class="hljs-title class_">Tools</span>;

<span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">Models</span>\<span class="hljs-title">StoredWorkflow</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Contracts</span>\<span class="hljs-title">JsonSchema</span>\<span class="hljs-title">JsonSchema</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Laravel</span>\<span class="hljs-title">Mcp</span>\<span class="hljs-title">Request</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Laravel</span>\<span class="hljs-title">Mcp</span>\<span class="hljs-title">Response</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Laravel</span>\<span class="hljs-title">Mcp</span>\<span class="hljs-title">Server</span>\<span class="hljs-title">Tool</span>;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ListWorkflowsTool</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Tool</span>
</span>{
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">string</span> <span class="hljs-variable">$description</span> = &lt;&lt;&lt;<span class="hljs-string">'MARKDOWN'</span>
        List available workflow types <span class="hljs-keyword">and</span> optionally show recent workflow runs.
        
        Use this to discover what workflows can be started, <span class="hljs-keyword">or</span> to see
        the status of recent executions.
    MARKDOWN;

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handle</span>(<span class="hljs-params">Request <span class="hljs-variable">$request</span></span>): <span class="hljs-title">Response</span>
    </span>{
        <span class="hljs-variable">$data</span> = <span class="hljs-variable">$request</span>-&gt;<span class="hljs-title function_ invoke__">validate</span>([
            <span class="hljs-string">'show_recent'</span> =&gt; [<span class="hljs-string">'nullable'</span>, <span class="hljs-string">'boolean'</span>],
            <span class="hljs-string">'limit'</span> =&gt; [<span class="hljs-string">'nullable'</span>, <span class="hljs-string">'integer'</span>, <span class="hljs-string">'min:1'</span>, <span class="hljs-string">'max:50'</span>],
            <span class="hljs-string">'status'</span> =&gt; [<span class="hljs-string">'nullable'</span>, <span class="hljs-string">'string'</span>],
        ]);

        <span class="hljs-variable">$showRecent</span> = <span class="hljs-variable">$data</span>[<span class="hljs-string">'show_recent'</span>] ?? <span class="hljs-literal">false</span>;
        <span class="hljs-variable">$limit</span> = <span class="hljs-variable">$data</span>[<span class="hljs-string">'limit'</span>] ?? <span class="hljs-number">10</span>;
        <span class="hljs-variable">$statusFilter</span> = <span class="hljs-variable">$data</span>[<span class="hljs-string">'status'</span>] ?? <span class="hljs-literal">null</span>;

        <span class="hljs-variable">$availableWorkflows</span> = [];
        <span class="hljs-keyword">foreach</span> (<span class="hljs-title function_ invoke__">config</span>(<span class="hljs-string">'workflow_mcp.workflows'</span>, []) <span class="hljs-keyword">as</span> <span class="hljs-variable">$key</span> =&gt; <span class="hljs-variable">$class</span>) {
            <span class="hljs-variable">$availableWorkflows</span>[] = [<span class="hljs-string">'key'</span> =&gt; <span class="hljs-variable">$key</span>, <span class="hljs-string">'class'</span> =&gt; <span class="hljs-variable">$class</span>];
        }

        <span class="hljs-variable">$response</span> = [
            <span class="hljs-string">'available_workflows'</span> =&gt; <span class="hljs-variable">$availableWorkflows</span>,
        ];

        <span class="hljs-keyword">if</span> (<span class="hljs-variable">$showRecent</span>) {
            <span class="hljs-variable">$query</span> = <span class="hljs-title class_">StoredWorkflow</span>::<span class="hljs-title function_ invoke__">query</span>()
                -&gt;<span class="hljs-title function_ invoke__">orderBy</span>(<span class="hljs-string">'created_at'</span>, <span class="hljs-string">'desc'</span>)
                -&gt;<span class="hljs-title function_ invoke__">limit</span>(<span class="hljs-variable">$limit</span>);

            <span class="hljs-keyword">if</span> (<span class="hljs-variable">$statusFilter</span>) {
                <span class="hljs-variable">$query</span>-&gt;<span class="hljs-title function_ invoke__">where</span>(<span class="hljs-string">'status'</span>, <span class="hljs-string">'like'</span>, <span class="hljs-string">"%<span class="hljs-subst">{$statusFilter}</span>%"</span>);
            }

            <span class="hljs-variable">$response</span>[<span class="hljs-string">'recent_workflows'</span>] = <span class="hljs-variable">$query</span>-&gt;<span class="hljs-title function_ invoke__">get</span>()-&gt;<span class="hljs-title function_ invoke__">map</span>(function (<span class="hljs-variable">$w</span>) {
                <span class="hljs-variable">$status</span> = <span class="hljs-variable">$w</span>-&gt;status;
                <span class="hljs-variable">$statusName</span> = <span class="hljs-title function_ invoke__">is_object</span>(<span class="hljs-variable">$status</span>) ? <span class="hljs-title function_ invoke__">class_basename</span>(<span class="hljs-variable">$status</span>) : <span class="hljs-title function_ invoke__">class_basename</span>((<span class="hljs-keyword">string</span>) <span class="hljs-variable">$status</span>);

                <span class="hljs-keyword">return</span> [
                    <span class="hljs-string">'id'</span> =&gt; <span class="hljs-variable">$w</span>-&gt;id,
                    <span class="hljs-string">'class'</span> =&gt; <span class="hljs-variable">$w</span>-&gt;<span class="hljs-class"><span class="hljs-keyword">class</span>,
                    '<span class="hljs-title">status</span>' =&gt; $<span class="hljs-title">statusName</span>,
                    '<span class="hljs-title">created_at</span>' =&gt; $<span class="hljs-title">w</span>-&gt;<span class="hljs-title">created_at</span>?-&gt;<span class="hljs-title">toIso8601String</span>(),
                ];
            });
        }

        <span class="hljs-title">return</span> <span class="hljs-title">Response</span>::<span class="hljs-title">json</span>($<span class="hljs-title">response</span>);
    }

    <span class="hljs-title">public</span> <span class="hljs-title">function</span> <span class="hljs-title">schema</span>(<span class="hljs-title">JsonSchema</span> $<span class="hljs-title">schema</span>): <span class="hljs-title">array</span>
    </span>{
        <span class="hljs-keyword">return</span> [
            <span class="hljs-string">'show_recent'</span> =&gt; <span class="hljs-variable">$schema</span>-&gt;<span class="hljs-keyword">boolean</span>()
                -&gt;<span class="hljs-title function_ invoke__">description</span>(<span class="hljs-string">'Include recent workflow runs in response.'</span>),
            <span class="hljs-string">'limit'</span> =&gt; <span class="hljs-variable">$schema</span>-&gt;<span class="hljs-keyword">integer</span>()
                -&gt;<span class="hljs-title function_ invoke__">description</span>(<span class="hljs-string">'Max recent workflows to return (default: 10).'</span>),
            <span class="hljs-string">'status'</span> =&gt; <span class="hljs-variable">$schema</span>-&gt;<span class="hljs-keyword">string</span>()
                -&gt;<span class="hljs-title function_ invoke__">description</span>(<span class="hljs-string">'Filter by status (e.g., "Completed", "Failed").'</span>),
        ];
    }
}
</code></pre>
<h4 data-id="heading-9">配置可用的工作流</h4>
<p>创建 <code>config/workflow_mcp.php</code> 来将 AI 客户端可以启动的工作流加入白名单:</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">return</span> [
    <span class="hljs-string">'allow_fqcn'</span> =&gt; <span class="hljs-title function_ invoke__">env</span>(<span class="hljs-string">'WORKFLOW_MCP_ALLOW_FQCN'</span>, <span class="hljs-literal">false</span>),

    <span class="hljs-string">'workflows'</span> =&gt; [
        <span class="hljs-string">'simple'</span> =&gt; <span class="hljs-title class_">App\Workflows\Simple\SimpleWorkflow</span>::<span class="hljs-variable language_">class</span>,
        <span class="hljs-string">'prism'</span> =&gt; <span class="hljs-title class_">App\Workflows\Prism\PrismWorkflow</span>::<span class="hljs-variable language_">class</span>,
    ],
];
</code></pre>
<p>这可以防止任意类执行。只有映射的工作流可以访问。</p>
<h4 data-id="heading-10">注册 MCP 服务器</h4>
<p>更新 <code>routes/ai.php</code>:</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">Mcp</span>\<span class="hljs-title">Servers</span>\<span class="hljs-title">WorkflowServer</span>;
<span class="hljs-keyword">use</span> <span class="hljs-title">Laravel</span>\<span class="hljs-title">Mcp</span>\<span class="hljs-title">Facades</span>\<span class="hljs-title">Mcp</span>;

<span class="hljs-title class_">Mcp</span>::<span class="hljs-title function_ invoke__">web</span>(<span class="hljs-string">'/mcp/workflows'</span>, <span class="hljs-title class_">WorkflowServer</span>::<span class="hljs-variable language_">class</span>);
</code></pre>
<h3 data-id="heading-11">连接 AI 客户端</h3>
<h4 data-id="heading-12">VS Code / GitHub Copilot</h4>
<p>在项目中创建 <code>.vscode/mcp.json</code>:</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"servers"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"laravel-workflow"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"http"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"url"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"http://localhost/mcp/workflows"</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>此配置适用于本地开发和 GitHub Codespaces。在 Codespaces 中,VS Code 服务器在容器内运行,因此 localhost 可以正确访问 Laravel 服务器,无需公共端口或 <code>*.app.github.dev</code> URL。</p>
<p>重新加载 VS Code(Cmd/Ctrl+Shift+P → "Developer: Reload Window")后,Copilot 可以直接在聊天中使用工作流工具。</p>
<h3 data-id="heading-13">实际使用</h3>
<p>连接后,你可以与 AI 助手进行自然对话:</p>
<p><strong>你</strong>:"有哪些工作流可用?"</p>
<p><strong>AI</strong>:调用 <code>list_workflows</code> "我找到了 2 个工作流:simple 和 prism。"</p>
<p><strong>你</strong>:"启动 prism 工作流"</p>
<p><strong>AI</strong>:调用 <code>start_workflow</code> "已启动工作流 ID 42。我会检查它的状态。"</p>
<p><strong>AI</strong>:调用 <code>get_workflow_result</code> "工作流已完成!这是生成的用户配置文件:{ name: 'Elena', hobbies: [...] }"</p>
<p>这创造了一种无缝体验,AI 助手可以编排复杂的长时间运行的操作,同时让用户了解情况。</p>
<h3 data-id="heading-14">这种模式的强大之处</h3>
<ul>
<li><strong>持久化</strong>:工作流可以在服务器重启和网络故障中存活</li>
<li><strong>异步设计</strong>:AI 客户端不会阻塞等待完成</li>
<li><strong>可观察</strong>:每个工作流都在 Waterline 的仪表板中跟踪</li>
<li><strong>安全</strong>:基于白名单的工作流访问防止任意执行</li>
<li><strong>无状态 MCP</strong>:服务器不保存状态。客户端跟踪工作流 ID</li>
</ul>
<h3 data-id="heading-15">在浏览器中立即试用</h3>
<p>此 MCP 集成已包含并预配置在 Laravel Workflow Sample App 中。</p>
<p>要试用:</p>
<ol>
<li>在 GitHub 上打开 sample-app 仓库</li>
<li>点击 Code → Codespaces → Create codespace on main</li>
<li>等待环境构建</li>
<li>设置应用并启动队列工作器:</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">php artisan app:init
php artisan queue:work
</code></pre>
<ol start="5">
<li>启用 Laravel Workflow Server MCP 工具</li>
<li>让你的 AI 列出并运行工作流!</li>
</ol>
<h3 data-id="heading-16">接下来可以做什么</h3>
<p>你可以扩展此模式以实现:</p>
<ul>
<li><strong>参数化工作流</strong>:将用户输入传递给工作流参数</li>
<li><strong>Webhook 通知</strong>:推送完成事件而不是轮询</li>
<li><strong>工作流信号</strong>:让 AI 客户端向等待的工作流发送信号</li>
<li><strong>进度流式传输</strong>:使用 SSE 实时流式传输工作流进度</li>
<li><strong>多步骤代理</strong>:在对话中将多个工作流链接在一起</li>
</ul>
<p>Laravel Workflow 的持久化执行与 MCP 的工具协议相结合,为真正有能力的 AI 代理创建了一个基础,这些代理可以处理现实世界的复杂性。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[请求洪峰来了，怎么使用消息队列削峰? 我们来深入的聊一下]]></title>    <link>https://juejin.cn/post/7586505172815675443</link>    <guid>https://juejin.cn/post/7586505172815675443</guid>    <pubDate>2025-12-22T17:02:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586505172815675443" data-draft-id="7586550947703373834" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="请求洪峰来了，怎么使用消息队列削峰? 我们来深入的聊一下"/> <meta itemprop="keywords" content="后端,架构"/> <meta itemprop="datePublished" content="2025-12-22T17:02:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="自由生长2024"/> <meta itemprop="url" content="https://juejin.cn/user/1591748569862670"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            请求洪峰来了，怎么使用消息队列削峰? 我们来深入的聊一下
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1591748569862670/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    自由生长2024
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T17:02:52.000Z" title="Mon Dec 22 2025 17:02:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读25分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>摘要： 本文以秒杀场景为例，深入浅出讲解消息队列“削峰”原理，对比无队列直接冲击与异步缓冲差异，揭示票务系统“疯狂刷新”背后的多层限流设计。用“蓄水池”“排队取号”等比喻拆解本质，坦言高并发技术已成熟，价值在于细节与架构洞察。全文通俗真实，兼顾技术与行业思考，适合后台工程师阅读。</p>
</blockquote>
<h2 data-id="heading-0">请求洪峰来了，怎么使用消息队列削峰?</h2>
<p>这是一个非常经典的系统设计问题。</p>
<p>咱们前面插个嘴，这些技术真的很难吗？跟景区卖票限流没有本质区别。</p>
<p>它只是互联网业务场景下的一种需要，因为他们需要满足很多用户同时访问，因此这些年成为了一种“显学”。一个后台开发岗位JD里，总会多少带“高并发，高可用”字眼，实际上弄清楚本质，你也就知道怎么回事了。</p>
<p>简单来说，“削峰” 就像是在你家门口修了一个“蓄水池”（消息队列），当洪水（大量请求）来的时候，你不直接让水冲进屋子（服务器），而是先存进池子里，然后家里用水管按自己能承受的速度慢慢放水用。</p>
<p>如果不这么做，屋子（服务器）可能直接就被冲垮了（宕机）。</p>
<p>我们可以通过一个具体的“秒杀活动”场景，来一步步拆解怎么用消息队列来“削峰”。</p>
<h4 data-id="heading-1">🌊 第一步：理解“没有削峰”会发生什么？</h4>
<p>想象一下双十一，10万人同时点“下单”按钮。</p>
<ul>
<li><strong>直接冲击</strong>：这10万个请求瞬间全部涌向你的订单服务器。</li>
<li><strong>结果</strong>：服务器每秒只能处理1000个请求，瞬间被压垮，系统崩溃，所有人都买不了东西。</li>
</ul>
<h4 data-id="heading-2">🧱 第二步：引入“消息队列”这堵墙</h4>
<p>我们要做的是 <strong>“异步化”<strong>和</strong>“缓冲”</strong>。</p>
<h5 data-id="heading-3">1. 生产者（快速接收，不处理）</h5>
<p>当用户的请求（比如秒杀下单）来了，你的Web服务器（生产者）只做两件事：</p>
<ol>
<li>
<p><strong>简单校验</strong>：检查用户登录状态、验证码对不对（这一步很快）。</p>
</li>
<li>
<p><strong>扔进队列</strong>：把下单的指令（用户ID、商品ID）打包成一条“消息”，扔进**消息队列（比如 RabbitMQ、Kafka、RocketMQ）**里。</p>
</li>
<li>
<p><strong>立刻回复</strong>：马上告诉用户：“您的请求已收到，请在订单页查看结果”。(这是理想的优雅处理方式，然后我们待会分析实际情况)</p>
</li>
</ol>
<blockquote>
<p><strong>关键点</strong>：Web服务器<strong>不</strong>去扣库存，<strong>不</strong>去算价格，<strong>不</strong>去发短信。它只负责“收单”，处理完就立刻去接下一个请求。这样Web服务器就能扛住每秒几万的请求。</p>
</blockquote>
<h5 data-id="heading-4">2. 消费者（慢慢处理，稳如老狗）</h5>
<p>这时候，你的后台有一台专门的“订单处理机”（消费者），它会从消息队列里<strong>一条一条</strong>（或者批量）地拿消息。</p>
<ul>
<li>它按照自己舒服的速度（比如每秒处理1000条）去干活。</li>
<li>它去检查库存、生成订单、扣减余额、发短信通知。</li>
<li>如果处理完了，就告诉队列：“这条我干完了，删了吧”。</li>
</ul>
<h4 data-id="heading-5">📊 第三步：效果对比</h4>






























<table><thead><tr><th align="left">阶段</th><th align="left">没有消息队列（直接冲）</th><th align="left">使用消息队列（削峰）</th></tr></thead><tbody><tr><td align="left"><strong>请求涌入</strong></td><td align="left">10万请求瞬间砸向服务器</td><td align="left">10万请求瞬间扔进队列（队列抗住）</td></tr><tr><td align="left"><strong>服务器压力</strong></td><td align="left">瞬间爆炸，CPU 100%，宕机</td><td align="left">压力平缓，按固定速度消费</td></tr><tr><td align="left"><strong>用户体验</strong></td><td align="left">页面打不开，报错500</td><td align="left">立刻得到“已受理”的响应</td></tr><tr><td align="left"><strong>最终结果</strong></td><td align="left">全部失败</td><td align="left">前1000个抢到的人成功，后面的人失败（但系统没崩）</td></tr></tbody></table>
<h4 data-id="heading-6">💻 第四步：代码逻辑大概是怎样的？</h4>
<p>为了让你更直观地理解，我写一个非常简化的伪代码：</p>
<p><strong>1. 接收请求的接口（生产者）</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 这个接口非常快，只负责把消息扔进队列</span>
<span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">'/seckill'</span>, methods=[<span class="hljs-string">'POST'</span>]</span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">seckill</span>():
    user_id = get_current_user()
    product_id = request.form[<span class="hljs-string">'product_id'</span>]
    
    <span class="hljs-comment"># 1. 简单检查（比如Redis里看还有没有库存）</span>
    <span class="hljs-keyword">if</span> redis.decr(<span class="hljs-string">"stock:"</span> + product_id) &lt; <span class="hljs-number">0</span>: <span class="hljs-comment"># 对应商品的库存-1</span>
        <span class="hljs-keyword">return</span> <span class="hljs-string">"已售罄"</span>
    
    <span class="hljs-comment"># 2. 核心操作：把下单任务扔进消息队列</span>
    <span class="hljs-comment"># 这一步非常快，就像把信扔进邮筒</span>
    mq.send(<span class="hljs-string">"order_queue"</span>, {
        <span class="hljs-string">"user_id"</span>: user_id,
        <span class="hljs-string">"product_id"</span>: product_id
    })
    
    <span class="hljs-comment"># 3. 立刻返回成功（其实还没真正下单，只是拿到了排队号）</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">"请求已受理，请稍后查看订单"</span>
</code></pre>
<p><strong>2. 后台处理程序（消费者）</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 这个程序一直在后台跑，速度可控</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">order_consumer</span>():
    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:
        <span class="hljs-comment"># 从队列里拿消息（如果没有消息，就阻塞等着）</span>
        msg = mq.receive(<span class="hljs-string">"order_queue"</span>)
        
        <span class="hljs-comment"># 拿到消息后，开始真正干活（这一步慢，但没关系）</span>
        <span class="hljs-keyword">try</span>:
            <span class="hljs-comment"># 真正的业务逻辑：扣库存、生成订单、发短信</span>
            service.create_order(msg.user_id, msg.product_id)
            mq.ack(msg) <span class="hljs-comment"># 告诉队列：这活干完了</span>
        <span class="hljs-keyword">except</span>:
            mq.nack(msg) <span class="hljs-comment"># 告诉队列：这活没干完，稍后再试</span>
</code></pre>
<h4 data-id="heading-7">📌 你该怎么用</h4>
<ol>
<li><strong>拆分流程</strong>：把你的业务拆成“<strong>快速接收</strong>”和“<strong>慢慢干活</strong>”两部分。</li>
<li><strong>引入中间件</strong>：在中间加一个消息队列（如 RabbitMQ）。</li>
<li><strong>前端只管发</strong>：用户的请求来了，校验完参数，立刻发消息到队列，然后就返回“处理中”。</li>
<li><strong>后端慢慢收</strong>：用后台程序从队列里读数据，按部就班地处理业务。</li>
</ol>
<p>这样，无论外面有多少并发请求，你的后端数据库和核心服务看到的流量永远是平缓的，就像山谷被削平了一样。这就是“削峰”。</p>
<p>像排队取号一样，因为窗口接待的速度是有限的，所以让人拿个号在那等，也很餐厅限流一样（想想你去一家很火的餐厅，然后做到门外面排队的样子）。</p>
<p>我们再说不体面，不优雅的，让我厌恶的，现实中更多的实现方式。</p>
<p>很多抢票的是这么做的，比如演唱会门票，你不停的刷新页面抢到了一张，然后，等你点进去准备付款，又告诉你，对不起，已经被卖出去了。也就是说，它是来了两道门，第一道门是超额放人进来，第二道是拼付款速度。这些网站之所以这么做，是为了快速成交，不给用户太多的付款时间。</p>
<p>12306不会这么做，如果你刷到了，并且进入到支付页面，基本上就给你30分钟左右的支付时间，超时取消，算是比较体面的一种方式吧。</p>
<h2 data-id="heading-8">疯狂抢票刷新页面的背后</h2>
<p>对于不做显示的异步任务的网站，让用户一直在页面刷新，其实流量还挺爆炸的，很多用户刷30分钟也刷不到新票放出来，但是很多票务秒杀网站就是让用户一直刷新。</p>
<p>事实上，不是“不做排队”，而是把排队逻辑藏在了前端 + 网关 + 后端的多层防御体系里，并且用了很多“伪装”和“过滤”手段。</p>
<p>所以，提个问题，<strong>“很多票务/电商秒杀确实让用户疯狂刷新页面，看起来没做排队，那为什么系统没炸？”</strong></p>
<hr/>
<h4 data-id="heading-9">🧨 表象 vs 实际：用户“刷” ≠ 请求真打到核心系统</h4>
<p>当用户在大麦网疯狂点“立即抢购”时，<strong>绝大多数请求根本到不了订单服务</strong>。系统在前面设了多道“筛子”：</p>
<h5 data-id="heading-10">✅ 第 1 层：前端限流（最廉价）</h5>
<ul>
<li>按钮点击后 <strong>立刻禁用 1~3 秒</strong>（防止手快党连点）；</li>
<li>加 <strong>验证码</strong>（图形、滑块、短信），过滤掉 90% 的机器人；</li>
<li>用 <strong>本地倒计时</strong> 控制“开抢前不能点”，避免提前压测。</li>
</ul>
<blockquote>
<p>💡 用户以为自己在“抢”，其实只是在和前端交互。</p>
</blockquote>
<h5 data-id="heading-11">✅ 第 2 层：CDN + API 网关限流</h5>
<ul>
<li>请求先到 <strong>CDN 或 Nginx / API 网关</strong>（如 Kong、阿里云 API Gateway）；</li>
<li>这里做 <strong>IP 限流</strong>（比如每秒最多 5 次请求）、<strong>用户 ID 限流</strong>；</li>
<li>超过的直接返回 <code>429 Too Many Requests</code>，不进后端。</li>
</ul>
<blockquote>
<p>💡 10 万用户刷，可能只有 1 万能穿过这层。</p>
</blockquote>
<h5 data-id="heading-12">✅ 第 3 层：缓存预检（Redis 快速拦截）</h5>
<ul>
<li>请求到达业务服务后，<strong>第一件事不是查数据库，而是查 Redis</strong>：
<ul>
<li>商品是否已售罄？→ 直接返回“已抢光”；</li>
<li>用户是否已在排队？→ 返回“请勿重复提交”；</li>
<li>库存是否 &gt; 0？→ 如果为 0，直接拒绝。</li>
</ul>
</li>
<li>这些操作 <strong>微秒级完成</strong>，不涉及复杂逻辑。</li>
</ul>
<blockquote>
<p>💡 又过滤掉 80% 的无效请求。</p>
</blockquote>
<h5 data-id="heading-13">✅ 第 4 层：真正的“排队”——但用户不知道</h5>
<ul>
<li>只有通过以上所有检查的请求，才会进入<strong>真正的排队机制</strong>，比如：
<ul>
<li>写入 <strong>消息队列</strong>（异步下单）；</li>
<li>或进入 <strong>Redis 分布式队列</strong>（如用 List + BLPOP）；</li>
<li>甚至用 <strong>令牌桶</strong>：开抢瞬间放出 N 个令牌，抢到才能继续。</li>
</ul>
</li>
</ul>
<blockquote>
<p>⚠️ 但这时候，<strong>用户已经收到“排队中”或“处理中”的提示了</strong>，不再疯狂刷新。</p>
</blockquote>
<hr/>
<h4 data-id="heading-14">🎭 为什么让用户“感觉在抢”？</h4>
<p>这是<strong>产品设计 + 心理学</strong>的结合：</p>
<ul>
<li>如果直接说“您已进入队列，请等待”，用户会觉得“没参与感”；</li>
<li>而“疯狂点击 → 转圈 → 成功/失败” 的反馈，让人觉得“是我手慢了”，而不是“系统不行”，而且能营造出超级火爆的场面，甚至营造一种失落的感觉，让用户因为错失演出，滋生出厌恶损失心理，从而愿意高价去卖黄牛的票（系统的设计背后都是心理学）；</li>
<li>实际上，<strong>点击第 1 次之后，后续点击基本都被前端或网关拦住了</strong>。</li>
</ul>
<blockquote>
<p>🔍 可以打开浏览器开发者工具，监控 Network：
在真正的秒杀开抢时，你会发现<strong>第二次点击根本没发请求</strong>，或者返回了 429。</p>
</blockquote>
<hr/>
<h4 data-id="heading-15">🆚 对比两种模式</h4>






























<table><thead><tr><th>场景</th><th>“裸奔式刷新”（无防护）</th><th>“伪装式刷新”（真实秒杀系统）</th></tr></thead><tbody><tr><td>用户行为</td><td>无限刷，每次都发请求</td><td>刷多次，但多数请求被拦截</td></tr><tr><td>后端压力</td><td>直接爆炸</td><td>99% 流量在边缘被消化</td></tr><tr><td>核心系统</td><td>被冲垮</td><td>几乎无感</td></tr><tr><td>用户体验</td><td>全部失败 + 报错</td><td>少数成功 + 多数“公平失败”</td></tr></tbody></table>
<hr/>
<h4 data-id="heading-16">✅ 总结：</h4>
<blockquote>
<p><strong>“让用户刷”是一种 UI 假象，背后是层层限流 + 缓存拦截 + 异步排队的组合拳。<br/>
真正的高并发系统，绝不会让原始流量直达数据库或订单服务。</strong></p>
</blockquote>
<p><strong>表面的“混乱”其实是精心设计的“有序过滤”</strong>。</p>
<h2 data-id="heading-17">如果在洪峰中让一次请求像常规请求那样直接排队？</h2>
<p>如果让请求在 Web 服务器前面直接排队（比如用线程池、连接队列），而不是扔进消息队列，行不行？</p>
<p>答案是：<strong>短期可以，但扛不住真正的“秒杀级”高并发，而且体验和可靠性差很多。</strong></p>
<hr/>
<h4 data-id="heading-18">🧱 对比两种“排队”方式</h4>








































<table><thead><tr><th>维度</th><th><strong>Web 层直接排队（同步阻塞）</strong></th><th><strong>消息队列排队（异步缓冲）</strong></th></tr></thead><tbody><tr><td><strong>排队位置</strong></td><td>在 Web 服务器的线程/连接队列里</td><td>在独立的消息中间件（如 Kafka）里</td></tr><tr><td><strong>请求状态</strong></td><td>用户连接一直挂着（TCP 连接未释放）</td><td>用户立刻收到响应，连接释放</td></tr><tr><td><strong>资源占用</strong></td><td>每个排队请求占用内存 + 线程 + 连接</td><td>只占用消息队列的磁盘/内存，Web 无负担</td></tr><tr><td><strong>可扩展性</strong></td><td>队列长度受限于单机资源（通常几百~几千）</td><td>队列可分布式、持久化，轻松撑百万级</td></tr><tr><td><strong>容灾能力</strong></td><td>Web 服务器一崩，所有排队请求全丢</td><td>消息持久化，服务重启后继续处理</td></tr><tr><td><strong>用户体验</strong></td><td>页面卡死、超时、504 Gateway Timeout</td><td>立刻提示“已受理”，后台慢慢处理</td></tr></tbody></table>
<p>很早的时候，上大学选课的时候，大家能看到，每次选课系统开放的时候，刷着刷着，选课网站崩了，这就是直接使用Web层排队的结果。</p>
<hr/>
<h4 data-id="heading-19">🌰 举个现实例子：</h4>
<p>假设你有 10 万用户同时点“秒杀”。</p>
<h5 data-id="heading-20">✖️ 方案 A：Web 服务器自己排队（比如 Tomcat 线程池）</h5>
<ul>
<li>Tomcat 默认最大线程数 200。</li>
<li>前 200 个请求在处理，剩下 99800 个在操作系统连接队列或反向代理（如 Nginx）里排队。</li>
<li>但 Nginx 的 <code>backlog</code> 通常也就几千。</li>
<li><strong>结果</strong>：大量请求直接被拒绝（Connection Refused）或超时（Timeout），用户看到“网络错误”，疯狂刷新 → 雪崩。</li>
</ul>
<h5 data-id="heading-21">✔️ 方案 B：用消息队列</h5>
<ul>
<li>Web 服务器 1 秒处理 5000 个“收单”请求（只校验+入队），全部快速返回。</li>
<li>消息队列存下 10 万条消息（Kafka 轻松扛住）。</li>
<li>后台消费者以每秒 1000 条的速度稳稳处理。</li>
<li><strong>结果</strong>：系统不崩，用户知道“已提交”，即使没抢到也觉得公平。</li>
</ul>
<hr/>
<h4 data-id="heading-22">⚠️ 更严重的问题：<strong>资源耗尽</strong></h4>
<p>在“直接排队”模式下：</p>
<ul>
<li>每个 HTTP 请求都维持一个 TCP 连接；</li>
<li>每个连接可能对应一个线程或协程；</li>
<li>10 万个连接 ≈ 几 GB 内存 + 大量上下文切换；</li>
<li>操作系统可能直接 OOM（内存溢出）或无法新建连接。</li>
</ul>
<p>而消息队列把“请求”从“活跃连接”变成了“静态数据”，资源消耗天差地别。</p>
<hr/>
<h4 data-id="heading-23">✅ 结论：</h4>
<blockquote>
<p><strong>“在 Web 层直接排队”本质上还是同步模型，只是把崩溃时间推迟了一点点；<br/>
而“消息队列削峰”是真正的异步解耦，把瞬时压力转化为可持续处理的任务流。</strong></p>
</blockquote>
<p>所以，在高并发场景（尤其是秒杀、抢购、抢红包），<strong>必须用消息队列（或类似异步机制）做削峰</strong>，不能依赖 Web 服务器自己的排队能力。</p>
<h2 data-id="heading-24">排队取号的朴素逻辑和必要性</h2>
<p>上面说过，请求队列削锋就像医院就诊排队取号一样，也像银行柜台处理逻辑一样，因为窗口处理请求的速度是有限的，所以让人拿个号在那等， 逻辑非常的朴素。</p>
<p>没有取票机之前，所有的人必须在窗口后面等着，连坐的地方都没有，难受不难受？</p>
<p>这正是消息队列削峰的核心思想，我在一一对应展开说明，其实这部分过于通俗，知道本质的可以直接跳过了：</p>
<h4 data-id="heading-25">🎫 1. 削锋就像“排队取号”</h4>
<ul>
<li><strong>用户请求</strong>：就是去银行办事的<strong>客户</strong>。</li>
<li><strong>Web服务器</strong>：就是那个<strong>发号机</strong>。
<ul>
<li>它的任务只是检查一下你带没带身份证（简单校验），然后“滴”一声给你一张号（发消息到队列）。</li>
<li>发号机速度极快，一分钟能发几百个号。</li>
</ul>
</li>
<li><strong>消息队列</strong>：就是那个<strong>等待区</strong>。
<ul>
<li>所有拿到号的人都在这里坐着等。</li>
</ul>
</li>
<li><strong>后台消费者</strong>：就是那个<strong>办事窗口</strong>。
<ul>
<li>窗口的速度是固定的，不管外面来了多少人，窗口永远是“叫一个，办一个”。</li>
<li>如果窗口忙不过来，号就在等待区排队，人不会堵在门口。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-26">🍽️ 2. 就像“餐厅排号限流”</h4>
<ul>
<li><strong>高峰期</strong>：几百人涌向餐厅。</li>
<li><strong>如果没有队列</strong>：所有人都挤在门口和过道里，谁也动不了，服务员上不了菜，厨房也乱套了（服务器死锁/崩溃）。</li>
<li><strong>使用队列</strong>：
<ul>
<li>门口服务员说：“里面满了，您拿个号在路边等吧。”（请求被放入消息队列）。</li>
<li>餐厅里面还是按照原本的节奏，吃完一桌翻台一桌（消费者处理完一条消息，再取下一条）。</li>
<li>虽然外面排队的人很多，但餐厅内部秩序井然，不会因为人多而瘫痪。</li>
</ul>
</li>
</ul>
<hr/>
<h4 data-id="heading-27">🤔 这样做有什么好处？</h4>
<ol>
<li>
<p><strong>系统不崩</strong>：这是最大的好处。不管流量是平时的10倍还是100倍，你的核心业务处理能力（消费者）永远在自己的能力范围内工作。现实中，如果没有取号机制，不安排等候区，大家一直排着长长的队列，你会发现门被堵实了，影响正常的同行。</p>
</li>
<li>
<p><strong>用户体验好</strong>：用户虽然需要等待（比如去订单页刷新），但至少 <strong>不会看到“504网关超时”或者“服务器开小差了”</strong> 这种报错。用户看到的是“请求已提交”，心里就有底了。</p>
</li>
<li>
<p><strong>错峰处理</strong>：比如秒杀活动在0点结束，但处理订单可能要持续到凌晨1点。这没关系，只要在天亮前处理完就行。把瞬间的洪峰拉平成一个缓坡。</p>
</li>
</ol>
<h4 data-id="heading-28">⚠️ 需要注意的“坑”</h4>
<p>虽然这个比喻很形象，但在实际开发中，还需要注意一点小区别：</p>
<p><strong>号不会过期 vs. 消息会过期/积压</strong></p>
<ul>
<li>在餐厅，如果你等太久没去，号可能会作废。</li>
<li>在消息队列里，如果消费者挂了或者处理太慢，消息会<strong>堆积</strong>。
<ul>
<li>如果积压太多，队列可能会满（需要监控）。</li>
<li>如果处理太慢，用户可能要等很久才知道自己没抢到（这时候通常需要配合“熔断”和“降级”策略，比如超过一定数量直接拒绝请求，就像餐厅满员了直接说“今天不营业了”）。</li>
</ul>
</li>
</ul>
<p><strong>总结：消息队列就是一个“解耦”和“缓冲”的神器，它把“瞬时的高并发”转化为了“持续的异步任务流”。</strong></p>
<h2 data-id="heading-29">本质上当下没有太多技术含量但是细节很多的工作</h2>
<p>老是嚷嚷着什么高并发，高可用，现在技术已经很成熟了，再继续抠这些，感觉就像孔乙己穿着那个长袍不愿意脱下一样。</p>
<p>其实，这种技术既然已经成熟了，除了些许细节需要注意，它短期来看，也很难有什么新的突破了。</p>
<p>当然，这种“没什么技术含量”的感觉，也是优秀工程思维的核心——大道至简。真正的技术含量不在于把事情搞得多么玄乎，而在于用最简单、最稳定、最便宜的办法，把那个“不可能”的问题给解决了。</p>
<p>这里面的“技术含量”，其实不在于“用了队列”，而在于把细节处理好：</p>
<h4 data-id="heading-30">🎯 1. 技术含量在于“认知的穿透力”</h4>
<p>当所有人都在喊“服务器要炸了，快加机器”的时候，你能一眼看穿问题的本质不是“算力不够”，而是**“流量的突发性”和“处理能力的恒定性”之间的矛盾**。</p>
<ul>
<li>
<p><strong>难点</strong>：不被表象（CPU 100%）迷惑，精准定位到是“同步阻塞”导致了雪崩。</p>
</li>
<li>
<p><strong>技术含量</strong>：这是一种<strong>架构层面的洞察力</strong>。你知道系统瓶颈在哪里，也知道怎么绕过去。</p>
</li>
</ul>
<h4 data-id="heading-31">⚙️ 2. 技术含量在于“异步化”的改造</h4>
<p>看起来只是加了个队列，但要把一个原本“用户点了按钮 -&gt; 立刻扣库存 -&gt; 立刻返回成功”的同步流程，改成异步的，这中间全是坑：</p>
<ul>
<li>
<p><strong>状态管理</strong>：用户点了，你返回“排队中”，那用户怎么知道最后成功没？你需要设计一套<strong>状态查询机制</strong>（比如订单状态轮询或WebSocket推送）。</p>
</li>
<li>
<p><strong>数据一致性</strong>：如果消息发出去了，结果扣库存的时候数据库挂了，这条消息算不算？这就涉及到<strong>消息的可靠性投递</strong>、<strong>幂等性处理</strong>（防止同一条消息被重复消费导致库存扣成负数）。</p>
</li>
<li>
<p><strong>死信处理</strong>：如果那条消息因为数据格式错误一直处理不了，它会卡在那里，你需要一个“死信队列”来专门处理这些“钉子户”。</p>
</li>
</ul>
<h4 data-id="heading-32">🛡️ 3. 技术含量在于“兜底”和“治理”</h4>
<p>“排队”容易，“维持秩序”难。</p>
<ul>
<li>
<p><strong>积压怎么办</strong>：如果后台处理太慢，队列里堆积了几百万条消息，内存爆了怎么办？你需要<strong>监控告警</strong>，甚至需要<strong>动态扩容</strong>消费者。</p>
</li>
<li>
<p><strong>熔断机制</strong>：如果队列满了，你是把新来的请求丢掉，还是阻塞住？这就需要设计<strong>限流和降级策略</strong>。</p>
</li>
<li>
<p><strong>选型</strong>：你是用 RabbitMQ（灵活但吞吐量一般），还是用 Kafka（吞吐量巨大但延迟稍高），还是用 RocketMQ（金融级可靠）？这需要根据业务场景做权衡。</p>
</li>
</ul>
<h4 data-id="heading-33">📉 4. 技术含量在于“取舍”</h4>
<p>“削峰”其实也是一种 **“欺骗” **。你是在用 <strong>“响应时间”</strong> 换取 <strong>“系统稳定性”</strong>。</p>
<ul>
<li>
<p>技术含量在于你清楚地知道：<strong>让用户等3秒看到结果，比让用户立刻看到错误页面要好得多</strong>。</p>
</li>
<li>
<p>这种在<strong>用户体验</strong>和<strong>系统可用性</strong>之间做权衡的能力，是工程师为了务实不得不做的取舍。</p>
</li>
</ul>
<p>高并发是朴素而简单的东西，并不是什么复杂的东西，难在其长链条中有很多细节， 难在一旦出了错，需要被扣奖金和绩效，或者造成严重的工程事故，因此难在不能出错。</p>
<h2 data-id="heading-34">成熟工种带来的价值焦虑</h2>
<p>高并发高可用这一套,我称之为成熟工种，新人跟着老师傅认真干上一两次完整的流程，也就成为了有经验的老师傅，差不多理解本质了都知道咋弄。</p>
<p>有的时候，互联网行业的软件工程自嘲“搬砖”，可以称得上是没法反驳了。</p>
<p><strong>这是对“软件工程”现状最精准、最残忍的暴击。</strong></p>
<p><strong>一旦你看透了本质，剩下的真的就只是“体力活”和“熟练工种”。</strong></p>
<p>这触及了程序员这个职业最核心的焦虑之一：<strong>工作的“可替代性”</strong>。</p>
<h4 data-id="heading-35">🧱 1. 大部分工作确实是“搬砖”</h4>
<ul>
<li>
<p><strong>CRUD 工程师</strong>：增删改查，写接口，拼页面。只要是个正经计算机毕业的本科生，给他两三个月熟悉业务，确实能上手。</p>
</li>
<li>
<p><strong>业务逻辑的堆砌</strong>：大部分公司的代码，就是接近 if-else 的排列组合。这不需要天才，只需要耐心和记忆力。</p>
</li>
<li>
<p><strong>框架的成熟</strong>：现在各种框架太成熟了，把很多底层细节都封装好了。你只需要按照文档“填空”就行。</p>
</li>
</ul>
<h4 data-id="heading-36">🧩 2. “知道咋弄”和“能弄好”之间，隔着一条鸿沟</h4>
<p>这就是为什么虽然“换个人能干”，但还是有不可替代性的原因。<strong>“知道”只是第一步，后面的坑，才是你经验的价值所在。</strong></p>
<ul>
<li>
<p><strong>填坑的能力</strong>：你知道怎么用消息队列削峰，这是“知道”。但当消息队列挂了、消息丢了、重复消费了、积压了几十亿条了，那个“差不多理解本质”的新人怎么办？这时候靠的是你debug的直觉和经验。</p>
</li>
<li>
<p><strong>代码的“气味”</strong>：新人写出的代码能跑，但可能是一坨意大利面条（Spaghetti Code），耦合度极高，半年后谁都不敢动。你写出的代码，结构清晰，易于维护，扩展性强。这种“代码洁癖”和设计能力，是长期训练出来的。</p>
</li>
<li>
<p><strong>对业务的理解</strong>：你不仅仅是在写代码，你是在解决业务问题。你对业务的深刻理解，让你能设计出更合理的流程，避免很多无用功。新人往往只看得到需求文档的字面意思。</p>
</li>
<li>
<p><strong>权衡的艺术</strong>：技术没有银弹。用消息队列，你得权衡一致性、可用性、复杂度。这种在各种限制条件下做最优解的能力，是“经验值”的直接体现。</p>
</li>
</ul>
<h4 data-id="heading-37">📊 3. 程序员的价值金字塔</h4>
<p>其实，程序员的工作可以分为三层，你的焦虑主要来自于处于中间层：</p>
<ul>
<li>
<p><strong>第一层：基础执行层（可替代性高）</strong></p>
<ul>
<li>工作内容：实现具体的接口、页面、简单的业务逻辑。</li>
<li>状态：就是“换个人也能干”。这是纯体力活，卷的是代码量和加班时长。</li>
</ul>
</li>
<li>
<p><strong>第二层：系统设计层（核心竞争力）</strong></p>
<ul>
<li>工作内容：设计架构、解决复杂技术难题、优化性能、保障系统稳定。</li>
<li>状态：这需要经验和天赋。不是随便拉个人就能设计出淘宝那种级别的秒杀系统的。</li>
</ul>
</li>
<li>
<p><strong>第三层：业务/产品层（不可替代性）</strong></p>
<ul>
<li>工作内容：通过技术手段创造商业价值，或者用技术去改变一个行业。</li>
<li>状态：这时候你已经不是个单纯的程序员了，你是个懂技术的业务专家。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-38">💡 所以，该怎么办？</h4>
<ol>
<li>
<p><strong>不要把“写代码”当成你的核心价值</strong>。代码只是你实现想法的工具。你的核心价值是你的**“解决问题的能力”<strong>和</strong>“架构思维”**。</p>
</li>
<li>
<p><strong>往上走，不要在底层卷</strong>。多去思考系统设计，多去了解业务，多去学习那些“道”层面的东西，而不是死磕某个新出的框架语法。</p>
</li>
<li>
<p><strong>把自己当成一个“手艺人”</strong>。虽然工作很傻，但你可以追求代码的优雅，追求架构的简洁。这种<strong>职业自豪感</strong>，是你对抗“工作无意义感”的最大武器。</p>
</li>
<li>
<p><strong>承认工作的平凡，但不放弃自己的不凡</strong>。大部分工作确实是平凡的，但这不妨碍你在这个平凡的岗位上，成为一个牛逼的人。</p>
</li>
</ol>
<h2 data-id="heading-39">概览高并发高可用的三板斧</h2>
<p>最后，我们来再次回顾和总结一下互联网工作场景中的高并发高可用的老三样或者三板斧。</p>
<p><strong>“高并发”这三个字，被吹得神乎其神，搞得好像多么高深莫测似的，其实剥开那层玄学外衣，内核确实就是那“老三样”。</strong></p>
<p>大家之所以觉得它厉害，往往是因为它把这“老三样”玩到了极致，并且处理了这三样东西带来的各种烂摊子。</p>
<p>我们把这“三板斧”扒一扒，看看它到底有多“了不起”：</p>
<h4 data-id="heading-40">🪓 第一斧：缓存 (Cache)</h4>
<ul>
<li><strong>本质</strong>：就是 <strong>“别老问数据库”</strong>。</li>
<li><strong>操作</strong>：把数据放在内存里（Redis/Memcached）或者用户身边（CDN）。</li>
<li><strong>技术含量在哪</strong>：
<ul>
<li><strong>面子上</strong>：谁都会<code>set</code>和<code>get</code>。</li>
<li><strong>里子上</strong>：缓存穿透（查不到怎么办）、缓存击穿（热点Key失效瞬间）、缓存雪崩（大量Key同时失效）、数据一致性（数据库改了，缓存怎么同步）。<strong>解决这些“并发症”才是真功夫。</strong></li>
</ul>
</li>
</ul>
<p>这里面涉及了缓存和数据如何同步的细节问题。</p>
<h4 data-id="heading-41">🪓 第二斧：限流 (Rate Limiting)</h4>
<ul>
<li><strong>本质</strong>：就是**“干不过来就直接拒绝”**。</li>
<li><strong>操作</strong>：令牌桶、漏桶、计数器，核心逻辑就是“超了就滚”。</li>
<li><strong>技术含量在哪</strong>：
<ul>
<li><strong>面子上</strong>：<code>if (count &gt; limit) return error</code>。</li>
<li><strong>里子上</strong>：怎么动态调整阈值？是按机器负载调还是按业务重要性调？拒绝的时候怎么保证用户体验不崩？<strong>在“拒绝谁”和“拒绝多少”之间找平衡，靠经验。</strong></li>
</ul>
</li>
</ul>
<h4 data-id="heading-42">🪓 第三斧：异步 (消息队列) / 降级 (Degradation)</h4>
<ul>
<li>
<p><strong>本质</strong>：就是 <strong>“削峰填谷”</strong> 和 <strong>“丢卒保车”</strong>。</p>
</li>
<li>
<p><strong>操作</strong>：</p>
<ul>
<li><strong>异步</strong>：把同步调用改成发消息，让请求排队去。</li>
<li><strong>降级</strong>：大促的时候，评论功能卡？关了！推荐商品卡？关了！只要下单能用就行。</li>
</ul>
</li>
<li>
<p><strong>技术含量在哪</strong>：</p>
<ul>
<li><strong>面子上</strong>：引入个MQ中间件，或者注释掉几行代码。</li>
<li><strong>里子上</strong>：
<ul>
<li><strong>异步</strong>：分布式事务怎么保证？消息丢了怎么补偿？怎么保证消息不被重复消费？</li>
<li><strong>降级</strong>：怎么判断什么时候该降级？降级的开关在哪？降级之后怎么快速切回来？<strong>这需要对业务逻辑极其清晰的“优先级划分”。</strong></li>
</ul>
</li>
</ul>
</li>
</ul>
<hr/>
<p><strong>单看每一个技术点，确实没什么了不起的</strong>。大学刚毕业的实习生背背八股文，都能给你讲得头头是道。</p>
<p><strong>真正的“了不起”（或者说“恶心”），在于这几点：</strong></p>
<ol>
<li>
<p><strong>组合拳的复杂度</strong>：
不是单用缓存，也不是单用MQ，而是缓存+限流+MQ+降级+熔断（熔断其实也算降级的一种）一起上。这堆东西交织在一起，<strong>系统的复杂度是指数级上升的</strong>。一个请求过来，你得知道它走了哪条路，中间出了问题怎么排查。</p>
</li>
<li>
<p><strong>海量数据的细节</strong>：
本地跑个Demo，1秒处理10个请求，用HashMap存数据都行。但在生产环境，1秒几万请求，这时候<strong>Redis的网络延迟、MQ的堆积能力、数据库连接池的大小、甚至服务器网卡的带宽</strong>，都会成为瓶颈。</p>
<ul>
<li><em>技术含量在于：你得懂计算机体系结构，懂网络，懂操作系统，才能把这些组件在极限情况下压榨出性能。</em></li>
</ul>
</li>
<li>
<p><strong>兜底方案的完备性</strong>：
最怕的不是系统扛不住，而是**“雪崩”**——A挂了拖垮B，B挂了拖垮C，最后全挂。</p>
<ul>
<li><em>技术含量在于：你得预判到所有可能的失败点，并且在每个点都设置“熔断器”和“逃生通道”。这是一种极致的防御性编程思维。</em></li>
</ul>
</li>
</ol>
<h4 data-id="heading-43">📌 总结</h4>
<p>高并发高可用，它确实就是那几招，<strong>没什么了不起的</strong>。但要把这几招在几万台机器、几亿用户上耍得滴水不漏，不出乱子，这就是大厂愿意给高薪的原因。</p>
<p><strong>它本质就是“老三样”。但能把这“老三样”伺候好的人，确实也不多。</strong> 这就是现实。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>